{"problem_statement": "bug: doctest::String::substr() off by one at the end\n## Description\r\n\r\n`doctest::String::substr()` cuts short the last character, when extracting from the end of the `String`.\r\n\r\n\r\n### Steps to reproduce\r\n\r\n```\r\n#include <doctest/doctest.h>\r\n\r\nTEST_SUITE(\"doctest unit tests\") {\r\n    TEST_CASE(\"doctest::String::substr()\") {\r\n        const doctest::String abcde = \"abcde\";\r\n        CHECK(abcde.substr(0, 3) == \"abc\");\r\n        CHECK(abcde.substr(2, 3) == \"cde\");\r\n        CHECK(abcde.substr(0, 5) == \"abcde\");\r\n    }\r\n}\r\n```\r\n\r\n```\r\n===============================================================================\r\ncheck_doctest_string.cpp(0):\r\nTEST SUITE: doctest unit tests\r\nTEST CASE:  doctest::String::substr()\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(2, 3) == \"cde\" ) is NOT correct!\r\n  values: CHECK( cd == cde )\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(0, 5) == \"abcde\" ) is NOT correct!\r\n  values: CHECK( abcd == abcde )\r\n\r\n===============================================================================\r\n```\r\n\r\n\r\n### Extra information\r\n\r\n* doctest version: **v2.4.9** ... v2.4.11\r\n* Operating System: **22.04.1-Ubuntu**\r\n* Compiler+version: **GCC 12.3.0 x86_64**\r\n\n", "patch": "diff --git a/examples/all_features/CMakeLists.txt b/examples/all_features/CMakeLists.txt\nindex 19436c549..7b6277007 100644\n--- a/examples/all_features/CMakeLists.txt\n+++ b/examples/all_features/CMakeLists.txt\n@@ -9,6 +9,7 @@ set(files_with_output\n     alternative_macros.cpp\n     assertion_macros.cpp\n     stringification.cpp\n+    check_doctest_string.cpp\n     double_stringification.cpp\n     reporters_and_listeners.cpp\n     subcases.cpp\n", "instance_id": "doctest__doctest-881", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear, as it identifies a specific bug in the `doctest::String::substr()` method, provides reproducible test cases, and includes the expected versus actual output. The description of the issue (cutting short the last character when extracting from the end) is straightforward, and the steps to reproduce are well-documented with code and error output. However, there are minor ambiguities: the problem statement does not explicitly discuss edge cases beyond the provided test cases (e.g., empty strings, negative indices, or out-of-bounds conditions), nor does it specify if the fix should account for performance implications or compatibility with other parts of the library. Additionally, constraints or requirements for the solution (e.g., maintaining API compatibility) are not mentioned. Thus, while the core issue is clear, some minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4). The issue is a bug in the `doctest::String::substr()` method, likely involving an off-by-one error in the substring extraction logic, which is a common and relatively straightforward issue to debug and fix. The scope of the code changes appears limited, as the provided diff only shows the addition of a test file (`check_doctest_string.cpp`) to the build system, implying that the actual fix will likely be localized to the implementation of `substr()` in a single file or module. The technical concepts required are basic: understanding string manipulation, indexing, and boundary conditions in C++, along with familiarity with the doctest framework for testing. No advanced algorithms, design patterns, or system architecture changes are indicated. Edge cases are partially covered in the test cases provided (e.g., extracting from the start, middle, and end of the string), but additional edge cases like empty strings or invalid inputs may need to be considered, though these are not complex to handle. Overall, this problem requires understanding some code logic and making a simple modification, likely adjusting index calculations or bounds checking, which aligns with a difficulty score of 0.30.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Prevent unnecessary `VACUUM` executions for SQLite3 `stats` database\n## Description\n\nWhile profiling several queries commonly received by Admin targeting `stats` database, like queries from other `ProxySQL` instances regarding `Cluster`, it was found that one of the biggest contributions to CPU utilization for serving those queries is a `VACUUM` that is performed after the query execution.\n\nMany times this `VACUUM` is performed after queries that are idempotent on tables that won't benefit at all of this subsequent operation. This is an extract of a `perf` report:\n\n- Query: `SELECT Variable_Name, Variable_Value FROM stats_mysql_global`\n- Report extract:\n  ```\n  -   88.56%     0.01%  Admin            proxysql              [.] void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n     - 88.55% void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n        + 45.64% ProxySQL_Admin::vacuum_stats(bool)\n        + 32.01% SQLite3DB::execute_statement(char const*, char**, int*, int*, SQLite3_result**)\n        + 9.94% ProxySQL_Admin::GenericRefreshStatistics(char const*, unsigned int, bool)\n        + 0.87% SQLite3_result::~SQLite3_result()\n  ```\n\nThese `VACUUM` operations should be more selective, or performed when the database is going to benefit of the operation.\n", "patch": "diff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex 41c21783f..38b2c954c 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -4048,7 +4048,7 @@ int MySQL_Session::get_pkts_from_client(bool& wrong_pass, PtrSize_t& pkt) {\n \t\t\t\t\t\t\t\t\tconst uint32_t recv_query_sz { pkt.size - 5 };\n \n \t\t\t\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_MYSQL_COM, 5, \"Processing received query\"\n-\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=%s query=%.*s\\n\",\n+\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=\\\"%s\\\" query=\\\"%.*s\\\"\\n\",\n \t\t\t\t\t\t\t\t\t\tthis, session_type, schemaname ? schemaname : \"\", recv_query_sz, recv_query\n \t\t\t\t\t\t\t\t\t);\n \t\t\t\t\t\t\t\t}\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex af6b7bb87..88890c456 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -1682,20 +1682,24 @@ bool ProxySQL_Admin::GenericRefreshStatistics(const char *query_no_space, unsign\n \t\t}\n \t\t//pthread_mutex_unlock(&admin_mutex);\n \t}\n-\tif (\n-\t\tstats_mysql_processlist || stats_mysql_connection_pool || stats_mysql_connection_pool_reset ||\n-\t\tstats_mysql_query_digest || stats_mysql_query_digest_reset || stats_mysql_errors ||\n-\t\tstats_mysql_errors_reset || stats_mysql_global || stats_memory_metrics || \n-\t\tstats_mysql_commands_counters || stats_mysql_query_rules || stats_mysql_users ||\n-\t\tstats_mysql_gtid_executed || stats_mysql_free_connections || \n-\t\tstats_pgsql_global || stats_pgsql_connection_pool || stats_pgsql_connection_pool_reset ||\n-\t\tstats_pgsql_free_connections || stats_pgsql_users || stats_pgsql_processlist ||\n-\t\tstats_pgsql_errors || stats_pgsql_errors_reset || stats_pgsql_query_rules || stats_pgsql_commands_counters ||\n-\t\tstats_pgsql_query_digest || stats_pgsql_query_digest_reset\n-\t) {\n-\t\tret = true;\n+\n+\tint freelist_count = statsdb->return_one_int(\"PRAGMA freelist_count\");\n+\tif (freelist_count < 1000) {\n+\t\tret = false;\n+\t} else {\n+\t\tint page_count  = statsdb->return_one_int(\"PRAGMA page_count\");\n+\t\tret = (freelist_count * 100 / page_count) > 20;\n+\n+#ifdef DEBUG\n+\t\tif (ret) {\n+\t\t\tproxy_debug(PROXY_DEBUG_ADMIN, 4,\n+\t\t\t\t\"VACUUM required for 'stats_db'   page_count=%d freelist_count=%d\\n\",\n+\t\t\t\tpage_count, freelist_count\n+\t\t\t);\n+\t\t}\n+#endif\n \t}\n-\t\n+\n \treturn ret;\n }\n \ndiff --git a/lib/ProxySQL_Admin_Stats.cpp b/lib/ProxySQL_Admin_Stats.cpp\nindex 6de28f52f..c6b477f93 100644\n--- a/lib/ProxySQL_Admin_Stats.cpp\n+++ b/lib/ProxySQL_Admin_Stats.cpp\n@@ -428,163 +428,170 @@ void ProxySQL_Admin::p_update_stmt_metrics() {\n \t}\n }\n \n+using row_bind_t = void (*)(int offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row);\n+\n+void sqlite3_bulk_step(\n+\tSQLite3DB* db,\n+\tsqlite3_stmt* row_stmt,\n+\tsqlite3_stmt* bulk_stmt,\n+\tSQLite3_result* resultset,\n+\trow_bind_t row_bind\n+) {\n+\tint max_bulk_row_idx = resultset->rows_count / 32;\n+\tmax_bulk_row_idx = max_bulk_row_idx * 32;\n+\n+\tint rc = 0;\n+\tint row_idx = 0;\n+\n+\tfor (SQLite3_row* row : resultset->rows) {\n+\t\tint e_idx = row_idx % 32;\n+\n+\t\tif (row_idx < max_bulk_row_idx) {\n+\t\t\trow_bind(e_idx, db, bulk_stmt, row);\n+\n+\t\t\tif (e_idx == 31) {\n+\t\t\t\tSAFE_SQLITE3_STEP2(bulk_stmt);\n+\t\t\t\trc = (*proxy_sqlite3_clear_bindings)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t\trc = (*proxy_sqlite3_reset)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t}\n+\t\t} else {\n+\t\t\trow_bind(0, db, row_stmt, row);\n+\n+\t\t\tSAFE_SQLITE3_STEP2(row_stmt);\n+\t\t\trc = (*proxy_sqlite3_clear_bindings)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\trc = (*proxy_sqlite3_reset)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t}\n+\n+\t\trow_idx += 1;\n+\t}\n+}\n+\n+void stats_mysql_global___bind_row(\n+\tint offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row\n+) {\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 1, row->fields[0], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 2, row->fields[1], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+}\n+\n+template <class...> constexpr std::false_type always_false {};\n+\n+template <typename T>\n+const void sqlite3_global_stats_row_step(\n+\tSQLite3DB* db, sqlite3_stmt* stmt, const char* name, T val\n+) {\n+\tchar buf[32] = { 0 };\n+\n+\tif constexpr (std::is_same_v<T, int32_t>)  {\n+\t\tsprintf(buf, \"%d\", val);\n+\t} else if constexpr (std::is_same_v<T, uint64_t>) {\n+\t\tsprintf(buf, \"%lu\", val);\n+\t} else if constexpr (std::is_same_v<T, unsigned long long>) {\n+\t\tsprintf(buf, \"%llu\", val);\n+\t} else if constexpr (std::is_same_v<T, bool>) {\n+\t\tsprintf(buf, \"%s\", val ? \"true\" : \"false\");\n+\t} else {\n+\t\tstatic_assert(always_false<T>, \"Non-exhaustive switch\");\n+\t}\n+\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, 1, name, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, 2, buf, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\n+\tSAFE_SQLITE3_STEP2(stmt);\n+\trc = (*proxy_sqlite3_clear_bindings)(stmt); ASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_reset)(stmt); ASSERT_SQLITE_OK(rc, db);\n+};\n+\n void ProxySQL_Admin::stats___mysql_global() {\n \tif (!GloMTH) return;\n \tSQLite3_result * resultset=GloMTH->SQL3_GlobalStatus(true);\n \tif (resultset==NULL) return;\n+\n \tstatsdb->execute(\"BEGIN\");\n \tstatsdb->execute(\"DELETE FROM stats_mysql_global\");\n-\tchar *a=(char *)\"INSERT INTO stats_mysql_global VALUES (\\\"%s\\\",\\\"%s\\\")\";\n-\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\tSQLite3_row *r=*it;\n-\t\tint arg_len=0;\n-\t\tfor (int i=0; i<2; i++) {\n-\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t}\n-\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n+\n+\tconst string q_row_insert { \"INSERT INTO stats_mysql_global VALUES (?1, ?2)\" };\n+\tconst string q_bulk_insert {\n+\t\t\"INSERT INTO stats_mysql_global VALUES \" + generate_multi_rows_query(32, 2)\n+\t};\n+\n+\tsqlite3_stmt* row_stmt = nullptr;\n+\tint rc = statsdb->prepare_v2(q_row_insert.c_str(), &row_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\tsqlite3_stmt* bulk_stmt = nullptr;\n+\trc = statsdb->prepare_v2(q_bulk_insert.c_str(), &bulk_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\n+\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n+\n \tdelete resultset;\n \tresultset=NULL;\n \n \tresultset=MyHGM->SQL3_Get_ConnPool_Stats();\n+\n \tif (resultset) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n-\tint highwater;\n-\tint current;\n-\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n-\tchar bu[32];\n-\tchar *vn=NULL;\n-\tchar *query=NULL;\n-\tvn=(char *)\"SQLite3_memory_bytes\";\n-\tsprintf(bu,\"%d\",current);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tint highwater, current = 0;\n+\t\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"SQLite3_memory_bytes\", current);\n+\t}\n \n-\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n-\tvn=(char *)\"ConnPool_memory_bytes\";\n-\tsprintf(bu,\"%llu\",connpool_mem);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"ConnPool_memory_bytes\", connpool_mem);\n+\t}\n \n \tif (GloMyStmt) {\n-\t\tuint64_t stmt_client_active_unique = 0;\n-\t\tuint64_t stmt_client_active_total = 0;\n-\t\tuint64_t stmt_max_stmt_id = 0;\n-\t\tuint64_t stmt_cached = 0;\n-\t\tuint64_t stmt_server_active_unique = 0;\n-\t\tuint64_t stmt_server_active_total = 0;\n-\t\tGloMyStmt->get_metrics(&stmt_client_active_unique,&stmt_client_active_total,&stmt_max_stmt_id,&stmt_cached,&stmt_server_active_unique,&stmt_server_active_total);\n-\t\tvn=(char *)\"Stmt_Client_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Client_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Max_Stmt_id\";\n-\t\tsprintf(bu,\"%lu\",stmt_max_stmt_id);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Cached\";\n-\t\tsprintf(bu,\"%lu\",stmt_cached);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tuint64_t client_active_unique = 0;\n+\t\tuint64_t client_active_total = 0;\n+\t\tuint64_t max_stmt_id = 0;\n+\t\tuint64_t cached = 0;\n+\t\tuint64_t server_active_unique = 0;\n+\t\tuint64_t server_active_total = 0;\n+\n+\t\tGloMyStmt->get_metrics(\n+\t\t\t&client_active_unique,\n+\t\t\t&client_active_total,\n+\t\t\t&max_stmt_id,\n+\t\t\t&cached,\n+\t\t\t&server_active_unique,\n+\t\t\t&server_active_total\n+\t\t);\n+\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Total\", client_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Unique\", client_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Total\", server_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Unique\", server_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Max_Stmt_id\", max_stmt_id);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Cached\", cached);\n \t}\n \n \tif (GloMyQC && (resultset= GloMyQC->SQL3_getStats())) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n \tif (GloMyLdapAuth) {\n \t\tresultset=GloMyLdapAuth->SQL3_getStats();\n-\t\tif (resultset) {\n-\t\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\t\tSQLite3_row *r=*it;\n-\t\t\t\tint arg_len=0;\n-\t\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t\t}\n-\t\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\t\tstatsdb->execute(query);\n-\t\t\t\tfree(query);\n-\t\t\t}\n-\t\t\tdelete resultset;\n-\t\t\tresultset=NULL;\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t}\n \n \tif (GloMyQPro) {\n \t\tunsigned long long mu = GloMyQPro->get_new_req_conns_count();\n-\t\tvn=(char *)\"new_req_conns_count\";\n-\t\tsprintf(bu,\"%llu\",mu);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n-\t{\n-\t\tvn=(char *)\"mysql_listener_paused\";\n-\t\tsprintf(bu, \"%s\", ( admin_proxysql_mysql_paused==true ? \"true\" : \"false\") );\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"new_req_conns_count\", mu);\n \t}\n+\n+\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"mysql_listener_paused\", admin_proxysql_mysql_paused);\n+\n \tstatsdb->execute(\"COMMIT\");\n }\n \n", "instance_id": "sysown__proxysql-4859", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the goal of preventing unnecessary `VACUUM` operations in a SQLite3 database used by ProxySQL for stats. It provides context about the performance issue (high CPU utilization due to frequent `VACUUM` calls) and includes a relevant excerpt from a performance report to illustrate the problem. The goal of making `VACUUM` operations more selective is stated, along with the observation that many queries are idempotent and do not benefit from `VACUUM`. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what constitutes a \"benefit\" for the database from a `VACUUM` operation, nor does it specify the criteria or thresholds for when a `VACUUM` should be performed. Additionally, edge cases or specific scenarios where `VACUUM` might still be necessary are not mentioned. While the intent is clear, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes involves multiple files (`ProxySQL_Admin.cpp`, `ProxySQL_Admin_Stats.cpp`, and a minor debug log change in `MySQL_Session.cpp`), indicating a need to understand interactions between different parts of the codebase, particularly how the stats database is managed and queried. The primary change in `ProxySQL_Admin.cpp` introduces a heuristic for deciding when to perform a `VACUUM` based on `freelist_count` and `page_count`, which requires understanding SQLite internals (PRAGMA statements and database page management) and applying a logical threshold for optimization. This adds a layer of complexity beyond simple bug fixes. Additionally, the extensive refactoring in `ProxySQL_Admin_Stats.cpp` to optimize SQLite insertions using bulk operations and prepared statements demonstrates a need for proficiency in SQLite API usage, C++ template programming, and performance optimization techniques. While the changes do not appear to impact the overall system architecture significantly, they do require handling potential edge cases, such as ensuring the new `VACUUM` logic does not miss critical scenarios where database maintenance is needed, though these are not explicitly detailed in the problem statement. The number of technical concepts involved\u2014SQLite database management, performance profiling, C++ programming patterns, and debugging\u2014further contributes to the moderate difficulty. However, the problem does not reach the \"hard\" category as it does not involve deep architectural changes, complex algorithms, or advanced domain-specific knowledge beyond database optimization. A score of 0.55 reflects this balance of moderate complexity across multiple files and concepts, with manageable but non-trivial implementation challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1, "human_difficulty_modify_explanation": -1}
{"problem_statement": "FirebaseStorage.StorageError provides limited information\n### Description\r\n\r\nOne of my TestFlight users consistently gets an error when using the FirebaseStorage API:\r\n`StorageReference.writeAsync()`\r\n\r\nLogging this error provides little insights since the localizedDescription is\r\n`The operation couldn\u2019t be completed. (FirebaseStorage.StorageError error 0.)`\r\n\r\nUnpacking the error case and logging the `.unknown(String)` produces\r\n`An unknown error occurred, please check the server response.`\r\n\r\nThe server response isn't on the error however since its lost when the Objective-C `NSError` is converted the Swift enum via `swiftConvert(objcError:)`.\r\n\r\nWould it be possible to instead make `StorageError` conform to [`CustomNSError`](https://developer.apple.com/documentation/foundation/customnserror) and expose the `userInfo` in Swift? Would love to debug this without rewriting a significant portion of my code in Objective-C.\r\n\r\n### Reproducing the issue\r\n\r\nTrying to figure this out myself.\r\n\r\n### Firebase SDK Version\r\n\r\n10.5.0\r\n\r\n### Xcode Version\r\n\r\n14.2\r\n\r\n### Installation Method\r\n\r\nSwift Package Manager\r\n\r\n### Firebase Product(s)\r\n\r\nStorage\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n```json\r\n{\r\n  \"pins\" : [\r\n    {\r\n      \"identity\" : \"abseil-cpp-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/abseil-cpp-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"583de9bd60f66b40e78d08599cc92036c2e7e4e1\",\r\n        \"version\" : \"0.20220203.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"boringssl-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/boringssl-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"dd3eda2b05a3f459fc3073695ad1b28659066eab\",\r\n        \"version\" : \"0.9.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"firebase-ios-sdk\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/firebase-ios-sdk\",\r\n      \"state\" : {\r\n        \"revision\" : \"f567ed9a2b30e29159df258049a9c662c517688e\",\r\n        \"version\" : \"10.5.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleappmeasurement\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleAppMeasurement.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"9a09ece724128e8d1e14c5133b87c0e236844ac0\",\r\n        \"version\" : \"10.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googledatatransport\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleDataTransport.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"f6b558e3f801f2cac336b04f615ce111fa9ddaa0\",\r\n        \"version\" : \"9.2.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleutilities\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleUtilities.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0543562f85620b5b7c510c6bcbef75b562a5127b\",\r\n        \"version\" : \"7.11.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"grpc-ios\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/grpc/grpc-ios.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"8440b914756e0d26d4f4d054a1c1581daedfc5b6\",\r\n        \"version\" : \"1.44.3-grpc\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"gtm-session-fetcher\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/gtm-session-fetcher.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"5ccda3981422a84186387dbb763ba739178b529c\",\r\n        \"version\" : \"2.3.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"leveldb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/leveldb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0706abcc6b0bd9cedfbb015ba840e4a780b5159b\",\r\n        \"version\" : \"1.22.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"mixpanel-swift\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/mixpanel/mixpanel-swift\",\r\n      \"state\" : {\r\n        \"branch\" : \"master\",\r\n        \"revision\" : \"dfc52c9155f2e42fb69f98a2370647d28d7eebe1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"nanopb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/nanopb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"819d0a2173aff699fb8c364b6fb906f7cdb1a692\",\r\n        \"version\" : \"2.30909.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"promises\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/promises.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"ec957ccddbcc710ccc64c9dcbd4c7006fcf8b73a\",\r\n        \"version\" : \"2.2.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"swift-protobuf\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/apple/swift-protobuf.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0af9125c4eae12a4973fb66574c53a54962a9e1e\",\r\n        \"version\" : \"1.21.0\"\r\n      }\r\n    }\r\n  ],\r\n  \"version\" : 2\r\n}\r\n```\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/FirebaseStorage/CHANGELOG.md b/FirebaseStorage/CHANGELOG.md\nindex 1baafc4bbdb..1703f2ae829 100644\n--- a/FirebaseStorage/CHANGELOG.md\n+++ b/FirebaseStorage/CHANGELOG.md\n@@ -1,3 +1,9 @@\n+# 11.0.0\n+- [fixed] Updated error handling to support both Swift error enum handling and NSError error\n+  handling. Some of the Swift enums have additional parameters which may be a **breaking** change.\n+  There are additional NSError's for completeness, but nothing related to NSError handling is\n+  breaking. (#13071, #10889, #13114)\n+\n # 10.24.0\n - [fixed] `putFile` and `putFileAsync` now work in app extensions. A background session\n    configuration is not used when uploading from an app extension (#12579).\ndiff --git a/FirebaseStorage/Sources/AsyncAwait.swift b/FirebaseStorage/Sources/AsyncAwait.swift\nindex 8fffded0e18..e38a2525711 100644\n--- a/FirebaseStorage/Sources/AsyncAwait.swift\n+++ b/FirebaseStorage/Sources/AsyncAwait.swift\n@@ -66,7 +66,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putDataAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putDataAsync\")\n         ))\n       }\n     }\n@@ -103,7 +104,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putFileAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putFileAsync\")\n         ))\n       }\n     }\n@@ -137,7 +139,8 @@ public extension StorageReference {\n       }\n       downloadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in writeAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in writeAsync\")\n         ))\n       }\n     }\ndiff --git a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\nindex 2cca8acdca2..5fb5ca61ae1 100644\n--- a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n@@ -74,10 +74,10 @@ class StorageGetDownloadURLTask: StorageTask, StorageTaskManagement {\n              .jsonObject(with: data) as? [String: Any] {\n             downloadURL = self.downloadURLFromMetadataDictionary(responseDictionary)\n             if downloadURL == nil {\n-              self.error = NSError(domain: StorageErrorDomain,\n-                                   code: StorageErrorCode.unknown.rawValue,\n-                                   userInfo: [NSLocalizedDescriptionKey:\n-                                     \"Failed to retrieve a download URL.\"])\n+              self.error = StorageError.unknown(\n+                message: \"Failed to retrieve a download URL.\",\n+                serverError: [:]\n+              ) as NSError\n             }\n           } else {\n             self.error = StorageErrorCode.error(withInvalidRequest: data)\ndiff --git a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\nindex 217f8775116..bb195656cae 100644\n--- a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n@@ -45,12 +45,7 @@ class StorageTokenAuthorizer: NSObject, GTMSessionFetcherAuthorizer {\n           var errorDictionary = error.userInfo\n           errorDictionary[\"ResponseErrorDomain\"] = error.domain\n           errorDictionary[\"ResponseErrorCode\"] = error.code\n-          errorDictionary[NSLocalizedDescriptionKey] =\n-            \"User is not authenticated, please authenticate\" +\n-            \" using Firebase Authentication and try again.\"\n-          tokenError = NSError(domain: \"FIRStorageErrorDomain\",\n-                               code: StorageErrorCode.unauthenticated.rawValue,\n-                               userInfo: errorDictionary)\n+          tokenError = StorageError.unauthenticated(serverError: errorDictionary) as NSError\n         } else if let token {\n           let firebaseToken = \"Firebase \\(token)\"\n           request?.setValue(firebaseToken, forHTTPHeaderField: \"Authorization\")\ndiff --git a/FirebaseStorage/Sources/Result.swift b/FirebaseStorage/Sources/Result.swift\nindex 931794cbfb1..3a73da64f97 100644\n--- a/FirebaseStorage/Sources/Result.swift\n+++ b/FirebaseStorage/Sources/Result.swift\n@@ -29,9 +29,11 @@ private func getResultCallback<T>(completion: @escaping (Result<T, Error>) -> Vo\n     if let value {\n       completion(.success(value))\n     } else if let error {\n-      completion(.failure(StorageError.swiftConvert(objcError: error as NSError)))\n+      completion(.failure(error))\n     } else {\n-      completion(.failure(StorageError.internalError(\"Internal failure in getResultCallback\")))\n+      completion(.failure(StorageError.internalError(\n+        message: \"Internal failure in getResultCallback\"\n+      )))\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/Storage.swift b/FirebaseStorage/Sources/Storage.swift\nindex 3d547e28da3..09f211d3341 100644\n--- a/FirebaseStorage/Sources/Storage.swift\n+++ b/FirebaseStorage/Sources/Storage.swift\n@@ -193,9 +193,9 @@ import FirebaseCore\n     do {\n       path = try StoragePath.path(string: url.absoluteString)\n     } catch let StoragePathError.storagePathError(message) {\n-      throw StorageError.pathError(message)\n+      throw StorageError.pathError(message: message)\n     } catch {\n-      throw StorageError.pathError(\"Internal error finding StoragePath: \\(error)\")\n+      throw StorageError.pathError(message: \"Internal error finding StoragePath: \\(error)\")\n     }\n \n     // If no default bucket exists (empty string), accept anything.\n@@ -205,7 +205,7 @@ import FirebaseCore\n     // If there exists a default bucket, throw if provided a different bucket.\n     if path.bucket != storageBucket {\n       throw StorageError\n-        .bucketMismatch(\"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n+        .bucketMismatch(message: \"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n           \"bucket of the current instance: `\\(storageBucket)`\")\n     }\n     return StorageReference(storage: self, path: path)\ndiff --git a/FirebaseStorage/Sources/StorageDownloadTask.swift b/FirebaseStorage/Sources/StorageDownloadTask.swift\nindex 8f9f0332393..91629bd632b 100644\n--- a/FirebaseStorage/Sources/StorageDownloadTask.swift\n+++ b/FirebaseStorage/Sources/StorageDownloadTask.swift\n@@ -67,8 +67,7 @@ open class StorageDownloadTask: StorageObservableTask, StorageTaskManagement {\n    * Cancels a task.\n    */\n   @objc open func cancel() {\n-    let error = StorageErrorCode.error(withCode: .cancelled)\n-    cancel(withError: error)\n+    cancel(withError: StorageError.cancelled as NSError)\n   }\n \n   /**\ndiff --git a/FirebaseStorage/Sources/StorageError.swift b/FirebaseStorage/Sources/StorageError.swift\nindex d9e80dd31bd..f3e02340a2d 100644\n--- a/FirebaseStorage/Sources/StorageError.swift\n+++ b/FirebaseStorage/Sources/StorageError.swift\n@@ -36,24 +36,17 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n   case downloadSizeExceeded = -13032\n   case cancelled = -13040\n   case invalidArgument = -13050\n+  case bucketMismatch = -13051\n+  case internalError = -13052\n+  case pathError = -13053\n \n   /**\n-   * Creates a Firebase Storage error from a specific GCS error and FIRIMPLStorageReference.\n+   * Creates a Firebase Storage error from a specific GCS error and StorageReference.\n    * @param serverError Server error to wrap and return as a Firebase Storage error.\n    * @param ref StorageReference which provides context about the request being made.\n    * @return Returns a Firebase Storage error.\n    */\n   static func error(withServerError serverError: NSError, ref: StorageReference) -> NSError {\n-    var errorCode: StorageErrorCode\n-    switch serverError.code {\n-    case 400: errorCode = .unknown\n-    case 401: errorCode = .unauthenticated\n-    case 402: errorCode = .quotaExceeded\n-    case 403: errorCode = .unauthorized\n-    case 404: errorCode = .objectNotFound\n-    default: errorCode = .unknown\n-    }\n-\n     var errorDictionary = serverError.userInfo\n     errorDictionary[\"ResponseErrorDomain\"] = serverError.domain\n     errorDictionary[\"ResponseErrorCode\"] = serverError.code\n@@ -66,7 +59,29 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     if let data = (errorDictionary[\"data\"] as? Data) {\n       errorDictionary[\"ResponseBody\"] = String(data: data, encoding: .utf8)\n     }\n-    return error(withCode: errorCode, infoDictionary: errorDictionary)\n+    let storageError = switch serverError.code {\n+    case 400: StorageError.unknown(\n+        message: \"Unknown 400 error from backend\",\n+        serverError: errorDictionary\n+      )\n+    case 401: StorageError.unauthenticated(serverError: errorDictionary)\n+    case 402: StorageError.quotaExceeded(\n+        bucket: ref.path.bucket,\n+        serverError: errorDictionary\n+      )\n+    case 403: StorageError.unauthorized(\n+        bucket: ref.path.bucket,\n+        object: ref.path.object ?? \"<object-entity-internal-error>\",\n+        serverError: errorDictionary\n+      )\n+    case 404: StorageError.objectNotFound(\n+        object: ref.path.object ?? \"<object-entity-internal-error>\", serverError: errorDictionary\n+      )\n+    default: StorageError.unknown(\n+        message: \"Unexpected \\(serverError.code) code from backend\", serverError: errorDictionary\n+      )\n+    }\n+    return storageError as NSError\n   }\n \n   /** Creates a Firebase Storage error from an invalid request.\n@@ -81,143 +96,123 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     } else {\n       requestString = \"<nil request returned from server>\"\n     }\n-    let invalidDataString = \"Invalid data returned from the server:\\(requestString)\"\n-    return error(\n-      withCode: .unknown,\n-      infoDictionary: [NSLocalizedFailureErrorKey: invalidDataString]\n-    )\n+    let invalidDataString = \"Invalid data returned from the server: \\(requestString)\"\n+    return StorageError.unknown(message: invalidDataString, serverError: [:]) as NSError\n   }\n+}\n \n-  /**\n-   * Creates a Firebase Storage error from a specific FIRStorageErrorCode while adding\n-   * custom info from an optionally provided info dictionary.\n-   */\n-  static func error(withCode code: StorageErrorCode,\n-                    infoDictionary: [String: Any]? = nil) -> NSError {\n-    var dictionary = infoDictionary ?? [:]\n-    var errorMessage: String\n-    switch code {\n+/// Firebase Storage errors\n+public enum StorageError: Error, CustomNSError {\n+  case unknown(message: String, serverError: [String: Any])\n+  case objectNotFound(object: String, serverError: [String: Any])\n+  case bucketNotFound(bucket: String)\n+  case projectNotFound(project: String)\n+  case quotaExceeded(bucket: String, serverError: [String: Any])\n+  case unauthenticated(serverError: [String: Any])\n+  case unauthorized(bucket: String, object: String, serverError: [String: Any])\n+  case retryLimitExceeded\n+  case nonMatchingChecksum\n+  case downloadSizeExceeded(total: Int64, maxSize: Int64)\n+  case cancelled\n+  case invalidArgument(message: String)\n+  case internalError(message: String)\n+  case bucketMismatch(message: String)\n+  case pathError(message: String)\n+\n+  // MARK: - CustomNSError\n+\n+  /// Default domain of the error.\n+  public static var errorDomain: String { return StorageErrorDomain }\n+\n+  /// The error code within the given domain.\n+  public var errorCode: Int {\n+    switch self {\n+    case .unknown:\n+      return StorageErrorCode.unknown.rawValue\n     case .objectNotFound:\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"Object \\(object) does not exist.\"\n+      return StorageErrorCode.objectNotFound.rawValue\n     case .bucketNotFound:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage = \"Bucket \\(bucket) does not exist.\"\n+      return StorageErrorCode.bucketNotFound.rawValue\n     case .projectNotFound:\n-      let project = dictionary[\"project\"] ?? \"<project-entity-internal-error>\"\n-      errorMessage = \"Project \\(project) does not exist.\"\n+      return StorageErrorCode.projectNotFound.rawValue\n     case .quotaExceeded:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage =\n-        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n-    case .downloadSizeExceeded:\n-      let total = \"\\(dictionary[\"totalSize\"] ?? \"unknown\")\"\n-      let size = \"\\(dictionary[\"maxAllowedSize\"] ?? \"unknown\")\"\n-      errorMessage = \"Attempted to download object with size of \\(total) bytes, \" +\n-        \"which exceeds the maximum size of \\(size) bytes. \" +\n-        \"Consider raising the maximum download size, or using StorageReference.write\"\n+      return StorageErrorCode.quotaExceeded.rawValue\n     case .unauthenticated:\n-      errorMessage = \"User is not authenticated, please authenticate using Firebase \" +\n-        \"Authentication and try again.\"\n+      return StorageErrorCode.unauthenticated.rawValue\n     case .unauthorized:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return StorageErrorCode.unauthorized.rawValue\n     case .retryLimitExceeded:\n-      errorMessage = \"Max retry time for operation exceeded, please try again.\"\n+      return StorageErrorCode.retryLimitExceeded.rawValue\n     case .nonMatchingChecksum:\n-      // TODO: replace with actual checksum strings when we choose to implement.\n-      errorMessage = \"Uploaded/downloaded object TODO has checksum: TODO \" +\n-        \"which does not match server checksum: TODO. Please retry the upload/download.\"\n+      return StorageErrorCode.nonMatchingChecksum.rawValue\n+    case .downloadSizeExceeded:\n+      return StorageErrorCode.downloadSizeExceeded.rawValue\n     case .cancelled:\n-      errorMessage = \"User cancelled the upload/download.\"\n-    case .unknown, .invalidArgument: // invalidArgument fell through in the old Objective-C code.\n-      errorMessage = \"An unknown error occurred, please check the server response.\"\n+      return StorageErrorCode.cancelled.rawValue\n+    case .invalidArgument:\n+      return StorageErrorCode.invalidArgument.rawValue\n+    case .internalError:\n+      return StorageErrorCode.internalError.rawValue\n+    case .bucketMismatch:\n+      return StorageErrorCode.bucketMismatch.rawValue\n+    case .pathError:\n+      return StorageErrorCode.pathError.rawValue\n     }\n-    dictionary[NSLocalizedDescriptionKey] = errorMessage\n-    return NSError(domain: StorageErrorDomain, code: code.rawValue, userInfo: dictionary)\n   }\n-}\n-\n-public enum StorageError: Error {\n-  case unknown(String)\n-  case objectNotFound(String)\n-  case bucketNotFound(String)\n-  case projectNotFound(String)\n-  case quotaExceeded(String)\n-  case unauthenticated\n-  case unauthorized(String, String)\n-  case retryLimitExceeded\n-  case nonMatchingChecksum\n-  case downloadSizeExceeded(Int64, Int64)\n-  case cancelled\n-  case invalidArgument(String)\n-  case internalError(String)\n-  case bucketMismatch(String)\n-  case pathError(String)\n \n-  static func swiftConvert(objcError: NSError) -> StorageError {\n-    let userInfo = objcError.userInfo\n-\n-    switch objcError.code {\n-    case StorageErrorCode.unknown.rawValue:\n-      return StorageError.unknown(objcError.localizedDescription)\n-    case StorageErrorCode.objectNotFound.rawValue:\n-      guard let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode object not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.objectNotFound(object)\n-    case StorageErrorCode.bucketNotFound.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode bucket not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.bucketNotFound(bucket)\n-    case StorageErrorCode.projectNotFound.rawValue:\n-      guard let project = userInfo[\"project\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode project not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.projectNotFound(project)\n-    case StorageErrorCode.quotaExceeded.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\"Failed to decode quota exceeded error: \\(objcError.localizedDescription)\")\n-      }\n-      return StorageError.quotaExceeded(bucket)\n-    case StorageErrorCode.unauthenticated.rawValue: return StorageError.unauthenticated\n-    case StorageErrorCode.unauthorized.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String,\n-            let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode unauthorized error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.unauthorized(bucket, object)\n-    case StorageErrorCode.retryLimitExceeded.rawValue: return StorageError.retryLimitExceeded\n-    case StorageErrorCode.nonMatchingChecksum.rawValue: return StorageError\n-      .nonMatchingChecksum\n-    case StorageErrorCode.downloadSizeExceeded.rawValue:\n-      guard let total = userInfo[\"totalSize\"] as? Int64,\n-            let maxSize = userInfo[\"maxAllowedSize\"] as? Int64 else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode downloadSizeExceeded error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.downloadSizeExceeded(total, maxSize)\n-    case StorageErrorCode.cancelled.rawValue: return StorageError.cancelled\n-    case StorageErrorCode.invalidArgument.rawValue: return StorageError\n-      .invalidArgument(objcError.localizedDescription)\n-    default: return StorageError.internalError(\"Internal error converting ObjC Error to Swift\")\n+  /// The default user-info dictionary.\n+  public var errorUserInfo: [String: Any] {\n+    switch self {\n+    case let .unknown(message, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = message\n+      return dictionary\n+    case let .objectNotFound(object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"Object \\(object) does not exist.\"\n+      return dictionary\n+    case let .bucketNotFound(bucket):\n+      return [NSLocalizedDescriptionKey: \"Bucket \\(bucket) does not exist.\"]\n+    case let .projectNotFound(project):\n+      return [NSLocalizedDescriptionKey: \"Project \\(project) does not exist.\"]\n+    case let .quotaExceeded(bucket, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n+      return dictionary\n+    case let .unauthenticated(serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"User is not authenticated, please \" +\n+        \"authenticate using Firebase Authentication and try again.\"\n+      return dictionary\n+    case let .unauthorized(bucket, object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return dictionary\n+    case .retryLimitExceeded:\n+      return [NSLocalizedDescriptionKey: \"Max retry time for operation exceeded, please try again.\"]\n+    case .nonMatchingChecksum:\n+      // TODO: replace with actual checksum strings when we choose to implement.\n+      return [NSLocalizedDescriptionKey: \"Uploaded/downloaded object TODO has checksum: TODO \" +\n+        \"which does not match server checksum: TODO. Please retry the upload/download.\"]\n+    case let .downloadSizeExceeded(total, maxSize):\n+      var dictionary: [String: Any] = [\"totalSize\": total, \"maxAllowedSize\": maxSize]\n+      dictionary[NSLocalizedDescriptionKey] = \"Attempted to download object with size of \" +\n+        \"\\(total) bytes, \" +\n+        \"which exceeds the maximum size of \\(maxSize) bytes. \" +\n+        \"Consider raising the maximum download maxSize, or using StorageReference.write\"\n+      return dictionary\n+    case .cancelled:\n+      return [NSLocalizedDescriptionKey: \"User cancelled the upload/download.\"]\n+    case let .invalidArgument(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .internalError(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .bucketMismatch(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .pathError(message):\n+      return [NSLocalizedDescriptionKey: message]\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/StorageReference.swift b/FirebaseStorage/Sources/StorageReference.swift\nindex 92a547b3f14..9e4f0c29c41 100644\n--- a/FirebaseStorage/Sources/StorageReference.swift\n+++ b/FirebaseStorage/Sources/StorageReference.swift\n@@ -399,11 +399,9 @@ import Foundation\n   open func list(maxResults: Int64,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -437,11 +435,9 @@ import Foundation\n                  pageToken: String,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -584,11 +580,10 @@ import Foundation\n   /// For maxSize API, return an error if the size is exceeded.\n   private func checkSizeOverflow(task: StorageTask, maxSize: Int64) -> NSError? {\n     if task.progress.totalUnitCount > maxSize || task.progress.completedUnitCount > maxSize {\n-      return StorageErrorCode.error(withCode: .downloadSizeExceeded,\n-                                    infoDictionary: [\n-                                      \"totalSize\": task.progress.totalUnitCount,\n-                                      \"maxAllowedSize\": maxSize,\n-                                    ])\n+      return StorageError.downloadSizeExceeded(\n+        total: task.progress.totalUnitCount,\n+        maxSize: maxSize\n+      ) as NSError\n     }\n     return nil\n   }\ndiff --git a/FirebaseStorage/Sources/StorageTaskSnapshot.swift b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\nindex 3c909d67855..d7b291b06a8 100644\n--- a/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n+++ b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n@@ -68,7 +68,7 @@ import Foundation\n        reference: StorageReference,\n        progress: Progress,\n        metadata: StorageMetadata? = nil,\n-       error: NSError? = nil) {\n+       error: Error? = nil) {\n     self.task = task\n     self.reference = reference\n     self.progress = progress\ndiff --git a/FirebaseStorage/Sources/StorageUploadTask.swift b/FirebaseStorage/Sources/StorageUploadTask.swift\nindex 8c99e8c4a28..5878b03fb04 100644\n--- a/FirebaseStorage/Sources/StorageUploadTask.swift\n+++ b/FirebaseStorage/Sources/StorageUploadTask.swift\n@@ -237,14 +237,10 @@ import Foundation\n        isFile == true {\n       return nil\n     }\n-    let userInfo = [NSLocalizedDescriptionKey:\n-      \"File at URL: \\(fileURL?.absoluteString ?? \"\") is not reachable.\"\n-      + \" Ensure file URL is not a directory, symbolic link, or invalid url.\"]\n-    return NSError(\n-      domain: StorageErrorDomain,\n-      code: StorageErrorCode.unknown.rawValue,\n-      userInfo: userInfo\n-    )\n+    return StorageError.unknown(message: \"File at URL: \\(fileURL?.absoluteString ?? \"\") is \" +\n+      \"not reachable. Ensure file URL is not \" +\n+      \"a directory, symbolic link, or invalid url.\",\n+      serverError: [:]) as NSError\n   }\n \n   func finishTaskWithStatus(status: StorageTaskStatus, snapshot: StorageTaskSnapshot) {\ndiff --git a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\nindex f8729a5b675..fa780f24a6c 100644\n--- a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n@@ -118,11 +118,29 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putDataAsync(data)\n       XCTFail(\"Unexpected success from unauthorized putData\")\n-    } catch let StorageError.unauthorized(bucket, object) {\n+    } catch let StorageError.unauthorized(bucket, object, _) {\n       XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n       XCTAssertEqual(object, objectLocation)\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unauthorized\")\n+      XCTFail(\"error failed to convert to StorageError.unauthorized  \\(error)\")\n+    }\n+  }\n+\n+  func testSimplePutDataUnauthorizedWithNSError() async throws {\n+    let objectLocation = \"ios/private/secretfile.txt\"\n+    let ref = storage.reference(withPath: objectLocation)\n+    let data = try XCTUnwrap(\"Hello Swift World\".data(using: .utf8), \"Data construction failed\")\n+    do {\n+      _ = try await ref.putDataAsync(data)\n+      XCTFail(\"Unexpected success from unauthorized putData\")\n+    } catch {\n+      let e = error as NSError\n+      XCTAssertEqual(e.domain, StorageErrorDomain)\n+      XCTAssertEqual(e.code, StorageErrorCode.unauthorized.rawValue)\n+      XCTAssertEqual(e.localizedDescription, \"User does not have permission to access\" +\n+        \" gs://ios-opensource-samples.appspot.com/ios/private/secretfile.txt.\")\n+      XCTAssertEqual(e.userInfo[\"ResponseErrorCode\"] as? Int, 403)\n+      print(e)\n     }\n   }\n \n@@ -136,13 +154,13 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putFileAsync(from: fileURL)\n       XCTFail(\"Unexpected success from putFile of a directory\")\n-    } catch let StorageError.unknown(reason) {\n+    } catch let StorageError.unknown(reason, _) {\n       XCTAssertTrue(reason.starts(with: \"File at URL:\"))\n       XCTAssertTrue(reason.hasSuffix(\n         \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n       ))\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unknown\")\n+      XCTFail(\"error failed to convert to StorageError.unknown \\(error)\")\n     }\n   }\n \ndiff --git a/FirebaseStorage/Tests/Integration/StorageIntegration.swift b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\nindex 2f407dc7427..7e93e84e7fe 100644\n--- a/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n@@ -201,7 +201,7 @@ class StorageResultTests: StorageIntegrationCommon {\n         XCTFail(\"Unexpected success from unauthorized putData\")\n       case let .failure(error as StorageError):\n         switch error {\n-        case let .unauthorized(bucket, object):\n+        case let .unauthorized(bucket, object, serverError):\n           XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n           XCTAssertEqual(object, file)\n           expectation.fulfill()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageAPITests.swift b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\nindex 02d6b06e557..0244d22f7be 100644\n--- a/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n@@ -158,6 +158,9 @@ final class StorageAPITests: XCTestCase {\n     case .downloadSizeExceeded: return code\n     case .cancelled: return code\n     case .invalidArgument: return code\n+    case .bucketMismatch: return code\n+    case .internalError: return code\n+    case .pathError: return code\n     @unknown default:\n       fatalError()\n     }\ndiff --git a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\nindex 52592be27c2..a711125d8c1 100644\n--- a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n@@ -181,7 +181,9 @@ class StorageGetMetadataTests: StorageTestHelpers {\n       fetcherService: fetcherService!.self,\n       queue: dispatchQueue!.self\n     ) { metadata, error in\n-      XCTAssertEqual((error as? NSError)!.code, StorageErrorCode.unknown.rawValue)\n+      XCTAssertNil(metadata)\n+      let nsError = try! XCTUnwrap(error as? NSError)\n+      XCTAssertEqual(nsError.code, StorageErrorCode.unknown.rawValue)\n       expectation.fulfill()\n     }\n     task.enqueue()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\nindex 56efb5cabf9..7854bedcf15 100644\n--- a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n@@ -72,7 +72,7 @@ class StorageReferenceTests: XCTestCase {\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bcket` does not match the Storage \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bcket` does not match the Storage \" +\n           \"bucket of the current instance: `bucket`\\\")\"\n       )\n     }\n@@ -95,8 +95,9 @@ class StorageReferenceTests: XCTestCase {\n   func testBadBucketScheme2() throws {\n     let url = try XCTUnwrap(URL(string: \"htttp://bucket/\"))\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n-      XCTAssertEqual(\"\\(error)\", \"pathError(\\\"Internal error: URL scheme must be one of gs://, \" +\n-        \"http://, or https://\\\")\")\n+      XCTAssertEqual(\"\\(error)\",\n+                     \"pathError(message: \\\"Internal error: URL scheme must be one of gs://, \" +\n+                       \"http://, or https://\\\")\")\n     }\n   }\n \n@@ -219,7 +220,7 @@ class StorageReferenceTests: XCTestCase {\n         XCTFail(\"Unexpected success.\", file: #file, line: #line)\n       case let .failure(error):\n         switch error {\n-        case let StorageError.unknown(message):\n+        case let StorageError.unknown(message, serverError):\n           let expectedDescription = \"File at URL: \\(dummyFileURL.absoluteString) \" +\n             \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n           XCTAssertEqual(expectedDescription, message)\ndiff --git a/FirebaseStorage/Tests/Unit/StorageTests.swift b/FirebaseStorage/Tests/Unit/StorageTests.swift\nindex ff605798ef8..bbc19194c62 100644\n--- a/FirebaseStorage/Tests/Unit/StorageTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageTests.swift\n@@ -45,7 +45,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n           \"Storage bucket of the current instance: `benwu-test1.storage.firebase.com`\\\")\"\n       )\n     }\n@@ -126,7 +126,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bucket` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bucket` does not match the \" +\n           \"Storage bucket of the current instance: `notMyBucket`\\\")\"\n       )\n     }\n", "instance_id": "firebase__firebase-ios-sdk-13114", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `FirebaseStorage.StorageError` enum in Swift does not provide sufficient information from the underlying `NSError` object, particularly the `userInfo` dictionary, which is lost during conversion from Objective-C to Swift. The goal is to enhance error handling by making `StorageError` conform to `CustomNSError` to expose more detailed error information. The description includes relevant context, such as the Firebase SDK version, Xcode version, and the specific API (`StorageReference.writeAsync()`) causing the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected format or content of the `userInfo` dictionary to be exposed, nor does it provide specific examples of server responses or error scenarios to be handled. Additionally, while the issue is reproducible by the user, no concrete steps or code snippets for reproduction are provided, which could aid in understanding the problem's scope. Overall, the statement is valid and clear but lacks some finer details and examples that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is significant, spanning multiple files (e.g., `StorageError.swift`, `StorageReference.swift`, `AsyncAwait.swift`, and various test files) within the Firebase Storage SDK. These changes involve refactoring the core error handling mechanism, which is a critical part of the library, potentially impacting many dependent components and requiring a deep understanding of the codebase's architecture. Second, the technical concepts involved are moderately complex, including Swift's error handling model, conformance to `CustomNSError`, interoperability between Objective-C and Swift, and familiarity with Firebase's internal error mapping logic. Third, the modifications require careful handling of edge cases, such as ensuring backward compatibility (noted as a breaking change in the changelog), correctly mapping server error codes to Swift enum cases, and updating test cases to validate the new behavior. While the problem does not involve advanced algorithms or system-level considerations, it demands a solid grasp of language-specific nuances (Swift/Obj-C bridging) and library-specific design patterns. The impact on the system is notable, as error handling is a foundational aspect, and the changes could affect user-facing behavior. Therefore, I assign a difficulty score of 0.65, reflecting the need for deep understanding and careful implementation across multiple modules, balanced by the absence of extremely advanced technical challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Regression: `win.getNativeWindowHandle()` is broken on macOS\n### Confirmation\n\n- [x] I am a [maintainer](https://github.com/orgs/electron/people) of the Electron project. (If not, please create a [different issue type](https://github.com/electron/electron/issues/new/).)\n\n### Description\n\n## Summary\n\nFor [about a month now](https://chromium-review.googlesource.com/c/chromium/src/+/6361987), `getNativeWindowHandle()` is no longer returning a `NSView*` on macOS.\n\nI found this bug today when [this new buffer safety PR](https://github.com/electron/electron/pull/46724) surfaced it. So I guess that PR is doing its job! \ud83d\ude06\n\nWe also have a [spec](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/spec/api-browser-window-spec.ts#L6281) that should detect this, but it seems to be [disabled in CI](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/.github/workflows/pipeline-segment-electron-test.yml#L195).\n\n## Storytime\n\n`BaseWindow::GetNativeWindowHandle()` works by doing a bytewise copy of NativeWindowHandle, which on macOS is a typedef for the Chromium type `gfx::NativeView`.\n\nIn the very early days of Electron, `gfx::NativeView` was, in fact, a `NSView*` and so the code worked as expected.\n\nThis changed in October 2018 with the [upstream change](https://chromium-review.googlesource.com/c/1270343) \"Make gfx::NativeView and gfx::NativeWindow not be NSView and NSWindow\".  Happily, the new type was a wrapper class whose only field was the `NSView` pointer, so a bytewise copy worked anyway. The code still worked as expected... by accident. \n\nThe type changed again [in March 2025](https://chromium-review.googlesource.com/c/chromium/src/+/6361987). It's now a subclass of [base::apple::WeakNSView](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#59) which [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#78) a `std::unique_ptr`. If that was a pointer to a NSView, in theory a bytewise copy would _still_ work as before due to the same lucky accident. Unfortunately, it's a pointer to [an opaque data type](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#13) that in turn [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#14) a NSView*. So instead of returning a `NSView*`, the bytewise copy is now returning a `NSView**`. \ud83d\ude35\n\n**BUT!** To add insult to injury, it's a little worse than that. Since the new wrapper class [also has another field](https://chromium-review.googlesource.com/c/chromium/src/+/6361987/10/ui/gfx/native_widget_types.h), we're also writing another `sizeof(uintptr_t)` bytes at the end of that `NSView**`. \n\n", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex ea1637c990309..45fafbdb52eb5 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -125,6 +125,7 @@ filenames = {\n     \"shell/browser/animation_util.h\",\n     \"shell/browser/animation_util_mac.mm\",\n     \"shell/browser/api/electron_api_app_mac.mm\",\n+    \"shell/browser/api/electron_api_base_window_mac.mm\",\n     \"shell/browser/api/electron_api_menu_mac.h\",\n     \"shell/browser/api/electron_api_menu_mac.mm\",\n     \"shell/browser/api/electron_api_native_theme_mac.mm\",\ndiff --git a/shell/browser/api/electron_api_base_window.cc b/shell/browser/api/electron_api_base_window.cc\nindex 848cc6cc2c9f8..a7983dd39c8bc 100644\n--- a/shell/browser/api/electron_api_base_window.cc\n+++ b/shell/browser/api/electron_api_base_window.cc\n@@ -70,6 +70,7 @@ namespace electron::api {\n \n namespace {\n \n+#if !BUILDFLAG(IS_MAC)\n // Converts binary data to Buffer.\n v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n@@ -78,6 +79,7 @@ v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n [[nodiscard]] constexpr std::array<int, 2U> ToArray(const gfx::Size size) {\n   return {size.width(), size.height()};\n@@ -778,6 +780,7 @@ std::string BaseWindow::GetMediaSourceId() const {\n   return window_->GetDesktopMediaID().ToString();\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   // TODO(MarshallOfSound): Replace once\n   // https://chromium-review.googlesource.com/c/chromium/src/+/1253094/ has\n@@ -785,6 +788,7 @@ v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   NativeWindowHandle handle = window_->GetNativeWindowHandle();\n   return ToBuffer(isolate(), &handle, sizeof(handle));\n }\n+#endif\n \n void BaseWindow::SetProgressBar(double progress, gin_helper::Arguments* args) {\n   gin_helper::Dictionary options;\ndiff --git a/shell/browser/api/electron_api_base_window_mac.mm b/shell/browser/api/electron_api_base_window_mac.mm\nnew file mode 100644\nindex 0000000000000..148ec216283f7\n--- /dev/null\n+++ b/shell/browser/api/electron_api_base_window_mac.mm\n@@ -0,0 +1,32 @@\n+// Copyright (c) 2025 Microsoft, Inc.\n+// Use of this source code is governed by the MIT license that can be\n+// found in the LICENSE file.\n+\n+#include \"shell/browser/api/electron_api_base_window.h\"\n+\n+#include \"electron/buildflags/buildflags.h\"\n+#include \"shell/browser/api/electron_api_view.h\"\n+#include \"shell/browser/native_window.h\"\n+#include \"shell/common/node_includes.h\"\n+\n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+namespace electron::api {\n+\n+v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n+  NSView* handle = window_->GetNativeWindowHandle().GetNativeNSView();\n+  return ToBuffer(isolate(), &handle, sizeof(handle));\n+}\n+\n+}  // namespace electron::api\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex 0779c4919b29a..bf5f6ec4b44b2 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -3743,15 +3743,17 @@ void WebContents::SetDevToolsWebContents(const WebContents* devtools) {\n     inspectable_web_contents_->SetDevToolsWebContents(devtools->web_contents());\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n   gfx::NativeView ptr = web_contents()->GetNativeView();\n-  auto buffer = node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr),\n-                                   sizeof(gfx::NativeView));\n+  auto buffer =\n+      node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr), sizeof(ptr));\n   if (buffer.IsEmpty())\n     return v8::Null(isolate);\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n v8::Local<v8::Value> WebContents::DevToolsWebContents(v8::Isolate* isolate) {\n   if (devtools_web_contents_.IsEmpty())\ndiff --git a/shell/browser/api/electron_api_web_contents_mac.mm b/shell/browser/api/electron_api_web_contents_mac.mm\nindex 52c4362839610..1358b3dde95da 100644\n--- a/shell/browser/api/electron_api_web_contents_mac.mm\n+++ b/shell/browser/api/electron_api_web_contents_mac.mm\n@@ -6,6 +6,7 @@\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n+#include \"shell/common/node_includes.h\"\n #include \"ui/base/cocoa/command_dispatcher.h\"\n #include \"ui/base/cocoa/nsmenu_additions.h\"\n #include \"ui/base/cocoa/nsmenuitem_additions.h\"\n@@ -92,4 +93,22 @@ - (void)redispatchKeyEvent:(NSEvent*)event;\n   return false;\n }\n \n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n+  NSView* handle = web_contents()->GetNativeView().GetNativeNSView();\n+  return ToBuffer(isolate, &handle, sizeof(handle));\n+}\n+\n }  // namespace electron::api\ndiff --git a/shell/browser/native_window.h b/shell/browser/native_window.h\nindex cc4d150ca72b1..831cf8947aa85 100644\n--- a/shell/browser/native_window.h\n+++ b/shell/browser/native_window.h\n@@ -58,9 +58,9 @@ class BrowserView;\n }\n \n #if BUILDFLAG(IS_MAC)\n-typedef gfx::NativeView NativeWindowHandle;\n+using NativeWindowHandle = gfx::NativeView;\n #else\n-typedef gfx::AcceleratedWidget NativeWindowHandle;\n+using NativeWindowHandle = gfx::AcceleratedWidget;\n #endif\n \n class NativeWindow : public base::SupportsUserData,\n", "instance_id": "electron__electron-46733", "clarity": 3, "difficulty": 0.65, "clarity_explanation": "The problem statement is exceptionally detailed and comprehensive. It provides a clear summary of the issue, explaining that `win.getNativeWindowHandle()` no longer returns the expected `NSView*` on macOS due to upstream changes in Chromium. The description includes a historical context (\"Storytime\") that outlines how the issue evolved over time due to changes in the `gfx::NativeView` type, and it precisely identifies the root cause of the bug (a bytewise copy returning a `NSView**` instead of `NSView*`, compounded by additional field misalignment). The statement also references relevant upstream changes, PRs, and even disabled CI tests, providing a full picture of the issue. There are no significant ambiguities; the goal (fix the return value of `getNativeWindowHandle()` on macOS), the cause, and the expected behavior are all well-defined. While edge cases are not explicitly mentioned, the depth of technical detail and context compensates for this minor omission, making it a comprehensive problem description.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes involves multiple files and requires platform-specific handling (macOS), as seen in the addition of new files (`electron_api_base_window_mac.mm`) and modifications to existing ones (`electron_api_base_window.cc`, `electron_api_web_contents_mac.mm`, etc.). The changes are not trivial; they involve conditional compilation (`#if !BUILDFLAG(IS_MAC)`) to separate macOS-specific logic from other platforms, indicating a need to understand cross-platform code organization. Second, the technical concepts required include familiarity with Chromium's `gfx::NativeView` type, macOS-specific Objective-C++ programming (e.g., handling `NSView*` pointers), and Node.js integration (e.g., converting native handles to V8 buffers). Additionally, the problem demands an understanding of memory layout and pointer dereferencing issues caused by upstream type changes, which is a nuanced and error-prone area. Third, while edge cases are not explicitly mentioned in the problem statement, the code changes suggest potential risks around pointer handling and memory safety, especially given the historical \"lucky accidents\" in bytewise copying. Finally, the impact is significant as it fixes a regression in a core API (`getNativeWindowHandle()`), which likely affects downstream consumers of the Electron framework. However, it does not reach the \"Very Hard\" category (0.8-1.0) because it does not involve system-level redesign or highly complex algorithms; it is more about precise, platform-specific adjustments within a well-defined scope. A score of 0.65 reflects the need for deep understanding of the codebase and careful handling of platform-specific details, but not the extreme complexity of, say, architectural overhauls or novel algorithm design.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.80, "human_difficulty_modify_explanation":"As we all know, pointer management in C++ is notoriously troublesome, especially when it comes to cross-platform collaboration."}
{"problem_statement": "[Documentation request] Explain why someone might enable the fuse `loadBrowserProcessSpecificV8Snapshot`\nThe [documentation](https://www.electronjs.org/docs/latest/tutorial/fuses#loadbrowserprocessspecificv8snapshot) of the fuse `loadBrowserProcessSpecificV8Snapshot` does not explain in which cases it would make sense to enable the fuse, i.e. why someone would want the browser process to use a separate V8 snapshot or what benefits and drawbacks that brings with it.\n\nIt would be great if that could be documented.\n", "patch": "diff --git a/docs/tutorial/fuses.md b/docs/tutorial/fuses.md\nindex 3e644f02dcad9..1afa53d6a7df3 100644\n--- a/docs/tutorial/fuses.md\n+++ b/docs/tutorial/fuses.md\n@@ -68,6 +68,10 @@ The onlyLoadAppFromAsar fuse changes the search system that Electron uses to loc\n \n The loadBrowserProcessSpecificV8Snapshot fuse changes which V8 snapshot file is used for the browser process.  By default Electron's processes will all use the same V8 snapshot file.  When this fuse is enabled the browser process uses the file called `browser_v8_context_snapshot.bin` for its V8 snapshot. The other processes will use the V8 snapshot file that they normally do.\n \n+V8 snapshots can be useful to improve app startup performance. V8 lets you take snapshots of initialized heaps and then load them back in to avoid the cost of initializing the heap.\n+\n+Using separate snapshots for renderer processes and the main process can improve security, especially to make sure that the renderer doesn't use a snapshot with `nodeIntegration` enabled. See [#35170](https://github.com/electron/electron/issues/35170) for details.\n+\n ### `grantFileProtocolExtraPrivileges`\n \n **Default:** Enabled\n", "instance_id": "electron__electron-44710", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in its intent: it requests additional documentation for the `loadBrowserProcessSpecificV8Snapshot` fuse in Electron, specifically asking for an explanation of why someone might enable it and the associated benefits and drawbacks. The goal is well-defined, and the context (a link to the existing documentation) is provided. However, there are minor ambiguities, such as the lack of specific guidance on the depth or technical detail expected in the explanation (e.g., should it include performance metrics, security implications, or specific use cases?). Additionally, while the problem is straightforward, it assumes some familiarity with Electron and V8 snapshots, which might not be explicitly clear to all readers. Hence, it falls under \"Mostly Clear\" with minor details missing.", "difficulty_explanation": "The difficulty of this task is very low, falling in the 0.0-0.2 range. The task involves adding a small amount of explanatory text to an existing documentation file (`fuses.md`), as shown in the code changes. The scope of the change is minimal, confined to a single file with just a few lines of added content. It does not require modifying any functional code, understanding complex interactions within the codebase, or impacting the system's architecture. The technical concepts involved are relatively basic\u2014knowledge of V8 snapshots and their role in Electron's performance and security is sufficient, and the provided code change already demonstrates an understanding of these concepts (e.g., referencing improved startup performance and security benefits). No edge cases or error handling are relevant since this is purely a documentation task. The primary challenge might be ensuring the explanation is accurate and concise, but this does not require deep technical expertise beyond a surface-level understanding of Electron's architecture. Therefore, I assess this as a very easy task.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: zstd is not enabled in accept-encoding\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n31.3.1\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nany\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n_No response_\r\n\r\n### Expected Behavior\r\n\r\nzstd is a supported content encoding method, and the accept-encoding should be \"gzip, deflate, br, zstd\"\r\n\r\n<img width=\"920\" alt=\"\u622a\u5c4f2024-07-31 06 43 43\" src=\"https://github.com/user-attachments/assets/11d536fd-f7bd-4a31-93cb-36960de0dfea\">\r\n\r\n\r\n### Actual Behavior\r\n\r\nit's not enabled even it's forcely enabled it in network conditions panel, the accept-encoding header is still \"gzip, deflate, br\".\r\n<img width=\"812\" alt=\"\u622a\u5c4f2024-07-31 06 40 16\" src=\"https://github.com/user-attachments/assets/c47a5f8a-9393-40a2-a1fb-ef81695a9be5\">\r\n\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nJust start the default electron fiddle, open the dev tools and set location.href to any site for example 'https://www.google.com/' then check the request headers in network panel.\n", "patch": "diff --git a/shell/browser/net/system_network_context_manager.cc b/shell/browser/net/system_network_context_manager.cc\nindex be839e174243c..8b8beac393cfb 100644\n--- a/shell/browser/net/system_network_context_manager.cc\n+++ b/shell/browser/net/system_network_context_manager.cc\n@@ -195,6 +195,8 @@ SystemNetworkContextManager::CreateDefaultNetworkContextParams() {\n void SystemNetworkContextManager::ConfigureDefaultNetworkContextParams(\n     network::mojom::NetworkContextParams* network_context_params) {\n   network_context_params->enable_brotli = true;\n+  network_context_params->enable_zstd =\n+      base::FeatureList::IsEnabled(net::features::kZstdContentEncoding);\n \n   network_context_params->enable_referrers = true;\n \n", "instance_id": "electron__electron-43150", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the 'zstd' content encoding is not included in the 'accept-encoding' header of HTTP requests in Electron, even when forcibly enabled in the network conditions panel. The expected behavior (\"gzip, deflate, br, zstd\") and actual behavior (\"gzip, deflate, br\") are explicitly stated, and screenshots are provided for visual reference, which aids in understanding the issue. Additionally, steps to reproduce the bug are given, which helps in validating the problem. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this issue affects all platforms or only Windows (despite the reporter using Windows), and there are no mentions of specific edge cases or constraints (e.g., does this depend on specific server configurations or Electron settings?). Furthermore, there is no discussion of potential side effects or compatibility issues that enabling 'zstd' might introduce. Due to these minor gaps, the clarity score is set to 2 (Mostly Clear) rather than 3.", "difficulty_explanation": "The difficulty of solving this problem is relatively low, falling into the 'Easy' category (0.2-0.4). Let's break this down based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is minimal, involving only a single file (`system_network_context_manager.cc`) and the addition of two lines to enable 'zstd' content encoding based on a feature flag. This modification is localized and does not appear to impact the broader system architecture or require changes across multiple modules. The change is straightforward and does not necessitate a deep understanding of the Electron codebase beyond the specific network context configuration.\n\n2. **Number of Technical Concepts:** The solution requires basic knowledge of C++ (the language used in the Electron codebase) and a rudimentary understanding of network context parameters in Electron/Chromium. The concept of content encoding (e.g., 'zstd', 'brotli') is relevant but not complex, as the change simply toggles a flag based on a feature list. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic HTTP headers and content encoding are needed.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases or error conditions, and the code change does not introduce new error handling logic. However, a developer might need to consider whether enabling 'zstd' could lead to compatibility issues with servers that do not support it or potential performance implications, though these are not addressed in the provided diff. The simplicity of the change suggests that edge case handling is minimal at this stage.\n\n4. **Overall Complexity:** The task is a simple bug fix that involves enabling a feature already supported in the underlying Chromium framework (as evidenced by the feature flag `net::features::kZstdContentEncoding`). It does not require deep architectural changes or extensive debugging.\n\nGiven these points, a difficulty score of 0.25 is appropriate. It reflects an easy task that requires understanding some code logic (network context configuration) and making a simple modification, with minimal impact on the broader codebase and no significant edge case complexity mentioned in the problem or code change.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: nativeImage.createThumbnailFromPath fails to resolve in renderer process from version 25.0.0\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n29.2.0\r\n\r\n### What operating system are you using?\r\n\r\nmacOS\r\n\r\n### Operating System Version\r\n\r\n13.6 (22G116)\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n24.8.8\r\n\r\n### Expected Behavior\r\n\r\nThe function should resolve as it did in version 24.8.8, returning a thumbnail image or throwing an error if the operation fails.\r\n\r\n### Actual Behavior\r\n\r\nThe function call does not resolve or throw errors, leaving the operation in an unresolved state.\r\n\r\n### Testcase Gist URL\r\n\r\nhttps://gist.github.com/gaodeng/05a4fefb9cde972336a1285821953df6\r\n\r\n### Additional Information\r\n\r\n_No response_\n", "patch": "diff --git a/shell/common/api/electron_api_native_image_mac.mm b/shell/common/api/electron_api_native_image_mac.mm\nindex cf9c6cdcfa37f..e45eaae9a9387 100644\n--- a/shell/common/api/electron_api_native_image_mac.mm\n+++ b/shell/common/api/electron_api_native_image_mac.mm\n@@ -14,6 +14,7 @@\n \n #include \"base/apple/foundation_util.h\"\n #include \"base/strings/sys_string_conversions.h\"\n+#include \"base/task/bind_post_task.h\"\n #include \"gin/arguments.h\"\n #include \"shell/common/gin_converters/image_converter.h\"\n #include \"shell/common/gin_helper/promise.h\"\n@@ -38,6 +39,23 @@\n   return def;\n }\n \n+void ReceivedThumbnailResult(CGSize size,\n+                             gin_helper::Promise<gfx::Image> p,\n+                             QLThumbnailRepresentation* thumbnail,\n+                             NSError* error) {\n+  if (error || !thumbnail) {\n+    std::string err_msg([error.localizedDescription UTF8String]);\n+    p.RejectWithErrorMessage(\"unable to retrieve thumbnail preview \"\n+                             \"image for the given path: \" +\n+                             err_msg);\n+  } else {\n+    NSImage* result = [[NSImage alloc] initWithCGImage:[thumbnail CGImage]\n+                                                  size:size];\n+    gfx::Image image(result);\n+    p.Resolve(image);\n+  }\n+}\n+\n // static\n v8::Local<v8::Promise> NativeImage::CreateThumbnailFromPath(\n     v8::Isolate* isolate,\n@@ -70,31 +88,15 @@\n                      size:cg_size\n                     scale:[screen backingScaleFactor]\n       representationTypes:QLThumbnailGenerationRequestRepresentationTypeAll]);\n-  __block gin_helper::Promise<gfx::Image> p = std::move(promise);\n+  __block auto block_callback = base::BindPostTaskToCurrentDefault(\n+      base::BindOnce(&ReceivedThumbnailResult, cg_size, std::move(promise)));\n+  auto completionHandler =\n+      ^(QLThumbnailRepresentation* thumbnail, NSError* error) {\n+        std::move(block_callback).Run(thumbnail, error);\n+      };\n   [[QLThumbnailGenerator sharedGenerator]\n       generateBestRepresentationForRequest:request\n-                         completionHandler:^(\n-                             QLThumbnailRepresentation* thumbnail,\n-                             NSError* error) {\n-                           if (error || !thumbnail) {\n-                             std::string err_msg(\n-                                 [error.localizedDescription UTF8String]);\n-                             dispatch_async(dispatch_get_main_queue(), ^{\n-                               p.RejectWithErrorMessage(\n-                                   \"unable to retrieve thumbnail preview \"\n-                                   \"image for the given path: \" +\n-                                   err_msg);\n-                             });\n-                           } else {\n-                             NSImage* result = [[NSImage alloc]\n-                                 initWithCGImage:[thumbnail CGImage]\n-                                            size:cg_size];\n-                             gfx::Image image(result);\n-                             dispatch_async(dispatch_get_main_queue(), ^{\n-                               p.Resolve(image);\n-                             });\n-                           }\n-                         }];\n+                         completionHandler:completionHandler];\n \n   return handle;\n }\ndiff --git a/shell/common/platform_util_mac.mm b/shell/common/platform_util_mac.mm\nindex 60419c7b28daa..32972a5dfe44f 100644\n--- a/shell/common/platform_util_mac.mm\n+++ b/shell/common/platform_util_mac.mm\n@@ -15,11 +15,15 @@\n #include \"base/apple/osstatus_logging.h\"\n #include \"base/files/file_path.h\"\n #include \"base/files/file_util.h\"\n+#include \"base/functional/bind.h\"\n #include \"base/functional/callback.h\"\n #include \"base/logging.h\"\n #include \"base/mac/scoped_aedesc.h\"\n #include \"base/strings/stringprintf.h\"\n #include \"base/strings/sys_string_conversions.h\"\n+#include \"base/task/thread_pool.h\"\n+#include \"content/public/browser/browser_task_traits.h\"\n+#include \"content/public/browser/browser_thread.h\"\n #include \"net/base/apple/url_conversions.h\"\n #include \"ui/views/widget/widget.h\"\n #include \"url/gurl.h\"\n@@ -183,15 +187,12 @@ void OpenExternal(const GURL& url,\n     return;\n   }\n \n-  bool activate = options.activate;\n-  __block OpenCallback c = std::move(callback);\n-  dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0),\n-                 ^{\n-                   __block std::string error = OpenURL(ns_url, activate);\n-                   dispatch_async(dispatch_get_main_queue(), ^{\n-                     std::move(c).Run(error);\n-                   });\n-                 });\n+  base::ThreadPool::PostTaskAndReplyWithResult(\n+      FROM_HERE,\n+      {base::MayBlock(), base::WithBaseSyncPrimitives(),\n+       base::TaskPriority::USER_BLOCKING,\n+       base::TaskShutdownBehavior::SKIP_ON_SHUTDOWN},\n+      base::BindOnce(&OpenURL, ns_url, options.activate), std::move(callback));\n }\n \n bool MoveItemToTrashWithError(const base::FilePath& full_path,\ndiff --git a/spec/api-native-image-spec.ts b/spec/api-native-image-spec.ts\nindex 7e055dd6a169f..d498214942af9 100644\n--- a/spec/api-native-image-spec.ts\n+++ b/spec/api-native-image-spec.ts\n@@ -1,6 +1,6 @@\n import { expect } from 'chai';\n import { nativeImage } from 'electron/common';\n-import { ifdescribe, ifit } from './lib/spec-helpers';\n+import { ifdescribe, ifit, itremote, useRemoteContext } from './lib/spec-helpers';\n import * as path from 'node:path';\n \n describe('nativeImage module', () => {\n@@ -426,6 +426,8 @@ describe('nativeImage module', () => {\n   });\n \n   ifdescribe(process.platform !== 'linux')('createThumbnailFromPath(path, size)', () => {\n+    useRemoteContext({ webPreferences: { contextIsolation: false, nodeIntegration: true } });\n+\n     it('throws when invalid size is passed', async () => {\n       const badSize = { width: -1, height: -1 };\n \n@@ -473,6 +475,13 @@ describe('nativeImage module', () => {\n       const result = await nativeImage.createThumbnailFromPath(imgPath, maxSize);\n       expect(result.getSize()).to.deep.equal(maxSize);\n     });\n+\n+    itremote('works in the renderer', async (path: string) => {\n+      const { nativeImage } = require('electron');\n+      const goodSize = { width: 100, height: 100 };\n+      const result = await nativeImage.createThumbnailFromPath(path, goodSize);\n+      expect(result.isEmpty()).to.equal(false);\n+    }, [path.join(fixturesPath, 'assets', 'logo.png')]);\n   });\n \n   describe('addRepresentation()', () => {\ndiff --git a/spec/api-shell-spec.ts b/spec/api-shell-spec.ts\nindex 749677311bd57..a2e9cef96ff8c 100644\n--- a/spec/api-shell-spec.ts\n+++ b/spec/api-shell-spec.ts\n@@ -31,7 +31,7 @@ describe('shell module', () => {\n     });\n     afterEach(closeAllWindows);\n \n-    it('opens an external link', async () => {\n+    async function urlOpened () {\n       let url = 'http://127.0.0.1';\n       let requestReceived: Promise<any>;\n       if (process.platform === 'linux') {\n@@ -53,12 +53,26 @@ describe('shell module', () => {\n         url = (await listen(server)).url;\n         requestReceived = new Promise<void>(resolve => server.on('connection', () => resolve()));\n       }\n+      return { url, requestReceived };\n+    }\n \n+    it('opens an external link', async () => {\n+      const { url, requestReceived } = await urlOpened();\n       await Promise.all<void>([\n         shell.openExternal(url),\n         requestReceived\n       ]);\n     });\n+\n+    it('opens an external link in the renderer', async () => {\n+      const { url, requestReceived } = await urlOpened();\n+      const w = new BrowserWindow({ show: false, webPreferences: { sandbox: false, contextIsolation: false, nodeIntegration: true } });\n+      await w.loadURL('about:blank');\n+      await Promise.all<void>([\n+        w.webContents.executeJavaScript(`require(\"electron\").shell.openExternal(${JSON.stringify(url)})`),\n+        requestReceived\n+      ]);\n+    });\n   });\n \n   describe('shell.trashItem()', () => {\n", "instance_id": "electron__electron-41875", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: the `nativeImage.createThumbnailFromPath` function fails to resolve or throw errors in the renderer process starting from Electron version 25.0.0, whereas it worked correctly in version 24.8.8. The expected behavior (resolving with a thumbnail or throwing an error) and actual behavior (unresolved state) are explicitly stated, which provides a good foundation for understanding the bug. Additionally, relevant details such as the Electron version, operating system (macOS), and architecture (x64) are provided, along with a test case gist URL for reproducibility. However, the statement lacks specific details about potential causes or contexts in which the issue occurs (e.g., specific file types or paths that fail). Edge cases or constraints are not mentioned, which could be critical for a complete understanding of the problem scope. Therefore, while the problem is valid and mostly clear, minor details are missing, warranting a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI assess the difficulty of this problem as 0.65, placing it in the \"Hard\" range (0.6-0.8), based on the following analysis of the factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem statement is mostly clear, the lack of detail about specific failure conditions or edge cases adds some complexity to diagnosing the root cause. The issue involves asynchronous behavior and inter-process communication in Electron (between main and renderer processes), which inherently increases the logical complexity.\n\n2. **Scope and Depth of Code Changes**: The provided code changes span multiple files (`electron_api_native_image_mac.mm`, `platform_util_mac.mm`, and test files `api-native-image-spec.ts` and `api-shell-spec.ts`), indicating a moderate scope. The primary fix in `electron_api_native_image_mac.mm` involves refactoring the asynchronous handling of thumbnail generation using `base::BindPostTask` to ensure proper thread dispatching, which suggests a need to understand Electron's threading model and macOS-specific APIs (`QLThumbnailGenerator`). The changes in `platform_util_mac.mm` address a related issue with external URL opening, also involving threading adjustments. While the changes are not architecturally significant, they require understanding interactions between Electron's main and renderer processes, as well as macOS-specific APIs. The amount of code change is moderate, with significant logic modifications rather than trivial updates.\n\n3. **Number of Technical Concepts to Understand**: Solving this problem requires familiarity with several concepts: (a) Electron's architecture, particularly the distinction between main and renderer processes and how promises are handled across them; (b) macOS-specific APIs like `QLThumbnailGenerator` for thumbnail generation; (c) C++ threading and asynchronous programming using `base::BindPostTask` and dispatch queues; (d) V8 JavaScript engine integration with native code via `gin_helper::Promise`; and (e) testing in Electron, as evidenced by updates to test specs. These concepts are moderately complex, especially for someone not deeply familiar with Electron's internals or macOS development.\n\n4. **Potential Edge Cases and Error Handling Requirements**: The problem statement does not explicitly mention edge cases, but the code changes address error handling by properly rejecting promises with detailed error messages when thumbnail generation fails. The fix also ensures that callbacks are executed on the correct thread, which is critical for avoiding deadlocks or unresolved promises. Potential edge cases include invalid file paths, unsupported file types for thumbnails, or permissions issues on macOS, which are not explicitly handled in the diff but may need consideration. The error handling logic added is non-trivial due to the asynchronous nature of the operation.\n\nOverall, this problem requires a deep understanding of Electron's threading model, macOS APIs, and asynchronous programming in C++. The changes impact multiple files and involve moderate complexity in ensuring proper promise resolution across processes. While it does not involve a complete architectural overhaul or extremely advanced concepts, it is challenging enough to be classified as \"Hard\" with a score of 0.65, reflecting the need for specialized knowledge and careful handling of asynchronous behavior.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1, "human_difficulty_explanation": -1}
{"problem_statement": "[Windows] Scons isn't detecting MinGW and fails when building\n### Tested versions\n\n- Reproducible in master (4.5.dev) - commit [6b5b84c0c50135e88691e035d3e00c68a2ae5aa4]\n- **Not** reproducible in 4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7735HS with Radeon Graphics (16 threads)\n\n### Issue description\n\nScons fails to detect MinGW (I'm using [LLVM-MinGW](https://github.com/mstorsjo/llvm-mingw/releases/)) which is included in my PATH, then complains it can't find MSVC and errors out. Scons works perfectly fine for me in 4.4 stable.\n\nThis is what I get when trying to build on master:\n\n```\n> scons\nscons: Reading SConscript files ...\nAutomatically detected platform: windows\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink', 'mslib']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\nBuilding for platform \"windows\", architecture \"x86_64\", target \"template_release\".\nKeyError: 'VSWHERE':\n  File \"D:\\Godot Dev\\godot\\SConstruct\", line 623:\n    cc_version = methods.get_compiler_version(env)\n  File \"D:\\Godot Dev\\godot\\methods.py\", line 698:\n    env[\"VSWHERE\"],\n  File \"C:\\Users\\ahmou\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python311\\site-packages\\SCons\\Environment.py\", line 603:\n    return self._dict[key]\n```\n\n### Steps to reproduce\n\nTry building on Windows with MinGW, without MSVC installed\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 31a8d07fea80..789909b22351 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -148,7 +148,9 @@ def detect_build_env_arch():\n \n \n def get_tools(env: \"SConsEnvironment\"):\n-    if os.name != \"nt\" or env.get(\"use_mingw\"):\n+    from SCons.Tool.MSCommon import msvc_exists\n+\n+    if os.name != \"nt\" or env.get(\"use_mingw\") or not msvc_exists():\n         return [\"mingw\"]\n     else:\n         msvc_arch_aliases = {\"x86_32\": \"x86\", \"arm32\": \"arm\"}\n", "instance_id": "godotengine__godot-104744", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Scons fails to detect MinGW on Windows in the master branch (Godot v4.5.dev) while it works in the stable branch (v4.4.stable). The goal is implicitly to fix the detection of MinGW to allow building without MSVC. The description includes relevant system information, tested versions, and steps to reproduce, which are helpful. However, there are minor ambiguities and missing details. For instance, it does not explicitly state the expected behavior (e.g., should Scons prioritize MinGW over MSVC or provide a fallback mechanism?) or mention specific constraints or edge cases (e.g., different MinGW versions or PATH configurations). Additionally, there are no examples of expected output or detailed error logs beyond the provided snippet. While the issue is understandable, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the easy range (0.2-0.4) due to the following analysis based on the provided factors:\n\n1. **Scope and Depth of Code Changes:** The code change is minimal and localized to a single file (`detect.py`) and a specific function (`get_tools`). It involves adding a check for MSVC existence before deciding whether to use MinGW or MSVC tools. The diff shows a small modification (adding an import and a conditional check), indicating a low amount of code change with no impact on the broader system architecture or multiple modules.\n\n2. **Number of Technical Concepts:** Solving this requires understanding Scons build system configuration, specifically how tools are detected and prioritized on Windows. It also involves familiarity with the Scons API (e.g., `msvc_exists()` from `SCons.Tool.MSCommon`) and basic Python scripting. These concepts are relatively straightforward for someone with build system experience, though they might be less familiar to a general developer without specific Scons knowledge.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the nature of the issue suggests potential considerations like different MinGW installations, PATH misconfigurations, or scenarios where both MSVC and MinGW are present. The provided code change does not address these explicitly, and no additional error handling logic is introduced in the diff. The complexity of edge cases appears low at this stage, as the fix focuses on a basic detection check.\n\n4. **Overall Assessment:** The problem requires understanding a specific part of the build system logic and making a simple conditional modification. It does not involve complex algorithms, deep architectural changes, or advanced language features. The main challenge lies in knowing the Scons tool detection mechanism, which is a moderate but not overly complex concept. Therefore, I assign a difficulty score of 0.35, reflecting an easy problem that requires some targeted knowledge and minimal code changes but is not trivially solvable by a complete novice.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "RichTextLabel table with padding and BBCode enabled cause misalignment\n### Tested versions\n\nv4.5.dev.custom_build.6b4fda04c\n\n### System information\n\nGodot v4.5.dev (6b4fda04c) - Ubuntu 22.04.5 LTS 22.04 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - D3D12 (AMD Radeon(TM) Graphics) - AMD Ryzen 5 5600H with Radeon Graphics (12 threads)\n\n### Issue description\n\nWhen using a RichTextLabel with BBCode enabled, tables with padding display incorrect horizontal and vertical alignment. This issue only occurs when BBCode is enabled.\nI would like to fix this bug as my first contribution to Godot. I'm already investigating the offset calculation in the relevant functions and would appreciate any guidance from the maintainers on the correct approach.\n\nhttps://github.com/user-attachments/assets/b1a6895c-f446-4fa2-b885-6757e4ca36d9\n\n### Steps to reproduce\n\n1.Create a RichTextLabel node\n2.Enable BBCode (set bbcode_enabled = true)\n3.Set text content with a table that includes padding, for example:\n```\n[table=1]\n[cell bg=black padding=20,20,20,20]Lorem ipsum dolor sit amet, consectetur adipiscing elit.[/cell]\n[/table]\n```\n\n\n### Minimal reproduction project (MRP)\n\n[padding-misalignment.zip](https://github.com/user-attachments/files/19135134/padding-misalignment.zip)\n", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex 19d59e53c99f..d3648c9faf02 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -685,6 +685,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t} else {\n \t\t\tp_table->total_width += p_table->columns[i].width;\n \t\t}\n+\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t}\n \n \t// Resize to max_width if needed and distribute the remaining space.\n@@ -702,6 +703,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\tp_table->columns[i].width = p_table->columns[i].max_width;\n \t\t\t\tp_table->total_width -= dif;\n \t\t\t\ttotal_ratio -= p_table->columns[i].expand_ratio;\n+\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t}\n \t\t}\n \t\t// Grow.\n@@ -715,6 +717,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\t\t\tint incr = MIN(dif, slice);\n \t\t\t\t\t\tp_table->columns[i].width += incr;\n \t\t\t\t\t\tp_table->total_width += incr;\n+\t\t\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n@@ -745,6 +748,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \n \t\t\tframe->lines[i].text_buf->set_width(p_table->columns[column].width);\n \t\t\tp_table->columns[column].width = MAX(p_table->columns[column].width, ceil(frame->lines[i].text_buf->get_size().x));\n+\t\t\tp_table->columns[column].width_with_padding = MAX(p_table->columns[column].width_with_padding, ceil(frame->lines[i].text_buf->get_size().x + frame->padding.position.x + frame->padding.size.x));\n \n \t\t\tframe->lines[i].offset.y = prev_h;\n \n@@ -780,6 +784,12 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t}\n \t\tidx++;\n \t}\n+\n+\t// Recalculate total width.\n+\tp_table->total_width = 0;\n+\tfor (int i = 0; i < col_count; i++) {\n+\t\tp_table->total_width += p_table->columns[i].width_with_padding + theme_cache.table_h_separation;\n+\t}\n }\n \n int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_ofs, int p_width, float p_vsep, const Color &p_base_color, int p_outline_size, const Color &p_outline_color, const Color &p_font_shadow_color, int p_shadow_outline_size, const Point2 &p_shadow_ofs, int &r_processed_glyphs) {\ndiff --git a/scene/gui/rich_text_label.h b/scene/gui/rich_text_label.h\nindex 013ee15c03fe..dd1cedcd8bb5 100644\n--- a/scene/gui/rich_text_label.h\n+++ b/scene/gui/rich_text_label.h\n@@ -347,6 +347,7 @@ class RichTextLabel : public Control {\n \t\t\tint min_width = 0;\n \t\t\tint max_width = 0;\n \t\t\tint width = 0;\n+\t\t\tint width_with_padding = 0;\n \t\t};\n \n \t\tLocalVector<Column> columns;\n", "instance_id": "godotengine__godot-104662", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear, earning a score of 2 (Mostly Clear). The issue is well-defined: misalignment in tables with padding in a `RichTextLabel` when BBCode is enabled in the Godot engine. The description includes specific steps to reproduce the issue, a minimal reproduction project (MRP), and relevant system information, which aids in understanding the context. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly define what \"correct\" alignment should look like, nor does it specify the expected output or behavior after the fix. Additionally, while edge cases like specific padding values or table configurations are implied, they are not explicitly mentioned. These missing details could lead to uncertainty during implementation or validation of the solution.", "difficulty_explanation": "I assign a difficulty score of 0.55, placing this problem in the medium range (0.4-0.6). Here's the breakdown based on the evaluation factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem is mostly clear, the lack of explicit expected output or detailed edge cases adds a slight layer of complexity in determining the correct fix. The logic behind table rendering and padding calculations in a graphical context (Godot engine) is moderately complex, requiring an understanding of text layout and rendering.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`rich_text_label.cpp`) and its header (`rich_text_label.h`), specifically within the table sizing logic. The modifications involve adding a new field (`width_with_padding`) to track padded widths and updating the total width calculation to account for padding and separation. The changes are relatively small (a few lines of code) and do not appear to impact the broader system architecture. However, they require understanding the existing table rendering logic and how padding interacts with width calculations, which adds some depth to the task.\n\n3. **Number of Technical Concepts**: Solving this requires familiarity with C++ (as the Godot engine is written in it), specifically struct modifications and pointer handling. Additionally, it demands domain-specific knowledge of text rendering in GUI systems, particularly how Godot's `RichTextLabel` processes BBCode and applies padding. While no advanced algorithms or design patterns are involved, understanding the rendering pipeline and offset calculations is non-trivial for someone unfamiliar with GUI programming or Godot's internals.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the nature of table rendering suggests potential issues like zero or negative padding, very large padding values, nested tables, or interactions with other BBCode features. The code changes do not introduce explicit error handling, but ensuring the fix works across various table configurations and padding values adds moderate complexity. There is also a risk of introducing new bugs in width calculations if edge cases are not considered.\n\nOverall, this problem is of medium difficulty because it requires a moderate understanding of Godot's rendering logic and careful handling of padding in table layouts. It is not a simple bug fix (e.g., changing a constant), nor is it a highly complex architectural change. It sits in the middle, requiring targeted modifications with some risk of unintended side effects if not thoroughly tested. The score of 0.55 reflects this balance, leaning slightly above the midpoint of the medium range due to the domain-specific knowledge required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Script Editor - Error Panel stays open after error fixed\n### Tested versions\n\n4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1650 (NVIDIA; 32.0.15.7260) - AMD Ryzen 3 3100 4-Core Processor (8 threads)\n\n### Issue description\n\nScript Editor - Error Panel stays open after error fixed\nin order to close the panel, need to cause an error to have the expand collapse button, this fresh first error after fix also collapses the panel.\n\n### Steps to reproduce\n\ncreate a script.\nmake an error,\nexpand the error panel\nfix the error in script\n> now you have the panel open with no errors but also no way to hide this Error Panel\n\n### Minimal reproduction project (MRP)\n\nAny simple project would do.\n", "patch": "diff --git a/editor/code_editor.cpp b/editor/code_editor.cpp\nindex bc678b5ba1be..1b77ae749e40 100644\n--- a/editor/code_editor.cpp\n+++ b/editor/code_editor.cpp\n@@ -1668,9 +1668,9 @@ void CodeTextEditor::set_error_count(int p_error_count) {\n \terror_button->set_text(itos(p_error_count));\n \terror_button->set_visible(p_error_count > 0);\n \tif (p_error_count > 0) {\n-\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time_with_errors); // Parsing should happen sooner.\n \t} else {\n+\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time);\n \t}\n }\n", "instance_id": "godotengine__godot-104169", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Script Editor's Error Panel in Godot v4.4.stable remains open even after an error is fixed, with no apparent way to close it unless another error is triggered. The steps to reproduce are straightforward and easy to follow, and the issue's context (Script Editor in Godot) is provided along with system information. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should the panel auto-close when no errors exist, or should there be a manual close button?). Additionally, there are no mentions of edge cases or specific constraints that might affect the solution. While the issue is understandable, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is minimal, as it involves a single file (`code_editor.cpp`) and a small modification to the logic in the `set_error_count` method. The change appears to address the issue by ensuring the error panel is hidden when the error count reaches zero, which is a simple adjustment. Second, the technical concepts required are basic: understanding of C++ syntax, conditional logic, and familiarity with the Godot editor's codebase structure. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic UI handling in Godot are needed. Third, the change does not impact the broader system architecture or require understanding complex interactions between modules. Finally, while the problem statement does not explicitly mention edge cases, the nature of the issue (UI panel visibility) suggests minimal complexity in error handling\u2014likely just ensuring the panel state is correctly toggled based on error count. Overall, this is a straightforward bug fix requiring minimal effort and understanding, hence a difficulty score of 0.25.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Callable.callv() will make call with wrong arguments if a const Array is passed\n### Tested versions\r\n\r\n- Reproducible in 4.3.beta2.official [b75f0485b]\r\n\r\n### System information\r\n\r\nWindows 10 - Godot 4.3.beta2.official [b75f0485b]\r\n\r\n### Issue description\r\n\r\nUsing Callable().callv() will result in a call using the wrong arguments, if the Array being passed is a const.\r\nThe bug does not occur if the Array being passed is a var.\r\nThe bug does not occur if we use Callable().bindv().call() instead.\r\n\r\n### Steps to reproduce\r\n\r\nThe following code can demonstrate the bug. The debugger does not show any errors or warnings.\r\n```extends Node2D\r\n\r\nconst arr_const = ['one','two','three','four']\r\nvar arr_var = ['one','two','three','four']\r\n\r\nfunc _ready() -> void:\r\n\t# non-const works\r\n\tsomefunc.callv(arr_var)\r\n\t# const fails\r\n\tsomefunc.callv(arr_const)\r\n\t# temporary workaround\r\n\tsomefunc.bindv(arr_const).call()\r\n\t\r\nfunc somefunc(v1,v2,v3,v4):\r\n\tprint('%s,%s,%s,%s'% [v1,v2,v3,v4])\r\n```\r\nwill print:\r\n```\r\none,two,three,four\r\nfour,four,four,four\r\none,two,three,four\r\n```\r\nThe first and third calls work as expected, with the four arguments in the arrays.\r\nOnly the second call, which used a const Array and .callv(), made a call with all arguments replaced by the last argument.\r\n\r\nIn this example, I use a function directly, but this can be reproduced with any Callable().\r\n\r\nThis seems like a similar issue as #69237, with a similar workaround, but in this case the correct number of arguments was passed.\r\n\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[callablecheck.zip](https://github.com/user-attachments/files/15974691/callablecheck.zip)\r\n\n", "patch": "diff --git a/core/variant/array.cpp b/core/variant/array.cpp\nindex d91612b420ca..2357e3f907ab 100644\n--- a/core/variant/array.cpp\n+++ b/core/variant/array.cpp\n@@ -88,11 +88,11 @@ Array::Iterator Array::end() {\n }\n \n Array::ConstIterator Array::begin() const {\n-\treturn ConstIterator(_p->array.ptr(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr());\n }\n \n Array::ConstIterator Array::end() const {\n-\treturn ConstIterator(_p->array.ptr() + _p->array.size(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr() + _p->array.size());\n }\n \n Variant &Array::operator[](int p_idx) {\n@@ -104,10 +104,6 @@ Variant &Array::operator[](int p_idx) {\n }\n \n const Variant &Array::operator[](int p_idx) const {\n-\tif (unlikely(_p->read_only)) {\n-\t\t*_p->read_only = _p->array[p_idx];\n-\t\treturn *_p->read_only;\n-\t}\n \treturn _p->array[p_idx];\n }\n \ndiff --git a/core/variant/array.h b/core/variant/array.h\nindex 841b6ff8eaa4..a796a2581171 100644\n--- a/core/variant/array.h\n+++ b/core/variant/array.h\n@@ -56,21 +56,19 @@ class Array {\n \t\t_FORCE_INLINE_ bool operator==(const ConstIterator &p_other) const { return element_ptr == p_other.element_ptr; }\n \t\t_FORCE_INLINE_ bool operator!=(const ConstIterator &p_other) const { return element_ptr != p_other.element_ptr; }\n \n-\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr, Variant *p_read_only = nullptr) :\n-\t\t\t\telement_ptr(p_element_ptr), read_only(p_read_only) {}\n+\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr) :\n+\t\t\t\telement_ptr(p_element_ptr) {}\n \t\t_FORCE_INLINE_ ConstIterator() {}\n \t\t_FORCE_INLINE_ ConstIterator(const ConstIterator &p_other) :\n-\t\t\t\telement_ptr(p_other.element_ptr), read_only(p_other.read_only) {}\n+\t\t\t\telement_ptr(p_other.element_ptr) {}\n \n \t\t_FORCE_INLINE_ ConstIterator &operator=(const ConstIterator &p_other) {\n \t\t\telement_ptr = p_other.element_ptr;\n-\t\t\tread_only = p_other.read_only;\n \t\t\treturn *this;\n \t\t}\n \n \tprivate:\n \t\tconst Variant *element_ptr = nullptr;\n-\t\tVariant *read_only = nullptr;\n \t};\n \n \tstruct Iterator {\n@@ -96,7 +94,7 @@ class Array {\n \t\t}\n \n \t\toperator ConstIterator() const {\n-\t\t\treturn ConstIterator(element_ptr, read_only);\n+\t\t\treturn ConstIterator(element_ptr);\n \t\t}\n \n \tprivate:\ndiff --git a/core/variant/variant.h b/core/variant/variant.h\nindex e38f7c9b0bae..f0bd7ec6824e 100644\n--- a/core/variant/variant.h\n+++ b/core/variant/variant.h\n@@ -997,18 +997,10 @@ Array::Iterator &Array::Iterator::operator--() {\n }\n \n const Variant &Array::ConstIterator::operator*() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn *read_only;\n-\t}\n \treturn *element_ptr;\n }\n \n const Variant *Array::ConstIterator::operator->() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn read_only;\n-\t}\n \treturn element_ptr;\n }\n \n", "instance_id": "godotengine__godot-103999", "clarity": 3, "difficulty": 0.55, "clarity_explanation": "The problem statement is comprehensive and well-structured. It clearly describes the issue with `Callable().callv()` when a const Array is passed, including the specific behavior (arguments being replaced by the last element). The goal is evident: fix the bug related to const Array handling in the Godot engine. The input, output, and constraints are implicitly defined through the provided code example and the minimal reproduction project (MRP). The steps to reproduce are detailed, and the expected versus actual output is explicitly shown. Additionally, the statement references a similar issue (#69237) for context and provides a workaround, which adds to the clarity. There are no significant ambiguities, and the problem description includes all critical details needed to understand and address the issue.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. \n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, affecting only a few files (`array.cpp`, `array.h`, and `variant.h`) in the Godot engine's core variant system. The modifications involve removing logic related to a `read_only` variable in the `ConstIterator` class and associated dereferencing operations. While the changes are not extensive in terms of lines of code, they impact a critical part of the engine (the variant and array handling system), which requires careful consideration to avoid introducing new bugs. The changes do not appear to affect the broader system architecture but do require understanding the internal representation of arrays and their const behavior.\n\n2. **Number of Technical Concepts**: Solving this problem requires a moderate understanding of C++ concepts, specifically const correctness, iterators, and pointer dereferencing. Familiarity with Godot's internal `Variant` and `Array` classes is necessary, as these are core components of the engine's type system. The bug relates to how const arrays are accessed and copied, which involves understanding memory management and the implications of removing the `read_only` workaround. While the concepts are not overly advanced, they do require a solid grasp of C++ and some domain-specific knowledge of Godot's internals.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention additional edge cases beyond the const Array issue, and the code changes do not introduce new error handling logic. However, since the fix modifies how const arrays are accessed, there is an implicit need to ensure that other use cases (e.g., different array sizes, types of elements, or concurrent access) are not adversely affected. This adds a layer of complexity to testing and validation, though it is not explicitly detailed in the problem.\n\n4. **Overall Complexity**: The problem is not trivial as it involves debugging and modifying a core component of a game engine, which inherently carries risks of unintended side effects. However, it is not extremely challenging either, as the bug is well-isolated, and the fix is straightforward once the root cause (improper handling of const arrays via `read_only`) is identified. The difficulty lies in understanding the specific behavior of Godot's `Array` class and ensuring the fix does not break other functionality, which places it in the medium range.\n\nA score of 0.55 reflects a medium difficulty level, leaning slightly above the midpoint due to the need for domain-specific knowledge of Godot and the potential impact on a critical system component, balanced by the localized nature of the changes and the clarity of the bug's manifestation.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Skeleton's deferred update process should be performed after physics interpolation\n### Tested versions\n\n- Reproduced in v4.4.beta4.official [93d270693]\n\n### System information\n\nGodot v4.4.beta4 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Ti (NVIDIA; 32.0.15.6636) - 12th Gen Intel(R) Core(TM) i9-12900K (24 threads)\n\n### Issue description\n\nEnabling physics interpolation in project settings and following procedures to manually implement interpolation for camera movement ([trying to follow this](https://docs.godotengine.org/en/3.6/tutorials/physics/interpolation/advanced_physics_interpolation.html#mouse-look)) results in the SkeletonIK3D failing to have physics interpolation while moving and looking around, while everything else is smooth:\n\nhttps://github.com/user-attachments/assets/0645a0ac-7f8b-48fe-a912-1e8695df23ec\n\n\nIt is noteworthy that disabling physics interpolation globally but keeping the manual implementation on the camera results in smooth ik movement when looking around but NOT while walking:\n\nhttps://github.com/user-attachments/assets/bf066442-43d8-4549-9d8b-55cc49cd6035\n\nIt's entirely possible I am implementing this incorrectly, in which case, better documentation/information would be really helpful, as currently it seems unclear how to properly implement first person camera mouse movement with physics interpolation on high refresh monitors and inverse kinematics.\n\n### Steps to reproduce\n\n1. Enable physics interpolation globally and turn down the physics tick rate to 10 (so the effect is more clear)\n2. Create a first person player with a camera child that is top level and has it's interpolation turned off, and manually implemented (see camera_3d.gd)\n3. Using a rigged model (provided in the MRP) attach a skeletonIK3D node and put its target to a Marker3D node that is a child of the camera\n4. Play the project and walk/look around\n\n\n### Minimal reproduction project (MRP)\n\n[firstpersontest.zip](https://github.com/user-attachments/files/18858802/firstpersontest.zip)\n", "patch": "diff --git a/core/local_vector.h b/core/local_vector.h\nindex fe14dbb494ef..5dfe273c40c7 100644\n--- a/core/local_vector.h\n+++ b/core/local_vector.h\n@@ -104,6 +104,15 @@ class LocalVector {\n \t\t}\n \t}\n \n+\tbool erase_unordered(const T &p_val) {\n+\t\tint64_t idx = find(p_val);\n+\t\tif (idx >= 0) {\n+\t\t\tremove_unordered(idx);\n+\t\t\treturn true;\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n \tU erase_multiple_unordered(const T &p_val) {\n \t\tU from = 0;\n \t\tU count = 0;\ndiff --git a/doc/classes/BoneAttachment.xml b/doc/classes/BoneAttachment.xml\nindex 8d427fbf8eb3..703a231b22d9 100644\n--- a/doc/classes/BoneAttachment.xml\n+++ b/doc/classes/BoneAttachment.xml\n@@ -14,6 +14,7 @@\n \t\t<member name=\"bone_name\" type=\"String\" setter=\"set_bone_name\" getter=\"get_bone_name\" default=\"&quot;&quot;\">\n \t\t\tThe name of the attached bone.\n \t\t</member>\n+\t\t<member name=\"physics_interpolation_mode\" type=\"int\" setter=\"set_physics_interpolation_mode\" getter=\"get_physics_interpolation_mode\" overrides=\"Node\" enum=\"Node.PhysicsInterpolationMode\" default=\"1\" />\n \t</members>\n \t<constants>\n \t</constants>\ndiff --git a/doc/classes/VehicleWheel.xml b/doc/classes/VehicleWheel.xml\nindex c51542abe72c..67a80e0bf832 100644\n--- a/doc/classes/VehicleWheel.xml\n+++ b/doc/classes/VehicleWheel.xml\n@@ -52,6 +52,7 @@\n \t\t\t[b]Note:[/b] The simulation does not take the effect of gears into account, you will need to add logic for this if you wish to simulate gears.\n \t\t\tA negative value will result in the wheel reversing.\n \t\t</member>\n+\t\t<member name=\"physics_interpolation_mode\" type=\"int\" setter=\"set_physics_interpolation_mode\" getter=\"get_physics_interpolation_mode\" overrides=\"Node\" enum=\"Node.PhysicsInterpolationMode\" default=\"1\" />\n \t\t<member name=\"steering\" type=\"float\" setter=\"set_steering\" getter=\"get_steering\" default=\"0.0\">\n \t\t\tThe steering angle for the wheel. Setting this to a non-zero value will result in the vehicle turning when it's moving.\n \t\t</member>\ndiff --git a/doc/classes/VisualServer.xml b/doc/classes/VisualServer.xml\nindex 027a4a1c2413..042fe81ba650 100644\n--- a/doc/classes/VisualServer.xml\n+++ b/doc/classes/VisualServer.xml\n@@ -1488,14 +1488,6 @@\n \t\t\t\tSets a material that will override the material for all surfaces on the mesh associated with this instance. Equivalent to [member GeometryInstance.material_override].\n \t\t\t</description>\n \t\t</method>\n-\t\t<method name=\"instance_reset_physics_interpolation\">\n-\t\t\t<return type=\"void\" />\n-\t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n-\t\t\t<description>\n-\t\t\t\tPrevents physics interpolation for the current physics tick.\n-\t\t\t\tThis is useful when moving an instance to a new location, to give an instantaneous change rather than interpolation from the previous location.\n-\t\t\t</description>\n-\t\t</method>\n \t\t<method name=\"instance_set_base\">\n \t\t\t<return type=\"void\" />\n \t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n@@ -1537,14 +1529,6 @@\n \t\t\t\tSets a margin to increase the size of the AABB when culling objects from the view frustum. This allows you to avoid culling objects that fall outside the view frustum. Equivalent to [member GeometryInstance.extra_cull_margin].\n \t\t\t</description>\n \t\t</method>\n-\t\t<method name=\"instance_set_interpolated\">\n-\t\t\t<return type=\"void\" />\n-\t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n-\t\t\t<argument index=\"1\" name=\"interpolated\" type=\"bool\" />\n-\t\t\t<description>\n-\t\t\t\tTurns on and off physics interpolation for the instance.\n-\t\t\t</description>\n-\t\t</method>\n \t\t<method name=\"instance_set_layer_mask\">\n \t\t\t<return type=\"void\" />\n \t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\ndiff --git a/scene/3d/arvr_nodes.cpp b/scene/3d/arvr_nodes.cpp\nindex 7b5e96759bf6..a68360fb6d8e 100644\n--- a/scene/3d/arvr_nodes.cpp\n+++ b/scene/3d/arvr_nodes.cpp\n@@ -613,7 +613,7 @@ void ARVROrigin::_notification(int p_what) {\n \t\t}; break;\n \t\tcase NOTIFICATION_INTERNAL_PROCESS: {\n \t\t\t// set our world origin to our node transform\n-\t\t\tarvr_server->set_world_origin(get_global_transform());\n+\t\t\tarvr_server->set_world_origin(get_global_transform_interpolated());\n \n \t\t\t// check if we have a primary interface\n \t\t\tRef<ARVRInterface> arvr_interface = arvr_server->get_primary_interface();\ndiff --git a/scene/3d/bone_attachment.cpp b/scene/3d/bone_attachment.cpp\nindex fc9f67abd526..5b2f4cd25492 100644\n--- a/scene/3d/bone_attachment.cpp\n+++ b/scene/3d/bone_attachment.cpp\n@@ -105,6 +105,7 @@ void BoneAttachment::_notification(int p_what) {\n }\n \n BoneAttachment::BoneAttachment() {\n+\tset_physics_interpolation_mode(PHYSICS_INTERPOLATION_MODE_OFF);\n \tbound = false;\n }\n \ndiff --git a/scene/3d/camera.cpp b/scene/3d/camera.cpp\nindex 8645e8567ee4..5b59a6785139 100644\n--- a/scene/3d/camera.cpp\n+++ b/scene/3d/camera.cpp\n@@ -45,6 +45,13 @@ void Camera::_request_camera_update() {\n \t_update_camera();\n }\n \n+void Camera::fti_update_servers() {\n+\tif (camera.is_valid()) {\n+\t\tTransform tr = _get_adjusted_camera_transform(_get_cached_global_transform_interpolated());\n+\t\tVisualServer::get_singleton()->camera_set_transform(camera, tr);\n+\t}\n+}\n+\n void Camera::_update_camera_mode() {\n \tforce_change = true;\n \tswitch (mode) {\n@@ -85,12 +92,8 @@ void Camera::_update_camera() {\n \tif (!is_physics_interpolated_and_enabled()) {\n \t\tVisualServer::get_singleton()->camera_set_transform(camera, get_camera_transform());\n \t} else {\n-\t\t// Ideally we shouldn't be moving a physics interpolated camera within a frame,\n-\t\t// because it will break smooth interpolation, but it may occur on e.g. level load.\n-\t\tif (!Engine::get_singleton()->is_in_physics_frame() && camera.is_valid()) {\n-\t\t\t_physics_interpolation_ensure_transform_calculated(true);\n-\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t}\n+\t\t// Force a refresh next frame.\n+\t\tfti_notify_node_changed();\n \t}\n \n \t// here goes listener stuff\n@@ -114,40 +117,6 @@ void Camera::_physics_interpolated_changed() {\n \t_update_process_mode();\n }\n \n-void Camera::_physics_interpolation_ensure_data_flipped() {\n-\t// The curr -> previous update can either occur\n-\t// on the INTERNAL_PHYSICS_PROCESS OR\n-\t// on NOTIFICATION_TRANSFORM_CHANGED,\n-\t// if NOTIFICATION_TRANSFORM_CHANGED takes place\n-\t// earlier than INTERNAL_PHYSICS_PROCESS on a tick.\n-\t// This is to ensure that the data keeps flowing, but the new data\n-\t// doesn't overwrite before prev has been set.\n-\n-\t// Keep the data flowing.\n-\tuint64_t tick = Engine::get_singleton()->get_physics_frames();\n-\tif (_interpolation_data.last_update_physics_tick != tick) {\n-\t\t_interpolation_data.xform_prev = _interpolation_data.xform_curr;\n-\t\t_interpolation_data.last_update_physics_tick = tick;\n-\t\tphysics_interpolation_flip_data();\n-\t}\n-}\n-\n-void Camera::_physics_interpolation_ensure_transform_calculated(bool p_force) const {\n-\tDEV_CHECK_ONCE(!Engine::get_singleton()->is_in_physics_frame());\n-\n-\tInterpolationData &id = _interpolation_data;\n-\tuint64_t frame = Engine::get_singleton()->get_frames_drawn();\n-\n-\tif (id.last_update_frame != frame || p_force) {\n-\t\tid.last_update_frame = frame;\n-\n-\t\tTransformInterpolator::interpolate_transform(id.xform_prev, id.xform_curr, id.xform_interpolated, Engine::get_singleton()->get_physics_interpolation_fraction());\n-\n-\t\tTransform &tr = id.camera_xform_interpolated;\n-\t\ttr = _get_adjusted_camera_transform(id.xform_interpolated);\n-\t}\n-}\n-\n void Camera::set_desired_process_modes(bool p_process_internal, bool p_physics_process_internal) {\n \t_desired_process_internal = p_process_internal;\n \t_desired_physics_process_internal = p_physics_process_internal;\n@@ -155,17 +124,8 @@ void Camera::set_desired_process_modes(bool p_process_internal, bool p_physics_p\n }\n \n void Camera::_update_process_mode() {\n-\tbool process = _desired_process_internal;\n-\tbool physics_process = _desired_physics_process_internal;\n-\n-\tif (is_physics_interpolated_and_enabled()) {\n-\t\tif (is_current()) {\n-\t\t\tprocess = true;\n-\t\t\tphysics_process = true;\n-\t\t}\n-\t}\n-\tset_process_internal(process);\n-\tset_physics_process_internal(physics_process);\n+\tset_process_internal(_desired_process_internal);\n+\tset_physics_process_internal(_desired_physics_process_internal);\n }\n \n void Camera::_notification(int p_what) {\n@@ -182,56 +142,21 @@ void Camera::_notification(int p_what) {\n \t\t\t\tviewport->_camera_set(this);\n \t\t\t}\n \t\t} break;\n-\t\tcase NOTIFICATION_INTERNAL_PROCESS: {\n-\t\t\tif (is_physics_interpolated_and_enabled() && camera.is_valid()) {\n-\t\t\t\t_physics_interpolation_ensure_transform_calculated();\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\t\t\tprint_line(\"\\t\\tinterpolated Camera: \" + rtos(_interpolation_data.xform_interpolated.origin.x) + \"\\t( prev \" + rtos(_interpolation_data.xform_prev.origin.x) + \", curr \" + rtos(_interpolation_data.xform_curr.origin.x) + \" ) on tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-#endif\n-\n-\t\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t\t}\n-\t\t} break;\n-\t\tcase NOTIFICATION_INTERNAL_PHYSICS_PROCESS: {\n-\t\t\tif (is_physics_interpolated_and_enabled()) {\n-\t\t\t\t_physics_interpolation_ensure_data_flipped();\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n-\t\t\t}\n-\t\t} break;\n \t\tcase NOTIFICATION_TRANSFORM_CHANGED: {\n-\t\t\tif (is_physics_interpolated_and_enabled()) {\n-\t\t\t\t_physics_interpolation_ensure_data_flipped();\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n #if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n \t\t\t\tif (!Engine::get_singleton()->is_in_physics_frame()) {\n \t\t\t\t\tPHYSICS_INTERPOLATION_NODE_WARNING(get_instance_id(), \"Interpolated Camera triggered from outside physics process\");\n \t\t\t\t}\n-#endif\n \t\t\t}\n+#endif\n \t\t\t_request_camera_update();\n \t\t\tif (doppler_tracking != DOPPLER_TRACKING_DISABLED) {\n \t\t\t\tvelocity_tracker->update_position(get_global_transform().origin);\n \t\t\t}\n-\t\t\t// Allow auto-reset when first adding to the tree, as a convenience.\n-\t\t\tif (_is_physics_interpolation_reset_requested() && is_inside_tree()) {\n-\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n-\t\t\t\t_set_physics_interpolation_reset_requested(false);\n-\t\t\t}\n-\n \t\t} break;\n \t\tcase NOTIFICATION_RESET_PHYSICS_INTERPOLATION: {\n-\t\t\tif (is_inside_tree()) {\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n-\t\t\t\t_interpolation_data.xform_prev = _interpolation_data.xform_curr;\n-\t\t\t\t_update_process_mode();\n-\t\t\t}\n-\t\t} break;\n-\t\tcase NOTIFICATION_PAUSED: {\n-\t\t\tif (is_physics_interpolated_and_enabled() && is_inside_tree() && is_visible_in_tree()) {\n-\t\t\t\t_physics_interpolation_ensure_transform_calculated(true);\n-\t\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t\t}\n+\t\t\t_update_process_mode();\n \t\t} break;\n \t\tcase NOTIFICATION_EXIT_WORLD: {\n \t\t\tif (!get_tree()->is_node_being_edited(this)) {\n@@ -274,8 +199,7 @@ Transform Camera::_get_adjusted_camera_transform(const Transform &p_xform) const\n \n Transform Camera::get_camera_transform() const {\n \tif (is_physics_interpolated_and_enabled() && !Engine::get_singleton()->is_in_physics_frame()) {\n-\t\t_physics_interpolation_ensure_transform_calculated();\n-\t\treturn _interpolation_data.camera_xform_interpolated;\n+\t\treturn _get_adjusted_camera_transform(_get_cached_global_transform_interpolated());\n \t}\n \n \treturn _get_adjusted_camera_transform(get_global_transform());\n@@ -865,9 +789,16 @@ float ClippedCamera::get_margin() const {\n \treturn margin;\n }\n void ClippedCamera::set_process_mode(ProcessMode p_mode) {\n-\tif (is_physics_interpolated_and_enabled() && p_mode == CLIP_PROCESS_IDLE) {\n-\t\tp_mode = CLIP_PROCESS_PHYSICS;\n-\t\tWARN_PRINT_ONCE(\"[Physics interpolation] Forcing ClippedCamera to PROCESS_PHYSICS mode.\");\n+\tif (is_physics_interpolated_and_enabled()) {\n+\t\tif (p_mode == CLIP_PROCESS_IDLE) {\n+\t\t\tp_mode = CLIP_PROCESS_PHYSICS;\n+\t\t\tWARN_PRINT_ONCE(\"[Physics interpolation] Forcing ClippedCamera to PROCESS_PHYSICS mode.\");\n+\t\t}\n+\n+\t\tprocess_mode = p_mode;\n+\n+\t\tset_desired_process_modes(false, true);\n+\t\treturn;\n \t}\n \n \tif (process_mode == p_mode) {\n@@ -881,8 +812,11 @@ ClippedCamera::ProcessMode ClippedCamera::get_process_mode() const {\n \treturn process_mode;\n }\n \n-void ClippedCamera::physics_interpolation_flip_data() {\n+void ClippedCamera::fti_pump() {\n \t_interpolation_data.clip_offset_prev = _interpolation_data.clip_offset_curr;\n+\n+\t// Must call the base class.\n+\tSpatial::fti_pump();\n }\n \n void ClippedCamera::_physics_interpolated_changed() {\n@@ -899,6 +833,11 @@ Transform ClippedCamera::_get_adjusted_camera_transform(const Transform &p_xform\n \treturn t;\n }\n \n+void ClippedCamera::fti_update_servers() {\n+\tclip_offset = ((_interpolation_data.clip_offset_curr - _interpolation_data.clip_offset_prev) * Engine::get_singleton()->get_physics_interpolation_fraction()) + _interpolation_data.clip_offset_prev;\n+\tCamera::fti_update_servers();\n+}\n+\n void ClippedCamera::_notification(int p_what) {\n \tif (p_what == NOTIFICATION_ENTER_TREE) {\n \t\t// Switch process mode to physics if we are turning on interpolation.\n@@ -966,10 +905,6 @@ void ClippedCamera::_notification(int p_what) {\n \t\t_update_camera();\n \t}\n \n-\tif (is_physics_interpolated_and_enabled() && (p_what == NOTIFICATION_INTERNAL_PROCESS)) {\n-\t\tclip_offset = ((_interpolation_data.clip_offset_curr - _interpolation_data.clip_offset_prev) * Engine::get_singleton()->get_physics_interpolation_fraction()) + _interpolation_data.clip_offset_prev;\n-\t}\n-\n \tif (p_what == NOTIFICATION_LOCAL_TRANSFORM_CHANGED) {\n \t\tupdate_gizmo();\n \t}\ndiff --git a/scene/3d/camera.h b/scene/3d/camera.h\nindex afa95b046bbe..72fdb2641d05 100644\n--- a/scene/3d/camera.h\n+++ b/scene/3d/camera.h\n@@ -91,26 +91,10 @@ class Camera : public Spatial {\n \tRef<SpatialVelocityTracker> velocity_tracker;\n \tbool affect_lod = true;\n \n-\t///////////////////////////////////////////////////////\n-\t// INTERPOLATION FUNCTIONS\n-\tvoid _physics_interpolation_ensure_transform_calculated(bool p_force = false) const;\n-\tvoid _physics_interpolation_ensure_data_flipped();\n-\n-\t// These can be set by derived Cameras,\n-\t// if they wish to do processing (while still\n-\t// allowing physics interpolation to function).\n+\t// These can be set by derived Cameras.\n \tbool _desired_process_internal = false;\n \tbool _desired_physics_process_internal = false;\n \n-\tmutable struct InterpolationData {\n-\t\tTransform xform_curr;\n-\t\tTransform xform_prev;\n-\t\tTransform xform_interpolated;\n-\t\tTransform camera_xform_interpolated; // After modification according to camera type.\n-\t\tuint32_t last_update_physics_tick = 0;\n-\t\tuint32_t last_update_frame = UINT32_MAX;\n-\t} _interpolation_data;\n-\n \tvoid _update_process_mode();\n \n protected:\n@@ -118,9 +102,6 @@ class Camera : public Spatial {\n \t// This is because physics interpolation may need to request process modes additionally.\n \tvoid set_desired_process_modes(bool p_process_internal, bool p_physics_process_internal);\n \n-\t// Opportunity for derived classes to interpolate extra attributes.\n-\tvirtual void physics_interpolation_flip_data() {}\n-\n \tvirtual void _physics_interpolated_changed();\n \tvirtual Transform _get_adjusted_camera_transform(const Transform &p_xform) const;\n \t///////////////////////////////////////////////////////\n@@ -128,6 +109,7 @@ class Camera : public Spatial {\n \tvoid _update_camera();\n \tvirtual void _request_camera_update();\n \tvoid _update_camera_mode();\n+\tvirtual void fti_update_servers();\n \n \tvoid _notification(int p_what);\n \tvirtual void _validate_property(PropertyInfo &p_property) const;\n@@ -248,8 +230,9 @@ class ClippedCamera : public Camera {\n \n protected:\n \tvirtual Transform _get_adjusted_camera_transform(const Transform &p_xform) const;\n-\tvirtual void physics_interpolation_flip_data();\n+\tvirtual void fti_pump();\n \tvirtual void _physics_interpolated_changed();\n+\tvirtual void fti_update_servers();\n \t///////////////////////////////////////////////////////\n \n \tvoid _notification(int p_what);\ndiff --git a/scene/3d/spatial.cpp b/scene/3d/spatial.cpp\nindex cac9673bfa06..394f334adc48 100644\n--- a/scene/3d/spatial.cpp\n+++ b/scene/3d/spatial.cpp\n@@ -118,7 +118,7 @@ void Spatial::_propagate_transform_changed(Spatial *p_origin) {\n #endif\n \t\tget_tree()->xform_change_list.add(&xform_change);\n \t}\n-\tdata.dirty |= DIRTY_GLOBAL;\n+\tdata.dirty |= DIRTY_GLOBAL | DIRTY_GLOBAL_INTERPOLATED;\n \n \tdata.children_lock--;\n }\n@@ -174,13 +174,27 @@ void Spatial::_notification(int p_what) {\n \t\t\t\t_propagate_merging_allowed(merging_allowed);\n \t\t\t}\n \n-\t\t\tdata.dirty |= DIRTY_GLOBAL; //global is always dirty upon entering a scene\n+\t\t\tdata.dirty |= DIRTY_GLOBAL | DIRTY_GLOBAL_INTERPOLATED; //global is always dirty upon entering a scene\n \t\t\t_notify_dirty();\n \n \t\t\tnotification(NOTIFICATION_ENTER_WORLD);\n \n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n+\t\t\t\t// Always reset FTI when entering tree.\n+\t\t\t\tfti_pump();\n+\n+\t\t\t\t// No need to interpolate as we are doing a reset.\n+\t\t\t\tdata.global_transform_interpolated = get_global_transform();\n+\n+\t\t\t\t// Make sure servers are up to date.\n+\t\t\t\tfti_update_servers();\n+\t\t\t}\n \t\t} break;\n \t\tcase NOTIFICATION_EXIT_TREE: {\n+\t\t\tif (is_inside_tree()) {\n+\t\t\t\tget_tree()->get_scene_tree_fti().spatial_notify_delete(this);\n+\t\t\t}\n+\n \t\t\tnotification(NOTIFICATION_EXIT_WORLD, true);\n \t\t\tif (xform_change.in_list()) {\n \t\t\t\tget_tree()->xform_change_list.remove(&xform_change);\n@@ -252,6 +266,13 @@ void Spatial::_notification(int p_what) {\n \t\t\tif (data.client_physics_interpolation_data) {\n \t\t\t\tdata.client_physics_interpolation_data->global_xform_prev = data.client_physics_interpolation_data->global_xform_curr;\n \t\t\t}\n+\t\t\tdata.local_transform_prev = data.local_transform;\n+\t\t} break;\n+\n+\t\tcase NOTIFICATION_PAUSED: {\n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n+\t\t\t\tdata.local_transform_prev = data.local_transform;\n+\t\t\t}\n \t\t} break;\n \n \t\tdefault: {\n@@ -281,7 +302,22 @@ void Spatial::set_global_rotation(const Vector3 &p_euler_rad) {\n \tset_global_transform(transform);\n }\n \n+void Spatial::fti_pump() {\n+\tif (data.dirty & DIRTY_LOCAL) {\n+\t\t_update_local_transform();\n+\t}\n+\n+\tdata.local_transform_prev = data.local_transform;\n+}\n+\n+void Spatial::fti_notify_node_changed() {\n+\tif (is_inside_tree()) {\n+\t\tget_tree()->get_scene_tree_fti().spatial_notify_set_transform(*this);\n+\t}\n+}\n+\n void Spatial::set_transform(const Transform &p_transform) {\n+\tfti_notify_node_changed();\n \tdata.local_transform = p_transform;\n \tdata.dirty |= DIRTY_VECTORS;\n \tdata.dirty &= ~DIRTY_LOCAL;\n@@ -404,14 +440,19 @@ Transform Spatial::_get_global_transform_interpolated(real_t p_interpolation_fra\n }\n \n Transform Spatial::get_global_transform_interpolated() {\n+#if 1\n \t// Pass through if physics interpolation is switched off.\n \t// This is a convenience, as it allows you to easy turn off interpolation\n \t// without changing any code.\n-\tif (!is_physics_interpolated_and_enabled()) {\n-\t\treturn get_global_transform();\n+\tif (data.fti_global_xform_interp_set && is_physics_interpolated_and_enabled() && !Engine::get_singleton()->is_in_physics_frame() && is_visible_in_tree()) {\n+\t\treturn data.global_transform_interpolated;\n \t}\n \n-\t// If we are in the physics frame, the interpolated global transform is meaningless.\n+\treturn get_global_transform();\n+#else\n+\t// OLD METHOD - deprecated since moving to SceneTreeFTI,\n+\t// but leaving for reference and comparison for debugging.\n+\n \t// However, there is an exception, we may want to use this as a means of starting off the client\n \t// interpolation pump if not already started (when _is_physics_interpolated_client_side() is false).\n \tif (Engine::get_singleton()->is_in_physics_frame() && _is_physics_interpolated_client_side()) {\n@@ -419,6 +460,7 @@ Transform Spatial::get_global_transform_interpolated() {\n \t}\n \n \treturn _get_global_transform_interpolated(Engine::get_singleton()->get_physics_interpolation_fraction());\n+#endif\n }\n \n Transform Spatial::get_global_transform() const {\n@@ -484,6 +526,7 @@ Transform Spatial::get_relative_transform(const Node *p_parent) const {\n }\n \n void Spatial::set_translation(const Vector3 &p_translation) {\n+\tfti_notify_node_changed();\n \tdata.local_transform.origin = p_translation;\n \t_change_notify(\"transform\");\n \t_propagate_transform_changed(this);\n@@ -493,6 +536,7 @@ void Spatial::set_translation(const Vector3 &p_translation) {\n }\n \n void Spatial::set_rotation(const Vector3 &p_euler_rad) {\n+\tfti_notify_node_changed();\n \tif (data.dirty & DIRTY_VECTORS) {\n \t\tdata.scale = data.local_transform.basis.get_scale();\n \t\tdata.dirty &= ~DIRTY_VECTORS;\n@@ -512,6 +556,7 @@ void Spatial::set_rotation_degrees(const Vector3 &p_euler_deg) {\n }\n \n void Spatial::set_scale(const Vector3 &p_scale) {\n+\tfti_notify_node_changed();\n \tif (data.dirty & DIRTY_VECTORS) {\n \t\tdata.rotation = data.local_transform.basis.get_rotation();\n \t\tdata.dirty &= ~DIRTY_VECTORS;\n@@ -1061,6 +1106,11 @@ Spatial::Spatial() :\n \tdata.disable_scale = false;\n \tdata.vi_visible = true;\n \tdata.merging_allowed = true;\n+\n+\tdata.fti_on_frame_list = false;\n+\tdata.fti_on_tick_list = false;\n+\tdata.fti_global_xform_interp_set = false;\n+\n \tdata.merging_mode = MERGING_MODE_INHERIT;\n \n \tdata.client_physics_interpolation_data = nullptr;\n@@ -1077,4 +1127,8 @@ Spatial::Spatial() :\n \n Spatial::~Spatial() {\n \t_disable_client_physics_interpolation();\n+\n+\tif (is_inside_tree()) {\n+\t\tget_tree()->get_scene_tree_fti().spatial_notify_delete(this);\n+\t}\n }\ndiff --git a/scene/3d/spatial.h b/scene/3d/spatial.h\nindex 9c80044919eb..53c595ee3f3a 100644\n--- a/scene/3d/spatial.h\n+++ b/scene/3d/spatial.h\n@@ -52,6 +52,8 @@ class Spatial : public Node {\n \tGDCLASS(Spatial, Node);\n \tOBJ_CATEGORY(\"3D\");\n \n+\tfriend class SceneTreeFTI;\n+\n public:\n \tenum MergingMode : unsigned int {\n \t\tMERGING_MODE_INHERIT,\n@@ -74,15 +76,27 @@ class Spatial : public Node {\n \t\tDIRTY_NONE = 0,\n \t\tDIRTY_VECTORS = 1,\n \t\tDIRTY_LOCAL = 2,\n-\t\tDIRTY_GLOBAL = 4\n+\t\tDIRTY_GLOBAL = 4,\n+\t\tDIRTY_GLOBAL_INTERPOLATED = 8,\n \t};\n \n \tmutable SelfList<Node> xform_change;\n \tSelfList<Spatial> _client_physics_interpolation_spatials_list;\n \n \tstruct Data {\n+\t\t// Interpolated global transform - correct on the frame only.\n+\t\t// Only used with FTI.\n+\t\tTransform global_transform_interpolated;\n+\n+\t\t// Current xforms are either\n+\t\t// * Used for everything (when not using FTI)\n+\t\t// * Correct on the physics tick (when using FTI)\n \t\tmutable Transform global_transform;\n \t\tmutable Transform local_transform;\n+\n+\t\t// Only used with FTI.\n+\t\tTransform local_transform_prev;\n+\n \t\tmutable Vector3 rotation;\n \t\tmutable Vector3 scale;\n \n@@ -108,6 +122,11 @@ class Spatial : public Node {\n \t\tbool visible : 1;\n \t\tbool disable_scale : 1;\n \n+\t\t// Scene tree interpolation\n+\t\tbool fti_on_frame_list : 1;\n+\t\tbool fti_on_tick_list : 1;\n+\t\tbool fti_global_xform_interp_set : 1;\n+\n \t\tbool merging_allowed : 1;\n \n \t\tint children_lock;\n@@ -139,9 +158,27 @@ class Spatial : public Node {\n \n \tvoid _set_vi_visible(bool p_visible);\n \tbool _is_vi_visible() const { return data.vi_visible; }\n+\n \tTransform _get_global_transform_interpolated(real_t p_interpolation_fraction);\n+\tconst Transform &_get_cached_global_transform_interpolated() const { return data.global_transform_interpolated; }\n \tvoid _disable_client_physics_interpolation();\n \n+\t// Calling this announces to the FTI system that a node has been moved,\n+\t// or requires an update in terms of interpolation\n+\t// (e.g. changing Camera zoom even if position hasn't changed).\n+\tvoid fti_notify_node_changed();\n+\n+\t// Opportunity after FTI to update the servers\n+\t// with global_transform_interpolated,\n+\t// and any custom interpolated data in derived classes.\n+\t// Make sure to call the parent class fti_update_servers(),\n+\t// so all data is updated to the servers.\n+\tvirtual void fti_update_servers() {}\n+\n+\t// Pump the FTI data, also gives a chance for inherited classes\n+\t// to pump custom data, but they *must* call the base class here too.\n+\tvirtual void fti_pump();\n+\n \tvoid _notification(int p_what);\n \tstatic void _bind_methods();\n \ndiff --git a/scene/3d/vehicle_body.cpp b/scene/3d/vehicle_body.cpp\nindex 8231e4a6daf8..724867a0bcc1 100644\n--- a/scene/3d/vehicle_body.cpp\n+++ b/scene/3d/vehicle_body.cpp\n@@ -44,7 +44,7 @@ class btVehicleJacobianEntry {\n \n \treal_t getDiagonal() const { return m_Adiag; }\n \n-\tbtVehicleJacobianEntry(){};\n+\tbtVehicleJacobianEntry() {}\n \t//constraint between two different rigidbodies\n \tbtVehicleJacobianEntry(\n \t\t\tconst Basis &world2A,\n@@ -366,6 +366,8 @@ VehicleWheel::VehicleWheel() {\n \tm_raycastInfo.m_suspensionLength = 0.0;\n \n \tbody = nullptr;\n+\n+\tset_physics_interpolation_mode(PHYSICS_INTERPOLATION_MODE_OFF);\n }\n \n void VehicleBody::_update_wheel_transform(VehicleWheel &wheel, PhysicsDirectBodyState *s) {\ndiff --git a/scene/3d/visual_instance.cpp b/scene/3d/visual_instance.cpp\nindex cf80a6742dd7..05d7414b9698 100644\n--- a/scene/3d/visual_instance.cpp\n+++ b/scene/3d/visual_instance.cpp\n@@ -82,6 +82,12 @@ void VisualInstance::set_instance_use_identity_transform(bool p_enable) {\n \t}\n }\n \n+void VisualInstance::fti_update_servers() {\n+\tif (!_is_using_identity_transform()) {\n+\t\tVisualServer::get_singleton()->instance_set_transform(get_instance(), _get_cached_global_transform_interpolated());\n+\t}\n+}\n+\n void VisualInstance::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_ENTER_WORLD: {\n@@ -97,33 +103,26 @@ void VisualInstance::_notification(int p_what) {\n \n \t\t} break;\n \t\tcase NOTIFICATION_TRANSFORM_CHANGED: {\n-\t\t\tif (_is_vi_visible() || is_physics_interpolated_and_enabled()) {\n+\t\t\tif (_is_vi_visible()) {\n \t\t\t\tif (!_is_using_identity_transform()) {\n-\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n-\n-\t\t\t\t\t// For instance when first adding to the tree, when the previous transform is\n-\t\t\t\t\t// unset, to prevent streaking from the origin.\n-\t\t\t\t\tif (_is_physics_interpolation_reset_requested() && is_physics_interpolated_and_enabled() && is_inside_tree()) {\n-\t\t\t\t\t\tif (_is_vi_visible()) {\n-\t\t\t\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n+\t\t\t\t\t// Physics interpolated VIs don't need to send their transform immediately after setting,\n+\t\t\t\t\t// indeed it is counterproductive, because the interpolated transform will be sent\n+\t\t\t\t\t// to the VisualServer immediately prior to rendering.\n+\t\t\t\t\tif (!is_physics_interpolated_and_enabled()) {\n+\t\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\t// For instance when first adding to the tree, when the previous transform is\n+\t\t\t\t\t\t// unset, to prevent streaking from the origin.\n+\t\t\t\t\t\tif (_is_physics_interpolation_reset_requested() && is_inside_tree()) {\n+\t\t\t\t\t\t\tif (_is_vi_visible()) {\n+\t\t\t\t\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t_set_physics_interpolation_reset_requested(false);\n \t\t\t\t\t\t}\n-\t\t\t\t\t\t_set_physics_interpolation_reset_requested(false);\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n \t\t} break;\n-\t\tcase NOTIFICATION_RESET_PHYSICS_INTERPOLATION: {\n-\t\t\tif (_is_vi_visible() && is_physics_interpolated() && is_inside_tree()) {\n-\t\t\t\t// We must ensure the VisualServer transform is up to date before resetting.\n-\t\t\t\t// This is because NOTIFICATION_TRANSFORM_CHANGED is deferred,\n-\t\t\t\t// and cannot be relied to be called in order before NOTIFICATION_RESET_PHYSICS_INTERPOLATION.\n-\t\t\t\tif (!_is_using_identity_transform()) {\n-\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n-\t\t\t\t}\n-\n-\t\t\t\tVisualServer::get_singleton()->instance_reset_physics_interpolation(instance);\n-\t\t\t}\n-\t\t} break;\n \t\tcase NOTIFICATION_EXIT_WORLD: {\n \t\t\tVisualServer::get_singleton()->instance_set_scenario(instance, RID());\n \t\t\tVisualServer::get_singleton()->instance_attach_skeleton(instance, RID());\n@@ -140,10 +139,6 @@ void VisualInstance::_notification(int p_what) {\n \t}\n }\n \n-void VisualInstance::_physics_interpolated_changed() {\n-\tVisualServer::get_singleton()->instance_set_interpolated(instance, is_physics_interpolated());\n-}\n-\n RID VisualInstance::get_instance() const {\n \treturn instance;\n }\ndiff --git a/scene/3d/visual_instance.h b/scene/3d/visual_instance.h\nindex 0b605ed15c72..ce8164bff25b 100644\n--- a/scene/3d/visual_instance.h\n+++ b/scene/3d/visual_instance.h\n@@ -51,8 +51,8 @@ class VisualInstance : public CullInstance {\n protected:\n \tvoid _update_visibility();\n \tvirtual void _refresh_portal_mode();\n-\tvirtual void _physics_interpolated_changed();\n \tvoid set_instance_use_identity_transform(bool p_enable);\n+\tvirtual void fti_update_servers();\n \n \tvoid _notification(int p_what);\n \tstatic void _bind_methods();\ndiff --git a/scene/animation/skeleton_ik.cpp b/scene/animation/skeleton_ik.cpp\nindex 22561d1d7be8..8fed9677ae51 100644\n--- a/scene/animation/skeleton_ik.cpp\n+++ b/scene/animation/skeleton_ik.cpp\n@@ -276,7 +276,7 @@ void FabrikInverseKinematic::solve(Task *p_task, real_t blending_delta, bool ove\n \tp_task->skeleton->set_bone_global_pose_override(p_task->chain.chain_root.bone, Transform(), 0.0, false);\n \tVector3 origin_pos = p_task->skeleton->get_bone_global_pose(p_task->chain.chain_root.bone).origin;\n \n-\tmake_goal(p_task, p_task->skeleton->get_global_transform().affine_inverse(), blending_delta);\n+\tmake_goal(p_task, p_task->skeleton->get_global_transform_interpolated().affine_inverse(), blending_delta);\n \n \tif (p_use_magnet && p_task->chain.middle_chain_item) {\n \t\tp_task->chain.magnet_position = p_task->chain.middle_chain_item->initial_transform.origin.linear_interpolate(p_magnet_position, blending_delta);\ndiff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 6a7f4b4eb55c..33a828e41757 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -538,6 +538,8 @@ void SceneTree::set_physics_interpolation_enabled(bool p_enabled) {\n \t_physics_interpolation_enabled = p_enabled;\n \tVisualServer::get_singleton()->set_physics_interpolation_enabled(p_enabled);\n \n+\tget_scene_tree_fti().set_enabled(get_root(), p_enabled);\n+\n \t// Perform an auto reset on the root node for convenience for the user.\n \tif (root) {\n \t\troot->reset_physics_interpolation();\n@@ -563,6 +565,7 @@ void SceneTree::iteration_prepare() {\n \t\t// Make sure any pending transforms from the last tick / frame\n \t\t// are flushed before pumping the interpolation prev and currents.\n \t\tflush_transform_notifications();\n+\t\tget_scene_tree_fti().tick_update();\n \t\tVisualServer::get_singleton()->tick();\n \t}\n }\n@@ -628,6 +631,17 @@ bool SceneTree::idle(float p_time) {\n \t//print_line(\"node count: \"+itos(get_node_count()));\n \t//print_line(\"TEXTURE RAM: \"+itos(VS::get_singleton()->get_render_info(VS::INFO_TEXTURE_MEM_USED)));\n \n+\t// First pass of scene tree fixed timestep interpolation.\n+\tif (get_scene_tree_fti().is_enabled()) {\n+\t\t// Special, we need to ensure RenderingServer is up to date\n+\t\t// with *all* the pending xforms *before* updating it during\n+\t\t// the FTI update.\n+\t\t// If this is not done, we can end up with a deferred `set_transform()`\n+\t\t// overwriting the interpolated xform in the server.\n+\t\tflush_transform_notifications();\n+\t\tget_scene_tree_fti().frame_update(get_root(), true);\n+\t}\n+\n \troot_lock++;\n \n \tif (MainLoop::idle(p_time)) {\n@@ -733,6 +747,11 @@ bool SceneTree::idle(float p_time) {\n \n #endif\n \n+\t// Second pass of scene tree fixed timestep interpolation.\n+\t// ToDo: Possibly needs another flush_transform_notifications here\n+\t// depending on whether there are side effects to _call_idle_callbacks().\n+\tget_scene_tree_fti().frame_update(get_root(), false);\n+\n \tVisualServer::get_singleton()->pre_draw(true);\n \n \treturn _quit;\ndiff --git a/scene/main/scene_tree.h b/scene/main/scene_tree.h\nindex 292cdf23ec28..b8ab1ed4b3fc 100644\n--- a/scene/main/scene_tree.h\n+++ b/scene/main/scene_tree.h\n@@ -35,6 +35,7 @@\n #include \"core/os/main_loop.h\"\n #include \"core/os/thread_safe.h\"\n #include \"core/self_list.h\"\n+#include \"scene/main/scene_tree_fti.h\"\n #include \"scene/resources/mesh.h\"\n #include \"scene/resources/world.h\"\n #include \"scene/resources/world_2d.h\"\n@@ -160,6 +161,7 @@ class SceneTree : public MainLoop {\n \tStretchAspect stretch_aspect;\n \tSize2i stretch_min;\n \treal_t stretch_scale;\n+\tSceneTreeFTI scene_tree_fti;\n \n \tvoid _update_font_oversampling(float p_ratio);\n \tvoid _update_root_rect();\n@@ -438,6 +440,8 @@ class SceneTree : public MainLoop {\n \tvoid client_physics_interpolation_add_spatial(SelfList<Spatial> *p_elem);\n \tvoid client_physics_interpolation_remove_spatial(SelfList<Spatial> *p_elem);\n \n+\tSceneTreeFTI &get_scene_tree_fti() { return scene_tree_fti; }\n+\n \tstatic void add_idle_callback(IdleCallback p_callback);\n \tSceneTree();\n \t~SceneTree();\ndiff --git a/scene/main/scene_tree_fti.cpp b/scene/main/scene_tree_fti.cpp\nnew file mode 100644\nindex 000000000000..f9e3ef26fbd1\n--- /dev/null\n+++ b/scene/main/scene_tree_fti.cpp\n@@ -0,0 +1,288 @@\n+/**************************************************************************/\n+/*  scene_tree_fti.cpp                                                    */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef _3D_DISABLED\n+\n+#include \"scene_tree_fti.h\"\n+#include \"core/engine.h\"\n+#include \"core/error_macros.h\"\n+#include \"core/math/transform_interpolator.h\"\n+#include \"core/os/os.h\"\n+#include \"scene/3d/spatial.h\"\n+#include \"scene/3d/visual_instance.h\"\n+\n+void SceneTreeFTI::_reset_flags(Node *p_node) {\n+\tSpatial *s = Object::cast_to<Spatial>(p_node);\n+\n+\tif (s) {\n+\t\ts->data.fti_on_frame_list = false;\n+\t\ts->data.fti_on_tick_list = false;\n+\n+\t\t// In most cases the later  NOTIFICATION_RESET_PHYSICS_INTERPOLATION\n+\t\t// will reset this, but this should help cover hidden nodes.\n+\t\ts->data.local_transform_prev = s->data.local_transform;\n+\t}\n+\n+\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t_reset_flags(p_node->get_child(n));\n+\t}\n+}\n+\n+void SceneTreeFTI::set_enabled(Node *p_root, bool p_enabled) {\n+\tif (data.enabled == p_enabled) {\n+\t\treturn;\n+\t}\n+\n+\tdata.spatial_tick_list[0].clear();\n+\tdata.spatial_tick_list[1].clear();\n+\n+\t// Spatial flags must be reset.\n+\tif (p_root) {\n+\t\t_reset_flags(p_root);\n+\t}\n+\n+\tdata.enabled = p_enabled;\n+}\n+\n+void SceneTreeFTI::tick_update() {\n+\tif (!data.enabled) {\n+\t\treturn;\n+\t}\n+\n+\tuint32_t curr_mirror = data.mirror;\n+\tuint32_t prev_mirror = curr_mirror ? 0 : 1;\n+\n+\tLocalVector<Spatial *> &curr = data.spatial_tick_list[curr_mirror];\n+\tLocalVector<Spatial *> &prev = data.spatial_tick_list[prev_mirror];\n+\n+\t// First detect on the previous list but not on this tick list.\n+\tfor (uint32_t n = 0; n < prev.size(); n++) {\n+\t\tSpatial *s = prev[n];\n+\t\tif (!s->data.fti_on_tick_list) {\n+\t\t\t// Needs a reset so jittering will stop.\n+\t\t\ts->fti_pump();\n+\n+\t\t\t// This may not get updated so set it to the same as global xform.\n+\t\t\t// TODO: double check this is the best value.\n+\t\t\ts->data.global_transform_interpolated = s->get_global_transform();\n+\n+\t\t\t// Remove from interpolation list.\n+\t\t\tif (s->data.fti_on_frame_list) {\n+\t\t\t\ts->data.fti_on_frame_list = false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t// Now pump all on the current list.\n+\tfor (uint32_t n = 0; n < curr.size(); n++) {\n+\t\tSpatial *s = curr[n];\n+\n+\t\t// Reset, needs to be marked each tick.\n+\t\ts->data.fti_on_tick_list = false;\n+\n+\t\t// Pump.\n+\t\ts->fti_pump();\n+\t}\n+\n+\t// Clear previous list and flip.\n+\tprev.clear();\n+\tdata.mirror = prev_mirror;\n+}\n+\n+void SceneTreeFTI::_spatial_notify_set_transform(Spatial &r_spatial) {\n+\t// This may be checked by the calling routine already,\n+\t// but needs to be double checked for custom SceneTrees.\n+\tif (!data.enabled || !r_spatial.is_physics_interpolated()) {\n+\t\treturn;\n+\t}\n+\n+\tif (!r_spatial.data.fti_on_tick_list) {\n+\t\tr_spatial.data.fti_on_tick_list = true;\n+\t\tdata.spatial_tick_list[data.mirror].push_back(&r_spatial);\n+\t}\n+\n+\tif (!r_spatial.data.fti_on_frame_list) {\n+\t\tr_spatial.data.fti_on_frame_list = true;\n+\t}\n+}\n+\n+void SceneTreeFTI::spatial_notify_delete(Spatial *p_spatial) {\n+\tif (!data.enabled) {\n+\t\treturn;\n+\t}\n+\n+\tif (p_spatial->data.fti_on_frame_list) {\n+\t\tp_spatial->data.fti_on_frame_list = false;\n+\t}\n+\n+\t// This can potentially be optimized for large scenes with large churn,\n+\t// as it will be doing a linear search through the lists.\n+\tdata.spatial_tick_list[0].erase_unordered(p_spatial);\n+\tdata.spatial_tick_list[1].erase_unordered(p_spatial);\n+}\n+\n+void SceneTreeFTI::_update_dirty_spatials(Node *p_node, uint32_t p_current_frame, float p_interpolation_fraction, bool p_active, const Transform *p_parent_global_xform, int p_depth) {\n+\tSpatial *s = Object::cast_to<Spatial>(p_node);\n+\n+\t// Don't recurse into hidden branches.\n+\tif (s && !s->is_visible()) {\n+\t\t// NOTE : If we change from recursing entire tree, we should do an is_visible_in_tree()\n+\t\t// check for the first of the branch.\n+\t\treturn;\n+\t}\n+\n+\t// Not a Spatial.\n+\t// Could be e.g. a viewport or something\n+\t// so we should still recurse to children.\n+\tif (!s) {\n+\t\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t\t_update_dirty_spatials(p_node->get_child(n), p_current_frame, p_interpolation_fraction, p_active, nullptr, p_depth + 1);\n+\t\t}\n+\t\treturn;\n+\t}\n+\n+\t// Start the active interpolation chain from here onwards\n+\t// as we recurse further into the SceneTree.\n+\t// Once we hit an active (interpolated) node, we have to fully\n+\t// process all ancestors because their xform will also change.\n+\t// Anything not moving (inactive) higher in the tree need not be processed.\n+\tif (!p_active) {\n+\t\tif (data.frame_start) {\n+\t\t\t// On the frame start, activate whenever we hit something that requests interpolation.\n+\t\t\tif (s->data.fti_on_frame_list) {\n+\t\t\t\tp_active = true;\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// On the frame end, we want to re-interpolate *anything* that has moved\n+\t\t\t// since the frame start.\n+\t\t\tif (s->data.dirty & Spatial::DIRTY_GLOBAL_INTERPOLATED) {\n+\t\t\t\tp_active = true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (data.frame_start) {\n+\t\t// Mark on the Spatial whether we have set global_transform_interp.\n+\t\t// This can later be used when calling `get_global_transform_interpolated()`\n+\t\t// to know which xform to return.\n+\t\ts->data.fti_global_xform_interp_set = p_active;\n+\t}\n+\n+\tif (p_active) {\n+#if 0\n+\t\tbool dirty = s->data.dirty & Spatial::DIRTY_GLOBAL_INTERP;\n+\n+\t\tif (data.debug) {\n+\t\t\tString sz;\n+\t\t\tfor (int n = 0; n < p_depth; n++) {\n+\t\t\t\tsz += \"\\t\";\n+\t\t\t}\n+\t\t\tprint_line(sz + p_node->get_name() + (dirty ? \" DIRTY\" : \"\"));\n+\t\t}\n+#endif\n+\n+\t\t// First calculate our local xform.\n+\t\t// This will either use interpolation, or just use the current local if not interpolated.\n+\t\tTransform local_interp;\n+\t\tif (s->is_physics_interpolated()) {\n+\t\t\tTransformInterpolator::interpolate_transform(s->data.local_transform_prev, s->data.local_transform, local_interp, p_interpolation_fraction);\n+\t\t} else {\n+\t\t\tlocal_interp = s->data.local_transform;\n+\t\t}\n+\n+\t\t// Concatenate parent xform.\n+\t\tif (!s->is_set_as_toplevel()) {\n+\t\t\tif (p_parent_global_xform) {\n+\t\t\t\ts->data.global_transform_interpolated = (*p_parent_global_xform) * local_interp;\n+\t\t\t} else {\n+\t\t\t\tconst Spatial *parent = s->get_parent_spatial();\n+\n+\t\t\t\tif (parent) {\n+\t\t\t\t\tconst Transform &parent_glob = parent->data.fti_global_xform_interp_set ? parent->data.global_transform_interpolated : parent->data.global_transform;\n+\t\t\t\t\ts->data.global_transform_interpolated = parent_glob * local_interp;\n+\t\t\t\t} else {\n+\t\t\t\t\ts->data.global_transform_interpolated = local_interp;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\ts->data.global_transform_interpolated = local_interp;\n+\t\t}\n+\n+\t\t// Upload to VisualServer the interpolated global xform.\n+\t\ts->fti_update_servers();\n+\n+\t} // if active.\n+\n+\t// Remove the dirty interp flag from EVERYTHING as we go.\n+\ts->data.dirty &= ~Spatial::DIRTY_GLOBAL_INTERPOLATED;\n+\n+\t// Recurse to children.\n+\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t_update_dirty_spatials(p_node->get_child(n), p_current_frame, p_interpolation_fraction, p_active, s->data.fti_global_xform_interp_set ? &s->data.global_transform_interpolated : &s->data.global_transform, p_depth + 1);\n+\t}\n+}\n+\n+void SceneTreeFTI::frame_update(Node *p_root, bool p_frame_start) {\n+\tif (!data.enabled || !p_root) {\n+\t\treturn;\n+\t}\n+\n+\tdata.frame_start = p_frame_start;\n+\n+\tfloat f = Engine::get_singleton()->get_physics_interpolation_fraction();\n+\tuint32_t frame = Engine::get_singleton()->get_frames_drawn();\n+\n+// #define SCENE_TREE_FTI_TAKE_TIMINGS\n+#ifdef SCENE_TREE_FTI_TAKE_TIMINGS\n+\tuint64_t before = OS::get_singleton()->get_ticks_usec();\n+#endif\n+\n+\tif (data.debug) {\n+\t\tprint_line(String(\"\\nScene: \") + (data.frame_start ? \"start\" : \"end\") + \"\\n\");\n+\t}\n+\n+\t// Probably not the most optimal approach as we traverse the entire SceneTree\n+\t// but simple and foolproof.\n+\t// Can be optimized later.\n+\t_update_dirty_spatials(p_root, frame, f, false);\n+\n+\tif (!p_frame_start && data.debug) {\n+\t\tdata.debug = false;\n+\t}\n+\n+#ifdef SCENE_TREE_FTI_TAKE_TIMINGS\n+\tuint64_t after = OS::get_singleton()->get_ticks_usec();\n+\tif ((Engine::get_singleton()->get_frames_drawn() % 60) == 0) {\n+\t\tprint_line(\"Took \" + itos(after - before) + \" usec \" + (data.frame_start ? \"start\" : \"end\"));\n+\t}\n+#endif\n+}\n+\n+#endif // ndef _3D_DISABLED\ndiff --git a/scene/main/scene_tree_fti.h b/scene/main/scene_tree_fti.h\nnew file mode 100644\nindex 000000000000..5e76d30c7b10\n--- /dev/null\n+++ b/scene/main/scene_tree_fti.h\n@@ -0,0 +1,112 @@\n+/**************************************************************************/\n+/*  scene_tree_fti.h                                                      */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef SCENE_TREE_FTI_H\n+#define SCENE_TREE_FTI_H\n+\n+#include <core/local_vector.h>\n+#include <core/os/mutex.h>\n+\n+class Spatial;\n+class Node;\n+class Transform;\n+\n+#ifdef _3D_DISABLED\n+// Stubs\n+class SceneTreeFTI {\n+public:\n+\tvoid frame_update(Node *p_root, bool p_frame_start) {}\n+\tvoid tick_update() {}\n+\tvoid set_enabled(Node *p_root, bool p_enabled) {}\n+\tbool is_enabled() const { return false; }\n+\n+\tvoid spatial_notify_set_transform(Spatial &r_spatial) {}\n+\tvoid spatial_notify_delete(Spatial *p_spatial) {}\n+};\n+#else\n+\n+// Important.\n+// This class uses raw pointers, so it is essential that on deletion, this class is notified\n+// so that any references can be cleared up to prevent dangling pointer access.\n+\n+// This class can be used from a custom SceneTree.\n+\n+// Note we could potentially make SceneTreeFTI static / global to avoid the lookup through scene tree,\n+// but this covers the custom case of multiple scene trees.\n+\n+// This class is not thread safe, but can be made thread safe easily with a mutex as in the 4.x version.\n+\n+class SceneTreeFTI {\n+\tstruct Data {\n+\t\t// Prev / Curr lists of spatials having local xforms pumped.\n+\t\tLocalVector<Spatial *> spatial_tick_list[2];\n+\t\tuint32_t mirror = 0;\n+\n+\t\tbool enabled = false;\n+\n+\t\t// Whether we are in physics ticks, or in a frame.\n+\t\tbool in_frame = false;\n+\n+\t\t// Updating at the start of the frame, or the end on second pass.\n+\t\tbool frame_start = true;\n+\n+\t\tbool debug = false;\n+\t} data;\n+\n+\tvoid _update_dirty_spatials(Node *p_node, uint32_t p_current_frame, float p_interpolation_fraction, bool p_active, const Transform *p_parent_global_xform = nullptr, int p_depth = 0);\n+\tvoid _reset_flags(Node *p_node);\n+\tvoid _spatial_notify_set_transform(Spatial &r_spatial);\n+\n+public:\n+\t// Hottest function, allow inlining the data.enabled check.\n+\tvoid spatial_notify_set_transform(Spatial &r_spatial) {\n+\t\tif (!data.enabled) {\n+\t\t\treturn;\n+\t\t}\n+\t\t_spatial_notify_set_transform(r_spatial);\n+\t}\n+\n+\tvoid spatial_notify_delete(Spatial *p_spatial);\n+\n+\t// Calculate interpolated xforms, send to visual server.\n+\tvoid frame_update(Node *p_root, bool p_frame_start);\n+\n+\t// Update local xform pumps.\n+\tvoid tick_update();\n+\n+\tvoid set_enabled(Node *p_root, bool p_enabled);\n+\tbool is_enabled() const { return data.enabled; }\n+\n+\tvoid set_debug_next_frame() { data.debug = true; }\n+};\n+\n+#endif // ndef _3D_DISABLED\n+\n+#endif // SCENE_TREE_FTI_H\ndiff --git a/servers/visual/rasterizer.h b/servers/visual/rasterizer.h\nindex 2b2259cc17f0..e99b16da6c4c 100644\n--- a/servers/visual/rasterizer.h\n+++ b/servers/visual/rasterizer.h\n@@ -92,16 +92,8 @@ class RasterizerScene {\n \t\tRID material_override;\n \t\tRID material_overlay;\n \n-\t\t// This is the main transform to be drawn with ..\n-\t\t// This will either be the interpolated transform (when using fixed timestep interpolation)\n-\t\t// or the ONLY transform (when not using FTI).\n \t\tTransform transform;\n \n-\t\t// for interpolation we store the current transform (this physics tick)\n-\t\t// and the transform in the previous tick\n-\t\tTransform transform_curr;\n-\t\tTransform transform_prev;\n-\n \t\tint depth_layer;\n \t\tuint32_t layer_mask;\n \n@@ -123,16 +115,6 @@ class RasterizerScene {\n \t\tbool baked_light : 1; //this flag is only to know if it actually did use baked light\n \t\tbool redraw_if_visible : 1;\n \n-\t\tbool on_interpolate_list : 1;\n-\t\tbool on_interpolate_transform_list : 1;\n-\t\tbool interpolated : 1;\n-\t\tTransformInterpolator::Method interpolation_method : 3;\n-\n-\t\t// For fixed timestep interpolation.\n-\t\t// Note 32 bits is plenty for checksum, no need for real_t\n-\t\tfloat transform_checksum_curr;\n-\t\tfloat transform_checksum_prev;\n-\n \t\tfloat depth; //used for sorting\n \n \t\tSelfList<InstanceBase> dependency_item;\n@@ -158,12 +140,6 @@ class RasterizerScene {\n \t\t\tlightmap_capture = nullptr;\n \t\t\tlightmap_slice = -1;\n \t\t\tlightmap_uv_rect = Rect2(0, 0, 1, 1);\n-\t\t\ton_interpolate_list = false;\n-\t\t\ton_interpolate_transform_list = false;\n-\t\t\tinterpolated = true;\n-\t\t\tinterpolation_method = TransformInterpolator::INTERP_LERP;\n-\t\t\ttransform_checksum_curr = 0.0;\n-\t\t\ttransform_checksum_prev = 0.0;\n \t\t}\n \t};\n \ndiff --git a/servers/visual/visual_server_raster.h b/servers/visual/visual_server_raster.h\nindex 6d088c09c3ec..297e3693096a 100644\n--- a/servers/visual/visual_server_raster.h\n+++ b/servers/visual/visual_server_raster.h\n@@ -573,8 +573,6 @@ class VisualServerRaster : public VisualServer {\n \tBIND2(instance_set_layer_mask, RID, uint32_t)\n \tBIND3(instance_set_pivot_data, RID, float, bool)\n \tBIND2(instance_set_transform, RID, const Transform &)\n-\tBIND2(instance_set_interpolated, RID, bool)\n-\tBIND1(instance_reset_physics_interpolation, RID)\n \tBIND2(instance_attach_object_instance_id, RID, ObjectID)\n \tBIND3(instance_set_blend_shape_weight, RID, int, float)\n \tBIND3(instance_set_surface_material, RID, int, RID)\ndiff --git a/servers/visual/visual_server_scene.cpp b/servers/visual/visual_server_scene.cpp\nindex bdea223d5cee..1552469abb6a 100644\n--- a/servers/visual/visual_server_scene.cpp\n+++ b/servers/visual/visual_server_scene.cpp\n@@ -673,9 +673,6 @@ void VisualServerScene::instance_set_scenario(RID p_instance, RID p_scenario) {\n \t\t\t_instance_destroy_occlusion_rep(instance);\n \t\t}\n \n-\t\t// remove any interpolation data associated with the instance in this scenario\n-\t\t_interpolation_data.notify_free_instance(p_instance, *instance);\n-\n \t\tswitch (instance->base_type) {\n \t\t\tcase VS::INSTANCE_LIGHT: {\n \t\t\t\tInstanceLightData *light = static_cast<InstanceLightData *>(instance->base_data);\n@@ -765,27 +762,6 @@ void VisualServerScene::instance_set_pivot_data(RID p_instance, float p_sorting_\n \tinstance->use_aabb_center = p_use_aabb_center;\n }\n \n-void VisualServerScene::instance_reset_physics_interpolation(RID p_instance) {\n-\tInstance *instance = instance_owner.get(p_instance);\n-\tERR_FAIL_COND(!instance);\n-\n-\tif (_interpolation_data.interpolation_enabled && instance->interpolated) {\n-\t\tinstance->transform_prev = instance->transform_curr;\n-\t\tinstance->transform_checksum_prev = instance->transform_checksum_curr;\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\tprint_line(\"instance_reset_physics_interpolation .. tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-\t\tprint_line(\"\\tprev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x));\n-#endif\n-\t}\n-}\n-\n-void VisualServerScene::instance_set_interpolated(RID p_instance, bool p_interpolated) {\n-\tInstance *instance = instance_owner.get(p_instance);\n-\tERR_FAIL_COND(!instance);\n-\tinstance->interpolated = p_interpolated;\n-}\n-\n void VisualServerScene::instance_set_transform(RID p_instance, const Transform &p_transform) {\n \tInstance *instance = instance_owner.get(p_instance);\n \tERR_FAIL_COND(!instance);\n@@ -794,47 +770,8 @@ void VisualServerScene::instance_set_transform(RID p_instance, const Transform &\n \tprint_line(\"instance_set_transform \" + rtos(p_transform.origin.x) + \" .. tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n #endif\n \n-\tif (!(_interpolation_data.interpolation_enabled && instance->interpolated) || !instance->scenario) {\n-\t\tif (instance->transform == p_transform) {\n-\t\t\treturn; //must be checked to avoid worst evil\n-\t\t}\n-\n-#ifdef DEBUG_ENABLED\n-\n-\t\tfor (int i = 0; i < 4; i++) {\n-\t\t\tconst Vector3 &v = i < 3 ? p_transform.basis.elements[i] : p_transform.origin;\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.x));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.x));\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.y));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.y));\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.z));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.z));\n-\t\t}\n-\n-#endif\n-\t\tinstance->transform = p_transform;\n-\t\t_instance_queue_update(instance, true);\n-\n-#if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n-\t\tif ((_interpolation_data.interpolation_enabled && !instance->interpolated) && (Engine::get_singleton()->is_in_physics_frame())) {\n-\t\t\tPHYSICS_INTERPOLATION_NODE_WARNING(instance->object_id, \"Non-interpolated triggered from physics process\");\n-\t\t}\n-#endif\n-\n-\t\treturn;\n-\t}\n-\n-\tfloat new_checksum = TransformInterpolator::checksum_transform(p_transform);\n-\tbool checksums_match = (instance->transform_checksum_curr == new_checksum) && (instance->transform_checksum_prev == new_checksum);\n-\n-\t// we can't entirely reject no changes because we need the interpolation\n-\t// system to keep on stewing\n-\n-\t// Optimized check. First checks the checksums. If they pass it does the slow check at the end.\n-\t// Alternatively we can do this non-optimized and ignore the checksum...\n-\t// if no change\n-\tif (checksums_match && (instance->transform_curr == p_transform) && (instance->transform_prev == p_transform)) {\n-\t\treturn;\n+\tif (instance->transform == p_transform) {\n+\t\treturn; //must be checked to avoid worst evil\n \t}\n \n #ifdef DEBUG_ENABLED\n@@ -850,62 +787,8 @@ void VisualServerScene::instance_set_transform(RID p_instance, const Transform &\n \t}\n \n #endif\n-\n-\tinstance->transform_curr = p_transform;\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\tprint_line(\"\\tprev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x));\n-#endif\n-\n-\t// keep checksums up to date\n-\tinstance->transform_checksum_curr = new_checksum;\n-\n-\tif (!instance->on_interpolate_transform_list) {\n-\t\t_interpolation_data.instance_transform_update_list_curr->push_back(p_instance);\n-\t\tinstance->on_interpolate_transform_list = true;\n-\t} else {\n-\t\tDEV_ASSERT(_interpolation_data.instance_transform_update_list_curr->size());\n-\t}\n-\n-\t// If the instance is invisible, then we are simply updating the data flow, there is no need to calculate the interpolated\n-\t// transform or anything else.\n-\t// Ideally we would not even call the VisualServer::set_transform() when invisible but that would entail having logic\n-\t// to keep track of the previous transform on the SceneTree side. The \"early out\" below is less efficient but a lot cleaner codewise.\n-\tif (!instance->visible) {\n-\t\treturn;\n-\t}\n-\n-\t// decide on the interpolation method .. slerp if possible\n-\tinstance->interpolation_method = TransformInterpolator::find_method(instance->transform_prev.basis, instance->transform_curr.basis);\n-\n-\tif (!instance->on_interpolate_list) {\n-\t\t_interpolation_data.instance_interpolate_update_list.push_back(p_instance);\n-\t\tinstance->on_interpolate_list = true;\n-\t} else {\n-\t\tDEV_ASSERT(_interpolation_data.instance_interpolate_update_list.size());\n-\t}\n-\n+\tinstance->transform = p_transform;\n \t_instance_queue_update(instance, true);\n-\n-#if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n-\tif (!Engine::get_singleton()->is_in_physics_frame()) {\n-\t\tPHYSICS_INTERPOLATION_NODE_WARNING(instance->object_id, \"Interpolated triggered from outside physics process\");\n-\t}\n-#endif\n-}\n-\n-void VisualServerScene::InterpolationData::notify_free_instance(RID p_rid, Instance &r_instance) {\n-\tr_instance.on_interpolate_list = false;\n-\tr_instance.on_interpolate_transform_list = false;\n-\n-\tif (!interpolation_enabled) {\n-\t\treturn;\n-\t}\n-\n-\t// if the instance was on any of the lists, remove\n-\tinstance_interpolate_update_list.erase_multiple_unordered(p_rid);\n-\tinstance_transform_update_list_curr->erase_multiple_unordered(p_rid);\n-\tinstance_transform_update_list_prev->erase_multiple_unordered(p_rid);\n }\n \n void VisualServerScene::update_interpolation_tick(bool p_process) {\n@@ -915,84 +798,11 @@ void VisualServerScene::update_interpolation_tick(bool p_process) {\n \n \t// update interpolation in storage\n \tVSG::storage->update_interpolation_tick(p_process);\n-\n-\t// detect any that were on the previous transform list that are no longer active,\n-\t// we should remove them from the interpolate list\n-\n-\tfor (unsigned int n = 0; n < _interpolation_data.instance_transform_update_list_prev->size(); n++) {\n-\t\tconst RID &rid = (*_interpolation_data.instance_transform_update_list_prev)[n];\n-\t\tInstance *instance = instance_owner.getornull(rid);\n-\n-\t\tbool active = true;\n-\n-\t\t// no longer active? (either the instance deleted or no longer being transformed)\n-\t\tif (instance && !instance->on_interpolate_transform_list) {\n-\t\t\tactive = false;\n-\t\t\tinstance->on_interpolate_list = false;\n-\n-\t\t\t// make sure the most recent transform is set\n-\t\t\tinstance->transform = instance->transform_curr;\n-\n-\t\t\t// and that both prev and current are the same, just in case of any interpolations\n-\t\t\tinstance->transform_prev = instance->transform_curr;\n-\n-\t\t\t// make sure are updated one more time to ensure the AABBs are correct\n-\t\t\t_instance_queue_update(instance, true);\n-\t\t}\n-\n-\t\tif (!instance) {\n-\t\t\tactive = false;\n-\t\t}\n-\n-\t\tif (!active) {\n-\t\t\t_interpolation_data.instance_interpolate_update_list.erase(rid);\n-\t\t}\n-\t}\n-\n-\t// and now for any in the transform list (being actively interpolated), keep the previous transform\n-\t// value up to date ready for the next tick\n-\tif (p_process) {\n-\t\tfor (unsigned int n = 0; n < _interpolation_data.instance_transform_update_list_curr->size(); n++) {\n-\t\t\tconst RID &rid = (*_interpolation_data.instance_transform_update_list_curr)[n];\n-\t\t\tInstance *instance = instance_owner.getornull(rid);\n-\t\t\tif (instance) {\n-\t\t\t\tinstance->transform_prev = instance->transform_curr;\n-\t\t\t\tinstance->transform_checksum_prev = instance->transform_checksum_curr;\n-\t\t\t\tinstance->on_interpolate_transform_list = false;\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-\t// we maintain a mirror list for the transform updates, so we can detect when an instance\n-\t// is no longer being transformed, and remove it from the interpolate list\n-\tSWAP(_interpolation_data.instance_transform_update_list_curr, _interpolation_data.instance_transform_update_list_prev);\n-\n-\t// prepare for the next iteration\n-\t_interpolation_data.instance_transform_update_list_curr->clear();\n }\n \n void VisualServerScene::update_interpolation_frame(bool p_process) {\n \t// update interpolation in storage\n \tVSG::storage->update_interpolation_frame(p_process);\n-\n-\tif (p_process) {\n-\t\treal_t f = Engine::get_singleton()->get_physics_interpolation_fraction();\n-\n-\t\tfor (unsigned int i = 0; i < _interpolation_data.instance_interpolate_update_list.size(); i++) {\n-\t\t\tconst RID &rid = _interpolation_data.instance_interpolate_update_list[i];\n-\t\t\tInstance *instance = instance_owner.getornull(rid);\n-\t\t\tif (instance) {\n-\t\t\t\tTransformInterpolator::interpolate_transform_via_method(instance->transform_prev, instance->transform_curr, instance->transform, f, instance->interpolation_method);\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\t\t\tprint_line(\"\\t\\tinterpolated: \" + rtos(instance->transform.origin.x) + \"\\t( prev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x) + \" ) on tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-#endif\n-\n-\t\t\t\t// make sure AABBs are constantly up to date through the interpolation\n-\t\t\t\t_instance_queue_update(instance, true);\n-\t\t\t}\n-\t\t} // for n\n-\t}\n }\n \n void VisualServerScene::instance_attach_object_instance_id(RID p_instance, ObjectID p_id) {\n@@ -1046,25 +856,6 @@ void VisualServerScene::instance_set_visible(RID p_instance, bool p_visible) {\n \n \tinstance->visible = p_visible;\n \n-\t// Special case for physics interpolation, we want to ensure the interpolated data is up to date\n-\tif (_interpolation_data.interpolation_enabled && p_visible && instance->interpolated && instance->scenario && !instance->on_interpolate_list) {\n-\t\t// Do all the extra work we normally do on instance_set_transform(), because this is optimized out for hidden instances.\n-\t\t// This prevents a glitch of stale interpolation transform data when unhiding before the next physics tick.\n-\t\tinstance->interpolation_method = TransformInterpolator::find_method(instance->transform_prev.basis, instance->transform_curr.basis);\n-\t\t_interpolation_data.instance_interpolate_update_list.push_back(p_instance);\n-\t\tinstance->on_interpolate_list = true;\n-\t\t_instance_queue_update(instance, true);\n-\n-\t\t// We must also place on the transform update list for a tick, so the system\n-\t\t// can auto-detect if the instance is no longer moving, and remove from the interpolate lists again.\n-\t\t// If this step is ignored, an unmoving instance could remain on the interpolate lists indefinitely\n-\t\t// (or rather until the object is deleted) and cause unnecessary updates and drawcalls.\n-\t\tif (!instance->on_interpolate_transform_list) {\n-\t\t\t_interpolation_data.instance_transform_update_list_curr->push_back(p_instance);\n-\t\t\tinstance->on_interpolate_transform_list = true;\n-\t\t}\n-\t}\n-\n \t// give the opportunity for the spatial partitioning scene to use a special implementation of visibility\n \t// for efficiency (supported in BVH but not octree)\n \n@@ -4496,7 +4287,6 @@ bool VisualServerScene::free(RID p_rid) {\n \t\tupdate_dirty_instances();\n \n \t\tInstance *instance = instance_owner.get(p_rid);\n-\t\t_interpolation_data.notify_free_instance(p_rid, *instance);\n \n \t\tinstance_set_use_lightmap(p_rid, RID(), RID(), -1, Rect2(0, 0, 1, 1));\n \t\tinstance_set_scenario(p_rid, RID());\ndiff --git a/servers/visual/visual_server_scene.h b/servers/visual/visual_server_scene.h\nindex 56b6ceb5b60b..76b890765796 100644\n--- a/servers/visual/visual_server_scene.h\n+++ b/servers/visual/visual_server_scene.h\n@@ -397,12 +397,6 @@ class VisualServerScene {\n \tvirtual void set_physics_interpolation_enabled(bool p_enabled);\n \n \tstruct InterpolationData {\n-\t\tvoid notify_free_instance(RID p_rid, Instance &r_instance);\n-\t\tLocalVector<RID> instance_interpolate_update_list;\n-\t\tLocalVector<RID> instance_transform_update_lists[2];\n-\t\tLocalVector<RID> *instance_transform_update_list_curr = &instance_transform_update_lists[0];\n-\t\tLocalVector<RID> *instance_transform_update_list_prev = &instance_transform_update_lists[1];\n-\n \t\tbool interpolation_enabled = false;\n \t} _interpolation_data;\n \n@@ -662,8 +656,6 @@ class VisualServerScene {\n \tvirtual void instance_set_layer_mask(RID p_instance, uint32_t p_mask);\n \tvirtual void instance_set_pivot_data(RID p_instance, float p_sorting_offset, bool p_use_aabb_center);\n \tvirtual void instance_set_transform(RID p_instance, const Transform &p_transform);\n-\tvirtual void instance_set_interpolated(RID p_instance, bool p_interpolated);\n-\tvirtual void instance_reset_physics_interpolation(RID p_instance);\n \tvirtual void instance_attach_object_instance_id(RID p_instance, ObjectID p_id);\n \tvirtual void instance_set_blend_shape_weight(RID p_instance, int p_shape, float p_weight);\n \tvirtual void instance_set_surface_material(RID p_instance, int p_surface, RID p_material);\ndiff --git a/servers/visual/visual_server_wrap_mt.h b/servers/visual/visual_server_wrap_mt.h\nindex 6ba16fb7786f..a422de5f6401 100644\n--- a/servers/visual/visual_server_wrap_mt.h\n+++ b/servers/visual/visual_server_wrap_mt.h\n@@ -481,8 +481,6 @@ class VisualServerWrapMT : public VisualServer {\n \tFUNC2(instance_set_layer_mask, RID, uint32_t)\n \tFUNC3(instance_set_pivot_data, RID, float, bool)\n \tFUNC2(instance_set_transform, RID, const Transform &)\n-\tFUNC2(instance_set_interpolated, RID, bool)\n-\tFUNC1(instance_reset_physics_interpolation, RID)\n \tFUNC2(instance_attach_object_instance_id, RID, ObjectID)\n \tFUNC3(instance_set_blend_shape_weight, RID, int, float)\n \tFUNC3(instance_set_surface_material, RID, int, RID)\ndiff --git a/servers/visual_server.cpp b/servers/visual_server.cpp\nindex f13470cf11de..93ca55c52437 100644\n--- a/servers/visual_server.cpp\n+++ b/servers/visual_server.cpp\n@@ -2172,8 +2172,6 @@ void VisualServer::_bind_methods() {\n \tClassDB::bind_method(D_METHOD(\"instance_set_scenario\", \"instance\", \"scenario\"), &VisualServer::instance_set_scenario);\n \tClassDB::bind_method(D_METHOD(\"instance_set_layer_mask\", \"instance\", \"mask\"), &VisualServer::instance_set_layer_mask);\n \tClassDB::bind_method(D_METHOD(\"instance_set_transform\", \"instance\", \"transform\"), &VisualServer::instance_set_transform);\n-\tClassDB::bind_method(D_METHOD(\"instance_set_interpolated\", \"instance\", \"interpolated\"), &VisualServer::instance_set_interpolated);\n-\tClassDB::bind_method(D_METHOD(\"instance_reset_physics_interpolation\", \"instance\"), &VisualServer::instance_reset_physics_interpolation);\n \tClassDB::bind_method(D_METHOD(\"instance_attach_object_instance_id\", \"instance\", \"id\"), &VisualServer::instance_attach_object_instance_id);\n \tClassDB::bind_method(D_METHOD(\"instance_set_blend_shape_weight\", \"instance\", \"shape\", \"weight\"), &VisualServer::instance_set_blend_shape_weight);\n \tClassDB::bind_method(D_METHOD(\"instance_set_surface_material\", \"instance\", \"surface\", \"material\"), &VisualServer::instance_set_surface_material);\ndiff --git a/servers/visual_server.h b/servers/visual_server.h\nindex 9668be06c56f..7ea42a4ebf34 100644\n--- a/servers/visual_server.h\n+++ b/servers/visual_server.h\n@@ -878,8 +878,6 @@ class VisualServer : public Object {\n \tvirtual void instance_set_layer_mask(RID p_instance, uint32_t p_mask) = 0;\n \tvirtual void instance_set_pivot_data(RID p_instance, float p_sorting_offset, bool p_use_aabb_center) = 0;\n \tvirtual void instance_set_transform(RID p_instance, const Transform &p_transform) = 0;\n-\tvirtual void instance_set_interpolated(RID p_instance, bool p_interpolated) = 0;\n-\tvirtual void instance_reset_physics_interpolation(RID p_instance) = 0;\n \tvirtual void instance_attach_object_instance_id(RID p_instance, ObjectID p_id) = 0;\n \tvirtual void instance_set_blend_shape_weight(RID p_instance, int p_shape, float p_weight) = 0;\n \tvirtual void instance_set_surface_material(RID p_instance, int p_surface, RID p_material) = 0;\n", "instance_id": "godotengine__godot-103685", "clarity": 2, "difficulty": 0.85, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue with SkeletonIK3D failing to interpolate smoothly when physics interpolation is enabled in Godot v4.4.beta4, particularly in the context of camera movement and inverse kinematics in a first-person setup. It provides steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. Additionally, visual evidence (via GitHub asset links) is provided to demonstrate the problem. However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem statement suggests uncertainty about whether the issue lies in the implementation or the engine itself (\"It's entirely possible I am implementing this incorrectly\"), and it lacks specific technical details about the expected behavior of SkeletonIK3D with physics interpolation. Furthermore, critical constraints or edge cases (e.g., specific refresh rates or hardware configurations beyond the provided system info) are not explicitly mentioned. While the intent and reproduction steps are clear, these minor gaps in specificity and clarity about the root cause or expected fix lower the score to \"Mostly Clear.\"\n", "difficulty_explanation": "\nI assign a difficulty score of 0.85, placing this problem in the \"Very Hard\" category due to several factors:\n\n1. **Scope and Depth of Code Changes**: The code changes provided are extensive, spanning multiple files and modules within the Godot engine, including core data structures (`LocalVector`), scene management (`SceneTree`, `Spatial`, `Camera`), visual rendering (`VisualServer`, `Rasterizer`), and specific 3D components (`BoneAttachment`, `VehicleWheel`, `SkeletonIK`). The changes involve a significant overhaul of the physics interpolation system, introducing a new `SceneTreeFTI` class for fixed timestep interpolation and removing or refactoring existing interpolation logic. This impacts the system's architecture fundamentally, as it redefines how transforms are managed and updated across frames and physics ticks, affecting a wide range of engine components. The sheer volume of code changes (hundreds of lines across critical files) and the need to understand interactions between rendering, physics, and scene tree systems elevate the complexity.\n\n2. **Number of Technical Concepts**: Solving this problem requires a deep understanding of several advanced concepts, including:\n   - Physics interpolation and fixed timestep rendering in game engines, which involves managing state between physics updates and rendering frames.\n   - Godot's internal architecture, particularly the `VisualServer`, `SceneTree`, and `Spatial` hierarchies, as well as how transforms are propagated and rendered.\n   - Transform interpolation algorithms (e.g., `TransformInterpolator`), requiring knowledge of linear algebra and 3D mathematics.\n   - Low-level engine optimizations, such as managing dirty flags (`DIRTY_GLOBAL_INTERPOLATED`) and efficient list operations (`LocalVector` modifications).\n   - Domain-specific knowledge of inverse kinematics (`SkeletonIK3D`) and camera systems in 3D game engines.\n   These concepts are complex and require significant experience with game engine internals, making this a highly technical challenge.\n\n3. **Potential Edge Cases and Error Handling**: The problem and code changes implicitly address several edge cases, such as handling visibility states, inactive nodes, and transform updates outside physics frames. The code introduces mechanisms to prevent jittering (e.g., resetting interpolation data when nodes are no longer active) and ensures smooth transitions during scene tree changes (e.g., entering/exiting tree). However, the complexity of these edge cases is high, as they involve subtle interactions between visibility, physics ticks, and rendering updates. Error handling logic, such as ensuring transforms are not corrupted during interpolation, is also critical and non-trivial to implement correctly across all scenarios (e.g., high refresh rates, paused states, or sudden transform changes).\n\n4. **Overall Complexity and Impact**: The task requires not just fixing a bug but rearchitecting a core part of the engine's interpolation system to address the issue with `SkeletonIK3D`. This involves balancing performance (e.g., minimizing unnecessary updates in `SceneTreeFTI`) with correctness (e.g., ensuring interpolated transforms are accurate). The risk of introducing new bugs or performance regressions is significant, given the broad impact on the engine's rendering and physics systems. This level of challenge demands advanced expertise in Rust/C++ (as Godot is primarily C++), deep familiarity with game engine design, and careful consideration of system-level implications.\n\nGiven these factors, a score of 0.85 reflects the very high difficulty of this task, requiring extensive experience, intricate logic, and a comprehensive understanding of Godot's internals. It falls short of the absolute maximum (1.0) as it does not involve entirely novel system-level innovations (e.g., a new distributed system protocol) but rather a complex refactoring of existing systems.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Android rotating screen more than once causes a crash\n### Tested versions\n\nReproducible in:  4.4.dev4, 4.4.dev5, 4.4.beta, 4.4.rc1\nNot reproducible in: 4.4.dev3, 4.4.dev1, 4.3.stable\nRegression starting in 4.4.dev4 and still present in current 4.4.rc1\n\n### System information\n\nAndroid 14, Rendering: Forward Mobile Vulkan 1.1.128, GPU:Qualcomm Adreno 619, Hardware: Motorola One 5G Ace\n\n### Issue description\n\nRotating the phone screen more than once causes the exported game/app to crash on Android. Expected to be able to rotate the screen more than once in any direction without crashing.\n\n\n### Steps to reproduce\n\nCreate a new empty project, Set Project>Project Settings>Display>Window>Handheld>Orientation>Sensor.\nExport the project to Android and run.\nRotate the screen once than rotate it again (crash).\n\n### Minimal reproduction project (MRP)\n\nN/A. Reproducible in a new project with Display Orientation set to Sensor on Android.\n", "patch": "diff --git a/.github/workflows/android_builds.yml b/.github/workflows/android_builds.yml\nindex 443b0be0f388..426efac6ece3 100644\n--- a/.github/workflows/android_builds.yml\n+++ b/.github/workflows/android_builds.yml\n@@ -62,8 +62,8 @@ jobs:\n       - name: Download pre-built Android Swappy Frame Pacing Library\n         uses: dsaltares/fetch-gh-release-asset@1.1.2\n         with:\n-          repo: darksylinc/godot-swappy\n-          version: tags/v2023.3.0.0\n+          repo: godotengine/godot-swappy\n+          version: tags/from-source-2025-01-31\n           file: godot-swappy.7z\n           target: swappy/godot-swappy.7z\n \ndiff --git a/.gitignore b/.gitignore\nindex 2c3bf742ba2e..8adc7b786c63 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -263,6 +263,11 @@ bld/\n !thirdparty/**/arm/\n !thirdparty/**/arm64/\n \n+thirdparty/swappy-frame-pacing/arm64-v8a/abi.json\n+thirdparty/swappy-frame-pacing/armeabi-v7a/abi.json\n+thirdparty/swappy-frame-pacing/x86/abi.json\n+thirdparty/swappy-frame-pacing/x86_64/abi.json\n+\n # Visual Studio 2015/2017 cache/options directory\n .vs/\n \ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 571cfd9819c0..cac7c3f48d4e 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -187,7 +187,7 @@ def configure(env: \"SConsEnvironment\"):\n     has_swappy = detect_swappy()\n     if not has_swappy:\n         print_warning(\n-            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/darksylinc/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n+            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/godotengine/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n             + \" thirdparty/swappy-frame-pacing/arm64-v8a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/armeabi-v7a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/x86/libswappy_static.a\\n\"\ndiff --git a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\nindex d29ac01af384..25ce813968f7 100644\n--- a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n+++ b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n@@ -31,11 +31,12 @@\n \n // There are separate versions for each GameSDK component that use this format:\n #define ANDROID_GAMESDK_PACKED_VERSION(MAJOR, MINOR, BUGFIX) \\\n-    ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n+  ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n // Accessors\n #define ANDROID_GAMESDK_MAJOR_VERSION(PACKED) ((PACKED) >> 16)\n #define ANDROID_GAMESDK_MINOR_VERSION(PACKED) (((PACKED) >> 8) & 0xff)\n #define ANDROID_GAMESDK_BUGFIX_VERSION(PACKED) ((PACKED) & 0xff)\n \n-#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX, GIT) \\\n-#MAJOR \".\" #MINOR \".\" #BUGFIX \".\" #GIT\n+#define AGDK_STRINGIFY(NUMBER) #NUMBER\n+#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX) \\\n+  AGDK_STRINGIFY(MAJOR) \".\" AGDK_STRINGIFY(MINOR) \".\" AGDK_STRINGIFY(BUGFIX)\ndiff --git a/thirdparty/swappy-frame-pacing/swappyVk.h b/thirdparty/swappy-frame-pacing/swappyVk.h\nindex 020683cbc43c..654fcbf4a4a7 100644\n--- a/thirdparty/swappy-frame-pacing/swappyVk.h\n+++ b/thirdparty/swappy-frame-pacing/swappyVk.h\n@@ -281,30 +281,30 @@ void SwappyVk_uninjectTracer(const SwappyTracer* tracer);\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyVkFunctionProvider {\n-    /**\n-     * @brief Callback to initialize the function provider.\n-     *\n-     * This function is called by Swappy before any functions are requested.\n-     * E.g. so you can call dlopen on the Vulkan library.\n-     */\n-    bool (*init)();\n-\n-    /**\n-     * @brief Callback to get the address of a function.\n-     *\n-     * This function is called by Swappy to get the address of a Vulkan\n-     * function.\n-     * @param name The null-terminated name of the function.\n-     */\n-    void* (*getProcAddr)(const char* name);\n-\n-    /**\n-     * @brief Callback to close any resources owned by the function provider.\n-     *\n-     * This function is called by Swappy when no more functions will be\n-     * requested, e.g. so you can call dlclose on the Vulkan library.\n-     */\n-    void (*close)();\n+  /**\n+   * @brief Callback to initialize the function provider.\n+   *\n+   * This function is called by Swappy before any functions are requested.\n+   * E.g. so you can call dlopen on the Vulkan library.\n+   */\n+  bool (*init)();\n+\n+  /**\n+   * @brief Callback to get the address of a function.\n+   *\n+   * This function is called by Swappy to get the address of a Vulkan\n+   * function.\n+   * @param name The null-terminated name of the function.\n+   */\n+  void* (*getProcAddr)(const char* name);\n+\n+  /**\n+   * @brief Callback to close any resources owned by the function provider.\n+   *\n+   * This function is called by Swappy when no more functions will be\n+   * requested, e.g. so you can call dlclose on the Vulkan library.\n+   */\n+  void (*close)();\n } SwappyVkFunctionProvider;\n \n /**\n@@ -384,7 +384,8 @@ void SwappyVk_enableStats(VkSwapchainKHR swapchain, bool enabled);\n \n  * @see SwappyVk_enableStats.\n  */\n-void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t image);\n+void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain,\n+                               uint32_t image);\n \n /**\n  * @brief Returns the stats collected, if statistics collection was toggled on.\n@@ -396,11 +397,11 @@ void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t\n  * conditions.\n  *\n  * @param[in]  swapchain   - The swapchain for which stats are being queried.\n- * @param      swappyStats - Pointer to a SwappyStats that will be populated with\n- *                             the collected stats. Cannot be NULL.\n+ * @param      swappyStats - Pointer to a SwappyStats that will be populated\n+ * with the collected stats. Cannot be NULL.\n  * @see SwappyStats\n  */\n-void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n+void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats* swappyStats);\n \n /**\n  * @brief Clears the frame statistics collected so far.\n@@ -413,6 +414,58 @@ void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n  */\n void SwappyVk_clearStats(VkSwapchainKHR swapchain);\n \n+/**\n+ * @brief Reset the swappy pacing mechanism\n+ *\n+ * In cases where the frame timing history is irrelevant (for example during\n+ * scene/level transitions or after loading screens), calling this would\n+ * remove all the history for frame pacing. Calling this entry point\n+ * would reset the frame rate to the initial state at the end of the current\n+ * frame. Then swappy would just pace as normal with fresh state from next\n+ * frame. There are no error conditions associated with this call.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which frame pacing is reset.\n+ */\n+void SwappyVk_resetFramePacing(VkSwapchainKHR swapchain);\n+\n+/**\n+ * @brief Enable/Disable the swappy pacing mechanism\n+ *\n+ * By default frame pacing is enabled when swappy is used, however it can be\n+ * disabled at runtime by calling `SwappyVk_enableFramePacing(swapchain,\n+ * false)`. When the frame pacing is disabled, ::SwappyVk_enableBlockingWait\n+ * will control whether\n+ * ::SwappyVk_queuePresent will return immediately, or will block until the\n+ * previous frame's GPU work is completed. All enabling/disabling effects take\n+ * place from next frame. Once disabled, `SwappyVk_enableFramePacing(swapchain,\n+ * true)` will enable frame pacing again with a fresh frame time state -\n+ * equivalent of calling ::SwappyVk_resetFramePacing().\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, enables frame pacing otherwise disables it\n+ */\n+void SwappyVk_enableFramePacing(VkSwapchainKHR swapchain, bool enable);\n+\n+/**\n+ * @brief Enable/Disable blocking wait when frame-pacing is disabled\n+ *\n+ * By default ::SwappyVk_queuePresent will do a blocking wait until previous\n+ * frame's GPU work is completed. However when frame pacing is disabled, calling\n+ * `SwappyVk_enableBlockingWait(swapchain, false)` will ensure that\n+ * ::SwappyVk_queuePresent returns without waiting for previous frame's GPU\n+ * work. This behaviour impacts the GPU time returned in the\n+ * ::SwappyPostWaitCallback callback. If the last frame's GPU work is done by\n+ * the time ::SwappyVk_queuePresent for this frame is called, then the previous\n+ * frame's GPU time will be returned otherwise `-1` will be delivered in the\n+ * callback for the frame. This setting has no impact when frame pacing is\n+ * enabled.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, ::SwappyVk_queuePresent will block until\n+ * the previous frame's GPU work is complete.\n+ */\n+void SwappyVk_enableBlockingWait(VkSwapchainKHR swapchain, bool enable);\n+\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\ndiff --git a/thirdparty/swappy-frame-pacing/swappy_common.h b/thirdparty/swappy-frame-pacing/swappy_common.h\nindex b711ca910fb3..acceb4243df6 100644\n--- a/thirdparty/swappy-frame-pacing/swappy_common.h\n+++ b/thirdparty/swappy-frame-pacing/swappy_common.h\n@@ -48,22 +48,22 @@\n \n // Internal macros to track Swappy version, do not use directly.\n #define SWAPPY_MAJOR_VERSION 2\n-#define SWAPPY_MINOR_VERSION 0\n+#define SWAPPY_MINOR_VERSION 2\n #define SWAPPY_BUGFIX_VERSION 0\n-#define SWAPPY_PACKED_VERSION                                                  \\\n-    ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n-                                   SWAPPY_BUGFIX_VERSION)\n+#define SWAPPY_PACKED_VERSION                                                \\\n+  ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n+                                 SWAPPY_BUGFIX_VERSION)\n \n // Internal macros to generate a symbol to track Swappy version, do not use\n // directly.\n #define SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n+  PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n #define SWAPPY_VERSION_CONCAT(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n-#define SWAPPY_VERSION_SYMBOL                                          \\\n-    SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n-                          SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n-                          AGDK_GIT_COMMIT)\n+  SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n+#define SWAPPY_VERSION_SYMBOL                                        \\\n+  SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n+                        SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n+                        AGDK_GIT_COMMIT)\n \n // Define this to 1 to enable all logging from Swappy, by default it is\n // disabled in a release build and enabled in a debug build.\n@@ -83,29 +83,29 @@ typedef uint64_t SwappyThreadId;\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyThreadFunctions {\n-    /** @brief Thread start callback.\n-     *\n-     * This function is called by Swappy to start thread_func on a new thread.\n-     * @param user_data A value to be passed the thread function.\n-     * If the thread was started, this function should set the thread_id and\n-     * return 0. If the thread was not started, this function should return a\n-     * non-zero value.\n-     */\n-    int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n-                 void* user_data);\n-\n-    /** @brief Thread join callback.\n-     *\n-     * This function is called by Swappy to join the thread with given id.\n-     */\n-    void (*join)(SwappyThreadId thread_id);\n-\n-    /** @brief Thread joinable callback.\n-     *\n-     * This function is called by Swappy to discover whether the thread with the\n-     * given id is joinable.\n-     */\n-    bool (*joinable)(SwappyThreadId thread_id);\n+  /** @brief Thread start callback.\n+   *\n+   * This function is called by Swappy to start thread_func on a new thread.\n+   * @param user_data A value to be passed the thread function.\n+   * If the thread was started, this function should set the thread_id and\n+   * return 0. If the thread was not started, this function should return a\n+   * non-zero value.\n+   */\n+  int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n+               void* user_data);\n+\n+  /** @brief Thread join callback.\n+   *\n+   * This function is called by Swappy to join the thread with given id.\n+   */\n+  void (*join)(SwappyThreadId thread_id);\n+\n+  /** @brief Thread joinable callback.\n+   *\n+   * This function is called by Swappy to discover whether the thread with the\n+   * given id is joinable.\n+   */\n+  bool (*joinable)(SwappyThreadId thread_id);\n } SwappyThreadFunctions;\n \n #ifdef __cplusplus\n@@ -138,47 +138,46 @@ const char* Swappy_versionString();\n  * ::SwappyGL_enableStats or ::SwappyVk_enableStats.\n  */\n typedef struct SwappyStats {\n-    /** @brief Total frames swapped by swappy */\n-    uint64_t totalFrames;\n-\n-    /** @brief Histogram of the number of screen refreshes a frame waited in the\n-     * compositor queue after rendering was completed.\n-     *\n-     * For example:\n-     *     if a frame waited 2 refresh periods in the compositor queue after\n-     * rendering was done, the frame will be counted in idleFrames[2]\n-     */\n-    uint64_t idleFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * requested presentation time and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the requested\n-     * timestamp swappy set, the frame will be counted in lateFrames[2]\n-     */\n-    uint64_t lateFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between two\n-     * consecutive frames\n-     *\n-     * For example:\n-     *     if frame N was presented 2 refresh periods after frame N-1\n-     *     frame N will be counted in offsetFromPreviousFrame[2]\n-     */\n-    uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * call to Swappy_recordFrameStart and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the call to\n-     * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n-     */\n-    uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n+  /** @brief Total frames swapped by swappy */\n+  uint64_t totalFrames;\n+\n+  /** @brief Histogram of the number of screen refreshes a frame waited in the\n+   * compositor queue after rendering was completed.\n+   *\n+   * For example:\n+   *     if a frame waited 2 refresh periods in the compositor queue after\n+   * rendering was done, the frame will be counted in idleFrames[2]\n+   */\n+  uint64_t idleFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * requested presentation time and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the requested\n+   * timestamp swappy set, the frame will be counted in lateFrames[2]\n+   */\n+  uint64_t lateFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between two\n+   * consecutive frames\n+   *\n+   * For example:\n+   *     if frame N was presented 2 refresh periods after frame N-1\n+   *     frame N will be counted in offsetFromPreviousFrame[2]\n+   */\n+  uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * call to Swappy_recordFrameStart and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the call to\n+   * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n+   */\n+  uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n } SwappyStats;\n \n-\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\n@@ -236,43 +235,43 @@ typedef void (*SwappySwapIntervalChangedCallback)(void*);\n  * Injection of these is optional.\n  */\n typedef struct SwappyTracer {\n-    /**\n-     * Callback called before waiting to queue the frame to the composer.\n-     */\n-    SwappyPreWaitCallback preWait;\n-\n-    /**\n-     * Callback called after wait to queue the frame to the composer is done.\n-     */\n-    SwappyPostWaitCallback postWait;\n-\n-    /**\n-     * Callback called before calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPreSwapBuffersCallback preSwapBuffers;\n-\n-    /**\n-     * Callback called after calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPostSwapBuffersCallback postSwapBuffers;\n-\n-    /**\n-     * Callback called at the start of a frame.\n-     */\n-    SwappyStartFrameCallback startFrame;\n-\n-    /**\n-     * Pointer to some arbitrary data that will be passed as the first argument\n-     * of callbacks.\n-     */\n-    void* userData;\n-\n-    /**\n-     * Callback called when the swap interval was changed.\n-     */\n-    SwappySwapIntervalChangedCallback swapIntervalChanged;\n+  /**\n+   * Callback called before waiting to queue the frame to the composer.\n+   */\n+  SwappyPreWaitCallback preWait;\n+\n+  /**\n+   * Callback called after wait to queue the frame to the composer is done.\n+   */\n+  SwappyPostWaitCallback postWait;\n+\n+  /**\n+   * Callback called before calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPreSwapBuffersCallback preSwapBuffers;\n+\n+  /**\n+   * Callback called after calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPostSwapBuffersCallback postSwapBuffers;\n+\n+  /**\n+   * Callback called at the start of a frame.\n+   */\n+  SwappyStartFrameCallback startFrame;\n+\n+  /**\n+   * Pointer to some arbitrary data that will be passed as the first argument\n+   * of callbacks.\n+   */\n+  void* userData;\n+\n+  /**\n+   * Callback called when the swap interval was changed.\n+   */\n+  SwappySwapIntervalChangedCallback swapIntervalChanged;\n } SwappyTracer;\n \n /** @} */\n", "instance_id": "godotengine__godot-103409", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: rotating the screen more than once on Android causes a crash in specific versions of the software (4.4.dev4 to 4.4.rc1). It provides detailed system information, steps to reproduce, and specifies the affected versions, which helps in understanding the scope of the regression. However, there are minor ambiguities and missing details. For instance, the exact cause of the crash (e.g., stack trace, error logs, or specific component failure) is not mentioned, which would be critical for debugging. Additionally, while the steps to reproduce are provided, there are no specifics on the expected behavior beyond \"not crashing,\" nor are there mentions of specific edge cases or conditions under which the crash might vary (e.g., specific Android API levels or device configurations beyond the one tested). Thus, while the problem is valid and mostly clear, it lacks some critical debugging details and edge case specifications, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty score of 0.75 reflects a hard problem due to several factors. First, the scope of code changes involves multiple files and components, including updates to the Swappy Frame Pacing library (a third-party dependency for Android rendering), modifications to build configurations (e.g., GitHub workflows), and updates to header files with significant changes in functionality (e.g., adding frame pacing controls and stats handling in Vulkan rendering). This indicates a need to understand interactions between the rendering pipeline, Android-specific behaviors, and external libraries, which increases complexity. Second, the technical concepts involved are moderately advanced, including Vulkan rendering, frame pacing mechanisms, Android-specific screen rotation handling, and version-specific regressions, requiring familiarity with low-level graphics programming and Android's native development environment. Third, while the problem statement does not explicitly mention edge cases, the nature of screen rotation and rendering suggests potential complexities in handling various device orientations, refresh rates, and Android versions, as well as ensuring thread safety and performance in the rendering pipeline. Finally, the changes impact a critical part of the system (rendering on Android), which could have broader architectural implications if not handled carefully. Although the provided code changes seem to address the issue by updating the Swappy library and related configurations, implementing and verifying the fix requires deep understanding and careful testing across multiple scenarios, justifying a score in the hard range (0.6-0.8), specifically 0.75 due to the specialized knowledge of Android rendering and Vulkan required.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.9, "human_difficulty_modify_explanation": "The workload involved in low-level graphics programming is substantial, and given the unknown impact on the safety of other system functionalities, it is therefore rated as high difficulty."}
{"problem_statement": "\"Game Embedding not available on your OS\" EndeavorOS Hyprland\n### Tested versions\n\nReproducible in: 4.4.beta3\n\n### System information\n\nGodot v4.4.beta3 - EndeavourOS #1 SMP PREEMPT_DYNAMIC Sun, 02 Feb 2025 01:02:29 +0000 on Wayland - Wayland display driver, Single-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) HD Graphics 500 (APL 2) - Intel(R) Celeron(R) CPU N3350 @ 1.10GHz (2 threads)\n\n### Issue description\n\nWas going to test for the first time the game embedding from 4.4 and was surprised to seed it did not work, the devlogs said it was available for linux so that got me wondering if it was a Hyprland issue, but I could not find anything online, or on the issues, easily available.\n\n### Steps to reproduce\n\n- Create any new project\n- Run any scene\n- Open game tab\n\n### Minimal reproduction project (MRP)\n\nAny godot project\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 638262fb8bec..efc5719d2def 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -446,6 +446,10 @@ GameView::EmbedAvailability GameView::_get_embed_available() {\n \tif (get_tree()->get_root()->is_embedding_subwindows()) {\n \t\treturn EMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE;\n \t}\n+\tString display_driver = GLOBAL_GET(\"display/display_server/driver\");\n+\tif (display_driver == \"headless\" || display_driver == \"wayland\") {\n+\t\treturn EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER;\n+\t}\n \n \tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n \tif (placement.force_fullscreen) {\n@@ -489,7 +493,14 @@ void GameView::_update_ui() {\n \t\t\t}\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_FEATURE_NOT_SUPPORTED:\n-\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\tif (DisplayServer::get_singleton()->get_name() == \"Wayland\") {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on Wayland.\\nWayland can be disabled in the Editor Settings (Run > Platforms > Linux/*BSD > Prefer Wayland).\"));\n+\t\t\t} else {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER:\n+\t\t\tstate_label->set_text(vformat(TTR(\"Game embedding not available for the Display Server: '%s'.\\nDisplay Server can be modified in the Project Settings (Display > Display Server > Driver).\"), GLOBAL_GET(\"display/display_server/driver\")));\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_MINIMIZED:\n \t\t\tstate_label->set_text(TTR(\"Game embedding not available when the game starts minimized.\\nConsider overriding the window mode project setting with the editor feature tag to Windowed to use game embedding while leaving the exported project intact.\"));\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6be2d961ba08..6e08c269b063 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -108,6 +108,7 @@ class GameView : public VBoxContainer {\n \t\tEMBED_NOT_AVAILABLE_MAXIMIZED,\n \t\tEMBED_NOT_AVAILABLE_FULLSCREEN,\n \t\tEMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE,\n+\t\tEMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER,\n \t};\n \n \tinline static GameView *singleton = nullptr;\n", "instance_id": "godotengine__godot-102833", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: game embedding does not work on EndeavourOS with Hyprland using the Wayland display driver in Godot v4.4.beta3. It provides system information, steps to reproduce, and mentions that the feature was expected to work on Linux based on devlogs. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"game embedding\" entails or what the expected behavior should be when it works. Additionally, there are no specific error messages or logs provided to pinpoint the root cause, and edge cases or constraints (e.g., specific Wayland compositors or hardware limitations) are not mentioned. While the issue is reproducible with any Godot project, the lack of deeper context or detailed expectations slightly reduces the clarity.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.35, placing it in the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively small and localized to two files (`game_view_plugin.cpp` and `game_view_plugin.h`) within the Godot editor plugin. The modifications involve adding a new enum value for a specific error condition (`EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER`) and updating the UI feedback to inform users about unsupported display drivers like Wayland. The changes do not impact the broader system architecture or require extensive refactoring, as they are confined to a specific feature (game embedding) and its error reporting logic. The amount of code changed is minimal, with only a few lines added or modified.\n\n2. **Number of Technical Concepts**: Solving this issue requires a basic understanding of Godot's editor plugin system, specifically how display drivers are queried and how UI elements are updated based on runtime conditions. Familiarity with C++ (used in Godot's core) is necessary, but the concepts involved\u2014string comparison, enum usage, and UI text updates\u2014are straightforward. No advanced algorithms, design patterns, or domain-specific knowledge (beyond basic graphics display drivers like Wayland) are required.\n\n3. **Potential Edge Cases and Error Handling**: The problem and code changes address a specific edge case: game embedding not working on Wayland or headless display drivers. The solution adds explicit error messaging to guide users on how to potentially resolve the issue (e.g., by changing settings). However, the complexity of handling these edge cases is low, as it only involves detecting the display driver and updating a UI label. No intricate error recovery or fallback mechanisms are implemented in the provided diff.\n\n4. **Overall Assessment**: This task falls into the \"Easy\" category because it involves simple modifications to existing logic, with a clear goal of improving user feedback for an unsupported feature. It requires understanding a small part of the codebase and making targeted changes without significant risk of introducing bugs or affecting other systems. The difficulty is slightly above the \"Very Easy\" range (0.0-0.2) due to the need to understand Godot's display driver system and editor settings, but it does not reach \"Medium\" difficulty (0.4-0.6) as it lacks complexity in terms of cross-module interactions or advanced technical challenges.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Jolt Physics warnings for PhysicalBone3D fail to report bone names when running physics on separate thread\n### Tested versions\n\n- Reproducible in 4.4-beta2, 4.4-beta3\n- Not reproducible in 4.3 (no Jolt implementation)\n\n### System information\n\nGodot v4.4.beta3 - Fedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4080 SUPER (nvidia; 565.77) - AMD Ryzen 7 8700F 8-Core Processor (16 threads)\n\n### Issue description\n\nI am using the native Jolt Physics engine on a separate thread via project settings (`physics/3d/run_on_separate_thread`). I have an armature that needs updating, so Jolt is emitting warnings. However, the warning is attempting to fetch the names of the problem bones, which is not thread-safe, so the warning text is malformed and is passed with multiple errors (as seen below).\n\n```\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine_001). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects '' and ''.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\n\nWhen physics is set to run on the main thread, the problem resolves, showing the warnings as normal, including the bone names (expected behavior).\n```\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3027113173784>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3027146728218>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3102627426828>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3102660981262>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\nShould the warning itself be deferred to the main thread?\n\n### Steps to reproduce\n\n1. Set physics to run on a separate thread `physics/3d/run_on_separate_thread`\n2. Switch Physics Engine to Jolt Physics\n3. Set up a Skeleton3D with PhysicalBone3D bones that have joint properties unsupported in Jolt (i.e. a Pinjoint configured with impulse clamping)\n4. Restart editor to see errors in console, or launch game to see them in debugger\n\n### Minimal reproduction project (MRP)\n\nWarnings should appear as soon as this project is opened and imported.\n\n[physicalbone3d_report_2025-02-09_17-35-51.zip](https://github.com/user-attachments/files/18726415/physicalbone3d_report_2025-02-09_17-35-51.zip)\n", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex c48b05002c82..7d41d2faa601 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2330,6 +2330,7 @@\n \t\t</member>\n \t\t<member name=\"physics/3d/run_on_separate_thread\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n \t\t\tIf [code]true[/code], the 3D physics server runs on a separate thread, making better use of multi-core CPUs. If [code]false[/code], the 3D physics server runs on the main thread. Running the physics server on a separate thread can increase performance, but restricts API access to only physics process.\n+\t\t\t[b]Note:[/b] When [member physics/3d/physics_engine] is set to [code]Jolt Physics[/code], enabling this setting will prevent the 3D physics server from being able to provide any context when reporting errors and warnings, and will instead always refer to nodes as [code]&lt;unknown&gt;[/code].\n \t\t</member>\n \t\t<member name=\"physics/3d/sleep_threshold_angular\" type=\"float\" setter=\"\" getter=\"\" default=\"0.139626\">\n \t\t\tThreshold angular velocity under which a 3D physics body will be considered inactive. See [constant PhysicsServer3D.SPACE_PARAM_BODY_ANGULAR_VELOCITY_SLEEP_THRESHOLD].\ndiff --git a/modules/jolt_physics/jolt_physics_server_3d.h b/modules/jolt_physics/jolt_physics_server_3d.h\nindex 7dac7610f71a..416e3df56aec 100644\n--- a/modules/jolt_physics/jolt_physics_server_3d.h\n+++ b/modules/jolt_physics/jolt_physics_server_3d.h\n@@ -421,6 +421,7 @@ class JoltPhysicsServer3D final : public PhysicsServer3D {\n \n \tvirtual int get_process_info(PhysicsServer3D::ProcessInfo p_process_info) override;\n \n+\tbool is_on_separate_thread() const { return on_separate_thread; }\n \tbool is_active() const { return active; }\n \n \tvoid free_space(JoltSpace3D *p_space);\ndiff --git a/modules/jolt_physics/objects/jolt_object_3d.cpp b/modules/jolt_physics/objects/jolt_object_3d.cpp\nindex 1c2019d9fa3f..e9e6d504e0e7 100644\n--- a/modules/jolt_physics/objects/jolt_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_object_3d.h\"\n \n+#include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n #include \"../spaces/jolt_layers.h\"\n #include \"../spaces/jolt_space_3d.h\"\n@@ -137,6 +138,12 @@ bool JoltObject3D::can_interact_with(const JoltObject3D &p_other) const {\n }\n \n String JoltObject3D::to_string() const {\n+\tstatic const String fallback_name = \"<unknown>\";\n+\n+\tif (JoltPhysicsServer3D::get_singleton()->is_on_separate_thread()) {\n+\t\treturn fallback_name; // Calling `Object::to_string` is not thread-safe.\n+\t}\n+\n \tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n+\treturn instance != nullptr ? instance->to_string() : fallback_name;\n }\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\nindex 281591af9a6c..040d98dace9f 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n@@ -727,8 +727,3 @@ bool JoltSoftBody3D::is_vertex_pinned(int p_index) const {\n \n \treturn pinned_vertices.has(physics_index);\n }\n-\n-String JoltSoftBody3D::to_string() const {\n-\tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n-}\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.h b/modules/jolt_physics/objects/jolt_soft_body_3d.h\nindex f236310f6c69..4d7eb039426b 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.h\n@@ -167,8 +167,6 @@ class JoltSoftBody3D final : public JoltObject3D {\n \tvoid unpin_all_vertices();\n \n \tbool is_vertex_pinned(int p_index) const;\n-\n-\tString to_string() const;\n };\n \n #endif // JOLT_SOFT_BODY_3D_H\n", "instance_id": "godotengine__godot-102726", "clarity": 3, "difficulty": 0.45, "clarity_explanation": "The problem statement is comprehensive and well-structured. It clearly describes the issue: when using Jolt Physics on a separate thread in Godot 4.4, warnings fail to report bone names due to thread-safety issues, resulting in malformed output. The goal is evident\u2014ensure warnings are meaningful even when physics runs on a separate thread. The statement includes detailed system information, tested versions, steps to reproduce, and even a minimal reproduction project (MRP). It contrasts the behavior between running physics on the main thread (correct output) and a separate thread (malformed output), providing clear examples of expected versus actual results. Constraints and context, such as the thread-safety limitation, are explicitly mentioned. There are no significant ambiguities, and the problem's scope is well-defined, making it a strong candidate for a clarity score of 3.", "difficulty_explanation": "The difficulty of this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes is moderate, involving modifications across a few files (e.g., `jolt_physics_server_3d.h`, `jolt_object_3d.cpp`, `jolt_soft_body_3d.cpp`, and documentation in `ProjectSettings.xml`). The changes primarily focus on adding thread-awareness to prevent unsafe calls to `Object::to_string()` and updating documentation to reflect limitations, which does not significantly impact the system's architecture. Second, the technical concepts required include understanding thread-safety in a game engine context, familiarity with Godot's physics server implementation, and basic knowledge of the Jolt Physics integration. These concepts are not overly complex for someone with experience in multi-threaded programming or game engines, though they do require specific domain knowledge. Third, the problem does not explicitly mention complex edge cases beyond the thread-safety issue, and the provided solution (returning a fallback string when on a separate thread) is straightforward, with minimal error-handling additions. Lastly, the amount of code change is small and localized, mostly involving conditional checks and documentation updates. Overall, this problem requires understanding multiple concepts and making targeted modifications, but it lacks the depth or architectural impact to push it into the hard category, justifying a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Godot 4.4 throws errors when using `await` on EditorPlugin\n### Tested versions\n\n- Reproducible: 4.4-dev1 and 4.4-dev7\n- Not Reproducible: 4.3-stable\n\n### System information\n\nGodot v4.4.dev7 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1650 (NVIDIA; 32.0.15.6603) - Intel(R) Core(TM) i7-2600K CPU @ 3.40GHz (8 threads)\n\n### Issue description\n\nWhen the editor starts up, calling code from an Autoload to an EditorPlugin with a function that uses `while` and `await` will result in either:\n- Working fine.\n- Throwing a Bad Address Index error.\n- Throwing an Internal Script error with opcode 0, 1 or 99.\n- Crashing to desktop.\n\n![Image](https://github.com/user-attachments/assets/24fe74ed-8acc-4ff7-b0d8-8fa50fee318a)\n\n### Steps to reproduce\n\nThe MRP will throw the error when opening the project. If it doesn't, use \"Project > Reload Current Project\" as sometimes it may simply work.\n\nThis problem seems to require a combination of a few situations to happen:\n- The EditorPlugin must be enabled. The issue vanishes when disabled, even if there are no changes in the script execution.\n- The function must be called from the Autoloader to the EditorPlugin, if called from inside the EditorPlugin, it works fine.\n- the EditorPlugin class must be loaded inside the function using `load()`. Works fine with a preloaded variable on the class scope.\n- The `await` must be inside the `while` loop.\n\n\nSome background on why I'm running code like this:\n- To isolate editor access to only inside the EditorPlugin class.\n- My plugin checks for a resource file, if it doesn't exist, creates the file and updates the FileSystem if it's in editor mode.\n- After v4.2 or v4.3, the FileSystem takes a while to load and during that time any new files or requests to update are ignored.\n- I can't use `preload()` because EditorPlugin classes are not exported to runtime.\n\n### Minimal reproduction project (MRP)\n\n[project_bad_address.zip](https://github.com/user-attachments/files/18223024/project_bad_address.zip)\n", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 961d81c034fd..c8b6227d1341 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -3710,7 +3710,9 @@ void EditorNode::set_addon_plugin_enabled(const String &p_addon, bool p_enabled,\n \t// Only try to load the script if it has a name. Else, the plugin has no init script.\n \tif (script_path.length() > 0) {\n \t\tscript_path = addon_path.get_base_dir().path_join(script_path);\n-\t\tscr = ResourceLoader::load(script_path, \"Script\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n+\t\t// We should not use the cached version on startup to prevent a script reload\n+\t\t// if it is already loaded and potentially running from autoloads. See GH-100750.\n+\t\tscr = ResourceLoader::load(script_path, \"Script\", EditorFileSystem::get_singleton()->doing_first_scan() ? ResourceFormatLoader::CACHE_MODE_REUSE : ResourceFormatLoader::CACHE_MODE_IGNORE);\n \n \t\tif (scr.is_null()) {\n \t\t\tshow_warning(vformat(TTR(\"Unable to load addon script from path: '%s'.\"), script_path));\n", "instance_id": "godotengine__godot-102535", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with Godot 4.4 when using `await` in an EditorPlugin under specific conditions. It provides detailed steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. The description also includes specific scenarios (e.g., EditorPlugin must be enabled, `await` inside a `while` loop) that trigger the error, along with background on why the code is structured this way. However, there are minor ambiguities: the exact nature of the errors (e.g., \"Bad Address Index error\" or \"Internal Script error with opcode 0, 1 or 99\") is not fully explained, and the problem statement does not explicitly define the expected behavior or desired outcome beyond \"fixing the error.\" Additionally, edge cases or constraints around the timing of the FileSystem loading or other environmental factors are not fully specified, which could impact the solution's robustness. Overall, while the issue is well-documented, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code change, while seemingly small (a single line modification in `editor_node.cpp`), requires a deep understanding of the Godot engine's internals, specifically the resource loading mechanism and the interaction between EditorPlugins, Autoloads, and the FileSystem during startup. The change involves modifying the caching behavior of `ResourceLoader::load()` based on whether the editor is performing its first scan, which suggests a nuanced understanding of initialization timing and script reloading issues (as referenced by GH-100750). Second, the technical concepts involved are moderately complex, including Godot's resource management, editor-specific constraints (e.g., EditorPlugin not being exported to runtime), and the interplay of asynchronous operations (`await`) with loops in the GDScript runtime. Third, the problem likely involves subtle edge cases related to startup timing, script execution order, and FileSystem readiness, which are not fully detailed but are implied by the erratic behavior (sometimes working, sometimes crashing). While the code change itself is minimal, the impact on the system's behavior is significant, as it addresses a core editor initialization issue that could affect stability across various plugins and projects. This combination of deep domain knowledge, system-level understanding, and potential for subtle bugs or regressions places the difficulty at 0.65, within the \"Hard\" range (0.6-0.8), though not at the extreme end due to the localized nature of the fix.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.85, "human_difficulty_explanation": "The code that needs to be modified involves too many aspects such as asynchronous operations and file execution order, which most models do not possess the specialized knowledge to handle." }
{"problem_statement": "Crash when duplicating file with Ctrl+Drag and drop\n### Tested versions\n\n4.4 dev7, dev6, didn't test earlier\n\n### System information\n\nW10\n\n### Issue description\n\n```\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.4.dev.custom_build (d2ada64a03d2abdb97cafe8f10623db8a2ce1d4c)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] std::_Atomic_storage<unsigned __int64,8>::load (C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.39.33519\\include\\atomic:1121)\n[1] std::_Atomic_storage<unsigned __int64,8>::load (C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.39.33519\\include\\atomic:1121)\n[2] SafeNumeric<unsigned __int64>::conditional_increment (C:\\godot_source\\core\\templates\\safe_refcount.h:139)\n[3] CowData<char32_t>::_ref (C:\\godot_source\\core\\templates\\cowdata.h:502)\n[4] String::String (C:\\godot_source\\core\\string\\ustring.h:602)\n[5] EditorFileSystemDirectory::get_file (C:\\godot_source\\editor\\editor_file_system.cpp:94)\n[6] EditorFileSystemDirectory::get_file_path (C:\\godot_source\\editor\\editor_file_system.cpp:126)\n[7] EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor\\editor_file_system.cpp:847)\n[8] EditorFileSystem::_notification (C:\\godot_source\\editor\\editor_file_system.cpp:1714)\n[9] EditorFileSystem::_notificationv (C:\\godot_source\\editor\\editor_file_system.h:145)\n[10] Object::notification (C:\\godot_source\\core\\object\\object.cpp:883)\n[11] SceneTree::_process_group (C:\\godot_source\\scene\\main\\scene_tree.cpp:1063)\n[12] SceneTree::_process (C:\\godot_source\\scene\\main\\scene_tree.cpp:1140)\n[13] SceneTree::process (C:\\godot_source\\scene\\main\\scene_tree.cpp:580)\n[14] Main::iteration (C:\\godot_source\\main\\main.cpp:4493)\n[15] ProgressDialog::_update_ui (C:\\godot_source\\editor\\progress_dialog.cpp:135)\n[16] ProgressDialog::task_step (C:\\godot_source\\editor\\progress_dialog.cpp:222)\n[17] EditorNode::progress_task_step (C:\\godot_source\\editor\\editor_node.cpp:4965)\n[18] EditorProgress::step (C:\\godot_source\\editor\\editor_node.cpp:180)\n[19] EditorFileSystem::reimport_files (C:\\godot_source\\editor\\editor_file_system.cpp:3118)\n[20] EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor\\editor_file_system.cpp:963)\n[21] EditorFileSystem::_refresh_filesystem (C:\\godot_source\\editor\\editor_file_system.cpp:3044)\n[22] call_with_variant_args_helper<EditorFileSystem> (C:\\godot_source\\core\\variant\\binder_common.h:320)\n[23] call_with_variant_args<EditorFileSystem> (C:\\godot_source\\core\\variant\\binder_common.h:430)\n[24] CallableCustomMethodPointer<EditorFileSystem,void>::call (C:\\godot_source\\core\\object\\callable_method_pointer.h:109)\n[25] Callable::callp (C:\\godot_source\\core\\variant\\callable.cpp:58)\n[26] Object::emit_signalp (C:\\godot_source\\core\\object\\object.cpp:1206)\n[27] Object::emit_signal<> (C:\\godot_source\\core\\object\\object.h:926)\n[28] SceneTree::process (C:\\godot_source\\scene\\main\\scene_tree.cpp:574)\n[29] Main::iteration (C:\\godot_source\\main\\main.cpp:4493)\n[30] OS_Windows::run (C:\\godot_source\\platform\\windows\\os_windows.cpp:2062)\n[31] widechar_main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:181)\n[32] _main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:206)\n[33] main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:220)\n[34] WinMain (C:\\godot_source\\platform\\windows\\godot_windows.cpp:234)\n[35] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[36] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n```\nAlternatively this error will appear:\n```\nERROR: Condition \"idx == -1\" is true. Continuing.\n   at: EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor/editor_file_system.cpp:899)\nERROR: Attempted to call reimport_files() recursively, this is not allowed.\n   at: (C:\\godot_source\\editor/editor_file_system.cpp:3055)\n```\n\n### Steps to reproduce\n\n1. Have any PNG file in your project\n2. Drag and drop it to another directory while holding Ctrl\n3. Either crash or error\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex b1156f61a3d9..e29d7424c5f3 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1959,18 +1959,12 @@ void FileSystemDock::_move_operation_confirm(const String &p_to_path, bool p_cop\n \t}\n \n \tif (p_copy) {\n-\t\tbool is_copied = false;\n \t\tfor (int i = 0; i < to_move.size(); i++) {\n \t\t\tif (to_move[i].path != new_paths[i]) {\n \t\t\t\t_try_duplicate_item(to_move[i], new_paths[i]);\n \t\t\t\tselect_after_scan = new_paths[i];\n-\t\t\t\tis_copied = true;\n \t\t\t}\n \t\t}\n-\n-\t\tif (is_copied) {\n-\t\t\t_rescan();\n-\t\t}\n \t} else {\n \t\t// Check groups.\n \t\tfor (int i = 0; i < to_move.size(); i++) {\n", "instance_id": "godotengine__godot-102260", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash or error occurs when duplicating a file using Ctrl+Drag and Drop in the Godot Engine editor on Windows 10. It provides specific steps to reproduce the issue, the affected versions, and a detailed backtrace of the crash, which helps in identifying the problematic areas in the codebase. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior after duplication (e.g., should the file be copied and immediately visible in the new location?). Additionally, it lacks clarity on specific edge cases beyond the basic reproduction steps (e.g., behavior with different file types, large files, or nested directories). While a minimal reproduction project (MRP) is marked as N/A, it would have been helpful to have a small test case or further context about the project structure. Overall, the statement is valid and mostly clear but misses some minor details that could aid in a more comprehensive understanding of the issue.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change is relatively small, as it involves modifying a specific part of the `filesystem_dock.cpp` file to address the crash or error during file duplication. The provided diff shows a targeted change\u2014removing a forced rescan after a copy operation\u2014which suggests the fix does not require extensive modifications across multiple files or a deep architectural overhaul. However, understanding the root cause requires familiarity with the Godot Engine's editor filesystem logic, particularly how file operations like duplication interact with the scanning and updating mechanisms (`_update_scan_actions`, `reimport_files`, etc.), as hinted by the backtrace and error messages. This involves moderate complexity in terms of technical concepts, such as understanding reference counting (`SafeNumeric`, `CowData`), string handling in C++, and the editor's event-driven notification system. Additionally, the problem hints at potential edge cases (e.g., recursive reimport calls, as seen in the error message), which may require careful handling to prevent further crashes or errors, though these are not extensively detailed in the statement. Overall, solving this issue requires a moderate understanding of the codebase and targeted debugging skills, but it does not appear to demand advanced domain-specific knowledge or extensive system-level changes, placing it in the 0.4-0.6 range with a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`print_verbose` makes build fail when `scu_build=yes`\n### Tested versions\n\n- 4.4.beta\n\n### System information\n\nWindows 11\n\n### Issue description\n\nThe `print_verbose` macro is causing one of the CI jobs that uses `scu_build=yes` to fail in my PR although I didn't modify the file calling it.\nhttps://github.com/godotengine/godot/actions/runs/12934119444/job/36074414239\n\nMy local build also fails when I use `scu_build=yes` but works fine otherwise.\n```sh\n[100%] godot\\core/debugger/remote_debugger_peer.cpp(172): error C3861: 'print_verbose': identifier not found\n```\n\nBy the way, it works if I replace it with `WARN_VERBOSE`.\n\n### Steps to reproduce\n\n- Checkout https://github.com/godotengine/godot/pull/100516\n- I changed calls to `print_verbose`  in `core/debugger/remote_debugger_peer.cpp` to `WARN_VERBOSE` to fix CI. Change it back to `print_verbose`. \n- Build it with `scons scu_build=yes`.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/core/variant/variant_utility.cpp b/core/variant/variant_utility.cpp\nindex ec9492ac5d1c..a53b5660d5a5 100644\n--- a/core/variant/variant_utility.cpp\n+++ b/core/variant/variant_utility.cpp\n@@ -999,9 +999,7 @@ void VariantUtilityFunctions::print_rich(const Variant **p_args, int p_arg_count\n \tr_error.error = Callable::CallError::CALL_OK;\n }\n \n-#undef print_verbose\n-\n-void VariantUtilityFunctions::print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error) {\n+void VariantUtilityFunctions::_print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error) {\n \tif (OS::get_singleton()->is_stdout_verbose()) {\n \t\tString s;\n \t\tfor (int i = 0; i < p_arg_count; i++) {\n@@ -1581,16 +1579,16 @@ static _FORCE_INLINE_ Variant::Type get_ret_type_helper(void (*p_func)(P...)) {\n \t};                                                                                                           \\\n \tregister_utility_function<Func_##m_func>(#m_func, m_args)\n \n-#define FUNCBINDVARARGV(m_func, m_args, m_category)                                                              \\\n+#define FUNCBINDVARARGV_CNAME(m_func, m_func_cname, m_args, m_category)                                          \\\n \tclass Func_##m_func {                                                                                        \\\n \tpublic:                                                                                                      \\\n \t\tstatic void call(Variant *r_ret, const Variant **p_args, int p_argcount, Callable::CallError &r_error) { \\\n \t\t\tr_error.error = Callable::CallError::CALL_OK;                                                        \\\n-\t\t\tVariantUtilityFunctions::m_func(p_args, p_argcount, r_error);                                        \\\n+\t\t\tVariantUtilityFunctions::m_func_cname(p_args, p_argcount, r_error);                                  \\\n \t\t}                                                                                                        \\\n \t\tstatic void validated_call(Variant *r_ret, const Variant **p_args, int p_argcount) {                     \\\n \t\t\tCallable::CallError c;                                                                               \\\n-\t\t\tVariantUtilityFunctions::m_func(p_args, p_argcount, c);                                              \\\n+\t\t\tVariantUtilityFunctions::m_func_cname(p_args, p_argcount, c);                                        \\\n \t\t}                                                                                                        \\\n \t\tstatic void ptrcall(void *ret, const void **p_args, int p_argcount) {                                    \\\n \t\t\tVector<Variant> args;                                                                                \\\n@@ -1625,6 +1623,8 @@ static _FORCE_INLINE_ Variant::Type get_ret_type_helper(void (*p_func)(P...)) {\n \t};                                                                                                           \\\n \tregister_utility_function<Func_##m_func>(#m_func, m_args)\n \n+#define FUNCBINDVARARGV(m_func, m_args, m_category) FUNCBINDVARARGV_CNAME(m_func, m_func, m_args, m_category)\n+\n #define FUNCBIND(m_func, m_args, m_category)                                                                     \\\n \tclass Func_##m_func {                                                                                        \\\n \tpublic:                                                                                                      \\\n@@ -1832,7 +1832,7 @@ void Variant::_register_variant_utility_functions() {\n \tFUNCBINDVARARGV(printt, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(prints, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(printraw, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n-\tFUNCBINDVARARGV(print_verbose, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n+\tFUNCBINDVARARGV_CNAME(print_verbose, _print_verbose, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(push_error, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(push_warning, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \ndiff --git a/core/variant/variant_utility.h b/core/variant/variant_utility.h\nindex 75cde4942b5f..a653369621a0 100644\n--- a/core/variant/variant_utility.h\n+++ b/core/variant/variant_utility.h\n@@ -133,8 +133,7 @@ struct VariantUtilityFunctions {\n \tstatic String type_string(Variant::Type p_type);\n \tstatic void print(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void print_rich(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n-#undef print_verbose\n-\tstatic void print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n+\tstatic void _print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void printerr(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void printt(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void prints(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n", "instance_id": "godotengine__godot-102062", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `print_verbose` macro causes a build failure when `scu_build=yes` is used, and the error message and affected file are provided. The steps to reproduce are also given, along with a reference to a specific GitHub PR and CI job failure. However, there are minor ambiguities and missing details. For instance, the problem statement does not explain why `print_verbose` fails under `scu_build=yes` (e.g., is it a macro definition issue, a build configuration conflict, or something else?). Additionally, there is no mention of specific constraints or requirements for the fix beyond replacing `print_verbose` with `WARN_VERBOSE` as a workaround. Edge cases or broader implications of the issue are not discussed. Overall, while the issue is understandable and actionable, it lacks deeper context or comprehensive details about the root cause or desired solution.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code changes are localized to two files (`variant_utility.cpp` and `variant_utility.h`) and involve renaming a function (`print_verbose` to `_print_verbose`) and updating macro definitions to handle the renaming. The changes are relatively small in terms of lines of code and do not appear to impact the broader system architecture. However, understanding the macro system (`FUNCBINDVARARGV` and its variants) and how it interacts with the build configuration (`scu_build=yes`) adds a slight layer of complexity.\n\n2. **Technical Concepts Involved:** Solving this issue requires familiarity with C++ macros, function binding mechanisms in the Godot engine (as seen in the `FUNCBINDVARARGV` macro), and build configuration options (`scu_build=yes`). While these concepts are not overly complex for an experienced C++ developer, they do require some domain-specific knowledge of the Godot engine's internals and build system, which elevates the difficulty slightly beyond a trivial fix.\n\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases or additional error handling requirements. The code changes provided also do not introduce new error handling logic. However, the developer must ensure that renaming `print_verbose` to `_print_verbose` does not break other parts of the codebase that might rely on the original name or macro, which introduces a minor risk of unintended side effects.\n\n4. **Overall Complexity:** The issue is a build failure caused by a naming or macro resolution problem, which is a common type of bug in large C++ projects. The fix involves straightforward renaming and macro adjustments, but it requires a basic understanding of the Godot engine's utility function registration system and build configurations. This places the difficulty slightly above a very easy task (e.g., fixing a typo) but still within the easy category due to the limited scope and moderate conceptual requirements.\n\nIn summary, I assign a difficulty score of 0.35, reflecting an easy problem that requires some understanding of the codebase and build system but does not involve complex logic, extensive changes, or significant architectural impact.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Closing game running in editor no longer sends NotificationWMCloseRequest - v4.4Beta1\n### Tested versions\n\n- Reproducible in 4.4Beta1 .NET\n- Not reproducible in 4.3 .NET\n\n### System information\n\nWindows 11 - Godot_v4.4-beta1_mono_win64\n\n### Issue description\n\nWhen closing the game while running it via the editor, a NotificationWMCloseRequest is no longer sent in 4.4.\n\n### Steps to reproduce\n\nSee minimal reproduction project\n\n### Minimal reproduction project (MRP)\n\nAttached is a simple 'save on exit' project that will demonstrate the issue.  When running the game in the editor interface in 4.3, the entire game state will be saved upon closing (and loaded when you next restart the game).  When running the game in the editor interface in 4.4, the game will no longer save because a NotificationWMCloseRequest is no longer sent when the game is closing.\n\nNote: The `StageManager` class is responsible for receiving the NotificationWMCloseRequest in this project.\n\n[BrackeysFirstSavedGame.zip](https://github.com/user-attachments/files/18483606/BrackeysFirstSavedGame.zip)\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex b1f7a8498a3a..f0f1a915f011 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -652,14 +652,20 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \tr_arguments.insert_after(N, itos(rect.size.x) + \"x\" + itos(rect.size.y));\n }\n \n-void GameView::_window_before_closing() {\n+void GameView::_window_close_request() {\n \t// Before the parent window closed, we close the embedded game. That prevents\n \t// the embedded game to be seen without a parent window for a fraction of second.\n \tif (EditorRunBar::get_singleton()->is_playing() && (embedded_process->is_embedding_completed() || embedded_process->is_embedding_in_progress())) {\n+\t\t// Try to gracefully close the window. That way, the NOTIFICATION_WM_CLOSE_REQUEST\n+\t\t// notification should be propagated in the game process.\n \t\tembedded_process->reset();\n-\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n-\t\t// actually closes.\n-\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\n+\t\t// When the embedding is not complete, we need to kill the process.\n+\t\tif (embedded_process->is_embedding_in_progress()) {\n+\t\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n+\t\t\t// actually closes.\n+\t\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\t\t}\n \t}\n }\n \n@@ -829,7 +835,8 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tp_debugger->connect(\"session_started\", callable_mp(this, &GameView::_sessions_changed));\n \tp_debugger->connect(\"session_stopped\", callable_mp(this, &GameView::_sessions_changed));\n \n-\tp_wrapper->connect(\"window_before_closing\", callable_mp(this, &GameView::_window_before_closing));\n+\tp_wrapper->set_override_close_request(true);\n+\tp_wrapper->connect(\"window_close_requested\", callable_mp(this, &GameView::_window_close_request));\n \tp_wrapper->connect(\"window_size_changed\", callable_mp(this, &GameView::_update_floating_window_settings));\n }\n \ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 959da73dcde8..273652dae821 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -162,7 +162,7 @@ class GameView : public VBoxContainer {\n \tvoid _camera_override_button_toggled(bool p_pressed);\n \tvoid _camera_override_menu_id_pressed(int p_id);\n \n-\tvoid _window_before_closing();\n+\tvoid _window_close_request();\n \tvoid _update_floating_window_settings();\n \tvoid _attach_script_debugger();\n \tvoid _detach_script_debugger();\ndiff --git a/editor/window_wrapper.cpp b/editor/window_wrapper.cpp\nindex 37a3efc91e90..22e2fda68567 100644\n--- a/editor/window_wrapper.cpp\n+++ b/editor/window_wrapper.cpp\n@@ -101,12 +101,6 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \n \tNode *parent = _get_wrapped_control_parent();\n \n-\t// In the GameView plugin, we need to the the signal before the window is actually closed\n-\t// to prevent the embedded game to be seen the parent window for a fraction of a second.\n-\tif (!p_visible) {\n-\t\temit_signal(\"window_before_closing\");\n-\t}\n-\n \tif (wrapped_control->get_parent() != parent) {\n \t\t// Move the control to the window.\n \t\twrapped_control->reparent(parent, false);\n@@ -120,7 +114,7 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \t}\n \n \twindow->set_visible(p_visible);\n-\tif (!p_visible) {\n+\tif (!p_visible && !override_close_request) {\n \t\temit_signal(\"window_close_requested\");\n \t}\n \temit_signal(\"window_visibility_changed\", p_visible);\n@@ -141,10 +135,17 @@ void WindowWrapper::_window_size_changed() {\n \temit_signal(SNAME(\"window_size_changed\"));\n }\n \n+void WindowWrapper::_window_close_request() {\n+\tif (override_close_request) {\n+\t\temit_signal(\"window_close_requested\");\n+\t} else {\n+\t\tset_window_enabled(false);\n+\t}\n+}\n+\n void WindowWrapper::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"window_visibility_changed\", PropertyInfo(Variant::BOOL, \"visible\")));\n \tADD_SIGNAL(MethodInfo(\"window_close_requested\"));\n-\tADD_SIGNAL(MethodInfo(\"window_before_closing\"));\n \tADD_SIGNAL(MethodInfo(\"window_size_changed\"));\n }\n \n@@ -330,6 +331,10 @@ void WindowWrapper::grab_window_focus() {\n \t}\n }\n \n+void WindowWrapper::set_override_close_request(bool p_enabled) {\n+\toverride_close_request = p_enabled;\n+}\n+\n WindowWrapper::WindowWrapper() {\n \tif (!EditorNode::get_singleton()->is_multi_window_enabled()) {\n \t\treturn;\n@@ -342,7 +347,7 @@ WindowWrapper::WindowWrapper() {\n \tadd_child(window);\n \twindow->hide();\n \n-\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::set_window_enabled).bind(false));\n+\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::_window_close_request));\n \twindow->connect(\"size_changed\", callable_mp(this, &WindowWrapper::_window_size_changed));\n \n \tShortcutBin *capturer = memnew(ShortcutBin);\ndiff --git a/editor/window_wrapper.h b/editor/window_wrapper.h\nindex 3f4e9385861c..e33c8c179d53 100644\n--- a/editor/window_wrapper.h\n+++ b/editor/window_wrapper.h\n@@ -50,12 +50,15 @@ class WindowWrapper : public MarginContainer {\n \n \tRef<Shortcut> enable_shortcut;\n \n+\tbool override_close_request = false;\n+\n \tRect2 _get_default_window_rect() const;\n \tNode *_get_wrapped_control_parent() const;\n \n \tvoid _set_window_enabled_with_rect(bool p_visible, const Rect2 p_rect);\n \tvoid _set_window_rect(const Rect2 p_rect);\n \tvoid _window_size_changed();\n+\tvoid _window_close_request();\n \n protected:\n \tstatic void _bind_methods();\n@@ -84,6 +87,8 @@ class WindowWrapper : public MarginContainer {\n \tvoid set_margins_enabled(bool p_enabled);\n \tvoid grab_window_focus();\n \n+\tvoid set_override_close_request(bool p_enabled);\n+\n \tWindowWrapper();\n \t~WindowWrapper();\n };\ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex b17f72dc5c04..b1945eb47a2e 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -5849,6 +5849,24 @@ Error DisplayServerX11::remove_embedded_process(OS::ProcessID p_pid) {\n \t}\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n+\n+\t// Handle bad window errors silently because just in case the embedded window was closed.\n+\tint (*oldHandler)(Display *, XErrorEvent *) = XSetErrorHandler(&bad_window_error_handler);\n+\n+\t// Send the message to gracefully close the window.\n+\tXEvent ev;\n+\tmemset(&ev, 0, sizeof(ev));\n+\tev.xclient.type = ClientMessage;\n+\tev.xclient.window = ep->process_window;\n+\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n+\tev.xclient.format = 32;\n+\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n+\tev.xclient.data.l[1] = CurrentTime;\n+\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\n+\t// Restore default error handler.\n+\tXSetErrorHandler(oldHandler);\n+\n \tembedded_processes.erase(p_pid);\n \tmemdelete(ep);\n \ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex ac7fa8b3c69e..1d3a6f0ca4f2 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -2975,6 +2975,9 @@ Error DisplayServerWindows::remove_embedded_process(OS::ProcessID p_pid) {\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n \n+\t// Send a close message to gracefully close the process.\n+\tPostMessage(ep->window_handle, WM_CLOSE, 0, 0);\n+\n \t// This is a workaround to ensure the parent window correctly regains focus after the\n \t// embedded window is closed. When the embedded window is closed while it has focus,\n \t// the parent window (the editor) does not become active. It appears focused but is not truly activated.\n", "instance_id": "godotengine__godot-101895", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `NotificationWMCloseRequest` is no longer sent when closing a game running in the editor in version 4.4Beta1 of Godot, compared to version 4.3. It provides context about the affected versions, system information, and a minimal reproduction project (MRP) to demonstrate the issue. The goal of fixing the missing notification is evident, and the steps to reproduce are referenced via the MRP. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior beyond \"sending the notification\" (e.g., under what exact conditions or configurations), nor does it mention potential edge cases or constraints (e.g., behavior in different operating systems beyond Windows 11). Additionally, while the MRP is provided, the problem statement lacks inline examples or detailed expected input/output behavior. Thus, while the issue is valid and mostly clear, it misses some minor but useful details for a fully comprehensive description.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`game_view_plugin.cpp`, `game_view_plugin.h`, `window_wrapper.cpp`, `window_wrapper.h`, `display_server_x11.cpp`, and `display_server_windows.cpp`), indicating a need to understand and modify interactions across different modules of the Godot engine. The changes involve not just simple bug fixes but a restructuring of how window close requests are handled, including introducing graceful shutdown mechanisms (e.g., sending `WM_CLOSE` messages on Windows or `WM_DELETE_WINDOW` on Linux). Second, the technical concepts required include knowledge of Godot's editor plugin architecture, window management in the engine, platform-specific APIs (Windows and X11), event handling, and process management for embedded games. These are moderately advanced topics, especially since they involve cross-platform considerations. Third, the problem requires handling edge cases, such as incomplete embedding states (`is_embedding_in_progress`), ensuring proper focus management after closing embedded windows, and gracefully propagating close requests without visual glitches. The code changes also impact core functionality (window closing behavior in the editor), which could have broader architectural implications if not handled carefully. While the problem does not reach \"Very Hard\" (0.8-1.0) due to the absence of extremely complex algorithms or system-level redesigns, it still demands a deep understanding of the codebase and careful implementation to avoid introducing new bugs. Hence, a score of 0.65 reflects the challenging nature of the task, balancing the complexity of multi-file changes, technical depth, and edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "TextureRect with ViewportTexture from SubViewport in SubViewportContainer crashes when switching back to scene tab.\n### Tested versions\n\n- Reproducible in v4.4-beta1.mono.official\n- Not reproducible in v4.3.stable.mono.official\n\n### System information\n\nGodot v4.4.beta1.mono - Ubuntu 24.04.1 LTS 24.04 on X11 - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 SUPER (nvidia; 550.120) - Intel(R) Core(TM) i7-14700KF (28 threads)\n\n### Issue description\n\nWhen a scene contains a `TextureRect`  inside of `CanvasLayer`, which has a `ViewportTexture` pointing to a `SubViewport` in a `SubViewportContainer`, the editor will crash when switching back to that scene tab.\n\nThis crash does not occur when `TextureRect` is not in a `CanvasLayer` or when `SubViewport` is not in a `SubViewportContainer`.\n\nA sample backtrace can be found below:\n\n```\n================================================================\nhandle_crash: Program crashed with signal 11\nEngine version: Godot Engine v4.4.beta1.mono.official (d33da79d3f8fe84be2521d25b9ba8e440cf25a88)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] /usr/lib/dotnet8/shared/Microsoft.NETCore.App/8.0.12/libcoreclr.so(+0x6068bc) [0x7ec4948068bc] (??:0)\n[2] /usr/lib/dotnet8/shared/Microsoft.NETCore.App/8.0.12/libcoreclr.so(+0x605ef5) [0x7ec494805ef5] (??:0)\n[3] /lib/x86_64-linux-gnu/libc.so.6(+0x45320) [0x7ec4cbe45320] (??:0)\n[4] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2945d4a] (??:0)\n[5] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2943eb9] (??:0)\n[6] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x294c182] (??:0)\n[7] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2a563dc] (??:0)\n[8] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2ac99e3] (??:0)\n[9] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x21180c1] (??:0)\n[10] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x477e0c8] (??:0)\n[11] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x28a284f] (??:0)\n[12] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x21180b7] (??:0)\n[13] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x477e0c8] (??:0)\n[14] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29336f6] (??:0)\n[15] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2933975] (??:0)\n[16] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2933975] (??:0)\n[17] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2934792] (??:0)\n[18] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2934a10] (??:0)\n[19] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x1950204] (??:0)\n[20] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x484291a] (??:0)\n[21] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x1cd37a6] (??:0)\n[22] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x484291a] (??:0)\n[23] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2cd0e0c] (??:0)\n[24] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2cd1bbe] (??:0)\n[25] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x294e07f] (??:0)\n[26] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29c4915] (??:0)\n[27] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29c5ab6] (??:0)\n[28] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29dc19c] (??:0)\n[29] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4f5510b] (??:0)\n[30] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4cf5ed] (??:0)\n[31] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x44a0843] (??:0)\n[32] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x44a2c2f] (??:0)\n[33] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4d8a83] (??:0)\n[34] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x41e313] (??:0)\n[35] /lib/x86_64-linux-gnu/libc.so.6(+0x2a1ca) [0x7ec4cbe2a1ca] (??:0)\n[36] /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x8b) [0x7ec4cbe2a28b] (??:0)\n[37] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x443faa] (??:0)\n-- END OF BACKTRACE --\n================================================================\n```\n\n### Steps to reproduce\n\n- Create a scene with the setup below, where the `ViewportTexture` in the `TextureRect` is pointing at `SubViewport`.\n- Open a new tab in the editor\n- Switch back to the scene containing the `TextureRect`\n\n![Image](https://github.com/user-attachments/assets/aa3adc29-9eda-498d-8762-c8be95f0e221)\n\n### Minimal reproduction project (MRP)\n\n[crashrepro.zip](https://github.com/user-attachments/files/18454471/crashrepro.zip)\n", "patch": "diff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex e9dfbd6189c1..76b2502bade3 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -126,7 +126,10 @@ int ViewportTexture::get_width() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn 0;\n \t}\n-\treturn get_size().width;\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size.width;\n+\t}\n+\treturn vp->size.width * vp->get_stretch_transform().get_scale().width;\n }\n \n int ViewportTexture::get_height() const {\n@@ -134,7 +137,10 @@ int ViewportTexture::get_height() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn 0;\n \t}\n-\treturn get_size().height;\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size.height;\n+\t}\n+\treturn vp->size.height * vp->get_stretch_transform().get_scale().height;\n }\n \n Size2 ViewportTexture::get_size() const {\n@@ -142,8 +148,11 @@ Size2 ViewportTexture::get_size() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn Size2();\n \t}\n-\tfloat scale = MIN(vp->get_screen_transform().get_scale().width, vp->get_screen_transform().get_scale().height);\n-\treturn Size2(vp->size.width * scale, vp->size.height * scale).ceil();\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size;\n+\t}\n+\tSize2 scale = vp->get_stretch_transform().get_scale();\n+\treturn Size2(vp->size.width * scale.width, vp->size.height * scale.height).ceil();\n }\n \n RID ViewportTexture::get_rid() const {\n", "instance_id": "godotengine__godot-101700", "clarity": 3, "difficulty": 0.65, "clarity_explanation": "The problem statement is comprehensive and well-documented. It clearly describes the issue: a crash in the Godot editor when switching scene tabs under a specific setup involving `TextureRect`, `ViewportTexture`, `SubViewport`, and `SubViewportContainer` within a `CanvasLayer`. The statement includes detailed system information, tested versions, steps to reproduce, a minimal reproduction project (MRP), and even a backtrace of the crash. The conditions under which the crash occurs and does not occur are explicitly mentioned, reducing ambiguity. Additionally, visual aids (an image) and a downloadable reproduction project further enhance clarity. There are no significant missing details regarding the problem's context or reproduction, making it a very clear and actionable issue report.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the clarity of the problem statement helps in understanding the issue, but solving it requires a deep understanding of the Godot engine's rendering and viewport system, which is a complex domain-specific area. The code changes provided are focused on a single file (`viewport.cpp`) and modify a specific part of the `ViewportTexture` class to handle size calculations differently for sub-viewports versus regular viewports, indicating a targeted fix. However, the impact of these changes is significant as they affect core rendering logic, which could have downstream effects on other parts of the engine (e.g., how textures are displayed or scaled in different contexts). \n\nThe technical concepts involved include understanding viewport hierarchies, texture rendering, and scaling transformations in a game engine context, which are non-trivial and require familiarity with Godot's internal architecture. While the code change itself is relatively small (a few lines adjusting size calculations), determining the root cause of the crash and ensuring the fix does not introduce regressions or break other features demands careful analysis and testing. Edge cases, such as different viewport configurations, stretch modes, or editor states, are not explicitly mentioned in the problem statement but are implied given the nature of the crash, adding to the complexity of validation. \n\nOverall, this problem requires a solid grasp of the codebase's rendering pipeline and cautious modification to avoid unintended side effects, placing it in the 0.6-0.8 range. I assign a score of 0.65 as it leans toward the lower end of \"Hard\" due to the focused nature of the code change, but still demands significant expertise to ensure correctness and stability.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4 dev7] Seperation Ray causes Mesh surface errors\n### Tested versions\n\n-reproducible in 4.4 Dev 7, mono version \n\n### System information\n\nGodot v4.4.dev7.mono - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1070 (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i5-7640X CPU @ 4.00GHz (4 threads)\n\n### Issue description\n\nThree errors are thrown when starting a scene with a CollisionShape3D with shape set to Seperation Ray.\n![Image](https://github.com/user-attachments/assets/8da0920f-c8db-420f-9ff6-c955df909800)\n\n\n### Steps to reproduce\n\nOpen the attached project. Run the main scene.\n\nAlternatively, run a scene with a CollisionShape3D, with the shape set to Seperation Ray.\n\n### Minimal reproduction project (MRP)\n\n[surface-error-example.zip](https://github.com/user-attachments/files/18215122/surface-error-example.zip)\n\n", "patch": "diff --git a/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp b/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\nindex 6db68f413ebd..db9a9bef04b2 100644\n--- a/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\n+++ b/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\n@@ -350,7 +350,7 @@ void CollisionShape3DGizmoPlugin::redraw(EditorNode3DGizmo *p_gizmo) {\n \n \tif (cs->get_debug_fill_enabled()) {\n \t\tRef<ArrayMesh> array_mesh = s->get_debug_arraymesh_faces(collision_color);\n-\t\tif (array_mesh.is_valid()) {\n+\t\tif (array_mesh.is_valid() && array_mesh->get_surface_count() > 0) {\n \t\t\tp_gizmo->add_mesh(array_mesh, material_arraymesh);\n \t\t}\n \t}\ndiff --git a/scene/resources/3d/shape_3d.cpp b/scene/resources/3d/shape_3d.cpp\nindex 63d424fb3724..4eae3ffeb2e5 100644\n--- a/scene/resources/3d/shape_3d.cpp\n+++ b/scene/resources/3d/shape_3d.cpp\n@@ -132,9 +132,12 @@ Ref<ArrayMesh> Shape3D::get_debug_mesh() {\n \t\tdebug_mesh_cache->surface_set_material(0, material);\n \n \t\tif (debug_fill) {\n-\t\t\tArray solid_array = get_debug_arraymesh_faces(debug_color * Color(1.0, 1.0, 1.0, 0.0625))->surface_get_arrays(0);\n-\t\t\tdebug_mesh_cache->add_surface_from_arrays(Mesh::PRIMITIVE_TRIANGLES, solid_array);\n-\t\t\tdebug_mesh_cache->surface_set_material(1, material);\n+\t\t\tRef<ArrayMesh> array_mesh = get_debug_arraymesh_faces(debug_color * Color(1.0, 1.0, 1.0, 0.0625));\n+\t\t\tif (array_mesh.is_valid() && array_mesh->get_surface_count() > 0) {\n+\t\t\t\tArray solid_array = array_mesh->surface_get_arrays(0);\n+\t\t\t\tdebug_mesh_cache->add_surface_from_arrays(Mesh::PRIMITIVE_TRIANGLES, solid_array);\n+\t\t\t\tdebug_mesh_cache->surface_set_material(1, material);\n+\t\t\t}\n \t\t}\n \t}\n \n", "instance_id": "godotengine__godot-101014", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: errors are thrown when starting a scene with a CollisionShape3D set to Separation Ray in Godot v4.4.dev7.mono. It provides system information, steps to reproduce, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities and missing details. The exact nature of the \"surface errors\" is not described in detail (e.g., what specific errors are thrown), and the problem statement does not explicitly mention the expected behavior or the root cause of the issue. Additionally, there are no mentions of specific edge cases or constraints that might need to be considered. While the attached image and reproduction project help, the textual description could be more comprehensive in defining the problem's scope and desired outcome.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are relatively localized, affecting two files (`collision_shape_3d_gizmo_plugin.cpp` and `shape_3d.cpp`) in the Godot engine codebase. The modifications are small, involving conditional checks to ensure that a mesh has valid surfaces before processing. There is no indication of widespread architectural impact or the need to modify multiple interconnected modules. The changes are straightforward and do not require deep refactoring.\n\n2. **Technical Concepts Involved:** Solving this issue requires a basic understanding of C++ (used in the Godot engine), specifically working with conditional logic and object validation. Familiarity with Godot's rendering and physics systems (e.g., `ArrayMesh`, `CollisionShape3D`) is necessary, but the concepts are not overly complex for someone with moderate experience in game engine development or C++. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic 3D graphics are required.\n\n3. **Edge Cases and Error Handling:** The code changes address a specific error condition\u2014ensuring that a mesh has valid surfaces before rendering or processing. While this implies handling an edge case (invalid or empty mesh surfaces), the solution is simple and does not involve intricate error-handling logic or performance considerations. The problem statement does not explicitly mention other edge cases to consider.\n\n4. **Overall Complexity:** The task involves understanding a small part of the codebase related to debug mesh rendering and gizmo plugins in Godot. The fix is essentially a guard clause to prevent errors when a mesh lacks surfaces, which is a common and straightforward bug-fixing pattern. There is no indication of needing to dive deeply into the broader architecture of the engine or handle complex interactions between systems.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires understanding some code logic and making simple modifications to prevent errors. It is slightly above the lower end of the range due to the need for familiarity with Godot's internal APIs and 3D graphics concepts, but it remains a relatively contained and manageable task for a developer with moderate experience.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Metal: Error compiling compute shader on iPhone A12\nWhen compiling the `particles.glsl` shader for an A12 or earlier device, it fails with the following error:\n\n```\nvalidateComputeFunctionArguments:1083: failed assertion `Compute Function(main0): argument src_particles[0] from buffer(4) with offset(0) and length(16) has space for 16 bytes, but argument has a length(128).'\n```\n\n> [!NOTE]\n>\n> Disabling API validation allows the app to run.\n\nThe issue is that when using classic binding (i.e. not argument buffers), the ABI for the shader passes the structures as arguments to the entry point:\n\n```metal\nstruct ParticleEmission\n{\n    float4x4 xform;\n    packed_float3 velocity;\n    uint flags;\n    float4 color;\n    float4 custom;\n};\n\nstruct SourceEmission\n{\n    int particle_count;\n    uint pad0;\n    uint pad1;\n    uint pad2;\n    ParticleEmission data[1];\n};\n\nkernel void main0(device SourceEmission& src_particles [[buffer(5)]], uint3 gl_GlobalInvocationID [[thread_position_in_grid]])\n{\n// ...\n```\n\nNote that the `src_particles` argument is a `struct SourceEmission`. Note again that this struct has an embedded type `struct ParticleEmission[1]`. Metal doesn't support unsized arrays, but SPRIV-Cross works around it by passing an embedded struct of size `1`. Interestingly, Metal is a variant of C++, and even Godot's definition has to use a sized array for the structure definition:\n\nhttps://github.com/godotengine/godot/blob/2450dee1bc1495daa2b7bdf06c7b3ddfbf8007e1/servers/rendering/renderer_rd/storage_rd/particles_storage.h#L157\n\nThe issue is that when Godot binds an empty emission buffer, it does not need to account for this, so it allocates a size 16:\n\nhttps://github.com/godotengine/godot/blob/d9ef826c545e7d623279c312ca837b947a4989b3/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp#L544\n\n_Originally posted by @TCROC in https://github.com/godotengine/godot/issues/99820#issuecomment-2558697999_\n            \n", "patch": "diff --git a/drivers/metal/metal_objects.mm b/drivers/metal/metal_objects.mm\nindex b44c496e4f6f..04900a0e5162 100644\n--- a/drivers/metal/metal_objects.mm\n+++ b/drivers/metal/metal_objects.mm\n@@ -56,6 +56,10 @@\n \n #import <os/signpost.h>\n \n+// We have to undefine these macros because they are defined in NSObjCRuntime.h.\n+#undef MIN\n+#undef MAX\n+\n void MDCommandBuffer::begin() {\n \tDEV_ASSERT(commandBuffer == nil);\n \tcommandBuffer = queue.commandBufferWithUnretainedReferences;\n@@ -764,6 +768,7 @@\n \t\t[render.encoder setVertexBuffers:render.vertex_buffers.ptr()\n \t\t\t\t\t\t\t\t offsets:render.vertex_offsets.ptr()\n \t\t\t\t\t\t\t   withRange:NSMakeRange(first, p_binding_count)];\n+\t\trender.dirty.clear_flag(RenderState::DIRTY_VERTEX);\n \t} else {\n \t\trender.dirty.set_flag(RenderState::DIRTY_VERTEX);\n \t}\n@@ -1082,7 +1087,7 @@\n \n \tUniformSet const &set = p_shader->sets[index];\n \n-\tfor (uint32_t i = 0; i < uniforms.size(); i++) {\n+\tfor (uint32_t i = 0; i < MIN(uniforms.size(), set.uniforms.size()); i++) {\n \t\tRDD::BoundUniform const &uniform = uniforms[i];\n \t\tUniformInfo ui = set.uniforms[i];\n \ndiff --git a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\nindex 7bd2d75c74a3..2ed4efd1572e 100644\n--- a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n@@ -541,13 +541,15 @@ void ParticlesStorage::_particles_allocate_emission_buffer(Particles *particles)\n \n void ParticlesStorage::_particles_ensure_unused_emission_buffer(Particles *particles) {\n \tif (particles->unused_emission_storage_buffer.is_null()) {\n-\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\t// For rendering devices that do not support empty arrays (like C++),\n+\t\t// we need to size the buffer with at least 1 element.\n+\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(ParticleEmissionBuffer));\n \t}\n }\n \n void ParticlesStorage::_particles_ensure_unused_trail_buffer(Particles *particles) {\n \tif (particles->unused_trail_storage_buffer.is_null()) {\n-\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(16 * sizeof(float)); // Size of mat4.\n \t}\n }\n \n", "instance_id": "godotengine__godot-100766", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: a compilation error occurs when compiling a compute shader on iPhone A12 or earlier devices due to a mismatch in buffer size allocation for a struct with an embedded array. The error message, relevant code snippets, and links to the Godot repository provide context about the root cause (Metal's handling of structs and buffer sizing). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or constraints for the fix (e.g., should the solution work for all Metal devices, or just A12 and earlier?). Additionally, edge cases such as varying struct sizes or zero-element buffers are not mentioned, which could impact the solution. While the issue is well-documented with references to specific lines of code, the lack of explicit requirements for the solution prevents it from being fully comprehensive.\n", "difficulty_explanation": "\nI rate this problem as hard with a difficulty score of 0.65 due to several factors. First, the scope of code changes involves multiple files (`metal_objects.mm` and `particles_storage.cpp`) in the Godot engine, a large and complex codebase. The modifications, while not extensive in terms of lines of code, require a deep understanding of Metal (Apple's graphics and compute API) and its interaction with shader compilation and buffer binding, which are advanced concepts. The changes also impact critical rendering logic, specifically particle emission buffers, which could have downstream effects on performance or behavior if not handled correctly. \n\nFrom a technical perspective, solving this requires knowledge of Metal's ABI (Application Binary Interface) for shaders, struct padding/alignment in C++ and Metal, and how SPIRV-Cross translates shaders. Additionally, the developer must understand Godot's rendering architecture to ensure the buffer sizing fix does not break other parts of the system. The problem also hints at potential edge cases, such as handling empty buffers or varying array sizes in structs, though these are not explicitly detailed. Error handling does not seem to be a major focus of the changes, but ensuring compatibility across different Metal devices adds complexity.\n\nOverall, this problem falls into the \"hard\" category (0.6-0.8) because it demands domain-specific knowledge of graphics programming and Metal, a nuanced understanding of the Godot engine's rendering pipeline, and careful modifications to avoid introducing new bugs. It is not \"very hard\" (0.8-1.0) as it does not involve system-level redesign or extremely intricate logic, but it is beyond medium difficulty due to the specialized knowledge and cross-file impact.\n", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.9, "human_difficulty_explanation": "Developers need to have a deep understanding of the detailed functions of the shader of the entire mobile operating system, which involves complex rendering logic functions."}
{"problem_statement": "Can't export project in self-contained mode\n### Tested versions\n\nRegression from #100150\n\n### System information\n\nW10\n\n### Issue description\n\nWhen using portable mode (the `._sc_` thing), exporting project results in:\n```\n  ERROR: Couldn't save project.binary at 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Can't open file from path 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Cannot remove non-existent file or directory: 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: C:\\godot_source\\editor\\export\\editor_export_platform.h:241 - Save ZIP: Failed to move temporary file \"C:/godot_source/bin/editor_data/temp/packtmp\" to \"C:/Program Files/Godot/BugReports/Repro/.export/project.zip\".\n```\nAlthough after further testing, seems like temp folder is missing for some reason and it's not created automatically. I didn't test if it's a problem in non-portable mode (it would happen with a clean Godot installation).\n\n### Steps to reproduce\n\n1. Enable [self-contained mode](https://docs.godotengine.org/en/stable/tutorials/io/data_paths.html#doc-data-paths-self-contained-mode)\n2. Export project\n3. The exported files are not created\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_paths.cpp b/editor/editor_paths.cpp\nindex 8e9df68f3b70..cd17559ac3dc 100644\n--- a/editor/editor_paths.cpp\n+++ b/editor/editor_paths.cpp\n@@ -237,6 +237,17 @@ EditorPaths::EditorPaths() {\n \t\t}\n \t}\n \n+\t// Temporary dir.\n+\t{\n+\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\tdir->make_dir_recursive(temp_dir);\n+\t\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\t\tERR_PRINT(\"Could not create editor temporary directory: \" + temp_dir);\n+\t\t\t\tpaths_valid = false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n \t// Validate or create project-specific editor data dir,\n \t// including shader cache subdir.\n \tif (Engine::get_singleton()->is_project_manager_hint() || (Main::is_cmdline_tool() && !ProjectSettings::get_singleton()->is_project_loaded())) {\n", "instance_id": "godotengine__godot-100510", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inability to export a project in self-contained mode due to missing temporary directories, resulting in specific error messages. It provides context about the environment (Windows 10), the steps to reproduce the issue, and the observed behavior. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, it does not explicitly clarify whether this issue is exclusive to self-contained mode or if it could occur in other configurations beyond a clean installation (as mentioned but not tested). Additionally, there are no explicit mentions of expected behavior beyond \"exported files are not created,\" nor are there detailed constraints or edge cases provided in the description. The lack of a minimal reproduction project (MRP) also slightly hampers clarity for someone trying to replicate the issue from scratch. Overall, while the problem goal is understandable, these minor gaps in detail result in a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is localized to a single file (`editor_paths.cpp`) and involves a small, focused modification of adding logic to create a temporary directory if it does not exist. The change does not impact multiple modules or the broader system architecture, nor does it require extensive refactoring. The amount of code change is minimal, consisting of just a few lines to handle directory creation and error logging.\n\n2. **Number of Technical Concepts:** The solution requires basic understanding of file system operations in C++ (e.g., directory creation and navigation using the `dir` object) and error handling (printing error messages). No advanced language features, complex algorithms, design patterns, or domain-specific knowledge are necessary. The concepts involved are straightforward for anyone with basic C++ experience.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention specific edge cases beyond the missing temporary directory. The code change addresses the primary issue by ensuring the directory is created, and includes basic error handling if the directory creation or navigation fails. However, potential edge cases like permission issues, disk space constraints, or concurrent access to the directory are not addressed in the problem statement or code change, and they do not seem critical to the immediate fix. The error handling added is minimal and not complex.\n\n4. **Overall Complexity:** The fix is a simple bug resolution that does not require deep understanding of the Godot engine's codebase beyond the specific `EditorPaths` class. It does not involve intricate logic, performance considerations, or interactions with other parts of the system beyond the file system operations.\n\nGiven these factors, a difficulty score of 0.25 is appropriate. It reflects an easy problem that requires understanding a small piece of code logic and making a simple modification to handle a specific failure condition. It is slightly above the \"Very Easy\" range due to the need to understand the context of directory paths in the editor's initialization process, but it remains a straightforward task for a developer with moderate experience in C++.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Godot will throw errors infinitely when Windows audio driver was once used by another app\n### Tested versions\n\nGodot 4.3 Stable\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\nWhen another app (like audio or video editing software) uses Windows Audio system, Godot begin to throw errors and will not stop until it will be fully closed and reopened. Even if another app is already closed and is no longer using the driver.\n\n![Image](https://github.com/user-attachments/assets/14b78097-b33d-454a-8e61-bd50e776841b)\n\n\n### Steps to reproduce\n\nOpen Godot\nOpen Vegas Pro or other video editing app at the same time\n\n### Minimal reproduction project (MRP)\n\nN/A (and not required)\n", "patch": "diff --git a/drivers/wasapi/audio_driver_wasapi.cpp b/drivers/wasapi/audio_driver_wasapi.cpp\nindex b5cb8da249af..7d5680699f41 100644\n--- a/drivers/wasapi/audio_driver_wasapi.cpp\n+++ b/drivers/wasapi/audio_driver_wasapi.cpp\n@@ -123,6 +123,8 @@ const IID IID_IAudioCaptureClient = __uuidof(IAudioCaptureClient);\n \n static bool default_output_device_changed = false;\n static bool default_input_device_changed = false;\n+static int output_reinit_countdown = 0;\n+static int input_reinit_countdown = 0;\n \n // Silence warning due to a COM API weirdness (GH-35194).\n #if defined(__GNUC__) && !defined(__clang__)\n@@ -134,6 +136,8 @@ class CMMNotificationClient : public IMMNotificationClient {\n \tLONG _cRef = 1;\n \n public:\n+\tComPtr<IMMDeviceEnumerator> enumerator = nullptr;\n+\n \tCMMNotificationClient() {}\n \tvirtual ~CMMNotificationClient() {}\n \n@@ -199,6 +203,9 @@ class CMMNotificationClient : public IMMNotificationClient {\n static CMMNotificationClient notif_client;\n \n Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_input, bool p_reinit, bool p_no_audio_client_3) {\n+\t// This function can be called recursively, so clean up before starting:\n+\taudio_device_finish(p_device);\n+\n \tWAVEFORMATEX *pwfex;\n \tComPtr<IMMDeviceEnumerator> enumerator = nullptr;\n \tComPtr<IMMDevice> output_device = nullptr;\n@@ -225,21 +232,25 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tComPtr<IMMDevice> tmp_device = nullptr;\n \n \t\t\thr = devices->Item(i, &tmp_device);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot get devices item.\");\n \n \t\t\tComPtr<IPropertyStore> props = nullptr;\n \t\t\thr = tmp_device->OpenPropertyStore(STGM_READ, &props);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot open property store.\");\n \n \t\t\tPROPVARIANT propvar;\n \t\t\tPropVariantInit(&propvar);\n \n \t\t\thr = props->GetValue(PKEY_Device_FriendlyNameGodot, &propvar);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot get value.\");\n \n \t\t\tif (p_device->device_name == String(propvar.pwszVal)) {\n \t\t\t\thr = tmp_device->GetId(&strId);\n-\t\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\t\tif (unlikely(hr != S_OK)) {\n+\t\t\t\t\tPropVariantClear(&propvar);\n+\t\t\t\t\tERR_PRINT(\"Cannot get device ID string.\");\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \n \t\t\t\tfound = true;\n \t\t\t}\n@@ -270,9 +281,14 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n \t}\n \n+\tif (notif_client.enumerator != nullptr) {\n+\t\tnotif_client.enumerator->UnregisterEndpointNotificationCallback(&notif_client);\n+\t\tnotif_client.enumerator = nullptr;\n+\t}\n \thr = enumerator->RegisterEndpointNotificationCallback(&notif_client);\n-\n-\tif (hr != S_OK) {\n+\tif (hr == S_OK) {\n+\t\tnotif_client.enumerator = enumerator;\n+\t} else {\n \t\tERR_PRINT(\"WASAPI: RegisterEndpointNotificationCallback error\");\n \t}\n \n@@ -317,6 +333,7 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \n \thr = p_device->audio_client->GetMixFormat(&pwfex);\n \tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\t// From this point onward, CoTaskMemFree(pwfex) must be called before returning or pwfex will leak!\n \n \tprint_verbose(\"WASAPI: wFormatTag = \" + itos(pwfex->wFormatTag));\n \tprint_verbose(\"WASAPI: nChannels = \" + itos(pwfex->nChannels));\n@@ -340,6 +357,7 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tprint_verbose(\"WASAPI: closest->cbSize = \" + itos(closest->cbSize));\n \n \t\t\tWARN_PRINT(\"WASAPI: Using closest match instead\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tpwfex = closest;\n \t\t}\n \t}\n@@ -359,11 +377,13 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tp_device->format_tag = WAVE_FORMAT_IEEE_FLOAT;\n \t\t} else {\n \t\t\tERR_PRINT(\"WASAPI: Format not supported\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n \t\t}\n \t} else {\n \t\tif (p_device->format_tag != WAVE_FORMAT_PCM && p_device->format_tag != WAVE_FORMAT_IEEE_FLOAT) {\n \t\t\tERR_PRINT(\"WASAPI: Format not supported\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n \t\t}\n \t}\n@@ -376,10 +396,28 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tpwfex->nAvgBytesPerSec = pwfex->nSamplesPerSec * pwfex->nChannels * (pwfex->wBitsPerSample / 8);\n \t\t}\n \t\thr = p_device->audio_client->Initialize(AUDCLNT_SHAREMODE_SHARED, streamflags, p_input ? REFTIMES_PER_SEC : 0, 0, pwfex, nullptr);\n-\t\tERR_FAIL_COND_V_MSG(hr != S_OK, ERR_CANT_OPEN, \"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\n+\t\tif (p_reinit) {\n+\t\t\t// In case we're trying to re-initialize the device, prevent throwing this error on the console,\n+\t\t\t// otherwise if there is currently no device available this will spam the console.\n+\t\t\tif (hr != S_OK) {\n+\t\t\t\tprint_verbose(\"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\t\t\t\tCoTaskMemFree(pwfex);\n+\t\t\t\treturn ERR_CANT_OPEN;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tif (unlikely(hr != S_OK)) {\n+\t\t\t\tCoTaskMemFree(pwfex);\n+\t\t\t\tERR_FAIL_V_MSG(ERR_CANT_OPEN, \"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\t\t\t}\n+\t\t}\n+\n \t\tUINT32 max_frames;\n \t\thr = p_device->audio_client->GetBufferSize(&max_frames);\n-\t\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\t\tif (unlikely(hr != S_OK)) {\n+\t\t\tCoTaskMemFree(pwfex);\n+\t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n+\t\t}\n \n \t\t// Due to WASAPI Shared Mode we have no control of the buffer size\n \t\tif (!p_input) {\n@@ -453,7 +491,10 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t} else {\n \t\thr = p_device->audio_client->GetService(IID_IAudioRenderClient, (void **)&p_device->render_client);\n \t}\n-\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\tif (unlikely(hr != S_OK)) {\n+\t\tCoTaskMemFree(pwfex);\n+\t\tERR_FAIL_V(ERR_CANT_OPEN);\n+\t}\n \n \t// Free memory\n \tCoTaskMemFree(pwfex);\n@@ -464,6 +505,11 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n Error AudioDriverWASAPI::init_output_device(bool p_reinit) {\n \tError err = audio_device_init(&audio_output, false, p_reinit);\n \tif (err != OK) {\n+\t\t// We've tried to init the device, but have failed. Time to clean up.\n+\t\tError finish_err = finish_output_device();\n+\t\tif (finish_err != OK) {\n+\t\t\tERR_PRINT(\"WASAPI: finish_output_device error after failed output audio_device_init\");\n+\t\t}\n \t\treturn err;\n \t}\n \n@@ -504,6 +550,11 @@ Error AudioDriverWASAPI::init_output_device(bool p_reinit) {\n Error AudioDriverWASAPI::init_input_device(bool p_reinit) {\n \tError err = audio_device_init(&audio_input, true, p_reinit);\n \tif (err != OK) {\n+\t\t// We've tried to init the device, but have failed. Time to clean up.\n+\t\tError finish_err = finish_input_device();\n+\t\tif (finish_err != OK) {\n+\t\t\tERR_PRINT(\"WASAPI: finish_input_device error after failed input audio_device_init\");\n+\t\t}\n \t\treturn err;\n \t}\n \n@@ -826,9 +877,15 @@ void AudioDriverWASAPI::thread_func(void *p_udata) {\n \t\t}\n \n \t\tif (!ad->audio_output.audio_client) {\n-\t\t\tError err = ad->init_output_device(true);\n-\t\t\tif (err == OK) {\n-\t\t\t\tad->start();\n+\t\t\tif (output_reinit_countdown < 1) {\n+\t\t\t\tError err = ad->init_output_device(true);\n+\t\t\t\tif (err == OK) {\n+\t\t\t\t\tad->start();\n+\t\t\t\t} else {\n+\t\t\t\t\toutput_reinit_countdown = 1000;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\toutput_reinit_countdown--;\n \t\t\t}\n \n \t\t\tavail_frames = 0;\n@@ -899,9 +956,15 @@ void AudioDriverWASAPI::thread_func(void *p_udata) {\n \t\t\t}\n \n \t\t\tif (!ad->audio_input.audio_client) {\n-\t\t\t\tError err = ad->init_input_device(true);\n-\t\t\t\tif (err == OK) {\n-\t\t\t\t\tad->input_start();\n+\t\t\t\tif (input_reinit_countdown < 1) {\n+\t\t\t\t\tError err = ad->init_input_device(true);\n+\t\t\t\t\tif (err == OK) {\n+\t\t\t\t\t\tad->input_start();\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tinput_reinit_countdown = 1000;\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tinput_reinit_countdown--;\n \t\t\t\t}\n \t\t\t}\n \t\t}\n", "instance_id": "godotengine__godot-100116", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Godot throws infinite errors when the Windows audio driver is used by another application, and the errors persist even after the other application is closed. The description includes the tested version (Godot 4.3 Stable), system information (Windows 10 x64), and steps to reproduce the issue, which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the exact nature of the errors (error messages or logs) is not provided beyond a reference to an image, which is inaccessible in this text format. Additionally, there are no specific requirements or expectations for the solution (e.g., desired behavior after the fix), and edge cases or constraints are not explicitly mentioned. While the issue is valid and reproducible, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant but localized to a single file (`audio_driver_wasapi.cpp`), involving modifications to the WASAPI audio driver implementation in Godot. The changes span multiple functions and introduce new logic for reinitialization countdowns and error handling, indicating a moderate amount of code change (around 100+ lines modified). Second, the technical concepts required are complex, including deep knowledge of the Windows Audio Session API (WASAPI), COM programming (e.g., handling `ComPtr`, `IMMDeviceEnumerator`, and error codes like `HRESULT`), and audio driver initialization logic. Understanding the interaction between Godot's audio system and Windows audio drivers is crucial, as is familiarity with the specific error conditions that arise from shared audio resources. Third, the problem involves handling edge cases, such as repeated initialization failures and resource cleanup to prevent memory leaks (e.g., ensuring `CoTaskMemFree` is called appropriately), which adds to the complexity. Finally, while the changes do not impact the broader system architecture, they require a nuanced understanding of the audio driver's behavior under concurrent access by multiple applications, as well as careful error handling to avoid spamming logs or causing further instability. A score of 0.75 reflects the need for specialized knowledge of Windows audio APIs and the intricate error recovery logic required, placing it on the higher end of the \"Hard\" range but not quite at \"Very Hard\" since it does not involve system-wide refactoring or advanced domain-specific algorithms.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13\n### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/random.cpp b/src/random.cpp\nindex 5b605e988d0c5..6acbbcc210a15 100644\n--- a/src/random.cpp\n+++ b/src/random.cpp\n@@ -192,11 +192,13 @@ uint64_t GetRdSeed() noexcept\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n \n bool g_rndr_supported = false;\n+bool g_rndrrs_supported = false;\n \n void InitHardwareRand()\n {\n     if (getauxval(AT_HWCAP2) & HWCAP2_RNG) {\n         g_rndr_supported = true;\n+        g_rndrrs_supported = VerifyRNDRRS();\n     }\n }\n \n@@ -204,8 +206,10 @@ void ReportHardwareRand()\n {\n     // This must be done in a separate function, as InitHardwareRand() may be indirectly called\n     // from global constructors, before logging is initialized.\n-    if (g_rndr_supported) {\n+    if (g_rndr_supported && g_rndrrs_supported) {\n         LogPrintf(\"Using RNDR and RNDRRS as additional entropy sources\\n\");\n+    } else if (g_rndr_supported) {\n+        LogPrintf(\"Using RNDR as an additional entropy source\\n\");\n     }\n }\n \n@@ -227,24 +231,43 @@ uint64_t GetRNDR() noexcept\n     return r1;\n }\n \n-/** Read 64 bits of entropy using rndrrs.\n- *\n+// Helper function to retrieve random value using RNDRRS\n+bool GetRNDRRSInternal(uint64_t &r1) noexcept\n+{\n+    uint8_t ok = 0;\n+    __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n+                     : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n+    return ok != 0;\n+}\n+\n+\n+/** Read 64 bits of entropy using RNDRRS.\n  * Must only be called when RNDRRS is supported.\n  */\n uint64_t GetRNDRRS() noexcept\n {\n-    uint8_t ok = 0;\n     uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n+    while (!GetRNDRRSInternal(r1)) {\n         __asm__ volatile(\"yield\");\n-    } while (true);\n+    }\n     return r1;\n }\n \n+/** Verify if RNDRRS is supported and functional.\n+ * Return true if it works within the retry limit.\n+ */\n+bool VerifyRNDRRS() noexcept\n+{\n+    uint64_t test;\n+    for (int retry = 0; retry < 10; ++retry) {\n+        if (GetRNDRRSInternal(test)) {\n+            return true;\n+        }\n+        __asm__ volatile(\"yield\");\n+    }\n+    return false;\n+}\n+\n #else\n /* Access to other hardware random number generators could be added here later,\n  * assuming it is sufficiently fast (in the order of a few hundred CPU cycles).\n@@ -295,7 +318,7 @@ void SeedHardwareSlow(CSHA512& hasher) noexcept {\n         return;\n     }\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n+    if (g_rndrrs_supported) {\n         for (int i = 0; i < 4; ++i) {\n             uint64_t out = GetRNDRRS();\n             hasher.Write((const unsigned char*)&out, sizeof(out));\n", "instance_id": "bitcoin__bitcoin-31826", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: `GetRandBytes()` hangs on specific Android devices (Samsung Galaxy S25 and OnePlus 13) due to an infinite loop in `GetRNDRRS()`. It provides context about the environment (Android 15, specific hardware), the affected function, and the expected behavior (returning entropy without hanging). Steps to reproduce are included, and relevant code snippets are provided. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether this issue occurs consistently or intermittently, nor does it provide detailed logs or debugging output to pinpoint the root cause (e.g., whether the hardware instruction itself fails or if there are other environmental factors). Additionally, edge cases or specific conditions under which the hang occurs are not specified. Overall, while the goal and issue are clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" range due to several factors. First, the clarity and complexity of the problem require understanding low-level hardware interactions (specifically, ARM architecture's RNDRRS instruction for random number generation), which is a niche and advanced topic. The code changes, while localized to a single file (`random.cpp`), involve non-trivial modifications, including adding a verification mechanism for RNDRRS support and adjusting the logic to prevent infinite loops. This requires knowledge of inline assembly, hardware capability flags (e.g., `HWCAP2_RNG`), and the Android NDK build environment.\n\nSecond, the scope of changes, though limited to one file, impacts a critical component of the system (random number generation for cryptographic operations in Bitcoin Core), necessitating careful consideration of security and reliability. The changes also require understanding the interaction between hardware entropy sources and the software stack, which adds to the depth of the problem.\n\nThird, the number of technical concepts involved is significant: inline assembly for ARM, hardware entropy sources (RNDR and RNDRRS), Android-specific hardware behavior, and error handling for hardware failures. These concepts are moderately to highly complex, especially for developers without experience in low-level programming or hardware interactions.\n\nFinally, potential edge cases and error handling are critical here. The problem statement does not explicitly mention edge cases, but the code changes introduce a retry limit to prevent infinite loops, indicating an awareness of hardware failure scenarios. Handling such cases (e.g., fallback mechanisms if RNDRRS consistently fails) adds complexity, as does ensuring that the entropy source remains secure and reliable across different devices and Android versions.\n\nOverall, this problem requires a deep understanding of both the codebase and hardware-specific behavior, along with careful handling of critical system functionality, justifying a difficulty score of 0.65. It is not in the \"Very Hard\" range because the changes are localized and do not involve a complete architectural overhaul or advanced algorithmic design.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.9, "human_difficulty_explanation": "Experience with low-level programming or hardware interaction is required."}
{"problem_statement": "28.0rc1 synchronizes much slower on Windows\nBitcoin Core 28.0rc1 (both pre-built and self-built binary) on Windows 10 synchronizes much slower than 27.0 after around block 120,000 when blocks stop being almost empty. I'm running with default settings (dbcache=450, pruning disabled).\r\n\r\nTime to synchronize to block 300,000: (measured around 10 runs each, alternating between the versions)\r\n27.0: **695 seconds**\r\n28.0rc1: **2760 seconds**\r\n\r\n![28.0rc1](https://github.com/user-attachments/assets/060a1e18-7f97-4e86-9ba8-5bf867b3510e)\r\n\r\nRunning the Linux pre-built binary in WSL doesn't show the slowdown, so it's probably limited to Windows.\r\n\r\n~~I'm going to bisect this, but that will definitely take me a while. If anyone suspects a commit/PR that I should look at first that might help.~~ I've bisected this down to #28052, for more details see https://github.com/bitcoin/bitcoin/issues/30833#issuecomment-2335184072.\n", "patch": "diff --git a/src/addrdb.cpp b/src/addrdb.cpp\nindex e9838d722291e..b89141c88e324 100644\n--- a/src/addrdb.cpp\n+++ b/src/addrdb.cpp\n@@ -73,7 +73,7 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n         remove(pathTmp);\n         return false;\n     }\n-    if (!FileCommit(fileout.Get())) {\n+    if (!fileout.Commit()) {\n         fileout.fclose();\n         remove(pathTmp);\n         LogError(\"%s: Failed to flush file %s\\n\", __func__, fs::PathToString(pathTmp));\ndiff --git a/src/bench/streams_findbyte.cpp b/src/bench/streams_findbyte.cpp\nindex 5098262e9afa6..004bf8ffc9dc7 100644\n--- a/src/bench/streams_findbyte.cpp\n+++ b/src/bench/streams_findbyte.cpp\n@@ -19,7 +19,7 @@ static void FindByte(benchmark::Bench& bench)\n     uint8_t data[file_size] = {0};\n     data[file_size-1] = 1;\n     file << data;\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n     BufferedFile bf{file, /*nBufSize=*/file_size + 1, /*nRewindIn=*/file_size};\n \n     bench.run([&] {\ndiff --git a/src/index/blockfilterindex.cpp b/src/index/blockfilterindex.cpp\nindex 41bdca9df562a..26de7eee32fc0 100644\n--- a/src/index/blockfilterindex.cpp\n+++ b/src/index/blockfilterindex.cpp\n@@ -151,7 +151,7 @@ bool BlockFilterIndex::CustomCommit(CDBBatch& batch)\n         LogError(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n-    if (!FileCommit(file.Get())) {\n+    if (!file.Commit()) {\n         LogError(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n@@ -201,11 +201,11 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n             LogPrintf(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!TruncateFile(last_file.Get(), pos.nPos)) {\n+        if (!last_file.Truncate(pos.nPos)) {\n             LogPrintf(\"%s: Failed to truncate filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!FileCommit(last_file.Get())) {\n+        if (!last_file.Commit()) {\n             LogPrintf(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\ndiff --git a/src/index/txindex.cpp b/src/index/txindex.cpp\nindex 80f615ed0e77b..425a7f00a0d08 100644\n--- a/src/index/txindex.cpp\n+++ b/src/index/txindex.cpp\n@@ -87,10 +87,7 @@ bool TxIndex::FindTx(const uint256& tx_hash, uint256& block_hash, CTransactionRe\n     CBlockHeader header;\n     try {\n         file >> header;\n-        if (fseek(file.Get(), postx.nTxOffset, SEEK_CUR)) {\n-            LogError(\"%s: fseek(...) failed\\n\", __func__);\n-            return false;\n-        }\n+        file.seek(postx.nTxOffset, SEEK_CUR);\n         file >> TX_WITH_WITNESS(tx);\n     } catch (const std::exception& e) {\n         LogError(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\nindex b40ca0260beee..44c2808c3bd46 100644\n--- a/src/node/blockstorage.cpp\n+++ b/src/node/blockstorage.cpp\n@@ -683,7 +683,7 @@ bool BlockManager::UndoWriteToDisk(const CBlockUndo& blockundo, FlatFilePos& pos\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write undo data\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\n@@ -981,7 +981,7 @@ bool BlockManager::WriteBlockToDisk(const CBlock& block, FlatFilePos& pos) const\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write block\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\ndiff --git a/src/node/mempool_persist.cpp b/src/node/mempool_persist.cpp\nindex a265c2e12d15a..ff7de8c64a259 100644\n--- a/src/node/mempool_persist.cpp\n+++ b/src/node/mempool_persist.cpp\n@@ -199,8 +199,8 @@ bool DumpMempool(const CTxMemPool& pool, const fs::path& dump_path, FopenFn mock\n         LogInfo(\"Writing %d unbroadcast transactions to file.\\n\", unbroadcast_txids.size());\n         file << unbroadcast_txids;\n \n-        if (!skip_file_commit && !FileCommit(file.Get()))\n-            throw std::runtime_error(\"FileCommit failed\");\n+        if (!skip_file_commit && !file.Commit())\n+            throw std::runtime_error(\"Commit failed\");\n         file.fclose();\n         if (!RenameOver(dump_path + \".new\", dump_path)) {\n             throw std::runtime_error(\"Rename failed\");\ndiff --git a/src/node/utxo_snapshot.cpp b/src/node/utxo_snapshot.cpp\nindex 976421e455391..7d589c886b824 100644\n--- a/src/node/utxo_snapshot.cpp\n+++ b/src/node/utxo_snapshot.cpp\n@@ -73,9 +73,11 @@ std::optional<uint256> ReadSnapshotBaseBlockhash(fs::path chaindir)\n     }\n     afile >> base_blockhash;\n \n-    if (std::fgetc(afile.Get()) != EOF) {\n+    int64_t position = afile.tell();\n+    afile.seek(0, SEEK_END);\n+    if (position != afile.tell()) {\n         LogPrintf(\"[snapshot] warning: unexpected trailing data in %s\\n\", read_from_str);\n-    } else if (std::ferror(afile.Get())) {\n+    } else if (afile.IsError()) {\n         LogPrintf(\"[snapshot] warning: i/o error reading %s\\n\", read_from_str);\n     }\n     return base_blockhash;\ndiff --git a/src/streams.cpp b/src/streams.cpp\nindex cdd36a86feb17..5f7baf92b9e8e 100644\n--- a/src/streams.cpp\n+++ b/src/streams.cpp\n@@ -4,21 +4,29 @@\n \n #include <span.h>\n #include <streams.h>\n+#include <util/fs_helpers.h>\n \n #include <array>\n \n+AutoFile::AutoFile(std::FILE* file, std::vector<std::byte> data_xor)\n+    : m_file{file}, m_xor{std::move(data_xor)}\n+{\n+    if (!IsNull()) {\n+        auto pos{std::ftell(m_file)};\n+        if (pos >= 0) m_position = pos;\n+    }\n+}\n+\n std::size_t AutoFile::detail_fread(Span<std::byte> dst)\n {\n     if (!m_file) throw std::ios_base::failure(\"AutoFile::read: file handle is nullptr\");\n-    if (m_xor.empty()) {\n-        return std::fread(dst.data(), 1, dst.size(), m_file);\n-    } else {\n-        const auto init_pos{std::ftell(m_file)};\n-        if (init_pos < 0) throw std::ios_base::failure(\"AutoFile::read: ftell failed\");\n-        std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n-        util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n-        return ret;\n+    size_t ret = std::fread(dst.data(), 1, dst.size(), m_file);\n+    if (!m_xor.empty()) {\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::read: position unknown\");\n+        util::Xor(dst.subspan(0, ret), m_xor, *m_position);\n     }\n+    if (m_position.has_value()) *m_position += ret;\n+    return ret;\n }\n \n void AutoFile::seek(int64_t offset, int origin)\n@@ -29,18 +37,23 @@ void AutoFile::seek(int64_t offset, int origin)\n     if (std::fseek(m_file, offset, origin) != 0) {\n         throw std::ios_base::failure(feof() ? \"AutoFile::seek: end of file\" : \"AutoFile::seek: fseek failed\");\n     }\n+    if (origin == SEEK_SET) {\n+        m_position = offset;\n+    } else if (origin == SEEK_CUR && m_position.has_value()) {\n+        *m_position += offset;\n+    } else {\n+        int64_t r{std::ftell(m_file)};\n+        if (r < 0) {\n+            throw std::ios_base::failure(\"AutoFile::seek: ftell failed\");\n+        }\n+        m_position = r;\n+    }\n }\n \n int64_t AutoFile::tell()\n {\n-    if (IsNull()) {\n-        throw std::ios_base::failure(\"AutoFile::tell: file handle is nullptr\");\n-    }\n-    int64_t r{std::ftell(m_file)};\n-    if (r < 0) {\n-        throw std::ios_base::failure(\"AutoFile::tell: ftell failed\");\n-    }\n-    return r;\n+    if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::tell: position unknown\");\n+    return *m_position;\n }\n \n void AutoFile::read(Span<std::byte> dst)\n@@ -60,6 +73,7 @@ void AutoFile::ignore(size_t nSize)\n             throw std::ios_base::failure(feof() ? \"AutoFile::ignore: end of file\" : \"AutoFile::ignore: fread failed\");\n         }\n         nSize -= nNow;\n+        if (m_position.has_value()) *m_position += nNow;\n     }\n }\n \n@@ -70,19 +84,34 @@ void AutoFile::write(Span<const std::byte> src)\n         if (std::fwrite(src.data(), 1, src.size(), m_file) != src.size()) {\n             throw std::ios_base::failure(\"AutoFile::write: write failed\");\n         }\n+        if (m_position.has_value()) *m_position += src.size();\n     } else {\n-        auto current_pos{std::ftell(m_file)};\n-        if (current_pos < 0) throw std::ios_base::failure(\"AutoFile::write: ftell failed\");\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::write: position unknown\");\n         std::array<std::byte, 4096> buf;\n         while (src.size() > 0) {\n             auto buf_now{Span{buf}.first(std::min<size_t>(src.size(), buf.size()))};\n             std::copy(src.begin(), src.begin() + buf_now.size(), buf_now.begin());\n-            util::Xor(buf_now, m_xor, current_pos);\n+            util::Xor(buf_now, m_xor, *m_position);\n             if (std::fwrite(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n                 throw std::ios_base::failure{\"XorFile::write: failed\"};\n             }\n             src = src.subspan(buf_now.size());\n-            current_pos += buf_now.size();\n+            *m_position += buf_now.size();\n         }\n     }\n }\n+\n+bool AutoFile::Commit()\n+{\n+    return ::FileCommit(m_file);\n+}\n+\n+bool AutoFile::IsError()\n+{\n+    return ferror(m_file);\n+}\n+\n+bool AutoFile::Truncate(unsigned size)\n+{\n+    return ::TruncateFile(m_file, size);\n+}\ndiff --git a/src/streams.h b/src/streams.h\nindex c2a9dea2878d1..431a4d77c6ced 100644\n--- a/src/streams.h\n+++ b/src/streams.h\n@@ -390,9 +390,10 @@ class AutoFile\n protected:\n     std::FILE* m_file;\n     std::vector<std::byte> m_xor;\n+    std::optional<int64_t> m_position;\n \n public:\n-    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={}) : m_file{file}, m_xor{std::move(data_xor)} {}\n+    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={});\n \n     ~AutoFile() { fclose(); }\n \n@@ -419,12 +420,6 @@ class AutoFile\n         return ret;\n     }\n \n-    /** Get wrapped FILE* without transfer of ownership.\n-     * @note Ownership of the FILE* will remain with this class. Use this only if the scope of the\n-     * AutoFile outlives use of the passed pointer.\n-     */\n-    std::FILE* Get() const { return m_file; }\n-\n     /** Return true if the wrapped FILE* is nullptr, false otherwise.\n      */\n     bool IsNull() const { return m_file == nullptr; }\n@@ -458,6 +453,10 @@ class AutoFile\n         ::Unserialize(*this, obj);\n         return *this;\n     }\n+\n+    bool Commit();\n+    bool IsError();\n+    bool Truncate(unsigned size);\n };\n \n /** Wrapper around an AutoFile& that implements a ring buffer to\ndiff --git a/src/util/asmap.cpp b/src/util/asmap.cpp\nindex f50cd8a28c12d..04b0673c49b42 100644\n--- a/src/util/asmap.cpp\n+++ b/src/util/asmap.cpp\n@@ -203,10 +203,10 @@ std::vector<bool> DecodeAsmap(fs::path path)\n         LogPrintf(\"Failed to open asmap file from disk\\n\");\n         return bits;\n     }\n-    fseek(filestr, 0, SEEK_END);\n-    int length = ftell(filestr);\n+    file.seek(0, SEEK_END);\n+    int length = file.tell();\n     LogPrintf(\"Opened asmap file %s (%d bytes) from disk\\n\", fs::quoted(fs::PathToString(path)), length);\n-    fseek(filestr, 0, SEEK_SET);\n+    file.seek(0, SEEK_SET);\n     uint8_t cur_byte;\n     for (int i = 0; i < length; ++i) {\n         file >> cur_byte;\n", "instance_id": "bitcoin__bitcoin-30884", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: Bitcoin Core 28.0rc1 synchronizes significantly slower on Windows compared to version 27.0, with specific performance metrics provided (e.g., time to synchronize to block 300,000). It also narrows down the issue to a specific commit/PR (#28052) and notes that the problem is Windows-specific, as Linux builds in WSL do not exhibit the slowdown. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior beyond synchronization speed, nor does it provide detailed context about the root cause or specific components affected (though it references a commit). Additionally, edge cases or specific conditions under which the slowdown occurs (beyond default settings and block 120,000) are not mentioned. While the issue is valid and the goal is implied (fix the performance regression), the lack of deeper technical context or explicit requirements for the solution slightly reduces clarity.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is significant, spanning multiple files (e.g., `streams.cpp`, `addrdb.cpp`, `blockstorage.cpp`, etc.) and involving modifications to core file handling logic in the Bitcoin Core codebase. The changes replace low-level file operations (e.g., `ftell`, `fseek`, `FileCommit`) with a custom abstraction in the `AutoFile` class, which requires understanding the interaction between different modules and ensuring consistency across the system. Second, the technical concepts involved are moderately complex, including file I/O operations, position tracking in streams, XOR-based data handling, and Windows-specific performance considerations. Third, the problem likely involves subtle edge cases, such as file position errors, commit failures, or platform-specific behaviors (e.g., Windows vs. Linux file handling), which are not fully detailed in the problem statement but are evident in the code changes (e.g., error handling for `tell` and `seek`). Finally, the performance regression suggests a need for deep understanding of the codebase architecture and potentially system-level debugging to identify why the abstraction introduced in commit #28052 causes a slowdown on Windows. While not at the extreme end of difficulty (e.g., designing a new consensus protocol), this problem requires significant expertise in C++ file handling, cross-platform development, and performance optimization, justifying a score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Improve minimum file descriptor accounting and documentation\n#16003 has been closed, and I've pulled out the unrelated p2p change. However I think it's worth someone following up and taking a look at our startup file descriptor accounting. \r\n\r\nAs mentioned in #16003, if `bitcoind` is started somewhere that the maximum number of open file descriptors is limited, we can run into some nonsensical behaviour. Such as a \"negative\" number of maximum connections:\r\n\r\n```bash\r\n# using bash\r\nulimit -n 150\r\nsrc/bitcoind\r\n[init] Using at most -8 automatic connections (150 file descriptors available)\r\n```\r\n\r\nIt's also impossible to shutdown `bitcoind` from this state as the `opencon` thread will never exit.\r\n\r\nIt would be good for someone to look through this code, document assumptions, and fix issues like the above.\r\n\r\nYou do not need to request permission to start working on this. You are encouraged to comment on the issue if you are planning to work on it. This will help other contributors monitor which issues are actively being addressed and is also an effective way to request assistance if and when you need it.\r\n\r\nFor guidance on contributing, please read [CONTRIBUTING.md](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md) before opening your pull request.\r\n\n", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e60feecf108be..3c4b72d3e4ffe 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -147,11 +147,12 @@ static constexpr bool DEFAULT_STOPAFTERBLOCKIMPORT{false};\n // Win32 LevelDB doesn't use filedescriptors, and the ones used for\n // accessing block files don't count towards the fd_set size limit\n // anyway.\n-#define MIN_CORE_FILEDESCRIPTORS 0\n+#define MIN_LEVELDB_FDS 0\n #else\n-#define MIN_CORE_FILEDESCRIPTORS 150\n+#define MIN_LEVELDB_FDS 150\n #endif\n \n+static constexpr int MIN_CORE_FDS = MIN_LEVELDB_FDS + NUM_FDS_MESSAGE_CAPTURE;\n static const char* DEFAULT_ASMAP_FILENAME=\"ip_asn.map\";\n \n /**\n@@ -834,8 +835,7 @@ void InitLogging(const ArgsManager& args)\n namespace { // Variables internal to initialization process only\n \n int nMaxConnections;\n-int nUserMaxConnections;\n-int nFD;\n+int available_fds;\n ServiceFlags nLocalServices = ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);\n int64_t peer_connect_timeout;\n std::set<BlockFilterType> g_enabled_filter_types;\n@@ -987,27 +987,33 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"Cannot set -listen=0 together with -listenonion=1\"));\n     }\n \n-    // Make sure enough file descriptors are available\n-    int nBind = std::max(nUserBind, size_t(1));\n-    nUserMaxConnections = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n-    nMaxConnections = std::max(nUserMaxConnections, 0);\n-\n-    nFD = RaiseFileDescriptorLimit(nMaxConnections + MIN_CORE_FILEDESCRIPTORS + MAX_ADDNODE_CONNECTIONS + nBind + NUM_FDS_MESSAGE_CAPTURE);\n+    // Make sure enough file descriptors are available. We need to reserve enough FDs to account for the bare minimum,\n+    // plus all manual connections and all bound interfaces. Any remainder will be available for connection sockets\n \n-#ifdef USE_POLL\n-    int fd_max = nFD;\n-#else\n-    int fd_max = FD_SETSIZE;\n+    // Number of bound interfaces (we have at least one)\n+    int nBind = std::max(nUserBind, size_t(1));\n+    // Maximum number of connections with other nodes, this accounts for all types of outbounds and inbounds except for manual\n+    int user_max_connection = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n+    if (user_max_connection < 0) {\n+        return InitError(Untranslated(\"-maxconnections must be greater or equal than zero\"));\n+    }\n+    // Reserve enough FDs to account for the bare minimum, plus any manual connections, plus the bound interfaces\n+    int min_required_fds = MIN_CORE_FDS + MAX_ADDNODE_CONNECTIONS + nBind;\n+\n+    // Try raising the FD limit to what we need (available_fds may be smaller than the requested amount if this fails)\n+    available_fds = RaiseFileDescriptorLimit(user_max_connection + min_required_fds);\n+    // If we are using select instead of poll, our actual limit may be even smaller\n+#ifndef USE_POLL\n+    available_fds = std::min(FD_SETSIZE, available_fds);\n #endif\n+    if (available_fds < min_required_fds)\n+        return InitError(strprintf(_(\"Not enough file descriptors available. %d available, %d required.\"), available_fds, min_required_fds));\n+\n     // Trim requested connection counts, to fit into system limitations\n-    // <int> in std::min<int>(...) to work around FreeBSD compilation issue described in #2695\n-    nMaxConnections = std::max(std::min<int>(nMaxConnections, fd_max - nBind - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE), 0);\n-    if (nFD < MIN_CORE_FILEDESCRIPTORS)\n-        return InitError(_(\"Not enough file descriptors available.\"));\n-    nMaxConnections = std::min(nFD - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE, nMaxConnections);\n+    nMaxConnections = std::min(available_fds - min_required_fds, user_max_connection);\n \n-    if (nMaxConnections < nUserMaxConnections)\n-        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), nUserMaxConnections, nMaxConnections));\n+    if (nMaxConnections < user_max_connection)\n+        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), user_max_connection, nMaxConnections));\n \n     // ********************************************************* Step 3: parameter-to-internal-flags\n     if (auto result{init::SetLoggingCategories(args)}; !result) return InitError(util::ErrorString(result));\n@@ -1155,7 +1161,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         return false;\n     }\n \n-    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, nFD);\n+    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, available_fds);\n \n     // Warn about relative -datadir path.\n     if (args.IsArgSet(\"-datadir\") && !args.GetPathArg(\"-datadir\").is_absolute()) {\n", "instance_id": "bitcoin__bitcoin-30065", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in identifying the issue with file descriptor accounting in the Bitcoin Core software (`bitcoind`), particularly under constrained environments where the maximum number of open file descriptors is limited. It highlights a specific undesirable behavior (negative maximum connections) and mentions the inability to shut down the application in certain states. However, the statement lacks detailed requirements or examples beyond the initial description. For instance, it does not specify expected behavior for edge cases, constraints on file descriptor limits across different platforms, or detailed success criteria for the fix. Additionally, while it suggests documenting assumptions, it does not clarify what specific aspects of the code or behavior need documentation. Despite these minor ambiguities, the goal of improving file descriptor accounting and fixing the mentioned issues is understandable, and the provided code changes align with the described problem.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily within a single file (`init.cpp`), and involves modifications to the logic for calculating and managing file descriptors and maximum connections. However, the changes require a solid understanding of system-level concepts such as file descriptor limits, platform-specific behaviors (e.g., differences between `poll` and `select`), and their impact on a networked application like Bitcoin Core. The problem also demands familiarity with the codebase's initialization process and how different components (e.g., connection handling, logging) interact with file descriptor limits. The code changes introduce error handling for insufficient file descriptors and adjust the logic to prevent negative connection counts, which adds a layer of complexity in ensuring correctness across various system configurations. While the problem does not significantly impact the broader architecture or require extensive cross-module changes, it does involve careful consideration of edge cases (e.g., very low file descriptor limits) and system constraints. Overall, this task requires a moderate level of expertise in systems programming and a good grasp of the Bitcoin Core initialization logic, placing it in the medium difficulty range of 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Re-registered WSL distro profiles do not get auto generated on terminal restart unless state.json is deleted.\n### Windows Terminal version (or Windows build number)\n\nMicrosoft Windows [Version 10.0.19043.1237]\n\n### Other Software\n\nWSL\n\n### Steps to reproduce\n\n- close terminal\r\n- re-register an existing WSL distribution which had an existing profile in WT before\r\n- remove that profile from WT's config\r\n- open terminal\r\n- config file does NOT contain the new distribution's auto-generated profile\n\n### Expected Behavior\n\nAn auto-generated profile for the WSL distro which was registered.\n\n### Actual Behavior\n\nA profile is not added automatically, to make WT add the profile, the state.json file must be deleted, and the terminal must be reopened.\r\n\r\nI'm just blindly guessing but I'm assuming this bug as to do w caching existing profiles in state.json, wt looks at the guid in state.json, assumes thats already generated, and skips trying to generate it again for the config.\r\n\r\nAlso, just for my own curiosity, how are the GUIDs generated for a distro? Is it a uuid v5 with the terminal uuid namespace? I registered a custom distro using `wsl --import` and it gave it a GUID too. A uuid v5 is what i could tell from the source code, but i tried generating some UUID v5s myself using the terminal's runtime namespace and the name of the distro, and the results weren't the same.\n", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/MainPage.cpp b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\nindex 739e0c5e6f8..62e496c1d15 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n@@ -457,6 +457,15 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \r\n         _SetupProfileEventHandling(profile);\r\n \r\n+        if (profile.Orphaned())\r\n+        {\r\n+            contentFrame().Navigate(xaml_typename<Editor::Profiles_Base_Orphaned>(), winrt::make<implementation::NavigateToProfileArgs>(profile, *this));\r\n+            const auto crumb = winrt::make<Breadcrumb>(box_value(profile), profile.Name(), BreadcrumbSubPage::None);\r\n+            _breadcrumbs.Append(crumb);\r\n+            profile.CurrentPage(ProfileSubPage::Base);\r\n+            return;\r\n+        }\r\n+\r\n         contentFrame().Navigate(xaml_typename<Editor::Profiles_Base>(), winrt::make<implementation::NavigateToProfileArgs>(profile, *this));\r\n         const auto crumb = winrt::make<Breadcrumb>(box_value(profile), profile.Name(), BreadcrumbSubPage::None);\r\n         _breadcrumbs.Append(crumb);\r\n@@ -621,6 +630,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         _Navigate(profileViewModel, BreadcrumbSubPage::None);\r\n     }\r\n \r\n+    static MUX::Controls::InfoBadge _createGlyphIconBadge(wil::zwstring_view glyph)\r\n+    {\r\n+        MUX::Controls::InfoBadge badge;\r\n+        MUX::Controls::FontIconSource icon;\r\n+        icon.FontFamily(winrt::Windows::UI::Xaml::Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n+        icon.FontSize(12);\r\n+        icon.Glyph(glyph);\r\n+        badge.IconSource(icon);\r\n+        return badge;\r\n+    }\r\n+\r\n     MUX::Controls::NavigationViewItem MainPage::_CreateProfileNavViewItem(const Editor::ProfileViewModel& profile)\r\n     {\r\n         MUX::Controls::NavigationViewItem profileNavItem;\r\n@@ -628,6 +648,15 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         profileNavItem.Tag(box_value<Editor::ProfileViewModel>(profile));\r\n         profileNavItem.Icon(UI::IconPathConverter::IconWUX(profile.EvaluatedIcon()));\r\n \r\n+        if (profile.Orphaned())\r\n+        {\r\n+            profileNavItem.InfoBadge(_createGlyphIconBadge(L\"\\xE7BA\") /* Warning Triangle */);\r\n+        }\r\n+        else if (profile.Hidden())\r\n+        {\r\n+            profileNavItem.InfoBadge(_createGlyphIconBadge(L\"\\xED1A\") /* Hide */);\r\n+        }\r\n+\r\n         // Update the menu item when the icon/name changes\r\n         auto weakMenuItem{ make_weak(profileNavItem) };\r\n         profile.PropertyChanged([weakMenuItem](const auto&, const WUX::Data::PropertyChangedEventArgs& args) {\r\n@@ -642,6 +671,10 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n                 {\r\n                     menuItem.Content(box_value(tag.Name()));\r\n                 }\r\n+                else if (args.PropertyName() == L\"Hidden\")\r\n+                {\r\n+                    menuItem.InfoBadge(tag.Hidden() ? _createGlyphIconBadge(L\"\\xED1A\") /* Hide */ : nullptr);\r\n+                }\r\n             }\r\n         });\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj b/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\nindex 7d2aed1b744..7d6456886ac 100644\n--- a/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\n+++ b/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\n@@ -113,6 +113,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </ClInclude>\r\n+    <ClInclude Include=\"Profiles_Base_Orphaned.h\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </ClInclude>\r\n     <ClInclude Include=\"Profiles_Advanced.h\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n@@ -176,6 +180,9 @@\n     <Page Include=\"Profiles_Base.xaml\">\r\n       <SubType>Designer</SubType>\r\n     </Page>\r\n+    <Page Include=\"Profiles_Base_Orphaned.xaml\">\r\n+      <SubType>Designer</SubType>\r\n+    </Page>\r\n     <Page Include=\"Profiles_Advanced.xaml\">\r\n       <SubType>Designer</SubType>\r\n     </Page>\r\n@@ -269,6 +276,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </ClCompile>\r\n+    <ClCompile Include=\"Profiles_Base_Orphaned.cpp\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </ClCompile>\r\n     <ClCompile Include=\"Profiles_Advanced.cpp\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n@@ -354,6 +365,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </Midl>\r\n+    <Midl Include=\"Profiles_Base_Orphaned.idl\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </Midl>\r\n     <Midl Include=\"Profiles_Advanced.idl\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\nindex 66d8371c3ea..ab927bd890b 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\n@@ -225,6 +225,11 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         return !IsBaseLayer();\r\n     }\r\n \r\n+    bool ProfileViewModel::Orphaned() const\r\n+    {\r\n+        return _profile.Orphaned();\r\n+    }\r\n+\r\n     Editor::AppearanceViewModel ProfileViewModel::DefaultAppearance()\r\n     {\r\n         return _defaultAppearanceViewModel;\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\nindex c396fe38ec8..0b84a515ead 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\n@@ -85,6 +85,8 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         bool AutoMarkPromptsAvailable() const noexcept;\r\n         bool RepositionCursorWithMouseAvailable() const noexcept;\r\n \r\n+        bool Orphaned() const;\r\n+\r\n         til::typed_event<Editor::ProfileViewModel, Editor::DeleteProfileEventArgs> DeleteProfileRequested;\r\n \r\n         VIEW_MODEL_OBSERVABLE_PROPERTY(ProfileSubPage, CurrentPage);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\nindex 9bf20079cba..08f0108a8a9 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\n@@ -81,6 +81,7 @@ namespace Microsoft.Terminal.Settings.Editor\n         void CreateUnfocusedAppearance();\r\n         void DeleteUnfocusedAppearance();\r\n \r\n+\tBoolean Orphaned { get; };\r\n         OBSERVABLE_PROJECTED_PROFILE_SETTING(String, Name);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Guid, Guid);\r\n         OBSERVABLE_PROJECTED_PROFILE_SETTING(String, Source);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp\nnew file mode 100644\nindex 00000000000..bc27cc4c2da\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp\n@@ -0,0 +1,50 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+#include \"pch.h\"\n+#include \"Profiles_Base_Orphaned.h\"\n+#include \"Profiles_Base_Orphaned.g.cpp\"\n+#include \"ProfileViewModel.h\"\n+\n+#include <LibraryResources.h>\n+#include \"..\\WinRTUtils\\inc\\Utils.h\"\n+\n+using namespace winrt::Windows::UI::Xaml;\n+using namespace winrt::Windows::UI::Xaml::Controls;\n+using namespace winrt::Windows::UI::Xaml::Navigation;\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n+{\n+    Profiles_Base_Orphaned::Profiles_Base_Orphaned()\n+    {\n+        InitializeComponent();\n+        Automation::AutomationProperties::SetName(DeleteButton(), RS_(L\"Profile_DeleteButton/Text\"));\n+    }\n+\n+    void Profiles_Base_Orphaned::OnNavigatedTo(const NavigationEventArgs& e)\n+    {\n+        const auto args = e.Parameter().as<Editor::NavigateToProfileArgs>();\n+        _Profile = args.Profile();\n+\n+        _layoutUpdatedRevoker = LayoutUpdated(winrt::auto_revoke, [this](auto /*s*/, auto /*e*/) {\n+            // This event fires every time the layout changes, but it is always the last one to fire\n+            // in any layout change chain. That gives us great flexibility in finding the right point\n+            // at which to initialize our renderer (and our terminal).\n+            // Any earlier than the last layout update and we may not know the terminal's starting size.\n+\n+            // Only let this succeed once.\n+            _layoutUpdatedRevoker.revoke();\n+\n+            if (_Profile.FocusDeleteButton())\n+            {\n+                DeleteButton().Focus(FocusState::Programmatic);\n+                _Profile.FocusDeleteButton(false);\n+            }\n+        });\n+    }\n+\n+    void Profiles_Base_Orphaned::DeleteConfirmation_Click(const IInspectable& /*sender*/, const RoutedEventArgs& /*e*/)\n+    {\n+        winrt::get_self<ProfileViewModel>(_Profile)->DeleteProfile();\n+    }\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h\nnew file mode 100644\nindex 00000000000..3fca070c89e\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h\n@@ -0,0 +1,30 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+#pragma once\n+\n+#include \"Profiles_Base_Orphaned.g.h\"\n+#include \"ViewModelHelpers.h\"\n+#include \"Utils.h\"\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n+{\n+    struct Profiles_Base_Orphaned : public HasScrollViewer<Profiles_Base_Orphaned>, Profiles_Base_OrphanedT<Profiles_Base_Orphaned>\n+    {\n+    public:\n+        Profiles_Base_Orphaned();\n+\n+        void OnNavigatedTo(const Windows::UI::Xaml::Navigation::NavigationEventArgs& e);\n+        void DeleteConfirmation_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& e);\n+\n+        WINRT_PROPERTY(Editor::ProfileViewModel, Profile, nullptr);\n+\n+    private:\n+        winrt::Windows::UI::Xaml::Controls::SwapChainPanel::LayoutUpdated_revoker _layoutUpdatedRevoker;\n+    };\n+};\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::factory_implementation\n+{\n+    BASIC_FACTORY(Profiles_Base_Orphaned);\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl\nnew file mode 100644\nindex 00000000000..e0266fd3d8a\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl\n@@ -0,0 +1,13 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+import \"ProfileViewModel.idl\";\n+\n+namespace Microsoft.Terminal.Settings.Editor\n+{\n+    [default_interface] runtimeclass Profiles_Base_Orphaned : Windows.UI.Xaml.Controls.Page\n+    {\n+        Profiles_Base_Orphaned();\n+        ProfileViewModel Profile { get; };\n+    }\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml\nnew file mode 100644\nindex 00000000000..a21bbf5e85b\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml\n@@ -0,0 +1,59 @@\n+<!--\r\n+    Copyright (c) Microsoft Corporation. All rights reserved. Licensed under\r\n+    the MIT License. See LICENSE in the project root for license information.\r\n+-->\r\n+<Page x:Class=\"Microsoft.Terminal.Settings.Editor.Profiles_Base_Orphaned\"\r\n+      xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\"\r\n+      xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\"\r\n+      xmlns:d=\"http://schemas.microsoft.com/expression/blend/2008\"\r\n+      xmlns:local=\"using:Microsoft.Terminal.Settings.Editor\"\r\n+      xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"\r\n+      xmlns:model=\"using:Microsoft.Terminal.Settings.Model\"\r\n+      xmlns:mtu=\"using:Microsoft.Terminal.UI\"\r\n+      xmlns:muxc=\"using:Microsoft.UI.Xaml.Controls\"\r\n+      mc:Ignorable=\"d\">\r\n+\r\n+    <Page.Resources>\r\n+        <ResourceDictionary>\r\n+            <ResourceDictionary.MergedDictionaries>\r\n+                <ResourceDictionary Source=\"CommonResources.xaml\" />\r\n+            </ResourceDictionary.MergedDictionaries>\r\n+        </ResourceDictionary>\r\n+    </Page.Resources>\r\n+\r\n+    <StackPanel Style=\"{StaticResource SettingsStackStyle}\">\r\n+        <!--  Delete Button  -->\r\n+        <local:SettingContainer x:Uid=\"Profile_Delete_Orphaned\">\r\n+            <local:SettingContainer.Content>\r\n+                <Button x:Name=\"DeleteButton\"\r\n+                        Click=\"DeleteConfirmation_Click\"\r\n+                        Style=\"{StaticResource DeleteButtonStyle}\">\r\n+                    <Button.Content>\r\n+                        <StackPanel Orientation=\"Horizontal\">\r\n+                            <FontIcon FontSize=\"{StaticResource StandardIconSize}\"\r\n+                                      Glyph=\"&#xE74D;\" />\r\n+                            <TextBlock x:Uid=\"Profile_DeleteButton\"\r\n+                                       Margin=\"10,0,0,0\" />\r\n+                        </StackPanel>\r\n+                    </Button.Content>\r\n+                </Button>\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+\r\n+        <local:SettingContainer x:Uid=\"Profile_Name\">\r\n+            <local:SettingContainer.Content>\r\n+                <TextBlock FontFamily=\"Segoe UI, Segoe Fluent Icons, Segoe MDL2 Assets\"\r\n+                           Style=\"{StaticResource SettingsPageItemDescriptionStyle}\"\r\n+                           Text=\"{x:Bind Profile.Name, Mode=OneTime}\" />\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+\r\n+        <local:SettingContainer x:Uid=\"Profile_Source_Orphaned\">\r\n+            <local:SettingContainer.Content>\r\n+                <TextBlock FontFamily=\"Segoe UI, Segoe Fluent Icons, Segoe MDL2 Assets\"\r\n+                           Style=\"{StaticResource SettingsPageItemDescriptionStyle}\"\r\n+                           Text=\"{x:Bind Profile.Source, Mode=OneTime}\" />\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+    </StackPanel>\r\n+</Page>\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex 46524ca62d4..86c0ae46144 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -1961,4 +1961,16 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+  <data name=\"Profile_Delete_Orphaned.Header\" xml:space=\"preserve\">\r\n+    <value>Profile no longer detected</value>\r\n+  </data>\r\n+  <data name=\"Profile_Delete_Orphaned.HelpText\" xml:space=\"preserve\">\r\n+    <value>This automatically-detected profile appears to have been uninstalled. Changes you have made to it are preserved, but it cannot be used until it has been reinstalled.</value>\r\n+  </data>\r\n+  <data name=\"Profile_Source_Orphaned.Header\" xml:space=\"preserve\">\r\n+    <value>Original Source</value>\r\n+  </data>\r\n+  <data name=\"Profile_Source_Orphaned.HelpText\" xml:space=\"preserve\">\r\n+    <value>Indicates the software that originally created this profile.</value>\r\n+  </data>\r\n+</root>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\nindex 6b412d28b68..eeb3d7cc2e3 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\n@@ -103,7 +103,7 @@ Model::CascadiaSettings CascadiaSettings::Copy() const\n             for (const auto& profile : targetProfiles)\r\n             {\r\n                 allProfiles.emplace_back(*profile);\r\n-                if (!profile->Hidden())\r\n+                if (!profile->Hidden() && !profile->Orphaned())\r\n                 {\r\n                     activeProfiles.emplace_back(*profile);\r\n                 }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\nindex 15a6bd153c9..ea9bda76166 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n@@ -1226,12 +1226,12 @@ CascadiaSettings::CascadiaSettings(SettingsLoader&& loader) :\n             const auto& parents = profile->Parents();\r\n             if (std::none_of(parents.begin(), parents.end(), [&](const auto& parent) { return parent->Source() == source; }))\r\n             {\r\n-                continue;\r\n+                profile->Orphaned(true);\r\n             }\r\n         }\r\n \r\n         allProfiles.emplace_back(*profile);\r\n-        if (!profile->Hidden())\r\n+        if (!profile->Hidden() && !profile->Orphaned())\r\n         {\r\n             activeProfiles.emplace_back(*profile);\r\n         }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.cpp b/src/cascadia/TerminalSettingsModel/Profile.cpp\nindex 561a21017fc..88ae6e8590b 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Profile.cpp\n@@ -104,6 +104,7 @@ winrt::com_ptr<Profile> Profile::CopySettings() const\n     const auto defaultAppearance = AppearanceConfig::CopyAppearance(winrt::get_self<AppearanceConfig>(_DefaultAppearance), weakProfile);\r\n \r\n     profile->_Deleted = _Deleted;\r\n+    profile->_Orphaned = _Orphaned;\r\n     profile->_Updates = _Updates;\r\n     profile->_Guid = _Guid;\r\n     profile->_Name = _Name;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.h b/src/cascadia/TerminalSettingsModel/Profile.h\nindex 24fbb7d1f2d..86110c206ea 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.h\n+++ b/src/cascadia/TerminalSettingsModel/Profile.h\n@@ -115,6 +115,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         void Icon(const hstring& value);\r\n \r\n         WINRT_PROPERTY(bool, Deleted, false);\r\n+        WINRT_PROPERTY(bool, Orphaned, false);\r\n         WINRT_PROPERTY(OriginTag, Origin, OriginTag::None);\r\n         WINRT_PROPERTY(guid, Updates);\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.idl b/src/cascadia/TerminalSettingsModel/Profile.idl\nindex b93a52aa797..331fc1345cf 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.idl\n+++ b/src/cascadia/TerminalSettingsModel/Profile.idl\n@@ -41,6 +41,8 @@ namespace Microsoft.Terminal.Settings.Model\n \r\n         // True if the user explicitly removed this Profile from settings.json.\r\n         Boolean Deleted { get; };\r\n+        // True if the user *kept* this Profile, but it disappeared from the system.\r\n+        Boolean Orphaned { get; };\r\n \r\n         // Helper for magically using a commandline for an icon for a profile\r\n         // without an explicit icon.\r\n", "instance_id": "microsoft__terminal-18188", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: re-registered WSL distro profiles are not auto-generated in Windows Terminal upon restart unless the state.json file is deleted. It provides specific steps to reproduce the issue, expected behavior, and actual behavior, which helps in understanding the problem context. However, there are minor ambiguities and missing details. For instance, it does not explicitly define what constitutes a \"re-registered\" WSL distribution or provide details on the environment setup beyond the Windows version and WSL mention. Additionally, while the user speculates about caching in state.json, there is no confirmation or detailed explanation of the root cause in the problem statement. Edge cases, such as multiple re-registrations or interactions with other terminal configurations, are not mentioned. Overall, the statement is valid and clear but lacks some depth in constraints and edge case specifications.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files and modules within the Windows Terminal codebase, including UI components (XAML files), view models, and settings management logic. The changes involve adding a new concept of \"orphaned\" profiles, which requires modifications to the profile model, UI navigation, and serialization logic, indicating a moderate-to-high impact on the codebase. Second, the technical concepts involved are relatively complex, requiring knowledge of C++/WinRT, XAML for UI development, and the Windows Terminal's internal architecture for profile management and state persistence. Understanding how profiles are generated, cached, and managed in state.json is non-trivial and likely requires familiarity with the codebase's design patterns and data flow. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest handling scenarios where profiles are no longer detected (orphaned), which introduces the need for robust error handling and state management. This includes ensuring that UI updates and profile deletion logic work seamlessly for such cases. The overall amount of code change is significant, with new files added and existing logic modified across several components. However, it does not reach the \"Very Hard\" category as it does not appear to involve system-level changes, performance optimizations, or highly intricate domain-specific knowledge beyond the terminal's profile system. A score of 0.65 reflects the need for a deep understanding of specific parts of the codebase and the complexity of integrating the new \"orphaned\" profile feature without breaking existing functionality.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Windows Terminal]: Screen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\n### Windows Terminal version\r\n\r\n1.22.2362.0\r\n\r\n### Windows build number\r\n\r\n27695.1000\r\n\r\n### Other Software\r\n\r\nTest Environment:\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\n\r\n### Steps to reproduce\r\n\r\n**Repro steps :**\r\n1.Open Windows Terminal.\r\n2.Navigate to the editor.\r\n3.Turn on Narrator by pressing 'Ctrl + Windows + Enter' keys.\r\n4.Now turn on mark mode by pressing 'Ctrl + Shift + M' keys.\r\n5. Now navigate among words using 'Ctrl + Left/Right' keys.\r\n6.Observe the screen reader narration here.\r\n\r\n**Observation using NVDA and JAWS screen reader:**\r\nSame issue repro with NVDA and JAWS screen reader also.\r\n\r\n**User Experience**\r\nUsers who rely on screen reader may not get the info properly while navigating in mark mode.\r\n \r\n **WCAG Reference Link:**\r\n https://www.w3.org/WAI/WCAG21/Understanding/info-and-relationships\r\n \r\n**Attachment :**\r\n[Screen reader is not announcing full word information while navigating via ctrl + left_right arrow keys.zip](https://github.com/user-attachments/files/16943981/Screen.reader.is.not.announcing.full.word.information.while.navigating.via.ctrl.%2B.left_right.arrow.keys.zip)\r\n\r\n\r\n### Expected Behavior\r\n\r\nScreen reader should narrate complete word information while navigating using ctrl + left/right arrow keys in mark mode.\r\n\r\n### Actual Behavior\r\n\r\nScreen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\r\nFor example:\r\nFor word \"Microsoft\", screen reader is just announcing as 'M selected' when we navigate using 'Ctrl + Left' arrow key and announces as 't selected' using 'Ctrl + Right' arrow.\n", "patch": "diff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex b77cf969f49..1a896e0ced6 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -163,6 +163,7 @@ CBN\n cbt\n Ccc\n CCCBB\n+CCCDDD\n cch\n CCHAR\n CCmd\n@@ -369,6 +370,7 @@ DColor\n dcommon\n DComposition\n dde\n+DDDCCC\n DDESHARE\n DDevice\n DEADCHAR\ndiff --git a/src/buffer/out/Row.cpp b/src/buffer/out/Row.cpp\nindex 7a46215b6fc..63ba83f4cd5 100644\n--- a/src/buffer/out/Row.cpp\n+++ b/src/buffer/out/Row.cpp\n@@ -80,11 +80,12 @@ constexpr OutIt copy_n_small(InIt first, Diff count, OutIt dest)\n     return dest;\r\n }\r\n \r\n-CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept :\r\n+CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t charsLength, til::CoordType currentColumn, til::CoordType columnCount) noexcept :\r\n     _chars{ chars },\r\n     _charOffsets{ charOffsets },\r\n-    _lastCharOffset{ lastCharOffset },\r\n-    _currentColumn{ currentColumn }\r\n+    _charsLength{ charsLength },\r\n+    _currentColumn{ currentColumn },\r\n+    _columnCount{ columnCount }\r\n {\r\n }\r\n \r\n@@ -92,7 +93,7 @@ CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* cha\n // This function in particular returns the glyph's first column.\r\n til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept\r\n {\r\n-    targetOffset = clamp(targetOffset, 0, _lastCharOffset);\r\n+    targetOffset = clamp(targetOffset, 0, _charsLength);\r\n \r\n     // This code needs to fulfill two conditions on top of the obvious (a forward/backward search):\r\n     // A: We never want to stop on a column that is marked with CharOffsetsTrailer (= \"GetLeadingColumn\").\r\n@@ -130,10 +131,14 @@ til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) no\n til::CoordType CharToColumnMapper::GetTrailingColumnAt(ptrdiff_t offset) noexcept\r\n {\r\n     auto col = GetLeadingColumnAt(offset);\r\n-    // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n-    // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n-    for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+\r\n+    if (col < _columnCount)\r\n     {\r\n+        // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n+        // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n+        for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+        {\r\n+        }\r\n     }\r\n     return col;\r\n }\r\n@@ -1114,6 +1119,9 @@ std::wstring_view ROW::GetText() const noexcept\n     return { _chars.data(), width };\r\n }\r\n \r\n+// Arguments:\r\n+// - columnBegin: inclusive\r\n+// - columnEnd: exclusive\r\n std::wstring_view ROW::GetText(til::CoordType columnBegin, til::CoordType columnEnd) const noexcept\r\n {\r\n     const auto columns = GetReadableColumnCount();\r\n@@ -1219,15 +1227,15 @@ T ROW::_adjustForward(T column) const noexcept\n }\r\n \r\n // Creates a CharToColumnMapper given an offset into _chars.data().\r\n-// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120).\r\n+// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120].\r\n CharToColumnMapper ROW::_createCharToColumnMapper(ptrdiff_t offset) const noexcept\r\n {\r\n     const auto charsSize = _charSize();\r\n-    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize - 1);\r\n+    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize);\r\n     // We can sort of guess what column belongs to what offset because BMP glyphs are very common and\r\n     // UTF-16 stores them in 1 char. In other words, usually a ROW will have N chars for N columns.\r\n     const auto guessedColumn = gsl::narrow_cast<til::CoordType>(clamp(offset, 0, _columnCount));\r\n-    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn };\r\n+    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn, _columnCount };\r\n }\r\n \r\n const std::optional<ScrollbarData>& ROW::GetScrollbarData() const noexcept\r\ndiff --git a/src/buffer/out/Row.hpp b/src/buffer/out/Row.hpp\nindex d2c19036baf..44156d1b881 100644\n--- a/src/buffer/out/Row.hpp\n+++ b/src/buffer/out/Row.hpp\n@@ -71,7 +71,7 @@ struct RowCopyTextFromState\n // into a ROW's text this class can tell you what cell that pointer belongs to.\r\n struct CharToColumnMapper\r\n {\r\n-    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept;\r\n+    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn, til::CoordType columnCount) noexcept;\r\n \r\n     til::CoordType GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept;\r\n     til::CoordType GetTrailingColumnAt(ptrdiff_t offset) noexcept;\r\n@@ -85,8 +85,9 @@ struct CharToColumnMapper\n \r\n     const wchar_t* _chars;\r\n     const uint16_t* _charOffsets;\r\n-    ptrdiff_t _lastCharOffset;\r\n+    ptrdiff_t _charsLength;\r\n     til::CoordType _currentColumn;\r\n+    til::CoordType _columnCount;\r\n };\r\n \r\n class ROW final\r\ndiff --git a/src/buffer/out/UTextAdapter.cpp b/src/buffer/out/UTextAdapter.cpp\nindex ff0861ce54d..717d97812aa 100644\n--- a/src/buffer/out/UTextAdapter.cpp\n+++ b/src/buffer/out/UTextAdapter.cpp\n@@ -411,16 +411,13 @@ Microsoft::Console::ICU::unique_uregex Microsoft::Console::ICU::CreateRegex(cons\n     return unique_uregex{ re };\r\n }\r\n \r\n-// Returns an inclusive point range given a text start and end position.\r\n+// Returns a half-open [beg,end) range given a text start and end position.\r\n // This function is designed to be used with uregex_start64/uregex_end64.\r\n til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegularExpression* re)\r\n {\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     const auto nativeIndexBeg = uregex_start64(re, 0, &status);\r\n-    auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n-\r\n-    // The parameters are given as a half-open [beg,end) range, but the point_span we return in closed [beg,end].\r\n-    nativeIndexEnd--;\r\n+    const auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n \r\n     const auto& textBuffer = *static_cast<const TextBuffer*>(ut->context);\r\n     til::point_span ret;\r\n@@ -439,7 +436,7 @@ til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegula\n     if (utextAccess(ut, nativeIndexEnd, true))\r\n     {\r\n         const auto y = accessCurrentRow(ut);\r\n-        ret.end.x = textBuffer.GetRowByOffset(y).GetTrailingColumnAtCharOffset(ut->chunkOffset);\r\n+        ret.end.x = textBuffer.GetRowByOffset(y).GetLeadingColumnAtCharOffset(ut->chunkOffset);\r\n         ret.end.y = y;\r\n     }\r\n     else\r\ndiff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex a920854b732..df30a3ffb23 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -1118,6 +1118,14 @@ void TextBuffer::TriggerNewTextNotification(const std::wstring_view newText)\n     }\r\n }\r\n \r\n+void TextBuffer::TriggerSelection()\r\n+{\r\n+    if (_isActiveBuffer && _renderer)\r\n+    {\r\n+        _renderer->TriggerSelection();\r\n+    }\r\n+}\r\n+\r\n // Method Description:\r\n // - get delimiter class for buffer cell position\r\n // - used for double click selection and uia word navigation\r\n@@ -1132,6 +1140,213 @@ DelimiterClass TextBuffer::_GetDelimiterClassAt(const til::point pos, const std:\n     return GetRowByOffset(realPos.y).DelimiterClassAt(realPos.x, wordDelimiters);\r\n }\r\n \r\n+til::point TextBuffer::GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos < bufferSize.Origin())\r\n+    {\r\n+        // can't move further back, so return early at origin\r\n+        return bufferSize.Origin();\r\n+    }\r\n+    else if (pos >= limit)\r\n+    {\r\n+        // clamp to limit,\r\n+        // but still do movement\r\n+        pos = limit;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     CCC___|   -->   |CCC___  CCC|___\r\n+    //     DDD___|   -->   |DDD___  DDD|___\r\n+    //     ___CCC|   -->   ___|CCC  ___|CCC\r\n+    //     DDDCCC|   -->   DDD|CCC  DDD|CCC\r\n+    //     ___DDD|   -->   ___|DDD  ___|DDD\r\n+    //     CCCDDD|   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the beginning of the delimiter class run\r\n+    // 2. (includeWhitespace) if we were on a ControlChar, go back one more delimiter class run\r\n+    const auto initialDelimiter = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.Left())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the left boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+    else if (initialDelimiter == DelimiterClass::ControlChar)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+        pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+til::point TextBuffer::GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // can't move further forward,\r\n+        // so return early at limit\r\n+        return limit;\r\n+    }\r\n+    else if (const auto origin{ bufferSize.Origin() }; pos < origin)\r\n+    {\r\n+        // clamp to origin,\r\n+        // but still do movement\r\n+        pos = origin;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     |CCC___   -->   CCC___|  CCC|___\r\n+    //     |DDD___   -->   DDD___|  DDD|___\r\n+    //     |___CCC   -->   ___|CCC  ___|CCC\r\n+    //     |DDDCCC   -->   DDD|CCC  DDD|CCC\r\n+    //     |___DDD   -->   ___|DDD  ___|DDD\r\n+    //     |CCCDDD   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the end of the delimiter class run\r\n+    // 2. (includeWhitespace) if the next delimiter class run is a ControlChar, go forward one more delimiter class run\r\n+    pos = _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the right boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+\r\n+    if (const auto nextDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+        nextDelimClass == DelimiterClass::ControlChar)\r\n+    {\r\n+        return _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+bool TextBuffer::IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    if (!bufferSize.IsInExclusiveBounds(pos))\r\n+    {\r\n+        // not in bounds\r\n+        return false;\r\n+    }\r\n+\r\n+    // buffer boundaries are always word boundaries\r\n+    if (pos == bufferSize.Origin() || pos == bufferSize.BottomInclusiveRightExclusive())\r\n+    {\r\n+        return true;\r\n+    }\r\n+\r\n+    // at beginning of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.Left())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y - 1);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // at end of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // we can treat text as contiguous,\r\n+    // use DecrementInBounds (not exclusive) here\r\n+    auto prevPos = pos;\r\n+    bufferSize.DecrementInBounds(prevPos);\r\n+    const auto prevDelimiterClass = _GetDelimiterClassAt(prevPos, wordDelimiters);\r\n+\r\n+    // if we changed delimiter class\r\n+    // and the current delimiter class is not a control char,\r\n+    // we're at a word boundary\r\n+    const auto currentDelimiterClass = _GetDelimiterClassAt(pos, wordDelimiters);\r\n+    return prevDelimiterClass != currentDelimiterClass && currentDelimiterClass != DelimiterClass::ControlChar;\r\n+}\r\n+\r\n+til::point TextBuffer::_GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.Origin(); pos = nextPos)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.RightExclusive())\r\n+        {\r\n+            // wrapped onto previous line,\r\n+            // check if it was forced to wrap\r\n+            const auto& row = GetRowByOffset(nextPos.y);\r\n+            if (!row.WasWrapForced())\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (_GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class, we're done (don't apply move)\r\n+            return pos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+// Method Description:\r\n+// - Get the exclusive position for the end of the current delimiter class run\r\n+// Arguments:\r\n+// - pos - the buffer position being within the current delimiter class\r\n+// - wordDelimiters - what characters are we considering for the separation of words\r\n+til::point TextBuffer::_GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.BottomInclusiveRightExclusive(); pos = nextPos)\r\n+    {\r\n+        bufferSize.IncrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.Left())\r\n+        {\r\n+            // wrapped onto next line,\r\n+            // check if it was forced to wrap or switched delimiter class\r\n+            const auto& row = GetRowByOffset(pos.y);\r\n+            if (!row.WasWrapForced() || _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (bufferSize.IsInBounds(nextPos) && _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class,\r\n+            // apply the move and return\r\n+            return nextPos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n // Method Description:\r\n // - Get the til::point for the beginning of the word you are on\r\n // Arguments:\r\n@@ -1520,13 +1735,14 @@ til::point TextBuffer::GetGlyphStart(const til::point pos, std::optional<til::po\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    // limit is exclusive, so we need to move back to be within valid bounds\r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    // if we're on a trailing byte, move to the leading byte\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n         bufferSize.DecrementInBounds(resultPos, true);\r\n     }\r\n@@ -1548,12 +1764,13 @@ til::point TextBuffer::GetGlyphEnd(const til::point pos, bool accessibilityMode,\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n     {\r\n         bufferSize.IncrementInBounds(resultPos, true);\r\n     }\r\n@@ -1610,6 +1827,31 @@ bool TextBuffer::MoveToNextGlyph(til::point& pos, bool allowExclusiveEnd, std::o\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move forward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.IncrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Update pos to be the beginning of the previous glyph/character. This is used for accessibility\r\n // Arguments:\r\n@@ -1642,6 +1884,31 @@ bool TextBuffer::MoveToPreviousGlyph(til::point& pos, std::optional<til::point>\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move backward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.DecrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Determines the line-by-line rectangles based on two COORDs\r\n // - expands the rectangles to support wide glyphs\r\n@@ -1660,12 +1927,10 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n {\r\n     std::vector<til::inclusive_rect> textRects;\r\n \r\n-    const auto bufferSize = GetSize();\r\n-\r\n     // (0,0) is the top-left of the screen\r\n     // the physically \"higher\" coordinate is closer to the top-left\r\n     // the physically \"lower\" coordinate is closer to the bottom-right\r\n-    const auto [higherCoord, lowerCoord] = bufferSize.CompareInBounds(start, end) <= 0 ?\r\n+    const auto [higherCoord, lowerCoord] = start <= end ?\r\n                                                std::make_tuple(start, end) :\r\n                                                std::make_tuple(end, start);\r\n \r\n@@ -1686,6 +1951,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n         }\r\n         else\r\n         {\r\n+            const auto bufferSize = GetSize();\r\n             textRow.left = (row == higherCoord.y) ? higherCoord.x : bufferSize.Left();\r\n             textRow.right = (row == lowerCoord.y) ? lowerCoord.x : bufferSize.RightInclusive();\r\n         }\r\n@@ -1710,7 +1976,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n // - Else if a blockSelection, returns spans corresponding to each line in the block selection\r\n // Arguments:\r\n // - start: beginning of the text region of interest (inclusive)\r\n-// - end: the other end of the text region of interest (inclusive)\r\n+// - end: the other end of the text region of interest (exclusive)\r\n // - blockSelection: when enabled, get spans for each line covered by the block\r\n // - bufferCoordinates: when enabled, treat the coordinates as relative to\r\n //                      the buffer rather than the screen.\r\n@@ -1780,31 +2046,17 @@ void TextBuffer::_ExpandTextRow(til::inclusive_rect& textRow) const\n \r\n     // expand left side of rect\r\n     til::point targetPoint{ textRow.left, textRow.top };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.Left())\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.DecrementInExclusiveBounds(targetPoint);\r\n         textRow.left = targetPoint.x;\r\n     }\r\n \r\n     // expand right side of rect\r\n     targetPoint = { textRow.right, textRow.bottom };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.RightInclusive())\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.IncrementInExclusiveBounds(targetPoint);\r\n         textRow.right = targetPoint.x;\r\n     }\r\n }\r\n@@ -1821,8 +2073,8 @@ size_t TextBuffer::SpanLength(const til::point coordStart, const til::point coor\n // - Retrieves the plain text data between the specified coordinates.\r\n // Arguments:\r\n // - trimTrailingWhitespace - remove the trailing whitespace at the end of the result.\r\n-// - start - where to start getting text (should be at or prior to \"end\")\r\n-// - end - where to end getting text\r\n+// - start - where to start getting text (should be at or prior to \"end\") (inclusive)\r\n+// - end - where to end getting text (exclusive)\r\n // Return Value:\r\n // - Just the text.\r\n std::wstring TextBuffer::GetPlainText(const til::point start, const til::point end) const\r\n@@ -1851,7 +2103,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto maxX = req.bufferCoordinates ? req.maxX : ScreenToBufferLineInclusive(til::point{ req.maxX, iRow }, lineRendition).x;\r\n \r\n         rowBeg = minX;\r\n-        rowEnd = maxX + 1; // +1 to get an exclusive end\r\n+        rowEnd = maxX;\r\n     }\r\n     else\r\n     {\r\n@@ -1860,7 +2112,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto end = req.bufferCoordinates ? req.end : ScreenToBufferLineInclusive(req.end, lineRendition);\r\n \r\n         rowBeg = iRow != beg.y ? 0 : beg.x;\r\n-        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x + 1; // +1 to get an exclusive end\r\n+        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x;\r\n     }\r\n \r\n     // Our selection mechanism doesn't stick to glyph boundaries at the moment.\r\n@@ -1905,7 +2157,7 @@ std::wstring TextBuffer::GetPlainText(const CopyRequest& req) const\n         const auto& row = GetRowByOffset(iRow);\r\n         const auto& [rowBeg, rowEnd, addLineBreak] = _RowCopyHelper(req, iRow, row);\r\n \r\n-        // save selected text\r\n+        // save selected text (exclusive end)\r\n         selectedText += row.GetText(rowBeg, rowEnd);\r\n \r\n         if (addLineBreak && iRow != req.end.y)\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex c97de9e7523..775417caab0 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -170,9 +170,15 @@ class TextBuffer final\n     void TriggerScroll();\r\n     void TriggerScroll(const til::point delta);\r\n     void TriggerNewTextNotification(const std::wstring_view newText);\r\n+    void TriggerSelection();\r\n \r\n     til::point GetWordStart(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     til::point GetWordEnd(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    til::point GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    til::point GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    bool IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n     bool MoveToNextWord(til::point& pos, const std::wstring_view wordDelimiters, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousWord(til::point& pos, const std::wstring_view wordDelimiters) const;\r\n \r\n@@ -180,6 +186,8 @@ class TextBuffer final\n     til::point GetGlyphEnd(const til::point pos, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToNextGlyph(til::point& pos, bool allowBottomExclusive = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousGlyph(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n \r\n     const std::vector<til::inclusive_rect> GetTextRects(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n     std::vector<til::point_span> GetTextSpans(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n@@ -322,6 +330,8 @@ class TextBuffer final\n     void _SetFirstRowIndex(const til::CoordType FirstRowIndex) noexcept;\r\n     void _ExpandTextRow(til::inclusive_rect& selectionRow) const;\r\n     DelimiterClass _GetDelimiterClassAt(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForAccessibility(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForSelection(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordEndForAccessibility(const til::point target, const std::wstring_view wordDelimiters, const til::point limit) const;\r\ndiff --git a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\nindex be9e941c757..81974fe83ab 100644\n--- a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n+++ b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n@@ -49,15 +49,15 @@ class UTextAdapterTests\n             return { { beg, 0 }, { end, 0 } };\r\n         };\r\n \r\n-        auto expected = std::vector{ s(0, 2), s(8, 10) };\r\n+        auto expected = std::vector{ s(0, 3), s(8, 11) };\r\n         auto actual = buffer.SearchText(L\"abc\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(5, 5) };\r\n+        expected = std::vector{ s(5, 6) };\r\n         actual = buffer.SearchText(L\"\ud835\udcb7\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(12, 15) };\r\n+        expected = std::vector{ s(12, 16) };\r\n         actual = buffer.SearchText(L\"\u30cd\u30b3\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex b46da5236af..72a8e85ad55 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1200,7 +1200,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         const auto bufferSize{ _terminal->GetTextBuffer().GetSize() };\r\n         info.StartAtLeftBoundary = _terminal->GetSelectionAnchor().x == bufferSize.Left();\r\n-        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightInclusive();\r\n+        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightExclusive();\r\n         return info;\r\n     }\r\n \r\n@@ -1217,8 +1217,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             return;\r\n         }\r\n \r\n+        // clamp the converted position to be within the viewport bounds\r\n+        // x: allow range of [0, RightExclusive]\r\n+        // GH #18106: right exclusive needed for selection to support exclusive end\r\n         til::point terminalPosition{\r\n-            std::clamp(position.x, 0, _terminal->GetViewport().Width() - 1),\r\n+            std::clamp(position.x, 0, _terminal->GetViewport().Width()),\r\n             std::clamp(position.y, 0, _terminal->GetViewport().Height() - 1)\r\n         };\r\n \r\n@@ -2722,7 +2725,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bufferSize.DecrementInBounds(inclusiveEnd);\r\n \r\n         _terminal->SelectNewRegion(s.start, inclusiveEnd);\r\n-        _renderer->TriggerSelection();\r\n     }\r\n \r\n     void ControlCore::SelectCommand(const bool goUp)\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex 1da3b89ab1d..f4c0feed2a3 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -241,7 +241,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                               const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                               const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         const auto altEnabled = modifiers.IsAltPressed();\r\n         const auto shiftEnabled = modifiers.IsShiftPressed();\r\n@@ -338,7 +338,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                             const Core::Point pixelPosition,\r\n                                             const bool pointerPressedInBounds)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n         // Returning true from this function indicates that the caller should do no further processing of this movement.\r\n         bool handledCompletely = false;\r\n \r\n@@ -372,7 +372,19 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // _touchdown_ point here. We want to start the selection\r\n                     // from where the user initially clicked, not where they are\r\n                     // now.\r\n-                    _core->SetSelectionAnchor(_getTerminalPosition(til::point{ touchdownPoint }));\r\n+                    auto termPos = _getTerminalPosition(til::point{ touchdownPoint }, false);\r\n+                    if (dx < 0)\r\n+                    {\r\n+                        // _getTerminalPosition(_, false) will floor the x-value,\r\n+                        //   meaning that the selection will start on the left-side\r\n+                        //   of the current cell. This is great if the use is dragging\r\n+                        //   towards the right.\r\n+                        // If the user is dragging towards the left (dx < 0),\r\n+                        //   we want to select the current cell, so place the anchor on the right\r\n+                        //   side of the current cell.\r\n+                        termPos.x++;\r\n+                    }\r\n+                    _core->SetSelectionAnchor(termPos);\r\n \r\n                     // stop tracking the touchdown point\r\n                     _singleClickTouchdownPos = std::nullopt;\r\n@@ -428,7 +440,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                                const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                                const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, false);\r\n         // Short-circuit isReadOnly check to avoid warning dialog\r\n         if (!_core->IsInReadOnlyMode() && _canSendVTMouseInput(modifiers))\r\n         {\r\n@@ -475,7 +487,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                           const Core::Point pixelPosition,\r\n                                           const Control::MouseButtonState buttonState)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         // Short-circuit isReadOnly check to avoid warning dialog.\r\n         //\r\n@@ -662,7 +674,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - cursorPosition: in pixels, relative to the origin of the control\r\n     void ControlInteractivity::SetEndSelectionPoint(const Core::Point pixelPosition)\r\n     {\r\n-        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }));\r\n+        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }, true));\r\n         _selectionNeedsToBeCopied = true;\r\n     }\r\n \r\n@@ -672,12 +684,22 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Arguments:\r\n     // - pixelPosition: the (x,y) position of a given point (i.e.: mouse cursor).\r\n     //    NOTE: origin (0,0) is top-left.\r\n+    // - roundToNearestCell: if true, round the x-value. Otherwise, floor it (standard int division)\r\n     // Return Value:\r\n     // - the corresponding viewport terminal position for the given Point parameter\r\n-    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition)\r\n+    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell)\r\n     {\r\n         // Get the size of the font, which is in pixels\r\n-        const til::size fontSize{ _core->GetFont().GetSize() };\r\n+        const auto fontSize{ _core->GetFont().GetSize() };\r\n+\r\n+        if (roundToNearestCell)\r\n+        {\r\n+            // GH#5099: round the x-value to the nearest cell\r\n+            til::point result;\r\n+            result.x = gsl::narrow_cast<til::CoordType>(std::round(gsl::narrow_cast<double>(pixelPosition.x) / fontSize.width));\r\n+            result.y = pixelPosition.y / fontSize.height;\r\n+            return result;\r\n+        }\r\n         // Convert the location in pixels to characters within the current viewport.\r\n         return pixelPosition / fontSize;\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 18d55b53cfa..dcf2c811d02 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -155,7 +155,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bool _canSendVTMouseInput(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers);\r\n         bool _shouldSendAlternateScroll(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers, const int32_t delta);\r\n \r\n-        til::point _getTerminalPosition(const til::point pixelPosition);\r\n+        til::point _getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell);\r\n \r\n         bool _sendMouseEventHelper(const til::point terminalPosition,\r\n                                    const unsigned int pointerUpdateKind,\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 67a1523e99b..9e6350df044 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -478,7 +478,7 @@ bool Terminal::ShouldSendAlternateScroll(const unsigned int uiButton,\n // - The position relative to the viewport\r\n std::wstring Terminal::GetHyperlinkAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos));\r\n+    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos, false));\r\n }\r\n \r\n std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\r\n@@ -502,12 +502,8 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n         result = GetHyperlinkIntervalFromViewportPosition(viewportPos);\r\n         if (result.has_value())\r\n         {\r\n-            // GetPlainText and _ConvertToBufferCell work with inclusive coordinates, but interval's\r\n-            // stop point is (horizontally) exclusive, so let's just update it.\r\n-            result->stop.x--;\r\n-\r\n-            result->start = _ConvertToBufferCell(result->start);\r\n-            result->stop = _ConvertToBufferCell(result->stop);\r\n+            result->start = _ConvertToBufferCell(result->start, false);\r\n+            result->stop = _ConvertToBufferCell(result->stop, true);\r\n         }\r\n     }\r\n     else\r\n@@ -544,7 +540,7 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n // - The hyperlink ID\r\n uint16_t Terminal::GetHyperlinkIdAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos))->TextAttr().GetHyperlinkId();\r\n+    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos, false))->TextAttr().GetHyperlinkId();\r\n }\r\n \r\n // Method description:\r\n@@ -1466,7 +1462,6 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n                 // PointTree uses half-open ranges and viewport-relative coordinates.\r\n                 range.start.y -= beg;\r\n                 range.end.y -= beg;\r\n-                range.end.x++;\r\n                 intervals.push_back(PointTree::interval(range.start, range.end, 0));\r\n             } while (uregex_findNext(re.get(), &status));\r\n         }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex 0ff2cb1955e..1459c39fc3c 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -478,7 +478,7 @@ class Microsoft::Terminal::Core::Terminal final :\n     std::vector<til::point_span> _GetSelectionSpans() const noexcept;\r\n     std::pair<til::point, til::point> _PivotSelection(const til::point targetPos, bool& targetStart) const noexcept;\r\n     std::pair<til::point, til::point> _ExpandSelectionAnchors(std::pair<til::point, til::point> anchors) const;\r\n-    til::point _ConvertToBufferCell(const til::point viewportPos) const;\r\n+    til::point _ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const;\r\n     void _ScrollToPoint(const til::point pos);\r\n     void _MoveByChar(SelectionDirection direction, til::point& pos);\r\n     void _MoveByWord(SelectionDirection direction, til::point& pos);\r\ndiff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 6a800f329dd..9501f64a85e 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -93,14 +93,21 @@ const til::point Terminal::GetSelectionEnd() const noexcept\n til::point Terminal::SelectionStartForRendering() const\r\n {\r\n     auto pos{ _selection->start };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n     if (pos.x != bufferSize.Left())\r\n     {\r\n         // In general, we need to draw the marker one before the\r\n         // beginning of the selection.\r\n         // When we're at the left boundary, we want to\r\n         // flip the marker, so we skip this step.\r\n-        bufferSize.DecrementInBounds(pos);\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -112,14 +119,21 @@ til::point Terminal::SelectionStartForRendering() const\n til::point Terminal::SelectionEndForRendering() const\r\n {\r\n     auto pos{ _selection->end };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n-    if (pos.x != bufferSize.RightInclusive())\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        // In general, we need to draw the marker one after the\r\n-        // end of the selection.\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // sln->end is exclusive\r\n+        // In general, we need to draw the marker on the same cell.\r\n         // When we're at the right boundary, we want to\r\n-        // flip the marker, so we skip this step.\r\n-        bufferSize.IncrementInBounds(pos);\r\n+        // flip the marker, so we move one cell to the left.\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -157,7 +171,7 @@ void Terminal::MultiClickSelection(const til::point viewportPos, SelectionExpans\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = expansionMode;\r\n@@ -179,7 +193,7 @@ void Terminal::SetSelectionAnchor(const til::point viewportPos)\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = SelectionExpansion::Char;\r\n@@ -198,7 +212,7 @@ void Terminal::SetSelectionEnd(const til::point viewportPos, std::optional<Selec\n // - based on the selection expansion mode\r\n // Arguments:\r\n // - viewportPos: the (x,y) coordinate on the visible viewport\r\n-// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for ShiftClick\r\n+// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for Shift+Click\r\n void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewportPos, std::optional<SelectionExpansion> newExpansionMode)\r\n {\r\n     wil::hide_name _selection;\r\n@@ -209,7 +223,12 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n         return;\r\n     }\r\n \r\n-    const auto textBufferPos = _ConvertToBufferCell(viewportPos);\r\n+    auto textBufferPos = _ConvertToBufferCell(viewportPos, true);\r\n+    if (newExpansionMode && *newExpansionMode == SelectionExpansion::Char && textBufferPos >= selection->pivot)\r\n+    {\r\n+        // Shift+Click forwards should highlight the clicked space\r\n+        _activeBuffer().GetSize().IncrementInExclusiveBounds(textBufferPos);\r\n+    }\r\n \r\n     // if this is a shiftClick action, we need to overwrite the _multiClickSelectionMode value (even if it's the same)\r\n     // Otherwise, we may accidentally expand during other selection-based actions\r\n@@ -248,7 +267,7 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n // - the new start/end for a selection\r\n std::pair<til::point, til::point> Terminal::_PivotSelection(const til::point targetPos, bool& targetStart) const noexcept\r\n {\r\n-    if (targetStart = _activeBuffer().GetSize().CompareInBounds(targetPos, _selection->pivot) <= 0)\r\n+    if (targetStart = targetPos <= _selection->pivot)\r\n     {\r\n         // target is before pivot\r\n         // treat target as start\r\n@@ -273,17 +292,31 @@ std::pair<til::point, til::point> Terminal::_ExpandSelectionAnchors(std::pair<ti\n     auto start = anchors.first;\r\n     auto end = anchors.second;\r\n \r\n-    const auto bufferSize = _activeBuffer().GetSize();\r\n+    const auto& buffer = _activeBuffer();\r\n+    const auto bufferSize = buffer.GetSize();\r\n     switch (_multiClickSelectionMode)\r\n     {\r\n     case SelectionExpansion::Line:\r\n         start = { bufferSize.Left(), start.y };\r\n-        end = { bufferSize.RightInclusive(), end.y };\r\n+        end = { bufferSize.RightExclusive(), end.y };\r\n         break;\r\n     case SelectionExpansion::Word:\r\n-        start = _activeBuffer().GetWordStart(start, _wordDelimiters);\r\n-        end = _activeBuffer().GetWordEnd(end, _wordDelimiters);\r\n+    {\r\n+        start = buffer.GetWordStart2(start, _wordDelimiters, false);\r\n+\r\n+        // GH#5099: We round to the nearest cell boundary,\r\n+        //   so we would normally prematurely expand to the next word\r\n+        //   as we approach it during a 2x-click+drag.\r\n+        //   To remedy this, decrement the end's position by 1.\r\n+        //   However, only do this when expanding right (it's correct\r\n+        //   as is when expanding left).\r\n+        if (end > _selection->pivot)\r\n+        {\r\n+            bufferSize.DecrementInExclusiveBounds(end);\r\n+        }\r\n+        end = buffer.GetWordEnd2(end, _wordDelimiters, false);\r\n         break;\r\n+    }\r\n     case SelectionExpansion::Char:\r\n     default:\r\n         // no expansion is necessary\r\n@@ -376,9 +409,9 @@ void Terminal::ExpandSelectionToWord()\n         const auto& buffer = _activeBuffer();\r\n         auto selection{ _selection.write() };\r\n         wil::hide_name _selection;\r\n-        selection->start = buffer.GetWordStart(selection->start, _wordDelimiters);\r\n+        selection->start = buffer.GetWordStart2(selection->start, _wordDelimiters, false);\r\n         selection->pivot = selection->start;\r\n-        selection->end = buffer.GetWordEnd(selection->end, _wordDelimiters);\r\n+        selection->end = buffer.GetWordEnd2(selection->end, _wordDelimiters, false);\r\n \r\n         // if we're targeting both endpoints, instead just target \"end\"\r\n         if (WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) && WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::End))\r\n@@ -529,7 +562,6 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n         selection->start = result->first;\r\n         selection->pivot = result->first;\r\n         selection->end = result->second;\r\n-        bufferSize.DecrementInBounds(selection->end);\r\n         _selectionIsTargetingUrl = true;\r\n         _selectionEndpoint = SelectionEndpoint::End;\r\n     }\r\n@@ -625,7 +657,7 @@ void Terminal::UpdateSelection(SelectionDirection direction, SelectionExpansion\n     }\r\n     auto targetPos{ WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) ? _selection->start : _selection->end };\r\n \r\n-    // 2 Perform the movement\r\n+    // 2. Perform the movement\r\n     switch (mode)\r\n     {\r\n     case SelectionExpansion::Char:\r\n@@ -695,12 +727,12 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n-        _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphStart(pos);\r\n+        _activeBuffer().MoveToPreviousGlyph2(pos);\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphEnd(pos);\r\n+        // We need the limit to be the mutable viewport here,\r\n+        // otherwise we're allowed to navigate by character past the mutable bottom\r\n+        _activeBuffer().MoveToNextGlyph2(pos, _GetMutableViewport().BottomInclusiveRightExclusive());\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -714,7 +746,7 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n         const auto bufferSize{ _activeBuffer().GetSize() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + 1 };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -722,61 +754,45 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n \r\n void Terminal::_MoveByWord(SelectionDirection direction, til::point& pos)\r\n {\r\n+    const auto& buffer = _activeBuffer();\r\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n     {\r\n-        const auto wordStartPos{ _activeBuffer().GetWordStart(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(_selection->pivot, pos) < 0)\r\n-        {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = wordStartPos;\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        }\r\n-        else if (wordStartPos == pos)\r\n-        {\r\n-            // already at the beginning of the current word,\r\n-            // move to the beginning of the previous word\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // move to the beginning of the current word\r\n-            pos = wordStartPos;\r\n+            // didn't move because we're already at the beginning of a word,\r\n+            // so move to the beginning of the previous word\r\n+            buffer.GetSize().DecrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Right:\r\n     {\r\n-        const auto wordEndPos{ _activeBuffer().GetWordEnd(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(pos, _selection->pivot) < 0)\r\n+        const auto mutableViewportEndExclusive = _GetMutableViewport().BottomInclusiveRightExclusive();\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        }\r\n-        else if (wordEndPos == pos)\r\n-        {\r\n-            // already at the end of the current word,\r\n-            // move to the end of the next word\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n-        {\r\n-            // move to the end of the current word\r\n-            pos = wordEndPos;\r\n+            // didn't move because we're already at the end of a word,\r\n+            // so move to the end of the next word\r\n+            buffer.GetSize().IncrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Up:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordStart2(pos, _wordDelimiters, true);\r\n         break;\r\n     case SelectionDirection::Down:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordEnd2(pos, _wordDelimiters, true);\r\n         break;\r\n     }\r\n }\r\n@@ -790,7 +806,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         pos = { bufferSize.Left(), pos.y };\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        pos = { bufferSize.RightInclusive(), pos.y };\r\n+        pos = { bufferSize.RightExclusive(), pos.y };\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -804,7 +820,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         const auto viewportHeight{ _GetMutableViewport().Height() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + viewportHeight };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -821,7 +837,7 @@ void Terminal::_MoveByBuffer(SelectionDirection direction, til::point& pos) noex\n         break;\r\n     case SelectionDirection::Right:\r\n     case SelectionDirection::Down:\r\n-        pos = { bufferSize.RightInclusive(), _GetMutableViewport().BottomInclusive() };\r\n+        pos = { bufferSize.RightExclusive(), _GetMutableViewport().BottomInclusive() };\r\n         break;\r\n     }\r\n }\r\n@@ -901,13 +917,17 @@ Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singl\n // - convert viewport position to the corresponding location on the buffer\r\n // Arguments:\r\n // - viewportPos: a coordinate on the viewport\r\n+// - allowRightExclusive: if true, clamp to the right exclusive boundary of the buffer.\r\n+//     Careful! This position doesn't point to any data in the buffer!\r\n // Return Value:\r\n // - the corresponding location on the buffer\r\n-til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\r\n+til::point Terminal::_ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const\r\n {\r\n     const auto yPos = _VisibleStartIndex() + viewportPos.y;\r\n     til::point bufferPos = { viewportPos.x, yPos };\r\n-    _activeBuffer().GetSize().Clamp(bufferPos);\r\n+    const auto bufferSize = _activeBuffer().GetSize();\r\n+    bufferPos.x = std::clamp(bufferPos.x, bufferSize.Left(), allowRightExclusive ? bufferSize.RightExclusive() : bufferSize.RightInclusive());\r\n+    bufferPos.y = std::clamp(bufferPos.y, bufferSize.Top(), bufferSize.BottomInclusive());\r\n     return bufferPos;\r\n }\r\n \r\n@@ -917,7 +937,7 @@ til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\n // - pos: a coordinate relative to the buffer (not viewport)\r\n void Terminal::_ScrollToPoint(const til::point pos)\r\n {\r\n-    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInBounds(pos))\r\n+    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInExclusiveBounds(pos))\r\n     {\r\n         if (const auto amtAboveView = visibleViewport.Top() - pos.y; amtAboveView > 0)\r\n         {\r\ndiff --git a/src/cascadia/TerminalCore/terminalrenderdata.cpp b/src/cascadia/TerminalCore/terminalrenderdata.cpp\nindex 006d87aabe5..d7bca1077cc 100644\n--- a/src/cascadia/TerminalCore/terminalrenderdata.cpp\n+++ b/src/cascadia/TerminalCore/terminalrenderdata.cpp\n@@ -201,6 +201,11 @@ til::CoordType Terminal::_ScrollToPoints(const til::point coordStart, const til:\n     return _VisibleStartIndex();\r\n }\r\n \r\n+// Method Description:\r\n+// - selects the region from coordStart to coordEnd\r\n+// Arguments:\r\n+// - coordStart - The start point (inclusive)\r\n+// - coordEnd - The end point (inclusive)\r\n void Terminal::SelectNewRegion(const til::point coordStart, const til::point coordEnd)\r\n {\r\n     const auto newScrollOffset = _ScrollToPoints(coordStart, coordEnd);\r\n@@ -210,6 +215,7 @@ void Terminal::SelectNewRegion(const til::point coordStart, const til::point coo\n     const auto newCoordEnd = til::point{ coordEnd.x, coordEnd.y - newScrollOffset };\r\n     SetSelectionAnchor(newCoordStart);\r\n     SetSelectionEnd(newCoordEnd, SelectionExpansion::Char);\r\n+    _activeBuffer().TriggerSelection();\r\n }\r\n \r\n const std::wstring_view Terminal::GetConsoleTitle() const noexcept\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\nindex e018e1fd2ad..999809cb397 100644\n--- a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n@@ -419,7 +419,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -440,7 +440,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -450,7 +450,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -460,7 +460,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -502,7 +502,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -663,7 +663,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 26, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 27, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -673,7 +673,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -731,7 +731,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 29, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 30, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -741,7 +741,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -804,7 +804,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 1, 1 };\r\n-            const til::point expectedEnd{ 1, 2 };\r\n+            const til::point expectedEnd{ 2, 2 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\nindex 49fcd6d21eb..282b1995da7 100644\n--- a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n@@ -438,8 +438,9 @@ namespace ControlUnitTests\n         // The viewport is on row 21, so the selection will be on:\r\n         // {(5, 5)+(0, 21)} to {(5, 5)+(0, 21)}\r\n         til::point expectedAnchor{ 5, 26 };\r\n+        til::point expectedEnd{ 6, 26 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Scroll up a line, with the left mouse button selected\");\r\n         interactivity->MouseWheel(modifiers,\r\n@@ -449,10 +450,11 @@ namespace ControlUnitTests\n \r\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The viewport is now on row 20, so the selection will be on:\r\n-        // {(5, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n-        til::point newExpectedAnchor{ 5, 25 };\r\n+        // {(5 + 1, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n+        // NOTE: newExpectedAnchor should be expectedEnd moved up one row\r\n+        til::point newExpectedAnchor{ 6, 25 };\r\n         // Remember, the anchor is always before the end in the buffer. So yes,\r\n-        // se started the selection on 5,26, but now that's the end.\r\n+        // we started the selection on 5,26, but now that's the end.\r\n         VERIFY_ARE_EQUAL(newExpectedAnchor, core->_terminal->GetSelectionAnchor());\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n     }\r\n@@ -628,7 +630,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify that it started on the first cell we clicked on, not the one we dragged to\");\r\n         til::point expectedAnchor{ 0, 0 };\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        til::point expectedEnd{ 2, 0 };\r\n+        til::point expectedEnd{ 3, 0 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         interactivity->PointerReleased(noMouseDown,\r\n@@ -798,8 +800,9 @@ namespace ControlUnitTests\n         // The viewport is on row (historySize + 5), so the selection will be on:\r\n         // {(5, (historySize+5))+(0, 21)} to {(5, (historySize+5))+(0, 21)}\r\n         til::point expectedAnchor{ 5, settings->HistorySize() + 5 };\r\n+        til::point expectedEnd{ 6, expectedAnchor.y }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Output a line of text\");\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n@@ -807,6 +810,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -815,7 +819,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 1, core->_terminal->GetScrollOffset());\r\n \r\n@@ -825,6 +829,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -833,7 +838,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 2, core->_terminal->GetScrollOffset());\r\n \r\n@@ -858,15 +863,17 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"anchor:({},{})\", anchor.x, anchor.y).c_str());\r\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n+            // Selection was updated, but we didn't highlight a full cell\r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n             VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n         }\r\n \r\n-        Log::Comment(L\"Output a line ant move the mouse a little to update the selection, all at once\");\r\n+        Log::Comment(L\"Output a line and move the mouse a little to update the selection, all at once\");\r\n         // Same as above. The viewport has moved, so the mouse is still over the\r\n         // same character, even though it's at a new offset.\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 3, core->_terminal->GetScrollOffset());\r\n         interactivity->PointerMoved(leftMouseDown,\r\n                                     WM_LBUTTONDOWN, //pointerUpdateKind\r\n@@ -883,7 +890,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n \r\n         // Output enough text for the selection to get pushed off the buffer\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\nindex 11f01c75297..1585fef905f 100644\n--- a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n@@ -126,20 +126,20 @@ namespace TerminalCoreUnitTests\n \r\n             // Test with no scrollback\r\n             Log::Comment(L\"Single click selection with NO scrollback value\");\r\n-            ValidateSingleClickSelection(0, { 9, 9 }, { 9, 9 });\r\n+            ValidateSingleClickSelection(0, { 10, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Double click selection with NO scrollback value\");\r\n-            ValidateDoubleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateDoubleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Triple click selection with NO scrollback value\");\r\n-            ValidateTripleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateTripleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n \r\n             // Test with max scrollback\r\n             const til::CoordType expected_row = SHRT_MAX - 1;\r\n             Log::Comment(L\"Single click selection with MAXIMUM scrollback value\");\r\n-            ValidateSingleClickSelection(SHRT_MAX, { 9, expected_row }, { 9, expected_row });\r\n+            ValidateSingleClickSelection(SHRT_MAX, { 10, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Double click selection with MAXIMUM scrollback value\");\r\n-            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Triple click selection with MAXIMUM scrollback value\");\r\n-            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n         }\r\n \r\n         TEST_METHOD(SelectFromOutofBounds)\r\n@@ -155,7 +155,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const auto leftBoundary = viewport.Left();\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n             const auto topBoundary = viewport.Top();\r\n             const auto bottomBoundary = viewport.BottomInclusive();\r\n \r\n@@ -163,7 +163,7 @@ namespace TerminalCoreUnitTests\n             // should clamp to right boundary\r\n             term.SetSelectionAnchor({ 20, 5 });\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n-            ValidateLinearSelection(term, { rightBoundary, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { rightExclusiveBoundary, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Simulate click past left (x,y) = (-20,5)\r\n             // should clamp to left boundary\r\n@@ -197,7 +197,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const til::CoordType leftBoundary = 0;\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n \r\n             // Simulate click at (x,y) = (5,5)\r\n             term.SetSelectionAnchor({ 5, 5 });\r\n@@ -205,7 +205,7 @@ namespace TerminalCoreUnitTests\n             // Case 1: Move out of right boundary\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n             term.SetSelectionEnd({ 20, 5 });\r\n-            ValidateLinearSelection(term, { 5, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { 5, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Move out of left boundary\r\n             Log::Comment(L\"Out of bounds: X-value negative\");\r\n@@ -312,7 +312,7 @@ namespace TerminalCoreUnitTests\n \r\n             // Validate selection area\r\n             // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 6, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyph_Leading)\r\n@@ -334,8 +334,8 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionAnchor(clickPos);\r\n \r\n             // Validate selection area\r\n-            // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            // Selection should clamp to the left side of the glyph and stay degenerate\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 4, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyphsInBoxSelection)\r\n@@ -356,12 +356,26 @@ namespace TerminalCoreUnitTests\n             GetTextBuffer(term).GetCursor().SetPosition({ 7, 11 });\r\n             term.Write(burrito);\r\n \r\n+            // Text buffer should look like this:\r\n+            // -------------\r\n+            // |     A      |\r\n+            // |            |\r\n+            // |    \ud83c\udf2f      |\r\n+            // |       \ud83c\udf2f   |\r\n+            // |        B   |\r\n+            // -------------\r\n+            // A: selection anchor\r\n+            // B: selection end\r\n+            // The boundaries of the selection should cut through\r\n+            //  the middle of the burritos, but the selection\r\n+            //  should expand to encompass each burrito entirely.\r\n+\r\n             // Simulate ALT + click at (x,y) = (5,8)\r\n             term.SetSelectionAnchor({ 5, 8 });\r\n             term.SetBlockSelection(true);\r\n \r\n-            // Simulate move to (x,y) = (7,12)\r\n-            term.SetSelectionEnd({ 7, 12 });\r\n+            // Simulate move to (x,y) = (8,12)\r\n+            term.SetSelectionEnd({ 8, 12 });\r\n \r\n             // Simulate renderer calling TriggerSelection and acquiring selection area\r\n             auto selectionSpans = term.GetSelectionSpans();\r\n@@ -376,18 +390,18 @@ namespace TerminalCoreUnitTests\n                 if (rowValue == 10)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 4, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n                 else if (rowValue == 11)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 9, rowValue }), sp.end);\r\n                 }\r\n                 else\r\n                 {\r\n                     // Verify all lines\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n \r\n                 rowValue++;\r\n@@ -414,7 +428,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size() - 1), 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size()), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_Delimiter)\r\n@@ -432,7 +446,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_DelimiterClass)\r\n@@ -457,10 +471,10 @@ namespace TerminalCoreUnitTests\n \r\n             // ---Validate selection area---\r\n             // \"Terminal\" is in class 2\r\n-            // \">\" is in class 1\r\n+            // \":\" and \">\" are in class 1\r\n             // the white space to the right of the \">\" is in class 0\r\n             // Double-clicking the \">\" should only highlight that cell\r\n-            ValidateLinearSelection(term, { 15, 10 }, { 15, 10 });\r\n+            ValidateLinearSelection(term, { 15, 10 }, { 16, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Right)\r\n@@ -489,7 +503,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 21, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Left)\r\n@@ -502,7 +516,7 @@ namespace TerminalCoreUnitTests\n             auto settings = winrt::make<MockTermSettings>(0, 100, 100);\r\n             term.UpdateSettings(settings);\r\n \r\n-            // Insert text at position (21,10)\r\n+            // Insert text at position (4,10)\r\n             const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n@@ -513,12 +527,12 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,10)\r\n             //\r\n             // buffer: doubleClickMe dragThroughHere\r\n-            //         ^                ^\r\n-            //       finish            start\r\n+            //          ^               ^\r\n+            //        finish           start\r\n             term.SetSelectionEnd({ 5, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClick_GeneralCase)\r\n@@ -532,7 +546,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Line);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Horizontal)\r\n@@ -549,7 +563,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 7, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Vertical)\r\n@@ -565,7 +579,7 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,11)\r\n             term.SetSelectionEnd({ 5, 11 });\r\n \r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 11 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 11 });\r\n         }\r\n \r\n         TEST_METHOD(ShiftClick)\r\n@@ -579,20 +593,20 @@ namespace TerminalCoreUnitTests\n             term.UpdateSettings(settings);\r\n \r\n             // Insert text at position (4,10)\r\n-            const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n+            const std::wstring_view text = L\"doubleClickMe dragThroughHere anotherWord\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n \r\n-            // Step 1: Create a selection on \"doubleClickMe\"\r\n+            Log::Comment(L\"Step 1 : Create a selection on \\\"doubleClickMe\\\"\");\r\n             {\r\n                 // Simulate double click at (x,y) = (5,10)\r\n                 term.MultiClickSelection({ 5, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 16, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 17, 10 });\r\n             }\r\n \r\n-            // Step 2: Shift+Click to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 2: Shift+Click to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+Click at (x,y) = (21,10)\r\n                 //\r\n@@ -602,10 +616,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area: \"doubleClickMe drag\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 21, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 22, 10 });\r\n             }\r\n \r\n-            // Step 3: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 3: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -615,10 +629,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Triple-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 4: Shift+Triple-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+TripleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -628,60 +642,62 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Line);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 100, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 5: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start            click      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^           ^\r\n+                //       start            click       finish\r\n+                // NOTE: end is exclusive, so finish should point to the spot AFTER \"dragThroughHere\"\r\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag past \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 6: Drag past \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (35,10)\r\n                 // Since we were preceded by a double-click, we're in \"word\" expansion mode\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere     |\r\n-                //         ^                                 ^\r\n-                //       start                             finish (boundary)\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                              ^\r\n+                //       start                          finish\r\n                 term.SetSelectionEnd({ 35, 10 });\r\n \r\n-                // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                // Validate selection area: \"doubleClickMe dragThroughHere anotherWord\" selected\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 45, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag back to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 7: Drag back to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (21,10)\r\n+                // Should still be in \"word\" expansion mode!\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start             drag      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^\r\n+                //       start            finish\r\n                 term.SetSelectionEnd({ 21, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 7: Drag within \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 8: Drag within \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (25,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                    ^      ^\r\n-                //       start                 drag  finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                    ^\r\n+                //       start                finish\r\n                 term.SetSelectionEnd({ 25, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" still selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n         }\r\n \r\n@@ -691,25 +707,27 @@ namespace TerminalCoreUnitTests\n             DummyRenderer renderer{ &term };\r\n             term.Create({ 100, 100 }, 0, renderer);\r\n \r\n-            // Step 1: Create a selection\r\n+            Log::Comment(L\"Step 1: Create a selection\");\r\n             {\r\n-                // (10,10) to (20, 10)\r\n+                // (10,10) to (20, 10) (inclusive)\r\n                 term.SelectNewRegion({ 10, 10 }, { 20, 10 });\r\n \r\n                 // Validate selection area\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n \r\n-            // Step 2: Drag to (5,10)\r\n+            Log::Comment(L\"Step 2: Drag to (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 });\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should be (10, 10)\r\n+                // NOTES:\r\n+                // - Pivot should be (10, 10)\r\n+                // - though end is generally exclusive, since we moved behind the pivot, end is actually inclusive\r\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 3: Drag back to (20,10)\r\n+            Log::Comment(L\"Step 3: Drag back to (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 });\r\n \r\n@@ -718,7 +736,7 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Click at (5,10)\r\n+            Log::Comment(L\"Step 4: Shift+Click at (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n@@ -727,13 +745,14 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Click back at (20,10)\r\n+            Log::Comment(L\"Step 5: Shift+Click back at (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should still be (10, 10)\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                //   Pivot should still be (10, 10)\r\n+                //   Shift+Click makes end inclusive (so add 1)\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n         }\r\n     };\r\ndiff --git a/src/host/selection.cpp b/src/host/selection.cpp\nindex 300068d9671..d7dcf21ebe2 100644\n--- a/src/host/selection.cpp\n+++ b/src/host/selection.cpp\n@@ -43,11 +43,32 @@ void Selection::_RegenerateSelectionSpans() const\n     endSelectionAnchor.x = (_d->coordSelectionAnchor.x == _d->srSelectionRect.left) ? _d->srSelectionRect.right : _d->srSelectionRect.left;\r\n     endSelectionAnchor.y = (_d->coordSelectionAnchor.y == _d->srSelectionRect.top) ? _d->srSelectionRect.bottom : _d->srSelectionRect.top;\r\n \r\n+    // GH #18106: Conhost and Terminal share most of the selection code.\r\n+    //    Both now store the selection data as a half-open range [start, end),\r\n+    //     where \"end\" is the bottom-right-most point.\r\n+    //    Note that Conhost defines start/end as \"start was set in time before end\",\r\n+    //     whereas above (and in Terminal) we're treating start/end as \"start is physically before end\".\r\n+    //    We want Conhost to still operate as an inclusive range.\r\n+    //    To make it \"feel\" inclusive, we need to adjust the \"end\" endpoint\r\n+    //     by incrementing it by one, so that the \"end\" endpoint is rendered\r\n+    //     and handled as selected.\r\n     const auto blockSelection = !IsLineSelection();\r\n-    _lastSelectionSpans = screenInfo.GetTextBuffer().GetTextSpans(_d->coordSelectionAnchor,\r\n-                                                                  endSelectionAnchor,\r\n-                                                                  blockSelection,\r\n-                                                                  false);\r\n+    const auto& buffer = screenInfo.GetTextBuffer();\r\n+    auto startSelectionAnchor = _d->coordSelectionAnchor;\r\n+    if (blockSelection)\r\n+    {\r\n+        // Compare x-values when we're in block selection!\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor.x <= endSelectionAnchor.x ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    else\r\n+    {\r\n+        // General comparison for line selection.\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor <= endSelectionAnchor ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    _lastSelectionSpans = buffer.GetTextSpans(startSelectionAnchor,\r\n+                                              endSelectionAnchor,\r\n+                                              blockSelection,\r\n+                                              false);\r\n     _lastSelectionGeneration = _d.generation();\r\n }\r\n \r\ndiff --git a/src/host/ut_host/ClipboardTests.cpp b/src/host/ut_host/ClipboardTests.cpp\nindex 21d4c7b13b8..24f2693c643 100644\n--- a/src/host/ut_host/ClipboardTests.cpp\n+++ b/src/host/ut_host/ClipboardTests.cpp\n@@ -84,7 +84,7 @@ class ClipboardTests\n         const auto& screenInfo = gci.GetActiveOutputBuffer();\r\n         const auto& buffer = screenInfo.GetTextBuffer();\r\n \r\n-        constexpr til::point_span selection = { { 0, 0 }, { 14, 3 } };\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 15, 3 } };\r\n         const auto req = TextBuffer::CopyRequest::FromConfig(buffer, selection.start, selection.end, false, !fLineSelection, false);\r\n         return buffer.GetPlainText(req);\r\n     }\r\ndiff --git a/src/host/ut_host/SearchTests.cpp b/src/host/ut_host/SearchTests.cpp\nindex 423273b3c38..d37c3556d40 100644\n--- a/src/host/ut_host/SearchTests.cpp\n+++ b/src/host/ut_host/SearchTests.cpp\n@@ -60,7 +60,7 @@ class SearchTests\n         const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n \r\n         auto coordEndExpected = coordStartExpected;\r\n-        coordEndExpected.x += 1;\r\n+        coordEndExpected.x += 2;\r\n \r\n         VERIFY_IS_TRUE(s.SelectCurrent());\r\n         VERIFY_ARE_EQUAL(coordStartExpected, gci.renderData.GetSelectionAnchor());\r\ndiff --git a/src/host/ut_host/SelectionTests.cpp b/src/host/ut_host/SelectionTests.cpp\nindex 62eac812053..f314e8dcc9e 100644\n--- a/src/host/ut_host/SelectionTests.cpp\n+++ b/src/host/ut_host/SelectionTests.cpp\n@@ -74,7 +74,7 @@ class SelectionTests\n                 VERIFY_ARE_EQUAL(span.end.y, sRectangleLineNumber);\r\n \r\n                 VERIFY_ARE_EQUAL(span.start.x, m_pSelection->_d->srSelectionRect.left);\r\n-                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right);\r\n+                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right + 1);\r\n             }\r\n         }\r\n     }\r\n@@ -141,15 +141,17 @@ class SelectionTests\n         }\r\n     }\r\n \r\n-    void VerifyGetSelectionSpans_LineMode(const til::point start, const til::point end)\r\n+    void VerifyGetSelectionSpans_LineMode(const til::point inclusiveStart, const til::point inclusiveEnd)\r\n     {\r\n         const auto selectionSpans = m_pSelection->GetSelectionSpans();\r\n \r\n         if (VERIFY_ARE_EQUAL(1u, selectionSpans.size()))\r\n         {\r\n             auto& span{ selectionSpans[0] };\r\n-            VERIFY_ARE_EQUAL(start, span.start, L\"start\");\r\n-            VERIFY_ARE_EQUAL(end, span.end, L\"end\");\r\n+            VERIFY_ARE_EQUAL(inclusiveStart, span.start, L\"start\");\r\n+\r\n+            const til::point exclusiveEnd{ inclusiveEnd.x + 1, inclusiveEnd.y };\r\n+            VERIFY_ARE_EQUAL(exclusiveEnd, span.end, L\"end\");\r\n         }\r\n     }\r\n \r\ndiff --git a/src/host/ut_host/TextBufferTests.cpp b/src/host/ut_host/TextBufferTests.cpp\nindex 2d6c1d1628e..4252609e30f 100644\n--- a/src/host/ut_host/TextBufferTests.cpp\n+++ b/src/host/ut_host/TextBufferTests.cpp\n@@ -2432,11 +2432,11 @@ void TextBufferTests::GetTextRects()\n     std::vector<til::inclusive_rect> expected{};\r\n     if (blockSelection)\r\n     {\r\n-        expected.push_back({ 1, 0, 7, 0 });\r\n-        expected.push_back({ 1, 1, 8, 1 }); // expand right\r\n-        expected.push_back({ 1, 2, 7, 2 });\r\n-        expected.push_back({ 0, 3, 7, 3 }); // expand left\r\n-        expected.push_back({ 1, 4, 7, 4 });\r\n+        expected.push_back({ 1, 0, 8, 0 });\r\n+        expected.push_back({ 1, 1, 9, 1 }); // expand right\r\n+        expected.push_back({ 1, 2, 8, 2 });\r\n+        expected.push_back({ 0, 3, 8, 3 }); // do not expand\r\n+        expected.push_back({ 1, 4, 8, 4 });\r\n     }\r\n     else\r\n     {\r\n@@ -2444,11 +2444,11 @@ void TextBufferTests::GetTextRects()\n         expected.push_back({ 0, 1, 19, 1 });\r\n         expected.push_back({ 0, 2, 19, 2 });\r\n         expected.push_back({ 0, 3, 19, 3 });\r\n-        expected.push_back({ 0, 4, 7, 4 });\r\n+        expected.push_back({ 0, 4, 8, 4 });\r\n     }\r\n \r\n     til::point start{ 1, 0 };\r\n-    til::point end{ 7, 4 };\r\n+    til::point end{ 8, 4 };\r\n     const auto result = _buffer->GetTextRects(start, end, blockSelection, false);\r\n     VERIFY_ARE_EQUAL(expected.size(), result.size());\r\n     for (size_t i = 0; i < expected.size(); ++i)\r\n@@ -2494,8 +2494,9 @@ void TextBufferTests::GetPlainText()\n                                                        L\"  3  \" };\r\n         WriteLinesToBuffer(bufferText, *_buffer);\r\n \r\n-        // simulate a selection from origin to {4,4}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 4 } };\r\n+        // simulate a selection from origin to {5,4}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 4 } };\r\n \r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, false };\r\n         const auto result = _buffer->GetPlainText(req);\r\n@@ -2589,8 +2590,9 @@ void TextBufferTests::GetPlainText()\n         // |     |\r\n         // |_____|\r\n \r\n-        // simulate a selection from origin to {4,5}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 5 } };\r\n+        // simulate a selection from origin to {5,5}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 5 } };\r\n \r\n         const auto formatWrappedRows = blockSelection;\r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, formatWrappedRows };\r\ndiff --git a/src/inc/til/point.h b/src/inc/til/point.h\nindex 17bc9d1c861..95eed691671 100644\n--- a/src/inc/til/point.h\n+++ b/src/inc/til/point.h\n@@ -322,6 +322,42 @@ namespace til // Terminal Implementation Library. Also: \"Today I Learned\"\n                 func(y, x1, x2);\r\n             }\r\n         }\r\n+\r\n+        // Similar to iterate_rows above, but the \"end\" point is exclusive\r\n+        // and RightExclusive (aka \"width\") is an allowable coordinate\r\n+        constexpr void iterate_rows_exclusive(til::CoordType width, auto&& func) const\r\n+        {\r\n+            // Copy the members so that the compiler knows it doesn't\r\n+            // need to re-read them on every loop iteration.\r\n+            const auto w = width;\r\n+            auto ax = std::clamp(start.x, 0, w);\r\n+            auto ay = start.y;\r\n+            auto bx = std::clamp(end.x, 0, w);\r\n+            auto by = end.y;\r\n+\r\n+            // if start is at RightExclusive,\r\n+            // treat it as (0, y+1) (left-most point on next line)\r\n+            if (ax == w)\r\n+            {\r\n+                ay++;\r\n+                ax = 0;\r\n+            }\r\n+\r\n+            // if end is on left boundary,\r\n+            // treat it as (w, y-1) (RightExclusive on previous line)\r\n+            if (bx == 0)\r\n+            {\r\n+                by--;\r\n+                bx = w;\r\n+            }\r\n+\r\n+            for (auto y = ay; y <= by; ++y)\r\n+            {\r\n+                const auto x1 = y != ay ? 0 : ax;\r\n+                const auto x2 = y != by ? w : bx;\r\n+                func(y, x1, x2);\r\n+            }\r\n+        }\r\n     };\r\n }\r\n \r\ndiff --git a/src/renderer/atlas/AtlasEngine.api.cpp b/src/renderer/atlas/AtlasEngine.api.cpp\nindex a80ae930ba9..10cf2e3a405 100644\n--- a/src/renderer/atlas/AtlasEngine.api.cpp\n+++ b/src/renderer/atlas/AtlasEngine.api.cpp\n@@ -89,11 +89,11 @@ void AtlasEngine::_invalidateSpans(std::span<const til::point_span> spans, const\n     const auto viewport = til::rect{ 0, 0, _api.s->viewportCellCount.x, _api.s->viewportCellCount.y };\r\n     for (auto&& sp : spans)\r\n     {\r\n-        sp.iterate_rows(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n+        sp.iterate_rows_exclusive(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n             const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n             beg <<= shift;\r\n             end <<= shift;\r\n-            til::rect rect{ beg, row, end + 1, row + 1 };\r\n+            til::rect rect{ beg, row, end, row + 1 };\r\n             rect = rect.to_origin(viewportOrigin);\r\n             rect &= viewport;\r\n             _api.invalidatedRows.start = gsl::narrow_cast<u16>(std::min<int>(_api.invalidatedRows.start, std::max<int>(0, rect.top)));\r\ndiff --git a/src/renderer/atlas/AtlasEngine.cpp b/src/renderer/atlas/AtlasEngine.cpp\nindex 0de92b62373..90b9083b5d3 100644\n--- a/src/renderer/atlas/AtlasEngine.cpp\n+++ b/src/renderer/atlas/AtlasEngine.cpp\n@@ -427,13 +427,13 @@ try\n     if (y > hiStart.y)\r\n     {\r\n         const auto isFinalRow = y == hiEnd.y;\r\n-        const auto end = isFinalRow ? std::min(hiEnd.x + 1, x2) : x2;\r\n+        const auto end = isFinalRow ? std::min(hiEnd.x, x2) : x2;\r\n         _fillColorBitmap(row, x1, end, fgColor, bgColor);\r\n \r\n         // Return early if we couldn't paint the whole region (either this was not the last row, or\r\n         // it was the last row but the highlight ends outside of our x range.)\r\n         // We will resume from here in the next call.\r\n-        if (!isFinalRow || hiEnd.x /*inclusive*/ >= x2 /*exclusive*/)\r\n+        if (!isFinalRow || hiEnd.x > x2)\r\n         {\r\n             return S_OK;\r\n         }\r\n@@ -448,10 +448,10 @@ try\n         hiEnd = it->end - offset;\r\n \r\n         const auto isStartInside = y == hiStart.y && hiStart.x < x2;\r\n-        const auto isEndInside = y == hiEnd.y && hiEnd.x < x2;\r\n+        const auto isEndInside = y == hiEnd.y && hiEnd.x <= x2;\r\n         if (isStartInside && isEndInside)\r\n         {\r\n-            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x) + 1, fgColor, bgColor);\r\n+            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x), fgColor, bgColor);\r\n             ++it;\r\n         }\r\n         else\r\ndiff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex c44216ac470..31ab5a410e3 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -342,9 +342,8 @@ try\n             const til::rect vp{ _viewport.ToExclusive() };\r\n             for (auto&& sp : spans)\r\n             {\r\n-                sp.iterate_rows(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n+                sp.iterate_rows_exclusive(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n                     const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n-                    max += 1; // Selection spans are inclusive (still)\r\n                     min <<= shift;\r\n                     max <<= shift;\r\n                     til::rect r{ min, row, max, row + 1 };\r\ndiff --git a/src/types/TermControlUiaProvider.cpp b/src/types/TermControlUiaProvider.cpp\nindex 34bd94f9404..3e4091bd963 100644\n--- a/src/types/TermControlUiaProvider.cpp\n+++ b/src/types/TermControlUiaProvider.cpp\n@@ -157,14 +157,8 @@ HRESULT TermControlUiaProvider::GetSelectionRange(_In_ IRawElementProviderSimple\n     RETURN_HR_IF_NULL(E_INVALIDARG, ppUtr);\r\n     *ppUtr = nullptr;\r\n \r\n-    const auto start = _pData->GetSelectionAnchor();\r\n-\r\n-    // we need to make end exclusive\r\n-    auto end = _pData->GetSelectionEnd();\r\n-    _pData->GetTextBuffer().GetSize().IncrementInBounds(end, true);\r\n-\r\n     TermControlUiaTextRange* result = nullptr;\r\n-    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, start, end, _pData->IsBlockSelection(), wordDelimiters));\r\n+    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, _pData->GetSelectionAnchor(), _pData->GetSelectionEnd(), _pData->IsBlockSelection(), wordDelimiters));\r\n     *ppUtr = result;\r\n     return S_OK;\r\n }\r\ndiff --git a/src/types/UiaTextRangeBase.cpp b/src/types/UiaTextRangeBase.cpp\nindex 0ce958e6985..9b3d7040a5e 100644\n--- a/src/types/UiaTextRangeBase.cpp\n+++ b/src/types/UiaTextRangeBase.cpp\n@@ -972,7 +972,7 @@ CATCH_RETURN();\n // Return Value:\r\n // - the text that the UiaTextRange encompasses\r\n #pragma warning(push)\r\n-#pragma warning(disable : 26447) // compiler isn't filtering throws inside the try/catch\r\n+#pragma warning(disable : 26440) // The function ... can be declared as noexcept.\r\n std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\r\n {\r\n     std::wstring textData{};\r\n@@ -987,13 +987,12 @@ std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\n \r\n         // TODO GH#5406: create a different UIA parent object for each TextBuffer\r\n         // nvaccess/nvda#11428: Ensure our endpoints are in bounds\r\n-        THROW_HR_IF(E_FAIL, !bufferSize.IsInBounds(_start, true) || !bufferSize.IsInBounds(_end, true));\r\n+        auto isValid = [&](const til::point& point) {\r\n+            return bufferSize.IsInExclusiveBounds(point) || point == bufferSize.EndExclusive();\r\n+        };\r\n+        THROW_HR_IF(E_FAIL, !isValid(_start) || !isValid(_end));\r\n \r\n-        // convert _end to be inclusive\r\n-        auto inclusiveEnd = _end;\r\n-        bufferSize.DecrementInBounds(inclusiveEnd, true);\r\n-\r\n-        const auto req = TextBuffer::CopyRequest{ buffer, _start, inclusiveEnd, _blockRange, true, false, false, true };\r\n+        const auto req = TextBuffer::CopyRequest{ buffer, _start, _end, _blockRange, true, false, false, true };\r\n         auto plainText = buffer.GetPlainText(req);\r\n \r\n         if (plainText.size() > maxLengthAsSize)\r\ndiff --git a/src/types/inc/viewport.hpp b/src/types/inc/viewport.hpp\nindex fd0d5b302f8..0f1ea0bdeb8 100644\n--- a/src/types/inc/viewport.hpp\n+++ b/src/types/inc/viewport.hpp\n@@ -41,20 +41,26 @@ namespace Microsoft::Console::Types\n         til::point Origin() const noexcept;\r\n         til::point BottomRightInclusive() const noexcept;\r\n         til::point BottomRightExclusive() const noexcept;\r\n+        til::point BottomInclusiveRightExclusive() const noexcept;\r\n         til::point EndExclusive() const noexcept;\r\n         til::size Dimensions() const noexcept;\r\n \r\n         bool IsInBounds(const Viewport& other) const noexcept;\r\n         bool IsInBounds(const til::point pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IsInExclusiveBounds(const til::point pos) const noexcept;\r\n \r\n         void Clamp(til::point& pos) const;\r\n         Viewport Clamp(const Viewport& other) const noexcept;\r\n \r\n         bool IncrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n         bool DecrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IncrementInExclusiveBounds(til::point& pos) const noexcept;\r\n+        bool DecrementInExclusiveBounds(til::point& pos) const noexcept;\r\n         int CompareInBounds(const til::point first, const til::point second, bool allowEndExclusive = false) const noexcept;\r\n+        int CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept;\r\n \r\n         bool WalkInBounds(til::point& pos, const til::CoordType delta, bool allowEndExclusive = false) const noexcept;\r\n+        bool WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept;\r\n         til::point GetWalkOrigin(const til::CoordType delta) const noexcept;\r\n         static til::CoordType DetermineWalkDirection(const Viewport& source, const Viewport& target) noexcept;\r\n \r\ndiff --git a/src/types/viewport.cpp b/src/types/viewport.cpp\nindex 30c5307dd14..ce4b38565eb 100644\n--- a/src/types/viewport.cpp\n+++ b/src/types/viewport.cpp\n@@ -118,6 +118,11 @@ til::point Viewport::BottomRightExclusive() const noexcept\n     return { RightExclusive(), BottomExclusive() };\r\n }\r\n \r\n+til::point Viewport::BottomInclusiveRightExclusive() const noexcept\r\n+{\r\n+    return { RightExclusive(), BottomInclusive() };\r\n+}\r\n+\r\n // Method Description:\r\n // - For Accessibility, get a til::point representing the end of this viewport in exclusive terms.\r\n // - This is needed to represent an exclusive endpoint in UiaTextRange that includes the last\r\n@@ -295,6 +300,61 @@ bool Viewport::WalkInBounds(til::point& pos, const til::CoordType delta, bool al\n     return off == offClamped;\r\n }\r\n \r\n+bool Viewport::IncrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, 1);\r\n+}\r\n+\r\n+bool Viewport::DecrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, -1);\r\n+}\r\n+\r\n+bool Viewport::IsInExclusiveBounds(const til::point pos) const noexcept\r\n+{\r\n+    return pos.x >= Left() && pos.x <= RightExclusive() &&\r\n+           pos.y >= Top() && pos.y <= BottomInclusive();\r\n+}\r\n+\r\n+int Viewport::CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept\r\n+{\r\n+    // Assert that our coordinates are within the expected boundaries\r\n+    assert(IsInExclusiveBounds(first));\r\n+    assert(IsInExclusiveBounds(second));\r\n+\r\n+    // First set the distance vertically\r\n+    //   If first is on row 4 and second is on row 6, first will be -2 rows behind second * an 80 character row would be -160.\r\n+    //   For the same row, it'll be 0 rows * 80 character width = 0 difference.\r\n+    auto retVal = (first.y - second.y) * Width();\r\n+\r\n+    // Now adjust for horizontal differences\r\n+    //   If first is in position 15 and second is in position 30, first is -15 left in relation to 30.\r\n+    retVal += (first.x - second.x);\r\n+\r\n+    // Further notes:\r\n+    //   If we already moved behind one row, this will help correct for when first is right of second.\r\n+    //     For example, with row 4, col 79 and row 5, col 0 as first and second respectively, the distance is -1.\r\n+    //     Assume the row width is 80.\r\n+    //     Step one will set the retVal as -80 as first is one row behind the second.\r\n+    //     Step two will then see that first is 79 - 0 = +79 right of second and add 79\r\n+    //     The total is -80 + 79 = -1.\r\n+    return retVal;\r\n+}\r\n+\r\n+bool Viewport::WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept\r\n+{\r\n+    const auto l = static_cast<ptrdiff_t>(_sr.left);\r\n+    const auto t = static_cast<ptrdiff_t>(_sr.top);\r\n+    const auto w = static_cast<ptrdiff_t>(std::max(0, _sr.right - _sr.left + 2));\r\n+    const auto h = static_cast<ptrdiff_t>(std::max(0, _sr.bottom - _sr.top + 1));\r\n+    const auto max = w * h;\r\n+    const auto off = w * (pos.y - t) + (pos.x - l) + delta;\r\n+    const auto offClamped = std::clamp(off, ptrdiff_t{ 0 }, max);\r\n+    pos.x = gsl::narrow_cast<til::CoordType>(offClamped % w + l);\r\n+    pos.y = gsl::narrow_cast<til::CoordType>(offClamped / w + t);\r\n+    return off == offClamped;\r\n+}\r\n+\r\n // Routine Description:\r\n // - If walking through a viewport, one might want to know the origin\r\n //   for the direction walking.\r\n", "instance_id": "microsoft__terminal-18106", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the screen reader in Windows Terminal does not announce full word information when navigating in mark mode using Ctrl + Left/Right arrow keys, instead only announcing single characters. It provides specific steps to reproduce, expected behavior, actual behavior, and references to accessibility guidelines (WCAG). However, it lacks some critical details, such as explicit mention of specific edge cases (e.g., behavior with non-ASCII characters, wrapped lines, or empty buffers) and constraints on the solution (e.g., performance requirements or compatibility with other features). Additionally, while the problem is tied to accessibility, it does not specify the exact interaction with screen reader APIs or expected integration points, which could lead to minor ambiguities during implementation.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple files and modules (e.g., text buffer handling, selection logic, rendering, and UI interaction) in a complex codebase like Windows Terminal. The changes involve deep modifications to core components such as `TextBuffer`, `Terminal`, and `ControlInteractivity`, requiring a thorough understanding of how selection and navigation interact with the rendering and accessibility layers. Second, the problem demands knowledge of multiple technical concepts, including text buffer management, Unicode handling (e.g., wide glyphs, DBCS attributes), accessibility APIs (e.g., UIA), and screen reader integration, which are non-trivial and require domain-specific expertise. Third, the code changes impact critical functionality (selection and navigation), necessitating careful handling of numerous edge cases such as wide characters, line wrapping, buffer boundaries, and different selection modes (char, word, line). Finally, the solution must ensure compatibility with existing features and maintain performance, adding to the complexity. While not at the extreme end of difficulty (e.g., requiring system-level redesign), this problem demands a deep understanding of the codebase architecture and careful implementation, justifying a score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Windows Terminal - Settings]: In dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Prerequisites:**\r\nSettings> Personalization> Colors> Choose your Mode> Dark Mode.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Apply dark mode by following the prerequisites.\r\n3. Now open 'Setting' and activate 'Startup' tab.\r\n4. Navigate to the 'Defaults' tab and activate it.\r\n5. Now navigate to the 'Appearance' button and activate it.\r\n6. Now navigate to any control like 'Line height' and change value.\r\n7. 'Reset to inherited value' button will appear.\r\n8. Open Accessibility Insights for windows and check contrast ratio of 'Reset to inherited value' icon. \r\n9. Observe the issue.\r\n\r\n**User experience:**\r\nLow vision users will find difficulty in tracking the control, if contrast ratio for the control's icon is less than '3:1' (Required).\r\n\r\n**WCAG Reference Link:**\r\n[[MAS 4.3.1 \u2013 No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)](https://www.w3.org/WAI/WCAG22/Understanding/non-text-contrast)\r\n\r\n**Attachment:**\r\n[MAS1.4.11 - In Dark mode, cca failed for 'Reset to inherited value' button..zip](https://github.com/user-attachments/files/16959865/MAS1.4.11.-.In.Dark.mode.cca.failed.for.Reset.to.inherited.value.button.zip)\n\n### Expected Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon should be greater than or equal to 3:1. \n\n### Actual Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\r\n\r\n**Note:**\r\nSame issue repro for all 'Reset to inherited value' button's icon throughout.\n", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\nindex 0e12e7d3de7..72b254e4e41 100644\n--- a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n@@ -44,6 +44,9 @@\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n \r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorDark2\" />\r\n+\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"HighContrast\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -73,6 +76,9 @@\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight1\" />\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"Dark\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -106,6 +112,9 @@\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight2\" />\r\n         </ResourceDictionary>\r\n     </ResourceDictionary.ThemeDictionaries>\r\n \r\n@@ -136,7 +145,7 @@\n \r\n     <Style x:Key=\"SettingContainerFontIconStyle\"\r\n            TargetType=\"FontIcon\">\r\n-        <Setter Property=\"Foreground\" Value=\"{StaticResource SystemAccentColor}\" />\r\n+        <Setter Property=\"Foreground\" Value=\"{ThemeResource SettingContainerResetButtonIconForeground}\" />\r\n         <Setter Property=\"FontSize\" Value=\"11\" />\r\n         <Setter Property=\"FontFamily\" Value=\"{ThemeResource SymbolThemeFontFamily}\" />\r\n     </Style>\r\n", "instance_id": "microsoft__terminal-17912", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the context (Windows Terminal in dark mode), the specific problem (luminosity ratio of the 'Reset to inherited value' icon being below the required 3:1), steps to reproduce, expected behavior, and actual behavior. It also references accessibility guidelines (WCAG) and includes attachments for further context. However, there are minor ambiguities: the problem statement does not explicitly discuss potential challenges in adjusting the contrast ratio (e.g., whether changing colors might conflict with other UI elements or themes) or specify if there are constraints on which colors can be used to achieve the required ratio. Additionally, edge cases such as behavior in other themes or high-contrast modes are not fully addressed in the statement, though the code changes partially account for them. Overall, the statement is valid and clear but lacks some minor details that could impact implementation.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling in the easy range (0.2-0.4). The issue involves adjusting the foreground color of an icon to meet accessibility contrast ratio requirements, which is a straightforward UI tweak. The code changes are confined to a single file (SettingContainerStyle.xaml) and involve minimal modifications\u2014adding theme-specific resource definitions for the icon foreground color and updating a style setter to use the new resource. This requires basic understanding of XAML (Extensible Application Markup Language) for Windows UI development and familiarity with theme dictionaries and resource usage, but no complex algorithms, design patterns, or deep architectural changes are needed. The scope of the change is small, with no impact on the broader system architecture or interactions between modules. While the problem touches on accessibility (an important domain-specific concept), the technical implementation is simple. Edge cases, such as ensuring the new colors work across different themes (Dark, Light, High Contrast), are implicitly handled in the code changes but do not add significant complexity. Overall, this is a simple bug fix requiring minimal effort and expertise beyond basic UI development skills.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Can't off feature \"Auto recognize URLs\"\n### Windows Terminal version\n\n1.22.2281.0\n\n### Windows build number\n\n10.0.19045.3448\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nbroken features:\r\n\"experimental.detectURLs\": false,\r\n\r\nwork fine:\r\nMicrosoft.WindowsTerminal_1.17.11461.0_x64.zip\r\nMicrosoft.WindowsTerminal_1.18.2681.0_x64.zip\r\n\r\n\r\nbroken:\r\nMicrosoft.WindowsTerminal_1.19.10302.0_x64.zip\r\n...\r\nMicrosoft.WindowsTerminal_1.20.11781.0_x64.zip\r\n\r\nlatest Canary terminal-1.22.2281.0 also broken\r\n\r\n\r\ntest URL:\r\nhttps://aka.ms/terminal-documentation\r\n\n\n### Expected Behavior\n\nrecognized URLs are not highlighted\n\n### Actual Behavior\n\nrecognized URLs is highlighted\r\nanyway\r\n\r\nwhen \r\n\"experimental.detectURLs\": false,\r\nor\r\n\"experimental.detectURLs\": true,\n", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex a7530807d07..87236331fca 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1425,6 +1425,11 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n         LR\"(\\b(?:https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|$!:,.;]*[A-Za-z0-9+&@#/%=~_|$])\",\r\n     };\r\n \r\n+    if (!_detectURLs)\r\n+    {\r\n+        return {};\r\n+    }\r\n+\r\n     auto text = ICU::UTextFromTextBuffer(_activeBuffer(), beg, end + 1);\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     PointTree::interval_vector intervals;\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\nindex 827c4da85ce..ac9841369db 100644\n--- a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n@@ -607,6 +607,13 @@ void TerminalBufferTests::TestURLPatternDetection()\n     constexpr auto urlStartX = BeforeStr.size();\r\n     constexpr auto urlEndX = BeforeStr.size() + UrlStr.size() - 1;\r\n \r\n+    // This is off by default; turn it on for the test.\r\n+    auto originalDetectURLs = term->_detectURLs;\r\n+    auto restoreDetectUrls = wil::scope_exit([&]() {\r\n+        term->_detectURLs = originalDetectURLs;\r\n+    });\r\n+    term->_detectURLs = true;\r\n+\r\n     auto& termSm = *term->_stateMachine;\r\n     termSm.ProcessString(fmt::format(FMT_COMPILE(L\"{}{}{}\"), BeforeStr, UrlStr, AfterStr));\r\n     term->UpdatePatternsUnderLock();\r\n", "instance_id": "microsoft__terminal-17731", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the \"Auto recognize URLs\" feature in Windows Terminal does not respect the configuration setting \"experimental.detectURLs\": false, and URLs are still highlighted despite the setting. The expected behavior (URLs should not be highlighted when the setting is false) and actual behavior (URLs are highlighted regardless of the setting) are explicitly stated, which provides a clear goal for the fix. Additionally, specific version numbers where the feature works and where it is broken are provided, along with a test URL for reproduction. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this issue occurs under specific conditions (e.g., certain terminal profiles, themes, or input types) or if there are any related side effects. Edge cases, such as malformed URLs or specific text rendering scenarios, are not mentioned. While the issue is reproducible based on the provided information, these missing details prevent the statement from being fully comprehensive.", "difficulty_explanation": "The difficulty of solving this problem is relatively low, falling into the \"Easy\" category (0.2-0.4). Let's break this down based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are minimal and localized to two files: `Terminal.cpp` and `TerminalBufferTests.cpp`. In `Terminal.cpp`, the fix involves adding a conditional check to return an empty `PointTree` if URL detection is disabled, effectively preventing URL pattern matching. In `TerminalBufferTests.cpp`, the change ensures the test explicitly enables URL detection to maintain test validity. These modifications are straightforward, affecting only a small part of the codebase without impacting the broader system architecture or requiring extensive refactoring.\n\n2. **Number of Technical Concepts**: The solution requires basic understanding of C++ (control flow with conditionals), familiarity with the Windows Terminal codebase's internal state (specifically the `_detectURLs` flag), and minimal knowledge of how pattern detection works in the terminal (returning an empty result to disable highlighting). No advanced algorithms, design patterns, or domain-specific knowledge are needed beyond basic terminal rendering logic.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce or handle any complex error conditions. The fix is a simple early return, which inherently avoids further processing and thus minimizes the risk of edge case issues. However, a developer might need to consider whether disabling URL detection could inadvertently affect other features (e.g., text selection or rendering), but this is not evident from the provided diff or problem statement.\n\n4. **Overall Complexity**: The issue is a straightforward bug fix that involves toggling behavior based on a configuration flag. It does not require deep understanding of the codebase beyond the specific function being modified, nor does it involve performance optimization, complex data structures, or cross-module interactions.\n\nGiven these factors, a difficulty score of 0.25 reflects the simplicity of the fix, requiring only basic code modifications and minimal understanding of the surrounding logic. It is slightly above the \"Very Easy\" range due to the need to understand the context of URL detection and ensure the test code is updated accordingly, but it remains an easy task for a developer familiar with C++ and the Windows Terminal codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Gaps between block elements when using Direct2D\n### Windows Terminal version\r\n\r\nCurrent main\r\n\r\n### Windows build number\r\n\r\n10.0.19045.4291\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\n- System-wide scale and layout (display settings): 100%\r\n- WT PowerShell profile settings:\r\n  - Font face: \"Cascadia Mono\"\r\n  - Font size: \"12.2\"\r\n  - Line height: \"1.2\"\r\n  - Font weight: \"Normal\"\r\n  - Builtin Glyphs: \"On\"\r\n  - ![image](https://github.com/microsoft/terminal/assets/11535558/c5d3dcab-d3f3-4928-bb64-b5106f9c4eec)\r\n  - Graphics API: \"Direct2D\"\r\n  - ![image](https://github.com/microsoft/terminal/assets/11535558/92c17826-e955-4155-8c98-57ecbd565c40)\r\n\r\n- Type \"\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\" at the pwsh prompt\r\n  ```pwsh\r\n  \"\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\u2584\"\r\n  ```\r\n\r\n\r\n### Expected Behavior\r\n\r\n[Block elements](https://unicode.org/charts/PDF/U2580.pdf) are fused into a solid bar.\r\n\r\n### Actual Behavior\r\n\r\n![image](https://github.com/microsoft/terminal/assets/11535558/41b56b19-9f19-4300-a76c-f1022d65926f)\r\n\n", "patch": "diff --git a/src/renderer/atlas/AtlasEngine.cpp b/src/renderer/atlas/AtlasEngine.cpp\nindex 28295aeadd2..b5a89f6c09d 100644\n--- a/src/renderer/atlas/AtlasEngine.cpp\n+++ b/src/renderer/atlas/AtlasEngine.cpp\n@@ -74,9 +74,8 @@ try\n         _handleSettingsUpdate();\r\n     }\r\n \r\n-    if (ATLAS_DEBUG_DISABLE_PARTIAL_INVALIDATION || _hackTriggerRedrawAll)\r\n+    if constexpr (ATLAS_DEBUG_DISABLE_PARTIAL_INVALIDATION)\r\n     {\r\n-        _hackTriggerRedrawAll = false;\r\n         _api.invalidatedRows = invalidatedRowsAll;\r\n         _api.scrollOffset = 0;\r\n     }\r\n@@ -703,8 +702,6 @@ void AtlasEngine::_recreateFontDependentResources()\n             _api.textFormatAxes[i] = { fontAxisValues.data(), fontAxisValues.size() };\r\n         }\r\n     }\r\n-\r\n-    _hackWantsBuiltinGlyphs = _p.s->font->builtinGlyphs && !_hackIsBackendD2D;\r\n }\r\n \r\n void AtlasEngine::_recreateCellCountDependentResources()\r\n@@ -765,18 +762,13 @@ void AtlasEngine::_flushBufferLine()\n     // This would seriously blow us up otherwise.\r\n     Expects(_api.bufferLineColumn.size() == _api.bufferLine.size() + 1);\r\n \r\n+    const auto builtinGlyphs = _p.s->font->builtinGlyphs;\r\n     const auto beg = _api.bufferLine.data();\r\n     const auto len = _api.bufferLine.size();\r\n     size_t segmentBeg = 0;\r\n     size_t segmentEnd = 0;\r\n     bool custom = false;\r\n \r\n-    if (!_hackWantsBuiltinGlyphs)\r\n-    {\r\n-        _mapRegularText(0, len);\r\n-        return;\r\n-    }\r\n-\r\n     while (segmentBeg < len)\r\n     {\r\n         segmentEnd = segmentBeg;\r\n@@ -789,7 +781,7 @@ void AtlasEngine::_flushBufferLine()\n                 codepoint = til::combine_surrogates(codepoint, beg[i++]);\r\n             }\r\n \r\n-            const auto c = BuiltinGlyphs::IsBuiltinGlyph(codepoint) || BuiltinGlyphs::IsSoftFontChar(codepoint);\r\n+            const auto c = (builtinGlyphs && BuiltinGlyphs::IsBuiltinGlyph(codepoint)) || BuiltinGlyphs::IsSoftFontChar(codepoint);\r\n             if (custom != c)\r\n             {\r\n                 break;\r\ndiff --git a/src/renderer/atlas/AtlasEngine.h b/src/renderer/atlas/AtlasEngine.h\nindex 1f26644ebe6..ccb4da9fb4e 100644\n--- a/src/renderer/atlas/AtlasEngine.h\n+++ b/src/renderer/atlas/AtlasEngine.h\n@@ -127,18 +127,6 @@ namespace Microsoft::Console::Render::Atlas\n         std::unique_ptr<IBackend> _b;\r\n         RenderingPayload _p;\r\n \r\n-        // _p.s->font->builtinGlyphs is the setting which decides whether we should map box drawing glyphs to\r\n-        // our own builtin versions. There's just one problem: BackendD2D doesn't have this functionality.\r\n-        // But since AtlasEngine shapes the text before it's handed to the backends, it would need to know\r\n-        // whether BackendD2D is in use, before BackendD2D even exists. These two flags solve the issue\r\n-        // by triggering a complete, immediate redraw whenever the backend type changes.\r\n-        //\r\n-        // The proper solution is to move text shaping into the backends.\r\n-        // Someone just needs to write a generic \"TextBuffer to DWRITE_GLYPH_RUN\" function.\r\n-        bool _hackIsBackendD2D = false;\r\n-        bool _hackWantsBuiltinGlyphs = true;\r\n-        bool _hackTriggerRedrawAll = false;\r\n-\r\n         struct ApiState\r\n         {\r\n             GenerationalSettings s = DirtyGenerationalSettings();\r\ndiff --git a/src/renderer/atlas/AtlasEngine.r.cpp b/src/renderer/atlas/AtlasEngine.r.cpp\nindex a0dbdcc5470..3591abe7905 100644\n--- a/src/renderer/atlas/AtlasEngine.r.cpp\n+++ b/src/renderer/atlas/AtlasEngine.r.cpp\n@@ -77,7 +77,7 @@ CATCH_RETURN()\n \r\n [[nodiscard]] bool AtlasEngine::RequiresContinuousRedraw() noexcept\r\n {\r\n-    return ATLAS_DEBUG_CONTINUOUS_REDRAW || (_b && _b->RequiresContinuousRedraw()) || _hackTriggerRedrawAll;\r\n+    return ATLAS_DEBUG_CONTINUOUS_REDRAW || (_b && _b->RequiresContinuousRedraw());\r\n }\r\n \r\n void AtlasEngine::WaitUntilCanRender() noexcept\r\n@@ -282,21 +282,15 @@ void AtlasEngine::_recreateBackend()\n     {\r\n     case GraphicsAPI::Direct2D:\r\n         _b = std::make_unique<BackendD2D>();\r\n-        _hackIsBackendD2D = true;\r\n         break;\r\n     default:\r\n         _b = std::make_unique<BackendD3D>(_p);\r\n-        _hackIsBackendD2D = false;\r\n         break;\r\n     }\r\n \r\n     // This ensures that the backends redraw their entire viewports whenever a new swap chain is created,\r\n     // EVEN IF we got called when no actual settings changed (i.e. rendering failure, etc.).\r\n     _p.MarkAllAsDirty();\r\n-\r\n-    const auto hackWantsBuiltinGlyphs = _p.s->font->builtinGlyphs && !_hackIsBackendD2D;\r\n-    _hackTriggerRedrawAll = _hackWantsBuiltinGlyphs != hackWantsBuiltinGlyphs;\r\n-    _hackWantsBuiltinGlyphs = hackWantsBuiltinGlyphs;\r\n }\r\n \r\n void AtlasEngine::_handleSwapChainUpdate()\r\ndiff --git a/src/renderer/atlas/BackendD2D.cpp b/src/renderer/atlas/BackendD2D.cpp\nindex 5a663b49d04..cf7bd8a2bec 100644\n--- a/src/renderer/atlas/BackendD2D.cpp\n+++ b/src/renderer/atlas/BackendD2D.cpp\n@@ -4,6 +4,8 @@\n #include \"pch.h\"\r\n #include \"BackendD2D.h\"\r\n \r\n+#include <til/unicode.h>\r\n+\r\n #if ATLAS_DEBUG_SHOW_DIRTY\r\n #include \"colorbrewer.h\"\r\n #endif\r\n@@ -94,11 +96,15 @@ void BackendD2D::_handleSettingsUpdate(const RenderingPayload& p)\n                 .dpiY = static_cast<f32>(p.s->font->dpi),\r\n             };\r\n             // ID2D1RenderTarget and ID2D1DeviceContext are the same and I'm tired of pretending they're not.\r\n-            THROW_IF_FAILED(p.d2dFactory->CreateDxgiSurfaceRenderTarget(surface.get(), &props, reinterpret_cast<ID2D1RenderTarget**>(_renderTarget.addressof())));\r\n-            _renderTarget.try_query_to(_renderTarget4.addressof());\r\n+            THROW_IF_FAILED(p.d2dFactory->CreateDxgiSurfaceRenderTarget(surface.get(), &props, reinterpret_cast<ID2D1RenderTarget**>(_renderTarget.put())));\r\n \r\n             _renderTarget->SetUnitMode(D2D1_UNIT_MODE_PIXELS);\r\n-            _renderTarget->SetAntialiasMode(D2D1_ANTIALIAS_MODE_ALIASED);\r\n+\r\n+            _renderTarget.try_query_to(_renderTarget4.put());\r\n+            if (_renderTarget4)\r\n+            {\r\n+                THROW_IF_FAILED(_renderTarget4->CreateSpriteBatch(_builtinGlyphBatch.put()));\r\n+            }\r\n         }\r\n         {\r\n             static constexpr D2D1_COLOR_F color{};\r\n@@ -108,18 +114,15 @@ void BackendD2D::_handleSettingsUpdate(const RenderingPayload& p)\n         }\r\n     }\r\n \r\n-    if (!_dottedStrokeStyle)\r\n-    {\r\n-        static constexpr D2D1_STROKE_STYLE_PROPERTIES props{ .dashStyle = D2D1_DASH_STYLE_CUSTOM };\r\n-        static constexpr FLOAT dashes[2]{ 1, 1 };\r\n-        THROW_IF_FAILED(p.d2dFactory->CreateStrokeStyle(&props, &dashes[0], 2, _dottedStrokeStyle.addressof()));\r\n-    }\r\n-\r\n     if (renderTargetChanged || fontChanged)\r\n     {\r\n         const auto dpi = static_cast<f32>(p.s->font->dpi);\r\n         _renderTarget->SetDpi(dpi, dpi);\r\n         _renderTarget->SetTextAntialiasMode(static_cast<D2D1_TEXT_ANTIALIAS_MODE>(p.s->font->antialiasingMode));\r\n+\r\n+        _builtinGlyphsRenderTarget.reset();\r\n+        _builtinGlyphsBitmap.reset();\r\n+        _builtinGlyphsRenderTargetActive = false;\r\n     }\r\n \r\n     if (renderTargetChanged || fontChanged || cellCountChanged)\r\n@@ -199,6 +202,12 @@ void BackendD2D::_drawText(RenderingPayload& p)\n \r\n         for (const auto& m : row->mappings)\r\n         {\r\n+            if (!m.fontFace)\r\n+            {\r\n+                baselineX = _drawBuiltinGlyphs(p, row, m, baselineY, baselineX);\r\n+                continue;\r\n+            }\r\n+\r\n             const auto colorsBegin = row->colors.begin();\r\n             auto it = colorsBegin + m.glyphsFrom;\r\n             const auto end = colorsBegin + m.glyphsTo;\r\n@@ -228,42 +237,39 @@ void BackendD2D::_drawText(RenderingPayload& p)\n                     baselineY,\r\n                 };\r\n \r\n-                if (glyphRun.fontFace)\r\n+                D2D1_RECT_F bounds = GlyphRunEmptyBounds;\r\n+                wil::com_ptr<IDWriteColorGlyphRunEnumerator1> enumerator;\r\n+\r\n+                if (p.s->font->colorGlyphs)\r\n                 {\r\n-                    D2D1_RECT_F bounds = GlyphRunEmptyBounds;\r\n-                    wil::com_ptr<IDWriteColorGlyphRunEnumerator1> enumerator;\r\n+                    enumerator = TranslateColorGlyphRun(p.dwriteFactory4.get(), baselineOrigin, &glyphRun);\r\n+                }\r\n \r\n-                    if (p.s->font->colorGlyphs)\r\n+                if (enumerator)\r\n+                {\r\n+                    while (ColorGlyphRunMoveNext(enumerator.get()))\r\n                     {\r\n-                        enumerator = TranslateColorGlyphRun(p.dwriteFactory4.get(), baselineOrigin, &glyphRun);\r\n+                        const auto colorGlyphRun = ColorGlyphRunGetCurrentRun(enumerator.get());\r\n+                        ColorGlyphRunDraw(_renderTarget4.get(), _emojiBrush.get(), brush, colorGlyphRun);\r\n+                        ColorGlyphRunAccumulateBounds(_renderTarget.get(), colorGlyphRun, bounds);\r\n                     }\r\n+                }\r\n+                else\r\n+                {\r\n+                    _renderTarget->DrawGlyphRun(baselineOrigin, &glyphRun, brush, DWRITE_MEASURING_MODE_NATURAL);\r\n+                    GlyphRunAccumulateBounds(_renderTarget.get(), baselineOrigin, &glyphRun, bounds);\r\n+                }\r\n \r\n-                    if (enumerator)\r\n-                    {\r\n-                        while (ColorGlyphRunMoveNext(enumerator.get()))\r\n-                        {\r\n-                            const auto colorGlyphRun = ColorGlyphRunGetCurrentRun(enumerator.get());\r\n-                            ColorGlyphRunDraw(_renderTarget4.get(), _emojiBrush.get(), brush, colorGlyphRun);\r\n-                            ColorGlyphRunAccumulateBounds(_renderTarget.get(), colorGlyphRun, bounds);\r\n-                        }\r\n-                    }\r\n-                    else\r\n+                if (bounds.top < bounds.bottom)\r\n+                {\r\n+                    // Since we used SetUnitMode(D2D1_UNIT_MODE_PIXELS), bounds.top/bottom is in pixels already and requires no conversion/rounding.\r\n+                    if (row->lineRendition != LineRendition::DoubleHeightTop)\r\n                     {\r\n-                        _renderTarget->DrawGlyphRun(baselineOrigin, &glyphRun, brush, DWRITE_MEASURING_MODE_NATURAL);\r\n-                        GlyphRunAccumulateBounds(_renderTarget.get(), baselineOrigin, &glyphRun, bounds);\r\n+                        row->dirtyBottom = std::max(row->dirtyBottom, static_cast<i32>(lrintf(bounds.bottom)));\r\n                     }\r\n-\r\n-                    if (bounds.top < bounds.bottom)\r\n+                    if (row->lineRendition != LineRendition::DoubleHeightBottom)\r\n                     {\r\n-                        // Since we used SetUnitMode(D2D1_UNIT_MODE_PIXELS), bounds.top/bottom is in pixels already and requires no conversion/rounding.\r\n-                        if (row->lineRendition != LineRendition::DoubleHeightTop)\r\n-                        {\r\n-                            row->dirtyBottom = std::max(row->dirtyBottom, static_cast<i32>(lrintf(bounds.bottom)));\r\n-                        }\r\n-                        if (row->lineRendition != LineRendition::DoubleHeightBottom)\r\n-                        {\r\n-                            row->dirtyTop = std::min(row->dirtyTop, static_cast<i32>(lrintf(bounds.top)));\r\n-                        }\r\n+                        row->dirtyTop = std::min(row->dirtyTop, static_cast<i32>(lrintf(bounds.top)));\r\n                     }\r\n                 }\r\n \r\n@@ -274,6 +280,8 @@ void BackendD2D::_drawText(RenderingPayload& p)\n             }\r\n         }\r\n \r\n+        _flushBuiltinGlyphs();\r\n+\r\n         if (!row->gridLineRanges.empty())\r\n         {\r\n             _drawGridlineRow(p, row, y);\r\n@@ -300,6 +308,160 @@ void BackendD2D::_drawText(RenderingPayload& p)\n     }\r\n }\r\n \r\n+f32 BackendD2D::_drawBuiltinGlyphs(const RenderingPayload& p, const ShapedRow* row, const FontMapping& m, f32 baselineY, f32 baselineX)\r\n+{\r\n+    const f32 cellTop = baselineY - p.s->font->baseline;\r\n+    const f32 cellBottom = cellTop + p.s->font->cellSize.y;\r\n+    const f32 cellWidth = p.s->font->cellSize.x;\r\n+\r\n+    _prepareBuiltinGlyphRenderTarget(p);\r\n+\r\n+    for (size_t i = m.glyphsFrom; i < m.glyphsTo; ++i)\r\n+    {\r\n+        // This code runs when fontFace == nullptr. This is only the case for builtin glyphs which then use the glyphIndices\r\n+        // to store UTF16 code points. In other words, this doesn't accidentally corrupt any actual glyph indices.\r\n+        u32 ch = row->glyphIndices[i];\r\n+        if (til::is_leading_surrogate(ch))\r\n+        {\r\n+            i += 1;\r\n+            ch = til::combine_surrogates(ch, row->glyphIndices[i]);\r\n+        }\r\n+\r\n+        // If we don't have support for ID2D1SpriteBatch we don't support builtin glyphs.\r\n+        // But we do still need to account for the glyphAdvances, which is why we can't just skip everything.\r\n+        // It's very unlikely for a target device to not support ID2D1SpriteBatch as it's very old at this point.\r\n+        if (_builtinGlyphBatch)\r\n+        {\r\n+            if (const auto off = BuiltinGlyphs::GetBitmapCellIndex(ch); off >= 0)\r\n+            {\r\n+                const D2D1_RECT_F dst{ baselineX, cellTop, baselineX + cellWidth, cellBottom };\r\n+                const auto src = _prepareBuiltinGlyph(p, ch, off);\r\n+                const auto color = colorFromU32(row->colors[i]);\r\n+                THROW_IF_FAILED(_builtinGlyphBatch->AddSprites(1, &dst, &src, &color, nullptr, sizeof(D2D1_RECT_F), sizeof(D2D1_RECT_U), sizeof(D2D1_COLOR_F), sizeof(D2D1_MATRIX_3X2_F)));\r\n+            }\r\n+        }\r\n+\r\n+        baselineX += row->glyphAdvances[i];\r\n+    }\r\n+\r\n+    return baselineX;\r\n+}\r\n+\r\n+void BackendD2D::_prepareBuiltinGlyphRenderTarget(const RenderingPayload& p)\r\n+{\r\n+    // If we don't have support for ID2D1SpriteBatch none of the related members will be initialized or used.\r\n+    // We can just early-return in that case.\r\n+    if (!_builtinGlyphBatch)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    // If the render target is already created, all of the below has already been done in a previous frame.\r\n+    // Once the relevant settings change for some reason (primarily the font->cellSize), then _handleSettingsUpdate()\r\n+    // will reset the render target which will cause us to skip this condition and re-initialize it below.\r\n+    if (_builtinGlyphsRenderTarget)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    const auto cellWidth = static_cast<u32>(p.s->font->cellSize.x);\r\n+    const auto cellHeight = static_cast<u32>(p.s->font->cellSize.y);\r\n+    const auto cellArea = cellWidth * cellHeight;\r\n+    const auto area = cellArea * BuiltinGlyphs::TotalCharCount;\r\n+\r\n+    // This block of code calculates the size of a power-of-2 texture that has an area larger than the given `area`.\r\n+    // For instance, for an area of 985x1946 = 1916810 it would result in a u/v of 2048x1024 (area = 2097152).\r\n+    // We throw the \"v\" in this case away, because we don't really need power-of-2 textures here,\r\n+    // but you can find the complete code over in BackendD3D. If someone deleted it in the meantime:\r\n+    //   const auto index = bitness_of_area_minus_1 - std::countl_zero(area - 1); // aka: _BitScanReverse\r\n+    //   const auto u = 1u << ((index + 2) / 2);\r\n+    //   const auto v = 1u << ((index + 1) / 2);\r\n+    unsigned long index;\r\n+    _BitScanReverse(&index, area - 1);\r\n+    const auto potWidth = 1u << ((index + 2) / 2);\r\n+\r\n+    const auto cellCountU = potWidth / cellWidth;\r\n+    const auto cellCountV = (BuiltinGlyphs::TotalCharCount + cellCountU - 1) / cellCountU;\r\n+    const auto u = cellCountU * cellWidth;\r\n+    const auto v = cellCountV * cellHeight;\r\n+\r\n+    const D2D1_SIZE_F sizeF{ static_cast<f32>(u), static_cast<f32>(v) };\r\n+    const D2D1_SIZE_U sizeU{ gsl::narrow_cast<UINT32>(u), gsl::narrow_cast<UINT32>(v) };\r\n+    static constexpr D2D1_PIXEL_FORMAT format{ DXGI_FORMAT_A8_UNORM, D2D1_ALPHA_MODE_PREMULTIPLIED };\r\n+    wil::com_ptr<ID2D1BitmapRenderTarget> target;\r\n+    THROW_IF_FAILED(_renderTarget->CreateCompatibleRenderTarget(&sizeF, &sizeU, &format, D2D1_COMPATIBLE_RENDER_TARGET_OPTIONS_NONE, target.addressof()));\r\n+\r\n+    THROW_IF_FAILED(target->GetBitmap(_builtinGlyphsBitmap.put()));\r\n+    _builtinGlyphsRenderTarget = target.query<ID2D1DeviceContext>();\r\n+    _builtinGlyphsBitmapCellCountU = cellCountU;\r\n+    _builtinGlyphsRenderTargetActive = false;\r\n+    memset(&_builtinGlyphsReady[0], 0, sizeof(_builtinGlyphsReady));\r\n+}\r\n+\r\n+D2D1_RECT_U BackendD2D::_prepareBuiltinGlyph(const RenderingPayload& p, char32_t ch, u32 off)\r\n+{\r\n+    const u32 w = p.s->font->cellSize.x;\r\n+    const u32 h = p.s->font->cellSize.y;\r\n+    const u32 l = (off % _builtinGlyphsBitmapCellCountU) * w;\r\n+    const u32 t = (off / _builtinGlyphsBitmapCellCountU) * h;\r\n+    D2D1_RECT_U rectU{ l, t, l + w, t + h };\r\n+\r\n+    // Check if we previously cached this glyph already.\r\n+    if (_builtinGlyphsReady[off])\r\n+    {\r\n+        return rectU;\r\n+    }\r\n+\r\n+    static constexpr D2D1_COLOR_F shadeColorMap[] = {\r\n+        { 1, 1, 1, 0.25f }, // Shape_Filled025\r\n+        { 1, 1, 1, 0.50f }, // Shape_Filled050\r\n+        { 1, 1, 1, 0.75f }, // Shape_Filled075\r\n+        { 1, 1, 1, 1.00f }, // Shape_Filled100\r\n+    };\r\n+\r\n+    if (!_builtinGlyphsRenderTargetActive)\r\n+    {\r\n+        _builtinGlyphsRenderTarget->BeginDraw();\r\n+        _builtinGlyphsRenderTargetActive = true;\r\n+    }\r\n+\r\n+    const auto brush = _brushWithColor(0xffffffff);\r\n+    const D2D1_RECT_F rectF{\r\n+        static_cast<f32>(rectU.left),\r\n+        static_cast<f32>(rectU.top),\r\n+        static_cast<f32>(rectU.right),\r\n+        static_cast<f32>(rectU.bottom),\r\n+    };\r\n+    BuiltinGlyphs::DrawBuiltinGlyph(p.d2dFactory.get(), _builtinGlyphsRenderTarget.get(), brush, shadeColorMap, rectF, ch);\r\n+\r\n+    _builtinGlyphsReady[off] = true;\r\n+    return rectU;\r\n+}\r\n+\r\n+void BackendD2D::_flushBuiltinGlyphs()\r\n+{\r\n+    // If we don't have support for ID2D1SpriteBatch none of the related members will be initialized or used.\r\n+    // We can just early-return in that case.\r\n+    if (!_builtinGlyphBatch)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    if (_builtinGlyphsRenderTargetActive)\r\n+    {\r\n+        THROW_IF_FAILED(_builtinGlyphsRenderTarget->EndDraw());\r\n+        _builtinGlyphsRenderTargetActive = false;\r\n+    }\r\n+\r\n+    if (const auto count = _builtinGlyphBatch->GetSpriteCount(); count > 0)\r\n+    {\r\n+        _renderTarget4->SetAntialiasMode(D2D1_ANTIALIAS_MODE_ALIASED);\r\n+        _renderTarget4->DrawSpriteBatch(_builtinGlyphBatch.get(), 0, count, _builtinGlyphsBitmap.get(), D2D1_BITMAP_INTERPOLATION_MODE_NEAREST_NEIGHBOR, D2D1_SPRITE_OPTIONS_NONE);\r\n+        _renderTarget4->SetAntialiasMode(D2D1_ANTIALIAS_MODE_PER_PRIMITIVE);\r\n+        _builtinGlyphBatch->Clear();\r\n+    }\r\n+}\r\n+\r\n f32 BackendD2D::_drawTextPrepareLineRendition(const RenderingPayload& p, const ShapedRow* row, f32 baselineY) const noexcept\r\n {\r\n     const auto lineRendition = row->lineRendition;\r\n@@ -410,44 +572,118 @@ f32r BackendD2D::_getGlyphRunDesignBounds(const DWRITE_GLYPH_RUN& glyphRun, f32\n \r\n void BackendD2D::_drawGridlineRow(const RenderingPayload& p, const ShapedRow* row, u16 y)\r\n {\r\n-    const auto widthShift = gsl::narrow_cast<u8>(row->lineRendition != LineRendition::SingleWidth);\r\n-    const auto cellSize = p.s->font->cellSize;\r\n-    const auto rowTop = gsl::narrow_cast<i16>(cellSize.y * y);\r\n-    const auto rowBottom = gsl::narrow_cast<i16>(rowTop + cellSize.y);\r\n-    const auto textCellCenter = row->lineRendition == LineRendition::DoubleHeightTop ? rowBottom : rowTop;\r\n+    const auto cellWidth = static_cast<f32>(p.s->font->cellSize.x);\r\n+    const auto cellHeight = static_cast<f32>(p.s->font->cellSize.y);\r\n+    const auto rowTop = cellHeight * y;\r\n+    const auto rowBottom = rowTop + cellHeight;\r\n+    const auto cellCenter = row->lineRendition == LineRendition::DoubleHeightTop ? rowBottom : rowTop;\r\n+    const auto scaleHorizontal = row->lineRendition != LineRendition::SingleWidth ? 0.5f : 1.0f;\r\n+    const auto scaledCellWidth = cellWidth * scaleHorizontal;\r\n \r\n     const auto appendVerticalLines = [&](const GridLineRange& r, FontDecorationPosition pos) {\r\n-        const auto from = r.from >> widthShift;\r\n-        const auto to = r.to >> widthShift;\r\n+        const auto from = r.from * scaledCellWidth;\r\n+        const auto to = r.to * scaledCellWidth;\r\n+        auto x = from + pos.position;\r\n \r\n-        auto posX = from * cellSize.x + pos.position;\r\n-        const auto end = to * cellSize.x;\r\n-\r\n-        D2D1_POINT_2F point0{ 0, static_cast<f32>(textCellCenter) };\r\n-        D2D1_POINT_2F point1{ 0, static_cast<f32>(textCellCenter + cellSize.y) };\r\n+        D2D1_POINT_2F point0{ 0, cellCenter };\r\n+        D2D1_POINT_2F point1{ 0, cellCenter + cellHeight };\r\n         const auto brush = _brushWithColor(r.gridlineColor);\r\n         const f32 w = pos.height;\r\n         const f32 hw = w * 0.5f;\r\n \r\n-        for (; posX < end; posX += cellSize.x)\r\n+        for (; x < to; x += cellWidth)\r\n         {\r\n-            const auto centerX = posX + hw;\r\n+            const auto centerX = x + hw;\r\n             point0.x = centerX;\r\n             point1.x = centerX;\r\n             _renderTarget->DrawLine(point0, point1, brush, w, nullptr);\r\n         }\r\n     };\r\n     const auto appendHorizontalLine = [&](const GridLineRange& r, FontDecorationPosition pos, ID2D1StrokeStyle* strokeStyle, const u32 color) {\r\n-        const auto from = r.from >> widthShift;\r\n-        const auto to = r.to >> widthShift;\r\n+        const auto from = r.from * scaledCellWidth;\r\n+        const auto to = r.to * scaledCellWidth;\r\n \r\n         const auto brush = _brushWithColor(color);\r\n         const f32 w = pos.height;\r\n-        const f32 centerY = textCellCenter + pos.position + w * 0.5f;\r\n-        const D2D1_POINT_2F point0{ static_cast<f32>(from * cellSize.x), centerY };\r\n-        const D2D1_POINT_2F point1{ static_cast<f32>(to * cellSize.x), centerY };\r\n+        const f32 centerY = cellCenter + pos.position + w * 0.5f;\r\n+        const D2D1_POINT_2F point0{ from, centerY };\r\n+        const D2D1_POINT_2F point1{ to, centerY };\r\n         _renderTarget->DrawLine(point0, point1, brush, w, strokeStyle);\r\n     };\r\n+    const auto appendCurlyLine = [&](const GridLineRange& r) {\r\n+        const auto& font = *p.s->font;\r\n+\r\n+        const auto duTop = static_cast<f32>(font.doubleUnderline[0].position);\r\n+        const auto duBottom = static_cast<f32>(font.doubleUnderline[1].position);\r\n+        // The double-underline height is also our target line width.\r\n+        const auto duHeight = static_cast<f32>(font.doubleUnderline[0].height);\r\n+\r\n+        // This gives it the same position and height as our double-underline. There's no particular reason for that, apart from\r\n+        // it being simple to implement and robust against more peculiar fonts with unusually large/small descenders, etc.\r\n+        // We still need to ensure though that it doesn't clip out of the cellHeight at the bottom, which is why `position` has a min().\r\n+        const auto height = std::max(3.0f, duBottom + duHeight - duTop);\r\n+        const auto position = std::min(duTop, cellHeight - height - duHeight);\r\n+\r\n+        // The amplitude of the wave needs to account for the stroke width, so that the final height including\r\n+        // antialiasing isn't larger than our target `height`. That's why we calculate `(height - duHeight)`.\r\n+        //\r\n+        // In other words, Direct2D draws strokes centered on the path. This also means that (for instance)\r\n+        // for a line width of 1px, we need to ensure that the amplitude passes through the center of a pixel.\r\n+        // Because once the path gets stroked, it'll occupy half a pixel on either side of the path.\r\n+        // This results in a \"crisp\" look. That's why we do `round(amp + half) - half`.\r\n+        const auto halfLineWidth = 0.5f * duHeight;\r\n+        const auto amplitude = roundf((height - duHeight) * 0.5f + halfLineWidth) - halfLineWidth;\r\n+        // While the amplitude needs to account for the stroke width, the vertical center of the wave needs\r\n+        // to be at an integer pixel position of course. Otherwise, the wave won't be vertically symmetric.\r\n+        const auto center = cellCenter + position + amplitude + halfLineWidth;\r\n+\r\n+        const auto top = center - 2.0f * amplitude;\r\n+        const auto bottom = center + 2.0f * amplitude;\r\n+        const auto step = 0.5f * height;\r\n+        const auto period = 4.0f * step;\r\n+\r\n+        const auto from = r.from * scaledCellWidth;\r\n+        const auto to = r.to * scaledCellWidth;\r\n+        // Align the start of the wave to the nearest preceding period boundary.\r\n+        // This ensures that the wave is continuous across color and cell changes.\r\n+        auto x = floorf(from / period) * period;\r\n+\r\n+        wil::com_ptr<ID2D1PathGeometry> geometry;\r\n+        THROW_IF_FAILED(p.d2dFactory->CreatePathGeometry(geometry.addressof()));\r\n+\r\n+        wil::com_ptr<ID2D1GeometrySink> sink;\r\n+        THROW_IF_FAILED(geometry->Open(sink.addressof()));\r\n+\r\n+        // This adds complete periods of the wave until we reach the end of the range.\r\n+        sink->BeginFigure({ x, center }, D2D1_FIGURE_BEGIN_HOLLOW);\r\n+        for (D2D1_QUADRATIC_BEZIER_SEGMENT segment; x < to;)\r\n+        {\r\n+            x += step;\r\n+            segment.point1.x = x;\r\n+            segment.point1.y = top;\r\n+            x += step;\r\n+            segment.point2.x = x;\r\n+            segment.point2.y = center;\r\n+            sink->AddQuadraticBezier(&segment);\r\n+\r\n+            x += step;\r\n+            segment.point1.x = x;\r\n+            segment.point1.y = bottom;\r\n+            x += step;\r\n+            segment.point2.x = x;\r\n+            segment.point2.y = center;\r\n+            sink->AddQuadraticBezier(&segment);\r\n+        }\r\n+        sink->EndFigure(D2D1_FIGURE_END_OPEN);\r\n+\r\n+        THROW_IF_FAILED(sink->Close());\r\n+\r\n+        const auto brush = _brushWithColor(r.underlineColor);\r\n+        const D2D1_RECT_F clipRect{ from, rowTop, to, rowBottom };\r\n+        _renderTarget->PushAxisAlignedClip(&clipRect, D2D1_ANTIALIAS_MODE_ALIASED);\r\n+        _renderTarget->DrawGeometry(geometry.get(), brush, duHeight, nullptr);\r\n+        _renderTarget->PopAxisAlignedClip();\r\n+    };\r\n \r\n     for (const auto& r : row->gridLineRanges)\r\n     {\r\n@@ -481,8 +717,28 @@ void BackendD2D::_drawGridlineRow(const RenderingPayload& p, const ShapedRow* ro\n         }\r\n         else if (r.lines.any(GridLines::DottedUnderline, GridLines::HyperlinkUnderline))\r\n         {\r\n+            if (!_dottedStrokeStyle)\r\n+            {\r\n+                static constexpr D2D1_STROKE_STYLE_PROPERTIES props{ .dashStyle = D2D1_DASH_STYLE_CUSTOM };\r\n+                static constexpr FLOAT dashes[2]{ 1, 1 };\r\n+                THROW_IF_FAILED(p.d2dFactory->CreateStrokeStyle(&props, &dashes[0], 2, _dottedStrokeStyle.addressof()));\r\n+            }\r\n             appendHorizontalLine(r, p.s->font->underline, _dottedStrokeStyle.get(), r.underlineColor);\r\n         }\r\n+        else if (r.lines.test(GridLines::DashedUnderline))\r\n+        {\r\n+            if (!_dashedStrokeStyle)\r\n+            {\r\n+                static constexpr D2D1_STROKE_STYLE_PROPERTIES props{ .dashStyle = D2D1_DASH_STYLE_CUSTOM };\r\n+                static constexpr FLOAT dashes[2]{ 2, 2 };\r\n+                THROW_IF_FAILED(p.d2dFactory->CreateStrokeStyle(&props, &dashes[0], 2, _dashedStrokeStyle.addressof()));\r\n+            }\r\n+            appendHorizontalLine(r, p.s->font->underline, _dashedStrokeStyle.get(), r.underlineColor);\r\n+        }\r\n+        else if (r.lines.test(GridLines::CurlyUnderline))\r\n+        {\r\n+            appendCurlyLine(r);\r\n+        }\r\n         else if (r.lines.test(GridLines::DoubleUnderline))\r\n         {\r\n             for (const auto pos : p.s->font->doubleUnderline)\r\ndiff --git a/src/renderer/atlas/BackendD2D.h b/src/renderer/atlas/BackendD2D.h\nindex e6993d60603..4206390ea52 100644\n--- a/src/renderer/atlas/BackendD2D.h\n+++ b/src/renderer/atlas/BackendD2D.h\n@@ -3,9 +3,8 @@\n \r\n #pragma once\r\n \r\n-#include <til/flat_set.h>\r\n-\r\n #include \"Backend.h\"\r\n+#include \"BuiltinGlyphs.h\"\r\n \r\n namespace Microsoft::Console::Render::Atlas\r\n {\r\n@@ -19,6 +18,10 @@ namespace Microsoft::Console::Render::Atlas\n         ATLAS_ATTR_COLD void _handleSettingsUpdate(const RenderingPayload& p);\r\n         void _drawBackground(const RenderingPayload& p);\r\n         void _drawText(RenderingPayload& p);\r\n+        ATLAS_ATTR_COLD f32 _drawBuiltinGlyphs(const RenderingPayload& p, const ShapedRow* row, const FontMapping& m, f32 baselineY, f32 baselineX);\r\n+        void _prepareBuiltinGlyphRenderTarget(const RenderingPayload& p);\r\n+        D2D1_RECT_U _prepareBuiltinGlyph(const RenderingPayload& p, char32_t ch, u32 off);\r\n+        void _flushBuiltinGlyphs();\r\n         ATLAS_ATTR_COLD f32 _drawTextPrepareLineRendition(const RenderingPayload& p, const ShapedRow* row, f32 baselineY) const noexcept;\r\n         ATLAS_ATTR_COLD void _drawTextResetLineRendition(const ShapedRow* row) const noexcept;\r\n         ATLAS_ATTR_COLD f32r _getGlyphRunDesignBounds(const DWRITE_GLYPH_RUN& glyphRun, f32 baselineX, f32 baselineY);\r\n@@ -37,10 +40,18 @@ namespace Microsoft::Console::Render::Atlas\n         wil::com_ptr<ID2D1DeviceContext> _renderTarget;\r\n         wil::com_ptr<ID2D1DeviceContext4> _renderTarget4; // Optional. Supported since Windows 10 14393.\r\n         wil::com_ptr<ID2D1StrokeStyle> _dottedStrokeStyle;\r\n+        wil::com_ptr<ID2D1StrokeStyle> _dashedStrokeStyle;\r\n         wil::com_ptr<ID2D1Bitmap> _backgroundBitmap;\r\n         wil::com_ptr<ID2D1BitmapBrush> _backgroundBrush;\r\n         til::generation_t _backgroundBitmapGeneration;\r\n \r\n+        wil::com_ptr<ID2D1DeviceContext> _builtinGlyphsRenderTarget;\r\n+        wil::com_ptr<ID2D1Bitmap> _builtinGlyphsBitmap;\r\n+        wil::com_ptr<ID2D1SpriteBatch> _builtinGlyphBatch;\r\n+        u32 _builtinGlyphsBitmapCellCountU = 0;\r\n+        bool _builtinGlyphsRenderTargetActive = false;\r\n+        bool _builtinGlyphsReady[BuiltinGlyphs::TotalCharCount]{};\r\n+\r\n         wil::com_ptr<ID2D1Bitmap> _cursorBitmap;\r\n         til::size _cursorBitmapSize; // in columns/rows\r\n \r\ndiff --git a/src/renderer/atlas/BackendD3D.cpp b/src/renderer/atlas/BackendD3D.cpp\nindex fe07271c16a..d85d6e0365f 100644\n--- a/src/renderer/atlas/BackendD3D.cpp\n+++ b/src/renderer/atlas/BackendD3D.cpp\n@@ -295,20 +295,20 @@ void BackendD3D::_updateFontDependents(const RenderingPayload& p)\n     // baseline of curlyline is at the middle of singly underline. When there's\r\n     // limited space to draw a curlyline, we apply a limit on the peak height.\r\n     {\r\n-        const auto cellHeight = static_cast<f32>(font.cellSize.y);\r\n-        const auto duTop = static_cast<f32>(font.doubleUnderline[0].position);\r\n-        const auto duBottom = static_cast<f32>(font.doubleUnderline[1].position);\r\n-        const auto duHeight = static_cast<f32>(font.doubleUnderline[0].height);\r\n+        const int cellHeight = font.cellSize.y;\r\n+        const int duTop = font.doubleUnderline[0].position;\r\n+        const int duBottom = font.doubleUnderline[1].position;\r\n+        const int duHeight = font.doubleUnderline[0].height;\r\n \r\n         // This gives it the same position and height as our double-underline. There's no particular reason for that, apart from\r\n         // it being simple to implement and robust against more peculiar fonts with unusually large/small descenders, etc.\r\n-        // We still need to ensure though that it doesn't clip out of the cellHeight at the bottom.\r\n-        const auto height = std::max(3.0f, duBottom + duHeight - duTop);\r\n-        const auto top = std::min(duTop, floorf(cellHeight - height - duHeight));\r\n+        // We still need to ensure though that it doesn't clip out of the cellHeight at the bottom, which is why `position` has a min().\r\n+        const auto height = std::max(3, duBottom + duHeight - duTop);\r\n+        const auto position = std::min(duTop, cellHeight - height - duHeight);\r\n \r\n         _curlyLineHalfHeight = height * 0.5f;\r\n-        _curlyUnderline.position = gsl::narrow_cast<u16>(lrintf(top));\r\n-        _curlyUnderline.height = gsl::narrow_cast<u16>(lrintf(height));\r\n+        _curlyUnderline.position = gsl::narrow_cast<u16>(position);\r\n+        _curlyUnderline.height = gsl::narrow_cast<u16>(height);\r\n     }\r\n \r\n     DWrite_GetRenderParams(p.dwriteFactory.get(), &_gamma, &_cleartypeEnhancedContrast, &_grayscaleEnhancedContrast, _textRenderingParams.put());\r\n@@ -1509,7 +1509,19 @@ BackendD3D::AtlasGlyphEntry* BackendD3D::_drawBuiltinGlyph(const RenderingPayloa\n     }\r\n     else\r\n     {\r\n-        BuiltinGlyphs::DrawBuiltinGlyph(p.d2dFactory.get(), _d2dRenderTarget.get(), _brush.get(), r, glyphIndex);\r\n+        // This code works in tandem with SHADING_TYPE_TEXT_BUILTIN_GLYPH in our pixel shader.\r\n+        // Unless someone removed it, it should have a lengthy comment visually explaining\r\n+        // what each of the 3 RGB components do. The short version is:\r\n+        //   R: stretch the checkerboard pattern (Shape_Filled050) horizontally\r\n+        //   G: invert the pixels\r\n+        //   B: overrides the above and fills it\r\n+        static constexpr D2D1_COLOR_F shadeColorMap[] = {\r\n+            { 1, 0, 0, 1 }, // Shape_Filled025\r\n+            { 0, 0, 0, 1 }, // Shape_Filled050\r\n+            { 1, 1, 0, 1 }, // Shape_Filled075\r\n+            { 1, 1, 1, 1 }, // Shape_Filled100\r\n+        };\r\n+        BuiltinGlyphs::DrawBuiltinGlyph(p.d2dFactory.get(), _d2dRenderTarget.get(), _brush.get(), shadeColorMap, r, glyphIndex);\r\n         shadingType = ShadingType::TextBuiltinGlyph;\r\n     }\r\n \r\ndiff --git a/src/renderer/atlas/BuiltinGlyphs.cpp b/src/renderer/atlas/BuiltinGlyphs.cpp\nindex c46bfc01fc0..92d87bc0b45 100644\n--- a/src/renderer/atlas/BuiltinGlyphs.cpp\n+++ b/src/renderer/atlas/BuiltinGlyphs.cpp\n@@ -135,8 +135,6 @@ inline constexpr f32 Pos_Lut[][2] = {\n     /* Pos_11_12       */ { 11.0f / 12.0f, 0.0f },\n };\n \n-static constexpr char32_t BoxDrawing_FirstChar = 0x2500;\n-static constexpr u32 BoxDrawing_CharCount = 0xA0;\n static constexpr Instruction BoxDrawing[BoxDrawing_CharCount][InstructionsPerGlyph] = {\n     // U+2500 \u2500 BOX DRAWINGS LIGHT HORIZONTAL\n     {\n@@ -964,8 +962,6 @@ static constexpr Instruction BoxDrawing[BoxDrawing_CharCount][InstructionsPerGly\n     },\n };\n \n-static constexpr char32_t Powerline_FirstChar = 0xE0B0;\n-static constexpr u32 Powerline_CharCount = 0x10;\n static constexpr Instruction Powerline[Powerline_CharCount][InstructionsPerGlyph] = {\n     // U+E0B0 Right triangle solid\n     {\n@@ -1071,7 +1067,20 @@ static const Instruction* GetInstructions(char32_t codepoint) noexcept\n     return nullptr;\n }\n \n-void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_RECT_F& rect, char32_t codepoint)\n+i32 BuiltinGlyphs::GetBitmapCellIndex(char32_t codepoint) noexcept\n+{\n+    if (BoxDrawing_IsMapped(codepoint))\n+    {\n+        return codepoint - BoxDrawing_FirstChar;\n+    }\n+    if (Powerline_IsMapped(codepoint))\n+    {\n+        return codepoint - Powerline_FirstChar + BoxDrawing_CharCount;\n+    }\n+    return -1;\n+}\n+\n+void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_COLOR_F (&shadeColorMap)[4], const D2D1_RECT_F& rect, char32_t codepoint)\n {\n     renderTarget->PushAxisAlignedClip(&rect, D2D1_ANTIALIAS_MODE_ALIASED);\n     const auto restoreD2D = wil::scope_exit([&]() {\n@@ -1122,15 +1131,18 @@ void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext*\n         const auto lineOffsetX = isHollowRect || isLineX ? lineWidthHalf : 0.0f;\n         const auto lineOffsetY = isHollowRect || isLineY ? lineWidthHalf : 0.0f;\n \n-        begX = roundf(begX - lineOffsetX) + lineOffsetX;\n-        begY = roundf(begY - lineOffsetY) + lineOffsetY;\n-        endX = roundf(endX + lineOffsetX) - lineOffsetX;\n-        endY = roundf(endY + lineOffsetY) - lineOffsetY;\n-\n-        const auto begXabs = begX + rectX;\n-        const auto begYabs = begY + rectY;\n-        const auto endXabs = endX + rectX;\n-        const auto endYabs = endY + rectY;\n+        // Direct2D draws strokes centered on the path. In order to make them pixel-perfect we need to round the\n+        // coordinates to whole pixels, but offset by half the stroke width (= the radius of the stroke).\n+        //\n+        // All floats up to this point will be highly \"consistent\" between different `rect`s of identical size and\n+        // different shapes, because the above calculations work with only a small set of constant floats.\n+        // However, the addition of a potentially fractional begX/Y with a highly variable `rect` position is different.\n+        // Rounding beg/endX/Y first ensures that we continue to get a consistent behavior between calls.\n+        // This is particularly noticeable at smaller font sizes, where the line width is just a pixel or two.\n+        const auto begXabs = rectX + roundf(begX - lineOffsetX) + lineOffsetX;\n+        const auto begYabs = rectY + roundf(begY - lineOffsetY) + lineOffsetY;\n+        const auto endXabs = rectX + roundf(endX + lineOffsetX) - lineOffsetX;\n+        const auto endYabs = rectY + roundf(endY + lineOffsetY) - lineOffsetY;\n \n         switch (shape)\n         {\n@@ -1139,21 +1151,8 @@ void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext*\n         case Shape_Filled075:\n         case Shape_Filled100:\n         {\n-            // This code works in tandem with SHADING_TYPE_TEXT_BUILTIN_GLYPH in our pixel shader.\n-            // Unless someone removed it, it should have a lengthy comment visually explaining\n-            // what each of the 3 RGB components do. The short version is:\n-            //   R: stretch the checkerboard pattern (Shape_Filled050) horizontally\n-            //   G: invert the pixels\n-            //   B: overrides the above and fills it\n-            static constexpr D2D1_COLOR_F colors[] = {\n-                { 1, 0, 0, 1 }, // Shape_Filled025\n-                { 0, 0, 0, 1 }, // Shape_Filled050\n-                { 1, 1, 0, 1 }, // Shape_Filled075\n-                { 1, 1, 1, 1 }, // Shape_Filled100\n-            };\n-\n             const auto brushColor = brush->GetColor();\n-            brush->SetColor(&colors[shape]);\n+            brush->SetColor(&shadeColorMap[shape]);\n \n             const D2D1_RECT_F r{ begXabs, begYabs, endXabs, endYabs };\n             renderTarget->FillRectangle(&r, brush);\n@@ -1183,13 +1182,13 @@ void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext*\n         }\n         case Shape_FilledEllipsis:\n         {\n-            const D2D1_ELLIPSE e{ { begXabs, begYabs }, endX, endY };\n+            const D2D1_ELLIPSE e{ { rectX + begX, rectY + begY }, endX, endY };\n             renderTarget->FillEllipse(&e, brush);\n             break;\n         }\n         case Shape_EmptyEllipsis:\n         {\n-            const D2D1_ELLIPSE e{ { begXabs, begYabs }, endX, endY };\n+            const D2D1_ELLIPSE e{ { rectX + begX, rectY + begY }, endX, endY };\n             renderTarget->DrawEllipse(&e, brush, lineWidth, nullptr);\n             break;\n         }\ndiff --git a/src/renderer/atlas/BuiltinGlyphs.h b/src/renderer/atlas/BuiltinGlyphs.h\nindex f399653893c..b6cce3a3974 100644\n--- a/src/renderer/atlas/BuiltinGlyphs.h\n+++ b/src/renderer/atlas/BuiltinGlyphs.h\n@@ -8,7 +8,17 @@\n namespace Microsoft::Console::Render::Atlas::BuiltinGlyphs\r\n {\r\n     bool IsBuiltinGlyph(char32_t codepoint) noexcept;\r\n-    void DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_RECT_F& rect, char32_t codepoint);\r\n+    void DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_COLOR_F (&shadeColorMap)[4], const D2D1_RECT_F& rect, char32_t codepoint);\r\n+\r\n+    inline constexpr char32_t BoxDrawing_FirstChar = 0x2500;\r\n+    inline constexpr u32 BoxDrawing_CharCount = 0xA0;\r\n+\r\n+    inline constexpr char32_t Powerline_FirstChar = 0xE0B0;\r\n+    inline constexpr u32 Powerline_CharCount = 0x10;\r\n+\r\n+    inline constexpr u32 TotalCharCount = BoxDrawing_CharCount + Powerline_CharCount;\r\n+\r\n+    i32 GetBitmapCellIndex(char32_t codepoint) noexcept;\r\n \r\n     // This is just an extra. It's not actually implemented as part of BuiltinGlyphs.cpp.\r\n     constexpr bool IsSoftFontChar(char32_t ch) noexcept\r\ndiff --git a/src/tools/RenderingTests/main.cpp b/src/tools/RenderingTests/main.cpp\nindex 45dfcf66ea7..2d0ef8612a4 100644\n--- a/src/tools/RenderingTests/main.cpp\n+++ b/src/tools/RenderingTests/main.cpp\n@@ -108,15 +108,15 @@ static void printfUTF16(_In_z_ _Printf_format_string_ wchar_t const* const forma\n \r\n static void wait()\r\n {\r\n-    printUTF16(L\"\\x1B[9999;1HPress any key to continue...\");\r\n+    printUTF16(L\"\\x1b[9999;1HPress any key to continue...\");\r\n     _getch();\r\n }\r\n \r\n static void clear()\r\n {\r\n     printUTF16(\r\n-        L\"\\x1B[H\" // move cursor to 0,0\r\n-        L\"\\x1B[2J\" // clear screen\r\n+        L\"\\x1b[H\" // move cursor to 0,0\r\n+        L\"\\x1b[2J\" // clear screen\r\n     );\r\n }\r\n \r\n@@ -166,7 +166,7 @@ int main()\n             for (const auto& t : consoleAttributeTests)\r\n             {\r\n                 const auto length = static_cast<DWORD>(wcslen(t.text));\r\n-                printfUTF16(L\"\\x1B[%d;5H%s\", row + 1, t.text);\r\n+                printfUTF16(L\"\\x1b[%d;5H%s\", row + 1, t.text);\r\n \r\n                 WORD attributes[32];\r\n                 std::fill_n(&attributes[0], length, static_cast<WORD>(FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED | t.attribute));\r\n@@ -190,16 +190,16 @@ int main()\n                 { L\"overlined\", 53 },\r\n             };\r\n \r\n-            printfUTF16(L\"\\x1B[3;39HANSI escape SGR:\");\r\n+            printfUTF16(L\"\\x1b[3;39HANSI escape SGR:\");\r\n \r\n             int row = 5;\r\n             for (const auto& t : basicSGR)\r\n             {\r\n-                printfUTF16(L\"\\x1B[%d;39H\\x1b[%dm%s\\x1b[m\", row, t.attribute, t.text);\r\n+                printfUTF16(L\"\\x1b[%d;39H\\x1b[%dm%s\\x1b[m\", row, t.attribute, t.text);\r\n                 row += 2;\r\n             }\r\n \r\n-            printfUTF16(L\"\\x1B[%d;39H\\x1b]8;;https://example.com\\x1b\\\\hyperlink\\x1b]8;;\\x1b\\\\\", row);\r\n+            printfUTF16(L\"\\x1b[%d;39H\\x1b]8;;https://example.com\\x1b\\\\hyperlink\\x1b]8;;\\x1b\\\\\", row);\r\n         }\r\n \r\n         {\r\n@@ -211,18 +211,18 @@ int main()\n                 { L\"dashed\", 5 },\r\n             };\r\n \r\n-            printfUTF16(L\"\\x1B[3;63HStyled Underlines:\");\r\n+            printfUTF16(L\"\\x1b[3;63HStyled Underlines:\");\r\n \r\n             int row = 5;\r\n             for (const auto& t : styledUnderlines)\r\n             {\r\n-                printfUTF16(L\"\\x1B[%d;63H\\x1b[4:%dm\", row, t.attribute);\r\n+                printfUTF16(L\"\\x1b[%d;63H\\x1b[4:%dm\", row, t.attribute);\r\n \r\n                 const auto len = wcslen(t.text);\r\n                 for (size_t i = 0; i < len; ++i)\r\n                 {\r\n                     const auto color = colorbrewer::pastel1[i % std::size(colorbrewer::pastel1)];\r\n-                    printfUTF16(L\"\\x1B[58:2::%d:%d:%dm%c\", (color >> 16) & 0xff, (color >> 8) & 0xff, color & 0xff, t.text[i]);\r\n+                    printfUTF16(L\"\\x1b[58:2::%d:%d:%dm%c\", (color >> 16) & 0xff, (color >> 8) & 0xff, color & 0xff, t.text[i]);\r\n                 }\r\n \r\n                 printfUTF16(L\"\\x1b[m\");\r\n@@ -236,19 +236,19 @@ int main()\n \r\n     {\r\n         printUTF16(\r\n-            L\"\\x1B[3;5HDECDWL Double Width \\U0001FAE0 \\x1B[45;92mA\\u0353\\u0353\\x1B[m B\\u036F\\u036F\"\r\n-            L\"\\x1B[4;3H\\x1b#6DECDWL Double Width         \\U0001FAE0 \\x1B[45;92mA\\u0353\\u0353\\x1B[m B\\u036F\\u036F\"\r\n-            L\"\\x1B[7;5HDECDHL Double Height \\U0001F952\\U0001F6C1 A\\u0353\\u0353 \\x1B[45;92mB\\u036F\\u036F\\x1B[m \\x1B[45;92mX\\u0353\\u0353\\x1B[m Y\\u036F\\u036F\"\r\n-            L\"\\x1B[8;3H\\x1b#3DECDHL Double Height Top    \\U0001F952 A\\u0353\\u0353 \\x1B[45;92mB\\u036F\\u036F\\x1B[m\"\r\n-            L\"\\x1B[9;3H\\x1b#4DECDHL Double Height Bottom \\U0001F6C1 \\x1B[45;92mX\\u0353\\u0353\\x1B[m Y\\u036F\\u036F\"\r\n-            L\"\\x1B[13;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[15;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n-            L\"\\x1B[17;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[19;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n-            L\"\\x1B[21;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[22;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[24;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n-            L\"\\x1B[25;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\");\r\n+            L\"\\x1b[3;5HDECDWL Double Width \\U0001FAE0 \\x1b[45;92mA\\u0353\\u0353\\x1b[m B\\u036F\\u036F\"\r\n+            L\"\\x1b[4;3H\\x1b#6DECDWL Double Width         \\U0001FAE0 \\x1b[45;92mA\\u0353\\u0353\\x1b[m B\\u036F\\u036F\"\r\n+            L\"\\x1b[7;5HDECDHL Double Height \\U0001F952\\U0001F6C1 A\\u0353\\u0353 \\x1b[45;92mB\\u036F\\u036F\\x1b[m \\x1b[45;92mX\\u0353\\u0353\\x1b[m Y\\u036F\\u036F\"\r\n+            L\"\\x1b[8;3H\\x1b#3DECDHL Double Height Top    \\U0001F952 A\\u0353\\u0353 \\x1b[45;92mB\\u036F\\u036F\\x1b[m\"\r\n+            L\"\\x1b[9;3H\\x1b#4DECDHL Double Height Bottom \\U0001F6C1 \\x1b[45;92mX\\u0353\\u0353\\x1b[m Y\\u036F\\u036F\"\r\n+            L\"\\x1b[12;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[14;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n+            L\"\\x1b[16;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[18;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n+            L\"\\x1b[20;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[21;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[23;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n+            L\"\\x1b[24;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\");\r\n \r\n         static constexpr WORD attributes[]{\r\n             FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED | COMMON_LVB_GRID_HORIZONTAL,\r\n@@ -264,7 +264,7 @@ int main()\n         DWORD numberOfAttrsWritten;\r\n         DWORD offset = 0;\r\n \r\n-        for (const auto r : { 12, 14, 16, 18, 20, 21, 23, 24 })\r\n+        for (const auto r : { 11, 13, 15, 17, 19, 20, 22, 23 })\r\n         {\r\n             COORD coord;\r\n             coord.X = r > 14 ? 2 : 4;\r\n@@ -338,14 +338,14 @@ int main()\n \r\n #define DRCS_SEQUENCE L\"\\x1b( @#\\x1b(A\"\r\n         printUTF16(\r\n-            L\"\\x1B[3;5HDECDLD and DRCS test - it should show \\\"WT\\\" in a single cell\"\r\n-            L\"\\x1B[5;5HRegular: \" DRCS_SEQUENCE L\"\"\r\n-            L\"\\x1B[7;3H\\x1b#6DECDWL: \" DRCS_SEQUENCE L\"\"\r\n-            L\"\\x1B[9;3H\\x1b#3DECDHL: \" DRCS_SEQUENCE L\"\"\r\n-            L\"\\x1B[10;3H\\x1b#4DECDHL: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[3;5HDECDLD and DRCS test - it should show \\\"WT\\\" in a single cell\"\r\n+            L\"\\x1b[5;5HRegular: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[7;3H\\x1b#6DECDWL: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[9;3H\\x1b#3DECDHL: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[10;3H\\x1b#4DECDHL: \" DRCS_SEQUENCE L\"\"\r\n             // We map soft fonts into the private use area starting at U+EF20. This test ensures\r\n             // that we correctly map actual fallback glyphs mixed into the DRCS glyphs.\r\n-            L\"\\x1B[12;5HUnicode Fallback: \\uE000\\uE001\" DRCS_SEQUENCE L\"\\uE003\\uE004\");\r\n+            L\"\\x1b[12;5HUnicode Fallback: \\uE000\\uE001\" DRCS_SEQUENCE L\"\\uE003\\uE004\");\r\n #undef DRCS_SEQUENCE\r\n \r\n         wait();\r\n", "instance_id": "microsoft__terminal-17278", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: there are visible gaps between block elements when using Direct2D in Windows Terminal, which should ideally render as a solid bar. The goal (fusing block elements into a solid bar), the environment (Windows Terminal version, build number, and settings), and steps to reproduce are provided with sufficient detail, including images for expected and actual behavior. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the constraints or edge cases (e.g., specific Unicode ranges, font configurations, or scaling factors beyond 100%) that might affect the rendering. Additionally, while the expected behavior is described, there is no mention of potential trade-offs or performance considerations for the fix. Overall, the statement is valid and clear but lacks some depth in specifying edge cases or broader implications, warranting a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75 (Hard) to this problem based on the following analysis of the factors:\n\n1. **Scope and Depth of Code Changes**: The code changes span multiple files (`AtlasEngine.cpp`, `AtlasEngine.h`, `BackendD2D.cpp`, `BackendD2D.h`, `BackendD3D.cpp`, `BuiltinGlyphs.cpp`, `BuiltinGlyphs.h`, and `RenderingTests/main.cpp`), indicating a broad impact across the rendering subsystem of Windows Terminal. The modifications involve significant refactoring, such as removing hacky workarounds (e.g., `_hackIsBackendD2D`, `_hackWantsBuiltinGlyphs`) and introducing new rendering logic for built-in glyphs using `ID2D1SpriteBatch` in Direct2D. This requires understanding and altering interactions between the `AtlasEngine` and backend rendering implementations (`BackendD2D` and `BackendD3D`), which suggests a deep impact on the rendering architecture.\n\n2. **Number of Technical Concepts**: Solving this problem demands familiarity with several advanced concepts, including Direct2D and Direct3D rendering APIs, glyph rendering and text shaping, Unicode handling (e.g., surrogate pairs), and Windows-specific graphics programming. The changes involve intricate handling of bitmap rendering for built-in glyphs, sprite batching, and pixel-perfect rendering techniques (e.g., adjusting for stroke width and antialiasing). Additionally, domain-specific knowledge of terminal rendering (e.g., line renditions, grid lines, and ANSI escape sequences) is required. These concepts are complex and necessitate a strong background in graphics programming.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes reveal several implicit considerations, such as handling different font sizes, cell dimensions, Unicode codepoints (including surrogates), and fallback scenarios for devices lacking `ID2D1SpriteBatch` support. The implementation also addresses rendering precision (e.g., rounding coordinates for pixel-perfect lines) and clipping issues. These edge cases add complexity, as they require careful testing and validation to ensure consistent rendering across diverse configurations.\n\n4. **Overall Complexity**: The combination of architectural changes, advanced graphics programming, and nuanced edge case handling places this problem in the \"Hard\" category. It requires a deep understanding of the Windows Terminal rendering pipeline and the ability to refactor core components without introducing regressions. While it does not reach the \"Very Hard\" level (e.g., no system-level or distributed system challenges), it is still a significant undertaking due to the specialized knowledge and precision required. A score of 0.75 reflects the high difficulty, balancing between complex refactoring and the absence of extreme system-wide implications.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "UI style errors: Menu items capitalization and \u2026 (ellipses) mark misuse\n### Windows Terminal version\r\n\r\n1.20.10572.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.3235\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nDisplay the tab contextual menu, preferably with a second pane open to show all options.\r\n![image](https://github.com/microsoft/terminal/assets/25664275/469f703e-1a8c-4dae-a7d8-ac11a8da44f6)\r\nThere are several problems with this menu.\r\n\r\n### First: Excessive capitalization\r\nIf you check out the style guide: https://learn.microsoft.com/en-us/style-guide/text-formatting/formatting-common-text-elements\r\nYou'll see that `UI text or strings` should use `Sentence-style capitalization`, this is further described at https://learn.microsoft.com/en-us/style-guide/capitalization\r\n```\r\ncapitalize the first word and lowercase the rest.\r\nExceptions: Proper nouns, including brand, product, and service names, are always capitalized.\r\nIf a title or heading includes a colon, capitalize the first word after it.\r\n```\r\n`Tab`, `New`, `Window`, `Right` are not brands, products, or service names, they should not be capitalized.\r\nThis looks worse in other languages as determiners make the capitalized words lose their vertical alignment, as seen in #16819.\r\n\r\n### Second: Misuse of `\u2026` (ellipses)\r\nFrom the Windows UX design guide: https://learn.microsoft.com/en-us/windows/win32/uxguide/text-ui#guidelines\r\n```\r\nEllipses mean incompleteness. Use ellipses in UI text as follows:\r\n\r\nCommands: Indicate that a command needs additional information.\r\nDon't use an ellipsis whenever an action displays another window only when additional information is required.\r\nFor more information, see [Command Buttons](https://learn.microsoft.com/en-us/windows/win32/uxguide/ctrl-command-buttons).\r\n\r\n(\u2026 more details about truncated text, use in data and labels not included here)\r\n```\r\nI know this is getting out of style, but `\u2026` and `>` next to menu items were originally designed to provide predictability.\r\nThe `\u2026` after a menu item means selecting it will display a follow-up dialog or window asking for more options before completing the selected action, while `>` after a menu item means selecting it will display a cascading submenu, finally, neither means selecting it will perform the action immediately.\r\nTherefore, they are mutually exclusive, you cannot have `\u2026` and `>` on the same menu item, clicking it either displays a dialog/window, or a submenu, it cannot do both.\r\n\r\nMore modern Windows UI is trying to get rid of `\u2026` on menu items, trading discoverability and predictability for the sake of visual style, but including it when it doesn't mean a subsequent window will get displayed breaks both the UI guidelines we had since Windows 3.x, and the modern look. Those `Close\u2026` have to go.\r\n\r\nNote the tab contextual menu was taken as an example because it contains all the problems I wanted to mention, but other menus also contain similar errors.\r\n\r\n### Expected Behavior\r\n\r\nUI consistency _(didn't there used to be a UI guidelines check before inclusion as a Windows component?)_.\r\n\r\n### Actual Behavior\r\n\r\nUnpredictability and confusion \ud83e\udd2a\n", "patch": "diff --git a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\nindex 54cd9e9bc30..15b79c40ffc 100644\n--- a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n@@ -191,43 +191,43 @@\n     <value>Multiple panes</value>\r\n   </data>\r\n   <data name=\"TabCloseSubMenu\" xml:space=\"preserve\">\r\n-    <value>Close...</value>\r\n+    <value>Close</value>\r\n   </data>\r\n   <data name=\"TabCloseAfter\" xml:space=\"preserve\">\r\n-    <value>Close Tabs to the Right</value>\r\n+    <value>Close tabs to the right</value>\r\n   </data>\r\n   <data name=\"TabCloseOther\" xml:space=\"preserve\">\r\n-    <value>Close Other Tabs</value>\r\n+    <value>Close other tabs</value>\r\n   </data>\r\n   <data name=\"TabClose\" xml:space=\"preserve\">\r\n-    <value>Close Tab</value>\r\n+    <value>Close tab</value>\r\n   </data>\r\n   <data name=\"PaneClose\" xml:space=\"preserve\">\r\n-    <value>Close Pane</value>\r\n+    <value>Close pane</value>\r\n   </data>\r\n   <data name=\"SplitTabText\" xml:space=\"preserve\">\r\n-    <value>Split Tab</value>\r\n+    <value>Split tab</value>\r\n   </data>\r\n   <data name=\"SplitPaneText\" xml:space=\"preserve\">\r\n-    <value>Split Pane</value>\r\n+    <value>Split pane</value>\r\n   </data>\r\n   <data name=\"SearchWebText\" xml:space=\"preserve\">\r\n-    <value>Web Search</value>\r\n+    <value>Web search</value>\r\n   </data>\r\n   <data name=\"TabColorChoose\" xml:space=\"preserve\">\r\n-    <value>Color...</value>\r\n+    <value>Change tab color</value>\r\n   </data>\r\n   <data name=\"TabColorCustomButton.Content\" xml:space=\"preserve\">\r\n-    <value>Custom...</value>\r\n+    <value>Custom</value>\r\n   </data>\r\n   <data name=\"TabColorClearButton.Content\" xml:space=\"preserve\">\r\n     <value>Reset</value>\r\n   </data>\r\n   <data name=\"RenameTabText\" xml:space=\"preserve\">\r\n-    <value>Rename Tab</value>\r\n+    <value>Rename tab</value>\r\n   </data>\r\n   <data name=\"DuplicateTabText\" xml:space=\"preserve\">\r\n-    <value>Duplicate Tab</value>\r\n+    <value>Duplicate tab</value>\r\n   </data>\r\n   <data name=\"InvalidBackgroundImage\" xml:space=\"preserve\">\r\n     <value>Found a profile with an invalid \"backgroundImage\". Defaulting that profile to have no background image. Make sure that when setting a \"backgroundImage\", the value is a valid file path to an image.</value>\r\n@@ -462,7 +462,7 @@\n     <value>About</value>\r\n   </data>\r\n   <data name=\"AboutDialog.PrimaryButtonText\" xml:space=\"preserve\">\r\n-    <value>Send Feedback</value>\r\n+    <value>Send feedback</value>\r\n   </data>\r\n   <data name=\"AboutDialog.CloseButtonText\" xml:space=\"preserve\">\r\n     <value>OK</value>\r\n@@ -472,11 +472,11 @@\n     <comment>This is the heading for a version number label</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_GettingStartedLink.Content\" xml:space=\"preserve\">\r\n-    <value>Getting Started</value>\r\n+    <value>Getting started</value>\r\n     <comment>A hyperlink name for a guide on how to get started using Terminal</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_SourceCodeLink.Content\" xml:space=\"preserve\">\r\n-    <value>Source Code</value>\r\n+    <value>Source code</value>\r\n     <comment>A hyperlink name for the Terminal's documentation</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_DocumentationLink.Content\" xml:space=\"preserve\">\r\n@@ -484,15 +484,15 @@\n     <comment>A hyperlink name for user documentation</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_ReleaseNotesLink.Content\" xml:space=\"preserve\">\r\n-    <value>Release Notes</value>\r\n+    <value>Release notes</value>\r\n     <comment>A hyperlink name for the Terminal's release notes</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_PrivacyPolicyLink.Content\" xml:space=\"preserve\">\r\n-    <value>Privacy Policy</value>\r\n+    <value>Privacy policy</value>\r\n     <comment>A hyperlink name for the Terminal's privacy policy</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_ThirdPartyNoticesLink.Content\" xml:space=\"preserve\">\r\n-    <value>Third-Party Notices</value>\r\n+    <value>Third-Party notices</value>\r\n     <comment>A hyperlink name for the Terminal's third-party notices</comment>\r\n   </data>\r\n   <data name=\"QuitDialog.CloseButtonText\" xml:space=\"preserve\">\r\n@@ -579,10 +579,10 @@\n     <value>Failed parsing command line:</value>\r\n   </data>\r\n   <data name=\"CommandPaletteControlName\" xml:space=\"preserve\">\r\n-    <value>Command Palette</value>\r\n+    <value>Command palette</value>\r\n   </data>\r\n   <data name=\"TabSwitcherControlName\" xml:space=\"preserve\">\r\n-    <value>Tab Switcher</value>\r\n+    <value>Tab switcher</value>\r\n   </data>\r\n   <data name=\"TabSwitcher_SearchBoxText\" xml:space=\"preserve\">\r\n     <value>Type a tab name...</value>\r\n@@ -731,10 +731,10 @@\n     <value>Maximize</value>\r\n   </data>\r\n   <data name=\"WindowRestoreDownButtonToolTip\" xml:space=\"preserve\">\r\n-    <value>Restore Down</value>\r\n+    <value>Restore down</value>\r\n   </data>\r\n   <data name=\"CommandPaletteMenuItem\" xml:space=\"preserve\">\r\n-    <value>Command Palette</value>\r\n+    <value>Command palette</value>\r\n   </data>\r\n   <data name=\"NotificationIconFocusTerminal\" xml:space=\"preserve\">\r\n     <value>Focus Terminal</value>\r\n@@ -754,7 +754,7 @@\n     <value>Split the window and start in given directory</value>\r\n   </data>\r\n   <data name=\"ExportTabText\" xml:space=\"preserve\">\r\n-    <value>Export Text</value>\r\n+    <value>Export text</value>\r\n   </data>\r\n   <data name=\"ExportFailure\" xml:space=\"preserve\">\r\n     <value>Failed to export terminal content</value>\r\n@@ -766,7 +766,7 @@\n     <value>Find</value>\r\n   </data>\r\n   <data name=\"PlainText\" xml:space=\"preserve\">\r\n-    <value>Plain Text</value>\r\n+    <value>Plain text</value>\r\n   </data>\r\n   <data name=\"CloseOnExitInfoBar.Message\" xml:space=\"preserve\">\r\n     <value>Termination behavior can be configured in advanced profile settings.</value>\r\n@@ -775,7 +775,7 @@\n     <value>Don't show again</value>\r\n   </data>\r\n   <data name=\"ElevationShield.[using:Windows.UI.Xaml.Controls]ToolTipService.ToolTip\" xml:space=\"preserve\">\r\n-    <value>This Terminal window is running as Admin</value>\r\n+    <value>This Terminal window is running as administrator</value>\r\n   </data>\r\n   <data name=\"CommandPalette_MatchesAvailable\" xml:space=\"preserve\">\r\n     <value>Suggestions found: {0}</value>\r\n@@ -835,10 +835,10 @@\n     <value>Close this tab</value>\r\n   </data>\r\n   <data name=\"NewTabMenuFolderEmpty\" xml:space=\"preserve\">\r\n-    <value>Empty...</value>\r\n+    <value>Empty</value>\r\n   </data>\r\n   <data name=\"ClosePaneText\" xml:space=\"preserve\">\r\n-    <value>Close Pane</value>\r\n+    <value>Close pane</value>\r\n   </data>\r\n   <data name=\"ClosePaneToolTip\" xml:space=\"preserve\">\r\n     <value>Close the active pane if multiple panes are present</value>\r\n@@ -848,13 +848,13 @@\n     <comment>Text used to identify the reset button</comment>\r\n   </data>\r\n   <data name=\"MoveTabToNewWindowText\" xml:space=\"preserve\">\r\n-    <value>Move Tab to New Window</value>\r\n+    <value>Move tab to new window</value>\r\n   </data>\r\n   <data name=\"MoveTabToNewWindowToolTip\" xml:space=\"preserve\">\r\n     <value>Moves tab to a new window </value>\r\n   </data>\r\n   <data name=\"RunAsAdminFlyout.Text\" xml:space=\"preserve\">\r\n-    <value>Run as Administrator</value>\r\n+    <value>Run as administrator</value>\r\n     <comment>This text is displayed on context menu for profile entries in add new tab button.</comment>\r\n   </data>\r\n   <data name=\"TerminalPage_PaneMovedAnnouncement_ExistingTab\" xml:space=\"preserve\">\r\n@@ -893,7 +893,7 @@\n     <value>If set, the command will be appended to the profile's default command instead of replacing it.</value>\r\n   </data>\r\n   <data name=\"RestartConnectionText\" xml:space=\"preserve\">\r\n-    <value>Restart Connection</value>\r\n+    <value>Restart connection</value>\r\n   </data>\r\n   <data name=\"RestartConnectionToolTip\" xml:space=\"preserve\">\r\n     <value>Restart the active pane connection</value>\r\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.cpp b/src/cascadia/TerminalApp/TerminalTab.cpp\nindex ceb3860f1ff..e0a93ee9275 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.cpp\n+++ b/src/cascadia/TerminalApp/TerminalTab.cpp\n@@ -1372,7 +1372,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         auto weakThis{ get_weak() };\r\n \r\n-        // \"Color...\"\r\n+        // \"Change tab color...\"\r\n         Controls::MenuFlyoutItem chooseColorMenuItem;\r\n         {\r\n             Controls::FontIcon colorPickSymbol;\r\n@@ -1391,7 +1391,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem renameTabMenuItem;\r\n         {\r\n-            // \"Rename Tab\"\r\n+            // \"Rename tab\"\r\n             Controls::FontIcon renameTabSymbol;\r\n             renameTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             renameTabSymbol.Glyph(L\"\\xE8AC\"); // Rename\r\n@@ -1408,7 +1408,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem duplicateTabMenuItem;\r\n         {\r\n-            // \"Duplicate Tab\"\r\n+            // \"Duplicate tab\"\r\n             Controls::FontIcon duplicateTabSymbol;\r\n             duplicateTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             duplicateTabSymbol.Glyph(L\"\\xF5ED\");\r\n@@ -1425,7 +1425,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem splitTabMenuItem;\r\n         {\r\n-            // \"Split Tab\"\r\n+            // \"Split tab\"\r\n             Controls::FontIcon splitTabSymbol;\r\n             splitTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             splitTabSymbol.Glyph(L\"\\xF246\"); // ViewDashboard\r\n@@ -1442,7 +1442,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem moveTabToNewWindowMenuItem;\r\n         {\r\n-            // \"Move Tab to New Window\"\r\n+            // \"Move tab to new window\"\r\n             Controls::FontIcon moveTabToNewWindowTabSymbol;\r\n             moveTabToNewWindowTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             moveTabToNewWindowTabSymbol.Glyph(L\"\\xE8A7\");\r\n@@ -1459,7 +1459,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem closePaneMenuItem = _closePaneMenuItem;\r\n         {\r\n-            // \"Close Pane\"\r\n+            // \"Close pane\"\r\n             closePaneMenuItem.Click({ get_weak(), &TerminalTab::_closePaneClicked });\r\n             closePaneMenuItem.Text(RS_(L\"ClosePaneText\"));\r\n \r\n@@ -1471,7 +1471,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem exportTabMenuItem;\r\n         {\r\n-            // \"Export Tab\"\r\n+            // \"Export tab\"\r\n             Controls::FontIcon exportTabSymbol;\r\n             exportTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             exportTabSymbol.Glyph(L\"\\xE74E\"); // Save\r\n@@ -1505,7 +1505,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem restartConnectionMenuItem = _restartConnectionMenuItem;\r\n         {\r\n-            // \"Restart Connection\"\r\n+            // \"Restart connection\"\r\n             Controls::FontIcon restartConnectionSymbol;\r\n             restartConnectionSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             restartConnectionSymbol.Glyph(L\"\\xE72C\");\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\nindex 03e330d9ecd..6179099bdf5 100644\n--- a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n@@ -118,13 +118,13 @@\n     <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>\r\n   </resheader>\r\n   <data name=\"SetColorSchemeParentCommandName\" xml:space=\"preserve\">\r\n-    <value>Select color scheme...</value>\r\n+    <value>Select color scheme</value>\r\n   </data>\r\n   <data name=\"NewTabParentCommandName\" xml:space=\"preserve\">\r\n-    <value>New Tab...</value>\r\n+    <value>New tab</value>\r\n   </data>\r\n   <data name=\"SplitPaneParentCommandName\" xml:space=\"preserve\">\r\n-    <value>Split Pane...</value>\r\n+    <value>Split pane</value>\r\n   </data>\r\n   <data name=\"ApplicationDisplayNamePortable\" xml:space=\"preserve\">\r\n     <value>Terminal (Portable)</value>\r\n@@ -325,7 +325,7 @@\n     <comment>{Locked=\"JSON\"}. \"JSON\" is the extension of the file that will be opened.</comment>\r\n   </data>\r\n   <data name=\"OpenTabColorPickerCommandKey\" xml:space=\"preserve\">\r\n-    <value>Set the tab color...</value>\r\n+    <value>Set the tab color</value>\r\n   </data>\r\n   <data name=\"PasteTextCommandKey\" xml:space=\"preserve\">\r\n     <value>Paste</value>\r\n@@ -347,7 +347,7 @@\n     <value>Reset tab title</value>\r\n   </data>\r\n   <data name=\"OpenTabRenamerCommandKey\" xml:space=\"preserve\">\r\n-    <value>Rename tab title...</value>\r\n+    <value>Rename tab title</value>\r\n   </data>\r\n   <data name=\"ResizePaneCommandKey\" xml:space=\"preserve\">\r\n     <value>Resize pane</value>\r\n@@ -441,7 +441,7 @@\n     <value>Switch to the last tab</value>\r\n   </data>\r\n   <data name=\"TabSearchCommandKey\" xml:space=\"preserve\">\r\n-    <value>Search for tab...</value>\r\n+    <value>Search for tab</value>\r\n   </data>\r\n   <data name=\"ToggleAlwaysOnTopCommandKey\" xml:space=\"preserve\">\r\n     <value>Toggle always on top mode</value>\r\n@@ -450,10 +450,10 @@\n     <value>Toggle command palette</value>\r\n   </data>\r\n   <data name=\"SuggestionsCommandHistoryCommandKey\" xml:space=\"preserve\">\r\n-    <value>Recent commands...</value>\r\n+    <value>Recent commands</value>\r\n   </data>\r\n   <data name=\"SuggestionsCommandKey\" xml:space=\"preserve\">\r\n-    <value>Open suggestions...</value>\r\n+    <value>Open suggestions</value>\r\n   </data>\r\n   <data name=\"ToggleCommandPaletteCommandLineModeCommandKey\" xml:space=\"preserve\">\r\n     <value>Toggle command palette in command line mode</value>\r\n@@ -505,7 +505,7 @@\n     <value>Break into the debugger</value>\r\n   </data>\r\n   <data name=\"OpenSettingsUICommandKey\" xml:space=\"preserve\">\r\n-    <value>Open settings...</value>\r\n+    <value>Open settings</value>\r\n   </data>\r\n   <data name=\"RenameWindowCommandKey\" xml:space=\"preserve\">\r\n     <value>Rename window to \"{0}\"</value>\r\n@@ -515,7 +515,7 @@\n     <value>Reset window name</value>\r\n   </data>\r\n   <data name=\"OpenWindowRenamerCommandKey\" xml:space=\"preserve\">\r\n-    <value>Rename window...</value>\r\n+    <value>Rename window</value>\r\n   </data>\r\n   <data name=\"DisplayWorkingDirectoryCommandKey\" xml:space=\"preserve\">\r\n     <value>Display Terminal's current working directory</value>\r\n@@ -566,7 +566,7 @@\n     <value>Quit the Terminal</value>\r\n   </data>\r\n   <data name=\"SetOpacityParentCommandName\" xml:space=\"preserve\">\r\n-    <value>Set background opacity...</value>\r\n+    <value>Set background opacity</value>\r\n   </data>\r\n   <data name=\"IncreaseOpacityCommandKey\" xml:space=\"preserve\">\r\n     <value>Increase background opacity by {0}%</value>\r\n", "instance_id": "microsoft__terminal-16886", "clarity": 3, "difficulty": 0.15, "clarity_explanation": "The problem statement is comprehensive and well-detailed. It clearly outlines the issues with UI style errors in the Windows Terminal application, specifically focusing on excessive capitalization and misuse of ellipses in menu items. The statement provides explicit references to Microsoft style guides and UX design guidelines, ensuring that the expected behavior is well-defined. It includes visual examples (via a linked image) and mentions specific menu items and their issues. Additionally, it addresses the impact of these issues in different languages and provides a historical context for UI design choices. There are no significant ambiguities; the goal (achieving UI consistency), the issues, and the expected fixes are all clearly articulated. The only minor omission is the lack of explicit mention of specific edge cases or localization challenges beyond a reference to other languages, but this does not detract from the overall clarity.", "difficulty_explanation": "The difficulty of this problem is very low, falling in the 0.0-0.2 range, as it involves straightforward modifications to resource strings and comments in the codebase. The code changes are limited to updating text strings in resource files (`Resources.resw`) and corresponding comments in the C++ code (`TerminalTab.cpp`) to adhere to sentence-style capitalization and remove inappropriate ellipses usage. The scope of changes is narrow, affecting only specific UI text elements across a couple of files, with no impact on the system's architecture or logic. No complex technical concepts, algorithms, or deep understanding of the codebase are required beyond basic familiarity with resource files and string manipulation. There are no significant edge cases or error handling requirements mentioned or implied in the problem statement or code changes, as the task is purely cosmetic. The primary challenge might be ensuring consistency across all UI elements, but this is a minor concern given the provided diff. Overall, this is a very easy task suitable for a junior developer or someone with minimal experience in the codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "gltfpack: EXT_texture_webp support\nSpec [here](https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Vendor/EXT_texture_webp).\r\n\r\nModel before:\r\n[webp_demo.zip](https://github.com/zeux/meshoptimizer/files/10695236/webp_demo.zip)\r\n```json\r\n{\r\n\"textures\":[{\"sampler\":0,\"extensions\":{\"EXT_texture_webp\":{\"source\":0}}}],\r\n\"extensionsUsed\":[\"EXT_texture_webp\"],\"extensionsRequired\":[\"EXT_texture_webp\"]\r\n}\r\n```\r\nModel after:\r\n[webp_demo_gltfpack.zip](https://github.com/zeux/meshoptimizer/files/10695237/webp_demo_gltfpack.zip)\r\n```json\r\n{\r\n\"extensionsUsed\":[\"KHR_mesh_quantization\",\"KHR_texture_transform\"],\"extensionsRequired\":[\"KHR_mesh_quantization\"],\r\n\"textures\":[{}]\r\n}\r\n```\n", "patch": "diff --git a/extern/cgltf.h b/extern/cgltf.h\nindex ac392aba4..36fd644e1 100644\n--- a/extern/cgltf.h\n+++ b/extern/cgltf.h\n@@ -395,6 +395,8 @@ typedef struct cgltf_texture\n \tcgltf_sampler* sampler;\n \tcgltf_bool has_basisu;\n \tcgltf_image* basisu_image;\n+\tcgltf_bool has_webp;\n+\tcgltf_image* webp_image;\n \tcgltf_extras extras;\n \tcgltf_size extensions_count;\n \tcgltf_extension* extensions;\n@@ -4551,6 +4553,34 @@ static int cgltf_parse_json_texture(cgltf_options* options, jsmntok_t const* tok\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\telse if (cgltf_json_strcmp(tokens + i, json_chunk, \"EXT_texture_webp\") == 0)\n+\t\t\t\t{\n+\t\t\t\t\tout_texture->has_webp = 1;\n+\t\t\t\t\t++i;\n+\t\t\t\t\tCGLTF_CHECK_TOKTYPE(tokens[i], JSMN_OBJECT);\n+\t\t\t\t\tint num_properties = tokens[i].size;\n+\t\t\t\t\t++i;\n+\n+\t\t\t\t\tfor (int t = 0; t < num_properties; ++t)\n+\t\t\t\t\t{\n+\t\t\t\t\t\tCGLTF_CHECK_KEY(tokens[i]);\n+\n+\t\t\t\t\t\tif (cgltf_json_strcmp(tokens + i, json_chunk, \"source\") == 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t\tout_texture->webp_image = CGLTF_PTRINDEX(cgltf_image, cgltf_json_to_int(tokens + i, json_chunk));\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\ti = cgltf_skip_json(tokens, i + 1);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tif (i < 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\treturn i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t\telse\n \t\t\t\t{\n \t\t\t\t\ti = cgltf_parse_json_unprocessed_extension(options, tokens, i, json_chunk, &(out_texture->extensions[out_texture->extensions_count++]));\n@@ -6561,6 +6591,7 @@ static int cgltf_fixup_pointers(cgltf_data* data)\n \t{\n \t\tCGLTF_PTRFIXUP(data->textures[i].image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].basisu_image, data->images, data->images_count);\n+\t\tCGLTF_PTRFIXUP(data->textures[i].webp_image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].sampler, data->samplers, data->samplers_count);\n \t}\n \ndiff --git a/gltf/README.md b/gltf/README.md\nindex ffe6d1e12..4b278676a 100644\n--- a/gltf/README.md\n+++ b/gltf/README.md\n@@ -85,6 +85,7 @@ gltfpack supports most Khronos extensions and some multi-vendor extensions in th\n - KHR_texture_transform\n - EXT_mesh_gpu_instancing\n - EXT_meshopt_compression\n+- EXT_texture_webp\n \n Even if the source file does not use extensions, gltfpack may use some extensions in the output file either by default or when certain options are used:\n \ndiff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex f3156d3e3..ee46fa6a7 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -454,6 +454,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \tbool ext_instancing = false;\n \tbool ext_texture_transform = false;\n \tbool ext_texture_basisu = false;\n+\tbool ext_texture_webp = false;\n \n \tsize_t accr_offset = 0;\n \tsize_t node_offset = 0;\n@@ -512,6 +513,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\tassert(textures[i].remap == int(texture_offset));\n \t\ttexture_offset++;\n \t\text_texture_basisu = ext_texture_basisu || texture.has_basisu;\n+\t\text_texture_webp = ext_texture_webp || texture.has_webp;\n \t}\n \n \tfor (size_t i = 0; i < data->materials_count; ++i)\n@@ -838,6 +840,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t    {\"KHR_materials_variants\", data->variants_count > 0, false},\n \t    {\"KHR_lights_punctual\", data->lights_count > 0, false},\n \t    {\"KHR_texture_basisu\", (!json_textures.empty() && settings.texture_ktx2) || ext_texture_basisu, true},\n+\t    {\"EXT_texture_webp\", ext_texture_webp, true},\n \t    {\"EXT_mesh_gpu_instancing\", ext_instancing, true},\n \t};\n \ndiff --git a/gltf/image.cpp b/gltf/image.cpp\nindex 129938a0e..972b4c441 100644\n--- a/gltf/image.cpp\n+++ b/gltf/image.cpp\n@@ -8,6 +8,7 @@ static const char* kMimeTypes[][2] = {\n     {\"image/jpeg\", \".jpeg\"},\n     {\"image/png\", \".png\"},\n     {\"image/ktx2\", \".ktx2\"},\n+    {\"image/webp\", \".webp\"},\n };\n \n static const char* inferMimeType(const char* path)\n@@ -128,6 +129,7 @@ static int readInt32LE(const std::string& data, size_t offset)\n \t       (unsigned((unsigned char)data[offset + 3]) << 24);\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool getDimensionsPng(const std::string& data, int& width, int& height)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -146,6 +148,7 @@ static bool getDimensionsPng(const std::string& data, int& width, int& height)\n \treturn true;\n }\n \n+// https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format#File_format_structure\n static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n {\n \tsize_t offset = 0;\n@@ -189,6 +192,7 @@ static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n \treturn false;\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool hasTransparencyPng(const std::string& data)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -224,6 +228,7 @@ static bool hasTransparencyPng(const std::string& data)\n \treturn false;\n }\n \n+// https://github.khronos.org/KTX-Specification/ktxspec.v2.html\n static bool hasTransparencyKtx2(const std::string& data)\n {\n \tif (data.size() < 12 + 17 * 4)\n@@ -261,12 +266,45 @@ static bool hasTransparencyKtx2(const std::string& data)\n \treturn false;\n }\n \n+// https://developers.google.com/speed/webp/docs/riff_container\n+static bool hasTransparencyWebP(const std::string& data)\n+{\n+\tif (data.size() < 12 + 4 + 12)\n+\t\treturn false;\n+\n+\tif (data.compare(0, 4, \"RIFF\") != 0)\n+\t\treturn false;\n+\tif (data.compare(8, 4, \"WEBP\") != 0)\n+\t\treturn false;\n+\n+\t// WebP data may use VP8L, VP8X or VP8 format, but VP8 does not support transparency\n+\tif (data.compare(12, 4, \"VP8L\") == 0)\n+\t{\n+\t\tif (unsigned(data[20]) != 0x2f)\n+\t\t\treturn false;\n+\n+\t\t// width (14) | height (14) | alpha_is_used (1) | version_number(3)\n+\t\tunsigned int header = readInt32LE(data, 21);\n+\t\treturn (header & (1 << 28)) != 0;\n+\t}\n+\telse if (data.compare(12, 4, \"VP8X\") == 0)\n+\t{\n+\t\t// zero (2) | icc (1) | alpha (1) | exif (1) | xmp (1) | animation (1) | zero (1)\n+\t\tunsigned char header = data[20];\n+\t\treturn (header & (1 << 4)) != 0;\n+\t}\n+\n+\treturn false;\n+}\n+\n bool hasAlpha(const std::string& data, const char* mime_type)\n {\n \tif (strcmp(mime_type, \"image/png\") == 0)\n \t\treturn hasTransparencyPng(data);\n \telse if (strcmp(mime_type, \"image/ktx2\") == 0)\n \t\treturn hasTransparencyKtx2(data);\n+\telse if (strcmp(mime_type, \"image/webp\") == 0)\n+\t\treturn hasTransparencyWebP(data);\n \telse\n \t\treturn false;\n }\ndiff --git a/gltf/material.cpp b/gltf/material.cpp\nindex 0931b2e05..68d5610c8 100644\n--- a/gltf/material.cpp\n+++ b/gltf/material.cpp\n@@ -11,10 +11,10 @@ static bool areTexturesEqual(const cgltf_texture& lhs, const cgltf_texture& rhs)\n \tif (lhs.sampler != rhs.sampler)\n \t\treturn false;\n \n-\tif (lhs.has_basisu != rhs.has_basisu)\n+\tif (lhs.basisu_image != rhs.basisu_image)\n \t\treturn false;\n \n-\tif (lhs.basisu_image != rhs.basisu_image)\n+\tif (lhs.webp_image != rhs.webp_image)\n \t\treturn false;\n \n \treturn true;\n@@ -446,9 +446,12 @@ static const cgltf_image* getTextureImage(const cgltf_texture* texture)\n \tif (texture && texture->image)\n \t\treturn texture->image;\n \n-\tif (texture && texture->has_basisu && texture->basisu_image)\n+\tif (texture && texture->basisu_image)\n \t\treturn texture->basisu_image;\n \n+\tif (texture && texture->webp_image)\n+\t\treturn texture->webp_image;\n+\n \treturn NULL;\n }\n \ndiff --git a/gltf/write.cpp b/gltf/write.cpp\nindex 13f2f3ad5..429d0c446 100644\n--- a/gltf/write.cpp\n+++ b/gltf/write.cpp\n@@ -975,13 +975,20 @@ void writeTexture(std::string& json, const cgltf_texture& texture, const ImageIn\n \t\t}\n \t}\n \n-\tif (texture.has_basisu && texture.basisu_image)\n+\tif (texture.basisu_image)\n \t{\n \t\tcomma(json);\n \t\tappend(json, \"\\\"extensions\\\":{\\\"KHR_texture_basisu\\\":{\\\"source\\\":\");\n \t\tappend(json, size_t(texture.basisu_image - data->images));\n \t\tappend(json, \"}}\");\n \t}\n+\telse if (texture.webp_image)\n+\t{\n+\t\tcomma(json);\n+\t\tappend(json, \"\\\"extensions\\\":{\\\"EXT_texture_webp\\\":{\\\"source\\\":\");\n+\t\tappend(json, size_t(texture.webp_image - data->images));\n+\t\tappend(json, \"}}\");\n+\t}\n }\n \n void writeMeshAttributes(std::string& json, std::vector<BufferView>& views, std::string& json_accessors, size_t& accr_offset, const Mesh& mesh, int target, const QuantizationPosition& qp, const QuantizationTexture& qt, const Settings& settings)\n", "instance_id": "zeux__meshoptimizer-709", "clarity": 2, "difficulty": 0.5, "clarity_explanation": "The problem statement is mostly clear in its intent to add support for the EXT_texture_webp extension in the gltfpack tool, as part of handling WebP texture formats in glTF models. It provides a reference to the specification and includes before-and-after examples of the model JSON, which helps in understanding the expected transformation. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior when processing WebP textures (e.g., whether they should be preserved, converted, or handled differently based on certain conditions). Additionally, edge cases, constraints, or specific requirements for WebP support (like compatibility with other extensions or tools) are not mentioned. While the provided JSON snippets and linked specification help, the lack of detailed requirements or explicit goals beyond \"support\" leaves room for interpretation, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.50) due to several factors. \n\n1. **Scope and Depth of Code Changes:** The changes span multiple files (cgltf.h, gltfpack.cpp, image.cpp, material.cpp, write.cpp, and README.md), indicating a moderate impact across the codebase. The modifications involve adding new fields to data structures, updating parsing logic, handling image transparency, and ensuring proper serialization of the WebP extension in the output. While the changes are not architecturally significant (they don't alter the core design of gltfpack), they require understanding and modifying several interconnected components, such as texture handling, image processing, and JSON output generation.\n\n2. **Technical Concepts Involved:** Solving this problem requires familiarity with the glTF format and its extension mechanism, specifically EXT_texture_webp. It also involves knowledge of C++ (struct modifications, pointer handling), JSON parsing (via cgltf library), and image format specifics (WebP container structure for transparency detection). Additionally, the developer must understand how gltfpack processes textures and extensions, which involves some domain-specific knowledge of 3D model optimization. While these concepts are not overly complex for an experienced developer, they do require a moderate level of expertise and research into the WebP format and glTF specifications.\n\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the code changes introduce logic for detecting WebP transparency and handling different WebP formats (VP8L, VP8X). This suggests some consideration of edge cases, such as invalid or unsupported WebP data. The code also includes error checking during JSON parsing for the extension. However, the complexity of these edge cases is moderate, as they are mostly confined to format validation and do not involve intricate error recovery or performance-critical scenarios.\n\n4. **Overall Complexity:** The task requires a developer to integrate a new feature (WebP texture support) into an existing system, which involves understanding the glTF ecosystem, making consistent updates across multiple modules, and ensuring compatibility with existing functionality (e.g., other texture formats like PNG or KTX2). While not overly challenging, it is more than a simple bug fix or feature addition due to the need for cross-file modifications and domain knowledge. It does not reach the \"hard\" category as it lacks deep architectural changes, complex algorithms, or significant performance optimization challenges.\n\nThus, a difficulty score of 0.50 reflects a medium-level problem that requires a solid understanding of the codebase and moderate technical skills to implement correctly.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[FEATURE] Optimize compilation speed by reorganize headers\n# Introduction\r\n\r\nThe calculation core is a header-only library in C++. In each build target of unit test, C API, validation test, etc, we have multiple translation units (`.cpp` files). The compilation speed is slow in both CI and local development machine. This is frustrating and slows down the development.\r\n\r\n# Proposal\r\n\r\nWe would like to re-organize the headers in the header only library to reduce the dependencies between the headers. Hopefully we can increase the compilation speed. Possible ways of improvement can be:\r\n\r\n1. Remove most of the standard library include in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp). Only keep the absolute common standard libraries (like `cstddef`). Include the needed standard library in individual header files where it is needed.\r\n2. Forward declare classes in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp), so that other headers can use the opaque type if the full type is not needed. This reduces the dependencies between the headers.\r\n3. Use separate header file with `type_traits` types to specify the `input`, `update`, .. types of each component. In this way, when compiling meta-data (like serializer), we do not need to include all the component types, only the traiter types.\r\n4. Make the `MathSolver` a generic template class with supported solvers, just like how the `MainModelImpl` is templated with the components\r\n5. Move generic template class `using` declarations like [`using MainModel = MainModelImpl<...>;`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/main_model.hpp#L1225-L1228) to separate header files, e.g. `main_model.hpp` and `main_model_impl.hpp`. The tester of dispatch functionality of the `MainModel` could then use a component-less instance.\r\n\n", "patch": "diff --git a/power_grid_model_c/power_grid_model_c/src/buffer.cpp b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\nindex aeb6374bc..d4d268674 100644\n--- a/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n+++ b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n@@ -20,10 +20,15 @@ using meta_data::RawDataPtr;\n \n // buffer control\n RawDataPtr PGM_create_buffer(PGM_Handle* /* handle */, PGM_MetaComponent const* component, PGM_Idx size) {\n+    // alignment should be maximum of alignment of the component and alignment of void*\n+    size_t const alignment = std::max(component->alignment, sizeof(void*));\n+    // total bytes should be multiple of alignment\n+    size_t const requested_bytes = component->size * size;\n+    size_t const rounded_bytes = ((requested_bytes + alignment - 1) / alignment) * alignment;\n #ifdef _WIN32\n-    return _aligned_malloc(component->size * size, component->alignment);\n+    return _aligned_malloc(rounded_bytes, alignment);\n #else\n-    return std::aligned_alloc(component->alignment, component->size * size);\n+    return std::aligned_alloc(alignment, rounded_bytes);\n #endif\n }\n void PGM_destroy_buffer(RawDataPtr ptr) {\n", "instance_id": "PowerGridModel__power-grid-model-718", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in its intent to optimize compilation speed by reorganizing headers in a C++ header-only library. The introduction provides context about the issue (slow compilation speed in CI and local development), and the proposal lists specific strategies for improvement, such as reducing standard library includes, forward declarations, and separating type definitions into different headers. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not specify measurable goals or benchmarks for \"improved compilation speed,\" nor does it provide concrete examples of current dependencies causing issues. Additionally, there is no mention of potential risks or trade-offs (e.g., increased maintenance complexity due to header reorganization). Edge cases or constraints, such as compatibility with existing code or specific build systems, are also not addressed. While the overall goal and approach are understandable, these missing details could lead to misinterpretation or incomplete solutions.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Scope and Depth of Code Changes**: The proposed changes involve reorganizing headers across a header-only C++ library, which likely affects multiple files and modules. Modifications to core files like `power_grid_model.hpp` and `main_model.hpp` suggest a deep impact on the codebase's structure. The suggestions (e.g., forward declarations, separating type traits, and templating `MathSolver`) indicate a need for systemic refactoring rather than isolated changes. While the provided code diff (in `buffer.cpp`) is minor and unrelated to the main header reorganization, it hints at potential broader changes not fully shown in the snippet. The overall scope appears significant, potentially affecting the entire build process and architecture of the library.\n\n2. **Clarity and Complexity of Problem Logic**: The problem's logic is inherently complex as it deals with compilation speed optimization, a non-trivial aspect of C++ development. Reducing header dependencies requires a deep understanding of include graphs, translation units, and how the compiler processes headers. The proposed solutions, such as forward declarations and splitting type definitions, add further complexity as they require careful design to avoid breaking existing code or introducing circular dependencies.\n\n3. **Number of Technical Concepts**: Solving this problem demands expertise in several advanced C++ concepts, including header dependency management, forward declarations, template metaprogramming (for `MathSolver` and `MainModelImpl`), and type traits. Additionally, knowledge of build systems (e.g., CMake or similar) and compiler behavior (e.g., how includes affect compilation time) is necessary. These concepts are not beginner-friendly and require significant experience to apply correctly in a large codebase.\n\n4. **Edge Cases and Error Handling**: While the problem statement does not explicitly mention edge cases, the nature of header reorganization implies several potential pitfalls, such as breaking existing code due to missing includes, introducing circular dependencies, or affecting downstream consumers of the library (e.g., unit tests, C API). Error handling in the build process (e.g., ensuring compatibility across platforms or compilers) may also need to be considered. These implicit edge cases add to the difficulty, as they require foresight and thorough testing.\n\nOverall, this problem requires a deep understanding of C++ internals, careful refactoring across multiple files, and consideration of subtle build-time impacts. It falls short of \"Very Hard\" (0.8-1.0) because it does not appear to involve system-level or domain-specific challenges beyond compilation optimization (e.g., no distributed systems or complex algorithms are mentioned). However, it is still a challenging task best suited for experienced developers familiar with large-scale C++ projects.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "run script doesn't upload dsym files when <paths> parameter passed\n### Description\n\nWhen I try to upload multiple dsym files with <paths> parameter using run, it doesn't start uploading at all. I see this output in the build logs:\r\n\r\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"my.dSYM\", \"myother.dSYM\", \"--build-phase \", \"--validate\"]\r\n\r\nWhen I change these lines in the run script:\r\n```\r\nVALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\r\nUPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\r\n```\r\nto\r\n```\r\nVALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\r\nUPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS\"\r\n```\r\nit works, since the <paths> parameter should be the last parameter.\n\n### Reproducing the issue\n\nCall the run scirpt with a paths parameter to point another dSYM file.\n\n### Firebase SDK Version\n\n11.4\n\n### Xcode Version\n\n16\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChat-Debug.app.dSYM\", \"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChatShared.framework.dSYM\", \"--build-phase\", \"--validate\"]\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nPODS:\r\n  - FirebaseAnalytics (11.4.0):\r\n    - FirebaseAnalytics/AdIdSupport (= 11.4.0)\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseAnalytics/AdIdSupport (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleAppMeasurement (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseCore (11.4.2):\r\n    - FirebaseCoreInternal (< 12.0, >= 11.4.2)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/Logger (~> 8.0)\r\n  - FirebaseCoreExtension (11.4.1):\r\n    - FirebaseCore (~> 11.0)\r\n  - FirebaseCoreInternal (11.4.2):\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n  - FirebaseCrashlytics (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - FirebaseRemoteConfigInterop (~> 11.0)\r\n    - FirebaseSessions (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseInstallations (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseRemoteConfigInterop (11.4.0)\r\n  - FirebaseSessions (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseCoreExtension (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesSwift (~> 2.1)\r\n  - GoogleAppMeasurement (11.4.0):\r\n    - GoogleAppMeasurement/AdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/AdIdSupport (11.4.0):\r\n    - GoogleAppMeasurement/WithoutAdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/WithoutAdIdSupport (11.4.0):\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleDataTransport (10.1.0):\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - GoogleUtilities/AppDelegateSwizzler (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Network\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Environment (8.0.2):\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Logger (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/MethodSwizzler (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Network (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - \"GoogleUtilities/NSData+zlib\"\r\n    - GoogleUtilities/Privacy\r\n    - GoogleUtilities/Reachability\r\n  - \"GoogleUtilities/NSData+zlib (8.0.2)\":\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Privacy (8.0.2)\r\n  - GoogleUtilities/Reachability (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/UserDefaults (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - KMPNativeCoroutinesAsync (1.0.0-ALPHA-34):\r\n    - KMPNativeCoroutinesCore (= 1.0.0-ALPHA-34)\r\n  - KMPNativeCoroutinesCore (1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelCore (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCoreObjC (= 1.0.0-BETA-4)\r\n  - KMPObservableViewModelCoreObjC (1.0.0-BETA-4)\r\n  - KMPObservableViewModelSwiftUI (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCore (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (5.3.92)\r\n  - lottie-ios (4.5.0)\r\n  - MijickPopupView (2.7.1)\r\n  - nanopb (3.30910.0):\r\n    - nanopb/decode (= 3.30910.0)\r\n    - nanopb/encode (= 3.30910.0)\r\n  - nanopb/decode (3.30910.0)\r\n  - nanopb/encode (3.30910.0)\r\n  - OneSignalXCFramework (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalExtension (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalOutcomes (= 3.12.10)\r\n  - OneSignalXCFramework/OneSignalCore (3.12.10)\r\n  - OneSignalXCFramework/OneSignalExtension (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n    - OneSignalXCFramework/OneSignalOutcomes\r\n  - OneSignalXCFramework/OneSignalOutcomes (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n  - PromisesObjC (2.4.0)\r\n  - PromisesSwift (2.4.0):\r\n    - PromisesObjC (= 2.4.0)\r\n\r\nDEPENDENCIES:\r\n  - FirebaseAnalytics\r\n  - FirebaseCrashlytics\r\n  - KMPNativeCoroutinesAsync (= 1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelSwiftUI (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (~> 5.3.90)\r\n  - lottie-ios\r\n  - MijickPopupView\r\n  - OneSignalXCFramework (~> 3.12.9)\r\n\r\nSPEC REPOS:\r\n  https://github.com/CocoaPods/Specs.git:\r\n    - FirebaseAnalytics\r\n    - FirebaseCore\r\n    - FirebaseCoreExtension\r\n    - FirebaseCoreInternal\r\n    - FirebaseCrashlytics\r\n    - FirebaseInstallations\r\n    - FirebaseRemoteConfigInterop\r\n    - FirebaseSessions\r\n    - GoogleAppMeasurement\r\n    - GoogleDataTransport\r\n    - GoogleUtilities\r\n    - KMPNativeCoroutinesAsync\r\n    - KMPNativeCoroutinesCore\r\n    - KMPObservableViewModelCore\r\n    - KMPObservableViewModelCoreObjC\r\n    - KMPObservableViewModelSwiftUI\r\n    - lottie-ios\r\n    - MijickPopupView\r\n    - nanopb\r\n    - OneSignalXCFramework\r\n    - PromisesObjC\r\n    - PromisesSwift\r\n  https://gitlab.linphone.org/BC/public/podspec.git:\r\n    - linphone-sdk-novideo\r\n\r\nSPEC CHECKSUMS:\r\n  FirebaseAnalytics: 3feef9ae8733c567866342a1000691baaa7cad49\r\n  FirebaseCore: 6b32c57269bd999aab34354c3923d92a6e5f3f84\r\n  FirebaseCoreExtension: f1bc67a4702931a7caa097d8e4ac0a1b0d16720e\r\n  FirebaseCoreInternal: 35731192cab10797b88411be84940d2beb33a238\r\n  FirebaseCrashlytics: 41bbdd2b514a8523cede0c217aee6ef7ecf38401\r\n  FirebaseInstallations: 6ef4a1c7eb2a61ee1f74727d7f6ce2e72acf1414\r\n  FirebaseRemoteConfigInterop: e76f46ffa4d6a65e273d4dfebb6a79e588cec136\r\n  FirebaseSessions: 3f56f177d9e53a85021d16b31f9a111849d1dd8b\r\n  GoogleAppMeasurement: 987769c4ca6b968f2479fbcc9fe3ce34af454b8e\r\n  GoogleDataTransport: aae35b7ea0c09004c3797d53c8c41f66f219d6a7\r\n  GoogleUtilities: 26a3abef001b6533cf678d3eb38fd3f614b7872d\r\n  KMPNativeCoroutinesAsync: 709d922d3c8db3b83c5f0ce4035123dd7e6187b1\r\n  KMPNativeCoroutinesCore: 7e18aa574381ab40ea6a5b90ec2dffd362c0082b\r\n  KMPObservableViewModelCore: ded4abdfcc3566844c8dd18e23accd5cacd89a91\r\n  KMPObservableViewModelCoreObjC: d74dbf0c84cb8f66d6c706e89add1df9b8f653f4\r\n  KMPObservableViewModelSwiftUI: c3f740105ba32cd964cab1794d631b759d76a1d0\r\n  linphone-sdk-novideo: 50b8bcad0511613eca167586e75858f03cbaeb03\r\n  lottie-ios: a881093fab623c467d3bce374367755c272bdd59\r\n  MijickPopupView: 54863e093a18d6435cd5068850414570f9c1ba07\r\n  nanopb: fad817b59e0457d11a5dfbde799381cd727c1275\r\n  OneSignalXCFramework: e458f7a374192598a1d66418e1b61481c3cdf0e9\r\n  PromisesObjC: f5707f49cb48b9636751c5b2e7d227e43fba9f47\r\n  PromisesSwift: 9d77319bbe72ebf6d872900551f7eeba9bce2851\r\n\r\nPODFILE CHECKSUM: 4a3c4d0cf9b5f244d507d3ec13bca26d8124fa8b\r\n\r\nCOCOAPODS: 1.15.2\r\n\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/Crashlytics/run b/Crashlytics/run\nindex 93a6f11e7ae..bb1d43d8f0f 100755\n--- a/Crashlytics/run\n+++ b/Crashlytics/run\n@@ -46,8 +46,8 @@ for i in \"$@\"; do\n   ARGUMENTS=\"$ARGUMENTS \\\"$i\\\"\"\n done\n \n-VALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\n-UPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\n+VALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\n+UPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS \"\n \n # Quote the path to handle folders with special characters\n COMMAND_PATH=\"\\\"$DIR/upload-symbols\\\" \"\n", "instance_id": "firebase__firebase-ios-sdk-13966", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `run` script fails to upload dSYM files when the `<paths>` parameter is passed, due to the order of arguments in the script. The description includes relevant logs, reproduction steps, and context about the environment (Firebase SDK version, Xcode version, installation method, etc.), which helps in understanding the issue. The provided solution (reordering the arguments) is also clear. However, there are minor ambiguities, such as a lack of detailed explanation about why the order of arguments matters or what the expected behavior of the `--build-phase` and `--validate` flags is. Additionally, edge cases or potential side effects of the change are not mentioned, which could be critical for a complete understanding. Overall, the statement is valid and clear but misses some minor details, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward fix to a shell script by reordering arguments in two lines of code. The scope of the change is minimal, confined to a single file (`Crashlytics/run`), and does not impact the broader codebase or system architecture. The technical concepts required are basic shell scripting and understanding of command-line argument handling, which are not complex. There are no significant edge cases or error handling requirements mentioned in the problem statement, and the provided logs and reproduction steps make the issue easy to diagnose and resolve. The change is essentially a small bug fix with no deep understanding of the Firebase Crashlytics system or iOS development required beyond the script itself. Therefore, I assign a difficulty score of 0.15, placing it in the \"Very Easy\" range (0.0-0.2), as it requires only a basic code modification.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Cleanup deprecated notification API usages in Firebase\n### Description\r\n\r\nFirebase has multiple usages of the deprecated ` (void)application:(UIApplication *)application\r\n\u00a0 \u00a0 didReceiveRemoteNotification:(NSDictionary *)userInfo\u00a0` API. \r\n\r\nIt's usages should be removed across Firebase and GoogleUtilities.\r\n\r\nIn addition, GoogleUtilities should stop conditionalizing the swizzling of the replacement API: https://github.com/google/GoogleUtilities/blame/main/GoogleUtilities/AppDelegateSwizzler/GULAppDelegateSwizzler.m#L520\r\n\r\nAuth part of this is done in #13003 \r\nGoogleUtilities in https://github.com/google/GoogleUtilities/pull/162\r\nFirebaseMessging and CocoaPods updates still need to be done.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\nAll\r\n\r\n### Xcode Version\r\n\r\n14.3\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAuthentication\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/FirebaseMessaging/Sources/FIRMessaging.m b/FirebaseMessaging/Sources/FIRMessaging.m\nindex 9511d34a29e..9a688b034be 100644\n--- a/FirebaseMessaging/Sources/FIRMessaging.m\n+++ b/FirebaseMessaging/Sources/FIRMessaging.m\n@@ -437,9 +437,7 @@ - (void)handleIncomingLinkIfNeededFromMessage:(NSDictionary *)message {\n     // Similarly, |application:openURL:sourceApplication:annotation:| will also always be called,\n     // due to the default swizzling done by FIRAAppDelegateProxy in Firebase Analytics\n   } else if ([appDelegate respondsToSelector:openURLWithSourceApplicationSelector]) {\n-// TODO(Xcode 15): When Xcode 15 is the minimum supported Xcode version, it will be unnecessary to\n-// check if `TARGET_OS_VISION` is defined.\n-#if TARGET_OS_IOS && (!defined(TARGET_OS_VISION) || !TARGET_OS_VISION)\n+#if TARGET_OS_IOS\n #pragma clang diagnostic push\n #pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     [appDelegate application:application\ndiff --git a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\nindex 52c5ff0f82d..5cd5d8b16a2 100644\n--- a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n+++ b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n@@ -384,13 +384,6 @@ id FIRMessagingPropertyNameFromObject(id object, NSString *propertyName, Class k\n }\n \n #pragma mark - GULApplicationDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  [[FIRMessaging messaging] appDidReceiveMessage:userInfo];\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\nindex 6bf33f9b5d6..ea061e8a284 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n@@ -75,10 +75,12 @@ + (BOOL)supportsSecureCoding {\n }\n \n - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n-  id deviceToken = [aDecoder decodeObjectForKey:kFIRInstanceIDAPNSInfoTokenKey];\n-  if (![deviceToken isKindOfClass:[NSData class]]) {\n+  NSData *deviceToken = [aDecoder decodeObjectOfClass:[NSData class]\n+                                               forKey:kFIRInstanceIDAPNSInfoTokenKey];\n+  if (!deviceToken) {\n     return nil;\n   }\n+\n   BOOL isSandbox = [aDecoder decodeBoolForKey:kFIRInstanceIDAPNSInfoSandboxKey];\n   return [self initWithDeviceToken:(NSData *)deviceToken isSandbox:isSandbox];\n }\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\nindex 90420d1e72e..2852f0cad69 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n@@ -143,32 +143,29 @@ - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n   BOOL needsMigration = NO;\n   // These value cannot be nil\n \n-  id authorizedEntity = [aDecoder decodeObjectForKey:kFIRInstanceIDAuthorizedEntityKey];\n-  if (![authorizedEntity isKindOfClass:[NSString class]]) {\n+  NSString *authorizedEntity = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                      forKey:kFIRInstanceIDAuthorizedEntityKey];\n+  if (!authorizedEntity) {\n     return nil;\n   }\n \n-  id scope = [aDecoder decodeObjectForKey:kFIRInstanceIDScopeKey];\n-  if (![scope isKindOfClass:[NSString class]]) {\n+  NSString *scope = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDScopeKey];\n+  if (!scope) {\n     return nil;\n   }\n \n-  id token = [aDecoder decodeObjectForKey:kFIRInstanceIDTokenKey];\n-  if (![token isKindOfClass:[NSString class]]) {\n+  NSString *token = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDTokenKey];\n+  if (!token) {\n     return nil;\n   }\n \n-  // These values are nullable, so only fail the decode if the type does not match\n+  // These values are nullable, so don't fail on nil.\n \n-  id appVersion = [aDecoder decodeObjectForKey:kFIRInstanceIDAppVersionKey];\n-  if (appVersion && ![appVersion isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n+  NSString *appVersion = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                forKey:kFIRInstanceIDAppVersionKey];\n+  NSString *firebaseAppID = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                   forKey:kFIRInstanceIDFirebaseAppIDKey];\n \n-  id firebaseAppID = [aDecoder decodeObjectForKey:kFIRInstanceIDFirebaseAppIDKey];\n-  if (firebaseAppID && ![firebaseAppID isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n   NSSet *classes = [[NSSet alloc] initWithArray:@[ FIRMessagingAPNSInfo.class ]];\n   FIRMessagingAPNSInfo *rawAPNSInfo = [aDecoder decodeObjectOfClasses:classes\n                                                                forKey:kFIRInstanceIDAPNSInfoKey];\ndiff --git a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\nindex d3bbdc3ead3..16f7086f1d3 100644\n--- a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n+++ b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n@@ -64,19 +64,13 @@ @interface FakeAppDelegate : NSObject <GULApplicationDelegate>\n @property(nonatomic, strong) NSError *registerForRemoteNotificationsError;\n @end\n @implementation FakeAppDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  self.remoteNotificationMethodWasCalled = YES;\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\n     didReceiveRemoteNotification:(NSDictionary *)userInfo\n           fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler {\n   self.remoteNotificationWithFetchHandlerWasCalled = YES;\n+  completionHandler(UIBackgroundFetchResultNewData);\n }\n #endif\n \n@@ -192,6 +186,7 @@ - (void)testSwizzlingNonAppDelegate {\n #if !SWIFT_PACKAGE\n // The next 3 tests depend on a sharedApplication which is not available in the Swift PM test env.\n - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n+  XCTestExpectation *expectation = [self expectationWithDescription:@\"completion\"];\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n   [self.proxy swizzleMethodsIfPossible];\n@@ -199,15 +194,18 @@ - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n   NSDictionary *notification = @{@\"test\" : @\"\"};\n   OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n \n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n   [incompleteAppDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-        didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n+        didReceiveRemoteNotification:notification\n+              fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+                [expectation fulfill];\n+              }];\n \n   [self.mockMessaging verify];\n+  [self waitForExpectationsWithTimeout:0.5 handler:nil];\n }\n \n+// This test demonstrates the difference between Firebase 10 and 11. In 10 and earlier the\n+// swizzler inserts the old `didReceiveRemoteNotification` method. In 11, the new.\n - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n@@ -216,11 +214,11 @@ - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n #if TARGET_OS_IOS || TARGET_OS_TV\n   SEL remoteNotificationWithFetchHandler = @selector(application:\n                                     didReceiveRemoteNotification:fetchCompletionHandler:);\n-  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n+  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n #endif\n \n   SEL remoteNotification = @selector(application:didReceiveRemoteNotification:);\n-  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotification]);\n+  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotification]);\n }\n \n - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n@@ -230,21 +228,6 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   NSDictionary *notification = @{@\"test\" : @\"\"};\n \n-  // Test application:didReceiveRemoteNotification:\n-\n-  // Verify our swizzled method was called\n-  OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n-\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-  [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-      didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n-\n-  // Verify our original method was called\n-  XCTAssertTrue(appDelegate.remoteNotificationMethodWasCalled);\n-  [self.mockMessaging verify];\n-\n   // Test application:didReceiveRemoteNotification:fetchCompletionHandler:\n #if TARGET_OS_IOS || TARGET_OS_TV\n   // Verify our swizzled method was called\n@@ -252,7 +235,8 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n       didReceiveRemoteNotification:notification\n-            fetchCompletionHandler:^(UIBackgroundFetchResult result){\n+            fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+              XCTAssertEqual(result, UIBackgroundFetchResultNewData);\n             }];\n \n   // Verify our original method was called\n", "instance_id": "firebase__firebase-ios-sdk-13064", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in its intent to remove deprecated API usages related to Firebase notifications and to update swizzling behavior in GoogleUtilities. It specifies the deprecated API, mentions the affected components (FirebaseMessaging, CocoaPods, and GoogleUtilities), and provides references to related PRs and issues. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, it lacks explicit mention of the expected behavior after removing the deprecated API (e.g., what should replace it in all cases), does not specify edge cases or potential risks of removing the API, and provides no detailed steps or examples for reproduction or testing. Additionally, the scope of \"Firebase SDK Version: All\" and \"Installation Method: N/A\" leaves uncertainty about specific version constraints or testing environments. Overall, while the goal is understandable, these gaps could lead to misinterpretation or incomplete solutions without further clarification.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files within the FirebaseMessaging module, including core functionality (FIRMessaging.m, FIRMessagingRemoteNotificationsProxy.m) and token handling (FIRMessagingAPNSInfo.m, FIRMessagingTokenInfo.m), as well as unit tests. This requires understanding interactions between different parts of the codebase, such as app delegate swizzling and notification handling. Second, the technical concepts involved include familiarity with iOS-specific APIs (UIApplicationDelegate methods), Objective-C runtime behavior (swizzling), deprecated API migration, and conditional compilation for different iOS targets. While these concepts are not extraordinarily complex for an experienced iOS developer, they do require a solid grasp of Apple's ecosystem and Firebase's architecture. Third, the changes involve removing deprecated methods and updating method signatures, which could introduce subtle compatibility issues or require careful handling of backward compatibility, though specific edge cases are not mentioned in the problem statement. Finally, the impact on the system's architecture appears moderate, as it involves updating core notification handling logic but does not seem to require a full redesign. Given these considerations, the problem is more complex than a simple bug fix or feature addition but does not reach the level of a deep architectural refactor or highly intricate logic implementation, placing it at a difficulty of 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Setting vibrancy removes window border style\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n35.1.4\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS 15.2\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n34.0.0\n\n### Expected Behavior\n\nIn previous version (34.0.0), when I had vibrancy set to `\"sidebar\"` and frame to `false`, window did look like this:\n\n(it has macOS style border frame)\n\n![Image](https://github.com/user-attachments/assets/755227cf-30dc-473d-a220-bca0535477bb)\n\n### Actual Behavior\n\nNow, with exactly the same settings, the window looks like this (vibrancy set to `\"sidebar\"` and frame to `false`):\n\nmacOS style border of the window disappears\n\n![Image](https://github.com/user-attachments/assets/4071ee03-cfd1-4ad4-830a-ac66ed654ae3)\n\nEven if I enable `frame` to `true` (which I dont want to do as it enables traffic lights), it doesnt help:\n\n![Image](https://github.com/user-attachments/assets/f1abc4fd-9968-45b2-b583-0fd4a444e453)\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\n_No response_\n", "patch": "diff --git a/shell/browser/native_window_mac.h b/shell/browser/native_window_mac.h\nindex 590ac6d8bb7cd..5420e14aecd7d 100644\n--- a/shell/browser/native_window_mac.h\n+++ b/shell/browser/native_window_mac.h\n@@ -225,6 +225,7 @@ class NativeWindowMac : public NativeWindow,\n   bool CanMaximize() const override;\n   std::unique_ptr<views::NonClientFrameView> CreateNonClientFrameView(\n       views::Widget* widget) override;\n+  void OnWidgetInitialized() override;\n \n   // ui::NativeThemeObserver:\n   void OnNativeThemeUpdated(ui::NativeTheme* observed_theme) override;\ndiff --git a/shell/browser/native_window_mac.mm b/shell/browser/native_window_mac.mm\nindex 8bb7d5b51fa43..a895f26446213 100644\n--- a/shell/browser/native_window_mac.mm\n+++ b/shell/browser/native_window_mac.mm\n@@ -1861,6 +1861,28 @@ int NonClientHitTest(const gfx::Point& point) override {\n   return std::nullopt;\n }\n \n+void NativeWindowMac::OnWidgetInitialized() {\n+  // |window_| is not yet assigned when this function is called, so we need to\n+  // get the window from the widget.\n+  NSWindow* window = widget()->GetNativeWindow().GetNativeNSWindow();\n+\n+  // In |NativeWidgetNSWindowBridge::InitCompositorView| in Chromium,\n+  // translucent windows are assigned a clear background color. This causes\n+  // undesirable side effects, such as a window with vibrancy losing its natural\n+  // system border highlight. We undo that behavior here.\n+  //\n+  // Ref:\n+  // https://source.chromium.org/chromium/chromium/src/+/main:components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm;l=1341-1342;drc=e7c8be576285195257b0813326b3bab154dc7e73\n+  if (!transparent()) {\n+    if ([[window backgroundColor] isEqual:NSColor.clearColor]) {\n+      [window setBackgroundColor:NSColor.windowBackgroundColor];\n+    }\n+    if (![window isOpaque]) {\n+      [window setOpaque:YES];\n+    }\n+  }\n+}\n+\n // static\n std::unique_ptr<NativeWindow> NativeWindow::Create(\n     const gin_helper::Dictionary& options,\n", "instance_id": "electron__electron-46648", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: setting vibrancy to \"sidebar\" with frame set to false removes the macOS-style window border in Electron version 35.1.4, which was not the case in version 34.0.0. The expected and actual behaviors are illustrated with images, which help in understanding the visual impact of the bug. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this behavior occurs under specific conditions or configurations beyond the mentioned settings. Additionally, there is no mention of potential edge cases (e.g., different macOS versions, other vibrancy settings, or window styles) or constraints that might affect the solution. The lack of a test case or reproducible code snippet also slightly reduces clarity, as it leaves some room for interpretation regarding the exact context of the issue. Overall, while the core issue is well-articulated, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code changes is relatively focused, involving modifications to a single class (`NativeWindowMac`) in two files (`native_window_mac.h` and `native_window_mac.mm`). The changes are localized to adding a new method (`OnWidgetInitialized`) and implementing logic to override background color and opacity settings for non-transparent windows. However, the changes require a moderate understanding of the Electron codebase and Chromium's native window handling on macOS, specifically how window properties like transparency and vibrancy interact with system-level rendering (e.g., `NSWindow` properties in macOS). The technical concepts involved include familiarity with Objective-C++ (used in `.mm` files), macOS-specific UI rendering behaviors, and the Electron framework's window management architecture. Additionally, the solution touches on a subtle interaction between Electron's settings and Chromium's default behavior for translucent windows, which adds a layer of complexity in diagnosing and fixing the issue. While no explicit edge cases or error handling are mentioned in the problem statement, the code change implicitly addresses a specific rendering issue, and potential edge cases (e.g., different window styles or macOS versions) might need consideration during testing or further refinement. The impact on the system's architecture is minimal, as it does not alter core functionality but rather corrects an unintended side effect. Overall, this problem requires a moderate level of expertise and understanding of platform-specific nuances, placing it in the 0.4-0.6 range, with a score of 0.55 reflecting the balance between focused changes and the need for specialized knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: EXCEPTION_ACCESS_VIOLATION crash on `BrowserWindow.destroy()`\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n \\>=v31.0.0 (tested v31.0.0, v31.2.1, v32.0.0-aplha.10)\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nWindows 10 22H2\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nv30.3.0 (and everything below it)\r\n\r\n### Expected Behavior\r\n\r\n```js\r\nchildWindow.once('close', () => {\r\n    // do some cleanup etc\r\n    childWindow.destroy();;\r\n});\r\n```\r\n\r\nshouldn't crash Electron\r\n\r\n\r\n### Actual Behavior\r\n\r\n```js\r\nfunction cleanup() {\r\n\t// do some cleanup etc\r\n    childWindow.destroy();;\r\n}\r\nipcMain.once(`done`, cleanup);\r\nchildWindow.once('close', cleanup);\r\n```\r\nif `done` ipc event is not called and the window is manually closed, the window is destroyed and a few moments later The main Electron process crash with the following trace:\r\n\r\n<details><summary>Stacktrace Windows</summary>\r\n<p>\r\n\r\n```\r\nReceived fatal exception EXCEPTION_ACCESS_VIOLATION\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03CB9E08+3764424]\r\nv8::HeapStatistics::external_memory [0x00A48A12+8338]\r\ncppgc::internal::SameThreadEnabledCheckingPolicyBase::SameThreadEnabledCheckingPolicyBase [0x00B0DE72+28834]\r\nuv_req_get_data [0x022485EE+4269966]\r\nuv_req_get_data [0x02248AAA+4271178]\r\nuv_stream_get_write_queue_size [0x0277DBD5+2462421]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nsqlite3_dbdata_init [0x068DC9A7+2609367]\r\nuv_stream_get_write_queue_size [0x0277E07F+2463615]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nuv_stream_get_write_queue_size [0x0277D3B9+2460345]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nDispatchMessageW [0x76976901+1265]\r\nDispatchMessageW [0x76976420+16]\r\nuv_os_getpid [0x01D81F00+6592]\r\nuv_os_getpid [0x01D81B5B+5659]\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03C980DB+3625883]\r\nuv_os_getpid [0x01D817FB+4795]\r\nGetHandleVerifier [0x0232C67C+61788]\r\nuv_os_getpid [0x01DA8F14+166356]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169DD19+2893273]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169F5FE+2899646]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169B4AF+2882927]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DF37+3175]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EFF0+7456]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EEB7+7143]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9D88E+1470]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DA11+1857]\r\nv8::SourceLocation::SourceLocation [0x00960B7D+46669]\r\nv8::SourceLocation::SourceLocation [0x00960721+45553]\r\nGetNumaHighestNodeNumber [0x77682911+161]\r\nGetNumaHighestNodeNumber [0x776828C6+86]\r\nRtlUserFiberStart [0x77EC2DC7+23]\r\n\r\nElectron exited with code 3221226525.\r\n```\r\n\r\n</p>\r\n</details> \r\n\r\n### Testcase Gist URL\r\n\r\n> To reproduce, click the menu item then manually close the window that appears\r\n\r\nNo dependencies:\r\n\r\nhttps://gist.github.com/Araxeus/4e80b05c8bce61a5fe709eec1e969f2b\r\n\r\nOriginal issue:\r\n\r\nhttps://gist.github.com/Araxeus/6548ef4f3438d35d1713d5fd69c3b494\r\n\r\n### Additional Information\r\n\r\n* test repo: https://github.com/Aetherinox/electron-prompts\r\n* related issue: https://github.com/Araxeus/custom-electron-prompt/issues/26\n", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex 99c80b915a02d..9a950d0e1955c 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -159,12 +159,8 @@ filenames = {\n     \"shell/browser/osr/osr_web_contents_view_mac.mm\",\n     \"shell/browser/relauncher_mac.cc\",\n     \"shell/browser/ui/certificate_trust_mac.mm\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.h\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.mm\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.h\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.mm\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.h\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.mm\",\n     \"shell/browser/ui/cocoa/electron_native_widget_mac.h\",\n@@ -191,8 +187,6 @@ filenames = {\n     \"shell/browser/ui/cocoa/window_buttons_proxy.mm\",\n     \"shell/browser/ui/drag_util_mac.mm\",\n     \"shell/browser/ui/file_dialog_mac.mm\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.h\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.mm\",\n     \"shell/browser/ui/message_box_mac.mm\",\n     \"shell/browser/ui/tray_icon_cocoa.h\",\n     \"shell/browser/ui/tray_icon_cocoa.mm\",\n@@ -224,8 +218,6 @@ filenames = {\n     \"shell/browser/ui/views/electron_views_delegate.h\",\n     \"shell/browser/ui/views/frameless_view.cc\",\n     \"shell/browser/ui/views/frameless_view.h\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.cc\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.h\",\n     \"shell/browser/ui/views/menu_bar.cc\",\n     \"shell/browser/ui/views/menu_bar.h\",\n     \"shell/browser/ui/views/menu_delegate.cc\",\ndiff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex dc05787535848..939c67537716a 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -133,6 +133,8 @@ osr_shared_texture_remove_keyed_mutex_on_win_dxgi.patch\n feat_allow_usage_of_sccontentsharingpicker_on_supported_platforms.patch\n chore_partial_revert_of.patch\n fix_software_compositing_infinite_loop.patch\n+fix_add_method_which_disables_headless_mode_on_native_widget.patch\n+fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n refactor_unfilter_unresponsive_events.patch\n build_disable_thin_lto_mac.patch\n build_add_public_config_simdutf_config.patch\ndiff --git a/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\nnew file mode 100644\nindex 0000000000000..95d22359148d2\n--- /dev/null\n+++ b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\n@@ -0,0 +1,26 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Cezary Kulakowski <cezary@openfin.co>\n+Date: Mon, 22 Jul 2024 16:23:13 +0200\n+Subject: fix: add method which disables headless mode on native widget\n+\n+We need this method as we create window in headless mode and we\n+switch it back to normal mode only after inital paint is done in\n+order to get some events like WebContents.beginFrameSubscription.\n+If we don't set `is_headless_` to false then some child windows\n+e.g. autofill popups will be created in headless mode leading to\n+ui problems (like dissapearing popup during typing in html's\n+input list.\n+\n+diff --git a/ui/views/widget/widget.h b/ui/views/widget/widget.h\n+index 30d0ea6633cb0f7f9aab37951a38be9b0482a12a..734e91e6d50c8d3afd20b39167c6254e934e7c1e 100644\n+--- a/ui/views/widget/widget.h\n++++ b/ui/views/widget/widget.h\n+@@ -1144,6 +1144,8 @@ class VIEWS_EXPORT Widget : public internal::NativeWidgetDelegate,\n+   // True if widget was created in headless mode.\n+   bool is_headless() const { return is_headless_; }\n+ \n++  void DisableHeadlessMode() { is_headless_ = false; }\n++\n+   // True if the window size will follow the content preferred size.\n+   bool is_autosized() const { return is_autosized_; }\n+ \ndiff --git a/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\nnew file mode 100644\nindex 0000000000000..d7e0977944197\n--- /dev/null\n+++ b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: =?UTF-8?q?Micha=C5=82=20Pichli=C5=84ski?=\n+ <michal.pichlinski@openfin.co>\n+Date: Tue, 29 Oct 2024 21:16:29 +0100\n+Subject: fix: Put NSVisualEffectView before ViewsCompositorSuperview\n+\n+Upstreamed at https://chromium-review.googlesource.com/c/chromium/src/+/6030552\n+\n+Otherwise when using `vibrancy` in `BrowserWindow` NSVisualEffectView\n+will hide content displayed by the compositor.\n+\n+diff --git a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+index 07c3997e6565cf77362ee73959c4d21da4fefe96..3353a7847df90b58eec34ea4d6ff8fb19617f5cc 100644\n+--- a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n++++ b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+@@ -223,8 +223,19 @@ NSComparisonResult SubviewSorter(__kindof NSView* lhs,\n+                                  void* rank_as_void) {\n+   DCHECK_NE(lhs, rhs);\n+ \n+-  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]])\n++\n++  // Put NSVisualEffectView before ViewsCompositorSuperview otherwise when using\n++  // `vibrancy` in `BrowserWindow` NSVisualEffectView will hide content\n++  // displayed by the compositor.\n++  if ([lhs isKindOfClass:[NSVisualEffectView class]]) {\n+     return NSOrderedAscending;\n++  }\n++  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]]) {\n++    if ([rhs isKindOfClass:[NSVisualEffectView class]]) {\n++      return NSOrderedDescending;\n++    }\n++    return NSOrderedAscending;\n++  }\n+ \n+   const RankMap* rank = static_cast<const RankMap*>(rank_as_void);\n+   auto left_rank = rank->find(lhs);\ndiff --git a/shell/browser/api/electron_api_web_contents_view.cc b/shell/browser/api/electron_api_web_contents_view.cc\nindex 644ea373a7287..f76209fbdf5be 100644\n--- a/shell/browser/api/electron_api_web_contents_view.cc\n+++ b/shell/browser/api/electron_api_web_contents_view.cc\n@@ -27,29 +27,14 @@\n #include \"ui/views/view_class_properties.h\"\n #include \"ui/views/widget/widget.h\"\n \n-#if BUILDFLAG(IS_MAC)\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#endif\n-\n namespace electron::api {\n \n WebContentsView::WebContentsView(v8::Isolate* isolate,\n                                  gin::Handle<WebContents> web_contents)\n-#if BUILDFLAG(IS_MAC)\n-    : View(new DelayedNativeViewHost(web_contents->inspectable_web_contents()\n-                                         ->GetView()\n-                                         ->GetNativeView())),\n-#else\n-    : View(web_contents->inspectable_web_contents()->GetView()->GetView()),\n-#endif\n+    : View(web_contents->inspectable_web_contents()->GetView()),\n       web_contents_(isolate, web_contents.ToV8()),\n       api_web_contents_(web_contents.get()) {\n-#if !BUILDFLAG(IS_MAC)\n-  // On macOS the View is a newly-created |DelayedNativeViewHost| and it is our\n-  // responsibility to delete it. On other platforms the View is created and\n-  // managed by InspectableWebContents.\n   set_delete_view(false);\n-#endif\n   view()->SetProperty(\n       views::kFlexBehaviorKey,\n       views::FlexSpecification(views::MinimumFlexSizeRule::kScaleToMinimum,\ndiff --git a/shell/browser/native_window_mac.h b/shell/browser/native_window_mac.h\nindex d153dec7f87d5..c49cdc9635932 100644\n--- a/shell/browser/native_window_mac.h\n+++ b/shell/browser/native_window_mac.h\n@@ -169,9 +169,6 @@ class NativeWindowMac : public NativeWindow,\n   void NotifyWindowDidFailToEnterFullScreen();\n   void NotifyWindowWillLeaveFullScreen();\n \n-  // views::WidgetDelegate:\n-  views::View* GetContentsView() override;\n-\n   // Cleanup observers when window is getting closed. Note that the destructor\n   // can be called much later after window gets closed, so we should not do\n   // cleanup in destructor.\n@@ -223,6 +220,7 @@ class NativeWindowMac : public NativeWindow,\n \n  protected:\n   // views::WidgetDelegate:\n+  views::View* GetContentsView() override;\n   bool CanMaximize() const override;\n   std::unique_ptr<views::NonClientFrameView> CreateNonClientFrameView(\n       views::Widget* widget) override;\ndiff --git a/shell/browser/native_window_mac.mm b/shell/browser/native_window_mac.mm\nindex dc483ee3fd3aa..2acea04280688 100644\n--- a/shell/browser/native_window_mac.mm\n+++ b/shell/browser/native_window_mac.mm\n@@ -194,6 +194,8 @@ static bool FromV8(v8::Isolate* isolate,\n   params.bounds = bounds;\n   params.delegate = this;\n   params.type = views::Widget::InitParams::TYPE_WINDOW;\n+  // Allow painting before shown, to be later disabled in ElectronNSWindow.\n+  params.headless_mode = true;\n   params.native_widget =\n       new ElectronNativeWidgetMac(this, windowType, styleMask, widget());\n   widget()->Init(std::move(params));\n@@ -1674,6 +1676,7 @@ static bool FromV8(v8::Isolate* isolate,\n   DCHECK(!IsClosed());\n   ui::NativeTheme::GetInstanceForNativeUi()->RemoveObserver(this);\n   display::Screen::GetScreen()->RemoveObserver(this);\n+  [window_ cleanup];\n }\n \n class NativeAppWindowFrameViewMac : public views::NativeFrameViewMac {\ndiff --git a/shell/browser/native_window_views.cc b/shell/browser/native_window_views.cc\nindex 1f6c3957c45ec..d5118ec346a8f 100644\n--- a/shell/browser/native_window_views.cc\n+++ b/shell/browser/native_window_views.cc\n@@ -27,6 +27,7 @@\n #include \"content/public/browser/desktop_media_id.h\"\n #include \"content/public/common/color_parser.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/views/root_view.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n #include \"shell/browser/web_view_manager.h\"\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.h b/shell/browser/ui/cocoa/delayed_native_view_host.h\ndeleted file mode 100644\nindex e7020dba60715..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.h\n+++ /dev/null\n@@ -1,33 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-\n-#include \"ui/views/controls/native/native_view_host.h\"\n-\n-namespace electron {\n-\n-// Automatically attach the native view after the NativeViewHost is attached to\n-// a widget. (Attaching it directly would cause crash.)\n-class DelayedNativeViewHost : public views::NativeViewHost {\n- public:\n-  explicit DelayedNativeViewHost(gfx::NativeView native_view);\n-  ~DelayedNativeViewHost() override;\n-\n-  // disable copy\n-  DelayedNativeViewHost(const DelayedNativeViewHost&) = delete;\n-  DelayedNativeViewHost& operator=(const DelayedNativeViewHost&) = delete;\n-\n-  // views::View:\n-  void ViewHierarchyChanged(\n-      const views::ViewHierarchyChangedDetails& details) override;\n-\n- private:\n-  gfx::NativeView native_view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.mm b/shell/browser/ui/cocoa/delayed_native_view_host.mm\ndeleted file mode 100644\nindex 38b0796555e1f..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.mm\n+++ /dev/null\n@@ -1,23 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-\n-namespace electron {\n-\n-DelayedNativeViewHost::DelayedNativeViewHost(gfx::NativeView native_view)\n-    : native_view_(native_view) {}\n-\n-DelayedNativeViewHost::~DelayedNativeViewHost() = default;\n-\n-void DelayedNativeViewHost::ViewHierarchyChanged(\n-    const views::ViewHierarchyChangedDetails& details) {\n-  if (!details.is_add && native_view())\n-    Detach();\n-  NativeViewHost::ViewHierarchyChanged(details);\n-  if (details.is_add && GetWidget() && !native_view())\n-    Attach(native_view_);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\ndeleted file mode 100644\nindex 4286312573aab..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-\n-#import <AppKit/AppKit.h>\n-\n-#include \"base/apple/owned_objc.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-\n-namespace electron {\n-class InspectableWebContentsViewMac;\n-}\n-\n-using electron::InspectableWebContentsViewMac;\n-\n-@interface NSView (WebContentsView)\n-- (void)setMouseDownCanMoveWindow:(BOOL)can_move;\n-@end\n-\n-@interface ElectronInspectableWebContentsView : BaseView <NSWindowDelegate> {\n- @private\n-  raw_ptr<electron::InspectableWebContentsViewMac> inspectableWebContentsView_;\n-\n-  NSView* __strong fake_view_;\n-  NSWindow* __strong devtools_window_;\n-  BOOL devtools_visible_;\n-  BOOL devtools_docked_;\n-  BOOL devtools_is_first_responder_;\n-  BOOL attached_to_window_;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-}\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view;\n-- (void)notifyDevToolsFocused;\n-- (void)setCornerRadii:(CGFloat)cornerRadius;\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate;\n-- (BOOL)isDevToolsVisible;\n-- (BOOL)isDevToolsFocused;\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate;\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy;\n-- (void)setTitle:(NSString*)title;\n-- (NSString*)getTitle;\n-\n-@end\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\ndeleted file mode 100644\nindex d719fc164e476..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\n+++ /dev/null\n@@ -1,337 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-\n-#include \"content/public/browser/render_widget_host_view.h\"\n-#include \"shell/browser/api/electron_api_web_contents.h\"\n-#include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-#include \"ui/gfx/mac/scoped_cocoa_disable_screen_updates.h\"\n-\n-@implementation ElectronInspectableWebContentsView\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view {\n-  self = [super init];\n-  if (!self)\n-    return nil;\n-\n-  inspectableWebContentsView_ = view;\n-  devtools_visible_ = NO;\n-  devtools_docked_ = NO;\n-  devtools_is_first_responder_ = NO;\n-  attached_to_window_ = NO;\n-\n-  if (inspectableWebContentsView_->inspectable_web_contents()->is_guest()) {\n-    fake_view_ = [[NSView alloc] init];\n-    [fake_view_ setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:fake_view_];\n-  } else {\n-    auto* contents = inspectableWebContentsView_->inspectable_web_contents()\n-                         ->GetWebContents();\n-    auto* contentsView = contents->GetNativeView().GetNativeNSView();\n-    [contentsView setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:contentsView];\n-  }\n-\n-  // See https://code.google.com/p/chromium/issues/detail?id=348490.\n-  [self setWantsLayer:YES];\n-\n-  return self;\n-}\n-\n-- (void)dealloc {\n-  [[NSNotificationCenter defaultCenter] removeObserver:self];\n-}\n-\n-- (void)resizeSubviewsWithOldSize:(NSSize)oldBoundsSize {\n-  [self adjustSubviews];\n-}\n-\n-- (void)viewDidMoveToWindow {\n-  if (attached_to_window_ && !self.window) {\n-    attached_to_window_ = NO;\n-    [[NSNotificationCenter defaultCenter] removeObserver:self];\n-  } else if (!attached_to_window_ && self.window) {\n-    attached_to_window_ = YES;\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(viewDidBecomeFirstResponder:)\n-               name:kViewDidBecomeFirstResponder\n-             object:nil];\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(parentWindowBecameMain:)\n-               name:NSWindowDidBecomeMainNotification\n-             object:nil];\n-  }\n-}\n-\n-- (IBAction)showDevTools:(id)sender {\n-  inspectableWebContentsView_->inspectable_web_contents()->ShowDevTools(true);\n-}\n-\n-- (void)notifyDevToolsFocused {\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsFocused();\n-}\n-\n-- (void)setCornerRadii:(CGFloat)cornerRadius {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-  webContentsView.wantsLayer = YES;\n-  webContentsView.layer.cornerRadius = cornerRadius;\n-}\n-\n-- (void)notifyDevToolsResized {\n-  // When devtools is opened, resizing devtools would not trigger\n-  // UpdateDraggableRegions for WebContents, so we have to notify the window\n-  // to do an update of draggable regions.\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsResized();\n-}\n-\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate {\n-  if (visible == devtools_visible_)\n-    return;\n-\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto* devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  devtools_visible_ = visible;\n-  if (devtools_docked_) {\n-    if (visible) {\n-      // Place the devToolsView under contentsView, notice that we didn't set\n-      // sizes for them until the setContentsResizingStrategy message.\n-      [self addSubview:devToolsView positioned:NSWindowBelow relativeTo:nil];\n-      [self adjustSubviews];\n-\n-      // Focus on web view.\n-      devToolsWebContents->RestoreFocus();\n-    } else {\n-      gfx::ScopedCocoaDisableScreenUpdates disabler;\n-      [devToolsView removeFromSuperview];\n-      [self adjustSubviews];\n-      [self notifyDevToolsResized];\n-    }\n-  } else {\n-    if (visible) {\n-      if (activate) {\n-        [devtools_window_ makeKeyAndOrderFront:nil];\n-      } else {\n-        [devtools_window_ orderBack:nil];\n-      }\n-    } else {\n-      [devtools_window_ setDelegate:nil];\n-      [devtools_window_ close];\n-      devtools_window_ = nil;\n-    }\n-  }\n-}\n-\n-- (BOOL)isDevToolsVisible {\n-  return devtools_visible_;\n-}\n-\n-- (BOOL)isDevToolsFocused {\n-  if (devtools_docked_) {\n-    return [[self window] isKeyWindow] && devtools_is_first_responder_;\n-  } else {\n-    return [devtools_window_ isKeyWindow];\n-  }\n-}\n-\n-// TODO: remove NSWindowStyleMaskTexturedBackground.\n-// https://github.com/electron/electron/issues/43125\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate {\n-  // Revert to no-devtools state.\n-  [self setDevToolsVisible:NO activate:NO];\n-\n-  // Switch to new state.\n-  devtools_docked_ = docked;\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-  if (!docked) {\n-    auto styleMask = NSWindowStyleMaskTitled | NSWindowStyleMaskClosable |\n-                     NSWindowStyleMaskMiniaturizable |\n-                     NSWindowStyleMaskResizable |\n-                     NSWindowStyleMaskTexturedBackground |\n-                     NSWindowStyleMaskUnifiedTitleAndToolbar;\n-    devtools_window_ = [[EventDispatchingWindow alloc]\n-        initWithContentRect:NSMakeRect(0, 0, 800, 600)\n-                  styleMask:styleMask\n-                    backing:NSBackingStoreBuffered\n-                      defer:YES];\n-    [devtools_window_ setDelegate:self];\n-    [devtools_window_ setFrameAutosaveName:@\"electron.devtools\"];\n-    [devtools_window_ setTitle:@\"Developer Tools\"];\n-    [devtools_window_ setReleasedWhenClosed:NO];\n-    [devtools_window_ setAutorecalculatesContentBorderThickness:NO\n-                                                        forEdge:NSMaxYEdge];\n-    [devtools_window_ setContentBorderThickness:24 forEdge:NSMaxYEdge];\n-\n-    NSView* contentView = [devtools_window_ contentView];\n-    devToolsView.frame = contentView.bounds;\n-    devToolsView.autoresizingMask = NSViewWidthSizable | NSViewHeightSizable;\n-\n-    [contentView addSubview:devToolsView];\n-    [devToolsView setMouseDownCanMoveWindow:NO];\n-  } else {\n-    [devToolsView setMouseDownCanMoveWindow:YES];\n-  }\n-  [self setDevToolsVisible:YES activate:activate];\n-}\n-\n-// -Wdeprecated-declarations\n-#pragma clang diagnostic pop\n-\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy {\n-  strategy_.CopyFrom(strategy);\n-  [self adjustSubviews];\n-}\n-\n-- (void)adjustSubviews {\n-  if (![[self subviews] count])\n-    return;\n-\n-  if (![self isDevToolsVisible] || devtools_window_) {\n-    DCHECK_EQ(1u, [[self subviews] count]);\n-    NSView* contents = [[self subviews] objectAtIndex:0];\n-    [contents setFrame:[self bounds]];\n-    return;\n-  }\n-\n-  NSView* devToolsView = [[self subviews] objectAtIndex:0];\n-  NSView* contentsView = [[self subviews] objectAtIndex:1];\n-\n-  DCHECK_EQ(2u, [[self subviews] count]);\n-\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, gfx::Size(NSSizeToCGSize([self bounds].size)),\n-      &new_devtools_bounds, &new_contents_bounds);\n-  [devToolsView setFrame:[self flipRectToNSRect:new_devtools_bounds]];\n-  [contentsView setFrame:[self flipRectToNSRect:new_contents_bounds]];\n-\n-  // Move mask to the devtools area to exclude it from dragging.\n-  NSRect cf = contentsView.frame;\n-  NSRect sb = [self bounds];\n-  NSRect devtools_frame;\n-  if (cf.size.height < sb.size.height) {  // bottom docked\n-    devtools_frame.origin.x = 0;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width;\n-    devtools_frame.size.height = sb.size.height - cf.size.height;\n-  } else {                // left or right docked\n-    if (cf.origin.x > 0)  // left docked\n-      devtools_frame.origin.x = 0;\n-    else  // right docked.\n-      devtools_frame.origin.x = cf.size.width;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width - cf.size.width;\n-    devtools_frame.size.height = sb.size.height;\n-  }\n-\n-  [self notifyDevToolsResized];\n-}\n-\n-- (void)setTitle:(NSString*)title {\n-  [devtools_window_ setTitle:title];\n-}\n-\n-- (NSString*)getTitle {\n-  return [devtools_window_ title];\n-}\n-\n-- (void)viewDidBecomeFirstResponder:(NSNotification*)notification {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-\n-  NSView* view = [notification object];\n-  if ([[webContentsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = NO;\n-    return;\n-  }\n-\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  if (!devToolsWebContents)\n-    return;\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  if ([[devToolsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = YES;\n-    [self notifyDevToolsFocused];\n-  }\n-}\n-\n-- (void)parentWindowBecameMain:(NSNotification*)notification {\n-  NSWindow* parentWindow = [notification object];\n-  if ([self window] == parentWindow && devtools_docked_ &&\n-      devtools_is_first_responder_)\n-    [self notifyDevToolsFocused];\n-}\n-\n-#pragma mark - NSWindowDelegate\n-\n-- (void)windowWillClose:(NSNotification*)notification {\n-  inspectableWebContentsView_->inspectable_web_contents()->CloseDevTools();\n-}\n-\n-- (void)windowDidBecomeMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->RestoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(true);\n-\n-  [self notifyDevToolsFocused];\n-}\n-\n-- (void)windowDidResignMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->StoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(false);\n-}\n-\n-@end\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.h b/shell/browser/ui/cocoa/electron_ns_window.h\nindex 502592313c15d..63ea5355467d4 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.h\n+++ b/shell/browser/ui/cocoa/electron_ns_window.h\n@@ -29,6 +29,8 @@ class ScopedDisableResize {\n \n }  // namespace electron\n \n+class ElectronNativeWindowObserver;\n+\n @interface ElectronNSWindow : NativeWidgetMacNSWindow {\n  @private\n   raw_ptr<electron::NativeWindowMac> shell_;\n@@ -41,6 +43,7 @@ class ScopedDisableResize {\n @property(nonatomic, retain) NSImage* cornerMask;\n - (id)initWithShell:(electron::NativeWindowMac*)shell\n           styleMask:(NSUInteger)styleMask;\n+- (void)cleanup;\n - (electron::NativeWindowMac*)shell;\n - (id)accessibilityFocusedUIElement;\n - (NSRect)originalContentRectForFrameRect:(NSRect)frameRect;\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.mm b/shell/browser/ui/cocoa/electron_ns_window.mm\nindex 5c5f1512f4a3e..30780277d3a5c 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window.mm\n@@ -8,8 +8,6 @@\n #include \"electron/mas.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/native_window_mac.h\"\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/cocoa/electron_preview_item.h\"\n #include \"shell/browser/ui/cocoa/electron_touch_bar.h\"\n #include \"shell/browser/ui/cocoa/root_view_mac.h\"\n@@ -113,6 +111,7 @@ void SwizzleSwipeWithEvent(NSView* view, SEL swiz_selector) {\n                            method_getImplementation(new_swipe_with_event));\n }\n #endif\n+\n }  // namespace\n \n @implementation ElectronNSWindow\n@@ -168,6 +167,10 @@ - (id)initWithShell:(electron::NativeWindowMac*)shell\n   return self;\n }\n \n+- (void)cleanup {\n+  shell_ = nullptr;\n+}\n+\n - (electron::NativeWindowMac*)shell {\n   return shell_;\n }\n@@ -255,6 +258,17 @@ - (void)setFrame:(NSRect)windowFrame display:(BOOL)displayViews {\n     [super setFrame:windowFrame display:displayViews];\n }\n \n+- (void)orderWindow:(NSWindowOrderingMode)place relativeTo:(NSInteger)otherWin {\n+  if (shell_) {\n+    // We initialize the window in headless mode to allow painting before it is\n+    // shown, but we don't want the headless behavior of allowing the window to\n+    // be placed unconstrained.\n+    self.isHeadless = false;\n+    shell_->widget()->DisableHeadlessMode();\n+  }\n+  [super orderWindow:place relativeTo:otherWin];\n+}\n+\n - (id)accessibilityAttributeValue:(NSString*)attribute {\n   if ([attribute isEqual:NSAccessibilityEnabledAttribute])\n     return [NSNumber numberWithBool:YES];\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\nindex d6af0ac6d9bb8..3f7c689bfc8b0 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n@@ -365,6 +365,19 @@ - (void)windowWillClose:(NSNotification*)notification {\n       shell_->GetNativeWindow());\n   auto* bridged_view = bridge_host->GetInProcessNSWindowBridge();\n   bridged_view->OnWindowWillClose();\n+\n+  // Native widget and its compositor have been destroyed upon close. We need\n+  // to detach contents view in order to prevent reusing its layer without\n+  // compositor in the `WebContentsViewMac::CreateViewForWidget`, leading to\n+  // `DCHECK` failure in `BrowserCompositorMac::SetParentUiLayer`.\n+  auto* contents_view =\n+      static_cast<views::WidgetDelegate*>(shell_)->GetContentsView();\n+  if (contents_view) {\n+    auto* parent = contents_view->parent();\n+    if (parent) {\n+      parent->RemoveChildView(contents_view);\n+    }\n+  }\n }\n \n - (BOOL)windowShouldClose:(id)window {\ndiff --git a/shell/browser/ui/inspectable_web_contents.cc b/shell/browser/ui/inspectable_web_contents.cc\nindex ea02168ef5596..75ebdd6441429 100644\n--- a/shell/browser/ui/inspectable_web_contents.cc\n+++ b/shell/browser/ui/inspectable_web_contents.cc\n@@ -297,11 +297,6 @@ class InspectableWebContents::NetworkResourceLoader\n   base::TimeDelta retry_delay_;\n };\n \n-// Implemented separately on each platform.\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents);\n-\n-// static\n // static\n void InspectableWebContents::RegisterPrefs(PrefRegistrySimple* registry) {\n   registry->RegisterDictionaryPref(kDevToolsBoundsPref,\n@@ -317,7 +312,7 @@ InspectableWebContents::InspectableWebContents(\n     : pref_service_(pref_service),\n       web_contents_(std::move(web_contents)),\n       is_guest_(is_guest),\n-      view_(CreateInspectableContentsView(this)) {\n+      view_(new InspectableWebContentsView(this)) {\n   const base::Value* bounds_dict =\n       &pref_service_->GetValue(kDevToolsBoundsPref);\n   if (bounds_dict->is_dict()) {\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.cc b/shell/browser/ui/inspectable_web_contents_view.cc\nindex 946b5071bcc87..e61f008414df4 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.cc\n+++ b/shell/browser/ui/inspectable_web_contents_view.cc\n@@ -5,12 +5,250 @@\n \n #include \"shell/browser/ui/inspectable_web_contents_view.h\"\n \n+#include <memory>\n+#include <utility>\n+\n+#include \"base/memory/raw_ptr.h\"\n+#include \"base/strings/utf_string_conversions.h\"\n+#include \"shell/browser/ui/drag_util.h\"\n+#include \"shell/browser/ui/inspectable_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n+#include \"ui/base/models/image_model.h\"\n+#include \"ui/views/controls/label.h\"\n+#include \"ui/views/controls/webview/webview.h\"\n+#include \"ui/views/widget/widget.h\"\n+#include \"ui/views/widget/widget_delegate.h\"\n+#include \"ui/views/window/client_view.h\"\n+\n namespace electron {\n \n+namespace {\n+\n+class DevToolsWindowDelegate : public views::ClientView,\n+                               public views::WidgetDelegate {\n+ public:\n+  DevToolsWindowDelegate(InspectableWebContentsView* shell,\n+                         views::View* view,\n+                         views::Widget* widget)\n+      : views::ClientView(widget, view),\n+        shell_(shell),\n+        view_(view),\n+        widget_(widget) {\n+    SetOwnedByWidget(true);\n+    set_owned_by_client();\n+\n+    if (shell->GetDelegate())\n+      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n+  }\n+  ~DevToolsWindowDelegate() override = default;\n+\n+  // disable copy\n+  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n+  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n+\n+  // views::WidgetDelegate:\n+  views::View* GetInitiallyFocusedView() override { return view_; }\n+  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n+  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n+  ui::ImageModel GetWindowIcon() override { return icon_; }\n+  views::Widget* GetWidget() override { return widget_; }\n+  const views::Widget* GetWidget() const override { return widget_; }\n+  views::View* GetContentsView() override { return view_; }\n+  views::ClientView* CreateClientView(views::Widget* widget) override {\n+    return this;\n+  }\n+\n+  // views::ClientView:\n+  views::CloseRequestResult OnWindowCloseRequested() override {\n+    shell_->inspectable_web_contents()->CloseDevTools();\n+    return views::CloseRequestResult::kCannotClose;\n+  }\n+\n+ private:\n+  raw_ptr<InspectableWebContentsView> shell_;\n+  raw_ptr<views::View> view_;\n+  raw_ptr<views::Widget> widget_;\n+  ui::ImageModel icon_;\n+};\n+\n+}  // namespace\n+\n InspectableWebContentsView::InspectableWebContentsView(\n     InspectableWebContents* inspectable_web_contents)\n-    : inspectable_web_contents_(inspectable_web_contents) {}\n+    : inspectable_web_contents_(inspectable_web_contents),\n+      devtools_web_view_(new views::WebView(nullptr)),\n+      title_(u\"Developer Tools\") {\n+  if (!inspectable_web_contents_->is_guest() &&\n+      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n+    auto* contents_web_view = new views::WebView(nullptr);\n+    contents_web_view->SetWebContents(\n+        inspectable_web_contents_->GetWebContents());\n+    contents_web_view_ = contents_web_view;\n+  } else {\n+    no_contents_view_ = new views::Label(u\"No content under offscreen mode\");\n+  }\n+\n+  devtools_web_view_->SetVisible(false);\n+  AddChildView(devtools_web_view_.get());\n+  AddChildView(GetContentsView());\n+}\n+\n+InspectableWebContentsView::~InspectableWebContentsView() {\n+  if (devtools_window_)\n+    inspectable_web_contents()->SaveDevToolsBounds(\n+        devtools_window_->GetWindowBoundsInScreen());\n+}\n+\n+void InspectableWebContentsView::SetCornerRadii(\n+    const gfx::RoundedCornersF& corner_radii) {\n+  // WebView won't exist for offscreen rendering.\n+  if (contents_web_view_) {\n+    contents_web_view_->holder()->SetCornerRadii(corner_radii);\n+  }\n+}\n+\n+void InspectableWebContentsView::ShowDevTools(bool activate) {\n+  if (devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = true;\n+  if (devtools_window_) {\n+    devtools_window_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n+    if (activate) {\n+      devtools_window_->Show();\n+    } else {\n+      devtools_window_->ShowInactive();\n+    }\n+\n+    // Update draggable regions to account for the new dock position.\n+    if (GetDelegate())\n+      GetDelegate()->DevToolsResized();\n+  } else {\n+    devtools_web_view_->SetVisible(true);\n+    devtools_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_web_view_->RequestFocus();\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+void InspectableWebContentsView::CloseDevTools() {\n+  if (!devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = false;\n+  if (devtools_window_) {\n+    auto save_bounds = devtools_window_->IsMinimized()\n+                           ? devtools_window_->GetRestoredBounds()\n+                           : devtools_window_->GetWindowBoundsInScreen();\n+    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n+\n+    devtools_window_.reset();\n+    devtools_window_web_view_ = nullptr;\n+    devtools_window_delegate_ = nullptr;\n+  } else {\n+    devtools_web_view_->SetVisible(false);\n+    devtools_web_view_->SetWebContents(nullptr);\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewShowing() {\n+  return devtools_visible_;\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewFocused() {\n+  if (devtools_window_web_view_)\n+    return devtools_window_web_view_->HasFocus();\n+  else if (devtools_web_view_)\n+    return devtools_web_view_->HasFocus();\n+  else\n+    return false;\n+}\n+\n+void InspectableWebContentsView::SetIsDocked(bool docked, bool activate) {\n+  CloseDevTools();\n+\n+  if (!docked) {\n+    devtools_window_ = std::make_unique<views::Widget>();\n+    devtools_window_web_view_ = new views::WebView(nullptr);\n+    devtools_window_delegate_ = new DevToolsWindowDelegate(\n+        this, devtools_window_web_view_, devtools_window_.get());\n+\n+    views::Widget::InitParams params(\n+        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET,\n+        views::Widget::InitParams::TYPE_WINDOW);\n+    params.delegate = devtools_window_delegate_;\n+    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n+\n+#if BUILDFLAG(IS_LINUX)\n+    params.wm_role_name = \"devtools\";\n+    if (GetDelegate())\n+      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n+                                              &params.wm_class_class);\n+#endif\n+\n+    devtools_window_->Init(std::move(params));\n+    devtools_window_->UpdateWindowIcon();\n+    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n+  }\n+\n+  ShowDevTools(activate);\n+}\n+\n+void InspectableWebContentsView::SetContentsResizingStrategy(\n+    const DevToolsContentsResizingStrategy& strategy) {\n+  strategy_.CopyFrom(strategy);\n+  DeprecatedLayoutImmediately();\n+}\n+\n+void InspectableWebContentsView::SetTitle(const std::u16string& title) {\n+  if (devtools_window_) {\n+    title_ = title;\n+    devtools_window_->UpdateWindowTitle();\n+  }\n+}\n+\n+const std::u16string InspectableWebContentsView::GetTitle() {\n+  return title_;\n+}\n+\n+void InspectableWebContentsView::Layout(PassKey) {\n+  if (!devtools_web_view_->GetVisible()) {\n+    GetContentsView()->SetBoundsRect(GetContentsBounds());\n+    // Propagate layout call to all children, for example browser views.\n+    LayoutSuperclass<View>(this);\n+    return;\n+  }\n+\n+  gfx::Size container_size(width(), height());\n+  gfx::Rect new_devtools_bounds;\n+  gfx::Rect new_contents_bounds;\n+  ApplyDevToolsContentsResizingStrategy(\n+      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n+\n+  // DevTools cares about the specific position, so we have to compensate RTL\n+  // layout here.\n+  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n+  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n+\n+  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n+  GetContentsView()->SetBoundsRect(new_contents_bounds);\n+\n+  // Propagate layout call to all children, for example browser views.\n+  LayoutSuperclass<View>(this);\n+\n+  if (GetDelegate())\n+    GetDelegate()->DevToolsResized();\n+}\n+\n+views::View* InspectableWebContentsView::GetContentsView() const {\n+  DCHECK(contents_web_view_ || no_contents_view_);\n \n-InspectableWebContentsView::~InspectableWebContentsView() = default;\n+  return contents_web_view_ ? contents_web_view_ : no_contents_view_;\n+}\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.h b/shell/browser/ui/inspectable_web_contents_view.h\nindex a9c95d477e00d..282d3bf805a97 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.h\n+++ b/shell/browser/ui/inspectable_web_contents_view.h\n@@ -9,13 +9,9 @@\n #include <string>\n \n #include \"base/memory/raw_ptr.h\"\n-#include \"build/build_config.h\"\n-\n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-#include \"ui/views/view.h\"\n-#else\n+#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n #include \"ui/gfx/native_widget_types.h\"\n-#endif\n+#include \"ui/views/view.h\"\n \n class DevToolsContentsResizingStrategy;\n \n@@ -23,23 +19,22 @@ namespace gfx {\n class RoundedCornersF;\n }  // namespace gfx\n \n-#if defined(TOOLKIT_VIEWS)\n namespace views {\n-class View;\n class WebView;\n+class Widget;\n+class WidgetDelegate;\n }  // namespace views\n-#endif\n \n namespace electron {\n \n class InspectableWebContents;\n class InspectableWebContentsViewDelegate;\n \n-class InspectableWebContentsView {\n+class InspectableWebContentsView : public views::View {\n  public:\n   explicit InspectableWebContentsView(\n       InspectableWebContents* inspectable_web_contents);\n-  virtual ~InspectableWebContentsView();\n+  ~InspectableWebContentsView() override;\n \n   InspectableWebContents* inspectable_web_contents() {\n     return inspectable_web_contents_;\n@@ -51,32 +46,40 @@ class InspectableWebContentsView {\n   }\n   InspectableWebContentsViewDelegate* GetDelegate() const { return delegate_; }\n \n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-  // Returns the container control, which has devtools view attached.\n-  virtual views::View* GetView() = 0;\n-#else\n-  virtual gfx::NativeView GetNativeView() const = 0;\n-#endif\n-\n-  virtual void ShowDevTools(bool activate) = 0;\n-  virtual void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) = 0;\n-  // Hide the DevTools view.\n-  virtual void CloseDevTools() = 0;\n-  virtual bool IsDevToolsViewShowing() = 0;\n-  virtual bool IsDevToolsViewFocused() = 0;\n-  virtual void SetIsDocked(bool docked, bool activate) = 0;\n-  virtual void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) = 0;\n-  virtual void SetTitle(const std::u16string& title) = 0;\n-  virtual const std::u16string GetTitle() = 0;\n-\n- protected:\n+  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii);\n+\n+  void ShowDevTools(bool activate);\n+  void CloseDevTools();\n+  bool IsDevToolsViewShowing();\n+  bool IsDevToolsViewFocused();\n+  void SetIsDocked(bool docked, bool activate);\n+  void SetContentsResizingStrategy(\n+      const DevToolsContentsResizingStrategy& strategy);\n+  void SetTitle(const std::u16string& title);\n+  const std::u16string GetTitle();\n+\n+  // views::View:\n+  void Layout(PassKey) override;\n+\n+ private:\n+  views::View* GetContentsView() const;\n+\n   // Owns us.\n   raw_ptr<InspectableWebContents> inspectable_web_contents_;\n \n- private:\n   raw_ptr<InspectableWebContentsViewDelegate> delegate_ =\n       nullptr;  // weak references.\n+\n+  std::unique_ptr<views::Widget> devtools_window_;\n+  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n+  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n+  raw_ptr<views::View> no_contents_view_ = nullptr;\n+  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n+\n+  DevToolsContentsResizingStrategy strategy_;\n+  bool devtools_visible_ = false;\n+  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n+  std::u16string title_;\n };\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.h b/shell/browser/ui/inspectable_web_contents_view_mac.h\ndeleted file mode 100644\nindex 88b4078614f42..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.h\n+++ /dev/null\n@@ -1,42 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-#define ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-\n-@class ElectronInspectableWebContentsView;\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewMac : public InspectableWebContentsView {\n- public:\n-  explicit InspectableWebContentsViewMac(\n-      InspectableWebContents* inspectable_web_contents);\n-  InspectableWebContentsViewMac(const InspectableWebContentsViewMac&) = delete;\n-  InspectableWebContentsViewMac& operator=(\n-      const InspectableWebContentsViewMac&) = delete;\n-  ~InspectableWebContentsViewMac() override;\n-\n-  gfx::NativeView GetNativeView() const override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void ShowDevTools(bool activate) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n- private:\n-  ElectronInspectableWebContentsView* __strong view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.mm b/shell/browser/ui/inspectable_web_contents_view_mac.mm\ndeleted file mode 100644\nindex a3789e09a8fb3..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.mm\n+++ /dev/null\n@@ -1,75 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-\n-#include \"base/strings/sys_string_conversions.h\"\n-#import \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-\n-namespace electron {\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewMac(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewMac::InspectableWebContentsViewMac(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      view_([[ElectronInspectableWebContentsView alloc]\n-          initWithInspectableWebContentsViewMac:this]) {}\n-\n-InspectableWebContentsViewMac::~InspectableWebContentsViewMac() {\n-  [[NSNotificationCenter defaultCenter] removeObserver:view_];\n-  CloseDevTools();\n-}\n-\n-gfx::NativeView InspectableWebContentsViewMac::GetNativeView() const {\n-  return view_;\n-}\n-\n-void InspectableWebContentsViewMac::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // We can assume all four values are identical.\n-  [view_ setCornerRadii:corner_radii.upper_left()];\n-}\n-\n-void InspectableWebContentsViewMac::ShowDevTools(bool activate) {\n-  [view_ setDevToolsVisible:YES activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::CloseDevTools() {\n-  [view_ setDevToolsVisible:NO activate:NO];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewShowing() {\n-  return [view_ isDevToolsVisible];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewFocused() {\n-  return [view_ isDevToolsFocused];\n-}\n-\n-void InspectableWebContentsViewMac::SetIsDocked(bool docked, bool activate) {\n-  [view_ setIsDocked:docked activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  [view_ setContentsResizingStrategy:strategy];\n-}\n-\n-void InspectableWebContentsViewMac::SetTitle(const std::u16string& title) {\n-  [view_ setTitle:base::SysUTF16ToNSString(title)];\n-}\n-\n-const std::u16string InspectableWebContentsViewMac::GetTitle() {\n-  return base::SysNSStringToUTF16([view_ getTitle]);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/frameless_view.cc b/shell/browser/ui/views/frameless_view.cc\nindex c963d1731093a..dcfed5ef695f0 100644\n--- a/shell/browser/ui/views/frameless_view.cc\n+++ b/shell/browser/ui/views/frameless_view.cc\n@@ -5,6 +5,8 @@\n #include \"shell/browser/ui/views/frameless_view.h\"\n \n #include \"shell/browser/native_window_views.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n+#include \"ui/aura/window.h\"\n #include \"ui/base/hit_test.h\"\n #include \"ui/base/metadata/metadata_impl_macros.h\"\n #include \"ui/views/widget/widget.h\"\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.cc b/shell/browser/ui/views/inspectable_web_contents_view_views.cc\ndeleted file mode 100644\nindex 61a5b013ecb12..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.cc\n+++ /dev/null\n@@ -1,257 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/views/inspectable_web_contents_view_views.h\"\n-\n-#include <memory>\n-#include <utility>\n-\n-#include \"base/memory/raw_ptr.h\"\n-#include \"shell/browser/ui/drag_util.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/base/models/image_model.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-#include \"ui/views/controls/label.h\"\n-#include \"ui/views/controls/webview/webview.h\"\n-#include \"ui/views/widget/widget.h\"\n-#include \"ui/views/widget/widget_delegate.h\"\n-#include \"ui/views/window/client_view.h\"\n-\n-namespace electron {\n-\n-namespace {\n-\n-class DevToolsWindowDelegate : public views::ClientView,\n-                               public views::WidgetDelegate {\n- public:\n-  DevToolsWindowDelegate(InspectableWebContentsViewViews* shell,\n-                         views::View* view,\n-                         views::Widget* widget)\n-      : views::ClientView(widget, view),\n-        shell_(shell),\n-        view_(view),\n-        widget_(widget) {\n-    SetOwnedByWidget(true);\n-    set_owned_by_client();\n-\n-    if (shell->GetDelegate())\n-      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n-  }\n-  ~DevToolsWindowDelegate() override = default;\n-\n-  // disable copy\n-  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n-  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n-\n-  // views::WidgetDelegate:\n-  views::View* GetInitiallyFocusedView() override { return view_; }\n-  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n-  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n-  ui::ImageModel GetWindowIcon() override { return icon_; }\n-  views::Widget* GetWidget() override { return widget_; }\n-  const views::Widget* GetWidget() const override { return widget_; }\n-  views::View* GetContentsView() override { return view_; }\n-  views::ClientView* CreateClientView(views::Widget* widget) override {\n-    return this;\n-  }\n-\n-  // views::ClientView:\n-  views::CloseRequestResult OnWindowCloseRequested() override {\n-    shell_->inspectable_web_contents()->CloseDevTools();\n-    return views::CloseRequestResult::kCannotClose;\n-  }\n-\n- private:\n-  raw_ptr<InspectableWebContentsViewViews> shell_;\n-  raw_ptr<views::View> view_;\n-  raw_ptr<views::Widget> widget_;\n-  ui::ImageModel icon_;\n-};\n-\n-}  // namespace\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewViews(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewViews::InspectableWebContentsViewViews(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      devtools_web_view_(new views::WebView(nullptr)),\n-      title_(u\"Developer Tools\") {\n-  if (!inspectable_web_contents_->is_guest() &&\n-      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n-    auto* contents_web_view = new views::WebView(nullptr);\n-    contents_web_view->SetWebContents(\n-        inspectable_web_contents_->GetWebContents());\n-    contents_view_ = contents_web_view_ = contents_web_view;\n-  } else {\n-    contents_view_ = new views::Label(u\"No content under offscreen mode\");\n-  }\n-\n-  devtools_web_view_->SetVisible(false);\n-  AddChildView(devtools_web_view_.get());\n-  AddChildView(contents_view_.get());\n-}\n-\n-InspectableWebContentsViewViews::~InspectableWebContentsViewViews() {\n-  if (devtools_window_)\n-    inspectable_web_contents()->SaveDevToolsBounds(\n-        devtools_window_->GetWindowBoundsInScreen());\n-}\n-\n-views::View* InspectableWebContentsViewViews::GetView() {\n-  return this;\n-}\n-\n-void InspectableWebContentsViewViews::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // WebView won't exist for offscreen rendering.\n-  if (contents_web_view_) {\n-    contents_web_view_->holder()->SetCornerRadii(\n-        gfx::RoundedCornersF(corner_radii));\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::ShowDevTools(bool activate) {\n-  if (devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = true;\n-  if (devtools_window_) {\n-    devtools_window_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n-    if (activate) {\n-      devtools_window_->Show();\n-    } else {\n-      devtools_window_->ShowInactive();\n-    }\n-\n-    // Update draggable regions to account for the new dock position.\n-    if (GetDelegate())\n-      GetDelegate()->DevToolsResized();\n-  } else {\n-    devtools_web_view_->SetVisible(true);\n-    devtools_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_web_view_->RequestFocus();\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::CloseDevTools() {\n-  if (!devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = false;\n-  if (devtools_window_) {\n-    auto save_bounds = devtools_window_->IsMinimized()\n-                           ? devtools_window_->GetRestoredBounds()\n-                           : devtools_window_->GetWindowBoundsInScreen();\n-    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n-\n-    devtools_window_.reset();\n-    devtools_window_web_view_ = nullptr;\n-    devtools_window_delegate_ = nullptr;\n-  } else {\n-    devtools_web_view_->SetVisible(false);\n-    devtools_web_view_->SetWebContents(nullptr);\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewShowing() {\n-  return devtools_visible_;\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewFocused() {\n-  if (devtools_window_web_view_)\n-    return devtools_window_web_view_->HasFocus();\n-  else if (devtools_web_view_)\n-    return devtools_web_view_->HasFocus();\n-  else\n-    return false;\n-}\n-\n-void InspectableWebContentsViewViews::SetIsDocked(bool docked, bool activate) {\n-  CloseDevTools();\n-\n-  if (!docked) {\n-    devtools_window_ = std::make_unique<views::Widget>();\n-    devtools_window_web_view_ = new views::WebView(nullptr);\n-    devtools_window_delegate_ = new DevToolsWindowDelegate(\n-        this, devtools_window_web_view_, devtools_window_.get());\n-\n-    views::Widget::InitParams params{\n-        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET};\n-    params.ownership = views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;\n-    params.delegate = devtools_window_delegate_;\n-    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n-\n-#if BUILDFLAG(IS_LINUX)\n-    params.wm_role_name = \"devtools\";\n-    if (GetDelegate())\n-      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n-                                              &params.wm_class_class);\n-#endif\n-\n-    devtools_window_->Init(std::move(params));\n-    devtools_window_->UpdateWindowIcon();\n-    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n-  }\n-\n-  ShowDevTools(activate);\n-}\n-\n-void InspectableWebContentsViewViews::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  strategy_.CopyFrom(strategy);\n-  DeprecatedLayoutImmediately();\n-}\n-\n-void InspectableWebContentsViewViews::SetTitle(const std::u16string& title) {\n-  if (devtools_window_) {\n-    title_ = title;\n-    devtools_window_->UpdateWindowTitle();\n-  }\n-}\n-\n-const std::u16string InspectableWebContentsViewViews::GetTitle() {\n-  return title_;\n-}\n-\n-void InspectableWebContentsViewViews::Layout(PassKey) {\n-  if (!devtools_web_view_->GetVisible()) {\n-    contents_view_->SetBoundsRect(GetContentsBounds());\n-    // Propagate layout call to all children, for example browser views.\n-    LayoutSuperclass<View>(this);\n-    return;\n-  }\n-\n-  gfx::Size container_size(width(), height());\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n-\n-  // DevTools cares about the specific position, so we have to compensate RTL\n-  // layout here.\n-  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n-  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n-\n-  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n-  contents_view_->SetBoundsRect(new_contents_bounds);\n-\n-  // Propagate layout call to all children, for example browser views.\n-  LayoutSuperclass<View>(this);\n-\n-  if (GetDelegate())\n-    GetDelegate()->DevToolsResized();\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.h b/shell/browser/ui/views/inspectable_web_contents_view_views.h\ndeleted file mode 100644\nindex 36554a497d6f2..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.h\n+++ /dev/null\n@@ -1,63 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-#define ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-\n-#include <memory>\n-\n-#include \"base/compiler_specific.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-#include \"third_party/skia/include/core/SkRegion.h\"\n-#include \"ui/views/view.h\"\n-\n-namespace views {\n-class WebView;\n-class Widget;\n-class WidgetDelegate;\n-}  // namespace views\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewViews : public InspectableWebContentsView,\n-                                        public views::View {\n- public:\n-  explicit InspectableWebContentsViewViews(\n-      InspectableWebContents* inspectable_web_contents);\n-  ~InspectableWebContentsViewViews() override;\n-\n-  // InspectableWebContentsView:\n-  views::View* GetView() override;\n-  void ShowDevTools(bool activate) override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n-  // views::View:\n-  void Layout(PassKey) override;\n-\n- private:\n-  std::unique_ptr<views::Widget> devtools_window_;\n-  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n-  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n-  raw_ptr<views::View> contents_view_ = nullptr;\n-  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-  bool devtools_visible_ = false;\n-  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n-  std::u16string title_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n", "instance_id": "electron__electron-45238", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: an `EXCEPTION_ACCESS_VIOLATION` crash occurs in Electron when `BrowserWindow.destroy()` is called under specific conditions (e.g., when a window is manually closed before an IPC event is triggered). The expected and actual behaviors are outlined with code snippets, and a stack trace is provided for debugging context. Additionally, links to test cases and related issues are included, which help in reproducing the problem. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly clarify the root cause of the crash (e.g., whether it's a memory access issue, a race condition, or a lifecycle management problem in Electron's window handling). The constraints or specific conditions under which the crash consistently occurs are not fully detailed beyond the provided test case. Edge cases, such as different window states or user interactions, are not mentioned. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Scope and Depth of Code Changes**: The code changes span multiple files and modules within the Electron codebase, affecting core components like window management (`NativeWindowMac`, `ElectronNSWindow`), UI rendering (`InspectableWebContentsView`), and platform-specific logic (macOS and Windows via Chromium patches). The modifications include removing deprecated or problematic macOS-specific UI handling code (e.g., `DelayedNativeViewHost`, `ElectronInspectableWebContentsView`), adding new methods to manage headless mode, and ensuring proper cleanup to prevent crashes. These changes impact the system's architecture, particularly in how windows and their associated views are managed and destroyed, requiring a deep understanding of Electron's integration with Chromium's UI stack.\n\n2. **Number of Technical Concepts**: Solving this issue requires familiarity with several advanced concepts, including Electron's window lifecycle management, Chromium's `views` framework, macOS-specific Cocoa APIs (e.g., `NSWindow`, `NSVisualEffectView`), and V8 JavaScript engine integration (given the crash stack trace involves V8 internals). Additionally, understanding headless mode behavior, inter-process communication (IPC), and platform-specific rendering pipelines is necessary. The patches to Chromium indicate a need to modify upstream behavior, which adds complexity due to the need to align with Chromium's design patterns and ensure compatibility.\n\n3. **Potential Edge Cases and Error Handling**: The problem involves a crash triggered by specific user interactions (manual window closure before an IPC event), suggesting that edge cases around window destruction, event ordering, and state management are critical. The code changes address these by adding cleanup logic (e.g., detaching views to prevent reuse without a compositor) and handling headless mode transitions, but the problem statement does not fully enumerate other potential edge cases (e.g., multiple windows, rapid open/close cycles, or different OS versions). Implementing robust error handling for these scenarios adds to the difficulty.\n\n4. **Overall Complexity**: The combination of platform-specific code (macOS and Windows), integration with a large and complex codebase like Electron/Chromium, and the need to debug a low-level crash (access violation) makes this a challenging problem. It requires not only coding skills but also debugging expertise, familiarity with Electron's internals, and the ability to navigate and modify a multi-layered architecture without introducing regressions.\n\nWhile not at the extreme end of difficulty (e.g., requiring novel algorithm design or system-level innovations), this problem demands significant expertise and careful handling of complex interactions, justifying a score of 0.75.\n", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.95, "human_difficulty_explanation": "This requires an understanding of the macOS and Windows code cores, which is difficult even for human experts to handle, and should be set to the highest difficulty of 0.95"}
{"problem_statement": "[Bug]: protocol.handle fails when filename contains '#'\n### Preflight Checklist\n\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n30.0.2\n\n### What operating system are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 10 version 22H2\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nThe image should display as normal.\n\n### Actual Behavior\n\nWhen you're handling a file:// protocol request, it's being treated like a regular URL. However, the file:// protocol is different from HTTP or HTTPS URLs in how it handles characters like #. In a file:// URL, the # character is typically part of the file or directory name and is not treated as a fragment identifier like in HTTP URLs.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/KBriscoe/550df36cd29a4d27a7672f1404a9e990\n\n### Additional Information\n\nIf using the gist, the filepaths need to be updated in the renderer.js to actual images. The issue is when the image contains '#' in my case and I looked through the protocol.handle and saw it was treating it like a web request I believe where # usually means to truncate off the rest of the request. So it ends up trying to get an incorrect path item.\n", "patch": "diff --git a/docs/api/protocol.md b/docs/api/protocol.md\nindex 6d2de18751de4..3f4ce799a1370 100644\n--- a/docs/api/protocol.md\n+++ b/docs/api/protocol.md\n@@ -9,10 +9,14 @@ An example of implementing a protocol that has the same effect as the\n \n ```js\n const { app, protocol, net } = require('electron')\n+const path = require('node:path')\n+const url = require('node:url')\n \n app.whenReady().then(() => {\n-  protocol.handle('atom', (request) =>\n-    net.fetch('file://' + request.url.slice('atom://'.length)))\n+  protocol.handle('atom', (request) => {\n+    const filePath = request.url.slice('atom://'.length)\n+    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+  })\n })\n ```\n \n@@ -42,7 +46,7 @@ app.whenReady().then(() => {\n \n   ses.protocol.handle('atom', (request) => {\n     const filePath = request.url.slice('atom://'.length)\n-    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+    return net.fetch(url.pathToFileURL(path.resolve(__dirname, filePath)).toString())\n   })\n \n   const mainWindow = new BrowserWindow({ webPreferences: { partition } })\n", "instance_id": "electron__electron-42111", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `protocol.handle` function in Electron fails when a filename contains a '#' character due to it being treated as a fragment identifier like in HTTP URLs, rather than part of the file path in a `file://` URL. The expected behavior (image should display normally) and actual behavior (incorrect path resolution due to truncation at '#') are provided, along with a test case gist URL for reproduction. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the full range of problematic characters beyond '#', nor does it specify if this issue affects only certain file types or operating systems beyond Windows. Additionally, while the gist is referenced, it requires manual filepath updates, which adds a small layer of uncertainty for someone trying to replicate the issue. Overall, the statement is valid and clear but lacks comprehensive edge case details and explicit constraints.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`docs/api/protocol.md`) and involve modifying a small section of example code for the `protocol.handle` function. The changes do not impact the broader Electron codebase or architecture but are limited to updating documentation with a more robust way to handle file paths using `path.resolve` and `url.pathToFileURL`. The amount of code change is minimal, focusing on a specific logic adjustment.\n\n2. **Technical Concepts Involved**: Solving this requires basic familiarity with Node.js modules like `path` and `url`, as well as an understanding of how Electron's `protocol.handle` and `net.fetch` work with custom protocols and file URLs. The concept of URL parsing and file path resolution is straightforward for someone with moderate experience in JavaScript/Node.js. No advanced algorithms, design patterns, or domain-specific knowledge beyond Electron's protocol handling are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement highlights a specific edge case (filenames with '#'), and the code change addresses it by ensuring proper file path resolution. However, the solution does not introduce complex error handling logic beyond using standard path resolution functions. Additional edge cases (e.g., other special characters, invalid paths) are not mentioned or addressed in the provided changes, keeping the complexity low.\n\n4. **Overall Complexity**: The task involves understanding a specific bug in URL handling and applying a simple fix through proper path manipulation. It does not require deep knowledge of the Electron codebase or significant architectural changes. The problem is approachable for someone with basic to intermediate experience in Electron or Node.js development.\n\nThus, a difficulty score of 0.35 reflects the simplicity of the fix, the limited scope of changes, and the straightforward technical concepts involved, while acknowledging the need for some understanding of Electron's protocol handling and file URL logic.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Default export values are ignored if negative\n### Tested versions\n\n- Reproducible in 4.5.dev [215acd52e82f4c575abb715e25e54558deeef998]\n- Not reproducible in 4.4.1 and earlier\n\n### System information\n\nGodot v4.5.dev.mono (215acd52e) - Linux Mint 22.1 (Xia) on X11 - X11 display driver, Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (nvidia; 550.120) - 13th Gen Intel(R) Core(TM) i5-13600KF (20 threads)\n\n### Issue description\n\nWhen setting a default value to an export property, if the value is negative, the editor does not recognize the value as the default. Setting the value to `0` will not be saved to the `.tscn` since the editor still thinks it's the default value for the type.\n\n![Image](https://github.com/user-attachments/assets/66e7fecb-c086-44b8-89a9-176bad5edd4f)\n\n![Image](https://github.com/user-attachments/assets/a64167a0-7273-4884-8b16-4d789572ad57)\n\n![Image](https://github.com/user-attachments/assets/f90f40fc-615c-4057-9b29-5713cf95ca07)\n\n### Steps to reproduce\n\nCreate a Node with a script.\nAdd an export property of type `int` and set the default value to a negative number.\nAdd the node to scene.\nSave and reopen the scene.\n\n### Minimal reproduction project (MRP)\n\n[ExportTest.zip](https://github.com/user-attachments/files/19725812/ExportTest.zip)\n", "patch": "diff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\nindex f201b7c8d8dd..4caf51dc5a01 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\n@@ -22,7 +22,7 @@ partial class ExportedFields\n         values.Add(PropertyName.@_fieldInt16, global::Godot.Variant.From<short>(___fieldInt16_default_value));\n         int ___fieldInt32_default_value = 10;\n         values.Add(PropertyName.@_fieldInt32, global::Godot.Variant.From<int>(___fieldInt32_default_value));\n-        long ___fieldInt64_default_value = 10;\n+        long ___fieldInt64_default_value = -10_000;\n         values.Add(PropertyName.@_fieldInt64, global::Godot.Variant.From<long>(___fieldInt64_default_value));\n         byte ___fieldByte_default_value = 10;\n         values.Add(PropertyName.@_fieldByte, global::Godot.Variant.From<byte>(___fieldByte_default_value));\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\nindex ce154cad8e88..0bf0b0845a45 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\n@@ -36,7 +36,7 @@ partial class ExportedProperties\n         values.Add(PropertyName.@PropertyInt16, global::Godot.Variant.From<short>(__PropertyInt16_default_value));\n         int __PropertyInt32_default_value = 10;\n         values.Add(PropertyName.@PropertyInt32, global::Godot.Variant.From<int>(__PropertyInt32_default_value));\n-        long __PropertyInt64_default_value = 10;\n+        long __PropertyInt64_default_value = -10_000;\n         values.Add(PropertyName.@PropertyInt64, global::Godot.Variant.From<long>(__PropertyInt64_default_value));\n         byte __PropertyByte_default_value = 10;\n         values.Add(PropertyName.@PropertyByte, global::Godot.Variant.From<byte>(__PropertyByte_default_value));\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\nindex 0938d10afe58..07ae5cb68427 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\n@@ -9,7 +9,7 @@ public partial class ExportedFields : GodotObject\n     [Export] private SByte _fieldSByte = 10;\n     [Export] private Int16 _fieldInt16 = 10;\n     [Export] private Int32 _fieldInt32 = 10;\n-    [Export] private Int64 _fieldInt64 = 10;\n+    [Export] private Int64 _fieldInt64 = -10_000;\n     [Export] private Byte _fieldByte = 10;\n     [Export] private UInt16 _fieldUInt16 = 10;\n     [Export] private UInt32 _fieldUInt32 = 10;\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\nindex 9ae23066fc4b..d7fcdc6b1b58 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\n@@ -97,7 +97,7 @@ public String LamdaPropertyString\n     [Export] private SByte PropertySByte { get; set; } = 10;\n     [Export] private Int16 PropertyInt16 { get; set; } = 10;\n     [Export] private Int32 PropertyInt32 { get; set; } = 10;\n-    [Export] private Int64 PropertyInt64 { get; set; } = 10;\n+    [Export] private Int64 PropertyInt64 { get; set; } = -10_000;\n     [Export] private Byte PropertyByte { get; set; } = 10;\n     [Export] private UInt16 PropertyUInt16 { get; set; } = 10;\n     [Export] private UInt32 PropertyUInt32 { get; set; } = 10;\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\nindex fff32a108004..6c3824711f8c 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\n@@ -430,6 +430,13 @@ private static bool IsStaticallyResolvable(ExpressionSyntax expression, Semantic\n                 return true;\n             }\n \n+            // Handle negative literals (e.g., `-10`)\n+            if (expression is PrefixUnaryExpressionSyntax { Operand: LiteralExpressionSyntax } &&\n+                expression.Kind() == SyntaxKind.UnaryMinusExpression)\n+            {\n+                return true;\n+            }\n+\n             // Handle identifiers (e.g., variable names)\n             if (expression is IdentifierNameSyntax identifier)\n             {\n", "instance_id": "godotengine__godot-105352", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: default export values for properties in Godot are ignored if they are negative, leading to incorrect behavior in the editor when saving scenes. It provides specific version information, system details, steps to reproduce, and even a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities. For instance, the problem statement does not explicitly define the expected behavior (e.g., should negative values be saved as default in the `.tscn` file, or is there another intended fix?). Additionally, edge cases or constraints (e.g., specific integer ranges or other property types affected) are not mentioned, which could impact the solution's completeness. Overall, while the issue is well-documented with examples and reproduction steps, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are relatively localized, affecting a few files in the Godot.NET SDK module. The modifications involve updating default values in test data (e.g., changing a default value from 10 to -10,000) and adding logic in the `ScriptPropertyDefValGenerator.cs` to handle negative literals. The changes do not appear to impact the broader system architecture or require extensive refactoring, as they are confined to specific test cases and a single generator function. The amount of code change is minimal, with only a few lines added or modified per file.\n\n2. **Number of Technical Concepts**: Solving this issue requires understanding C# syntax (specifically handling unary minus expressions in syntax trees), familiarity with Godot's export property system, and some knowledge of source generators in .NET. These concepts are not overly complex for a developer with moderate experience in C# and code generation. The fix involves recognizing and supporting negative literals in the syntax parser, which is a straightforward extension of existing logic.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases beyond negative values, and the code changes do not introduce significant error handling logic. However, a developer might need to consider whether other unary operations or complex expressions should be handled similarly, though this is not evident from the provided diff. The complexity of edge cases appears low at this stage.\n\n4. **Overall Complexity**: The issue requires understanding a specific bug in the editor's handling of default values and making targeted changes to support negative numbers in the source generator. While it involves some logic modification (e.g., updating the parser to handle unary minus expressions), it does not require deep architectural changes or advanced domain-specific knowledge beyond the Godot/.NET context. The test data updates suggest this is partly a validation or test coverage issue rather than a core system problem.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires moderate understanding of the codebase and simple modifications, with minimal impact on the overall system. It is slightly above the lower end of the easy range due to the need to understand source generators and syntax tree manipulation, which might be unfamiliar to junior developers but are routine for those with a few years of experience.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Hashtag comments after \"#region\" command won't fold the multiline comment unless there is space.\n### Tested versions\n\nV4.3\n\n### System information\n\nWin11\n\n### Issue description\n\nWhen putting \"#region\" command, the hashtag comments after it won't fold unless there is a space between. Happens with both a single hashtag and double hashtag comments. But it won't happen with triple quotes -comment.\n\n### Steps to reproduce\n\nAfter command \"#region\" add \"#\" or \"##\" comment next line without any space.\n\n### Minimal reproduction project (MRP)\n\n![Image](https://github.com/user-attachments/assets/40e5627f-2a48-4c93-a8e2-b9fce6acbd5c)\n", "patch": "diff --git a/scene/gui/code_edit.cpp b/scene/gui/code_edit.cpp\nindex 9722b5e2eefa..870c5bbf842d 100644\n--- a/scene/gui/code_edit.cpp\n+++ b/scene/gui/code_edit.cpp\n@@ -1645,12 +1645,12 @@ bool CodeEdit::can_fold_line(int p_line) const {\n \t\tif (delimiter_end_line == p_line) {\n \t\t\t/* Check we are the start of the block. */\n \t\t\tif (p_line - 1 >= 0) {\n-\t\t\t\tif ((in_string != -1 && is_in_string(p_line - 1) != -1) || (in_comment != -1 && is_in_comment(p_line - 1) != -1)) {\n+\t\t\t\tif ((in_string != -1 && is_in_string(p_line - 1) != -1) || (in_comment != -1 && is_in_comment(p_line - 1) != -1 && !is_line_code_region_start(p_line - 1) && !is_line_code_region_end(p_line - 1))) {\n \t\t\t\t\treturn false;\n \t\t\t\t}\n \t\t\t}\n \t\t\t/* Check it continues for at least one line. */\n-\t\t\treturn ((in_string != -1 && is_in_string(p_line + 1) != -1) || (in_comment != -1 && is_in_comment(p_line + 1) != -1));\n+\t\t\treturn ((in_string != -1 && is_in_string(p_line + 1) != -1) || (in_comment != -1 && is_in_comment(p_line + 1) != -1 && !is_line_code_region_start(p_line + 1) && !is_line_code_region_end(p_line + 1)));\n \t\t}\n \t\treturn ((in_string != -1 && is_in_string(delimiter_end_line) != -1) || (in_comment != -1 && is_in_comment(delimiter_end_line) != -1));\n \t}\n@@ -1705,6 +1705,10 @@ void CodeEdit::fold_line(int p_line) {\n \t\t\t\t\tif ((in_string != -1 && is_in_string(i) == -1) || (in_comment != -1 && is_in_comment(i) == -1)) {\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n+\t\t\t\t\tif (in_comment != -1 && (is_line_code_region_start(i) || is_line_code_region_end(i))) {\n+\t\t\t\t\t\t// A code region tag should split a comment block, ending it early.\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t\tend_line = i;\n \t\t\t\t}\n \t\t\t}\n", "instance_id": "godotengine__godot-105007", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the \"#region\" command in a code editor does not fold hashtag comments (single or double) unless there is a space between the command and the comment. It also specifies that this issue does not occur with triple-quote comments and provides steps to reproduce the issue along with a minimal reproduction example (via an image). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should folding work without a space, or is a space required by design?). Additionally, it lacks clarity on whether this is a bug or a feature request, and there are no explicit mentions of edge cases or constraints (e.g., specific languages or comment styles beyond hashtags). While the intent is understandable, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided diff shows modifications to a single file (`code_edit.cpp`) in a specific class or module related to code folding logic. The changes are localized to two functions (`can_fold_line` and `fold_line`), involving a small number of lines (adding conditions to handle code region tags within comments). There is no indication of widespread impact on the system's architecture or interactions with other modules, making the scope relatively narrow.\n\n2. **Technical Concepts Involved**: Solving this requires understanding basic C++ syntax and control flow, as well as familiarity with the specific codebase's logic for handling code folding, comments, and region delimiters. The concepts involved\u2014checking for comment states and region tags\u2014are not inherently complex and do not require advanced language features, libraries, or algorithms. It appears to be a straightforward bug fix rather than a feature implementation or architectural change.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest consideration of scenarios where a code region tag appears within a comment block (e.g., splitting a comment block early if a region tag is encountered). The modifications add logic to handle such cases, but they do not appear particularly complex or numerous. Error handling requirements seem minimal, as the changes focus on adjusting existing conditional checks rather than introducing new error paths.\n\n4. **Overall Complexity**: The task involves understanding a specific part of the code editor's folding mechanism and making targeted modifications. While it requires some familiarity with the codebase's internal logic (e.g., functions like `is_line_code_region_start` and `is_in_comment`), it does not demand deep architectural knowledge or extensive refactoring. The problem is more about tweaking existing behavior than designing new functionality.\n\nGiven these points, a score of 0.35 reflects an \"Easy\" task that requires moderate understanding of the code logic and simple modifications to address the issue. It is slightly above the lower end of the easy range due to the need to understand the specific folding logic and ensure the fix does not introduce unintended side effects in comment handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[GUI] Setting a control's recursive mode to disabled does not work on start\n### Tested versions\n\nlatest main branch [2303ce843a362cf5497ca3336451de23793eb711]\n\n### System information\n\nGodot v4.5.dev (2303ce843) - Windows 10 (build 19044) - Multi-window, 4 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4060 Ti (NVIDIA; 32.0.15.7260) - AMD Ryzen 9 5900X 12-Core Processor (24 threads)\n\n### Issue description\n\n#97495 introduces properties for managing children's controls' focus mode and mouse filters. However, this won't work if you set the recursive behavior to `Disable` in the editor.\n\n### Steps to reproduce\n\nhttps://github.com/user-attachments/assets/c498932f-8874-4a14-a693-fe0e09b74443\n\n\n### Minimal reproduction project (MRP)\n\n[MrpRecursiveGuiDisable.zip](https://github.com/user-attachments/files/19391423/MrpRecursiveGuiDisable.zip)\n", "patch": "diff --git a/scene/gui/control.cpp b/scene/gui/control.cpp\nindex a64de8fb3c5d..8d34746529e7 100644\n--- a/scene/gui/control.cpp\n+++ b/scene/gui/control.cpp\n@@ -1880,16 +1880,20 @@ void Control::set_mouse_recursive_behavior(RecursiveBehavior p_recursive_mouse_b\n \tif (data.mouse_recursive_behavior == p_recursive_mouse_behavior) {\n \t\treturn;\n \t}\n+\t_set_mouse_recursive_behavior_ignore_cache(p_recursive_mouse_behavior);\n+}\n+\n+void Control::_set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior) {\n \tdata.mouse_recursive_behavior = p_recursive_mouse_behavior;\n \tif (p_recursive_mouse_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n+\t\t\t_propagate_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n+\t\t_propagate_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n \t}\n \n \tif (get_viewport()) {\n@@ -2064,16 +2068,20 @@ void Control::set_focus_recursive_behavior(RecursiveBehavior p_recursive_focus_b\n \tif (data.focus_recursive_behavior == p_recursive_focus_behavior) {\n \t\treturn;\n \t}\n+\t_set_focus_recursive_behavior_ignore_cache(p_recursive_focus_behavior);\n+}\n+\n+void Control::_set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_focus_behavior) {\n \tdata.focus_recursive_behavior = p_recursive_focus_behavior;\n \tif (p_recursive_focus_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n+\t\t\t_propagate_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_focus_behavior_recursively(p_recursive_focus_behavior, false);\n+\t\t_propagate_focus_behavior_recursively(p_recursive_focus_behavior, false);\n \t}\n }\n \n@@ -2449,7 +2457,7 @@ bool Control::_is_focus_disabled_recursively() const {\n \treturn false;\n }\n \n-void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n \tif (is_inside_tree() && (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED || (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_INHERITED && p_focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED)) && has_focus()) {\n \t\trelease_focus();\n \t}\n@@ -2463,7 +2471,7 @@ void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_focus_behavior_recursively(p_focus_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_focus_behavior_recursively(p_focus_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -2480,7 +2488,7 @@ bool Control::_is_parent_mouse_disabled() const {\n \treturn false;\n }\n \n-void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n \tif (p_skip_non_inherited && data.mouse_recursive_behavior != RECURSIVE_BEHAVIOR_INHERITED) {\n \t\treturn;\n \t}\n@@ -2490,7 +2498,7 @@ void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -3450,8 +3458,8 @@ void Control::_notification(int p_notification) {\n \n \t\t\t_update_layout_mode();\n \n-\t\t\tset_focus_recursive_behavior(data.focus_recursive_behavior);\n-\t\t\tset_mouse_recursive_behavior(data.mouse_recursive_behavior);\n+\t\t\t_set_focus_recursive_behavior_ignore_cache(data.focus_recursive_behavior);\n+\t\t\t_set_mouse_recursive_behavior_ignore_cache(data.mouse_recursive_behavior);\n \t\t} break;\n \n \t\tcase NOTIFICATION_UNPARENTED: {\ndiff --git a/scene/gui/control.h b/scene/gui/control.h\nindex 8188b3ba31d0..b2001fdd259f 100644\n--- a/scene/gui/control.h\n+++ b/scene/gui/control.h\n@@ -330,8 +330,10 @@ class Control : public CanvasItem {\n \tvoid _window_find_focus_neighbor(const Vector2 &p_dir, Node *p_at, const Rect2 &p_rect, const Rect2 &p_clamp, real_t p_min, real_t &r_closest_dist_squared, Control **r_closest);\n \tControl *_get_focus_neighbor(Side p_side, int p_count = 0);\n \tbool _is_focus_disabled_recursively() const;\n-\tvoid _apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n-\tvoid _apply_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n+\tvoid _set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n \n \t// Theming.\n \n", "instance_id": "godotengine__godot-104444", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: setting a control's recursive mode to \"Disable\" does not work as expected when initialized in the editor. It provides context about the affected feature (focus mode and mouse filters for GUI controls), references a related issue (#97495), and includes system information, tested versions, and a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. The exact expected behavior when recursive mode is set to \"Disable\" is not explicitly described, nor are the specific conditions under which the issue manifests (e.g., does it fail only on start, or under other scenarios as well?). Additionally, the steps to reproduce are provided as a link to an asset, which is not directly accessible in the text, making it less comprehensive for immediate understanding. Edge cases or specific failure scenarios are also not detailed in the description. Thus, while the problem is valid and mostly clear, it lacks some minor but important details for full clarity.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`control.cpp`) and its associated header (`control.h`) in the Godot engine's GUI module. The changes involve renaming functions (e.g., `_apply_*_behavior_recursively` to `_propagate_*_behavior_recursively`) and introducing new helper methods to bypass caching logic during initialization, indicating a bug fix related to initialization behavior. The amount of code change is moderate, with modifications to several related functions but no major architectural impact.\n\nSecond, the technical concepts required include an understanding of GUI control hierarchies, recursive behavior propagation, and initialization logic in a game engine context (Godot). Familiarity with C++ (used in Godot's codebase) and object-oriented design is necessary, but the concepts are not overly complex for someone with moderate experience in systems programming or game development. The changes also require understanding the interaction between parent and child controls in a tree structure, which adds a layer of complexity but is still within a manageable scope.\n\nThird, the problem does not explicitly mention edge cases or error handling requirements in the statement, but the code changes suggest a focus on ensuring proper behavior during initialization (e.g., ignoring cached values). There are no significant additions to error handling logic in the diff, which keeps the complexity moderate. However, potential edge cases like nested control hierarchies or dynamic changes to recursive behavior might need consideration, though they are not evident in the provided changes.\n\nOverall, this problem requires understanding multiple related concepts (GUI control behavior, initialization, and recursive propagation) and making targeted but non-trivial modifications. It does not demand deep architectural changes or advanced domain-specific knowledge beyond typical game engine development, placing it in the medium difficulty range at 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "ScrollContainer focus StyleBox is not clipped by parent\n### Tested versions\n\nv4.4.dev6.official [1f47e4c4e]\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\n![Image](https://github.com/user-attachments/assets/14590874-4426-4de5-919b-caab8b9a6239)\n\nPR https://github.com/godotengine/godot/pull/97521 added a focus style for ScrollContainer this has the same problem as following issues:\n\nTree:\nhttps://github.com/godotengine/godot/issues/100063\nhttps://github.com/godotengine/godot/issues/88749\nhttps://github.com/godotengine/godot/issues/74670\n\n\n\nItemList:\nhttps://github.com/godotengine/godot/issues/77919\n\n\n### Steps to reproduce\n\nA ScrollContainer inside another ScrollContainer\nAdd some content to both\nEnable draw_focus_border for second ScrollContainer\nSelect something in the second ScrollContainer so it gets focus\nScroll the first ScrollContainer\n\n### Minimal reproduction project (MRP)\n\n[scrollfocus.zip](https://github.com/user-attachments/files/18052689/scrollfocus.zip)\n\n", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 0fbb74939ccd..54a25c62438f 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -4956,12 +4956,6 @@ void EditorInspector::_clear_current_favorites() {\n \tupdate_tree();\n }\n \n-void EditorInspector::_update_theme() {\n-\tupdating_theme = true;\n-\tadd_theme_style_override(SceneStringName(panel), get_theme_stylebox(SceneStringName(panel), SNAME(\"Tree\")));\n-\tupdating_theme = false;\n-}\n-\n void EditorInspector::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_TRANSLATION_CHANGED: {\n@@ -4989,17 +4983,11 @@ void EditorInspector::_notification(int p_what) {\n \t\t\tERR_FAIL_NULL(EditorFeatureProfileManager::get_singleton());\n \t\t\tEditorFeatureProfileManager::get_singleton()->connect(\"current_feature_profile_changed\", callable_mp(this, &EditorInspector::_feature_profile_changed));\n \t\t\tset_process(is_visible_in_tree());\n-\t\t\tget_parent()->connect(SceneStringName(theme_changed), callable_mp(this, &EditorInspector::_update_theme));\n-\t\t\t_update_theme();\n \t\t\tif (!is_sub_inspector()) {\n \t\t\t\tget_tree()->connect(\"node_removed\", callable_mp(this, &EditorInspector::_node_removed));\n \t\t\t}\n \t\t} break;\n \n-\t\tcase NOTIFICATION_EXIT_TREE: {\n-\t\t\tget_parent()->disconnect(SceneStringName(theme_changed), callable_mp(this, &EditorInspector::_update_theme));\n-\t\t} break;\n-\n \t\tcase NOTIFICATION_PREDELETE: {\n \t\t\tif (!is_sub_inspector() && is_inside_tree()) {\n \t\t\t\tget_tree()->disconnect(\"node_removed\", callable_mp(this, &EditorInspector::_node_removed));\n@@ -5059,10 +5047,6 @@ void EditorInspector::_notification(int p_what) {\n \t\t} break;\n \n \t\tcase EditorSettings::NOTIFICATION_EDITOR_SETTINGS_CHANGED: {\n-\t\t\tif (!is_sub_inspector() && EditorThemeManager::is_generated_theme_outdated()) {\n-\t\t\t\t_update_theme();\n-\t\t\t}\n-\n \t\t\tif (use_settings_name_style && EditorSettings::get_singleton()->check_changed_settings_in_group(\"interface/editor/localize_settings\")) {\n \t\t\t\tEditorPropertyNameProcessor::Style style = EditorPropertyNameProcessor::get_settings_style();\n \t\t\t\tif (property_name_style != style) {\ndiff --git a/editor/editor_inspector.h b/editor/editor_inspector.h\nindex 14e2d816f12c..6049d6dce1c5 100644\n--- a/editor/editor_inspector.h\n+++ b/editor/editor_inspector.h\n@@ -638,8 +638,6 @@ class EditorInspector : public ScrollContainer {\n \tvoid _set_property_favorited(const String &p_path, bool p_favorited);\n \tvoid _clear_current_favorites();\n \n-\tvoid _update_theme();\n-\n \tvoid _node_removed(Node *p_node);\n \n \tHashMap<StringName, int> per_array_page;\ndiff --git a/editor/themes/editor_theme_manager.cpp b/editor/themes/editor_theme_manager.cpp\nindex 986a0469e740..d2e8d300d8e1 100644\n--- a/editor/themes/editor_theme_manager.cpp\n+++ b/editor/themes/editor_theme_manager.cpp\n@@ -1888,8 +1888,6 @@ void EditorThemeManager::_populate_editor_styles(const Ref<EditorTheme> &p_theme\n \t\tp_theme->set_stylebox(\"FocusViewport\", EditorStringName(EditorStyles), style_widget_focus_viewport);\n \n \t\tRef<StyleBoxFlat> style_widget_scroll_container = p_config.button_style_focus->duplicate();\n-\t\t// Make the focus outline appear to be flush with the buttons it's focusing, so not draw on top of the content.\n-\t\tstyle_widget_scroll_container->set_expand_margin_all(4);\n \t\tp_theme->set_stylebox(\"focus\", \"ScrollContainer\", style_widget_scroll_container);\n \n \t\t// This stylebox is used in 3d and 2d viewports (no borders).\n@@ -2236,6 +2234,12 @@ void EditorThemeManager::_populate_editor_styles(const Ref<EditorTheme> &p_theme\n \n \t// Editor inspector.\n \t{\n+\t\t// Panel.\n+\t\tRef<StyleBoxFlat> editor_inspector_panel = p_config.tree_panel_style->duplicate();\n+\t\teditor_inspector_panel->set_border_width_all(0);\n+\t\teditor_inspector_panel->set_content_margin_all(0);\n+\t\tp_theme->set_stylebox(SceneStringName(panel), \"EditorInspector\", editor_inspector_panel);\n+\n \t\t// Vertical separation between inspector categories and sections.\n \t\tp_theme->set_constant(\"v_separation\", \"EditorInspector\", 0);\n \ndiff --git a/scene/gui/scroll_container.cpp b/scene/gui/scroll_container.cpp\nindex 00a2e8e01fd8..02652547a83f 100644\n--- a/scene/gui/scroll_container.cpp\n+++ b/scene/gui/scroll_container.cpp\n@@ -31,6 +31,7 @@\n #include \"scroll_container.h\"\n \n #include \"core/config/project_settings.h\"\n+#include \"scene/gui/panel_container.h\"\n #include \"scene/main/window.h\"\n #include \"scene/theme/theme_db.h\"\n \n@@ -44,7 +45,7 @@ Size2 ScrollContainer::get_minimum_size() const {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \n@@ -72,7 +73,16 @@ Size2 ScrollContainer::get_minimum_size() const {\n \t\t}\n \t}\n \n-\tmin_size += theme_cache.panel_style->get_minimum_size();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tmin_size += panel_size;\n+\tif (draw_focus_border) {\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\t// Only update the minimum size if the focus style's minimum size doesn't fit into the panel style's minimum size.\n+\t\tif (focus_size > panel_size) {\n+\t\t\tmin_size += focus_size - panel_size;\n+\t\t}\n+\t}\n+\n \treturn min_size;\n }\n \n@@ -258,21 +268,45 @@ void ScrollContainer::_update_scrollbar_position() {\n \t\treturn;\n \t}\n \n+\tfloat right_margin = theme_cache.panel_style->get_margin(SIDE_RIGHT);\n+\tfloat left_margin = theme_cache.panel_style->get_margin(SIDE_LEFT);\n+\tfloat top_margin = theme_cache.panel_style->get_margin(SIDE_TOP);\n+\tfloat bottom_margin = theme_cache.panel_style->get_margin(SIDE_BOTTOM);\n+\tif (draw_focus_border) {\n+\t\t// Only update margins if the focus style's margins don't fit into the panel style's margins.\n+\t\tfloat focus_margin = theme_cache.focus_style->get_margin(SIDE_RIGHT);\n+\t\tif (focus_margin > right_margin) {\n+\t\t\tright_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_LEFT);\n+\t\tif (focus_margin > left_margin) {\n+\t\t\tleft_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_TOP);\n+\t\tif (focus_margin > top_margin) {\n+\t\t\ttop_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_BOTTOM);\n+\t\tif (focus_margin > bottom_margin) {\n+\t\t\tbottom_margin += focus_margin;\n+\t\t}\n+\t}\n+\n \tSize2 hmin = h_scroll->is_visible() ? h_scroll->get_combined_minimum_size() : Size2();\n \tSize2 vmin = v_scroll->is_visible() ? v_scroll->get_combined_minimum_size() : Size2();\n \n-\tint lmar = is_layout_rtl() ? theme_cache.panel_style->get_margin(SIDE_RIGHT) : theme_cache.panel_style->get_margin(SIDE_LEFT);\n-\tint rmar = is_layout_rtl() ? theme_cache.panel_style->get_margin(SIDE_LEFT) : theme_cache.panel_style->get_margin(SIDE_RIGHT);\n+\tint lmar = is_layout_rtl() ? right_margin : left_margin;\n+\tint rmar = is_layout_rtl() ? left_margin : right_margin;\n \n \th_scroll->set_anchor_and_offset(SIDE_LEFT, ANCHOR_BEGIN, lmar);\n \th_scroll->set_anchor_and_offset(SIDE_RIGHT, ANCHOR_END, -rmar - vmin.width);\n-\th_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_END, -hmin.height - theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n-\th_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n+\th_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_END, -hmin.height - bottom_margin);\n+\th_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -bottom_margin);\n \n \tv_scroll->set_anchor_and_offset(SIDE_LEFT, ANCHOR_END, -vmin.width - rmar);\n \tv_scroll->set_anchor_and_offset(SIDE_RIGHT, ANCHOR_END, -rmar);\n-\tv_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_BEGIN, theme_cache.panel_style->get_margin(SIDE_TOP));\n-\tv_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -hmin.height - theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n+\tv_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_BEGIN, top_margin);\n+\tv_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -hmin.height - bottom_margin);\n \n \t_updating_scrollbars = false;\n }\n@@ -313,8 +347,22 @@ void ScrollContainer::_reposition_children() {\n \tSize2 size = get_size();\n \tPoint2 ofs;\n \n-\tsize -= theme_cache.panel_style->get_minimum_size();\n-\tofs += theme_cache.panel_style->get_offset();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tPoint2 panel_offset = theme_cache.panel_style->get_offset();\n+\tsize -= panel_size;\n+\tofs += panel_offset;\n+\tif (draw_focus_border) {\n+\t\t// Only update the size and offset if focus style's doesn't fit into the panel style's.\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\tif (focus_size > panel_size) {\n+\t\t\tsize -= focus_size - panel_size;\n+\t\t}\n+\t\tPoint2 focus_offset = theme_cache.focus_style->get_offset();\n+\t\tif (focus_offset > panel_offset) {\n+\t\t\tofs += focus_offset - panel_offset;\n+\t\t}\n+\t}\n+\n \tbool rtl = is_layout_rtl();\n \n \tif (_is_h_scroll_visible() || horizontal_scroll_mode == SCROLL_MODE_RESERVE) {\n@@ -330,7 +378,7 @@ void ScrollContainer::_reposition_children() {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \t\tSize2 minsize = c->get_combined_minimum_size();\n@@ -350,6 +398,9 @@ void ScrollContainer::_reposition_children() {\n \t\tfit_child_in_rect(c, r);\n \t}\n \n+\tif (draw_focus_border) {\n+\t\tfocus_panel->set_size(get_size());\n+\t}\n \tqueue_redraw();\n }\n \n@@ -399,6 +450,7 @@ void ScrollContainer::_notification(int p_what) {\n \t\t\tif (p_what == NOTIFICATION_THEME_CHANGED) {\n \t\t\t\tscroll_border = get_theme_constant(SNAME(\"scroll_border\"), SNAME(\"Tree\"));\n \t\t\t\tscroll_speed = get_theme_constant(SNAME(\"scroll_speed\"), SNAME(\"Tree\"));\n+\t\t\t\tfocus_panel->add_theme_style_override(\"panel\", theme_cache.focus_style);\n \t\t\t}\n \t\t} break;\n \n@@ -415,15 +467,8 @@ void ScrollContainer::_notification(int p_what) {\n \n \t\tcase NOTIFICATION_DRAW: {\n \t\t\tdraw_style_box(theme_cache.panel_style, Rect2(Vector2(), get_size()));\n-\t\t\tif (draw_focus_border && (has_focus() || child_has_focus())) {\n-\t\t\t\tRID ci = get_canvas_item();\n-\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_clip_ignore(ci, true);\n-\t\t\t\tdraw_style_box(theme_cache.focus_style, Rect2(Point2(), get_size()));\n-\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_clip_ignore(ci, false);\n-\t\t\t\tfocus_border_is_drawn = true;\n-\t\t\t} else {\n-\t\t\t\tfocus_border_is_drawn = false;\n-\t\t\t}\n+\t\t\tfocus_border_is_drawn = draw_focus_border && (has_focus() || child_has_focus());\n+\t\t\tfocus_panel->set_visible(focus_border_is_drawn);\n \t\t} break;\n \n \t\tcase NOTIFICATION_DRAG_BEGIN: {\n@@ -535,7 +580,15 @@ void ScrollContainer::_notification(int p_what) {\n \n void ScrollContainer::update_scrollbars() {\n \tSize2 size = get_size();\n-\tsize -= theme_cache.panel_style->get_minimum_size();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tsize -= panel_size;\n+\tif (draw_focus_border) {\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\t// Only update the size if the focus style's minimum size doesn't fit into the panel style's minimum size.\n+\t\tif (focus_size > panel_size) {\n+\t\t\tsize -= focus_size - panel_size;\n+\t\t}\n+\t}\n \n \tSize2 hmin = h_scroll->get_combined_minimum_size();\n \tSize2 vmin = v_scroll->get_combined_minimum_size();\n@@ -646,7 +699,7 @@ PackedStringArray ScrollContainer::get_configuration_warnings() const {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \n@@ -736,7 +789,9 @@ void ScrollContainer::set_draw_focus_border(bool p_draw) {\n \t\treturn;\n \t}\n \tdraw_focus_border = p_draw;\n-\tqueue_redraw();\n+\tif (is_ready()) {\n+\t\t_reposition_children();\n+\t}\n }\n \n bool ScrollContainer::get_draw_focus_border() {\n@@ -759,6 +814,17 @@ ScrollContainer::ScrollContainer() {\n \tadd_child(v_scroll, false, INTERNAL_MODE_BACK);\n \tv_scroll->connect(SceneStringName(value_changed), callable_mp(this, &ScrollContainer::_scroll_moved));\n \n+\t// We need to use a PanelContainer for the focus style instead of just drawing it directly with RenderingService\n+\t// due to a clippling issues. The Control that is being scrolled will be over the focus border because both will be\n+\t// drawn on the same CanvasItem. If we decide to ignore clipping, the focus border will be drawn even over other\n+\t// CanvasItems.\n+\tfocus_panel = memnew(PanelContainer);\n+\tfocus_panel->set_name(\"_focus\");\n+\tfocus_panel->set_mouse_filter(MOUSE_FILTER_IGNORE);\n+\tfocus_panel->set_focus_mode(FOCUS_NONE);\n+\tfocus_panel->set_visible(draw_focus_border);\n+\tadd_child(focus_panel, false, INTERNAL_MODE_BACK);\n+\n \tdeadzone = GLOBAL_GET(\"gui/common/default_scroll_deadzone\");\n \n \tset_clip_contents(true);\ndiff --git a/scene/gui/scroll_container.h b/scene/gui/scroll_container.h\nindex 7f2352704114..1970ed403fc1 100644\n--- a/scene/gui/scroll_container.h\n+++ b/scene/gui/scroll_container.h\n@@ -34,6 +34,8 @@\n \n #include \"scroll_bar.h\"\n \n+class PanelContainer;\n+\n class ScrollContainer : public Container {\n \tGDCLASS(ScrollContainer, Container);\n \n@@ -49,6 +51,7 @@ class ScrollContainer : public Container {\n private:\n \tHScrollBar *h_scroll = nullptr;\n \tVScrollBar *v_scroll = nullptr;\n+\tPanelContainer *focus_panel = nullptr;\n \n \tmutable Size2 largest_child_min_size; // The largest one among the min sizes of all available child controls.\n \n", "instance_id": "godotengine__godot-104317", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the focus style for a `ScrollContainer` in the Godot engine is not being clipped by its parent, leading to visual overlap or incorrect rendering when nested inside another `ScrollContainer`. The statement includes references to related issues, steps to reproduce, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (the focus style should be clipped by the parent), but not explicitly stated. Additionally, the problem statement does not specify constraints or edge cases beyond the basic reproduction steps, such as how the clipping should behave with different themes or layouts. While the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files (`scroll_container.cpp`, `scroll_container.h`, `editor_inspector.cpp`, `editor_inspector.h`, and `editor_theme_manager.cpp`) in the Godot engine, indicating a need to understand interactions between different components like the `ScrollContainer`, `PanelContainer`, and theme management. The changes are not trivial; they involve modifying how the focus border is rendered (switching from direct drawing to using a `PanelContainer` to handle clipping issues) and adjusting layout calculations to account for focus style margins and sizes. This requires a deep understanding of Godot's rendering pipeline, theme system, and control hierarchy.\n\nSecond, the technical concepts involved are moderately complex. The solution necessitates knowledge of Godot's GUI system, including `CanvasItem` clipping behavior, stylebox rendering, and control positioning logic. Additionally, the developer must understand how focus states are managed and propagated through child controls. While not requiring advanced algorithms or system-level programming, these concepts demand familiarity with the engine's internals.\n\nThird, the problem involves handling edge cases, such as ensuring the focus border does not overlap with other elements and correctly adjusts to different panel and focus style configurations (e.g., margins and minimum sizes). The code changes explicitly address these by comparing and adjusting for style differences, which adds to the complexity.\n\nFinally, while the changes do not appear to impact the broader system architecture significantly, they do require careful integration to avoid introducing new rendering or layout bugs. Given the need for a solid grasp of the codebase, the multi-file modifications, and the handling of specific rendering edge cases, I assign a difficulty score of 0.65, placing it in the lower end of the \"Hard\" range. It does not reach \"Very Hard\" as it does not involve advanced domain-specific knowledge or system-level redesign, but it is beyond a medium difficulty due to the depth of understanding required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Running with the `--headless` flag does not result in removing the project's recovery mode lock if present\n### Tested versions\n\n4.4.rc1\n\n### System information\n\nGodot v4.4.rc (d91f2cd77) - Windows 11 (build 22631) - Multi-window, 3 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 7900 XT (Advanced Micro Devices, Inc.; 32.0.11037.4004) - AMD Ryzen Threadripper 7970X 32-Cores (64 threads)\n\n### Issue description\n\nRunning with the `--headless flag` does not result in a call to `_remove_lock_file`\n\n### Steps to reproduce\n\nrun any command on a project with the `--headless` flag.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex e65f894c549f..5a3a651fcd9d 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -4662,6 +4662,12 @@ void Main::cleanup(bool p_force) {\n \tResourceSaver::remove_custom_savers();\n \tPropertyListHelper::clear_base_helpers();\n \n+\t// Remove the lock file if the engine exits successfully. Some automated processes such as\n+\t// --export/--import can bypass and/or finish faster than the existing check to remove the lock file.\n+\tif (OS::get_singleton()->get_exit_code() == EXIT_SUCCESS) {\n+\t\tOS::get_singleton()->remove_lock_file();\n+\t}\n+\n \t// Flush before uninitializing the scene, but delete the MessageQueue as late as possible.\n \tmessage_queue->flush();\n \n", "instance_id": "godotengine__godot-103805", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: running a project with the `--headless` flag does not result in removing the project's recovery mode lock file. It provides context about the tested version, system information, and steps to reproduce the issue. However, there are minor ambiguities and missing details. For instance, it does not explicitly define what the \"recovery mode lock\" is or its purpose in the context of the Godot engine. Additionally, there are no specific examples of commands or scenarios where this issue manifests, nor are there mentions of expected behavior beyond a call to `_remove_lock_file`. Edge cases or potential side effects of not removing the lock file are also not discussed. While the issue is understandable to someone familiar with the Godot engine, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" category. The code change provided is minimal, involving the addition of a small conditional block in a single file (`main/main.cpp`) to call `remove_lock_file()` when the engine exits successfully. The scope of the change is narrow, affecting only the cleanup process in the `Main::cleanup` function, and does not appear to impact the broader architecture of the system. The technical concepts required are straightforward: basic C++ control flow and familiarity with the Godot engine's `OS` singleton and its methods. There is no indication of complex interactions with other parts of the codebase or the need for advanced algorithms or design patterns. Regarding edge cases, the problem statement does not explicitly mention any, and the code change does not introduce significant error-handling logic beyond checking the exit code. However, a developer would need to ensure that calling `remove_lock_file()` in this context does not introduce unintended side effects (e.g., removing a lock file that should persist in certain scenarios), which adds a slight layer of complexity. Overall, this task requires understanding some code logic and making a simple modification, justifying a difficulty score of 0.25.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Panel - StyleBoxFlat with rounded borders LEFT and RIGHT creates a line of lighter color in the middle of the panel\n### Tested versions\n\nGodot Engine v4.3.stable.official.77dcf97d8\n\n\n### System information\n\nWin11 - OpenGL API 3.3.0 NVIDIA 572.16 - Compatibility - Using Device: NVIDIA - NVIDIA GeForce RTX 2060 SUPER\n\n### Issue description\n\nLeft and Right border (light line is present):\n![Image](https://github.com/user-attachments/assets/f94e6e4b-8173-464b-9ed6-d0e5d7af2fb0)\n\nTop and Bottom (no light line):\n![Image](https://github.com/user-attachments/assets/b4c36057-f442-4d78-9baf-213999381178)\n\nAt runtime:\n![Image](https://github.com/user-attachments/assets/cedfed74-36c6-4791-8e9a-1a9f33552e63)\n\nBut if I change the size (to a greater value on X axis) - the line disappears:\n![Image](https://github.com/user-attachments/assets/8b8005c4-d0db-47b3-8bc8-99ff73fa65b9)\n\n### Steps to reproduce\n\n1. Create a Panel\n2. Change the size to 128x128\n3. Add StyleBoxFlat in Theme Override - Styles\n4. Set all Corner Radiuses to 70 (to create the circle)\n5. Change the BG color to a darker one with some opacity\n6. In Border Width for the StyleBox start adding to LEFT or RIGHT (or both)\n\n### Minimal reproduction project (MRP)\n\nNot needed\n", "patch": "diff --git a/scene/resources/style_box_flat.cpp b/scene/resources/style_box_flat.cpp\nindex e4dd48d1635e..4e2e5823effd 100644\n--- a/scene/resources/style_box_flat.cpp\n+++ b/scene/resources/style_box_flat.cpp\n@@ -234,6 +234,79 @@ inline void set_inner_corner_radius(const Rect2 style_rect, const Rect2 inner_re\n \tinner_corner_radius[3] = MAX(corner_radius[3] - MIN(border_bottom, border_left), 0); // Bottom left.\n }\n \n+inline void set_corner_scale(const Rect2 &style_rect, const Rect2 &inner_rect, const real_t corner_radius[4], Point2 *inner_scale) {\n+\treal_t border_left = inner_rect.position.x - style_rect.position.x;\n+\treal_t border_top = inner_rect.position.y - style_rect.position.y;\n+\treal_t border_right = style_rect.size.width - inner_rect.size.width - border_left;\n+\treal_t border_bottom = style_rect.size.height - inner_rect.size.height - border_top;\n+\n+\t// Amount of overflow along an edge.\n+\t// Ex. SIDE_LEFT edge is the overflow between top_left and bottom_left corners.\n+\t// MIN(0,) is to ignore underflow, and negating is to make values positive.\n+\treal_t edge_overflow[4] = {\n+\t\t-MIN(0, inner_rect.size.y - corner_radius[CORNER_TOP_LEFT] - corner_radius[CORNER_BOTTOM_LEFT]),\n+\t\t-MIN(0, inner_rect.size.x - corner_radius[CORNER_TOP_LEFT] - corner_radius[CORNER_TOP_RIGHT]),\n+\t\t-MIN(0, inner_rect.size.y - corner_radius[CORNER_TOP_RIGHT] - corner_radius[CORNER_BOTTOM_RIGHT]),\n+\t\t-MIN(0, inner_rect.size.x - corner_radius[CORNER_BOTTOM_LEFT] - corner_radius[CORNER_BOTTOM_RIGHT])\n+\t};\n+\n+\t// Sums of borders.\n+\treal_t hb_sum = border_left + border_right;\n+\treal_t vb_sum = border_top + border_bottom;\n+\n+\t// Ratio of each side to the sum of itself and opposite side.\n+\t// Since overflow only happens with opposite borders, you only need to get the ratio of each border relative to the sum of involved borders.\n+\treal_t ratios[4] = {\n+\t\t// Prevent divide by 0 errors.\n+\t\thb_sum > 0 ? (border_left / hb_sum) : 0,\n+\t\tvb_sum > 0 ? (border_top / vb_sum) : 0,\n+\t\thb_sum > 0 ? (border_right / hb_sum) : 0,\n+\t\tvb_sum > 0 ? (border_bottom / vb_sum) : 0\n+\t};\n+\n+\t// Raw amount each corner should shrink.\n+\tPoint2 corner_reduction[4] = {\n+\t\tPoint2(edge_overflow[SIDE_TOP] * ratios[SIDE_LEFT], edge_overflow[SIDE_LEFT] * ratios[SIDE_TOP]),\n+\t\tPoint2(edge_overflow[SIDE_TOP] * ratios[SIDE_RIGHT], edge_overflow[SIDE_RIGHT] * ratios[SIDE_TOP]),\n+\t\tPoint2(edge_overflow[SIDE_BOTTOM] * ratios[SIDE_RIGHT], edge_overflow[SIDE_RIGHT] * ratios[SIDE_BOTTOM]),\n+\t\tPoint2(edge_overflow[SIDE_BOTTOM] * ratios[SIDE_LEFT], edge_overflow[SIDE_LEFT] * ratios[SIDE_BOTTOM]),\n+\t};\n+\n+\t// Corner Radii as Point2s.\n+\tPoint2 pcr[4] = {\n+\t\tPoint2(corner_radius[0], corner_radius[0]),\n+\t\tPoint2(corner_radius[1], corner_radius[1]),\n+\t\tPoint2(corner_radius[2], corner_radius[2]),\n+\t\tPoint2(corner_radius[3], corner_radius[3]),\n+\t};\n+\n+\t// If corner radii are too small, they won't shrink the full amount.\n+\t// Adjacent corners will have to shrink the leftovers if they can.\n+\t// Minf(0) is to ignore non-leftovers, and negating is to make values positive.\n+\tPoint2 leftovers[4] = {\n+\t\t-((pcr[0] - corner_reduction[0]).minf(0)),\n+\t\t-((pcr[1] - corner_reduction[1]).minf(0)),\n+\t\t-((pcr[2] - corner_reduction[2]).minf(0)),\n+\t\t-((pcr[3] - corner_reduction[3]).minf(0)),\n+\t};\n+\n+\t// New shrunken radii after distributing the leftovers.\n+\tPoint2 distributed[4] = {\n+\t\t((pcr[0] - corner_reduction[0] - leftovers[3] - leftovers[1]).maxf(0)),\n+\t\t((pcr[1] - corner_reduction[1] - leftovers[0] - leftovers[2]).maxf(0)),\n+\t\t((pcr[2] - corner_reduction[2] - leftovers[1] - leftovers[3]).maxf(0)),\n+\t\t((pcr[3] - corner_reduction[3] - leftovers[2] - leftovers[0]).maxf(0)),\n+\t};\n+\n+\t// How much the curve should scale to achieve the shrunken radii.\n+\tfor (int i = 0; i < 4; i++) {\n+\t\t// Unshrinkable is how much is still left over, even after distributing leftovers.\n+\t\t// Exclude it from the final scale.\n+\t\tPoint2 unshrinkable = (leftovers[(i + 1) % 4] + leftovers[(i + 4 - 1) % 4] - distributed[i]).maxf(0);\n+\t\tinner_scale[i] = distributed[i] / (pcr[i] - unshrinkable).maxf(FLT_EPSILON);\n+\t}\n+}\n+\n inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices, Vector<Color> &colors, const Rect2 &style_rect, const real_t corner_radius[4],\n \t\tconst Rect2 &ring_rect, const Rect2 &inner_rect, const Color &inner_color, const Color &outer_color, const int corner_detail, const Vector2 &skew, bool is_filled = false) {\n \tint vert_offset = verts.size();\n@@ -244,23 +317,30 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \treal_t ring_corner_radius[4];\n \tset_inner_corner_radius(style_rect, ring_rect, corner_radius, ring_corner_radius);\n \n+\tPoint2 ring_scale[4];\n+\tset_corner_scale(style_rect, ring_rect, ring_corner_radius, ring_scale);\n+\n \t// Corner radius center points.\n \tVector<Point2> outer_points = {\n-\t\tring_rect.position + Vector2(ring_corner_radius[0], ring_corner_radius[0]), //tl\n-\t\tPoint2(ring_rect.position.x + ring_rect.size.x - ring_corner_radius[1], ring_rect.position.y + ring_corner_radius[1]), //tr\n-\t\tring_rect.position + ring_rect.size - Vector2(ring_corner_radius[2], ring_corner_radius[2]), //br\n-\t\tPoint2(ring_rect.position.x + ring_corner_radius[3], ring_rect.position.y + ring_rect.size.y - ring_corner_radius[3]) //bl\n+\t\tring_rect.position + Vector2(ring_corner_radius[0], ring_corner_radius[0]) * ring_scale[0], //tl\n+\t\tPoint2(ring_rect.position.x + ring_rect.size.x - ring_corner_radius[1] * ring_scale[1].x, ring_rect.position.y + ring_corner_radius[1] * ring_scale[1].y), //tr\n+\t\tring_rect.position + ring_rect.size - Vector2(ring_corner_radius[2], ring_corner_radius[2]) * ring_scale[2], //br\n+\t\tPoint2(ring_rect.position.x + ring_corner_radius[3] * ring_scale[3].x, ring_rect.position.y + ring_rect.size.y - ring_corner_radius[3] * ring_scale[3].y) //bl\n \t};\n \n \treal_t inner_corner_radius[4];\n \tset_inner_corner_radius(style_rect, inner_rect, corner_radius, inner_corner_radius);\n \n+\tPoint2 inner_scale[4];\n+\tset_corner_scale(style_rect, inner_rect, inner_corner_radius, inner_scale);\n+\n \tVector<Point2> inner_points = {\n-\t\tinner_rect.position + Vector2(inner_corner_radius[0], inner_corner_radius[0]), //tl\n-\t\tPoint2(inner_rect.position.x + inner_rect.size.x - inner_corner_radius[1], inner_rect.position.y + inner_corner_radius[1]), //tr\n-\t\tinner_rect.position + inner_rect.size - Vector2(inner_corner_radius[2], inner_corner_radius[2]), //br\n-\t\tPoint2(inner_rect.position.x + inner_corner_radius[3], inner_rect.position.y + inner_rect.size.y - inner_corner_radius[3]) //bl\n+\t\tinner_rect.position + Vector2(inner_corner_radius[0], inner_corner_radius[0]) * inner_scale[0], //tl\n+\t\tPoint2(inner_rect.position.x + inner_rect.size.x - inner_corner_radius[1] * inner_scale[1].x, inner_rect.position.y + inner_corner_radius[1] * inner_scale[1].y), //tr\n+\t\tinner_rect.position + inner_rect.size - Vector2(inner_corner_radius[2], inner_corner_radius[2]) * inner_scale[2], //br\n+\t\tPoint2(inner_rect.position.x + inner_corner_radius[3] * inner_scale[3].x, inner_rect.position.y + inner_rect.size.y - inner_corner_radius[3] * inner_scale[3].y) //bl\n \t};\n+\n \t// Calculate the vertices.\n \n \t// If the center is filled, we do not draw the border and directly use the inner ring as reference. Because all calls to this\n@@ -289,8 +369,8 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \t\t\tconst real_t angle_sine = Math::sin(pt_angle);\n \n \t\t\t{\n-\t\t\t\tconst real_t x = inner_corner_radius[corner_idx] * angle_cosine + inner_points[corner_idx].x;\n-\t\t\t\tconst real_t y = inner_corner_radius[corner_idx] * angle_sine + inner_points[corner_idx].y;\n+\t\t\t\tconst real_t x = inner_corner_radius[corner_idx] * angle_cosine * inner_scale[corner_idx].x + inner_points[corner_idx].x;\n+\t\t\t\tconst real_t y = inner_corner_radius[corner_idx] * angle_sine * inner_scale[corner_idx].y + inner_points[corner_idx].y;\n \t\t\t\tconst float x_skew = -skew.x * (y - style_rect_center.y);\n \t\t\t\tconst float y_skew = -skew.y * (x - style_rect_center.x);\n \t\t\t\tverts_ptr[verts_size + idx_ofs] = Vector2(x + x_skew, y + y_skew);\n@@ -298,8 +378,8 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \t\t\t}\n \n \t\t\tif (draw_border) {\n-\t\t\t\tconst real_t x = ring_corner_radius[corner_idx] * angle_cosine + outer_points[corner_idx].x;\n-\t\t\t\tconst real_t y = ring_corner_radius[corner_idx] * angle_sine + outer_points[corner_idx].y;\n+\t\t\t\tconst real_t x = ring_corner_radius[corner_idx] * angle_cosine * ring_scale[corner_idx].x + outer_points[corner_idx].x;\n+\t\t\t\tconst real_t y = ring_corner_radius[corner_idx] * angle_sine * ring_scale[corner_idx].y + outer_points[corner_idx].y;\n \t\t\t\tconst float x_skew = -skew.x * (y - style_rect_center.y);\n \t\t\t\tconst float y_skew = -skew.y * (x - style_rect_center.x);\n \t\t\t\tverts_ptr[verts_size + idx_ofs + 1] = Vector2(x + x_skew, y + y_skew);\n", "instance_id": "godotengine__godot-103607", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a visual artifact (a lighter line in the middle of a panel) appears when using StyleBoxFlat with rounded borders on the left and right sides in Godot Engine v4.3. It provides specific steps to reproduce the issue, system information, and illustrative images, which help in understanding the problem context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should the line never appear under any conditions?) or mention specific edge cases beyond resizing the panel on the X-axis. Additionally, it lacks clarity on whether this is purely a rendering issue or tied to specific theme settings or hardware configurations beyond the provided system info. While the issue is reproducible with the given steps, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of solving this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is focused on a single file (style_box_flat.cpp) and a specific rendering logic for rounded rectangles, which limits the breadth of impact on the codebase. However, the depth of the change is significant, as it introduces a new function (set_corner_scale) with complex logic to adjust corner scaling based on border overflow and radii distribution. This requires a deep understanding of the rendering mechanics in Godot, specifically how StyleBoxFlat handles borders and corner radii, as well as vector mathematics for scaling and positioning.\n\nThe technical concepts involved include advanced 2D geometry (handling corner radii, border overflows, and scaling), Godot's rendering pipeline, and C++ programming with inline functions and array manipulations. The code changes also demonstrate a nuanced approach to distributing \"leftovers\" in corner reductions, which adds to the logical complexity. While the problem does not impact the broader system architecture, it requires precise modifications to avoid introducing new visual artifacts or performance issues in rendering.\n\nEdge cases are implicitly present, as the issue manifests under specific conditions (e.g., certain border widths and corner radii), and the solution must handle scenarios like zero borders or extreme radii values, as seen in the code's safeguards against division by zero and negative values. However, explicit error handling is not a major focus of the change. Overall, this problem demands a solid grasp of graphical rendering concepts and careful implementation, placing it in the 0.6-0.8 range. I assign a score of 0.65 to reflect the challenge of understanding and modifying the rendering logic while acknowledging that the scope is confined to a single component.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Android editor: Game crash after changing device language\n### Tested versions\n\nGodot Engine v4.3.stable.official [77dcf97d8]\n\n### System information\n\nXiaomi Redmi A2+, Android 13, compatible rendering\n\n### Issue description\n\nAfter changing device language, opening the game will hang for a few seconds then exit.\r\nThis issue occur the same way on Android emulator x86\n\n### Steps to reproduce\n\n1. Open the game\r\n2. Leave the game run in background and go to device system settings\r\n3. Change device display language\r\n4. Re-enter the game (the game will hang for a few seconds then exit)\n\n### Minimal reproduction project (MRP)\n\n[demo.zip](https://github.com/user-attachments/files/16936623/demo.zip)\r\n\n", "patch": "diff --git a/platform/android/java/app/AndroidManifest.xml b/platform/android/java/app/AndroidManifest.xml\nindex 60ce75fd16e2..1d59d15d560f 100644\n--- a/platform/android/java/app/AndroidManifest.xml\n+++ b/platform/android/java/app/AndroidManifest.xml\n@@ -46,7 +46,7 @@\n             android:excludeFromRecents=\"false\"\n             android:exported=\"true\"\n             android:screenOrientation=\"landscape\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:resizeableActivity=\"false\"\n             tools:ignore=\"UnusedAttribute\" >\n \ndiff --git a/platform/android/java/editor/src/main/AndroidManifest.xml b/platform/android/java/editor/src/main/AndroidManifest.xml\nindex a1971554bf7d..b136e348b2c7 100644\n--- a/platform/android/java/editor/src/main/AndroidManifest.xml\n+++ b/platform/android/java/editor/src/main/AndroidManifest.xml\n@@ -41,7 +41,7 @@\n \n         <activity\n             android:name=\".GodotEditor\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"true\"\n             android:icon=\"@mipmap/themed_icon\"\n             android:launchMode=\"singleTask\"\n@@ -59,7 +59,7 @@\n         </activity>\n         <activity\n             android:name=\".GodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -74,7 +74,7 @@\n         </activity>\n         <activity\n             android:name=\".embed.EmbeddedGodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -87,7 +87,7 @@\n             android:screenOrientation=\"userLandscape\" />\n         <activity\n             android:name=\".GodotXRGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:process=\":GodotXRGame\"\n             android:launchMode=\"singleTask\"\n             android:icon=\"@mipmap/ic_play_window\"\n", "instance_id": "godotengine__godot-103419", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a game crash on Android after changing the device language. It provides specific details such as the tested version of Godot Engine, system information, steps to reproduce, and even a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the expected behavior after a language change (e.g., should the game reload with the new language or ignore the change?). Additionally, there are no details about specific error messages or logs that might help pinpoint the root cause of the crash. While the steps to reproduce are clear, edge cases or additional context (e.g., does this happen with all languages or specific ones?) are not addressed. Thus, while the problem is valid and mostly clear, it lacks some minor but useful details for a fully comprehensive understanding.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" category (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are minimal and localized to AndroidManifest.xml files in the Godot Engine's Android platform module. The modification involves adding \"layoutDirection|locale\" to the `android:configChanges` attribute for several activities. This change is straightforward, affecting only configuration settings in manifest files, and does not require deep modifications to the codebase or impact the system's architecture. It is a small, targeted fix.\n\n2. **Number of Technical Concepts**: Solving this issue requires basic knowledge of Android development, specifically understanding the `android:configChanges` attribute in the AndroidManifest.xml file. This attribute is used to handle configuration changes (like language or layout direction) without restarting the activity, which likely prevents the crash. No advanced algorithms, design patterns, or complex language features are involved. Familiarity with Android's activity lifecycle and configuration management is helpful but not deeply complex.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases beyond the language change scenario. The code change itself does not introduce new error handling logic; it simply updates a configuration to prevent the app from restarting or crashing on locale changes. While there might be implicit edge cases (e.g., ensuring compatibility with different Android versions or handling unsupported languages), these are not addressed in the problem or code changes and do not significantly increase the difficulty.\n\n4. **Overall Complexity**: The fix is a well-known pattern in Android development for handling locale changes, and the implementation is a one-line change per activity in the manifest files. It does not require deep understanding of the broader Godot Engine codebase or complex interactions between modules. The impact is limited to the Android platform layer, and the amount of code changed is minimal.\n\nGiven these factors, the difficulty is rated at 0.25, as it involves a simple, localized fix with minimal technical complexity. It requires basic Android development knowledge and does not involve significant logic, edge case handling, or architectural changes. This is an easy problem for someone with even moderate experience in Android app development or configuration management.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor crash when interacting with a re-opened scene containing an animation player\n### Tested versions\n\nAt least 4.4.beta1 to current head `6dc78c8aa17ad46e701e0c4e7b7632c2f0e098f1` but involves code introduced in  https://github.com/godotengine/godot/pull/99700 or a related PR cc @hpvb \n\n~~As far as I've seen, the crash does not happen if the editor is compiled with `dev_build=yes`~~\n\n### System information\n\nGodot v4.4.beta.mono (6dc78c8aa) - macOS Sequoia (15.2.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 (Apple8) - Apple M2 (8 threads)\n\n### Issue description\n\nAfter closing and re-opening a scene containing an animation player and then either selecting a node or closing the scene tab several times, either SIGSEGV or SIGBUS crashes the editor. From lldb:\n```\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x3d9ec6003f8001a8)\n  * frame #0: 0x0000000102cb4df8 godot.macos.editor.arm64`Node::get_parent() const\n    frame #1: 0x0000000102468e1c godot.macos.editor.arm64`SceneTreeEditor::_update_tree(bool) + 500\n    frame #2: 0x0000000104bd0394 godot.macos.editor.arm64`CallQueue::_call_function(Callable const&, Variant const*, int, bool) + 336\n    frame #3: 0x0000000104bd06b0 godot.macos.editor.arm64`CallQueue::flush() + 352\n    frame #4: 0x0000000102ceb6d0 godot.macos.editor.arm64`SceneTree::physics_process(double) + 244\n    frame #5: 0x00000001003f366c godot.macos.editor.arm64`Main::iteration() + 596\n    frame #6: 0x0000000100383878 godot.macos.editor.arm64`OS_MacOS::run() + 148\n    frame #7: 0x00000001003b0ad4 godot.macos.editor.arm64`main + 388\n    frame #8: 0x0000000196350274 dyld`start + 2840\n```\nPresumably some call is getting inlined between _update_tree and get_parent?\n\n### Steps to reproduce\n\nClose and reopen the same scene several times in a row, optionally interacting with a node. In my tests, I saw a crash after anywhere between 1 and 4 close/reopen cycles with the last user action being any of opening the scene, closing the scene, or selecting a node in the tree.\n\n### Minimal reproduction project (MRP)\n\n[glb_test.zip](https://github.com/user-attachments/files/18680946/glb_test.zip)\n", "patch": "diff --git a/editor/gui/scene_tree_editor.cpp b/editor/gui/scene_tree_editor.cpp\nindex ab834929cd58..5aedd940e482 100644\n--- a/editor/gui/scene_tree_editor.cpp\n+++ b/editor/gui/scene_tree_editor.cpp\n@@ -924,12 +924,19 @@ void SceneTreeEditor::_update_tree(bool p_scroll_to_selected) {\n \t\t// If pinned state changed, update the currently pinned node.\n \t\tif (AnimationPlayerEditor::get_singleton()->is_pinned() != node_cache.current_has_pin) {\n \t\t\tnode_cache.current_has_pin = AnimationPlayerEditor::get_singleton()->is_pinned();\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n \t\t}\n \t\t// If the current pinned node changed update both the old and new node.\n \t\tif (node_cache.current_pinned_node != pinned_node) {\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n-\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t// get_editing_node() will return deleted nodes. If the nodes are not in cache don't try to mark them.\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n+\t\t\tif (node_cache.has(node_cache.current_pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t}\n \t\t\tnode_cache.current_pinned_node = pinned_node;\n \t\t}\n \n@@ -2373,6 +2380,10 @@ HashMap<Node *, SceneTreeEditor::CachedNode>::Iterator SceneTreeEditor::NodeCach\n \treturn I;\n }\n \n+bool SceneTreeEditor::NodeCache::has(Node *p_node) {\n+\treturn get(p_node, false).operator bool();\n+}\n+\n void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \tif (!p_node) {\n \t\treturn;\n@@ -2382,6 +2393,11 @@ void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \t\teditor->selected = nullptr;\n \t}\n \n+\tif (p_node == current_pinned_node) {\n+\t\tcurrent_pinned_node = nullptr;\n+\t\tcurrent_has_pin = false;\n+\t}\n+\n \teditor->marked.erase(p_node);\n \n \tHashMap<Node *, CachedNode>::Iterator I = cache.find(p_node);\n@@ -2419,6 +2435,7 @@ void SceneTreeEditor::NodeCache::mark_dirty(Node *p_node, bool p_parents) {\n \t\tif (!p_parents) {\n \t\t\tbreak;\n \t\t}\n+\n \t\tnode = node->get_parent();\n \t}\n }\n@@ -2483,4 +2500,6 @@ void SceneTreeEditor::NodeCache::clear() {\n \t}\n \tcache.clear();\n \tto_delete.clear();\n+\tcurrent_pinned_node = nullptr;\n+\tcurrent_has_pin = false;\n }\ndiff --git a/editor/gui/scene_tree_editor.h b/editor/gui/scene_tree_editor.h\nindex e789e9692419..d29c4df0cdb2 100644\n--- a/editor/gui/scene_tree_editor.h\n+++ b/editor/gui/scene_tree_editor.h\n@@ -90,6 +90,7 @@ class SceneTreeEditor : public Control {\n \n \t\tHashMap<Node *, CachedNode>::Iterator add(Node *p_node, TreeItem *p_item);\n \t\tHashMap<Node *, CachedNode>::Iterator get(Node *p_node, bool p_deleted_ok = true);\n+\t\tbool has(Node *p_node);\n \t\tvoid remove(Node *p_node, bool p_recursive = false);\n \t\tvoid mark_dirty(Node *p_node, bool p_parents = true);\n \t\tvoid mark_children_dirty(Node *p_node, bool p_recursive = false);\n", "instance_id": "godotengine__godot-102813", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash in the Godot editor when interacting with a re-opened scene containing an animation player. It provides specific details such as the affected versions, system information, steps to reproduce, and a minimal reproduction project (MRP). Additionally, a stack trace from the crash is included, which helps in identifying the problematic area of the codebase. However, there are minor ambiguities that prevent a perfect score. For instance, the exact cause of the crash (e.g., whether it's a null pointer dereference or memory corruption) is not explicitly deduced or hypothesized in the statement, leaving some room for interpretation. Furthermore, while the steps to reproduce are provided, they are somewhat vague in terms of the exact sequence or conditions that guarantee the crash (\"anywhere between 1 and 4 close/reopen cycles\"). Edge cases or specific conditions leading to the crash are not fully detailed, which could complicate debugging efforts. Overall, the statement is valid and mostly clear but lacks some precision in critical details.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the issue involves a crash in a complex editor application (Godot), which suggests a deep understanding of the editor's internals, specifically the scene tree and animation player interactions. The code changes provided are focused on the `SceneTreeEditor` class, particularly around node caching and pinned node handling, indicating that the fix requires understanding how nodes are managed and updated in the editor's GUI. The modifications are relatively localized to a single file (`scene_tree_editor.cpp`) and its header, but they involve critical logic for node management, which could have broader implications on the editor's stability if not handled correctly. \n\nFrom a technical concepts perspective, the problem requires knowledge of C++ (memory management, pointers, and object lifetimes), familiarity with Godot's architecture (scene tree, node caching, editor GUI), and debugging skills to interpret stack traces and pinpoint the root cause of a crash (SIGSEGV/SIGBUS). The changes introduce checks to prevent accessing invalid or deleted nodes, which suggests handling edge cases related to node deletion or invalidation\u2014potentially a common source of crashes in such systems. The addition of a `has()` method and conditional checks for node existence in the cache demonstrates a need to handle these edge cases explicitly, adding to the complexity.\n\nThe difficulty is further compounded by the need to ensure that these changes do not introduce new issues in the editor's behavior, especially since the crash occurs under specific, non-deterministic conditions (re-opening scenes multiple times). While the code changes are not extensive in terms of lines of code, the impact of getting this wrong could be significant, as it deals with core editor functionality. This places the difficulty at 0.65, reflecting a hard problem that requires a solid grasp of the codebase, careful handling of edge cases, and a good understanding of C++ memory management, but it does not reach the \"Very Hard\" category as it does not appear to involve system-level or highly domain-specific challenges beyond the editor's architecture.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Exported vars  without a default set, of enum types with no entry with a value of 0, show misleading info in inspector\n### Godot version\n\nv4.0.rc6.official [0cd148313]\n\n### System information\n\nArch Linux\n\n### Issue description\n\nIn GDScript, when exporting a variable of an enum type that does NOT have an entry with value `0` (zero), and you don't  a default value, the inspector looks as if you have selected the first element, but in truth, the value of the variable is `0`.\r\n\r\nGiven the following snippet:\r\n\r\n```\r\nenum Foo{\r\n\tbar = 1,\r\n\tfoobar = 2,\r\n}\r\n@export var foo : Foo\r\n```\r\n\r\nThe inspector looks like this:\r\n\r\n![image](https://user-images.githubusercontent.com/7486114/221964166-7493668b-bf60-4f7a-b95f-787081599882.png)\r\n\r\nThis suggests `bar` is selected, and thus `foo` should be `1`.\r\n\r\nHowever,\r\n```\r\nfunc _ready():\r\n\tprint(str(foo))\r\n```\r\nprints `0` (zero).\r\n\r\nIf you _do_ give a default:\r\n\r\n```\r\n@export var foo : Foo = Foo.bar\r\n```\r\n\r\nthe inspector looks exactly the same as it did without the default specified, but the output _is_ the (expected) `1`. As a user, I thus can't tell the difference without inspecting the code. \r\n\r\nAs a user, I expect that whatever is shown in the inspector is a representation of what I'll get when I run the code. So when no default is specified, I expect that either (the inspector shows `0` or `null`) _or_ (the value of `foo` ends up being `bar` instead of `0`). Ideally, I would like it to do the latter, but I think that the former is technically more correct\n\n### Steps to reproduce\n\n1. Make a new scene \r\n2. Attach the following script:\r\n```\r\nextends Node\r\n\r\nenum Foo{\r\n\tbar = 1,\r\n\tfoobar = 2,\r\n}\r\n\r\n@export var foo : Foo\r\n\r\nfunc _ready():\r\n\tprint(str(foo))\r\n```\r\n3. Observe that the inspector for this node suggest that `foo`  is set to `bar`.\r\n4. Run the code, and observe the ouput prints `0` instead.\r\n5. Change the export line to `@export var foo : Foo = Foo.bar`\r\n6. Observe that the outliner looks exactly the same as before\r\n7. Run the code, and observe that the output now reads `1`.\n\n### Minimal reproduction project\n\nn/a, but can be supplied if helpful. \n", "patch": "diff --git a/editor/editor_properties.cpp b/editor/editor_properties.cpp\nindex 9ea0c2de9a75..52780d7c5889 100644\n--- a/editor/editor_properties.cpp\n+++ b/editor/editor_properties.cpp\n@@ -321,6 +321,9 @@ void EditorPropertyTextEnum::update_property() {\n \t\t}\n \t} else {\n \t\toption_button->select(default_option);\n+\t\tif (default_option < 0) {\n+\t\t\toption_button->set_text(current_value);\n+\t\t}\n \t}\n }\n \n@@ -699,6 +702,7 @@ void EditorPropertyEnum::update_property() {\n \tVariant current = get_edited_property_value();\n \tif (current.get_type() == Variant::NIL) {\n \t\toptions->select(-1);\n+\t\toptions->set_text(\"<null>\");\n \t\treturn;\n \t}\n \n@@ -709,6 +713,8 @@ void EditorPropertyEnum::update_property() {\n \t\t\treturn;\n \t\t}\n \t}\n+\toptions->select(-1);\n+\toptions->set_text(itos(which));\n }\n \n void EditorPropertyEnum::setup(const Vector<String> &p_options) {\n", "instance_id": "godotengine__godot-102743", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the discrepancy between the Godot inspector display and the actual value of an exported enum variable when no default is set. It includes a code snippet, steps to reproduce, and visual evidence (screenshot) to illustrate the problem. The expected behavior is also discussed, with a preference for aligning the inspector display with the runtime value. However, there are minor ambiguities: the problem statement does not explicitly define all edge cases (e.g., behavior with negative enum values or non-sequential enum values beyond the provided example) or constraints on the solution (e.g., performance considerations or compatibility with other Godot features). Additionally, while the desired outcome is mentioned, it is not definitively specified whether the inspector should show a \"null\" state or default to the first enum value. These minor missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided diff shows modifications to a single file (`editor_properties.cpp`) in the Godot engine codebase, specifically targeting the UI behavior of the inspector for enum properties. The changes are localized to a few functions (`EditorPropertyTextEnum::update_property` and `EditorPropertyEnum::update_property`) and involve a small number of lines (adding conditional text updates for invalid or null selections). There is no indication of widespread impact on the system's architecture or interactions with other modules, making the scope relatively narrow.\n\n2. **Technical Concepts Involved:** Solving this requires a basic understanding of C++ (the language used in the Godot engine), familiarity with Godot's editor property system, and how UI elements like dropdowns (`OptionButton`) are updated. The concepts are not particularly complex\u2014primarily involving conditional logic and string manipulation to update the inspector display. No advanced algorithms, design patterns, or domain-specific knowledge beyond Godot's editor internals are needed.\n\n3. **Edge Cases and Error Handling:** The problem statement highlights a specific edge case (enums without a value of 0 and no default set), and the code changes address this by updating the inspector text to reflect the actual value or a null state. However, the complexity of handling these edge cases is low, as it involves straightforward checks and UI updates. Additional edge cases (e.g., invalid enum values or UI rendering issues) are not mentioned or addressed in the diff, suggesting limited depth in error handling requirements.\n\n4. **Overall Complexity:** The task involves understanding a small part of the Godot editor codebase and making targeted UI fixes. It does not require deep architectural changes, performance optimization, or extensive debugging of complex interactions. The problem is a straightforward bug fix with a clear path to resolution, aligning with an Easy difficulty level.\n\nA score of 0.35 is assigned as it is slightly more involved than a trivial fix (e.g., changing a constant) due to the need to understand Godot's property system and ensure the UI reflects the correct state, but it remains within the realm of simple modifications without significant technical challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor crashes when callback for `RD::texture_get_data_async` is an empty method\n\n\n### Tested versions\n\n- Reproducable in 4.4-beta2, 4.4-beta1, 4.4-dev7\n\n(All versions with [#100110](https://github.com/godotengine/godot/pull/100110))\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 22631) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6094) - 12th Gen Intel(R) Core(TM) i5-12400F (12 threads)\n\n### Issue description\n\nWhen calling `RD::texture_get_data_async` from a tool script on every process and passing a callback to an empty method the Editor crashes after about 5 seconds.\n\n```\nERROR: FATAL: Index p_index = 8278 is out of bounds (count = 82).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nCrashHandlerException: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta2.official (a013481b0911e59cc3f3dea7ebb732450c3e1460)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n\n(no backtrace.. same with --verbose)\n```\n\nRunning the game does not trigger the crash. It only seems to be happening in the editor.\n\nHaving something happen in the callback also doesn't seem to trigger the crash or perhaps delays it to great extend. I doubt that the empty callback is the root cause. It probably just triggers whatever is wrong with using it in the editor faster. Though, I'm speculating here.\n\nIf this wasn't intended to work in the editor, there should be a guard.\n\n### Steps to reproduce\n\n- Uncommennt `@tool` at the top of node.gd\n- save\n- reopen the scene\n- switch to 2D\n- wait for about 5s\n\nAlso try uncommenting the print statement in the callback. That seems to stop the crash.\n\n### Minimal reproduction project (MRP)\n\n[texture-get-data-async-empty-callback-editor-crash.zip](https://github.com/user-attachments/files/18656439/texture-get-data-async-empty-callback-editor-crash.zip)\n", "patch": "diff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9716a42c97b9..055fcbeda64f 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -721,7 +721,6 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t_check_transfer_worker_buffer(buffer);\n \n \tBufferGetDataRequest get_data_request;\n-\tuint32_t flushed_copies = 0;\n \tget_data_request.callback = p_callback;\n \tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n \tget_data_request.size = p_size;\n@@ -738,22 +737,26 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\treturn err;\n \t\t}\n \n-\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n+\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\tif (flush_frames) {\n \t\t\tif (_buffer_make_mutable(buffer, p_buffer)) {\n \t\t\t\t// The buffer must be mutable to be used as a copy source.\n \t\t\t\tdraw_graph.add_synchronization();\n \t\t\t}\n \n-\t\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t\t}\n-\n-\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t}\n \n \t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\tif (flush_frames) {\n+\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n+\t\t}\n+\n \t\tRDD::BufferCopyRegion region;\n \t\tregion.src_offset = submit_from + p_offset;\n \t\tregion.dst_offset = block_write_offset;\n@@ -775,7 +778,7 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\tdraw_graph.add_synchronization();\n \t\t}\n \n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t}\n@@ -2098,7 +2101,6 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \tuint32_t block_write_offset;\n \tuint32_t block_write_amount;\n \tStagingRequiredAction required_action;\n-\tuint32_t flushed_copies = 0;\n \tfor (uint32_t i = 0; i < tex->mipmaps; i++) {\n \t\tuint32_t image_total = get_image_format_required_size(tex->format, tex->width, tex->height, tex->depth, i + 1, &w, &h, &d);\n \t\tuint32_t tight_mip_size = image_total - mipmap_offset;\n@@ -2119,17 +2121,21 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t\t\t\t\tError err = _staging_buffer_allocate(download_staging_buffers, to_allocate, required_align, block_write_offset, block_write_amount, required_action, false);\n \t\t\t\t\tERR_FAIL_COND_V(err, ERR_CANT_CREATE);\n \n-\t\t\t\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n-\t\t\t\t\t\tfor (uint32_t j = flushed_copies; j < get_data_request.frame_local_count; j++) {\n+\t\t\t\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tfor (uint32_t j = 0; j < get_data_request.frame_local_count; j++) {\n \t\t\t\t\t\t\tuint32_t local_index = get_data_request.frame_local_index + j;\n \t\t\t\t\t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t\t\t\t}\n \n \t\t\t\t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\t\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_texture_copy_regions.size();\n+\t\t\t\t\t}\n+\n \t\t\t\t\tRDD::BufferTextureCopyRegion copy_region;\n \t\t\t\t\tcopy_region.buffer_offset = block_write_offset;\n \t\t\t\t\tcopy_region.texture_subresources.aspect = tex->read_aspect_flags;\n@@ -2154,12 +2160,11 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t}\n \n \tif (get_data_request.frame_local_count > 0) {\n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t}\n \n-\t\tflushed_copies = get_data_request.frame_local_count;\n \t\tframes[frame].download_texture_get_data_requests.push_back(get_data_request);\n \t}\n \n", "instance_id": "godotengine__godot-102454", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the editor crashes when using `RD::texture_get_data_async` with an empty callback method in a tool script. It provides specific details such as the affected versions, system information, steps to reproduce, and a minimal reproduction project (MRP). The description also includes observations about the crash not occurring when running the game or when the callback has content, which adds helpful context. However, there are minor ambiguities and missing details. For instance, the root cause is speculative (\"I doubt that the empty callback is the root cause\"), and there is no clear mention of expected behavior or constraints for using `texture_get_data_async` in the editor. Additionally, edge cases beyond the empty callback are not explicitly discussed, which could impact the completeness of the solution. Overall, while the problem is well-documented, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes is focused on a single file (`rendering_device.cpp`), but the modifications are intricate, involving logic related to asynchronous data retrieval, buffer management, and frame synchronization in a rendering engine (Godot). The changes impact critical functionality, as they address a crash in the editor, which suggests a deep interaction with the rendering pipeline and memory management. Second, the technical concepts required to solve this are complex, including understanding asynchronous operations, GPU buffer handling, staging buffers, and the specific behavior of the Godot engine's rendering device API. The code changes also involve managing frame-local indices and ensuring proper synchronization, which requires a solid grasp of low-level graphics programming and concurrency. Third, while the problem statement does not explicitly mention edge cases beyond the empty callback, the nature of the crash and the speculative root cause imply that there could be subtle timing or resource management issues to handle, potentially requiring robust error handling or additional safeguards. Finally, solving this issue demands a deep understanding of the codebase architecture, particularly the rendering subsystem, making it a challenging task even for experienced developers. A score of 0.75 reflects the high complexity and specialized knowledge required, though it does not reach the \"Very Hard\" range as it does not appear to involve system-level redesign or extremely intricate domain-specific challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
