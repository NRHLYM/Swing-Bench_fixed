{"repo": "FiniteSingularity/obs-quick-access-utility", "instance_id": "FiniteSingularity__obs-quick-access-utility-16", "base_commit": "4a41098cf69303cd7fa963bfd58d2b2f5635b8c1", "patch": "diff --git a/src/quick-access-dock.cpp b/src/quick-access-dock.cpp\nindex 9c2cb10..95e6f91 100644\n--- a/src/quick-access-dock.cpp\n+++ b/src/quick-access-dock.cpp\n@@ -22,6 +22,7 @@ QuickAccessDock::QuickAccessDock(QWidget *parent, obs_data_t *obsData)\n \t_clickableScenes = obs_data_get_bool(obsData, \"clickable_scenes\");\n \n \t_widget = new QuickAccess(this, this, \"quick_access_widget\");\n+\tsetMinimumWidth(200);\n \tauto l = new QVBoxLayout;\n \tl->setContentsMargins(0, 0, 0, 0);\n \tl->addWidget(_widget);\ndiff --git a/src/quick-access.cpp b/src/quick-access.cpp\nindex 123c487..4831281 100644\n--- a/src/quick-access.cpp\n+++ b/src/quick-access.cpp\n@@ -77,57 +77,47 @@ QuickAccessItem::QuickAccessItem(QWidget *parent, QuickAccessDock *dock,\n \tlayout->addSpacing(2);\n \tlayout->addWidget(_label);\n \n-\t_actionsToolbar = new QToolBar(this);\n-\t_actionsToolbar->setObjectName(QStringLiteral(\"actionsToolbar\"));\n-\t_actionsToolbar->setIconSize(QSize(16, 16));\n-\t_actionsToolbar->setFixedHeight(22);\n-\t_actionsToolbar->setStyleSheet(\"QToolBar{spacing: 0px;}\");\n-\t_actionsToolbar->setFloatable(false);\n-\t_actionsToolbar->setSizePolicy(QSizePolicy::Maximum,\n-\t\t\t\t       QSizePolicy::Maximum);\n-\t_actionsToolbar->setStyleSheet(\n-\t\t\"QToolButton {padding: 0px; margin-left: 2px; margin-right: 2px;}\");\n-\n-\t_actionProperties = new QAction(this);\n-\t_actionProperties->setObjectName(QStringLiteral(\"actionProperties\"));\n+\t_actionProperties = new QPushButton();\n \t_actionProperties->setProperty(\"themeID\", \"propertiesIconSmall\");\n-\t_actionProperties->setText(QT_UTF8(obs_module_text(\"Properties\")));\n-\tconnect(_actionProperties, SIGNAL(triggered()), this,\n-\t\tSLOT(on_actionProperties_triggered()));\n-\t_actionsToolbar->addAction(_actionProperties);\n-\n-\t_actionFilters = new QAction(this);\n-\t_actionFilters->setObjectName(QStringLiteral(\"actionFilters\"));\n-\t_actionFilters->setShortcutContext(Qt::WidgetWithChildrenShortcut);\n+\t_actionProperties->setDisabled(false);\n+\t_actionProperties->setAccessibleDescription(\n+\t\t\"Opens the source properties window.\");\n+\t_actionProperties->setAccessibleName(\"Open Source Properties\");\n+\t_actionProperties->setToolTip(\"Open Source Properties\");\n+\t_actionProperties->setStyleSheet(\"padding: 0px; background: none\");\n+\tconnect(_actionProperties, &QPushButton::released, this,\n+\t\t&QuickAccessItem::on_actionProperties_triggered);\n+\n+\t_actionFilters = new QPushButton();\n \t_actionFilters->setProperty(\"themeID\", \"filtersIcon\");\n-\t_actionFilters->setText(QT_UTF8(obs_module_text(\"Filters\")));\n-\tconnect(_actionFilters, SIGNAL(triggered()), this,\n-\t\tSLOT(on_actionFilters_triggered()));\n-\t_actionsToolbar->addAction(_actionFilters);\n-\n-\t_actionScenes = new QAction(this);\n-\t_actionScenes->setObjectName(QStringLiteral(\"actionScenes\"));\n-\t_actionScenes->setShortcutContext(Qt::WidgetWithChildrenShortcut);\n+\t_actionFilters->setDisabled(false);\n+\t_actionFilters->setAccessibleDescription(\n+\t\t\"Opens the source filters window.\");\n+\t_actionFilters->setAccessibleName(\"Open Source Filters\");\n+\t_actionFilters->setToolTip(\"Open Source Filters\");\n+\t_actionFilters->setStyleSheet(\"padding: 0px; background: none\");\n+\tconnect(_actionFilters, &QPushButton::released, this,\n+\t\t&QuickAccessItem::on_actionFilters_triggered);\n+\n+\t_actionScenes = new QPushButton();\n \tQIcon sceneIcon;\n \tsceneIcon = qau->GetSceneIcon();\n \t_actionScenes->setIcon(sceneIcon);\n-\t_actionScenes->setText(QT_UTF8(obs_module_text(\"Scenes\")));\n-\tconnect(_actionScenes, SIGNAL(triggered()), this,\n-\t\tSLOT(on_actionScenes_triggered()));\n-\t_actionsToolbar->addAction(_actionScenes);\n-\n-\tSetButtonVisibility();\n+\t_actionScenes->setDisabled(false);\n+\t_actionScenes->setAccessibleDescription(\n+\t\t\"Opens list of all parent scenes\");\n+\t_actionScenes->setAccessibleName(\"Show Parent Scenes\");\n+\t_actionScenes->setToolTip(\"Show Parent Scenes\");\n+\t_actionScenes->setStyleSheet(\"padding: 0px; background: none\");\n+\tconnect(_actionScenes, &QPushButton::released, this,\n+\t\t&QuickAccessItem::on_actionScenes_triggered);\n+\n+\tlayout->addWidget(_actionProperties);\n+\tlayout->addWidget(_actionFilters);\n+\tlayout->addWidget(_actionScenes);\n \n-\t// Themes need the QAction dynamic properties\n-\tfor (QAction *x : _actionsToolbar->actions()) {\n-\t\tQWidget *temp = _actionsToolbar->widgetForAction(x);\n-\n-\t\tfor (QByteArray &y : x->dynamicPropertyNames()) {\n-\t\t\ttemp->setProperty(y, x->property(y));\n-\t\t}\n-\t}\n-\tlayout->addWidget(_actionsToolbar);\n \tsetLayout(layout);\n+\tSetButtonVisibility();\n }\n \n void QuickAccessItem::SetButtonVisibility()\n@@ -135,17 +125,6 @@ void QuickAccessItem::SetButtonVisibility()\n \t_actionProperties->setVisible(_configurable && _dock->ShowProperties());\n \t_actionFilters->setVisible(_dock->ShowFilters());\n \t_actionScenes->setVisible(_dock->ShowScenes());\n-\n-\t// Refresh Toolbar Styling\n-\tfor (auto x : _actionsToolbar->actions()) {\n-\t\tauto widget = _actionsToolbar->widgetForAction(x);\n-\n-\t\tif (!widget) {\n-\t\t\tcontinue;\n-\t\t}\n-\t\twidget->style()->unpolish(widget);\n-\t\twidget->style()->polish(widget);\n-\t}\n }\n \n const char *QuickAccessItem::GetSourceName()\n@@ -160,7 +139,9 @@ QuickAccessItem::~QuickAccessItem()\n {\n \tdelete _label;\n \tdelete _iconLabel;\n-\tdelete _actionsToolbar;\n+\tdelete _actionProperties;\n+\tdelete _actionFilters;\n+\tdelete _actionScenes;\n \t_clearSceneItems();\n \tobs_weak_source_release(_source);\n }\n@@ -352,9 +333,16 @@ QuickAccess::QuickAccess(QWidget *parent, QuickAccessDock *dock, QString name)\n \t_sourceList->setFrameShape(QFrame::NoFrame);\n \t_sourceList->setFrameShadow(QFrame::Plain);\n \t_sourceList->setProperty(\"showDropIndicator\", QVariant(true));\n-\t_sourceList->setDragEnabled(_dock->GetType() == \"Manual\");\n-\t_sourceList->setDragDropMode(QAbstractItemView::InternalMove);\n-\t_sourceList->setDefaultDropAction(Qt::TargetMoveAction);\n+\tif (_dock->GetType() == \"Manual\") {\n+\t\t_sourceList->setDragEnabled(true);\n+\t\t_sourceList->setDragDropMode(QAbstractItemView::InternalMove);\n+\t\t_sourceList->setDefaultDropAction(Qt::TargetMoveAction);\n+\t} else {\n+\t\t_sourceList->setDragEnabled(false);\n+\t\t_sourceList->setDragDropMode(QAbstractItemView::NoDragDrop);\n+\t\t_sourceList->viewport()->setAcceptDrops(false);\n+\t}\n+\n \tconnect(_sourceList, SIGNAL(itemSelectionChanged()), this,\n \t\tSLOT(on_sourceList_itemSelectionChanged()));\n \ndiff --git a/src/quick-access.hpp b/src/quick-access.hpp\nindex 073bfa8..3fb49ea 100644\n--- a/src/quick-access.hpp\n+++ b/src/quick-access.hpp\n@@ -72,10 +72,9 @@ class QuickAccessItem : public QFrame {\n \tQLabel *_label = nullptr;\n \tQLabel *_iconLabel = nullptr;\n \n-\tQToolBar *_actionsToolbar = nullptr;\n-\tQAction *_actionProperties = nullptr;\n-\tQAction *_actionFilters = nullptr;\n-\tQAction *_actionScenes = nullptr;\n+\tQPushButton *_actionProperties = nullptr;\n+\tQPushButton *_actionFilters = nullptr;\n+\tQPushButton *_actionScenes = nullptr;\n \n \tQPushButton *_filters = nullptr;\n \tobs_weak_source_t *_source = nullptr;\n", "test_patch": "", "problem_statement": "[BUG] - Crash when dragging/dropping a dock source item in non-manual mode.\n**Describe the bug**\r\nAn item can still be dragged in non-manual docks, which causes OBS to crash.\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Create a new dynamic or search dock.\r\n2. Make sure it is populated with items.\r\n3. Drag an item up or down and release.\r\n4. Crash.\r\n\r\n**Expected behavior**\r\nDynamic and search docks should not have any ability to drag/reorder items, and should not crash if an item is accidentally dragged.\r\n\r\n**Additional context**\r\nNeed to disable drag/drop functionality for non-manual docks.\n", "hints_text": "", "created_at": "2024-06-30 21:08:38", "merge_commit_sha": "d6b2c4d720413db97df8757a84085e65627a6b5f", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["Build for Ubuntu \ud83d\udc27", ".github/workflows/pr-pull.yaml"], ["Build for macOS \ud83c\udf4f", ".github/workflows/pr-pull.yaml"], ["cmake-format", ".github/workflows/pr-pull.yaml"], ["Package Windows (signed) \ud83d\udcc0", ".github/workflows/pr-pull.yaml"]]}
{"repo": "ledger/ledger", "instance_id": "ledger__ledger-2381", "base_commit": "a908d37ed1d5acd1ac18b66597b447bf6e94e837", "patch": "diff --git a/src/filters.cc b/src/filters.cc\nindex b5b7fb19f..523fa7959 100644\n--- a/src/filters.cc\n+++ b/src/filters.cc\n@@ -237,8 +237,6 @@ void anonymize_posts::render_commodity(amount_t& amt)\n \n void anonymize_posts::operator()(post_t& post)\n {\n-\tboost::uuids::detail::sha1  sha;\n-  unsigned int message_digest[5];\n   bool         copy_xact_details = false;\n \n   if (last_xact != post.xact) {\n@@ -255,12 +253,7 @@ void anonymize_posts::operator()(post_t& post)\n     std::ostringstream buf;\n     buf << reinterpret_cast<boost::uintmax_t>(post.xact->payee.c_str())\n         << integer_gen() << post.xact->payee.c_str();\n-\n-\t\tsha.reset();\n-    sha.process_bytes(buf.str().c_str(), buf.str().length());\n-    sha.get_digest(message_digest);\n-\n-    xact.payee = to_hex(message_digest);\n+    xact.payee = sha1sum(buf.str(), 8);\n     xact.note  = none;\n   } else {\n     xact.journal = post.xact->journal;\n@@ -273,12 +266,7 @@ void anonymize_posts::operator()(post_t& post)\n        acct = acct->parent) {\n     std::ostringstream buf;\n     buf << integer_gen() << acct << acct->fullname();\n-\n-    sha.reset();\n-    sha.process_bytes(buf.str().c_str(), buf.str().length());\n-    sha.get_digest(message_digest);\n-\n-    account_names.push_front(to_hex(message_digest));\n+    account_names.push_front(sha1sum(buf.str(), 8));\n   }\n \n   account_t * new_account =\n@@ -1269,7 +1257,7 @@ void budget_posts::report_budget_items(const date_t& date)\n     foreach (pending_posts_list::iterator& i, posts_to_erase)\n       pending_posts.erase(i);\n   }\n-  \n+\n   if (pending_posts.size() == 0)\n     return;\n \ndiff --git a/src/utils.h b/src/utils.h\nindex bc05ff4f9..13cf26f63 100644\n--- a/src/utils.h\n+++ b/src/utils.h\n@@ -578,29 +578,39 @@ inline int peek_next_nonws(std::istream& in) {\n     *_p = '\\0';                                         \\\n   }\n \n-inline string to_hex(unsigned int * message_digest, const int len = 1)\n-{\n+inline string digest_to_hex(\n+  const boost::uuids::detail::sha1::digest_type& message_digest,\n+  size_t len = sizeof(boost::uuids::detail::sha1::digest_type) * 2\n+) {\n   std::ostringstream buf;\n-\n-  for(int i = 0; i < 5 ; i++) {\n-    buf.width(8);\n-    buf.fill('0');\n-    buf << std::hex << message_digest[i];\n-    if (i + 1 >= len)\n-      break;                    // only output the first LEN dwords\n+  buf.setf(std::ios_base::hex, std::ios_base::basefield);\n+  buf.fill('0');\n+\n+  // sha1::digest_type is an array type and may change between Boost versions\n+  const size_t count = std::min(\n+    sizeof(message_digest) / sizeof(message_digest[0]),\n+    (len - 1) / (sizeof(message_digest[0]) * 2) + 1\n+  );\n+  for(size_t i = 0; i < count; i++) {\n+    buf.width(sizeof(message_digest[i]) * 2);\n+    buf << (unsigned int)message_digest[i];\n   }\n-  return buf.str();\n+  string hex = buf.str();\n+  hex.resize(len, '0'); // in case a partial element is requested\n+  return hex;\n }\n \n-inline string sha1sum(const string& str)\n-{\n-\tboost::uuids::detail::sha1 sha;\n+inline string sha1sum(\n+  const string& str,\n+  size_t len = sizeof(boost::uuids::detail::sha1::digest_type) * 2\n+) {\n+\tstatic boost::uuids::detail::sha1 sha;\n+  boost::uuids::detail::sha1::digest_type message_digest;\n \n+\tsha.reset();\n   sha.process_bytes(str.c_str(), str.length());\n-\n-  unsigned int message_digest[5];\n   sha.get_digest(message_digest);\n-  return to_hex(message_digest, 5);\n+  return digest_to_hex(message_digest, len);\n }\n \n extern const string version;\n", "test_patch": "", "problem_statement": "Build fails with boost 1.86\nWith Boost 1.86.0-2, I get the following error during build:\r\n```\r\nIn file included from src/exprbase.h:56,\r\n                 from src/draft.h:44,\r\n                 from src/stats.cc:34\r\nsrc/utils.h: In function \u2018ledger::string ledger::sha1sum(const string&)\u2019:\r\nsrc/utils.h:602:18: error: cannot convert \u2018unsigned int [5]\u2019 to \u2018unsigned char (&)[20]\u2019\r\n  602 |   sha.get_digest(message_digest);\r\n      |                  ^~~~~~~~~~~~~~\r\n      |                  |\r\n      |                  unsigned int [5]\r\nIn file included from src/utils.h:46:\r\n/usr/include/boost/uuid/detail/sha1.hpp:179:43: note:   initializing argument 1 of \u2018void boost::uuids::detail::sha1::get_digest(unsigned char (&)[20])\u2019\r\n  179 | inline void sha1::get_digest(digest_type& digest)\r\n      |                              ~~~~~~~~~~~~~^~~~~~\r\n```\nBuild fails with boost 1.86\nWith Boost 1.86.0-2, I get the following error during build:\r\n```\r\nIn file included from src/exprbase.h:56,\r\n                 from src/draft.h:44,\r\n                 from src/stats.cc:34\r\nsrc/utils.h: In function \u2018ledger::string ledger::sha1sum(const string&)\u2019:\r\nsrc/utils.h:602:18: error: cannot convert \u2018unsigned int [5]\u2019 to \u2018unsigned char (&)[20]\u2019\r\n  602 |   sha.get_digest(message_digest);\r\n      |                  ^~~~~~~~~~~~~~\r\n      |                  |\r\n      |                  unsigned int [5]\r\nIn file included from src/utils.h:46:\r\n/usr/include/boost/uuid/detail/sha1.hpp:179:43: note:   initializing argument 1 of \u2018void boost::uuids::detail::sha1::get_digest(unsigned char (&)[20])\u2019\r\n  179 | inline void sha1::get_digest(digest_type& digest)\r\n      |                              ~~~~~~~~~~~~~^~~~~~\r\n```\n", "hints_text": "\n", "created_at": "2024-09-13 12:50:56", "merge_commit_sha": "684ccbd86d2eb56d51db2a19653793a02f62172e", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["build (ubuntu-latest)", ".github/workflows/nix-flake.yml"], ["build (ubuntu-latest, Ubuntu, 3, -DUSE_PYTHON=ON -DUSE_GPGME=ON)", ".github/workflows/cmake.yml"]]}
{"repo": "leil-io/saunafs", "instance_id": "leil-io__saunafs-237", "base_commit": "dbef020887689eb381ac597006453f0d132abbfa", "patch": "diff --git a/src/chunkserver/chunkserver-common/plugin_manager.cc b/src/chunkserver/chunkserver-common/plugin_manager.cc\nindex 30fa071a6..69cf5568a 100644\n--- a/src/chunkserver/chunkserver-common/plugin_manager.cc\n+++ b/src/chunkserver/chunkserver-common/plugin_manager.cc\n@@ -19,19 +19,27 @@\n #include \"common/platform.h\"\n \n #include \"chunkserver-common/plugin_manager.h\"\n+#include <boost/filesystem/exception.hpp>\n \n #include \"chunkserver-common/disk_plugin.h\"\n #include \"slogger/slogger.h\"\n \n bool PluginManager::loadPlugins(const std::string &directory) {\n-\tif (!boost::filesystem::is_directory(directory) ||\n-\t    boost::filesystem::is_empty(directory)) {\n-\t\t// It is normal to not have any plugins in many scenarios\n-\t\tsafs_pretty_syslog(\n-\t\t    LOG_NOTICE,\n-\t\t    \"PluginManager: Directory %s does not exist or is empty\",\n-\t\t    directory.c_str());\n-\t\treturn false;\n+\ttry {\n+\t\tif (!boost::filesystem::is_directory(directory) ||\n+\t\t    boost::filesystem::is_empty(directory)) {\n+\t\t\t// It is normal to not have any plugins in many scenarios\n+\t\t\tsafs_pretty_syslog(\n+\t\t\t    LOG_NOTICE,\n+\t\t\t    \"PluginManager: Directory %s does not exist or is empty\",\n+\t\t\t    directory.c_str());\n+\t\t\treturn false;\n+\t\t}\n+\t} catch (boost::filesystem::filesystem_error &e) {\n+\t\t\tsafs::log_info(\n+\t\t\t    \"PluginManager: Directory {} cannot not be checked: {}\",\n+\t\t\t    directory.c_str(), e.what());\n+\t\t\treturn false;\n \t}\n \n \tboost::filesystem::path dir(directory);\n", "test_patch": "", "problem_statement": "Unhandled permission denied exception in plugin-manager.cc\nWhen the chunkserver plugin is not installed (as is the default in CMake right now), it will try to load the plugin from the build directory, which may not be available (could be either permissions or it could not exist, very common when transitioning from a build environment), this causes a exception which is handled by initialize, which then causes the program exits. This is undesired as chunkserver can work without a plugin.\r\n\r\nReproduce:\r\n\r\n1. Build and install from directory where `saunafs` (or whatever user is running chunkserver) cannot access the build files.\r\n2. Run chunkserver\r\n\r\nPotential fix:\r\n\r\n```diff\r\ndiff --git a/src/chunkserver/chunkserver-common/plugin_manager.cc b/src/chunkserver/chunkserver-common/plugin_manager.cc\r\nindex 30fa071a..69cf5568 100644\r\n--- a/src/chunkserver/chunkserver-common/plugin_manager.cc\r\n+++ b/src/chunkserver/chunkserver-common/plugin_manager.cc\r\n@@ -19,19 +19,27 @@\r\n #include \"common/platform.h\"\r\n \r\n #include \"chunkserver-common/plugin_manager.h\"\r\n+#include <boost/filesystem/exception.hpp>\r\n \r\n #include \"chunkserver-common/disk_plugin.h\"\r\n #include \"slogger/slogger.h\"\r\n \r\n bool PluginManager::loadPlugins(const std::string &directory) {\r\n-\tif (!boost::filesystem::is_directory(directory) ||\r\n-\t    boost::filesystem::is_empty(directory)) {\r\n-\t\t// It is normal to not have any plugins in many scenarios\r\n-\t\tsafs_pretty_syslog(\r\n-\t\t    LOG_NOTICE,\r\n-\t\t    \"PluginManager: Directory %s does not exist or is empty\",\r\n-\t\t    directory.c_str());\r\n-\t\treturn false;\r\n+\ttry {\r\n+\t\tif (!boost::filesystem::is_directory(directory) ||\r\n+\t\t    boost::filesystem::is_empty(directory)) {\r\n+\t\t\t// It is normal to not have any plugins in many scenarios\r\n+\t\t\tsafs_pretty_syslog(\r\n+\t\t\t    LOG_NOTICE,\r\n+\t\t\t    \"PluginManager: Directory %s does not exist or is empty\",\r\n+\t\t\t    directory.c_str());\r\n+\t\t\treturn false;\r\n+\t\t}\r\n+\t} catch (boost::filesystem::filesystem_error &e) {\r\n+\t\t\tsafs::log_info(\r\n+\t\t\t    \"PluginManager: Directory {} cannot not be checked: {}\",\r\n+\t\t\t    directory.c_str(), e.what());\r\n+\t\t\treturn false;\r\n \t}\r\n \r\n \tboost::filesystem::path dir(directory);\r\n```\r\n\r\nOther idea is to include the chunkserver plugin by default when installing\n", "hints_text": "Thoughts @lgsilva3087?", "created_at": "2024-11-04 13:27:55", "merge_commit_sha": "3350e64d8f66efbe60ab96201c6a9351f7db6b4e", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["Run-Unit-Tests-and-Ganesha", ".github/workflows/run-unit-and-ganesha-tests.yml"]]}
{"repo": "doctest/doctest", "instance_id": "doctest__doctest-881", "base_commit": "35a540d01395117c733125aa7d1781b37b40d077", "patch": "diff --git a/examples/all_features/CMakeLists.txt b/examples/all_features/CMakeLists.txt\nindex 19436c549..7b6277007 100644\n--- a/examples/all_features/CMakeLists.txt\n+++ b/examples/all_features/CMakeLists.txt\n@@ -9,6 +9,7 @@ set(files_with_output\n     alternative_macros.cpp\n     assertion_macros.cpp\n     stringification.cpp\n+    check_doctest_string.cpp\n     double_stringification.cpp\n     reporters_and_listeners.cpp\n     subcases.cpp\n", "test_patch": "diff --git a/doctest/doctest.h b/doctest/doctest.h\nindex 5c754cde0..7df38834d 100644\n--- a/doctest/doctest.h\n+++ b/doctest/doctest.h\n@@ -3751,7 +3751,7 @@ String::size_type String::capacity() const {\n }\n \n String String::substr(size_type pos, size_type cnt) && {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     char* cptr = c_str();\n     memmove(cptr, cptr + pos, cnt);\n     setSize(cnt);\n@@ -3759,7 +3759,7 @@ String String::substr(size_type pos, size_type cnt) && {\n }\n \n String String::substr(size_type pos, size_type cnt) const & {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     return String{ c_str() + pos, cnt };\n }\n \ndiff --git a/doctest/parts/doctest.cpp b/doctest/parts/doctest.cpp\nindex 5a2dd4599..19ba25a4f 100644\n--- a/doctest/parts/doctest.cpp\n+++ b/doctest/parts/doctest.cpp\n@@ -661,7 +661,7 @@ String::size_type String::capacity() const {\n }\n \n String String::substr(size_type pos, size_type cnt) && {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     char* cptr = c_str();\n     memmove(cptr, cptr + pos, cnt);\n     setSize(cnt);\n@@ -669,7 +669,7 @@ String String::substr(size_type pos, size_type cnt) && {\n }\n \n String String::substr(size_type pos, size_type cnt) const & {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     return String{ c_str() + pos, cnt };\n }\n \ndiff --git a/examples/all_features/check_doctest_string.cpp b/examples/all_features/check_doctest_string.cpp\nnew file mode 100644\nindex 000000000..2fce03506\n--- /dev/null\n+++ b/examples/all_features/check_doctest_string.cpp\n@@ -0,0 +1,10 @@\n+#include <doctest/doctest.h>\n+\n+TEST_SUITE(\"doctest unit tests\") {\n+    TEST_CASE(\"doctest::String::substr()\") {\n+        const doctest::String abcde = \"abcde\";\n+        CHECK(abcde.substr(0, 3) == \"abc\");\n+        CHECK(abcde.substr(2, 3) == \"cde\");\n+        CHECK(abcde.substr(0, 5) == \"abcde\");\n+    }\n+}\n\\ No newline at end of file\ndiff --git a/examples/all_features/test_output/check_doctest_string.cpp.txt b/examples/all_features/test_output/check_doctest_string.cpp.txt\nnew file mode 100644\nindex 000000000..75be56a8f\n--- /dev/null\n+++ b/examples/all_features/test_output/check_doctest_string.cpp.txt\n@@ -0,0 +1,6 @@\n+[doctest] run with \"--help\" for options\n+===============================================================================\n+[doctest] test cases: 1 | 1 passed | 0 failed |\n+[doctest] assertions: 3 | 3 passed | 0 failed |\n+[doctest] Status: SUCCESS!\n+Program code.\ndiff --git a/examples/all_features/test_output/check_doctest_string.cpp_junit.txt b/examples/all_features/test_output/check_doctest_string.cpp_junit.txt\nnew file mode 100644\nindex 000000000..eb141a57b\n--- /dev/null\n+++ b/examples/all_features/test_output/check_doctest_string.cpp_junit.txt\n@@ -0,0 +1,7 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<testsuites>\n+  <testsuite name=\"all_features\" errors=\"0\" failures=\"0\" tests=\"3\">\n+    <testcase classname=\"check_doctest_string.cpp\" name=\"doctest::String::substr()\" status=\"run\"/>\n+  </testsuite>\n+</testsuites>\n+Program code.\ndiff --git a/examples/all_features/test_output/check_doctest_string.cpp_xml.txt b/examples/all_features/test_output/check_doctest_string.cpp_xml.txt\nnew file mode 100644\nindex 000000000..12c39533d\n--- /dev/null\n+++ b/examples/all_features/test_output/check_doctest_string.cpp_xml.txt\n@@ -0,0 +1,12 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<doctest binary=\"all_features\">\n+  <Options order_by=\"file\" rand_seed=\"324\" first=\"0\" last=\"4294967295\" abort_after=\"0\" subcase_filter_levels=\"2147483647\" case_sensitive=\"false\" no_throw=\"false\" no_skip=\"false\"/>\n+  <TestSuite name=\"doctest unit tests\">\n+    <TestCase name=\"doctest::String::substr()\" filename=\"check_doctest_string.cpp\" line=\"0\">\n+      <OverallResultsAsserts successes=\"3\" failures=\"0\" test_case_success=\"true\"/>\n+    </TestCase>\n+  </TestSuite>\n+  <OverallResultsAsserts successes=\"3\" failures=\"0\"/>\n+  <OverallResultsTestCases successes=\"1\" failures=\"0\"/>\n+</doctest>\n+Program code.\ndiff --git a/examples/all_features/test_output/filter_2.txt b/examples/all_features/test_output/filter_2.txt\nindex 7d43c001c..cc3557f98 100644\n--- a/examples/all_features/test_output/filter_2.txt\n+++ b/examples/all_features/test_output/filter_2.txt\n@@ -1,6 +1,6 @@\n [doctest] run with \"--help\" for options\n ===============================================================================\n-[doctest] test cases: 0 | 0 passed | 0 failed | 108 skipped\n+[doctest] test cases: 0 | 0 passed | 0 failed | 109 skipped\n [doctest] assertions: 0 | 0 passed | 0 failed |\n [doctest] Status: SUCCESS!\n Program code.\ndiff --git a/examples/all_features/test_output/filter_2_xml.txt b/examples/all_features/test_output/filter_2_xml.txt\nindex f1c124dac..7905baa89 100644\n--- a/examples/all_features/test_output/filter_2_xml.txt\n+++ b/examples/all_features/test_output/filter_2_xml.txt\n@@ -42,6 +42,9 @@\n     <TestCase name=\"default construction&lt;signed char>\" filename=\"templated_test_cases.cpp\" line=\"0\" skipped=\"true\"/>\n     <TestCase name=\"default construction&lt;unsigned char>\" filename=\"templated_test_cases.cpp\" line=\"0\" skipped=\"true\"/>\n   </TestSuite>\n+  <TestSuite name=\"doctest unit tests\">\n+    <TestCase name=\"doctest::String::substr()\" filename=\"check_doctest_string.cpp\" line=\"0\" skipped=\"true\"/>\n+  </TestSuite>\n   <TestSuite name=\"test suite with a description\">\n     <TestCase name=\"doesn't fail but it should have\" filename=\"test_cases_and_suites.cpp\" line=\"0\" description=\"regarding failures\" should_fail=\"true\" skipped=\"true\"/>\n     <TestCase name=\"doesn't fail which is fine\" filename=\"test_cases_and_suites.cpp\" line=\"0\" description=\"regarding failures\" may_fail=\"true\" skipped=\"true\"/>\n@@ -152,6 +155,6 @@\n     <TestCase name=\"without a funny name:\" filename=\"subcases.cpp\" line=\"0\" skipped=\"true\"/>\n   </TestSuite>\n   <OverallResultsAsserts successes=\"0\" failures=\"0\"/>\n-  <OverallResultsTestCases successes=\"0\" failures=\"0\" skipped=\"108\"/>\n+  <OverallResultsTestCases successes=\"0\" failures=\"0\" skipped=\"109\"/>\n </doctest>\n Program code.\ndiff --git a/examples/all_features/test_output/no_multi_lane_atomics.txt b/examples/all_features/test_output/no_multi_lane_atomics.txt\nindex 4469b9154..15c128634 100644\n--- a/examples/all_features/test_output/no_multi_lane_atomics.txt\n+++ b/examples/all_features/test_output/no_multi_lane_atomics.txt\n@@ -925,7 +925,7 @@ TEST CASE:  without a funny name:\n subcases.cpp(0): MESSAGE: Nooo\n \n ===============================================================================\n-[doctest] test cases:  86 |  35 passed |  51 failed |\n-[doctest] assertions: 235 | 115 passed | 120 failed |\n+[doctest] test cases:  87 |  36 passed |  51 failed |\n+[doctest] assertions: 238 | 118 passed | 120 failed |\n [doctest] Status: FAILURE!\n Program code.\ndiff --git a/examples/all_features/test_output/no_multithreading.txt b/examples/all_features/test_output/no_multithreading.txt\nindex 4469b9154..15c128634 100644\n--- a/examples/all_features/test_output/no_multithreading.txt\n+++ b/examples/all_features/test_output/no_multithreading.txt\n@@ -925,7 +925,7 @@ TEST CASE:  without a funny name:\n subcases.cpp(0): MESSAGE: Nooo\n \n ===============================================================================\n-[doctest] test cases:  86 |  35 passed |  51 failed |\n-[doctest] assertions: 235 | 115 passed | 120 failed |\n+[doctest] test cases:  87 |  36 passed |  51 failed |\n+[doctest] assertions: 238 | 118 passed | 120 failed |\n [doctest] Status: FAILURE!\n Program code.\ndiff --git a/examples/all_features/test_output/std_headers.txt b/examples/all_features/test_output/std_headers.txt\nindex 4469b9154..15c128634 100644\n--- a/examples/all_features/test_output/std_headers.txt\n+++ b/examples/all_features/test_output/std_headers.txt\n@@ -925,7 +925,7 @@ TEST CASE:  without a funny name:\n subcases.cpp(0): MESSAGE: Nooo\n \n ===============================================================================\n-[doctest] test cases:  86 |  35 passed |  51 failed |\n-[doctest] assertions: 235 | 115 passed | 120 failed |\n+[doctest] test cases:  87 |  36 passed |  51 failed |\n+[doctest] assertions: 238 | 118 passed | 120 failed |\n [doctest] Status: FAILURE!\n Program code.\n", "problem_statement": "bug: doctest::String::substr() off by one at the end\n## Description\r\n\r\n`doctest::String::substr()` cuts short the last character, when extracting from the end of the `String`.\r\n\r\n\r\n### Steps to reproduce\r\n\r\n```\r\n#include <doctest/doctest.h>\r\n\r\nTEST_SUITE(\"doctest unit tests\") {\r\n    TEST_CASE(\"doctest::String::substr()\") {\r\n        const doctest::String abcde = \"abcde\";\r\n        CHECK(abcde.substr(0, 3) == \"abc\");\r\n        CHECK(abcde.substr(2, 3) == \"cde\");\r\n        CHECK(abcde.substr(0, 5) == \"abcde\");\r\n    }\r\n}\r\n```\r\n\r\n```\r\n===============================================================================\r\ncheck_doctest_string.cpp(0):\r\nTEST SUITE: doctest unit tests\r\nTEST CASE:  doctest::String::substr()\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(2, 3) == \"cde\" ) is NOT correct!\r\n  values: CHECK( cd == cde )\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(0, 5) == \"abcde\" ) is NOT correct!\r\n  values: CHECK( abcd == abcde )\r\n\r\n===============================================================================\r\n```\r\n\r\n\r\n### Extra information\r\n\r\n* doctest version: **v2.4.9** ... v2.4.11\r\n* Operating System: **22.04.1-Ubuntu**\r\n* Compiler+version: **GCC 12.3.0 x86_64**\r\n\n", "hints_text": "", "created_at": "2024-11-27 11:51:15", "merge_commit_sha": "4a97a18d349053eeb706be3311abbb71343c1280", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["ci (ubuntu-latest, clang, 14)", ".github/workflows/main.yml"], ["sanitizers (integer)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 5.0)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Release)", ".github/workflows/main.yml"], ["ci (macOS-latest, gcc, 11)", ".github/workflows/main.yml"], ["ci-msvs (v143, Win32, Release)", ".github/workflows/main.yml"], ["sanitizers (thread)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 4.8)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, cl)", ".github/workflows/main.yml"], ["clang-tidy", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 12)", ".github/workflows/main.yml"], ["ci-msvs (v142, Win32, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 6.0)", ".github/workflows/main.yml"], ["sanitizers (address)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 9)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 8)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 11)", ".github/workflows/main.yml"], ["sanitizers (undefined)", ".github/workflows/main.yml"], ["ci-msvs (v141, x64, Release)", ".github/workflows/main.yml"], ["sanitizers (safe-stack)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-latest, gcc, 9)", ".github/workflows/main.yml"], ["ci-msvs (v140, Win32, Debug)", ".github/workflows/main.yml"], ["ci (macOS-latest, xcode, 13.2.1)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Release)", ".github/workflows/main.yml"], ["ci-msvs (v143, x64, Release)", ".github/workflows/main.yml"], ["ci-min-gw (Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 3.7)", ".github/workflows/main.yml"], ["sanitizers (implicit-conversion)", ".github/workflows/main.yml"], ["ci-msvs (v141, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 7)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, clang)", ".github/workflows/main.yml"]]}
{"repo": "doctest/doctest", "instance_id": "doctest__doctest-878", "base_commit": "35a540d01395117c733125aa7d1781b37b40d077", "patch": "diff --git a/examples/all_features/CMakeLists.txt b/examples/all_features/CMakeLists.txt\nindex 19436c549..47ee019b0 100644\n--- a/examples/all_features/CMakeLists.txt\n+++ b/examples/all_features/CMakeLists.txt\n@@ -63,7 +63,7 @@ if(NOT MINGW AND NOT DEFINED DOCTEST_THREAD_LOCAL)\n     doctest_add_test(NO_OUTPUT NAME concurrency.cpp ${common_args} -sf=*concurrency.cpp -d) # duration: there is no output anyway\n endif()\n \n-doctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp.cpp )\n+doctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp )\n doctest_add_test(NO_OUTPUT NAME bitfields.cpp ${common_args} -sf=*bitfields.cpp )\n doctest_add_test(NO_OUTPUT NAME namespace1.cpp ${common_args} -sf=*namespace1.cpp )\n doctest_add_test(NO_OUTPUT NAME namespace2.cpp ${common_args} -sf=*namespace2.cpp )\n", "test_patch": "", "problem_statement": "Typo in examples/all_features/CMakeLists.txt\n## Description\r\n\r\nThere is probably a copy&paste error in:\r\nhttps://github.com/doctest/doctest/blob/35a540d01395117c733125aa7d1781b37b40d077/examples/all_features/CMakeLists.txt#L66\r\n```\r\ndoctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp.cpp )\r\n                                                                                                         ^^^^\r\n```\r\nSee the double `.cpp`?\n", "hints_text": "", "created_at": "2024-11-27 10:41:45", "merge_commit_sha": "90f4e3144b25008b2942d612106900d6e1db57e1", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["ci (ubuntu-latest, clang, 14)", ".github/workflows/main.yml"], ["sanitizers (integer)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 5.0)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Release)", ".github/workflows/main.yml"], ["ci (macOS-latest, gcc, 11)", ".github/workflows/main.yml"], ["ci-msvs (v143, Win32, Release)", ".github/workflows/main.yml"], ["sanitizers (thread)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 4.8)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, cl)", ".github/workflows/main.yml"], ["clang-tidy", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 12)", ".github/workflows/main.yml"], ["ci-msvs (v142, Win32, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 6.0)", ".github/workflows/main.yml"], ["sanitizers (address)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 9)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 8)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 11)", ".github/workflows/main.yml"], ["sanitizers (undefined)", ".github/workflows/main.yml"], ["ci-msvs (v141, x64, Release)", ".github/workflows/main.yml"], ["sanitizers (safe-stack)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-latest, gcc, 9)", ".github/workflows/main.yml"], ["ci-msvs (v140, Win32, Debug)", ".github/workflows/main.yml"], ["ci (macOS-latest, xcode, 13.2.1)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Release)", ".github/workflows/main.yml"], ["ci-msvs (v143, x64, Release)", ".github/workflows/main.yml"], ["ci-min-gw (Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 3.7)", ".github/workflows/main.yml"], ["sanitizers (implicit-conversion)", ".github/workflows/main.yml"], ["ci-msvs (v141, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 7)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, clang)", ".github/workflows/main.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-882", "base_commit": "57123951b57eb38ab219eaa188ed73cc917f728f", "patch": "diff --git a/README.md b/README.md\nindex 9ea6ed923..985d14eff 100644\n--- a/README.md\n+++ b/README.md\n@@ -253,7 +253,7 @@ For optimal compression results, the values must be quantized to small integers.\n For single-precision floating-point data, it's recommended to use `meshopt_quantizeFloat` to remove entropy from the lower bits of the mantissa. Due to current limitations of the codec, the bit count needs to be 15 (23-8) for good results (7 can be used for more extreme compression).\n For normal or tangent vectors, using octahedral encoding is recommended over three components as it reduces redundancy. Similarly to other quantized values, consider using 10-12 bits per component instead of 16.\n \n-When data is bit packed, using v1 vertex codec (via `meshopt_encodeVertexVersion(1)`) and specifying compression level 3 (`meshopt_encodeVertexBufferLevel`) can improve the compression further by redistributing bits between components. Note that v1 vertex codec is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n+When data is bit packed, using v1 vertex codec and specifying compression level 3 (`meshopt_encodeVertexBufferLevel` with level 3 and version 1) can improve the compression further by redistributing bits between components. Note that v1 vertex codec (`meshopt_encodeVertexVersion(1)`) is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n \n To further leverage the inherent structure of some data, the preparation stage can use filters that encode and decode the data in a lossy manner. This is similar to quantization but can be used without having to change the shader code. After decoding, the filter transformation needs to be reversed. For native game engine pipelines, it is usually more optimal to carefully prequantize and pretransform the vertex data, but sometimes (for example when serializing data in glTF format) this is not a practical option and filters are more practical. This library provides three filters:\n \n@@ -618,7 +618,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_buildMeshletsFlex`\n - `meshopt_buildMeshletsSplit`\n - `meshopt_computeSphereBounds`*\n-- `meshopt_encodeVertexBufferLevel`*\n+- `meshopt_encodeVertexBufferLevel`\n - `meshopt_generateProvokingIndexBuffer`*\n - `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex a98c69461..a06a54f04 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -893,7 +893,7 @@ void encodeVertex(const Mesh& mesh, const char* pvn, int level = 2)\n \tdouble start = timestamp();\n \n \tstd::vector<unsigned char> vbuf(meshopt_encodeVertexBufferBound(mesh.vertices.size(), sizeof(PV)));\n-\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level));\n+\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level, -1));\n \n \tdouble middle = timestamp();\n \ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 84ba1a7ab..ef6c4a93f 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -304,8 +304,9 @@ MESHOPTIMIZER_API size_t meshopt_encodeVertexBufferBound(size_t vertex_count, si\n  * The default compression level implied by meshopt_encodeVertexBuffer is 2.\n  *\n  * level should be in the range [0, 3] with 0 being the fastest and 3 being the slowest and producing the best compression ratio.\n+ * version should be -1 to use the default version (specified via meshopt_encodeVertexVersion), or 0/1 to override the version; per above, level won't take effect if version is 0.\n  */\n-MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level);\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version);\n \n /**\n  * Set vertex encoder format version\ndiff --git a/src/vertexcodec.cpp b/src/vertexcodec.cpp\nindex 53cf9d753..847589b3d 100644\n--- a/src/vertexcodec.cpp\n+++ b/src/vertexcodec.cpp\n@@ -1643,13 +1643,16 @@ static unsigned int cpuid = getCpuFeatures();\n \n } // namespace meshopt\n \n-size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level)\n+size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version)\n {\n \tusing namespace meshopt;\n \n \tassert(vertex_size > 0 && vertex_size <= 256);\n \tassert(vertex_size % 4 == 0);\n \tassert(level >= 0 && level <= 9); // only a subset of this range is used right now\n+\tassert(version < 0 || unsigned(version) <= kDecodeVertexVersion);\n+\n+\tversion = version < 0 ? gEncodeVertexVersion : version;\n \n #if TRACE\n \tmemset(vertexstats, 0, sizeof(vertexstats));\n@@ -1663,8 +1666,6 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \tif (size_t(data_end - data) < 1)\n \t\treturn 0;\n \n-\tint version = gEncodeVertexVersion;\n-\n \t*data++ = (unsigned char)(kVertexHeader | version);\n \n \tunsigned char first_vertex[256] = {};\n@@ -1777,7 +1778,7 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \n size_t meshopt_encodeVertexBuffer(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size)\n {\n-\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel);\n+\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel, meshopt::gEncodeVertexVersion);\n }\n \n size_t meshopt_encodeVertexBufferBound(size_t vertex_count, size_t vertex_size)\ndiff --git a/tools/codecfuzz.cpp b/tools/codecfuzz.cpp\nindex 89bce2409..4992857e3 100644\n--- a/tools/codecfuzz.cpp\n+++ b/tools/codecfuzz.cpp\n@@ -26,12 +26,12 @@ void fuzzRoundtrip(const uint8_t* data, size_t size, size_t stride, int level)\n \tvoid* decoded = malloc(count * stride);\n \tassert(encoded && decoded);\n \n-\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level);\n+\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level, -1);\n \tassert(res > 0 && res <= bound);\n \n \t// encode again at the boundary to check for memory safety\n \t// this should produce the same output because encoder is deterministic\n-\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level);\n+\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level, -1);\n \tassert(rese == res);\n \n \tint rc = meshopt_decodeVertexBuffer(decoded, count, stride, static_cast<unsigned char*>(encoded) + bound - res, res);\n", "test_patch": "diff --git a/demo/tests.cpp b/demo/tests.cpp\nindex 1636756ca..8e9e4a9c1 100644\n--- a/demo/tests.cpp\n+++ b/demo/tests.cpp\n@@ -616,7 +616,7 @@ static void decodeVertexDeltas()\n \t}\n \n \tstd::vector<unsigned char> buffer(meshopt_encodeVertexBufferBound(16, 8));\n-\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 8, 2));\n+\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 8, 2, -1));\n \n \tunsigned short decoded[16 * 4];\n \tassert(meshopt_decodeVertexBuffer(decoded, 16, 8, &buffer[0], buffer.size()) == 0);\n@@ -637,7 +637,7 @@ static void decodeVertexBitXor()\n \t}\n \n \tstd::vector<unsigned char> buffer(meshopt_encodeVertexBufferBound(16, 16));\n-\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 16, 3));\n+\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 16, 3, -1));\n \n \tunsigned int decoded[16 * 4];\n \tassert(meshopt_decodeVertexBuffer(decoded, 16, 16, &buffer[0], buffer.size()) == 0);\ndiff --git a/tools/codectest.cpp b/tools/codectest.cpp\nindex 28203ecd4..04ba873b1 100644\n--- a/tools/codectest.cpp\n+++ b/tools/codectest.cpp\n@@ -91,7 +91,7 @@ void testFile(FILE* file, size_t count, size_t stride, int level, Stats* stats =\n \n \tstd::vector<unsigned char> output(meshopt_encodeVertexBufferBound(count, stride));\n \tmeshopt_encodeVertexVersion(1);\n-\toutput.resize(meshopt_encodeVertexBufferLevel(output.data(), output.size(), decoded.data(), count, stride, level));\n+\toutput.resize(meshopt_encodeVertexBufferLevel(output.data(), output.size(), decoded.data(), count, stride, level, -1));\n \n \tprintf(\" raw %zu KB\\t\", decoded.size() / 1024);\n \tprintf(\" v0 %.3f\", double(input.size()) / double(decoded.size()));\n", "problem_statement": "Pass vertex and index versions as arguments instead of having them as globals.\nHaving gEncodeVertexVersion and gEncodeIndexVersion as globals makes the meshoptimizer library difficult to use correctly in a multithreaded program, when some threads may be want to write with different versions.\n", "hints_text": "Could you elaborate on why you need to encode multiple versions in different threads? The assumption so far has been that the versions are either never changed or changed at the start of the program.\n\n(as to \"why not just add this\", due to binary compatibility requirements this can't be added as an argument to the existing `encode*Buffer` functions. It may be possible to expand `encodeVertexBufferLevel` with an extra version argument as it's still experimental, and add `encodeIndexBufferLevel` counterpart, and/or rename them somehow, but I was hoping to not have to do that)\nHi,\nIt's for backwards compatibility - for older clients connecting to my metaverse server, they will not have the code to decode vertex version 1.  So meshes need to be encoded for them with version 0.   But for newer clients that support version 1, I want to be able to encode meshes with version 1.\nHow long is that window of compatibility? As in is there a point where you will know for sure that all clients support version 1 and would be able to use it unconditionally?\nAnd, just to confirm, this is specifically for the vertex decoder?\n\nI understand the use case but want to make sure it's solved with least amount of new APIs that would have to be kept long term...\nThere's no specific window, just long enough that no one is likely to be using the old client any more.  maybe a year or so.\nAnd yeah it's just for the vertex version, I think I introduced meshopt encoded meshes after the index version was 1.\n\nEDIT: unlike a lot of computer games, I don't force clients to update to a specific version.\nAlright, thanks. I think it would make the most sense to preserve the global versioning by default but provide a way to override that for vertex encoder (index encoder currently does not need it in practice, and similar functions could be added there in the future if there's ever a v2 index codec). The existing meshopt_encodeVertexBufferLevel function could be changed to something like\n\n```c++\nMESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(\n    unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size,\n    int level, int version);\n```\n\n... with `version = -1` used to select the currently active global version, but values 0/1 (and other values in the future if there's ever a vertex codec v2) used to override that. `meshopt_encodeVertexBufferLevel` name is a little less clear with that change, maybe it should be changed (`-Ex`?), not sure - I'll think about alternatives. All of this is currently ok to change because `meshopt_encodeVertexBufferLevel` is experimental (and as such is subject to change). So in your case you'd need to switch to this function to be able to simultaneously encode multiple streams at different versions from multiple threads.", "created_at": "2025-04-30 00:49:56", "merge_commit_sha": "650bf41c6da93238ba30b3c4293f0599d0943d2f", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"], ["gltfpack", ".github/workflows/build.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-862", "base_commit": "ecebbd86269e283a9d8c7da20a22d9009b36310c", "patch": "diff --git a/README.md b/README.md\nindex 7cd858e43..d9d0488a9 100644\n--- a/README.md\n+++ b/README.md\n@@ -56,7 +56,8 @@ First, generate a remap table from your existing vertex (and, optionally, index)\n size_t index_count = face_count * 3;\n size_t unindexed_vertex_count = face_count * 3;\n std::vector<unsigned int> remap(unindexed_vertex_count); // temporary remap table\n-size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count, &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n+size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n ```\n \n Note that in this case we only have an unindexed vertex buffer; when input mesh has an index buffer, it will need to be passed to `meshopt_generateVertexRemap` instead of `NULL`, along with the correct source vertex count. In either case, the remap table is generated based on binary equivalence of the input vertices, so the resulting mesh will render the same way. Binary equivalence considers all input bytes, including padding which should be zero-initialized if the vertex structure has gaps.\n@@ -70,7 +71,18 @@ meshopt_remapVertexBuffer(vertices, &unindexed_vertices[0], unindexed_vertex_cou\n \n You can then further optimize the resulting buffers by calling the other functions on them in-place.\n \n-`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\n+`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use `meshopt_generateVertexRemapCustom` algorithm that allows comparing individual attributes with tolerance by providing a custom comparison function:\n+\n+```c++\n+size_t vertex_count = meshopt_generateVertexRemapCustom(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0].px, unindexed_vertex_count, sizeof(Vertex),\n+    [&](unsigned int lhs, unsigned int rhs) -> bool {\n+        const Vertex& lv = unindexed_vertices[lhs];\n+        const Vertex& rv = unindexed_vertices[rhs];\n+\n+        return fabsf(lv.tx - rv.tx) < 1e-3f && fabsf(lv.ty - rv.ty) < 1e-3f;\n+    });\n+```\n \n ## Vertex cache optimization\n \n@@ -573,6 +585,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_computeSphereBounds`*\n - `meshopt_encodeVertexBufferLevel`*\n - `meshopt_generateProvokingIndexBuffer`*\n+- `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\n - `meshopt_simplifySloppy`\n - `meshopt_spatialSortTriangles`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex 1e3e9ea2e..012a8524d 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -1287,6 +1287,44 @@ void provoking(const Mesh& mesh)\n \t    int(mesh.indices.size() / 3), int(pcount), double(pcount) / double(bestv) * 100.0 - 100.0, (end - start) * 1000);\n }\n \n+static int reindexCompare(void* context, unsigned int lhs, unsigned int rhs)\n+{\n+\tconst Vertex* vertices = static_cast<Vertex*>(context);\n+\tconst Vertex& lv = vertices[lhs];\n+\tconst Vertex& rv = vertices[rhs];\n+\n+\tfloat ln = lv.nx * lv.nx + lv.ny * lv.ny + lv.nz * lv.nz;\n+\tfloat rn = rv.nx * rv.nx + rv.ny * rv.ny + rv.nz * rv.nz;\n+\n+\t// 1/1024px UV tolerance, 3 degree normal tolerance\n+\treturn fabsf(lv.tx - rv.tx) < 1e-3f &&\n+\t       fabsf(lv.ty - rv.ty) < 1e-3f &&\n+\t       (lv.nx * rv.nx + lv.ny * rv.ny + lv.nz * rv.nz >= 0.9986f * sqrtf(ln * rn));\n+}\n+\n+void reindexFuzzy(const Mesh& mesh)\n+{\n+\tstd::vector<PackedVertex> pv(mesh.vertices.size());\n+\tpackMesh(pv, mesh.vertices);\n+\n+\tstd::vector<unsigned int> remap(mesh.vertices.size());\n+\n+\tdouble start = timestamp();\n+\n+\tsize_t up = meshopt_generateVertexRemap(&remap[0], &mesh.indices[0], mesh.indices.size(), &pv[0], mesh.vertices.size(), sizeof(PackedVertex));\n+\n+\tdouble middle = timestamp();\n+\n+\tsize_t uf = meshopt_generateVertexRemapCustom(&remap[0], &mesh.indices[0], mesh.indices.size(), &mesh.vertices[0].px, mesh.vertices.size(), sizeof(Vertex), reindexCompare, const_cast<Vertex*>(&mesh.vertices[0]));\n+\n+\tdouble end = timestamp();\n+\n+\tprintf(\"ReindexQ : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(up), (middle - start) * 1000);\n+\tprintf(\"ReindexF : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(uf), (end - middle) * 1000);\n+}\n+\n void nanite(const std::vector<Vertex>& vertices, const std::vector<unsigned int>& indices); // nanite.cpp\n \n bool loadMesh(Mesh& mesh, const char* path)\n@@ -1468,6 +1506,8 @@ void process(const char* path)\n \tspatialSort(mesh);\n \tspatialSortTriangles(mesh);\n \n+\treindexFuzzy(mesh);\n+\n \tif (path)\n \t\tprocessDeinterleaved(path);\n }\ndiff --git a/gltf/mesh.cpp b/gltf/mesh.cpp\nindex d5c744a59..bf231e32a 100644\n--- a/gltf/mesh.cpp\n+++ b/gltf/mesh.cpp\n@@ -66,6 +66,15 @@ static void transformNormal(float* res, const float* ptr, const float* transform\n \tres[2] = z * s;\n }\n \n+static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n+{\n+\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n+\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n+\t\t\treturn &mesh.streams[i];\n+\n+\treturn NULL;\n+}\n+\n // assumes mesh & target are structurally identical\n static void transformMesh(Mesh& target, const Mesh& mesh, const cgltf_node* node)\n {\n@@ -722,15 +731,6 @@ static void filterTriangles(Mesh& mesh)\n \tmesh.indices.resize(write);\n }\n \n-static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n-{\n-\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n-\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n-\t\t\treturn &mesh.streams[i];\n-\n-\treturn NULL;\n-}\n-\n static void simplifyAttributes(std::vector<float>& attrs, float* attrw, size_t stride, Mesh& mesh)\n {\n \tassert(stride >= 6); // normal + color\ndiff --git a/src/indexgenerator.cpp b/src/indexgenerator.cpp\nindex 0d53020e3..5f36d2463 100644\n--- a/src/indexgenerator.cpp\n+++ b/src/indexgenerator.cpp\n@@ -5,6 +5,7 @@\n #include <string.h>\n \n // This work is based on:\n+// Matthias Teschner, Bruno Heidelberger, Matthias Mueller, Danat Pomeranets, Markus Gross. Optimized Spatial Hashing for Collision Detection of Deformable Objects. 2003\n // John McDonald, Mark Kilgard. Crack-Free Point-Normal Triangles using Adjacent Edge Normals. 2010\n // John Hable. Variable Rate Shading with Visibility Buffer Rendering. 2024\n namespace meshopt\n@@ -86,6 +87,46 @@ struct VertexStreamHasher\n \t}\n };\n \n+struct VertexCustomHasher\n+{\n+\tconst float* vertex_positions;\n+\tsize_t vertex_stride_float;\n+\n+\tint (*callback)(void*, unsigned int, unsigned int);\n+\tvoid* context;\n+\n+\tsize_t hash(unsigned int index) const\n+\t{\n+\t\tconst unsigned int* key = reinterpret_cast<const unsigned int*>(vertex_positions + index * vertex_stride_float);\n+\n+\t\tunsigned int x = key[0], y = key[1], z = key[2];\n+\n+\t\t// replace negative zero with zero\n+\t\tx = (x == 0x80000000) ? 0 : x;\n+\t\ty = (y == 0x80000000) ? 0 : y;\n+\t\tz = (z == 0x80000000) ? 0 : z;\n+\n+\t\t// scramble bits to make sure that integer coordinates have entropy in lower bits\n+\t\tx ^= x >> 17;\n+\t\ty ^= y >> 17;\n+\t\tz ^= z >> 17;\n+\n+\t\t// Optimized Spatial Hashing for Collision Detection of Deformable Objects\n+\t\treturn (x * 73856093) ^ (y * 19349663) ^ (z * 83492791);\n+\t}\n+\n+\tbool equal(unsigned int lhs, unsigned int rhs) const\n+\t{\n+\t\tconst float* lp = vertex_positions + lhs * vertex_stride_float;\n+\t\tconst float* rp = vertex_positions + rhs * vertex_stride_float;\n+\n+\t\tif (lp[0] != rp[0] || lp[1] != rp[1] || lp[2] != rp[2])\n+\t\t\treturn false;\n+\n+\t\treturn callback ? callback(context, lhs, rhs) : true;\n+\t}\n+};\n+\n struct EdgeHasher\n {\n \tconst unsigned int* remap;\n@@ -183,6 +224,43 @@ static void buildPositionRemap(unsigned int* remap, const float* vertex_position\n \tallocator.deallocate(vertex_table);\n }\n \n+template <typename Hash>\n+static size_t generateVertexRemap(unsigned int* remap, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n+{\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n+\n+\tsize_t table_size = hashBuckets(vertex_count);\n+\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n+\tmemset(table, -1, table_size * sizeof(unsigned int));\n+\n+\tunsigned int next_vertex = 0;\n+\n+\tfor (size_t i = 0; i < index_count; ++i)\n+\t{\n+\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tassert(index < vertex_count);\n+\n+\t\tif (remap[index] != ~0u)\n+\t\t\tcontinue;\n+\n+\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n+\n+\t\tif (*entry == ~0u)\n+\t\t{\n+\t\t\t*entry = index;\n+\t\t\tremap[index] = next_vertex++;\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tassert(remap[*entry] != ~0u);\n+\t\t\tremap[index] = remap[*entry];\n+\t\t}\n+\t}\n+\n+\tassert(next_vertex <= vertex_count);\n+\treturn next_vertex;\n+}\n+\n template <size_t BlockSize>\n static void remapVertices(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n {\n@@ -197,55 +275,49 @@ static void remapVertices(void* destination, const void* vertices, size_t vertex\n \t\t}\n }\n \n-} // namespace meshopt\n-\n-size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+template <typename Hash>\n+static void generateShadowBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n {\n-\tusing namespace meshopt;\n-\n-\tassert(indices || index_count == vertex_count);\n-\tassert(!indices || index_count % 3 == 0);\n-\tassert(vertex_size > 0 && vertex_size <= 256);\n-\n-\tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n-\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n \n \tsize_t table_size = hashBuckets(vertex_count);\n \tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n \tmemset(table, -1, table_size * sizeof(unsigned int));\n \n-\tunsigned int next_vertex = 0;\n-\n \tfor (size_t i = 0; i < index_count; ++i)\n \t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tunsigned int index = indices[i];\n \t\tassert(index < vertex_count);\n \n-\t\tif (destination[index] == ~0u)\n+\t\tif (remap[index] == ~0u)\n \t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n+\t\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n \n \t\t\tif (*entry == ~0u)\n-\t\t\t{\n \t\t\t\t*entry = index;\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n-\n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n+\t\t\tremap[index] = *entry;\n \t\t}\n+\n+\t\tdestination[i] = remap[index];\n \t}\n+}\n \n-\tassert(next_vertex <= vertex_count);\n+} // namespace meshopt\n \n-\treturn next_vertex;\n+size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+{\n+\tusing namespace meshopt;\n+\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_size > 0 && vertex_size <= 256);\n+\n+\tmeshopt_Allocator allocator;\n+\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -263,44 +335,24 @@ size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigne\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tunsigned int next_vertex = 0;\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (destination[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t{\n-\t\t\t\t*entry = index;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n+}\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n+size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context)\n+{\n+\tusing namespace meshopt;\n \n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n-\t\t}\n-\t}\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_positions_stride >= 12 && vertex_positions_stride <= 256);\n+\tassert(vertex_positions_stride % sizeof(float) == 0);\n \n-\tassert(next_vertex <= vertex_count);\n+\tmeshopt_Allocator allocator;\n+\tVertexCustomHasher hasher = {vertex_positions, vertex_positions_stride / sizeof(float), callback, context};\n \n-\treturn next_vertex;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_remapVertexBuffer(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n@@ -362,33 +414,9 @@ void meshopt_generateShadowIndexBuffer(unsigned int* destination, const unsigned\n \tassert(vertex_size <= vertex_stride);\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_stride};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -406,33 +434,9 @@ void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const uns\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateAdjacencyIndexBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride)\ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 295324c78..54320c178 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -74,6 +74,19 @@ MESHOPTIMIZER_API size_t meshopt_generateVertexRemap(unsigned int* destination,\n  */\n MESHOPTIMIZER_API size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count);\n \n+/**\n+ * Experimental: Generates a vertex remap table from the vertex buffer and an optional index buffer and returns number of unique vertices\n+ * As a result, all vertices that are equivalent map to the same (new) location, with no gaps in the resulting sequence.\n+ * Equivalence is checked in two steps: vertex positions are compared for equality, and then the user-specified equality function is called (if provided).\n+ * Resulting remap table maps old vertices to new vertices and can be used in meshopt_remapVertexBuffer/meshopt_remapIndexBuffer.\n+ *\n+ * destination must contain enough space for the resulting remap table (vertex_count elements)\n+ * indices can be NULL if the input is unindexed\n+ * vertex_positions should have float3 position in the first 12 bytes of each vertex\n+ * callback can be NULL if no additional equality check is needed; otherwise, it should return 1 if vertices with specified indices are equivalent and 0 if they are not\n+ */\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context);\n+\n /**\n  * Generates vertex buffer from the source vertex buffer and remap table generated by meshopt_generateVertexRemap\n  *\n@@ -722,6 +735,8 @@ template <typename T>\n inline size_t meshopt_generateVertexRemap(unsigned int* destination, const T* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size);\n template <typename T>\n inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const T* indices, size_t index_count, size_t vertex_count, const meshopt_Stream* streams, size_t stream_count);\n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback);\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap);\n template <typename T>\n@@ -930,6 +945,19 @@ inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const\n \treturn meshopt_generateVertexRemapMulti(destination, indices ? in.data : NULL, index_count, vertex_count, streams, stream_count);\n }\n \n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback)\n+{\n+\tstruct Call\n+\t{\n+\t\tstatic int compare(void* context, unsigned int lhs, unsigned int rhs) { return (*static_cast<F*>(context))(lhs, rhs) ? 1 : 0; }\n+\t};\n+\n+\tmeshopt_IndexAdapter<T> in(NULL, indices, indices ? index_count : 0);\n+\n+\treturn meshopt_generateVertexRemapCustom(destination, indices ? in.data : NULL, index_count, vertex_positions, vertex_count, vertex_positions_stride, &Call::compare, &callback);\n+}\n+\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap)\n {\n", "test_patch": "diff --git a/demo/tests.cpp b/demo/tests.cpp\nindex 85f6c146d..0d1ee3908 100644\n--- a/demo/tests.cpp\n+++ b/demo/tests.cpp\n@@ -1354,6 +1354,50 @@ static void partitionBasic()\n \tassert(part[0] == 0 && part[1] == 0 && part[2] == 0 && part[3] == 0);\n }\n \n+static int remapCustomFalse(void*, unsigned int, unsigned int)\n+{\n+\treturn 0;\n+}\n+\n+static int remapCustomTrue(void*, unsigned int, unsigned int)\n+{\n+\treturn 1;\n+}\n+\n+static void remapCustom()\n+{\n+\tconst float vb[] = {\n+\t    0, 0, 0,\n+\t    1, 0, 0,\n+\t    0, 1, 0,\n+\t    0, 0, 1,\n+\t    1, 0, 0,\n+\t    0, -0.f, 1, // clang-format\n+\t};\n+\n+\tunsigned int remap[6];\n+\tsize_t res;\n+\n+\tres = meshopt_generateVertexRemapCustom(remap, NULL, 6, vb, 6, sizeof(float) * 3, NULL, NULL);\n+\tassert(res == 4);\n+\tfor (int i = 0; i < 4; ++i)\n+\t\tassert(remap[i] == unsigned(i));\n+\tassert(remap[4] == 1);\n+\tassert(remap[5] == 3);\n+\n+\tres = meshopt_generateVertexRemapCustom(remap, NULL, 6, vb, 6, sizeof(float) * 3, remapCustomTrue, NULL);\n+\tassert(res == 4);\n+\tfor (int i = 0; i < 4; ++i)\n+\t\tassert(remap[i] == unsigned(i));\n+\tassert(remap[4] == 1);\n+\tassert(remap[5] == 3);\n+\n+\tres = meshopt_generateVertexRemapCustom(remap, NULL, 6, vb, 6, sizeof(float) * 3, remapCustomFalse, NULL);\n+\tassert(res == 6);\n+\tfor (int i = 0; i < 6; ++i)\n+\t\tassert(remap[i] == unsigned(i));\n+}\n+\n static size_t allocCount;\n static size_t freeCount;\n \n@@ -2424,6 +2468,8 @@ void runTests()\n \n \tpartitionBasic();\n \n+\tremapCustom();\n+\n \tcustomAllocator();\n \n \temptyMesh();\n", "problem_statement": "Vertex remapping/reindexing with approximate equality\nAs the README states,\r\n> meshopt_generateVertexRemap uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\r\n\r\nSince rolling a custom version of the algorithm for a single-line change also comes with a maintenance cost, would it be possible to provide a variant of the algorithm that allows the specification of custom distance functions?\r\n\r\nFor instance by extending the `meshopt_Stream` struct or by passing a function pointer to the signature, which then gets the stream and element?\n", "hints_text": "Yeah I plan to add support for tolerance based remapping eventually. It would be helpful to have a generic algorithm for this use case.\r\n\r\nThis is not a single-line change, and exposing a callback isn't quite enough; this requires a different algorithm, and perhaps an interface where the implementation has direct access to floating point values (or not; for normals it might be better to compare the dot product for example).", "created_at": "2025-03-26 01:57:49", "merge_commit_sha": "bcce37fb9a420aed3a8efe2f7e1d3c9d67848637", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"], ["gltfpack", ".github/workflows/build.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-709", "base_commit": "b092eee9823cbc38ec8dd6107ff1dedcd3ac9bfa", "patch": "diff --git a/extern/cgltf.h b/extern/cgltf.h\nindex ac392aba4..36fd644e1 100644\n--- a/extern/cgltf.h\n+++ b/extern/cgltf.h\n@@ -395,6 +395,8 @@ typedef struct cgltf_texture\n \tcgltf_sampler* sampler;\n \tcgltf_bool has_basisu;\n \tcgltf_image* basisu_image;\n+\tcgltf_bool has_webp;\n+\tcgltf_image* webp_image;\n \tcgltf_extras extras;\n \tcgltf_size extensions_count;\n \tcgltf_extension* extensions;\n@@ -4551,6 +4553,34 @@ static int cgltf_parse_json_texture(cgltf_options* options, jsmntok_t const* tok\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\telse if (cgltf_json_strcmp(tokens + i, json_chunk, \"EXT_texture_webp\") == 0)\n+\t\t\t\t{\n+\t\t\t\t\tout_texture->has_webp = 1;\n+\t\t\t\t\t++i;\n+\t\t\t\t\tCGLTF_CHECK_TOKTYPE(tokens[i], JSMN_OBJECT);\n+\t\t\t\t\tint num_properties = tokens[i].size;\n+\t\t\t\t\t++i;\n+\n+\t\t\t\t\tfor (int t = 0; t < num_properties; ++t)\n+\t\t\t\t\t{\n+\t\t\t\t\t\tCGLTF_CHECK_KEY(tokens[i]);\n+\n+\t\t\t\t\t\tif (cgltf_json_strcmp(tokens + i, json_chunk, \"source\") == 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t\tout_texture->webp_image = CGLTF_PTRINDEX(cgltf_image, cgltf_json_to_int(tokens + i, json_chunk));\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\ti = cgltf_skip_json(tokens, i + 1);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tif (i < 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\treturn i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t\telse\n \t\t\t\t{\n \t\t\t\t\ti = cgltf_parse_json_unprocessed_extension(options, tokens, i, json_chunk, &(out_texture->extensions[out_texture->extensions_count++]));\n@@ -6561,6 +6591,7 @@ static int cgltf_fixup_pointers(cgltf_data* data)\n \t{\n \t\tCGLTF_PTRFIXUP(data->textures[i].image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].basisu_image, data->images, data->images_count);\n+\t\tCGLTF_PTRFIXUP(data->textures[i].webp_image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].sampler, data->samplers, data->samplers_count);\n \t}\n \ndiff --git a/gltf/README.md b/gltf/README.md\nindex ffe6d1e12..4b278676a 100644\n--- a/gltf/README.md\n+++ b/gltf/README.md\n@@ -85,6 +85,7 @@ gltfpack supports most Khronos extensions and some multi-vendor extensions in th\n - KHR_texture_transform\n - EXT_mesh_gpu_instancing\n - EXT_meshopt_compression\n+- EXT_texture_webp\n \n Even if the source file does not use extensions, gltfpack may use some extensions in the output file either by default or when certain options are used:\n \ndiff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex f3156d3e3..ee46fa6a7 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -454,6 +454,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \tbool ext_instancing = false;\n \tbool ext_texture_transform = false;\n \tbool ext_texture_basisu = false;\n+\tbool ext_texture_webp = false;\n \n \tsize_t accr_offset = 0;\n \tsize_t node_offset = 0;\n@@ -512,6 +513,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\tassert(textures[i].remap == int(texture_offset));\n \t\ttexture_offset++;\n \t\text_texture_basisu = ext_texture_basisu || texture.has_basisu;\n+\t\text_texture_webp = ext_texture_webp || texture.has_webp;\n \t}\n \n \tfor (size_t i = 0; i < data->materials_count; ++i)\n@@ -838,6 +840,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t    {\"KHR_materials_variants\", data->variants_count > 0, false},\n \t    {\"KHR_lights_punctual\", data->lights_count > 0, false},\n \t    {\"KHR_texture_basisu\", (!json_textures.empty() && settings.texture_ktx2) || ext_texture_basisu, true},\n+\t    {\"EXT_texture_webp\", ext_texture_webp, true},\n \t    {\"EXT_mesh_gpu_instancing\", ext_instancing, true},\n \t};\n \ndiff --git a/gltf/image.cpp b/gltf/image.cpp\nindex 129938a0e..972b4c441 100644\n--- a/gltf/image.cpp\n+++ b/gltf/image.cpp\n@@ -8,6 +8,7 @@ static const char* kMimeTypes[][2] = {\n     {\"image/jpeg\", \".jpeg\"},\n     {\"image/png\", \".png\"},\n     {\"image/ktx2\", \".ktx2\"},\n+    {\"image/webp\", \".webp\"},\n };\n \n static const char* inferMimeType(const char* path)\n@@ -128,6 +129,7 @@ static int readInt32LE(const std::string& data, size_t offset)\n \t       (unsigned((unsigned char)data[offset + 3]) << 24);\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool getDimensionsPng(const std::string& data, int& width, int& height)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -146,6 +148,7 @@ static bool getDimensionsPng(const std::string& data, int& width, int& height)\n \treturn true;\n }\n \n+// https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format#File_format_structure\n static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n {\n \tsize_t offset = 0;\n@@ -189,6 +192,7 @@ static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n \treturn false;\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool hasTransparencyPng(const std::string& data)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -224,6 +228,7 @@ static bool hasTransparencyPng(const std::string& data)\n \treturn false;\n }\n \n+// https://github.khronos.org/KTX-Specification/ktxspec.v2.html\n static bool hasTransparencyKtx2(const std::string& data)\n {\n \tif (data.size() < 12 + 17 * 4)\n@@ -261,12 +266,45 @@ static bool hasTransparencyKtx2(const std::string& data)\n \treturn false;\n }\n \n+// https://developers.google.com/speed/webp/docs/riff_container\n+static bool hasTransparencyWebP(const std::string& data)\n+{\n+\tif (data.size() < 12 + 4 + 12)\n+\t\treturn false;\n+\n+\tif (data.compare(0, 4, \"RIFF\") != 0)\n+\t\treturn false;\n+\tif (data.compare(8, 4, \"WEBP\") != 0)\n+\t\treturn false;\n+\n+\t// WebP data may use VP8L, VP8X or VP8 format, but VP8 does not support transparency\n+\tif (data.compare(12, 4, \"VP8L\") == 0)\n+\t{\n+\t\tif (unsigned(data[20]) != 0x2f)\n+\t\t\treturn false;\n+\n+\t\t// width (14) | height (14) | alpha_is_used (1) | version_number(3)\n+\t\tunsigned int header = readInt32LE(data, 21);\n+\t\treturn (header & (1 << 28)) != 0;\n+\t}\n+\telse if (data.compare(12, 4, \"VP8X\") == 0)\n+\t{\n+\t\t// zero (2) | icc (1) | alpha (1) | exif (1) | xmp (1) | animation (1) | zero (1)\n+\t\tunsigned char header = data[20];\n+\t\treturn (header & (1 << 4)) != 0;\n+\t}\n+\n+\treturn false;\n+}\n+\n bool hasAlpha(const std::string& data, const char* mime_type)\n {\n \tif (strcmp(mime_type, \"image/png\") == 0)\n \t\treturn hasTransparencyPng(data);\n \telse if (strcmp(mime_type, \"image/ktx2\") == 0)\n \t\treturn hasTransparencyKtx2(data);\n+\telse if (strcmp(mime_type, \"image/webp\") == 0)\n+\t\treturn hasTransparencyWebP(data);\n \telse\n \t\treturn false;\n }\ndiff --git a/gltf/material.cpp b/gltf/material.cpp\nindex 0931b2e05..68d5610c8 100644\n--- a/gltf/material.cpp\n+++ b/gltf/material.cpp\n@@ -11,10 +11,10 @@ static bool areTexturesEqual(const cgltf_texture& lhs, const cgltf_texture& rhs)\n \tif (lhs.sampler != rhs.sampler)\n \t\treturn false;\n \n-\tif (lhs.has_basisu != rhs.has_basisu)\n+\tif (lhs.basisu_image != rhs.basisu_image)\n \t\treturn false;\n \n-\tif (lhs.basisu_image != rhs.basisu_image)\n+\tif (lhs.webp_image != rhs.webp_image)\n \t\treturn false;\n \n \treturn true;\n@@ -446,9 +446,12 @@ static const cgltf_image* getTextureImage(const cgltf_texture* texture)\n \tif (texture && texture->image)\n \t\treturn texture->image;\n \n-\tif (texture && texture->has_basisu && texture->basisu_image)\n+\tif (texture && texture->basisu_image)\n \t\treturn texture->basisu_image;\n \n+\tif (texture && texture->webp_image)\n+\t\treturn texture->webp_image;\n+\n \treturn NULL;\n }\n \ndiff --git a/gltf/write.cpp b/gltf/write.cpp\nindex 13f2f3ad5..429d0c446 100644\n--- a/gltf/write.cpp\n+++ b/gltf/write.cpp\n@@ -975,13 +975,20 @@ void writeTexture(std::string& json, const cgltf_texture& texture, const ImageIn\n \t\t}\n \t}\n \n-\tif (texture.has_basisu && texture.basisu_image)\n+\tif (texture.basisu_image)\n \t{\n \t\tcomma(json);\n \t\tappend(json, \"\\\"extensions\\\":{\\\"KHR_texture_basisu\\\":{\\\"source\\\":\");\n \t\tappend(json, size_t(texture.basisu_image - data->images));\n \t\tappend(json, \"}}\");\n \t}\n+\telse if (texture.webp_image)\n+\t{\n+\t\tcomma(json);\n+\t\tappend(json, \"\\\"extensions\\\":{\\\"EXT_texture_webp\\\":{\\\"source\\\":\");\n+\t\tappend(json, size_t(texture.webp_image - data->images));\n+\t\tappend(json, \"}}\");\n+\t}\n }\n \n void writeMeshAttributes(std::string& json, std::vector<BufferView>& views, std::string& json_accessors, size_t& accr_offset, const Mesh& mesh, int target, const QuantizationPosition& qp, const QuantizationTexture& qt, const Settings& settings)\n", "test_patch": "", "problem_statement": "gltfpack: EXT_texture_webp support\nSpec [here](https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Vendor/EXT_texture_webp).\r\n\r\nModel before:\r\n[webp_demo.zip](https://github.com/zeux/meshoptimizer/files/10695236/webp_demo.zip)\r\n```json\r\n{\r\n\"textures\":[{\"sampler\":0,\"extensions\":{\"EXT_texture_webp\":{\"source\":0}}}],\r\n\"extensionsUsed\":[\"EXT_texture_webp\"],\"extensionsRequired\":[\"EXT_texture_webp\"]\r\n}\r\n```\r\nModel after:\r\n[webp_demo_gltfpack.zip](https://github.com/zeux/meshoptimizer/files/10695237/webp_demo_gltfpack.zip)\r\n```json\r\n{\r\n\"extensionsUsed\":[\"KHR_mesh_quantization\",\"KHR_texture_transform\"],\"extensionsRequired\":[\"KHR_mesh_quantization\"],\r\n\"textures\":[{}]\r\n}\r\n```\n", "hints_text": "A similar thing is the proposal of [EXT_texture_avif](https://github.com/KhronosGroup/glTF/pull/2235). Or maybe gltfpack can just keep all unknown extensions of texture for maximum compatibility.\nThis requires https://github.com/jkuhlmann/cgltf/issues/248; I'm not very interested in implementing this myself and gltfpack can't encode webp images without external dependencies anyway so the best it can do here is to preserve inputs as is, but if the linked issue gets implemented I can take a look at this.\r\n\r\nKeeping unknown extensions doesn't work because image files need to be parsed for material transparency optimization.", "created_at": "2024-06-22 23:34:01", "merge_commit_sha": "fbc9f5498c33d537fbc3d853d643dd9acadbcf94", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-696", "base_commit": "97e57ad2628bf04adf8f0d0291f2387d4c08578a", "patch": "diff --git a/extern/cgltf.h b/extern/cgltf.h\nindex 17dc0ca5d..ac392aba4 100644\n--- a/extern/cgltf.h\n+++ b/extern/cgltf.h\n@@ -1697,7 +1697,20 @@ cgltf_result cgltf_validate(cgltf_data* data)\n \t{\n \t\tif (data->nodes[i].weights && data->nodes[i].mesh)\n \t\t{\n-\t\t\tCGLTF_ASSERT_IF (data->nodes[i].mesh->primitives_count && data->nodes[i].mesh->primitives[0].targets_count != data->nodes[i].weights_count, cgltf_result_invalid_gltf);\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh->primitives_count && data->nodes[i].mesh->primitives[0].targets_count != data->nodes[i].weights_count, cgltf_result_invalid_gltf);\n+\t\t}\n+\n+\t\tif (data->nodes[i].has_mesh_gpu_instancing)\n+\t\t{\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh == NULL, cgltf_result_invalid_gltf);\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh_gpu_instancing.attributes_count == 0, cgltf_result_invalid_gltf);\n+\n+\t\t\tcgltf_accessor* first = data->nodes[i].mesh_gpu_instancing.attributes[0].data;\n+\n+\t\t\tfor (cgltf_size k = 0; k < data->nodes[i].mesh_gpu_instancing.attributes_count; ++k)\n+\t\t\t{\n+\t\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh_gpu_instancing.attributes[k].data->count != first->count, cgltf_result_invalid_gltf);\n+\t\t\t}\n \t\t}\n \t}\n \ndiff --git a/gltf/README.md b/gltf/README.md\nindex a6be16405..ffe6d1e12 100644\n--- a/gltf/README.md\n+++ b/gltf/README.md\n@@ -83,6 +83,7 @@ gltfpack supports most Khronos extensions and some multi-vendor extensions in th\n - KHR_mesh_quantization\n - KHR_texture_basisu\n - KHR_texture_transform\n+- EXT_mesh_gpu_instancing\n - EXT_meshopt_compression\n \n Even if the source file does not use extensions, gltfpack may use some extensions in the output file either by default or when certain options are used:\ndiff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex 2db6eff77..dee7a930a 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -281,7 +281,10 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \tfor (size_t i = 0; i < meshes.size(); ++i)\n \t{\n \t\tMesh& mesh = meshes[i];\n-\t\tassert(mesh.instances.empty());\n+\n+\t\t// mesh is already instanced, skip\n+\t\tif (!mesh.instances.empty())\n+\t\t\tcontinue;\n \n \t\t// mesh is already world space, skip\n \t\tif (mesh.nodes.empty())\n@@ -664,9 +667,6 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \n \t\tappend(json_meshes, \"}\");\n \n-\t\tassert(mesh.nodes.empty() || mesh.instances.empty());\n-\t\text_instancing = ext_instancing || !mesh.instances.empty();\n-\n \t\tif (mesh.nodes.size())\n \t\t{\n \t\t\tfor (size_t j = 0; j < mesh.nodes.size(); ++j)\n@@ -691,7 +691,8 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-\t\telse if (mesh.instances.size())\n+\n+\t\tif (mesh.instances.size())\n \t\t{\n \t\t\tassert(mesh.scene >= 0);\n \t\t\tcomma(json_roots[mesh.scene]);\n@@ -704,7 +705,8 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \n \t\t\tnode_offset++;\n \t\t}\n-\t\telse\n+\n+\t\tif (mesh.nodes.empty() && mesh.instances.empty())\n \t\t{\n \t\t\tassert(mesh.scene >= 0);\n \t\t\tcomma(json_roots[mesh.scene]);\n@@ -716,6 +718,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\t}\n \n \t\tmesh_offset++;\n+\t\text_instancing = ext_instancing || !mesh.instances.empty();\n \n \t\t// skip all meshes that we've written in this iteration\n \t\tassert(pi > i);\ndiff --git a/gltf/parsegltf.cpp b/gltf/parsegltf.cpp\nindex 91f0c020f..f83356b70 100644\n--- a/gltf/parsegltf.cpp\n+++ b/gltf/parsegltf.cpp\n@@ -275,6 +275,54 @@ static void parseMeshesGltf(cgltf_data* data, std::vector<Mesh>& meshes, std::ve\n \t}\n }\n \n+static void parseMeshInstancesGltf(std::vector<Transform>& instances, cgltf_node* node)\n+{\n+\tcgltf_accessor* translation = NULL;\n+\tcgltf_accessor* rotation = NULL;\n+\tcgltf_accessor* scale = NULL;\n+\n+\tfor (size_t i = 0; i < node->mesh_gpu_instancing.attributes_count; ++i)\n+\t{\n+\t\tcgltf_attribute& attr = node->mesh_gpu_instancing.attributes[i];\n+\n+\t\tif (strcmp(attr.name, \"TRANSLATION\") == 0 && attr.data->type == cgltf_type_vec3)\n+\t\t\ttranslation = attr.data;\n+\t\telse if (strcmp(attr.name, \"ROTATION\") == 0 && attr.data->type == cgltf_type_vec4)\n+\t\t\trotation = attr.data;\n+\t\telse if (strcmp(attr.name, \"SCALE\") == 0 && attr.data->type == cgltf_type_vec3)\n+\t\t\tscale = attr.data;\n+\t}\n+\n+\tsize_t count = node->mesh_gpu_instancing.attributes[0].data->count;\n+\n+\tinstances.reserve(instances.size() + count);\n+\n+\tcgltf_node instance = {};\n+\tinstance.parent = node;\n+\tinstance.has_translation = translation != NULL;\n+\tinstance.has_rotation = rotation != NULL;\n+\tinstance.has_scale = scale != NULL;\n+\tinstance.rotation[3] = 1.f;\n+\tinstance.scale[0] = 1.f;\n+\tinstance.scale[1] = 1.f;\n+\tinstance.scale[2] = 1.f;\n+\n+\tfor (size_t i = 0; i < count; ++i)\n+\t{\n+\t\tif (translation)\n+\t\t\tcgltf_accessor_read_float(translation, i, instance.translation, sizeof(float));\n+\t\tif (rotation)\n+\t\t\tcgltf_accessor_read_float(rotation, i, instance.rotation, sizeof(float));\n+\t\tif (scale)\n+\t\t\tcgltf_accessor_read_float(scale, i, instance.scale, sizeof(float));\n+\n+\t\tTransform xf;\n+\t\tcgltf_node_transform_world(&instance, xf.data);\n+\n+\t\tinstances.push_back(xf);\n+\t}\n+}\n+\n static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, const std::vector<std::pair<size_t, size_t> >& mesh_remap)\n {\n \tfor (size_t i = 0; i < data->nodes_count; ++i)\n@@ -289,7 +337,7 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\t{\n \t\t\tMesh* mesh = &meshes[mi];\n \n-\t\t\tif (!mesh->nodes.empty() && mesh->skin != node.skin)\n+\t\t\tif (mesh->skin != node.skin && (!mesh->nodes.empty() || !mesh->instances.empty()))\n \t\t\t{\n \t\t\t\t// this should be extremely rare - if the same mesh is used with different skins, we need to duplicate it\n \t\t\t\t// in this case we don't spend any effort on keeping the number of duplicates to the minimum, because this\n@@ -298,8 +346,16 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\t\t\tmesh = &meshes.back();\n \t\t\t}\n \n-\t\t\tmesh->nodes.push_back(&node);\n-\t\t\tmesh->skin = node.skin;\n+\t\t\tif (node.has_mesh_gpu_instancing)\n+\t\t\t{\n+\t\t\t\tmesh->scene = 0; // we need to assign scene index since instances are attached to a scene; for now we assume 0\n+\t\t\t\tparseMeshInstancesGltf(mesh->instances, &node);\n+\t\t\t}\n+\t\t\telse\n+\t\t\t{\n+\t\t\t\tmesh->skin = node.skin;\n+\t\t\t\tmesh->nodes.push_back(&node);\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -308,7 +364,7 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\tMesh& mesh = meshes[i];\n \n \t\t// because the rest of gltfpack assumes that empty nodes array = world-space mesh, we need to filter unused meshes\n-\t\tif (mesh.nodes.empty())\n+\t\tif (mesh.nodes.empty() && mesh.instances.empty())\n \t\t{\n \t\t\tmesh.streams.clear();\n \t\t\tmesh.indices.clear();\n@@ -530,8 +586,6 @@ static cgltf_data* parseGltf(cgltf_data* data, cgltf_result result, std::vector<\n \t\t*error = getError(result, data);\n \telse if (requiresExtension(data, \"KHR_draco_mesh_compression\"))\n \t\t*error = \"file requires Draco mesh compression support\";\n-\telse if (requiresExtension(data, \"EXT_mesh_gpu_instancing\"))\n-\t\t*error = \"file requires mesh instancing support\";\n \telse if (needsDummyBuffers(data))\n \t\t*error = \"buffer has no data\";\n \n@@ -543,6 +597,8 @@ static cgltf_data* parseGltf(cgltf_data* data, cgltf_result result, std::vector<\n \n \tif (requiresExtension(data, \"KHR_mesh_quantization\"))\n \t\tfprintf(stderr, \"Warning: file uses quantized geometry; repacking may result in increased quantization error\\n\");\n+\tif (requiresExtension(data, \"EXT_mesh_gpu_instancing\") && data->scenes_count > 1)\n+\t\tfprintf(stderr, \"Warning: file uses instancing and has more than one scene; results may be incorrect\\n\");\n \n \tstd::vector<std::pair<size_t, size_t> > mesh_remap;\n \n", "test_patch": "", "problem_statement": "gltfpack: Keep `EXT_mesh_gpu_instancing`\n### Discussed in https://github.com/zeux/meshoptimizer/discussions/680\r\n\r\n<div type='discussions-op-text'>\r\n\r\n<sup>Originally posted by **BoyBaykiller** April 22, 2024</sup>\r\nI am running `gltfpack -v -mi -noq -tc -i .\\SimpleInstancing.gltf -o .\\Compressed\\Output.gltf` over [this](https://github.com/KhronosGroup/glTF-Sample-Models/tree/main/2.0/SimpleInstancing/glTF) gltf model.\r\nIt uses the EXT_mesh_gpu_instancing extension to define a bunch of instanced cubes. I can render it correctly as it, but after running it through the command the EXT_mesh_gpu_instancing extension is removed, resulting in only a single cube being rendered.</div>\n", "hints_text": "", "created_at": "2024-05-26 22:16:14", "merge_commit_sha": "a4f2b370fd07a0f642f7ef53f70222b612e89acc", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"]]}
{"repo": "pixie-io/pixie", "instance_id": "pixie-io__pixie-2032", "base_commit": "5292f5858e3cb25895a66bdcc00717d50919940d", "patch": "diff --git a/src/utils/shared/k8s/delete.go b/src/utils/shared/k8s/delete.go\nindex 046b6cde570..c9728f78c32 100644\n--- a/src/utils/shared/k8s/delete.go\n+++ b/src/utils/shared/k8s/delete.go\n@@ -185,6 +185,13 @@ func (o *ObjectDeleter) runDelete(r *resource.Result) (int, error) {\n \t\tif err != nil {\n \t\t\treturn err\n \t\t}\n+\t\t// In newer versions of k8s, the resource name can be empty. This causes\n+\t\t// the delete to fail since it can't watch for the resource. See\n+\t\t// https://github.com/pixie-io/pixie/issues/2029 for more details.\n+\t\tif info.Name == \"\" {\n+\t\t\tlog.Debugf(\"Skipping resource with empty name: %+v\\n\", info)\n+\t\t\treturn nil\n+\t\t}\n \t\tdeletedInfos = append(deletedInfos, info)\n \t\tfound++\n \n", "test_patch": "", "problem_statement": "`px delete` fails on recent K8s versions (1.30)\n**Describe the bug**\r\nRunning `px delete` against a recent K8s version (1.30) fails with the following error:\r\n\r\n```\r\n$ px delete --namespace testing\r\nPixie CLI\r\nThis action will delete the entire 'testing' namespace.\r\nConfirm to proceed on cluster gke_csmc-dev_us-west1-a_dev-cluster-ddelnano1. (y/n) [y] : y\r\n \u2714    Deleting namespace\r\n \u2715    Deleting cluster-scoped resources  ERR: resource name may not be empty\r\nError deleting Pixie error=resource name may not be empty\r\n```\r\n\r\nRunning against a 1.27 version cluster (1.27.16-gke.1342000) results in the correct behavior.\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Deploy pixie to a k8s cluster (`px deploy`)\r\n2. Attempt to delete it with `px delete`\r\n\r\nThis is also reproducible without when deleting non vizier resources since it's a bug with our handling of k8s API server calls\r\n1. Create any following ConfigMap\r\n```\r\n$ kubectl create namespace testing\r\n# sample_map.yaml\r\n---\r\napiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: pl-indexer-config\r\n  labels:\r\n    component: vizier\r\ndata:\r\n  PL_MD_INDEX_REPLICAS: \"1\"\r\n\r\n$ kubectl apply -n testing -f k8s/cloud/dev/indexer_config.yaml\r\n```\r\n2. Attempt to delete the `testing` namespace\r\n```\r\n$ px delete --namespace testing\r\n```\r\n\r\n**Expected behavior**\r\nNamespace and the resources with the `component=vizier` labels should be removed\r\n\r\n\r\n**App information (please complete the following information):**\r\n- Pixie version: 0.14.11\r\n- Pixie cli: 0.8.2 and 0.8.3\r\n- K8s cluster version: 1.30.3-gke.1639000\r\n\n", "hints_text": "", "created_at": "2024-09-24 17:20:58", "merge_commit_sha": "7a468a416fa6fc5762460ad844a9ed06ed80d0f0", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["testlogs-Go race detector tests", ".github/workflows/trivy_fs.yaml"], ["get-image", ".github/workflows/pr_genfiles.yml"], ["dependency-review", ".github/workflows/pr_3p_deps.yaml"], ["build-and-test-status", ".github/workflows/build_and_test.yaml"], ["get-image", ".github/workflows/build_and_test.yaml"], ["code-scan", ".github/workflows/trivy_fs.yaml"], ["authorize", ".github/workflows/build_and_test.yaml"], ["lint-pr-description", ".github/workflows/pr_description_linter.yaml"], ["check-files-changed", ".github/workflows/filename_linter.yaml"], ["build-and-test (Go race detector, nokvm, --config=go_race --compilation_mode=opt, bazel_buildable...", ".github/workflows/build_and_test.yaml"]]}
{"repo": "swig/swig", "instance_id": "swig__swig-3159", "base_commit": "4167b0275adc574f86914e42fb5ef9639b2b25a5", "patch": "diff --git a/.github/workflows/linux.yml b/.github/workflows/linux.yml\nindex 02aa3f0681..a7e8f84d96 100644\n--- a/.github/workflows/linux.yml\n+++ b/.github/workflows/linux.yml\n@@ -132,6 +132,9 @@ jobs:\n         - SWIGLANG: python\n           VER: '3.13t' # no-gil testing\n           CSTD: gnu99\n+        - SWIGLANG: python\n+          VER: '3.14'\n+          CSTD: gnu99\n         - SWIGLANG: python\n           PY2: 2\n           SWIG_FEATURES: -builtin\ndiff --git a/Doc/Manual/Python.html b/Doc/Manual/Python.html\nindex 23587e5dbc..01fc449a68 100644\n--- a/Doc/Manual/Python.html\n+++ b/Doc/Manual/Python.html\n@@ -6552,7 +6552,7 @@ <H4><a name=\"Python_package_search_both_package_modules\">33.11.6.1 Both modules\n \n <p>\n In this configuration, the pure Python module, foo.py, tries to load the C/C++ module, _foo, from the same package foo.py is\n-located in.  The package name is determined from the <tt>__package__</tt>\n+located in.  The package name is determined from the <tt>__spec__.parent</tt> (or <tt>__package__</tt> before Python 3.4)\n attribute if available, see <a href=\"https://www.python.org/dev/peps/pep-0366/\">PEP 366</a>. Otherwise it is derived from the <tt>__name__</tt>\n attribute given to foo.py by the Python loader that imported foo.py.\n The interface file for this configuration would contain:\n@@ -6675,7 +6675,7 @@ <H4><a name=\"Python_custom_module_import\">33.11.6.4 More on customizing the modu\n \n <div class=\"targetlang\">\n <pre>\n-if __package__ or '.' in __name__:\n+if getattr(__spec__, \"parent\", None) or '.' in __name__:\n     from . import _foo\n else:\n     import _foo\n@@ -6760,7 +6760,7 @@ <H4><a name=\"Python_custom_module_import\">33.11.6.4 More on customizing the modu\n \n <div class=\"targetlang\">\n <pre>\n-if __package__ or '.' in __name__:\n+if getattr(__spec__, \"parent\", None) or '.' in __name__:\n     from ._foo import *\n else:\n     from _foo import *\ndiff --git a/Source/Modules/python.cxx b/Source/Modules/python.cxx\nindex 86daf131c8..3070a94fac 100644\n--- a/Source/Modules/python.cxx\n+++ b/Source/Modules/python.cxx\n@@ -703,20 +703,22 @@ class PYTHON:public Language {\n \t * onwards (implicit relative imports raised a DeprecationWarning in 2.6,\n \t * and fail in 2.7 onwards).\n \t *\n-\t * First check for __package__ which is available from 2.6 onwards, see PEP366.\n+\t * First check for __spec__.parent which is available from 3.4 onwards,\n+\t * see https://docs.python.org/3/reference/import.html#spec. If not,\n+\t * check for __package__, which was set before 3.14.\n \t * Next try determine the shadow wrapper's package based on the __name__ it\n \t * was given by the importer that loaded it.\n \t * If the module is in a package, load the low-level C/C++ module from the\n \t * same package, otherwise load it as a global module.\n \t */\n         Printv(default_import_code, \"# Import the low-level C/C++ module\\n\", NULL);\n-        Printv(default_import_code, \"if __package__ or \\\".\\\" in __name__:\\n\", NULL);\n+        Printv(default_import_code, \"if getattr(globals().get(\\\"__spec__\\\"), \\\"parent\\\", None) or globals().get(\\\"__package__\\\") or \\\".\\\" in __name__:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from . import \", module, \"\\n\", NULL);\n         Printv(default_import_code, \"else:\\n\", NULL);\n         Printv(default_import_code, tab4, \"import \", module, \"\\n\", NULL);\n       } else {\n         Printv(default_import_code, \"# Pull in all the attributes from the low-level C/C++ module\\n\", NULL);\n-        Printv(default_import_code, \"if __package__ or \\\".\\\" in __name__:\\n\", NULL);\n+        Printv(default_import_code, \"if getattr(globals().get(\\\"__spec__\\\"), \\\"parent\\\", None) or globals().get(\\\"__package__\\\") or \\\".\\\" in __name__:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from .\", module, \" import *\\n\", NULL);\n         Printv(default_import_code, \"else:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from \", module, \" import *\\n\", NULL);\n@@ -4372,6 +4374,11 @@ class PYTHON:public Language {\n     Printv(f, \"#if PY_VERSION_HEX >= 0x030b0000\\n\", NIL);\n     printSlot(f, getSlot(n, \"feature:python:_ht_tpname\"), \"_ht_tpname\", \"char *\");\n \n+    // void *ht_token;\n+    Printv(f, \"#if PY_VERSION_HEX >= 0x030e0000\\n\", NIL);\n+    printSlot(f, getSlot(n, \"feature:python:ht_token\"), \"ht_token\", \"void *\");\n+    Printv(f, \"#endif\\n\", NIL);\n+\n     // struct _specialization_cache _spec_cache;\n     Printf(f, \"  {\\n\");\n     printSlot(f, getSlot(n, \"feature:python:getitem\"), \"getitem\", \"PyObject *\");\n", "test_patch": "diff --git a/Examples/test-suite/python/python_annotations_variable_c_runme.py b/Examples/test-suite/python/python_annotations_variable_c_runme.py\nindex 153852d05e..d1f359bbbd 100644\n--- a/Examples/test-suite/python/python_annotations_variable_c_runme.py\n+++ b/Examples/test-suite/python/python_annotations_variable_c_runme.py\n@@ -1,4 +1,17 @@\n import sys\n+import inspect\n+\n+\n+def get_annotations(cls):\n+    # Python >=3.14 removed the __annotations__ attribute\n+    # retrieve it via inspect (see also annotationlib)\n+    if hasattr(inspect, \"get_annotations\"):\n+        # Python >=3.10\n+        return inspect.get_annotations(cls)\n+    else:\n+        # Python <3.10\n+        return getattr(cls, \"__annotations__\", {})\n+\n \n # Variable annotations for properties is only supported in python-3.6 and later (PEP 526)\n if sys.version_info[0:2] >= (3, 6):\n@@ -8,17 +21,14 @@\n     annotations_supported = not(is_python_builtin() or is_python_fastproxy())\n \n     if annotations_supported:\n-        ts = TemplateShort()\n-        anno = ts.__annotations__\n+        anno = get_annotations(TemplateShort)\n         if anno != {'member_variable': 'int'}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n \n-        ts = StructWithVar()\n-        anno = ts.__annotations__\n+        anno = get_annotations(StructWithVar)\n         if anno != {'member_variable': 'int'}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n \n-        ts = StructWithVarNotAnnotated()\n-        if getattr(ts, \"__annotations__\", None) != None:\n-            anno = ts.__annotations__\n+        anno = get_annotations(StructWithVarNotAnnotated)\n+        if anno != {}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n", "problem_statement": "__package__ will cease being set/used  in Python 3.15\nThe files generated by SWIG depend on `__package__` being present, but Python 3.14 will removing this in favor of `__spec__.parent`. The 3.13 release notes https://docs.python.org/3.13/whatsnew/3.13.html#pending-removal-in-python-3-14 say:\r\n\r\n> [importlib](https://docs.python.org/3.13/library/importlib.html#module-importlib): `__package__` and `__cached__` will cease to be set or taken into consideration by the import system ([gh-97879](https://github.com/python/cpython/issues/97879)).\r\n\r\nBoth could be checked, or just `__spec__.parent` - I can verify that works back to 3.6, which is the oldest Python I had to check.\n", "hints_text": "Python 3.3 is the oldest SWIG currently supports and seems to lack `__spec__` entirely:\r\n\r\n```\r\nPython 3.3.5 (default, Mar 22 2014, 13:24:53) \r\n[GCC 4.8.2] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information. \r\n>>> dir(__spec__)\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\nNameError: name '__spec__' is not defined\r\n>>> \r\n```\nAdded in 3.4: https://docs.python.org/3/reference/import.html#spec__\nFWIW I think it would be fine to set 3.4 as the minimum required version, I think nobody uses anything less than 3.6 or maybe even later any more by now.\n3.3 is _really_ old, by the way, and never was well supported - throughout 3.3's support window, 2.x was dramatically more popular. 3.5 was the first version with heavy use. Personally, 3.6 is still a _really_ old version of Python and a fine minimum; 3.6 is the oldest version you can build for via manylinux, for example. 3.8 is the oldest officially supported version of Python these days.\nNo arguments from me, but you'll need to convince wsfulton...\nFWIW, I'd argue for the minimum Python3 version being 3.5 since that's the oldest we've actually been testing in CI since github dropped their ubuntu-18.04 image over a year ago.\r\n\r\nRequiring CI testing for a version of a target language aligns with our requirements for supporting a target language version at all, and both seem reasonable requirements since without automated testing we won't detect breakages, and expecting developers to test by hand seems like the burden falling in the wrong place.  If someone wants to keep support for an older version, they get to sort out CI coverage for that version (by using packages from a PPA or using a prebuilt version or running the job in a docker image or whatever).\nSupporting the latest version of python is more important than supporting older versions. It's easy enough to put in version specific code though. I agree with @ojwb though, that ideally we test the versions we state we support. I'm still using 3.6 though in places, and I doubt I am not the only one.\r\n\r\n> Both could be checked, or just `__spec__.parent` - I can verify that works back to 3.6, which is the oldest Python I had to check\r\n\r\nI don't see any `__spec__.parent` until python 3.13, eg for for 3.12:\r\n```\r\n$ python3.12\r\nPython 3.12.4 (main, Jun  8 2024, 18:29:57) [GCC 11.4.0] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> dir(__spec__)\r\n['__bool__', '__class__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__']\r\n>>> \r\n```\r\nNo parent, but there is in 3.13:\r\n```\r\n$ python3.13\r\nPython 3.13.0b3 (main, Jul  8 2024, 01:23:25) [GCC 11.4.0] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> dir(__spec__)\r\n['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__weakref__', '_cached', '_set_fileattr', '_uninitialized_submodules', 'cached', 'has_location', 'loader', 'loader_state', 'name', 'origin', 'parent', 'submodule_search_locations']\r\n>>> \r\n```\r\nHow did you determine it works all the way back to python-3.6?\r\n\r\nAdding @mromberg, who has done most of the advanced package support, for Python for comment.\nIt has to be in a file, the interpreter doesn\u2019t have a `__spec__` until 3.13 (and only the new Python-based REPL).\n> Supporting the latest version of python is more important than supporting older versions. It's easy enough to put in version specific code though. I agree with @ojwb though, that ideally we test the versions we state we support. I'm still using 3.6 though in places, and I doubt I am not the only one.\r\n\r\nWe still have CI testing for 3.6 (and 3.5) so enforcing a requirement for a version to be testable in CI wouldn't require dropping 3.6 at this point anyway.  It's only 3.3 and 3.4 that we claim to support without having any CI coverage to back that up (so unless anyone has been regularly manually testing with these older versions, really all we can say is that we haven't knowingly done anything that stops SWIG working Python 3.3 and 3.4, which to me isn't very reassuring either as a user or as a maintainer).\nLooks like 3.14 will likely be released in just over a year, so we should aim to fix this for SWIG 4.4.0.\nNote: it's important to support this at least by RC 1, since that's when CPython is ABI stable and packages are supposed to start shipping. The \".0\" release is when normal users are supposed to start using it, packages should already have been built for 3.14. It would be a very good idea to support it by beta 1, as that's when most packages start experimenting with support.\r\n\r\nAlphas are produced starting in October or so, and are available on GHA for _early_ testing. Anything can change, though.\r\nBeta phase starts in May. This is fairly stable (feature freeze), _small_ chance of ABI changes though.\r\nRC starts in August.\r\nFinal is October.\r\n\r\nI believe more people will be using 3.14.0a1 than 3.3 and 3.4 combined, if that's helpful. Yesterday, pip was downloaded 10 times for 3.3 and 495 times for 3.4. For comparison, for 3.14, pip was downloaded 260 times, and that's just people building CPython from source. For 3.13, it was downloaded 12,609 (0.12%) times, which is slightly higher than 3.5's 11,389 (0.11%) times. The most popular Python version, 3.11, downloaded pip 2,605,209 times (25.2%).\r\n\r\nSo removing 3.3 and 3.4 removes 0.00% of Python users (who download pip, since that's the package I chose for a metric).\r\n\r\nHere's the [download numbers](https://pypistats.org/packages/swig) for the pip `swig` package, by the way, which was downloaded 0 times for 3.3, 3.4, and 3.5:\r\n\r\n![Screenshot 2024-09-19 at 12 48 16\u202fAM](https://github.com/user-attachments/assets/65cd1757-ebb6-47e1-afae-7e9a9e2df90b)\r\n\r\nIf you scroll back a week or two, you can find one download for 3.5, on 9-9-2024.\r\n\r\n\nWe need an easy way to install python-3.14 with the `__package__` removal implemented to test in order to take this forward. Any news on 3.14 being ready for testing this would be good to know here. A patch with a proposed fix wouldn't go amiss either!\n@henryiii SWIG is a volunteer project - if you want something to happen (and especially if you want it to happen in a particular time scale) the best way to achieve that is to submit a clean patch.  If you're wanting to get a patch in 4.3.0, then you have about a week before it gets released (which is a timeline driven primarily by the Python 3.13 release date).\r\n\r\n(Even adding it to the 4.4 milestone doesn't guarantee it'll get done for 4.4.0, but it does at least ensure we don't forget about the issue completely.)\r\n\r\nI don't **think** there's much argument against hard dropping support for 3.3 and 3.4 at this point if keeping it is blocking 3.14 support, though I'm not 100% clear on @wsfulton's position on this.  If he's wanting to keep conditional version-specific code for 3.3 and 3.4 that may make the task significantly harder because we don't have CI testing to tell us such code actually works.\n> 3.3 is _really_ old, by the way, and never was well supported - throughout 3.3's support window, 2.x was dramatically more popular. 3.5 was the first version with heavy use. Personally, 3.6 is still a _really_ old version of Python and a fine minimum; 3.6 is the oldest version you can build for via manylinux, for example. 3.8 is the oldest officially supported version of Python these days.\r\n\r\n3.6 is still part of SUSE Linux Enterprise Server 15, and it will be part of it for a long time (unfortunately, I am the maintainer).\nOh, sorry, missed this. This would be a lot easier if something like 3.5+ or 3.6+ became the minimum supported version, which I assume you'd not want on a short timescale anyway. It seem like 4.4 or later would be fine, as long as it's in by the beta series of 3.14, which is next year, something like March IIRC.\r\n\r\n> 3.6 is still part of SUSE Linux Enterprise Server 15\r\n\r\nDo people expect the latest version of SWIG to work with 3.6, though? All the rest of the core libraries for Python require 3.7+ or 3.8+ (and 3.8 is now EoL, so soon it will be 3.9+). I think it's fine to expect to need old versions of software on old OSs. Though from what I remember above even 3.5+ would be just fine for this specific thing.\r\n\r\nFYI, you can't get older versions of Python (<3.8) via setup-python in GHA on macos-latest or ubuntu-latest. Apple Silicon support started in 3.8 and they didn't bother to build EoL Pythons for ubuntu-24.04.\nI wasn't submitting a patch since I didn't want to raise the min version of Python, that seem like a project consensus type of a thing. Should I make a patch that just doesn't support <3.5 for this, then?\nMaking the minimum supported version as 3.5 doesn't seem an unreasonable compromise in order to add support for 3.14. Please submit your patch to support 3.5 and later and I'll take a look.\nOn Wed Oct 30, 2024 at 7:30 PM CET, Henry Schreiner wrote:\r\n>> 3.6 is still part of SUSE Linux Enterprise Server 15\r\n>\r\n> Do people expect the latest version of SWIG to work with 3.6, though? All the rest of the core libraries for Python require 3.7+ or 3.8+ (and 3.8 is now EoL, so soon it will be 3.9+). I think it\u2019s fine to expect to need old versions of software on old OSs. Though from what I remember above even 3.5+ would be just fine for this specific thing.\r\n\r\nI didn\u2019t mean that. Certainly we discourage users of our enterprise systems to use recent versions of software packages we provide in the system, moreover using most recent swig on the ancient system is beyond recklessness. However, as I believe SLE\u2019s Python 3.6 is probably one of the oldest supported Pythons in the production use (I am not sure RHEL, but I think they don\u2019t carry anything that ancient any more), it could be just one milestone where to stop with increasing the version of Python you support.\r\n\nManylinux also still supports 3.6 for a bit longer also (and because of that, it's still pretty easy to test on 3.6).", "created_at": "2025-04-10 17:59:12", "merge_commit_sha": "c8bedcc66163513ca3cc204e7b9b3388a44d26c2", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["java 8 gcc", ".github/workflows/windows.yml"], ["python  3.13   gcc  gnu99", ".github/workflows/linux.yml"], ["csharp     gcc", ".github/workflows/linux.yml"], ["scilab  2024.1.0   gcc", ".github/workflows/linux.yml"], ["python  3.13t   gcc  gnu99", ".github/workflows/linux.yml"], ["guile     gcc c++14", ".github/workflows/linux.yml"], ["java 8 msvc", ".github/workflows/windows.yml"], ["ruby  3.1   gcc c++11", ".github/workflows/linux.yml"], ["none     gcc", ".github/workflows/linux.yml"], ["ruby  3.3   gcc c++11", ".github/workflows/linux.yml"], ["csharp  gcc windows-2019", ".github/workflows/windows.yml"], ["csharp     gcc c++14", ".github/workflows/linux.yml"], ["none     clang", ".github/workflows/linux.yml"], ["ruby 3.1.6 msvc  no-test", ".github/workflows/windows.yml"], ["octave     gcc13 c++17", ".github/workflows/linux.yml"], ["scilab  2023.1.0   gcc", ".github/workflows/linux.yml"], ["d  2.103.1   gcc c++17", ".github/workflows/linux.yml"], ["none     gcc10", ".github/workflows/linux.yml"], ["csharp  gcc", ".github/workflows/windows.yml"], ["scilab  5.5.2   gcc", ".github/workflows/linux.yml"], ["python    -builtin -O gcc", ".github/workflows/linux.yml"], ["php  8.1   gcc", ".github/workflows/linux.yml"], ["octave     gcc c++11", ".github/workflows/linux.yml"], ["perl5     gcc c++14", ".github/workflows/linux.yml"], ["go  1.24   gcc  gnu99", ".github/workflows/linux.yml"], ["ocaml     gcc13 c++17   (can fail)", ".github/workflows/linux.yml"], ["java     gcc13 c++17", ".github/workflows/linux.yml"], ["python  3.13  -builtin gcc", ".github/workflows/linux.yml"], ["none     gcc11", ".github/workflows/linux.yml"], ["d  gdmd   gcc c++11", ".github/workflows/linux.yml"], ["r     gcc c++14", ".github/workflows/linux.yml"], ["php     gcc13 c++17 gnu17", ".github/workflows/linux.yml"], ["php  8.3   gcc", ".github/workflows/linux.yml"], ["java     gcc c++11", ".github/workflows/linux.yml"], ["javascript v8 7.8   gcc c++14 c++14", ".github/workflows/linux.yml"], ["php     gcc c++14 gnu11", ".github/workflows/linux.yml"], ["ruby  2.1   gcc", ".github/workflows/linux.yml"], ["ruby  gcc  no-test", ".github/workflows/windows.yml"], ["python  3.14   gcc  gnu99", ".github/workflows/linux.yml"], ["none     gcc9 c++98 c99", ".github/workflows/linux.yml"], ["perl5     gcc c++11", ".github/workflows/linux.yml"], ["perl5     gcc13 c++17", ".github/workflows/linux.yml"], ["r     gcc c++11", ".github/workflows/linux.yml"], ["python     gcc13 c++17", ".github/workflows/linux.yml"], ["none     gcc12", ".github/workflows/linux.yml"], ["ruby     gcc c++11", ".github/workflows/linux.yml"], ["go  1.20   gcc c++14 gnu11", ".github/workflows/linux.yml"], ["none     gcc13", ".github/workflows/linux.yml"], ["guile     gcc13 c++17", ".github/workflows/linux.yml"], ["ruby  3.2   gcc c++11", ".github/workflows/linux.yml"], ["tcl     gcc c++14", ".github/workflows/linux.yml"], ["python  3.10   gcc", ".github/workflows/linux.yml"], ["c     gcc c++11", ".github/workflows/linux.yml"], ["ruby  2.3   gcc", ".github/workflows/linux.yml"], ["lua     gcc c++11", ".github/workflows/linux.yml"], ["ruby     gcc c++14", ".github/workflows/linux.yml"], ["javascript napi 20   gcc13 c++17", ".github/workflows/linux.yml"], ["python  3.9   gcc", ".github/workflows/linux.yml"], ["python     gcc13 c++20", ".github/workflows/linux.yml"], ["lua     gcc13 c++17", ".github/workflows/linux.yml"], ["java     gcc c++14", ".github/workflows/linux.yml"], ["csharp     gcc13 c++17", ".github/workflows/linux.yml"], ["CMake VS 17 2022", ".github/workflows/windows-cmake.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4881", "base_commit": "8f51df70b7e29ec66345f973c1b168b85ccdce30", "patch": "diff --git a/lib/ProxySQL_Admin_Stats.cpp b/lib/ProxySQL_Admin_Stats.cpp\nindex c6b477f93..3e314a8c3 100644\n--- a/lib/ProxySQL_Admin_Stats.cpp\n+++ b/lib/ProxySQL_Admin_Stats.cpp\n@@ -591,6 +591,7 @@ void ProxySQL_Admin::stats___mysql_global() {\n \t}\n \n \tsqlite3_global_stats_row_step(statsdb, row_stmt, \"mysql_listener_paused\", admin_proxysql_mysql_paused);\n+\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"OpenSSL_Version_Num\", OpenSSL_version_num());\n \n \tstatsdb->execute(\"COMMIT\");\n }\ndiff --git a/src/main.cpp b/src/main.cpp\nindex 7c1006c01..8f9ce9316 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -341,8 +341,15 @@ static void init_locks(void) {\n static bool check_openssl_version() {\n \tunsigned long version = OpenSSL_version_num();\n \tconst unsigned long OPENSSL_3_0_0 = 0x30000000L;\n+\tconst unsigned long OPENSSL_3_2_0 = 0x30200000L;\n \n \tproxy_info(\"Using OpenSSL version: %s\\n\", OpenSSL_version(OPENSSL_VERSION));\n+\tif (version > OPENSSL_3_0_0 && version < OPENSSL_3_2_0) {\n+\t\tproxy_warning(\n+\t\t\t\"Detected OpenSSL version has known performance regressions, please upgrade to '3.2.0' or later.\"\n+\t\t\t\" For further details, please refer to: https://github.com/openssl/openssl/issues/18814\\n\"\n+\t\t);\n+\t}\n \tif (version < OPENSSL_3_0_0) {\n \t\tproxy_error(\"%s\\n\", \"ProxySQL server required openssl version 3.0.0 or above\");\n \t\treturn false;\n", "test_patch": "diff --git a/test/tap/tap/utils.cpp b/test/tap/tap/utils.cpp\nindex 21061f4d0..79238b910 100644\n--- a/test/tap/tap/utils.cpp\n+++ b/test/tap/tap/utils.cpp\n@@ -243,6 +243,22 @@ string to_string(std::thread::id id) {\n \treturn helper.str();\n }\n \n+string replace_str(const string& str, const string& match, const string& repl) {\n+\tif(match.empty()) {\n+\t\treturn str;\n+\t}\n+\n+\tstring result { str };\n+\tsize_t start_pos = 0;\n+\n+\twhile((start_pos = result.find(match, start_pos)) != std::string::npos) {\n+\t\tresult.replace(start_pos, match.length(), repl);\n+\t\tstart_pos += repl.length();\n+\t}\n+\n+\treturn result;\n+}\n+\n pair<int,vector<MYSQL*>> disable_core_nodes_scheduler(CommandLine& cl, MYSQL* admin) {\n \tvector<MYSQL*> nodes_conns {};\n \ndiff --git a/test/tap/tap/utils.h b/test/tap/tap/utils.h\nindex bb22de272..c2d19a517 100644\n--- a/test/tap/tap/utils.h\n+++ b/test/tap/tap/utils.h\n@@ -21,6 +21,9 @@\n template <typename T>\n using rc_t = std::pair<int,T>;\n \n+#define _S(s) ( std::string {s} )\n+#define _TO_S(s) ( std::to_string(s) )\n+\n // Improve dependency failure compilation error\n #ifndef DISABLE_WARNING_COUNT_LOGGING\n \n@@ -63,6 +66,12 @@ my_bool mysql_stmt_close_override(MYSQL_STMT* stmt, const char* file, int line);\n \n #endif \n \n+/**\n+ * @brief Simple macro to use with 'mysql_query' versions.\n+ * @details E.g: `mysql_query_ext_val(admin, SELECT_RUNTIME_VAR\"'mysql-eventslog_filename'\", \"\")`.\n+ */\n+#define SELECT_RUNTIME_VAR \"SELECT variable_value FROM runtime_global_variables WHERE variable_name=\"\n+\n /**\n  * @brief Computes the binomial coefficient C(n, k)\n  */\n@@ -95,6 +104,15 @@ int find_min_elems(double tg_prob, int M);\n  */\n std::string to_string(std::thread::id id);\n \n+/**\n+ * @brief Replaces all occurrences of a substring in a given string with another substring.\n+ * @param str The string which matches are to be replaced.\n+ * @param match The string which occurrences shall be replaced.\n+ * @param repl The string used to replace 'match' occurrences.\n+ * @return A new string with all 'match' occurrences replaced by 'repl'.\n+ */\n+std::string replace_str(const std::string& str, const std::string& match, const std::string& repl);\n+\n /**\n  * @brief Helper function to disable Core nodes scheduler from ProxySQL Cluster nodes.\n  * @details In the CI environment, 'Scheduler' is used to induce extra load via Admin interface on\n@@ -221,6 +239,19 @@ enum SQ3_RES_T {\n  */\n sq3_res_t sqlite3_execute_stmt(sqlite3* db, const std::string& query);\n \n+/**\n+ * @brief Utility one-liner macro to check for query failure on a 'ext_val_t<T>'.\n+ * @param val The 'ext_val_t<T>' to be checked.\n+ * @return In case of failure, 'EXIT_FAILURE' after logging the error, continues otherwise.\n+ */\n+#define CHECK_EXT_VAL(val)\\\n+\tdo {\\\n+\t\tif (val.err) {\\\n+\t\t\tdiag(\"%s:%d: Query failed   err=\\\"%s\\\"\", __func__, __LINE__, val.str.c_str());\\\n+\t\t\treturn EXIT_FAILURE;\\\n+\t\t}\\\n+\t} while(0)\n+\n /**\n  * @brief Holds the result of an `mysql_query_ext_val` operation.\n  */\ndiff --git a/test/tap/tests/generate_set_session_csv.cpp b/test/tap/tests/generate_set_session_csv.cpp\nindex 7829d4edb..b9e91b03c 100644\n--- a/test/tap/tests/generate_set_session_csv.cpp\n+++ b/test/tap/tests/generate_set_session_csv.cpp\n@@ -19,6 +19,11 @@ std::vector<int> int_values = {\n \t10, 20, 100, 1010, 1234, 3456, 7890, 34564, 68100, 123456, 456123\n };\n \n+std::vector<int> mariadb_compatible_tmp_table_size = {\n+\t32768, 49152, 65536, 81920, 98304, 114688, 131072, 131072, 147456, 163840, 180224,\n+\t196608, 212992, 229376, 245760, 262144, 491520, 507904, 524288, 540672, 557056\n+};\n+\n std::vector<int> int_values_small = {\n \t13, 32, 110, 310, 434, 558, 789\n };\n@@ -188,8 +193,20 @@ int main() {\n \tvars[\"max_join_size\"]->add(\"18446744073709551615\");\n \tvars[\"max_join_size\"]->add(\"DEFAULT\");\n \tvars[\"tmp_table_size\"] = std::make_unique<variable>(\"tmp_table_size\", true, true, false);\n-\tvars[\"tmp_table_size\"]->add(int_values, 10050);\n-\tvars[\"tmp_table_size\"]->add(\"18446744000000051615\");\n+\t// NOTE: Since recent MariaDB versions (known affected version 10.11.11), values which are not multiples\n+\t// of '16384' for 'tmp_table_size' generate truncate warnings:\n+\t//  - Warning for max value:\n+\t//    +---------+------+--------------------------------------------------------+\n+\t//    | Level   | Code | Message                                                |\n+\t//    +---------+------+--------------------------------------------------------+\n+\t//    | Warning | 1292 | Truncated incorrect tmp_table_size value: '4294967295' |\n+\t//    +---------+------+--------------------------------------------------------+\n+\t//  - https://github.com/MariaDB/server/blob/31adb3030ce531009457913cbf947456ad606646/sql/sys_vars.cc#L4486\n+\t// The value woule be set to the nearest valid block_size, this is also true for the maximum value.\n+\t// Warnings, in combination with 'sql_mode=TRADITIONAL' will trigger errors, preventing the test to run\n+\t// for recent MariaDB versions.\n+\tvars[\"tmp_table_size\"]->add(mariadb_compatible_tmp_table_size, 16384);\n+\tvars[\"tmp_table_size\"]->add(\"4294950912\");\n \tvars[\"max_heap_table_size\"] = std::make_unique<variable>(\"max_heap_table_size\", true, true, false);\n \tvars[\"max_heap_table_size\"]->add(int_values, 20031);\n \tvars[\"max_heap_table_size\"]->add(\"8446744073709547520\");\ndiff --git a/test/tap/tests/mysql-protocol_compression_level-t.cpp b/test/tap/tests/mysql-protocol_compression_level-t.cpp\nindex b01565cb7..354d11744 100644\n--- a/test/tap/tests/mysql-protocol_compression_level-t.cpp\n+++ b/test/tap/tests/mysql-protocol_compression_level-t.cpp\n@@ -1,261 +1,344 @@\n+/**\n+ * @file mysql-protocol_compression_level-t.cpp\n+ * @brief Checks 'mysql-protocol_compression_level' variable and its performance impact.\n+ * @details The test generates an artificially large resultset from a simple, small test table. Cross-joins of\n+ *  this table are used to generate bigger resulsets. The column selection is generated randomly in a\n+ *  per-query based to prevent forms of caching/exact memory patterns on server side. In it's current form the\n+ *  test uses '20', '40Mb' randomly generated packets, measuring the average overhead per-packet that is\n+ *  imposed when different compression levels are enabled. A slight delay is imposed between each packet\n+ *  fetch, preventing to fetch more than '10' packets per-second. This is done to completely isolate the load\n+ *  and attempting to prevent any form of network saturation.\n+ */\n+\n+#include <cmath>\n #include <cstdlib>\n #include <cstdio>\n #include <cstring>\n #include <unistd.h>\n \n+#include <random>\n #include <string>\n-#include <sstream>\n-#include <fstream>\n+#include <vector>\n+\n #include \"mysql.h\"\n+#include \"json.hpp\"\n \n #include \"tap.h\"\n #include \"command_line.h\"\n #include \"utils.h\"\n \n-unsigned long calculate_query_execution_time(MYSQL* mysql, const std::string& query) {\n-\tMYSQL_RES *res;\n-\tMYSQL_ROW row;\n-\tunsigned long long begin = monotonic_time();\n-\tunsigned long long row_count = 0;\n-\tunsigned long ret_query = 0;\n-\n-\tret_query = mysql_query(mysql, query.c_str());\n-\tif (ret_query != 0) {\n-\t\tfprintf(stderr, \"Failed to execute query: Error: %s\\n\", mysql_error(mysql));\n-\t\treturn -1;\n-\t}\n+using std::string;\n+using std::vector;\n \n-\tres = mysql_use_result(mysql);\n-\tunsigned long long num_rows = mysql_num_rows(res);\n-\tunsigned int num_fields = mysql_num_fields(res);\n-\twhile ((row = mysql_fetch_row(res))) {\n-\t\tfor (unsigned int i = 1; i < num_fields; i++) {\n-\t\t\tchar *field = row[i];\n-\t\t}\n-\t\trow_count++;\n-\t}\n-\tmysql_free_result(res);\t\n-\tunsigned long long end = monotonic_time();\n-\tfprintf(stderr, \"Row count: %lld\\n\", row_count);\n-\treturn (end - begin);\n-}\n+std::random_device rd;\n+std::mt19937 gen(rd());\n \n-MYSQL* initilize_mysql_connection(char* host, char* username, char* password, int port, bool compression) {\n-\tMYSQL* mysql = mysql_init(NULL);\n-\tif (!mysql)\n-\t\treturn nullptr;\n+string get_rnd_fields(const vector<string>& fields) {\n+\tvector<string> _fields { fields };\n+\tstd::shuffle(_fields.begin(), _fields.end(), gen);\n+\tconst string fields_str { join(\", \", _fields) };\n \n-\tfprintf(stderr, \"MySQL connection details: %s %s %d\\n\", username, password, port);\n-\tif (compression) {\n-\t\tif (mysql_options(mysql, MYSQL_OPT_COMPRESS, nullptr) != 0) {\n-\t\t\tfprintf(stderr, \"Failed to set mysql compression option: Error: %s\\n\",\n-\t\t\t\t\tmysql_error(mysql));\n-\t\t\treturn nullptr;\n-\t\t}\n-\t}\n-\tif (!mysql_real_connect(mysql, host, username, password, NULL, port, NULL, 0)) {\n-\t    fprintf(stderr, \"Failed to connect to database: Error: %s\\n\",\n-\t              mysql_error(mysql));\n-\t\treturn nullptr;\n-\t}\n-\treturn mysql;\n+\treturn fields_str;\n }\n \n-int main(int argc, char** argv) {\n+uint64_t measure_avg_query_time(\n+\tMYSQL* mysql, const string& q, const vector<string>& fields, uint32_t its=10\n+) {\n+\tdiag(\n+\t\t\"Starting query measurement   q=\\\"%s\\\" fields=\\\"%s\\\" its=%d\",\n+\t\tq.c_str(), nlohmann::json(fields).dump().c_str(), its\n+\t);\n \n-\tCommandLine cl;\n-\tstd::string query = \"SELECT t1.id id1, t1.k k1, t1.c c1, t1.pad pad1, t2.id id2, t2.k k2, t2.c c2, t2.pad pad2 FROM test.sbtest1 t1 JOIN test.sbtest1 t2 LIMIT 90000000\";\n-\tunsigned long time_proxy = 0;\n-\tunsigned long time_proxy_compression_level_default = 0;\n-\tunsigned long time_proxy_compression_level_8 = 0;\t\n-\tlong diff = 0;\n-\tunsigned long time_mysql_compressed = 0;\n-\tunsigned long time_mysql_without_compressed = 0;\n-\tstd::string compression_level = {\"\"};\n-\tint32_t ret = 0;\n-\tMYSQL* proxysql = nullptr;\n-\tMYSQL* proxysql_compression = nullptr;\n-\tMYSQL* proxysql_admin = nullptr;\n-\tMYSQL* mysql_compression = nullptr;\n-\tMYSQL* mysql = nullptr;\n-\tfloat performance_diff = 0;\n-\n-\tif(cl.getEnv())\n-\t\treturn exit_status();\n-\n-\tplan(9);\n-\n-\t// ProxySQL connection without compression\n-\tproxysql = initilize_mysql_connection(cl.host, cl.username, cl.password, cl.port, false);\n-\tif (!proxysql) {\n-\t\tgoto cleanup;\n-\t}\n+\tuint64_t avg { 0 };\n+\tuint64_t row_count { 0 };\n+\tuint64_t delay_us = std::pow(10, 6) / its;\n \n-\t// ProxySQL connection with compression\n-\tproxysql_compression = initilize_mysql_connection(cl.host, cl.username, cl.password, cl.port, true);\n-\tif (!proxysql_compression) {\n-\t\tgoto cleanup;\n-\t}\n+\tfor (uint32_t i = 0; i < its; i++) {\n+\t\tconst string it_fields { get_rnd_fields(fields) };\n+\t\tconst string it_query { replace_str(q, \"?\", it_fields) };\n \n-\t// MySQL connection without compression\n-\tmysql = initilize_mysql_connection(cl.host, cl.username, cl.password, cl.mysql_port, false);\n-\tif (!mysql) {\n-\t\tgoto cleanup;\n-\t}\n+\t\tdiag(\" :: Starting it query measurement   it_fields=\\\"%s\\\" it=%d\", it_fields.c_str(), i);\n \n-\t// MySQL connection with compression\n-\tmysql_compression = initilize_mysql_connection(cl.host, cl.username, cl.password, cl.mysql_port, true);\n-\tif (!mysql_compression) {\n-\t\tgoto cleanup;\n-\t}\n+\t\tunsigned long long begin = monotonic_time();\n \n-\t// ProxySQL admin connection\n-\tproxysql_admin = initilize_mysql_connection(cl.host, cl.admin_username, cl.admin_password, cl.admin_port, false);\n-\tif (!proxysql_admin) {\n-\t\tgoto cleanup;\n-\t}\n+\t\tMYSQL_QUERY(mysql, it_query.c_str());\n \n-\t// Change default query rules to avoid replication issues; This test only requires the default hostgroup\n-\tMYSQL_QUERY(proxysql_admin, \"UPDATE mysql_query_rules SET active=0\");\n-\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL QUERY RULES TO RUNTIME\");\n+\t\tMYSQL_RES* res = mysql_use_result(mysql);\n+\t\twhile (MYSQL_ROW row = mysql_fetch_row(res)) {\n+\t\t\trow_count += 1;\n+\t\t}\n \n-\tMYSQL_QUERY(proxysql, \"CREATE DATABASE IF NOT EXISTS test\");\n-\tMYSQL_QUERY(proxysql, \"DROP TABLE IF EXISTS test.sbtest1\");\n+\t\t// NOTE: This is an interesting case. Fetching the resulset at once, appears to be slightly slower\n+\t\t// than doing it row by row. This can be interesting to investigate (check non-debug build).\n+\t\t// MYSQL_RES* res = mysql_store_result(mysql);\n+\t\t// row_count += mysql_num_rows(res);\n \n-\tmysql_query(proxysql, \"CREATE TABLE IF NOT EXISTS test.sbtest1 (id INT UNSIGNED NOT NULL AUTO_INCREMENT, k INT UNSIGNED NOT NULL DEFAULT 0, c CHAR(120) NOT NULL DEFAULT '', pad CHAR(60) NOT NULL DEFAULT '', PRIMARY KEY (id), KEY k_1 (k));\");\n+\t\tmysql_free_result(res);\n+\t\tunsigned long long end = monotonic_time();\n \n-\tMYSQL_QUERY(proxysql, \"USE test\");\n+\t\tavg += (end - begin);\n \n-\tfor (int i = 0; i < 100; i++) {\n-\t\tMYSQL_QUERY(proxysql, \"INSERT INTO sbtest1 (k, c, pad) SELECT FLOOR(RAND() * 10000), REPEAT('a', 120), REPEAT('b', 60) FROM information_schema.tables LIMIT 1000;\");\n+\t\tusleep(delay_us);\n \t}\n \n-\ttime_proxy = calculate_query_execution_time(proxysql, query);\n-\tdiag(\"Time taken for query with proxysql without compression: %ld\", time_proxy);\n-\tif (time_proxy == -1) {\n-\t\tgoto cleanup;\n-\t}\n+\tdiag(\"Finished query measurement   q=\\\"%s\\\" its=%d rows=%lu\", q.c_str(), its, row_count);\n \n-\ttime_proxy_compression_level_default = calculate_query_execution_time(proxysql_compression, query);\n-\tdiag(\"Time taken for query with proxysql with default compression (3): %ld\", time_proxy_compression_level_default);\n-\tif (time_proxy_compression_level_default == -1) {\n-\t\tgoto cleanup;\n-\t}\n+\tavg /= its;\n+\n+\treturn avg;\n+}\n \n-\tdiff = time_proxy_compression_level_default - time_proxy;\n-\tperformance_diff = (float)(diff * 100) / time_proxy;\n+MYSQL* init_mysql_conn(char* host, char* user, char* pass, int port, bool cmp=false) {\n+\tdiag(\"Creating MySQL conn   host=\\\"%s\\\" port=\\\"%d\\\" cmp=\\\"%d\\\"\", user, port, cmp);\n \n-\tok((performance_diff > 0), \"proxysql without compression performed well compared to default compression level (3). Performance difference: %f percentage\", performance_diff);\n+\tMYSQL* mysql = mysql_init(NULL);\n \n-\ttime_mysql_without_compressed = calculate_query_execution_time(mysql, query);\n-\tdiag(\"Time taken for query with mysql without compression: %ld\", time_mysql_without_compressed);\n-\tif (time_mysql_without_compressed == -1) {\n-\t\tgoto cleanup;\n+\tif (!mysql) {\n+\t\treturn nullptr;\n \t}\n+\tif (cmp) {\n+\t\tif (mysql_options(mysql, MYSQL_OPT_COMPRESS, nullptr)) {\n+\t\t\treturn nullptr;\n+\t\t}\n+\t}\n+\tif (!mysql_real_connect(mysql, host, user, pass, NULL, port, NULL, 0)) {\n+\t\treturn nullptr;\n+\t}\n+\n+\treturn mysql;\n+}\n \n-\ttime_mysql_compressed = calculate_query_execution_time(mysql_compression, query);\n-\tdiag(\"Time taken for query with mysql with compression: %ld\", time_mysql_compressed);\n-\tif (time_mysql_compressed == -1) {\n-\t\tgoto cleanup;\n+const char version_comment_query[] { \"select @@version_comment limit 1\" };\n+\n+int check_perf_diff(const string tcase, double time1, double time2, double exp_diff, bool _diag=false) {\n+\tdouble diff = time2 - time1;\n+\tdouble perf_diff = double(diff * 100) / time1;\n+\n+\tif (_diag) {\n+\t\tdiag(\n+\t\t\t\"For diagnosing: Computed perf diff   case=\\\"%s\\\" perf_diff=%lf\",\n+\t\t\ttcase.c_str(), perf_diff\n+\t\t);\n+\t} else {\n+\t\tok(\n+\t\t\texp_diff > 0 ? perf_diff < exp_diff : perf_diff > (-exp_diff),\n+\t\t\t\"Perf diff within expected range   case=\\\"%s\\\" perf_diff=%lf exp_diff=%lf\",\n+\t\t\ttcase.c_str(), perf_diff, std::abs(exp_diff)\n+\t\t);\n \t}\n \n-\tdiff = time_mysql_compressed - time_mysql_without_compressed;\n-\tperformance_diff = (float)(diff * 100) / time_mysql_without_compressed;\n+\treturn EXIT_SUCCESS;\n+}\n+\n+int main(int argc, char** argv) {\n+\tplan(8);\n \n-\tok((performance_diff > 0), \"MySQL without compression performed well compared to mysql with compression. Performance difference: %f percentage\", performance_diff);\n+\tCommandLine cl;\n \n-\tret = get_variable_value(proxysql_admin, \"mysql-protocol_compression_level\", compression_level, true);\n-\tif (ret == EXIT_SUCCESS) {\n-\t\tok(compression_level == \"3\", \"Run-time default compression level is correct: %s\", compression_level.c_str());\n-\t}\n-\telse {\n-\t\tdiag(\"Failed to get the default compression level.\");\n-\t\tgoto cleanup;\n+\tif (cl.getEnv()) {\n+\t\tdiag(\"Failed to get the required environmental variables.\");\n+\t\treturn EXIT_FAILURE;\n \t}\n \n-\tret = get_variable_value(proxysql_admin, \"mysql-protocol_compression_level\", compression_level);\n-\tif (ret == EXIT_SUCCESS) {\n-\t\tok(compression_level == \"3\", \"Default compression level is correct: %s\", compression_level.c_str());\n+\tMYSQL* admin = init_mysql_conn(cl.host, cl.admin_username, cl.admin_password, cl.admin_port);\n+\tif (!admin) {\n+\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(admin));\n+\t\treturn EXIT_FAILURE;\n \t}\n-\telse {\n-\t\tdiag(\"Failed to get the default compression level.\");\n-\t\tgoto cleanup;\n+\n+\tMYSQL* proxy = init_mysql_conn(cl.host, cl.username, cl.password, cl.port);\n+\tif (!proxy) {\n+\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(admin));\n+\t\treturn EXIT_FAILURE;\n \t}\n \n-\tset_admin_global_variable(proxysql_admin, \"mysql-protocol_compression_level\", \"8\");\n-\tif (mysql_query(proxysql_admin, \"load mysql variables to runtime\")) {\n-\t\tdiag(\"Failed to load mysql variables to runtime.\");\n-\t\tgoto cleanup;\n+\t// Disable query rules to avoid replication issues; Test uses default hostgroup\n+\tMYSQL_QUERY_T(admin, \"UPDATE mysql_query_rules SET active=0\");\n+\tMYSQL_QUERY_T(admin, \"LOAD MYSQL QUERY RULES TO RUNTIME\");\n+\n+\tMYSQL_QUERY_T(proxy, \"CREATE DATABASE IF NOT EXISTS test\");\n+\tMYSQL_QUERY_T(proxy, \"DROP TABLE IF EXISTS test.sbtest1\");\n+\n+\tMYSQL_QUERY_T(proxy,\n+\t\t\"CREATE TABLE IF NOT EXISTS test.sbtest1 (\"\n+\t\t\t\" id INT UNSIGNED NOT NULL AUTO_INCREMENT,\"\n+\t\t\t\" k INT UNSIGNED NOT NULL DEFAULT 0,\"\n+\t\t\t\" c CHAR(112) NOT NULL DEFAULT '',\"\n+\t\t\t\" pad CHAR(80) NOT NULL DEFAULT '',\"\n+\t\t\t\" PRIMARY KEY (id), KEY k_1 (k)\"\n+\t\t\" )\"\n+\t);\n+\n+\tMYSQL_QUERY_T(proxy, \"USE test\");\n+\n+\t// Generate '256' entries: (4 + 4 + 112 + 80) * 256 ~= 51.2kb\n+\tMYSQL_QUERY_T(proxy,\n+\t\t\"INSERT INTO sbtest1 (`k`, `c`, `pad`)\"\n+\t\t\" SELECT\"\n+\t\t\t\" FLOOR(RAND() * 1000) AS `k`,\"\n+\t\t\t\" LEFT(REPEAT(MD5(RAND()), 4), 112) AS `c`,\"\n+\t\t\t\" LEFT(REPEAT(MD5(RAND()), 3), 80) AS `pad`\"\n+\t\t\" FROM\"\n+\t\t\t\" (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4) as u1,\"\n+\t\t\t\" (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4) as u2,\"\n+\t\t\t\" (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4) as u3,\"\n+\t\t\t\" (SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4) as u4;\"\n+\t);\n+\n+\tMYSQL* proxy_cmp = init_mysql_conn(cl.host, cl.username, cl.password, cl.port, true);\n+\tif (!proxy_cmp) {\n+\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxy_cmp));\n+\t\treturn EXIT_FAILURE;\n \t}\n-\tret = get_variable_value(proxysql_admin, \"mysql-protocol_compression_level\", compression_level, true);\n-\tif (ret == EXIT_SUCCESS) {\n-\t\tok(compression_level == \"8\", \"Run-time Compression level is set correctly: %s\", compression_level.c_str());\n+\tMYSQL* mysql = init_mysql_conn(cl.host, cl.username, cl.password, cl.mysql_port, false);\n+\tif (!mysql) {\n+\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(mysql));\n+\t\treturn EXIT_FAILURE;\n \t}\n-\telse {\n-\t\tdiag(\"Failed to set the Compression level is set correctly:\");\n-\t\tgoto cleanup;\n+\tMYSQL* mysql_cmp = init_mysql_conn(cl.host, cl.username, cl.password, cl.mysql_port, true);\n+\tif (!mysql_cmp) {\n+\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(mysql_cmp));\n+\t\treturn EXIT_FAILURE;\n \t}\n \n-\tret = get_variable_value(proxysql_admin, \"mysql-protocol_compression_level\", compression_level);\n-\tif (ret == EXIT_SUCCESS) {\n-\t\tok(compression_level == \"8\", \"Compression level is set correctly: %s\", compression_level.c_str());\n-\t}\n-\telse {\n-\t\tdiag(\"Failed to set the Compression level is set correctly:\");\n-\t\tgoto cleanup;\n+\tconst vector<string> fields {\n+\t\t\"t1.id id1\", \"t1.k k1\", \"t1.c c1\", \"t1.pad pad1\", \"t1.id id2\", \"t1.k k2\", \"t1.c c2\", \"t1.pad pad2\"\n+\t};\n+\n+\t// Generates rows doubling the original columns (51.2kb * 2 =~ 102.4kb). Then it multiplies the number of\n+\t// rows using cross-joins (102kb * (100 * 4) ~= 40800mb). Each resulset is expected to have around 40mb.\n+\tconst char select_query[] {\n+\t\t\"SELECT\"\n+\t\t\t\" ?\" // \" t1.id id1, t1.k k1, t1.c c1, t1.pad pad1, t1.id id2, t1.k k2, t1.c c2, t1.pad pad2\"\n+\t\t\" FROM\"\n+\t\t\t\" test.sbtest1 t1\"\n+\t\t\t\" CROSS JOIN (\"\n+\t\t\t\t\" SELECT a.n + (b.n - 1) * 10 AS num\"\n+\t\t\t\t\" FROM (\"\n+\t\t\t\t\t\" SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL\"\n+\t\t\t\t\t\" SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL\"\n+\t\t\t\t\t\" SELECT 9 UNION ALL SELECT 10\"\n+\t\t\t\t\" ) a\"\n+\t\t\t\t\" CROSS JOIN (\"\n+\t\t\t\t\t\" SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL\"\n+\t\t\t\t\t\" SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL\"\n+\t\t\t\t\t\" SELECT 9 UNION ALL SELECT 10\"\n+\t\t\t\t\" ) b\" // 10MB\n+\t\t\t\t\" CROSS JOIN (\"\n+\t\t\t\t\t\" SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4\"\n+\t\t\t\t\") c\" // 40MB\n+\t\t\t\" ) num\"\n+\t};\n+\n+\tdiag(\"Meassuring ProxySQL time *WITHOUT* compression\");\n+\tuint64_t proxy_time = measure_avg_query_time(proxy, select_query, fields, 20);\n+\tif (proxy_time == 0) { return EXIT_FAILURE; }\n+\n+\tdiag(\"Meassuring ProxySQL time *WITH* compression   cmp_lvl=3\");\n+\tMYSQL_QUERY_T(admin, \"SET mysql-protocol_compression_level=3\");\n+\tMYSQL_QUERY_T(admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\n+\t{\n+\t\tstring cmp_lvl {};\n+\t\tint rc = get_variable_value(admin, \"mysql-protocol_compression_level\", cmp_lvl, true);\n+\t\tif (rc) { return EXIT_FAILURE; }\n+\t\tok(cmp_lvl == \"3\", \"Runtime Compression level set correctly: %s\", cmp_lvl.c_str());\n+\t\trc = get_variable_value(admin, \"mysql-protocol_compression_level\", cmp_lvl);\n+\t\tif (rc) { return EXIT_FAILURE; }\n+\t\tok(cmp_lvl == \"3\", \"Compression level set correctly: %s\", cmp_lvl.c_str());\n \t}\n \n-\ttime_proxy_compression_level_8 = calculate_query_execution_time(proxysql_compression, query);\n-\tdiag(\"Time taken for query with proxysql with compression level 8: %ld\", time_proxy_compression_level_8);\n-\tif (time_proxy_compression_level_8 == -1) {\n-\t\tgoto cleanup;\n+\tuint64_t proxy_cmp_time = measure_avg_query_time(proxy_cmp, select_query, fields, 20);\n+\tif (proxy_cmp_time == 0) { return EXIT_FAILURE; }\n+\n+\tdiag(\"Meassuring ProxySQL time *WITH* compression   cmp_lvl=8\");\n+\tMYSQL_QUERY_T(admin, \"SET mysql-protocol_compression_level=8\");\n+\tMYSQL_QUERY_T(admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\n+\t{\n+\t\tstring cmp_lvl {};\n+\t\tint rc = get_variable_value(admin, \"mysql-protocol_compression_level\", cmp_lvl, true);\n+\t\tif (rc) { return EXIT_FAILURE; }\n+\t\tok(cmp_lvl == \"8\", \"Runtime Compression level is set correctly: %s\", cmp_lvl.c_str());\n+\t\trc = get_variable_value(admin, \"mysql-protocol_compression_level\", cmp_lvl);\n+\t\tif (rc) { return EXIT_FAILURE; }\n+\t\tok(cmp_lvl == \"8\", \"Compression level is set correctly: %s\", cmp_lvl.c_str());\n \t}\n \n-\tdiff = time_proxy_compression_level_8 - time_proxy_compression_level_default;\n-\tperformance_diff = (float)(diff * 100) / time_proxy_compression_level_default;\n+\tuint64_t proxy_cmp8_time = measure_avg_query_time(proxy_cmp, select_query, fields, 20);\n+\tif (proxy_cmp8_time == 0) { return EXIT_FAILURE; }\n+\n+\tdiag(\"Meassuring MySQL time *WITHOUT* compression\");\n+\tuint64_t mysql_time = measure_avg_query_time(mysql, select_query, fields, 20);\n+\tif (proxy_time == 0) { return EXIT_FAILURE; }\n+\n+\tdiag(\"Meassuring MySQL time *WITH* compression\");\n+\tuint64_t mysql_cmp_time = measure_avg_query_time(mysql_cmp, select_query, fields, 20);\n+\tif (mysql_cmp_time == 0) { return EXIT_FAILURE; }\n+\n+\tdiag(\n+\t\t\"Avg ProxySQL query time   proxy=%lu proxy_cmp_3=%lu proxy_cmp_8=%lu mysql=%lu mysql_cmp=%lu\",\n+\t\tproxy_time, proxy_cmp_time, proxy_cmp8_time, mysql_time, mysql_cmp_time\n+\t);\n+\n+\t// COHERENCE CHECKS\n+\t// ////////////////////////////////////////////////////////////////////////\n+\t// proxy < proxy_cmp(3): Normally this value goes below '200%'. When the value goes above that threshold,\n+\t// isn't because the compressed workload is slower than in other runs, but because the non-compressed load\n+\t// slightly faster than usual. No further investigation have gone into this.\n+\tint rc = check_perf_diff(\"proxysql-proxysql_cmp(3)\", proxy_time, proxy_cmp_time, 350);\n+\tif (rc) { return EXIT_FAILURE; }\n+\n+\t// proxy < proxy_cmp(8): Normally this diff goes below '500%'. See comment for 'proxysql-proxysql_cmp(3)'.\n+\trc = check_perf_diff(\"proxysql-proxysql_cmp(8)\", proxy_time, proxy_cmp8_time, 650);\n+\tif (rc) { return EXIT_FAILURE; }\n+\n+\t// proxy_cmp(3) < proxy_cmp(8)\n+\trc = check_perf_diff(\"proxysql_cmp(3)-proxysql_cmp(8)\", proxy_cmp_time, proxy_cmp8_time, 250);\n+\tif (rc) { return EXIT_FAILURE; }\n+\n+\t// mysql < mysql_cmp: Normally this sits between 305-350. Since this measurement in isolation is the least\n+\t// interesting to us, we give it a bigger threshold.\n+\trc = check_perf_diff(\"mysql-mysql_cmp\", mysql_time, mysql_cmp_time, 550);\n+\tif (rc) { return EXIT_FAILURE; }\n+\n+\t// MYSQL PERF COMPARISONS\n+\t// ////////////////////////////////////////////////////////////////////////\n+\t// proxy < mysql_cmp: Local tests show ProxySQL having at least a '200%' perf diff to MySQL. This\n+\t// measurements can't be reproduced on the CI, as the base 'proxy_time' is slower. The diff is left for\n+\t// further diagnosing.\n+\trc = check_perf_diff(\"proxysql-mysql_cmp\", proxy_time, mysql_cmp_time, -150, true);\n+\n+\t// proxy_cmp < mysql_cmp: Local tests show ProxySQL having at least a '60%' perf diff to MySQL. This\n+\t// measurements can't be reproduced on the CI, as the base 'proxy_time' is slower. But the diff is left\n+\t// for further diagnosing.\n+\trc = check_perf_diff(\"proxysql_cmp-mysql_cmp\", proxy_cmp_time, mysql_cmp_time, -5, true);\n+\tif (rc) { return EXIT_FAILURE; }\n \n-\tok((performance_diff > 0), \"proxysql with default compression level (3) performed well compared to compression level (8). Performance difference: %f percentage\", performance_diff);\n+\t// Recover default query rules\n+\tif (admin) {\n+\t\tMYSQL_QUERY_T(admin, \"UPDATE mysql_query_rules SET active=1\");\n+\t\tMYSQL_QUERY_T(admin, \"LOAD MYSQL QUERY RULES TO RUNTIME\");\n \n-\tset_admin_global_variable(proxysql_admin, \"mysql-protocol_compression_level\", \"3\");\n-\tif (mysql_query(proxysql_admin, \"load mysql variables to runtime\")) {\n-\t\tdiag(\"Failed to load mysql variables to runtime.\");\n-\t\tgoto cleanup;\n-\t}\t\n-\tret = get_variable_value(proxysql_admin, \"mysql-protocol_compression_level\", compression_level, true);\n-\tif (ret == EXIT_SUCCESS) {\n-\t\tok(compression_level == \"3\", \"Run-time Compression level set correctly: %s\", compression_level.c_str());\n-\t}\n-\telse {\n-\t\tdiag(\"Failed to set the Compression level set correctly:\");\n-\t\tgoto cleanup;\n+\t\tMYSQL_QUERY_T(admin, \"SET mysql-protocol_compression_level=3\");\n+\t\tMYSQL_QUERY_T(admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \t}\n \n-\tret = get_variable_value(proxysql_admin, \"mysql-protocol_compression_level\", compression_level);\n-\tif (ret == EXIT_SUCCESS) {\n-\t\tok(compression_level == \"3\", \"Compression level set correctly: %s\", compression_level.c_str());\n+\tif (proxy) {\n+\t\tmysql_close(proxy);\n \t}\n-\telse {\n-\t\tdiag(\"Failed to set the Compression level set correctly:\");\n-\t\tgoto cleanup;\n+\tif (proxy_cmp) {\n+\t\tmysql_close(proxy_cmp);\n \t}\n-\n-cleanup:\n-\t// Recover default query rules\n-\tif (proxysql_admin) {\n-\t\tMYSQL_QUERY(proxysql_admin, \"UPDATE mysql_query_rules SET active=1\");\n-\t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL QUERY RULES TO RUNTIME\");\n+\tif (mysql_cmp) {\n+\t\tmysql_close(mysql_cmp);\n \t}\n-\n-\tif (proxysql)\n-\t\tmysql_close(proxysql);\n-\tif (proxysql_compression)\n-\t\tmysql_close(proxysql_compression);\n-\tif (mysql_compression)\n-\t\tmysql_close(mysql_compression);\n-\tif (mysql)\n+\tif (mysql) {\n \t\tmysql_close(mysql);\n-\tif (proxysql_admin)\n-\t\tmysql_close(proxysql_admin);\n+\t}\n+\tif (admin) {\n+\t\tmysql_close(admin);\n+\t}\n \n \treturn exit_status();\n }\ndiff --git a/test/tap/tests/set_character_set-t.cpp b/test/tap/tests/set_character_set-t.cpp\nindex f208e532f..090101d36 100644\n--- a/test/tap/tests/set_character_set-t.cpp\n+++ b/test/tap/tests/set_character_set-t.cpp\n@@ -13,7 +13,6 @@\n  *   * character_set_client\n  *   * character_set_connection\n  *   * character_set_results\n- *   * character_set_database\n  *\n  *   This checks are performed by means of the query:\n  *\n@@ -48,7 +47,7 @@ int main(int argc, char** argv) {\n \tif(cl.getEnv())\n \t\treturn exit_status();\n \n-\tplan(11);\n+\tplan(8);\n \tdiag(\"Testing SET CHARACTER SET\");\n \n \tMYSQL* mysql = mysql_init(NULL);\n@@ -94,7 +93,6 @@ int main(int argc, char** argv) {\n \tstd::string var_charset_client = \"character_set_client\";\n \tstd::string var_charset_connection = \"character_set_connection\";\n \tstd::string var_charset_results = \"character_set_results\";\n-\tstd::string var_charset_database = \"character_set_database\";\n \tstd::string var_value;\n \n \tshow_variable(mysql, var_charset_client, var_value);\n@@ -106,9 +104,6 @@ int main(int argc, char** argv) {\n \tshow_variable(mysql, var_charset_results, var_value);\n \tok(var_value.compare(\"utf8\") == 0, \"Initial results character set. Actual %s\", var_value.c_str()); // ok_3\n \n-\tshow_variable(mysql, var_charset_database, var_value);\n-\tok(var_value.compare(\"utf8\") == 0, \"Initial database character set. Actual %s\", var_value.c_str()); // ok_4\n-\n \tif (mysql_query(mysql, \"set character set latin1\")) {\n \t    fprintf(stderr, \"SET CHARACTER SET : Error: %s\\n\",\n \t              mysql_error(mysql));\n@@ -118,11 +113,6 @@ int main(int argc, char** argv) {\n \tshow_variable(mysql, var_charset_client, var_value);\n \tok(var_value.compare(\"latin1\") == 0, \"Client character set is changed. Actual %s\", var_value.c_str()); // ok_5\n \n-\tstd::string db_charset_value;\n-\tshow_variable(mysql, var_charset_database, db_charset_value);\n-\n-\tshow_variable(mysql, var_charset_database, var_value);\n-\tok(var_value.compare(\"utf8\") == 0, \"Database character set is not changed. Actual %s\", var_value.c_str()); // ok_6\n \n \t/*\n \t * NOTE: This check was disabled because trying to check 'character_set_connection' after issuing 'SET CHARACTER SET',\n@@ -150,9 +140,6 @@ int main(int argc, char** argv) {\n \tshow_variable(mysql, var_charset_results, var_value);\n \tok(var_value.compare(\"latin1\") == 0, \"Results character set is correct. Actual %s\", var_value.c_str()); // ok_10\n \n-\tshow_variable(mysql, var_charset_database, var_value);\n-\tok(var_value.compare(\"utf8\") == 0, \"Database character set is not changed by set names. Actual %s\", var_value.c_str()); // ok_11\n-\n \tmysql_close(mysql);\n \n \treturn exit_status();\ndiff --git a/test/tap/tests/set_testing-240-t.cpp b/test/tap/tests/set_testing-240-t.cpp\nindex 485c3662a..7100bd4bd 100644\n--- a/test/tap/tests/set_testing-240-t.cpp\n+++ b/test/tap/tests/set_testing-240-t.cpp\n@@ -541,6 +541,7 @@ int main(int argc, char *argv[]) {\n \t\t\tdiag(\"Cannot detect MySQL version\");\n \t\t\treturn exit_status();\n \t\t}\n+\t\tdiag(\"Starting testing for MySQL version   is_mariadb:%d\", is_mariadb);\n \n \t\tif (strcmp(host,\"localhost\")==0) {\n \t\t\tlocal = 1;\ndiff --git a/test/tap/tests/test_backend_conn_ping-t.cpp b/test/tap/tests/test_backend_conn_ping-t.cpp\nindex 123c9205a..ef168455e 100644\n--- a/test/tap/tests/test_backend_conn_ping-t.cpp\n+++ b/test/tap/tests/test_backend_conn_ping-t.cpp\n@@ -59,6 +59,8 @@\n  *   parameters this number is very high, even with extremely low values for `wait_timeout`, like\n  *   `num_threads=4,wait_timeout=60,batch_size=64`, a large number of connections(`15104`) would still be\n  *   maintained without issues. This is what makes this issue an artificial one.\n+ *\n+ *   IMPORTANT: In case of failure see note below on 'wait_timeout' definition.\n  */\n \n #include <string>\n@@ -83,14 +85,8 @@ using srv_cfg = vector<pair<string,int>>;\n \n #define SESSIONS_FOR_CONNECTIONS_HANDLER 64\n \n-// IMPORTANT: We **always** gives ourselves `1` second grace period. Depending on MySQL connection killing\n-// policy for `wait_timeout`, connections could already be killed on the edge of the interval. Also, for extra\n-// safety, we gave `1` extra second to avoid possible rounding errors on time computations within MySQL.\n-uint32_t grace_period = 2;\n-int wait_timeout = 10 + grace_period;\n-\n int max_pinged_conns(uint32_t num_threads, uint32_t ping_interval_server_msec, uint32_t wait_timeout) {\n-\tuint32_t ping_proc_batches = floor((wait_timeout- (grace_period+1))/float(ping_interval_server_msec/1000.0));\n+\tuint32_t ping_proc_batches = floor(wait_timeout/float(ping_interval_server_msec/1000.0));\n \n \treturn (num_threads * SESSIONS_FOR_CONNECTIONS_HANDLER) * ping_proc_batches;\n }\n@@ -508,7 +504,31 @@ int main(int, char**) {\n \t\treturn EXIT_FAILURE;\n \t}\n \n-\tuint32_t max_conns = max_pinged_conns(ext_threads.val, 2000, wait_timeout);\n+\t// IMPORTANT: Previously, this test gave ProxySQL only '1s' margin in the computation of the 'max\n+\t// connections' that can be maintained for the selected 'wait_timeout' interval. While this computation\n+\t// was correct, this could lead to failures due to small network stalls or slowdowns. Meaning that\n+\t// ProxySQL acknowledges the ping for the connection **before** MySQL actual response to it, i.e, the last\n+\t// time the connection was used by ProxySQL can diverge slightly from the time in which MySQL acknowledges\n+\t// the keep-alive. With only '1s' margin, this could result in lost connections for these slowdown\n+\t// scenarios.\n+\t//\n+\t// There are two main reasons to relax this margin. First, this is an artificial scenario created for this\n+\t// test, with a way too low 'wait_timetout', i.e, the real number of connections that ProxySQL can be kept\n+\t// alive with the current pinging algorithm, using a default or sensible 'wait_timeout' for most loads, is\n+\t// too large to even be practical. Secondly, testing this maximum number of connections that can be kept\n+\t// alive isn't the goal of this test, but to ensure correctness in the selection of connections to ping\n+\t// from the connection pool, which can be done with much smaller and less error prone numbers.\n+\t//\n+\t// Due to this, we are going to give a full extra grace interval in the computation for the maximum number\n+\t// of connections that could be kept alive. This should result in creating `(max conns) - (conns pinged in\n+\t// one interval)` connections. This should give enough room for the test not to fail even in the\n+\t// previously described scenarios. If further failures are detected, this **should be investigated** as\n+\t// could mean that something is not working as expected, either in the setup or the pinging algorithm\n+\t// itself.\n+\tint wait_timeout = 10;\n+\tuint32_t grace_timeout = wait_timeout - (ext_ping_intv.val / 1000) - 1;\n+\n+\tuint32_t max_conns = max_pinged_conns(ext_threads.val, ext_ping_intv.val, grace_timeout);\n \tuint32_t server_max_conns = max_conns + 1000;\n \tdouble its = floor((max_conns - b_0) / b);\n \ndiff --git a/test/tap/tests/test_cacert_load_and_verify_duration-t.cpp b/test/tap/tests/test_cacert_load_and_verify_duration-t.cpp\nindex f75b913ee..eece0e554 100644\n--- a/test/tap/tests/test_cacert_load_and_verify_duration-t.cpp\n+++ b/test/tap/tests/test_cacert_load_and_verify_duration-t.cpp\n@@ -1,11 +1,27 @@\n+/**\n+ * @file test_cacert_load_and_verify_duration-t.cpp\n+ * @brief Test for OpenSSL performance regression on certificate loading.\n+ * @details This test uses an internal ProxySQL test checking the following OpenSSL regression regarding\n+ *  certificate loading https://github.com/openssl/openssl/issues/18814. Experimental results from the test\n+ *  using different OpenSSL versions:\n+ *    - openssl=\"3.4.1\" openssl_num=30400010 time='5239 ms'\n+ *    - openssl=\"3.2.0\" openssl_num=30200000 time='5407 ms'\n+ *    - openssl=\"3.1.8\" openssl_num=30100080 time='9152 ms'\n+ *    - openssl=\"3.1.0\" openssl_num=30100000 time='9481 ms'\n+ *    - openssl=\"3.0.16\" openssl_num=30400010 time='18979 ms'\n+ *    - openssl=\"3.0.10\" openssl_num=300000 time='21212 ms'\n+ *    - openssl=\"3.0.2\" openssl_num=30000020 time='47756 ms'\n+ */\n+\n #include <string>\n #include <string.h>\n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n #include \"tap.h\"\n #include \"command_line.h\"\n #include \"utils.h\"\n \n+using std::string;\n+\n CommandLine cl;\n \n int main() {\n@@ -25,9 +41,6 @@ int main() {\n \tplan(1);\n \n \tint32_t WASAN = get_env_int(\"WITHASAN\", 0);\n-\t// Double the value of previously failed ASAN run: '89415ms'\n-\tint32_t EXP_TIME = WASAN == 0 ? 20000 : 180000;\n-\n \tMYSQL* proxysql_admin = mysql_init(NULL);\n \n \t// Initialize connection\n@@ -41,6 +54,45 @@ int main() {\n \t\treturn -1;\n \t}\n \n+\tconst string select_query {\n+\t\t\"SELECT variable_value FROM stats.stats_mysql_global WHERE variable_name='OpenSSL_Version_Num'\"\n+\t}; ext_val_t<int64_t> ssl_ver_ext { mysql_query_ext_val(proxysql_admin, select_query, int64_t(-1)) };\n+    if (ssl_ver_ext.err) {\n+        const string err { get_ext_val_err(proxysql_admin, ssl_ver_ext) };\n+        diag(\"Failed query   query:`%s`, err:`%s`\", select_query.c_str(), err.c_str());\n+        return EXIT_FAILURE;\n+    }\n+\n+\t// OPENSSL_VERSION_NUMBER: 0xMNN00PP0L\n+\t// https://docs.openssl.org/master/man3/OpenSSL_version/\n+\tconst string major { std::to_string(ssl_ver_ext.val >> 28) };\n+\tconst string minor { std::to_string((ssl_ver_ext.val & 0x0FF00000L) >> 20) };\n+\tconst string patch { std::to_string((ssl_ver_ext.val & 0x00000FF0L) >> 4) };\n+\tconst string version { major + \".\" + minor + \".\" + patch };\n+\n+\tdiag(\"Detected env   openssl=\\\"%s\\\" openssl_num=%lx ASAN=%d\", version.c_str(), ssl_ver_ext.val, WASAN);\n+\n+\t// Double the value of previously failed ASAN run, previous known time '89415ms'\n+\tint32_t EXP_TIME = 0;\n+\tconst int64_t OPENSSL_3_0_0 { 0x30000000L };\n+\tconst int64_t OPENSSL_3_2_0 { 0x30200000L };\n+\n+\tif (ssl_ver_ext.val > OPENSSL_3_0_0 && ssl_ver_ext.val < OPENSSL_3_2_0) {\n+\t\tdiag(\"OpenSSL version *AFFECTED* by perf regression (https://github.com/openssl/openssl/issues/18814).\");\n+\t\t// Based on previous run with '61392 ms'. Extra marging for versions with perf-regressions.\n+\t\tEXP_TIME = 80000;\n+\t} else if (ssl_ver_ext.val >= OPENSSL_3_2_0) {\n+\t\tdiag(\"OpenSSL version *NOT* affected by perf regression\");\n+\t\tEXP_TIME = 20000;\n+\t}\n+\n+\tif (WASAN) {\n+\t\tdiag(\"Running under ASAN, doubling expected time\");\n+\t\tEXP_TIME *= 2;\n+\t}\n+\n+\tdiag(\"Computed threshold for test runtime   exp_time=%d\", EXP_TIME);\n+\n \tconst std::string& ca_full_path = std::string(p_infra_datadir) + \"/cert-bundle-rnd.pem\";\n \tdiag(\"Setting mysql-ssl_p2s_ca to '%s'\", ca_full_path.c_str());\n \tconst std::string& set_ssl_p2s_ca = \"SET mysql-ssl_p2s_ca='\" + ca_full_path + \"'\";\ndiff --git a/test/tap/tests/test_query_rules_fast_routing_algorithm-t.cpp b/test/tap/tests/test_query_rules_fast_routing_algorithm-t.cpp\nindex a69844709..1ae41d717 100644\n--- a/test/tap/tests/test_query_rules_fast_routing_algorithm-t.cpp\n+++ b/test/tap/tests/test_query_rules_fast_routing_algorithm-t.cpp\n@@ -36,29 +36,6 @@ using std::vector;\n // Used for 'extract_module_host_port'\n #include \"modules_server_test.h\"\n \n-////////////////////////////////////////////////////////////////////////////////\n-//          Borrowed from test_match_eof_conn_cap.cpp - TODO: MERGE\n-////////////////////////////////////////////////////////////////////////////////\n-\n-#include <dirent.h>\n-\n-#define _S(s) ( std::string {s} )\n-#define _TO_S(s) ( std::to_string(s) )\n-\n-#define SELECT_RUNTIME_VAR \"SELECT variable_value FROM runtime_global_variables WHERE variable_name=\"\n-\n-#define CHECK_EXT_VAL(val)\\\n-\tdo {\\\n-\t\tif (val.err) {\\\n-\t\t\tdiag(\"%s:%d: Query failed   err=\\\"%s\\\"\", __func__, __LINE__, val.str.c_str());\\\n-\t\t\treturn EXIT_FAILURE;\\\n-\t\t}\\\n-\t} while(0)\n-\n-const uint32_t USLEEP_SQLITE_LOCKED = 100;\n-\n-////////////////////////////////////////////////////////////////////////////////\n-\n int get_query_int_res(MYSQL* admin, const string& q, int& val) {\n \tMYSQL_QUERY_T(admin, q.c_str());\n \tMYSQL_RES* myres = mysql_store_result(admin);\ndiff --git a/test/tap/tests/test_utf8mb4_as_ci-4841-t.cpp b/test/tap/tests/test_utf8mb4_as_ci-4841-t.cpp\nindex 63f80e16f..2a0f9dcb8 100644\n--- a/test/tap/tests/test_utf8mb4_as_ci-4841-t.cpp\n+++ b/test/tap/tests/test_utf8mb4_as_ci-4841-t.cpp\n@@ -17,6 +17,10 @@\n #include \"command_line.h\"\n #include \"utils.h\"\n \n+using std::string;\n+\n+const int MYSQL8_HG = get_env_int(\"TAP_MYSQL8_BACKEND_HG\", 30);\n+\n int main(int argc, char** argv) {\n \tCommandLine cl;\n \n@@ -44,11 +48,21 @@ int main(int argc, char** argv) {\n \t\treturn exit_status();\n \t}\n \n-\tstd::string var_collation_connection = \"collation_connection\";\n-\tstd::string var_value;\n+\tconst string select_query {\n+\t\t\"SELECT /* hostgroup=\" + _TO_S(MYSQL8_HG) + \";create_new_connection=1 */ @@collation_connection\"\n+\t};\n+\text_val_t<string> var_ext { mysql_query_ext_val(mysql, select_query, string {}) };\n+\tif (var_ext.err) {\n+\t\tconst string err { get_ext_val_err(mysql, var_ext) };\n+\t\tdiag(\"Failed query   query:`%s`, err:`%s`\", select_query.c_str(), err.c_str());\n+\t\treturn EXIT_FAILURE;\n+\t}\n \n-\tshow_variable(mysql, var_collation_connection, var_value, true);\n-\tok(var_value.compare(\"utf8mb4_0900_as_ci\") == 0, \"collation_connection , Expected utf8mb4_0900_as_ci . Actual %s\", var_value.c_str()); // ok_1\n+\tok(\n+\t\t\"utf8mb4_0900_as_ci\" == var_ext.val,\n+\t\t\"collation_connection , Expected utf8mb4_0900_as_ci . Actual %s\",\n+\t\tvar_ext.val.c_str()\n+\t); // ok_1\n \n \tmysql_close(mysql);\n \n", "problem_statement": "Display a warning message for problematic OpenSSL versions\nIn ProxySQL 3.0 we stopped using statically linked OpenSSL in favor of dynamically linked.\nThis also means that an outdated version of OpenSSL can considerably slowdown ProxySQL.\nFor example, in a CI run where OpenSSL 3.0.2 is installed, the test `test_cacert_load_and_verify_duration-t` fails with:\n```\nmsg: not ok 1 - 2025-02-14 22:49:32.351206 - Total duration is '60871 ms' should be less than 20 Seconds\n```\n\nI think we need to take a series of actions:\n* [ ] export via status variables what OpenSSL version is in use\n* [ ] test `test_cacert_load_and_verify_duration-t` should check OpenSSL version using such variable, and adjust the time threshold\n* [ ] When ProxySQL prints the OpenSSL version (ex: `[INFO] Using OpenSSL version: OpenSSL 3.0.2 15 Mar 2022`) it should also display a warning for problematic known OpenSSL versions\n\n\nNote:\nMaybe (not sure) issue #4828 is related to OpenSSL version too\n", "hints_text": "", "created_at": "2025-03-21 15:37:44", "merge_commit_sha": "a876b1f055105d5fb010a2ce1a7e85015cd23543", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["CI-builds / builds (ubuntu22,-tap-asan)", ".github/workflows/CI-trigger.yml"], ["CI-builds / builds (opensuse15,-clang)", ".github/workflows/CI-trigger.yml"], ["CI-builds / builds (debian12,)", ".github/workflows/CI-trigger.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4859", "base_commit": "4f878a44cf7149757caaa89b7fa5964b3fb53153", "patch": "diff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex 41c21783f..38b2c954c 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -4048,7 +4048,7 @@ int MySQL_Session::get_pkts_from_client(bool& wrong_pass, PtrSize_t& pkt) {\n \t\t\t\t\t\t\t\t\tconst uint32_t recv_query_sz { pkt.size - 5 };\n \n \t\t\t\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_MYSQL_COM, 5, \"Processing received query\"\n-\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=%s query=%.*s\\n\",\n+\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=\\\"%s\\\" query=\\\"%.*s\\\"\\n\",\n \t\t\t\t\t\t\t\t\t\tthis, session_type, schemaname ? schemaname : \"\", recv_query_sz, recv_query\n \t\t\t\t\t\t\t\t\t);\n \t\t\t\t\t\t\t\t}\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex af6b7bb87..88890c456 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -1682,20 +1682,24 @@ bool ProxySQL_Admin::GenericRefreshStatistics(const char *query_no_space, unsign\n \t\t}\n \t\t//pthread_mutex_unlock(&admin_mutex);\n \t}\n-\tif (\n-\t\tstats_mysql_processlist || stats_mysql_connection_pool || stats_mysql_connection_pool_reset ||\n-\t\tstats_mysql_query_digest || stats_mysql_query_digest_reset || stats_mysql_errors ||\n-\t\tstats_mysql_errors_reset || stats_mysql_global || stats_memory_metrics || \n-\t\tstats_mysql_commands_counters || stats_mysql_query_rules || stats_mysql_users ||\n-\t\tstats_mysql_gtid_executed || stats_mysql_free_connections || \n-\t\tstats_pgsql_global || stats_pgsql_connection_pool || stats_pgsql_connection_pool_reset ||\n-\t\tstats_pgsql_free_connections || stats_pgsql_users || stats_pgsql_processlist ||\n-\t\tstats_pgsql_errors || stats_pgsql_errors_reset || stats_pgsql_query_rules || stats_pgsql_commands_counters ||\n-\t\tstats_pgsql_query_digest || stats_pgsql_query_digest_reset\n-\t) {\n-\t\tret = true;\n+\n+\tint freelist_count = statsdb->return_one_int(\"PRAGMA freelist_count\");\n+\tif (freelist_count < 1000) {\n+\t\tret = false;\n+\t} else {\n+\t\tint page_count  = statsdb->return_one_int(\"PRAGMA page_count\");\n+\t\tret = (freelist_count * 100 / page_count) > 20;\n+\n+#ifdef DEBUG\n+\t\tif (ret) {\n+\t\t\tproxy_debug(PROXY_DEBUG_ADMIN, 4,\n+\t\t\t\t\"VACUUM required for 'stats_db'   page_count=%d freelist_count=%d\\n\",\n+\t\t\t\tpage_count, freelist_count\n+\t\t\t);\n+\t\t}\n+#endif\n \t}\n-\t\n+\n \treturn ret;\n }\n \ndiff --git a/lib/ProxySQL_Admin_Stats.cpp b/lib/ProxySQL_Admin_Stats.cpp\nindex 6de28f52f..c6b477f93 100644\n--- a/lib/ProxySQL_Admin_Stats.cpp\n+++ b/lib/ProxySQL_Admin_Stats.cpp\n@@ -428,163 +428,170 @@ void ProxySQL_Admin::p_update_stmt_metrics() {\n \t}\n }\n \n+using row_bind_t = void (*)(int offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row);\n+\n+void sqlite3_bulk_step(\n+\tSQLite3DB* db,\n+\tsqlite3_stmt* row_stmt,\n+\tsqlite3_stmt* bulk_stmt,\n+\tSQLite3_result* resultset,\n+\trow_bind_t row_bind\n+) {\n+\tint max_bulk_row_idx = resultset->rows_count / 32;\n+\tmax_bulk_row_idx = max_bulk_row_idx * 32;\n+\n+\tint rc = 0;\n+\tint row_idx = 0;\n+\n+\tfor (SQLite3_row* row : resultset->rows) {\n+\t\tint e_idx = row_idx % 32;\n+\n+\t\tif (row_idx < max_bulk_row_idx) {\n+\t\t\trow_bind(e_idx, db, bulk_stmt, row);\n+\n+\t\t\tif (e_idx == 31) {\n+\t\t\t\tSAFE_SQLITE3_STEP2(bulk_stmt);\n+\t\t\t\trc = (*proxy_sqlite3_clear_bindings)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t\trc = (*proxy_sqlite3_reset)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t}\n+\t\t} else {\n+\t\t\trow_bind(0, db, row_stmt, row);\n+\n+\t\t\tSAFE_SQLITE3_STEP2(row_stmt);\n+\t\t\trc = (*proxy_sqlite3_clear_bindings)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\trc = (*proxy_sqlite3_reset)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t}\n+\n+\t\trow_idx += 1;\n+\t}\n+}\n+\n+void stats_mysql_global___bind_row(\n+\tint offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row\n+) {\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 1, row->fields[0], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 2, row->fields[1], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+}\n+\n+template <class...> constexpr std::false_type always_false {};\n+\n+template <typename T>\n+const void sqlite3_global_stats_row_step(\n+\tSQLite3DB* db, sqlite3_stmt* stmt, const char* name, T val\n+) {\n+\tchar buf[32] = { 0 };\n+\n+\tif constexpr (std::is_same_v<T, int32_t>)  {\n+\t\tsprintf(buf, \"%d\", val);\n+\t} else if constexpr (std::is_same_v<T, uint64_t>) {\n+\t\tsprintf(buf, \"%lu\", val);\n+\t} else if constexpr (std::is_same_v<T, unsigned long long>) {\n+\t\tsprintf(buf, \"%llu\", val);\n+\t} else if constexpr (std::is_same_v<T, bool>) {\n+\t\tsprintf(buf, \"%s\", val ? \"true\" : \"false\");\n+\t} else {\n+\t\tstatic_assert(always_false<T>, \"Non-exhaustive switch\");\n+\t}\n+\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, 1, name, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, 2, buf, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\n+\tSAFE_SQLITE3_STEP2(stmt);\n+\trc = (*proxy_sqlite3_clear_bindings)(stmt); ASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_reset)(stmt); ASSERT_SQLITE_OK(rc, db);\n+};\n+\n void ProxySQL_Admin::stats___mysql_global() {\n \tif (!GloMTH) return;\n \tSQLite3_result * resultset=GloMTH->SQL3_GlobalStatus(true);\n \tif (resultset==NULL) return;\n+\n \tstatsdb->execute(\"BEGIN\");\n \tstatsdb->execute(\"DELETE FROM stats_mysql_global\");\n-\tchar *a=(char *)\"INSERT INTO stats_mysql_global VALUES (\\\"%s\\\",\\\"%s\\\")\";\n-\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\tSQLite3_row *r=*it;\n-\t\tint arg_len=0;\n-\t\tfor (int i=0; i<2; i++) {\n-\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t}\n-\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n+\n+\tconst string q_row_insert { \"INSERT INTO stats_mysql_global VALUES (?1, ?2)\" };\n+\tconst string q_bulk_insert {\n+\t\t\"INSERT INTO stats_mysql_global VALUES \" + generate_multi_rows_query(32, 2)\n+\t};\n+\n+\tsqlite3_stmt* row_stmt = nullptr;\n+\tint rc = statsdb->prepare_v2(q_row_insert.c_str(), &row_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\tsqlite3_stmt* bulk_stmt = nullptr;\n+\trc = statsdb->prepare_v2(q_bulk_insert.c_str(), &bulk_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\n+\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n+\n \tdelete resultset;\n \tresultset=NULL;\n \n \tresultset=MyHGM->SQL3_Get_ConnPool_Stats();\n+\n \tif (resultset) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n-\tint highwater;\n-\tint current;\n-\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n-\tchar bu[32];\n-\tchar *vn=NULL;\n-\tchar *query=NULL;\n-\tvn=(char *)\"SQLite3_memory_bytes\";\n-\tsprintf(bu,\"%d\",current);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tint highwater, current = 0;\n+\t\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"SQLite3_memory_bytes\", current);\n+\t}\n \n-\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n-\tvn=(char *)\"ConnPool_memory_bytes\";\n-\tsprintf(bu,\"%llu\",connpool_mem);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"ConnPool_memory_bytes\", connpool_mem);\n+\t}\n \n \tif (GloMyStmt) {\n-\t\tuint64_t stmt_client_active_unique = 0;\n-\t\tuint64_t stmt_client_active_total = 0;\n-\t\tuint64_t stmt_max_stmt_id = 0;\n-\t\tuint64_t stmt_cached = 0;\n-\t\tuint64_t stmt_server_active_unique = 0;\n-\t\tuint64_t stmt_server_active_total = 0;\n-\t\tGloMyStmt->get_metrics(&stmt_client_active_unique,&stmt_client_active_total,&stmt_max_stmt_id,&stmt_cached,&stmt_server_active_unique,&stmt_server_active_total);\n-\t\tvn=(char *)\"Stmt_Client_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Client_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Max_Stmt_id\";\n-\t\tsprintf(bu,\"%lu\",stmt_max_stmt_id);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Cached\";\n-\t\tsprintf(bu,\"%lu\",stmt_cached);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tuint64_t client_active_unique = 0;\n+\t\tuint64_t client_active_total = 0;\n+\t\tuint64_t max_stmt_id = 0;\n+\t\tuint64_t cached = 0;\n+\t\tuint64_t server_active_unique = 0;\n+\t\tuint64_t server_active_total = 0;\n+\n+\t\tGloMyStmt->get_metrics(\n+\t\t\t&client_active_unique,\n+\t\t\t&client_active_total,\n+\t\t\t&max_stmt_id,\n+\t\t\t&cached,\n+\t\t\t&server_active_unique,\n+\t\t\t&server_active_total\n+\t\t);\n+\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Total\", client_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Unique\", client_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Total\", server_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Unique\", server_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Max_Stmt_id\", max_stmt_id);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Cached\", cached);\n \t}\n \n \tif (GloMyQC && (resultset= GloMyQC->SQL3_getStats())) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n \tif (GloMyLdapAuth) {\n \t\tresultset=GloMyLdapAuth->SQL3_getStats();\n-\t\tif (resultset) {\n-\t\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\t\tSQLite3_row *r=*it;\n-\t\t\t\tint arg_len=0;\n-\t\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t\t}\n-\t\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\t\tstatsdb->execute(query);\n-\t\t\t\tfree(query);\n-\t\t\t}\n-\t\t\tdelete resultset;\n-\t\t\tresultset=NULL;\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t}\n \n \tif (GloMyQPro) {\n \t\tunsigned long long mu = GloMyQPro->get_new_req_conns_count();\n-\t\tvn=(char *)\"new_req_conns_count\";\n-\t\tsprintf(bu,\"%llu\",mu);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n-\t{\n-\t\tvn=(char *)\"mysql_listener_paused\";\n-\t\tsprintf(bu, \"%s\", ( admin_proxysql_mysql_paused==true ? \"true\" : \"false\") );\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"new_req_conns_count\", mu);\n \t}\n+\n+\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"mysql_listener_paused\", admin_proxysql_mysql_paused);\n+\n \tstatsdb->execute(\"COMMIT\");\n }\n \n", "test_patch": "diff --git a/test/tap/tap/utils.cpp b/test/tap/tap/utils.cpp\nindex 5821da27e..e6f27fc0f 100644\n--- a/test/tap/tap/utils.cpp\n+++ b/test/tap/tap/utils.cpp\n@@ -1114,8 +1114,11 @@ int get_proxysql_cpu_usage(const CommandLine& cl, double& cpu_usage, uint32_t in\n \t\tsleep(1);\n \t}\n \n-\tMYSQL_QUERY(admin, \"SELECT * FROM system_cpu ORDER BY timestamp DESC LIMIT 2\");\n-\tMYSQL_RES* admin_res = mysql_store_result(admin);\n+\tMYSQL_QUERY(admin, \"SELECT * FROM system_cpu ORDER BY timestamp DESC LIMIT 5\");\n+\tMYSQL_RES* admin_res { mysql_store_result(admin) };\n+\tconst string sys_cpu_str { dump_as_table(admin_res) };\n+\tdiag(\"Dumping latest 5 entries from 'system_cpu':\\n%s\", sys_cpu_str.c_str());\n+\n \tMYSQL_ROW row = mysql_fetch_row(admin_res);\n \n \tdouble s_clk = (1000.0 / sysconf(_SC_CLK_TCK));\n", "problem_statement": "Prevent unnecessary `VACUUM` executions for SQLite3 `stats` database\n## Description\n\nWhile profiling several queries commonly received by Admin targeting `stats` database, like queries from other `ProxySQL` instances regarding `Cluster`, it was found that one of the biggest contributions to CPU utilization for serving those queries is a `VACUUM` that is performed after the query execution.\n\nMany times this `VACUUM` is performed after queries that are idempotent on tables that won't benefit at all of this subsequent operation. This is an extract of a `perf` report:\n\n- Query: `SELECT Variable_Name, Variable_Value FROM stats_mysql_global`\n- Report extract:\n  ```\n  -   88.56%     0.01%  Admin            proxysql              [.] void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n     - 88.55% void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n        + 45.64% ProxySQL_Admin::vacuum_stats(bool)\n        + 32.01% SQLite3DB::execute_statement(char const*, char**, int*, int*, SQLite3_result**)\n        + 9.94% ProxySQL_Admin::GenericRefreshStatistics(char const*, unsigned int, bool)\n        + 0.87% SQLite3_result::~SQLite3_result()\n  ```\n\nThese `VACUUM` operations should be more selective, or performed when the database is going to benefit of the operation.\n", "hints_text": "", "created_at": "2025-03-08 14:35:02", "merge_commit_sha": "a9bdf5462a20ef3d69a126ff94d5211cc3087f76", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["CI-builds / builds (ubuntu22,-tap-asan)", ".github/workflows/CI-trigger.yml"], ["CI-builds / builds (opensuse15,-clang)", ".github/workflows/CI-trigger.yml"], ["CI-builds / builds (debian12,)", ".github/workflows/CI-trigger.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4605", "base_commit": "01d1fc9828a5da09896acd2287be48335bbc1ada", "patch": "diff --git a/include/set_parser.h b/include/set_parser.h\nindex 5421868342..bd89bbab22 100644\n--- a/include/set_parser.h\n+++ b/include/set_parser.h\n@@ -42,6 +42,12 @@ class SetParser {\n \t// First implemenation of the parser for TRANSACTION ISOLATION LEVEL and TRANSACTION READ/WRITE\n \tstd::map<std::string, std::vector<std::string>> parse2();\n \tstd::string parse_character_set();\n+\tstd::string parse_USE_query();\n+\tstd::string remove_comments(const std::string& q);\n+#ifdef DEBUG\n+\t// built-in testing\n+\tvoid test_parse_USE_query();\n+#endif // DEBUG\n \t~SetParser();\n };\n \ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex b40d922539..42930c9b92 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -6138,30 +6138,27 @@ void MySQL_Session::handler___status_WAITING_CLIENT_DATA___STATE_SLEEP___MYSQL_C\n \tif (session_type == PROXYSQL_SESSION_MYSQL) {\n \t\t__sync_fetch_and_add(&MyHGM->status.frontend_use_db, 1);\n \t\tstring nq=string((char *)pkt->ptr+sizeof(mysql_hdr)+1,pkt->size-sizeof(mysql_hdr)-1);\n-\t\tRE2::GlobalReplace(&nq,(char *)\"(?U)/\\\\*.*\\\\*/\",(char *)\" \");\n-\t\tchar *sn_tmp = (char *)nq.c_str();\n-\t\twhile (sn_tmp < ( nq.c_str() + nq.length() - 4 ) && *sn_tmp == ' ')\n-\t\t\tsn_tmp++;\n-\t\t//char *schemaname=strdup(nq.c_str()+4);\n-\t\tchar *schemaname=strdup(sn_tmp+3);\n-\t\tchar *schemanameptr=trim_spaces_and_quotes_in_place(schemaname);\n-\t\t// handle cases like \"USE `schemaname`\n-\t\tif(schemanameptr[0]=='`' && schemanameptr[strlen(schemanameptr)-1]=='`') {\n-\t\t\tschemanameptr[strlen(schemanameptr)-1]='\\0';\n-\t\t\tschemanameptr++;\n-\t\t}\n-\t\tclient_myds->myconn->userinfo->set_schemaname(schemanameptr,strlen(schemanameptr));\n-\t\tfree(schemaname);\n-\t\tif (mirror==false) {\n+\t\tSetParser parser(nq);\n+\t\tstring schemaname = parser.parse_USE_query();\n+\t\tif (schemaname != \"\") {\n+\t\t\tclient_myds->myconn->userinfo->set_schemaname((char *)schemaname.c_str(),schemaname.length());\n+\t\t\tif (mirror==false) {\n+\t\t\t\tRequestEnd(NULL);\n+\t\t\t}\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tunsigned int nTrx=NumActiveTransactions();\n+\t\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n+\t\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n+\t\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n+\t\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n+\t\t} else {\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tstd::string msg = \"Unable to parse: \" + nq;\n+\t\t\tclient_myds->myprot.generate_pkt_ERR(true,NULL,NULL,client_myds->pkt_sid+1,1148,(char *)\"42000\", msg.c_str());\n \t\t\tRequestEnd(NULL);\n \t\t}\n-\t\tl_free(pkt->size,pkt->ptr);\n-\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n-\t\tunsigned int nTrx=NumActiveTransactions();\n-\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n-\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n-\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n-\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n \t\tclient_myds->DSS=STATE_SLEEP;\n \t} else {\n \t\tl_free(pkt->size,pkt->ptr);\ndiff --git a/lib/set_parser.cpp b/lib/set_parser.cpp\nindex 521808d642..7abef9adf1 100644\n--- a/lib/set_parser.cpp\n+++ b/lib/set_parser.cpp\n@@ -3,9 +3,11 @@\n #include <string>\n #include <vector>\n #include <map>\n-#ifdef PARSERDEBUG\n+#include <cassert>\n+#include <utility> // for std::pair\n+//#ifdef PARSERDEBUG\n #include <iostream>\n-#endif\n+//#endif\n \n using namespace std;\n \n@@ -506,3 +508,148 @@ std::string SetParser::parse_character_set() {\n \treturn value4;\n }\n \n+std::string SetParser::parse_USE_query() {\n+#ifdef DEBUG\n+\tproxy_debug(PROXY_DEBUG_MYSQL_QUERY_PROCESSOR, 4, \"Parsing query %s\\n\", query.c_str());\n+#endif // DEBUG\n+\n+\tre2::RE2::Options opt2(RE2::Quiet);\n+\topt2.set_case_sensitive(false);\n+\topt2.set_longest_match(false);\n+\n+\tstd::string dbname = remove_comments(query);\n+\tre2::RE2 re0(\"^\\\\s*\", opt2);\n+\tre2::RE2::Replace(&dbname, re0, \"\");\n+\tif (dbname.size() >= 4) {\n+\t\tif (\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE \",4) == 0\n+\t\t\t||\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE`\",4) == 0\n+\t\t) {\n+\t\t\tre2::RE2 re1(\"^USE\\\\s*\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re1, \"\");\n+\t\t\tre2::RE2 re2(\"\\\\s*$\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re2, \"\");\n+\t\t\tif (dbname[0] == '`') {\n+\t\t\t\tif (dbname.length() > 2) {\n+\t\t\t\t\tif (dbname[dbname.length()-1] == '`') {\n+\t\t\t\t\t\t// Remove the first character\n+\t\t\t\t\t\tdbname.erase(0, 1);\n+\t\t\t\t\t\t// Remove the last character\n+\t\t\t\t\t\tdbname.erase(dbname.length() - 1);\n+\t\t\t\t\t\treturn dbname;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\treturn dbname;\n+\t\t\t}\n+\t\t}\n+\t} else {\n+\t\treturn \"\";\n+\t}\n+\n+\treturn \"\";\n+}\n+\n+\n+std::string SetParser::remove_comments(const std::string& q) {\n+    std::string result = \"\";\n+    bool in_multiline_comment = false;\n+\n+    for (size_t i = 0; i < query.size(); ++i) {\n+        char current_char = query[i];\n+\n+        // Check for multiline comment start\n+        if (current_char == '/' && i + 1 < query.size() && query[i + 1] == '*') {\n+            in_multiline_comment = true;\n+            i++; // Skip the '*'\n+            continue;\n+        }   \n+\n+        // Check for multiline comment end\n+        if (in_multiline_comment && current_char == '*' && i + 1 < query.size() && query[i + 1] == '/') {\n+            in_multiline_comment = false;\n+            i++; // Skip the '/'\n+            continue;\n+        }   \n+\n+        // Skip characters inside multiline comment\n+        if (in_multiline_comment) {\n+            continue;\n+        }\n+\n+        // Check for single-line comments\n+        if (current_char == '#' || (current_char == '-' && i + 1 < query.size() && query[i + 1] == '-')) {\n+            // Skip until the end of the line\n+            while (i < query.size() && query[i] != '\\n') {\n+                i++;\n+            }\n+            continue;\n+        }\n+\n+        // Append the character to the result if it's not a comment\n+        result += current_char;\n+    }\n+\n+    return result;\n+}\n+\n+\n+#ifdef DEBUG\n+void SetParser::test_parse_USE_query() {\n+\n+\t// Define vector of pairs (query, expected dbname)\n+\tstd::vector<std::pair<std::string, std::string>> testCases = {\n+\t\t{\"USE my_database\",    \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database\",  \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database \", \"my_database\"},                   // Basic Case\n+\t\t{\"/* comment */USE dbname /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */   USE   dbname\",            \"dbname\"}, // With Comments\n+\t\t{\"USE    dbname           /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */USE `dbname` /* comment */\", \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE`dbname` /* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment */\", \"dbname\"}, // Multiline Comment\n+\t\t{\"/* comment */USE dbname # comment\",       \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname -- comment\",      \"dbname\"}, // Double Dash Comment\n+\t\t{\"/* comment */USE dbname   # comment\",     \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname    -- comment\",   \"dbname\"}, // Double Dash Comment\n+\t\t{\"USE dbname   # comment\",                  \"dbname\"}, // Hash Comment\n+\t\t{\"USE dbname    -- comment\",                \"dbname\"}, // Double Dash Comment\n+\t\t{\"SELECT * FROM my_table\", \"\"}, // No match\n+\t\t{\"/*+ placeholder_comment */ USE test_use_comment\", \"test_use_comment\"},\n+\n+\t\t{\"USE /*+ placeholder_comment */ `test_use_comment-a1`\",  \"test_use_comment-a1\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment_1`\", \"test_use_comment_1\"},\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment_2`\",    \"test_use_comment_2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment_3`\",    \"test_use_comment_3\"},\n+\t\t{\"USE /*+ placeholder_comment */   test_use_comment_4\",   \"test_use_comment_4\"},\n+\t\t{\"USE/*+ placeholder_comment */ test_use_comment_5\",      \"test_use_comment_5\"},\n+\t\t{\"USE /*+ placeholder_comment */test_use_comment_6\",      \"test_use_comment_6\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment-1`\", \"test_use_comment-1\"},\n+\t\t{\"use my_database\", \"my_database\"},\n+\t\t{\"/* comment */  use dbname -- comment\",        \"dbname\"},\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment\\nmultiline comment */\", \"dbname\"}, // Multiline Comment\n+\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment-2`\",      \"test_use_comment-2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment-3`\",      \"test_use_comment-3\"},\n+\t\t{\"/*+ placeholder_comment */USE      `test_use_comment-4`\", \"test_use_comment-4\"},\n+\t\t{\"USE/*+ placeholder_comment */`test_use_comment-5`\",       \"test_use_comment-5\"},\n+\t\t{\"/* comment */USE`test_use_comment-6`\",                    \"test_use_comment-6\"},\n+\t\t{\"USE`test_use_comment-7`\",                                 \"test_use_comment-7\"},\n+\t};\n+\n+\t// Run tests for each pair\n+\tfor (const auto& p : testCases) {\n+\t\tset_query(p.first);\n+\t\tstd::string dbname = parse_USE_query();\n+\t\tif (dbname != p.second) {\n+\t\t\t// we call parse_USE_query() again just to make it easier to create a breakpoint\n+\t\t\tstd::string s = parse_USE_query();\n+\t\t\tassert(s == p.second);\n+\t\t}\n+\t}\n+\n+}\n+#endif // DEBUG\ndiff --git a/src/main.cpp b/src/main.cpp\nindex c30a6bd999..d98743a604 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1976,6 +1976,13 @@ int main(int argc, const char * argv[]) {\n //\t\tstd::cerr << \"Main init phase0 completed in \";\n #endif\n \t}\n+#ifdef DEBUG\n+\t{\n+\t\t// Automated testing\n+\t\tSetParser parser(\"\");\n+\t\tparser.test_parse_USE_query();\n+\t}\n+#endif // DEBUG\n \t{\n \t\tcpu_timer t;\n \t\tProxySQL_Main_process_global_variables(argc, argv);\n", "test_patch": "", "problem_statement": "Not ignoring comments on \"use database\" statements\nI find that the following works as expected:\r\n\r\n    use db /* COMMENT */\r\n\r\nit will connect to the database `db`.\r\n\r\nHowever, if there is a newline in the comment:\r\n\r\n    use db /*\r\n       COMMENT */\r\n\r\nit will try to switch to the database `db /* COMMENT */`, which obviously not what should happen. \r\n\r\nThe other types of comment aren't ignored either:\r\n\r\n    use db -- COMMENT\r\n    use db # COMMENT\r\n\r\nresult in attempts to switch to database `db -- COMMENT` and `db # COMMENT`.\r\n\r\nI have not seen this issue with other statements than the `use` statement, but I haven't done an exhaustive search.\n", "hints_text": "Hi @Abigail,\r\n\r\nthe issue template is not a form to scrap and replace with free-writing. There are several details required to follow up on this, all of them missing, but that would be present if the template was filled. When opening an issue, please, at least make sure the points on the issue template are filled.\r\n\r\nThanks, Javier.\nSorry, I don't know all the details being asked.\r\n\r\nYou can just ignore my bug report, or, alternatively, investigate the regexp on line 6139 of `lib/MySQL_Session.cpp`. The regexp is:\r\n```\r\n     /\\\\*.*\\\\*/\r\n```\r\nwhich is problematic in three ways:\r\n1. `.` matches any character, but a newline.\r\n2. The regexp is too greedy, meaning that if you have two comments on the same line (like `SQL1 /* comment */ SQL2 /* comment */`) it replaces the code between the comments (replacing `/* comment */ SQL2 /* comment */` by a space).\r\n3. It doesn't match `-- ` or `#` style comments.\r\n\r\nMay I suggest something like\r\n```\r\n     (?:(?:#|--(?=\\s))[^\\n]*\\n|/\\*(?:(?>[^*]+)|\\*(?!/))*(?:;|\\*/))\r\n```\r\ninstead?\nHi @Abigail,\r\n\r\n> You can just ignore my bug report, or, alternatively, investigate the regexp on line 6139 of lib/MySQL_Session.cpp. The regexp is:\r\n\r\nWhat an interesting wording you used, I find myself at a crossroads, only two ways ahead! I understand this is your *not so nice* way of presenting your findings. Let me be clear, my request was not because there was the need of extra info for a regular contributor to find the **obvious** cause of the behavior, or to change a simple regex, into a **sightly** more complex one. A couple of `git blames` would tell you that the change was intentional, and that the behavior is well known, and was changed like this by design for the time being. Giving you more context, for several parsing related issues, we solve the most common and pressing cases, and (this has changed overtime) we might take a different approach for fixing these kind of parsing issues all together, or *maybe*, while waiting for this more ideal solution, we might use more complex regexes (like the one you provided).\r\n\r\nThe point of asking those details, as you can probably guess, is procedural. Those details are generic, and help with issue categorization, even without knowledge of the codebase, something that universal and common to all projects (even outside software). So please, just for the sake of curiosity, and maybe improving the template, which one of this highly technical details, was not possible to share?\r\n\r\n```\r\nIf you are submitting a reproducible bug report, please provide:\r\n- [ ] A clear description of the issue  // you already did this\r\n- [ ] ProxySQL version // ??\r\n- [ ] OS version // ??\r\n- [ ] The steps to reproduce the issue // ??\r\n- [ ] The **full** ProxySQL error log (default location: `/var/lib/proxysql/proxysql.log`) // copy paste?\r\n```\r\n\r\nRegards, Javier.", "created_at": "2024-08-12 20:26:45", "merge_commit_sha": "050907efa9e537dc9b9e6d3b3f777d384a589df8", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["builds (testreadonly)", ".github/workflows/CI-maketest.yml"], ["select (ubuntu22-tap, mysql57)", ".github/workflows/CI-taptests-groups.yml"], ["builds (testaurora)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (debian11)", ".github/workflows/CI-builds.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-laravel-framework.yml"], ["builds (testall)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-mysql-connector-j.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (testgalera)", ".github/workflows/CI-maketest.yml"], ["Analyze (ubuntu22-tap, python)", ".github/workflows/CI-codeql.yml"], ["builds (ubuntu16)", ".github/workflows/CI-builds.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-basictests.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-selftests.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-php-pdo-mysql.yml"], ["test (debian11, mariadb10)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (ubuntu22, -clang)", ".github/workflows/CI-builds.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-django-framework.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4588", "base_commit": "27e71d29729c67cbaf6beafcb3a3b4eeca7ab9b4", "patch": "diff --git a/include/MySQL_Variables.h b/include/MySQL_Variables.h\nindex 678d594a06..4d0aa5c8a9 100644\n--- a/include/MySQL_Variables.h\n+++ b/include/MySQL_Variables.h\n@@ -20,6 +20,7 @@ bool update_server_variable(MySQL_Session* session, int idx, int &_rc);\n bool verify_server_variable(MySQL_Session* session, int idx, uint32_t client_hash, uint32_t server_hash);\n bool verify_set_names(MySQL_Session* session);\n bool logbin_update_server_variable(MySQL_Session* session, int idx, int &_rc);\n+bool is_perm_track_err(int err, const char* varname);\n \n class MySQL_Variables {\n \tstatic verify_var verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/include/proxysql.h b/include/proxysql.h\nindex 90c881d414..8b6d1d4d50 100644\n--- a/include/proxysql.h\n+++ b/include/proxysql.h\n@@ -117,6 +117,10 @@ void proxy_info_(const char* msg, ...);\n #ifdef DEBUG\n void init_debug_struct();\n void init_debug_struct_from_cmdline();\n+/**\n+ * @brief Add a debug entry in the error log. To be used through 'proxy_debug' macro.\n+ * @details This function saves/restores the previous 'errno' value.\n+ */\n __attribute__((__format__ (__printf__, 7, 8)))\n void proxy_debug_func(enum debug_module, int, int, const char *, int, const char *, const char *, ...);\n void proxy_debug_get_filters(std::set<std::string>&);\ndiff --git a/include/proxysql_structs.h b/include/proxysql_structs.h\nindex f3d322305c..deac187de0 100644\n--- a/include/proxysql_structs.h\n+++ b/include/proxysql_structs.h\n@@ -277,6 +277,11 @@ typedef struct {\n \tchar * default_value;       // default value\n \tbool is_global_variable;\t// is it a global variable?\n } mysql_variable_st;\n+\n+typedef struct {\n+\tint err;\n+\tconst char* name;\n+} var_track_err_st;\n #endif\n \n enum mysql_data_stream_status {\n@@ -1218,10 +1223,9 @@ mysql_variable_st mysql_tracked_variables[] {\n \tsession_track_system_variables\n \tsession_track_transaction_info\n \t*/\n-\n-\n };\n #else\n extern mysql_variable_st mysql_tracked_variables[];\n+extern var_track_err_st perm_track_errs[];\n #endif // PROXYSQL_EXTERN\n #endif // MYSQL_TRACKED_VARIABLES\ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex ae306e36e4..b40d922539 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -2974,6 +2974,8 @@ bool MySQL_Session::handler_again___status_SETTING_GENERIC_VARIABLE(int *_rc, co\n \t\t\t\t\t(myerr == 1193) // variable is not found\n \t\t\t\t\t||\n \t\t\t\t\t(myerr == 1651) // Query cache is disabled\n+\t\t\t\t\t||\n+\t\t\t\t\t(is_perm_track_err(myerr, var_name)) // Special permitted tracking errors (~= '1193')\n \t\t\t\t) {\n \t\t\t\t\tint idx = SQL_NAME_LAST_HIGH_WM;\n \t\t\t\t\tfor (int i=0; i<SQL_NAME_LAST_HIGH_WM; i++) {\ndiff --git a/lib/MySQL_Variables.cpp b/lib/MySQL_Variables.cpp\nindex 6f5c1f0481..c0df467820 100644\n--- a/lib/MySQL_Variables.cpp\n+++ b/lib/MySQL_Variables.cpp\n@@ -9,6 +9,7 @@\n #endif\n \n #include <sstream>\n+#include \"mysqld_error.h\"\n \n \n static inline char is_digit(char c) {\n@@ -17,6 +18,23 @@ static inline char is_digit(char c) {\n \treturn 0;\n }\n \n+var_track_err_st perm_track_errs[] {\n+\t// ERROR 1210 (HY000): Variable not supported in combination with Galera:\n+\t// - Changed by MySQL, previously 'ER_UNKNOWN_SYSTEM_VARIABLE'\n+\t{ ER_WRONG_ARGUMENTS, \"sql_generate_invisible_primary_key\" }\n+};\n+\n+bool is_perm_track_err(int err, const char* varname) {\n+\tconst size_t count = sizeof(perm_track_errs) / sizeof(var_track_err_st);\n+\n+\tfor (size_t i = 0; i < count; i++) {\n+\t\tif (perm_track_errs[i].err == err && (strcasecmp(varname, perm_track_errs[i].name) == 0)) {\n+\t\t\treturn true;\n+\t\t}\n+\t}\n+\treturn false;\n+}\n+\n #include \"proxysql_find_charset.h\"\n \n verify_var MySQL_Variables::verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex a98d7669db..709ae3492b 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -153,7 +153,8 @@ static void BQE1(SQLite3DB *db, const vector<string>& tbs, const string& p1, con\n }\n \n \n-static int round_intv_to_time_interval(int& intv) {\n+static int round_intv_to_time_interval(const char* name, int _intv) {\n+\tint intv = _intv;\n \tif (intv > 300) {\n \t\tintv = 600;\n \t} else {\n@@ -181,6 +182,9 @@ static int round_intv_to_time_interval(int& intv) {\n \t\t\t}\n \t\t}\n \t}\n+\tif (intv != _intv) {\n+\t\tproxy_warning(\"Variable '%s' rounded to interval '%d'\\n\", name, intv);\n+\t}\n \treturn intv;\n }\n \n@@ -8686,7 +8690,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connection_pool\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connection_pool=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connection_pool=intv;\n \t\t\t\treturn true;\n@@ -8697,7 +8701,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connections\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connections=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connections=intv;\n \t\t\t\treturn true;\n@@ -8708,7 +8712,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_query_cache\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_query_cache=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_query_cache=intv;\n \t\t\t\treturn true;\n@@ -8729,7 +8733,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_cpu\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_cpu=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_cpu=intv;\n \t\t\t\treturn true;\n@@ -8741,7 +8745,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_memory\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_memory=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_memory=intv;\n \t\t\t\treturn true;\ndiff --git a/lib/debug.cpp b/lib/debug.cpp\nindex e4eda648f5..4f3755c9c0 100644\n--- a/lib/debug.cpp\n+++ b/lib/debug.cpp\n@@ -131,15 +131,22 @@ void proxy_debug_load_filters(std::set<std::string>& f) {\n \t//pthread_mutex_unlock(&debug_mutex);\n }\n \n+// REMINDER: This function should always save/restore 'errno', otherwise it could influence error handling.\n void proxy_debug_func(enum debug_module module, int verbosity, int thr, const char *__file, int __line, const char *__func, const char *fmt, ...) {\n+\tint saved_errno = errno;\n \tassert(module<PROXY_DEBUG_UNKNOWN);\n \tif (pretime == 0) { // never initialized\n \t\tpretime=realtime_time();\n \t}\n-\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity)\n+\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity) {\n+\t\terrno = saved_errno;\n \t\treturn;\n-\tif (filter_debug_entry(__file, __line, __func)) // check if the entry must be filtered\n+\t}\n+\t// check if the entry must be filtered\n+\tif (filter_debug_entry(__file, __line, __func)) {\n+\t\terrno = saved_errno;\n \t\treturn;\n+\t}\n \tchar origdebugbuff[DEBUG_MSG_MAXSIZE];\n \tchar debugbuff[DEBUG_MSG_MAXSIZE];\n \tchar longdebugbuff[DEBUG_MSG_MAXSIZE*8];\n@@ -243,6 +250,8 @@ void proxy_debug_func(enum debug_module module, int verbosity, int thr, const ch\n \tpthread_mutex_unlock(&debug_mutex);\n \tif (curtime != 0)\n \t\tpretime=curtime;\n+\n+\terrno = saved_errno;\n };\n #endif\n \ndiff --git a/lib/mysql_connection.cpp b/lib/mysql_connection.cpp\nindex 53b47cc7c4..8ae6a85f5c 100644\n--- a/lib/mysql_connection.cpp\n+++ b/lib/mysql_connection.cpp\n@@ -1252,6 +1252,14 @@ MDB_ASYNC_ST MySQL_Connection::handler(short event) {\n \t\t\t//if (parent->use_ssl) {\n \t\t\t{\n \t\t\t\t// mariadb client library disables NONBLOCK for SSL connections ... re-enable it!\n+\t\t\t\t// CONTEXT: This shouldn't be confused with the previous incompatibility that 'mariadbclient'\n+\t\t\t\t// had between the NONBLOCK flags and SSL connections, and that was reported and solved via\n+\t\t\t\t// CONC-320, our patch for this incompatibility was dropped on connector upgrade for v2.0.9.\n+\t\t\t\t// Setting the socket back to NONBLOCK is SAFE. This is because a connection can be used for\n+\t\t\t\t// BOTH blocking and not blocking calls, as described here:\n+\t\t\t\t// - https://mariadb.com/kb/en/using-the-non-blocking-library/#mixing-blocking-and-non-blocking-operation\n+\t\t\t\t// In case of SSL connections, it's still required to set the socket back to NONBLOCK prior to\n+\t\t\t\t// non-blockig calls.\n \t\t\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n \t\t\t\tint f=fcntl(mysql->net.fd, F_GETFL);\n #ifdef FD_CLOEXEC\ndiff --git a/lib/mysql_data_stream.cpp b/lib/mysql_data_stream.cpp\nindex 3ff6e5da44..a45e77dc93 100644\n--- a/lib/mysql_data_stream.cpp\n+++ b/lib/mysql_data_stream.cpp\n@@ -570,9 +570,7 @@ int MySQL_Data_Stream::read_from_net() {\n \n \tint r=0;\n \tint s=queue_available(queueIN);\n-\tif (encrypted) {\n-\t//\tproxy_info(\"Queue available of %d bytes\\n\", s);\n-\t}\n+\n \tif (encrypted == false) {\n \t\tif (pkts_recv) {\n \t\t\tr = recv(fd, queue_w_ptr(queueIN), s, 0);\n@@ -592,41 +590,24 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t}\n \t\t}\n \t} else { // encrypted == true\n-/*\n-\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\tint ret = SSL_do_handshake(ssl);\n-\t\t\tint ret2;\n-\t\t\tif (ret != 1) {\n-\t\t\t\t//ERR_print_errors_fp(stderr);\n-\t\t\t\tret2 = SSL_get_error(ssl, ret);\n-\t\t\t\tfprintf(stderr,\"%d\\n\",ret2);\n-\t\t\t}\n-\t\t\treturn 0;\n-\t\t} else {\n-\t\t\tr = SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t}\n-*/\n \t\tPROXY_TRACE();\n \t\tif (s < MY_SSL_BUFFER) {\n \t\t\treturn 0;\t// no enough space for reads\n \t\t}\n \t\tchar buf[MY_SSL_BUFFER];\n-\t\t//ssize_t n = read(fd, buf, sizeof(buf));\n-\t\tint n = recv(fd, buf, sizeof(buf), 0);\n-\t\t//proxy_info(\"SSL recv of %d bytes\\n\", n);\n-\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, n,  rbio_ssl->num_write , rbio_ssl->num_read);\n-\t\tif (n > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n-\t\t\t//on_read_cb(buf, (size_t)n);\n+\t\tint ssl_recv_bytes = recv(fd, buf, sizeof(buf), 0);\n+\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, ssl_recv_bytes,  rbio_ssl->num_write , rbio_ssl->num_read);\n \n+\t\tif (ssl_recv_bytes > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n \t\t\tchar buf2[MY_SSL_BUFFER];\n \t\t\tint n2;\n \t\t\tenum sslstatus status;\n \t\t\tchar *src = buf;\n-\t\t\tint len = n;\n+\t\t\tint len = ssl_recv_bytes;\n \t\t\twhile (len > 0) {\n \t\t\t\tn2 = BIO_write(rbio_ssl, src, len);\n \t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: write %d bytes into BIO %p, len=%d\\n\", sess, n2, rbio_ssl, len);\n-\t\t\t\t//proxy_info(\"BIO_write with len = %d and %d bytes\\n\", len , n2);\n+\n \t\t\t\tif (n2 <= 0) {\n \t\t\t\t\tshut_soft();\n \t\t\t\t\treturn -1;\n@@ -634,40 +615,29 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\tsrc += n2;\n \t\t\t\tlen -= n2;\n \t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished NOT completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\tif (do_ssl_handshake() == SSLSTATUS_FAIL) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished failed!!\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake failed   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\tshut_soft();\n \t\t\t\t\t\treturn -1;\n \t\t\t\t\t}\n \t\t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished yet NOT completed\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\treturn 0;\n \t\t\t\t\t}\n \t\t\t\t} else {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake finished   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t}\n \t\t\t}\n \t\t\tn2 = SSL_read (ssl, queue_w_ptr(queueIN), s);\n \t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from BIO %p into a buffer with %d bytes free\\n\", sess, n2, rbio_ssl, s);\n \t\t\tr = n2;\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n-\t\t\tif (n2 > 0) {\n-\t\t\t}\n-/*\n-\t\t\tdo {\n-\t\t\t\tn2 = SSL_read(ssl, buf2, sizeof(buf2));\n-\t\t\t\tif (n2 > 0) {\n-\t\t\t\t\t\n-\t\t\t\t}\n-\t\t\t} while (n > 0);\n-*/\n \t\t\tstatus = get_sslstatus(ssl, n2);\n-\t\t\t//proxy_info(\"SSL status = %d\\n\", status);\n+\n \t\t\tif (status == SSLSTATUS_WANT_IO) {\n \t\t\t\tdo {\n \t\t\t\t\tn2 = BIO_read(wbio_ssl, buf2, sizeof(buf2));\n-\t\t\t\t\t//proxy_info(\"BIO_read with %d bytes\\n\", n2);\n+\n \t\t\t\t\tif (n2 > 0) {\n           \t\t\t\tqueue_encrypted_bytes(buf2, n2);\n \t\t\t\t\t} else if (!BIO_should_retry(wbio_ssl)) {\n@@ -681,14 +651,18 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\treturn -1;\n \t\t\t}\n \t\t} else {\n-\t\t\tr = n;\n-\t\t\t//r += SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n+\t\t\t// Shutdown if we either received the EOF, or operation failed with non-retryable error.\n+\t\t\tif (ssl_recv_bytes==0 || (ssl_recv_bytes==-1 && errno != EINTR && errno != EAGAIN)) {\n+\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Received EOF, shutting down soft socket -- Session=%p, Datastream=%p\\n\", sess, this);\n+\t\t\t\tshut_soft();\n+\t\t\t\treturn -1;\n+\t\t\t}\n+\t\t\tr = ssl_recv_bytes;\n \t\t}\n \t}\n-//__exit_read_from_next:\n+\n \tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from fd %d into a buffer of %d bytes free\\n\", sess, r, fd, s);\n-\t//proxy_error(\"read %d bytes from fd %d into a buffer of %d bytes free\\n\", r, fd, s);\n+\n \tif (r < 1) {\n \t\tif (encrypted==false) {\n \t\t\tint myds_errno=errno;\n", "test_patch": "diff --git a/test/tap/tap/tap.cpp b/test/tap/tap/tap.cpp\nindex b067432a2d..5270516f87 100644\n--- a/test/tap/tap/tap.cpp\n+++ b/test/tap/tap/tap.cpp\n@@ -20,7 +20,6 @@\n \n #include \"tap.h\"\n \n-//#include \"my_global.h\"\n typedef char my_bool;\n \n #include <stdlib.h>\n@@ -28,8 +27,13 @@ typedef char my_bool;\n #include <stdio.h>\n #include <string.h>\n #include <signal.h>\n+#include <time.h>\n #include <unistd.h>\n \n+#include <sys/time.h>\n+\n+using std::size_t;\n+\n static ulong start_timer(void);\n static void end_timer(ulong start_time,char *buff);\n static void nice_time(double sec,char *buff,my_bool part_second);\n@@ -68,6 +72,34 @@ static TEST_DATA g_test = { NO_PLAN, 0, 0, \"\" };\n  */\n #define tapout stdout\n \n+/**\n+  @brief Writes current time (\"%Y-%m-%d %H:%M:%S\") in the supplied buffer.\n+\n+  @param tm_buf Buffer to be written.\n+  @param us True for enabling microseconds in log output.\n+  @param len Buffer len.\n+ */\n+size_t get_fmt_time(char* tm_buf, size_t len, bool us=false) {\n+  time_t __timer;\n+  time(&__timer);\n+  struct tm __tm_info {};\n+  localtime_r(&__timer, &__tm_info);\n+  size_t rc = strftime(tm_buf, len, \"%Y-%m-%d %H:%M:%S\", &__tm_info);\n+\n+  if (rc == 0) {\n+    return rc;\n+  } else if (us) {\n+    struct timeval tv;\n+    struct tm *tm_info;\n+\n+    gettimeofday(&tv, NULL);\n+    tm_info = localtime(&tv.tv_sec);\n+    rc = snprintf(tm_buf + rc, len - rc, \".%06ld\", tv.tv_usec);\n+  }\n+\n+  return rc;\n+}\n+\n /**\n   Emit the beginning of a test line, that is: \"(not) ok\", test number,\n   and description.\n@@ -85,9 +117,12 @@ static TEST_DATA g_test = { NO_PLAN, 0, 0, \"\" };\n static void\n vemit_tap(int pass, char const *fmt, va_list ap)\n {\n-  fprintf(tapout, \"%sok %d%s\",\n+  char tm_buf[28] = { 0 };\n+  get_fmt_time(tm_buf, sizeof(tm_buf), __sync_add_and_fetch(&tap_log_us, 0));\n+  fprintf(tapout, \"%sok %d - %s%s\",\n           pass ? \"\" : \"not \",\n           __sync_add_and_fetch(&g_test.last, 1),\n+          tm_buf,\n           (fmt && *fmt) ? \" - \" : \"\");\n   if (fmt && *fmt)\n     vfprintf(tapout, fmt, ap);\n@@ -156,7 +191,9 @@ diag(char const *fmt, ...)\n {\n   va_list ap;\n   va_start(ap, fmt);\n-  fprintf(tapout, \"# \");\n+  char tm_buf[28] = { 0 };\n+  get_fmt_time(tm_buf, sizeof(tm_buf), __sync_add_and_fetch(&tap_log_us, 0));\n+  fprintf(tapout, \"# %s  \", tm_buf);\n   vfprintf(tapout, fmt, ap);\n   emit_endl();\n   va_end(ap);\n@@ -192,6 +229,7 @@ static signal_entry install_signal[]= {\n };\n \n int skip_big_tests= 1;\n+volatile int tap_log_us = 1;\n ulong start_time= 0;\n \n void\ndiff --git a/test/tap/tap/tap.h b/test/tap/tap/tap.h\nindex 7678c1a390..f40dad0e9b 100644\n--- a/test/tap/tap/tap.h\n+++ b/test/tap/tap/tap.h\n@@ -78,6 +78,10 @@ extern \"C\" {\n    @see SKIP_BIG_TESTS\n */\n extern int skip_big_tests;\n+/**\n+ * @brief Specifies if time logging should include microseconds; either 1 or 0.\n+ */\n+extern volatile int tap_log_us;\n \n /**\n   @defgroup MyTAP_API MyTAP API\ndiff --git a/test/tap/tap/utils.cpp b/test/tap/tap/utils.cpp\nindex d55e3521c0..b192d9544f 100644\n--- a/test/tap/tap/utils.cpp\n+++ b/test/tap/tap/utils.cpp\n@@ -187,6 +187,45 @@ my_bool mysql_stmt_close_override(MYSQL_STMT* stmt, const char* file, int line)\n \n #endif\n \n+pair<int,vector<MYSQL*>> disable_core_nodes_scheduler(CommandLine& cl, MYSQL* admin) {\n+\tvector<MYSQL*> nodes_conns {};\n+\n+\tpair<int,vector<srv_addr_t>> nodes_fetch { fetch_cluster_nodes(admin, true) };\n+\tif (nodes_fetch.first) {\n+\t\tdiag(\"Failed to fetch cluster nodes. Aborting further testing\");\n+\t\treturn { EXIT_FAILURE, {} };\n+\t}\n+\n+\t// Ensure a more idle status for ProxySQL\n+\tfor (const srv_addr_t& node : nodes_fetch.second) {\n+\t\tconst char* user { cl.admin_username };\n+\t\tconst char* pass { cl.admin_password };\n+\n+\t\tMYSQL* myconn = mysql_init(NULL);\n+\n+\t\tif (!mysql_real_connect(myconn, node.host.c_str(), user, pass, NULL, node.port, NULL, 0)) {\n+\t\t\tdiag(\n+\t\t\t\t\"Failed to connect to Cluster node. Abort further testing\"\n+\t\t\t\t\"   host=%s port=%d errno=%d error='%s'\",\n+\t\t\t\tnode.host.c_str(), node.port, mysql_errno(myconn), mysql_error(myconn)\n+\t\t\t);\n+\t\t\treturn { EXIT_FAILURE, {} };\n+\t\t}\n+\n+\t\tconst vector<const char*> queries { \"DELETE FROM scheduler\", \"LOAD SCHEDULER TO RUNTIME\" };\n+\t\tfor (const char* q : queries) {\n+\t\t\tif (mysql_query_t(myconn, q)) {\n+\t\t\t\tdiag(\"Failed to execute query   query=%s error='%s'\", q, mysql_error(myconn));\n+\t\t\t\treturn { EXIT_FAILURE, {} };\n+\t\t\t}\n+\t\t}\n+\n+\t\tnodes_conns.push_back(myconn);\n+\t}\n+\n+\treturn { EXIT_SUCCESS, nodes_conns };\n+}\n+\n std::size_t count_matches(const string& str, const string& substr) {\n \tstd::size_t result = 0;\n \tstd::size_t pos = 0;\n@@ -199,8 +238,8 @@ std::size_t count_matches(const string& str, const string& substr) {\n \treturn result;\n }\n \n-int mysql_query_t(MYSQL* mysql, const char* query) {\n-\tdiag(\"%s: Issuing query '%s' to ('%s':%d)\", get_formatted_time().c_str(), query, mysql->host, mysql->port);\n+int mysql_query_t__(MYSQL* mysql, const char* query, const char* f, int ln, const char* fn) {\n+\tdiag(\"%s:%d:%s(): Issuing query '%s' to ('%s':%d)\", f, ln, fn, query, mysql->host, mysql->port);\n \treturn mysql_query(mysql, query);\n }\n \n@@ -946,20 +985,71 @@ string tap_curtime() {\n }\n \n int get_proxysql_cpu_usage(const CommandLine& cl, uint32_t intv, double& cpu_usage) {\n-\t// check if proxysql process is consuming higher cpu than it should\n+\t// Create Admin connection\n \tMYSQL* proxysql_admin = mysql_init(NULL);\n \tif (!mysql_real_connect(proxysql_admin, cl.host, cl.admin_username, cl.admin_password, NULL, cl.admin_port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxysql_admin));\n \t\treturn EXIT_FAILURE;\n \t}\n \n-\t// recover admin variables\n-\tstring set_stats_query { \"SET admin-stats_system_cpu=\" + std::to_string(intv) };\n+\t// Set new interval\n+\tconst string set_stats_query { \"SET admin-stats_system_cpu=\" + std::to_string(intv) };\n \tMYSQL_QUERY(proxysql_admin, set_stats_query.c_str());\n \tMYSQL_QUERY(proxysql_admin, \"LOAD ADMIN VARIABLES TO RUNTIME\");\n \n+\t// Wait until 'system_cpu' is filled with newer entries\n+\ttime_t curtime = time(NULL);\n+\tuint32_t entry_count { 0 };\n+\n+\tconst char runtime_stats[] {\n+\t\t\"SELECT variable_value FROM runtime_global_variables WHERE variable_name='admin-stats_system_cpu'\"\n+\t};\n+\text_val_t<int> ext_rintv { mysql_query_ext_val(proxysql_admin, runtime_stats, 10) };\n+\tif (ext_rintv.err != EXIT_SUCCESS) {\n+\t\tconst string err { get_ext_val_err(proxysql_admin, ext_rintv) };\n+\t\tdiag(\"Failed query   query:`%s`, err:`%s`\", runtime_stats, err.c_str());\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tif (ext_rintv.val != intv) {\n+\t\tdiag(\n+\t\t\t\"WARNING: Supplied interval not available, using rounded value   intv=%d rintv=%d\",\n+\t\t\tintv, ext_rintv.val\n+\t\t);\n+\t}\n+\n \t// sleep during the required interval + safe threshold\n-\tsleep(2 * intv + 2);\n+\tconst uint32_t init_wait = 2 * ext_rintv.val + 2;\n+\tdiag(\"Waiting for %d secs for new 'system_cpu' entries...   curtime=%ld\", init_wait, curtime);\n+\tsleep(init_wait);\n+\n+\tconst string count_query {\n+\t\t\"SELECT COUNT(*) FROM system_cpu WHERE timestamp > \" + std::to_string(curtime)\n+\t};\n+\text_val_t<int> ext_stats_count { mysql_query_ext_val(proxysql_admin, count_query, 10) };\n+\n+\tif (ext_stats_count.err != EXIT_SUCCESS) {\n+\t\tconst string err { get_ext_val_err(proxysql_admin, ext_stats_count) };\n+\t\tdiag(\"Failed query   query:`%s`, err:`%s`\", count_query.c_str(), err.c_str());\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tentry_count = ext_stats_count.val;\n+\tdiag(\"Finished initial wait for 'system_cpu'   entry_count=%d\", entry_count);\n+\n+\twhile (entry_count < 2) {\n+\t\tdiag(\"Waiting for more 'system_cpu' entries...   entry_count=%d\", entry_count);\n+\t\text_val_t<int> ext_stats_count { mysql_query_ext_val(proxysql_admin, count_query, 10) };\n+\n+\t\tif (ext_stats_count.err != EXIT_SUCCESS) {\n+\t\t\tconst string err { get_ext_val_err(proxysql_admin, ext_stats_count) };\n+\t\t\tdiag(\"Failed query   query:`%s`, err:`%s`\", count_query.c_str(), err.c_str());\n+\t\t\treturn EXIT_FAILURE;\n+\t\t}\n+\n+\t\tentry_count = ext_stats_count.val;\n+\t\tsleep(1);\n+\t}\n \n \tMYSQL_QUERY(proxysql_admin, \"SELECT * FROM system_cpu ORDER BY timestamp DESC LIMIT 2\");\n \tMYSQL_RES* admin_res = mysql_store_result(proxysql_admin);\n@@ -977,7 +1067,7 @@ int get_proxysql_cpu_usage(const CommandLine& cl, uint32_t intv, double& cpu_usa\n \tint init_stime_s = atoi(row[2]) * s_clk;\n \tint init_t_s = init_utime_s + init_stime_s;\n \n-\tcpu_usage = 100.0 * ((final_t_s - init_t_s) / (static_cast<double>(intv) * 1000));\n+\tcpu_usage = 100.0 * ((final_t_s - init_t_s) / (static_cast<double>(ext_rintv.val) * 1000));\n \n \t// free the result\n \tmysql_free_result(admin_res);\n@@ -1690,42 +1780,49 @@ pair<int,pool_state_t> fetch_conn_stats(MYSQL* admin, const vector<uint32_t> hgs\n \t}\n }\n \n-int wait_for_cond(MYSQL* mysql, const std::string& query, uint32_t timeout) {\n-\tint result = EXIT_FAILURE;\n+int check_cond(MYSQL* mysql, const string& q) {\n+\tdiag(\"Checking condition '%s' in ('%s':%d)\", q.c_str(), mysql->host, mysql->port);\n \n-\tauto start = std::chrono::system_clock::now();\n-\tstd::chrono::duration<double> elapsed {};\n+\tint rc = mysql_query(mysql, q.c_str());\n+\tint res = 1;\n \n-\twhile (elapsed.count() < timeout && result == EXIT_FAILURE) {\n-\t\tint rc = mysql_query(mysql, query.c_str());\n-\t\tfprintf(\n-\t\t\tstderr, \"# %s: Waiting for condition '%s' in ('%s':%d)\\n\",\n-\t\t\tget_formatted_time().c_str(), query.c_str(), mysql->host, mysql->port\n-\t\t);\n+\tif (rc == 0) {\n+\t\tMYSQL_RES* myres = mysql_store_result(mysql);\n \n-\t\tif (rc == EXIT_SUCCESS) {\n-\t\t\tMYSQL_RES* myres = mysql_store_result(mysql);\n-\t\t\tif (myres) {\n-\t\t\t\tuint32_t field_num = mysql_num_fields(myres);\n-\t\t\t\tuint32_t row_num = mysql_num_rows(myres);\n+\t\tif (myres) {\n+\t\t\tuint32_t field_num = mysql_num_fields(myres);\n+\t\t\tuint32_t row_num = mysql_num_rows(myres);\n \n-\t\t\t\tif (field_num == 1 && row_num == 1) {\n-\t\t\t\t\tMYSQL_ROW row = mysql_fetch_row(myres);\n+\t\t\tif (field_num == 1 && row_num == 1) {\n+\t\t\t\tMYSQL_ROW myrow = mysql_fetch_row(myres);\n \n-\t\t\t\t\tif (row && strcasecmp(\"TRUE\", row[0]) == 0) {\n-\t\t\t\t\t\tresult = EXIT_SUCCESS;\n-\t\t\t\t\t}\n+\t\t\t\tif (myrow && strcasecmp(\"TRUE\", myrow[0]) == 0) {\n+\t\t\t\t\tres = 0;\n+\t\t\t\t} else if (myrow && atoi(myrow[0]) >= 1) {\n+\t\t\t\t\tres = 0;\n \t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t} else {\n+\t\tdiag(\"Check failed with error '%s'\", mysql_error(mysql));\n+\t\tres = -1;\n+\t}\n \n-\t\t\t\tmysql_free_result(myres);\n+\treturn res;\n+}\n \n-\t\t\t\tif (result == EXIT_SUCCESS) {\n-\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t} else {\n-\t\t\tdiag(\"Condition query failed with error: ('%d','%s')\", mysql_errno(mysql), mysql_error(mysql));\n-\t\t\tresult = EXIT_FAILURE;\n+int wait_for_cond(MYSQL* mysql, const string& q, uint32_t to) {\n+\tdiag(\"Waiting for condition '%s' in ('%s':%d)\", q.c_str(), mysql->host, mysql->port);\n+\n+\tint result = 1;\n+\tstd::chrono::duration<double> elapsed {};\n+\n+\tauto start = std::chrono::system_clock::now();\n+\n+\twhile (elapsed.count() < to && result == EXIT_FAILURE) {\n+\t\tresult = check_cond(mysql, q);\n+\n+\t\tif (result == 0 || result == -1) {\n \t\t\tbreak;\n \t\t}\n \n@@ -1738,6 +1835,74 @@ int wait_for_cond(MYSQL* mysql, const std::string& query, uint32_t timeout) {\n \treturn result;\n }\n \n+vector<check_res_t> wait_for_conds(MYSQL* mysql, const vector<string>& qs, uint32_t to) {\n+\tdiag(\"Waiting multiple conditions in ('%s':%d):\", mysql->host, mysql->port);\n+\tfor (const string& q : qs) {\n+\t\tdiag(\"  - cond: '%s'\", q.c_str());\n+\t}\n+\n+\tstd::chrono::duration<double> elapsed {};\n+\n+\tvector<check_res_t> res {};\n+\tstd::transform(qs.begin(), qs.end(), std::back_inserter(res),\n+\t\t[] (const string& q) {\n+\t\t\treturn check_res_t { 1, q };\n+\t\t}\n+\t);\n+\tauto start = std::chrono::system_clock::now();\n+\n+\twhile (elapsed.count() < to) {\n+\t\tint chk_res = 0;\n+\n+\t\tfor (std::size_t i = 0; i < qs.size(); i++) {\n+\t\t\tchk_res = check_cond(mysql, qs[i]);\n+\n+\t\t\tif (chk_res == -1) {\n+\t\t\t\tdiag(\"Error during query. Aborting further checks\");\n+\t\t\t\tres[i].first = -1;\n+\t\t\t\tbreak;\n+\t\t\t} else if (chk_res == 0) {\n+\t\t\t\tres[i].first = 0;\n+\t\t\t}\n+\t\t}\n+\n+\t\tint acc = std::accumulate(res.begin(), res.end(), size_t(0),\n+\t\t\t[] (size_t acc, const check_res_t& p) -> size_t {\n+\t\t\t\tif (p.first == 0) {\n+\t\t\t\t\treturn acc + 1;\n+\t\t\t\t} else {\n+\t\t\t\t\treturn acc;\n+\t\t\t\t}\n+\t\t\t});\n+\n+\t\tif (acc == qs.size() || chk_res == -1) {\n+\t\t\tbreak;\n+\t\t} else {\n+\t\t\tusleep(500 * 1000);\n+\t\t\tauto it_end = std::chrono::system_clock::now();\n+\t\t\telapsed = it_end - start;\n+\t\t}\n+\t}\n+\n+\treturn res;\n+}\n+\n+int proc_wait_checks(const vector<check_res_t>& chks) {\n+\tint res = 0;\n+\n+\tfor (const check_res_t& r : chks) {\n+\t\tif (r.first == -1) {\n+\t\t\tres = -1;\n+\t\t\tdiag(\"Waiting check FAILED to execute '%s'\", r.second.c_str());\n+\t\t} else if (r.first == 1)  {\n+\t\t\tres = res == 0 ? 1 : res;\n+\t\t\tdiag(\"Waiting check TIMEOUT '%s'\", r.second.c_str());\n+\t\t}\n+\t}\n+\n+\treturn res;\n+}\n+\n void check_conn_count(MYSQL* admin, const string& conn_type, uint32_t conn_num, int32_t hg) {\n \tconst string hg_s { to_string(hg) };\n \tconst string conn_num_s { to_string(conn_num) };\n@@ -1807,8 +1972,67 @@ void check_query_count(MYSQL* admin, vector<uint32_t> queries, uint32_t hg) {\n \t}\n };\n \n-const char* get_env_str(const char* envname, const char* envdefault) {\n+pair<int,vector<srv_addr_t>> fetch_cluster_nodes(MYSQL* admin, bool dump_fetch) {\n+\tint rc = mysql_query_t(admin, \"SELECT hostname,port FROM proxysql_servers\");\n+\tif (rc) { return { static_cast<int>(mysql_errno(admin)), {} }; }\n \n+\tMYSQL_RES* myres = mysql_store_result(admin);\n+\tif (myres == NULL) {\n+\t\tdiag(\"Storing resultset failed   error='%s'\", mysql_error(admin));\n+\t\treturn { static_cast<int>(mysql_errno(admin)), {} };\n+\t}\n+\n+\tif (dump_fetch) {\n+\t\tconst string res_table { dump_as_table(myres) };\n+\t\tdiag(\"Dumping fetched cluster nodes:\");\n+\n+\t\tprintf(\"%s\", res_table.c_str());\n+\t}\n+\n+\tvector<mysql_res_row> nodes_rows { extract_mysql_rows(myres) };\n+\tmysql_free_result(myres);\n+\n+\tvector<srv_addr_t> nodes {};\n+\tstd::transform(nodes_rows.begin(), nodes_rows.end(), std::back_inserter(nodes),\n+\t\t[] (const mysql_res_row& row) {\n+\t\t\treturn srv_addr_t { row[0], std::atoi(row[1].c_str()) };\n+\t\t}\n+\t);\n+\n+\treturn { 0, nodes };\n+}\n+\n+int check_nodes_sync(\n+\tconst CommandLine& cl, const vector<srv_addr_t>& nodes, const string& check, uint32_t to\n+) {\n+\tfor (const auto& node : nodes) {\n+\t\tMYSQL* admin = mysql_init(NULL);\n+\n+\t\tif (\n+\t\t\t!mysql_real_connect(\n+\t\t\t\tadmin, node.host.c_str(), cl.admin_username, cl.admin_password, NULL, node.port, NULL, 0\n+\t\t\t)\n+\t\t) {\n+\t\t\tdiag(\"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(admin));\n+\t\t\treturn EXIT_FAILURE;\n+\t\t}\n+\n+\t\tconst vector<check_res_t> wres { wait_for_conds(admin, { check }, to) };\n+\t\tint node_sync = proc_wait_checks(wres);\n+\n+\t\tif (node_sync != EXIT_SUCCESS) {\n+\t\t\tconst string err { \"Node '\" + node.host + \":\" + std::to_string(node.port) + \"' sync timed out\" };\n+\t\t\tdiag(\"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, err.c_str());\n+\t\t\treturn EXIT_FAILURE;\n+\t\t}\n+\n+\t\tmysql_close(admin);\n+\t}\n+\n+\treturn EXIT_SUCCESS;\n+}\n+\n+const char* get_env_str(const char* envname, const char* envdefault) {\n \tconst char* envval = std::getenv(envname);\n \n \tif (envval != NULL)\n@@ -1818,13 +2042,11 @@ const char* get_env_str(const char* envname, const char* envdefault) {\n };\n \n int get_env_int(const char* envname, int envdefault) {\n-\n \tconst char* envval = std::getenv(envname);\n \tint res = envdefault;\n \n \tif (envval != NULL)\n \t\tres = strtol(envval, NULL, 0);\n-//\tdiag(\"%s: %s='%s' >>> %d\", __FUNCTION__, envname, envval, res);\n \n \treturn res;\n };\n@@ -1852,7 +2074,5 @@ bool get_env_bool(const char* envname, bool envdefault) {\n \t\t}\n \t}\n \n-//\tdiag(\"%s: %s='%s' >>> %d\", __FUNCTION__, envname, envval, res);\n-\n \treturn (bool) res;\n };\ndiff --git a/test/tap/tap/utils.h b/test/tap/tap/utils.h\nindex 0b918b0d06..d88182442b 100644\n--- a/test/tap/tap/utils.h\n+++ b/test/tap/tap/utils.h\n@@ -56,6 +56,18 @@ my_bool mysql_stmt_close_override(MYSQL_STMT* stmt, const char* file, int line);\n \n #endif \n \n+/**\n+ * @brief Helper function to disable Core nodes scheduler from ProxySQL Cluster nodes.\n+ * @details In the CI environment, 'Scheduler' is used to induce extra load via Admin interface on\n+ *  all the cluster nodes. Disabling this allows for more accurate measurements on the primary.\n+ * @param cl CommandLine arguments supplied to the test.\n+ * @param admin Already opened Admin conn to the primary instance.\n+ * @return On success, the opened Admin connections to the Core nodes used to change their config,\n+ *  these conns should later be used to restore their original config. On failure, a pair of shape\n+ *  '{ EXIT_FAILURE, {} }'.\n+ */\n+std::pair<int,std::vector<MYSQL*>> disable_core_nodes_scheduler(CommandLine& cl, MYSQL* admin);\n+\n inline std::string get_formatted_time() {\n \ttime_t __timer;\n \tchar __buffer[30];\n@@ -68,7 +80,18 @@ inline std::string get_formatted_time() {\n \treturn std::string(__buffer);\n }\n \n-int mysql_query_t(MYSQL* mysql, const char* query);\n+/**\n+ * @brief Wrapper for 'mysql_query' with logging for convenience.\n+ * @details Should be used through 'mysql_query_t' macro.\n+ * @return Result of calling 'mysql_query'.\n+ */\n+int mysql_query_t__(MYSQL* mysql, const char* query, const char* f, int ln, const char* fn);\n+\n+/**\n+ * @brief Convenience macro with query logging.\n+ */\n+#define mysql_query_t(mysql, query)\\\n+\tmysql_query_t__(mysql, query, __FILE__, __LINE__, __func__)\n \n #define MYSQL_QUERY(mysql, query) \\\n \tdo { \\\n@@ -89,8 +112,7 @@ int mysql_query_t(MYSQL* mysql, const char* query);\n \n #define MYSQL_QUERY_T(mysql, query) \\\n \tdo { \\\n-\t\tconst std::string time { get_formatted_time() }; \\\n-\t\tfprintf(stderr, \"# %s: Issuing query '%s' to ('%s':%d)\\n\", time.c_str(), query, mysql->host, mysql->port); \\\n+\t\tdiag(\"Issuing query '%s' to ('%s':%d)\", query, mysql->host, mysql->port); \\\n \t\tif (mysql_query(mysql, query)) { \\\n \t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(mysql)); \\\n \t\t\treturn EXIT_FAILURE; \\\n@@ -220,7 +242,7 @@ std::string get_ext_val_err(MYSQL* mysql, const ext_val_t<T>& ext_val) {\n \t} else if (ext_val.err == -2) {\n \t\treturn \"Failed to parse response value '\" + ext_val.str + \"'\";\n \t} else {\n-\t\treturn \"Query failed with error '\" + std::string { mysql_error(mysql) } + \"'\";\n+\t\treturn std::string { mysql_error(mysql) };\n \t}\n }\n \n@@ -720,11 +742,56 @@ std::pair<int,pool_state_t> fetch_conn_stats(MYSQL* admin, const std::vector<uin\n  */\n int wait_for_cond(MYSQL* mysql, const std::string& query, uint32_t timeout);\n \n+using check_res_t = std::pair<int,std::string>;\n+\n+/**\n+ * @brief Waits for multiple conditions to take place before returning.\n+ * @param mysql Already oppened connection in which to execute the queries.\n+ * @param qs Conditions represented as queries; must pass 'check_cond' requirements.\n+ * @param to Timeout in which all the conditions should be accomplished.\n+ * @return Vector of pairs of shape '{err, check}'.\n+ */\n+std::vector<check_res_t> wait_for_conds(MYSQL* mysql, const std::vector<std::string>& qs, uint32_t to);\n+\n+/**\n+ * @brief Reduces a vector of 'check_res_t' to either success or failure.\n+ * @param chks Vector to be fold into single value.\n+ * @return -1 in case a check failed to execute, 1 if any check timedout, 0 for success.\n+ */\n+int proc_wait_checks(const std::vector<check_res_t>& chks);\n+\n+/**\n+ * @brief Encapsulates a server address.\n+ */\n+struct srv_addr_t {\n+\tconst std::string host;\n+\tconst int port;\n+};\n+\n // Helpers using 'wait_for_cond' on 'stats_mysql_connection'\n void check_conn_count(MYSQL* admin, const std::string& conn_type, uint32_t conn_num, int32_t hg=-1);\n void check_query_count(MYSQL* admin, uint32_t queries, uint32_t hg);\n void check_query_count(MYSQL* admin, std::vector<uint32_t> queries, uint32_t hg);\n \n+/**\n+ * @brief Fetches the ProxySQL nodes configured in the supplied instance.\n+ * @param cl Parameters for performing the connection to the instance.\n+ * @return Pair of shape '{err, {srv_addr}}'.\n+ */\n+std::pair<int,std::vector<srv_addr_t>> fetch_cluster_nodes(MYSQL* admin, bool dump_fetch=false);\n+\n+/**\n+ * @brief Helper function that waits for a check in all the supplied nodes.\n+ * @param cl Used for credentials to open conns to the nodes.\n+ * @param nodes The nodes addresses in which to perform the checks.\n+ * @param check The check itself to be performed in all the nodes. Must pass 'check_cond' requirements.\n+ * @param to Timeout for synchronization to take place.\n+ * @return 0 in case of success, 1 in case of timeout, and -1 in case of check failure.\n+ */\n+int check_nodes_sync(\n+\tconst CommandLine& cl, const std::vector<srv_addr_t>& nodes, const std::string& check, uint32_t to\n+);\n+\n /**\n  * @brief fetches and converts env var value to str/int/bool if possible otherwise uses default\n  * @details helper function for fetching str/int/bool from env\ndiff --git a/test/tap/tests/max_connections_ff-t.cpp b/test/tap/tests/max_connections_ff-t.cpp\nindex f85a66f330..211c939c51 100644\n--- a/test/tap/tests/max_connections_ff-t.cpp\n+++ b/test/tap/tests/max_connections_ff-t.cpp\n@@ -18,14 +18,12 @@\n \n #include <cstring>\n #include <chrono>\n-#include <iostream>\n #include <string>\n #include <stdio.h>\n #include <vector>\n #include <unistd.h>\n \n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"json.hpp\"\n \n@@ -66,10 +64,10 @@ int set_max_conns(MYSQL* proxy_admin, int max_conns, int hg_id) {\n \tstring max_conn_query {};\n \tstring_format(\"UPDATE mysql_servers SET max_connections=%d WHERE hostgroup_id=%d\", max_conn_query, max_conns, hg_id);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), max_conn_query.c_str());\n+\tdiag(\"Executing query `%s`...\", max_conn_query.c_str());\n \tMYSQL_QUERY(proxy_admin, max_conn_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL SERVERS TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL SERVERS TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL SERVERS TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -79,10 +77,10 @@ int set_srv_conn_to(MYSQL* proxy_admin, int connect_to) {\n \tstring srv_conn_to_query {};\n \tstring_format(\"SET mysql-connect_timeout_server_max=%d\", srv_conn_to_query, connect_to);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), srv_conn_to_query.c_str());\n+\tdiag(\"Executing query `%s`...\", srv_conn_to_query.c_str());\n \tMYSQL_QUERY(proxy_admin, srv_conn_to_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -93,10 +91,10 @@ int set_ff_for_user(MYSQL* proxy_admin, const string& user, bool ff) {\n \tstring upd_ff_query {};\n \tstring_format(\"UPDATE mysql_users SET fast_forward=%d WHERE username='%s'\", upd_ff_query, ff, user.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), upd_ff_query.c_str());\n+\tdiag(\"Executing query `%s`...\", upd_ff_query.c_str());\n \tMYSQL_QUERY(proxy_admin, upd_ff_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL USERS TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -264,9 +262,9 @@ int test_ff_sess_exceeds_max_conns(const CommandLine& cl, MYSQL* proxy_admin, lo\n \n \tstring reset_conn_to_srv {};\n \tstring_format(\"SET mysql-connect_timeout_server_max=%s\", reset_conn_to_srv, str_connect_timeout_server_max.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), reset_conn_to_srv.c_str());\n+\tdiag(\"Executing query `%s`...\", reset_conn_to_srv.c_str());\n \tMYSQL_QUERY(proxy_admin, reset_conn_to_srv.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -313,7 +311,7 @@ int test_ff_only_one_free_conn(const CommandLine& cl, MYSQL* proxy_admin, int ma\n \n \t// Reset all the current stats for 'stats_mysql_connection_pool'\n \tmy_err = mysql_query(proxy_admin, reset_connpool_stats);\n-\tdiag(\"%s: Executing query `%s` in new 'fast_forward' conn...\", tap_curtime().c_str(), reset_connpool_stats);\n+\tdiag(\"Executing query `%s` in new 'fast_forward' conn...\", reset_connpool_stats);\n \tif (my_err) {\n \t\tdiag(\"Query '%s' failed\", reset_connpool_stats);\n \t\tres = EXIT_FAILURE;\n@@ -333,7 +331,7 @@ int test_ff_only_one_free_conn(const CommandLine& cl, MYSQL* proxy_admin, int ma\n \t\tMYSQL* trx_conn = trx_conns.back();\n \n \t\tdiag(\"Freeing ONE connection by committing the transaction...\");\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"COMMIT\");\n+\t\tdiag(\"Executing query `%s`...\", \"COMMIT\");\n \t\tmy_err = mysql_query(trx_conn, \"COMMIT\");\n \t\tif (my_err) {\n \t\t\tdiag(\n@@ -375,7 +373,7 @@ int test_ff_only_one_free_conn(const CommandLine& cl, MYSQL* proxy_admin, int ma\n \t\t}\n \n \t\t// 3.1 Issue a simple query into the new 'fast_forward' connection\n-\t\tdiag(\"%s: Executing query `%s` in new 'fast_forward' conn...\", tap_curtime().c_str(), \"DO 1\");\n+\t\tdiag(\"Executing query `%s` in new 'fast_forward' conn...\", \"DO 1\");\n \t\tint q_my_err = mysql_query(proxy_ff, \"DO 1\");\n \t\tif (q_my_err) {\n \t\t\tdiag(\ndiff --git a/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp b/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp\nindex bd6fa98ba5..86c3336d71 100644\n--- a/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp\n+++ b/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp\n@@ -172,7 +172,7 @@ int main(int argc, char** argv) {\n \t\t\tfor (const string& params : req.params) {\n \t\t\t\tconst string ept { join_path(base_address, req.ept_info.name) };\n \t\t\t\tdiag(\n-\t\t\t\t\t\"%s: Checking valid '%s' request - ept: '%s', params: '%s'\", tap_curtime().c_str(),\n+\t\t\t\t\t\"Checking valid '%s' request - ept: '%s', params: '%s'\",\n \t\t\t\t\treq.ept_info.method.c_str(), ept.c_str(), params.c_str()\n \t\t\t\t);\n \t\t\t\tstd::chrono::nanoseconds duration;\n@@ -308,7 +308,7 @@ int main(int argc, char** argv) {\n \n \t\t\tconst string ept { join_path(base_address, req.ept_info.name) };\n \t\t\tdiag(\n-\t\t\t\t\"%s: Checking valid '%s' request - ept: '%s', params: '%s'\", tap_curtime().c_str(),\n+\t\t\t\t\"Checking valid '%s' request - ept: '%s', params: '%s'\",\n \t\t\t\treq.ept_info.method.c_str(), ept.c_str(), ept_pl.params.c_str()\n \t\t\t);\n \ndiff --git a/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp b/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp\nindex 898c56f4ed..cdc48d14fa 100644\n--- a/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp\n+++ b/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp\n@@ -13,16 +13,17 @@\n #include <string>\n #include <stdio.h>\n #include <unistd.h>\n+#include <utility>\n #include <poll.h>\n #include <sys/epoll.h>\n \n #include \"mysql.h\"\n-#include <thread>\n \n #include \"tap.h\"\n #include \"command_line.h\"\n #include \"utils.h\"\n \n+using std::pair;\n using std::string;\n using std::vector;\n \n@@ -59,13 +60,15 @@ int create_connections(const conn_opts_t& conn_opts, uint32_t cons_num, std::vec\n const uint32_t ADMIN_CONN_NUM = 100;\n const uint32_t MYSQL_CONN_NUM = 100;\n const uint32_t REPORT_INTV_SEC = 5;\n-double MAX_ALLOWED_CPU_USAGE = (double) get_env_int(\"TAP_MAX_ALLOWED_CPU_USAGE\", 13);\n \n-int get_idle_conns_cpu_usage(CommandLine& cl, uint64_t mode, double& idle_cpu_ms, double& final_cpu_ms) {\n+double MAX_IDLE_CPU_USAGE = (double) get_env_int(\"MAX_IDLE_CPU_USAGE\", 10);\n+double MAX_INCREASE_CPU_USAGE = (double) get_env_int(\"TAP_MAX_INCREASE_CPU_USAGE\", 2);\n+\n+int get_idle_conns_cpu_usage(CommandLine& cl, uint64_t mode, double& no_conns_cpu, double& idle_conns_cpu) {\n \t// get ProxySQL idle cpu usage\n-\tint idle_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, idle_cpu_ms);\n+\tint idle_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, no_conns_cpu);\n \tif (idle_err) {\n-\t    diag(\"File %s, line %d, Error: '%s'\", __FILE__, __LINE__, \"Unable to get 'idle_cpu' usage.\");\n+\t    diag(\"Unable to get 'no_conns_cpu' usage.\");\n \t\treturn idle_err;\n \t}\n \n@@ -87,9 +90,9 @@ int get_idle_conns_cpu_usage(CommandLine& cl, uint64_t mode, double& idle_cpu_ms\n \t\treturn EXIT_FAILURE;\n \t}\n \n-\tint final_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, final_cpu_ms);\n+\tint final_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, idle_conns_cpu);\n \tif (final_err) {\n-\t    diag(\"File %s, line %d, Error: '%s'\", __FILE__, __LINE__, \"Unable to get 'idle_cpu' usage.\");\n+\t    diag(\"Unable to get 'idle_conns_cpu' usage.\");\n \t\treturn idle_err;\n \t}\n \n@@ -111,11 +114,11 @@ int main(int argc, char** argv) {\n \n \t// For ASAN builds we don't care about correctness in this measurement.\n \tif (get_env_int(\"WITHASAN\", 0)) {\n-\t\tMAX_ALLOWED_CPU_USAGE = 80;\n+\t\tMAX_IDLE_CPU_USAGE = 80;\n \t}\n \n-\tdouble idle_cpu_ms = 0;\n-\tdouble final_cpu_ms = 0;\n+\tdouble no_conns_cpu = 0;\n+\tdouble idle_conns_cpu = 0;\n \n \tMYSQL* proxysql_admin = mysql_init(NULL);\n \tif (!mysql_real_connect(proxysql_admin, cl.host, cl.admin_username, cl.admin_password, NULL, cl.admin_port, NULL, 0)) {\n@@ -123,57 +126,71 @@ int main(int argc, char** argv) {\n \t\treturn EXIT_FAILURE;\n \t}\n \n+\tpair<int,vector<MYSQL*>> p_err_nodes_conns { disable_core_nodes_scheduler(cl, proxysql_admin) };\n+\tif (p_err_nodes_conns.first) { return EXIT_FAILURE; }\n+\tvector<MYSQL*>& nodes_conns { p_err_nodes_conns.second };\n+\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-have_ssl=1\");\n \tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tmysql_close(proxysql_admin);\n \n \tdiag(\"Testing regular connections...\");\n-\tint ret_cpu_usage = get_idle_conns_cpu_usage(cl, 0, idle_cpu_ms, final_cpu_ms);\n+\tint ret_cpu_usage = get_idle_conns_cpu_usage(cl, 0, no_conns_cpu, idle_conns_cpu);\n \tif (ret_cpu_usage != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tok(\n-\t\tidle_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'no clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, idle_cpu_ms\n+\t\tno_conns_cpu < MAX_IDLE_CPU_USAGE,\n+\t\t\"ProxySQL 'no clients' CPU usage should be below expected: (MAX_IDLE_CPU_USAGE: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE, no_conns_cpu\n \t);\n \n \tok(\n-\t\tfinal_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, final_cpu_ms\n+\t\tidle_conns_cpu < MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE,\n+\t\t\"ProxySQL 'with clients' CPU usage should be below expected:\"\n+\t\t\t\" (MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE, idle_conns_cpu\n \t);\n \n \tdiag(\"Testing SSL connections...\");\n-\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL, idle_cpu_ms, final_cpu_ms);\n+\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL, no_conns_cpu, idle_conns_cpu);\n \tif (ret_cpu_usage != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tok(\n-\t\tidle_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n+\t\tno_conns_cpu < MAX_IDLE_CPU_USAGE,\n \t\t\"ProxySQL 'no clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, idle_cpu_ms\n+\t\tMAX_IDLE_CPU_USAGE, no_conns_cpu\n \t);\n \n \tok(\n-\t\tfinal_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'SSL clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, final_cpu_ms\n+\t\tidle_conns_cpu < MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE,\n+\t\t\"ProxySQL 'with SSL clients' CPU usage should be below expected:\"\n+\t\t\t\" (MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE, idle_conns_cpu\n \t);\n \n \tdiag(\"Testing SSL and compressed connections...\");\n-\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL|CLIENT_COMPRESS, idle_cpu_ms, final_cpu_ms);\n+\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL|CLIENT_COMPRESS, no_conns_cpu, idle_conns_cpu);\n \tif (ret_cpu_usage != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tok(\n-\t\tidle_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n+\t\tno_conns_cpu < MAX_IDLE_CPU_USAGE,\n \t\t\"ProxySQL 'no clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, idle_cpu_ms\n+\t\tMAX_IDLE_CPU_USAGE, no_conns_cpu\n \t);\n \n \tok(\n-\t\tfinal_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'SSL|COMPRESS clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, final_cpu_ms\n+\t\tidle_conns_cpu < MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE,\n+\t\t\"ProxySQL 'with SSL|COMPRESS clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE, idle_conns_cpu\n \t);\n \n+\t// Recover cluster scheduler\n+\tfor (MYSQL* myconn : nodes_conns) {\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER FROM DISK\");\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER TO RUNTIME\");\n+\n+\t\tmysql_close(myconn);\n+\t}\n+\n \treturn exit_status();\n }\ndiff --git a/test/tap/tests/reg_test_4402-mysql_fields-t.cpp b/test/tap/tests/reg_test_4402-mysql_fields-t.cpp\nindex bf1c0a1c16..ff0d3e5869 100644\n--- a/test/tap/tests/reg_test_4402-mysql_fields-t.cpp\n+++ b/test/tap/tests/reg_test_4402-mysql_fields-t.cpp\n@@ -83,7 +83,9 @@ int main(int argc, char** argv) {\n \n \t\t// to check column alias issue:\n \t\t{\n-\t\t\tconst std::string& query = \"SELECT testdb.echo_int(1) AS \" + generate_random_string(length);\n+\t\t\t// NOTE: The randomly generated string should be escaped \\`\\`, otherwise could collide\n+\t\t\t// with SQL reserved words, causing an invalid test failure.\n+\t\t\tconst std::string& query = \"SELECT testdb.echo_int(1) AS `\" + generate_random_string(length) + \"`\";\n \t\t\tMYSQL_QUERY__(proxysql, query.c_str());\n \n \t\t\tMYSQL_RES* res = mysql_use_result(proxysql);\ndiff --git a/test/tap/tests/reg_test__ssl_client_busy_wait-t.cpp b/test/tap/tests/reg_test__ssl_client_busy_wait-t.cpp\nnew file mode 100644\nindex 0000000000..0986898819\n--- /dev/null\n+++ b/test/tap/tests/reg_test__ssl_client_busy_wait-t.cpp\n@@ -0,0 +1,352 @@\n+/**\n+ * @file reg_test_3273_ssl_con-t.cpp\n+ * @brief Regression test for SSL busy/infinite loops for frontend connections.\n+ * @details When client disconnects unexpectedly closing the socket on a SSL connection, depending on the\n+ *   timing conditions, either an infinite loop or a busy loop could take place. These scenarios are:\n+ *   1. Closed socket while query running on backend (before data arrives), leads to busy loop.\n+ *   2. Closed socket after all the data has been written into the socket, since no more writing would take\n+ *      place in the socket an infinite loop would take place.\n+ */\n+\n+#include <cstring>\n+#include <string>\n+#include <stdio.h>\n+#include <unistd.h>\n+#include <utility>\n+#include <vector>\n+#include <poll.h>\n+#include <fcntl.h>\n+\n+#include <sys/epoll.h>\n+\n+\n+#include \"mysql.h\"\n+\n+#include \"tap.h\"\n+#include \"command_line.h\"\n+#include \"utils.h\"\n+\n+using std::string;\n+using std::pair;\n+using std::vector;\n+\n+/* Helper function to do the waiting for events on the socket. */\n+static int wait_for_mysql(MYSQL *mysql, int status) {\n+\tstruct pollfd pfd;\n+\tint timeout, res;\n+\n+\tpfd.fd = mysql_get_socket(mysql);\n+\tpfd.events =\n+\t\t(status & MYSQL_WAIT_READ ? POLLIN : 0) |\n+\t\t(status & MYSQL_WAIT_WRITE ? POLLOUT : 0) |\n+\t\t(status & MYSQL_WAIT_EXCEPT ? POLLPRI : 0);\n+\tif (status & MYSQL_WAIT_TIMEOUT)\n+\t\ttimeout = 1000*mysql_get_timeout_value(mysql);\n+\telse\n+\t\ttimeout = -1;\n+\tres = poll(&pfd, 1, timeout);\n+\tif (res == 0)\n+\t\treturn MYSQL_WAIT_TIMEOUT;\n+\telse if (res < 0)\n+\t\treturn MYSQL_WAIT_TIMEOUT;\n+\telse {\n+\t\tint status = 0;\n+\t\tif (pfd.revents & POLLIN) status |= MYSQL_WAIT_READ;\n+\t\tif (pfd.revents & POLLOUT) status |= MYSQL_WAIT_WRITE;\n+\t\tif (pfd.revents & POLLPRI) status |= MYSQL_WAIT_EXCEPT;\n+\t\treturn status;\n+\t}\n+}\n+\n+enum BUSY_LOOP_T {\n+\tBUSY_LOOP=0,\n+\tINF_LOOP=1\n+};\n+\n+struct th_args__in_t {\n+\t// Input\n+\tint argc { 0 };\n+\tchar** argv { nullptr };\n+\tint secs { 0 };\n+\tint busy_loop_type = BUSY_LOOP_T::BUSY_LOOP;\n+\tCommandLine& cl;\n+};\n+\n+struct th_args__out_t {\n+\t// Output\n+\tvolatile int* query_started { nullptr };\n+\tvolatile int* routine_rc { nullptr };\n+};\n+\n+struct th_args_t {\n+\tth_args__in_t in_args;\n+\tth_args__out_t out_args {};\n+};\n+\n+void* perform_async_query(void* arg) {\n+\tth_args_t* th_args = static_cast<th_args_t*>(arg);\n+\n+\tMYSQL* mysql = nullptr;\n+\n+\t{\n+\t\tCommandLine& cl = th_args->in_args.cl;\n+\t\tmysql = mysql_init(NULL);\n+\t\tMYSQL* ret = NULL;\n+\t\tint query_ret = 0;\n+\n+\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n+\t\tmysql_ssl_set(mysql, NULL, NULL, NULL, NULL, NULL);\n+\n+\t\tint status = 0;\n+\n+\t\tif (th_args->in_args.argc == 2 && (strcmp(th_args->in_args.argv[1], \"admin\") == 0)) {\n+\t\t\tstatus = mysql_real_connect_start(\n+\t\t\t\t&ret, mysql, cl.host, \"radmin\", \"radmin\", NULL, 6032, NULL, CLIENT_SSL\n+\t\t\t);\n+\t\t\tdiag(\"Creating 'Admin' connection   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t} else {\n+\t\t\tstatus = mysql_real_connect_start(\n+\t\t\t\t&ret, mysql, cl.host, cl.username, cl.password, NULL, cl.port, NULL, CLIENT_SSL\n+\t\t\t);\n+\n+\t\t\tdiag(\"Creating 'MySQL' connection   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t}\n+\t\tif (status == 0) {\n+\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(mysql));\n+\t\t\t__sync_fetch_and_add(th_args->out_args.routine_rc, 1);\n+\t\t\treturn NULL;\n+\t\t}\n+\n+\t\tdiag(\"Continue connection establishment   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\twhile (status) {\n+\t\t\tstatus = wait_for_mysql(mysql, status);\n+\t\t\tstatus = mysql_real_connect_cont(&ret, mysql, status);\n+\t\t\tdiag(\"'mysql_real_connect_cont'   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t}\n+\n+\t\t// NOTE: mariadbclient has an incompatibility between SSL and NONBLOCK flags. Flag needs to be reset\n+\t\t// after 'mysql_real_connect_cont', otherwise API would become blocking.\n+\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n+\t\tint f=fcntl(mysql->net.fd, F_GETFL);\n+\t\tfcntl(mysql->net.fd, F_SETFL, f|O_NONBLOCK);\n+\n+\t\tconst string sleep_query { \"SELECT SLEEP(\" + std::to_string(th_args->in_args.secs) + \")\" };\n+\t\tdiag(\"mysql_query_start   thread=%ld query=%s\", pthread_self(), sleep_query.c_str());\n+\n+\t\tstatus = mysql_real_query_start(&query_ret, mysql, sleep_query.c_str(), sleep_query.size());\n+\n+\t\tif (th_args->in_args.busy_loop_type == BUSY_LOOP_T::INF_LOOP) {\n+\t\t\t// NOTE: When signaling after 'mysql_query_start' has finished, ProxySQL wont attempt to write more\n+\t\t\t// to the closed pipe, this corresponds to 'busy_loop_type=2' and infinite loop.\n+\t\t\twhile (status) {\n+\t\t\t\tstatus = wait_for_mysql(mysql, status);\n+\t\t\t\tstatus = mysql_real_query_cont(&query_ret, mysql, status);\n+\t\t\t\tdiag(\"'mysql_real_connect_cont'   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t\t}\n+\t\t}\n+\n+\t\tdiag(\"Signaling query start   thread=%ld status=%d query_ret=%d\", pthread_self(), status, query_ret);\n+\t\t__sync_fetch_and_add(th_args->out_args.query_started, 1);\n+\n+\t\t// NOTE: Required for triggering the issue, thread exit isn't enough, either 'process exit' or\n+\t\t// 'close()'. They should be immediate to the previous action, otherwise timing could be invalid.\n+\t\tclose(mysql->net.fd);\n+\n+\t\twhile (true) {\n+\t\t\tdiag(\n+\t\t\t\t\"Sleeping after query started...   thread=%ld status=%d query_ret=%d\",\n+\t\t\t\tpthread_self(), status, query_ret\n+\t\t\t);\n+\t\t\tsleep(1);\n+\t\t}\n+\t}\n+\n+\treturn NULL;\n+}\n+\n+struct pthread_data_t {\n+\tpthread_t id { 0 };\n+\tint query_started { 0 };\n+\tint routine_rc { EXIT_SUCCESS };\n+};\n+\n+const int BUSY_THREADS = get_env_int(\"TAP_SSL_BUSY_WAIT__BUSY_THREADS\", 4);\n+const int MAX_IDLE_CPU = get_env_int(\"TAP_SSL_BUSY_WAIT__MAX_IDLE_CPU\", 20);\n+const int MAX_BUSY_CPU = get_env_int(\"TAP_SSL_BUSY_WAIT__MAX_BUSY_CPU\", 25);\n+\n+// NOTE: '10' is a nice value due to it's relationship with the 'system_cpu' interval\n+const int BUSY_WAIT_SECS = get_env_int(\"TAP_SSL_BUSY_WAIT__BUSY_WAIT_SECS\", 10);\n+// NOTE: '5' is the min value due to time interval rounding 'round_intv_to_time_interval'\n+const int SAMPLE_INTV_SECS = get_env_int(\"TAP_SSL_BUSY_WAIT__SAMPLE_INTV_SEC\", BUSY_WAIT_SECS / 2);\n+\n+void create_busy_loops(int argc, char** argv, CommandLine& cl, BUSY_LOOP_T loop_type) {\n+\tvector<pthread_data_t> ths_data {};\n+\tvector<std::unique_ptr<th_args_t>> ths_args {};\n+\n+\tths_data.resize(BUSY_THREADS);\n+\n+\tfor (size_t i = 0; i < BUSY_THREADS; i++) {\n+\t\tpthread_data_t& th_data = ths_data[i];\n+\t\tstd::unique_ptr<th_args_t> th_args {\n+\t\t\tnew th_args_t {\n+\t\t\t\tth_args__in_t {\n+\t\t\t\t\targc, argv, BUSY_WAIT_SECS, loop_type, cl\n+\t\t\t\t},\n+\t\t\t\tth_args__out_t {\n+\t\t\t\t\t&th_data.query_started,\n+\t\t\t\t\t&th_data.routine_rc\n+\t\t\t\t}\n+\t\t\t}\n+\t\t};\n+\n+\t\tpthread_create(&th_data.id, NULL, perform_async_query, th_args.get());\n+\t\tths_args.push_back(std::move(th_args));\n+\n+\t\tdiag(\"Thread created   thread=%ld\", th_data.id);\n+\t}\n+\n+\tbool missing_query = true;\n+\tbool query_failed = false;\n+\n+\twhile (missing_query && !query_failed) {\n+\t\tbool all_query_started = true;\n+\n+\t\tfor (pthread_data_t& th_data : ths_data) {\n+\t\t\tbool query_started = __sync_fetch_and_add(&th_data.query_started, 0);\n+\t\t\tdiag(\n+\t\t\t\t\"Thread data   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t);\n+\n+\t\t\tif (th_data.id == 0 && query_started == 1) {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Thread alreay cancelled   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tquery_failed = __sync_fetch_and_add(&th_data.routine_rc, 0);\n+\n+\t\t\tif (query_failed) {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Async query failed; aborting test   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\n+\t\t\tall_query_started &= query_started;\n+\n+\t\t\tif (query_started) {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Async query started, killing thread   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t\tpthread_cancel(th_data.id);\n+\t\t\t\tth_data.id = 0;\n+\t\t\t} else {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Waiting for async query to start...   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t}\n+\t\t}\n+\n+\t\tmissing_query = !all_query_started;\n+\t\tusleep(500 * 1000);\n+\t}\n+}\n+\n+int main(int argc, char** argv) {\n+\tCommandLine cl;\n+\n+\tif (cl.getEnv()) {\n+\t\tdiag(\"Failed to get the required environmental variables.\");\n+\t\treturn -1;\n+\t}\n+\n+\tplan(4);\n+\n+\tMYSQL* admin = mysql_init(NULL);\n+\tif (!mysql_real_connect(admin, cl.host, cl.admin_username, cl.admin_password, NULL, cl.admin_port, NULL, 0)) {\n+\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(admin));\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tpair<int,vector<MYSQL*>> p_err_nodes_conns { disable_core_nodes_scheduler(cl, admin) };\n+\tif (p_err_nodes_conns.first) { return EXIT_FAILURE; }\n+\tvector<MYSQL*>& nodes_conns { p_err_nodes_conns.second };\n+\n+\tdiag(\"Checking ProxySQL idle CPU usage\");\n+\tdouble idle_cpu = 0;\n+\tint ret_i_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, idle_cpu);\n+\tif (ret_i_cpu) {\n+\t\tdiag(\"Getting initial CPU usage failed with error - %d\", ret_i_cpu);\n+\t\tdiag(\"Aborting further testing\");\n+\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tok(\n+\t\tidle_cpu < MAX_IDLE_CPU, \"Idle CPU usage should be below expected - Exp:%d%%, Act: %lf%%\",\n+\t\tMAX_IDLE_CPU, idle_cpu\n+\t);\n+\n+\tdiag(\"Trigger BUSY_LOOP regression    BUSY_THREADS=%d BUSY_WAIT_SECS=%d\", BUSY_THREADS, BUSY_WAIT_SECS);\n+\tcreate_busy_loops(argc, argv, cl, BUSY_LOOP_T::BUSY_LOOP);\n+\n+\tdiag(\"Checking ProxySQL final CPU usage for 'BUSY_LOOP'\");\n+\tdouble final_cpu_usage = 0;\n+\tint ret_f_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, final_cpu_usage);\n+\n+\tok(\n+\t\tfinal_cpu_usage < MAX_BUSY_CPU,\n+\t\t\"ProxySQL CPU usage should be below expected - Exp: %d%%, Act: %lf%%\",\n+\t\tMAX_BUSY_CPU, final_cpu_usage\n+\t);\n+\n+\t// Extra wait to ensure cleanup of faulty client conns. See 'BUSY_WAIT_SECS' NOTE in def.\n+\tint BUSY_WAIT_CLEANUP = BUSY_WAIT_SECS < 5 ? 5 : BUSY_WAIT_SECS / 2;\n+\tdiag(\"Sleeping for %d secs for BUSY_LOOP client cleanup\", BUSY_WAIT_CLEANUP);\n+\tsleep(BUSY_WAIT_CLEANUP);\n+\n+\tdiag(\"Checking ProxySQL idle CPU usage\");\n+\tret_i_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, idle_cpu);\n+\tif (ret_i_cpu) {\n+\t\tdiag(\"Getting initial CPU usage failed with error - %d\", ret_i_cpu);\n+\t\tdiag(\"Aborting further testing\");\n+\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tok(\n+\t\tidle_cpu < MAX_IDLE_CPU, \"Idle CPU usage should be below expected - Exp:%d%%, Act: %lf%%\",\n+\t\tMAX_IDLE_CPU, idle_cpu\n+\t);\n+\n+\tdiag(\"Trigger INF_LOOP regression    BUSY_THREADS=%d BUSY_WAIT_SECS=%d\", BUSY_THREADS, BUSY_WAIT_SECS);\n+\tcreate_busy_loops(argc, argv, cl, BUSY_LOOP_T::INF_LOOP);\n+\n+\tdiag(\"Checking ProxySQL final CPU usage for 'BUSY_LOOP'\");\n+\tfinal_cpu_usage = 0;\n+\tret_f_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, final_cpu_usage);\n+\n+\tok(\n+\t\tfinal_cpu_usage < MAX_BUSY_CPU,\n+\t\t\"ProxySQL CPU usage should be below expected - Exp: %d%%, Act: %lf%%\",\n+\t\tMAX_BUSY_CPU, final_cpu_usage\n+\t);\n+\n+\t// Recover cluster scheduler\n+\tfor (MYSQL* myconn : nodes_conns) {\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER FROM DISK\");\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER TO RUNTIME\");\n+\n+\t\tmysql_close(myconn);\n+\t}\n+\n+\tmysql_close(admin);\n+\n+\treturn exit_status();\n+}\ndiff --git a/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp b/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp\nindex 674a1f9b74..0a7200ef18 100644\n--- a/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp\n+++ b/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp\n@@ -13,7 +13,6 @@\n #include <unistd.h>\n \n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"json.hpp\"\n \n@@ -74,7 +73,7 @@ int main(int argc, char** argv) {\n \t// 1. Prepare the 'SQL_CALC_FOUND_ROWS' stmt in a connection\n \tMYSQL* proxy_mysql = mysql_init(NULL);\n \n-\tdiag(\"%s: Openning initial connection...\", tap_curtime().c_str());\n+\tdiag(\"Openning initial connection...\");\n \tif (!mysql_real_connect(proxy_mysql, cl.host, cl.username, cl.password, NULL, cl.port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxy_mysql));\n \t\treturn EXIT_FAILURE;\n@@ -84,7 +83,7 @@ int main(int argc, char** argv) {\n \tMYSQL_STMT* stmt_2 = mysql_stmt_init(proxy_mysql);\n \tMYSQL_STMT* stmt_3 = nullptr;\n \n-\tdiag(\"%s: Issuing the prepare for `%s` in init conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_1);\n+\tdiag(\"Issuing the prepare for `%s` in init conn\", Q_CALC_FOUND_ROWS_1);\n \tint my_err = mysql_stmt_prepare(stmt_1, Q_CALC_FOUND_ROWS_1, strlen(Q_CALC_FOUND_ROWS_1));\n \tif (my_err) {\n \t\tdiag(\n@@ -94,7 +93,7 @@ int main(int argc, char** argv) {\n \t\tgoto cleanup;\n \t}\n \n-\tdiag(\"%s: Issuing the prepare for `%s` in init conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_2);\n+\tdiag(\"Issuing the prepare for `%s` in init conn\", Q_CALC_FOUND_ROWS_2);\n \tmy_err = mysql_stmt_prepare(stmt_2, Q_CALC_FOUND_ROWS_2, strlen(Q_CALC_FOUND_ROWS_2));\n \tif (my_err) {\n \t\tdiag(\n@@ -107,13 +106,13 @@ int main(int argc, char** argv) {\n \tmysql_stmt_close(stmt_1);\n \tmysql_stmt_close(stmt_2);\n \n-\tdiag(\"%s: Closing initial connection...\", tap_curtime().c_str());\n+\tdiag(\"Closing initial connection...\");\n \tmysql_close(proxy_mysql);\n \n \t// 2. Open a new connection and prepare the stmts it again in a new connection\n \tproxy_mysql = mysql_init(NULL);\n \n-\tdiag(\"%s: Openning new connection for testing 'Multiplex' disabling\", tap_curtime().c_str());\n+\tdiag(\"Openning new connection for testing 'Multiplex' disabling\");\n \tif (!mysql_real_connect(proxy_mysql, cl.host, cl.username, cl.password, NULL, cl.port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxy_mysql));\n \t\treturn EXIT_FAILURE;\n@@ -123,7 +122,7 @@ int main(int argc, char** argv) {\n \tstmt_2 = mysql_stmt_init(proxy_mysql);\n \tstmt_3 = mysql_stmt_init(proxy_mysql);\n \n-\tdiag(\"%s: Issuing the prepare for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_1);\n+\tdiag(\"Issuing the prepare for `%s` in new conn\", Q_CALC_FOUND_ROWS_1);\n \tmy_err = mysql_stmt_prepare(stmt_1, Q_CALC_FOUND_ROWS_1, strlen(Q_CALC_FOUND_ROWS_1));\n \tif (my_err) {\n \t\tdiag(\n@@ -134,7 +133,7 @@ int main(int argc, char** argv) {\n \t}\n \n \t{\n-\t\tdiag(\"%s: Issuing execute for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_1);\n+\t\tdiag(\"Issuing execute for `%s` in new conn\", Q_CALC_FOUND_ROWS_1);\n \t\tmy_err = mysql_stmt_execute(stmt_1);\n \t\tif (my_err) {\n \t\t\tdiag(\"'mysql_stmt_execute' at line %d failed: %s\", __LINE__, mysql_stmt_error(stmt_1));\n@@ -149,7 +148,7 @@ int main(int argc, char** argv) {\n \t\t}\n \t}\n \t{\n-\t\tdiag(\"%s: Issuing the prepare for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_2);\n+\t\tdiag(\"Issuing the prepare for `%s` in new conn\", Q_CALC_FOUND_ROWS_2);\n \t\tmy_err = mysql_stmt_prepare(stmt_2, Q_CALC_FOUND_ROWS_2, strlen(Q_CALC_FOUND_ROWS_2));\n \t\tif (my_err) {\n \t\t\tdiag(\n@@ -160,7 +159,7 @@ int main(int argc, char** argv) {\n \t\t}\n \n \t\t{\n-\t\t\tdiag(\"%s: Issuing execute for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_2);\n+\t\t\tdiag(\"Issuing execute for `%s` in new conn\", Q_CALC_FOUND_ROWS_2);\n \t\t\tmy_err = mysql_stmt_execute(stmt_2);\n \t\t\tif (my_err) {\n \t\t\t\tdiag(\"'mysql_stmt_execute' at line %d failed: %s\", __LINE__, mysql_stmt_error(stmt_2));\n@@ -175,7 +174,7 @@ int main(int argc, char** argv) {\n \t\t\t}\n \t\t}\n \n-\t\tdiag(\"%s: Issuing the prepare for `%s` in new conn\", tap_curtime().c_str(), Q_FOUND_ROWS);\n+\t\tdiag(\"Issuing the prepare for `%s` in new conn\", Q_FOUND_ROWS);\n \t\tmy_err = mysql_stmt_prepare(stmt_3, Q_FOUND_ROWS, strlen(Q_FOUND_ROWS));\n \t\tif (my_err) {\n \t\t\tdiag(\ndiff --git a/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp b/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp\nindex ee50da7211..64f531da0e 100644\n--- a/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp\n+++ b/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp\n@@ -25,11 +25,9 @@\n #include <vector>\n #include <string>\n #include <stdio.h>\n-#include <iostream>\n \n #include <unistd.h>\n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"json.hpp\"\n \n@@ -142,14 +140,14 @@ int check_auto_increment_timeout(\n \tconst string set_auto_inc_to_query {\n \t\t\"SET mysql-auto_increment_delay_multiplex_timeout_ms=\" + std::to_string(auto_inc_delay_to)\n \t};\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_to_query.c_str());\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_to_query.c_str());\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_to_query.c_str());\n \n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \n \t// Wait at least '500' milliseconds over the poll period\n \tusleep((poll_to + 500) * 1000);\n@@ -197,7 +195,7 @@ int check_auto_increment_timeout(\n \t}\n \n \tMYSQL_QUERY(proxy_mysql, \"DO 1\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"DO 1\");\n+\tdiag(\"Executing query `%s`...\", \"DO 1\");\n \n \tuint32_t old_auto_inc_delay_mult = cur_auto_inc_delay_mult;\n \tg_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_auto_inc_delay_mult);\n@@ -244,9 +242,9 @@ int check_variables_config(MYSQL* proxy_mysql, MYSQL* proxy_admin) {\n \n int check_auto_increment_delay_multiplex(MYSQL* proxy_mysql, MYSQL* proxy_admin) {\n \t// Disable the 'timeout' for the this check since it can be fixated now\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\");\n+\tdiag(\"Executing query `%s`...\", \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\");\n \tMYSQL_QUERY(proxy_admin, \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SET mysql-connection_delay_multiplex_ms=0\");\n+\tdiag(\"Executing query `%s`...\", \"SET mysql-connection_delay_multiplex_ms=0\");\n \tMYSQL_QUERY(proxy_admin, \"SET mysql-connection_delay_multiplex_ms=0\");\n \n \tint cur_auto_inc_delay_mult = 0;\n@@ -310,13 +308,13 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \tuint64_t poll_timeout = 0;\n \tint g_res = 0;\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_query.c_str());\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_query.c_str());\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_query.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SET mysql-connection_delay_multiplex_ms=0\");\n+\tdiag(\"Executing query `%s`...\", \"SET mysql-connection_delay_multiplex_ms=0\");\n \tMYSQL_QUERY(proxy_admin, \"SET mysql-connection_delay_multiplex_ms=0\");\n \n \tconst string q_poll_timeout { \"SELECT variable_value FROM global_variables WHERE variable_name='mysql-poll_timeout'\" };\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), q_poll_timeout.c_str());\n+\tdiag(\"Executing query `%s`...\", q_poll_timeout.c_str());\n \tg_res = get_query_result(proxy_admin, q_poll_timeout.c_str(), poll_timeout);\n \tif (g_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n@@ -357,14 +355,14 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \tif (g_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tMYSQL_QUERY(proxy_admin, delay_query.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), delay_query.c_str());\n+\tdiag(\"Executing query `%s`...\", delay_query.c_str());\n \tMYSQL_QUERY(proxy_admin, timeout_query.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), timeout_query.c_str());\n+\tdiag(\"Executing query `%s`...\", timeout_query.c_str());\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t{\n \t\t// Insert disabling multiplexing for the connection\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\t\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \t\tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \t\t// Perform queries in the same connection\n@@ -373,7 +371,7 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t\twhile (waited < timeout_ms * 3) {\n \t\t\tsleep(1);\n \n-\t\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"/* hostgroup=0 */ DO 1\");\n+\t\t\tdiag(\"Executing query `%s`...\", \"/* hostgroup=0 */ DO 1\");\n \t\t\tMYSQL_QUERY(proxy_mysql, \"/* hostgroup=0 */ DO 1\");\n \t\t\twaited += 1000;\n \t\t}\n@@ -397,7 +395,7 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t\twhile (waited < timeout_ms * 3) {\n \t\t\tsleep(1);\n \n-\t\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SELECT 1\");\n+\t\t\tdiag(\"Executing query `%s`...\", \"SELECT 1\");\n \t\t\tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n \t\t\tmysql_free_result(mysql_store_result(proxy_mysql));\n \n@@ -423,16 +421,16 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \n \t// Transactions connections should be preserved by 'auto_increment_delay_multiplex_timeout_ms'\n \t{\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"BEGIN\");\n+\t\tdiag(\"Executing query `%s`...\", \"BEGIN\");\n \t\tMYSQL_QUERY(proxy_mysql, \"BEGIN\");\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\t\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \t\tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \t\t// Wait for the timeout and check the value\n-\t\tdiag(\"%s: Waiting for timeout to expire...\", tap_curtime().c_str());\n+\t\tdiag(\"Waiting for timeout to expire...\");\n \t\tusleep(timeout_ms * 1000 + poll_timeout * 1000 + 500 * 1000 * 2);\n \n-\t\tdiag(\"%s: Extracting current auto inc delay...\", tap_curtime().c_str());\n+\t\tdiag(\"Extracting current auto inc delay...\");\n \t\tint cur_delay = 0;\n \t\tint g_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_delay);\n \t\tif (g_res != EXIT_SUCCESS) {\n@@ -445,13 +443,13 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t\t\tdelay, cur_delay\n \t\t);\n \n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"COMMIT\");\n+\t\tdiag(\"Executing query `%s`...\", \"COMMIT\");\n \t\tMYSQL_QUERY(proxy_mysql, \"COMMIT\");\n \n-\t\tdiag(\"%s: Waiting for timeout to expire...\", tap_curtime().c_str());\n+\t\tdiag(\"Waiting for timeout to expire...\");\n \t\tusleep(timeout_ms * 1000 + poll_timeout * 1000 + 500 * 1000 * 2);\n \n-\t\tdiag(\"%s: Extracting current auto inc delay...\", tap_curtime().c_str());\n+\t\tdiag(\"Extracting current auto inc delay...\");\n \t\tcur_delay = 0;\n \t\tg_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_delay);\n \t\tif (g_res != EXIT_SUCCESS) {\n@@ -468,16 +466,16 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t// Multiplex disabled by any action should take precedence over 'auto_increment_delay_multiplex_timeout_ms'\n \t{\n \t\tconst char* set_query { \"SET @local_var='foo'\" };\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_query);\n+\t\tdiag(\"Executing query `%s`...\", set_query);\n \t\tMYSQL_QUERY(proxy_mysql, set_query);\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\t\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \t\tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \t\t// Wait for the timeout and check the value\n-\t\tdiag(\"%s: Waiting for timeout to expire...\", tap_curtime().c_str());\n+\t\tdiag(\"Waiting for timeout to expire...\");\n \t\tusleep(timeout_ms * 1000 + poll_timeout * 1000 + 500 * 1000 * 2);\n \n-\t\tdiag(\"%s: Extracting current auto inc delay...\", tap_curtime().c_str());\n+\t\tdiag(\"Extracting current auto inc delay...\");\n \t\tint cur_delay = 0;\n \t\tint g_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_delay);\n \t\tif (g_res != EXIT_SUCCESS) {\n@@ -533,9 +531,9 @@ void check_connection_retained(MYSQL* proxy_mysql, uint32_t exp_conns) {\n int check_transactions_and_multiplex_disable(\n \tMYSQL* proxy_mysql, const char* query, const uint32_t timeout, uint64_t poll_timeout=2\n ) {\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"BEGIN\");\n+\tdiag(\"Executing query `%s`...\", \"BEGIN\");\n \tMYSQL_QUERY(proxy_mysql, \"BEGIN\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), query);\n+\tdiag(\"Executing query `%s`...\", query);\n \tMYSQL_QUERY(proxy_mysql, query);\n \n \tdiag(\"Checking connection present before timeout...\");\n@@ -547,7 +545,7 @@ int check_transactions_and_multiplex_disable(\n \tdiag(\"Checking connection is still present after timeout due to transaction...\");\n \tcheck_connection_retained(proxy_mysql, 1);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"COMMIT\");\n+\tdiag(\"Executing query `%s`...\", \"COMMIT\");\n \tMYSQL_QUERY(proxy_mysql, \"COMMIT\");\n \n \tdiag(\"Sleeping for '%lf' seconds\", timeout / 2.0);\n@@ -565,7 +563,7 @@ int check_transactions_and_multiplex_disable(\n \tdiag(\"Checking multiplex disabled by any action take precedence over 'connection_delay_multiplex_ms'...\");\n \n \tconst char* set_query { \"SET @local_var='foo'\" };\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_query);\n+\tdiag(\"Executing query `%s`...\", set_query);\n \tMYSQL_QUERY(proxy_mysql, set_query);\n \n \tdiag(\"Sleeping for '%ld' seconds\", timeout + poll_timeout);\n@@ -587,13 +585,13 @@ int check_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy_admin)\n \tstring_format(\"SET mysql-connection_delay_multiplex_ms=%d\", set_delay_multiplex, timeout * 1000);\n \tconst char* set_auto_inc_delay { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex.c_str());\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex.c_str());\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_delay);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_delay);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_delay);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n@@ -632,13 +630,13 @@ int check_multiplex_disabled_connection_delay_multiplex_ms(MYSQL* proxy_mysql, M\n \tstring_format(\"SET mysql-connection_delay_multiplex_ms=%d\", set_delay_multiplex, timeout * 1000);\n \tconst char* set_auto_inc_delay { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex.c_str());\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex.c_str());\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_delay);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_delay);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_delay);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t// Check transactions behavior and multiplex disabling actions\n@@ -652,11 +650,11 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \tconst char* set_delay_multiplex_query { \"SET mysql-connection_delay_multiplex_ms=2000\" };\n \tconst char* set_auto_inc_timeout_query { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex_query);\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex_query);\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_timeout_query);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_timeout_query);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_timeout_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t// Retain connection in 'hg=0'\n@@ -664,7 +662,7 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \n \tuint32_t waited = 0;\n \twhile (waited < 2*timeout) {\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"DO 1\");\n+\t\tdiag(\"Executing query `%s`...\", \"DO 1\");\n \t\tMYSQL_QUERY(proxy_mysql, \"DO 1\");\n \n \t\tsleep(1);\n@@ -679,9 +677,9 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \n \tdiag(\"Check connection expiring when traffic issued to different hostgroup...\");\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"DO 1\");\n+\tdiag(\"Executing query `%s`...\", \"DO 1\");\n \tMYSQL_QUERY(proxy_mysql, \"DO 1\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SELECT 1\");\n+\tdiag(\"Executing query `%s`...\", \"SELECT 1\");\n \tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n \tmysql_free_result(mysql_store_result(proxy_mysql));\n \n@@ -719,7 +717,7 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \t// Check for connections retained in 'hg 0'\n \twaited = 0;\n \twhile (waited < timeout * 2) {\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SELECT 1\");\n+\t\tdiag(\"Executing query `%s`...\", \"SELECT 1\");\n \t\tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n \t\tmysql_free_result(mysql_store_result(proxy_mysql));\n \n@@ -768,18 +766,18 @@ int check_auto_inc_delay_and_conn_delay_multiplex(MYSQL* proxy_mysql, MYSQL* pro\n \tconst char* set_delay_multiplex_query { \"SET mysql-connection_delay_multiplex_ms=2000\" };\n \tconst char* set_auto_inc_timeout_query { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex_query);\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex_query);\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_timeout_query);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_timeout_query);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_timeout_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t// Retain connection in 'hg=0'\n \tdiag(\"Checking connection not expiring due to 'auto_increment_delay_multiplex'.\");\n \n \tuint32_t waited = 0;\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \tdiag(\"* Check connection retained after executing the query\");\n@@ -797,13 +795,13 @@ int check_auto_inc_delay_and_conn_delay_multiplex(MYSQL* proxy_mysql, MYSQL* pro\n \t);\n \n \tstring_format(\"SET mysql-auto_increment_delay_multiplex_timeout_ms=%d\", auto_inc_timeout_query, timeout*2*1000);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), auto_inc_timeout_query.c_str());\n+\tdiag(\"Executing query `%s`...\", auto_inc_timeout_query.c_str());\n \tMYSQL_QUERY(proxy_admin, auto_inc_timeout_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \tdiag(\"Sleeping for '%d' seconds\", timeout + 1);\n@@ -834,17 +832,17 @@ int check_auto_inc_delay_and_conn_delay_multiplex(MYSQL* proxy_mysql, MYSQL* pro\n \t);\n \n \tstring_format(\"SET mysql-auto_increment_delay_multiplex_timeout_ms=%d\", auto_inc_timeout_query, timeout*1000);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), auto_inc_timeout_query.c_str());\n+\tdiag(\"Executing query `%s`...\", auto_inc_timeout_query.c_str());\n \tMYSQL_QUERY(proxy_admin, auto_inc_timeout_query.c_str());\n \n \tconst char* set_delay_multiplex_query_2 { \"SET mysql-connection_delay_multiplex_ms=4000\" };\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex_query_2);\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex_query_2);\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex_query_2);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \tdiag(\"Sleeping for '%d' seconds\", timeout + 1);\ndiff --git a/test/tap/tests/test_binlog_fast_forward-t.cpp b/test/tap/tests/test_binlog_fast_forward-t.cpp\nindex 6f9c98befb..c6569c7c45 100644\n--- a/test/tap/tests/test_binlog_fast_forward-t.cpp\n+++ b/test/tap/tests/test_binlog_fast_forward-t.cpp\n@@ -84,7 +84,7 @@ int pull_replication(MYSQL *mysql, int server_id) {\n \t\t\t}\n \t\t}\n \t\tif (print_diag == true)\n-\t\t\tdiag(\"%s: server_id %d , event: %d , received events: %d , received heartbeats: %d\", tap_curtime().c_str(), server_id, event->event_type, num_events, num_heartbeats);\n+\t\t\tdiag(\"server_id %d , event: %d , received events: %d , received heartbeats: %d\", server_id, event->event_type, num_events, num_heartbeats);\n \t}\n \t// we expects NHB heartbeats\n \tok(num_heartbeats == NHB , \"For server_id %d received %d heartbeats\", server_id, num_heartbeats);\ndiff --git a/test/tap/tests/test_cluster_sync-t.cpp b/test/tap/tests/test_cluster_sync-t.cpp\nindex d7f47989c3..7d1e715019 100644\n--- a/test/tap/tests/test_cluster_sync-t.cpp\n+++ b/test/tap/tests/test_cluster_sync-t.cpp\n@@ -29,8 +29,11 @@\n  *  - Check that checksum is detected and fetched by the peer node (only checksum itself).\n  *  - Check that once checksum is detected and fetched, it takes '%_diffs_before_sync' before the actual sync\n  *    is performed, error log is used to verify this.\n- *  - Finally check the config sync, the new checksum should match the previously detected.\n+ *  - Check the config sync, the new checksum should match the previously detected.\n  *    + Module 'admin_variables' may be the exception, since 'LOAD TO RUNTIME' generates a new checksum.\n+ *  - To avoid race conditions, and make the next check always start from a known state, we finally check that\n+ *    the primary has updated the monitoring checksums. This way we ensure that in the next check, a change in\n+ *    the checksum means the new computed checksum not a previous, yet not synced one.\n  *\n  *  Each sync DISABLE check consists in:\n  *\n@@ -59,11 +62,9 @@\n  */\n \n #include <unistd.h>\n-#include <signal.h>\n #include <pthread.h>\n #include <stdio.h>\n #include <time.h>\n-#include <errno.h>\n \n #include <atomic>\n #include <vector>\n@@ -72,7 +73,6 @@\n #include <iostream>\n #include <fstream>\n #include <functional>\n-#include <regex>\n #include <utility>\n \n #include \"libconfig.h\"\n@@ -100,58 +100,6 @@ using std::tuple;\n using std::fstream;\n using std::function;\n \n-/**\n- * @brief Helper function to verify that the sync of a table (or variable) have been performed.\n- *\n- * @param r_proxy_admin An already opened connection to ProxySQL.\n- * @param queries Queries to be executed that should return a **non-zero** value after the sync has taken place.\n- * @param sync_timeout Timeout for the sync to happen.\n- *\n- * @return EXIT_SUCCESS in case of success, otherwise:\n- *  - '-1' if a query against Admin fails to be performed (failure is logged).\n- *  - '-2' if timeout expired without sync being completed.\n- */\n-int sync_checker(MYSQL* r_proxy_admin, const vector<string>& queries, uint32_t sync_timeout) {\n-\tbool not_synced_query = false;\n-\tuint waited = 0;\n-\n-\twhile (waited < sync_timeout) {\n-\t\tnot_synced_query = false;\n-\n-\t\t// Check that all the entries have been synced\n-\t\tfor (const auto& query : queries) {\n-\t\t\tint q_res = mysql_query(r_proxy_admin, query.c_str());\n-\t\t\tif (q_res != EXIT_SUCCESS) {\n-\t\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(r_proxy_admin));\n-\t\t\t\treturn -1;\n-\t\t\t}\n-\n-\t\t\tMYSQL_RES* proxysql_servers_res = mysql_store_result(r_proxy_admin);\n-\t\t\tMYSQL_ROW row = mysql_fetch_row(proxysql_servers_res);\n-\t\t\tint row_value = atoi(row[0]);\n-\t\t\tmysql_free_result(proxysql_servers_res);\n-\n-\t\t\tif (row_value == 0) {\n-\t\t\t\tnot_synced_query = true;\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t}\n-\n-\t\tif (not_synced_query) {\n-\t\t\twaited += 1;\n-\t\t\tsleep(1);\n-\t\t} else {\n-\t\t\tbreak;\n-\t\t}\n-\t}\n-\n-\tif (not_synced_query) {\n-\t\treturn -2;\n-\t} else {\n-\t\treturn EXIT_SUCCESS;\n-\t}\n-}\n-\n // GLOBAL TEST PARAMETERS\n const uint32_t SYNC_TIMEOUT = 10;\n const uint32_t CONNECT_TIMEOUT = 10;\n@@ -244,30 +192,6 @@ int setup_config_file(const CommandLine& cl) {\n \treturn 0;\n }\n \n-int check_nodes_sync(\n-\tconst CommandLine& cl, const vector<mysql_res_row>& core_nodes, const string& check_query, uint32_t sync_timeout\n-) {\n-\tfor (const auto& node : core_nodes) {\n-\t\tconst string host { node[0] };\n-\t\tconst int port = std::stol(node[1]);\n-\n-\t\tMYSQL* c_node_admin = mysql_init(NULL);\n-\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(c_node_admin));\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\n-\t\tint not_synced = sync_checker(c_node_admin, { check_query }, sync_timeout);\n-\t\tif (not_synced != EXIT_SUCCESS) {\n-\t\t\tconst string err_msg { \"Node '\"  + host + \":\" + std::to_string(port) + \"' sync timed out\" };\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: `%s`\\n\", __FILE__, __LINE__, err_msg.c_str());\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\t}\n-\n-\treturn EXIT_SUCCESS;\n-}\n-\n const std::string t_debug_query = \"mysql -u%s -p%s -h %s -P%d -C -e \\\"%s\\\"\";\n \n using mysql_server_tuple = tuple<int,string,int,int,string,int,int,int,int,int,int,string>;\n@@ -942,6 +866,53 @@ int check_module_checksums_sync(\n \t\t}\n \t}\n \n+\t// Check that the primary has updated monitored checksums:\n+\t//  - It's own checksum (monitoring itself).\n+\t//  - The new checksum from replica after its sync.\n+\t// This is important to avoid race conditions. If this sync is not performed, the primary may detect the\n+\t// new checksum in the replica confusing this with the previous check.\n+\t{\n+\t\tconst char prim_repl_sync_t[] {\n+\t\t\t\"SELECT count(*) FROM stats_proxysql_servers_checksums WHERE \"\n+\t\t\t\t\"hostname='%s' AND port='%d' AND name='%s' AND checksum='%s'\"\n+\t\t};\n+\t\tcfmt_t wait_remote_chksm_syn {\n+\t\t\tcstr_format( prim_repl_sync_t,\n+\t\t\t\tconn_opts.host.c_str(),\n+\t\t\t\tconn_opts.port,\n+\t\t\t\tmodule.c_str(),\n+\t\t\t\text_checksum.str.c_str()\n+\t\t\t)\n+\t\t};\n+\t\tconst char prim_own_sync_t[] {\n+\t\t\t\"SELECT count(*) FROM stats_proxysql_servers_checksums WHERE \"\n+\t\t\t\t\"hostname='%s' AND port='%d' AND name='%s' AND checksum='%s'\"\n+\t\t};\n+\t\tcfmt_t wait_own_chksm_sync {\n+\t\t\tcstr_format(\n+\t\t\t\tprim_repl_sync_t,\n+\t\t\t\tconn_opts.host.c_str(),\n+\t\t\t\tconn_opts.port,\n+\t\t\t\tmodule.c_str(),\n+\t\t\t\text_checksum.str.c_str()\n+\t\t\t)\n+\t\t};\n+\n+\t\tint sync_res = wait_for_node_sync(admin, { wait_remote_chksm_syn.str }, CHECKSUM_SYNC_TIMEOUT);\n+\t\tok(\n+\t\t\tsync_res == 0,\n+\t\t\t\"Primary(%s:%d) has detected the new checksum '%s' in the replica(%s:%d)\",\n+\t\t\tadmin->host, admin->port, ext_checksum.str.c_str(), r_admin->host, r_admin->port\n+\t\t);\n+\n+\t\tsync_res = wait_for_node_sync(admin, { wait_remote_chksm_syn.str }, CHECKSUM_SYNC_TIMEOUT);\n+\t\tok(\n+\t\t\tsync_res == 0,\n+\t\t\t\"Primary(%s:%d) has detected its own new checksum '%s'\",\n+\t\t\tadmin->host, admin->port, ext_checksum.str.c_str()\n+\t\t);\n+\t}\n+\n \treturn EXIT_SUCCESS;\n }\n \n@@ -1139,17 +1110,31 @@ int main(int, char**) {\n \t\treturn EXIT_FAILURE;\n \t}\n \n-\tconst size_t num_pls = module_sync_payloads.size();\n+\tconst size_t dis_mod_checks = 7;\n+\tconst size_t ena_mod_checks = 5;\n+\tconst size_t sync_pls = module_sync_payloads.size();\n \n-\tconst size_t all_mod_sync_checks = ((5+(3*(num_pls-1)))*(num_pls-1))*2 + (5+(3*(num_pls-1)));\n-\tconst size_t mod_sync_checks = ((3*4*(num_pls-1)) + 3*2);\n-\tconst size_t init_mod_sync_checks = (3*2*num_pls);\n+\t// check_all_modules_sync: 'ENABLED' mods sync and 'DISABLED' doesn't - REMOTE / MAIN\n+\tconst size_t check_all_modules_sync__tests = dis_mod_checks + (ena_mod_checks * (sync_pls-1));\n+\n+\t// check_modules_checksums_sync:  All modules checksums tests\n+\tconst size_t check_modules_checksums_sync__tests =\n+\t\t// 1: All 'ENABLED' modules sync - REMOTE / MAIN\n+\t\tsync_pls * ena_mod_checks * 2 +\n+\t\t// 2: Check all mods sync but disabled one\n+\t\tcheck_all_modules_sync__tests * sync_pls +\n+\t\t// 3: Re-enable module and check sync both ways\n+\t\tena_mod_checks * 2 * sync_pls +\n+\t\t// 4: Disable module via checksums and check again\n+\t\tcheck_all_modules_sync__tests * (sync_pls - 1) +\n+\t\t// 5: Re-enable module and check sync both ways\n+\t\tena_mod_checks * 2 * (sync_pls - 1);\n \n \tplan(\n \t\t// Sync tests by values\n \t\t16 +\n-\t\t// Module with disabled sync checksum tests\n-\t\tinit_mod_sync_checks + all_mod_sync_checks + mod_sync_checks\n+\t\t// Module checkums tests; enabled and disabled checksums\n+\t\tcheck_modules_checksums_sync__tests\n \t);\n \n \tconst std::string fmt_config_file = std::string(cl.workdir) + \"test_cluster_sync_config/test_cluster_sync.cnf\";\n@@ -1188,10 +1173,9 @@ int main(int, char**) {\n \tMYSQL_QUERY(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==6032\");\n \tMYSQL_QUERY(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==16062\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n-\tMYSQL_QUERY(proxy_admin, \"SELECT hostname,port FROM proxysql_servers\");\n-\tMYSQL_RES* my_res = mysql_store_result(proxy_admin);\n-\tvector<mysql_res_row> core_nodes { extract_mysql_rows(my_res) };\n-\tmysql_free_result(my_res);\n+\n+\tpair<int,vector<srv_addr_t>> nodes_fetch { fetch_cluster_nodes(proxy_admin) };\n+\tif (nodes_fetch.first) { return EXIT_FAILURE; }\n \n \t// 3. Wait for all Core nodes to sync (confirm primary out of core nodes)\n \tstring check_no_primary_query {};\n@@ -1200,7 +1184,7 @@ int main(int, char**) {\n \t\tcheck_no_primary_query, cl.host, cl.admin_port\n \t);\n \n-\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\tint check_res = check_nodes_sync(cl, nodes_fetch.second, check_no_primary_query, SYNC_TIMEOUT);\n \tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t// 4. Remove all current servers from primary instance (only secondary sync matters)\n@@ -1967,12 +1951,14 @@ int main(int, char**) {\n \t\tstd::cout << \"MASTER TABLE BEFORE SYNC:\" << std::endl;\n \t\tsystem(print_master_proxysql_servers.c_str());\n \n-\t\tint check_res = sync_checker(r_proxy_admin, select_proxysql_servers_queries, SYNC_TIMEOUT);\n+\t\tint wait_res = proc_wait_checks(\n+\t\t\twait_for_conds(r_proxy_admin, select_proxysql_servers_queries, SYNC_TIMEOUT)\n+\t\t);\n \n \t\tstd::cout << \"REPLICA TABLE AFTER SYNC:\" << std::endl;\n \t\tsystem(print_replica_proxysql_servers.c_str());\n \n-\t\tok(check_res == EXIT_SUCCESS, \"'proxysql_servers' with should be synced: '%d'\", check_res);\n+\t\tok(wait_res == EXIT_SUCCESS, \"'proxysql_servers' with should be synced: '%d'\", wait_res);\n \n \t\t// TEARDOWN CONFIG\n \t\tMYSQL_QUERY__(proxy_admin, \"DELETE FROM proxysql_servers\");\n@@ -2009,10 +1995,13 @@ int main(int, char**) {\n \t\tsystem(print_master_proxysql_servers.c_str());\n \n \t\t// 3. Check that the servers have been synced in the replica\n-\t\tint check_res =\n-\t\t\tsync_checker(\n-\t\t\t\tr_proxy_admin, { \"SELECT CASE count(*) WHEN 0 THEN 1 ELSE 0 END from proxysql_servers\" }, SYNC_TIMEOUT\n-\t\t\t);\n+\t\tint wait_res = proc_wait_checks(\n+\t\t\twait_for_conds(\n+\t\t\t\tr_proxy_admin,\n+\t\t\t\t{ \"SELECT CASE count(*) WHEN 0 THEN 1 ELSE 0 END from proxysql_servers\" },\n+\t\t\t\tSYNC_TIMEOUT\n+\t\t\t)\n+\t\t);\n \n \t\tstd::cout << \"REPLICA TABLE AFTER SYNC:\" << std::endl;\n \t\tsystem(print_replica_proxysql_servers.c_str());\n@@ -2028,7 +2017,7 @@ int main(int, char**) {\n \t\tMYSQL_QUERY__(r_proxy_admin, \"DROP TABLE IF EXISTS proxysql_servers_backup\");\n \t\tMYSQL_QUERY__(r_proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n \n-\t\tok(check_res == EXIT_SUCCESS, \"Empty 'proxysql_servers' table ('0x00' checksum) should be synced: '%d'\", check_res);\n+\t\tok(wait_res == EXIT_SUCCESS, \"Empty 'proxysql_servers' table ('0x00' checksum) should be synced: '%d'\", wait_res);\n \t}\n \n \tsleep(2);\n@@ -2525,7 +2514,7 @@ int main(int, char**) {\n \t\t//\tstd::make_tuple(\"admin-cluster_username\"                           , \"\"                          ), Known issue, can't clear\n \t\t//\tstd::make_tuple(\"admin-cluster_password\"                           , \"\"                          ), Known issue, can't clear\n \t\t//\tstd::make_tuple(\"admin-debug\"                                      , \"false\"                     ), Should not be synced\n-//\t\t\tstd::make_tuple(\"admin-hash_passwords\"                             , \"true\"                      ), // deprecated variable\n+\t\t//\tstd::make_tuple(\"admin-hash_passwords\"                             , \"true\"                      ), // deprecated variable\n \t\t//\tstd::make_tuple(\"admin-mysql_ifaces\"                               , \"0.0.0.0:6032\"              ), // disabled because of cluster_sync_interfaces=false\n \t\t\tstd::make_tuple(\"admin-prometheus_memory_metrics_interval\"         , \"61\"                        ),\n \t\t\tstd::make_tuple(\"admin-read_only\"                                  , \"false\"                     ),\n@@ -2715,14 +2704,16 @@ int main(int, char**) {\n \t\t\tinsert_query, cl.host, cl.admin_port\n \t\t);\n \n-\t\tfor (const auto& row : core_nodes) {\n-\t\t\tconst string host { row[0] };\n-\t\t\tconst int port = std::stol(row[1]);\n+\t\tfor (const auto& node : nodes_fetch.second) {\n \t\t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n-\t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", host.c_str(), port);\n+\t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", node.host.c_str(), node.port);\n \n-\t\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n+\t\t\tif (\n+\t\t\t\t!mysql_real_connect(\n+\t\t\t\t\tc_node_admin, node.host.c_str(), cl.admin_username, cl.admin_password, NULL, node.port, NULL, 0\n+\t\t\t\t)\n+\t\t\t) {\n \t\t\t\tconst string err_msg {\n \t\t\t\t\t\"Connection to core node failed with '\" + string { mysql_error(c_node_admin) } + \"'. Retrying...\"\n \t\t\t\t};\n@@ -2751,7 +2742,7 @@ int main(int, char**) {\n \t\t);\n \n \t\t// Wait for the other nodes to sync ProxySQL servers to include Primary\n-\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\tint check_res = check_nodes_sync(cl, nodes_fetch.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t\t// Recover the old ProxySQL servers from backup in primary\ndiff --git a/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp b/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp\nindex 4a84270c2f..6b4c8f4f9d 100644\n--- a/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp\n+++ b/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp\n@@ -24,20 +24,16 @@\n  */\n \n #include <unistd.h>\n-#include <signal.h>\n #include <pthread.h>\n #include <stdio.h>\n #include <time.h>\n-#include <errno.h>\n \n #include <atomic>\n #include <vector>\n #include <string>\n #include <thread>\n #include <iostream>\n-#include <fstream>\n #include <functional>\n-#include <regex>\n #include <utility>\n \n #include \"libconfig.h\"\n@@ -53,7 +49,9 @@\n #include \"command_line.h\"\n #include \"utils.h\"\n \n+using std::pair;\n using std::string;\n+using std::vector;\n \n #define MYSQL_QUERY__(mysql, query) \\\n \tdo { \\\n@@ -132,83 +130,6 @@ uint64_t mysql_servers_raw_checksum(MYSQL_RES* resultset) {\n \treturn res_hash;\n }\n \n-\n-/**\n- * @brief Helper function to verify that the sync of a table (or variable) have been performed.\n- *\n- * @param r_proxy_admin An already opened connection to ProxySQL.\n- * @param queries Queries to be executed that should return a **non-zero** value after the sync has taken place.\n- * @param sync_timeout Timeout for the sync to happen.\n- *\n- * @return EXIT_SUCCESS in case of success, otherwise:\n- *  - '-1' if a query against Admin fails to be performed (failure is logged).\n- *  - '-2' if timeout expired without sync being completed.\n- */\n-int sync_checker(MYSQL* r_proxy_admin, const std::vector<std::string>& queries, uint32_t sync_timeout) {\n-\tbool not_synced_query = false;\n-\tuint waited = 0;\n-\n-\twhile (waited < sync_timeout) {\n-\t\tnot_synced_query = false;\n-\n-\t\t// Check that all the entries have been synced\n-\t\tfor (const auto& query : queries) {\n-\t\t\tint q_res = mysql_query(r_proxy_admin, query.c_str());\n-\t\t\tif (q_res != EXIT_SUCCESS) {\n-\t\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(r_proxy_admin));\n-\t\t\t\treturn -1;\n-\t\t\t}\n-\n-\t\t\tMYSQL_RES* proxysql_servers_res = mysql_store_result(r_proxy_admin);\n-\t\t\tMYSQL_ROW row = mysql_fetch_row(proxysql_servers_res);\n-\t\t\tint row_value = atoi(row[0]);\n-\t\t\tmysql_free_result(proxysql_servers_res);\n-\n-\t\t\tif (row_value == 0) {\n-\t\t\t\tnot_synced_query = true;\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t}\n-\n-\t\tif (not_synced_query) {\n-\t\t\twaited += 1;\n-\t\t\tsleep(1);\n-\t\t} else {\n-\t\t\tbreak;\n-\t\t}\n-\t}\n-\n-\tif (not_synced_query) {\n-\t\treturn -2;\n-\t} else {\n-\t\treturn EXIT_SUCCESS;\n-\t}\n-}\n-\n-int check_nodes_sync(\n-\tconst CommandLine& cl, const std::vector<mysql_res_row>& core_nodes, const std::string& check_query, uint32_t sync_timeout\n-) {\n-\tfor (const auto& node : core_nodes) {\n-\t\tconst std::string host { node[0] };\n-\t\tconst int port = std::stol(node[1]);\n-\n-\t\tMYSQL* c_node_admin = mysql_init(NULL);\n-\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(c_node_admin));\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\n-\t\tint not_synced = sync_checker(c_node_admin, { check_query }, sync_timeout);\n-\t\tif (not_synced != EXIT_SUCCESS) {\n-\t\t\tconst std::string err_msg { \"Node '\"  + host + \":\" + std::to_string(port) + \"' sync timed out\" };\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: `%s`\\n\", __FILE__, __LINE__, err_msg.c_str());\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\t}\n-\n-\treturn EXIT_SUCCESS;\n-}\n-\n int insert_mysql_servers_records(MYSQL* proxy_admin, const std::vector<mysql_server_tuple>& insert_mysql_servers_values, \n \tconst std::vector<replication_hostgroups_tuple>& insert_replication_hostgroups_values) {\n \n@@ -860,15 +781,15 @@ int main(int, char**) {\n \t// 2. Remove primary from Core nodes\n \tMYSQL_QUERY(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==6032\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n-\tMYSQL_QUERY(proxy_admin, \"SELECT hostname,port FROM proxysql_servers\");\n-\tMYSQL_RES* my_res = mysql_store_result(proxy_admin);\n-\tstd::vector<mysql_res_row> core_nodes { extract_mysql_rows(my_res) };\n-\tmysql_free_result(my_res);\n+\n+\tpair<int,vector<srv_addr_t>> core_nodes { fetch_cluster_nodes(proxy_admin) };\n+\tif (core_nodes.first) { return EXIT_FAILURE; }\n \n \t// 2.1 If core nodes are not reachable, assume no cluster is running; make test gracefully exit\n-\tif (core_nodes.size()) {\n-\t\tconst string host { core_nodes[0][0] };\n-\t\tconst int port = std::stol(core_nodes[0][1]);\n+\tif (core_nodes.second.size()) {\n+\t\tconst string host { core_nodes.second[0].host };\n+\t\tconst int port { core_nodes.second[0].port };\n+\n \t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n \t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n@@ -894,7 +815,7 @@ int main(int, char**) {\n \t\tcheck_no_primary_query, cl.host, cl.admin_port\n \t);\n \n-\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t// 4. Remove all current servers from primary instance (only secondary sync matters)\n@@ -1048,9 +969,9 @@ int main(int, char**) {\n \t\t\tinsert_query, cl.host, cl.admin_port\n \t\t);\n \n-\t\tfor (const auto& row : core_nodes) {\n-\t\t\tconst std::string host { row[0] };\n-\t\t\tconst int port = std::stol(row[1]);\n+\t\tfor (const auto& node : core_nodes.second) {\n+\t\t\tconst std::string host { node.host };\n+\t\t\tconst int port = node.port;\n \t\t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n \t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", host.c_str(), port);\n@@ -1084,7 +1005,7 @@ int main(int, char**) {\n \t\t);\n \n \t\t// Wait for the other nodes to sync ProxySQL servers to include Primary\n-\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t\t// Recover the old ProxySQL servers from backup in primary\ndiff --git a/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp b/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp\nindex 90380e20f9..7ab4af208e 100644\n--- a/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp\n+++ b/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp\n@@ -1,8 +1,8 @@\n-\n #include <unistd.h>\n-#include <atomic>\n #include <vector>\n #include <string>\n+#include <utility>\n+#include <vector>\n \n #include \"mysql.h\"\n #include \"tap.h\"\n@@ -15,6 +15,9 @@\n //#define BACKEND_SERVER_USER\t\"root\"\n //#define BACKEND_SERVER_PASS \"root\"\n \n+using std::vector;\n+using std::pair;\n+\n #define MYSQL_QUERY__(mysql, query) \\\n \tdo { \\\n \t\tif (mysql_query(mysql, query)) { \\\n@@ -49,87 +52,6 @@ MYSQL* create_new_connection(const char* host, const char* username, const char*\n \treturn mysql;\n }\n \n-/**\n- * @brief Helper function to verify that the sync of a table (or variable) have been performed.\n- *\n- * @param r_proxy_admin An already opened connection to ProxySQL.\n- * @param queries Queries to be executed that should return a **non-zero** value after the sync has taken place.\n- * @param sync_timeout Timeout for the sync to happen.\n- *\n- * @return EXIT_SUCCESS in case of success, otherwise:\n- *  - '-1' if a query against Admin fails to be performed (failure is logged).\n- *  - '-2' if timeout expired without sync being completed.\n- */\n-int sync_checker(MYSQL* r_proxy_admin, const std::vector<std::string>& queries, uint32_t sync_timeout) {\n-\tbool not_synced_query = false;\n-\tuint waited = 0;\n-\n-\twhile (waited < sync_timeout) {\n-\t\tnot_synced_query = false;\n-\n-\t\t// Check that all the entries have been synced\n-\t\tfor (const auto& query : queries) {\n-\t\t\tint q_res = mysql_query(r_proxy_admin, query.c_str());\n-\t\t\tif (q_res != EXIT_SUCCESS) {\n-\t\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(r_proxy_admin));\n-\t\t\t\treturn -1;\n-\t\t\t}\n-\n-\t\t\tMYSQL_RES* proxysql_servers_res = mysql_store_result(r_proxy_admin);\n-\t\t\tMYSQL_ROW row = mysql_fetch_row(proxysql_servers_res);\n-\t\t\tint row_value = atoi(row[0]);\n-\t\t\tmysql_free_result(proxysql_servers_res);\n-\n-\t\t\tif (row_value == 0) {\n-\t\t\t\tnot_synced_query = true;\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t}\n-\n-\t\tif (not_synced_query) {\n-\t\t\twaited += 1;\n-\t\t\tsleep(1);\n-\t\t} else {\n-\t\t\tbreak;\n-\t\t}\n-\t}\n-\n-\tif (not_synced_query) {\n-\t\treturn -2;\n-\t} else {\n-\t\treturn EXIT_SUCCESS;\n-\t}\n-}\n-\n-int check_nodes_sync(\n-\tconst CommandLine& cl, const std::vector<mysql_res_row>& core_nodes, const std::string& check_query, uint32_t sync_timeout\n-) {\n-\tint ret_status = EXIT_FAILURE;\n-\n-\tfor (const auto& node : core_nodes) {\n-\t\tconst std::string host { node[0] };\n-\t\tconst int port = std::stol(node[1]);\n-\n-\t\tMYSQL* c_node_admin = mysql_init(NULL);\n-\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(c_node_admin));\n-\t\t\tgoto __exit;\n-\t\t}\n-\n-\t\tint not_synced = sync_checker(c_node_admin, { check_query }, sync_timeout);\n-\t\tif (not_synced != EXIT_SUCCESS) {\n-\t\t\tconst std::string err_msg { \"Node '\"  + host + \":\" + std::to_string(port) + \"' sync timed out\" };\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: `%s`\\n\", __FILE__, __LINE__, err_msg.c_str());\n-\t\t\tgoto __exit;\n-\t\t}\n-\t}\n-\n-\tret_status = EXIT_SUCCESS;\n-\n-__exit:\n-\treturn ret_status;\n-}\n-\n int insert_mysql_servers_records(MYSQL* proxy_admin, const std::vector<mysql_server_tuple>& insert_mysql_servers_values, \n \tconst std::vector<replication_hostgroups_tuple>& insert_replication_hostgroups_values) {\n \n@@ -535,7 +457,7 @@ int test_scenario_2(MYSQL* proxy_admin, const CommandLine& cl) {\n \n int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& cl, bool isolate_primary_node) {\n \n-\tstd::vector<mysql_res_row> core_nodes;\n+\tpair<int,vector<srv_addr_t>> core_nodes;\n \tstd::string check_no_primary_query;\n \n \tif (isolate_primary_node) {\n@@ -553,10 +475,9 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t// 2. Remove primary from Core nodes\n \t\tMYSQL_QUERY__(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==6032\");\n \t\tMYSQL_QUERY__(proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n-\t\tMYSQL_QUERY__(proxy_admin, \"SELECT hostname,port FROM proxysql_servers\");\n-\t\tMYSQL_RES* my_res = mysql_store_result(proxy_admin);\n-\t\tcore_nodes = { extract_mysql_rows(my_res) };\n-\t\tmysql_free_result(my_res);\n+\n+\t\tcore_nodes = fetch_cluster_nodes(proxy_admin);\n+\t\tif (core_nodes.first) { goto cleanup; }\n \n \t\t// 3. Wait for all Core nodes to sync (confirm primary out of core nodes)\n \t\tstring_format(\n@@ -564,7 +485,7 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t\tcheck_no_primary_query, cl.host, cl.admin_port\n \t\t);\n \n-\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\tif (check_res != EXIT_SUCCESS) {\n \t\t\tgoto cleanup;\n \t\t}\n@@ -601,9 +522,9 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t\t\tinsert_query, cl.host, cl.admin_port\n \t\t\t);\n \n-\t\t\tfor (const auto& row : core_nodes) {\n-\t\t\t\tconst std::string host{ row[0] };\n-\t\t\t\tconst int port = std::stol(row[1]);\n+\t\t\tfor (const auto& row : core_nodes.second) {\n+\t\t\t\tconst std::string host{ row.host };\n+\t\t\t\tconst int port = row.port;\n \t\t\t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n \t\t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", host.c_str(), port);\n@@ -637,7 +558,7 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t\t);\n \n \t\t\t// Wait for the other nodes to sync ProxySQL servers to include Primary\n-\t\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\t\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\t\tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t\t\t// Recover the old ProxySQL servers from backup in primary\ndiff --git a/test/tap/tests/test_session_status_flags-t.cpp b/test/tap/tests/test_session_status_flags-t.cpp\nindex 181c2561b5..2849fa49e8 100644\n--- a/test/tap/tests/test_session_status_flags-t.cpp\n+++ b/test/tap/tests/test_session_status_flags-t.cpp\n@@ -172,7 +172,7 @@ int prepare_stmt_queries(const CommandLine& cl, const vector<query_t>& p_queries\n \t// 1. Prepare the stmt in a connection\n \tMYSQL* proxy_mysql = mysql_init(NULL);\n \n-\tdiag(\"%s: Openning INITIAL connection...\", tap_curtime().c_str());\n+\tdiag(\"Openning INITIAL connection...\");\n \tif (!mysql_real_connect(proxy_mysql, cl.root_host, cl.root_username, cl.root_password, NULL, cl.root_port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxy_mysql));\n \t\treturn EXIT_FAILURE;\n@@ -216,7 +216,7 @@ int prepare_stmt_queries(const CommandLine& cl, const vector<query_t>& p_queries\n \t\t\treturn EXIT_FAILURE;\n \t\t}\n \n-\t\tdiag(\"%s: Issuing PREPARE for `%s` in INIT conn\", tap_curtime().c_str(), query.c_str());\n+\t\tdiag(\"Issuing PREPARE for `%s` in INIT conn\", query.c_str());\n \t\tint my_err = mysql_stmt_prepare(stmt, query.c_str(), strlen(query.c_str()));\n \t\tif (my_err) {\n \t\t\tdiag(\n@@ -229,7 +229,7 @@ int prepare_stmt_queries(const CommandLine& cl, const vector<query_t>& p_queries\n \t\tmysql_stmt_close(stmt);\n \t}\n \n-\tdiag(\"%s: Closing PREPARING connection...\", tap_curtime().c_str());\n+\tdiag(\"Closing PREPARING connection...\");\n \tmysql_close(proxy_mysql);\n \n \treturn EXIT_SUCCESS;\n@@ -326,7 +326,7 @@ int exec_stmt_queries(MYSQL* proxy_mysql, const vector<query_t>& test_queries) {\n \t\t} else {\n \t\t\tMYSQL_STMT* stmt = mysql_stmt_init(proxy_mysql);\n \n-\t\t\tdiag(\"%s: Issuing PREPARE for `%s` in new conn\", tap_curtime().c_str(), query.c_str());\n+\t\t\tdiag(\"Issuing PREPARE for `%s` in new conn\", query.c_str());\n \t\t\tint my_err = mysql_stmt_prepare(stmt, query.c_str(), strlen(query.c_str()));\n \t\t\tif (my_err) {\n \t\t\t\tdiag(\n@@ -339,7 +339,7 @@ int exec_stmt_queries(MYSQL* proxy_mysql, const vector<query_t>& test_queries) {\n \t\t\t// TODO: Remember to DOC requiring to execute\n \t\t\t{\n \t\t\t\tif (rep_check.first == 0 || rep_check.second == 0) {\n-\t\t\t\t\tdiag(\"%s: Issuing EXECUTE for `%s` in new conn\", tap_curtime().c_str(), query.c_str());\n+\t\t\t\t\tdiag(\"Issuing EXECUTE for `%s` in new conn\", query.c_str());\n \t\t\t\t\tmy_err = mysql_stmt_execute(stmt);\n \t\t\t\t\tif (my_err) {\n \t\t\t\t\t\tdiag(\"'mysql_stmt_execute' at line %d failed: %s\", __LINE__, mysql_stmt_error(stmt));\ndiff --git a/test/tap/tests/test_unshun_algorithm-t.cpp b/test/tap/tests/test_unshun_algorithm-t.cpp\nindex 4a5714eaaf..7b424a7fdd 100644\n--- a/test/tap/tests/test_unshun_algorithm-t.cpp\n+++ b/test/tap/tests/test_unshun_algorithm-t.cpp\n@@ -59,12 +59,12 @@\n \n #include <cstring>\n #include <unistd.h>\n-#include <vector>\n #include <string>\n #include <stdio.h>\n+#include <utility>\n+#include <vector>\n \n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"proxysql_utils.h\"\n #include \"tap.h\"\n@@ -74,14 +74,17 @@\n const uint32_t SHUN_RECOVERY_TIME = 1;\n const uint32_t VALID_RANGE = 1;\n const uint32_t SERVERS_COUNT = 10;\n+const uint32_t SYNC_TIMEOUT = 10;\n \n+using std::pair;\n using std::string;\n+using std::vector;\n \n int shunn_server(MYSQL* proxysql_admin, uint32_t i, uint32_t j) {\n \tstd::string t_simulator_error_query { \"PROXYSQL_SIMULATOR mysql_error %d 127.0.0.1:330%d 1234\" };\n \tstd::string simulator_error_q_i {};\n \tstring_format(t_simulator_error_query, simulator_error_q_i, i, j);\n-\tdiag(\"%s: running query: %s\", tap_curtime().c_str(), simulator_error_q_i.c_str());\n+\tdiag(\"running query: %s\", simulator_error_q_i.c_str());\n \tMYSQL_QUERY(proxysql_admin, simulator_error_q_i.c_str());\n \n \treturn EXIT_SUCCESS;\n@@ -113,7 +116,7 @@ int wakup_target_server(MYSQL* proxysql_mysql, uint32_t i) {\n \tstring_format(t_simple_do_query, simple_do_query, i);\n \n \tmysql_query(proxysql_mysql, simple_do_query.c_str());\n-\tdiag(\"%s: running query: %s\", tap_curtime().c_str(), simple_do_query.c_str());\n+\tdiag(\"running query: %s\", simple_do_query.c_str());\n \n \treturn EXIT_SUCCESS;\n }\n@@ -124,7 +127,7 @@ int server_status_checker(MYSQL* admin, const string& f_st, const string& n_st,\n \t};\n \tstd::string server_status_query {};\n \tstring_format(t_server_status_query, server_status_query, i);\n-\tdiag(\"%s: running query: %s\", tap_curtime().c_str(), server_status_query.c_str());\n+\tdiag(\"running query: %s\", server_status_query.c_str());\n \tMYSQL_QUERY(admin, server_status_query.c_str());\n \n \tMYSQL_RES* status_res = mysql_store_result(admin);\n@@ -190,9 +193,9 @@ int test_unshun_algorithm_variable(MYSQL* proxysql_admin) {\n \t};\n \n \tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES FROM DISK\");\n-\tdiag(\"%s: Line:%d running admin query to reload variables: LOAD MYSQL VARIABLES FROM DISK\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query to reload variables: LOAD MYSQL VARIABLES FROM DISK\", __LINE__);\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-hostgroup_manager_verbose=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", __LINE__);\n \tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tint32_t def_unshun_value = get_current_unshun_algorithm_val(proxysql_admin);\n \tok(def_unshun_value == 0, \"Default 'mysql-unshun_algorithm' should be '0', actual: %d\", def_unshun_value);\n@@ -203,7 +206,7 @@ int test_unshun_algorithm_variable(MYSQL* proxysql_admin) {\n \t\tstd::string set_unshun {};\n \t\tstring_format(t_set_unshun, set_unshun, i);\n \t\tMYSQL_QUERY(proxysql_admin, set_unshun.c_str());\n-\t\tdiag(\"%s: Line:%d running admin query: %s\", tap_curtime().c_str(), __LINE__, set_unshun.c_str());\n+\t\tdiag(\"Line:%d running admin query: %s\", __LINE__, set_unshun.c_str());\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint32_t cur_unshun_val = get_current_unshun_algorithm_val(proxysql_admin);\n@@ -214,7 +217,7 @@ int test_unshun_algorithm_variable(MYSQL* proxysql_admin) {\n \t\tstd::string set_unshun {};\n \t\tstring_format(t_set_unshun, set_unshun, VALID_RANGE + 1);\n \t\tMYSQL_QUERY(proxysql_admin, set_unshun.c_str());\n-\t\tdiag(\"%s: Line:%d running admin query: %s\", tap_curtime().c_str(), __LINE__, set_unshun.c_str());\n+\t\tdiag(\"Line:%d running admin query: %s\", __LINE__, set_unshun.c_str());\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint32_t cur_unshun_val = get_current_unshun_algorithm_val(proxysql_admin);\n@@ -273,13 +276,13 @@ int test_proxysql_simulator_error(MYSQL* proxysql_admin) {\n  */\n int configure_mysql_shunning_variables(MYSQL* proxysql_admin) {\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-shun_on_failures=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-shun_on_failures=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-shun_on_failures=3\", __LINE__);\n \n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-connect_retries_on_failure=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-connect_retries_on_failure=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-connect_retries_on_failure=3\", __LINE__);\n \n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-connect_retries_delay=1000\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-connect_retries_delay=1000\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-connect_retries_delay=1000\", __LINE__);\n \n \treturn EXIT_SUCCESS;\n }\n@@ -287,11 +290,11 @@ int configure_mysql_shunning_variables(MYSQL* proxysql_admin) {\n int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin) {\n \t// Configure Admin variables with lower thresholds\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-shun_recovery_time_sec=1\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-shun_recovery_time_sec=1\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-shun_recovery_time_sec=1\", __LINE__);\n \n \t// Set verbosity up for extra information in ProxySQL log\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-hostgroup_manager_verbose=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", __LINE__);\n \n \t// Configure the relevant variables for the desired UNSHUNNING behavior\n \tif (configure_mysql_shunning_variables(proxysql_admin)) {\n@@ -324,7 +327,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \n \t{\n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=0\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=0\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=0\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint shunn_err = shunn_all_servers(proxysql_admin);\n@@ -344,7 +347,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \n \t{\n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=1\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=1\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=1\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint shunn_err = shunn_all_servers(proxysql_admin);\n@@ -364,7 +367,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \n \t{\n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=0\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=0\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=0\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint shunn_err = shunn_all_servers(proxysql_admin);\n@@ -376,7 +379,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \t\tdiag(\" \"); // empty line\n \n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=1\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=1\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=1\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tfor (uint32_t i = 0; i < SERVERS_COUNT; i++) {\n@@ -426,8 +429,43 @@ int main(int argc, char** argv) {\n \t}\n \n \t// Disable Monitor for the following tests\n-\tMYSQL_QUERY(proxysql_admin, \"SET mysql-monitor_enabled=0\");\n-\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tMYSQL_QUERY_T(proxysql_admin, \"SET mysql-monitor_enabled=0\");\n+\tMYSQL_QUERY_T(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\n+\t// We need to wait for synchronization in case 'admin-cluster_mysql_servers_sync_algorithm=1' to prevent\n+\t// circular fetches. If config is set to '2' we DO NOT wait, as circular fetches shouldn't be possible,\n+\t// this way a misbehavior **could** be detected by the test. We do not enforce failure either.\n+\t{\n+\t\tconst char sync_algo_query[] {\n+\t\t\t\"SELECT variable_value FROM global_variables\"\n+\t\t\t\t\" WHERE variable_name='admin-cluster_mysql_servers_sync_algorithm'\",\n+\t\t};\n+\t\text_val_t<int32_t> servers_sync_algo { mysql_query_ext_val(proxysql_admin, sync_algo_query, 1) };\n+\t\tif (servers_sync_algo.err != EXIT_SUCCESS) {\n+\t\t\tconst string err { get_ext_val_err(proxysql_admin, servers_sync_algo) };\n+\t\t\tdiag(\"Failed getting variable   query:`%s`, err:`%s`\", sync_algo_query, err.c_str());\n+\t\t\tgoto cleanup;\n+\t\t}\n+\n+\t\t// NOTE: '3' is a configuration thought for replicas, this test assumes it's connecting to a\n+\t\t// primary, so the same protection should be applied.\n+\t\tif (servers_sync_algo.val == 1 || servers_sync_algo.val == 3) {\n+\t\t\tconst pair<int,vector<srv_addr_t>> core_nodes { fetch_cluster_nodes(proxysql_admin) };\n+\t\t\tif (core_nodes.first) {\n+\t\t\t\tdiag(\"Cluster node fetching failed with mysql_errno=%d\", core_nodes.first);\n+\t\t\t\tgoto cleanup;\n+\t\t\t}\n+\n+\t\t\tconst char sync_query[] {\n+\t\t\t\t\"SELECT CASE WHEN \"\n+\t\t\t\t\t\"(SELECT variable_value FROM runtime_global_variables WHERE\"\n+\t\t\t\t\t\t\" variable_name='mysql-monitor_enabled')='false'\"\n+\t\t\t\t\t\" THEN 1 ELSE 0 END\"\n+\t\t\t};\n+\t\t\tint check_res = check_nodes_sync(cl, core_nodes.second, sync_query, SYNC_TIMEOUT);\n+\t\t\tif (check_res != EXIT_SUCCESS) { goto cleanup; }\n+\t\t}\n+\t}\n \n \t{\n \t\tint simulator_err = test_proxysql_simulator_error(proxysql_admin);\n", "problem_statement": "Handle nicely `SET` failure with `ER_WRONG_ARGUMENTS` for `sql_generate_invisible_primary_key`\n## Description\r\n\r\nIf you are submitting a reproducible bug report, please provide:\r\n\r\n- [x] A clear description of the issue\r\n\r\nMySQL has changed how the setting `sql_generate_invisible_primary_key` is reported for `Galera`. For version `8.0.28-26.10` error was still `ER_UNKNOWN_SYSTEM_VARIABLE`, yet in newer versions like `8.0.34-26.15` error has changed to `ER_WRONG_ARGUMENTS`:\r\n\r\n```\r\nAnd the error reported by MySQL is now ERROR 1210 (HY000): Variable not supported in combination with Galera\r\n```\r\n\r\nSince this error is equivalent to the one previously reported as `ER_UNKNOWN_SYSTEM_VARIABLE`, we should identify it and handle it the same way we previously did.\r\n\r\n- [x] ProxySQL version\r\n\r\nDevelopment branch `2.x`.\r\n\r\n- [x] The steps to reproduce the issue\r\n\r\nCreate a `mysql` session against ProxySQL using `MySQL Galera` with server version `8.0.34-26.15`. Change the value for `sql_generate_invisible_primary_key` and perform a query. ProxySQL reports the following in the error log:\r\n\r\n```\r\n2024-07-17 11:17:02 MySQL_Session.cpp:2970:handler_again___status_SETTING_GENERIC_VARIABLE(): [WARNING] Error while setting sql_generate_invisible_primary_key to \"ON\" on 127.0.0.1:15307 hg 101 :  1210, Variable not supported in combination with Galera\r\n```\r\n\r\n## Fix\r\n\r\nProposed fix is bundled in PR #4588. \r\n\n", "hints_text": "", "created_at": "2024-07-12 17:02:56", "merge_commit_sha": "01d1fc9828a5da09896acd2287be48335bbc1ada", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["builds (testreadonly)", ".github/workflows/CI-maketest.yml"], ["select (ubuntu22-tap, mysql57)", ".github/workflows/CI-taptests-groups.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (testaurora)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (debian11)", ".github/workflows/CI-builds.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-laravel-framework.yml"], ["builds (testall)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-mysql-connector-j.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (testgalera)", ".github/workflows/CI-maketest.yml"], ["Analyze (ubuntu22-tap, python)", ".github/workflows/CI-codeql.yml"], ["builds (ubuntu16)", ".github/workflows/CI-builds.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-basictests.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-selftests.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-php-pdo-mysql.yml"], ["test (debian11, mariadb10)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (ubuntu22, -clang)", ".github/workflows/CI-builds.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-django-framework.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4518", "base_commit": "57bf59aefdc4d10e2905a46f4a4e8bad23efbba1", "patch": "diff --git a/include/proxysql_admin.h b/include/proxysql_admin.h\nindex 6906091cc7..d46933a331 100644\n--- a/include/proxysql_admin.h\n+++ b/include/proxysql_admin.h\n@@ -394,6 +394,8 @@ class ProxySQL_Admin {\n \tvoid public_add_active_users(enum cred_username_type usertype, char *user=NULL) {\n \t\t__add_active_users(usertype, user);\n \t}\n+\t// @brief True if all ProxySQL modules have been already started. End of 'phase3'.\n+\tbool all_modules_started;\n \tProxySQL_Admin();\n \t~ProxySQL_Admin();\n \tSQLite3DB *admindb;\t// in memory\n@@ -416,6 +418,18 @@ class ProxySQL_Admin {\n \t */\n \tbool init(const bootstrap_info_t& bootstrap_info);\n \tvoid init_ldap();\n+\t/** @brief Initializes the HTTP server. For safety should be called after 'phase3'. */\n+\tvoid init_http_server();\n+\t/**\n+\t * @brief Loads the HTTP server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_http_server();\n+\t/**\n+\t * @brief Loads the RESTAPI server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_restapi_server();\n \tbool get_read_only() { return variables.admin_read_only; }\n \tbool set_read_only(bool ro) { variables.admin_read_only=ro; return variables.admin_read_only; }\n \tbool has_variable(const char *name);\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex 17ac811b0c..ae9b3e4502 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -6115,6 +6115,12 @@ void ProxySQL_Admin::init_ldap() {\n \t}\n }\n \n+void ProxySQL_Admin::init_http_server() {\n+\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n+\tAdminHTTPServer->init();\n+\tAdminHTTPServer->print_version();\n+}\n+\n struct boot_srv_info_t {\n \tstring member_id;\n \tstring member_host;\n@@ -6381,10 +6387,6 @@ bool ProxySQL_Admin::init(const bootstrap_info_t& bootstrap_info) {\n \tcpu_timer cpt;\n \n \tAdmin_HTTP_Server = NULL;\n-\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n-\tAdminHTTPServer->init();\n-\tAdminHTTPServer->print_version();\n-\n \tAdminRestApiServer = NULL;\n /*\n \tAdminRestApiServer = new ProxySQL_RESTAPI_Server();\n@@ -7220,6 +7222,167 @@ void ProxySQL_Admin::load_or_update_global_settings(SQLite3DB *db) {\n \t}\n }\n \n+void ProxySQL_Admin::load_restapi_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n+\t\t[this](const httpserver::http_request& request) {\n+\t\t\tauto headers = request_headers(request);\n+\t\t\tauto serial_response = this->serial_exposer(headers);\n+\t\t\tauto http_response = make_response(serial_response);\n+\n+\t\t\treturn http_response;\n+\t\t}\n+\t};\n+\n+\tbool free_restapi_port = false;\n+\n+\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n+\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n+\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n+\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n+\n+\t\tif (restapi_port_free == false) {\n+\t\t\tif (e_port_check == -1) {\n+\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n+\t\t\t} else {\n+\t\t\t\tproxy_error(\n+\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n+\t\t\t\t\tvariables.restapi_port\n+\t\t\t\t);\n+\t\t\t}\n+\t\t}\n+\t};\n+\n+\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n+\t\tif (variables.restapi_enabled) {\n+\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t}\n+\n+\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t);\n+\t\t} else {\n+\t\t\tdelete AdminRestApiServer;\n+\t\t\tAdminRestApiServer = NULL;\n+\t\t}\n+\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n+\t} else {\n+\t\tif (variables.restapi_port != variables.restapi_port_old) {\n+\t\t\tif (AdminRestApiServer) {\n+\t\t\t\tdelete AdminRestApiServer;\n+\t\t\t\tAdminRestApiServer = NULL;\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled) {\n+\t\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t\t);\n+\t\t\t}\n+\t\t\tvariables.restapi_port_old = variables.restapi_port;\n+\t\t}\n+\t}\n+}\n+\n+void ProxySQL_Admin::load_http_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tif (variables.web_enabled != variables.web_enabled_old) {\n+\t\tif (variables.web_enabled) {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tchar *key_pem;\n+\t\t\t\tchar *cert_pem;\n+\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tint sfd = 0;\n+\t\t\t\t\tint reuseaddr = 1;\n+\t\t\t\t\tstruct sockaddr_in tmp_addr;\n+\n+\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n+\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n+\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n+\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n+\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n+\n+\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n+\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n+\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n+\t\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t\t);\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tGloWebInterface->stop();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tvariables.web_enabled_old = variables.web_enabled;\n+\t} else {\n+\t\tif (variables.web_port != variables.web_port_old) {\n+\t\t\tif (variables.web_enabled) {\n+\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t\t\tchar *key_pem;\n+\t\t\t\t\tchar *cert_pem;\n+\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t\t} else {\n+\t\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tvariables.web_port_old = variables.web_port;\n+\t\t}\n+\t}\n+}\n+\n void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \tSQLite3DB *db, bool replace, const string& checksum, const time_t epoch, bool lock\n ) {\n@@ -7308,157 +7471,8 @@ void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \t\t}\n \t\twrunlock();\n \t\t{\n-\t\t\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n-\t\t\t\t[this](const httpserver::http_request& request) {\n-\t\t\t\t\tauto headers = request_headers(request);\n-\t\t\t\t\tauto serial_response = this->serial_exposer(headers);\n-\t\t\t\t\tauto http_response = make_response(serial_response);\n-\n-\t\t\t\t\treturn http_response;\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tbool free_restapi_port = false;\n-\n-\t\t\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n-\t\t\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n-\t\t\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n-\t\t\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n-\n-\t\t\t\tif (restapi_port_free == false) {\n-\t\t\t\t\tif (e_port_check == -1) {\n-\t\t\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\tvariables.restapi_port\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n-\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t}\n-\n-\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t);\n-\t\t\t\t} else {\n-\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t}\n-\t\t\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.restapi_port != variables.restapi_port_old) {\n-\t\t\t\t\tif (AdminRestApiServer) {\n-\t\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.restapi_port_old = variables.restapi_port;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\tif (variables.web_enabled != variables.web_enabled_old) {\n-\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tint sfd = 0;\n-\t\t\t\t\t\t\tint reuseaddr = 1;\n-\t\t\t\t\t\t\tstruct sockaddr_in tmp_addr;\n-\n-\t\t\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n-\t\t\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n-\t\t\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n-\t\t\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n-\t\t\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n-\n-\t\t\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n-\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n-\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t} else {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tGloWebInterface->stop();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tvariables.web_enabled_old = variables.web_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.web_port != variables.web_port_old) {\n-\t\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.web_port_old = variables.web_port;\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\tload_http_server();\n+\t\t\tload_restapi_server();\n \t\t\t// Update the admin variable for 'web_verbosity'\n \t\t\tadmin___web_verbosity = variables.web_verbosity;\n \t\t}\ndiff --git a/lib/ProxySQL_HTTP_Server.cpp b/lib/ProxySQL_HTTP_Server.cpp\nindex ff38885582..d8affaf396 100644\n--- a/lib/ProxySQL_HTTP_Server.cpp\n+++ b/lib/ProxySQL_HTTP_Server.cpp\n@@ -586,7 +586,7 @@ int ProxySQL_HTTP_Server::handler(void *cls, struct MHD_Connection *connection,\n \t\t\tdelete cpu_sqlite;\n \t\t\t\n \t\t\ts.append(\"</body></html>\");\n-\t \t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_PERSISTENT); \n+\t\t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_MUST_COPY);\n   \t\t\tret = MHD_queue_response (connection, MHD_HTTP_OK, response);\n   \t\t\tMHD_destroy_response (response);\n \t\t\treturn ret;\ndiff --git a/src/main.cpp b/src/main.cpp\nindex aaac09822c..cfe5f4ff93 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1145,7 +1145,6 @@ void ProxySQL_Main_init_phase3___start_all() {\n \t\tGloAdmin->init_mysql_servers();\n \t\tGloAdmin->init_proxysql_servers();\n \t\tGloAdmin->load_scheduler_to_runtime();\n-\t\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n #ifdef DEBUG\n \t\tstd::cerr << \"Main phase3 : GloAdmin initialized in \";\n #endif\n@@ -1217,6 +1216,17 @@ void ProxySQL_Main_init_phase3___start_all() {\n \tif (GloMyLdapAuth) {\n \t\tGloAdmin->init_ldap_variables();\n \t}\n+\n+\t// HTTP Server should be initialized after other modules. See #4510\n+\tGloAdmin->init_http_server();\n+\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n+\n+\t// Signal ProxySQL_Admin that all modules have been started\n+\tGloAdmin->all_modules_started = true;\n+\n+\t// Load the config not previously loaded for these modules\n+\tGloAdmin->load_http_server();\n+\tGloAdmin->load_restapi_server();\n }\n \n \n", "test_patch": "", "problem_statement": "The HTTP server should starts at the end of ProxySQL Admin\nUp to version 2.6.2 , in `ProxySQL_Admin::init()` the HTTP server is started at the very beginning:\r\n\r\nhttps://github.com/sysown/proxysql/blob/v2.6.2/lib/ProxySQL_Admin.cpp#L6384\r\n\r\nIf the Prometheus exporter is immediately accessible, it can attempt to access objects yet not initialized, possibly leading to a crash if the exporter is accessed within a few milliseconds from ProxySQL start.\r\n\r\nWe should probably move the initialization of `AdminHTTPServer` outside of `ProxySQL_Admin::init()` , and only initialize after all the other modules are initialized (therefore should be initialized from `main()`.\n", "hints_text": "", "created_at": "2024-04-23 07:21:28", "merge_commit_sha": "8a525bf9f61e76c358c3ff2f06c1914b7189360c", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["builds (testreadonly)", ".github/workflows/CI-maketest.yml"], ["select (ubuntu22-tap, mysql57)", ".github/workflows/CI-taptests-groups.yml"], ["builds (testaurora)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (debian11)", ".github/workflows/CI-builds.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-laravel-framework.yml"], ["builds (testall)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-mysql-connector-j.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (testgalera)", ".github/workflows/CI-maketest.yml"], ["Analyze (ubuntu22-tap, python)", ".github/workflows/CI-codeql.yml"], ["builds (ubuntu16)", ".github/workflows/CI-builds.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-basictests.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-selftests.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-php-pdo-mysql.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (ubuntu22, -clang)", ".github/workflows/CI-builds.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-laravel-framework.yml"]]}
{"repo": "OpenAtomFoundation/pikiwidb", "instance_id": "OpenAtomFoundation__pikiwidb-2638", "base_commit": "e38e255cf16b6ab2c50d32741458bfb38adcadeb", "patch": "diff --git a/conf/pika.conf b/conf/pika.conf\nindex 055208dae5..a99c30b30d 100644\n--- a/conf/pika.conf\n+++ b/conf/pika.conf\n@@ -34,10 +34,17 @@ slow-cmd-thread-pool-size : 1\n # Slow cmd list e.g. hgetall, mset\n slow-cmd-list :\n \n-# The number of sync-thread for data replication from master, those are the threads work on slave nodes\n-# and are used to execute commands sent from master node when replicating.\n+# The number of threads to write DB in slaveNode when replicating.\n+# It's preferable to set slave's sync-thread-num value close to master's thread-pool-size.\n sync-thread-num : 6\n \n+# The num of threads to write binlog in slaveNode when replicating,\n+# each DB cloud only bind to one sync-binlog-thread to write binlog in maximum\n+#[NOTICE] It's highly recommended to set sync-binlog-thread-num equal to conf item 'database'(then each DB cloud have a exclusive thread to write binlog),\n+# eg. if you use 8 DBs(databases_ is 8), sync-binlog-thread-num is preferable to be 8\n+# Valid range of sync-binlog-thread-num is [1, databases], the final value of it is Min(sync-binlog-thread-num, databases)\n+sync-binlog-thread-num : 1\n+\n # Directory to store log files of Pika, which contains multiple types of logs,\n # Including: INFO, WARNING, ERROR log, as well as binglog(write2fine) file which\n # is used for replication.\n@@ -101,6 +108,8 @@ instance-mode : classic\n # The default database id is DB 0. You can select a different one on\n # a per-connection by using SELECT. The db id range is [0, 'databases' value -1].\n # The value range of this parameter is [1, 8].\n+# [NOTICE] It's RECOMMENDED to set sync-binlog-thread-num equal to DB num(databases),\n+# if you've changed the value of databases, remember to check if the value of sync-binlog-thread-num is proper.\n databases : 1\n \n # The number of followers of a master. Only [0, 1, 2, 3, 4] is valid at present.\ndiff --git a/include/pika_conf.h b/include/pika_conf.h\nindex 2a5ed25212..e0cb81062d 100644\n--- a/include/pika_conf.h\n+++ b/include/pika_conf.h\n@@ -65,6 +65,10 @@ class PikaConf : public pstd::BaseConf {\n     std::shared_lock l(rwlock_);\n     return sync_thread_num_;\n   }\n+  int sync_binlog_thread_num() {\n+    std::shared_lock l(rwlock_);\n+    return sync_binlog_thread_num_;\n+  }\n   std::string log_path() {\n     std::shared_lock l(rwlock_);\n     return log_path_;\n@@ -793,6 +797,7 @@ class PikaConf : public pstd::BaseConf {\n   int slow_cmd_thread_pool_size_ = 0;\n   std::unordered_set<std::string> slow_cmd_set_;\n   int sync_thread_num_ = 0;\n+  int sync_binlog_thread_num_ = 0;\n   int expire_dump_days_ = 3;\n   int db_sync_speed_ = 0;\n   std::string slaveof_;\ndiff --git a/include/pika_define.h b/include/pika_define.h\nindex 4d6bf6a846..91ddffeb9f 100644\n--- a/include/pika_define.h\n+++ b/include/pika_define.h\n@@ -30,6 +30,8 @@\n #define PIKA_SERVER_ID_MAX 65535\n \n class PikaServer;\n+/* Global Const */\n+constexpr int MAX_DB_NUM = 8;\n \n /* Port shift */\n const int kPortShiftRSync = 1000;\ndiff --git a/include/pika_repl_client.h b/include/pika_repl_client.h\nindex aa20b83c78..49eb2c9b82 100644\n--- a/include/pika_repl_client.h\n+++ b/include/pika_repl_client.h\n@@ -65,6 +65,7 @@ class PikaReplClient {\n   pstd::Status Close(const std::string& ip, int port);\n \n   void Schedule(net::TaskFunc func, void* arg);\n+  void ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name);\n   void ScheduleWriteBinlogTask(const std::string& db_name, const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n@@ -80,13 +81,15 @@ class PikaReplClient {\n   pstd::Status SendRemoveSlaveNode(const std::string& ip, uint32_t port, const std::string& db_name, const std::string& local_ip);\n \n  private:\n-  size_t GetHashIndex(const std::string& key, bool upper_half);\n-  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(bg_workers_.size()); }\n+  size_t GetBinlogWorkerIndexByDBName(const std::string &db_name);\n+  size_t GetHashIndexByKey(const std::string& key);\n+  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(write_binlog_workers_.size()); }\n \n   std::unique_ptr<PikaReplClientThread> client_thread_;\n   int next_avail_ = 0;\n   std::hash<std::string> str_hash;\n-  std::vector<std::unique_ptr<PikaReplBgWorker>> bg_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_binlog_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_db_workers_;\n };\n \n #endif\ndiff --git a/include/pika_rm.h b/include/pika_rm.h\nindex 9cc0c5ef38..b3e310ddf4 100644\n--- a/include/pika_rm.h\n+++ b/include/pika_rm.h\n@@ -182,6 +182,7 @@ class PikaReplicaManager {\n                                const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n+  void ScheduleReplClientBGTaskByDBName(net::TaskFunc , void* arg, const std::string &db_name);\n   void ReplServerRemoveClientConn(int fd);\n   void ReplServerUpdateClientConnMap(const std::string& ip_port, int fd);\n \ndiff --git a/src/pika_admin.cc b/src/pika_admin.cc\nindex 6760ac247b..15d49cdbae 100644\n--- a/src/pika_admin.cc\n+++ b/src/pika_admin.cc\n@@ -942,6 +942,7 @@ void InfoCmd::InfoServer(std::string& info) {\n   tmp_stream << \"tcp_port:\" << g_pika_conf->port() << \"\\r\\n\";\n   tmp_stream << \"thread_num:\" << g_pika_conf->thread_num() << \"\\r\\n\";\n   tmp_stream << \"sync_thread_num:\" << g_pika_conf->sync_thread_num() << \"\\r\\n\";\n+  tmp_stream << \"sync_binlog_thread_num:\" << g_pika_conf->sync_binlog_thread_num() << \"\\r\\n\";\n   tmp_stream << \"uptime_in_seconds:\" << (current_time_s - g_pika_server->start_time_s()) << \"\\r\\n\";\n   tmp_stream << \"uptime_in_days:\" << (current_time_s / (24 * 3600) - g_pika_server->start_time_s() / (24 * 3600) + 1)\n              << \"\\r\\n\";\n@@ -1501,6 +1502,12 @@ void ConfigCmd::ConfigGet(std::string& ret) {\n     EncodeNumber(&config_body, g_pika_conf->sync_thread_num());\n   }\n \n+  if (pstd::stringmatch(pattern.data(), \"sync-binlog-thread-num\", 1) != 0) {\n+     elements += 2;\n+     EncodeString(&config_body, \"sync-binlog-thread-num\");\n+     EncodeNumber(&config_body, g_pika_conf->sync_binlog_thread_num());\n+    }\n+\n   if (pstd::stringmatch(pattern.data(), \"log-path\", 1) != 0) {\n     elements += 2;\n     EncodeString(&config_body, \"log-path\");\ndiff --git a/src/pika_conf.cc b/src/pika_conf.cc\nindex adc1b26d9f..e2e0d4f885 100644\n--- a/src/pika_conf.cc\n+++ b/src/pika_conf.cc\n@@ -176,7 +176,7 @@ int PikaConf::Load() {\n \n   if (classic_mode_.load()) {\n     GetConfInt(\"databases\", &databases_);\n-    if (databases_ < 1 || databases_ > 8) {\n+    if (databases_ < 1 || databases_ > MAX_DB_NUM) {\n       LOG(FATAL) << \"config databases error, limit [1 ~ 8], the actual is: \" << databases_;\n     }\n     for (int idx = 0; idx < databases_; ++idx) {\n@@ -185,6 +185,15 @@ int PikaConf::Load() {\n   }\n   default_db_ = db_structs_[0].db_name;\n \n+  // sync_binlog_thread_num_ must be set after the setting of databases_\n+  GetConfInt(\"sync-binlog-thread-num\", &sync_binlog_thread_num_);\n+  if (sync_binlog_thread_num_ <= 0) {\n+      sync_binlog_thread_num_ = databases_;\n+  } else {\n+      // final value is MIN(sync_binlog_thread_num, databases_)\n+      sync_binlog_thread_num_ = sync_binlog_thread_num_ > databases_ ?  databases_ : sync_binlog_thread_num_;\n+  }\n+\n   int tmp_replication_num = 0;\n   GetConfInt(\"replication-num\", &tmp_replication_num);\n   if (tmp_replication_num > 4 || tmp_replication_num < 0) {\ndiff --git a/src/pika_repl_client.cc b/src/pika_repl_client.cc\nindex 2754eb2f6e..352fbdf7e5 100644\n--- a/src/pika_repl_client.cc\n+++ b/src/pika_repl_client.cc\n@@ -27,8 +27,11 @@ extern std::unique_ptr<PikaReplicaManager> g_pika_rm;\n PikaReplClient::PikaReplClient(int cron_interval, int keepalive_timeout)  {\n   client_thread_ = std::make_unique<PikaReplClientThread>(cron_interval, keepalive_timeout);\n   client_thread_->set_thread_name(\"PikaReplClient\");\n-  for (int i = 0; i < 2 * g_pika_conf->sync_thread_num(); ++i) {\n-    bg_workers_.push_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  for (int i = 0; i < g_pika_conf->sync_binlog_thread_num(); i++) {\n+      write_binlog_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  }\n+  for (int i = 0; i < g_pika_conf->sync_thread_num(); ++i) {\n+    write_db_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n   }\n }\n \n@@ -43,49 +46,77 @@ int PikaReplClient::Start() {\n     LOG(FATAL) << \"Start ReplClient ClientThread Error: \" << res\n                << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n   }\n-  for (auto & bg_worker : bg_workers_) {\n-    res = bg_worker->StartThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    res = binlog_worker->StartThread();\n     if (res != net::kSuccess) {\n-      LOG(FATAL) << \"Start Pika Repl Worker Thread Error: \" << res\n+      LOG(FATAL) << \"Start Pika Repl Write Binlog Worker Thread Error: \" << res\n                  << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n     }\n   }\n+  for (auto & db_worker : write_db_workers_) {\n+        res = db_worker->StartThread();\n+        if (res != net::kSuccess) {\n+            LOG(FATAL) << \"Start Pika Repl Write DB Worker Thread Error: \" << res\n+                       << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n+        }\n+    }\n   return res;\n }\n \n int PikaReplClient::Stop() {\n   client_thread_->StopThread();\n-  for (auto & bg_worker : bg_workers_) {\n-    bg_worker->StopThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    binlog_worker->StopThread();\n+  }\n+  for (auto &db_worker: write_db_workers_) {\n+    db_worker->StopThread();\n   }\n   return 0;\n }\n \n void PikaReplClient::Schedule(net::TaskFunc func, void* arg) {\n-  bg_workers_[next_avail_]->Schedule(func, arg);\n+  write_binlog_workers_[next_avail_]->Schedule(func, arg);\n   UpdateNextAvail();\n }\n \n+void PikaReplClient::ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name) {\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  write_binlog_workers_[index]->Schedule(func, arg);\n+};\n+\n void PikaReplClient::ScheduleWriteBinlogTask(const std::string& db_name,\n                                              const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                              const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n-  size_t index = GetHashIndex(db_name, true);\n-  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, bg_workers_[index].get());\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, write_binlog_workers_[index].get());\n+  write_binlog_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n }\n \n void PikaReplClient::ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset,\n                                          const std::string& db_name) {\n   const PikaCmdArgsType& argv = cmd_ptr->argv();\n   std::string dispatch_key = argv.size() >= 2 ? argv[1] : argv[0];\n-  size_t index = GetHashIndex(dispatch_key, false);\n+  size_t index = GetHashIndexByKey(dispatch_key);\n   auto task_arg = new ReplClientWriteDBTaskArg(cmd_ptr, offset, db_name);\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+  write_db_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+}\n+\n+size_t PikaReplClient::GetBinlogWorkerIndexByDBName(const std::string &db_name) {\n+    char db_num_c = db_name.back();\n+    int32_t db_num = db_num_c - '0';\n+    //Valid range of db_num is [0, MAX_DB_NUM)\n+    if (db_num < 0 || db_num >= MAX_DB_NUM) {\n+        LOG(ERROR)\n+                << \"Corruption in consuming binlog: the last char of the db_name(extracted from binlog) is not a valid db num, the extracted db_num is \"\n+                << db_num_c << \" while write_binlog_workers.size() is \" << write_binlog_workers_.size();\n+        if (db_num < 0) { assert(false && \"db_num invalid, check if the db_name in the request is valid, also check the ERROR Log of Pika.\"); }\n+    }\n+    return db_num % write_binlog_workers_.size();\n }\n \n-size_t PikaReplClient::GetHashIndex(const std::string& key, bool upper_half) {\n-  size_t hash_base = bg_workers_.size() / 2;\n-  return (str_hash(key) % hash_base) + (upper_half ? 0 : hash_base);\n+size_t PikaReplClient::GetHashIndexByKey(const std::string& key) {\n+  size_t hash_base = write_db_workers_.size();\n+  return (str_hash(key) % hash_base);\n }\n \n Status PikaReplClient::Write(const std::string& ip, const int port, const std::string& msg) {\ndiff --git a/src/pika_repl_client_conn.cc b/src/pika_repl_client_conn.cc\nindex 672648d64d..6c8e001bf1 100644\n--- a/src/pika_repl_client_conn.cc\n+++ b/src/pika_repl_client_conn.cc\n@@ -63,9 +63,12 @@ int PikaReplClientConn::DealMessage() {\n       break;\n     }\n     case InnerMessage::kTrySync: {\n+      const std::string& db_name = response->try_sync().slot().db_name();\n+      //TrySync resp must contain db_name\n+      assert(!db_name.empty());\n       auto task_arg =\n           new ReplClientTaskArg(response, std::dynamic_pointer_cast<PikaReplClientConn>(shared_from_this()));\n-      g_pika_rm->ScheduleReplClientBGTask(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg));\n+      g_pika_rm->ScheduleReplClientBGTaskByDBName(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg), db_name);\n       break;\n     }\n     case InnerMessage::kBinlogSync: {\n@@ -193,7 +196,6 @@ void PikaReplClientConn::HandleTrySyncResponse(void* arg) {\n     LOG(WARNING) << \"TrySync Failed: \" << reply;\n     return;\n   }\n-\n   const InnerMessage::InnerResponse_TrySync& try_sync_response = response->try_sync();\n   const InnerMessage::Slot& db_response = try_sync_response.slot();\n   std::string db_name = db_response.db_name();\ndiff --git a/src/pika_rm.cc b/src/pika_rm.cc\nindex 3445e9fea6..a996463bc2 100644\n--- a/src/pika_rm.cc\n+++ b/src/pika_rm.cc\n@@ -659,6 +659,10 @@ void PikaReplicaManager::ScheduleReplClientBGTask(net::TaskFunc func, void* arg)\n   pika_repl_client_->Schedule(func, arg);\n }\n \n+void PikaReplicaManager::ScheduleReplClientBGTaskByDBName(net::TaskFunc func, void* arg, const std::string &db_name) {\n+  pika_repl_client_->ScheduleByDBName(func, arg, db_name);\n+}\n+\n void PikaReplicaManager::ScheduleWriteBinlogTask(const std::string& db,\n                                                  const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                                  const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n", "test_patch": "diff --git a/tests/integration/replication_test.go b/tests/integration/replication_test.go\nindex 51a8ad00bd..764e8bcca5 100644\n--- a/tests/integration/replication_test.go\n+++ b/tests/integration/replication_test.go\n@@ -558,6 +558,7 @@ var _ = Describe(\"should replication \", func() {\n \n \t\t\tlog.Println(\"randomSpopstore test start\")\n \t\t\texecute(&ctx, clientMaster, 4, randomSpopstroeThread)\n+\t\t\ttime.Sleep(10 * time.Second)\n \t\t\tmaster_spopstore_set := clientMaster.SMembers(ctx, \"set1\")\n \t\t\tExpect(master_spopstore_set.Err()).NotTo(HaveOccurred())\n \t\t\tslave_spopstore_set := clientSlave.SMembers(ctx, \"set1\")\n", "problem_statement": "If a binlog task blocks the slave for a long period, the master may resume the increment replication from an incorrect  start position after timeout reconnection\n### Is this a regression?\r\n\r\nNo\r\n\r\n### Description\r\n\r\n**\u5728\u589e\u91cf\u540c\u6b65\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u67d0\u6761BinlogTask\u963b\u585e\u4e86Slave\u5f88\u957f\u65f6\u95f4\uff08\u8d85\u8fc720s\u7684\u8d85\u65f6\u65f6\u95f4\uff09\uff0c\u4f1a\u9020\u6210\u4e3b\u4ece\u65ad\u8054\uff0c\u5f53\u4e3b\u4ece\u518d\u6b21\u8bd5\u56fe\u91cd\u5efa\u8fde\u63a5\u65f6\uff0cSlave\u53ef\u80fd\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u9519\u8bef\u7684Binlog Start Point\u7ed9Master\u6765\u8fdb\u884c\u7eed\u4f20**\u3002\r\n\r\n**\u9488\u5bf9\u8fd9\u4e00Case\u7684\u5c55\u5f00\u63cf\u8ff0**:\r\n**\u573a\u666f**\uff1a\u5047\u8bbeSlave\u5728\u589e\u91cf\u540c\u6b65\u9636\u6bb5\uff0c\u53d1\u751f\u8d85\u65f6\u8f6c\u4e3a\u4e86TryConnect\u72b6\u6001\uff0c\u5728\u53d1\u51faTrySync\u8bf7\u6c42\u65f6\uff0c\u5982\u679c\u76f8\u5e94\u7684BinlogWorker\u6b63\u597d\u8fd8\u5728\u6267\u884c\u4e00\u4e2a\u4e0a\u6b21\u8fde\u63a5\u671f\u95f4\u7684Binlog\u4efb\u52a1\uff08\u5c06\u8be5Binlog\u4efb\u52a1\u5b9a\u4e49\u4e3a\u4efb\u52a1A) \u3002 \u90a3\u4e48\uff0c\u56e0\u4e3a\u4efb\u52a1A\u7684\u5b58\u5728\uff0cSlave\u662f\u5426\u53ef\u80fd\u4f1a\u53d1\u9001\u4e86\u4e0d\u6b63\u786e\u7684\u7eed\u4f20\u8d77\u59cbOffset\u7ed9Master \uff1f \u6362\u53e5\u8bdd\u8bf4\uff1a\u867d\u7136\u6700\u7ec8\u4efb\u52a1A\u4f1a\u5728Slave\u843d\u76d8\uff0c\u4f46\u662fSlave\u662f\u5426\u53ef\u80fd\u544a\u77e5\u4e86Master\u4ece\u4efb\u52a1A\uff08\u6240\u5bf9\u5e94\u7684Binlog\uff09\u5f00\u59cb\u7684\u4f4d\u7f6e\u53d1\u9001Binlog\uff0c\u5bfc\u81f4Master\u4f1a\u5c06\u4efb\u52a1A\u5bf9\u5e94\u7684Binlog\u518d\u53d1\u4e00\u6b21\uff0c\u4e14Slave\u4f1a\u6d88\u8d39\u4e24\u6b21\u4efb\u52a1A\u6240\u5bf9\u5e94\u7684Binlog \uff1f  \u5148\u505a\u56de\u7b54: \u4f1a\u51fa\u73b0\u8fd9\u79cd\u95ee\u9898\u3002\u5177\u4f53\u68b3\u7406\u5728\u4e0b\u9762\uff1a\r\n\r\n**\u80cc\u666f\u8865\u5145\u548c\u5b9a\u4e49**\uff1aTrySync\u8bf7\u6c42\u643a\u5e26\u7684offset(\u5b9a\u4e49\u4e3aoffset A)\u4e3b\u8981\u4f5c\u7528\u662f\u7ed9Master\u5224\u65ad\u662f\u5426\u80fd\u505a\u589e\u91cf\u540c\u6b65\uff0c\u771f\u6b63\u51b3\u5b9aMaster\u521d\u59cb\u5316\u53d1\u9001\u7a97\u53e3\u8d77\u59cb\u4f4d\u7f6e\uff08\u7eed\u4f20Binlog\u7684\u8d77\u59cb\u4f4d\u7f6e\uff09\u7684\uff0c\u662fslave\u5728\u6536\u5230TrySync\u7684Resp\u540e\u53d1\u51fa\u7684\u4e00\u6761\u7279\u6b8aBinlogACK (is_first_send=true)\uff0c\u8be5ACK\u7684offst start\u7b49\u4e8eend(\u5b9a\u4e49\u4e3aOffset B)\uff0c\u4e14\u8be5Offset B\u5c31\u662fslave\u5728\u53d1\u51fa\u8fd9\u6761\u7279\u6b8aAck\u65f6\u7684\u6700\u65b0\u843d\u76d8\u70b9\u3002\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u5176\u5b9eOffset B\u5e94\u8be5\u4f1a\u548cOffset A\u76f8\u540c\uff0c\u4f46\u662f\u5728Edge Case 1\u4e2d\uff0c\u7531\u4e8e\u53d1\u51faTrySync\u65f6\u4efb\u52a1A\u6b63\u5728\u6267\u884c\u4e14\u6700\u7ec8\u4f1a\u6267\u884c\u5b8c\u6bd5\uff0cOffset B\u7684\u6b63\u786e\u9884\u671f\u5e94\u5f53\u662f  Offset A + BinlogSizeOf(\u4efb\u52a1A), \u6216\u8005\u8bf4Binlog\u7684\u8d77\u59cb\u7eed\u4f20\u4f4d\u7f6e\u5e94\u8be5\u5c31\u5728\u4efb\u52a1A\u5bf9\u5e94\u7684Binlogs\u7684\u540e\u9762\u3002\r\n\r\n**\u73b0\u6709\u4ee3\u7801\u903b\u8f91\u4e2d**\uff1aOffset B\u53ef\u80fd\u4e0d\u4f1a\u7b49\u4e8e\u6b63\u786e\u9884\u671f\uff0c\u5047\u5982BinlogWork\u6267\u884c\u4efb\u52a1A\u6267\u884c\u4e86\u6bd4\u8f83\u4e45\uff0c\u800c\u5728\u4efb\u52a1A\u7684\u6267\u884c\u671f\u95f4Slave\u5b8c\u6210\u4e86\uff1aTrySync Req\u53d1\u9001 ->TrySync Resp\u5904\u7406->\u5728TrySync Resp\u7684\u5904\u7406\u51fd\u6570\u672b\u5c3e\u4f1a\u83b7\u53d6Slave\u6700\u65b0\u7684Binlog\u843d\u76d8\u70b9\uff08Offset B\uff09\uff0c\u53d1\u51fa\u7279\u6b8aBinlogAck(is_first_send=true)\u6765\u544a\u77e5Master\u4ece\u54ea\u91cc\u5f00\u59cb\u91cd\u53d1Binlog\u3002 \u5982\u679c\u5728\u83b7\u53d6Offset B\u7684\u65f6\u5019\uff0c\u4efb\u52a1A\u8fd8\u6ca1\u843d\u76d8\uff0c\u6216\u8005\u843d\u76d8\u4e86\u4f46\u662f\u8fd8\u6ca1\u6709\u5c06\u6700\u65b0\u7684offset\u66f4\u65b0\u5230version_\u5bf9\u8c61\u4e2d(Offset B\u5c31\u662f\u4eceversion_\u5bf9\u8c61\u4e2d\u53d6)\uff0c\u5c31\u4f1a\u5bfc\u81f4\u83b7\u53d6\u7684OffsetB\u5c31\u7b49\u4e8eOffset A(\u4f46\u6b63\u786e\u7684\u5e94\u8be5Offset B\u5e94\u8be5\u662f Offset A + Offset A + BinlogSizeOf(\u4efb\u52a1A))\uff0c\u4e8e\u662fMaster\u4f1a\u628a\u4efb\u52a1A\u6240\u5bf9\u5e94\u7684\u90a3\u6279Binlog\u518d\u53d1\u4e00\u904d\u3002\r\n\r\n**\u540e\u679c**\uff1aMaster\u4f1a\u628a\u4efb\u52a1A\u5185\u90e8\u7684BInlog\u518d\u53d1\u4e00\u6b21\uff0cSlave\u7b49\u4e8e\u6d88\u8d39\u4e862\u6279\u540c\u6837\u7684Binlog\uff0c\u4e00\u6b21\u662f\u5728\u4e0a\u4e00\u6b21Session\u7684\u672b\u5c3e\uff08\u963b\u585e\u7684\u90a3\u4e2a\u4efb\u52a1A\uff09\uff0c\u4e00\u6b21\u662f\u5728\u65b0Session\u7684\u7b2c\u4e00\u4e2aBinlog\u4efb\u52a1\u4e2d\u3002\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u4e14\u5728\u540c\u6b65\u6ca1\u6709\u6ede\u540e/\u5b8c\u5168\u540c\u6b65\u7684\u60c5\u51b5\u4e0b\uff0cSlave\u7684Binlog\u6587\u4ef6\u4f1a\u6bd4Master\u7684\u5bf9\u5e94BInlog\u6587\u4ef6\u957f\u4e00\u70b9\uff0c\u5728Slave\u5207\u8d70\u8fd9\u4e2aBinlog\u6587\u4ef6\u4e4b\u524d\u5982\u679c\u53d1\u751f\u4e86\u65ad\u70b9\u91cd\u8fde\uff0c\u4e3b\u4ece\u5efa\u8054\u53ef\u80fd\u4f1a\u62a5\u9519 binlog offset is not a start point of master, \u4f46\u662f\u5982\u679cslave\u5728\u5904\u4e8e\u8be5Binlog\u6587\u4ef6\u671f\u95f4\u5b8c\u5168\u6ca1\u6709\u65ad\u5f00\u8fc7\uff0c\u53ef\u80fd\u6d88\u8d39\u5230\u4e86\u7a97\u53e3\u672b\u5c3e\u65f6Master\u7aef\u4f1a\u62a5\u51fa\u5947\u602a\u7684SyncWin Corruption\u3002(\u53e6\u5916\uff0c\u5728\u7ebf\u4e0a\u5b9e\u4f8b\u7684\u4e3b\u4ece\u8d85\u65f6\u6545\u969c\u4e2d\uff0c\u786e\u5b9e\u4e5f\u51fa\u73b0\u8fc7binlog offset is not a start point of master)\r\n\r\n\r\n**During incremental synchronization, if a BinlogTask blocks the Slave for a long time (exceeding the 20-second timeout), when the Master and Slave attempt to reconnect, the Slave may provide an incorrect Binlog Start Point to the Master for resuming the process.**\r\n\r\n**Expanded description of this case**:\r\n**Scenario**: Suppose during the incremental synchronization phase, the Slave times out and switches to TryConnect state. When sending a TrySync request, if the corresponding BinlogWorker happens to still be executing a Binlog task from the previous connection period (let's define this Binlog task as Task A), then due to the existence of Task A, could the Slave possibly send an incorrect resumption starting Offset to the Master? In other words, even though Task A will eventually be written to the Slave\u2019s disk, could the Slave inform the Master to send the Binlog from the starting point of Task A, causing the Master to resend the Binlog corresponding to Task A and resulting in the Slave consuming the Binlog for Task A twice? The preliminary answer is: yes, this issue can occur. The detailed explanation is below:\r\n\r\n**Background and definition**: The offset carried by the TrySync request (defined as Offset A) primarily serves for the Master to determine whether incremental synchronization can be performed. The actual determination of the starting position of the Master\u2019s initial sending window (the starting position for resuming the Binlog) is done by a special BinlogACK (with is_first_send=true) sent by the Slave after receiving the TrySync response. The start of this ACK\u2019s offset is equal to the end (defined as Offset B), and this Offset B is the latest disk write point of the Slave when sending this special Ack. In most cases, Offset B should be the same as Offset A, but in Edge Case 1, since Task A is executing when the TrySync is sent and will eventually complete, the correct expectation for Offset B should be Offset A + BinlogSizeOf(Task A), or in other words, the starting position for resuming the Binlog should be right after the Binlogs corresponding to Task A.\r\n\r\n**In the current code logic**: Offset B may not equal the correct expectation. If the BinlogWork executing Task A takes a long time, and during the execution of Task A, the Slave completes: sending TrySync Req -> processing TrySync Resp -> obtaining the latest Binlog write point (Offset B) at the end of the TrySync Resp processing function, and sending a special BinlogAck (is_first_send=true) to inform the Master where to start resending the Binlog. If Task A has not been written to disk or the latest offset has not been updated to the version_ object (Offset B is taken from the version_ object) when obtaining Offset B, then the obtained Offset B will equal Offset A (but the correct Offset B should be Offset A + BinlogSizeOf(Task A)), thus causing the Master to resend the batch of Binlogs corresponding to Task A.\r\n\r\n**Consequence**: The Master will resend the Binlogs within Task A, causing the Slave to consume two batches of the same Binlog, once at the end of the last session (the blocking Task A) and once in the first Binlog task of the new session. This can lead to data inconsistency between the Master and Slave. Additionally, if there is no lag in synchronization or if synchronization is complete, the Slave\u2019s Binlog file may be slightly longer than the corresponding Binlog file on the Master. If a breakpoint reconnection occurs before the Slave switches from this Binlog file, the Master-Slave connection might report an error: binlog offset is not a start point of master. However, if the Slave never disconnects during this Binlog file, a strange SyncWin Corruption error might be reported on the Master side when the window reaches the end. (Furthermore, in the actual Master-Slave timeout failures in online instances, the binlog offset is not a start point of master error has indeed occurred.)\r\n\r\n\r\n### Please provide a link to a minimal reproduction of the bug\r\n\r\n_No response_\r\n\r\n### Screenshots or videos\r\n\r\n\r\n### Please provide the version you discovered this bug in (check about page for version information)\r\n\r\n_No response_\r\n\r\n### Anything else?\r\n\r\n_No response_\n", "hints_text": "", "created_at": "2024-05-07 15:29:53", "merge_commit_sha": "32c423a2ae23b0b9a94a2480d1031cc3526562e9", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["cleanup", ".github/workflows/clean-cache.yml"], ["Build Pika Docker image", ".github/workflows/pika.yml"], ["build", ".github/workflows/codis.yml"], ["Build Codis Docker image", ".github/workflows/codis.yml"], ["Analyze (go)", ".github/workflows/codeql.yml"], ["update_release_draft", ".github/workflows/release-drafter.yml"]]}
{"repo": "benbovy/spherely", "instance_id": "benbovy__spherely-82", "base_commit": "53bf81a643c653c09e1cfa568c0d0d49687d9dcb", "patch": "diff --git a/src/geography.cpp b/src/geography.cpp\nindex d84c177..bd527fc 100644\n--- a/src/geography.cpp\n+++ b/src/geography.cpp\n@@ -7,6 +7,7 @@\n #include <s2/s2loop.h>\n #include <s2/s2point.h>\n #include <s2/s2polygon.h>\n+#include <s2/util/coding/coder.h>\n #include <s2geography/geography.h>\n #include <s2geography/predicates.h>\n #include <s2geography/wkt-writer.h>\n@@ -171,6 +172,53 @@ void Geography::extract_geog_properties() {\n     }\n }\n \n+py::tuple Geography::encode() const {\n+    // encode geography type\n+    using IntType = std::underlying_type_t<GeographyType>;\n+    auto encoded_geog_type = static_cast<IntType>(geog_type());\n+\n+    // encode empty\n+    // (note: this is already handled internally by s2geography::Geography::EncodeTagged() but\n+    // there no current way to get the that information externally when/after decoding)\n+    auto empty = m_is_empty;\n+\n+    // encode geog\n+    Encoder geog_encoder;\n+    s2geog::EncodeOptions encode_opts;\n+    geog().EncodeTagged(&geog_encoder, encode_opts);\n+\n+    std::string encoded_geog;\n+    encoded_geog.assign(geog_encoder.base(), geog_encoder.base() + geog_encoder.length());\n+\n+    return py::make_tuple(encoded_geog_type, empty, py::bytes(encoded_geog));\n+}\n+\n+Geography Geography::decode(const py::tuple &encoded) {\n+    auto decoded = Geography();\n+\n+    // decode geography type\n+    using IntType = std::underlying_type_t<GeographyType>;\n+    GeographyType geog_type{encoded[0].cast<IntType>()};\n+    decoded.m_geog_type = geog_type;\n+\n+    // decode empty\n+    decoded.m_is_empty = encoded[1].cast<bool>();\n+\n+    // decode geog() (s2geography::Geography)\n+    auto encoded_geog = encoded[2].cast<std::string>();\n+    Decoder geog_decoder(encoded_geog.c_str(), encoded_geog.size());\n+    auto decoded_geog_ptr = s2geog::Geography::DecodeTagged(&geog_decoder);\n+\n+    // TODO: remove this quick & dirty fix (https://github.com/paleolimbot/s2geography/issues/54)\n+    if (decoded_geog_ptr->kind() == s2geog::GeographyKind::GEOGRAPHY_COLLECTION) {\n+        decoded.m_s2geog_ptr = clone_s2geography(*decoded_geog_ptr);\n+    } else {\n+        decoded.m_s2geog_ptr = std::move(decoded_geog_ptr);\n+    }\n+\n+    return decoded;\n+}\n+\n /*\n ** Geography properties\n */\n@@ -267,6 +315,9 @@ void init_geography(py::module &m) {\n         return s2geog::s2_equals(idx1, idx2, options);\n     });\n \n+    pygeography.def(py::pickle([](Geography &geog) { return geog.encode(); },\n+                               [](py::tuple &encoded) { return Geography::decode(encoded); }));\n+\n     // Geography properties\n \n     m.def(\"get_type_id\",\ndiff --git a/src/geography.hpp b/src/geography.hpp\nindex bc116ca..c703647 100644\n--- a/src/geography.hpp\n+++ b/src/geography.hpp\n@@ -107,6 +107,9 @@ class Geography {\n     Geography clone() const;\n     std::unique_ptr<s2geog::Geography> clone_geog() const;\n \n+    py::tuple encode() const;\n+    static Geography decode(const py::tuple& encoded);\n+\n private:\n     S2GeographyPtr m_s2geog_ptr;\n     S2GeographyIndexPtr m_s2geog_index_ptr;\n", "test_patch": "diff --git a/tests/test_geography.py b/tests/test_geography.py\nindex c812926..6713141 100644\n--- a/tests/test_geography.py\n+++ b/tests/test_geography.py\n@@ -1,3 +1,5 @@\n+import pickle\n+\n import pytest\n import numpy as np\n \n@@ -130,3 +132,37 @@ def test_equality() -> None:\n     assert poly1 == poly2\n     assert poly2 == poly3\n     assert poly1 == poly3\n+\n+    coll1 = (spherely.create_collection([spherely.create_point(40, 50)]),)\n+    coll2 = (spherely.create_collection([spherely.create_point(40, 50)]),)\n+\n+    assert coll1 == coll2\n+\n+\n+@pytest.mark.parametrize(\n+    \"geog\",\n+    [\n+        spherely.create_point(45, 50),\n+        spherely.create_multipoint([(5, 50), (6, 51)]),\n+        spherely.create_linestring([(5, 50), (6, 51)]),\n+        spherely.create_multilinestring([[(5, 50), (6, 51)], [(15, 60), (16, 61)]]),\n+        spherely.create_polygon([(5, 50), (5, 60), (6, 60), (6, 51)]),\n+        spherely.create_multipolygon(\n+            [\n+                spherely.create_polygon([(5, 50), (5, 60), (6, 60), (6, 51)]),\n+                spherely.create_polygon([(10, 100), (10, 160), (11, 160), (11, 100)]),\n+            ]\n+        ),\n+        spherely.create_collection([spherely.create_point(40, 50)]),\n+        # empty geography\n+        spherely.create_point(),\n+        spherely.create_linestring(),\n+        spherely.create_polygon(),\n+    ],\n+)\n+def test_pickle_roundtrip(geog):\n+    roundtripped = pickle.loads(pickle.dumps(geog))\n+\n+    assert spherely.get_type_id(roundtripped) == spherely.get_type_id(geog)\n+    assert spherely.to_wkt(roundtripped) == spherely.to_wkt(geog)\n+    assert roundtripped == geog\n", "problem_statement": "Support pickling Geography objects\nAt the moment we didn't implement this, so you will get `TypeError: cannot pickle 'spherely.Point' object`, but it would be useful to support it.\r\n\r\nTo provide a full exact roundtrip through pickling, we should maybe pickle the raw unit vector (x, y, z) of the `S2Point`, instead of going through latitude/longitude like other conversions (eg WKB), because there can always be some floating point difference in this conversion.\r\n\r\n\n", "hints_text": "S2geometry provides `Encoder` and `Decoder` objects as well as `Encode()` and `Decode()` methods from most of its data types (point, polyline, polygon) so we might be able to just reuse that. For a point it serializes the raw unit vector. It is also possible to encode `S2ShapeIndex` objects with lazy decoding.\r\n\r\nProbably cleanest would be to expose this API via `s2geography::Geography` wrapper classes rather than dealing with it directly in spherely (same for other methods like `Clone()`, which would be better than [this function](https://github.com/benbovy/spherely/blob/165f0ef26fdc67126c83ef7996055636e3e5a3fc/src/geography.cpp#L35-L77) implemented in #51).\nActually, I think we could already access `Encode()` and `Decode()` via `s2geography::Geography::Shape()`.\nhttps://github.com/paleolimbot/s2geography/pull/40 is now merged so adding support for pickle should be easier.\r\n\r\nThat s2geography PR also added the `GeographyKind` enum tag, which will allow us to clean up some parts of the code in Spherely (e.g., remove some `dynamic_cast`).\r\n\r\n", "created_at": "2024-12-05 14:47:44", "merge_commit_sha": "17c355e4d8e275fe33ab02d6a5fd61ebb53edc65", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-latest, 3.11, ci/environment.yml", ".github/workflows/run-tests.yaml"], ["windows-latest, 3.12, ci/environment.yml", ".github/workflows/run-tests.yaml"], ["windows-latest, 3.11, ci/environment.yml", ".github/workflows/run-tests.yaml"], ["ubuntu-latest, 3.12, ci/environment.yml", ".github/workflows/run-tests.yaml"], ["ubuntu-latest, 3.11, ci/environment.yml", ".github/workflows/run-tests.yaml"], ["ubuntu-latest, 3.12, ci/environment-dev.yml", ".github/workflows/run-tests.yaml"], ["mypy", ".github/workflows/lint.yaml"]]}
{"repo": "PowerGridModel/power-grid-model", "instance_id": "PowerGridModel__power-grid-model-718", "base_commit": "2d74e82f971d4c9df56e7076ddcc2c9c639f3662", "patch": "diff --git a/power_grid_model_c/power_grid_model_c/src/buffer.cpp b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\nindex aeb6374bc..d4d268674 100644\n--- a/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n+++ b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n@@ -20,10 +20,15 @@ using meta_data::RawDataPtr;\n \n // buffer control\n RawDataPtr PGM_create_buffer(PGM_Handle* /* handle */, PGM_MetaComponent const* component, PGM_Idx size) {\n+    // alignment should be maximum of alignment of the component and alignment of void*\n+    size_t const alignment = std::max(component->alignment, sizeof(void*));\n+    // total bytes should be multiple of alignment\n+    size_t const requested_bytes = component->size * size;\n+    size_t const rounded_bytes = ((requested_bytes + alignment - 1) / alignment) * alignment;\n #ifdef _WIN32\n-    return _aligned_malloc(component->size * size, component->alignment);\n+    return _aligned_malloc(rounded_bytes, alignment);\n #else\n-    return std::aligned_alloc(component->alignment, component->size * size);\n+    return std::aligned_alloc(alignment, rounded_bytes);\n #endif\n }\n void PGM_destroy_buffer(RawDataPtr ptr) {\n", "test_patch": "diff --git a/tests/cpp_validation_tests/CMakeLists.txt b/tests/cpp_validation_tests/CMakeLists.txt\nindex f6d2560c4..0ad90903c 100644\n--- a/tests/cpp_validation_tests/CMakeLists.txt\n+++ b/tests/cpp_validation_tests/CMakeLists.txt\n@@ -11,7 +11,7 @@ add_executable(power_grid_model_validation_tests ${PROJECT_SOURCES})\n \n target_link_libraries(power_grid_model_validation_tests\n     PRIVATE\n-        power_grid_model\n+        power_grid_model_cpp\n         doctest::doctest\n         nlohmann_json nlohmann_json::nlohmann_json\n )\ndiff --git a/tests/cpp_validation_tests/test_validation.cpp b/tests/cpp_validation_tests/test_validation.cpp\nindex a4fe5d0bd..c3b6d7a6e 100644\n--- a/tests/cpp_validation_tests/test_validation.cpp\n+++ b/tests/cpp_validation_tests/test_validation.cpp\n@@ -2,27 +2,82 @@\n //\n // SPDX-License-Identifier: MPL-2.0\n \n-#include <power_grid_model/auxiliary/dataset.hpp>\n-#include <power_grid_model/auxiliary/meta_data_gen.hpp>\n-#include <power_grid_model/auxiliary/serialization/deserializer.hpp>\n-#include <power_grid_model/container.hpp>\n-#include <power_grid_model/main_model.hpp>\n+#define PGM_ENABLE_EXPERIMENTAL\n+\n+#include \"power_grid_model_cpp.hpp\"\n \n #include <doctest/doctest.h>\n #include <nlohmann/json.hpp>\n \n+#include <complex>\n #include <concepts>\n #include <cstdlib>\n #include <cstring>\n #include <filesystem>\n #include <fstream>\n #include <iostream>\n+#include <limits>\n+#include <numeric>\n #include <optional>\n #include <regex>\n+#include <stdexcept>\n+#include <type_traits>\n \n-namespace power_grid_model::meta_data {\n-\n+namespace power_grid_model_cpp {\n namespace {\n+class UnsupportedValidationCase : public PowerGridError {\n+  public:\n+    UnsupportedValidationCase(std::string const& calculation_type, bool sym)\n+        : PowerGridError{[&]() {\n+              using namespace std::string_literals;\n+              auto const sym_str = sym ? \"sym\"s : \"asym\"s;\n+              return \"Unsupported validation case: \"s + sym_str + \" \"s + calculation_type;\n+          }()} {}\n+};\n+\n+class UnsupportedPGM_CType : public PowerGridError {\n+  public:\n+    UnsupportedPGM_CType()\n+        : PowerGridError{[&]() {\n+              using namespace std::string_literals;\n+              return \"Unsupported PGM_Ctype\"s;\n+          }()} {}\n+};\n+\n+class OptionalNotInitialized : public PowerGridError {\n+  public:\n+    OptionalNotInitialized(std::string const& object)\n+        : PowerGridError{[&]() {\n+              using namespace std::string_literals;\n+              return \"Optional \"s + object + \" object not initialized\"s;\n+          }()} {}\n+};\n+\n+inline bool is_nan(std::floating_point auto x) { return std::isnan(x); }\n+template <std::floating_point T> inline bool is_nan(std::complex<T> const& x) {\n+    return is_nan(x.real()) || is_nan(x.imag());\n+}\n+inline bool is_nan(int32_t x) { return x == std::numeric_limits<int32_t>::min(); }\n+inline bool is_nan(int8_t x) { return x == std::numeric_limits<int8_t>::min(); }\n+template <typename T, std::size_t N> inline bool is_nan(std::array<T, N> const& array) {\n+    return std::ranges::any_of(array, [](T const& element) { return is_nan(element); });\n+}\n+\n+template <class Functor, class... Args>\n+decltype(auto) pgm_type_func_selector(enum PGM_CType type, Functor&& f, Args&&... args) {\n+    switch (type) {\n+    case PGM_int32:\n+        return std::forward<Functor>(f).template operator()<int32_t>(std::forward<Args>(args)...);\n+    case PGM_int8:\n+        return std::forward<Functor>(f).template operator()<int8_t>(std::forward<Args>(args)...);\n+    case PGM_double:\n+        return std::forward<Functor>(f).template operator()<double>(std::forward<Args>(args)...);\n+    case PGM_double3:\n+        return std::forward<Functor>(f).template operator()<std::array<double, 3>>(std::forward<Args>(args)...);\n+    default:\n+        throw UnsupportedPGM_CType();\n+    }\n+}\n \n using nlohmann::json;\n \n@@ -40,201 +95,247 @@ auto read_json(std::filesystem::path const& path) {\n     return j;\n }\n \n-class UnsupportedValidationCase : public PowerGridError {\n-  public:\n-    UnsupportedValidationCase(std::string const& calculation_type, bool sym) {\n-        using namespace std::string_literals;\n-\n-        auto const sym_str = sym ? \"sym\"s : \"asym\"s;\n-        append_msg(\"Unsupported validation case: \"s + sym_str + \" \"s + calculation_type);\n-    };\n-};\n-\n-// memory buffer\n-using BufferPtr = std::unique_ptr<void, std::add_pointer_t<void(RawDataConstPtr)>>; // custom deleter at runtime\n-struct Buffer {\n-    BufferPtr ptr{nullptr, [](void const*) {}};\n-    IdxVector indptr;\n+struct OwningMemory {\n+    std::vector<Buffer> buffers;\n+    std::vector<std::vector<Idx>> indptrs;\n };\n \n struct OwningDataset {\n-    MutableDataset dataset;\n-    ConstDataset const_dataset;\n-    std::vector<Buffer> buffers{};\n-    std::vector<ConstDataset> batch_scenarios{};\n+    std::optional<DatasetMutable> dataset;\n+    std::optional<DatasetConst> const_dataset;\n+    OwningMemory storage{};\n };\n \n-auto create_owning_dataset(WritableDataset& info) {\n+OwningDataset create_owning_dataset(DatasetWritable& writable_dataset) {\n+    auto const& info = writable_dataset.get_info();\n+    Idx const is_batch = info.is_batch();\n     Idx const batch_size = info.batch_size();\n-    std::vector<Buffer> buffers;\n+    auto const& dataset_name = info.name();\n+    OwningDataset owning_dataset{.dataset{DatasetMutable{dataset_name, is_batch, batch_size}},\n+                                 .const_dataset = std::nullopt};\n \n     for (Idx component_idx{}; component_idx < info.n_components(); ++component_idx) {\n-        auto const& component_info = info.get_component_info(component_idx);\n-        auto const& component_meta = component_info.component;\n-\n-        Buffer buffer{};\n-        buffer.ptr =\n-            BufferPtr{component_meta->create_buffer(component_info.total_elements), component_meta->destroy_buffer};\n-        buffer.indptr = IdxVector(component_info.elements_per_scenario < 0 ? batch_size + 1 : 0);\n-        Idx* indptr_data = buffer.indptr.empty() ? nullptr : buffer.indptr.data();\n-\n-        info.set_buffer(component_info.component->name, indptr_data, buffer.ptr.get());\n-        buffers.push_back(std::move(buffer));\n+        auto const& component_name = info.component_name(component_idx);\n+        auto const& component_meta = MetaData::get_component_by_name(dataset_name, component_name);\n+        Idx const component_elements_per_scenario = info.component_elements_per_scenario(component_idx);\n+        Idx const component_size = info.component_total_elements(component_idx);\n+\n+        auto& current_indptr = owning_dataset.storage.indptrs.emplace_back(\n+            info.component_elements_per_scenario(component_idx) < 0 ? batch_size + 1 : 0);\n+        if (!current_indptr.empty()) {\n+            current_indptr.at(0) = 0;\n+            current_indptr.at(batch_size) = component_size;\n+        }\n+        Idx* const indptr = current_indptr.empty() ? nullptr : current_indptr.data();\n+        auto const& current_buffer = owning_dataset.storage.buffers.emplace_back(component_meta, component_size);\n+        writable_dataset.set_buffer(component_name, indptr, current_buffer);\n+        owning_dataset.dataset.value().add_buffer(component_name, component_elements_per_scenario, component_size,\n+                                                  indptr, current_buffer);\n     }\n-    return OwningDataset{\n-        .dataset = info,\n-        .const_dataset = info,\n-        .buffers = std::move(buffers),\n-    };\n+    owning_dataset.const_dataset = writable_dataset;\n+    return owning_dataset;\n }\n \n-auto construct_individual_scenarios(OwningDataset& owning_dataset) {\n-    for (Idx scenario_idx{}; scenario_idx < owning_dataset.dataset.batch_size(); ++scenario_idx) {\n-        owning_dataset.batch_scenarios.push_back(owning_dataset.const_dataset.get_individual_scenario(scenario_idx));\n+OwningDataset create_result_dataset(OwningDataset const& input, std::string const& dataset_name, Idx is_batch = 0,\n+                                    Idx batch_size = 1) {\n+    OwningDataset owning_dataset{.dataset{DatasetMutable{dataset_name, is_batch, batch_size}},\n+                                 .const_dataset = std::nullopt};\n+\n+    if (!input.const_dataset.has_value()) {\n+        throw OptionalNotInitialized(\"DatasetConst\");\n+    }\n+    DatasetInfo const& input_info = input.const_dataset.value().get_info();\n+\n+    for (Idx component_idx{}; component_idx != input_info.n_components(); ++component_idx) {\n+        auto const& component_name = input_info.component_name(component_idx);\n+        auto const& component_meta = MetaData::get_component_by_name(dataset_name, component_name);\n+        Idx const component_elements_per_scenario = input_info.component_elements_per_scenario(component_idx);\n+        Idx const component_size = input_info.component_total_elements(component_idx);\n+\n+        auto& current_indptr = owning_dataset.storage.indptrs.emplace_back(\n+            input_info.component_elements_per_scenario(component_idx) < 0 ? batch_size + 1 : 0);\n+        Idx const* const indptr = current_indptr.empty() ? nullptr : current_indptr.data();\n+        auto const& current_buffer = owning_dataset.storage.buffers.emplace_back(component_meta, component_size);\n+        owning_dataset.dataset.value().add_buffer(component_name, component_elements_per_scenario, component_size,\n+                                                  indptr, current_buffer);\n     }\n+    owning_dataset.const_dataset = owning_dataset.dataset.value();\n+    return owning_dataset;\n }\n \n OwningDataset load_dataset(std::filesystem::path const& path) {\n // Issue in msgpack, reported in https://github.com/msgpack/msgpack-c/issues/1098\n // May be a Clang Analyzer bug\n #ifndef __clang_analyzer__ // TODO(mgovers): re-enable this when issue in msgpack is fixed\n-    auto deserializer = Deserializer{power_grid_model::meta_data::from_json, read_file(path), meta_data_gen::meta_data};\n-    auto& info = deserializer.get_dataset_info();\n-    auto dataset = create_owning_dataset(info);\n-    deserializer.parse();\n-    construct_individual_scenarios(dataset);\n+    Deserializer deserializer{read_file(path), Idx{0}};\n+    auto& writable_dataset = deserializer.get_dataset();\n+    auto dataset = create_owning_dataset(writable_dataset);\n+    deserializer.parse_to_buffer();\n     return dataset;\n #else  // __clang_analyzer__ // issue in msgpack\n     (void)path;\n     // fallback for https://github.com/msgpack/msgpack-c/issues/1098\n-    return OwningDataset{.dataset = {false, 0, \"\", meta_data_gen::meta_data},\n-                         .const_dataset = {false, 0, \"\", meta_data_gen::meta_data}};\n+    return OwningDataset{};\n #endif // __clang_analyzer__ // issue in msgpack\n }\n \n-// create single result set\n-OwningDataset create_result_dataset(OwningDataset const& input, std::string const& data_type, bool is_batch = false,\n-                                    Idx batch_size = 1) {\n-    MetaDataset const& meta = meta_data_gen::meta_data.get_dataset(data_type);\n-    WritableDataset handler{is_batch, batch_size, meta.name, meta_data_gen::meta_data};\n-    assert(input.const_dataset.batch_size() == 1);\n-\n-    for (Idx i{}; i != input.const_dataset.n_components(); ++i) {\n-        auto const& component_info = input.const_dataset.get_component_info(i);\n-        handler.add_component_info(component_info.component->name, component_info.elements_per_scenario,\n-                                   component_info.elements_per_scenario * batch_size);\n+template <typename T> std::string get_as_string(T const& attribute_value) {\n+    std::stringstream sstr;\n+    sstr << std::setprecision(16);\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        sstr << \"(\" << attribute_value[0] << \", \" << attribute_value[1] << \", \" << attribute_value[2] << \")\";\n+    } else if constexpr (std::is_same_v<std::decay_t<T>, int8_t>) {\n+        sstr << std::to_string(attribute_value);\n+    } else {\n+        sstr << attribute_value;\n     }\n-    auto owning_dataset = create_owning_dataset(handler);\n-    construct_individual_scenarios(owning_dataset);\n-    return owning_dataset;\n+    return sstr.str();\n }\n \n template <typename T>\n-std::string get_as_string(RawDataConstPtr const& raw_data_ptr, MetaAttribute const& attr, Idx obj) {\n-    // ensure that we don't read outside owned memory\n-    REQUIRE(attr.ctype == ctype_v<T>);\n-    REQUIRE(attr.size == sizeof(T));\n-\n-    T value{};\n-    attr.get_value(raw_data_ptr, reinterpret_cast<RawDataPtr>(&value), obj);\n+bool check_angle_and_magnitude(T const& ref_angle, T const& angle, T const& ref_magnitude, T const& magnitude,\n+                               double atol, double rtol) {\n+    auto to_complex = [](double r, double theta) { return std::polar(r, theta); };\n+    auto is_within_tolerance = [atol, rtol](std::complex<double> element, std::complex<double> ref_element) {\n+        return std::abs(element - ref_element) < std::abs(ref_element) * rtol + atol;\n+    };\n \n-    std::stringstream sstr;\n-    sstr << std::setprecision(16);\n-    if constexpr (std::same_as<T, RealValue<asymmetric_t>>) {\n-        sstr << \"(\" << value(0) << \", \" << value(1) << \", \" << value(2) << \")\";\n-    } else if constexpr (std::same_as<T, int8_t>) {\n-        sstr << std::to_string(value);\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        std::array<std::complex<double>, 3> result;\n+        std::array<std::complex<double>, 3> ref_result;\n+        std::ranges::transform(magnitude, angle, result.begin(), to_complex);\n+        std::ranges::transform(ref_magnitude, ref_angle, ref_result.begin(), to_complex);\n+        return std::ranges::equal(result, ref_result, is_within_tolerance);\n+    }\n+    if constexpr (std::is_same_v<std::decay_t<T>, double>) {\n+        std::complex<double> const result = to_complex(magnitude, angle);\n+        std::complex<double> const ref_result = to_complex(ref_magnitude, ref_angle);\n+        return is_within_tolerance(result, ref_result);\n     } else {\n-        sstr << value;\n+        return ref_angle == angle && ref_magnitude == magnitude;\n     }\n-    return sstr.str();\n }\n \n-std::string get_as_string(RawDataConstPtr const& raw_data_ptr, MetaAttribute const& attr, Idx obj) {\n-    using enum CType;\n-    using namespace std::string_literals;\n+template <typename T>\n+bool compare_value(T const& ref_attribute_value, T const& attribute_value, double atol, double rtol) {\n+    auto is_within_tolerance = [atol, rtol](std::complex<double> element, std::complex<double> ref_element) {\n+        return std::abs(element - ref_element) < std::abs(ref_element) * rtol + atol;\n+    };\n \n-    switch (attr.ctype) {\n-    case c_int32:\n-        return get_as_string<int32_t>(raw_data_ptr, attr, obj);\n-    case c_int8:\n-        return get_as_string<int8_t>(raw_data_ptr, attr, obj);\n-    case c_double:\n-        return get_as_string<double>(raw_data_ptr, attr, obj);\n-    case c_double3:\n-        return get_as_string<RealValue<asymmetric_t>>(raw_data_ptr, attr, obj);\n-    default:\n-        return \"<unknown value type>\"s;\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        return std::ranges::equal(attribute_value, ref_attribute_value, is_within_tolerance);\n+    } else if constexpr (std::is_same_v<std::decay_t<T>, double>) {\n+        return is_within_tolerance(attribute_value, ref_attribute_value);\n+    } else {\n+        return ref_attribute_value == attribute_value;\n     }\n }\n \n-template <symmetry_tag sym>\n-bool check_angle_and_magnitude(RawDataConstPtr reference_result_ptr, RawDataConstPtr result_ptr,\n-                               MetaAttribute const& angle_attr, MetaAttribute const& mag_attr, double atol, double rtol,\n-                               Idx obj) {\n-    RealValue<sym> mag{};\n-    RealValue<sym> mag_ref{};\n-    RealValue<sym> angle{};\n-    RealValue<sym> angle_ref{};\n-    mag_attr.get_value(result_ptr, &mag, obj);\n-    mag_attr.get_value(reference_result_ptr, &mag_ref, obj);\n-    angle_attr.get_value(result_ptr, &angle, obj);\n-    angle_attr.get_value(reference_result_ptr, &angle_ref, obj);\n-    ComplexValue<sym> const result = mag * exp(1.0i * angle);\n-    ComplexValue<sym> const result_ref = mag_ref * exp(1.0i * angle_ref);\n-    if constexpr (is_symmetric_v<sym>) {\n-        return cabs(result - result_ref) < (cabs(result_ref) * rtol + atol);\n-    } else {\n-        return (cabs(result - result_ref) < (cabs(result_ref) * rtol + atol)).all();\n+template <typename T>\n+void check_results(T const& ref_attribute_value, T const& attribute_value, T const& ref_possible_attribute_value,\n+                   T const& possible_attribute_value, bool const& is_angle, Idx scenario_idx, Idx obj,\n+                   std::string const& component_name, std::string const& attribute_name, double const& dynamic_atol,\n+                   double const& rtol) {\n+    bool const match =\n+        is_angle\n+            ? check_angle_and_magnitude<decltype(ref_attribute_value)>(ref_attribute_value, attribute_value,\n+                                                                       ref_possible_attribute_value,\n+                                                                       possible_attribute_value, dynamic_atol, rtol)\n+            : compare_value<decltype(ref_attribute_value)>(ref_attribute_value, attribute_value, dynamic_atol, rtol);\n+    if (!match) {\n+        std::stringstream case_sstr;\n+        case_sstr << \"dataset scenario: #\" << scenario_idx << \", Component: \" << component_name << \" #\" << obj\n+                  << \", attribute: \" << attribute_name\n+                  << \": actual = \" << get_as_string<decltype(attribute_value)>(attribute_value) + \" vs. expected = \"\n+                  << get_as_string<decltype(ref_attribute_value)>(ref_attribute_value);\n+        CHECK_MESSAGE(match, case_sstr.str());\n     }\n }\n \n-bool check_angle_and_magnitude(RawDataConstPtr reference_result_ptr, RawDataConstPtr result_ptr,\n-                               MetaAttribute const& angle_attr, MetaAttribute const& mag_attr, double atol, double rtol,\n-                               Idx obj) {\n-    if (angle_attr.ctype == CType::c_double) {\n-        assert(mag_attr.ctype == CType::c_double);\n-        return check_angle_and_magnitude<symmetric_t>(reference_result_ptr, result_ptr, angle_attr, mag_attr, atol,\n-                                                      rtol, obj);\n+template <typename T>\n+bool skip_check(T const& ref_attribute_value, bool const is_angle, T const& ref_possible_attribute_value) {\n+    // check attributes. For angle attribute, also check magnitude available\n+    return is_nan(ref_attribute_value) || (is_angle && is_nan(ref_possible_attribute_value));\n+}\n+\n+template <typename T>\n+void check_individual_attribute(Buffer const& buffer, Buffer const& ref_buffer,\n+                                MetaAttribute const* const attribute_meta,\n+                                MetaAttribute const* const possible_attr_meta, bool const& is_angle,\n+                                Idx elements_per_scenario, Idx scenario_idx, Idx obj, std::string const& component_name,\n+                                std::string const& attribute_name, double const& dynamic_atol, double const& rtol) {\n+    Idx idx = (elements_per_scenario * scenario_idx) + obj;\n+    // get attribute values to check\n+    T ref_attribute_value{};\n+    T attribute_value{};\n+    T ref_possible_attribute_value{};\n+    T possible_attribute_value{};\n+    auto get_values = [&ref_buffer, &buffer, &attribute_meta, &possible_attr_meta,\n+                       idx]<typename U>(U* ref_value, U* value, U* ref_possible_value, U* possible_value) {\n+        ref_buffer.get_value(attribute_meta, ref_value, idx, 0);\n+        buffer.get_value(attribute_meta, value, idx, 0);\n+        ref_buffer.get_value(possible_attr_meta, ref_possible_value, idx, 0);\n+        buffer.get_value(possible_attr_meta, possible_value, idx, 0);\n+    };\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        get_values(ref_attribute_value.data(), attribute_value.data(), ref_possible_attribute_value.data(),\n+                   possible_attribute_value.data());\n+    } else {\n+        get_values(&ref_attribute_value, &attribute_value, &ref_possible_attribute_value, &possible_attribute_value);\n+    }\n+\n+    if (!skip_check(ref_attribute_value, is_angle, ref_possible_attribute_value)) {\n+        check_results(ref_attribute_value, attribute_value, ref_possible_attribute_value, possible_attribute_value,\n+                      is_angle, scenario_idx, obj, component_name, attribute_name, dynamic_atol, rtol);\n     }\n-    assert(angle_attr.ctype == CType::c_double3);\n-    assert(mag_attr.ctype == CType::c_double3);\n-    return check_angle_and_magnitude<asymmetric_t>(reference_result_ptr, result_ptr, angle_attr, mag_attr, atol, rtol,\n-                                                   obj);\n }\n \n-// assert single result\n-void assert_result(ConstDataset const& result, ConstDataset const& reference_result,\n+void assert_result(OwningDataset const& owning_result, OwningDataset const& owning_reference_result,\n                    std::map<std::string, double, std::less<>> atol, double rtol) {\n     using namespace std::string_literals;\n-    MetaDataset const& meta = result.dataset();\n-    Idx const batch_size = result.batch_size();\n-    std::string const type_name = meta.name;\n-    // loop all scenario\n-    for (Idx scenario = 0; scenario != batch_size; ++scenario) {\n-        // loop all component type name\n-        for (Idx i{}; i != reference_result.n_components(); ++i) {\n-            auto const& component_info = reference_result.get_component_info(i);\n-            MetaComponent const& component_meta = *component_info.component;\n-            auto const& ref_buffer = reference_result.get_buffer(i);\n-            auto const& buffer = result.get_buffer(component_meta.name);\n-            Idx const elements_per_scenario = component_info.elements_per_scenario;\n-            assert(elements_per_scenario >= 0);\n-            // offset scenario\n-            RawDataConstPtr const result_ptr =\n-                reinterpret_cast<char const*>(buffer.data) + elements_per_scenario * scenario * component_meta.size;\n-            RawDataConstPtr const reference_result_ptr =\n-                reinterpret_cast<char const*>(ref_buffer.data) + elements_per_scenario * scenario * component_meta.size;\n-            // loop all attribute\n-            for (MetaAttribute const& attr : component_meta.attributes) {\n-                // TODO skip u angle, need a way for common angle\n-                if (attr.name == \"u_angle\"s) {\n+\n+    if (!owning_result.const_dataset.has_value()) {\n+        throw OptionalNotInitialized(\"DatasetConst\");\n+    }\n+    DatasetConst const& result = owning_result.const_dataset.value();\n+    auto const& result_info = result.get_info();\n+    auto const& result_name = result_info.name();\n+    Idx const result_batch_size = result_info.batch_size();\n+    auto const& storage = owning_result.storage;\n+\n+    if (!owning_reference_result.const_dataset.has_value()) {\n+        throw OptionalNotInitialized(\"DatasetConst\");\n+    }\n+    DatasetConst const& reference_result = owning_reference_result.const_dataset.value();\n+    auto const& reference_result_info = reference_result.get_info();\n+    auto const& reference_result_name = reference_result_info.name();\n+    auto const& reference_storage = owning_reference_result.storage;\n+    CHECK(storage.buffers.size() == reference_storage.buffers.size());\n+\n+    // loop through all scenarios\n+    for (Idx scenario_idx{}; scenario_idx < result_batch_size; ++scenario_idx) {\n+        // loop through all components\n+        for (Idx component_idx{}; component_idx < reference_result_info.n_components(); ++component_idx) {\n+            auto const& component_name = reference_result_info.component_name(component_idx);\n+            auto const* const component_meta = MetaData::get_component_by_name(reference_result_name, component_name);\n+\n+            auto const& ref_buffer = reference_storage.buffers.at(component_idx);\n+            auto const& buffer = storage.buffers.at(component_idx);\n+            Idx const elements_per_scenario = reference_result_info.component_elements_per_scenario(component_idx);\n+            CHECK(elements_per_scenario >= 0);\n+            // loop through all attributes\n+            for (Idx attribute_idx{}; attribute_idx < MetaData::n_attributes(component_meta); ++attribute_idx) {\n+                auto const* const attribute_meta = MetaData::get_attribute_by_idx(component_meta, attribute_idx);\n+                auto attribute_type = MetaData::attribute_ctype(attribute_meta);\n+                auto const& attribute_name = MetaData::attribute_name(attribute_meta);\n+                // TODO need a way for common angle: u angle skipped for now\n+                if (attribute_name == \"u_angle\"s) {\n                     continue;\n                 }\n                 // get absolute tolerance\n                 double dynamic_atol = atol.at(\"default\");\n                 for (auto const& [reg, value] : atol) {\n-                    if (std::regex_match(attr.name, std::regex{reg})) {\n+                    if (std::regex_match(attribute_name, std::regex{reg})) {\n                         dynamic_atol = value;\n                         break;\n                     }\n@@ -242,36 +343,22 @@ void assert_result(ConstDataset const& result, ConstDataset const& reference_res\n                 // for other _angle attribute, we need to find the magnitue and compare together\n                 std::regex const angle_regex(\"(.*)(_angle)\");\n                 std::smatch angle_match;\n-                std::string const attr_name = attr.name;\n-                bool const is_angle = std::regex_match(attr_name, angle_match, angle_regex);\n+                bool const is_angle = std::regex_match(attribute_name, angle_match, angle_regex);\n                 std::string const magnitude_name = angle_match[1];\n-                MetaAttribute const& possible_attr_magnitude =\n-                    is_angle ? component_meta.get_attribute(magnitude_name) : attr;\n-\n-                // loop all object\n-                for (Idx obj = 0; obj != elements_per_scenario; ++obj) {\n-                    // only check if reference result is not nan\n-                    if (attr.check_nan(reference_result_ptr, obj)) {\n-                        continue;\n-                    }\n-                    // for angle attribute, also check the magnitude available\n-                    if (is_angle && possible_attr_magnitude.check_nan(reference_result_ptr, obj)) {\n-                        continue;\n-                    }\n-                    bool const match =\n-                        is_angle ? check_angle_and_magnitude(reference_result_ptr, result_ptr, attr,\n-                                                             possible_attr_magnitude, dynamic_atol, rtol, obj)\n-                                 : attr.compare_value(reference_result_ptr, result_ptr, dynamic_atol, rtol, obj);\n-                    if (match) {\n-                        CHECK(match);\n-                    } else {\n-                        std::stringstream case_sstr;\n-                        case_sstr << \"dataset scenario: #\" << scenario << \", Component: \" << component_meta.name << \" #\"\n-                                  << obj << \", attribute: \" << attr.name\n-                                  << \": actual = \" << get_as_string(result_ptr, attr, obj) + \" vs. expected = \"\n-                                  << get_as_string(reference_result_ptr, attr, obj);\n-                        CHECK_MESSAGE(match, case_sstr.str());\n-                    }\n+                auto const& possible_attr_meta =\n+                    is_angle ? MetaData::get_attribute_by_name(reference_result_name, component_name, magnitude_name)\n+                             : attribute_meta;\n+                // loop through all objects\n+                for (Idx obj{}; obj < elements_per_scenario; ++obj) {\n+                    auto callable_wrapper = [&buffer, &ref_buffer, &attribute_meta, &possible_attr_meta, is_angle,\n+                                             elements_per_scenario, scenario_idx, obj, &component_name, &attribute_name,\n+                                             dynamic_atol, rtol]<typename T>() {\n+                        check_individual_attribute<T>(buffer, ref_buffer, attribute_meta, possible_attr_meta, is_angle,\n+                                                      elements_per_scenario, scenario_idx, obj, component_name,\n+                                                      attribute_name, dynamic_atol, rtol);\n+                    };\n+\n+                    pgm_type_func_selector(static_cast<PGM_CType>(attribute_type), callable_wrapper);\n                 }\n             }\n         }\n@@ -288,30 +375,22 @@ std::filesystem::path const data_dir = std::filesystem::path{__FILE__}.parent_pa\n #endif\n \n // method map\n-std::map<std::string, CalculationType, std::less<>> const calculation_type_mapping = {\n-    {\"power_flow\", CalculationType::power_flow},\n-    {\"state_estimation\", CalculationType::state_estimation},\n-    {\"short_circuit\", CalculationType::short_circuit}};\n-std::map<std::string, CalculationMethod, std::less<>> const calculation_method_mapping = {\n-    {\"newton_raphson\", CalculationMethod::newton_raphson},\n-    {\"linear\", CalculationMethod::linear},\n-    {\"iterative_current\", CalculationMethod::iterative_current},\n-    {\"iterative_linear\", CalculationMethod::iterative_linear},\n-    {\"linear_current\", CalculationMethod::linear_current},\n-    {\"iec60909\", CalculationMethod::iec60909}};\n-std::map<std::string, ShortCircuitVoltageScaling, std::less<>> const sc_voltage_scaling_mapping = {\n-    {\"\", ShortCircuitVoltageScaling::maximum}, // not provided returns default value\n-    {\"minimum\", ShortCircuitVoltageScaling::minimum},\n-    {\"maximum\", ShortCircuitVoltageScaling::maximum}};\n-using CalculationFunc =\n-    std::function<BatchParameter(MainModel&, CalculationMethod, MutableDataset const&, ConstDataset const&, Idx)>;\n-\n-std::map<std::string, OptimizerStrategy, std::less<>> const optimizer_strategy_mapping = {\n-    {\"disabled\", OptimizerStrategy::any},\n-    {\"any_valid_tap\", OptimizerStrategy::any},\n-    {\"min_voltage_tap\", OptimizerStrategy::global_minimum},\n-    {\"max_voltage_tap\", OptimizerStrategy::global_maximum},\n-    {\"fast_any_tap\", OptimizerStrategy::fast_any}};\n+std::map<std::string, PGM_CalculationType, std::less<>> const calculation_type_mapping = {\n+    {\"power_flow\", PGM_power_flow}, {\"state_estimation\", PGM_state_estimation}, {\"short_circuit\", PGM_short_circuit}};\n+std::map<std::string, PGM_CalculationMethod, std::less<>> const calculation_method_mapping = {\n+    {\"newton_raphson\", PGM_newton_raphson},       {\"linear\", PGM_linear},\n+    {\"iterative_current\", PGM_iterative_current}, {\"iterative_linear\", PGM_iterative_linear},\n+    {\"linear_current\", PGM_linear_current},       {\"iec60909\", PGM_iec60909}};\n+std::map<std::string, PGM_ShortCircuitVoltageScaling, std::less<>> const sc_voltage_scaling_mapping = {\n+    {\"\", PGM_short_circuit_voltage_scaling_maximum}, // not provided returns default value\n+    {\"minimum\", PGM_short_circuit_voltage_scaling_minimum},\n+    {\"maximum\", PGM_short_circuit_voltage_scaling_maximum}};\n+std::map<std::string, PGM_TapChangingStrategy, std::less<>> const optimizer_strategy_mapping = {\n+    {\"disabled\", PGM_tap_changing_strategy_disabled},\n+    {\"any_valid_tap\", PGM_tap_changing_strategy_any_valid_tap},\n+    {\"min_voltage_tap\", PGM_tap_changing_strategy_min_voltage_tap},\n+    {\"max_voltage_tap\", PGM_tap_changing_strategy_max_voltage_tap},\n+    {\"fast_any_tap\", PGM_tap_changing_strategy_fast_any_tap}};\n \n // case parameters\n struct CaseParam {\n@@ -321,11 +400,12 @@ struct CaseParam {\n     std::string calculation_method;\n     std::string short_circuit_voltage_scaling;\n     std::string tap_changing_strategy;\n+    double err_tol = 1e-8;\n+    Idx max_iter = 20;\n     bool sym{};\n     bool is_batch{};\n     double rtol{};\n     bool fail{};\n-    [[no_unique_address]] BatchParameter batch_parameter{};\n     std::map<std::string, double, std::less<>> atol;\n \n     static std::string replace_backslash(std::string const& str) {\n@@ -335,29 +415,17 @@ struct CaseParam {\n     }\n };\n \n-CalculationFunc calculation_func(CaseParam const& param) {\n-    auto const get_options = [&param](CalculationMethod calculation_method, Idx threading) {\n-        return MainModel::Options{\n-            .calculation_type = calculation_type_mapping.at(param.calculation_type),\n-            .calculation_symmetry = param.sym ? CalculationSymmetry::symmetric : CalculationSymmetry::asymmetric,\n-            .calculation_method = calculation_method,\n-            .optimizer_type = param.tap_changing_strategy == \"disabled\" ? OptimizerType::no_optimization\n-                                                                        : OptimizerType::automatic_tap_adjustment,\n-            .optimizer_strategy = optimizer_strategy_mapping.at(param.tap_changing_strategy),\n-            .err_tol = 1e-8,\n-            .max_iter = 20,\n-            .threading = threading,\n-            .short_circuit_voltage_scaling = sc_voltage_scaling_mapping.at(param.short_circuit_voltage_scaling)};\n-    };\n-\n-    return [get_options](MainModel& model, CalculationMethod calculation_method, MutableDataset const& dataset,\n-                         ConstDataset const& update_dataset, Idx threading) {\n-        auto options = get_options(calculation_method, threading);\n-        if (options.optimizer_type != OptimizerType::no_optimization) {\n-            REQUIRE(options.calculation_type == CalculationType::power_flow);\n-        }\n-        return model.calculate(options, dataset, update_dataset);\n-    };\n+Options get_options(CaseParam const& param, Idx threading = -1) {\n+    Options options{};\n+    options.set_calculation_type(calculation_type_mapping.at(param.calculation_type));\n+    options.set_calculation_method(calculation_method_mapping.at(param.calculation_method));\n+    options.set_symmetric(param.sym ? 1 : 0);\n+    options.set_err_tol(param.err_tol);\n+    options.set_max_iter(param.max_iter);\n+    options.set_threading(threading);\n+    options.set_short_circuit_voltage_scaling(sc_voltage_scaling_mapping.at(param.short_circuit_voltage_scaling));\n+    options.set_tap_changing_strategy(optimizer_strategy_mapping.at(param.tap_changing_strategy));\n+    return options;\n }\n \n std::string get_output_type(std::string const& calculation_type, bool sym) {\n@@ -458,16 +526,18 @@ void add_cases(std::filesystem::path const& case_dir, std::string const& calcula\n struct ValidationCase {\n     CaseParam param;\n     OwningDataset input;\n-    std::optional<OwningDataset> output{};\n-    std::optional<OwningDataset> update_batch{};\n-    std::optional<OwningDataset> output_batch{};\n+    std::optional<OwningDataset> output;\n+    std::optional<OwningDataset> update_batch;\n+    std::optional<OwningDataset> output_batch;\n };\n \n-ValidationCase create_validation_case(CaseParam const& param) {\n-    auto const output_type = get_output_type(param.calculation_type, param.sym);\n-\n+ValidationCase create_validation_case(CaseParam const& param, std::string const& output_type) {\n     // input\n-    ValidationCase validation_case{.param = param, .input = load_dataset(param.case_dir / \"input.json\")};\n+    ValidationCase validation_case{.param = param,\n+                                   .input = load_dataset(param.case_dir / \"input.json\"),\n+                                   .output = std::nullopt,\n+                                   .update_batch = std::nullopt,\n+                                   .output_batch = std::nullopt};\n \n     // output and update\n     if (!param.is_batch) {\n@@ -524,69 +594,51 @@ void execute_test(CaseParam const& param, T&& func) {\n     std::cout << \"Validation test: \" << param.case_name;\n \n     if (should_skip_test(param)) {\n-        std::cout << \" [skipped]\" << std::endl;\n+        std::cout << \" [skipped]\" << '\\n';\n     } else {\n-        std::cout << std::endl;\n-        func();\n+        std::cout << '\\n';\n+        std::forward<T>(func)();\n     }\n }\n \n void validate_single_case(CaseParam const& param) {\n     execute_test(param, [&]() {\n-        auto const validation_case = create_validation_case(param);\n         auto const output_prefix = get_output_type(param.calculation_type, param.sym);\n-        auto const result = create_result_dataset(validation_case.input, output_prefix);\n+        auto const validation_case = create_validation_case(param, output_prefix);\n+        auto const result = create_result_dataset(validation_case.output.value(), output_prefix);\n \n-        // create model and run\n-        MainModel model{50.0, validation_case.input.const_dataset, 0};\n-        CalculationFunc const func = calculation_func(param);\n+        // create and run model\n+        auto const& options = get_options(param);\n+        Model const model{50.0, validation_case.input.const_dataset.value()};\n+        model.calculate(options, result.dataset.value());\n \n-        ConstDataset const empty{false, 1, \"update\", meta_data_gen::meta_data};\n-        func(model, calculation_method_mapping.at(param.calculation_method), result.dataset, empty, -1);\n-        assert_result(result.const_dataset, validation_case.output.value().const_dataset, param.atol, param.rtol);\n+        // check results\n+        assert_result(result, validation_case.output.value(), param.atol, param.rtol);\n     });\n }\n \n void validate_batch_case(CaseParam const& param) {\n     execute_test(param, [&]() {\n-        auto const validation_case = create_validation_case(param);\n         auto const output_prefix = get_output_type(param.calculation_type, param.sym);\n-        auto const result = create_result_dataset(validation_case.input, output_prefix);\n+        auto const validation_case = create_validation_case(param, output_prefix);\n+        auto const& info = validation_case.update_batch.value().const_dataset.value().get_info();\n+        Idx const batch_size = info.batch_size();\n+        auto const batch_result =\n+            create_result_dataset(validation_case.output_batch.value(), output_prefix, Idx{1}, batch_size);\n \n         // create model\n-        // TODO (mgovers): fix false positive of misc-const-correctness\n-        // NOLINTNEXTLINE(misc-const-correctness)\n-        MainModel model{50.0, validation_case.input.const_dataset, 0};\n-        auto const n_scenario = static_cast<Idx>(validation_case.update_batch.value().batch_scenarios.size());\n-        CalculationFunc const func = calculation_func(param);\n-\n-        // run in loops\n-        for (Idx scenario = 0; scenario != n_scenario; ++scenario) {\n-            CAPTURE(scenario);\n-\n-            MainModel model_copy{model};\n-\n-            // update and run\n-            model_copy.update_component<permanent_update_t>(\n-                validation_case.update_batch.value().batch_scenarios[scenario]);\n-            ConstDataset const empty{false, 1, \"update\", meta_data_gen::meta_data};\n-            func(model_copy, calculation_method_mapping.at(param.calculation_method), result.dataset, empty, -1);\n-\n-            // check\n-            assert_result(result.const_dataset, validation_case.output_batch.value().batch_scenarios[scenario],\n-                          param.atol, param.rtol);\n-        }\n+        Model const model{50.0, validation_case.input.const_dataset.value()};\n \n-        // run in one-go, with different threading possibility\n-        auto const batch_result = create_result_dataset(validation_case.input, output_prefix, true, n_scenario);\n+        // check results after whole update is finished\n         for (Idx const threading : {-1, 0, 1, 2}) {\n             CAPTURE(threading);\n+            // set options and run\n+            auto const& options = get_options(param, threading);\n+            model.calculate(options, batch_result.dataset.value(),\n+                            validation_case.update_batch.value().const_dataset.value());\n \n-            func(model, calculation_method_mapping.at(param.calculation_method), batch_result.dataset,\n-                 validation_case.update_batch.value().const_dataset, threading);\n-\n-            assert_result(batch_result.const_dataset, validation_case.output_batch.value().const_dataset, param.atol,\n-                          param.rtol);\n+            // check results\n+            assert_result(batch_result, validation_case.output_batch.value(), param.atol, param.rtol);\n         }\n     });\n }\n@@ -626,4 +678,4 @@ TEST_CASE(\"Validation test batch\") {\n     }\n }\n \n-} // namespace power_grid_model::meta_data\n+} // namespace power_grid_model_cpp\n", "problem_statement": "[FEATURE] Optimize compilation speed by reorganize headers\n# Introduction\r\n\r\nThe calculation core is a header-only library in C++. In each build target of unit test, C API, validation test, etc, we have multiple translation units (`.cpp` files). The compilation speed is slow in both CI and local development machine. This is frustrating and slows down the development.\r\n\r\n# Proposal\r\n\r\nWe would like to re-organize the headers in the header only library to reduce the dependencies between the headers. Hopefully we can increase the compilation speed. Possible ways of improvement can be:\r\n\r\n1. Remove most of the standard library include in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp). Only keep the absolute common standard libraries (like `cstddef`). Include the needed standard library in individual header files where it is needed.\r\n2. Forward declare classes in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp), so that other headers can use the opaque type if the full type is not needed. This reduces the dependencies between the headers.\r\n3. Use separate header file with `type_traits` types to specify the `input`, `update`, .. types of each component. In this way, when compiling meta-data (like serializer), we do not need to include all the component types, only the traiter types.\r\n4. Make the `MathSolver` a generic template class with supported solvers, just like how the `MainModelImpl` is templated with the components\r\n5. Move generic template class `using` declarations like [`using MainModel = MainModelImpl<...>;`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/main_model.hpp#L1225-L1228) to separate header files, e.g. `main_model.hpp` and `main_model_impl.hpp`. The tester of dispatch functionality of the `MainModel` could then use a component-less instance.\r\n\n", "hints_text": "I also think that the fact that we do not use builder patterns increases this issue. that's why e.g. test_math_solver.cpp needs **all** solvers, even though not all solvers are needed for all tests\r\n\r\nWe can do something with the math solvers in the same way as we do for the `AllComponents` in the `MainModelImpl`.\r\n\r\nI also would recommend putting the `using` declaration in a separate header file, such that the tests that do not care about e.g. the iterative linear solver does not need to know about that solver.\r\n\r\nMaking smaller test files should also help, because `doctest` spends a lot of compilation time just on uncollapsing e.g. nested subcases\nirrelevant for CI but relevant for local development: i also think that we can split up the build target of the unit tests into multiple smaller ones to prevent the need of compiling all tests even though you're only looking into the deepest one\n@mgovers please modify the main content with your suggested header reorganization.\r\n\n> irrelevant for CI but relevant for local development: i also think that we can split up the build target of the unit tests into multiple smaller ones to prevent the need of compiling all tests even though you're only looking into the deepest one\r\n\r\nThis could be the next step if the compilation speed is still not satisfying after optimizing the header structure. My guess is that the target compilation speed should be improved (with incremental build) when the headers are decoupled a bit.\nThis might be very novice input, but aren't we making heavy use of templates? I think normally that is also not the easiest thing when it comes to compiling.\n> This might be very novice input, but aren't we making heavy use of templates? I think normally that is also not the easiest thing when it comes to compiling.\r\n\r\nyes but its also the thing that makes our code fast, so that's part of the trade-off. making heavier use of `concepts` should solve this partially, because it first does a check on the constraints before trying to compile everything. this takes up some time but not as much as trying to compile an implementation until compilation fails and then try the next implementation (as is the case for regular templates).", "created_at": "2024-09-11 15:20:06", "merge_commit_sha": "dd0d1b07d17dc37d99bb73db74a511df7faad769", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["build-cpp-test-windows (release, msvc)", ".github/workflows/main.yml"], ["build-cpp-test-linux (debug, clang)", ".github/workflows/main.yml"], ["Build and test in Conda (windows)", ".github/workflows/main.yml"], ["publish-wheels", ".github/workflows/main.yml"], ["build-cpp-test-macos (release)", ".github/workflows/main.yml"], ["SonarCloud", ".github/workflows/sonar.yml"], ["build-cpp-test-linux (debug, gcc)", ".github/workflows/main.yml"], ["clang-tidy (debug)", ".github/workflows/clang-tidy.yml"], ["build-and-test-python (linux-aarch64)", ".github/workflows/main.yml"], ["check-code-quality", ".github/workflows/check-code-quality.yml"], ["build-cpp-test-macos (debug)", ".github/workflows/main.yml"], ["build-and-test-python (macos)", ".github/workflows/main.yml"]]}
{"repo": "PowerGridModel/power-grid-model", "instance_id": "PowerGridModel__power-grid-model-658", "base_commit": "7a72a690d61bd9b2a36daaf2f23a1a65d3536a89", "patch": "diff --git a/.github/workflows/check-code-quality.yml b/.github/workflows/check-code-quality.yml\nindex 85aabd328..dc3c5a0d8 100644\n--- a/.github/workflows/check-code-quality.yml\n+++ b/.github/workflows/check-code-quality.yml\n@@ -75,3 +75,18 @@ jobs:\n             git status --porcelain --untracked-files=no\n             exit 1\n           fi\n+      \n+      - name: Check generated code\n+        if: success()\n+        run: |\n+          pip install -r code_generation/requirements.txt\n+          python code_generation/code_gen.py\n+          if [ -n \"$(git status --porcelain)\" ]; then\n+            echo\n+            echo \"The following files are outdated or were manually updated:\"\n+            git status --porcelain\n+            exit 1\n+          else\n+            echo\n+            echo \"All the generated files are up to date.\"\n+          fi\ndiff --git a/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja b/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja\nindex ff9ff3b7d..ed849f3db 100644\n--- a/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja\n+++ b/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja\n@@ -2,7 +2,7 @@\n //\n // SPDX-License-Identifier: MPL-2.0\n \n-// This header file is automatically generated. DO NOT modify it manually!\n+// This file is automatically generated. DO NOT modify it manually!\n \n // clang-format off\n \ndiff --git a/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp b/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp\nindex 70bd343b9..52951134e 100644\n--- a/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp\n+++ b/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp\n@@ -2,7 +2,7 @@\n //\n // SPDX-License-Identifier: MPL-2.0\n \n-// This header file is automatically generated. DO NOT modify it manually!\n+// This file is automatically generated. DO NOT modify it manually!\n \n // clang-format off\n \n", "test_patch": "", "problem_statement": "[FEATURE] Action to check that the generated code is up to date\n- the `code_generation/` directory contains the code generator including its configuration.\r\n- It is important that the generated code is up to date. i.e.:\r\n  - no manual code changes were made to generated files; generated files should remain generated\r\n  - the generated files are up to date with the latest code generator including its input configuration\r\n\r\nThis issue is about adding a github action check that that is indeed the case.\r\n\r\n## TODO\r\n\r\n* [x] Update all files in the `code_generation/templates/` directory\r\n  * [x] Those files currently contain the string `This header file is automatically generated. DO NOT modify it manually!`\r\n  * [x] There is at least one CPP file that is clearly not a header file but does contain the string `header`. That is clearly wrong (as it's not a header but a CPP file)\r\n  * [x] Instead, the string should be: `This file is automatically generated. DO NOT modify it manually!`\r\n  * [x] Run the `code_generation/code_gen.py` file to update all generated files and check them in\r\n* [x] Create the github action\r\n  * [x] Install all dependencies (found in `code_generation/requirements.txt`)\r\n  * [x] Run `code_generation/code_gen.py`\r\n  * [x] Check that the `git status` is empty\r\n    * [x] should pass if it is empty\r\n    * [x] should fail action if it isn't empty and list the changed files\r\n    * [x] look up the exact command in the `git` documentation to do this\r\n  * [x] To prevent unnecessary checks, the action should only run if and only if the following checked-in files and directories are changed:\r\n    * [x] `code_generation/`\r\n    * [x] All files and directories that contain the string `This file is automatically generated. DO NOT modify it manually!`\r\n      * [x] In particular, those are the files that the templates `code_generation/templates/` map to\r\n      * [x] That is: `code_generation/templates/x/.../y.z` maps to `x/.../y.z`\r\n\n", "hints_text": "", "created_at": "2024-07-01 15:21:53", "merge_commit_sha": "7679ffb7eab471f443a761105ea11ca286f9a0eb", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["build-cpp-test-windows (release, msvc)", ".github/workflows/main.yml"], ["build-cpp-test-linux (debug, clang)", ".github/workflows/main.yml"], ["Build and test in Conda (windows)", ".github/workflows/main.yml"], ["publish-wheels", ".github/workflows/main.yml"], ["build-cpp-test-macos (release)", ".github/workflows/main.yml"], ["SonarCloud", ".github/workflows/sonar.yml"], ["build-cpp-test-linux (debug, gcc)", ".github/workflows/main.yml"], ["clang-tidy (debug)", ".github/workflows/clang-tidy.yml"], ["check-code-quality", ".github/workflows/check-code-quality.yml"], ["build-and-test-python (linux-aarch64)", ".github/workflows/main.yml"], ["build-cpp-test-macos (debug)", ".github/workflows/main.yml"], ["build-and-test-python (macos)", ".github/workflows/main.yml"]]}
{"repo": "CHERIoT-Platform/cheriot-rtos", "instance_id": "CHERIoT-Platform__cheriot-rtos-370", "base_commit": "decf37989eb4baeae7284766724740f90cdfed44", "patch": "diff --git a/sdk/include/string.h b/sdk/include/string.h\nindex 965a02b6a..2dd75f1b7 100644\n--- a/sdk/include/string.h\n+++ b/sdk/include/string.h\n@@ -6,21 +6,27 @@\n #include <stddef.h>\n #include <stdint.h>\n \n-int __cheri_libcall   memcmp(const void *str1, const void *str2, size_t count);\n-void *__cheri_libcall memcpy(void *dest, const void *src, size_t n);\n-void *__cheri_libcall memset(void *, int, size_t);\n-void *__cheri_libcall memmove(void *dest, const void *src, size_t n);\n-void *__cheri_libcall memchr(const void *, int, size_t);\n-void *__cheri_libcall memrchr(const void *, int, size_t);\n-size_t __cheri_libcall      strlen(const char *str);\n-int __cheri_libcall         strncmp(const char *s1, const char *s2, size_t n);\n-char *__cheri_libcall       strncpy(char *dest, const char *src, size_t n);\n-int __cheri_libcall         strcmp(const char *s1, const char *s2);\n-char *__cheri_libcall       strnstr(const char *haystack,\n-                                    const char *needle,\n-                                    size_t      haystackLength);\n-char *__cheri_libcall       strchr(const char *s, int c);\n-size_t __cheri_libcall      strlcpy(char *dest, const char *src, size_t n);\n+int __cheri_libcall    memcmp(const void *str1,\n+                              const void *str2,\n+                              size_t      count) __asm__(\"memcmp\");\n+void *__cheri_libcall  memcpy(void       *dest,\n+                              const void *src,\n+                              size_t      n) __asm__(\"memcpy\");\n+void *__cheri_libcall  memset(void *, int, size_t) __asm__(\"memset\");\n+void *__cheri_libcall  memmove(void       *dest,\n+                               const void *src,\n+                               size_t      n) __asm__(\"memmove\");\n+void *__cheri_libcall  memchr(const void *, int, size_t);\n+void *__cheri_libcall  memrchr(const void *, int, size_t);\n+size_t __cheri_libcall strlen(const char *str);\n+int __cheri_libcall    strncmp(const char *s1, const char *s2, size_t n);\n+char *__cheri_libcall  strncpy(char *dest, const char *src, size_t n);\n+int __cheri_libcall    strcmp(const char *s1, const char *s2);\n+char *__cheri_libcall  strnstr(const char *haystack,\n+                               const char *needle,\n+                               size_t      haystackLength);\n+char *__cheri_libcall  strchr(const char *s, int c);\n+size_t __cheri_libcall strlcpy(char *dest, const char *src, size_t n);\n \n /**\n  * Explicit bzero is a memset variant that the compiler is not permitted to\ndiff --git a/sdk/lib/freestanding/compat.S b/sdk/lib/freestanding/compat.S\nnew file mode 100644\nindex 000000000..b6b90c7b5\n--- /dev/null\n+++ b/sdk/lib/freestanding/compat.S\n@@ -0,0 +1,31 @@\n+// Copyright CHERIoT Contributors.\n+// SPDX-License-Identifier: MIT\n+\n+/**\n+ * This file contains compatibility aliases for exporting the freestanding\n+ * library functions as both mangled and unmangled symbols.\n+ */\n+\n+/**\n+ * Given a function named `function_name`, export it as a library function\n+ * named `export_function_name`.\n+ */\n+.macro EXPORT_COMPATIBILITY_ALIAS export_function_name, function_name, flags\n+\t.section .compartment_exports,\"aR\",@progbits\n+\t.type    __library_export_libcalls_\\export_function_name\\(),@object\n+\t.global  __library_export_libcalls_\\export_function_name\\()\n+    .p2align 2\n+  __library_export_libcalls_\\export_function_name\\():\n+\t.half \\function_name - __compartment_pcc_start\n+\t// Stack usage: Ignored for library exports\n+\t.byte 0\n+\t// Flags, only interrupt state is used for library exports, 0 is inherited\n+\t.byte \\flags\n+\t.size __library_export_libcalls_\\export_function_name, 40\n+\t.previous\n+.endm\n+\n+EXPORT_COMPATIBILITY_ALIAS _Z6memcmpPKvS0_j, memcmp, 3\n+EXPORT_COMPATIBILITY_ALIAS _Z6memcpyPvPKvj, memcpy, 3\n+EXPORT_COMPATIBILITY_ALIAS _Z6memsetPvij, memset, 2\n+EXPORT_COMPATIBILITY_ALIAS _Z7memmovePvPKvj, memmove, 3\ndiff --git a/sdk/lib/freestanding/memcmp.c b/sdk/lib/freestanding/memcmp.c\nindex 8f3eef9d6..9a3a5185e 100644\n--- a/sdk/lib/freestanding/memcmp.c\n+++ b/sdk/lib/freestanding/memcmp.c\n@@ -34,11 +34,12 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n /*\n  * Compare memory regions.\n  */\n-int __cheri_libcall\n+int\n memcmp(const void *s1, const void *s2, size_t n)\n {\n \tif (n != 0) {\ndiff --git a/sdk/lib/freestanding/memcpy.c b/sdk/lib/freestanding/memcpy.c\nindex 5b7c7915a..80e880a05 100644\n--- a/sdk/lib/freestanding/memcpy.c\n+++ b/sdk/lib/freestanding/memcpy.c\n@@ -45,6 +45,7 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n typedef void *word;\n \n@@ -54,7 +55,7 @@ _Static_assert((wsize & (wsize - 1)) == 0);\n \n #define wmask (wsize - 1)\n \n-void *__cheri_libcall memcpy(void *dst0, const void *src0, size_t length)\n+void *memcpy(void *dst0, const void *src0, size_t length)\n {\n \tchar *      dst = dst0;\n \tconst char *src = src0;\n@@ -119,7 +120,7 @@ void *__cheri_libcall memcpy(void *dst0, const void *src0, size_t length)\n \treturn (dst0);\n }\n \n-void *__cheri_libcall memmove(void *dst0, const void *src0, size_t length)\n+void *memmove(void *dst0, const void *src0, size_t length)\n {\n \treturn memcpy(dst0, src0, length);\n }\ndiff --git a/sdk/lib/freestanding/memset.c b/sdk/lib/freestanding/memset.c\nindex c9e4c0a31..8945d5c10 100644\n--- a/sdk/lib/freestanding/memset.c\n+++ b/sdk/lib/freestanding/memset.c\n@@ -34,11 +34,12 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n #define wsize sizeof(unsigned int)\n #define wmask (wsize - 1)\n \n-void *__cheri_libcall memset(void *dst0, int c0, size_t length)\n+void *memset(void *dst0, int c0, size_t length)\n {\n \tsize_t         t;\n \tunsigned int   c;\ndiff --git a/sdk/lib/freestanding/xmake.lua b/sdk/lib/freestanding/xmake.lua\nindex 62f10fb8f..6daf6c5ce 100644\n--- a/sdk/lib/freestanding/xmake.lua\n+++ b/sdk/lib/freestanding/xmake.lua\n@@ -1,2 +1,2 @@\n library(\"freestanding\")\n-  add_files(\"memcmp.c\", \"memcpy.c\", \"memset.c\")\n+  add_files(\"memcmp.c\", \"memcpy.c\", \"memset.c\", \"compat.S\")\n", "test_patch": "diff --git a/tests/misc-test.cc b/tests/misc-test.cc\nindex dc09d775c..2de724a1a 100644\n--- a/tests/misc-test.cc\n+++ b/tests/misc-test.cc\n@@ -10,211 +10,235 @@\n \n using namespace CHERI;\n \n-/**\n- * Test timeouts.\n- *\n- * This test checks the following:\n- *\n- * - A timeout of zero would not block.\n- * - `elapse` saturates values, i.e., a `remaining` value of zero will still be\n- *   zero after a call to `elapse`, and an `elapsed` value of `UINT32_MAX`\n- *   would still be `UINT32_MAX` after a call to `elapse`.\n- * - An unlimited timeout is really unlimited, i.e., a call to `elapse` does\n- *   not modify its `remaining` value, which blocks.\n- */\n-void check_timeouts()\n+namespace\n {\n-\tdebug_log(\"Test timeouts.\");\n-\n-\t// Create a zero timeout.\n-\tTimeout t{0};\n-\t// Ensure that a zero timeout does not block.\n-\tTEST(!t.may_block(), \"A zero timeout should not block.\");\n-\n-\t// Create a zero timer with maximum elapsed time.\n-\tt = Timeout{UINT32_MAX /* elapsed */, 0 /* remaining */};\n-\t// Ensure that a call to `elapse` saturates both `elapsed` and\n-\t// `remaining`.\n-\tt.elapse(42);\n-\tTEST(t.remaining == 0,\n-\t     \"`elapse` does not saturate the `remaining` value of a zero timer.\");\n-\tTEST(t.elapsed == UINT32_MAX,\n-\t     \"`elapse` does not saturate the `elapsed` value of a zero timer.\");\n-\n-\t// Create an unlimited timeout.\n-\tt = Timeout{UnlimitedTimeout /* remaining */};\n-\t// Ensure that a call to `elapse` does not modify the `remaining` value\n-\t// of the unlimited timeout.\n-\tt.elapse(42);\n-\tTEST(t.remaining == UnlimitedTimeout,\n-\t     \"`elapse` alters the remaining value of an unlimited timeout.\");\n-\t// Ensure that an unlimited timeout blocks.\n-\tTEST(t.may_block(), \"An unlimited timeout should block.\");\n-}\n-\n-/**\n- * Test memchr.\n- *\n- * This test checks the following:\n- *\n- * - memchr finds the first occurrence of the character when it is present\n- *   (test for different values, particularly the first and the last one).\n- * - memchr returns NULL when the string does not contain the character (test\n- *   for non-NULL terminated string).\n- * - memchr does not stop at \\0 characters.\n- * - memchr returns NULL for 0-size pointers.\n- */\n-void check_memchr()\n-{\n-\tdebug_log(\"Test memchr.\");\n \n-\tchar string[] = {'C', 'H', 'E', 'R', 'R', 'I', 'E', 'S'};\n-\n-\tTEST(memchr(string, 'C', sizeof(string)) == &string[0],\n-\t     \"memchr must return the first occurence of the character.\");\n-\tTEST(memchr(string, 'R', sizeof(string)) == &string[3],\n-\t     \"memchr must return the first occurence of the character.\");\n-\tTEST(memchr(string, 'S', sizeof(string)) == &string[7],\n-\t     \"memchr must return the first occurence of the character.\");\n-\tTEST(memchr(string, 'X', sizeof(string)) == NULL,\n-\t     \"memchr must return NULL when a character is not present.\");\n+\t/**\n+\t * Test timeouts.\n+\t *\n+\t * This test checks the following:\n+\t *\n+\t * - A timeout of zero would not block.\n+\t * - `elapse` saturates values, i.e., a `remaining` value of zero will still\n+\t * be zero after a call to `elapse`, and an `elapsed` value of `UINT32_MAX`\n+\t *   would still be `UINT32_MAX` after a call to `elapse`.\n+\t * - An unlimited timeout is really unlimited, i.e., a call to `elapse` does\n+\t *   not modify its `remaining` value, which blocks.\n+\t */\n+\tvoid check_timeouts()\n+\t{\n+\t\tdebug_log(\"Test timeouts.\");\n+\n+\t\t// Create a zero timeout.\n+\t\tTimeout t{0};\n+\t\t// Ensure that a zero timeout does not block.\n+\t\tTEST(!t.may_block(), \"A zero timeout should not block.\");\n+\n+\t\t// Create a zero timer with maximum elapsed time.\n+\t\tt = Timeout{UINT32_MAX /* elapsed */, 0 /* remaining */};\n+\t\t// Ensure that a call to `elapse` saturates both `elapsed` and\n+\t\t// `remaining`.\n+\t\tt.elapse(42);\n+\t\tTEST(\n+\t\t  t.remaining == 0,\n+\t\t  \"`elapse` does not saturate the `remaining` value of a zero timer.\");\n+\t\tTEST(t.elapsed == UINT32_MAX,\n+\t\t     \"`elapse` does not saturate the `elapsed` value of a zero timer.\");\n+\n+\t\t// Create an unlimited timeout.\n+\t\tt = Timeout{UnlimitedTimeout /* remaining */};\n+\t\t// Ensure that a call to `elapse` does not modify the `remaining` value\n+\t\t// of the unlimited timeout.\n+\t\tt.elapse(42);\n+\t\tTEST(t.remaining == UnlimitedTimeout,\n+\t\t     \"`elapse` alters the remaining value of an unlimited timeout.\");\n+\t\t// Ensure that an unlimited timeout blocks.\n+\t\tTEST(t.may_block(), \"An unlimited timeout should block.\");\n+\t}\n \n-\tchar stringWithNull[] = {'Y', 'E', 'S', '\\0', 'N', 'O', '\\0'};\n+\t/**\n+\t * Test memchr.\n+\t *\n+\t * This test checks the following:\n+\t *\n+\t * - memchr finds the first occurrence of the character when it is present\n+\t *   (test for different values, particularly the first and the last one).\n+\t * - memchr returns NULL when the string does not contain the character\n+\t * (test for non-NULL terminated string).\n+\t * - memchr does not stop at \\0 characters.\n+\t * - memchr returns NULL for 0-size pointers.\n+\t */\n+\tvoid check_memchr()\n+\t{\n+\t\tdebug_log(\"Test memchr.\");\n \n-\tTEST(memchr(stringWithNull, 'N', sizeof(stringWithNull)) ==\n-\t       &stringWithNull[4],\n-\t     \"memchr must not stop at NULL characters.\");\n+\t\tchar string[] = {'C', 'H', 'E', 'R', 'R', 'I', 'E', 'S'};\n \n-\tTEST(memchr(stringWithNull, 'N', 0) == NULL,\n-\t     \"memchr must return NULL for zero-size pointers.\");\n-}\n+\t\tTEST(memchr(string, 'C', sizeof(string)) == &string[0],\n+\t\t     \"memchr must return the first occurence of the character.\");\n+\t\tTEST(memchr(string, 'R', sizeof(string)) == &string[3],\n+\t\t     \"memchr must return the first occurence of the character.\");\n+\t\tTEST(memchr(string, 'S', sizeof(string)) == &string[7],\n+\t\t     \"memchr must return the first occurence of the character.\");\n+\t\tTEST(memchr(string, 'X', sizeof(string)) == NULL,\n+\t\t     \"memchr must return NULL when a character is not present.\");\n \n-/**\n- * Test memrchr.\n- *\n- * This test checks the following:\n- *\n- * - memrchr finds the first occurrence of the character when it is present\n- *   (test for different values, particularly the first and the last one).\n- * - memrchr returns NULL when the string does not contain the character (test\n- *   for non-NULL terminated string).\n- * - memrchr does not stop at \\0 characters.\n- * - memrchr returns NULL for 0-size pointers.\n- */\n-void check_memrchr()\n-{\n-\tdebug_log(\"Test memrchr.\");\n+\t\tchar stringWithNull[] = {'Y', 'E', 'S', '\\0', 'N', 'O', '\\0'};\n \n-\tchar string[] = {'C', 'H', 'E', 'R', 'R', 'I', 'O', 'T'};\n+\t\tTEST(memchr(stringWithNull, 'N', sizeof(stringWithNull)) ==\n+\t\t       &stringWithNull[4],\n+\t\t     \"memchr must not stop at NULL characters.\");\n \n-\tTEST(memchr(string, 'C', sizeof(string)) == &string[0],\n-\t     \"memrchr must return the first occurence of the character.\");\n-\tTEST(memrchr(string, 'R', sizeof(string)) == &string[4],\n-\t     \"memrchr must return the first occurence of the character.\");\n-\tTEST(memrchr(string, 'T', sizeof(string)) == &string[7],\n-\t     \"memrchr must return the first occurence of the character.\");\n-\tTEST(memrchr(string, 'X', sizeof(string)) == NULL,\n-\t     \"memrchr must return NULL when a character is not present.\");\n+\t\tTEST(memchr(stringWithNull, 'N', 0) == NULL,\n+\t\t     \"memchr must return NULL for zero-size pointers.\");\n+\t}\n \n-\tchar stringWithNull[] = {'F', 'U', '\\0', 'B', 'A', 'R', '\\0'};\n+\t/**\n+\t * Test memrchr.\n+\t *\n+\t * This test checks the following:\n+\t *\n+\t * - memrchr finds the first occurrence of the character when it is present\n+\t *   (test for different values, particularly the first and the last one).\n+\t * - memrchr returns NULL when the string does not contain the character\n+\t * (test for non-NULL terminated string).\n+\t * - memrchr does not stop at \\0 characters.\n+\t * - memrchr returns NULL for 0-size pointers.\n+\t */\n+\tvoid check_memrchr()\n+\t{\n+\t\tdebug_log(\"Test memrchr.\");\n \n-\tTEST(memrchr(stringWithNull, 'F', sizeof(stringWithNull)) ==\n-\t       &stringWithNull[0],\n-\t     \"memrchr must not stop at NULL characters.\");\n+\t\tchar string[] = {'C', 'H', 'E', 'R', 'R', 'I', 'O', 'T'};\n \n-\tTEST(memrchr(stringWithNull, 'Y', 0) == NULL,\n-\t     \"memrchr must return NULL for zero-size pointers.\");\n-}\n+\t\tTEST(memchr(string, 'C', sizeof(string)) == &string[0],\n+\t\t     \"memrchr must return the first occurence of the character.\");\n+\t\tTEST(memrchr(string, 'R', sizeof(string)) == &string[4],\n+\t\t     \"memrchr must return the first occurence of the character.\");\n+\t\tTEST(memrchr(string, 'T', sizeof(string)) == &string[7],\n+\t\t     \"memrchr must return the first occurence of the character.\");\n+\t\tTEST(memrchr(string, 'X', sizeof(string)) == NULL,\n+\t\t     \"memrchr must return NULL when a character is not present.\");\n \n-/**\n- * Test pointer utilities.\n- *\n- * Not comprehensive, would benefit from being expanded at some point.\n- */\n-void check_pointer_utilities()\n-{\n-\tdebug_log(\"Test pointer utilities.\");\n+\t\tchar stringWithNull[] = {'F', 'U', '\\0', 'B', 'A', 'R', '\\0'};\n \n-\tint                              integer        = 42;\n-\tint                             *integerPointer = &integer;\n-\tds::pointer::proxy::Pointer<int> pointer{integerPointer};\n+\t\tTEST(memrchr(stringWithNull, 'F', sizeof(stringWithNull)) ==\n+\t\t       &stringWithNull[0],\n+\t\t     \"memrchr must not stop at NULL characters.\");\n \n-\tTEST((pointer == integerPointer) && (*pointer == 42),\n-\t     \"The pointer proxy does not return the value of its proxy.\");\n+\t\tTEST(memrchr(stringWithNull, 'Y', 0) == NULL,\n+\t\t     \"memrchr must return NULL for zero-size pointers.\");\n+\t}\n \n-\tint                              anotherInteger        = -100;\n-\tint                             *anotherIntegerPointer = &anotherInteger;\n-\tds::pointer::proxy::Pointer<int> anotherPointer{anotherIntegerPointer};\n+\t/**\n+\t * Test pointer utilities.\n+\t *\n+\t * Not comprehensive, would benefit from being expanded at some point.\n+\t */\n+\tvoid check_pointer_utilities()\n+\t{\n+\t\tdebug_log(\"Test pointer utilities.\");\n \n-\tpointer = anotherPointer;\n+\t\tint                              integer        = 42;\n+\t\tint                             *integerPointer = &integer;\n+\t\tds::pointer::proxy::Pointer<int> pointer{integerPointer};\n \n-\tTEST((pointer == anotherIntegerPointer) && (*pointer == -100),\n-\t     \"The pointer proxy `=` operator does not correctly set the pointer.\");\n-}\n+\t\tTEST((pointer == integerPointer) && (*pointer == 42),\n+\t\t     \"The pointer proxy does not return the value of its proxy.\");\n \n-void check_shared_object(const char      *name,\n-                         Capability<void> object,\n-                         size_t           size,\n-                         PermissionSet    permissions)\n-{\n-\tdebug_log(\"Checking shared object {}.\", object);\n-\tTEST(object.length() == size,\n-\t     \"Object {} is {} bytes, expected {}\",\n-\t     name,\n-\t     object.length(),\n-\t     size);\n-\tTEST(object.permissions() == permissions,\n-\t     \"Object {} has permissions {}, expected {}\",\n-\t     name,\n-\t     PermissionSet{object.permissions()},\n-\t     permissions);\n-}\n+\t\tint  anotherInteger        = -100;\n+\t\tint *anotherIntegerPointer = &anotherInteger;\n+\t\tds::pointer::proxy::Pointer<int> anotherPointer{anotherIntegerPointer};\n \n-// This test is somewhat intimately familiar with parameters of CHERIoT's\n-// capability encoding and so might need revision if that changes.\n-void check_capability_set_inexact_at_most()\n-{\n-\tvoid *p = malloc(3128);\n+\t\tpointer = anotherPointer;\n \n-\tdebug_log(\"Test Capability::BoundsProxy::set_inexact_at_most with {}\", p);\n+\t\tTEST(\n+\t\t  (pointer == anotherIntegerPointer) && (*pointer == -100),\n+\t\t  \"The pointer proxy `=` operator does not correctly set the pointer.\");\n+\t}\n \n-\t// Too many bits for mantissa, regardless of base alignment\n+\tvoid check_shared_object(const char      *name,\n+\t                         Capability<void> object,\n+\t                         size_t           size,\n+\t                         PermissionSet    permissions)\n \t{\n-\t\tCapability<void> q      = {p};\n-\t\tsize_t           reqlen = 2047;\n-\t\tq.bounds().set_inexact_at_most(reqlen);\n-\t\tdebug_log(\"Requesting 2047 gives {}: {}\", q.length(), q);\n-\t\tTEST(q.is_valid(), \"set_inexact_at_most untagged\");\n-\t\tTEST(q.length() < 2047, \"set_inexact_at_most failed to truncate\");\n-\t\tTEST(q.base() == q.address(), \"set_inexact_at_most nonzero offset\");\n+\t\tdebug_log(\"Checking shared object {}.\", object);\n+\t\tTEST(object.length() == size,\n+\t\t     \"Object {} is {} bytes, expected {}\",\n+\t\t     name,\n+\t\t     object.length(),\n+\t\t     size);\n+\t\tTEST(object.permissions() == permissions,\n+\t\t     \"Object {} has permissions {}, expected {}\",\n+\t\t     name,\n+\t\t     PermissionSet{object.permissions()},\n+\t\t     permissions);\n \t}\n \n-\t// Fits in mantissa, but not reachable from misaligned base\n+\t// This test is somewhat intimately familiar with parameters of CHERIoT's\n+\t// capability encoding and so might need revision if that changes.\n+\tvoid check_capability_set_inexact_at_most()\n \t{\n-\t\tCapability<void> q = {p};\n-\t\tq.address() += 2;\n-\t\tsize_t reqlen = 1024;\n-\t\tq.bounds().set_inexact_at_most(reqlen);\n-\t\tdebug_log(\"Requesting 1024 at align 2 gives {}: {}\", q.length(), q);\n-\t\tTEST(q.is_valid(), \"set_inexact_at_most untagged\");\n-\t\tTEST(q.length() < 1024, \"set_inexact_at_most failed to truncate\");\n-\t\tTEST(q.base() == q.address(), \"set_inexact_at_most nonzero offset\");\n+\t\tvoid *p = malloc(3128);\n+\n+\t\tdebug_log(\"Test Capability::BoundsProxy::set_inexact_at_most with {}\",\n+\t\t          p);\n+\n+\t\t// Too many bits for mantissa, regardless of base alignment\n+\t\t{\n+\t\t\tCapability<void> q      = {p};\n+\t\t\tsize_t           reqlen = 2047;\n+\t\t\tq.bounds().set_inexact_at_most(reqlen);\n+\t\t\tdebug_log(\"Requesting 2047 gives {}: {}\", q.length(), q);\n+\t\t\tTEST(q.is_valid(), \"set_inexact_at_most untagged\");\n+\t\t\tTEST(q.length() < 2047, \"set_inexact_at_most failed to truncate\");\n+\t\t\tTEST(q.base() == q.address(), \"set_inexact_at_most nonzero offset\");\n+\t\t}\n+\n+\t\t// Fits in mantissa, but not reachable from misaligned base\n+\t\t{\n+\t\t\tCapability<void> q = {p};\n+\t\t\tq.address() += 2;\n+\t\t\tsize_t reqlen = 1024;\n+\t\t\tq.bounds().set_inexact_at_most(reqlen);\n+\t\t\tdebug_log(\"Requesting 1024 at align 2 gives {}: {}\", q.length(), q);\n+\t\t\tTEST(q.is_valid(), \"set_inexact_at_most untagged\");\n+\t\t\tTEST(q.length() < 1024, \"set_inexact_at_most failed to truncate\");\n+\t\t\tTEST(q.base() == q.address(), \"set_inexact_at_most nonzero offset\");\n+\t\t}\n+\n+\t\t// Fits in mantissa and reachable from misaligned base\n+\t\t{\n+\t\t\tCapability<void> q = {p};\n+\t\t\tq.address() += 1;\n+\t\t\tsize_t reqlen = 511;\n+\t\t\tq.bounds().set_inexact_at_most(reqlen);\n+\t\t\tdebug_log(\"Requesting 511 at align 1 gives {}: {}\", q.length(), q);\n+\t\t\tTEST(q.is_valid(), \"set_inexact_at_most untagged\");\n+\t\t\tTEST(q.length() == 511,\n+\t\t\t     \"set_inexact_at_most truncated unnecessarily\");\n+\t\t\tTEST(q.base() == q.address(), \"set_inexact_at_most nonzero offset\");\n+\t\t}\n+\n+\t\tfree(p);\n \t}\n \n-\t// Fits in mantissa and reachable from misaligned base\n+\t/**\n+\t * This is a regression test for #368.  There are many different ways for\n+\t * the compiler to generate a memcmp call and this manages to trigger one of\n+\t * the ones that wasn't being mangled the same way as others.  The run-time\n+\t * behaviour of this test is irrelevant, we should get a linker failure if\n+\t * the freestanding library and the compiler disagree on function names.\n+\t */\n+\tvoid check_odd_memcmp()\n \t{\n-\t\tCapability<void> q = {p};\n-\t\tq.address() += 1;\n-\t\tsize_t reqlen = 511;\n-\t\tq.bounds().set_inexact_at_most(reqlen);\n-\t\tdebug_log(\"Requesting 511 at align 1 gives {}: {}\", q.length(), q);\n-\t\tTEST(q.is_valid(), \"set_inexact_at_most untagged\");\n-\t\tTEST(q.length() == 511, \"set_inexact_at_most truncated unnecessarily\");\n-\t\tTEST(q.base() == q.address(), \"set_inexact_at_most nonzero offset\");\n+\t\tstd::string first  = \"first\";\n+\t\tstd::string second = \"second\";\n+\t\tTEST((first == second) == false,\n+\t\t     \"This test should never fail but exists to make sure that a \"\n+\t\t     \"comparison result is used\");\n \t}\n-\n-\tfree(p);\n-}\n+} // namespace\n \n int test_misc()\n {\n@@ -247,5 +271,6 @@ int test_misc()\n \t                      void, test_word, true, false, false, false),\n \t                    4,\n \t                    {Permission::Global, Permission::Load});\n+\tcheck_odd_memcmp();\n \treturn 0;\n }\n", "problem_statement": "Using == on std::string causes undefined symbol: __library_export_libcalls_memcmp\nWhen I use `==` or `compare` between objects of type `std::string` the linker complains as follows:\r\n```\r\nerror: ld.lld: error: undefined symbol: __library_export_libcalls_memcmp\r\n>>> referenced by hello.cc\r\n>>>               build/cheriot/cheriot/debug/hello.compartment:()\r\n```\r\n\r\nI get this error with the following minimal example.\r\nhello.cc:\r\n```\r\n#include <compartment.h>\r\n#include <debug.hh>\r\n#include <string>\r\n\r\nusing Debug = ConditionalDebug<true, \"Hello world compartment\">;\r\n\r\n/// Thread entry point.\r\nvoid __cheri_compartment(\"hello\") say_hello()\r\n{\r\n\tstd::string first = \"first\";\r\n\tstd::string second = \"second\";\r\n\tif (first == second) {\r\n\t\tDebug::log(\"Equal!\");\r\n\t}\r\n}\r\n```\r\nxmake.lua:\r\n```\r\nset_project(\"CHERIoT Hello World\")\r\nsdkdir = \"../../sdk\"\r\nincludes(sdkdir)\r\nset_toolchains(\"cheriot-clang\")\r\n\r\noption(\"board\")\r\n    set_default(\"sail\")\r\n\r\ncompartment(\"hello\")\r\n    add_deps(\"freestanding\", \"debug\", \"string\")\r\n    add_files(\"hello.cc\")\r\n\r\nfirmware(\"hello_world\")\r\n    add_deps(\"hello\")\r\n    on_load(function(target)\r\n        target:values_set(\"board\", \"$(board)\")\r\n        target:values_set(\"threads\", {\r\n            {\r\n                compartment = \"hello\",\r\n                priority = 1,\r\n                entry_point = \"say_hello\",\r\n                stack_size = 0x300,\r\n                trusted_stack_frames = 3\r\n            }\r\n        }, {expand = false})\r\n    end)\r\n```\r\n\n", "hints_text": "This may be an issue with the compiler. I think we fixed something similar for `memset` and / or `memcpy`. Let me pull in @resistor .\nMemcmp is exported with the mangled name. We should probably just stop doing that and export them h mangled, as we do with the atomics.\nIs this what you had in mind? https://github.com/resistor/llvm-project-1/tree/memcmp\nI think so, there\u2019s also some stuff in the back end that explicitly handles these (memcpy is expanded multiple times in LLVM, we need to turn it into a libcall if it\u2019s expanded late and that also includes mangling).\r\n\r\nIt looks as if we\u2019ve missed one case for memcmp, and I suspect it\u2019s easier to just export our freestanding lib calls with unmangled names than to keep fixing things in the compiler.\r\n\r\nAs a transition thing, I think we can modify the freestanding lib to export the symbols under both names, then eventually remove the mangled one.\nThank you all for the quick triage!\r\n\r\nThe patched compiler solves the issue, though I'd like to know if @davidchisnall's freestanding lib patch would be easier in my use case.\r\n\r\nI'm using CHERIoT to create a project for students, which they can then work on in the devcontainer.\r\nReplacing the compiler in the devcontainer is fine on x86, but I'd like an image for ARM as well and I'm not fond of compiling clang through qemu...\r\n\r\nDo you have any advice?\nThe devcontainer has an image for ARM64 and once a fix is merged we'll rebuild it. Will that work?\r\n\r\nExciting to hear you're using CHERIoT with students. Don't hesitate to get touch if you need any more help!\nI think we'll do the freestanding lib patch soon and then slowly migrate the compiler.  Please can you test #370, it should allow the old or new compiler to work.  We can gradually then migrate to not mangling these symbols.\r\n\r\nA few other folks are interested in projects for student, it would be great if you could join [the Signal chat](https://signal.group/#CjQKIElxAs3t3MUEMOEmQEuMHRK4rErUk2xVeFzjAjFXAShzEhCK9qQwEMFKGLGZnCjrQ7zm) and share what you're working on!\nThe freestanding lib patch works as expected with the unpatched compiler, so thank you for that!\r\nI'll use this patch going forward and let you know if I encounter issues.\r\n\r\nWith the patched compiler I get duplicate symbols for mem*:\r\n```\r\n[ 82%]: linking library freestanding.library\r\n/cheriot-tools/bin/ld.lld --script=/workspaces/cheriot-rtos/sdk/library.ldscript --compartment --gc-sections --relax -o build/cheriot/cheriot/debug/freestanding.library build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/compat.S.o build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/memcmp.c.o build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/memcpy.c.o build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/memset.c.o\r\nld.lld: error: duplicate symbol: __library_export_libcalls_memset\r\n>>> defined at build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/compat.S.o:(__library_export_libcalls_memcmp)\r\n>>> defined at __cpp_memset.c.c\r\n>>>            build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/memset.c.o:(.compartment_exports+0x0)\r\n\r\nld.lld: error: duplicate symbol: __library_export_libcalls_memcmp\r\n>>> defined at build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/compat.S.o:(__library_export_libcalls_memcmp)\r\n>>> defined at __cpp_memcmp.c.c\r\n>>>            build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/memcmp.c.o:(.compartment_exports+0x0)\r\n\r\nld.lld: error: duplicate symbol: __library_export_libcalls_memcpy\r\n>>> defined at build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/compat.S.o:(__library_export_libcalls_memcmp)\r\n>>> defined at __cpp_memcpy.c.c\r\n>>>            build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/memcpy.c.o:(.compartment_exports+0x0)\r\n\r\nld.lld: error: duplicate symbol: __library_export_libcalls_memmove\r\n>>> defined at build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/compat.S.o:(__library_export_libcalls_memcmp)\r\n>>> defined at __cpp_memcpy.c.c\r\n>>>            build/.objs/freestanding/cheriot/cheriot/debug/__/__/sdk/lib/freestanding/memcpy.c.o:(.compartment_exports+0x4)\r\n```\r\n\r\nGood to hear other people are using CHERIoT in education.\r\nOnce I've finished the assignment I'll share something about it in the Signal group!\nAh, yes, that will cause problems.  I'll add the other bit of the patch to make it explicitly set symbol names and then it should be agnostic to the compiler.  Thanks!\nPlease can you test the updated version of #370?  This should now work with both versions of the compiler.", "created_at": "2024-12-06 17:34:04", "merge_commit_sha": "de2db172fd5767566aee89f756f6f7c5cdefda89", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["run-tests (release, ibex-safe-simulator)", ".github/workflows/main.yml"], ["run-tests (debug, sail)", ".github/workflows/main.yml"], ["run-tests (release, sail)", ".github/workflows/main.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-14667", "base_commit": "5003be4b4a8e63bf1815d2e4663e6aba480afe3a", "patch": "diff --git a/FirebaseFunctions/CHANGELOG.md b/FirebaseFunctions/CHANGELOG.md\nindex f244f3f58e8..3c5253793be 100644\n--- a/FirebaseFunctions/CHANGELOG.md\n+++ b/FirebaseFunctions/CHANGELOG.md\n@@ -1,3 +1,7 @@\n+# Unreleased\n+- [fixed] Fix regression from 11.6.0 where `HTTPSCallable` did not invoke\n+  completion block on main thread (#14653).\n+\n # 11.10.0\n - [added] Streaming callable functions are now supported.\n \ndiff --git a/FirebaseFunctions/Sources/HTTPSCallable.swift b/FirebaseFunctions/Sources/HTTPSCallable.swift\nindex b423ac4195a..671a7b67dce 100644\n--- a/FirebaseFunctions/Sources/HTTPSCallable.swift\n+++ b/FirebaseFunctions/Sources/HTTPSCallable.swift\n@@ -76,15 +76,15 @@ open class HTTPSCallable: NSObject {\n   ///   - data: Parameters to pass to the trigger.\n   ///   - completion: The block to call when the HTTPS request has completed.\n   @objc(callWithObject:completion:) open func call(_ data: Any? = nil,\n-                                                   completion: @escaping (HTTPSCallableResult?,\n+                                                   completion: @escaping @MainActor (HTTPSCallableResult?,\n                                                                           Error?) -> Void) {\n     if #available(iOS 13, macCatalyst 13, macOS 10.15, tvOS 13, watchOS 7, *) {\n       Task {\n         do {\n           let result = try await call(data)\n-          completion(result, nil)\n+          await completion(result, nil)\n         } catch {\n-          completion(nil, error)\n+          await completion(nil, error)\n         }\n       }\n     } else {\n@@ -98,9 +98,13 @@ open class HTTPSCallable: NSObject {\n       ) { result in\n         switch result {\n         case let .success(callableResult):\n-          completion(callableResult, nil)\n+          DispatchQueue.main.async {\n+            completion(callableResult, nil)\n+          }\n         case let .failure(error):\n-          completion(nil, error)\n+          DispatchQueue.main.async {\n+            completion(nil, error)\n+          }\n         }\n       }\n     }\ndiff --git a/FirebaseFunctions/Tests/Integration/IntegrationTests.swift b/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\nindex 878cec1c9a0..0fa9c21e862 100644\n--- a/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\n+++ b/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\n@@ -867,6 +867,38 @@ class IntegrationTests: XCTestCase {\n       XCTAssertEqual(response, expected)\n     }\n   }\n+\n+  func testFunctionsReturnsOnMainThread() {\n+    let expectation = expectation(description: #function)\n+    functions.httpsCallable(\n+      \"scalarTest\",\n+      requestAs: Int16.self,\n+      responseAs: Int.self\n+    ).call(17) { result in\n+      guard case .success = result else {\n+        return XCTFail(\"Unexpected failure.\")\n+      }\n+      XCTAssert(Thread.isMainThread)\n+      expectation.fulfill()\n+    }\n+    waitForExpectations(timeout: 5)\n+  }\n+\n+  func testFunctionsThrowsOnMainThread() {\n+    let expectation = expectation(description: #function)\n+    functions.httpsCallable(\n+      \"httpErrorTest\",\n+      requestAs: [Int].self,\n+      responseAs: Int.self\n+    ).call([]) { result in\n+      guard case .failure = result else {\n+        return XCTFail(\"Unexpected failure.\")\n+      }\n+      XCTAssert(Thread.isMainThread)\n+      expectation.fulfill()\n+    }\n+    waitForExpectations(timeout: 5)\n+  }\n }\n \n // MARK: - Streaming\ndiff --git a/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m b/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\nindex 124f2eb9044..1d3f88981ee 100644\n--- a/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\n+++ b/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\n@@ -290,4 +290,28 @@ - (void)testTimeout {\n   [self waitForExpectations:@[ expectation ] timeout:10];\n }\n \n+- (void)testFunctionsReturnsOnMainThread {\n+  XCTestExpectation *expectation = [[XCTestExpectation alloc] init];\n+  FIRHTTPSCallable *function = [_functions HTTPSCallableWithName:@\"scalarTest\"];\n+  [function callWithObject:@17\n+                completion:^(FIRHTTPSCallableResult *_Nullable result, NSError *_Nullable error) {\n+                  XCTAssert(NSThread.isMainThread);\n+                  XCTAssertNotNil(result);\n+                  [expectation fulfill];\n+                }];\n+  [self waitForExpectations:@[ expectation ] timeout:10];\n+}\n+\n+- (void)testFunctionErrorsOnMainThread {\n+  XCTestExpectation *expectation = [[XCTestExpectation alloc] init];\n+  FIRHTTPSCallable *function = [_functions HTTPSCallableWithName:@\"httpErrorTest\"];\n+  [function callWithObject:@{}\n+                completion:^(FIRHTTPSCallableResult *_Nullable result, NSError *_Nullable error) {\n+                  XCTAssert(NSThread.isMainThread);\n+                  XCTAssertNotNil(error);\n+                  [expectation fulfill];\n+                }];\n+  [self waitForExpectations:@[ expectation ] timeout:10];\n+}\n+\n @end\ndiff --git a/FirebaseFunctions/Tests/Unit/FunctionsTests.swift b/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\nindex 476fe116853..255b2785451 100644\n--- a/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\n+++ b/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\n@@ -290,7 +290,7 @@ class FunctionsTests: XCTestCase {\n         }\n \n         XCTAssertEqual(error as NSError, networkError)\n-\n+        XCTAssert(Thread.isMainThread)\n         completionExpectation.fulfill()\n       }\n \n", "test_patch": "", "problem_statement": "HTTPSCallable does not invoke completion blocks on the main thread\n### Description\n\nIssue: `HTTPSCallable`'s `callWithObject:completion` does not invoke the completion block on the main thread.\n\nRegression: This appears to be a regression from #14085.\n\n### Reproducing the issue\n\n1. Create an HTTPSCallable function.\n2. Invoke it with `callWithObject:completion`\n\nExpected results: observe that the completion block is called on the main thread.\nActual results: the completion block is called on a background thread.\n\n### Firebase SDK Version\n\n11.11.1\n\n### Xcode Version\n\n16.2\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nFunctions\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\n\n```\n\n### If using Swift Package Manager, the project's Package.resolved\n\n_No response_\n\n### If using CocoaPods, the project's Podfile.lock\n\n_No response_\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.\ncc @ncooke3 @yakovmanshin \nSeems like an unintended consequence of that old change.\n\nOn the other hand, as I was refactoring some Functions components last year, it never occurred to me that calling completion handlers on the main thread was even as little as an *informal* convention\u2014more like a fortunate coincidence. In practice, I wouldn\u2019t rely on this behavior in client code; though, of course, some sort of harmonization would be welcome (so far there\u2019s only [one method](https://github.com/firebase/firebase-ios-sdk/blob/main/FirebaseFunctions/Sources/Functions.swift#L462-L502) in the entire module that explicitly schedules completions on the main thread).\n@bdaz, as a workaround until a fix is released, you could use the previous release or wrap the contents of your callback in `DispatchQueue.main.async {}`", "created_at": "2025-04-07 16:19:10", "merge_commit_sha": "5113cfd4f952fe29a28414b0b25bdae92a076dbd", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-integration (macos-14, Xcode_15.4)", ".github/workflows/functions.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos, macos-15, Xcode_16.2)", ".github/workflows/functions.yml"], ["spm-unit (macos-13, Xcode_15.2, iOS)", ".github/workflows/functions.yml"], ["cmake-prod-db", ".github/workflows/firestore.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm-unit (macos-15, Xcode_16.2, tvOS)", ".github/workflows/functions.yml"], ["spm-unit (macos-15, Xcode_16.2, watchOS)", ".github/workflows/functions.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["pod-lib-lint (tvos, macos-15, Xcode_16.2)", ".github/workflows/functions.yml"], ["spm-unit (macos-15, Xcode_16.2, visionOS)", ".github/workflows/functions.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13966", "base_commit": "36da449b15619d301302faeba639c7893d576220", "patch": "diff --git a/Crashlytics/run b/Crashlytics/run\nindex 93a6f11e7ae..bb1d43d8f0f 100755\n--- a/Crashlytics/run\n+++ b/Crashlytics/run\n@@ -46,8 +46,8 @@ for i in \"$@\"; do\n   ARGUMENTS=\"$ARGUMENTS \\\"$i\\\"\"\n done\n \n-VALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\n-UPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\n+VALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\n+UPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS \"\n \n # Quote the path to handle folders with special characters\n COMMAND_PATH=\"\\\"$DIR/upload-symbols\\\" \"\n", "test_patch": "", "problem_statement": "run script doesn't upload dsym files when <paths> parameter passed\n### Description\n\nWhen I try to upload multiple dsym files with <paths> parameter using run, it doesn't start uploading at all. I see this output in the build logs:\r\n\r\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"my.dSYM\", \"myother.dSYM\", \"--build-phase \", \"--validate\"]\r\n\r\nWhen I change these lines in the run script:\r\n```\r\nVALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\r\nUPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\r\n```\r\nto\r\n```\r\nVALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\r\nUPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS\"\r\n```\r\nit works, since the <paths> parameter should be the last parameter.\n\n### Reproducing the issue\n\nCall the run scirpt with a paths parameter to point another dSYM file.\n\n### Firebase SDK Version\n\n11.4\n\n### Xcode Version\n\n16\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChat-Debug.app.dSYM\", \"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChatShared.framework.dSYM\", \"--build-phase\", \"--validate\"]\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nPODS:\r\n  - FirebaseAnalytics (11.4.0):\r\n    - FirebaseAnalytics/AdIdSupport (= 11.4.0)\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseAnalytics/AdIdSupport (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleAppMeasurement (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseCore (11.4.2):\r\n    - FirebaseCoreInternal (< 12.0, >= 11.4.2)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/Logger (~> 8.0)\r\n  - FirebaseCoreExtension (11.4.1):\r\n    - FirebaseCore (~> 11.0)\r\n  - FirebaseCoreInternal (11.4.2):\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n  - FirebaseCrashlytics (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - FirebaseRemoteConfigInterop (~> 11.0)\r\n    - FirebaseSessions (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseInstallations (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseRemoteConfigInterop (11.4.0)\r\n  - FirebaseSessions (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseCoreExtension (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesSwift (~> 2.1)\r\n  - GoogleAppMeasurement (11.4.0):\r\n    - GoogleAppMeasurement/AdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/AdIdSupport (11.4.0):\r\n    - GoogleAppMeasurement/WithoutAdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/WithoutAdIdSupport (11.4.0):\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleDataTransport (10.1.0):\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - GoogleUtilities/AppDelegateSwizzler (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Network\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Environment (8.0.2):\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Logger (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/MethodSwizzler (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Network (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - \"GoogleUtilities/NSData+zlib\"\r\n    - GoogleUtilities/Privacy\r\n    - GoogleUtilities/Reachability\r\n  - \"GoogleUtilities/NSData+zlib (8.0.2)\":\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Privacy (8.0.2)\r\n  - GoogleUtilities/Reachability (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/UserDefaults (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - KMPNativeCoroutinesAsync (1.0.0-ALPHA-34):\r\n    - KMPNativeCoroutinesCore (= 1.0.0-ALPHA-34)\r\n  - KMPNativeCoroutinesCore (1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelCore (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCoreObjC (= 1.0.0-BETA-4)\r\n  - KMPObservableViewModelCoreObjC (1.0.0-BETA-4)\r\n  - KMPObservableViewModelSwiftUI (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCore (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (5.3.92)\r\n  - lottie-ios (4.5.0)\r\n  - MijickPopupView (2.7.1)\r\n  - nanopb (3.30910.0):\r\n    - nanopb/decode (= 3.30910.0)\r\n    - nanopb/encode (= 3.30910.0)\r\n  - nanopb/decode (3.30910.0)\r\n  - nanopb/encode (3.30910.0)\r\n  - OneSignalXCFramework (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalExtension (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalOutcomes (= 3.12.10)\r\n  - OneSignalXCFramework/OneSignalCore (3.12.10)\r\n  - OneSignalXCFramework/OneSignalExtension (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n    - OneSignalXCFramework/OneSignalOutcomes\r\n  - OneSignalXCFramework/OneSignalOutcomes (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n  - PromisesObjC (2.4.0)\r\n  - PromisesSwift (2.4.0):\r\n    - PromisesObjC (= 2.4.0)\r\n\r\nDEPENDENCIES:\r\n  - FirebaseAnalytics\r\n  - FirebaseCrashlytics\r\n  - KMPNativeCoroutinesAsync (= 1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelSwiftUI (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (~> 5.3.90)\r\n  - lottie-ios\r\n  - MijickPopupView\r\n  - OneSignalXCFramework (~> 3.12.9)\r\n\r\nSPEC REPOS:\r\n  https://github.com/CocoaPods/Specs.git:\r\n    - FirebaseAnalytics\r\n    - FirebaseCore\r\n    - FirebaseCoreExtension\r\n    - FirebaseCoreInternal\r\n    - FirebaseCrashlytics\r\n    - FirebaseInstallations\r\n    - FirebaseRemoteConfigInterop\r\n    - FirebaseSessions\r\n    - GoogleAppMeasurement\r\n    - GoogleDataTransport\r\n    - GoogleUtilities\r\n    - KMPNativeCoroutinesAsync\r\n    - KMPNativeCoroutinesCore\r\n    - KMPObservableViewModelCore\r\n    - KMPObservableViewModelCoreObjC\r\n    - KMPObservableViewModelSwiftUI\r\n    - lottie-ios\r\n    - MijickPopupView\r\n    - nanopb\r\n    - OneSignalXCFramework\r\n    - PromisesObjC\r\n    - PromisesSwift\r\n  https://gitlab.linphone.org/BC/public/podspec.git:\r\n    - linphone-sdk-novideo\r\n\r\nSPEC CHECKSUMS:\r\n  FirebaseAnalytics: 3feef9ae8733c567866342a1000691baaa7cad49\r\n  FirebaseCore: 6b32c57269bd999aab34354c3923d92a6e5f3f84\r\n  FirebaseCoreExtension: f1bc67a4702931a7caa097d8e4ac0a1b0d16720e\r\n  FirebaseCoreInternal: 35731192cab10797b88411be84940d2beb33a238\r\n  FirebaseCrashlytics: 41bbdd2b514a8523cede0c217aee6ef7ecf38401\r\n  FirebaseInstallations: 6ef4a1c7eb2a61ee1f74727d7f6ce2e72acf1414\r\n  FirebaseRemoteConfigInterop: e76f46ffa4d6a65e273d4dfebb6a79e588cec136\r\n  FirebaseSessions: 3f56f177d9e53a85021d16b31f9a111849d1dd8b\r\n  GoogleAppMeasurement: 987769c4ca6b968f2479fbcc9fe3ce34af454b8e\r\n  GoogleDataTransport: aae35b7ea0c09004c3797d53c8c41f66f219d6a7\r\n  GoogleUtilities: 26a3abef001b6533cf678d3eb38fd3f614b7872d\r\n  KMPNativeCoroutinesAsync: 709d922d3c8db3b83c5f0ce4035123dd7e6187b1\r\n  KMPNativeCoroutinesCore: 7e18aa574381ab40ea6a5b90ec2dffd362c0082b\r\n  KMPObservableViewModelCore: ded4abdfcc3566844c8dd18e23accd5cacd89a91\r\n  KMPObservableViewModelCoreObjC: d74dbf0c84cb8f66d6c706e89add1df9b8f653f4\r\n  KMPObservableViewModelSwiftUI: c3f740105ba32cd964cab1794d631b759d76a1d0\r\n  linphone-sdk-novideo: 50b8bcad0511613eca167586e75858f03cbaeb03\r\n  lottie-ios: a881093fab623c467d3bce374367755c272bdd59\r\n  MijickPopupView: 54863e093a18d6435cd5068850414570f9c1ba07\r\n  nanopb: fad817b59e0457d11a5dfbde799381cd727c1275\r\n  OneSignalXCFramework: e458f7a374192598a1d66418e1b61481c3cdf0e9\r\n  PromisesObjC: f5707f49cb48b9636751c5b2e7d227e43fba9f47\r\n  PromisesSwift: 9d77319bbe72ebf6d872900551f7eeba9bce2851\r\n\r\nPODFILE CHECKSUM: 4a3c4d0cf9b5f244d507d3ec13bca26d8124fa8b\r\n\r\nCOCOAPODS: 1.15.2\r\n\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.", "created_at": "2024-10-24 20:23:26", "merge_commit_sha": "c73f83a6a3e34c9fbe8517e53bc578efe5f5796c", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["spm (macos-15, Xcode_16, catalyst)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["pod-lib-lint (macos, macos-14, --use-modular-headers --skip-tests, Xcode_16)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (macos, macos-14, Xcode_15.2)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (macos, macos-14, Xcode_16)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (ios, macos-14, Xcode_15.2)", ".github/workflows/crashlytics.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["spm (macos-14, Xcode_15.4, iOS)", ".github/workflows/crashlytics.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm (macos-15, Xcode_16, iOS)", ".github/workflows/crashlytics.yml"], ["quickstart-ftl-cron-only", ".github/workflows/crashlytics.yml"], ["spm (macos-15, Xcode_16, macOS)", ".github/workflows/crashlytics.yml"], ["spm (macos-13, Xcode_15.2, iOS)", ".github/workflows/crashlytics.yml"], ["catalyst", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (ios, macos-14, Xcode_16)", ".github/workflows/crashlytics.yml"], ["spm (macos-15, Xcode_16, tvOS)", ".github/workflows/crashlytics.yml"], ["check", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos --skip-tests, macos-14, Xcode_16)", ".github/workflows/crashlytics.yml"], ["crashlytics-cron-only", ".github/workflows/crashlytics.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13580", "base_commit": "71d8e92d168333f79ee29a555d32fee086e66ca5", "patch": "diff --git a/Firebase.podspec b/Firebase.podspec\nindex 78a0093eef2..75dd6212b16 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -122,7 +122,7 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.2.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '13.0'\n+    ss.ios.deployment_target = '12.0'\n     ss.osx.deployment_target = '10.15'\n     ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n", "test_patch": "", "problem_statement": "FirebaseCrashlytics deployment target inconsistency iOS 12 or 13\n### Description\n\nOur iOS application has iOS 12 as minimum deployment target (platform :ios, '12.0' in Podfile).\r\n\r\nIn our Podfile we have:\r\n\r\n`pod 'Firebase/Crashlytics', '~> 11.0'`\r\n\r\nIt fails as in Firebase.podspec Crashlytics subspec has iOS 13\r\n```\r\n  s.subspec 'Crashlytics' do |ss|\r\n    ss.ios.deployment_target = '13.0'\r\n  end\r\n```\r\n\r\nBut if we add to Podfile\r\n`pod 'FirebaseCrashlytics', '~> 11.0'`\r\n\r\nIt works, because in FirebaseCrashlytics.podspec iOS 12 is specified\r\n`ios_deployment_target = '12.0'`\r\n\r\nProbably iOS 12 can be specified in both places?\r\n\r\nThanks\r\n\n\n### Reproducing the issue\n\n_No response_\n\n### Firebase SDK Version\n\n11.1\n\n### Xcode Version\n\n15.4\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\n[!] CocoaPods could not find compatible versions for pod \"Firebase/Crashlytics\":\r\n  In Podfile:\r\n    Firebase/Crashlytics (~> 11.0)\r\n\r\nSpecs satisfying the `Firebase/Crashlytics (~> 11.0)` dependency were found, but they required a higher minimum deployment target.\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n_No response_\n\n### If using CocoaPods, the project's Podfile.lock\n\n_No response_\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.", "created_at": "2024-09-04 14:09:46", "merge_commit_sha": "b0dbeb8d37869f48b052170633510bb4c2753d33", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["client-app-cocoapods (ClientApp-CocoaPods-iOS13)", ".github/workflows/client_app.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["changes", ".github/workflows/firestore.yml"], ["client-app-cocoapods (ClientApp-CocoaPods)", ".github/workflows/client_app.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13176", "base_commit": "04f04917927da92f8f09e51df89328271def076c", "patch": "diff --git a/FirebaseMessaging/CHANGELOG.md b/FirebaseMessaging/CHANGELOG.md\nindex 29aa94a6057..d04f3da27c2 100644\n--- a/FirebaseMessaging/CHANGELOG.md\n+++ b/FirebaseMessaging/CHANGELOG.md\n@@ -1,3 +1,6 @@\n+# Unreleased\n+- [fixed] Fixed the APS Environment key on visionOS. (#13173)\n+\n # 10.29.0\n - [fixed] Renamed \"initWithFileName\" internal method that was causing submission issues for some\n   users. (#13134).\ndiff --git a/FirebaseMessaging/Sources/FIRMessagingUtilities.m b/FirebaseMessaging/Sources/FIRMessagingUtilities.m\nindex 2d9bddb5187..212cdf7208d 100644\n--- a/FirebaseMessaging/Sources/FIRMessagingUtilities.m\n+++ b/FirebaseMessaging/Sources/FIRMessagingUtilities.m\n@@ -28,12 +28,16 @@\n \n static NSString *const kFIRMessagingWatchKitExtensionPoint = @\"com.apple.watchkit\";\n \n-#if TARGET_OS_IOS || TARGET_OS_TV || TARGET_OS_WATCH\n-static NSString *const kEntitlementsAPSEnvironmentKey = @\"Entitlements.aps-environment\";\n-#else\n+#if TARGET_OS_OSX\n+// macOS uses a different entitlement key than the rest of Apple's platforms:\n+// https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_developer_aps-environment\n static NSString *const kEntitlementsAPSEnvironmentKey =\n     @\"Entitlements.com.apple.developer.aps-environment\";\n-#endif\n+#else\n+// Entitlement key for all non-macOS platforms:\n+// https://developer.apple.com/documentation/bundleresources/entitlements/aps-environment\n+static NSString *const kEntitlementsAPSEnvironmentKey = @\"Entitlements.aps-environment\";\n+#endif  // TARGET_OS_OSX\n static NSString *const kAPSEnvironmentDevelopmentValue = @\"development\";\n \n #pragma mark - URL Helpers\n", "test_patch": "", "problem_statement": "Firebase Cloud Messaging not working with visionOS\n### Description\n\nI have configured remote notifications for my cross-platform SwiftUI app, everything functions correctly and I'm receiving notifications on iOS devices but receive apns errors when launching on visionOS. \r\n\r\nERROR:\r\n10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\r\n\r\nI do successfully received the device token from fcm. These errors do not occur on iOS. I have also tested this on a clean project and had the same results.\n\n### Reproducing the issue\n\nUsing standing setup for a SwiftUI app will produce the errors when targeting visionOS\r\n\r\n`import SwiftUI\r\nimport FirebaseCore\r\nimport FirebaseMessaging\r\n\r\nclass AppDelegate: NSObject, UIApplicationDelegate, MessagingDelegate, UNUserNotificationCenterDelegate {\r\n    \r\n    func application(_ application: UIApplication,\r\n                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil) -> Bool {\r\n        application.registerForRemoteNotifications()\r\n        registerForPushNotifications(application: application)\r\n        \r\n        FirebaseApp.configure()\r\n        Messaging.messaging().delegate = self\r\n        return true\r\n    }\r\n    \r\n    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {\r\n        let tokenParts = deviceToken.map { data in String(format: \"%02.2hhx\", data) }\r\n        let token = tokenParts.joined()\r\n        print(\"Device Token: \\(token)\")\r\n        Messaging.messaging().apnsToken = deviceToken\r\n    }\r\n    \r\n    func registerForPushNotifications(application: UIApplication) {\r\n        UNUserNotificationCenter.current().delegate = self\r\n        let authOptions: UNAuthorizationOptions = [.alert, .badge, .sound]\r\n      \r\n        UNUserNotificationCenter.current().requestAuthorization(options: authOptions) { granted, error in\r\n            if let error = error {\r\n                print(\"Failed to request authorization: \\(error.localizedDescription)\")\r\n                return\r\n            }\r\n            guard granted else { return }\r\n            DispatchQueue.main.async {\r\n                application.registerForRemoteNotifications()\r\n            }\r\n        }\r\n    }\r\n    \r\n    func userNotificationCenter(_ center: UNUserNotificationCenter,\r\n                                willPresent notification: UNNotification,\r\n                                withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {\r\n   \r\n        completionHandler([.banner, .badge, .sound])\r\n    }\r\n    \r\n    func userNotificationCenter(_ center: UNUserNotificationCenter,\r\n                                didReceive response: UNNotificationResponse,\r\n                                withCompletionHandler completionHandler: @escaping () -> Void) {\r\n        let userInfo = response.notification.request.content.userInfo\r\n        completionHandler()\r\n    }\r\n    \r\n    func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {\r\n        print(\"Token: \\(fcmToken)\")\r\n    }\r\n}\r\n\r\n@main\r\nstruct NotificationsApp: App {\r\n    \r\n    @UIApplicationDelegateAdaptor(AppDelegate.self) var delegate\r\n    var body: some Scene {\r\n        WindowGroup {\r\n            ContentView()\r\n        }\r\n\r\n        ImmersiveSpace(id: \"ImmersiveSpace\") {\r\n            ImmersiveView()\r\n        }\r\n    }\r\n}`\n\n### Firebase SDK Version\n\n10.28.0\n\n### Xcode Version\n\n15.2\n\n### Installation Method\n\nSwift Package Manager\n\n### Firebase Product(s)\n\nMessaging\n\n### Targeted Platforms\n\niOS, visionOS\n\n### Relevant Log Output\n\n```shell\n10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\r\n\r\n<Error>: 10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.", "created_at": "2024-06-24 20:30:36", "merge_commit_sha": "5ef8265cfa3c262dd3f65cf12639fe8b3ecf50f5", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["messaging-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint-abtesting", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-dynamiclinks (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["messaging-watchos-standalone-sample-build-test", ".github/workflows/messaging.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-storage", ".github/workflows/health-metrics-presubmit.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-firestore", ".github/workflows/health-metrics-presubmit.yml"], ["spm (tvOS, macos-13)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-remoteconfig", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-remoteconfig (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["sanitizers-ubuntu", ".github/workflows/firestore.yml"], ["spm (iOS, macos-13)", ".github/workflows/messaging.yml"], ["quickstart-ftl-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint-database (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["quickstart (macos-13, Xcode_15.2)", ".github/workflows/messaging.yml"], ["catalyst", ".github/workflows/messaging.yml"], ["messaging_quickstart", ".github/workflows/prerelease.yml"], ["auth_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint-database", ".github/workflows/health-metrics-presubmit.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["spm (tvOS, macos-14)", ".github/workflows/messaging.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-inappmessaging", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["changes", ".github/workflows/firestore.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["messaging-integration-tests", ".github/workflows/messaging.yml"], ["performance_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-firestore (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["check", ".github/workflows/check.yml"], ["Check changed files", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-storage (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"], ["buildup_SpecsTesting_repo_FirebaseCore", ".github/workflows/prerelease.yml"], ["check-firestore-internal-public-headers", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13114", "base_commit": "3af2f80aeeb81c58867265569939b1818e2f544d", "patch": "diff --git a/FirebaseStorage/CHANGELOG.md b/FirebaseStorage/CHANGELOG.md\nindex 1baafc4bbdb..1703f2ae829 100644\n--- a/FirebaseStorage/CHANGELOG.md\n+++ b/FirebaseStorage/CHANGELOG.md\n@@ -1,3 +1,9 @@\n+# 11.0.0\n+- [fixed] Updated error handling to support both Swift error enum handling and NSError error\n+  handling. Some of the Swift enums have additional parameters which may be a **breaking** change.\n+  There are additional NSError's for completeness, but nothing related to NSError handling is\n+  breaking. (#13071, #10889, #13114)\n+\n # 10.24.0\n - [fixed] `putFile` and `putFileAsync` now work in app extensions. A background session\n    configuration is not used when uploading from an app extension (#12579).\ndiff --git a/FirebaseStorage/Sources/AsyncAwait.swift b/FirebaseStorage/Sources/AsyncAwait.swift\nindex 8fffded0e18..e38a2525711 100644\n--- a/FirebaseStorage/Sources/AsyncAwait.swift\n+++ b/FirebaseStorage/Sources/AsyncAwait.swift\n@@ -66,7 +66,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putDataAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putDataAsync\")\n         ))\n       }\n     }\n@@ -103,7 +104,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putFileAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putFileAsync\")\n         ))\n       }\n     }\n@@ -137,7 +139,8 @@ public extension StorageReference {\n       }\n       downloadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in writeAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in writeAsync\")\n         ))\n       }\n     }\ndiff --git a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\nindex 2cca8acdca2..5fb5ca61ae1 100644\n--- a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n@@ -74,10 +74,10 @@ class StorageGetDownloadURLTask: StorageTask, StorageTaskManagement {\n              .jsonObject(with: data) as? [String: Any] {\n             downloadURL = self.downloadURLFromMetadataDictionary(responseDictionary)\n             if downloadURL == nil {\n-              self.error = NSError(domain: StorageErrorDomain,\n-                                   code: StorageErrorCode.unknown.rawValue,\n-                                   userInfo: [NSLocalizedDescriptionKey:\n-                                     \"Failed to retrieve a download URL.\"])\n+              self.error = StorageError.unknown(\n+                message: \"Failed to retrieve a download URL.\",\n+                serverError: [:]\n+              ) as NSError\n             }\n           } else {\n             self.error = StorageErrorCode.error(withInvalidRequest: data)\ndiff --git a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\nindex 217f8775116..bb195656cae 100644\n--- a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n@@ -45,12 +45,7 @@ class StorageTokenAuthorizer: NSObject, GTMSessionFetcherAuthorizer {\n           var errorDictionary = error.userInfo\n           errorDictionary[\"ResponseErrorDomain\"] = error.domain\n           errorDictionary[\"ResponseErrorCode\"] = error.code\n-          errorDictionary[NSLocalizedDescriptionKey] =\n-            \"User is not authenticated, please authenticate\" +\n-            \" using Firebase Authentication and try again.\"\n-          tokenError = NSError(domain: \"FIRStorageErrorDomain\",\n-                               code: StorageErrorCode.unauthenticated.rawValue,\n-                               userInfo: errorDictionary)\n+          tokenError = StorageError.unauthenticated(serverError: errorDictionary) as NSError\n         } else if let token {\n           let firebaseToken = \"Firebase \\(token)\"\n           request?.setValue(firebaseToken, forHTTPHeaderField: \"Authorization\")\ndiff --git a/FirebaseStorage/Sources/Result.swift b/FirebaseStorage/Sources/Result.swift\nindex 931794cbfb1..3a73da64f97 100644\n--- a/FirebaseStorage/Sources/Result.swift\n+++ b/FirebaseStorage/Sources/Result.swift\n@@ -29,9 +29,11 @@ private func getResultCallback<T>(completion: @escaping (Result<T, Error>) -> Vo\n     if let value {\n       completion(.success(value))\n     } else if let error {\n-      completion(.failure(StorageError.swiftConvert(objcError: error as NSError)))\n+      completion(.failure(error))\n     } else {\n-      completion(.failure(StorageError.internalError(\"Internal failure in getResultCallback\")))\n+      completion(.failure(StorageError.internalError(\n+        message: \"Internal failure in getResultCallback\"\n+      )))\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/Storage.swift b/FirebaseStorage/Sources/Storage.swift\nindex 3d547e28da3..09f211d3341 100644\n--- a/FirebaseStorage/Sources/Storage.swift\n+++ b/FirebaseStorage/Sources/Storage.swift\n@@ -193,9 +193,9 @@ import FirebaseCore\n     do {\n       path = try StoragePath.path(string: url.absoluteString)\n     } catch let StoragePathError.storagePathError(message) {\n-      throw StorageError.pathError(message)\n+      throw StorageError.pathError(message: message)\n     } catch {\n-      throw StorageError.pathError(\"Internal error finding StoragePath: \\(error)\")\n+      throw StorageError.pathError(message: \"Internal error finding StoragePath: \\(error)\")\n     }\n \n     // If no default bucket exists (empty string), accept anything.\n@@ -205,7 +205,7 @@ import FirebaseCore\n     // If there exists a default bucket, throw if provided a different bucket.\n     if path.bucket != storageBucket {\n       throw StorageError\n-        .bucketMismatch(\"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n+        .bucketMismatch(message: \"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n           \"bucket of the current instance: `\\(storageBucket)`\")\n     }\n     return StorageReference(storage: self, path: path)\ndiff --git a/FirebaseStorage/Sources/StorageDownloadTask.swift b/FirebaseStorage/Sources/StorageDownloadTask.swift\nindex 8f9f0332393..91629bd632b 100644\n--- a/FirebaseStorage/Sources/StorageDownloadTask.swift\n+++ b/FirebaseStorage/Sources/StorageDownloadTask.swift\n@@ -67,8 +67,7 @@ open class StorageDownloadTask: StorageObservableTask, StorageTaskManagement {\n    * Cancels a task.\n    */\n   @objc open func cancel() {\n-    let error = StorageErrorCode.error(withCode: .cancelled)\n-    cancel(withError: error)\n+    cancel(withError: StorageError.cancelled as NSError)\n   }\n \n   /**\ndiff --git a/FirebaseStorage/Sources/StorageError.swift b/FirebaseStorage/Sources/StorageError.swift\nindex d9e80dd31bd..f3e02340a2d 100644\n--- a/FirebaseStorage/Sources/StorageError.swift\n+++ b/FirebaseStorage/Sources/StorageError.swift\n@@ -36,24 +36,17 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n   case downloadSizeExceeded = -13032\n   case cancelled = -13040\n   case invalidArgument = -13050\n+  case bucketMismatch = -13051\n+  case internalError = -13052\n+  case pathError = -13053\n \n   /**\n-   * Creates a Firebase Storage error from a specific GCS error and FIRIMPLStorageReference.\n+   * Creates a Firebase Storage error from a specific GCS error and StorageReference.\n    * @param serverError Server error to wrap and return as a Firebase Storage error.\n    * @param ref StorageReference which provides context about the request being made.\n    * @return Returns a Firebase Storage error.\n    */\n   static func error(withServerError serverError: NSError, ref: StorageReference) -> NSError {\n-    var errorCode: StorageErrorCode\n-    switch serverError.code {\n-    case 400: errorCode = .unknown\n-    case 401: errorCode = .unauthenticated\n-    case 402: errorCode = .quotaExceeded\n-    case 403: errorCode = .unauthorized\n-    case 404: errorCode = .objectNotFound\n-    default: errorCode = .unknown\n-    }\n-\n     var errorDictionary = serverError.userInfo\n     errorDictionary[\"ResponseErrorDomain\"] = serverError.domain\n     errorDictionary[\"ResponseErrorCode\"] = serverError.code\n@@ -66,7 +59,29 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     if let data = (errorDictionary[\"data\"] as? Data) {\n       errorDictionary[\"ResponseBody\"] = String(data: data, encoding: .utf8)\n     }\n-    return error(withCode: errorCode, infoDictionary: errorDictionary)\n+    let storageError = switch serverError.code {\n+    case 400: StorageError.unknown(\n+        message: \"Unknown 400 error from backend\",\n+        serverError: errorDictionary\n+      )\n+    case 401: StorageError.unauthenticated(serverError: errorDictionary)\n+    case 402: StorageError.quotaExceeded(\n+        bucket: ref.path.bucket,\n+        serverError: errorDictionary\n+      )\n+    case 403: StorageError.unauthorized(\n+        bucket: ref.path.bucket,\n+        object: ref.path.object ?? \"<object-entity-internal-error>\",\n+        serverError: errorDictionary\n+      )\n+    case 404: StorageError.objectNotFound(\n+        object: ref.path.object ?? \"<object-entity-internal-error>\", serverError: errorDictionary\n+      )\n+    default: StorageError.unknown(\n+        message: \"Unexpected \\(serverError.code) code from backend\", serverError: errorDictionary\n+      )\n+    }\n+    return storageError as NSError\n   }\n \n   /** Creates a Firebase Storage error from an invalid request.\n@@ -81,143 +96,123 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     } else {\n       requestString = \"<nil request returned from server>\"\n     }\n-    let invalidDataString = \"Invalid data returned from the server:\\(requestString)\"\n-    return error(\n-      withCode: .unknown,\n-      infoDictionary: [NSLocalizedFailureErrorKey: invalidDataString]\n-    )\n+    let invalidDataString = \"Invalid data returned from the server: \\(requestString)\"\n+    return StorageError.unknown(message: invalidDataString, serverError: [:]) as NSError\n   }\n+}\n \n-  /**\n-   * Creates a Firebase Storage error from a specific FIRStorageErrorCode while adding\n-   * custom info from an optionally provided info dictionary.\n-   */\n-  static func error(withCode code: StorageErrorCode,\n-                    infoDictionary: [String: Any]? = nil) -> NSError {\n-    var dictionary = infoDictionary ?? [:]\n-    var errorMessage: String\n-    switch code {\n+/// Firebase Storage errors\n+public enum StorageError: Error, CustomNSError {\n+  case unknown(message: String, serverError: [String: Any])\n+  case objectNotFound(object: String, serverError: [String: Any])\n+  case bucketNotFound(bucket: String)\n+  case projectNotFound(project: String)\n+  case quotaExceeded(bucket: String, serverError: [String: Any])\n+  case unauthenticated(serverError: [String: Any])\n+  case unauthorized(bucket: String, object: String, serverError: [String: Any])\n+  case retryLimitExceeded\n+  case nonMatchingChecksum\n+  case downloadSizeExceeded(total: Int64, maxSize: Int64)\n+  case cancelled\n+  case invalidArgument(message: String)\n+  case internalError(message: String)\n+  case bucketMismatch(message: String)\n+  case pathError(message: String)\n+\n+  // MARK: - CustomNSError\n+\n+  /// Default domain of the error.\n+  public static var errorDomain: String { return StorageErrorDomain }\n+\n+  /// The error code within the given domain.\n+  public var errorCode: Int {\n+    switch self {\n+    case .unknown:\n+      return StorageErrorCode.unknown.rawValue\n     case .objectNotFound:\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"Object \\(object) does not exist.\"\n+      return StorageErrorCode.objectNotFound.rawValue\n     case .bucketNotFound:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage = \"Bucket \\(bucket) does not exist.\"\n+      return StorageErrorCode.bucketNotFound.rawValue\n     case .projectNotFound:\n-      let project = dictionary[\"project\"] ?? \"<project-entity-internal-error>\"\n-      errorMessage = \"Project \\(project) does not exist.\"\n+      return StorageErrorCode.projectNotFound.rawValue\n     case .quotaExceeded:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage =\n-        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n-    case .downloadSizeExceeded:\n-      let total = \"\\(dictionary[\"totalSize\"] ?? \"unknown\")\"\n-      let size = \"\\(dictionary[\"maxAllowedSize\"] ?? \"unknown\")\"\n-      errorMessage = \"Attempted to download object with size of \\(total) bytes, \" +\n-        \"which exceeds the maximum size of \\(size) bytes. \" +\n-        \"Consider raising the maximum download size, or using StorageReference.write\"\n+      return StorageErrorCode.quotaExceeded.rawValue\n     case .unauthenticated:\n-      errorMessage = \"User is not authenticated, please authenticate using Firebase \" +\n-        \"Authentication and try again.\"\n+      return StorageErrorCode.unauthenticated.rawValue\n     case .unauthorized:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return StorageErrorCode.unauthorized.rawValue\n     case .retryLimitExceeded:\n-      errorMessage = \"Max retry time for operation exceeded, please try again.\"\n+      return StorageErrorCode.retryLimitExceeded.rawValue\n     case .nonMatchingChecksum:\n-      // TODO: replace with actual checksum strings when we choose to implement.\n-      errorMessage = \"Uploaded/downloaded object TODO has checksum: TODO \" +\n-        \"which does not match server checksum: TODO. Please retry the upload/download.\"\n+      return StorageErrorCode.nonMatchingChecksum.rawValue\n+    case .downloadSizeExceeded:\n+      return StorageErrorCode.downloadSizeExceeded.rawValue\n     case .cancelled:\n-      errorMessage = \"User cancelled the upload/download.\"\n-    case .unknown, .invalidArgument: // invalidArgument fell through in the old Objective-C code.\n-      errorMessage = \"An unknown error occurred, please check the server response.\"\n+      return StorageErrorCode.cancelled.rawValue\n+    case .invalidArgument:\n+      return StorageErrorCode.invalidArgument.rawValue\n+    case .internalError:\n+      return StorageErrorCode.internalError.rawValue\n+    case .bucketMismatch:\n+      return StorageErrorCode.bucketMismatch.rawValue\n+    case .pathError:\n+      return StorageErrorCode.pathError.rawValue\n     }\n-    dictionary[NSLocalizedDescriptionKey] = errorMessage\n-    return NSError(domain: StorageErrorDomain, code: code.rawValue, userInfo: dictionary)\n   }\n-}\n-\n-public enum StorageError: Error {\n-  case unknown(String)\n-  case objectNotFound(String)\n-  case bucketNotFound(String)\n-  case projectNotFound(String)\n-  case quotaExceeded(String)\n-  case unauthenticated\n-  case unauthorized(String, String)\n-  case retryLimitExceeded\n-  case nonMatchingChecksum\n-  case downloadSizeExceeded(Int64, Int64)\n-  case cancelled\n-  case invalidArgument(String)\n-  case internalError(String)\n-  case bucketMismatch(String)\n-  case pathError(String)\n \n-  static func swiftConvert(objcError: NSError) -> StorageError {\n-    let userInfo = objcError.userInfo\n-\n-    switch objcError.code {\n-    case StorageErrorCode.unknown.rawValue:\n-      return StorageError.unknown(objcError.localizedDescription)\n-    case StorageErrorCode.objectNotFound.rawValue:\n-      guard let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode object not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.objectNotFound(object)\n-    case StorageErrorCode.bucketNotFound.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode bucket not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.bucketNotFound(bucket)\n-    case StorageErrorCode.projectNotFound.rawValue:\n-      guard let project = userInfo[\"project\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode project not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.projectNotFound(project)\n-    case StorageErrorCode.quotaExceeded.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\"Failed to decode quota exceeded error: \\(objcError.localizedDescription)\")\n-      }\n-      return StorageError.quotaExceeded(bucket)\n-    case StorageErrorCode.unauthenticated.rawValue: return StorageError.unauthenticated\n-    case StorageErrorCode.unauthorized.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String,\n-            let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode unauthorized error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.unauthorized(bucket, object)\n-    case StorageErrorCode.retryLimitExceeded.rawValue: return StorageError.retryLimitExceeded\n-    case StorageErrorCode.nonMatchingChecksum.rawValue: return StorageError\n-      .nonMatchingChecksum\n-    case StorageErrorCode.downloadSizeExceeded.rawValue:\n-      guard let total = userInfo[\"totalSize\"] as? Int64,\n-            let maxSize = userInfo[\"maxAllowedSize\"] as? Int64 else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode downloadSizeExceeded error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.downloadSizeExceeded(total, maxSize)\n-    case StorageErrorCode.cancelled.rawValue: return StorageError.cancelled\n-    case StorageErrorCode.invalidArgument.rawValue: return StorageError\n-      .invalidArgument(objcError.localizedDescription)\n-    default: return StorageError.internalError(\"Internal error converting ObjC Error to Swift\")\n+  /// The default user-info dictionary.\n+  public var errorUserInfo: [String: Any] {\n+    switch self {\n+    case let .unknown(message, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = message\n+      return dictionary\n+    case let .objectNotFound(object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"Object \\(object) does not exist.\"\n+      return dictionary\n+    case let .bucketNotFound(bucket):\n+      return [NSLocalizedDescriptionKey: \"Bucket \\(bucket) does not exist.\"]\n+    case let .projectNotFound(project):\n+      return [NSLocalizedDescriptionKey: \"Project \\(project) does not exist.\"]\n+    case let .quotaExceeded(bucket, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n+      return dictionary\n+    case let .unauthenticated(serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"User is not authenticated, please \" +\n+        \"authenticate using Firebase Authentication and try again.\"\n+      return dictionary\n+    case let .unauthorized(bucket, object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return dictionary\n+    case .retryLimitExceeded:\n+      return [NSLocalizedDescriptionKey: \"Max retry time for operation exceeded, please try again.\"]\n+    case .nonMatchingChecksum:\n+      // TODO: replace with actual checksum strings when we choose to implement.\n+      return [NSLocalizedDescriptionKey: \"Uploaded/downloaded object TODO has checksum: TODO \" +\n+        \"which does not match server checksum: TODO. Please retry the upload/download.\"]\n+    case let .downloadSizeExceeded(total, maxSize):\n+      var dictionary: [String: Any] = [\"totalSize\": total, \"maxAllowedSize\": maxSize]\n+      dictionary[NSLocalizedDescriptionKey] = \"Attempted to download object with size of \" +\n+        \"\\(total) bytes, \" +\n+        \"which exceeds the maximum size of \\(maxSize) bytes. \" +\n+        \"Consider raising the maximum download maxSize, or using StorageReference.write\"\n+      return dictionary\n+    case .cancelled:\n+      return [NSLocalizedDescriptionKey: \"User cancelled the upload/download.\"]\n+    case let .invalidArgument(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .internalError(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .bucketMismatch(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .pathError(message):\n+      return [NSLocalizedDescriptionKey: message]\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/StorageReference.swift b/FirebaseStorage/Sources/StorageReference.swift\nindex 92a547b3f14..9e4f0c29c41 100644\n--- a/FirebaseStorage/Sources/StorageReference.swift\n+++ b/FirebaseStorage/Sources/StorageReference.swift\n@@ -399,11 +399,9 @@ import Foundation\n   open func list(maxResults: Int64,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -437,11 +435,9 @@ import Foundation\n                  pageToken: String,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -584,11 +580,10 @@ import Foundation\n   /// For maxSize API, return an error if the size is exceeded.\n   private func checkSizeOverflow(task: StorageTask, maxSize: Int64) -> NSError? {\n     if task.progress.totalUnitCount > maxSize || task.progress.completedUnitCount > maxSize {\n-      return StorageErrorCode.error(withCode: .downloadSizeExceeded,\n-                                    infoDictionary: [\n-                                      \"totalSize\": task.progress.totalUnitCount,\n-                                      \"maxAllowedSize\": maxSize,\n-                                    ])\n+      return StorageError.downloadSizeExceeded(\n+        total: task.progress.totalUnitCount,\n+        maxSize: maxSize\n+      ) as NSError\n     }\n     return nil\n   }\ndiff --git a/FirebaseStorage/Sources/StorageTaskSnapshot.swift b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\nindex 3c909d67855..d7b291b06a8 100644\n--- a/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n+++ b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n@@ -68,7 +68,7 @@ import Foundation\n        reference: StorageReference,\n        progress: Progress,\n        metadata: StorageMetadata? = nil,\n-       error: NSError? = nil) {\n+       error: Error? = nil) {\n     self.task = task\n     self.reference = reference\n     self.progress = progress\ndiff --git a/FirebaseStorage/Sources/StorageUploadTask.swift b/FirebaseStorage/Sources/StorageUploadTask.swift\nindex 8c99e8c4a28..5878b03fb04 100644\n--- a/FirebaseStorage/Sources/StorageUploadTask.swift\n+++ b/FirebaseStorage/Sources/StorageUploadTask.swift\n@@ -237,14 +237,10 @@ import Foundation\n        isFile == true {\n       return nil\n     }\n-    let userInfo = [NSLocalizedDescriptionKey:\n-      \"File at URL: \\(fileURL?.absoluteString ?? \"\") is not reachable.\"\n-      + \" Ensure file URL is not a directory, symbolic link, or invalid url.\"]\n-    return NSError(\n-      domain: StorageErrorDomain,\n-      code: StorageErrorCode.unknown.rawValue,\n-      userInfo: userInfo\n-    )\n+    return StorageError.unknown(message: \"File at URL: \\(fileURL?.absoluteString ?? \"\") is \" +\n+      \"not reachable. Ensure file URL is not \" +\n+      \"a directory, symbolic link, or invalid url.\",\n+      serverError: [:]) as NSError\n   }\n \n   func finishTaskWithStatus(status: StorageTaskStatus, snapshot: StorageTaskSnapshot) {\ndiff --git a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\nindex f8729a5b675..fa780f24a6c 100644\n--- a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n@@ -118,11 +118,29 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putDataAsync(data)\n       XCTFail(\"Unexpected success from unauthorized putData\")\n-    } catch let StorageError.unauthorized(bucket, object) {\n+    } catch let StorageError.unauthorized(bucket, object, _) {\n       XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n       XCTAssertEqual(object, objectLocation)\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unauthorized\")\n+      XCTFail(\"error failed to convert to StorageError.unauthorized  \\(error)\")\n+    }\n+  }\n+\n+  func testSimplePutDataUnauthorizedWithNSError() async throws {\n+    let objectLocation = \"ios/private/secretfile.txt\"\n+    let ref = storage.reference(withPath: objectLocation)\n+    let data = try XCTUnwrap(\"Hello Swift World\".data(using: .utf8), \"Data construction failed\")\n+    do {\n+      _ = try await ref.putDataAsync(data)\n+      XCTFail(\"Unexpected success from unauthorized putData\")\n+    } catch {\n+      let e = error as NSError\n+      XCTAssertEqual(e.domain, StorageErrorDomain)\n+      XCTAssertEqual(e.code, StorageErrorCode.unauthorized.rawValue)\n+      XCTAssertEqual(e.localizedDescription, \"User does not have permission to access\" +\n+        \" gs://ios-opensource-samples.appspot.com/ios/private/secretfile.txt.\")\n+      XCTAssertEqual(e.userInfo[\"ResponseErrorCode\"] as? Int, 403)\n+      print(e)\n     }\n   }\n \n@@ -136,13 +154,13 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putFileAsync(from: fileURL)\n       XCTFail(\"Unexpected success from putFile of a directory\")\n-    } catch let StorageError.unknown(reason) {\n+    } catch let StorageError.unknown(reason, _) {\n       XCTAssertTrue(reason.starts(with: \"File at URL:\"))\n       XCTAssertTrue(reason.hasSuffix(\n         \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n       ))\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unknown\")\n+      XCTFail(\"error failed to convert to StorageError.unknown \\(error)\")\n     }\n   }\n \ndiff --git a/FirebaseStorage/Tests/Integration/StorageIntegration.swift b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\nindex 2f407dc7427..7e93e84e7fe 100644\n--- a/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n@@ -201,7 +201,7 @@ class StorageResultTests: StorageIntegrationCommon {\n         XCTFail(\"Unexpected success from unauthorized putData\")\n       case let .failure(error as StorageError):\n         switch error {\n-        case let .unauthorized(bucket, object):\n+        case let .unauthorized(bucket, object, serverError):\n           XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n           XCTAssertEqual(object, file)\n           expectation.fulfill()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageAPITests.swift b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\nindex 02d6b06e557..0244d22f7be 100644\n--- a/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n@@ -158,6 +158,9 @@ final class StorageAPITests: XCTestCase {\n     case .downloadSizeExceeded: return code\n     case .cancelled: return code\n     case .invalidArgument: return code\n+    case .bucketMismatch: return code\n+    case .internalError: return code\n+    case .pathError: return code\n     @unknown default:\n       fatalError()\n     }\ndiff --git a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\nindex 52592be27c2..a711125d8c1 100644\n--- a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n@@ -181,7 +181,9 @@ class StorageGetMetadataTests: StorageTestHelpers {\n       fetcherService: fetcherService!.self,\n       queue: dispatchQueue!.self\n     ) { metadata, error in\n-      XCTAssertEqual((error as? NSError)!.code, StorageErrorCode.unknown.rawValue)\n+      XCTAssertNil(metadata)\n+      let nsError = try! XCTUnwrap(error as? NSError)\n+      XCTAssertEqual(nsError.code, StorageErrorCode.unknown.rawValue)\n       expectation.fulfill()\n     }\n     task.enqueue()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\nindex 56efb5cabf9..7854bedcf15 100644\n--- a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n@@ -72,7 +72,7 @@ class StorageReferenceTests: XCTestCase {\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bcket` does not match the Storage \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bcket` does not match the Storage \" +\n           \"bucket of the current instance: `bucket`\\\")\"\n       )\n     }\n@@ -95,8 +95,9 @@ class StorageReferenceTests: XCTestCase {\n   func testBadBucketScheme2() throws {\n     let url = try XCTUnwrap(URL(string: \"htttp://bucket/\"))\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n-      XCTAssertEqual(\"\\(error)\", \"pathError(\\\"Internal error: URL scheme must be one of gs://, \" +\n-        \"http://, or https://\\\")\")\n+      XCTAssertEqual(\"\\(error)\",\n+                     \"pathError(message: \\\"Internal error: URL scheme must be one of gs://, \" +\n+                       \"http://, or https://\\\")\")\n     }\n   }\n \n@@ -219,7 +220,7 @@ class StorageReferenceTests: XCTestCase {\n         XCTFail(\"Unexpected success.\", file: #file, line: #line)\n       case let .failure(error):\n         switch error {\n-        case let StorageError.unknown(message):\n+        case let StorageError.unknown(message, serverError):\n           let expectedDescription = \"File at URL: \\(dummyFileURL.absoluteString) \" +\n             \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n           XCTAssertEqual(expectedDescription, message)\ndiff --git a/FirebaseStorage/Tests/Unit/StorageTests.swift b/FirebaseStorage/Tests/Unit/StorageTests.swift\nindex ff605798ef8..bbc19194c62 100644\n--- a/FirebaseStorage/Tests/Unit/StorageTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageTests.swift\n@@ -45,7 +45,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n           \"Storage bucket of the current instance: `benwu-test1.storage.firebase.com`\\\")\"\n       )\n     }\n@@ -126,7 +126,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bucket` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bucket` does not match the \" +\n           \"Storage bucket of the current instance: `notMyBucket`\\\")\"\n       )\n     }\n", "test_patch": "", "problem_statement": "FirebaseStorage.StorageError provides limited information\n### Description\r\n\r\nOne of my TestFlight users consistently gets an error when using the FirebaseStorage API:\r\n`StorageReference.writeAsync()`\r\n\r\nLogging this error provides little insights since the localizedDescription is\r\n`The operation couldn\u2019t be completed. (FirebaseStorage.StorageError error 0.)`\r\n\r\nUnpacking the error case and logging the `.unknown(String)` produces\r\n`An unknown error occurred, please check the server response.`\r\n\r\nThe server response isn't on the error however since its lost when the Objective-C `NSError` is converted the Swift enum via `swiftConvert(objcError:)`.\r\n\r\nWould it be possible to instead make `StorageError` conform to [`CustomNSError`](https://developer.apple.com/documentation/foundation/customnserror) and expose the `userInfo` in Swift? Would love to debug this without rewriting a significant portion of my code in Objective-C.\r\n\r\n### Reproducing the issue\r\n\r\nTrying to figure this out myself.\r\n\r\n### Firebase SDK Version\r\n\r\n10.5.0\r\n\r\n### Xcode Version\r\n\r\n14.2\r\n\r\n### Installation Method\r\n\r\nSwift Package Manager\r\n\r\n### Firebase Product(s)\r\n\r\nStorage\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n```json\r\n{\r\n  \"pins\" : [\r\n    {\r\n      \"identity\" : \"abseil-cpp-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/abseil-cpp-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"583de9bd60f66b40e78d08599cc92036c2e7e4e1\",\r\n        \"version\" : \"0.20220203.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"boringssl-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/boringssl-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"dd3eda2b05a3f459fc3073695ad1b28659066eab\",\r\n        \"version\" : \"0.9.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"firebase-ios-sdk\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/firebase-ios-sdk\",\r\n      \"state\" : {\r\n        \"revision\" : \"f567ed9a2b30e29159df258049a9c662c517688e\",\r\n        \"version\" : \"10.5.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleappmeasurement\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleAppMeasurement.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"9a09ece724128e8d1e14c5133b87c0e236844ac0\",\r\n        \"version\" : \"10.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googledatatransport\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleDataTransport.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"f6b558e3f801f2cac336b04f615ce111fa9ddaa0\",\r\n        \"version\" : \"9.2.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleutilities\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleUtilities.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0543562f85620b5b7c510c6bcbef75b562a5127b\",\r\n        \"version\" : \"7.11.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"grpc-ios\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/grpc/grpc-ios.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"8440b914756e0d26d4f4d054a1c1581daedfc5b6\",\r\n        \"version\" : \"1.44.3-grpc\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"gtm-session-fetcher\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/gtm-session-fetcher.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"5ccda3981422a84186387dbb763ba739178b529c\",\r\n        \"version\" : \"2.3.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"leveldb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/leveldb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0706abcc6b0bd9cedfbb015ba840e4a780b5159b\",\r\n        \"version\" : \"1.22.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"mixpanel-swift\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/mixpanel/mixpanel-swift\",\r\n      \"state\" : {\r\n        \"branch\" : \"master\",\r\n        \"revision\" : \"dfc52c9155f2e42fb69f98a2370647d28d7eebe1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"nanopb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/nanopb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"819d0a2173aff699fb8c364b6fb906f7cdb1a692\",\r\n        \"version\" : \"2.30909.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"promises\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/promises.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"ec957ccddbcc710ccc64c9dcbd4c7006fcf8b73a\",\r\n        \"version\" : \"2.2.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"swift-protobuf\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/apple/swift-protobuf.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0af9125c4eae12a4973fb66574c53a54962a9e1e\",\r\n        \"version\" : \"1.21.0\"\r\n      }\r\n    }\r\n  ],\r\n  \"version\" : 2\r\n}\r\n```\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.\nThanks for the report. We'll take a look in the next few weeks. In the meantime, let us know if you find anything more - and we'd be interested in a PR.\nErrors from the server should actually be wrapped by `func error(withServerError serverError: NSError, ref: StorageReference)`.  if the error is not a server error, all the context should be in the Swift error. More examples and context in #10913.  If you're still blocked, we may need a reproducible example.\nSorry for the delayed response and thanks for adding a PR!\r\n\r\nSo the `Error` that is created via `error(withServerError:..` is actually great - it has all the info needed since it copies over the `userInfo` dictionary from the server `Error`. #10913 might actually not be necessary as all the info is carried over.\r\n\r\nThe loss in information comes when the wrapped `Error` is converted to the new `StorageError` in the `getResultCallback` method. I think a fix here would be to just not call `.swiftConvert(objcError:`. The case where there is no error in the callback can potentially leverage the new `StorageError` error type introduced.\r\n\r\nI was actually able to work around this quite easily (staying in an async Swift context) by just using the sync APIs and wrapping them with `withCheckedThrowingContinuation` myself. This threw the wrapped `error(withServerError` error as opposed to the `StorageError` and had all the info needed in my logging to debug.\r\n\r\nTL'DR\r\nServer Error -> Wrapped Error -> StorageError. \r\nThe first two are great - the third is missing info.\nThanks @jurgowski. I like the ideas of using `CustomNSError` and/or dropping `swiftConvert`. However, I'm not sure that can be done without breaking the ability to catch individual `StorageErrors` so it would be a breaking change. As a result, I've marked this for our next breaking change release.\r\n\r\nI agree that the `underlyingError` change isn't absolutely necessary but it should be non-breaking and provide the underlying server Error in a more standard way.\nI guess the main use case for `CustomNSError` is to make Swift errors easy to deal with in Obj-C code without custom bridging. It seems like in this case, the errors are coming from Obj-C and `StorageError` is a newly introduced error type (I didn't realize this when I first opened the issue). \r\n\r\nI agree that I don't think there is a way to make a change here that doesn't alter current behavior since `StorageError` is an enum.. However, I would expect that anyone catching `StorageError` is probably catching all errors generically. It may be possible to use the error directly in the failure case of the `Result` in `getResultCallback` (without converting it to `StorageError` via `swiftConvert`). As long as `StorageError` isn't deleted, things would still compile. \nSome WIP at https://github.com/firebase/firebase-ios-sdk/commit/3fae8e7ebc364985642a1000e89b2f663b5fc8ae", "created_at": "2024-06-11 22:45:42", "merge_commit_sha": "337d1efd54db7bc38c5ae9cbb034a5361a2d5221", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/storage.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm (iOS, macos-14)", ".github/workflows/storage.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["spm (tvOS, macos-14)", ".github/workflows/storage.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/storage.yml"], ["storage-integration-tests (ObjC)", ".github/workflows/storage.yml"], ["storage-cron-only", ".github/workflows/storage.yml"], ["spm (macOS, macos-14)", ".github/workflows/storage.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm (watchOS, macos-14)", ".github/workflows/storage.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/storage.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/storage.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm (macOS, macos-13)", ".github/workflows/storage.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13066", "base_commit": "594abb825043e6371f7336625d6ff5931b2a80b9", "patch": "diff --git a/CoreOnly/Tests/FirebasePodTest/Podfile b/CoreOnly/Tests/FirebasePodTest/Podfile\nindex d5c3822537b..5724b18b03a 100644\n--- a/CoreOnly/Tests/FirebasePodTest/Podfile\n+++ b/CoreOnly/Tests/FirebasePodTest/Podfile\n@@ -18,7 +18,6 @@ target 'FirebasePodTest' do\n   pod 'FirebaseDatabase', :path => '../../../'\n   pod 'FirebaseDynamicLinks', :path => '../../../'\n   pod 'FirebaseFirestore', :path => '../../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../../'\n   pod 'FirebaseFunctions', :path => '../../../'\n   pod 'FirebaseInAppMessaging', :path => '../../../'\n   pod 'FirebaseInstallations', :path => '../../../'\ndiff --git a/Firebase.podspec b/Firebase.podspec\nindex bb29fb049db..d464a2205ea 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -22,20 +22,20 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     \"CoreOnly/README.md\"\n   ]\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.cocoapods_version = '>= 1.12.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.default_subspec = 'Core'\n \n   s.subspec 'Core' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.ios.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.osx.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.tvos.dependency 'FirebaseAnalytics', '~> 11.0.0'\n@@ -55,30 +55,30 @@ Simplify your app development, grow your user base, and monetize more effectivel\n         'HEADER_SEARCH_PATHS' => \"$(inherited) ${PODS_ROOT}/Firebase/CoreOnly/Sources\"\n       }\n     end\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Analytics' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithoutAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'FirebaseAnalytics/WithoutAdIdSupport', '~> 11.0.0'\n     ss.dependency 'Firebase/CoreOnly'\n   end\n@@ -87,87 +87,87 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseABTesting', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'AppDistribution' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseAppDistribution', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'AppCheck' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAppCheck', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Auth' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAuth', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Crashlytics' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Database' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseDatabase', '~> 11.0.0'\n     # Standard platforms PLUS watchOS 7.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'DynamicLinks' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseDynamicLinks', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'Firestore' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFirestore', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Functions' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFunctions', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'InAppMessaging' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n     ss.tvos.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Installations' do |ss|\n@@ -179,48 +179,48 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMessaging', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'MLModelDownloader' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMLModelDownloader', '~> 11.0.0-beta'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Performance' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebasePerformance', '~> 11.0.0'\n     ss.tvos.dependency 'FirebasePerformance', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'RemoteConfig' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseRemoteConfig', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Storage' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseStorage', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n end\ndiff --git a/FirebaseABTesting.podspec b/FirebaseABTesting.podspec\nindex e8fe7414e45..6392dae0dc7 100644\n--- a/FirebaseABTesting.podspec\n+++ b/FirebaseABTesting.podspec\n@@ -22,10 +22,10 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -35,7 +35,7 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   base_dir = \"FirebaseABTesting/Sources/\"\n   s.source_files = [\ndiff --git a/FirebaseAnalytics.podspec b/FirebaseAnalytics.podspec\nindex 6467a9ef914..822a18a3b5a 100644\n--- a/FirebaseAnalytics.podspec\n+++ b/FirebaseAnalytics.podspec\n@@ -17,11 +17,11 @@ Pod::Spec.new do |s|\n     }\n \n     s.cocoapods_version = '>= 1.12.0'\n-    s.swift_version     = '5.3'\n+    s.swift_version     = '5.9'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/FirebaseAnalyticsOnDeviceConversion.podspec b/FirebaseAnalyticsOnDeviceConversion.podspec\nindex 2decdc2cac8..c8ccfe444c1 100644\n--- a/FirebaseAnalyticsOnDeviceConversion.podspec\n+++ b/FirebaseAnalyticsOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.static_framework = true\n \n-    s.ios.deployment_target = '10.0'\n+    s.ios.deployment_target = '12.0'\n \n     s.source_files = 'FirebaseAnalyticsOnDeviceConversionWrapper/*'\n end\ndiff --git a/FirebaseAppCheck.podspec b/FirebaseAppCheck.podspec\nindex b698de23452..e04fdfd976b 100644\n--- a/FirebaseAppCheck.podspec\n+++ b/FirebaseAppCheck.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAppCheckInterop.podspec b/FirebaseAppCheckInterop.podspec\nindex d8d372b4206..318feae1b1f 100644\n--- a/FirebaseAppCheckInterop.podspec\n+++ b/FirebaseAppCheckInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAppCheck/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAppCheck/Interop/Public/FirebaseAppCheckInterop/*.h'\ndiff --git a/FirebaseAppDistribution.podspec b/FirebaseAppDistribution.podspec\nindex 50135707816..fdfbd788c3c 100644\n--- a/FirebaseAppDistribution.podspec\n+++ b/FirebaseAppDistribution.podspec\n@@ -15,9 +15,9 @@ iOS SDK for App Distribution for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\nindex 2dc8abf4945..43b93570106 100644\n--- a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n+++ b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n@@ -23,12 +23,8 @@\n \n @implementation FIRAppDistributionUIService\n \n-API_AVAILABLE(ios(12.0))\n ASWebAuthenticationSession *_webAuthenticationVC;\n \n-// TODO: Remove this when the deployment target becomes iOS 12+\n-SFAuthenticationSession *_safariAuthenticationVC;\n-\n - (instancetype)init {\n   self = [super init];\n \n@@ -66,15 +62,8 @@ + (NSError *_Nullable)mapErrorToAppDistributionError:(NSError *_Nullable)error {\n   if (!error) {\n     return nil;\n   }\n-\n-  if (@available(iOS 12.0, *)) {\n-    if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n-  } else {\n-    if ([error code] == SFAuthenticationErrorCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n+  if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n+    return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n   }\n \n   return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationFailure];\n@@ -88,39 +77,24 @@ - (void)appDistributionRegistrationFlow:(NSURL *)URL\n   FIRFADInfoLog(@\"Registration URL: %@\", URL);\n   FIRFADInfoLog(@\"Callback URL: %@\", callbackURL);\n \n-  if (@available(iOS 12.0, *)) {\n-    ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    if (@available(iOS 13.0, *)) {\n-      authenticationVC.presentationContextProvider = self;\n-    }\n-\n-    _webAuthenticationVC = authenticationVC;\n+  ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n+            initWithURL:URL\n+      callbackURLScheme:callbackURL\n+      completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n+        [self resetUIState];\n+        [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n+        NSError *_Nullable appDistributionError =\n+            [[self class] mapErrorToAppDistributionError:error];\n+        completion(appDistributionError);\n+      }];\n \n-    [authenticationVC start];\n-  } else {\n-    _safariAuthenticationVC = [[SFAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[SFAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    [_safariAuthenticationVC start];\n+  if (@available(iOS 13.0, *)) {\n+    authenticationVC.presentationContextProvider = self;\n   }\n+\n+  _webAuthenticationVC = authenticationVC;\n+\n+  [authenticationVC start];\n }\n \n - (void)showUIAlert:(UIAlertController *)alertController {\n@@ -234,13 +208,7 @@ - (void)resetUIState {\n \n   self.registrationFlowCompletion = nil;\n \n-  if (@available(iOS 12.0, *)) {\n-    _webAuthenticationVC = nil;\n-  }\n-  // TODO: Remove this when the deployment target becomes iOS 12+\n-  // `_safariAuthenticationVC` is cleared unconditionally just in case;\n-  // It\u2019s supposed to be assigned only when run on iOS 11.\n-  _safariAuthenticationVC = nil;\n+  _webAuthenticationVC = nil;\n }\n \n - (void)safariViewControllerDidFinish:(SFSafariViewController *)controller {\ndiff --git a/FirebaseAuth.podspec b/FirebaseAuth.podspec\nindex 773fa9e5a21..2ce91b86c03 100644\n--- a/FirebaseAuth.podspec\n+++ b/FirebaseAuth.podspec\n@@ -24,7 +24,7 @@ supports email and password accounts, as well as several 3rd party authenticatio\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAuthInterop.podspec b/FirebaseAuthInterop.podspec\nindex f60eb9aa0be..2765250ac45 100644\n--- a/FirebaseAuthInterop.podspec\n+++ b/FirebaseAuthInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAuth/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAuth/Interop/Public/FirebaseAuthInterop/*.h'\ndiff --git a/FirebaseAuthTestingSupport.podspec b/FirebaseAuthTestingSupport.podspec\nindex f581d15d40e..3cf9b5128b5 100644\n--- a/FirebaseAuthTestingSupport.podspec\n+++ b/FirebaseAuthTestingSupport.podspec\n@@ -18,11 +18,11 @@ Pod::Spec.new do |s|\n   }\n \n   ios_deployment_target = '13.0'\n-  osx_deployment_target = '10.13'\n+  osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -39,7 +39,7 @@ Pod::Spec.new do |s|\n     base_dir + 'Sources/**/*.swift',\n   ]\n \n-  s.dependency 'FirebaseAuth', '~> 10.22'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n \n   s.test_spec 'unit' do |unit_tests|\n     unit_tests.scheme = { :code_coverage => true }\ndiff --git a/FirebaseCombineSwift.podspec b/FirebaseCombineSwift.podspec\nindex 6f5ad6bcfc9..1670e68b9d4 100644\n--- a/FirebaseCombineSwift.podspec\n+++ b/FirebaseCombineSwift.podspec\n@@ -1,6 +1,6 @@\n Pod::Spec.new do |s|\n   s.name             = 'FirebaseCombineSwift'\n-  s.version          = '10.0.0'\n+  s.version          = '11.0.0'\n   s.summary          = 'Swift extensions with Combine support for Firebase'\n \n   s.description      = <<-DESC\n@@ -19,12 +19,12 @@ for internal testing only. It should not be published.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  s.swift_version         = '5.3'\n+  s.swift_version       = '5.9'\n \n   ios_deployment_target = '13.0'\n   osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n-  watchos_deployment_target = '6.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -51,11 +51,11 @@ for internal testing only. It should not be published.\n   s.osx.framework = 'AppKit'\n   s.tvos.framework = 'UIKit'\n \n-  s.dependency 'FirebaseCore', '~> 10.0'\n-  s.dependency 'FirebaseAuth', '~> 10.0'\n-  s.dependency 'FirebaseFunctions', '~> 10.0'\n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n-  s.dependency 'FirebaseStorage', '~> 10.0'\n+  s.dependency 'FirebaseCore', '~> 11.0'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n+  s.dependency 'FirebaseFunctions', '~> 11.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n+  s.dependency 'FirebaseStorage', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'HEADER_SEARCH_PATHS' => '\"${PODS_TARGET_SRCROOT}\"',\n@@ -104,6 +104,6 @@ for internal testing only. It should not be published.\n     int_tests.resources = 'FirebaseStorage/Tests/Integration/Resources/1mb.dat',\n                           'FirebaseStorage/Tests/Integration/Resources/GoogleService-Info.plist',\n                           'FirebaseStorage/Tests/Integration/Resources/HomeImprovement.numbers'\n-    int_tests.dependency 'FirebaseAuth', '~> 10.0'\n+    int_tests.dependency 'FirebaseAuth', '~> 11.0'\n   end\n end\ndiff --git a/FirebaseCore.podspec b/FirebaseCore.podspec\nindex 9364d54bc8d..c740a159fa9 100644\n--- a/FirebaseCore.podspec\n+++ b/FirebaseCore.podspec\n@@ -18,10 +18,10 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -40,7 +40,7 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.public_header_files = 'FirebaseCore/Sources/Public/FirebaseCore/*.h'\n \ndiff --git a/FirebaseCore/CHANGELOG.md b/FirebaseCore/CHANGELOG.md\nindex 33f31986a49..be7014d50b1 100644\n--- a/FirebaseCore/CHANGELOG.md\n+++ b/FirebaseCore/CHANGELOG.md\n@@ -1,3 +1,14 @@\n+# Firebase 11.0.0\n+- [changed] **Breaking change**: Firebase's minimum supported versions have\n+  updated for the following platforms:\n+    - | Platform  | Firebase 11 |\n+      | ------------- | ------------- |\n+      | iOS  | **13.0**  |\n+      | tvOS  | **13.0**  |\n+      | macOS  | **10.15**  |\n+      | watchOS  | 7.0  |\n+  - FirebaseAnalytics and FirebaseCrashlytics also continue to support iOS 12.0.\n+\n # Firebase 10.25.0\n - [changed] Firebase now requires at least Xcode 15.2. See\n   https://developer.apple.com/news/?id=fxu2qp7b for more info.\ndiff --git a/FirebaseCoreExtension.podspec b/FirebaseCoreExtension.podspec\nindex 833ef4e5522..dfeecc3b2b4 100644\n--- a/FirebaseCoreExtension.podspec\n+++ b/FirebaseCoreExtension.podspec\n@@ -20,12 +20,12 @@ Pod::Spec.new do |s|\n     }\n     s.social_media_url = 'https://twitter.com/Firebase'\n \n-    s.swift_version = '5.3'\n+    s.swift_version = '5.9'\n \n-    s.ios.deployment_target = '10.0'\n-    s.osx.deployment_target = '10.13'\n-    s.tvos.deployment_target = '12.0'\n-    s.watchos.deployment_target = '6.0'\n+    s.ios.deployment_target = '12.0'\n+    s.osx.deployment_target = '10.15'\n+    s.tvos.deployment_target = '13.0'\n+    s.watchos.deployment_target = '7.0'\n \n     s.source_files = 'FirebaseCore/Extension/*.[hm]'\n     s.public_header_files = 'FirebaseCore/Extension/*.h'\ndiff --git a/FirebaseCoreInternal.podspec b/FirebaseCoreInternal.podspec\nindex a2dd33a0458..bd2ce688b2d 100644\n--- a/FirebaseCoreInternal.podspec\n+++ b/FirebaseCoreInternal.podspec\n@@ -18,10 +18,10 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -36,7 +36,7 @@ Pod::Spec.new do |s|\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Internal/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.dependency 'GoogleUtilities/NSData+zlib', '~> 8.0'\n \ndiff --git a/FirebaseCrashlytics.podspec b/FirebaseCrashlytics.podspec\nindex 365376a02ee..be080d77522 100644\n--- a/FirebaseCrashlytics.podspec\n+++ b/FirebaseCrashlytics.podspec\n@@ -11,12 +11,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabase.podspec b/FirebaseDatabase.podspec\nindex 71360409d13..6884a7a5539 100644\n--- a/FirebaseDatabase.podspec\n+++ b/FirebaseDatabase.podspec\n@@ -17,12 +17,12 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabaseSwift.podspec b/FirebaseDatabaseSwift.podspec\nindex 3e066ab7a0f..1701905ec67 100644\n--- a/FirebaseDatabaseSwift.podspec\n+++ b/FirebaseDatabaseSwift.podspec\n@@ -16,10 +16,10 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseDynamicLinks.podspec b/FirebaseDynamicLinks.podspec\nindex 08d3bcb940d..ad9606e0b76 100644\n--- a/FirebaseDynamicLinks.podspec\n+++ b/FirebaseDynamicLinks.podspec\n@@ -16,9 +16,9 @@ Firebase Dynamic Links are deep links that enhance user experience and increase\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestore.podspec b/FirebaseFirestore.podspec\nindex bd33677cd4a..8334d81e7e7 100644\n--- a/FirebaseFirestore.podspec\n+++ b/FirebaseFirestore.podspec\n@@ -13,11 +13,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.weak_framework = 'FirebaseFirestoreInternal'\n \ndiff --git a/FirebaseFirestoreInternal.podspec b/FirebaseFirestoreInternal.podspec\nindex bd3694dfda3..5e9288ad6c9 100644\n--- a/FirebaseFirestoreInternal.podspec\n+++ b/FirebaseFirestoreInternal.podspec\n@@ -16,11 +16,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestoreSwift.podspec b/FirebaseFirestoreSwift.podspec\nindex 4582f9f240f..511c8d1bff3 100644\n--- a/FirebaseFirestoreSwift.podspec\n+++ b/FirebaseFirestoreSwift.podspec\n@@ -21,10 +21,10 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseFirestoreTestingSupport.podspec b/FirebaseFirestoreTestingSupport.podspec\nindex c2c13ccb23e..a28ab450c3f 100644\n--- a/FirebaseFirestoreTestingSupport.podspec\n+++ b/FirebaseFirestoreTestingSupport.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -42,7 +42,7 @@ Pod::Spec.new do |s|\n \n   s.public_header_files = base_dir + '**/*.h'\n \n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'GCC_C_LANGUAGE_STANDARD' => 'c99',\ndiff --git a/FirebaseFunctions.podspec b/FirebaseFunctions.podspec\nindex 4383ae29317..2d069da346b 100644\n--- a/FirebaseFunctions.podspec\n+++ b/FirebaseFunctions.podspec\n@@ -16,12 +16,12 @@ Cloud Functions for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version    = '5.3'\n+  s.swift_version    = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -31,8 +31,6 @@ Cloud Functions for Firebase.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n-\n   s.source_files = [\n     'FirebaseFunctions/Sources/**/*.swift',\n   ]\ndiff --git a/FirebaseInAppMessaging.podspec b/FirebaseInAppMessaging.podspec\nindex 557b84d94ca..42eaf9ecb84 100644\n--- a/FirebaseInAppMessaging.podspec\n+++ b/FirebaseInAppMessaging.podspec\n@@ -17,10 +17,10 @@ See more product details at https://firebase.google.com/products/in-app-messagin\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\nindex ad7a95252aa..0e5b1ca8483 100644\n--- a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n+++ b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n@@ -160,15 +160,13 @@ - (void)viewDidLoad {\n   self.view.layer.shadowOpacity = 0.4;\n \n   // Calculate status bar height.\n-  CGFloat statusBarHeight = 0;\n-  if (@available(iOS 13.0, tvOS 13.0, *)) {\n-    UIStatusBarManager *manager =\n-        [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n-\n-    statusBarHeight = manager.statusBarFrame.size.height;\n-  } else {\n-    statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height;\n-  }\n+  // TODO(#13068) : Fix keyWindow deprecation.\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n+  UIStatusBarManager *manager =\n+      [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n+#pragma clang diagnostic pop\n+  CGFloat statusBarHeight = manager.statusBarFrame.size.height;\n \n   // Pin title label below status bar with cushion.\n   [[self.titleLabel.topAnchor constraintEqualToAnchor:self.view.topAnchor\ndiff --git a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\nindex ff1c70c111b..d7eac8d3b1e 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'FiamDisplaySwiftExample' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n end\n \ndiff --git a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\nindex 7597b44e9fc..50db2923845 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'InAppMessaging_Example_iOS' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n \n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n   pod 'FirebaseDynamicLinks',  :path => '../../../..'\ndiff --git a/FirebaseInstallations.podspec b/FirebaseInstallations.podspec\nindex 458e1654936..990dd505411 100644\n--- a/FirebaseInstallations.podspec\n+++ b/FirebaseInstallations.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader.podspec b/FirebaseMLModelDownloader.podspec\nindex 1118c479d1c..a45f5b93216 100644\n--- a/FirebaseMLModelDownloader.podspec\n+++ b/FirebaseMLModelDownloader.podspec\n@@ -16,12 +16,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader/Apps/Sample/Podfile b/FirebaseMLModelDownloader/Apps/Sample/Podfile\nindex 24d21a9d4de..cb632e9d85f 100644\n--- a/FirebaseMLModelDownloader/Apps/Sample/Podfile\n+++ b/FirebaseMLModelDownloader/Apps/Sample/Podfile\n@@ -1,4 +1,4 @@\n-platform :ios, '11.0'\n+platform :ios, '13.0'\n use_frameworks!\n \n source 'https://github.com/firebase/SpecsDev.git'\ndiff --git a/FirebaseMessaging.podspec b/FirebaseMessaging.podspec\nindex bbabbcdc201..0e056c8a17a 100644\n--- a/FirebaseMessaging.podspec\n+++ b/FirebaseMessaging.podspec\n@@ -20,12 +20,12 @@ device, and it is completely free.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMessagingInterop.podspec b/FirebaseMessagingInterop.podspec\nindex 31d03220e3c..3e7e1b6d8cb 100644\n--- a/FirebaseMessagingInterop.podspec\n+++ b/FirebaseMessagingInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseMessaging/Interop/*.[hm]'\n   s.public_header_files = 'FirebaseMessaging/Interop/*.h'\ndiff --git a/FirebasePerformance.podspec b/FirebasePerformance.podspec\nindex 9a0f48d3acf..6bcf58249df 100644\n--- a/FirebasePerformance.podspec\n+++ b/FirebasePerformance.podspec\n@@ -17,10 +17,10 @@ Firebase Performance library to measure performance of Mobile and Web Apps.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  tvos_deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.tvos.deployment_target = tvos_deployment_target\ndiff --git a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\nindex c5e04efc947..147b53c516a 100644\n--- a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n+++ b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n@@ -69,9 +69,12 @@ void InstrumentViewDidAppear(FPRUIViewControllerInstrument *instrument,\n \n     // This has to be called on the main thread and so it's done here instead of in\n     // FPRScreenTraceTracker.\n-    // TODO: Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n+    // TODO(#13067): Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n #if !defined(TARGET_OS_VISION) || !TARGET_OS_VISION\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     if ([((UIViewController *)_self).view isDescendantOfView:FPRSharedApplication().keyWindow]) {\n+#pragma clang diagnostic pop\n       [[FPRScreenTraceTracker sharedInstance] viewControllerDidAppear:_self];\n     }\n #endif\ndiff --git a/FirebaseRemoteConfig.podspec b/FirebaseRemoteConfig.podspec\nindex 6c81684decb..a69cdbed484 100644\n--- a/FirebaseRemoteConfig.podspec\n+++ b/FirebaseRemoteConfig.podspec\n@@ -18,12 +18,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseRemoteConfig/Tests/Sample/Podfile b/FirebaseRemoteConfig/Tests/Sample/Podfile\nindex bfff53e6fea..bdce061ec49 100644\n--- a/FirebaseRemoteConfig/Tests/Sample/Podfile\n+++ b/FirebaseRemoteConfig/Tests/Sample/Podfile\n@@ -1,5 +1,4 @@\n-# Uncomment the next line to define a global platform for your project\n-# platform :ios, '9.0'\n+platform :ios, '13.0'\n \n source 'https://github.com/firebase/SpecsDev.git'\n source 'https://github.com/firebase/SpecsStaging.git'\ndiff --git a/FirebaseRemoteConfigInterop.podspec b/FirebaseRemoteConfigInterop.podspec\nindex c9d9a9c30d8..6f9ea69cba2 100644\n--- a/FirebaseRemoteConfigInterop.podspec\n+++ b/FirebaseRemoteConfigInterop.podspec\n@@ -20,15 +20,17 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+\n+  # The ios deployment target must support Crashlytics.\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseRemoteConfig/Interop/*.swift'\n end\ndiff --git a/FirebaseRemoteConfigSwift.podspec b/FirebaseRemoteConfigSwift.podspec\nindex 3f0b3b3174e..7474d09616f 100644\n--- a/FirebaseRemoteConfigSwift.podspec\n+++ b/FirebaseRemoteConfigSwift.podspec\n@@ -19,12 +19,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSessions.podspec b/FirebaseSessions.podspec\nindex 6c282296e9a..8685d6c61af 100644\n--- a/FirebaseSessions.podspec\n+++ b/FirebaseSessions.podspec\n@@ -18,12 +18,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSharedSwift.podspec b/FirebaseSharedSwift.podspec\nindex 0b2ab17a71d..e0e8f4fec9c 100644\n--- a/FirebaseSharedSwift.podspec\n+++ b/FirebaseSharedSwift.podspec\n@@ -18,12 +18,12 @@ Firebase products. FirebaseSharedSwift is not supported for non-Firebase usage.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseStorage.podspec b/FirebaseStorage.podspec\nindex 5322597a81c..17729ae3d28 100644\n--- a/FirebaseStorage.podspec\n+++ b/FirebaseStorage.podspec\n@@ -27,7 +27,7 @@ Firebase Storage provides robust, secure file uploads and downloads from Firebas\n   s.tvos.deployment_target = tvos_deployment_target\n   s.watchos.deployment_target = watchos_deployment_target\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseVertexAI-Docs.not_podspec b/FirebaseVertexAI-Docs.not_podspec\nindex 7967cc616c4..4c447335f65 100644\n--- a/FirebaseVertexAI-Docs.not_podspec\n+++ b/FirebaseVertexAI-Docs.not_podspec\n@@ -34,7 +34,7 @@ Pod::Spec.new do |s|\n     'FirebaseVertexAI/Sources/**/*.swift',\n   ]\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.framework = 'Foundation'\n   s.ios.framework = 'UIKit'\ndiff --git a/Firestore/Example/GoogleBenchmark.podspec b/Firestore/Example/GoogleBenchmark.podspec\nindex ae7fc81cd98..c0024acced3 100644\n--- a/Firestore/Example/GoogleBenchmark.podspec\n+++ b/Firestore/Example/GoogleBenchmark.podspec\n@@ -33,9 +33,9 @@ Google's C++ benchmark framework.\n       :tag => 'v' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/GoogleTest.podspec b/Firestore/Example/GoogleTest.podspec\nindex 87788e99d8b..f7dd32cde06 100644\n--- a/Firestore/Example/GoogleTest.podspec\n+++ b/Firestore/Example/GoogleTest.podspec\n@@ -33,9 +33,9 @@ Google's C++ test framework.\n     :commit => 'bf66935e07825318ae519675d73d0f3e313b3ec6'\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/LibFuzzer.podspec b/Firestore/Example/LibFuzzer.podspec\nindex ea654f48fcc..c4b7b5f34a8 100644\n--- a/Firestore/Example/LibFuzzer.podspec\n+++ b/Firestore/Example/LibFuzzer.podspec\n@@ -28,9 +28,9 @@ Pod::Spec.new do |s|\n   s.license             = { :type => 'BSD-Like' }\n   s.authors             = 'LLVM Team'\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source              = {\n     :git => 'https://github.com/llvm/llvm-project.git'\ndiff --git a/Firestore/Example/Podfile b/Firestore/Example/Podfile\nindex 99bb2815390..c5417d9068d 100644\n--- a/Firestore/Example/Podfile\n+++ b/Firestore/Example/Podfile\n@@ -95,7 +95,7 @@ end\n \n if is_platform(:ios)\n   target 'Firestore_Example_iOS' do\n-    platform :ios, '11.0'\n+    platform :ios, '13.0'\n \n     configure_local_pods()\n \n@@ -120,7 +120,6 @@ if is_platform(:ios)\n     target 'Firestore_IntegrationTests_iOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -130,7 +129,7 @@ if is_platform(:ios)\n \n     target 'Firestore_FuzzTests_iOS' do\n       inherit! :search_paths\n-      platform :ios, '11.0'\n+      platform :ios, '13.0'\n \n       pod 'LibFuzzer', :podspec => 'LibFuzzer.podspec', :inhibit_warnings => true\n     end\n@@ -139,7 +138,7 @@ end\n \n if is_platform(:osx)\n   target 'Firestore_Example_macOS' do\n-    platform :osx, '10.13'\n+    platform :osx, '10.15'\n \n     configure_local_pods()\n \n@@ -158,7 +157,6 @@ if is_platform(:osx)\n     target 'Firestore_IntegrationTests_macOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -170,7 +168,7 @@ end\n \n if is_platform(:tvos)\n   target 'Firestore_Example_tvOS' do\n-    platform :tvos, '12.0'\n+    platform :tvos, '13.0'\n \n     configure_local_pods()\n \n@@ -189,7 +187,6 @@ if is_platform(:tvos)\n     target 'Firestore_IntegrationTests_tvOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\ndiff --git a/Firestore/Example/ProtobufCpp.podspec b/Firestore/Example/ProtobufCpp.podspec\nindex 956f9d3186c..7012de8d076 100644\n--- a/Firestore/Example/ProtobufCpp.podspec\n+++ b/Firestore/Example/ProtobufCpp.podspec\n@@ -29,9 +29,9 @@ Pod::Spec.new do |s|\n     :tag => \"v#{s.version}\"\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source_files = 'src/**/*.{h,cc,inc}',\n                    # utf8_range is needed too, to avoid build errors.\ndiff --git a/GoogleAppMeasurement.podspec b/GoogleAppMeasurement.podspec\nindex f893a310310..b69681f1520 100644\n--- a/GoogleAppMeasurement.podspec\n+++ b/GoogleAppMeasurement.podspec\n@@ -21,9 +21,9 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/GoogleAppMeasurementOnDeviceConversion.podspec b/GoogleAppMeasurementOnDeviceConversion.podspec\nindex a1810fb012c..0c816c4f9c4 100644\n--- a/GoogleAppMeasurementOnDeviceConversion.podspec\n+++ b/GoogleAppMeasurementOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n+    s.ios.deployment_target  = '12.0'\n \n     s.libraries  = 'c++'\n \ndiff --git a/IntegrationTesting/ClientApp/Podfile b/IntegrationTesting/ClientApp/Podfile\nindex e2abd6876dd..29810fab6ad 100644\n--- a/IntegrationTesting/ClientApp/Podfile\n+++ b/IntegrationTesting/ClientApp/Podfile\n@@ -3,7 +3,7 @@ source 'https://github.com/firebase/SpecsStaging.git'\n source 'https://cdn.cocoapods.org/'\n \n target 'ClientApp-CocoaPods' do\n-  platform :ios, '12.0'\n+  platform :ios, '13.0'\n \n   use_frameworks!\n \n@@ -24,7 +24,6 @@ target 'ClientApp-CocoaPods' do\n   pod 'FirebaseDatabaseSwift', :path => '../../'\n   pod 'FirebaseDynamicLinks', :path => '../../'\n   pod 'FirebaseFirestore', :path => '../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../'\n   pod 'FirebaseFunctions', :path => '../../'\n   pod 'FirebaseInAppMessaging', :path => '../../'\n   pod 'FirebaseMessaging', :path => '../../'\ndiff --git a/Package.swift b/Package.swift\nindex 3da098725da..87174d0fb70 100644\n--- a/Package.swift\n+++ b/Package.swift\n@@ -23,7 +23,7 @@ let firebaseVersion = \"11.0.0\"\n \n let package = Package(\n   name: \"Firebase\",\n-  platforms: [.iOS(.v12), .macCatalyst(.v13), .macOS(.v10_13), .tvOS(.v12), .watchOS(.v7)],\n+  platforms: [.iOS(.v12), .macCatalyst(.v15), .macOS(.v10_15), .tvOS(.v13), .watchOS(.v7)],\n   products: [\n     .library(\n       name: \"FirebaseAnalytics\",\n", "test_patch": "", "problem_statement": "Firebase 11 Minimum Supported version updates\n### Description\r\n\r\nIn order to address Xcode warnings for no longer supported build targets and increase the ability of Firebase to use modern Swift features, update most of Firebase to a minimum iOS version of 13 and comparable versions for other platforms.\r\n\r\nExceptions to consider:\r\n- Analytics and Crashlytics have historically needed to support older versions longer - proposing bumping to iOS 12, etc.\r\n- AppCheck may have a GoogleSignIn dependency in the future - proposing bumping to iOS 12, etc.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\n11.0\r\n\r\n### Xcode Version\r\n\r\n15.2+\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAll\r\n\r\n### Targeted Platforms\r\n\r\nAll\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "", "created_at": "2024-06-04 23:11:02", "merge_commit_sha": "7d7cbad7bda83297e51002577e7c5590b44accd7", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["messaging-cron-only", ".github/workflows/messaging.yml"], ["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/storage.yml"], ["spm (watchOS, macos-13)", ".github/workflows/abtesting.yml"], ["spm (iOS, macos-13)", ".github/workflows/auth.yml"], ["spm-unit (catalyst, macos-14)", ".github/workflows/functions.yml"], ["spm (catalyst, macos-13)", ".github/workflows/core.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/analytics.yml"], ["catalyst", ".github/workflows/auth.yml"], ["spm (macOS, macos-13)", ".github/workflows/storage.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, ios, macos-13)", ".github/workflows/firebase_app_check.yml"], ["sanitizers-mac (macos-14, tsan)", ".github/workflows/firestore.yml"], ["quickstart", ".github/workflows/database.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/performance.yml"], ["pod-lib-lint (FirebaseAuth.podspec, watchos, macos-14)", ".github/workflows/auth.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/core_internal.yml"], ["spm (macOS, macos-13)", ".github/workflows/shared-swift.yml"], ["quickstart", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-13)", ".github/workflows/storage.yml"], ["spm (macOS, macos-14)", ".github/workflows/installations.yml"], ["spm (iOS, macos-14)", ".github/workflows/core_internal.yml"], ["spm (watchOS, macos-13)", ".github/workflows/shared-swift.yml"], ["remoteconfig (iOS)", ".github/workflows/remoteconfig.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, tvos, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/installations.yml"], ["sample (build)", ".github/workflows/vertexai.yml"], ["quickstart", ".github/workflows/dynamiclinks.yml"], ["platforms (catalyst, macos-13)", ".github/workflows/spm.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["sample-build-test", ".github/workflows/remoteconfig.yml"], ["mlmodeldownloader-sample-build-test", ".github/workflows/mlmodeldownloader.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/performance.yml"], ["spm (watchOS, macos-13)", ".github/workflows/crashlytics.yml"], ["spm (macos-14, visionOS, Xcode_15.3, spm)", ".github/workflows/auth.yml"], ["spm (watchOS, macos-13)", ".github/workflows/sessions.yml"], ["spm-unit (macos-14, visionOS, Xcode_15.3)", ".github/workflows/functions.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/installations.yml"], ["swift-build-run (macos-14)", ".github/workflows/spm.yml"], ["spm (iOS, macos-13)", ".github/workflows/core_internal.yml"], ["messaging-integration-tests", ".github/workflows/messaging.yml"], ["spm (macos-14)", ".github/workflows/dynamiclinks.yml"], ["catalyst", ".github/workflows/core_internal.yml"], ["quickstart-ftl-cron-only", ".github/workflows/storage.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, macos --skip-tests, macos-13)", ".github/workflows/auth.yml"], ["spm (iOS, macos-14)", ".github/workflows/installations.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"], ["check-firestore-internal-public-headers", ".github/workflows/firestore.yml"], ["spm (catalyst, macos-14)", ".github/workflows/shared-swift.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/performance.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, ios, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"], ["spm (watchOS, macos-14)", ".github/workflows/installations.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/abtesting.yml"], ["spm (macOS, macos-14)", ".github/workflows/mlmodeldownloader.yml"], ["xcodebuild (iOS)", ".github/workflows/firestore.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos --skip-tests, macos-14)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (FirebaseAuth.podspec, watchos, macos-13)", ".github/workflows/auth.yml"], ["catalyst", ".github/workflows/installations.yml"], ["xcodebuild (tvOS)", ".github/workflows/firestore.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/core_extension.yml"], ["spm (macOS, macos-14)", ".github/workflows/core.yml"], ["auth-cron-only", ".github/workflows/auth.yml"], ["tests (iOS)", ".github/workflows/inappmessaging.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/mlmodeldownloader.yml"], ["spm (macos-13)", ".github/workflows/dynamiclinks.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, ios, macos-14)", ".github/workflows/auth.yml"], ["catalyst", ".github/workflows/appdistribution.yml"], ["remoteconfig-cron-only", ".github/workflows/remoteconfig.yml"], ["spm (tvOS, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/database.yml"], ["spm (iOS, macos-14)", ".github/workflows/mlmodeldownloader.yml"], ["platforms (tvOS, macos-14)", ".github/workflows/spm.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/functions.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/core.yml"], ["spm (macOS, macos-14)", ".github/workflows/storage.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/sessions.yml"], ["spm (macOS, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (macos --skip-tests, macos-13)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["spm-source (iOS, macos-13)", ".github/workflows/firestore.yml"], ["spm-source (tvOS, macos-13)", ".github/workflows/firestore.yml"], ["spm (iOS, macos-14)", ".github/workflows/core.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/abtesting.yml"], ["spm (macOS, macos-14)", ".github/workflows/shared-swift.yml"], ["client-app-spm-source-firestore (iOS, ClientApp-iOS13)", ".github/workflows/client_app.yml"], ["spm (tvOS, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/shared-swift.yml"], ["catalyst", ".github/workflows/mlmodeldownloader.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/abtesting.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/storage.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/database.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-13)", ".github/workflows/messaging.yml"], ["diff_report", ".github/workflows/api_diff_report.yml"], ["spm-unit (iOS, macos-13)", ".github/workflows/functions.yml"], ["pod-lib-lint-cron", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos, FirebaseRemoteConfig.podspec, macos-13)", ".github/workflows/remoteconfig.yml"], ["quickstart-ftl-cron-only", ".github/workflows/performance.yml"], ["spm (macOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/crashlytics.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/analytics.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/sessions.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm (iOS, macos-14)", ".github/workflows/storage.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/shared-swift.yml"], ["catalyst", ".github/workflows/core.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/abtesting.yml"], ["storage-integration-tests (ObjC)", ".github/workflows/storage.yml"], ["cmake (macos-14)", ".github/workflows/firestore.yml"], ["pod-lib-lint (ios, macos-14, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["spm-unit (iOS, macos-14)", ".github/workflows/functions.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/database.yml"], ["spm (catalyst, macos-13)", ".github/workflows/remoteconfig.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/functions.yml"], ["iOS-Device (macos-13)", ".github/workflows/spm.yml"], ["spm (catalyst, macos-14)", ".github/workflows/messaging.yml"], ["spm-integration (macos-14)", ".github/workflows/functions.yml"], ["spm (tvOS, macos-14)", ".github/workflows/database.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/crashlytics.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, macos --skip-tests, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/database.yml"], ["spm (watchOS, macos-14)", ".github/workflows/shared-swift.yml"], ["spm (iOS, macos-13)", ".github/workflows/storage.yml"], ["quickstart-ftl-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/sessions.yml"], ["pod-lib-lint (watchos --skip-tests, macos-13)", ".github/workflows/crashlytics.yml"], ["performance-cron-only", ".github/workflows/performance.yml"], ["spm (macOS, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/sessions.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/functions.yml"], ["spm (macOS, macos-13)", ".github/workflows/abtesting.yml"], ["platforms (macOS, macos-14)", ".github/workflows/spm.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/database.yml"], ["spm (tvOS, macos-13)", ".github/workflows/auth.yml"], ["pod-lib-lint (watchos --skip-tests, macos-13, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-14)", ".github/workflows/remoteconfig.yml"], ["spm (watchOS, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/crashlytics.yml"], ["changes", ".github/workflows/firestore.yml"], ["performance (iOS, proddev)", ".github/workflows/performance.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/sessions.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/shared-swift.yml"], ["integration", ".github/workflows/database.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["spm (catalyst, macos-13)", ".github/workflows/abtesting.yml"], ["spm-source (iOS, macos-14)", ".github/workflows/firestore.yml"], ["spm-unit (macOS, macos-14)", ".github/workflows/functions.yml"], ["crashlytics-cron-only", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/performance.yml"], ["spm (tvOS, macos-14)", ".github/workflows/auth.yml"], ["remoteconfig (macOS)", ".github/workflows/remoteconfig.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, watchos, macos-13)", ".github/workflows/auth.yml"], ["spm (macOS, macos-13)", ".github/workflows/database.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, watchos, macos-14)", ".github/workflows/firebase_app_check.yml"], ["spm (macOS, macos-13)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-14)", ".github/workflows/firebase_app_check.yml"], ["spm (watchOS, macos-13)", ".github/workflows/database.yml"], ["spm (macOS, macos-13)", ".github/workflows/sessions.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["spm (catalyst, macos-14)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/installations.yml"], ["spm (macOS, macos-14)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-13)", ".github/workflows/shared-swift.yml"], ["quickstart-ftl-cron-only", ".github/workflows/abtesting.yml"], ["spm (macOS, macos-13)", ".github/workflows/vertexai.yml"], ["spm (tvOS, macos-13)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (tvos, macos-14, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["spm (catalyst, macos-13)", ".github/workflows/crashlytics.yml"], ["spm-source (macos-14, visionOS, Xcode_15.3)", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos --skip-tests, macos-14)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-13)", ".github/workflows/sessions.yml"], ["core-cron-only", ".github/workflows/core.yml"], ["pod-lib-lint (FirebaseAuth.podspec, macos --skip-tests, macos-14)", ".github/workflows/auth.yml"], ["pod-lib-lint (ios, macos-13, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["database-cron-only", ".github/workflows/database.yml"], ["quickstart", ".github/workflows/auth.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/core_internal.yml"], ["spm (catalyst, macos-13)", ".github/workflows/vertexai.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/messaging.yml"], ["spm (macOS, macos-14)", ".github/workflows/remoteconfig.yml"], ["spm (tvOS, macos-14)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/core_internal.yml"], ["messaging-swiftui-sample-build-test", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-14)", ".github/workflows/database.yml"], ["danger", ".github/workflows/danger.yml"], ["spm (iOS, macos-14)", ".github/workflows/messaging.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["spm (tvOS, macos-13)", ".github/workflows/installations.yml"], ["pod-lib-lint (FirebaseAuth.podspec, macos --skip-tests, macos-13)", ".github/workflows/auth.yml"], ["dynamiclinks-cron-only", ".github/workflows/dynamiclinks.yml"], ["spm (watchOS, macos-13)", ".github/workflows/auth.yml"], ["spm (catalyst, macos-14)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-14)", ".github/workflows/sessions.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/core_extension.yml"], ["spm (watchOS, macos-14)", ".github/workflows/messaging.yml"], ["spm (iOS, macos-13)", ".github/workflows/installations.yml"], ["quickstart-ftl-cron-only", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-14)", ".github/workflows/messaging.yml"], ["spm (iOS)", ".github/workflows/performance.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/core_internal.yml"], ["platforms (catalyst, macos-14)", ".github/workflows/spm.yml"], ["quickstart", ".github/workflows/inappmessaging.yml"], ["xcodebuild (macOS)", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/mlmodeldownloader.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/installations.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/appdistribution.yml"], ["quickstart-ftl-cron-only", ".github/workflows/dynamiclinks.yml"], ["installation-test", ".github/workflows/firebasepod.yml"], ["appdistribution-cron-only", ".github/workflows/appdistribution.yml"], ["spm (iOS, macos-14)", ".github/workflows/remoteconfig.yml"], ["spm (macOS, macos-14)", ".github/workflows/firebase_app_check.yml"], ["spm (tvOS, macos-14)", ".github/workflows/installations.yml"], ["functions-cron-only", ".github/workflows/functions.yml"], ["platforms (tvOS, macos-13)", ".github/workflows/spm.yml"], ["spm (macOS, macos-14)", ".github/workflows/abtesting.yml"], ["pod_lib_lint (FirebaseAppCheckInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, watchos, macos-14)", ".github/workflows/auth.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/mlmodeldownloader.yml"], ["spm (watchOS, macos-14)", ".github/workflows/remoteconfig.yml"], ["quickstart (swift, macos-14, Xcode_15.3)", ".github/workflows/storage.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/core.yml"], ["pod-lib-lint (FirebaseFirestoreInternal.podspec)", ".github/workflows/firestore.yml"], ["spm (tvOS)", ".github/workflows/performance.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/core_extension.yml"], ["spm (catalyst, macos-14)", ".github/workflows/auth.yml"], ["pod_lib_lint (FirebaseInAppMessaging.podspec, macos-14)", ".github/workflows/inappmessaging.yml"], ["cmake-prod-db (macos-14, test-db)", ".github/workflows/firestore.yml"], ["spm (macOS, macos-13)", ".github/workflows/core_internal.yml"], ["client-app-cocoapods (ClientApp-CocoaPods-iOS13)", ".github/workflows/client_app.yml"], ["pod-lib-lint (macos --skip-tests, macos-14)", ".github/workflows/database.yml"], ["pod-lib-lint (FirebaseAuth.podspec, tvos, macos-14)", ".github/workflows/auth.yml"], ["spm (watchOS, macos-13)", ".github/workflows/core_internal.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13065", "base_commit": "594abb825043e6371f7336625d6ff5931b2a80b9", "patch": "diff --git a/FirebaseRemoteConfig/CHANGELOG.md b/FirebaseRemoteConfig/CHANGELOG.md\nindex 2a3024918c8..ff8a8a72050 100644\n--- a/FirebaseRemoteConfig/CHANGELOG.md\n+++ b/FirebaseRemoteConfig/CHANGELOG.md\n@@ -1,4 +1,7 @@\n-# 10.25.0\n+# 11.0.0\n+- [fixed] RemoteConfigValue stringValue is now `nonnull`. This may break some builds. (#10870)\n+\n+  # 10.25.0\n - [fixed] Fixed bug preventing Remote Config from working with a custom sqlite3\n   dependency (#10884).\n \ndiff --git a/FirebaseRemoteConfig/Sources/FIRConfigValue.m b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\nindex 8ab2d30d77a..e68d9c1312d 100644\n--- a/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n+++ b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n@@ -41,8 +41,8 @@ - (instancetype)init {\n }\n \n /// The string is a UTF-8 representation of NSData.\n-- (NSString *)stringValue {\n-  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding];\n+- (nonnull NSString *)stringValue {\n+  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding] ?: @\"\";\n }\n \n /// Number representation of a UTF-8 string.\ndiff --git a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\nindex 29cd12a5143..0a45617545f 100644\n--- a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n+++ b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n@@ -138,7 +138,7 @@ typedef void (^FIRRemoteConfigFetchAndActivateCompletion)(\n NS_SWIFT_NAME(RemoteConfigValue)\n @interface FIRRemoteConfigValue : NSObject <NSCopying>\n /// Gets the value as a string.\n-@property(nonatomic, readonly, nullable) NSString *stringValue;\n+@property(nonatomic, readonly, nonnull) NSString *stringValue;\n /// Gets the value as a number value.\n @property(nonatomic, readonly, nonnull) NSNumber *numberValue;\n /// Gets the value as a NSData object.\ndiff --git a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\nindex d0cea378995..f2d56542760 100644\n--- a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n+++ b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n@@ -35,7 +35,7 @@ struct FirebaseRemoteConfigValueDecoderHelper: FirebaseRemoteConfigValueDecoding\n   }\n \n   func stringValue() -> String {\n-    return value.stringValue ?? \"\"\n+    return value.stringValue\n   }\n \n   func dataValue() -> Data {\ndiff --git a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\nindex 7bf81c97a37..6665dd91258 100644\n--- a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n+++ b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n@@ -188,12 +188,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n@@ -204,13 +199,7 @@ class APITests: APITestBase {\n     let expectation2 = self.expectation(description: #function + \"2\")\n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.yoda)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n-\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.yoda)\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -239,13 +228,10 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.sith).stringValue {\n-        XCTAssertEqual(configValue, Constants.darthSidious)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.sith)\")\n-      }\n-\n+      XCTAssertEqual(\n+        self.config.configValue(forKey: Constants.sith).stringValue,\n+        Constants.darthSidious\n+      )\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -258,12 +244,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n", "test_patch": "", "problem_statement": "FIRRemoteConfigValue.stringValue is not nullable\n### Description\r\n\r\nFIRRemoteConfigValue.stringValue is marked `nullable` in the header file but will never return `null` as the implement.\r\nhttps://github.com/firebase/firebase-ios-sdk/blob/60f9a33e7084482df67b48e16f315f4f7a6f5da9/FirebaseRemoteConfig/Sources/FIRConfigValue.m#L43-L46\r\nIt would be thankful to implement it as `nullable`, before that marking it `nonnull` would be enough.\r\n\r\n### Firebase SDK Version\r\n\r\n9.6.0\r\n\r\n### Xcode Version\r\n\r\n14.1\r\n\r\n### Installation Method\r\n\r\nCocoaPods\r\n\r\n### Firebase Product(s)\r\n\r\nRemote Config\r\n\r\n### Targeted Platforms\r\n\r\niOS\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.\nHi @myihsan,\r\n\r\nThanks for opening an issue. Just so I understand the issue correctly, is the issue that the implementation's return type does not have the `nullable` attribute?\r\n\r\nSo something like the below diff would resolve things:\r\n```diff\r\n- - (NSString *)stringValue { \r\n+ - (nullable NSString *)stringValue { \r\n```\nHi @ncooke3,\r\n\r\nThanks for the confirmation.\r\nIf I understand the implementation correctly, adding the `nullable` attribute will not solve the issue since it's already `nullable` in the header file.\r\nhttps://github.com/firebase/firebase-ios-sdk/blob/60f9a33e7084482df67b48e16f315f4f7a6f5da9/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h#L110\r\n\r\n\r\nI expected it to be solved like the below:\r\n```objc\r\n- (NSString *)stringValue {\r\n  // if `_data` is nil or empty return nil.\r\n  if (!_data) {\r\n    return nil;\r\n  }\r\n  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding];\r\n}\r\n```\r\n\r\nBut it will affect `numberValue` and `boolValue`, so it may need some discussion before changing them to`nullable`.\r\n\r\nBefore that, marking `stringValue` `nonnull` would be enough for me.\r\n\r\n```diff\r\n- @property(nonatomic, readonly, nullable) NSString *stringValue;\r\n+ @property(nonatomic, readonly, nonnull) NSString *stringValue;\r\n```\nI think what is going on here is that Apple's documentation is misleading. Based on [this discussion section](https://developer.apple.com/documentation/foundation/nsstring/1416374-initwithdata#:~:text=Returns%20nil%20if%20the%20initialization%20fails%20for%20some%20reason%20(for%20example%20if%20data%20does%20not%20represent%20valid%20data%20for%20encoding).) and that [Swift equivalent returns `String?`](https://developer.apple.com/documentation/foundation/nsstring/1416374-init), I think `- [NSString initWithData:encoding:]` returns a nullable string, despite it's interface saying it doesn't. \n>  I think - [NSString initWithData:encoding:] returns a nullable string\r\n\r\nYou are right and [the return value section](https://developer.apple.com/documentation/foundation/nsstring/1416374-initwithdata#return_value) mentioned that.\r\n\r\n> Returns nil if the initialization fails for some reason (for example if data does not represent valid data for encoding).\r\n\r\nHowever, it will not return nil in the cases below:\r\n- `[[NSString alloc] initWithData:[[NSData alloc] init] encoding:NSUTF8StringEncoding]`\r\n- `[[NSString alloc] initWithData:nil encoding:NSUTF8StringEncoding]`\r\n\r\nYou can verify this behavior by:\r\n\r\n```objc\r\nNSLog(@\"%@\", [[NSString alloc] initWithData:[[NSData alloc] init] encoding:NSUTF8StringEncoding] == nil ? @\"True\" : @\"False\");\r\nNSLog(@\"%@\", [[NSString alloc] initWithData:nil encoding:NSUTF8StringEncoding] == nil ? @\"True\" : @\"False\");\r\n```\nThanks @myihsan, that's interesting. Sorry, so what exactly is the issue with the current behavior? Is it that you expected `- [FIRRemoteConfigValue stringValue]` to return `nil` when `_data` is `nil`?\nYes or no since I am unsure when `_data` became `nil`.\r\nI expected `- [FIRRemoteConfigValue stringValue]` to return `nil` when no related config is set.\r\n\r\nI want to distinguish the situations below:\r\n- nil (there is no related config set)\r\n- empty (there is a related config, but the value is empty)\n@ncooke3 \r\nI tried to solve this issue [here](https://github.com/firebase/firebase-ios-sdk/compare/master...myihsan:fix/FIRRemoteConfigValue-stringValue-nullable), but I realised that this will at least make dataValue `nullable` and this is an API change.\r\nShould I open another issue focusing on distinguishing the config is set as empty or not set at all.\nWhile we may progress earlier, I'll mark this as Firebase 11 to make sure we consider before our next breaking change release.", "created_at": "2024-06-04 22:04:01", "merge_commit_sha": "059b9211229c2e4c422bebb457f9421ae1a5c98a", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["pod-lib-lint (tvos, FirebaseRemoteConfig.podspec, macos-14)", ".github/workflows/remoteconfig.yml"], ["remoteconfig-cron-only", ".github/workflows/remoteconfig.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["spm (tvOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["sample-build-test", ".github/workflows/remoteconfig.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["spm (catalyst, macos-14)", ".github/workflows/remoteconfig.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["spm (watchOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["spm (macos-14, visionOS, Xcode_15.3, spm)", ".github/workflows/remoteconfig.yml"], ["spm (iOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["changes", ".github/workflows/firestore.yml"], ["catalyst", ".github/workflows/remoteconfig.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos --skip-tests, FirebaseRemoteConfig.podspec, macos-13)", ".github/workflows/remoteconfig.yml"], ["spm (catalyst, macos-13)", ".github/workflows/remoteconfig.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13064", "base_commit": "8136158f103c1584e0e0bcf482926d5cac63ba65", "patch": "diff --git a/FirebaseMessaging/Sources/FIRMessaging.m b/FirebaseMessaging/Sources/FIRMessaging.m\nindex 9511d34a29e..9a688b034be 100644\n--- a/FirebaseMessaging/Sources/FIRMessaging.m\n+++ b/FirebaseMessaging/Sources/FIRMessaging.m\n@@ -437,9 +437,7 @@ - (void)handleIncomingLinkIfNeededFromMessage:(NSDictionary *)message {\n     // Similarly, |application:openURL:sourceApplication:annotation:| will also always be called,\n     // due to the default swizzling done by FIRAAppDelegateProxy in Firebase Analytics\n   } else if ([appDelegate respondsToSelector:openURLWithSourceApplicationSelector]) {\n-// TODO(Xcode 15): When Xcode 15 is the minimum supported Xcode version, it will be unnecessary to\n-// check if `TARGET_OS_VISION` is defined.\n-#if TARGET_OS_IOS && (!defined(TARGET_OS_VISION) || !TARGET_OS_VISION)\n+#if TARGET_OS_IOS\n #pragma clang diagnostic push\n #pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     [appDelegate application:application\ndiff --git a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\nindex 52c5ff0f82d..5cd5d8b16a2 100644\n--- a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n+++ b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n@@ -384,13 +384,6 @@ id FIRMessagingPropertyNameFromObject(id object, NSString *propertyName, Class k\n }\n \n #pragma mark - GULApplicationDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  [[FIRMessaging messaging] appDidReceiveMessage:userInfo];\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\nindex 6bf33f9b5d6..ea061e8a284 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n@@ -75,10 +75,12 @@ + (BOOL)supportsSecureCoding {\n }\n \n - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n-  id deviceToken = [aDecoder decodeObjectForKey:kFIRInstanceIDAPNSInfoTokenKey];\n-  if (![deviceToken isKindOfClass:[NSData class]]) {\n+  NSData *deviceToken = [aDecoder decodeObjectOfClass:[NSData class]\n+                                               forKey:kFIRInstanceIDAPNSInfoTokenKey];\n+  if (!deviceToken) {\n     return nil;\n   }\n+\n   BOOL isSandbox = [aDecoder decodeBoolForKey:kFIRInstanceIDAPNSInfoSandboxKey];\n   return [self initWithDeviceToken:(NSData *)deviceToken isSandbox:isSandbox];\n }\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\nindex 90420d1e72e..2852f0cad69 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n@@ -143,32 +143,29 @@ - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n   BOOL needsMigration = NO;\n   // These value cannot be nil\n \n-  id authorizedEntity = [aDecoder decodeObjectForKey:kFIRInstanceIDAuthorizedEntityKey];\n-  if (![authorizedEntity isKindOfClass:[NSString class]]) {\n+  NSString *authorizedEntity = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                      forKey:kFIRInstanceIDAuthorizedEntityKey];\n+  if (!authorizedEntity) {\n     return nil;\n   }\n \n-  id scope = [aDecoder decodeObjectForKey:kFIRInstanceIDScopeKey];\n-  if (![scope isKindOfClass:[NSString class]]) {\n+  NSString *scope = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDScopeKey];\n+  if (!scope) {\n     return nil;\n   }\n \n-  id token = [aDecoder decodeObjectForKey:kFIRInstanceIDTokenKey];\n-  if (![token isKindOfClass:[NSString class]]) {\n+  NSString *token = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDTokenKey];\n+  if (!token) {\n     return nil;\n   }\n \n-  // These values are nullable, so only fail the decode if the type does not match\n+  // These values are nullable, so don't fail on nil.\n \n-  id appVersion = [aDecoder decodeObjectForKey:kFIRInstanceIDAppVersionKey];\n-  if (appVersion && ![appVersion isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n+  NSString *appVersion = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                forKey:kFIRInstanceIDAppVersionKey];\n+  NSString *firebaseAppID = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                   forKey:kFIRInstanceIDFirebaseAppIDKey];\n \n-  id firebaseAppID = [aDecoder decodeObjectForKey:kFIRInstanceIDFirebaseAppIDKey];\n-  if (firebaseAppID && ![firebaseAppID isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n   NSSet *classes = [[NSSet alloc] initWithArray:@[ FIRMessagingAPNSInfo.class ]];\n   FIRMessagingAPNSInfo *rawAPNSInfo = [aDecoder decodeObjectOfClasses:classes\n                                                                forKey:kFIRInstanceIDAPNSInfoKey];\ndiff --git a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\nindex d3bbdc3ead3..16f7086f1d3 100644\n--- a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n+++ b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n@@ -64,19 +64,13 @@ @interface FakeAppDelegate : NSObject <GULApplicationDelegate>\n @property(nonatomic, strong) NSError *registerForRemoteNotificationsError;\n @end\n @implementation FakeAppDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  self.remoteNotificationMethodWasCalled = YES;\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\n     didReceiveRemoteNotification:(NSDictionary *)userInfo\n           fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler {\n   self.remoteNotificationWithFetchHandlerWasCalled = YES;\n+  completionHandler(UIBackgroundFetchResultNewData);\n }\n #endif\n \n@@ -192,6 +186,7 @@ - (void)testSwizzlingNonAppDelegate {\n #if !SWIFT_PACKAGE\n // The next 3 tests depend on a sharedApplication which is not available in the Swift PM test env.\n - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n+  XCTestExpectation *expectation = [self expectationWithDescription:@\"completion\"];\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n   [self.proxy swizzleMethodsIfPossible];\n@@ -199,15 +194,18 @@ - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n   NSDictionary *notification = @{@\"test\" : @\"\"};\n   OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n \n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n   [incompleteAppDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-        didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n+        didReceiveRemoteNotification:notification\n+              fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+                [expectation fulfill];\n+              }];\n \n   [self.mockMessaging verify];\n+  [self waitForExpectationsWithTimeout:0.5 handler:nil];\n }\n \n+// This test demonstrates the difference between Firebase 10 and 11. In 10 and earlier the\n+// swizzler inserts the old `didReceiveRemoteNotification` method. In 11, the new.\n - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n@@ -216,11 +214,11 @@ - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n #if TARGET_OS_IOS || TARGET_OS_TV\n   SEL remoteNotificationWithFetchHandler = @selector(application:\n                                     didReceiveRemoteNotification:fetchCompletionHandler:);\n-  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n+  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n #endif\n \n   SEL remoteNotification = @selector(application:didReceiveRemoteNotification:);\n-  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotification]);\n+  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotification]);\n }\n \n - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n@@ -230,21 +228,6 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   NSDictionary *notification = @{@\"test\" : @\"\"};\n \n-  // Test application:didReceiveRemoteNotification:\n-\n-  // Verify our swizzled method was called\n-  OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n-\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-  [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-      didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n-\n-  // Verify our original method was called\n-  XCTAssertTrue(appDelegate.remoteNotificationMethodWasCalled);\n-  [self.mockMessaging verify];\n-\n   // Test application:didReceiveRemoteNotification:fetchCompletionHandler:\n #if TARGET_OS_IOS || TARGET_OS_TV\n   // Verify our swizzled method was called\n@@ -252,7 +235,8 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n       didReceiveRemoteNotification:notification\n-            fetchCompletionHandler:^(UIBackgroundFetchResult result){\n+            fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+              XCTAssertEqual(result, UIBackgroundFetchResultNewData);\n             }];\n \n   // Verify our original method was called\n", "test_patch": "", "problem_statement": "Cleanup deprecated notification API usages in Firebase\n### Description\r\n\r\nFirebase has multiple usages of the deprecated ` (void)application:(UIApplication *)application\r\n\u00a0 \u00a0 didReceiveRemoteNotification:(NSDictionary *)userInfo\u00a0` API. \r\n\r\nIt's usages should be removed across Firebase and GoogleUtilities.\r\n\r\nIn addition, GoogleUtilities should stop conditionalizing the swizzling of the replacement API: https://github.com/google/GoogleUtilities/blame/main/GoogleUtilities/AppDelegateSwizzler/GULAppDelegateSwizzler.m#L520\r\n\r\nAuth part of this is done in #13003 \r\nGoogleUtilities in https://github.com/google/GoogleUtilities/pull/162\r\nFirebaseMessging and CocoaPods updates still need to be done.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\nAll\r\n\r\n### Xcode Version\r\n\r\n14.3\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAuthentication\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "", "created_at": "2024-06-04 21:10:26", "merge_commit_sha": "594abb825043e6371f7336625d6ff5931b2a80b9", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["messaging-cron-only", ".github/workflows/messaging.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["messaging-swiftui-sample-build-test", ".github/workflows/messaging.yml"], ["danger", ".github/workflows/danger.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm (iOS, macos-14)", ".github/workflows/messaging.yml"], ["spm (tvOS, macos-14)", ".github/workflows/messaging.yml"], ["messaging-watchos-standalone-sample-build-test", ".github/workflows/messaging.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["spm (macOS, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, macos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm (watchOS, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-14)", ".github/workflows/messaging.yml"], ["spm (macOS, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-13)", ".github/workflows/messaging.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-12790", "base_commit": "09ed7125aef062192212cef3bcf1dfad2cf604c5", "patch": "diff --git a/.github/workflows/archiving.yml b/.github/workflows/archiving.yml\nindex 0d8a7eeddcf..8d60f6785b4 100644\n--- a/.github/workflows/archiving.yml\n+++ b/.github/workflows/archiving.yml\n@@ -46,29 +46,7 @@ jobs:\n       matrix:\n         target: [ios, tvos, macos]\n         # These need to be on a single line or else the formatting won't validate.\n-        pod: [\"FirebaseABTesting\", \"FirebaseAuth\", \"FirebaseCore\", \"FirebaseCrashlytics\", \"FirebaseDatabase\", \"FirebaseFunctions\", \"FirebaseMessaging\", \"FirebaseRemoteConfig\", \"FirebaseStorage\"]\n-    steps:\n-    - uses: actions/checkout@v4\n-    - uses: mikehardy/buildcache-action@c87cea0ccd718971d6cc39e672c4f26815b6c126\n-      with:\n-        cache_key: pods-${{ matrix.os }}\n-    - uses: ruby/setup-ruby@v1\n-    - name: Setup Bundler\n-      run: scripts/setup_bundler.sh\n-    - name: Setup project and archive\n-      run: scripts/test_archiving.sh ${{ matrix.pod }} ${{ matrix.target }} ArchiveOutputs/${{ matrix.target }}.xcarchive\n-\n-  # TODO(#12780: Merge Firestore back into above job after https://github.com/grpc/grpc/pull/36340\n-  pods-ios-tvos-macos-cron-macos12:\n-    # Don't run on private repo.\n-    if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule')\n-\n-    runs-on: macos-12\n-    strategy:\n-      matrix:\n-        target: [ios, tvos, macos]\n-        # These need to be on a single line or else the formatting won't validate.\n-        pod: [\"FirebaseFirestore\"]\n+        pod: [\"FirebaseABTesting\", \"FirebaseAuth\", \"FirebaseCore\", \"FirebaseCrashlytics\", \"FirebaseDatabase\", \"FirebaseFirestore\", \"FirebaseFunctions\", \"FirebaseMessaging\", \"FirebaseRemoteConfig\", \"FirebaseStorage\"]\n     steps:\n     - uses: actions/checkout@v4\n     - uses: mikehardy/buildcache-action@c87cea0ccd718971d6cc39e672c4f26815b6c126\ndiff --git a/.github/workflows/firestore.yml b/.github/workflows/firestore.yml\nindex f4641697a1b..ccf74fc36cb 100644\n--- a/.github/workflows/firestore.yml\n+++ b/.github/workflows/firestore.yml\n@@ -326,8 +326,7 @@ jobs:\n     if: |\n       (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') ||\n       (github.event_name == 'pull_request' && needs.changes.outputs.changed == 'true')\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     needs: check\n \n     strategy:\ndiff --git a/.github/workflows/prerelease.yml b/.github/workflows/prerelease.yml\nindex 296fd1c554f..6453cc4960a 100644\n--- a/.github/workflows/prerelease.yml\n+++ b/.github/workflows/prerelease.yml\n@@ -17,8 +17,7 @@ jobs:\n   specs_checking:\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     env:\n       bot_token_secret: ${{ secrets.GHASecretsGPGPassphrase1 }}\n       # The SDK repo will be cloned to this dir and podspecs from\n@@ -112,8 +111,7 @@ jobs:\n     needs: [buildup_SpecsTesting_repo_FirebaseCore, specs_checking]\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     strategy:\n       fail-fast: false\n       matrix: ${{fromJson(needs.specs_checking.outputs.matrix)}}\ndiff --git a/.github/workflows/release.yml b/.github/workflows/release.yml\nindex 500cc2e82eb..0604a1de1d9 100644\n--- a/.github/workflows/release.yml\n+++ b/.github/workflows/release.yml\n@@ -19,8 +19,7 @@ jobs:\n   specs_checking:\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     env:\n       bot_token_secret: ${{ secrets.GHASecretsGPGPassphrase1 }}\n       # The SDK repo will be cloned to this dir and podspecs from\n@@ -114,8 +113,7 @@ jobs:\n     needs: [buildup_SpecsTesting_repo_FirebaseCore, specs_checking]\n     # Don't run on private repo unless it is a PR.\n     if: github.repository == 'Firebase/firebase-ios-sdk'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     strategy:\n       fail-fast: false\n       matrix: ${{fromJson(needs.specs_checking.outputs.matrix)}}\n", "test_patch": "diff --git a/.github/workflows/spectesting.yml b/.github/workflows/spectesting.yml\nindex 52891d51ac8..97cf1bb4dcb 100644\n--- a/.github/workflows/spectesting.yml\n+++ b/.github/workflows/spectesting.yml\n@@ -44,8 +44,7 @@ jobs:\n   specs_testing:\n     needs: specs_checking\n     if: ${{ needs.specs_checking.outputs.podspecs != '[]' }}\n-    # TODO: macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     strategy:\n       fail-fast: false\n       matrix: ${{fromJson(needs.specs_checking.outputs.matrix)}}\n", "problem_statement": "Firestore for Mac doesn't build in CocoaPods for Xcode 15\n### Description\n\n    - NOTE  | [OSX] xcodebuild:  clang: error: SDK does not contain 'libarclite' at the path '/Applications/Xcode_15.0.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/arc/libarclite_macosx.a'; try increasing the minimum deployment target\r\n\r\nhttps://github.com/grpc/grpc/pull/36340 needs to be merged and published.\r\n\r\nThen update TODO's in firestore.yml, archive.yml, release.yml, and prerelease.yml\n\n### Reproducing the issue\n\nBuild Firestore example for macos or run pod lib lint ...\n\n### Firebase SDK Version\n\n10.24.0\n\n### Xcode Version\n\n15.3\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nFirestore\n\n### Targeted Platforms\n\nmacOS\n\n### Relevant Log Output\n\n_No response_\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "", "created_at": "2024-04-15 14:46:12", "merge_commit_sha": "5250da271ed186fd85cadb910b4b06916effc047", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["pod-lib-lint-abtesting", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-dynamiclinks (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["spm-source (macOS, macos-14)", ".github/workflows/firestore.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["buildup_SpecsTesting_repo_FirebaseCore", ".github/workflows/release.yml"], ["functions_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["abtesting_quickstart", ".github/workflows/release.yml"], ["pod-lib-lint-storage", ".github/workflows/health-metrics-presubmit.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-firestore", ".github/workflows/health-metrics-presubmit.yml"], ["specs_checking", ".github/workflows/release.yml"], ["pod-lib-lint (FirebaseFirestore.podspec)", ".github/workflows/firestore.yml"], ["pod-lib-lint-remoteconfig", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-remoteconfig (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["storage_quickstart", ".github/workflows/release.yml"], ["pod-lib-lint-database (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["specs_testing (FirebaseFirestoreSwift.podspec)", ".github/workflows/spectesting.yml"], ["messaging_quickstart", ".github/workflows/prerelease.yml"], ["auth_quickstart", ".github/workflows/prerelease.yml"], ["performance_quickstart", ".github/workflows/release.yml"], ["pod-lib-lint-database", ".github/workflows/health-metrics-presubmit.yml"], ["inappmessaging_quickstart", ".github/workflows/release.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-inappmessaging", ".github/workflows/health-metrics-presubmit.yml"], ["pods-ios-tvos-macos-cron", ".github/workflows/archiving.yml"], ["changes", ".github/workflows/firestore.yml"], ["pod-lib-lint-messaging", ".github/workflows/health-metrics-presubmit.yml"], ["dynamiclinks_quickstart", ".github/workflows/release.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["spm-source (iOS, macos-14)", ".github/workflows/firestore.yml"], ["performance_quickstart", ".github/workflows/prerelease.yml"], ["cmake (ubuntu-latest)", ".github/workflows/firestore.yml"], ["pod-lib-lint-firestore (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["check", ".github/workflows/check.yml"], ["Check changed files", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-storage (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["buildup_SpecsTesting_repo_FirebaseCore", ".github/workflows/prerelease.yml"], ["check-firestore-internal-public-headers", ".github/workflows/firestore.yml"], ["sanitizers-ubuntu (ubuntu-latest, asan)", ".github/workflows/firestore.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["sanitizers-mac (macos-12, tsan)", ".github/workflows/firestore.yml"], ["specs_checking", ".github/workflows/prerelease.yml"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-46733", "base_commit": "686ae476963ed138135bc5f2934addcd1cc1e4ac", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex ea1637c990309..45fafbdb52eb5 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -125,6 +125,7 @@ filenames = {\n     \"shell/browser/animation_util.h\",\n     \"shell/browser/animation_util_mac.mm\",\n     \"shell/browser/api/electron_api_app_mac.mm\",\n+    \"shell/browser/api/electron_api_base_window_mac.mm\",\n     \"shell/browser/api/electron_api_menu_mac.h\",\n     \"shell/browser/api/electron_api_menu_mac.mm\",\n     \"shell/browser/api/electron_api_native_theme_mac.mm\",\ndiff --git a/shell/browser/api/electron_api_base_window.cc b/shell/browser/api/electron_api_base_window.cc\nindex 848cc6cc2c9f8..a7983dd39c8bc 100644\n--- a/shell/browser/api/electron_api_base_window.cc\n+++ b/shell/browser/api/electron_api_base_window.cc\n@@ -70,6 +70,7 @@ namespace electron::api {\n \n namespace {\n \n+#if !BUILDFLAG(IS_MAC)\n // Converts binary data to Buffer.\n v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n@@ -78,6 +79,7 @@ v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n [[nodiscard]] constexpr std::array<int, 2U> ToArray(const gfx::Size size) {\n   return {size.width(), size.height()};\n@@ -778,6 +780,7 @@ std::string BaseWindow::GetMediaSourceId() const {\n   return window_->GetDesktopMediaID().ToString();\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   // TODO(MarshallOfSound): Replace once\n   // https://chromium-review.googlesource.com/c/chromium/src/+/1253094/ has\n@@ -785,6 +788,7 @@ v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   NativeWindowHandle handle = window_->GetNativeWindowHandle();\n   return ToBuffer(isolate(), &handle, sizeof(handle));\n }\n+#endif\n \n void BaseWindow::SetProgressBar(double progress, gin_helper::Arguments* args) {\n   gin_helper::Dictionary options;\ndiff --git a/shell/browser/api/electron_api_base_window_mac.mm b/shell/browser/api/electron_api_base_window_mac.mm\nnew file mode 100644\nindex 0000000000000..148ec216283f7\n--- /dev/null\n+++ b/shell/browser/api/electron_api_base_window_mac.mm\n@@ -0,0 +1,32 @@\n+// Copyright (c) 2025 Microsoft, Inc.\n+// Use of this source code is governed by the MIT license that can be\n+// found in the LICENSE file.\n+\n+#include \"shell/browser/api/electron_api_base_window.h\"\n+\n+#include \"electron/buildflags/buildflags.h\"\n+#include \"shell/browser/api/electron_api_view.h\"\n+#include \"shell/browser/native_window.h\"\n+#include \"shell/common/node_includes.h\"\n+\n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+namespace electron::api {\n+\n+v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n+  NSView* handle = window_->GetNativeWindowHandle().GetNativeNSView();\n+  return ToBuffer(isolate(), &handle, sizeof(handle));\n+}\n+\n+}  // namespace electron::api\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex 0779c4919b29a..bf5f6ec4b44b2 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -3743,15 +3743,17 @@ void WebContents::SetDevToolsWebContents(const WebContents* devtools) {\n     inspectable_web_contents_->SetDevToolsWebContents(devtools->web_contents());\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n   gfx::NativeView ptr = web_contents()->GetNativeView();\n-  auto buffer = node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr),\n-                                   sizeof(gfx::NativeView));\n+  auto buffer =\n+      node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr), sizeof(ptr));\n   if (buffer.IsEmpty())\n     return v8::Null(isolate);\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n v8::Local<v8::Value> WebContents::DevToolsWebContents(v8::Isolate* isolate) {\n   if (devtools_web_contents_.IsEmpty())\ndiff --git a/shell/browser/api/electron_api_web_contents_mac.mm b/shell/browser/api/electron_api_web_contents_mac.mm\nindex 52c4362839610..1358b3dde95da 100644\n--- a/shell/browser/api/electron_api_web_contents_mac.mm\n+++ b/shell/browser/api/electron_api_web_contents_mac.mm\n@@ -6,6 +6,7 @@\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n+#include \"shell/common/node_includes.h\"\n #include \"ui/base/cocoa/command_dispatcher.h\"\n #include \"ui/base/cocoa/nsmenu_additions.h\"\n #include \"ui/base/cocoa/nsmenuitem_additions.h\"\n@@ -92,4 +93,22 @@ - (void)redispatchKeyEvent:(NSEvent*)event;\n   return false;\n }\n \n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n+  NSView* handle = web_contents()->GetNativeView().GetNativeNSView();\n+  return ToBuffer(isolate, &handle, sizeof(handle));\n+}\n+\n }  // namespace electron::api\ndiff --git a/shell/browser/native_window.h b/shell/browser/native_window.h\nindex cc4d150ca72b1..831cf8947aa85 100644\n--- a/shell/browser/native_window.h\n+++ b/shell/browser/native_window.h\n@@ -58,9 +58,9 @@ class BrowserView;\n }\n \n #if BUILDFLAG(IS_MAC)\n-typedef gfx::NativeView NativeWindowHandle;\n+using NativeWindowHandle = gfx::NativeView;\n #else\n-typedef gfx::AcceleratedWidget NativeWindowHandle;\n+using NativeWindowHandle = gfx::AcceleratedWidget;\n #endif\n \n class NativeWindow : public base::SupportsUserData,\n", "test_patch": "", "problem_statement": "Regression: `win.getNativeWindowHandle()` is broken on macOS\n### Confirmation\n\n- [x] I am a [maintainer](https://github.com/orgs/electron/people) of the Electron project. (If not, please create a [different issue type](https://github.com/electron/electron/issues/new/).)\n\n### Description\n\n## Summary\n\nFor [about a month now](https://chromium-review.googlesource.com/c/chromium/src/+/6361987), `getNativeWindowHandle()` is no longer returning a `NSView*` on macOS.\n\nI found this bug today when [this new buffer safety PR](https://github.com/electron/electron/pull/46724) surfaced it. So I guess that PR is doing its job! \ud83d\ude06\n\nWe also have a [spec](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/spec/api-browser-window-spec.ts#L6281) that should detect this, but it seems to be [disabled in CI](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/.github/workflows/pipeline-segment-electron-test.yml#L195).\n\n## Storytime\n\n`BaseWindow::GetNativeWindowHandle()` works by doing a bytewise copy of NativeWindowHandle, which on macOS is a typedef for the Chromium type `gfx::NativeView`.\n\nIn the very early days of Electron, `gfx::NativeView` was, in fact, a `NSView*` and so the code worked as expected.\n\nThis changed in October 2018 with the [upstream change](https://chromium-review.googlesource.com/c/1270343) \"Make gfx::NativeView and gfx::NativeWindow not be NSView and NSWindow\".  Happily, the new type was a wrapper class whose only field was the `NSView` pointer, so a bytewise copy worked anyway. The code still worked as expected... by accident. \n\nThe type changed again [in March 2025](https://chromium-review.googlesource.com/c/chromium/src/+/6361987). It's now a subclass of [base::apple::WeakNSView](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#59) which [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#78) a `std::unique_ptr`. If that was a pointer to a NSView, in theory a bytewise copy would _still_ work as before due to the same lucky accident. Unfortunately, it's a pointer to [an opaque data type](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#13) that in turn [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#14) a NSView*. So instead of returning a `NSView*`, the bytewise copy is now returning a `NSView**`. \ud83d\ude35\n\n**BUT!** To add insult to injury, it's a little worse than that. Since the new wrapper class [also has another field](https://chromium-review.googlesource.com/c/chromium/src/+/6361987/10/ui/gfx/native_widget_types.h), we're also writing another `sizeof(uintptr_t)` bytes at the end of that `NSView**`. \n\n", "hints_text": "", "created_at": "2025-04-22 23:01:41", "merge_commit_sha": "c7b0bdab7e699aeeb58137a06e16d0432834e21a", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['Lint', '.github/workflows/build.yml']"], ["['test (linux, 1)', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['test (win, 1)', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-46112", "base_commit": "273baf4ec2c95a399468aa0cb170d609046fffba", "patch": "diff --git a/shell/browser/api/electron_api_desktop_capturer.cc b/shell/browser/api/electron_api_desktop_capturer.cc\nindex b7d7177bf47a9..1fcb7fbaa54c7 100644\n--- a/shell/browser/api/electron_api_desktop_capturer.cc\n+++ b/shell/browser/api/electron_api_desktop_capturer.cc\n@@ -15,6 +15,7 @@\n #include \"chrome/browser/media/webrtc/desktop_media_list.h\"\n #include \"chrome/browser/media/webrtc/thumbnail_capturer_mac.h\"\n #include \"chrome/browser/media/webrtc/window_icon_util.h\"\n+#include \"content/public/browser/browser_thread.h\"\n #include \"content/public/browser/desktop_capture.h\"\n #include \"gin/handle.h\"\n #include \"gin/object_template_builder.h\"\n@@ -252,7 +253,8 @@ void DesktopCapturer::DesktopListListener::OnSourceThumbnailChanged(int index) {\n }\n \n void DesktopCapturer::DesktopListListener::OnDelegatedSourceListDismissed() {\n-  std::move(failure_callback_).Run();\n+  content::GetUIThreadTaskRunner({})->PostTask(FROM_HERE,\n+                                               std::move(failure_callback_));\n }\n \n void DesktopCapturer::StartHandling(bool capture_window,\n", "test_patch": "", "problem_statement": "desktopCapturer crashing on linux w/XDP when the capture portal is dismissed/closed\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.0.0, 33.0.0, 34.0.0\n\n### What operating system(s) are you using?\n\nOther Linux\n\n### Operating System Version\n\nLinux bakery 6.12.9-zen1-1-zen #1 ZEN SMP PREEMPT_DYNAMIC Fri, 10 Jan 2025 00:39:35 +0000 x86_64 GNU/Linux\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n31.3.1 - No crashing but cannot open another portal request. 31.4.0 & later crashes\n\n### Expected Behavior\n\nDoesn't crash & allows following requests\n\n### Actual Behavior\n\nWhen the user closes the portal picker electron will crash.\n\n### Testcase Gist URL\n\nhttps://www.electronjs.org/docs/latest/api/desktop-capturer the example provided is a simple repro\n\n### Additional Information\n\nWhen attempting this from chromium the same errors will be spit out but there is no crash and can make following pick attempts so I believe theyre unrelated. Other than that theres no logs.\n```\n[10356:10356:0114/163419.616405:ERROR:screencast_portal.cc(367)] Failed to start the screen cast session.\n[10356:10356:0114/163419.616432:ERROR:base_capturer_pipewire.cc(81)] ScreenCastPortal failed: 2\n```\n", "hints_text": "<!-- blocked/need-repro -->\n\nHello @Covkie. Thanks for reporting this and helping to make Electron better!\n\nWould it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n\nStand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n\nNow adding the https://github.com/electron/electron/labels/blocked%2Fneed-repro label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\nhttps://gist.github.com/7335c2f02a56b67e19c0941491e5e6a3\n\nHere's the example on the docs in gist form\nCommenting to confirm that this happens on Flatpak apps using Electron as well.\nCould you please attach a crash dump to help us get more information? You can collect them by adding the following snippet to your main process code, before `app.whenReady`:\n\n```js\nconst { app, crashReporter } = require('electron')\nconsole.log(app.getPath('crashDumps'))\ncrashReporter.start({ submitURL: '', uploadToServer: false })\n```\n\nThen reproduce the crash, zip up the crash dumps directory and attach it here. Thanks! \n@codebytere \n\n[Crashpad.tar.gz](https://github.com/user-attachments/files/18514931/Crashpad.tar.gz)", "created_at": "2025-03-18 19:36:50", "merge_commit_sha": "cfd64b5f8983a34723abbdddf82fb6aea6ceb773", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-46067", "base_commit": "4ad20ccb396a3354d99b8843426bece2b28228bf", "patch": "diff --git a/shell/browser/file_system_access/file_system_access_permission_context.cc b/shell/browser/file_system_access/file_system_access_permission_context.cc\nindex 9f4b43645332b..865fa06f19bac 100644\n--- a/shell/browser/file_system_access/file_system_access_permission_context.cc\n+++ b/shell/browser/file_system_access/file_system_access_permission_context.cc\n@@ -825,13 +825,7 @@ std::u16string FileSystemAccessPermissionContext::GetPickerTitle(\n               ? IDS_FILE_SYSTEM_ACCESS_CHOOSER_OPEN_WRITABLE_DIRECTORY_TITLE\n               : IDS_FILE_SYSTEM_ACCESS_CHOOSER_OPEN_READABLE_DIRECTORY_TITLE);\n       break;\n-    case blink::mojom::TypeSpecificFilePickerOptionsUnion::Tag::\n-        kSaveFilePickerOptions:\n-      title = l10n_util::GetStringUTF16(\n-          IDS_FILE_SYSTEM_ACCESS_CHOOSER_OPEN_SAVE_FILE_TITLE);\n-      break;\n-    case blink::mojom::TypeSpecificFilePickerOptionsUnion::Tag::\n-        kOpenFilePickerOptions:\n+    default:\n       break;\n   }\n   return title;\n", "test_patch": "", "problem_statement": "`window.showSaveFilePicker()` shows warning in file picker UI\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n35.0.1, 36.0.0-alpha.2\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS Sequioa 15.3.1\n\n### What arch are you using?\n\narm64 (including Apple Silicon)\n\n### Last Known Working Electron version\n\n29.4.6\n\n### Expected Behavior\n\nIf I open a file picker with `window.showSaveFilePicker()`, it shows the standard file picker without any extra warnings.\n\nIn the context of an Electron app, I'd expect my app not to be referred to as a \"site\".\n\nAdditionally, in the context of a desktop app, a user expects the app to be able to continuously access files they select through a file picker. Warning them about that is unnecessary.\n\n### Actual Behavior\n\nThe file picker contains an ugly warning: \"Warning: this site can see edits you make\"\n\n![Screenshot](https://github.com/user-attachments/assets/b369517c-e6c3-480d-82b5-405b4abc38bb)\n\n### Testcase Gist URL\n\nhttps://gist.github.com/11316fce28ba719ce8446fb85955d50c\n\n### Additional Information\n\n_No response_\n", "hints_text": "This first appears in `v30.0.0`. In `v30.0.0-beta.8`, the title reads \"All Files\" when I test on Linux.\nLooks like this broke in cf1087badd437906f280373decb923733a8523e6 which landed right before v30.0.0\nIt's coming from this line here:\n\nhttps://github.com/electron/electron/blob/main/shell/browser/file_system_access/file_system_access_permission_context.cc#L830\n\nThe `Warning: the site can see changes you make` string is the default English value for `IDS_FILE_SYSTEM_ACCESS_CHOOSER_OPEN_SAVE_FILE_TITLE`.\n\n", "created_at": "2025-03-15 23:37:56", "merge_commit_sha": "bea7d618f1916d196e0a68c05f17a7ada286056f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45981", "base_commit": "cd56b965442d254ff8801446303343f36ea8acef", "patch": "diff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex 53a24ac6f5943..c01e3c5fda2aa 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -2057,6 +2057,17 @@ void WebContents::DidFinishNavigation(\n       if (is_main_frame) {\n         Emit(\"did-navigate\", url, http_response_code, http_status_text);\n       }\n+\n+      content::NavigationEntry* entry = navigation_handle->GetNavigationEntry();\n+\n+      // This check is needed due to an issue in Chromium\n+      // Upstream is open to patching:\n+      // https://bugs.chromium.org/p/chromium/issues/detail?id=1178663\n+      // If a history entry has been made and the forward/back call has been\n+      // made, proceed with setting the new title\n+      if (entry &&\n+          (entry->GetTransitionType() & ui::PAGE_TRANSITION_FORWARD_BACK))\n+        WebContents::TitleWasSet(entry);\n     }\n     if (is_guest())\n       Emit(\"load-commit\", url, is_main_frame);\n@@ -2077,15 +2088,6 @@ void WebContents::DidFinishNavigation(\n            frame_process_id, frame_routing_id);\n     }\n   }\n-  content::NavigationEntry* entry = navigation_handle->GetNavigationEntry();\n-\n-  // This check is needed due to an issue in Chromium\n-  // Check the Chromium issue to keep updated:\n-  // https://bugs.chromium.org/p/chromium/issues/detail?id=1178663\n-  // If a history entry has been made and the forward/back call has been made,\n-  // proceed with setting the new title\n-  if (entry && (entry->GetTransitionType() & ui::PAGE_TRANSITION_FORWARD_BACK))\n-    WebContents::TitleWasSet(entry);\n }\n \n void WebContents::TitleWasSet(content::NavigationEntry* entry) {\ndiff --git a/spec/api-web-contents-spec.ts b/spec/api-web-contents-spec.ts\nindex aa2c7d5297453..3f529c118d2e3 100644\n--- a/spec/api-web-contents-spec.ts\n+++ b/spec/api-web-contents-spec.ts\n@@ -631,6 +631,17 @@ describe('webContents module', () => {\n         w.webContents.navigationHistory.goBack();\n         expect(w.webContents.navigationHistory.getActiveIndex()).to.equal(0);\n       });\n+\n+      it('should have the same window title if navigating back within the page', async () => {\n+        const title = 'Test';\n+        w.webContents.on('did-finish-load', () => {\n+          w.setTitle(title);\n+          w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html#next`);\n+        });\n+        await w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html`);\n+        w.webContents.navigationHistory.goBack();\n+        expect(w.getTitle()).to.equal(title);\n+      });\n     });\n \n     describe('navigationHistory.canGoForward and navigationHistory.goForward API', () => {\n@@ -653,6 +664,16 @@ describe('webContents module', () => {\n         w.webContents.navigationHistory.goForward();\n         expect(w.webContents.navigationHistory.getActiveIndex()).to.equal(1);\n       });\n+\n+      it('should have the same window title if navigating forward within the page', async () => {\n+        const title = 'Test';\n+        w.webContents.on('did-finish-load', () => {\n+          w.setTitle(title);\n+          w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html#next`);\n+        });\n+        await w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html`);\n+        expect(w.getTitle()).to.equal(title);\n+      });\n     });\n \n     describe('navigationHistory.canGoToOffset(index) and navigationHistory.goToOffset(index) API', () => {\ndiff --git a/spec/fixtures/pages/navigation-history-anchor-in-page.html b/spec/fixtures/pages/navigation-history-anchor-in-page.html\nnew file mode 100644\nindex 0000000000000..03406b81f2a39\n--- /dev/null\n+++ b/spec/fixtures/pages/navigation-history-anchor-in-page.html\n@@ -0,0 +1,5 @@\n+<html>\n+<body>\n+  <span id=\"next\">This is content.</span>\n+</body>\n+</html>\n", "test_patch": "", "problem_statement": "[Bug]: When `window.webContents.navigationHistory.goBack()` is called, the title set by the HTML's `<title>` tag will override the title set by `window.setTitle()`.\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.0.1\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11\t23H2\t22631.4169\tWindows Feature Experience Pack 1000.22700.1034.0\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\n```\nconst window = new BrowserWindow();\nwindow.setTitle('myTitle');\n// After a route change in my HTML file, execute:\nwindow.webContents.navigationHistory.goBack();\n// => The title of the window should not be overridden by the HTML's title when `goBack()` is called.\n```\n\n### Actual Behavior\n\n```\nconst window = new BrowserWindow();\nwindow.setTitle('myTitle');\n// After a route change in my HTML file, execute:\nwindow.webContents.navigationHistory.goBack();\n// => At this point, the title of the window is no longer 'myTitle', but the content of the title tag in the HTML file.\n```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nThe front-end uses Vue.js + Vue-Router\n", "hints_text": "<!-- blocked/need-repro -->\n\nHello @an78mK89fy. Thanks for reporting this and helping to make Electron better!\n\nWould it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n\nStand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n\nNow adding the https://github.com/electron/electron/labels/blocked%2Fneed-repro label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\nPlease provide a title for your issue.\n> Hello [@an78mK89fy](https://github.com/an78mK89fy). Thanks for reporting this and helping to make Electron better!\n> \n> Would it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n> \n> Stand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n> \n> Now adding the [ blocked/need-repro](https://github.com/electron/electron/labels/blocked%2Fneed-repro) Needs a test case to reproduce the bug label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\n\n\n\n> Hello [@an78mK89fy](https://github.com/an78mK89fy). Thanks for reporting this and helping to make Electron better!\n> \n> Would it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n> \n> Stand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n> \n> Now adding the [ blocked/need-repro](https://github.com/electron/electron/labels/blocked%2Fneed-repro) Needs a test case to reproduce the bug label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\n\nexample:\nhttps://github.com/an78mK89fy/electron-nhgoBackTitleBug.git\n\n@an78mK89fy this repro still includes Vite - we need a repro that demonstrates this is an issue with Electron, which is made more difficult when the app is rife with third-party dependencies.\n> [@an78mK89fy](https://github.com/an78mK89fy) this repro still includes Vite - we need a repro that demonstrates this is an issue with Electron, which is made more difficult when the app is rife with third-party dependencies.\n\nhttps://github.com/an78mK89fy/electron-nhgoBackTitleBug.git\nis update\nConfirmed on v33.0.1 using this Fiddle gist: https://gist.github.com/f356a50a0dad57d13f13a48919b05709", "created_at": "2025-03-11 20:04:29", "merge_commit_sha": "4812b4e6c249a6ff346d435fcc21d8e03bfe5073", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45712", "base_commit": "340fdaf511de6e60e42db280c32c1fdd108cf737", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex fec7148a7ec5a..cea4da74f5f7f 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -140,3 +140,4 @@ revert_code_health_clean_up_stale_macwebcontentsocclusion.patch\n ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\n feat_add_signals_when_embedder_cleanup_callbacks_run_for.patch\n feat_separate_content_settings_callback_for_sync_and_async_clipboard.patch\n+fix_win32_synchronous_spellcheck.patch\ndiff --git a/patches/chromium/fix_win32_synchronous_spellcheck.patch b/patches/chromium/fix_win32_synchronous_spellcheck.patch\nnew file mode 100644\nindex 0000000000000..355c8f8e9a6ae\n--- /dev/null\n+++ b/patches/chromium/fix_win32_synchronous_spellcheck.patch\n@@ -0,0 +1,29 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Keeley Hammond <khammond@slack-corp.com>\n+Date: Wed, 19 Feb 2025 11:18:44 -0800\n+Subject: fix: re-enable synchronous spellcheck on Windows\n+\n+This fix partially reverts 6109477: Code Health:\n+Clean up stale base::Feature \"WinRetrieveSuggestionsOnlyOnDemand\"\n+https://chromium-review.googlesource.com/c/chromium/src/+/6109477\n+by re-adding a synchronous call to FillSuggestionList.\n+\n+This patch can be removed when an asynchronous spellcheck API\n+option is added to Electron.\n+\n+diff --git a/components/spellcheck/browser/windows_spell_checker.cc b/components/spellcheck/browser/windows_spell_checker.cc\n+index f5a7411037758427eddc088b5426554b4a500d33..04b3edd4d8c58d38e260cc54beb0dab86368fc25 100644\n+--- a/components/spellcheck/browser/windows_spell_checker.cc\n++++ b/components/spellcheck/browser/windows_spell_checker.cc\n+@@ -239,6 +239,11 @@ std::vector<SpellCheckResult> BackgroundHelper::RequestTextCheckForAllLanguages(\n+             (action == CORRECTIVE_ACTION_GET_SUGGESTIONS ||\n+              action == CORRECTIVE_ACTION_REPLACE)) {\n+           std::vector<std::u16string> suggestions;\n++          // TODO (vertedinde): Perform the synchronous operation of retrieving\n++          // suggestions for all misspelled words while performing a text check.\n++          FillSuggestionList(it->first,\n++            text.substr(start_index, error_length),\n++            &suggestions);\n+           result_map[std::tuple<ULONG, ULONG>(start_index, error_length)]\n+               .push_back(suggestions);\n+         }\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex f6265505f8803..a18f580f92bba 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -194,14 +194,6 @@\n #include \"content/public/browser/plugin_service.h\"\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"chrome/browser/spellchecker/spellcheck_factory.h\"\n-#include \"chrome/browser/spellchecker/spellcheck_service.h\"\n-#include \"components/spellcheck/browser/spellcheck_platform.h\"\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#include \"components/spellcheck/common/spellcheck_features.h\"\n-#endif\n-\n #if !IS_MAS_BUILD()\n #include \"chrome/browser/hang_monitor/hang_crash_dump.h\"  // nogncheck\n #endif\n@@ -1521,44 +1513,11 @@ void WebContents::RendererResponsive(\n \n bool WebContents::HandleContextMenu(content::RenderFrameHost& render_frame_host,\n                                     const content::ContextMenuParams& params) {\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (!params.misspelled_word.empty() && spellcheck::UseBrowserSpellChecker()) {\n-    SpellcheckService* spellcheck_service =\n-        SpellcheckServiceFactory::GetForContext(\n-            render_frame_host.GetBrowserContext());\n-    if (spellcheck_service) {\n-      spellcheck_platform::GetPerLanguageSuggestions(\n-          spellcheck_service->platform_spell_checker(), params.misspelled_word,\n-          base::BindOnce(&WebContents::OnGetPlatformSuggestionsComplete,\n-                         GetWeakPtr(), std::ref(render_frame_host), params));\n-    }\n-  } else {\n-#endif\n-    Emit(\"context-menu\",\n-         std::make_tuple(params, &render_frame_host,\n-                         std::optional<std::vector<std::u16string>>{}));\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  }\n-#endif\n+  Emit(\"context-menu\", std::make_pair(params, &render_frame_host));\n \n   return true;\n }\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-void WebContents::OnGetPlatformSuggestionsComplete(\n-    content::RenderFrameHost& render_frame_host,\n-    const content::ContextMenuParams& params,\n-    const spellcheck::PerLanguageSuggestions&\n-        platform_per_language_suggestions) {\n-  std::vector<std::u16string> combined_suggestions;\n-  spellcheck::FillSuggestions(platform_per_language_suggestions,\n-                              &combined_suggestions);\n-  Emit(\"context-menu\",\n-       std::make_tuple(params, &render_frame_host,\n-                       std::make_optional(combined_suggestions)));\n-}\n-#endif\n-\n void WebContents::FindReply(content::WebContents* web_contents,\n                             int request_id,\n                             int number_of_matches,\ndiff --git a/shell/browser/api/electron_api_web_contents.h b/shell/browser/api/electron_api_web_contents.h\nindex 58a6de68d24e5..40a0502b66924 100644\n--- a/shell/browser/api/electron_api_web_contents.h\n+++ b/shell/browser/api/electron_api_web_contents.h\n@@ -57,10 +57,6 @@ class ScriptExecutor;\n }\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#endif\n-\n namespace blink {\n struct DeviceEmulationParams;\n // enum class PermissionType;\n@@ -761,14 +757,6 @@ class WebContents final : public ExclusiveAccessContext,\n   // Update the html fullscreen flag in both browser and renderer.\n   void UpdateHtmlApiFullscreen(bool fullscreen);\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  void OnGetPlatformSuggestionsComplete(\n-      content::RenderFrameHost& render_frame_host,\n-      const content::ContextMenuParams& params,\n-      const spellcheck::PerLanguageSuggestions&\n-          platform_per_language_suggestions);\n-#endif\n-\n   v8::Global<v8::Value> session_;\n   v8::Global<v8::Value> devtools_web_contents_;\n   v8::Global<v8::Value> debugger_;\ndiff --git a/shell/common/gin_converters/content_converter.cc b/shell/common/gin_converters/content_converter.cc\nindex 7e593c324a0dd..d5a257b8f24ac 100644\n--- a/shell/common/gin_converters/content_converter.cc\n+++ b/shell/common/gin_converters/content_converter.cc\n@@ -88,7 +88,8 @@ v8::Local<v8::Value> Converter<blink::mojom::MenuItem::Type>::ToV8(\n v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n     v8::Isolate* isolate,\n     const ContextMenuParamsWithRenderFrameHost& val) {\n-  auto [params, render_frame_host, optional_suggestions] = val;\n+  const auto& params = val.first;\n+  content::RenderFrameHost* render_frame_host = val.second;\n   auto dict = gin_helper::Dictionary::CreateEmpty(isolate);\n   dict.SetGetter(\"frame\", render_frame_host, v8::DontEnum);\n   dict.Set(\"x\", params.x);\n@@ -113,11 +114,7 @@ v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n   dict.Set(\"misspelledWord\", params.misspelled_word);\n   dict.Set(\"selectionRect\", params.selection_rect);\n #if BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (optional_suggestions) {\n-    dict.Set(\"dictionarySuggestions\", optional_suggestions.value());\n-  } else {\n-    dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n-  }\n+  dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n   dict.Set(\"spellcheckEnabled\", params.spellcheck_enabled);\n #else\n   dict.Set(\"spellcheckEnabled\", false);\ndiff --git a/shell/common/gin_converters/content_converter.h b/shell/common/gin_converters/content_converter.h\nindex 1e1f26012f874..2fa5f7f118df9 100644\n--- a/shell/common/gin_converters/content_converter.h\n+++ b/shell/common/gin_converters/content_converter.h\n@@ -26,9 +26,7 @@ struct NativeWebKeyboardEvent;\n }\n \n using ContextMenuParamsWithRenderFrameHost =\n-    std::tuple<content::ContextMenuParams,\n-               content::RenderFrameHost*,\n-               std::optional<std::vector<std::u16string>>>;\n+    std::pair<content::ContextMenuParams, content::RenderFrameHost*>;\n \n namespace gin {\n \n", "test_patch": "", "problem_statement": "Empty dictionarySuggestions on Windows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\nv35.0.0-nightly.20250113\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\nv35.0.0-nightly.20250109\n\n### Expected Behavior\n\nContext menu contains `dictionarySuggestions`\n\n### Actual Behavior\n\nContext menu contains `dictionarySuggestions` without any suggestions\n\n### Testcase Gist URL\n\nhttps://gist.github.com/samuelmaddock/e66dde2361de95f3c48f443a8abdd099\n\n### Additional Information\n\nRegressed by https://chromium-review.googlesource.com/c/chromium/src/+/6109477 in https://github.com/electron/electron/pull/45055\n\nRelated:\n* https://github.com/electron/electron/pull/29690\n* https://github.com/electron/electron/issues/29685\n", "hints_text": "", "created_at": "2025-02-19 19:25:01", "merge_commit_sha": "6248c2436a2fd4c503feeee7183fe0afc44df2c6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45527", "base_commit": "9199d5c610c399d612dd938c87e2a92de56ec68c", "patch": "diff --git a/docs/api/in-app-purchase.md b/docs/api/in-app-purchase.md\nindex 38078ecf29dd7..0fed7b8c2c1b6 100644\n--- a/docs/api/in-app-purchase.md\n+++ b/docs/api/in-app-purchase.md\n@@ -10,13 +10,13 @@ The `inAppPurchase` module emits the following events:\n \n ### Event: 'transactions-updated'\n \n-Emitted when one or more transactions have been updated.\n-\n Returns:\n \n * `event` Event\n * `transactions` Transaction[] - Array of [`Transaction`](structures/transaction.md) objects.\n \n+Emitted when one or more transactions have been updated.\n+\n ## Methods\n \n The `inAppPurchase` module has the following methods:\n", "test_patch": "", "problem_statement": "Invalid TypeScript type for event 'transactions-updated'\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.2.8\n\n### What operating system(s) are you using?\n\nOther (specify below)\n\n### Operating System Version\n\n...\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nExpected type:\n```ts\non(event: 'transactions-updated', listener: (event: Event, transactions: Transaction[]) => void): this;\n```\n\n### Actual Behavior\n\nActual type:\n```ts\non(event: 'transactions-updated', listener: () => void): this;\n```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nDocs: https://www.electronjs.org/docs/latest/api/in-app-purchase#event-transactions-updated\n", "hints_text": "", "created_at": "2025-02-07 20:49:31", "merge_commit_sha": "4085185e2dd56cd691ba3c8ece36f63c969563b0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['macos-gn-check', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['macos-x64', '.github/workflows/build.yml']", "['Validate PR Title', '.github/workflows/semantic.yml']"], ["['Lint', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['checkout-windows', '.github/workflows/build.yml']", "['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']"], ["['linux-arm', '.github/workflows/build.yml']", "['windows-x64', '.github/workflows/build.yml']"], ["['windows-gn-check', '.github/workflows/build.yml']", "['windows-arm64', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45487", "base_commit": "6adc737a89110703a0f06744fb60571275a38c5c", "patch": "diff --git a/shell/browser/api/electron_api_web_frame_main.cc b/shell/browser/api/electron_api_web_frame_main.cc\nindex 3e800659a48c3..cc3d142eef049 100644\n--- a/shell/browser/api/electron_api_web_frame_main.cc\n+++ b/shell/browser/api/electron_api_web_frame_main.cc\n@@ -183,7 +183,7 @@ void WebFrameMain::UpdateRenderFrameHost(content::RenderFrameHost* rfh) {\n }\n \n bool WebFrameMain::CheckRenderFrame() const {\n-  if (render_frame_disposed_) {\n+  if (!HasRenderFrame()) {\n     v8::Isolate* isolate = JavascriptEnvironment::GetIsolate();\n     v8::HandleScope scope(isolate);\n     gin_helper::ErrorThrower(isolate).ThrowError(\n@@ -435,7 +435,7 @@ v8::Local<v8::Promise> WebFrameMain::CollectDocumentJSCallStack(\n   gin_helper::Promise<base::Value> promise(args->isolate());\n   v8::Local<v8::Promise> handle = promise.GetHandle();\n \n-  if (render_frame_disposed_) {\n+  if (!HasRenderFrame()) {\n     promise.RejectWithErrorMessage(\n         \"Render frame was disposed before WebFrameMain could be accessed\");\n     return handle;\n@@ -463,7 +463,7 @@ void WebFrameMain::CollectedJavaScriptCallStack(\n     gin_helper::Promise<base::Value> promise,\n     const std::string& untrusted_javascript_call_stack,\n     const std::optional<blink::LocalFrameToken>& remote_frame_token) {\n-  if (render_frame_disposed_) {\n+  if (!HasRenderFrame()) {\n     promise.RejectWithErrorMessage(\n         \"Render frame was disposed before call stack was received\");\n     return;\ndiff --git a/shell/browser/api/electron_api_web_frame_main.h b/shell/browser/api/electron_api_web_frame_main.h\nindex 9191e6f346217..de984aee5db69 100644\n--- a/shell/browser/api/electron_api_web_frame_main.h\n+++ b/shell/browser/api/electron_api_web_frame_main.h\n@@ -101,8 +101,14 @@ class WebFrameMain final : public gin::Wrappable<WebFrameMain>,\n   void TeardownMojoConnection();\n   void OnRendererConnectionError();\n \n-  // WebFrameMain can outlive its RenderFrameHost pointer so we need to check\n-  // whether its been disposed of prior to accessing it.\n+  [[nodiscard]] constexpr bool HasRenderFrame() const {\n+    return !render_frame_disposed_ && render_frame_ != nullptr;\n+  }\n+\n+  // Throws a JS error if HasRenderFrame() is false.\n+  // WebFrameMain can outlive its RenderFrameHost pointer,\n+  // so we need to check whether its been disposed of\n+  // prior to accessing it.\n   bool CheckRenderFrame() const;\n \n   v8::Local<v8::Promise> ExecuteJavaScript(gin::Arguments* args,\n", "test_patch": "", "problem_statement": "WebFrameMain frames and name field access SIGSEGV\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.3.0\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS Sonoma 14.3\n\n### What arch are you using?\n\narm64 (including Apple Silicon)\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nAccessing WebFrameMain `frames` and `name` attributes on destroyed frames previously threw an error.\n\n### Actual Behavior\n\nAccessing WebFrameMain `frames` and `name` attributes on destroyed frames now segfaults.\n\n```checked if frame is alive 0.8441429125447275\nchecking if frame is alive 0.7526827941185381\nchecked if frame is destroyed 0.7526827941185381\nchecking if frame is detached 0.7526827941185381\nchecked if frame is detached 0.7526827941185381\nchecking .frames 0.7526827941185381\n.../app/node_modules/electron/dist/Electron.app/Contents/MacOS/Electron exited with signal SIGSEGV```\n\nThe trace:\n\n```\nThread 0 (crashed)\n0 Electron Framework!content::FrameTree::SubtreeAndInnerTreeNodes(content::RenderFrameHostImpl*, bool) [frame_tree.cc : 353 + 0x0]\nx0 = 0xefefefefefefefef x1 = 0x0000000000000000\nx2 = 0x000000010c47eb00 x3 = 0x0000000000000000\nx4 = 0x0000000000000000 x5 = 0x000000000000000f\nx6 = 0x0000000000000180 x7 = 0x0000000000000004\nx8 = 0xaaaaaaaaaaaaaaaa x9 = 0x000000010eb2cd94\nx10 = 0xffffffffffff1e48  x11 = 0x00000d6300100000\nx12 = 0x0000000000001685  x13 = 0x0000000000000044\nx14 = 0x0000000000000010  x15 = 0x0000000000000003\nx16 = 0x000000000089cb29  x17 = 0x0000000157e0f6cc\nx18 = 0x0000000000000000  x19 = 0x000000016d59b710\nx20 = 0x0000000000000000  x21 = 0x00000104009d7e00\nx22 = 0x0000000000000000  x23 = 0x000000011528a000\nx24 = 0x00000001153b8000  x25 = 0xefefefefefefefef\nx26 = 0x0000010400510100  x27 = 0x00000d63002cdf65\nx28 = 0x00000d6300000000 fp = 0x000000016d59b680\nlr = 0x000000010eaf767c sp = 0x000000016d59b600\npc = 0x000000010ea57460\nFound by: given as instruction pointer in context\n1 Electron Framework!content::RenderFrameHostImpl::ForEachRenderFrameHostImpl(base::FunctionRef&lt;content::RenderFrameHost::FrameIterationAction (content::RenderFrameHostImpl*)&gt;, bool) [render_frame_host_impl.cc : 2713 + 0xc]\nx19 = 0x0000000000000000  x20 = 0x000000010eb2cd9c\nx21 = 0x000000016d59b790  x22 = 0x00000104009d7e00\nx23 = 0xaaaaaaaaaaaaaaaa  x24 = 0x00000001153b8000\nx25 = 0x00000104000f0280  x26 = 0x0000010400510100\nx27 = 0x00000d63002cdf65  x28 = 0x00000d6300000000\nfp = 0x000000016d59b770 sp = 0x000000016d59b690\npc = 0x000000010eaf767c\nFound by: call frame info\n2 Electron Framework!content::RenderFrameHostImpl::ForEachRenderFrameHost(base::FunctionRef&lt;void (content::RenderFrameHost*)&gt;) [render_frame_host_impl.cc : 2638 + 0x8]\nx19 = 0x00000104067ccfa0  x20 = 0x000000016d59b7e8\nx21 = 0x000000016d59b8a8  x22 = 0x0000000000000001\nx23 = 0x0000000000000015  x24 = 0x00000001153b8000\nx25 = 0x00000104000f0280  x26 = 0x0000010400510100\nx27 = 0x00000d63002cdf65  x28 = 0x00000d6300000000\nfp = 0x000000016d59b7a0 sp = 0x000000016d59b780\npc = 0x000000010eaf75c0\nFound by: call frame info\n3 Electron Framework!electron::api::WebFrameMain::Frames() const [electron_api_web_frame_main.cc : 412 + 0x4]\nx19 = 0x00000104067ccfa0  x20 = 0x000000016d59b7e8\nx21 = 0x000000016d59b8a8  x22 = 0x0000000000000001\nx23 = 0x0000000000000015  x24 = 0x00000001153b8000\nx25 = 0x00000104000f0280  x26 = 0x0000010400510100\nx27 = 0x00000d63002cdf65  x28 = 0x00000d6300000000\nfp = 0x000000016d59b7d0 sp = 0x000000016d59b7b0\npc = 0x000000010c47bf8c\nFound by: call frame info```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nThis may be related to [#43473](https://github.com/electron/electron/pull/43473) @samuelmaddock \n", "hints_text": "<!-- blocked/need-repro -->\n\nHello @alexi. Thanks for reporting this and helping to make Electron better!\n\nWould it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n\nStand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n\nNow adding the https://github.com/electron/electron/labels/blocked%2Fneed-repro label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\nReproduction: https://gist.github.com/alexi/8533563332a7c7004d0d535259080c18\nThe clue region is commented in the gist:\n\n``` \n  // If we comment this handler out, the SIGSEGV does not occur.\n  view.webContents.on(\"frame-created\", (event, details) => {\n      const { frame } = details;\n\n      if (!frame) return;\n\n      const { parent } = frame;\n      if (!parent) return;\n\n      // If we return here the crash _does_ still occur.\n      // return; \n\n      frame.once(\"dom-ready\", () => fixPreloadScripts(frame));\n  });\n```\n\nHowever, in our production project the same does not hold true. Removing the on `frame-created` handler does not prevent the segfault.\nI think this may be due to the fact that [CheckRenderFrame](https://github.com/electron/electron/blob/2745771a22dc7aec4364fec758804e0b7f230357/shell/browser/api/electron_api_web_frame_main.cc#L186) does not check if `render_frame_` is null, only if `render_frame_disposed_` is true.\n\nOne simple solution may be to add a null pointer check.\nWanted to check in and see if there is a timeline for adressing this segfault, it\u2019s currently blocking us. Thanks!\nThanks for reporting the crash!\n\nI tried reproducing this issue using the provided testcase gist but it does not produce a crash for me. It also seems to me like the fiddle contains a lot of extra code that might not be necessary.\n\nWould you be able to 1) double-check the gist and 2) slim it down to only the minimal amount of code necessary to reproduce the issue?\n\nApart from that, it would help if you could determine\n\n1) If the crash also happens on v35 prereleases\n2) What version of Electron this last worked on.\n\nThank you very much in advance!\nInteresting!\n\nI have slimmed down the gist: https://gist.github.com/alexi/e0fd317c0663267433c6c766e870ddbe\n\n1. The crash does happen for me on v35.0.0-alpha.5\n2. The last working version: v32.3.0\nThanks for slimming down the Fiddle gist!\n\nFor everyone running it: It's set to run on v32.3.0 by default \u2014 the version where it's supposed to work and not crash.\n\nI'm still not able to reproduce the crash with the slimmed-down gist (on macOS 15.2 with Electron 34/35) but maybe someone else is.\nI just reproduced on another machine as well (macOS Sonoma 14.5 - v33.3.0, v34.0.2).\nI believe there is a one line change that would fix this, planning to get local dev env setup to test but it's:\n\n```\nWebFrameMain::CheckRenderFrame() {\n    if (render_frame_disposed_ || render_frame_ == nullptr) { // add nullptr check\n```\n@alexi I'll test out this change and see if this fixes it. Thanks for doing so much research on this!", "created_at": "2025-02-06 03:00:44", "merge_commit_sha": "67f5ac5bbc1779c9ab896d0cf76e18e31251549e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45238", "base_commit": "97fa059e1fd2afae683830ec1d5d6f0f20f6792c", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex 99c80b915a02d..9a950d0e1955c 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -159,12 +159,8 @@ filenames = {\n     \"shell/browser/osr/osr_web_contents_view_mac.mm\",\n     \"shell/browser/relauncher_mac.cc\",\n     \"shell/browser/ui/certificate_trust_mac.mm\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.h\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.mm\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.h\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.mm\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.h\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.mm\",\n     \"shell/browser/ui/cocoa/electron_native_widget_mac.h\",\n@@ -191,8 +187,6 @@ filenames = {\n     \"shell/browser/ui/cocoa/window_buttons_proxy.mm\",\n     \"shell/browser/ui/drag_util_mac.mm\",\n     \"shell/browser/ui/file_dialog_mac.mm\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.h\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.mm\",\n     \"shell/browser/ui/message_box_mac.mm\",\n     \"shell/browser/ui/tray_icon_cocoa.h\",\n     \"shell/browser/ui/tray_icon_cocoa.mm\",\n@@ -224,8 +218,6 @@ filenames = {\n     \"shell/browser/ui/views/electron_views_delegate.h\",\n     \"shell/browser/ui/views/frameless_view.cc\",\n     \"shell/browser/ui/views/frameless_view.h\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.cc\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.h\",\n     \"shell/browser/ui/views/menu_bar.cc\",\n     \"shell/browser/ui/views/menu_bar.h\",\n     \"shell/browser/ui/views/menu_delegate.cc\",\ndiff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex dc05787535848..939c67537716a 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -133,6 +133,8 @@ osr_shared_texture_remove_keyed_mutex_on_win_dxgi.patch\n feat_allow_usage_of_sccontentsharingpicker_on_supported_platforms.patch\n chore_partial_revert_of.patch\n fix_software_compositing_infinite_loop.patch\n+fix_add_method_which_disables_headless_mode_on_native_widget.patch\n+fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n refactor_unfilter_unresponsive_events.patch\n build_disable_thin_lto_mac.patch\n build_add_public_config_simdutf_config.patch\ndiff --git a/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\nnew file mode 100644\nindex 0000000000000..95d22359148d2\n--- /dev/null\n+++ b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\n@@ -0,0 +1,26 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Cezary Kulakowski <cezary@openfin.co>\n+Date: Mon, 22 Jul 2024 16:23:13 +0200\n+Subject: fix: add method which disables headless mode on native widget\n+\n+We need this method as we create window in headless mode and we\n+switch it back to normal mode only after inital paint is done in\n+order to get some events like WebContents.beginFrameSubscription.\n+If we don't set `is_headless_` to false then some child windows\n+e.g. autofill popups will be created in headless mode leading to\n+ui problems (like dissapearing popup during typing in html's\n+input list.\n+\n+diff --git a/ui/views/widget/widget.h b/ui/views/widget/widget.h\n+index 30d0ea6633cb0f7f9aab37951a38be9b0482a12a..734e91e6d50c8d3afd20b39167c6254e934e7c1e 100644\n+--- a/ui/views/widget/widget.h\n++++ b/ui/views/widget/widget.h\n+@@ -1144,6 +1144,8 @@ class VIEWS_EXPORT Widget : public internal::NativeWidgetDelegate,\n+   // True if widget was created in headless mode.\n+   bool is_headless() const { return is_headless_; }\n+ \n++  void DisableHeadlessMode() { is_headless_ = false; }\n++\n+   // True if the window size will follow the content preferred size.\n+   bool is_autosized() const { return is_autosized_; }\n+ \ndiff --git a/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\nnew file mode 100644\nindex 0000000000000..d7e0977944197\n--- /dev/null\n+++ b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: =?UTF-8?q?Micha=C5=82=20Pichli=C5=84ski?=\n+ <michal.pichlinski@openfin.co>\n+Date: Tue, 29 Oct 2024 21:16:29 +0100\n+Subject: fix: Put NSVisualEffectView before ViewsCompositorSuperview\n+\n+Upstreamed at https://chromium-review.googlesource.com/c/chromium/src/+/6030552\n+\n+Otherwise when using `vibrancy` in `BrowserWindow` NSVisualEffectView\n+will hide content displayed by the compositor.\n+\n+diff --git a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+index 07c3997e6565cf77362ee73959c4d21da4fefe96..3353a7847df90b58eec34ea4d6ff8fb19617f5cc 100644\n+--- a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n++++ b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+@@ -223,8 +223,19 @@ NSComparisonResult SubviewSorter(__kindof NSView* lhs,\n+                                  void* rank_as_void) {\n+   DCHECK_NE(lhs, rhs);\n+ \n+-  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]])\n++\n++  // Put NSVisualEffectView before ViewsCompositorSuperview otherwise when using\n++  // `vibrancy` in `BrowserWindow` NSVisualEffectView will hide content\n++  // displayed by the compositor.\n++  if ([lhs isKindOfClass:[NSVisualEffectView class]]) {\n+     return NSOrderedAscending;\n++  }\n++  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]]) {\n++    if ([rhs isKindOfClass:[NSVisualEffectView class]]) {\n++      return NSOrderedDescending;\n++    }\n++    return NSOrderedAscending;\n++  }\n+ \n+   const RankMap* rank = static_cast<const RankMap*>(rank_as_void);\n+   auto left_rank = rank->find(lhs);\ndiff --git a/shell/browser/api/electron_api_web_contents_view.cc b/shell/browser/api/electron_api_web_contents_view.cc\nindex 644ea373a7287..f76209fbdf5be 100644\n--- a/shell/browser/api/electron_api_web_contents_view.cc\n+++ b/shell/browser/api/electron_api_web_contents_view.cc\n@@ -27,29 +27,14 @@\n #include \"ui/views/view_class_properties.h\"\n #include \"ui/views/widget/widget.h\"\n \n-#if BUILDFLAG(IS_MAC)\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#endif\n-\n namespace electron::api {\n \n WebContentsView::WebContentsView(v8::Isolate* isolate,\n                                  gin::Handle<WebContents> web_contents)\n-#if BUILDFLAG(IS_MAC)\n-    : View(new DelayedNativeViewHost(web_contents->inspectable_web_contents()\n-                                         ->GetView()\n-                                         ->GetNativeView())),\n-#else\n-    : View(web_contents->inspectable_web_contents()->GetView()->GetView()),\n-#endif\n+    : View(web_contents->inspectable_web_contents()->GetView()),\n       web_contents_(isolate, web_contents.ToV8()),\n       api_web_contents_(web_contents.get()) {\n-#if !BUILDFLAG(IS_MAC)\n-  // On macOS the View is a newly-created |DelayedNativeViewHost| and it is our\n-  // responsibility to delete it. On other platforms the View is created and\n-  // managed by InspectableWebContents.\n   set_delete_view(false);\n-#endif\n   view()->SetProperty(\n       views::kFlexBehaviorKey,\n       views::FlexSpecification(views::MinimumFlexSizeRule::kScaleToMinimum,\ndiff --git a/shell/browser/native_window_mac.h b/shell/browser/native_window_mac.h\nindex d153dec7f87d5..c49cdc9635932 100644\n--- a/shell/browser/native_window_mac.h\n+++ b/shell/browser/native_window_mac.h\n@@ -169,9 +169,6 @@ class NativeWindowMac : public NativeWindow,\n   void NotifyWindowDidFailToEnterFullScreen();\n   void NotifyWindowWillLeaveFullScreen();\n \n-  // views::WidgetDelegate:\n-  views::View* GetContentsView() override;\n-\n   // Cleanup observers when window is getting closed. Note that the destructor\n   // can be called much later after window gets closed, so we should not do\n   // cleanup in destructor.\n@@ -223,6 +220,7 @@ class NativeWindowMac : public NativeWindow,\n \n  protected:\n   // views::WidgetDelegate:\n+  views::View* GetContentsView() override;\n   bool CanMaximize() const override;\n   std::unique_ptr<views::NonClientFrameView> CreateNonClientFrameView(\n       views::Widget* widget) override;\ndiff --git a/shell/browser/native_window_mac.mm b/shell/browser/native_window_mac.mm\nindex dc483ee3fd3aa..2acea04280688 100644\n--- a/shell/browser/native_window_mac.mm\n+++ b/shell/browser/native_window_mac.mm\n@@ -194,6 +194,8 @@ static bool FromV8(v8::Isolate* isolate,\n   params.bounds = bounds;\n   params.delegate = this;\n   params.type = views::Widget::InitParams::TYPE_WINDOW;\n+  // Allow painting before shown, to be later disabled in ElectronNSWindow.\n+  params.headless_mode = true;\n   params.native_widget =\n       new ElectronNativeWidgetMac(this, windowType, styleMask, widget());\n   widget()->Init(std::move(params));\n@@ -1674,6 +1676,7 @@ static bool FromV8(v8::Isolate* isolate,\n   DCHECK(!IsClosed());\n   ui::NativeTheme::GetInstanceForNativeUi()->RemoveObserver(this);\n   display::Screen::GetScreen()->RemoveObserver(this);\n+  [window_ cleanup];\n }\n \n class NativeAppWindowFrameViewMac : public views::NativeFrameViewMac {\ndiff --git a/shell/browser/native_window_views.cc b/shell/browser/native_window_views.cc\nindex 1f6c3957c45ec..d5118ec346a8f 100644\n--- a/shell/browser/native_window_views.cc\n+++ b/shell/browser/native_window_views.cc\n@@ -27,6 +27,7 @@\n #include \"content/public/browser/desktop_media_id.h\"\n #include \"content/public/common/color_parser.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/views/root_view.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n #include \"shell/browser/web_view_manager.h\"\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.h b/shell/browser/ui/cocoa/delayed_native_view_host.h\ndeleted file mode 100644\nindex e7020dba60715..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.h\n+++ /dev/null\n@@ -1,33 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-\n-#include \"ui/views/controls/native/native_view_host.h\"\n-\n-namespace electron {\n-\n-// Automatically attach the native view after the NativeViewHost is attached to\n-// a widget. (Attaching it directly would cause crash.)\n-class DelayedNativeViewHost : public views::NativeViewHost {\n- public:\n-  explicit DelayedNativeViewHost(gfx::NativeView native_view);\n-  ~DelayedNativeViewHost() override;\n-\n-  // disable copy\n-  DelayedNativeViewHost(const DelayedNativeViewHost&) = delete;\n-  DelayedNativeViewHost& operator=(const DelayedNativeViewHost&) = delete;\n-\n-  // views::View:\n-  void ViewHierarchyChanged(\n-      const views::ViewHierarchyChangedDetails& details) override;\n-\n- private:\n-  gfx::NativeView native_view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.mm b/shell/browser/ui/cocoa/delayed_native_view_host.mm\ndeleted file mode 100644\nindex 38b0796555e1f..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.mm\n+++ /dev/null\n@@ -1,23 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-\n-namespace electron {\n-\n-DelayedNativeViewHost::DelayedNativeViewHost(gfx::NativeView native_view)\n-    : native_view_(native_view) {}\n-\n-DelayedNativeViewHost::~DelayedNativeViewHost() = default;\n-\n-void DelayedNativeViewHost::ViewHierarchyChanged(\n-    const views::ViewHierarchyChangedDetails& details) {\n-  if (!details.is_add && native_view())\n-    Detach();\n-  NativeViewHost::ViewHierarchyChanged(details);\n-  if (details.is_add && GetWidget() && !native_view())\n-    Attach(native_view_);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\ndeleted file mode 100644\nindex 4286312573aab..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-\n-#import <AppKit/AppKit.h>\n-\n-#include \"base/apple/owned_objc.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-\n-namespace electron {\n-class InspectableWebContentsViewMac;\n-}\n-\n-using electron::InspectableWebContentsViewMac;\n-\n-@interface NSView (WebContentsView)\n-- (void)setMouseDownCanMoveWindow:(BOOL)can_move;\n-@end\n-\n-@interface ElectronInspectableWebContentsView : BaseView <NSWindowDelegate> {\n- @private\n-  raw_ptr<electron::InspectableWebContentsViewMac> inspectableWebContentsView_;\n-\n-  NSView* __strong fake_view_;\n-  NSWindow* __strong devtools_window_;\n-  BOOL devtools_visible_;\n-  BOOL devtools_docked_;\n-  BOOL devtools_is_first_responder_;\n-  BOOL attached_to_window_;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-}\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view;\n-- (void)notifyDevToolsFocused;\n-- (void)setCornerRadii:(CGFloat)cornerRadius;\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate;\n-- (BOOL)isDevToolsVisible;\n-- (BOOL)isDevToolsFocused;\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate;\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy;\n-- (void)setTitle:(NSString*)title;\n-- (NSString*)getTitle;\n-\n-@end\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\ndeleted file mode 100644\nindex d719fc164e476..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\n+++ /dev/null\n@@ -1,337 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-\n-#include \"content/public/browser/render_widget_host_view.h\"\n-#include \"shell/browser/api/electron_api_web_contents.h\"\n-#include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-#include \"ui/gfx/mac/scoped_cocoa_disable_screen_updates.h\"\n-\n-@implementation ElectronInspectableWebContentsView\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view {\n-  self = [super init];\n-  if (!self)\n-    return nil;\n-\n-  inspectableWebContentsView_ = view;\n-  devtools_visible_ = NO;\n-  devtools_docked_ = NO;\n-  devtools_is_first_responder_ = NO;\n-  attached_to_window_ = NO;\n-\n-  if (inspectableWebContentsView_->inspectable_web_contents()->is_guest()) {\n-    fake_view_ = [[NSView alloc] init];\n-    [fake_view_ setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:fake_view_];\n-  } else {\n-    auto* contents = inspectableWebContentsView_->inspectable_web_contents()\n-                         ->GetWebContents();\n-    auto* contentsView = contents->GetNativeView().GetNativeNSView();\n-    [contentsView setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:contentsView];\n-  }\n-\n-  // See https://code.google.com/p/chromium/issues/detail?id=348490.\n-  [self setWantsLayer:YES];\n-\n-  return self;\n-}\n-\n-- (void)dealloc {\n-  [[NSNotificationCenter defaultCenter] removeObserver:self];\n-}\n-\n-- (void)resizeSubviewsWithOldSize:(NSSize)oldBoundsSize {\n-  [self adjustSubviews];\n-}\n-\n-- (void)viewDidMoveToWindow {\n-  if (attached_to_window_ && !self.window) {\n-    attached_to_window_ = NO;\n-    [[NSNotificationCenter defaultCenter] removeObserver:self];\n-  } else if (!attached_to_window_ && self.window) {\n-    attached_to_window_ = YES;\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(viewDidBecomeFirstResponder:)\n-               name:kViewDidBecomeFirstResponder\n-             object:nil];\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(parentWindowBecameMain:)\n-               name:NSWindowDidBecomeMainNotification\n-             object:nil];\n-  }\n-}\n-\n-- (IBAction)showDevTools:(id)sender {\n-  inspectableWebContentsView_->inspectable_web_contents()->ShowDevTools(true);\n-}\n-\n-- (void)notifyDevToolsFocused {\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsFocused();\n-}\n-\n-- (void)setCornerRadii:(CGFloat)cornerRadius {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-  webContentsView.wantsLayer = YES;\n-  webContentsView.layer.cornerRadius = cornerRadius;\n-}\n-\n-- (void)notifyDevToolsResized {\n-  // When devtools is opened, resizing devtools would not trigger\n-  // UpdateDraggableRegions for WebContents, so we have to notify the window\n-  // to do an update of draggable regions.\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsResized();\n-}\n-\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate {\n-  if (visible == devtools_visible_)\n-    return;\n-\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto* devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  devtools_visible_ = visible;\n-  if (devtools_docked_) {\n-    if (visible) {\n-      // Place the devToolsView under contentsView, notice that we didn't set\n-      // sizes for them until the setContentsResizingStrategy message.\n-      [self addSubview:devToolsView positioned:NSWindowBelow relativeTo:nil];\n-      [self adjustSubviews];\n-\n-      // Focus on web view.\n-      devToolsWebContents->RestoreFocus();\n-    } else {\n-      gfx::ScopedCocoaDisableScreenUpdates disabler;\n-      [devToolsView removeFromSuperview];\n-      [self adjustSubviews];\n-      [self notifyDevToolsResized];\n-    }\n-  } else {\n-    if (visible) {\n-      if (activate) {\n-        [devtools_window_ makeKeyAndOrderFront:nil];\n-      } else {\n-        [devtools_window_ orderBack:nil];\n-      }\n-    } else {\n-      [devtools_window_ setDelegate:nil];\n-      [devtools_window_ close];\n-      devtools_window_ = nil;\n-    }\n-  }\n-}\n-\n-- (BOOL)isDevToolsVisible {\n-  return devtools_visible_;\n-}\n-\n-- (BOOL)isDevToolsFocused {\n-  if (devtools_docked_) {\n-    return [[self window] isKeyWindow] && devtools_is_first_responder_;\n-  } else {\n-    return [devtools_window_ isKeyWindow];\n-  }\n-}\n-\n-// TODO: remove NSWindowStyleMaskTexturedBackground.\n-// https://github.com/electron/electron/issues/43125\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate {\n-  // Revert to no-devtools state.\n-  [self setDevToolsVisible:NO activate:NO];\n-\n-  // Switch to new state.\n-  devtools_docked_ = docked;\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-  if (!docked) {\n-    auto styleMask = NSWindowStyleMaskTitled | NSWindowStyleMaskClosable |\n-                     NSWindowStyleMaskMiniaturizable |\n-                     NSWindowStyleMaskResizable |\n-                     NSWindowStyleMaskTexturedBackground |\n-                     NSWindowStyleMaskUnifiedTitleAndToolbar;\n-    devtools_window_ = [[EventDispatchingWindow alloc]\n-        initWithContentRect:NSMakeRect(0, 0, 800, 600)\n-                  styleMask:styleMask\n-                    backing:NSBackingStoreBuffered\n-                      defer:YES];\n-    [devtools_window_ setDelegate:self];\n-    [devtools_window_ setFrameAutosaveName:@\"electron.devtools\"];\n-    [devtools_window_ setTitle:@\"Developer Tools\"];\n-    [devtools_window_ setReleasedWhenClosed:NO];\n-    [devtools_window_ setAutorecalculatesContentBorderThickness:NO\n-                                                        forEdge:NSMaxYEdge];\n-    [devtools_window_ setContentBorderThickness:24 forEdge:NSMaxYEdge];\n-\n-    NSView* contentView = [devtools_window_ contentView];\n-    devToolsView.frame = contentView.bounds;\n-    devToolsView.autoresizingMask = NSViewWidthSizable | NSViewHeightSizable;\n-\n-    [contentView addSubview:devToolsView];\n-    [devToolsView setMouseDownCanMoveWindow:NO];\n-  } else {\n-    [devToolsView setMouseDownCanMoveWindow:YES];\n-  }\n-  [self setDevToolsVisible:YES activate:activate];\n-}\n-\n-// -Wdeprecated-declarations\n-#pragma clang diagnostic pop\n-\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy {\n-  strategy_.CopyFrom(strategy);\n-  [self adjustSubviews];\n-}\n-\n-- (void)adjustSubviews {\n-  if (![[self subviews] count])\n-    return;\n-\n-  if (![self isDevToolsVisible] || devtools_window_) {\n-    DCHECK_EQ(1u, [[self subviews] count]);\n-    NSView* contents = [[self subviews] objectAtIndex:0];\n-    [contents setFrame:[self bounds]];\n-    return;\n-  }\n-\n-  NSView* devToolsView = [[self subviews] objectAtIndex:0];\n-  NSView* contentsView = [[self subviews] objectAtIndex:1];\n-\n-  DCHECK_EQ(2u, [[self subviews] count]);\n-\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, gfx::Size(NSSizeToCGSize([self bounds].size)),\n-      &new_devtools_bounds, &new_contents_bounds);\n-  [devToolsView setFrame:[self flipRectToNSRect:new_devtools_bounds]];\n-  [contentsView setFrame:[self flipRectToNSRect:new_contents_bounds]];\n-\n-  // Move mask to the devtools area to exclude it from dragging.\n-  NSRect cf = contentsView.frame;\n-  NSRect sb = [self bounds];\n-  NSRect devtools_frame;\n-  if (cf.size.height < sb.size.height) {  // bottom docked\n-    devtools_frame.origin.x = 0;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width;\n-    devtools_frame.size.height = sb.size.height - cf.size.height;\n-  } else {                // left or right docked\n-    if (cf.origin.x > 0)  // left docked\n-      devtools_frame.origin.x = 0;\n-    else  // right docked.\n-      devtools_frame.origin.x = cf.size.width;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width - cf.size.width;\n-    devtools_frame.size.height = sb.size.height;\n-  }\n-\n-  [self notifyDevToolsResized];\n-}\n-\n-- (void)setTitle:(NSString*)title {\n-  [devtools_window_ setTitle:title];\n-}\n-\n-- (NSString*)getTitle {\n-  return [devtools_window_ title];\n-}\n-\n-- (void)viewDidBecomeFirstResponder:(NSNotification*)notification {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-\n-  NSView* view = [notification object];\n-  if ([[webContentsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = NO;\n-    return;\n-  }\n-\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  if (!devToolsWebContents)\n-    return;\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  if ([[devToolsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = YES;\n-    [self notifyDevToolsFocused];\n-  }\n-}\n-\n-- (void)parentWindowBecameMain:(NSNotification*)notification {\n-  NSWindow* parentWindow = [notification object];\n-  if ([self window] == parentWindow && devtools_docked_ &&\n-      devtools_is_first_responder_)\n-    [self notifyDevToolsFocused];\n-}\n-\n-#pragma mark - NSWindowDelegate\n-\n-- (void)windowWillClose:(NSNotification*)notification {\n-  inspectableWebContentsView_->inspectable_web_contents()->CloseDevTools();\n-}\n-\n-- (void)windowDidBecomeMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->RestoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(true);\n-\n-  [self notifyDevToolsFocused];\n-}\n-\n-- (void)windowDidResignMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->StoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(false);\n-}\n-\n-@end\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.h b/shell/browser/ui/cocoa/electron_ns_window.h\nindex 502592313c15d..63ea5355467d4 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.h\n+++ b/shell/browser/ui/cocoa/electron_ns_window.h\n@@ -29,6 +29,8 @@ class ScopedDisableResize {\n \n }  // namespace electron\n \n+class ElectronNativeWindowObserver;\n+\n @interface ElectronNSWindow : NativeWidgetMacNSWindow {\n  @private\n   raw_ptr<electron::NativeWindowMac> shell_;\n@@ -41,6 +43,7 @@ class ScopedDisableResize {\n @property(nonatomic, retain) NSImage* cornerMask;\n - (id)initWithShell:(electron::NativeWindowMac*)shell\n           styleMask:(NSUInteger)styleMask;\n+- (void)cleanup;\n - (electron::NativeWindowMac*)shell;\n - (id)accessibilityFocusedUIElement;\n - (NSRect)originalContentRectForFrameRect:(NSRect)frameRect;\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.mm b/shell/browser/ui/cocoa/electron_ns_window.mm\nindex 5c5f1512f4a3e..30780277d3a5c 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window.mm\n@@ -8,8 +8,6 @@\n #include \"electron/mas.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/native_window_mac.h\"\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/cocoa/electron_preview_item.h\"\n #include \"shell/browser/ui/cocoa/electron_touch_bar.h\"\n #include \"shell/browser/ui/cocoa/root_view_mac.h\"\n@@ -113,6 +111,7 @@ void SwizzleSwipeWithEvent(NSView* view, SEL swiz_selector) {\n                            method_getImplementation(new_swipe_with_event));\n }\n #endif\n+\n }  // namespace\n \n @implementation ElectronNSWindow\n@@ -168,6 +167,10 @@ - (id)initWithShell:(electron::NativeWindowMac*)shell\n   return self;\n }\n \n+- (void)cleanup {\n+  shell_ = nullptr;\n+}\n+\n - (electron::NativeWindowMac*)shell {\n   return shell_;\n }\n@@ -255,6 +258,17 @@ - (void)setFrame:(NSRect)windowFrame display:(BOOL)displayViews {\n     [super setFrame:windowFrame display:displayViews];\n }\n \n+- (void)orderWindow:(NSWindowOrderingMode)place relativeTo:(NSInteger)otherWin {\n+  if (shell_) {\n+    // We initialize the window in headless mode to allow painting before it is\n+    // shown, but we don't want the headless behavior of allowing the window to\n+    // be placed unconstrained.\n+    self.isHeadless = false;\n+    shell_->widget()->DisableHeadlessMode();\n+  }\n+  [super orderWindow:place relativeTo:otherWin];\n+}\n+\n - (id)accessibilityAttributeValue:(NSString*)attribute {\n   if ([attribute isEqual:NSAccessibilityEnabledAttribute])\n     return [NSNumber numberWithBool:YES];\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\nindex d6af0ac6d9bb8..3f7c689bfc8b0 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n@@ -365,6 +365,19 @@ - (void)windowWillClose:(NSNotification*)notification {\n       shell_->GetNativeWindow());\n   auto* bridged_view = bridge_host->GetInProcessNSWindowBridge();\n   bridged_view->OnWindowWillClose();\n+\n+  // Native widget and its compositor have been destroyed upon close. We need\n+  // to detach contents view in order to prevent reusing its layer without\n+  // compositor in the `WebContentsViewMac::CreateViewForWidget`, leading to\n+  // `DCHECK` failure in `BrowserCompositorMac::SetParentUiLayer`.\n+  auto* contents_view =\n+      static_cast<views::WidgetDelegate*>(shell_)->GetContentsView();\n+  if (contents_view) {\n+    auto* parent = contents_view->parent();\n+    if (parent) {\n+      parent->RemoveChildView(contents_view);\n+    }\n+  }\n }\n \n - (BOOL)windowShouldClose:(id)window {\ndiff --git a/shell/browser/ui/inspectable_web_contents.cc b/shell/browser/ui/inspectable_web_contents.cc\nindex ea02168ef5596..75ebdd6441429 100644\n--- a/shell/browser/ui/inspectable_web_contents.cc\n+++ b/shell/browser/ui/inspectable_web_contents.cc\n@@ -297,11 +297,6 @@ class InspectableWebContents::NetworkResourceLoader\n   base::TimeDelta retry_delay_;\n };\n \n-// Implemented separately on each platform.\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents);\n-\n-// static\n // static\n void InspectableWebContents::RegisterPrefs(PrefRegistrySimple* registry) {\n   registry->RegisterDictionaryPref(kDevToolsBoundsPref,\n@@ -317,7 +312,7 @@ InspectableWebContents::InspectableWebContents(\n     : pref_service_(pref_service),\n       web_contents_(std::move(web_contents)),\n       is_guest_(is_guest),\n-      view_(CreateInspectableContentsView(this)) {\n+      view_(new InspectableWebContentsView(this)) {\n   const base::Value* bounds_dict =\n       &pref_service_->GetValue(kDevToolsBoundsPref);\n   if (bounds_dict->is_dict()) {\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.cc b/shell/browser/ui/inspectable_web_contents_view.cc\nindex 946b5071bcc87..e61f008414df4 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.cc\n+++ b/shell/browser/ui/inspectable_web_contents_view.cc\n@@ -5,12 +5,250 @@\n \n #include \"shell/browser/ui/inspectable_web_contents_view.h\"\n \n+#include <memory>\n+#include <utility>\n+\n+#include \"base/memory/raw_ptr.h\"\n+#include \"base/strings/utf_string_conversions.h\"\n+#include \"shell/browser/ui/drag_util.h\"\n+#include \"shell/browser/ui/inspectable_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n+#include \"ui/base/models/image_model.h\"\n+#include \"ui/views/controls/label.h\"\n+#include \"ui/views/controls/webview/webview.h\"\n+#include \"ui/views/widget/widget.h\"\n+#include \"ui/views/widget/widget_delegate.h\"\n+#include \"ui/views/window/client_view.h\"\n+\n namespace electron {\n \n+namespace {\n+\n+class DevToolsWindowDelegate : public views::ClientView,\n+                               public views::WidgetDelegate {\n+ public:\n+  DevToolsWindowDelegate(InspectableWebContentsView* shell,\n+                         views::View* view,\n+                         views::Widget* widget)\n+      : views::ClientView(widget, view),\n+        shell_(shell),\n+        view_(view),\n+        widget_(widget) {\n+    SetOwnedByWidget(true);\n+    set_owned_by_client();\n+\n+    if (shell->GetDelegate())\n+      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n+  }\n+  ~DevToolsWindowDelegate() override = default;\n+\n+  // disable copy\n+  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n+  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n+\n+  // views::WidgetDelegate:\n+  views::View* GetInitiallyFocusedView() override { return view_; }\n+  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n+  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n+  ui::ImageModel GetWindowIcon() override { return icon_; }\n+  views::Widget* GetWidget() override { return widget_; }\n+  const views::Widget* GetWidget() const override { return widget_; }\n+  views::View* GetContentsView() override { return view_; }\n+  views::ClientView* CreateClientView(views::Widget* widget) override {\n+    return this;\n+  }\n+\n+  // views::ClientView:\n+  views::CloseRequestResult OnWindowCloseRequested() override {\n+    shell_->inspectable_web_contents()->CloseDevTools();\n+    return views::CloseRequestResult::kCannotClose;\n+  }\n+\n+ private:\n+  raw_ptr<InspectableWebContentsView> shell_;\n+  raw_ptr<views::View> view_;\n+  raw_ptr<views::Widget> widget_;\n+  ui::ImageModel icon_;\n+};\n+\n+}  // namespace\n+\n InspectableWebContentsView::InspectableWebContentsView(\n     InspectableWebContents* inspectable_web_contents)\n-    : inspectable_web_contents_(inspectable_web_contents) {}\n+    : inspectable_web_contents_(inspectable_web_contents),\n+      devtools_web_view_(new views::WebView(nullptr)),\n+      title_(u\"Developer Tools\") {\n+  if (!inspectable_web_contents_->is_guest() &&\n+      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n+    auto* contents_web_view = new views::WebView(nullptr);\n+    contents_web_view->SetWebContents(\n+        inspectable_web_contents_->GetWebContents());\n+    contents_web_view_ = contents_web_view;\n+  } else {\n+    no_contents_view_ = new views::Label(u\"No content under offscreen mode\");\n+  }\n+\n+  devtools_web_view_->SetVisible(false);\n+  AddChildView(devtools_web_view_.get());\n+  AddChildView(GetContentsView());\n+}\n+\n+InspectableWebContentsView::~InspectableWebContentsView() {\n+  if (devtools_window_)\n+    inspectable_web_contents()->SaveDevToolsBounds(\n+        devtools_window_->GetWindowBoundsInScreen());\n+}\n+\n+void InspectableWebContentsView::SetCornerRadii(\n+    const gfx::RoundedCornersF& corner_radii) {\n+  // WebView won't exist for offscreen rendering.\n+  if (contents_web_view_) {\n+    contents_web_view_->holder()->SetCornerRadii(corner_radii);\n+  }\n+}\n+\n+void InspectableWebContentsView::ShowDevTools(bool activate) {\n+  if (devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = true;\n+  if (devtools_window_) {\n+    devtools_window_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n+    if (activate) {\n+      devtools_window_->Show();\n+    } else {\n+      devtools_window_->ShowInactive();\n+    }\n+\n+    // Update draggable regions to account for the new dock position.\n+    if (GetDelegate())\n+      GetDelegate()->DevToolsResized();\n+  } else {\n+    devtools_web_view_->SetVisible(true);\n+    devtools_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_web_view_->RequestFocus();\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+void InspectableWebContentsView::CloseDevTools() {\n+  if (!devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = false;\n+  if (devtools_window_) {\n+    auto save_bounds = devtools_window_->IsMinimized()\n+                           ? devtools_window_->GetRestoredBounds()\n+                           : devtools_window_->GetWindowBoundsInScreen();\n+    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n+\n+    devtools_window_.reset();\n+    devtools_window_web_view_ = nullptr;\n+    devtools_window_delegate_ = nullptr;\n+  } else {\n+    devtools_web_view_->SetVisible(false);\n+    devtools_web_view_->SetWebContents(nullptr);\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewShowing() {\n+  return devtools_visible_;\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewFocused() {\n+  if (devtools_window_web_view_)\n+    return devtools_window_web_view_->HasFocus();\n+  else if (devtools_web_view_)\n+    return devtools_web_view_->HasFocus();\n+  else\n+    return false;\n+}\n+\n+void InspectableWebContentsView::SetIsDocked(bool docked, bool activate) {\n+  CloseDevTools();\n+\n+  if (!docked) {\n+    devtools_window_ = std::make_unique<views::Widget>();\n+    devtools_window_web_view_ = new views::WebView(nullptr);\n+    devtools_window_delegate_ = new DevToolsWindowDelegate(\n+        this, devtools_window_web_view_, devtools_window_.get());\n+\n+    views::Widget::InitParams params(\n+        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET,\n+        views::Widget::InitParams::TYPE_WINDOW);\n+    params.delegate = devtools_window_delegate_;\n+    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n+\n+#if BUILDFLAG(IS_LINUX)\n+    params.wm_role_name = \"devtools\";\n+    if (GetDelegate())\n+      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n+                                              &params.wm_class_class);\n+#endif\n+\n+    devtools_window_->Init(std::move(params));\n+    devtools_window_->UpdateWindowIcon();\n+    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n+  }\n+\n+  ShowDevTools(activate);\n+}\n+\n+void InspectableWebContentsView::SetContentsResizingStrategy(\n+    const DevToolsContentsResizingStrategy& strategy) {\n+  strategy_.CopyFrom(strategy);\n+  DeprecatedLayoutImmediately();\n+}\n+\n+void InspectableWebContentsView::SetTitle(const std::u16string& title) {\n+  if (devtools_window_) {\n+    title_ = title;\n+    devtools_window_->UpdateWindowTitle();\n+  }\n+}\n+\n+const std::u16string InspectableWebContentsView::GetTitle() {\n+  return title_;\n+}\n+\n+void InspectableWebContentsView::Layout(PassKey) {\n+  if (!devtools_web_view_->GetVisible()) {\n+    GetContentsView()->SetBoundsRect(GetContentsBounds());\n+    // Propagate layout call to all children, for example browser views.\n+    LayoutSuperclass<View>(this);\n+    return;\n+  }\n+\n+  gfx::Size container_size(width(), height());\n+  gfx::Rect new_devtools_bounds;\n+  gfx::Rect new_contents_bounds;\n+  ApplyDevToolsContentsResizingStrategy(\n+      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n+\n+  // DevTools cares about the specific position, so we have to compensate RTL\n+  // layout here.\n+  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n+  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n+\n+  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n+  GetContentsView()->SetBoundsRect(new_contents_bounds);\n+\n+  // Propagate layout call to all children, for example browser views.\n+  LayoutSuperclass<View>(this);\n+\n+  if (GetDelegate())\n+    GetDelegate()->DevToolsResized();\n+}\n+\n+views::View* InspectableWebContentsView::GetContentsView() const {\n+  DCHECK(contents_web_view_ || no_contents_view_);\n \n-InspectableWebContentsView::~InspectableWebContentsView() = default;\n+  return contents_web_view_ ? contents_web_view_ : no_contents_view_;\n+}\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.h b/shell/browser/ui/inspectable_web_contents_view.h\nindex a9c95d477e00d..282d3bf805a97 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.h\n+++ b/shell/browser/ui/inspectable_web_contents_view.h\n@@ -9,13 +9,9 @@\n #include <string>\n \n #include \"base/memory/raw_ptr.h\"\n-#include \"build/build_config.h\"\n-\n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-#include \"ui/views/view.h\"\n-#else\n+#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n #include \"ui/gfx/native_widget_types.h\"\n-#endif\n+#include \"ui/views/view.h\"\n \n class DevToolsContentsResizingStrategy;\n \n@@ -23,23 +19,22 @@ namespace gfx {\n class RoundedCornersF;\n }  // namespace gfx\n \n-#if defined(TOOLKIT_VIEWS)\n namespace views {\n-class View;\n class WebView;\n+class Widget;\n+class WidgetDelegate;\n }  // namespace views\n-#endif\n \n namespace electron {\n \n class InspectableWebContents;\n class InspectableWebContentsViewDelegate;\n \n-class InspectableWebContentsView {\n+class InspectableWebContentsView : public views::View {\n  public:\n   explicit InspectableWebContentsView(\n       InspectableWebContents* inspectable_web_contents);\n-  virtual ~InspectableWebContentsView();\n+  ~InspectableWebContentsView() override;\n \n   InspectableWebContents* inspectable_web_contents() {\n     return inspectable_web_contents_;\n@@ -51,32 +46,40 @@ class InspectableWebContentsView {\n   }\n   InspectableWebContentsViewDelegate* GetDelegate() const { return delegate_; }\n \n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-  // Returns the container control, which has devtools view attached.\n-  virtual views::View* GetView() = 0;\n-#else\n-  virtual gfx::NativeView GetNativeView() const = 0;\n-#endif\n-\n-  virtual void ShowDevTools(bool activate) = 0;\n-  virtual void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) = 0;\n-  // Hide the DevTools view.\n-  virtual void CloseDevTools() = 0;\n-  virtual bool IsDevToolsViewShowing() = 0;\n-  virtual bool IsDevToolsViewFocused() = 0;\n-  virtual void SetIsDocked(bool docked, bool activate) = 0;\n-  virtual void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) = 0;\n-  virtual void SetTitle(const std::u16string& title) = 0;\n-  virtual const std::u16string GetTitle() = 0;\n-\n- protected:\n+  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii);\n+\n+  void ShowDevTools(bool activate);\n+  void CloseDevTools();\n+  bool IsDevToolsViewShowing();\n+  bool IsDevToolsViewFocused();\n+  void SetIsDocked(bool docked, bool activate);\n+  void SetContentsResizingStrategy(\n+      const DevToolsContentsResizingStrategy& strategy);\n+  void SetTitle(const std::u16string& title);\n+  const std::u16string GetTitle();\n+\n+  // views::View:\n+  void Layout(PassKey) override;\n+\n+ private:\n+  views::View* GetContentsView() const;\n+\n   // Owns us.\n   raw_ptr<InspectableWebContents> inspectable_web_contents_;\n \n- private:\n   raw_ptr<InspectableWebContentsViewDelegate> delegate_ =\n       nullptr;  // weak references.\n+\n+  std::unique_ptr<views::Widget> devtools_window_;\n+  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n+  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n+  raw_ptr<views::View> no_contents_view_ = nullptr;\n+  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n+\n+  DevToolsContentsResizingStrategy strategy_;\n+  bool devtools_visible_ = false;\n+  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n+  std::u16string title_;\n };\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.h b/shell/browser/ui/inspectable_web_contents_view_mac.h\ndeleted file mode 100644\nindex 88b4078614f42..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.h\n+++ /dev/null\n@@ -1,42 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-#define ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-\n-@class ElectronInspectableWebContentsView;\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewMac : public InspectableWebContentsView {\n- public:\n-  explicit InspectableWebContentsViewMac(\n-      InspectableWebContents* inspectable_web_contents);\n-  InspectableWebContentsViewMac(const InspectableWebContentsViewMac&) = delete;\n-  InspectableWebContentsViewMac& operator=(\n-      const InspectableWebContentsViewMac&) = delete;\n-  ~InspectableWebContentsViewMac() override;\n-\n-  gfx::NativeView GetNativeView() const override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void ShowDevTools(bool activate) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n- private:\n-  ElectronInspectableWebContentsView* __strong view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.mm b/shell/browser/ui/inspectable_web_contents_view_mac.mm\ndeleted file mode 100644\nindex a3789e09a8fb3..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.mm\n+++ /dev/null\n@@ -1,75 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-\n-#include \"base/strings/sys_string_conversions.h\"\n-#import \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-\n-namespace electron {\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewMac(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewMac::InspectableWebContentsViewMac(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      view_([[ElectronInspectableWebContentsView alloc]\n-          initWithInspectableWebContentsViewMac:this]) {}\n-\n-InspectableWebContentsViewMac::~InspectableWebContentsViewMac() {\n-  [[NSNotificationCenter defaultCenter] removeObserver:view_];\n-  CloseDevTools();\n-}\n-\n-gfx::NativeView InspectableWebContentsViewMac::GetNativeView() const {\n-  return view_;\n-}\n-\n-void InspectableWebContentsViewMac::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // We can assume all four values are identical.\n-  [view_ setCornerRadii:corner_radii.upper_left()];\n-}\n-\n-void InspectableWebContentsViewMac::ShowDevTools(bool activate) {\n-  [view_ setDevToolsVisible:YES activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::CloseDevTools() {\n-  [view_ setDevToolsVisible:NO activate:NO];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewShowing() {\n-  return [view_ isDevToolsVisible];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewFocused() {\n-  return [view_ isDevToolsFocused];\n-}\n-\n-void InspectableWebContentsViewMac::SetIsDocked(bool docked, bool activate) {\n-  [view_ setIsDocked:docked activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  [view_ setContentsResizingStrategy:strategy];\n-}\n-\n-void InspectableWebContentsViewMac::SetTitle(const std::u16string& title) {\n-  [view_ setTitle:base::SysUTF16ToNSString(title)];\n-}\n-\n-const std::u16string InspectableWebContentsViewMac::GetTitle() {\n-  return base::SysNSStringToUTF16([view_ getTitle]);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/frameless_view.cc b/shell/browser/ui/views/frameless_view.cc\nindex c963d1731093a..dcfed5ef695f0 100644\n--- a/shell/browser/ui/views/frameless_view.cc\n+++ b/shell/browser/ui/views/frameless_view.cc\n@@ -5,6 +5,8 @@\n #include \"shell/browser/ui/views/frameless_view.h\"\n \n #include \"shell/browser/native_window_views.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n+#include \"ui/aura/window.h\"\n #include \"ui/base/hit_test.h\"\n #include \"ui/base/metadata/metadata_impl_macros.h\"\n #include \"ui/views/widget/widget.h\"\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.cc b/shell/browser/ui/views/inspectable_web_contents_view_views.cc\ndeleted file mode 100644\nindex 61a5b013ecb12..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.cc\n+++ /dev/null\n@@ -1,257 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/views/inspectable_web_contents_view_views.h\"\n-\n-#include <memory>\n-#include <utility>\n-\n-#include \"base/memory/raw_ptr.h\"\n-#include \"shell/browser/ui/drag_util.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/base/models/image_model.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-#include \"ui/views/controls/label.h\"\n-#include \"ui/views/controls/webview/webview.h\"\n-#include \"ui/views/widget/widget.h\"\n-#include \"ui/views/widget/widget_delegate.h\"\n-#include \"ui/views/window/client_view.h\"\n-\n-namespace electron {\n-\n-namespace {\n-\n-class DevToolsWindowDelegate : public views::ClientView,\n-                               public views::WidgetDelegate {\n- public:\n-  DevToolsWindowDelegate(InspectableWebContentsViewViews* shell,\n-                         views::View* view,\n-                         views::Widget* widget)\n-      : views::ClientView(widget, view),\n-        shell_(shell),\n-        view_(view),\n-        widget_(widget) {\n-    SetOwnedByWidget(true);\n-    set_owned_by_client();\n-\n-    if (shell->GetDelegate())\n-      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n-  }\n-  ~DevToolsWindowDelegate() override = default;\n-\n-  // disable copy\n-  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n-  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n-\n-  // views::WidgetDelegate:\n-  views::View* GetInitiallyFocusedView() override { return view_; }\n-  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n-  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n-  ui::ImageModel GetWindowIcon() override { return icon_; }\n-  views::Widget* GetWidget() override { return widget_; }\n-  const views::Widget* GetWidget() const override { return widget_; }\n-  views::View* GetContentsView() override { return view_; }\n-  views::ClientView* CreateClientView(views::Widget* widget) override {\n-    return this;\n-  }\n-\n-  // views::ClientView:\n-  views::CloseRequestResult OnWindowCloseRequested() override {\n-    shell_->inspectable_web_contents()->CloseDevTools();\n-    return views::CloseRequestResult::kCannotClose;\n-  }\n-\n- private:\n-  raw_ptr<InspectableWebContentsViewViews> shell_;\n-  raw_ptr<views::View> view_;\n-  raw_ptr<views::Widget> widget_;\n-  ui::ImageModel icon_;\n-};\n-\n-}  // namespace\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewViews(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewViews::InspectableWebContentsViewViews(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      devtools_web_view_(new views::WebView(nullptr)),\n-      title_(u\"Developer Tools\") {\n-  if (!inspectable_web_contents_->is_guest() &&\n-      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n-    auto* contents_web_view = new views::WebView(nullptr);\n-    contents_web_view->SetWebContents(\n-        inspectable_web_contents_->GetWebContents());\n-    contents_view_ = contents_web_view_ = contents_web_view;\n-  } else {\n-    contents_view_ = new views::Label(u\"No content under offscreen mode\");\n-  }\n-\n-  devtools_web_view_->SetVisible(false);\n-  AddChildView(devtools_web_view_.get());\n-  AddChildView(contents_view_.get());\n-}\n-\n-InspectableWebContentsViewViews::~InspectableWebContentsViewViews() {\n-  if (devtools_window_)\n-    inspectable_web_contents()->SaveDevToolsBounds(\n-        devtools_window_->GetWindowBoundsInScreen());\n-}\n-\n-views::View* InspectableWebContentsViewViews::GetView() {\n-  return this;\n-}\n-\n-void InspectableWebContentsViewViews::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // WebView won't exist for offscreen rendering.\n-  if (contents_web_view_) {\n-    contents_web_view_->holder()->SetCornerRadii(\n-        gfx::RoundedCornersF(corner_radii));\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::ShowDevTools(bool activate) {\n-  if (devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = true;\n-  if (devtools_window_) {\n-    devtools_window_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n-    if (activate) {\n-      devtools_window_->Show();\n-    } else {\n-      devtools_window_->ShowInactive();\n-    }\n-\n-    // Update draggable regions to account for the new dock position.\n-    if (GetDelegate())\n-      GetDelegate()->DevToolsResized();\n-  } else {\n-    devtools_web_view_->SetVisible(true);\n-    devtools_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_web_view_->RequestFocus();\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::CloseDevTools() {\n-  if (!devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = false;\n-  if (devtools_window_) {\n-    auto save_bounds = devtools_window_->IsMinimized()\n-                           ? devtools_window_->GetRestoredBounds()\n-                           : devtools_window_->GetWindowBoundsInScreen();\n-    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n-\n-    devtools_window_.reset();\n-    devtools_window_web_view_ = nullptr;\n-    devtools_window_delegate_ = nullptr;\n-  } else {\n-    devtools_web_view_->SetVisible(false);\n-    devtools_web_view_->SetWebContents(nullptr);\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewShowing() {\n-  return devtools_visible_;\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewFocused() {\n-  if (devtools_window_web_view_)\n-    return devtools_window_web_view_->HasFocus();\n-  else if (devtools_web_view_)\n-    return devtools_web_view_->HasFocus();\n-  else\n-    return false;\n-}\n-\n-void InspectableWebContentsViewViews::SetIsDocked(bool docked, bool activate) {\n-  CloseDevTools();\n-\n-  if (!docked) {\n-    devtools_window_ = std::make_unique<views::Widget>();\n-    devtools_window_web_view_ = new views::WebView(nullptr);\n-    devtools_window_delegate_ = new DevToolsWindowDelegate(\n-        this, devtools_window_web_view_, devtools_window_.get());\n-\n-    views::Widget::InitParams params{\n-        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET};\n-    params.ownership = views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;\n-    params.delegate = devtools_window_delegate_;\n-    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n-\n-#if BUILDFLAG(IS_LINUX)\n-    params.wm_role_name = \"devtools\";\n-    if (GetDelegate())\n-      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n-                                              &params.wm_class_class);\n-#endif\n-\n-    devtools_window_->Init(std::move(params));\n-    devtools_window_->UpdateWindowIcon();\n-    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n-  }\n-\n-  ShowDevTools(activate);\n-}\n-\n-void InspectableWebContentsViewViews::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  strategy_.CopyFrom(strategy);\n-  DeprecatedLayoutImmediately();\n-}\n-\n-void InspectableWebContentsViewViews::SetTitle(const std::u16string& title) {\n-  if (devtools_window_) {\n-    title_ = title;\n-    devtools_window_->UpdateWindowTitle();\n-  }\n-}\n-\n-const std::u16string InspectableWebContentsViewViews::GetTitle() {\n-  return title_;\n-}\n-\n-void InspectableWebContentsViewViews::Layout(PassKey) {\n-  if (!devtools_web_view_->GetVisible()) {\n-    contents_view_->SetBoundsRect(GetContentsBounds());\n-    // Propagate layout call to all children, for example browser views.\n-    LayoutSuperclass<View>(this);\n-    return;\n-  }\n-\n-  gfx::Size container_size(width(), height());\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n-\n-  // DevTools cares about the specific position, so we have to compensate RTL\n-  // layout here.\n-  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n-  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n-\n-  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n-  contents_view_->SetBoundsRect(new_contents_bounds);\n-\n-  // Propagate layout call to all children, for example browser views.\n-  LayoutSuperclass<View>(this);\n-\n-  if (GetDelegate())\n-    GetDelegate()->DevToolsResized();\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.h b/shell/browser/ui/views/inspectable_web_contents_view_views.h\ndeleted file mode 100644\nindex 36554a497d6f2..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.h\n+++ /dev/null\n@@ -1,63 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-#define ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-\n-#include <memory>\n-\n-#include \"base/compiler_specific.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-#include \"third_party/skia/include/core/SkRegion.h\"\n-#include \"ui/views/view.h\"\n-\n-namespace views {\n-class WebView;\n-class Widget;\n-class WidgetDelegate;\n-}  // namespace views\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewViews : public InspectableWebContentsView,\n-                                        public views::View {\n- public:\n-  explicit InspectableWebContentsViewViews(\n-      InspectableWebContents* inspectable_web_contents);\n-  ~InspectableWebContentsViewViews() override;\n-\n-  // InspectableWebContentsView:\n-  views::View* GetView() override;\n-  void ShowDevTools(bool activate) override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n-  // views::View:\n-  void Layout(PassKey) override;\n-\n- private:\n-  std::unique_ptr<views::Widget> devtools_window_;\n-  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n-  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n-  raw_ptr<views::View> contents_view_ = nullptr;\n-  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-  bool devtools_visible_ = false;\n-  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n-  std::u16string title_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n", "test_patch": "", "problem_statement": "[Bug]: EXCEPTION_ACCESS_VIOLATION crash on `BrowserWindow.destroy()`\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n \\>=v31.0.0 (tested v31.0.0, v31.2.1, v32.0.0-aplha.10)\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nWindows 10 22H2\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nv30.3.0 (and everything below it)\r\n\r\n### Expected Behavior\r\n\r\n```js\r\nchildWindow.once('close', () => {\r\n    // do some cleanup etc\r\n    childWindow.destroy();;\r\n});\r\n```\r\n\r\nshouldn't crash Electron\r\n\r\n\r\n### Actual Behavior\r\n\r\n```js\r\nfunction cleanup() {\r\n\t// do some cleanup etc\r\n    childWindow.destroy();;\r\n}\r\nipcMain.once(`done`, cleanup);\r\nchildWindow.once('close', cleanup);\r\n```\r\nif `done` ipc event is not called and the window is manually closed, the window is destroyed and a few moments later The main Electron process crash with the following trace:\r\n\r\n<details><summary>Stacktrace Windows</summary>\r\n<p>\r\n\r\n```\r\nReceived fatal exception EXCEPTION_ACCESS_VIOLATION\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03CB9E08+3764424]\r\nv8::HeapStatistics::external_memory [0x00A48A12+8338]\r\ncppgc::internal::SameThreadEnabledCheckingPolicyBase::SameThreadEnabledCheckingPolicyBase [0x00B0DE72+28834]\r\nuv_req_get_data [0x022485EE+4269966]\r\nuv_req_get_data [0x02248AAA+4271178]\r\nuv_stream_get_write_queue_size [0x0277DBD5+2462421]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nsqlite3_dbdata_init [0x068DC9A7+2609367]\r\nuv_stream_get_write_queue_size [0x0277E07F+2463615]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nuv_stream_get_write_queue_size [0x0277D3B9+2460345]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nDispatchMessageW [0x76976901+1265]\r\nDispatchMessageW [0x76976420+16]\r\nuv_os_getpid [0x01D81F00+6592]\r\nuv_os_getpid [0x01D81B5B+5659]\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03C980DB+3625883]\r\nuv_os_getpid [0x01D817FB+4795]\r\nGetHandleVerifier [0x0232C67C+61788]\r\nuv_os_getpid [0x01DA8F14+166356]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169DD19+2893273]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169F5FE+2899646]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169B4AF+2882927]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DF37+3175]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EFF0+7456]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EEB7+7143]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9D88E+1470]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DA11+1857]\r\nv8::SourceLocation::SourceLocation [0x00960B7D+46669]\r\nv8::SourceLocation::SourceLocation [0x00960721+45553]\r\nGetNumaHighestNodeNumber [0x77682911+161]\r\nGetNumaHighestNodeNumber [0x776828C6+86]\r\nRtlUserFiberStart [0x77EC2DC7+23]\r\n\r\nElectron exited with code 3221226525.\r\n```\r\n\r\n</p>\r\n</details> \r\n\r\n### Testcase Gist URL\r\n\r\n> To reproduce, click the menu item then manually close the window that appears\r\n\r\nNo dependencies:\r\n\r\nhttps://gist.github.com/Araxeus/4e80b05c8bce61a5fe709eec1e969f2b\r\n\r\nOriginal issue:\r\n\r\nhttps://gist.github.com/Araxeus/6548ef4f3438d35d1713d5fd69c3b494\r\n\r\n### Additional Information\r\n\r\n* test repo: https://github.com/Aetherinox/electron-prompts\r\n* related issue: https://github.com/Araxeus/custom-electron-prompt/issues/26\n", "hints_text": "<details><summary>Stacktrace on macOS</summary>\r\n<p>\r\n\r\n```\r\n[80356:0722/110229.619327:FATAL:lock_impl_posix.cc(46)] Check failed: rv == 0 || rv == EBUSY. . Invalid argument. Hint: This is often related to a use-after-free.\r\n0   Electron Framework                  0x000000011b902974 base::debug::CollectStackTrace(void const**, unsigned long) + 28\r\n1   Electron Framework                  0x000000011b8f225c base::debug::StackTrace::StackTrace() + 80\r\n2   Electron Framework                  0x000000011b821800 logging::LogMessage::Flush() + 152\r\n3   Electron Framework                  0x000000011b8216f4 logging::LogMessage::~LogMessage() + 36\r\n4   Electron Framework                  0x000000011b80a568 logging::(anonymous namespace)::DCheckLogMessage::~DCheckLogMessage() + 124\r\n5   Electron Framework                  0x000000011b80a5b8 logging::(anonymous namespace)::DCheckLogMessage::~DCheckLogMessage() + 12\r\n6   Electron Framework                  0x000000011b80a034 logging::CheckError::~CheckError() + 44\r\n7   Electron Framework                  0x000000011b80a09c logging::CheckError::~CheckError() + 12\r\n8   Electron Framework                  0x000000011b8f0594 base::internal::dcheck_trylock_result(int) + 176\r\n9   Electron Framework                  0x000000011b8720c4 base::Lock::Acquire(base::subtle::LockTracking) + 44\r\n10  Electron Framework                  0x000000011b85c204 base::SequenceCheckerImpl::CalledOnValidSequence(std::__Cr::unique_ptr<base::debug::StackTrace, std::__Cr::default_delete<base::debug::StackTrace>>*) const + 44\r\n11  Electron Framework                  0x000000011b85be80 base::ScopedValidateSequenceChecker::ScopedValidateSequenceChecker(base::SequenceCheckerImpl const&) + 40\r\n12  Electron Framework                  0x000000011661bdc0 electron::NativeWindow::NotifyWindowCloseButtonClicked() + 624\r\n13  Electron Framework                  0x000000011672c2fc -[ElectronNSWindowDelegate windowShouldClose:] + 208\r\n14  AppKit                              0x0000000194831d9c __19-[NSWindow __close]_block_invoke + 160\r\n15  AppKit                              0x0000000194831ccc -[NSWindow __close] + 400\r\n16  AppKit                              0x00000001947120e8 -[NSApplication(NSResponder) sendAction:to:from:] + 460\r\n17  AppKit                              0x0000000194711eec -[NSControl sendAction:to:] + 72\r\n18  AppKit                              0x0000000194711e30 __26-[NSCell _sendActionFrom:]_block_invoke + 100\r\n19  AppKit                              0x0000000194711d58 -[NSCell _sendActionFrom:] + 204\r\n20  AppKit                              0x0000000194711c7c -[NSButtonCell _sendActionFrom:] + 88\r\n21  AppKit                              0x000000019470f268 NSControlTrackMouse + 1480\r\n22  AppKit                              0x000000019470ec74 -[NSCell trackMouse:inRect:ofView:untilMouseUp:] + 144\r\n23  AppKit                              0x000000019470eb2c -[NSButtonCell trackMouse:inRect:ofView:untilMouseUp:] + 488\r\n24  AppKit                              0x000000019470e000 -[NSControl mouseDown:] + 448\r\n25  AppKit                              0x000000019470cdcc -[NSWindow(NSEventRouting) _handleMouseDownEvent:isDelayedEvent:] + 3472\r\n26  AppKit                              0x000000019469840c -[NSWindow(NSEventRouting) _reallySendEvent:isDelayedEvent:] + 288\r\n27  AppKit                              0x0000000194698118 -[NSWindow(NSEventRouting) sendEvent:] + 284\r\n28  Electron Framework                  0x000000011d53614c -[NativeWidgetMacNSWindow sendEvent:] + 604\r\n29  AppKit                              0x0000000194d60828 -[NSApplication(NSEventRouting) sendEvent:] + 1604\r\n30  Electron Framework                  0x000000011670bc6c -[AtomApplication sendEvent:] + 128\r\n31  AppKit                              0x00000001949ae89c -[NSApplication _handleEvent:] + 60\r\n32  AppKit                              0x000000019455f0c0 -[NSApplication run] + 512\r\n33  Electron Framework                  0x000000011b910b9c base::MessagePumpNSApplication::DoRun(base::MessagePump::Delegate*) + 396\r\n34  Electron Framework                  0x000000011b90eabc base::MessagePumpCFRunLoopBase::Run(base::MessagePump::Delegate*) + 112\r\n35  Electron Framework                  0x000000011b8a8210 base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) + 692\r\n36  Electron Framework                  0x000000011b856af8 base::RunLoop::Run(base::Location const&) + 952\r\n37  Electron Framework                  0x000000011a31f818 content::BrowserMainLoop::RunMainMessageLoop() + 180\r\n38  Electron Framework                  0x000000011a321740 content::BrowserMainRunnerImpl::Run() + 48\r\n39  Electron Framework                  0x000000011a31c278 content::BrowserMain(content::MainFunctionParams) + 164\r\n40  Electron Framework                  0x00000001168c6e0c content::RunBrowserProcessMain(content::MainFunctionParams, content::ContentMainDelegate*) + 176\r\n41  Electron Framework                  0x00000001168c93c0 content::ContentMainRunnerImpl::RunBrowser(content::MainFunctionParams, bool) + 1824\r\n42  Electron Framework                  0x00000001168c8b78 content::ContentMainRunnerImpl::Run() + 952\r\n43  Electron Framework                  0x00000001168c64a8 content::RunContentProcess(content::ContentMainParams, content::ContentMainRunner*) + 1200\r\n44  Electron Framework                  0x00000001168c66f0 content::ContentMain(content::ContentMainParams) + 112\r\n45  Electron Framework                  0x00000001164b2c98 ElectronMain + 320\r\n46  dyld                                0x00000001908a60e0 start + 2360\r\nCrash keys:\r\n  \"ever_had_universal_access_exemption\" = \"true\"\r\n  \"amfi-status\" = \"rv=0 status=0x0 allow_everything=0\"\r\n  \"platform\" = \"darwin\"\r\n  \"process_type\" = \"browser\"\r\n\r\nElectron exited with signal SIGTRAP.\r\n```\r\n\r\n</p>\r\n</details> \r\n\r\nTracked to https://github.com/electron/electron/commit/e67ab9a93dadccecff30de50ab4555191c30b6c4\nClosed by https://github.com/electron/electron/pull/43033\n> Closed by https://github.com/electron/electron/pull/43033\n\nIt says the PR is for MacOS but this issue was reported on Windows?", "created_at": "2025-01-17 15:21:25", "merge_commit_sha": "91bb748eaa575cb45dafcf243f761e51900ae2e5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45195", "base_commit": "74c6669a8e3d1c8627c48842da2b0b0ce398ed70", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex f6471212332bf..671a98a5b49d5 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -139,3 +139,4 @@ build_disable_thin_lto_mac.patch\n build_add_public_config_simdutf_config.patch\n revert_code_health_clean_up_stale_macwebcontentsocclusion.patch\n build_remove_vr_directx_helpers_dependency.patch\n+ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\ndiff --git a/patches/chromium/ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch b/patches/chromium/ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\nnew file mode 100644\nindex 0000000000000..6f97dd9b9ce80\n--- /dev/null\n+++ b/patches/chromium/ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\n@@ -0,0 +1,40 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: =?UTF-8?q?David=20L=C3=B6nnhager?= <dv.lnh.d@gmail.com>\n+Date: Fri, 17 Jan 2025 14:30:48 +0100\n+Subject: Ignore parse errors for PKEY_AppUserModel_ToastActivatorCLSID\n+\n+Some shortcuts store this as a string UUID as opposed to VT_CLSID,\n+hitting NOTREACHED() and sometimes breaking parsing in Electron.\n+Ignore this error instead.\n+\n+Bug: N/A\n+Change-Id: I9fc472212b2d3afac2c8e18a2159bc2d50bbdf98\n+\n+diff --git a/AUTHORS b/AUTHORS\n+index 55dc38c1448c1960b802c136018c8be22ed61c18..5cd195df3650331fbfd62b2f964368b5f3217f3c 100644\n+--- a/AUTHORS\n++++ b/AUTHORS\n+@@ -337,6 +337,7 @@ David Futcher <david.mike.futcher@gmail.com>\n+ David Jin <davidjin@amazon.com>\n+ David Lechner <david@pybricks.com>\n+ David Leen <davileen@amazon.com>\n++David L\u00f6nnhager <dv.lnh.d@gmail.com>\n+ David Manouchehri <david@davidmanouchehri.com>\n+ David McAllister <mcdavid@amazon.com>\n+ David Michael Barr <david.barr@samsung.com>\n+diff --git a/base/win/shortcut.cc b/base/win/shortcut.cc\n+index e790adb2f1d6529ac0dd77145f5da2796264c7ae..8a7edcfaf9af963468b4b42fe55a771fb31f13a2 100644\n+--- a/base/win/shortcut.cc\n++++ b/base/win/shortcut.cc\n+@@ -342,8 +342,9 @@ bool ResolveShortcutProperties(const FilePath& shortcut_path,\n+               *(pv_toast_activator_clsid.get().puuid));\n+           break;\n+         default:\n+-          NOTREACHED() << \"Unexpected variant type: \"\n+-                       << pv_toast_activator_clsid.get().vt;\n++          // Shortcuts may use strings to represent the CLSID. This case is\n++          // ignored.\n++          break;\n+       }\n+     }\n+   }\ndiff --git a/shell/common/api/electron_api_shell.cc b/shell/common/api/electron_api_shell.cc\nindex a8031264d7cdd..d6097e7efbb84 100644\n--- a/shell/common/api/electron_api_shell.cc\n+++ b/shell/common/api/electron_api_shell.cc\n@@ -163,7 +163,8 @@ v8::Local<v8::Value> ReadShortcutLink(gin_helper::ErrorThrower thrower,\n   options.Set(\"icon\", properties.icon);\n   options.Set(\"iconIndex\", properties.icon_index);\n   options.Set(\"appUserModelId\", properties.app_id);\n-  options.Set(\"toastActivatorClsid\", properties.toast_activator_clsid);\n+  if (properties.options & ShortcutProperties::PROPERTIES_TOAST_ACTIVATOR_CLSID)\n+    options.Set(\"toastActivatorClsid\", properties.toast_activator_clsid);\n   return gin::ConvertToV8(thrower.isolate(), options);\n }\n #endif\n", "test_patch": "", "problem_statement": "`shell.readShortcutLink` crashes when parsing Slack shortcut\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.3.1\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11 version 26100\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nShortcut should be parsed/read correctly, and we should be able to handle the error if this fails.\n\n### Actual Behavior\n\nAn exception is thrown:\n\n```\n[1212:0109/171356.871:ERROR:crashpad_client_win.cc(868)] not connected\n```\n\n### Testcase Gist URL\n\nhttps://gist.github.com/dlon/f580673b27ba00d1bedfa25d2f2208c1\n\n### Additional Information\n\nThis seems related to https://github.com/electron/electron/issues/44752, but it affects other shortcuts.\n\nHere is a partial backtrace:\n```\n00 00000072`1e5fc3a0 00007ff7`f38192e9     electron!base::win::ResolveShortcutProperties+0xaaa [C:\\projects\\src\\base\\win\\shortcut.cc @ 345] \n01 00000072`1e5fc6e0 00007ff7`f36ecd16     electron!`anonymous namespace'::ReadShortcutLink+0xd9 [C:\\projects\\src\\electron\\shell\\common\\api\\electron_api_shell.cc @ 154] \n```\n\nI've reproduced the above on v33.3.1, as well as the latest beta.\n", "hints_text": "I've found an issue and fix. I'll try to provide a patch when I have time.", "created_at": "2025-01-14 09:52:38", "merge_commit_sha": "ae56a03e339f76cfdab9c77932026b47686af6f6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45187", "base_commit": "19ee4464c211a0cef3bc5070fbd7b8bd0d5c3c7d", "patch": "diff --git a/shell/browser/api/electron_api_session.cc b/shell/browser/api/electron_api_session.cc\nindex e72a309caa9e5..ae705c4fa5e67 100644\n--- a/shell/browser/api/electron_api_session.cc\n+++ b/shell/browser/api/electron_api_session.cc\n@@ -160,7 +160,8 @@ uint32_t GetQuotaMask(const std::vector<std::string>& quota_types) {\n   return quota_mask;\n }\n \n-constexpr BrowsingDataRemover::DataType kClearDataTypeAll = ~0ULL;\n+constexpr BrowsingDataRemover::DataType kClearDataTypeAll =\n+    ~0ULL & ~BrowsingDataRemover::DATA_TYPE_AVOID_CLOSING_CONNECTIONS;\n constexpr BrowsingDataRemover::OriginType kClearOriginTypeAll =\n     BrowsingDataRemover::ORIGIN_TYPE_UNPROTECTED_WEB |\n     BrowsingDataRemover::ORIGIN_TYPE_PROTECTED_WEB;\n", "test_patch": "", "problem_statement": "`avoidClosingConnections` option on `session.clearData()` doesn't work without `dataTypes`\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n34.0.0-beta.6\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS Sequoia 15.1.1\n\n### What arch are you using?\n\narm64 (including Apple Silicon)\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\n`avoidClosingConnections` is `false` by default (as the [docs](https://www.electronjs.org/docs/latest/api/session#sescleardataoptions) say), even when `dataTypes` is not set.\n\n### Actual Behavior\n\n`avoidClosingConnections` only takes effect when `dataTypes` is set.\n\nIf `dataTypes` is not set, `session.clearData()` behaves as if `avoidClosingConnections` was set to `true` (no matter what its actual value is).\n\n**Code:**\n\nThe data type mask is set to `~0ULL` here (i.e. `111111...`): https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1312\n\n`avoidClosingConnections` will try to set a bit in the data type mask to 1 here: https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1325-L1330\n\nThis only takes effect if `dataTypes` is set here: https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1320-L1323\n\nOtherwise, that bit is already 1.\n\n**Changes necessary:**\n\n* Either fix the default behavior (preferred).\n* Or update the docs.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/9fcc98d6a6a69f935d365df7ea741276\n\n### Additional Information\n\nI do not use this function in my code without specifying `dataTypes`, so I do not care much if this is fixed. I just noticed it while reading the code. If it doesn't get fixed, we should update the docs though.\n", "hints_text": "", "created_at": "2025-01-13 20:21:30", "merge_commit_sha": "6f7999ad0d09c7076f1878ba6e327b354425735e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-44599", "base_commit": "f9a04012b91539813b937b66c8998b4b068815f7", "patch": "diff --git a/shell/browser/api/electron_api_view.cc b/shell/browser/api/electron_api_view.cc\nindex b01a08be88cb7..c65f80b164fec 100644\n--- a/shell/browser/api/electron_api_view.cc\n+++ b/shell/browser/api/electron_api_view.cc\n@@ -124,6 +124,15 @@ struct Converter<views::FlexAllocationOrder> {\n   }\n };\n \n+template <>\n+struct Converter<electron::api::View> {\n+  static bool FromV8(v8::Isolate* isolate,\n+                     v8::Local<v8::Value> val,\n+                     electron::api::View* out) {\n+    return gin::ConvertFromV8(isolate, val, &out);\n+  }\n+};\n+\n template <>\n struct Converter<views::SizeBound> {\n   static v8::Local<v8::Value> ToV8(v8::Isolate* isolate,\n@@ -257,11 +266,13 @@ void View::RemoveChildView(gin::Handle<View> child) {\n #if BUILDFLAG(IS_MAC)\n     ScopedCAActionDisabler disable_animations;\n #endif\n+    // Remove from child_views first so that OnChildViewRemoved doesn't try to\n+    // remove it again\n+    child_views_.erase(it);\n     // It's possible for the child's view to be invalid here\n     // if the child's webContents was closed or destroyed.\n     if (child->view())\n       view_->RemoveChildView(child->view());\n-    child_views_.erase(it);\n   }\n }\n \n@@ -388,6 +399,19 @@ void View::OnViewIsDeleting(views::View* observed_view) {\n   view_ = nullptr;\n }\n \n+void View::OnChildViewRemoved(views::View* observed_view, views::View* child) {\n+  v8::Isolate* isolate = JavascriptEnvironment::GetIsolate();\n+  auto it = std::ranges::find_if(\n+      child_views_, [&](const v8::Global<v8::Object>& child_view) {\n+        View current_view;\n+        gin::ConvertFromV8(isolate, child_view.Get(isolate), &current_view);\n+        return current_view.view()->GetID() == child->GetID();\n+      });\n+  if (it != child_views_.end()) {\n+    child_views_.erase(it);\n+  }\n+}\n+\n // static\n gin_helper::WrappableBase* View::New(gin::Arguments* args) {\n   View* view = new View();\ndiff --git a/shell/browser/api/electron_api_view.h b/shell/browser/api/electron_api_view.h\nindex 6eeb16521906f..1b0a3f815a6f9 100644\n--- a/shell/browser/api/electron_api_view.h\n+++ b/shell/browser/api/electron_api_view.h\n@@ -47,6 +47,8 @@ class View : public gin_helper::EventEmitter<View>,\n   // views::ViewObserver\n   void OnViewBoundsChanged(views::View* observed_view) override;\n   void OnViewIsDeleting(views::View* observed_view) override;\n+  void OnChildViewRemoved(views::View* observed_view,\n+                          views::View* child) override;\n \n   views::View* view() const { return view_; }\n   std::optional<int> border_radius() const { return border_radius_; }\ndiff --git a/spec/fixtures/crash-cases/webview-move-between-windows/index.js b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\nnew file mode 100644\nindex 0000000000000..de9053ec65ca9\n--- /dev/null\n+++ b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\n@@ -0,0 +1,31 @@\n+const { app, BrowserWindow, WebContentsView } = require('electron');\n+\n+function createWindow () {\n+  // Create the browser window.\n+  const mainWindow = new BrowserWindow();\n+  const secondaryWindow = new BrowserWindow();\n+\n+  const contentsView = new WebContentsView();\n+  mainWindow.contentView.addChildView(contentsView);\n+  mainWindow.webContents.setDevToolsWebContents(contentsView.webContents);\n+  mainWindow.openDevTools();\n+\n+  contentsView.setBounds({\n+    x: 400,\n+    y: 0,\n+    width: 400,\n+    height: 600\n+  });\n+\n+  setTimeout(() => {\n+    secondaryWindow.contentView.addChildView(contentsView);\n+    setTimeout(() => {\n+      mainWindow.contentView.addChildView(contentsView);\n+      app.quit();\n+    }, 1000);\n+  }, 1000);\n+}\n+\n+app.whenReady().then(() => {\n+  createWindow();\n+});\n", "test_patch": "", "problem_statement": "segfault when moving WebContentsView between BrowserWindows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33, 34\n\n### What operating system(s) are you using?\n\nUbuntu\n\n### Operating System Version\n\n23.04\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nWhen moving WebContentsViews between different browser windows, the app doesn't crash\n\n### Actual Behavior\n\nWhen moving WebContentsViews from BrowserWindow A to BrowserWindow B and back to BrowserWindow A, the app crashes. Going just from A BrowserWindow A to BrowserWindow B works, but then back to A segfaults.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/Kilian/8014d47a193a8f66b05f490def934166\n\n### Additional Information\n\n_No response_\n", "hints_text": "@Kilian is there a last known version?\n\nedit: this seems to have been broken since at least e30\n.\ne29 fails on this line:\n\n```\nconst contentsView = new WebContentsView();\n```\nwith\n```sh\n(node:2038244) UnhandledPromiseRejectionWarning: TypeError: Insufficient number of arguments.\n    at createWindow (/tmp/electron-fiddle-2030700-MSoL9sQJYrOk/main.js:21:24)\n    at /tmp/electron-fiddle-2030700-MSoL9sQJYrOk/main.js:43:3\n```\nI can't find the webcontentsview docs in the 29 branch, so I don't know if there were any required arguments at that point.\n\nIt first started crashing in 30.0.0-beta.8, though in 30.0.0-beta.7 and earlier there is no webcontentsview visible but there is also no error visible like above.\n\nWebContentsView was [reverted in v29](https://github.com/electron/electron/pull/41361), so that is why you cannot find any docs in that branch. If it started crashing in a v30, then it has basically been crashing from the start from the looks of things. \nI hit the same issue and the solution was to remove the view from its current parent and then add it to the new parent.\nIt complicated our code a bit, but solved the problem.\n@estoykov do you have a code example?\n\nI have an different fiddle here that first removes the webcontentsview but it still crashes: https://gist.github.com/Kilian/8f0365a3c962b4d5927f2c21284fb1e6\nWell, may be I miss leaded you as our structure is a bit more complex - we need to have more than one view in our containers, so the flow is something like this:\n- create BrowserWindow\n- create rootView = new View()\n- browserWindow.setContentView(rootView)\n- create multiple \"hosts\" which are simply Views, i.e.\n- host1 has rootView = new View()\n- host2 has rootView = new View()\n- put host1 and host2 rootVews in the BrowerWindow content rootView \n- and then we move some other view from host1 and host2 rootView - it crashed before when added to host1, then host2 and then back to host1 - removing from the current host root view before adding to the new one solved the problem\n\nChanging BrowserWindow content view comes with an additional processing - you need to track this content view (View in my case) bounds change and re-pos/re-size the real content (WebContentsView) if any, ditto for the hosts and their content...\n", "created_at": "2024-11-08 19:42:56", "merge_commit_sha": "777e54792244b92565eb6bf32fed166217f46de7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['Lint', '.github/workflows/build.yml']"], ["['test (linux, 1)', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-43150", "base_commit": "45e5ccc55e8b13a45899bacff5cb98c9994446f2", "patch": "diff --git a/shell/browser/net/system_network_context_manager.cc b/shell/browser/net/system_network_context_manager.cc\nindex be839e174243c..8b8beac393cfb 100644\n--- a/shell/browser/net/system_network_context_manager.cc\n+++ b/shell/browser/net/system_network_context_manager.cc\n@@ -195,6 +195,8 @@ SystemNetworkContextManager::CreateDefaultNetworkContextParams() {\n void SystemNetworkContextManager::ConfigureDefaultNetworkContextParams(\n     network::mojom::NetworkContextParams* network_context_params) {\n   network_context_params->enable_brotli = true;\n+  network_context_params->enable_zstd =\n+      base::FeatureList::IsEnabled(net::features::kZstdContentEncoding);\n \n   network_context_params->enable_referrers = true;\n \n", "test_patch": "", "problem_statement": "[Bug]: zstd is not enabled in accept-encoding\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n31.3.1\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nany\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n_No response_\r\n\r\n### Expected Behavior\r\n\r\nzstd is a supported content encoding method, and the accept-encoding should be \"gzip, deflate, br, zstd\"\r\n\r\n<img width=\"920\" alt=\"\u622a\u5c4f2024-07-31 06 43 43\" src=\"https://github.com/user-attachments/assets/11d536fd-f7bd-4a31-93cb-36960de0dfea\">\r\n\r\n\r\n### Actual Behavior\r\n\r\nit's not enabled even it's forcely enabled it in network conditions panel, the accept-encoding header is still \"gzip, deflate, br\".\r\n<img width=\"812\" alt=\"\u622a\u5c4f2024-07-31 06 40 16\" src=\"https://github.com/user-attachments/assets/c47a5f8a-9393-40a2-a1fb-ef81695a9be5\">\r\n\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nJust start the default electron fiddle, open the dev tools and set location.href to any site for example 'https://www.google.com/' then check the request headers in network panel.\n", "hints_text": "", "created_at": "2024-08-01 04:27:45", "merge_commit_sha": "bba31189a06f59d5b828e25defe14571cb502157", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test', '.github/workflows/build.yml']", "['test (mas, 1)', '.github/workflows/build.yml']"], ["['build', '.github/workflows/build.yml']", "['Validate PR Title', '.github/workflows/semantic.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-42275", "base_commit": "3ffa35dc8d1cfe54a3343c51958c6e9f3d70ace3", "patch": "diff --git a/docs/api/structures/web-preferences.md b/docs/api/structures/web-preferences.md\nindex 9c6a3ecc8fc8c..044cd2b2270b1 100644\n--- a/docs/api/structures/web-preferences.md\n+++ b/docs/api/structures/web-preferences.md\n@@ -143,6 +143,7 @@\n   contain the layout of the document\u2014without requiring scrolling. Enabling\n   this will cause the `preferred-size-changed` event to be emitted on the\n   `WebContents` when the preferred size changes. Default is `false`.\n+* `transparent` boolean (optional) - Whether to enable background transparency for the guest page. Default is `true`. **Note:** The guest page's text and background colors are derived from the [color scheme](https://developer.mozilla.org/en-US/docs/Web/CSS/color-scheme) of its root element. When transparency is enabled, the text color will still change accordingly but the background will remain transparent.\n \n [chrome-content-scripts]: https://developer.chrome.com/extensions/content_scripts#execution-environment\n [runtime-enabled-features]: https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/platform/runtime_enabled_features.json5\ndiff --git a/docs/api/webview-tag.md b/docs/api/webview-tag.md\nindex 99e740eb39a9c..14103680f7f4e 100644\n--- a/docs/api/webview-tag.md\n+++ b/docs/api/webview-tag.md\n@@ -221,9 +221,7 @@ windows. Popups are disabled by default.\n ```\n \n A `string` which is a comma separated list of strings which specifies the web preferences to be set on the webview.\n-The full list of supported preference strings can be found in [BrowserWindow](browser-window.md#new-browserwindowoptions). In addition, webview supports the following preferences:\n-\n-* `transparent` boolean (optional) - Whether to enable background transparency for the guest page. Default is `true`. **Note:** The guest page's text and background colors are derived from the [color scheme](https://developer.mozilla.org/en-US/docs/Web/CSS/color-scheme) of its root element. When transparency is enabled, the text color will still change accordingly but the background will remain transparent.\n+The full list of supported preference strings can be found in [BrowserWindow](browser-window.md#new-browserwindowoptions).\n \n The string follows the same format as the features string in `window.open`.\n A name by itself is given a `true` boolean value.\n", "test_patch": "", "problem_statement": "[Bug]: `WebviewTag.webpreferences` has wrong type\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n30.0.6\r\n\r\n### What operating system are you using?\r\n\r\nmacOS\r\n\r\n### Operating System Version\r\n\r\nSonoma 14.4.1\r\n\r\n### What arch are you using?\r\n\r\narm64 (including Apple Silicon)\r\n\r\n### Last Known Working Electron version\r\n\r\n29.4.0\r\n\r\n### Expected Behavior\r\n\r\nCan assign `\"contextIsolation=false, nodeintegration=true\"` and other valid strings to `WebviewTag.webpreferences`. The type of `WebviewTag.webpreferences` should be `string`.\r\n\r\n### Actual Behavior\r\n\r\n```\r\nerror TS2322: Type '\"contextIsolation=false\"' is not assignable to type '\"transparent\"'\r\n```\r\n\r\n`WebviewTag.webpreferences` has type `'transparent'`.\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\n* Broken in #40301\n", "hints_text": "", "created_at": "2024-05-25 04:19:17", "merge_commit_sha": "6423968dc56ce40259ed4a90744dbb9368dffd4e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-42126", "base_commit": "9b0409f7c91b1dd8e1554f8428972c1b0f171766", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex cd97a83b93a3b..8ab128530c726 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -129,3 +129,4 @@ fix_add_support_for_skipping_first_2_no-op_refreshes_in_thumb_cap.patch\n refactor_expose_file_system_access_blocklist.patch\n revert_power_update_trace_counter_in_power_monitor.patch\n feat_add_support_for_missing_dialog_features_to_shell_dialogs.patch\n+fix_partially_revert_invalidate_focusring.patch\ndiff --git a/patches/chromium/fix_partially_revert_invalidate_focusring.patch b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\nnew file mode 100644\nindex 0000000000000..614f42b4acd3d\n--- /dev/null\n+++ b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\n@@ -0,0 +1,58 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: VerteDinde <keeleymhammond@gmail.com>\n+Date: Mon, 6 May 2024 11:03:08 -0700\n+Subject: fix: partially revert views invalidate FocusRing when its host is\n+ invalidated\n+\n+This reverts commit f425c438dfb11fb714655c999ba8c74b58393425. This\n+commit seems to be causing a sporadic crash on Ubuntu and other Linux\n+distros. This patch can be reverted when the issue is fixed upstream, or\n+when the crash is addressed.\n+\n+diff --git a/ui/views/view.cc b/ui/views/view.cc\n+index 94b026cda4738e489f1d7201c996f6db70d018ed..32ec794f4683be5ded78dcf310d3623b8748c236 100644\n+--- a/ui/views/view.cc\n++++ b/ui/views/view.cc\n+@@ -911,16 +911,6 @@ void View::Layout(PassKey) {\n+ }\n+ \n+ void View::InvalidateLayout() {\n+-  if (invalidating_) {\n+-    return;\n+-  }\n+-\n+-  // There is no need to `InvalidateLayout()` when `Widget::IsClosed()`.\n+-  if (Widget* widget = GetWidget(); widget && widget->IsClosed()) {\n+-    return;\n+-  }\n+-\n+-  base::AutoReset<bool> invalidating(&invalidating_, true);\n+   // We should never need to invalidate during a layout call; this tracks\n+   // how many times that is happening.\n+   ++invalidates_during_layout_;\n+@@ -928,11 +918,6 @@ void View::InvalidateLayout() {\n+   // Always invalidate up. This is needed to handle the case of us already being\n+   // valid, but not our parent.\n+   needs_layout_ = true;\n+-\n+-  for (ViewObserver& observer : observers_) {\n+-    observer.OnViewLayoutInvalidated(this);\n+-  }\n+-\n+   if (HasLayoutManager()) {\n+     GetLayoutManager()->InvalidateLayout();\n+   }\n+diff --git a/ui/views/view.h b/ui/views/view.h\n+index ea7d5441dbbfb713a6ffb57bcc07fb55fa574016..54b4c0a2871f214a4806fd863f32b8d010c09058 100644\n+--- a/ui/views/view.h\n++++ b/ui/views/view.h\n+@@ -2343,9 +2343,6 @@ class VIEWS_EXPORT View : public ui::LayerDelegate,\n+   // it is happening.\n+   int invalidates_during_layout_ = 0;\n+ \n+-  // Whether this view is in the middle of InvalidateLayout().\n+-  bool invalidating_ = false;\n+-\n+   // The View's LayoutManager defines the sizing heuristics applied to child\n+   // Views. The default is absolute positioning according to bounds_.\n+   std::unique_ptr<LayoutManager> layout_manager_;\n", "test_patch": "", "problem_statement": "[Bug]: SIGSEGV crash when maximizing window\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n30.0.0-alpha7\r\n\r\n### What operating system are you using?\r\n\r\nUbuntu\r\n\r\n### Operating System Version\r\n\r\n20.04, running on x11\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n30.0.0-alpha6\r\n\r\n### Expected Behavior\r\n\r\nMaximizing/fullscreening the app does not sigfault.\r\n\r\n### Actual Behavior\r\n\r\nMaximizing/fullscreening the window crashes the app.\r\n\r\n### Testcase Gist URL\r\n\r\nThis is visible in the default Fiddle template that opens with the app\r\n\r\n### Additional Information\r\n\r\nThere is no `render-process-gone` or `child-process-gone` event called when it crashes.\r\n\n", "hints_text": "I'm not able to repro this on either `v30.0.0-alpha.7` or `v30.0.0-beta.7`\r\n\r\nTested on Ubuntu 23.10 w/`XDG_SESSION_TYPE=x11`:\r\n\r\n- checked out electron-quick-start\r\n- changed the electron version in package.json\r\n- ran npm install\r\n- confirmed from the command line that `./node_modules/electron/dist/electron --version` yielded the expected version\r\n-  ran npm start\r\n- and hit F11 a few times to toggle back & forth between fullscreen.\r\n\r\nNo crash\r\n\r\n@Kilian I am wondering if I'm testing this wrong since your description sounds straightforward. Any idea what I should change from the above so that I can trigger the crash?\nquick follow-up to previous comment: @Kilian in the video you made for @VerteDinde, it looks like you are clicking the titlebar instead of pressing f11, so I tried again with that to see if it made any difference. FWIW I still am not seeing a crash\nF11 works for me, its the double clicking on the titlebar that causes the crash. So probably WM (I use Mate/Compiz) related.\nTested same setup with ubuntu-mate-desktop 1.291 and compiz 0.9.14.2+22.10.20220822-0ubuntu4, still no crash here.\r\n\r\nMaybe this depends on hw config? I do not have accelerated graphics configured.\nPerhaps a crash dump would be illuminating?\r\n\r\n```js\r\nconst { app, crashReporter } = require('electron')\r\n\r\nconsole.log(app.getPath('crashDumps'))\r\ncrashReporter.start({ submitURL: '', uploadToServer: false })\r\n```\njust checked with 30.0.0, same result. ubuntu-mate-desktop 1.290 (from the ubuntu repo, older than yours) and compiz 0.9.14.2+22.10.20220822-0ubuntu4 (from ubuntu repo too, same as yours)\r\n\r\nWith crashreporter this is the terminal output (dmp file sent to @ckerr)\r\n```\r\n/home/kilian/.config/coherent-help-sigh-y5rzn/Crashpad\r\n[0416/140340.230066:ERROR:elf_dynamic_array_reader.h(64)] tag not found\r\n[0416/140340.230471:ERROR:elf_dynamic_array_reader.h(64)] tag not found\r\n[0416/140340.230807:ERROR:elf_dynamic_array_reader.h(64)] tag not found\r\n\r\nElectron exited with signal SIGSEGV.\r\n```\r\n\r\nSomething that points to it _not_ being WM related is that `mainWindow.maximize();` also causes the same SIGSEGV.\r\n\n<details>\r\n  <summary>Dump</summary>\r\n\r\n```\r\nOperating system: Linux\r\n                  6.2.0 -39-generic #40-Ubuntu SMP PREEMPT_DYNAMIC Tue Nov 14 14:18:00 UTC 2023 x86_64\r\nCPU: amd64\r\n     family 6 model 186 stepping 2\r\n     16 CPUs\r\n\r\nGPU: UNKNOWN\r\n\r\nCrash reason:  SIGSEGV /SEGV_MAPERR\r\nCrash address: 0x120\r\nProcess uptime: 10 seconds\r\n\r\nThread 0 (crashed)\r\n 0  electron!views::View::UpdateChildLayerBounds(views::View::LayerOffsetData const&) [raw_ptr.h : 615 + 0x0]\r\n    rax = 0x0000000000000000   rdx = 0x0000000000000000\r\n    rcx = 0x0000000000000000   rbx = 0x00007fffffa3a5a0\r\n    rsi = 0x00007fffffa3a320   rdi = 0x0000054c001030c0\r\n    rbp = 0x00007fffffa3a580   rsp = 0x00007fffffa3a510\r\n     r8 = 0x00000000000009d8    r9 = 0xffffffff80000dfc\r\n    r10 = 0x0000054c00101aa8   r11 = 0x000000000000056c\r\n    r12 = 0x0000054c006881a8   r13 = 0x0000000000000000\r\n    r14 = 0x00007fffffa3a520   r15 = 0x0000054c01010101\r\n    rip = 0x0000564ed89500ce\r\n    Found by: given as instruction pointer in context\r\n 1  electron!views::View::UpdateChildLayerBounds(views::View::LayerOffsetData const&) [view.cc : 2578 + 0xb]\r\n    rbx = 0x00007fffffa3a6a0   rbp = 0x00007fffffa3a600\r\n    rsp = 0x00007fffffa3a590   r12 = 0x0000054c00e6f390\r\n    r13 = 0x0000054c002dff00   r14 = 0x00007fffffa3a5a0\r\n    r15 = 0x00007fffffa3a5c0   rip = 0x0000564ed89501b7\r\n    Found by: call frame info\r\n 2  electron!views::View::SetBoundsRect(gfx::Rect const&) [view.cc : 449 + 0xb]\r\n    rbx = 0x0000054c000d8700   rbp = 0x00007fffffa3a700\r\n    rsp = 0x00007fffffa3a610   r12 = 0x0000054c000d8850\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a6a0\r\n    r15 = 0x0000054c00101dfe   rip = 0x0000564ed894ef5f\r\n    Found by: call frame info\r\n 3  electron!views::View::SetSize(gfx::Size const&) [view.cc : 401 + 0x5]\r\n    rbx = 0x00007fffffa3a810   rbp = 0x00007fffffa3a720\r\n    rsp = 0x00007fffffa3a710   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016c100\r\n    r15 = 0x0000054c00101d40   rip = 0x0000564ed895042c\r\n    Found by: call frame info\r\n 4  electron!views::Widget::OnNativeWidgetSizeChanged(gfx::Size const&) [widget.cc : 1681 + 0x8]\r\n    rbx = 0x00007fffffa3a810   rbp = 0x00007fffffa3a7f0\r\n    rsp = 0x00007fffffa3a730   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016c100\r\n    r15 = 0x0000054c00101d40   rip = 0x0000564ed896d43e\r\n    Found by: call frame info\r\n 5  electron!non-virtual thunk to views::DesktopNativeWidgetAura::OnHostResized(aura::WindowTreeHost*) [desktop_native_widget_aura.cc : 1476 + 0x9]\r\n    rbx = 0x0000054c001438b0   rbp = 0x00007fffffa3a830\r\n    rsp = 0x00007fffffa3a800   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c001438f8\r\n    r15 = 0x0000054c00101d40   rip = 0x0000564ed89997b7\r\n    Found by: call frame info\r\n 6  electron!aura::WindowTreeHost::OnHostResizedInPixels(gfx::Size const&) [window_tree_host.cc : 605 + 0x8]\r\n    rbx = 0x0000054c00101d40   rbp = 0x00007fffffa3a950\r\n    rsp = 0x00007fffffa3a840   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a8d0\r\n    r15 = 0xaaaaaaaaaaaaaaaa   rip = 0x0000564ed87e8d86\r\n    Found by: call frame info\r\n 7  electron!aura::WindowTreeHostPlatform::OnBoundsChanged(ui::PlatformWindowDelegate::BoundsChange const&) [window_tree_host_platform.cc : 255 + 0x8]\r\n    rbx = 0x0000054c00101d40   rbp = 0x00007fffffa3aa00\r\n    rsp = 0x00007fffffa3a960   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3aa3c\r\n    r15 = 0x00007fffffa3a900   rip = 0x0000564ed87eaaed\r\n    Found by: call frame info\r\n 8  electron!electron::ElectronDesktopWindowTreeHostLinux::OnBoundsChanged(ui::PlatformWindowDelegate::BoundsChange const&) [electron_desktop_window_tree_host_linux.cc : 50 + 0x5]\r\n    rbx = 0x0000054c00101d40   rbp = 0x00007fffffa3aa20\r\n    rsp = 0x00007fffffa3aa10   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016bc00\r\n    r15 = 0x0000054c0016be00   rip = 0x0000564ed36e8e9e\r\n    Found by: call frame info\r\n 9  electron!ui::X11Window::DelayedResize(bool) [x11_window.cc : 2670 + 0x6]\r\n    rbx = 0x0000000000000001   rbp = 0x00007fffffa3aa60\r\n    rsp = 0x00007fffffa3aa30   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016bc00\r\n    r15 = 0x0000054c0016be00   rip = 0x0000564ed412cdf3\r\n    Found by: call frame info\r\n10  electron!void base::internal::CancelableCallbackImpl<base::OnceCallback<void ()>>::ForwardOnce<>() [callback.h : 156 + 0x3]\r\n    rbx = 0x0000054c0016be00   rbp = 0x00007fffffa3aa90\r\n    rsp = 0x00007fffffa3aa70   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3aa78\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed38d7950\r\n    Found by: call frame info\r\n11  electron!base::TaskAnnotator::RunTaskImpl(base::PendingTask&) [callback.h : 156 + 0x3]\r\n    rbx = 0x0000054c01044000   rbp = 0x00007fffffa3ab20\r\n    rsp = 0x00007fffffa3aaa0   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3aae8\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed6dffb4f\r\n    Found by: call frame info\r\n12  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl(base::LazyNow*) [task_annotator.h : 90 + 0x8]\r\n    rbx = 0xaaaaaaaaaaaaaaaa   rbp = 0x00007fffffa3adb0\r\n    rsp = 0x00007fffffa3ab30   r12 = 0x0000054c01044000\r\n    r13 = 0x00002ee400308280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edba62e70   rip = 0x0000564ed6e1c39d\r\n    Found by: call frame info\r\n13  electron!non-virtual thunk to base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork() [thread_controller_with_message_pump_impl.cc : 338 + 0xb]\r\n    rbx = 0x00007fffffa3ae40   rbp = 0x00007fffffa3ae30\r\n    rsp = 0x00007fffffa3adc0   r12 = 0x00002ee400308280\r\n    r13 = 0x00007fffffa3adc0   r14 = 0x00002ee400308368\r\n    r15 = 0x00002ee400308448   rip = 0x0000564ed6e1c98c\r\n    Found by: call frame info\r\n14  electron!base::MessagePumpGlib::Run(base::MessagePump::Delegate*) [message_pump_glib.cc : 694 + 0x8]\r\n    rbx = 0x00002ee40022f2c0   rbp = 0x00007fffffa3aef0\r\n    rsp = 0x00007fffffa3ae40   r12 = 0x00007fffffa3ae60\r\n    r13 = 0x0000000000000001   r14 = 0x0000000000000001\r\n    r15 = 0x00007fffffa3ae40   rip = 0x0000564ed6e7efd1\r\n    Found by: call frame info\r\n15  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee400308280   rbp = 0x00007fffffa3af40\r\n    rsp = 0x00007fffffa3af00   r12 = 0x00002ee400308298\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee4003084a8   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n16  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x0000054c01018870   rbp = 0x00007fffffa3b020\r\n    rsp = 0x00007fffffa3af50   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b270   r14 = 0x00007fffffa3afa0\r\n    r15 = 0x00007fffffa3b038   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n17  electron!content::BrowserMainLoop::RunMainMessageLoop() [browser_main_loop.cc : 1104 + 0x2a]\r\n    rbx = 0x00007fffffa3b038   rbp = 0x00007fffffa3b070\r\n    rsp = 0x00007fffffa3b030   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x0000054c01018870\r\n    r15 = 0x00007fffffa3b0a0   rip = 0x0000564ed5df70ff\r\n    Found by: call frame info\r\n18  electron!content::BrowserMainRunnerImpl::Run() [browser_main_runner_impl.cc : 159 + 0x5]\r\n    rbx = 0x0000054c00010330   rbp = 0x00007fffffa3b090\r\n    rsp = 0x00007fffffa3b080   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x0000054c00010330\r\n    r15 = 0x00007fffffa3b0a0   rip = 0x0000564ed5df8f52\r\n    Found by: call frame info\r\n19  electron!content::BrowserMain(content::MainFunctionParams) [browser_main.cc : 34 + 0x5]\r\n    rbx = 0x00000000ffffffff   rbp = 0x00007fffffa3b100\r\n    rsp = 0x00007fffffa3b0a0   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x0000054c00010330\r\n    r15 = 0x00007fffffa3b0a0   rip = 0x0000564ed5df45a9\r\n    Found by: call frame info\r\n20  electron!content::RunBrowserProcessMain(content::MainFunctionParams, content::ContentMainDelegate*) [content_main_runner_impl.cc : 712 + 0x8]\r\n    rbx = 0x00007fffffa3b720   rbp = 0x00007fffffa3b200\r\n    rsp = 0x00007fffffa3b110   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x00007fffffa3b148\r\n    r15 = 0x00007fffffa3b180   rip = 0x0000564ed384c274\r\n    Found by: call frame info\r\n21  electron!content::ContentMainRunnerImpl::RunBrowser(content::MainFunctionParams, bool) [content_main_runner_impl.cc : 1303 + 0x8]\r\n    rbx = 0x00002ee4002a38e0   rbp = 0x00007fffffa3b2f0\r\n    rsp = 0x00007fffffa3b210   r12 = 0x00000000ffffffff\r\n    r13 = 0x00007fffffa3b270   r14 = 0x00007fffffa3b300\r\n    r15 = 0x00007fffffa3b218   rip = 0x0000564ed384da6e\r\n    Found by: call frame info\r\n22  electron!content::ContentMainRunnerImpl::Run() [content_main_runner_impl.cc : 1148 + 0xf]\r\n    rbx = 0x00002ee4002a38e0   rbp = 0x00007fffffa3b410\r\n    rsp = 0x00007fffffa3b300   r12 = 0x00007fffffa3b3d0\r\n    r13 = 0xaaaaaaaaaaaaaaaa   r14 = 0x00007fffffa3b300\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed384d886\r\n    Found by: call frame info\r\n23  electron!content::RunContentProcess(content::ContentMainParams, content::ContentMainRunner*) [content_main.cc : 331 + 0x8]\r\n    rbx = 0x00002ee4002a38e0   rbp = 0x00007fffffa3b670\r\n    rsp = 0x00007fffffa3b420   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b610   r14 = 0x0000000000000000\r\n    r15 = 0x00007fffffa3b4a1   rip = 0x0000564ed384b24b\r\n    Found by: call frame info\r\n24  electron!content::ContentMain(content::ContentMainParams) [content_main.cc : 344 + 0x8]\r\n    rbx = 0x00007fffffa3b6f0   rbp = 0x00007fffffa3b6e0\r\n    rsp = 0x00007fffffa3b680   r12 = 0x00007fffffa3b6a8\r\n    r13 = 0x00007fffffa3b900   r14 = 0x00007fffffa3b6a0\r\n    r15 = 0x00007fffffa3b688   rip = 0x0000564ed384b350\r\n    Found by: call frame info\r\n25  electron!main [electron_main_linux.cc : 45 + 0x8]\r\n    rbx = 0x00007fffffa3b8d8   rbp = 0x00007fffffa3b7c0\r\n    rsp = 0x00007fffffa3b6f0   r12 = 0x00007fffffa3b770\r\n    r13 = 0x00007fffffa3b900   r14 = 0x00007fffffa3b770\r\n    r15 = 0x00007fffffa3b6f0   rip = 0x0000564ed3531928\r\n    Found by: call frame info\r\n26  libc.so.6!__libc_start_call_main [libc_start_call_main.h : 58 + 0x1a]\r\n    rbx = 0x00007fffffa3b8d8   rbp = 0x0000000000000004\r\n    rsp = 0x00007fffffa3b7d0   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b900   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb2a5135000   rip = 0x00007fb2a3223a90\r\n    Found by: call frame info\r\n27  libc.so.6!__libc_start_main_alias_2 [libc-start.c : 360 + 0xe]\r\n    rbx = 0x00007fffffa3b8d8   rbp = 0x0000000000000004\r\n    rsp = 0x00007fffffa3b870   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b900   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb2a5135000   rip = 0x00007fb2a3223b49\r\n    Found by: call frame info\r\n28  electron!_start + 0x2a\r\n    rbx = 0x0000000000000000   rbp = 0x0000000000000000\r\n    rsp = 0x00007fffffa3b8c0   r12 = 0x0000564ed3126000\r\n    r13 = 0x00007fffffa3b8d0   r14 = 0x0000000000000000\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed312602a\r\n    Found by: call frame info\r\n29  0x7fffffa3b8c8\r\n    rbx = 0x0000000000000000   rbp = 0x0000000000000000\r\n    rsp = 0x00007fffffa3b8c8   r12 = 0x0000564ed3126000\r\n    r13 = 0x00007fffffa3b8d0   r14 = 0x0000000000000000\r\n    r15 = 0x0000000000000000   rip = 0x00007fffffa3b8c8\r\n    Found by: call frame info\r\n\r\nThread 1\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x00002ee400234770\r\n    rsi = 0x0000000000000002   rdi = 0x00007fb2a09fe4d0\r\n    rbp = 0x00007fb2a09fe510   rsp = 0x00007fb2a09fe360\r\n     r8 = 0x0000000000000000    r9 = 0x0000564edbb0fe00\r\n    r10 = 0x0000000000000010   r11 = 0x0000000000000293\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb2a09fe398\r\n    r14 = 0x00007fb2a09fe4d0   r15 = 0x0000564ed1fcebbc\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  electron!content::SandboxIPCHandler::Run() [sandbox_ipc_linux.cc : 46 + 0x12]\r\n    rbx = 0x00002ee400234770   rbp = 0x00007fb2a09fe510\r\n    rsp = 0x00007fb2a09fe390   r12 = 0x0000000000000000\r\n    r13 = 0x00007fb2a09fe398   r14 = 0x00007fb2a09fe4d0\r\n    r15 = 0x0000564ed1fcebbc   rip = 0x0000564ed64862f0\r\n    Found by: call frame info\r\n 2  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb2a09ff6c0   rbp = 0x00007fb2a09fe550\r\n    rsp = 0x00007fb2a09fe520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a09ff258   r14 = 0x00002ee4002224c0\r\n    r15 = 0x00007fb2a09ff6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 3  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a09ffcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a09fe560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3adb0\r\n    r15 = 0x00007fb2a01ff000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 4  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a09fe600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3adb0\r\n    r15 = 0x00007fb2a01ff000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 2\r\n 0  libc.so.6!__GI___wait4 [wait4.c : 30 + 0x26]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a32e1a57   rbx = 0x00007fb2a01fd4b8\r\n    rsi = 0x00007fb2a01fd4b8   rdi = 0x00000000001b49b8\r\n    rbp = 0x00007fb2a01fd4f0   rsp = 0x00007fb2a01fd450\r\n     r8 = 0x0000000000000000    r9 = 0x0ccccccccccccccc\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000293\r\n    r12 = 0x0000000000000000   r13 = 0x8000000000000001\r\n    r14 = 0x7fffffffffffffff   r15 = 0x00000000001b49b8\r\n    rip = 0x00007fb2a32e1a57\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::Process::WaitForExitWithTimeout(base::TimeDelta, int*) const [process_posix.cc : 64 + 0xd]\r\n    rbx = 0x00007fb2a01fd4b8   rbp = 0x00007fb2a01fd4f0\r\n    rsp = 0x00007fb2a01fd480   r12 = 0x0000000000000000\r\n    r13 = 0x8000000000000001   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000001b49b8   rip = 0x0000564ed6e6ec00\r\n    Found by: call frame info\r\n 2  electron!base::(anonymous namespace)::BackgroundReaper::ThreadMain() [kill_posix.cc : 139 + 0x7]\r\n    rbx = 0x00002ee4002a4960   rbp = 0x00007fb2a01fd510\r\n    rsp = 0x00007fb2a01fd500   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a01fe258   r14 = 0x00002ee4002a4960\r\n    r15 = 0x00007fb2a01fe6c0   rip = 0x0000564ed6e70620\r\n    Found by: call frame info\r\n 3  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb2a01fe6c0   rbp = 0x00007fb2a01fd550\r\n    rsp = 0x00007fb2a01fd520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a01fe258   r14 = 0x00002ee4002a4960\r\n    r15 = 0x00007fb2a01fe6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a01fecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a01fd560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3aa00\r\n    r15 = 0x00007fb29f9fe000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a01fd600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3aa00\r\n    r15 = 0x00007fb29f9fe000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 3\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb29f9fc0d0   rdi = 0x0000000000000019\r\n    rbp = 0x00007fb29f9fc2a0   rsp = 0x00007fb29f9fc060\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000000\r\n    r10 = 0x0000000000005c04   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb29f9fc2b0   r13 = 0x0000000001676d87\r\n    r14 = 0x00002ee400222c40   r15 = 0x00007fb29f9fc0d0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29f9fc2a0\r\n    rsp = 0x00007fb29f9fc090   r12 = 0x00007fb29f9fc2b0\r\n    r13 = 0x0000000001676d87   r14 = 0x00002ee400222c40\r\n    r15 = 0x00007fb29f9fc0d0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29f9fc320\r\n    rsp = 0x00007fb29f9fc2b0   r12 = 0x00007fb29f9fc2b0\r\n    r13 = 0x0000000001676d87   r14 = 0x00002ee40030c468\r\n    r15 = 0x00002ee400222c40   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee40030c380   rbp = 0x00007fb29f9fc370\r\n    rsp = 0x00007fb29f9fc330   r12 = 0x00002ee40030c398\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee40030c5a8   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb29f9fc4c0   rbp = 0x00007fb29f9fc450\r\n    rsp = 0x00007fb29f9fc380   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29f9fc3d0\r\n    r15 = 0x00007fb29f9fc460   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb29f9fc4c0   rbp = 0x00007fb29f9fc490\r\n    rsp = 0x00007fb29f9fc460   r12 = 0x00007fb29f9fc4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29f9fc460\r\n    r15 = 0x00002ee4002fc050   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!base::internal::ServiceThread::Run(base::RunLoop*) [service_thread.cc : 15 + 0x5]\r\n    rbx = 0x00002ee4002fc040   rbp = 0x00007fb29f9fc4b0\r\n    rsp = 0x00007fb29f9fc4a0   r12 = 0x00007fb29f9fc4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00002ee4002a51a0\r\n    r15 = 0x00002ee4002fc050   rip = 0x0000564ed6e2a89d\r\n    Found by: call frame info\r\n 7  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x00002ee4002fc040   rbp = 0x00007fb29f9fc510\r\n    rsp = 0x00007fb29f9fc4c0   r12 = 0x00007fb29f9fc4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00002ee4002a51a0\r\n    r15 = 0x00002ee4002fc050   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 8  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29f9fd6c0   rbp = 0x00007fb29f9fc550\r\n    rsp = 0x00007fb29f9fc520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f9fd258   r14 = 0x00002ee4002fc040\r\n    r15 = 0x00007fb29f9fd6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 9  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29f9fdcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f9fc560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac20\r\n    r15 = 0x00007fb29f1fd000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n10  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f9fc600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac20\r\n    r15 = 0x00007fb29f1fd000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 4\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29f1fb2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29f1fb2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29f1fb0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29f1fb1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29f1fb2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29f1fb2a8   rbp = 0x00007fb29f1fb2cc\r\n    rsp = 0x00007fb29f1fb0e0   r12 = 0x00007fb29f1fb280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29f1fb2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29f1fb2a8   rbp = 0x00007fb29f1fb250\r\n    rsp = 0x00007fb29f1fb1b0   r12 = 0x00007fb29f1fb1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137c6\r\n    r15 = 0x0000000000000de9   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee400222b08   rbp = 0x00007fb29f1fb320\r\n    rsp = 0x00007fb29f1fb260   r12 = 0x00007fb29f1fb268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x000000129548fd83\r\n    r15 = 0x000000000394f000   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee400222b08   rbp = 0x00007fb29f1fb3b0\r\n    rsp = 0x00007fb29f1fb330   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x000000000394f045\r\n    r15 = 0x000000000394f045   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee400222af8   rbp = 0x00007fb29f1fb3c0\r\n    rsp = 0x00007fb29f1fb3c0   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x000000000394f045   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee400222af8   rbp = 0x00007fb29f1fb3f0\r\n    rsp = 0x00007fb29f1fb3d0   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x000000000394f045   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b480   rbp = 0x00007fb29f1fb4c0\r\n    rsp = 0x00007fb29f1fb400   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb29f1fb410\r\n    r15 = 0x00007fb29f1fb450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x00002ee40026b480   rbp = 0x00007fb29f1fb4e0\r\n    rsp = 0x00007fb29f1fb4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f1fc258   r14 = 0x00002ee40026b480\r\n    r15 = 0x00007fb29f1fc6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x00002ee40026b480   rbp = 0x00007fb29f1fb510\r\n    rsp = 0x00007fb29f1fb4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f1fc258   r14 = 0x00002ee40026b480\r\n    r15 = 0x00007fb29f1fc6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29f1fc6c0   rbp = 0x00007fb29f1fb550\r\n    rsp = 0x00007fb29f1fb520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f1fc258   r14 = 0x00002ee40026b480\r\n    r15 = 0x00007fb29f1fc6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29f1fccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f1fb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ab10\r\n    r15 = 0x00007fb29e9fc000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f1fb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ab10\r\n    r15 = 0x00007fb29e9fc000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 5\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29e9fa2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29e9fa2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29e9fa0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29e9fa1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29e9fa2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29e9fa2a8   rbp = 0x00007fb29e9fa2cc\r\n    rsp = 0x00007fb29e9fa0e0   r12 = 0x00007fb29e9fa280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29e9fa2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29e9fa2a8   rbp = 0x00007fb29e9fa250\r\n    rsp = 0x00007fb29e9fa1b0   r12 = 0x00007fb29e9fa1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x000000000000033f   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee40029c8d0   rbp = 0x00007fb29e9fa320\r\n    rsp = 0x00007fb29e9fa260   r12 = 0x00007fb29e9fa268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19a00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee40029c8d0   rbp = 0x00007fb29e9fa3b0\r\n    rsp = 0x00007fb29e9fa330   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a19a51\r\n    r15 = 0x0000000003a19a51   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee40029c8c0   rbp = 0x00007fb29e9fa3c0\r\n    rsp = 0x00007fb29e9fa3c0   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19a51   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee40029c8c0   rbp = 0x00007fb29e9fa3f0\r\n    rsp = 0x00007fb29e9fa3d0   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19a51   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b520   rbp = 0x00007fb29e9fa4c0\r\n    rsp = 0x00007fb29e9fa400   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb29e9fa410\r\n    r15 = 0x00007fb29e9fa450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunSharedWorker() [worker_thread.cc : 332 + 0x5]\r\n    rbx = 0x00002ee40026b520   rbp = 0x00007fb29e9fa4e0\r\n    rsp = 0x00007fb29e9fa4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e9fb258   r14 = 0x00002ee40026b520\r\n    r15 = 0x00007fb29e9fb6c0   rip = 0x0000564ed6e3a28d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 305 + 0x8]\r\n    rbx = 0x00002ee40026b520   rbp = 0x00007fb29e9fa510\r\n    rsp = 0x00007fb29e9fa4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e9fb258   r14 = 0x00002ee40026b520\r\n    r15 = 0x00007fb29e9fb6c0   rip = 0x0000564ed6e3a181\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29e9fb6c0   rbp = 0x00007fb29e9fa550\r\n    rsp = 0x00007fb29e9fa520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e9fb258   r14 = 0x00002ee40026b520\r\n    r15 = 0x00007fb29e9fb6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29e9fbcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e9fa560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3abf0\r\n    r15 = 0x00007fb29e1fb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e9fa600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3abf0\r\n    r15 = 0x00007fb29e1fb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 6\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29e1f92a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29e1f92d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29e1f90a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29e1f91c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29e1f92d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29e1f92a8   rbp = 0x00007fb29e1f92cc\r\n    rsp = 0x00007fb29e1f90e0   r12 = 0x00007fb29e1f9280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29e1f92d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29e1f92a8   rbp = 0x00007fb29e1f9250\r\n    rsp = 0x00007fb29e1f91b0   r12 = 0x00007fb29e1f91b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x0000000000000342   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee400222bc8   rbp = 0x00007fb29e1f9320\r\n    rsp = 0x00007fb29e1f9260   r12 = 0x00007fb29e1f9268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a15a00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee400222bc8   rbp = 0x00007fb29e1f93b0\r\n    rsp = 0x00007fb29e1f9330   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a15af5\r\n    r15 = 0x0000000003a15af5   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee400222bb8   rbp = 0x00007fb29e1f93c0\r\n    rsp = 0x00007fb29e1f93c0   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a15af5   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee400222bb8   rbp = 0x00007fb29e1f93f0\r\n    rsp = 0x00007fb29e1f93d0   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a15af5   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b5c0   rbp = 0x00007fb29e1f94c0\r\n    rsp = 0x00007fb29e1f9400   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb29e1f9410\r\n    r15 = 0x00007fb29e1f9450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x00002ee40026b5c0   rbp = 0x00007fb29e1f94e0\r\n    rsp = 0x00007fb29e1f94d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e1fa258   r14 = 0x00002ee40026b5c0\r\n    r15 = 0x00007fb29e1fa6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x00002ee40026b5c0   rbp = 0x00007fb29e1f9510\r\n    rsp = 0x00007fb29e1f94f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e1fa258   r14 = 0x00002ee40026b5c0\r\n    r15 = 0x00007fb29e1fa6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29e1fa6c0   rbp = 0x00007fb29e1f9550\r\n    rsp = 0x00007fb29e1f9520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e1fa258   r14 = 0x00002ee40026b5c0\r\n    r15 = 0x00007fb29e1fa6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29e1facdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e1f9560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb29d9fa000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e1f9600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb29d9fa000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 7\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29d1f72a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29d1f72d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29d1f70a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29d1f71c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29d1f72d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29d1f72a8   rbp = 0x00007fb29d1f72cc\r\n    rsp = 0x00007fb29d1f70e0   r12 = 0x00007fb29d1f7280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29d1f72d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29d1f72a8   rbp = 0x00007fb29d1f7250\r\n    rsp = 0x00007fb29d1f71b0   r12 = 0x00007fb29d1f71b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x0000000000000414   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee400222b68   rbp = 0x00007fb29d1f7320\r\n    rsp = 0x00007fb29d1f7260   r12 = 0x00007fb29d1f7268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19e00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee400222b68   rbp = 0x00007fb29d1f73b0\r\n    rsp = 0x00007fb29d1f7330   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a19e57\r\n    r15 = 0x0000000003a19e57   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee400222b58   rbp = 0x00007fb29d1f73c0\r\n    rsp = 0x00007fb29d1f73c0   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19e57   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee400222b58   rbp = 0x00007fb29d1f73f0\r\n    rsp = 0x00007fb29d1f73d0   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19e57   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b8e0   rbp = 0x00007fb29d1f74c0\r\n    rsp = 0x00007fb29d1f7400   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000000000003\r\n    r15 = 0x00007fb29d1f7450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x00002ee40026b8e0   rbp = 0x00007fb29d1f74e0\r\n    rsp = 0x00007fb29d1f74d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d1f8258   r14 = 0x00002ee40026b8e0\r\n    r15 = 0x00007fb29d1f86c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x00002ee40026b8e0   rbp = 0x00007fb29d1f7510\r\n    rsp = 0x00007fb29d1f74f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d1f8258   r14 = 0x00002ee40026b8e0\r\n    r15 = 0x00007fb29d1f86c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29d1f86c0   rbp = 0x00007fb29d1f7550\r\n    rsp = 0x00007fb29d1f7520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d1f8258   r14 = 0x00002ee40026b8e0\r\n    r15 = 0x00007fb29d1f86c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29d1f8cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d1f7560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fadc0\r\n    r15 = 0x00007fb29c9f8000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d1f7600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fadc0\r\n    r15 = 0x00007fb29c9f8000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 8\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb29d9f80b0   rdi = 0x0000000000000021\r\n    rbp = 0x00007fb29d9f8280   rsp = 0x00007fb29d9f8040\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000000\r\n    r10 = 0x00000000ffffffff   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb29d9f8290   r13 = 0x7fffffffffffffff\r\n    r14 = 0x0000054c00070700   r15 = 0x00007fb29d9f80b0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29d9f8280\r\n    rsp = 0x00007fb29d9f8070   r12 = 0x00007fb29d9f8290\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c00070700\r\n    r15 = 0x00007fb29d9f80b0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29d9f8300\r\n    rsp = 0x00007fb29d9f8290   r12 = 0x00007fb29d9f8290\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00002ee40030a3e8\r\n    r15 = 0x0000054c00070700   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee40030a300   rbp = 0x00007fb29d9f8350\r\n    rsp = 0x00007fb29d9f8310   r12 = 0x00002ee40030a318\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee40030a528   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb29d9f84c0   rbp = 0x00007fb29d9f8430\r\n    rsp = 0x00007fb29d9f8360   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29d9f83b0\r\n    r15 = 0x00007fb29d9f8440   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb29d9f84c0   rbp = 0x00007fb29d9f8470\r\n    rsp = 0x00007fb29d9f8440   r12 = 0x00007fb29d9f84c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29d9f8440\r\n    r15 = 0x00002ee40029cd30   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!content::BrowserProcessIOThread::IOThreadRun(base::RunLoop*) [browser_process_io_thread.cc : 118 + 0xb]\r\n    rbx = 0x00007fb29d9f84c0   rbp = 0x00007fb29d9f84b0\r\n    rsp = 0x00007fb29d9f8480   r12 = 0x00007fb29d9f84c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00002ee40029cd20\r\n    r15 = 0x00002ee40029cd30   rip = 0x0000564ed5df9bff\r\n    Found by: call frame info\r\n 7  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x00002ee40029cd20   rbp = 0x00007fb29d9f8510\r\n    rsp = 0x00007fb29d9f84c0   r12 = 0x00007fb29d9f84c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000054c00020820\r\n    r15 = 0x00002ee40029cd30   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 8  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29d9f96c0   rbp = 0x00007fb29d9f8550\r\n    rsp = 0x00007fb29d9f8520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d9f9258   r14 = 0x00002ee40029cd20\r\n    r15 = 0x00007fb29d9f96c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 9  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29d9f9cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d9f8560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac30\r\n    r15 = 0x00007fb29d1f9000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n10  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d9f8600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac30\r\n    r15 = 0x00007fb29d1f9000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 9\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29c9f61d8\r\n    rsi = 0x0000000000000189   rdi = 0x00007fb29c9f6200\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29c9f5ff0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb29c9f61b0\r\n    r14 = 0x0000000000000000   r15 = 0x00007fb29c9f6200\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x00007fb29c9f61d8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c9f6030   r12 = 0x00007fb29c9f61fc\r\n    r13 = 0x00007fb29c9f61b0   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb29c9f6200   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::Wait() [condition_variable_posix.cc : 106 + 0x8]\r\n    rbx = 0x00007fb29c9f61d8   rbp = 0x00007fb29c9f6180\r\n    rsp = 0x00007fb29c9f6100   r12 = 0x00007fb29c9f6198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e536e5\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 194 + 0x5]\r\n    rbx = 0x0000054c00010940   rbp = 0x00007fb29c9f6250\r\n    rsp = 0x00007fb29c9f6190   r12 = 0x00007fb29c9f6198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e7b74f\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::Wait() [waitable_event.cc : 39 + 0x8]\r\n    rbx = 0x0000054c00010940   rbp = 0x00007fb29c9f62e0\r\n    rsp = 0x00007fb29c9f6260   r12 = 0x00007fb29c9f62f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00002ee40030cbe8\r\n    r15 = 0x0000054c00010940   rip = 0x0000564ed6dfcd5c\r\n    Found by: call frame info\r\n 8  electron!base::MessagePumpDefault::Run(base::MessagePump::Delegate*) [message_pump_default.cc : 56 + 0x8]\r\n    rbx = 0x0000054c00010930   rbp = 0x00007fb29c9f6340\r\n    rsp = 0x00007fb29c9f62f0   r12 = 0x00007fb29c9f62f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00002ee40030cbe8\r\n    r15 = 0x0000054c00010940   rip = 0x0000564ed6dbbd94\r\n    Found by: call frame info\r\n 9  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee40030cb00   rbp = 0x00007fb29c9f6390\r\n    rsp = 0x00007fb29c9f6350   r12 = 0x00002ee40030cb18\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee40030cd28   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n10  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb29c9f64c0   rbp = 0x00007fb29c9f6470\r\n    rsp = 0x00007fb29c9f63a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29c9f63f0\r\n    r15 = 0x00007fb29c9f6480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n11  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb29c9f64c0   rbp = 0x00007fb29c9f64b0\r\n    rsp = 0x00007fb29c9f6480   r12 = 0x00007fb29c9f64c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29c9f6480\r\n    r15 = 0x00002ee400241210   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n12  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x00002ee400241200   rbp = 0x00007fb29c9f6510\r\n    rsp = 0x00007fb29c9f64c0   r12 = 0x00007fb29c9f64c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000000000000000\r\n    r15 = 0x00002ee400241210   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29c9f76c0   rbp = 0x00007fb29c9f6550\r\n    rsp = 0x00007fb29c9f6520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29c9f7258   r14 = 0x00002ee400241200\r\n    r15 = 0x00007fb29c9f76c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29c9f7cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c9f6560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac10\r\n    r15 = 0x00007fb29c1f7000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c9f6600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac10\r\n    r15 = 0x00007fb29c1f7000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 10\r\n 0  libc.so.6!__GI_epoll_pwait [epoll_pwait.c : 40 + 0x2f]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000400\r\n    rcx = 0x00007fb2a331e3c6   rbx = 0x0000000000000030\r\n    rsi = 0x00007fb29c1f1720   rdi = 0x0000000000000030\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29c1f16e0\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000008\r\n    r10 = 0x0000000000003a92   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00099000   r13 = 0x0000054c000990c8\r\n    r14 = 0x00007fb29c1f4720   r15 = 0x0000000000000030\r\n    rip = 0x00007fb2a331e3c6\r\n    Found by: given as instruction pointer in context\r\n 1  electron!uv__io_poll [linux.c : 1368 + 0x1a]\r\n    rbx = 0x0000000000000030   rbp = 0x00007fb29c1f5490\r\n    rsp = 0x00007fb29c1f1710   r12 = 0x0000054c00099000\r\n    r13 = 0x0000054c000990c8   r14 = 0x00007fb29c1f4720\r\n    r15 = 0x0000000000000030   rip = 0x0000564ed352ed99\r\n    Found by: call frame info\r\n 2  electron!uv_run [core.c : 447 + 0x8]\r\n    rbx = 0x0000054c000dc5e8   rbp = 0x00007fb29c1f5500\r\n    rsp = 0x00007fb29c1f54a0   r12 = 0x0000000000000000\r\n    r13 = 0x0000054c000dc630   r14 = 0x00007fb29c1f54c0\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed351e725\r\n    Found by: call frame info\r\n 3  electron!node::WorkerThreadsTaskRunner::DelayedTaskScheduler::Run() [node_platform.cc : 95 + 0xa]\r\n    rbx = 0x0000054c000dc500   rbp = 0x00007fb29c1f5550\r\n    rsp = 0x00007fb29c1f5510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x0000054c000dc5e8\r\n    r15 = 0x00007fb29b9f6000   rip = 0x0000564edb1328ec\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29c1f6cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c1f5560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b9f6000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c1f5600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b9f6000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 11\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c000c0040\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c000c006c\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29b9f43d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c000c0018\r\n    r14 = 0x0000000000000004   r15 = 0x0000054c000c006c\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c000c0040   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b9f4410   r12 = 0x0000054c000c0064\r\n    r13 = 0x0000054c000c0018   r14 = 0x0000000000000004\r\n    r15 = 0x0000054c000c006c   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000054c00010ea0   rbp = 0x00007fb29b9f44e0\r\n    rsp = 0x00007fb29b9f44e0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c0064d4c0   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!node::(anonymous namespace)::PlatformWorkerThread(void*) [node_mutex.h : 175 + 0xb]\r\n    rbx = 0x0000054c00010ea0   rbp = 0x00007fb29b9f4550\r\n    rsp = 0x00007fb29b9f44f0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c0064d4c0   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564edb13074c\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29b9f5cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b9f4560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b1f5000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b9f4600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b1f5000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 12\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c000c0040\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c000c006c\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29b1f33d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c000c0018\r\n    r14 = 0x0000000000000004   r15 = 0x0000054c000c006c\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c000c0040   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b1f3410   r12 = 0x0000054c000c0064\r\n    r13 = 0x0000054c000c0018   r14 = 0x0000000000000004\r\n    r15 = 0x0000054c000c006c   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000054c00010e70   rbp = 0x00007fb29b1f34e0\r\n    rsp = 0x00007fb29b1f34e0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e1f120   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!node::(anonymous namespace)::PlatformWorkerThread(void*) [node_mutex.h : 175 + 0xb]\r\n    rbx = 0x0000054c00010e70   rbp = 0x00007fb29b1f3550\r\n    rsp = 0x00007fb29b1f34f0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e1f120   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564edb13074c\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29b1f4cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b1f3560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a9f4000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b1f3600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a9f4000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 13\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c000c0040\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c000c0068\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29a9f23d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c000c0018\r\n    r14 = 0x0000000000000000   r15 = 0x0000054c000c0068\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c000c0040   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29a9f2410   r12 = 0x0000054c000c0064\r\n    r13 = 0x0000054c000c0018   r14 = 0x0000000000000000\r\n    r15 = 0x0000054c000c0068   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000054c00010e10   rbp = 0x00007fb29a9f24e0\r\n    rsp = 0x00007fb29a9f24e0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e2bd80   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!node::(anonymous namespace)::PlatformWorkerThread(void*) [node_mutex.h : 175 + 0xb]\r\n    rbx = 0x0000054c00010e10   rbp = 0x00007fb29a9f2550\r\n    rsp = 0x00007fb29a9f24f0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e2bd80   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564edb13074c\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29a9f3cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29a9f2560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a1f3000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29a9f2600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a1f3000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 14\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbbf1558\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbbf1558\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2a50f5490\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000019\r\n    r14 = 0x0000564edbbf14a8   r15 = 0x00007fb2a50ee000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__new_sem_wait_slow64 [sem_waitcommon.c : 183 + 0x8]\r\n    rbx = 0x0000564edbbf1558   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a50f54d0   r12 = 0x00007fb2a50f54d0\r\n    r13 = 0x0000000000000019   r14 = 0x0000564edbbf14a8\r\n    r15 = 0x00007fb2a50ee000   rip = 0x00007fb2a32976d0\r\n    Found by: call frame info\r\n 4  electron!uv_sem_wait [thread.c : 639 + 0x8]\r\n    rbx = 0x0000564edbbf1558   rbp = 0x00007fb2a50f5530\r\n    rsp = 0x00007fb2a50f5520   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x0000564edbbf14a8\r\n    r15 = 0x00007fb2a50ee000   rip = 0x0000564ed352a276\r\n    Found by: call frame info\r\n 5  electron!node::inspector::(anonymous namespace)::StartIoThreadMain(void*) [inspector_agent.cc : 85 + 0x8]\r\n    rbx = 0x0000564edbbf1558   rbp = 0x00007fb2a50f5550\r\n    rsp = 0x00007fb2a50f5540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x0000564edbbf14a8\r\n    r15 = 0x00007fb2a50ee000   rip = 0x0000564edb1e8fac\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a50f6cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a50f5560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x00007fffffa3a6d0\r\n    r15 = 0x00007fb2a50ee000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a50f5600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x00007fffffa3a6d0\r\n    r15 = 0x00007fb2a50ee000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 15\r\n 0  libc.so.6!__GI_epoll_pwait [epoll_pwait.c : 40 + 0x2f]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000400\r\n    rcx = 0x00007fb2a331e3c6   rbx = 0x0000000000000038\r\n    rsi = 0x00007fb2151ea1c0   rdi = 0x0000000000000038\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2151ea180\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000008\r\n    r10 = 0x00000000ffffffff   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00099800   r13 = 0x0000054c000998c8\r\n    r14 = 0x00007fb2151ed1c0   r15 = 0x0000000000000038\r\n    rip = 0x00007fb2a331e3c6\r\n    Found by: given as instruction pointer in context\r\n 1  electron!uv__io_poll [linux.c : 1368 + 0x1a]\r\n    rbx = 0x0000000000000038   rbp = 0x00007fb2151edf30\r\n    rsp = 0x00007fb2151ea1b0   r12 = 0x0000054c00099800\r\n    r13 = 0x0000054c000998c8   r14 = 0x00007fb2151ed1c0\r\n    r15 = 0x0000000000000038   rip = 0x0000564ed352ed99\r\n    Found by: call frame info\r\n 2  electron!uv_run [core.c : 447 + 0x8]\r\n    rbx = 0x00007fb2151edfc0   rbp = 0x00007fb2151edfa0\r\n    rsp = 0x00007fb2151edf40   r12 = 0x0000054c00070f00\r\n    r13 = 0x00007fb2151ee008   r14 = 0x00007fb2151edf60\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed351e725\r\n    Found by: call frame info\r\n 3  electron!node::inspector::InspectorIo::ThreadMain() [inspector_io.cc : 318 + 0xa]\r\n    rbx = 0x00007fb2151edfc0   rbp = 0x00007fb2151ee550\r\n    rsp = 0x00007fb2151edfb0   r12 = 0x0000054c00070fd8\r\n    r13 = 0x0000054c00070fd8   r14 = 0x0000054c00015ff0\r\n    r15 = 0x0000054c00070fc0   rip = 0x0000564edb1eced8\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2151efcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2151ee560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a3e0\r\n    r15 = 0x00007fb2149ef000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2151ee600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a3e0\r\n    r15 = 0x00007fb2149ef000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 16\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d4\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2149ed400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000004   r15 = 0x0000564edbac02d4\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2149ed440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000004\r\n    r15 = 0x0000564edbac02d4   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2149ed510\r\n    rsp = 0x00007fb2149ed510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2149ed550\r\n    rsp = 0x00007fb2149ed520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2149eecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2149ed560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2141ee000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2149ed600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2141ee000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 17\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2141ec400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000000   r15 = 0x0000564edbac02d0\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2141ec440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edbac02d0   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2141ec510\r\n    rsp = 0x00007fb2141ec510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2141ec550\r\n    rsp = 0x00007fb2141ec520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2141edcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2141ec560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2139ed000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2141ec600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2139ed000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 18\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2139eb400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000000   r15 = 0x0000564edbac02d0\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2139eb440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edbac02d0   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2139eb510\r\n    rsp = 0x00007fb2139eb510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2139eb550\r\n    rsp = 0x00007fb2139eb520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2139eccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2139eb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2131ec000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2139eb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2131ec000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 19\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2131ea400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000000   r15 = 0x0000564edbac02d0\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2131ea440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edbac02d0   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2131ea510\r\n    rsp = 0x00007fb2131ea510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2131ea550\r\n    rsp = 0x00007fb2131ea520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2131ebcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2131ea560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2129eb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2131ea600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2129eb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 20\r\n 0  libc.so.6!syscall [syscall.S : 38 + 0x0]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000002\r\n    rcx = 0x00007fb2a3315ded   rbx = 0x0000054c002345a0\r\n    rsi = 0x0000000000000080   rdi = 0x0000054c002345b0\r\n    rbp = 0x00007fb2103ff1c8   rsp = 0x00007fb2103fe468\r\n     r8 = 0x00007fb2103fe3f0    r9 = 0x0000054c002345a0\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000002   r13 = 0x0000054c002345b0\r\n    r14 = 0x0000000000000000   r15 = 0x00007fb2a478290c\r\n    rip = 0x00007fb2a3315ded\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_cond_wait [gthread-posix.c : 1475 + 0x25]\r\n    rbx = 0x0000054c002345a0   rbp = 0x00007fb2103ff1c8\r\n    rsp = 0x00007fb2103fe470   r12 = 0x0000000000000002\r\n    r13 = 0x0000054c002345b0   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb2a478290c   rip = 0x00007fb2a4768a74\r\n    Found by: call frame info\r\n 2  libglib-2.0.so.0!g_async_queue_pop_intern_unlocked [gasyncqueue.c : 425 + 0xb]\r\n    rbx = 0x0000054c002345a0   rbp = 0xffffffffffffffff\r\n    rsp = 0x00007fb2103fe4a0   r12 = 0x0000054c002345b8\r\n    r13 = 0x0000000000000001   r14 = 0x0000054c002345a8\r\n    r15 = 0x00007fb2a478290c   rip = 0x00007fb2a46dfb2b\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_thread_pool_spawn_thread [gthreadpool.c : 311 + 0xc]\r\n    rbx = 0x00007fffffa39690   rbp = 0x00007fb2103fe4e0\r\n    rsp = 0x00007fb2103fe4d0   r12 = 0x00007fb2a47fef40\r\n    r13 = 0x00007fb2a4745400   r14 = 0x00007fb2103fe4d8\r\n    r15 = 0x00007fb2a478290c   rip = 0x00007fb2a4744baa\r\n    Found by: call frame info\r\n 4  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00700c60   rbp = 0x0000054c00709fe0\r\n    rsp = 0x00007fb2103fe540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39bd0\r\n    r15 = 0x00007fb20fbff000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 5  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2103ffcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2103fe560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39bd0\r\n    r15 = 0x00007fb20fbff000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 6  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2103fe600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39bd0\r\n    r15 = 0x00007fb20fbff000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 21\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x0000000000000001\r\n    rsi = 0x0000000000000001   rdi = 0x0000054c00632c80\r\n    rbp = 0x0000054c0004ac40   rsp = 0x00007fb20fbfd480\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000001\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00632c80   r13 = 0x00007fb2a47211c0\r\n    r14 = 0x00000000ffffffff   r15 = 0x0000000000000001\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_main_context_poll [gmain.c : 4584 + 0xa]\r\n \r\n    Found by: inline record\r\n 2  libglib-2.0.so.0!g_main_context_iterate [gmain.c : 4271 + 0xb]\r\n    rbx = 0x0000000000000001   rbp = 0x0000054c0004ac40\r\n    rsp = 0x00007fb20fbfd4b0   r12 = 0x0000054c00632c80\r\n    r13 = 0x00007fb2a47211c0   r14 = 0x00000000ffffffff\r\n    r15 = 0x0000000000000001   rip = 0x00007fb2a476f26e\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_main_context_iteration [gmain.c : 4343 + 0x14]\r\n    rbx = 0x0000054c0004ac40   rbp = 0x0000000000000001\r\n    rsp = 0x00007fb20fbfd510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a4713220\r\n    Found by: call frame info\r\n 4  libglib-2.0.so.0!glib_worker_main [gmain.c : 6455 + 0x11]\r\n    rbx = 0x00007fb2a47feb48   rbp = 0x0000054c00632c80\r\n    rsp = 0x00007fb20fbfd530   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a4713271\r\n    Found by: call frame info\r\n 5  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00701800   rbp = 0x0000054c00632c80\r\n    rsp = 0x00007fb20fbfd540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20fbfecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20fbfd560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20fbfd600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 22\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x0000000000000002\r\n    rsi = 0x0000000000000002   rdi = 0x0000054c0070bfa0\r\n    rbp = 0x0000054c0004b540   rsp = 0x00007fb20f3fc480\r\n     r8 = 0x0000000000000000    r9 = 0x00007fb2a47fe380\r\n    r10 = 0x0000000000000010   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c0070bfa0   r13 = 0x00007fb2a47211c0\r\n    r14 = 0x00000000ffffffff   r15 = 0x0000000000000002\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_main_context_poll [gmain.c : 4584 + 0xa]\r\n \r\n    Found by: inline record\r\n 2  libglib-2.0.so.0!g_main_context_iterate [gmain.c : 4271 + 0xb]\r\n    rbx = 0x0000000000000002   rbp = 0x0000054c0004b540\r\n    rsp = 0x00007fb20f3fc4b0   r12 = 0x0000054c0070bfa0\r\n    r13 = 0x00007fb2a47211c0   r14 = 0x00000000ffffffff\r\n    r15 = 0x0000000000000002   rip = 0x00007fb2a476f26e\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_main_loop_run [gmain.c : 4479 + 0xf]\r\n    rbx = 0x0000054c0070bd80   rbp = 0x0000054c0070bd88\r\n    rsp = 0x00007fb20f3fc510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a4713c4f\r\n    Found by: call frame info\r\n 4  libgio-2.0.so.0!gdbus_shared_thread_func [gdbusprivate.c : 284 + 0x9]\r\n    rbx = 0x0000054c007116b0   rbp = 0x0000054c00632e30\r\n    rsp = 0x00007fb20f3fc530   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a45f70ba\r\n    Found by: call frame info\r\n 5  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00702040   rbp = 0x0000054c00632e30\r\n    rsp = 0x00007fb20f3fc540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20f3fdcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20f3fc560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20f3fc600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 23\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x0000000000000001\r\n    rsi = 0x0000000000000001   rdi = 0x0000054c00633de0\r\n    rbp = 0x0000054c0004b240   rsp = 0x00007fb20ebfb480\r\n     r8 = 0x0000000000000000    r9 = 0x00007fb2a47fe380\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00633de0   r13 = 0x00007fb2a47211c0\r\n    r14 = 0x00000000ffffffff   r15 = 0x0000000000000001\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_main_context_poll [gmain.c : 4584 + 0xa]\r\n \r\n    Found by: inline record\r\n 2  libglib-2.0.so.0!g_main_context_iterate [gmain.c : 4271 + 0xb]\r\n    rbx = 0x0000000000000001   rbp = 0x0000054c0004b240\r\n    rsp = 0x00007fb20ebfb4b0   r12 = 0x0000054c00633de0\r\n    r13 = 0x00007fb2a47211c0   r14 = 0x00000000ffffffff\r\n    r15 = 0x0000000000000001   rip = 0x00007fb2a476f26e\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_main_context_iteration [gmain.c : 4343 + 0x14]\r\n    rbx = 0x0000054c0004b240   rbp = 0x0000000000000001\r\n    rsp = 0x00007fb20ebfb510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a4713220\r\n    Found by: call frame info\r\n 4  libdconfsettings.so!dconf_gdbus_worker_thread [dconf-gdbus-thread.c : 82 + 0xd]\r\n    rbx = 0x0000054c0004b240   rbp = 0x0000054c00722ca0\r\n    rsp = 0x00007fb20ebfb530   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a150f20d\r\n    Found by: call frame info\r\n 5  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00703b40   rbp = 0x0000054c00722ca0\r\n    rsp = 0x00007fb20ebfb540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20ebfccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20ebfb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20ebfb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 24\r\n 0  libc.so.6!syscall [syscall.S : 38 + 0x0]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a3315ded   rbx = 0x0000000000000001\r\n    rsi = 0x0000000000000080   rdi = 0x0000054c00234d80\r\n    rbp = 0x0000054c00234d70   rsp = 0x00007fb20e3fa458\r\n     r8 = 0x0000000000000000    r9 = 0x000000000000000e\r\n    r10 = 0x00007fb20e3fa480   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000001\r\n    r14 = 0x0000054c00234d78   r15 = 0x00007fb20dbfb000\r\n    rip = 0x00007fb2a3315ded\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_cond_wait_until [gthread-posix.c : 1600 + 0x5]\r\n    rbx = 0x0000000000000001   rbp = 0x0000054c00234d70\r\n    rsp = 0x00007fb20e3fa460   r12 = 0x0000000000000000\r\n    r13 = 0x0000000000000001   r14 = 0x0000054c00234d78\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a4769040\r\n    Found by: call frame info\r\n 2  libglib-2.0.so.0!g_async_queue_pop_intern_unlocked [gasyncqueue.c : 428 + 0xe]\r\n    rbx = 0x0000054c00234d70   rbp = 0x0000001292081ba1\r\n    rsp = 0x00007fb20e3fa4c0   r12 = 0x0000054c00234d88\r\n    r13 = 0x0000000000000001   r14 = 0x0000054c00234d78\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a46dfb01\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_async_queue_timeout_pop [gasyncqueue.c : 551 + 0x10]\r\n    rbx = 0x0000054c00234d70   rbp = 0x0000001292081ba1\r\n    rsp = 0x00007fb20e3fa4f0   r12 = 0x0000000000000000\r\n    r13 = 0x0000000000000000   r14 = 0x0000000000000002\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a46dfc95\r\n    Found by: call frame info\r\n 4  libglib-2.0.so.0!g_thread_pool_wait_for_new_pool [gthreadpool.c : 181 + 0x7]\r\n \r\n    Found by: inline record\r\n 5  libglib-2.0.so.0!g_thread_pool_thread_proxy [gthreadpool.c : 408 + 0x8]\r\n    rbx = 0x0000054c00700cc0   rbp = 0x0000000000003a98\r\n    rsp = 0x00007fb20e3fa510   r12 = 0x0000000000000000\r\n    r13 = 0x0000000000000000   r14 = 0x0000000000000002\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a4745435\r\n    Found by: call frame info\r\n 6  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c0081dfe0   rbp = 0x0000054c0092e620\r\n    rsp = 0x00007fb20e3fa540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb2103fe260\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20e3fbcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20e3fa560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb2103fe260\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20e3fa600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb2103fe260\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 25\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb20dbf90f0   rdi = 0x0000000000000074\r\n    rbp = 0x00007fb20dbf92c0   rsp = 0x00007fb20dbf9080\r\n     r8 = 0x0000000000000000    r9 = 0x0000054c00e38000\r\n    r10 = 0x00000000ffffffff   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb20dbf92d0   r13 = 0x7fffffffffffffff\r\n    r14 = 0x0000054c00773870   r15 = 0x00007fb20dbf90f0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb20dbf92c0\r\n    rsp = 0x00007fb20dbf90b0   r12 = 0x00007fb20dbf92d0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c00773870\r\n    r15 = 0x00007fb20dbf90f0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb20dbf9340\r\n    rsp = 0x00007fb20dbf92d0   r12 = 0x00007fb20dbf92d0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c0016b2e8\r\n    r15 = 0x0000054c00773870   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x0000054c0016b200   rbp = 0x00007fb20dbf9390\r\n    rsp = 0x00007fb20dbf9350   r12 = 0x0000054c0016b218\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x0000054c0016b428   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb20dbf94c0   rbp = 0x00007fb20dbf9470\r\n    rsp = 0x00007fb20dbf93a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20dbf93f0\r\n    r15 = 0x00007fb20dbf9480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb20dbf94c0   rbp = 0x00007fb20dbf94b0\r\n    rsp = 0x00007fb20dbf9480   r12 = 0x00007fb20dbf94c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20dbf9480\r\n    r15 = 0x0000054c0001eab0   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x0000054c0001eaa0   rbp = 0x00007fb20dbf9510\r\n    rsp = 0x00007fb20dbf94c0   r12 = 0x00007fb20dbf94c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000054c0091cc00\r\n    r15 = 0x0000054c0001eab0   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 7  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20dbfa6c0   rbp = 0x00007fb20dbf9550\r\n    rsp = 0x00007fb20dbf9520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20dbfa258   r14 = 0x0000054c0001eaa0\r\n    r15 = 0x00007fb20dbfa6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 8  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20dbfacdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20dbf9560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a9e0\r\n    r15 = 0x00007fb20d3fa000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 9  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20dbf9600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a9e0\r\n    r15 = 0x00007fb20d3fa000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 26\r\n 0  libc.so.6!__GI___libc_read [read.c : 26 + 0x1a]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!read [read.c : 24 + 0x1a]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000004\r\n    rcx = 0x00007fb2a330becc   rbx = 0x0000054c00e256b0\r\n    rsi = 0x00007fb2a14434ec   rdi = 0x000000000000005c\r\n    rbp = 0x00007fb2a1443510   rsp = 0x00007fb2a1443380\r\n     r8 = 0x0000000000000000    r9 = 0x0000564edbb0fe00\r\n    r10 = 0x00007fb2a32e391b   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb2a1444258\r\n    r14 = 0x00007fb2a14434ec   r15 = 0x0000000000000004\r\n    rip = 0x00007fb2a330becc\r\n    Found by: given as instruction pointer in context\r\n 2  electron!electron::(anonymous namespace)::ShutdownDetector::ThreadMain() [electron_browser_main_parts_posix.cc : 138 + 0xe]\r\n    rbx = 0x0000054c00e256b0   rbp = 0x00007fb2a1443510\r\n    rsp = 0x00007fb2a14433b0   r12 = 0x0000000000000000\r\n    r13 = 0x00007fb2a1444258   r14 = 0x00007fb2a14434ec\r\n    r15 = 0x0000000000000004   rip = 0x0000564ed36e323b\r\n    Found by: call frame info\r\n 3  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb2a14446c0   rbp = 0x00007fb2a1443550\r\n    rsp = 0x00007fb2a1443520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a1444258   r14 = 0x0000054c00e256b0\r\n    r15 = 0x00007fb2a14446c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a1444cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a1443560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a990\r\n    r15 = 0x00007fb2a143c000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a1443600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a990\r\n    r15 = 0x00007fb2a143c000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 27\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20cdfe2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20cdfe2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20cdfe0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20cdfe1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20cdfe2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20cdfe2a8   rbp = 0x00007fb20cdfe2cc\r\n    rsp = 0x00007fb20cdfe0e0   r12 = 0x00007fb20cdfe280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20cdfe2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20cdfe2a8   rbp = 0x00007fb20cdfe250\r\n    rsp = 0x00007fb20cdfe1b0   r12 = 0x00007fb20cdfe1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bc\r\n    r15 = 0x0000000000000412   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c0081c1c8   rbp = 0x00007fb20cdfe320\r\n    rsp = 0x00007fb20cdfe260   r12 = 0x00007fb20cdfe268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294b06700\r\n    r15 = 0x0000000003945b00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c0081c1c8   rbp = 0x00007fb20cdfe3b0\r\n    rsp = 0x00007fb20cdfe330   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003945b49\r\n    r15 = 0x0000000003945b49   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c0081c1b8   rbp = 0x00007fb20cdfe3c0\r\n    rsp = 0x00007fb20cdfe3c0   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003945b49   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c0081c1b8   rbp = 0x00007fb20cdfe3f0\r\n    rsp = 0x00007fb20cdfe3d0   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003945b49   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c0078b180   rbp = 0x00007fb20cdfe4c0\r\n    rsp = 0x00007fb20cdfe400   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb20cdfe410\r\n    r15 = 0x00007fb20cdfe450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x0000054c0078b180   rbp = 0x00007fb20cdfe4e0\r\n    rsp = 0x00007fb20cdfe4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20cdff258   r14 = 0x0000054c0078b180\r\n    r15 = 0x00007fb20cdff6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x0000054c0078b180   rbp = 0x00007fb20cdfe510\r\n    rsp = 0x00007fb20cdfe4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20cdff258   r14 = 0x0000054c0078b180\r\n    r15 = 0x00007fb20cdff6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20cdff6c0   rbp = 0x00007fb20cdfe550\r\n    rsp = 0x00007fb20cdfe520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20cdff258   r14 = 0x0000054c0078b180\r\n    r15 = 0x00007fb20cdff6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20cdffcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20cdfe560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb20c5ff000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20cdfe600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb20c5ff000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 28\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20c5fd2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20c5fd2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20c5fd0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20c5fd1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20c5fd2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20c5fd2a8   rbp = 0x00007fb20c5fd2cc\r\n    rsp = 0x00007fb20c5fd0e0   r12 = 0x00007fb20c5fd280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20c5fd2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20c5fd2a8   rbp = 0x00007fb20c5fd250\r\n    rsp = 0x00007fb20c5fd1b0   r12 = 0x00007fb20c5fd1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bc\r\n    r15 = 0x00000000000004a6   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c0074b3a8   rbp = 0x00007fb20c5fd320\r\n    rsp = 0x00007fb20c5fd260   r12 = 0x00007fb20c5fd268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294b06701\r\n    r15 = 0x0000000003951300   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c0074b3a8   rbp = 0x00007fb20c5fd3b0\r\n    rsp = 0x00007fb20c5fd330   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00000000039513ff\r\n    r15 = 0x00000000039513ff   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c0074b398   rbp = 0x00007fb20c5fd3c0\r\n    rsp = 0x00007fb20c5fd3c0   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513ff   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c0074b398   rbp = 0x00007fb20c5fd3f0\r\n    rsp = 0x00007fb20c5fd3d0   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513ff   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c0078b700   rbp = 0x00007fb20c5fd4c0\r\n    rsp = 0x00007fb20c5fd400   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000000000003\r\n    r15 = 0x00007fb20c5fd450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x0000054c0078b700   rbp = 0x00007fb20c5fd4e0\r\n    rsp = 0x00007fb20c5fd4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20c5fe258   r14 = 0x0000054c0078b700\r\n    r15 = 0x00007fb20c5fe6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x0000054c0078b700   rbp = 0x00007fb20c5fd510\r\n    rsp = 0x00007fb20c5fd4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20c5fe258   r14 = 0x0000054c0078b700\r\n    r15 = 0x00007fb20c5fe6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20c5fe6c0   rbp = 0x00007fb20c5fd550\r\n    rsp = 0x00007fb20c5fd520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20c5fe258   r14 = 0x0000054c0078b700\r\n    r15 = 0x00007fb20c5fe6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20c5fecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20c5fd560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20cdfde30\r\n    r15 = 0x00007fb20bdfe000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20c5fd600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20cdfde30\r\n    r15 = 0x00007fb20bdfe000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 29\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20bdfc2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20bdfc2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20bdfc0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20bdfc1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20bdfc2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20bdfc2a8   rbp = 0x00007fb20bdfc2cc\r\n    rsp = 0x00007fb20bdfc0e0   r12 = 0x00007fb20bdfc280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20bdfc2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20bdfc2a8   rbp = 0x00007fb20bdfc250\r\n    rsp = 0x00007fb20bdfc1b0   r12 = 0x00007fb20bdfc1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x000000000000032f   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c007ee230   rbp = 0x00007fb20bdfc320\r\n    rsp = 0x00007fb20bdfc260   r12 = 0x00007fb20bdfc268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19200   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c007ee230   rbp = 0x00007fb20bdfc3b0\r\n    rsp = 0x00007fb20bdfc330   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a192b9\r\n    r15 = 0x0000000003a192b9   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c007ee220   rbp = 0x00007fb20bdfc3c0\r\n    rsp = 0x00007fb20bdfc3c0   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a192b9   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c007ee220   rbp = 0x00007fb20bdfc3f0\r\n    rsp = 0x00007fb20bdfc3d0   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a192b9   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c0078a1b0   rbp = 0x00007fb20bdfc4c0\r\n    rsp = 0x00007fb20bdfc400   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb20bdfc410\r\n    r15 = 0x00007fb20bdfc450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunDedicatedWorker() [worker_thread.cc : 342 + 0x5]\r\n    rbx = 0x0000054c0078a1b0   rbp = 0x00007fb20bdfc4e0\r\n    rsp = 0x00007fb20bdfc4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20bdfd258   r14 = 0x0000054c0078a1b0\r\n    r15 = 0x00007fb20bdfd6c0   rip = 0x0000564ed6e3a2bd\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 308 + 0x8]\r\n    rbx = 0x0000054c0078a1b0   rbp = 0x00007fb20bdfc510\r\n    rsp = 0x00007fb20bdfc4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20bdfd258   r14 = 0x0000054c0078a1b0\r\n    r15 = 0x00007fb20bdfd6c0   rip = 0x0000564ed6e3a177\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20bdfd6c0   rbp = 0x00007fb20bdfc550\r\n    rsp = 0x00007fb20bdfc520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20bdfd258   r14 = 0x0000054c0078a1b0\r\n    r15 = 0x00007fb20bdfd6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20bdfdcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20bdfc560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa39d40\r\n    r15 = 0x00007fb20b5fd000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20bdfc600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa39d40\r\n    r15 = 0x00007fb20b5fd000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 30\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x00007fb20b5fb440\r\n    rsi = 0x0000000000000001   rdi = 0x00007fb20b5fb440\r\n    rbp = 0x00007fb20b5fb510   rsp = 0x00007fb20b5fb400\r\n     r8 = 0x0000000000000000    r9 = 0x0000564edbb0fe00\r\n    r10 = 0x00007fb2a32e391b   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb20b5fb448   r13 = 0x00007fb20b5fc258\r\n    r14 = 0x0000564edbb0b6f0   r15 = 0x00007fb20b5fb4e0\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::(anonymous namespace)::InotifyReaderThreadDelegate::ThreadMain() [file_path_watcher_inotify.cc : 299 + 0x12]\r\n    rbx = 0x00007fb20b5fb440   rbp = 0x00007fb20b5fb510\r\n    rsp = 0x00007fb20b5fb430   r12 = 0x00007fb20b5fb448\r\n    r13 = 0x00007fb20b5fc258   r14 = 0x0000564edbb0b6f0\r\n    r15 = 0x00007fb20b5fb4e0   rip = 0x0000564ed6e56dce\r\n    Found by: call frame info\r\n 2  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20b5fc6c0   rbp = 0x00007fb20b5fb550\r\n    rsp = 0x00007fb20b5fb520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20b5fc258   r14 = 0x0000564edbb0b6f0\r\n    r15 = 0x00007fb20b5fc6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 3  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20b5fccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20b5fb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29e1f8560\r\n    r15 = 0x00007fb20adfc000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 4  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20b5fb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29e1f8560\r\n    r15 = 0x00007fb20adfc000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 31\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c0003ad80\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c0003adac\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20adfa240\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c0003ad18\r\n    r14 = 0x0000000000000004   r15 = 0x0000054c0003adac\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c0003ad80   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20adfa280   r12 = 0x0000054c0003ada4\r\n    r13 = 0x0000054c0003ad18   r14 = 0x0000000000000004\r\n    r15 = 0x0000054c0003adac   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::Wait() [condition_variable_posix.cc : 106 + 0x8]\r\n    rbx = 0x0000054c0003ad80   rbp = 0x00007fb20adfa3d0\r\n    rsp = 0x00007fb20adfa350   r12 = 0x00007fb20adfa460\r\n    r13 = 0xaaaaaaaaaaaaaaaa   r14 = 0x0000054c0003ad00\r\n    r15 = 0x0000054c0003ad68   rip = 0x0000564ed6e536e5\r\n    Found by: call frame info\r\n 6  electron!cc::SingleThreadTaskGraphRunner::Run() [single_thread_task_graph_runner.cc : 132 + 0x5]\r\n    rbx = 0x0000054c0003ad18   rbp = 0x00007fb20adfa510\r\n    rsp = 0x00007fb20adfa3e0   r12 = 0x00007fb20adfa460\r\n    r13 = 0xaaaaaaaaaaaaaaaa   r14 = 0x0000054c0003ad00\r\n    r15 = 0x0000054c0003ad68   rip = 0x0000564ed810325a\r\n    Found by: call frame info\r\n 7  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20adfb6c0   rbp = 0x00007fb20adfa550\r\n    rsp = 0x00007fb20adfa520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20adfb258   r14 = 0x0000054c0074b660\r\n    r15 = 0x00007fb20adfb6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 8  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20adfbcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20adfa560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3aa20\r\n    r15 = 0x00007fb20a5fb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 9  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20adfa600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3aa20\r\n    r15 = 0x00007fb20a5fb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 32\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20a58b1d8\r\n    rsi = 0x0000000000000189   rdi = 0x00007fb20a58b200\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20a58aff0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb20a58b1b0\r\n    r14 = 0x0000000000000000   r15 = 0x00007fb20a58b200\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x00007fb20a58b1d8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20a58b030   r12 = 0x00007fb20a58b1fc\r\n    r13 = 0x00007fb20a58b1b0   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb20a58b200   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::Wait() [condition_variable_posix.cc : 106 + 0x8]\r\n    rbx = 0x00007fb20a58b1d8   rbp = 0x00007fb20a58b180\r\n    rsp = 0x00007fb20a58b100   r12 = 0x00007fb20a58b198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e536e5\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 194 + 0x5]\r\n    rbx = 0x0000054c00e1ce20   rbp = 0x00007fb20a58b250\r\n    rsp = 0x00007fb20a58b190   r12 = 0x00007fb20a58b198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e7b74f\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::Wait() [waitable_event.cc : 39 + 0x8]\r\n    rbx = 0x0000054c00e1ce20   rbp = 0x00007fb20a58b2e0\r\n    rsp = 0x00007fb20a58b260   r12 = 0x00007fb20a58b2f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c0016ba68\r\n    r15 = 0x0000054c00e1ce20   rip = 0x0000564ed6dfcd5c\r\n    Found by: call frame info\r\n 8  electron!base::MessagePumpDefault::Run(base::MessagePump::Delegate*) [message_pump_default.cc : 56 + 0x8]\r\n    rbx = 0x0000054c00e1ce10   rbp = 0x00007fb20a58b340\r\n    rsp = 0x00007fb20a58b2f0   r12 = 0x00007fb20a58b2f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c0016ba68\r\n    r15 = 0x0000054c00e1ce20   rip = 0x0000564ed6dbbd94\r\n    Found by: call frame info\r\n 9  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x0000054c0016b980   rbp = 0x00007fb20a58b390\r\n    rsp = 0x00007fb20a58b350   r12 = 0x0000054c0016b998\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x0000054c0016bba8   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n10  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb20a58b4c0   rbp = 0x00007fb20a58b470\r\n    rsp = 0x00007fb20a58b3a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20a58b3f0\r\n    r15 = 0x00007fb20a58b480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n11  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb20a58b4c0   rbp = 0x00007fb20a58b4b0\r\n    rsp = 0x00007fb20a58b480   r12 = 0x00007fb20a58b4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20a58b480\r\n    r15 = 0x0000054c00d3bac8   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n12  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x0000054c00d3bab8   rbp = 0x00007fb20a58b510\r\n    rsp = 0x00007fb20a58b4c0   r12 = 0x00007fb20a58b4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000000000000000\r\n    r15 = 0x0000054c00d3bac8   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20a58c6c0   rbp = 0x00007fb20a58b550\r\n    rsp = 0x00007fb20a58b520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20a58c258   r14 = 0x0000054c00d3bab8\r\n    r15 = 0x00007fb20a58c6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20a58ccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20a58b560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3a820\r\n    r15 = 0x00007fb209d8c000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20a58b600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3a820\r\n    r15 = 0x00007fb209d8c000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 33\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000001\r\n    rcx = 0x00007fb2a331e546   rbx = 0x0000054c00094000\r\n    rsi = 0x00007fb209497504   rdi = 0x0000000000000029\r\n    rbp = 0x00007fb209497530   rsp = 0x00007fb2094974d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000004dc6   r11 = 0x0000000000000293\r\n    r12 = 0xaaaaaaaaaaaaaaaa   r13 = 0x0000000000000002\r\n    r14 = 0x0000000000004dc6   r15 = 0x00007fb209497504\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!electron::NodeBindingsLinux::PollEvents() [node_bindings_linux.cc : 31 + 0x10]\r\n    rbx = 0x0000054c00094000   rbp = 0x00007fb209497530\r\n    rsp = 0x00007fb209497500   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000002   r14 = 0x0000000000004dc6\r\n    r15 = 0x00007fb209497504   rip = 0x0000564ed36f3b70\r\n    Found by: call frame info\r\n 2  electron!electron::NodeBindings::EmbedThreadRunner(void*) [node_bindings.cc : 929 + 0x8]\r\n    rbx = 0x0000054c00094000   rbp = 0x00007fb209497550\r\n    rsp = 0x00007fb209497540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x0000054c00094388\r\n    r15 = 0x00007fb208c98000   rip = 0x0000564ed36bb754\r\n    Found by: call frame info\r\n 3  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb209498cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb209497560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3ab90\r\n    r15 = 0x00007fb208c98000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 4  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb209497600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3ab90\r\n    r15 = 0x00007fb208c98000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 34\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb207bae2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb207bae2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb207bae0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb207bae1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb207bae2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb207bae2a8   rbp = 0x00007fb207bae2cc\r\n    rsp = 0x00007fb207bae0e0   r12 = 0x00007fb207bae280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb207bae2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb207bae2a8   rbp = 0x00007fb207bae250\r\n    rsp = 0x00007fb207bae1b0   r12 = 0x00007fb207bae1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x00000000000000b3   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c007edcf0   rbp = 0x00007fb207bae320\r\n    rsp = 0x00007fb207bae260   r12 = 0x00007fb207bae268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19700   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c007edcf0   rbp = 0x00007fb207bae3b0\r\n    rsp = 0x00007fb207bae330   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a1978b\r\n    r15 = 0x0000000003a1978b   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c007edce0   rbp = 0x00007fb207bae3c0\r\n    rsp = 0x00007fb207bae3c0   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a1978b   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c007edce0   rbp = 0x00007fb207bae3f0\r\n    rsp = 0x00007fb207bae3d0   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a1978b   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c00e465d0   rbp = 0x00007fb207bae4c0\r\n    rsp = 0x00007fb207bae400   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb207bae410\r\n    r15 = 0x00007fb207bae450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunSharedWorker() [worker_thread.cc : 332 + 0x5]\r\n    rbx = 0x0000054c00e465d0   rbp = 0x00007fb207bae4e0\r\n    rsp = 0x00007fb207bae4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb207baf258   r14 = 0x0000054c00e465d0\r\n    r15 = 0x00007fb207baf6c0   rip = 0x0000564ed6e3a28d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 305 + 0x8]\r\n    rbx = 0x0000054c00e465d0   rbp = 0x00007fb207bae510\r\n    rsp = 0x00007fb207bae4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb207baf258   r14 = 0x0000054c00e465d0\r\n    r15 = 0x00007fb207baf6c0   rip = 0x0000564ed6e3a181\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb207baf6c0   rbp = 0x00007fb207bae550\r\n    rsp = 0x00007fb207bae520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb207baf258   r14 = 0x0000054c00e465d0\r\n    r15 = 0x00007fb207baf6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb207bafcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb207bae560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa38d50\r\n    r15 = 0x00007fb2073af000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb207bae600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa38d50\r\n    r15 = 0x00007fb2073af000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 35\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20738b2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20738b2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20738b0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20738b1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20738b2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20738b2a8   rbp = 0x00007fb20738b2cc\r\n    rsp = 0x00007fb20738b0e0   r12 = 0x00007fb20738b280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20738b2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20738b2a8   rbp = 0x00007fb20738b250\r\n    rsp = 0x00007fb20738b1b0   r12 = 0x00007fb20738b1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bc\r\n    r15 = 0x00000000000004e7   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c00781548   rbp = 0x00007fb20738b320\r\n    rsp = 0x00007fb20738b260   r12 = 0x00007fb20738b268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294b06701\r\n    r15 = 0x0000000003951300   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c00781548   rbp = 0x00007fb20738b3b0\r\n    rsp = 0x00007fb20738b330   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00000000039513eb\r\n    r15 = 0x00000000039513eb   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c00781538   rbp = 0x00007fb20738b3c0\r\n    rsp = 0x00007fb20738b3c0   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513eb   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c00781538   rbp = 0x00007fb20738b3f0\r\n    rsp = 0x00007fb20738b3d0   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513eb   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c00e44a50   rbp = 0x00007fb20738b4c0\r\n    rsp = 0x00007fb20738b400   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738b450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x0000054c00e44a50   rbp = 0x00007fb20738b4e0\r\n    rsp = 0x00007fb20738b4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20738c258   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738c6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x0000054c00e44a50   rbp = 0x00007fb20738b510\r\n    rsp = 0x00007fb20738b4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20738c258   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738c6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20738c6c0   rbp = 0x00007fb20738b550\r\n    rsp = 0x00007fb20738b520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20738c258   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738c6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20738ccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20738b560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20c5fce30\r\n    r15 = 0x00007fb206b8c000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20738b600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20c5fce30\r\n    r15 = 0x00007fb206b8c000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 36\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb206aff0f0   rdi = 0x000000000000008e\r\n    rbp = 0x00007fb206aff2c0   rsp = 0x00007fb206aff080\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000000\r\n    r10 = 0x0000000000007483   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb206aff2d0   r13 = 0x0000000001c71be8\r\n    r14 = 0x0000054c00f83c60   r15 = 0x00007fb206aff0f0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb206aff2c0\r\n    rsp = 0x00007fb206aff0b0   r12 = 0x00007fb206aff2d0\r\n    r13 = 0x0000000001c71be8   r14 = 0x0000054c00f83c60\r\n    r15 = 0x00007fb206aff0f0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb206aff340\r\n    rsp = 0x00007fb206aff2d0   r12 = 0x00007fb206aff2d0\r\n    r13 = 0x0000000001c71be8   r14 = 0x0000054c0016cbe8\r\n    r15 = 0x0000054c00f83c60   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x0000054c0016cb00   rbp = 0x00007fb206aff390\r\n    rsp = 0x00007fb206aff350   r12 = 0x0000054c0016cb18\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x0000054c0016cd28   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb206aff4c0   rbp = 0x00007fb206aff470\r\n    rsp = 0x00007fb206aff3a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb206aff3f0\r\n    r15 = 0x00007fb206aff480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb206aff4c0   rbp = 0x00007fb206aff4b0\r\n    rsp = 0x00007fb206aff480   r12 = 0x00007fb206aff4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb206aff480\r\n    r15 = 0x0000564edbb1d7e8   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x0000564edbb1d7d8   rbp = 0x00007fb206aff510\r\n    rsp = 0x00007fb206aff4c0   r12 = 0x00007fb206aff4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000054c00d2b700\r\n    r15 = 0x0000564edbb1d7e8   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 7  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb206b006c0   rbp = 0x00007fb206aff550\r\n    rsp = 0x00007fb206aff520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb206b00258   r14 = 0x0000564edbb1d7d8\r\n    r15 = 0x00007fb206b006c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 8  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb206b00cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb206aff560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa38b10\r\n    r15 = 0x00007fb206300000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 9  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb206aff600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa38b10\r\n    r15 = 0x00007fb206300000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nLoaded modules:\r\n0x564ed10de000 - 0x564edbbf3b52  electron  0.0.0.0  (main)\r\n0x7fb205cf1000 - 0x7fb205d79907  libnssckbi.so  0.0.0.0\r\n0x7fb205d7a000 - 0x7fb205e333df  libfreeblpriv3.so  0.0.0.0\r\n0x7fb205e34000 - 0x7fb205f85ef7  libsqlite3.so.0  0.0.0.0\r\n0x7fb205fa7000 - 0x7fb205ffc077  libsoftokn3.so  0.0.0.0\r\n0x7fb206b01000 - 0x7fb206b2079f  libdbusmenu-glib.so.4  0.0.0.0\r\n0x7fb20a58d000 - 0x7fb20a5ba917  libudev.so.1  0.0.0.0\r\n0x7fb210400000 - 0x7fb21066b1bf  libstdc++.so.6  0.0.0.0\r\n0x7fb2107c1000 - 0x7fb2107ff2b7  libgvfscommon.so  0.0.0.0\r\n0x7fb210800000 - 0x7fb2125d100f  libicudata.so.72  0.0.0.0\r\n0x7fb212602000 - 0x7fb2128002bf  libicuuc.so.72  0.0.0.0\r\n0x7fb212801000 - 0x7fb2129eadd7  libxml2.so.2  0.0.0.0\r\n0x7fb2a1445000 - 0x7fb2a14782ef  libgvfsdbus.so  0.0.0.0\r\n0x7fb2a1479000 - 0x7fb2a148200f  libogg.so.0  0.0.0.0\r\n0x7fb2a1483000 - 0x7fb2a14af00f  libvorbis.so.0  0.0.0.0\r\n0x7fb2a14b0000 - 0x7fb2a14ba18f  libltdl.so.7  0.0.0.0\r\n0x7fb2a14bb000 - 0x7fb2a14d104f  libtdb.so.1  0.0.0.0\r\n0x7fb2a14d2000 - 0x7fb2a14dc00f  libvorbisfile.so.3  0.0.0.0\r\n0x7fb2a14dd000 - 0x7fb2a14ef03f  libcanberra.so.0  0.0.0.0\r\n0x7fb2a14f0000 - 0x7fb2a14f600f  libcanberra-gtk3.so.0  0.0.0.0\r\n0x7fb2a1508000 - 0x7fb2a15170df  libdconfsettings.so  0.0.0.0\r\n0x7fb2a1518000 - 0x7fb2a151f0a7  libcanberra-gtk3-module.so  0.0.0.0\r\n0x7fb2a1520000 - 0x7fb2a1548c5f  libxkbfile.so.1  0.0.0.0\r\n0x7fb2a1549000 - 0x7fb2a1565a6f  libxklavier.so.16  0.0.0.0\r\n0x7fb2a1566000 - 0x7fb2a157f147  libgnomekbdui.so.8  0.0.0.0\r\n0x7fb2a1e06000 - 0x7fb2a1e0f0ef  libgnomekbd.so.8  0.0.0.0\r\n0x7fb2a1e10000 - 0x7fb2a1e4f3af  libxapp.so.1  0.0.0.0\r\n0x7fb2a1e53000 - 0x7fb2a1e650f7  libappmenu-gtk3-parser.so.0  0.0.0.0\r\n0x7fb2a1e66000 - 0x7fb2a1e70097  libappmenu-gtk-module.so  0.0.0.0\r\n0x7fb2a1f1d000 - 0x7fb2a1f290e7  libmd.so.0  0.0.0.0\r\n0x7fb2a1f2a000 - 0x7fb2a1f4c01f  libbrotlicommon.so.1  0.0.0.0\r\n0x7fb2a1f4f000 - 0x7fb2a1f61a27  libresolv.so.2  0.0.0.0\r\n0x7fb2a1f62000 - 0x7fb2a1f6800f  libkeyutils.so.1  0.0.0.0\r\n0x7fb2a1f69000 - 0x7fb2a1f8e1a7  libgpg-error.so.0  0.0.0.0\r\n0x7fb2a1f8f000 - 0x7fb2a1fa30df  libbsd.so.0  0.0.0.0\r\n0x7fb2a1fa6000 - 0x7fb2a1fb204f  libbrotlidec.so.1  0.0.0.0\r\n0x7fb2a1fb3000 - 0x7fb2a1fbb00f  libdatrie.so.1  0.0.0.0\r\n0x7fb2a1fbc000 - 0x7fb2a203e00f  libjpeg.so.8  0.0.0.0\r\n0x7fb2a203f000 - 0x7fb2a20650af  libgraphite2.so.3  0.0.0.0\r\n0x7fb2a2068000 - 0x7fb2a206c127  libXinerama.so.1  0.0.0.0\r\n0x7fb2a206d000 - 0x7fb2a20781c7  libXcursor.so.1  0.0.0.0\r\n0x7fb2a2079000 - 0x7fb2a207d01f  libwayland-egl.so.1  0.0.0.0\r\n0x7fb2a207e000 - 0x7fb2a20871e7  libwayland-cursor.so.0  0.0.0.0\r\n0x7fb2a2088000 - 0x7fb2a2098487  libwayland-client.so.0  0.0.0.0\r\n0x7fb2a2099000 - 0x7fb2a211b1ef  libgmp.so.10  0.0.0.0\r\n0x7fb2a211e000 - 0x7fb2a216500f  libhogweed.so.6  0.0.0.0\r\n0x7fb2a2166000 - 0x7fb2a21b507f  libnettle.so.8  0.0.0.0\r\n0x7fb2a21b6000 - 0x7fb2a21cc227  libtasn1.so.6  0.0.0.0\r\n0x7fb2a21cd000 - 0x7fb2a23808e7  libunistring.so.2  0.0.0.0\r\n0x7fb2a2381000 - 0x7fb2a23a100f  libidn2.so.0  0.0.0.0\r\n0x7fb2a23a2000 - 0x7fb2a24def47  libp11-kit.so.0  0.0.0.0\r\n0x7fb2a24e1000 - 0x7fb2a24ed3af  libkrb5support.so.0  0.0.0.0\r\n0x7fb2a24ee000 - 0x7fb2a24f3047  libcom_err.so.2  0.0.0.0\r\n0x7fb2a24f4000 - 0x7fb2a251f0f7  libk5crypto.so.3  0.0.0.0\r\n0x7fb2a2520000 - 0x7fb2a25e8aef  libkrb5.so.3  0.0.0.0\r\n0x7fb2a25e9000 - 0x7fb2a260b057  liblz4.so.1  0.0.0.0\r\n0x7fb2a260e000 - 0x7fb2a26c1037  libzstd.so.1  0.0.0.0\r\n0x7fb2a26c2000 - 0x7fb2a26f3017  liblzma.so.5  0.0.0.0\r\n0x7fb2a26f4000 - 0x7fb2a283b2cf  libgcrypt.so.20  0.0.0.0\r\n0x7fb2a283c000 - 0x7fb2a2847047  libcap.so.2  0.0.0.0\r\n0x7fb2a2848000 - 0x7fb2a287e3b7  libblkid.so.1  0.0.0.0\r\n0x7fb2a2881000 - 0x7fb2a288807f  libXdmcp.so.6  0.0.0.0\r\n0x7fb2a2889000 - 0x7fb2a288e107  libXau.so.6  0.0.0.0\r\n0x7fb2a288f000 - 0x7fb2a28a0047  libxcb-randr.so.0  0.0.0.0\r\n0x7fb2a28a1000 - 0x7fb2a28b661f  libwayland-server.so.0  0.0.0.0\r\n0x7fb2a28b7000 - 0x7fb2a28c326f  libXrender.so.1  0.0.0.0\r\n0x7fb2a28c6000 - 0x7fb2a28d3067  libxcb-render.so.0  0.0.0.0\r\n0x7fb2a28d4000 - 0x7fb2a28d8057  libxcb-shm.so.0  0.0.0.0\r\n0x7fb2a28d9000 - 0x7fb2a291000f  libpng16.so.16  0.0.0.0\r\n0x7fb2a2911000 - 0x7fb2a29da00f  libfreetype.so.6  0.0.0.0\r\n0x7fb2a29db000 - 0x7fb2a2a86157  libpixman-1.so.0  0.0.0.0\r\n0x7fb2a2a87000 - 0x7fb2a2a9188f  libthai.so.0  0.0.0.0\r\n0x7fb2a2a94000 - 0x7fb2a2aa71a7  libXi.so.6  0.0.0.0\r\n0x7fb2a2aa8000 - 0x7fb2a2bdcf87  libepoxy.so.0  0.0.0.0\r\n0x7fb2a2bdd000 - 0x7fb2a2c0b1df  libgdk_pixbuf-2.0.so.0  0.0.0.0\r\n0x7fb2a2c0c000 - 0x7fb2a2c16117  libcairo-gobject.so.2  0.0.0.0\r\n0x7fb2a2c17000 - 0x7fb2a2c330b7  libfribidi.so.0  0.0.0.0\r\n0x7fb2a2c36000 - 0x7fb2a2c8361f  libfontconfig.so.1  0.0.0.0\r\n0x7fb2a2c84000 - 0x7fb2a2c9d187  libpangoft2-1.0.so.0  0.0.0.0\r\n0x7fb2a2c9e000 - 0x7fb2a2d858df  libharfbuzz.so.0  0.0.0.0\r\n0x7fb2a2d86000 - 0x7fb2a2d960b7  libpangocairo-1.0.so.0  0.0.0.0\r\n0x7fb2a2d97000 - 0x7fb2a2e92d37  libgdk-3.so.0  0.0.0.0\r\n0x7fb2a2e93000 - 0x7fb2a308dd3f  libgnutls.so.30  0.0.0.0\r\n0x7fb2a308e000 - 0x7fb2a30a0117  libavahi-client.so.3  0.0.0.0\r\n0x7fb2a30a1000 - 0x7fb2a30ae24f  libavahi-common.so.3  0.0.0.0\r\n0x7fb2a30af000 - 0x7fb2a3102417  libgssapi_krb5.so.2  0.0.0.0\r\n0x7fb2a3103000 - 0x7fb2a31d254f  libsystemd.so.0  0.0.0.0\r\n0x7fb2a31d3000 - 0x7fb2a31ff6a7  libselinux.so.1  0.0.0.0\r\n0x7fb2a3200000 - 0x7fb2a3404f6f  libc.so.6  0.0.0.0\r\n0x7fb2a3407000 - 0x7fb2a340b09f  libplds4.so  0.0.0.0\r\n0x7fb2a340e000 - 0x7fb2a3451237  libmount.so.1  0.0.0.0\r\n0x7fb2a3452000 - 0x7fb2a346f09f  libz.so.1  0.0.0.0\r\n0x7fb2a3470000 - 0x7fb2a350930f  libpcre2-8.so.0  0.0.0.0\r\n0x7fb2a350a000 - 0x7fb2a352d367  libgcc_s.so.1  0.0.0.0\r\n0x7fb2a352e000 - 0x7fb2a36160f7  libm.so.6  0.0.0.0\r\n0x7fb2a3617000 - 0x7fb2a364f4a7  libatspi.so.0  0.0.0.0\r\n0x7fb2a3650000 - 0x7fb2a375450f  libasound.so.2  0.0.0.0\r\n0x7fb2a3755000 - 0x7fb2a379a157  libxkbcommon.so.0  0.0.0.0\r\n0x7fb2a379b000 - 0x7fb2a38d8d27  libX11.so.6  0.0.0.0\r\n0x7fb2a38d9000 - 0x7fb2a39ffe6f  libcairo.so.2  0.0.0.0\r\n0x7fb2a3a00000 - 0x7fb2a41d0dcf  libgtk-3.so.0  0.0.0.0\r\n0x7fb2a41d1000 - 0x7fb2a41d708f  libplc4.so  0.0.0.0\r\n0x7fb2a41d8000 - 0x7fb2a41de087  libgmodule-2.0.so.0  0.0.0.0\r\n0x7fb2a41e1000 - 0x7fb2a41eb60f  libffi.so.8  0.0.0.0\r\n0x7fb2a41ee000 - 0x7fb2a4217267  libxcb.so.1  0.0.0.0\r\n0x7fb2a4218000 - 0x7fb2a424207f  libexpat.so.1  0.0.0.0\r\n0x7fb2a4243000 - 0x7fb2a4253467  libgbm.so.1  0.0.0.0\r\n0x7fb2a4254000 - 0x7fb2a4260187  libXrandr.so.2  0.0.0.0\r\n0x7fb2a4261000 - 0x7fb2a42680e7  libXfixes.so.3  0.0.0.0\r\n0x7fb2a4269000 - 0x7fb2a427d8df  libXext.so.6  0.0.0.0\r\n0x7fb2a427e000 - 0x7fb2a42e79ff  libpango-1.0.so.0  0.0.0.0\r\n0x7fb2a42e8000 - 0x7fb2a42febd7  libdrm.so.2  0.0.0.0\r\n0x7fb2a42ff000 - 0x7fb2a439b22f  libcups.so.2  0.0.0.0\r\n0x7fb2a439c000 - 0x7fb2a43d7437  libatk-bridge-2.0.so.0  0.0.0.0\r\n0x7fb2a43d8000 - 0x7fb2a43ff4d7  libatk-1.0.so.0  0.0.0.0\r\n0x7fb2a4400000 - 0x7fb2a444d2e7  libdbus-1.so.3  0.0.0.0\r\n0x7fb2a444e000 - 0x7fb2a448d38f  libnspr4.so  0.0.0.0\r\n0x7fb2a448e000 - 0x7fb2a44b50af  libsmime3.so  0.0.0.0\r\n0x7fb2a44b6000 - 0x7fb2a44e670f  libnssutil3.so  0.0.0.0\r\n0x7fb2a44e7000 - 0x7fb2a46b8377  libgio-2.0.so.0  0.0.0.0\r\n0x7fb2a46b9000 - 0x7fb2a47ff1f7  libglib-2.0.so.0  0.0.0.0\r\n0x7fb2a4800000 - 0x7fb2a4f26d87  libffmpeg.so  0.0.0.0\r\n0x7fb2a4f2a000 - 0x7fb2a4f2e087  libXdamage.so.1  0.0.0.0\r\n0x7fb2a4f2f000 - 0x7fb2a4f33087  libXcomposite.so.1  0.0.0.0\r\n0x7fb2a4f38000 - 0x7fb2a50652df  libnss3.so  0.0.0.0\r\n0x7fb2a5068000 - 0x7fb2a50c8c47  libgobject-2.0.so.0  0.0.0.0\r\n0x7fb2a50c9000 - 0x7fb2a50cd00f  libpthread.so.0  0.0.0.0\r\n0x7fb2a50ce000 - 0x7fb2a50d200f  libdl.so.2  0.0.0.0\r\n0x7fb2a50d3000 - 0x7fb2a50dc4af  libgtk3-nocsd.so.0  0.0.0.0\r\n0x7fb2a50de000 - 0x7fb2a50e202f  libxapp-gtk3-module.so  0.0.0.0\r\n0x7fb2a50e4000 - 0x7fb2a50e800f  libX11-xcb.so.1  0.0.0.0\r\n0x7fb2a5100000 - 0x7fb2a51362b7  ld-linux-x86-64.so.2  0.0.0.0\r\n0x7fffffb8f000 - 0x7fffffb8fe3c  linux-vdso.so.1  0.0.0.0\r\n```\r\n\r\n</details>\ntemporary workaround for anyone experiencing this:\r\nlaunch vesktop with\r\n```\r\nelectron29 /usr/lib/vesktop/app.asar\r\n```\r\n(note: requires, obviously, electron29 to be installed)\nThe issue persists in 30.0.1 as well as 31.0.0-alpha.1 and 31.0.0-alpha.2.\nSame issue in our application; we have reverted to version 29 in https://github.com/neanes/neanes/pull/648.\nI could not reproduce this only by maximizing/setting Electron to fullscreen. But could reliably produce a crash by creating at least 3 browser windows and then attempting to maximize any of them.\r\n\r\nHere's a gist: https://gist.github.com/rvcalisto/a8e35699d18189d1d74cada4965ee779\r\n\r\nElectron terminated with SIGSEGV on both of my Manjaro and Kubuntu Linux VMs (X11).\nsame problem. resolve pls\nSame problem on Linux Mint.\n![3679-747f-8397-0524~3](https://github.com/electron/electron/assets/77581683/94d08c3e-131c-401c-a4cb-2f3e848d528b)\r\nThe same problem on Ubuntu\nI see that no one's attached any logs yet, so I've attached the coredump that shows up in my journalctl when it crashes. \r\n\r\n**Electron version**: 30.0.1\r\n**OS**: Arch Linux\r\n**WM**: Wayfire\r\n\r\nNote that the app doesn't need to be fullscreen - simply tiling the app using my WM's keybindings causes it to crash. On the other hand, resizing the window manually seems to be fine. \r\n\r\n- [coredump.log](https://github.com/electron/electron/files/15124979/coredump.log)\nThreema Desktop is also affected by this when launching under Electron 30.0.1 or 30.0.0-beta.7 (Wayland, Sway WM). There is no fullscreen involved, it immediately segfaults on launch. Launching in floating mode (as opposed to tiled mode) doesn't seem to help either.\r\n\r\nI can also confirm that 30.0.0-alpha.6 does not segfault, both in tiling and in floating mode, both with and without `--ozone-platform-hint=auto --enable-features=WaylandWindowDecorations` startup options.\r\n\r\nThe stack trace (created using `minidump-stackwalk`) shows this function call at the top:\r\n\r\n```\r\nCrash reason:  SIGSEGV / SEGV_MAPERR\r\nCrash address: 0x0000000000000000\r\nProcess uptime: 0 seconds\r\n\r\nThread 0 electron (crashed)\r\n 0  electron!views::View::UpdateChildLayerBounds(views::View::LayerOffsetData const&) [raw_ptr.h : 938 + 0x0]\r\n     rax = 0x0000000000000000    rdx = 0x0000000000000000\r\n     rcx = 0x0000000000000000    rbx = 0x00007ffed5afad40\r\n     rsi = 0x00007ffed5afad40    rdi = 0x0000331400105780\r\n     rbp = 0x00007ffed5afad20    rsp = 0x00007ffed5afacb0\r\n      r8 = 0x00000000000009e8     r9 = 0xffffffff800009fe\r\n     r10 = 0x000033140014c828    r11 = 0x00000000000001be\r\n     r12 = 0x0000000000000000    r13 = 0x0000331400105780\r\n     r14 = 0x00007ffed5afad40    r15 = 0x0000000001010101\r\n     rip = 0x0000602fdd92fd5a\r\n    Found by: given as instruction pointer in context\r\n```\r\n\r\nPotentially related to #39449 ?\nperhaps related to https://github.com/electron/electron/issues/41970\r\ncould it be that all these cases that were crashing were apps handling some protocol and calling maximize()?\nmy app has protocol handling, but the issue is also reproducible from the default Fiddle boilerplate, which doesn't.\nThe changes on the `30-x-y` branch between `v30.0.0-alpha.6` and `v30.0.0-alpha.7` are the following (newest to oldest):\r\n\r\n```\r\nb713e34947 - (tag: v30.0.0-alpha.7) chore: bump chromium to 124.0.6355.1 (30-x-y) (#41490) (7 weeks ago electron-roller[bot])\r\nb39f36496d - fix: improve caption button appearance on Windows 11 (#41586) (7 weeks ago trop[bot])\r\nd16f1d52e8 - docs: `nativeImage` api cleanup (#41570) (7 weeks ago trop[bot])\r\nd3b182f8b9 - fix: `chrome://process-internals` failing to load (#41540) (7 weeks ago trop[bot])\r\n35099d9289 - docs: Update code signing documentation (#41553) (7 weeks ago trop[bot])\r\n```\r\n\r\n(Crashes happen on Alpha 7, but not on Alpha 6.)\r\n\r\nI'm fairly sure that from that list only the Chromium bump commit is relevant (from 124.0.6331.0 to 124.0.6355.1).\r\n\r\nSo the change that introduced the crashes in Electron is probably commit b713e349478ab034b15ddd220a5872d0751035b8, and possibly a change in Chromium between 124.0.6331.0 and 124.0.6355.1). Additionally, the function that crashes (`views::View::UpdateChildLayerBounds`) is part of Chromium, not Electron.\nTo avoid confusion and better help devs find this issue, I'm editing the title & original post to be about maximizing rather than fullscreen\nI'm able to reproduce the crash with the gist that @rvcalisto posted in https://github.com/electron/electron/issues/41839#issuecomment-2075278091. Thanks!\r\n\r\nHere's a gdb backtrace from that gist with electron v30.0.2 running on Ubuntu 24.04. Oddly, it _doesn't_ have `UpdateChildLayerBounds()` in the call stack :thinking: but it seems likely that both traces have the same root cause.\r\n\r\n```\r\nThread 1 \"electron\" received signal SIGSEGV, Segmentation fault.\r\n0x0000555561057b72 in operator() () at ../../third_party/libc++/src/include/__functional/operations.h:358\r\n358\t    return __x < __y;\r\n(gdb) bt\r\n#0  0x0000555561057b72 in operator() () at ../../third_party/libc++/src/include/__functional/operations.h:358\r\n#1  operator() () at ../../third_party/libc++/src/include/map:640\r\n#2  __lower_bound<void const*> () at ../../third_party/libc++/src/include/__tree:2143\r\n#3  find<void const*> () at ../../third_party/libc++/src/include/__tree:2086\r\n#4  find () at ../../third_party/libc++/src/include/map:1367\r\n#5  TriggerChangedCallback () at ../../ui/base/metadata/metadata_types.cc:60\r\n#6  0x000055556125069e in OnPropertyChanged () at ../../ui/views/view.cc:2909\r\n#7  SetBoundsRect () at ../../ui/views/view.cc:487\r\n#8  0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#9  0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#10 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#11 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#12 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#13 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#14 0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#15 0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#16 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#17 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#18 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#19 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#20 0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#21 0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#22 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#23 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#24 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#25 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#26 0x0000555561297768 in Layout () at ../../ui/views/window/non_client_view.cc:125\r\n#27 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#28 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#29 0x0000555561298919 in Layout () at ../../ui/views/window/non_client_view.cc:272\r\n#30 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#31 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#32 0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#33 0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#34 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#35 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#36 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#37 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#38 0x0000555561251217 in SetBounds () at ../../ui/views/view.cc:401\r\n--Type <RET> for more, q to quit, c to continue without paging--\r\n#39 SetSize () at ../../ui/views/view.cc:495\r\n#40 0x0000555561277840 in OnNativeWidgetSizeChanged () at ../../ui/views/widget/widget.cc:1681\r\n#41 0x00005555612c48b4 in OnHostResized () at ../../ui/views/widget/desktop_aura/desktop_native_widget_aura.cc:1476\r\n#42 0x0000555561050fbc in OnHostResizedInPixels () at ../../ui/aura/window_tree_host.cc:605\r\n#43 0x0000555561053006 in OnBoundsChanged () at ../../ui/aura/window_tree_host_platform.cc:255\r\n#44 0x00005555595961a9 in non-virtual thunk to electron::ElectronDesktopWindowTreeHostLinux::OnBoundsChanged(ui::PlatformWindowDelegate::BoundsChange const&) ()\r\n    at ../../electron/shell/browser/ui/electron_desktop_window_tree_host_linux.cc:50\r\n#45 0x000055555a2f91d8 in NotifyBoundsChanged () at ../../ui/ozone/platform/x11/x11_window.cc:2670\r\n#46 0x000055555a2fa159 in DelayedResize () at ../../ui/ozone/platform/x11/x11_window.cc:2603\r\n#47 0x00005555593432a0 in Run () at ../../base/functional/callback.h:156\r\n#48 0x000055555982fe18 in ForwardOnce<>(void) () at ../../base/cancelable_callback.h:134\r\n#49 0x000055555937e11b in Invoke<void (electron::api::BrowserWindow::*)(), base::WeakPtr<electron::api::BrowserWindow> const&> ()\r\n    at ../../base/functional/bind_internal.h:738\r\n#50 MakeItSo<void (electron::api::BrowserWindow::* const&)(), std::__Cr::tuple<base::WeakPtr<electron::api::BrowserWindow> > const&> ()\r\n    at ../../base/functional/bind_internal.h:954\r\n#51 RunImpl<void (electron::api::BrowserWindow::* const&)(), std::__Cr::tuple<base::WeakPtr<electron::api::BrowserWindow> > const&, 0ul> ()\r\n    at ../../base/functional/bind_internal.h:1067\r\n#52 Run () at ../../base/functional/bind_internal.h:987\r\n#53 0x00005555593432a0 in Run () at ../../base/functional/callback.h:156\r\n#54 0x000055555ec713ad in RunTaskImpl () at ../../base/task/common/task_annotator.cc:203\r\n#55 0x000055555eca6e83 in RunTask<(lambda at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:475:11)> ()\r\n    at ../../base/task/common/task_annotator.h:90\r\n#56 DoWorkImpl () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:473\r\n#57 0x000055555eca63ab in DoWork () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:338\r\n#58 0x000055555eca7825 in non-virtual thunk to base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork() ()\r\n#59 0x000055555ed37123 in Run () at ../../base/message_loop/message_pump_glib.cc:694\r\n#60 0x000055555eca8040 in Run () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:641\r\n#61 0x000055555ec5015e in Run () at ../../base/run_loop.cc:134\r\n#62 0x000055555d5db2c7 in RunMainMessageLoop () at ../../content/browser/browser_main_loop.cc:1104\r\n#63 0x000055555d5dd825 in Run () at ../../content/browser/browser_main_runner_impl.cc:159\r\n#64 0x000055555d5d726a in BrowserMain () at ../../content/browser/browser_main.cc:34\r\n#65 0x000055555975b176 in RunBrowserProcessMain () at ../../content/app/content_main_runner_impl.cc:712\r\n#66 0x000055555975deb1 in RunBrowser () at ../../content/app/content_main_runner_impl.cc:1303\r\n#67 0x000055555975d489 in Run () at ../../content/app/content_main_runner_impl.cc:1148\r\n#68 0x0000555559759947 in RunContentProcess () at ../../content/app/content_main.cc:331\r\n#69 0x0000555559759c60 in ContentMain () at ../../content/app/content_main.cc:344\r\n#70 0x000055555933b539 in main () at ../../electron/shell/app/electron_main_linux.cc:45\r\n```\nHmm. It smells like a memory error to me, so I tried the same gist with an asan build of v30.0.2 and am not seeing a crash there.\r\n\r\nMaybe it's a timing issue instead & asan is changing the timing just enough to not tickle the crash :thinking: \nCrashing here (Ubuntu) as well since I upgraded to version 30.0.1 from ~29. I see the same SIGSEGV issue.\nI can confirm that 30.0.2 also exhibits this issue. We have multiple users complaining about segfaults on launch across various distributions (Arch, Fedora, Debian). Some report that they have a window tiling manager that will also crash on a few older versions of Electron. I personally just tested this out with Manjaro and Plasma, and I can observe that the main window is being drawn properly, but not maximized. However, the app will call maximize immediately after window creation. But the window never actually maximizes, indicating that it is indeed the maximizing step that causes the core dump. Possibly also an interaction with tiling managers, so I think there may be a wider issue that in general relates to how window operations are handled.\r\n\r\nEDIT: The bug seems to not appear on the current 29er line Electron version (29.3.2) and that one runs fine for all users who reported segfaults before.", "created_at": "2024-05-10 22:42:08", "merge_commit_sha": "c56e1dffb0adc6140b8b112678885cbccfc3d6f6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-42111", "base_commit": "e2acdffe58ad9b622ca1fd983348bf4ce26f9379", "patch": "diff --git a/docs/api/protocol.md b/docs/api/protocol.md\nindex 6d2de18751de4..3f4ce799a1370 100644\n--- a/docs/api/protocol.md\n+++ b/docs/api/protocol.md\n@@ -9,10 +9,14 @@ An example of implementing a protocol that has the same effect as the\n \n ```js\n const { app, protocol, net } = require('electron')\n+const path = require('node:path')\n+const url = require('node:url')\n \n app.whenReady().then(() => {\n-  protocol.handle('atom', (request) =>\n-    net.fetch('file://' + request.url.slice('atom://'.length)))\n+  protocol.handle('atom', (request) => {\n+    const filePath = request.url.slice('atom://'.length)\n+    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+  })\n })\n ```\n \n@@ -42,7 +46,7 @@ app.whenReady().then(() => {\n \n   ses.protocol.handle('atom', (request) => {\n     const filePath = request.url.slice('atom://'.length)\n-    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+    return net.fetch(url.pathToFileURL(path.resolve(__dirname, filePath)).toString())\n   })\n \n   const mainWindow = new BrowserWindow({ webPreferences: { partition } })\n", "test_patch": "", "problem_statement": "[Bug]: protocol.handle fails when filename contains '#'\n### Preflight Checklist\n\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n30.0.2\n\n### What operating system are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 10 version 22H2\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nThe image should display as normal.\n\n### Actual Behavior\n\nWhen you're handling a file:// protocol request, it's being treated like a regular URL. However, the file:// protocol is different from HTTP or HTTPS URLs in how it handles characters like #. In a file:// URL, the # character is typically part of the file or directory name and is not treated as a fragment identifier like in HTTP URLs.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/KBriscoe/550df36cd29a4d27a7672f1404a9e990\n\n### Additional Information\n\nIf using the gist, the filepaths need to be updated in the renderer.js to actual images. The issue is when the image contains '#' in my case and I looked through the protocol.handle and saw it was treating it like a web request I believe where # usually means to truncate off the rest of the request. So it ends up trying to get an incorrect path item.\n", "hints_text": "", "created_at": "2024-05-10 00:27:52", "merge_commit_sha": "88f28a302ff2ba6fd3698e1cb1cfb6497d178f32", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41709", "base_commit": "76172fd27ea30bbd50906b5f9bf5c9ee64553b99", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex 0dcfad8aa6dd5..62c5480edf965 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "test_patch": "", "problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "hints_text": "libnotify 0.8.x, **before 0.8.3** is affected by another bug: https://gitlab.gnome.org/GNOME/libnotify/-/issues/34.\r\n\r\nBut libnotify 0.8.3 has fixed its own bug, as I guess it's time for Electron to fix this unexpected `LibnotifyNotification::OnNotificationClosed()` call inside `LibnotifyNotification::Dismiss()`.\r\n\r\nWorkaround for app dev: Don't use `notification.close()` to avoid crash.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nI'm sure this bug still exists in electron 28.2.1 and 29.0.0-beta.6.\njust tested it in 28.2.3, there it is still an issue\nYou can also work around this crash by forcing libnotify to use dbus instead of the portal with the env var `NOTIFY_IGNORE_PORTAL=1`.\r\n\r\nYou need to add this to your flatpak build file:\r\n```yaml\r\nfinish-args:\r\n   - --talk-name=org.freedesktop.Notifications\r\n   - --env=NOTIFY_IGNORE_PORTAL=1\r\n```\r\n\r\nexample from my project: https://github.com/flathub/chat.delta.desktop/pull/125/commits/cf25cd0fa8c12a14cd52ee4c1600114b5b12f35e", "created_at": "2024-03-27 09:54:34", "merge_commit_sha": "f4b7aa540145278459f8ab92319e2d0074687afb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['Validate PR Title', '.github/workflows/semantic.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41708", "base_commit": "ba1e7fcaa718b233c45aef1233a34d1c50e28896", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex e039b382e3e24..4c8452fad1a8d 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "test_patch": "", "problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "hints_text": "libnotify 0.8.x, **before 0.8.3** is affected by another bug: https://gitlab.gnome.org/GNOME/libnotify/-/issues/34.\r\n\r\nBut libnotify 0.8.3 has fixed its own bug, as I guess it's time for Electron to fix this unexpected `LibnotifyNotification::OnNotificationClosed()` call inside `LibnotifyNotification::Dismiss()`.\r\n\r\nWorkaround for app dev: Don't use `notification.close()` to avoid crash.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nI'm sure this bug still exists in electron 28.2.1 and 29.0.0-beta.6.\njust tested it in 28.2.3, there it is still an issue\nYou can also work around this crash by forcing libnotify to use dbus instead of the portal with the env var `NOTIFY_IGNORE_PORTAL=1`.\r\n\r\nYou need to add this to your flatpak build file:\r\n```yaml\r\nfinish-args:\r\n   - --talk-name=org.freedesktop.Notifications\r\n   - --env=NOTIFY_IGNORE_PORTAL=1\r\n```\r\n\r\nexample from my project: https://github.com/flathub/chat.delta.desktop/pull/125/commits/cf25cd0fa8c12a14cd52ee4c1600114b5b12f35e", "created_at": "2024-03-27 09:54:31", "merge_commit_sha": "9ebeeb40ac1a9091165a9ecd63db44b4162467d5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41707", "base_commit": "3b025ec0c7b3442ebe3a2040b059bc2da5a80bc5", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex 0dcfad8aa6dd5..62c5480edf965 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "test_patch": "", "problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "hints_text": "libnotify 0.8.x, **before 0.8.3** is affected by another bug: https://gitlab.gnome.org/GNOME/libnotify/-/issues/34.\r\n\r\nBut libnotify 0.8.3 has fixed its own bug, as I guess it's time for Electron to fix this unexpected `LibnotifyNotification::OnNotificationClosed()` call inside `LibnotifyNotification::Dismiss()`.\r\n\r\nWorkaround for app dev: Don't use `notification.close()` to avoid crash.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nI'm sure this bug still exists in electron 28.2.1 and 29.0.0-beta.6.\njust tested it in 28.2.3, there it is still an issue\nYou can also work around this crash by forcing libnotify to use dbus instead of the portal with the env var `NOTIFY_IGNORE_PORTAL=1`.\r\n\r\nYou need to add this to your flatpak build file:\r\n```yaml\r\nfinish-args:\r\n   - --talk-name=org.freedesktop.Notifications\r\n   - --env=NOTIFY_IGNORE_PORTAL=1\r\n```\r\n\r\nexample from my project: https://github.com/flathub/chat.delta.desktop/pull/125/commits/cf25cd0fa8c12a14cd52ee4c1600114b5b12f35e", "created_at": "2024-03-27 09:54:28", "merge_commit_sha": "3698f892052f8d63ef5668b1064b39bc646c4ea3", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41691", "base_commit": "b9c4b27781495224e309eb75554a6cec21981982", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex e039b382e3e24..4c8452fad1a8d 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "test_patch": "", "problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "hints_text": "libnotify 0.8.x, **before 0.8.3** is affected by another bug: https://gitlab.gnome.org/GNOME/libnotify/-/issues/34.\r\n\r\nBut libnotify 0.8.3 has fixed its own bug, as I guess it's time for Electron to fix this unexpected `LibnotifyNotification::OnNotificationClosed()` call inside `LibnotifyNotification::Dismiss()`.\r\n\r\nWorkaround for app dev: Don't use `notification.close()` to avoid crash.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nI'm sure this bug still exists in electron 28.2.1 and 29.0.0-beta.6.\njust tested it in 28.2.3, there it is still an issue\nYou can also work around this crash by forcing libnotify to use dbus instead of the portal with the env var `NOTIFY_IGNORE_PORTAL=1`.\r\n\r\nYou need to add this to your flatpak build file:\r\n```yaml\r\nfinish-args:\r\n   - --talk-name=org.freedesktop.Notifications\r\n   - --env=NOTIFY_IGNORE_PORTAL=1\r\n```\r\n\r\nexample from my project: https://github.com/flathub/chat.delta.desktop/pull/125/commits/cf25cd0fa8c12a14cd52ee4c1600114b5b12f35e", "created_at": "2024-03-25 21:04:41", "merge_commit_sha": "4f76fff97879ee8f9b2d0dcfd43e686ff8757c69", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41642", "base_commit": "61ddb1aa07551d0a157bbc0b855d3074f5fe4e22", "patch": "diff --git a/shell/common/platform_util_win.cc b/shell/common/platform_util_win.cc\nindex a2deae69bf112..43684fc9e0efa 100644\n--- a/shell/common/platform_util_win.cc\n+++ b/shell/common/platform_util_win.cc\n@@ -336,7 +336,8 @@ void ShowItemInFolder(const base::FilePath& full_path) {\n   base::ThreadPool::CreateCOMSTATaskRunner(\n       {base::MayBlock(), base::TaskPriority::USER_BLOCKING})\n       ->PostTask(FROM_HERE,\n-                 base::BindOnce(&ShowItemInFolderOnWorkerThread, full_path));\n+                 base::BindOnce(&ShowItemInFolderOnWorkerThread,\n+                                full_path.NormalizePathSeparators()));\n }\n \n void OpenPath(const base::FilePath& full_path, OpenCallback callback) {\n@@ -344,9 +345,11 @@ void OpenPath(const base::FilePath& full_path, OpenCallback callback) {\n \n   base::ThreadPool::CreateCOMSTATaskRunner(\n       {base::MayBlock(), base::TaskPriority::USER_BLOCKING})\n-      ->PostTaskAndReplyWithResult(FROM_HERE,\n-                                   base::BindOnce(&OpenPathOnThread, full_path),\n-                                   std::move(callback));\n+      ->PostTaskAndReplyWithResult(\n+          FROM_HERE,\n+          base::BindOnce(&OpenPathOnThread,\n+                         full_path.NormalizePathSeparators()),\n+          std::move(callback));\n }\n \n void OpenExternal(const GURL& url,\n", "test_patch": "", "problem_statement": "shell.showItemInFolder won't open Explorer if forward slashes are present in path\n* Electron version: 1.7.10\r\n* Operating system: Windows 10, build 1709\r\n\r\nIf a path contains forward slash(es) on Windows (e.g. `C:\\some\\app/index.html`), ~~showItemInFolder will open the containing directory but will not select the file.~~ In Electron 8.x and newer, showItemInFolder will not open an Explorer window at all if forward slashes are present in path.\r\n\r\n### How to reproduce\r\n\r\nhttps://github.com/YellowAfterlife/abug-electron-showItemInFolder-forward-slashes\r\n```js\r\nconst electron = require('electron')\r\nconst app = electron.app\r\nconst path = require('path')\r\napp.on('ready', () => {\r\n\tlet test = path.join(__dirname, 'index.html')\r\n\ttest = test.replace(/^(.+)\\\\(.+)$/, \"$1/$2\") // simulate a forward slash in path\r\n\tconsole.log(test)\r\n\tconsole.log(electron.shell.showItemInFolder(test))\r\n\tapp.quit()\r\n})\r\n```\r\n\r\nFrom what I've seen, no other shell functions show this kind of \"partial success\" behaviour while returning `true`.\n", "hints_text": "\ud83d\udc4b Thanks for opening your first issue here! If you're reporting a \ud83d\udc1e bug, please make sure you include steps to reproduce it. We get a lot of issues on this repo, so please be patient and we will get back to you as soon as we can.\n\nTo help make it easier for us to investigate your issue, please follow the [contributing guidelines](https://github.com/electron/electron/blob/master/CONTRIBUTING.md#submitting-issues).\n\nThank you for taking the time to report this issue and helping to make Electron better.\r\n\r\nThe version of Electron you reported this on has been superseded by newer releases. \r\n\r\nIf you're still experiencing this issue in Electron v2.0.x or later, please add a comment specifying the version you're testing with and any other new information that a maintainer trying to reproduce the issue should know.\r\n\r\nI'm setting the `blocked/need-info` label for the above reasons.\r\n\r\nThanks in advance! Your help is appreciated.\nStill happens on 4.0.0-beta10 with same code.\nI encountered the same issue but I couldn't figure out why it didn't select the file. Luckily google brought me here. Thanks for the heads up @YellowAfterlife \n`path.normalize`\nThank you for taking the time to report this issue and helping to make Electron better.\r\n\r\nThe version of Electron you reported this on has been superseded by newer releases. \r\n\r\nIf you're still experiencing this issue in Electron 6.x.y or later, please add a comment specifying the version you're testing with and any other new information that a maintainer trying to reproduce the issue should know.\r\n\r\nI'm setting the `blocked/need-info` label for the above reasons. This issue will be closed 7 days from now if there is no response.\r\n\r\nThanks in advance! Your help is appreciated.\nIt would appear that in 8.0.0-beta.7 Explorer straight up doesn't open if you have forward slashes in path.\nCan confirm this happens in Electron `10.1.5`\nAs of right now Electron 9.0.0 still faces the same issue of the explorer straight up not opening\n> `path.normalize`\r\n\r\nThank you @KavenWork this did the trick for me\n> `path.normalize`\r\n\r\nThank you very very much, this indeed fixed my issue.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nStill happens in v20.1.4, tested in Fiddle - further degradation from v8 (window doesn't open at all if slashes are malformed) remains.\r\n```js\r\nconst {app, shell} = require('electron')\r\nconst path = require('path')\r\n\r\napp.whenReady().then(() => {\r\n\tlet test = path.join(__dirname, 'index.html')\r\n\ttest = test.replace(/^(.+)\\\\(.+)$/, \"$1/$2\") // simulate a forward slash in path\r\n\tconsole.log(test)\r\n\tconsole.log(shell.showItemInFolder(test))\r\n\tapp.quit()\r\n})\r\n\r\n```\nconfirmed on v22.1.0\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nStill there, tested on v25.0.0-beta-5 in Fiddle.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nIt is obviously tempting to just submit a PR with the one-line hack, but also this issue is now old enough to go to school so I'm interested to see how long it will last.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nStill here as of v28.0.0-beta.4\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nStill here as of v29.0.0-beta.12", "created_at": "2024-03-21 02:00:27", "merge_commit_sha": "90a7e5acae5ac8f77443bdc16c678fcee350d22b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-105205", "base_commit": "a8598cd8e261716fa3addb6f10bb57c03a061be9", "patch": "diff --git a/core/variant/dictionary.cpp b/core/variant/dictionary.cpp\nindex 6d89e3a1aed3..48164e30bde0 100644\n--- a/core/variant/dictionary.cpp\n+++ b/core/variant/dictionary.cpp\n@@ -218,7 +218,7 @@ bool Dictionary::is_empty() const {\n bool Dictionary::has(const Variant &p_key) const {\n \tVariant key = p_key;\n \tERR_FAIL_COND_V(!_p->typed_key.validate(key, \"use 'has'\"), false);\n-\treturn _p->variant_map.has(p_key);\n+\treturn _p->variant_map.has(key);\n }\n \n bool Dictionary::has_all(const Array &p_keys) const {\n", "test_patch": "", "problem_statement": "`Dictionary::has` doesn't use validated key\n### Tested versions\n\nv4.5.dev.custom_build [4248411ba]\n\n### System information\n\nGodot v4.5.dev (4248411ba) - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated AMD Radeon RX 6600 (Advanced Micro Devices, Inc.; 32.0.12033.1030) - 12th Gen Intel(R) Core(TM) i3-12100F (8 threads)\n\n### Issue description\n\nWhen `Dictionary` validates the key type passed in, the type may be changed to match the container type.  In most cases, the validated type is used, but `Dictionary::has` uses the original passed in type, which may cause it to not find the key in the `HashMap`.  I think this only impacts dictionaries with `float` keys, when calling `has` with an `int` - `String`/`StringName` differences seem to be handled by `StringLikeVariantComparator`.\n\nExample gdscript:\n\n```gdscript\nfunc _ready() -> void:\n\tvar d : Dictionary[float, String] = {}\n\td[1] = \"value\"\n\tprint(d.has(1))\n\tprint(d.has_all([1]))\n\tprint(d[1])\n\tprint(d)\n```\n\nOutput:\n```\nfalse\ntrue\nvalue\n{ 1.0: \"value\" }\n```\n\nExpected:\n```\ntrue\ntrue\nvalue\n{ 1.0: \"value\" }\n```\n\n### Steps to reproduce\n\nCreate a `Dictionary` with `float` key type, add a whole number key, then call `has` with the key as an `int`\n\n### Minimal reproduction project (MRP)\n\nN/A, can be reproduced in new project with gdscript above\n", "hints_text": "", "created_at": "2025-04-09 16:48:50", "merge_commit_sha": "7b74eb1a9b9cea2b88ae847c537bbcab03b6cce7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-105114", "base_commit": "a210fe6dbd27cc01bffacb0ce2816e0cf303af5e", "patch": "diff --git a/drivers/unix/os_unix.cpp b/drivers/unix/os_unix.cpp\nindex d3e4ca92defb..10f8b0ba38a3 100644\n--- a/drivers/unix/os_unix.cpp\n+++ b/drivers/unix/os_unix.cpp\n@@ -805,6 +805,57 @@ Dictionary OS_Unix::execute_with_pipe(const String &p_path, const List<String> &\n #endif\n }\n \n+int OS_Unix::_wait_for_pid_completion(const pid_t p_pid, int *r_status, int p_options) {\n+\twhile (true) {\n+\t\tif (waitpid(p_pid, r_status, p_options) != -1) {\n+\t\t\t// Thread exited normally.\n+\t\t\treturn 0;\n+\t\t}\n+\t\tconst int error = errno;\n+\t\tif (error == EINTR) {\n+\t\t\t// We're in a debugger, should call waitpid again.\n+\t\t\t// See https://stackoverflow.com/a/45472920/730797.\n+\t\t\tcontinue;\n+\t\t}\n+\t\treturn error;\n+\t}\n+}\n+\n+bool OS_Unix::_check_pid_is_running(const pid_t p_pid, int *r_status) const {\n+\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n+\n+\tif (pi && !pi->is_running) {\n+\t\t// Can return cached value.\n+\t\tif (r_status) {\n+\t\t\t*r_status = pi->exit_code;\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n+\tint status = 0;\n+\tconst int result = _wait_for_pid_completion(p_pid, &status, WNOHANG);\n+\tif (result == 0) {\n+\t\t// Thread is still running.\n+\t\treturn true;\n+\t}\n+\n+\tERR_FAIL_COND_V_MSG(result == -1, false, vformat(\"Thread %d exited with errno: %d\", (int)p_pid, errno));\n+\t// Thread exited normally.\n+\n+\tstatus = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n+\n+\tif (pi) {\n+\t\tpi->is_running = false;\n+\t\tpi->exit_code = status;\n+\t}\n+\n+\tif (r_status) {\n+\t\t*r_status = status;\n+\t}\n+\n+\treturn false;\n+}\n+\n Error OS_Unix::execute(const String &p_path, const List<String> &p_arguments, String *r_pipe, int *r_exitcode, bool read_stderr, Mutex *p_pipe_mutex, bool p_open_console) {\n #ifdef __EMSCRIPTEN__\n \t// Don't compile this code at all to avoid undefined references.\n@@ -870,12 +921,12 @@ Error OS_Unix::execute(const String &p_path, const List<String> &p_arguments, St\n \t\traise(SIGKILL);\n \t}\n \n-\tint status;\n-\twaitpid(pid, &status, 0);\n+\tint status = 0;\n+\tconst int result = _wait_for_pid_completion(pid, &status, 0);\n \tif (r_exitcode) {\n \t\t*r_exitcode = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n \t}\n-\treturn OK;\n+\treturn result ? FAILED : OK;\n #endif\n }\n \n@@ -929,7 +980,7 @@ Error OS_Unix::kill(const ProcessID &p_pid) {\n \tif (!ret) {\n \t\t//avoid zombie process\n \t\tint st;\n-\t\t::waitpid(p_pid, &st, 0);\n+\t\t_wait_for_pid_completion(p_pid, &st, 0);\n \t}\n \treturn ret ? ERR_INVALID_PARAMETER : OK;\n }\n@@ -940,42 +991,19 @@ int OS_Unix::get_process_id() const {\n \n bool OS_Unix::is_process_running(const ProcessID &p_pid) const {\n \tMutexLock lock(process_map_mutex);\n-\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n-\n-\tif (pi && !pi->is_running) {\n-\t\treturn false;\n-\t}\n-\n-\tint status = 0;\n-\tif (waitpid(p_pid, &status, WNOHANG) != 0) {\n-\t\tif (pi) {\n-\t\t\tpi->is_running = false;\n-\t\t\tpi->exit_code = status;\n-\t\t}\n-\t\treturn false;\n-\t}\n-\n-\treturn true;\n+\treturn _check_pid_is_running(p_pid, nullptr);\n }\n \n int OS_Unix::get_process_exit_code(const ProcessID &p_pid) const {\n \tMutexLock lock(process_map_mutex);\n-\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n \n-\tif (pi && !pi->is_running) {\n-\t\treturn pi->exit_code;\n+\tint exit_code = 0;\n+\tif (_check_pid_is_running(p_pid, &exit_code)) {\n+\t\t// Thread is still running\n+\t\treturn -1;\n \t}\n \n-\tint status = 0;\n-\tif (waitpid(p_pid, &status, WNOHANG) != 0) {\n-\t\tstatus = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n-\t\tif (pi) {\n-\t\t\tpi->is_running = false;\n-\t\t\tpi->exit_code = status;\n-\t\t}\n-\t\treturn status;\n-\t}\n-\treturn -1;\n+\treturn exit_code;\n }\n \n String OS_Unix::get_locale() const {\ndiff --git a/drivers/unix/os_unix.h b/drivers/unix/os_unix.h\nindex 8fde52b5ff00..febc7c79cd89 100644\n--- a/drivers/unix/os_unix.h\n+++ b/drivers/unix/os_unix.h\n@@ -71,6 +71,9 @@ class OS_Unix : public OS {\n \tvoid _load_iconv();\n #endif\n \n+\tstatic int _wait_for_pid_completion(const pid_t p_pid, int *r_status, int p_options);\n+\tbool _check_pid_is_running(const pid_t p_pid, int *r_status) const;\n+\n protected:\n \t// UNIX only handles the core functions.\n \t// inheriting platforms under unix (eg. X11) should handle the rest\n", "test_patch": "", "problem_statement": "Unit tests fail under `lldb` supervision\n### Tested versions\n\na210fe6dbd27cc01bffacb0ce2816e0cf303af5e / 4.0+\n\n### System information\n\nGodot v4.4.1.stable - macOS Sequoia (15.3.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M1 Max (Apple7) - Apple M1 Max (10 threads)\n\n### Issue description\n\nWhen using `lldb`, `test_os.h` fails `[OS] Execute`.\nThis is a regression from https://github.com/godotengine/godot/pull/42069 (4.0), cc @Calinou.\n\n### Steps to reproduce\n\n1. Be on macOS (may fail on linux too)\n2. run  `\u276f lldb bin/godot.macos.editor.arm64 -- --test`\n3. run `run`\n4. Observe the error:\n\n```\n./tests/core/os/test_os.h:199: ERROR: CHECK( exit_code == 0 ) is NOT correct!\n  values: CHECK( 230 == 0 )\n  logged: Running the command `sh -c \"ls > /dev/null\"` returns a zero (successful) exit code.\n\nProcess 42405 stopped\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BREAKPOINT (code=1, subcode=0x1005063b0)\n    frame #0: 0x00000001005063b0 godot.macos.editor.arm64.master`TestOS::DOCTEST_ANON_FUNC_4825() at test_os.h:197:2 [opt]\n   194          CHECK_MESSAGE(\n   195                          err == OK,\n   196                          \"(Running the command `sh -c \\\"ls > /dev/null\\\"` returns the expected Godot error code (OK).\");\n-> 197          CHECK_MESSAGE(\n   198                          exit_code == 0,\n   199                          \"Running the command `sh -c \\\"ls > /dev/null\\\"` returns a zero (successful) exit code.\");\n   200  #endif\nTarget 0: (godot.macos.editor.arm64.master) stopped.\nwarning: godot.macos.editor.arm64.master was compiled with optimization - stepping may behave oddly; variables may not be available.\n```\n\nThe rest of the unit tests run through, so deleting the test is a temporary fix.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "I don't really know how this works, but I've tested this on a WSL Environment and this is what I got:\n```\nProcess 38477 launched: '/home/seif-eldin/repos/godot/bin/godot.linuxbsd.editor.dev.x86_64.llvm' (x86_64)\nProcess 38477 stopped and restarted: thread 1 received signal: SIGCHLD\n[doctest] doctest version is \"2.4.11\"\n[doctest] run with \"--help\" for options\ntERROR: Unrecognized binary resource file: 'res://gltf_placed_in_dot_godot_imported.scn'.\n   at: open (./core/io/resource_format_binary.cpp:1002)\nERROR: EditorNode doesn't exist.\n   at: make_scene_preview (./editor/editor_interface.cpp:236)\nERROR: Unrecognized binary resource file: 'res://gltf_pointing_to_texture_outside_of_res_folder.scn'.\n   at: open (./core/io/resource_format_binary.cpp:1002)\nERROR: EditorNode doesn't exist.\n   at: make_scene_preview (./editor/editor_interface.cpp:236)\nERROR: Unrecognized binary resource file: 'res://embedded_texture.scn'.\n   at: open (./core/io/resource_format_binary.cpp:1002)\nERROR: EditorNode doesn't exist.\n   at: make_scene_preview (./editor/editor_interface.cpp:236)\nProcess 38477 stopped and restarted: thread 1 received signal: SIGCHLD\n===============================================================================\n[doctest] test cases:    1216 |    1216 passed | 0 failed | 3 skipped\n[doctest] assertions: 2441777 | 2441777 passed | 0 failed |\n[doctest] Status: SUCCESS!\nProcess 38477 exited with status = 0 (0x00000000) \n```\nSo probably MacOS only\nI can reproduce it, but not sure what's the reason, seems like `fork` fail under LLDB.", "created_at": "2025-04-07 11:14:45", "merge_commit_sha": "d9a367649ee3d83f9ac875f9419cbdab476a80c6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104962", "base_commit": "6392241742796dc50ce2c5102cf5147033eba63a", "patch": "diff --git a/scene/resources/portable_compressed_texture.cpp b/scene/resources/portable_compressed_texture.cpp\nindex 99317af5a113..32c7a0965e6a 100644\n--- a/scene/resources/portable_compressed_texture.cpp\n+++ b/scene/resources/portable_compressed_texture.cpp\n@@ -171,6 +171,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t}\n \t\t} break;\n \t\tcase COMPRESSION_MODE_BASIS_UNIVERSAL: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_BASIS_UNIVERSAL, buffer.ptrw() + 2);\n \t\t\tImage::UsedChannels uc = p_image->detect_used_channels(p_normal_map ? Image::COMPRESS_SOURCE_NORMAL : Image::COMPRESS_SOURCE_GENERIC);\n \t\t\tVector<uint8_t> budata = Image::basis_universal_packer(p_image, uc);\n@@ -180,6 +181,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\tcase COMPRESSION_MODE_S3TC:\n \t\tcase COMPRESSION_MODE_ETC2:\n \t\tcase COMPRESSION_MODE_BPTC: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_IMAGE, buffer.ptrw() + 2);\n \t\t\tRef<Image> copy = p_image->duplicate();\n \t\t\tswitch (p_compression_mode) {\n@@ -195,7 +197,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t\tdefault: {\n \t\t\t\t};\n \t\t\t}\n-\n+\t\t\tencode_uint32(copy->get_format(), buffer.ptrw() + 4);\n \t\t\tbuffer.append_array(copy->get_data());\n \n \t\t} break;\n", "test_patch": "", "problem_statement": "Unexpected image buffer size when creating PortableCompressedTexture2D from Image\n### Tested versions\n\n- Reproducible in v4.5.dev [1f56d96cf], 4.4.1.stable [96579d139]\n\n### System information\n\nWindows 11 Vulkan (Forward+)\n\n### Issue description\n\nWhen trying to create a PortableCompressedTexture2D from an Image, the following error shows when using compressed formats.\n```\n  ERROR: Expected Image data size of 512x512x3 (RGB8 without mipmaps) = 786432 bytes, got 131072 bytes instead.\n  ERROR: Width must be equal or greater than 1 for all textures\n```\nIf `COMPRESSION_MODE_LOSSLESS `is used, there's no error displayed. Most probably, what's happening is that the Image data buffer is compressed here:\nhttps://github.com/godotengine/godot/blob/1f56d96cf2c768c3844c68ccb504dfeee841ae15/scene/resources/portable_compressed_texture.cpp#L182-L204\nSo the buffer is no longer of the expected size, since it is compressed.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Open the script `test.gd`\n- Then run the script with File > Run\n\n### Minimal reproduction project (MRP)\n\n[test.zip](https://github.com/user-attachments/files/19578958/test.zip)\n", "hints_text": "", "created_at": "2025-04-03 10:41:56", "merge_commit_sha": "cb8cb95bdda52aff2a167d912ab1d6c11df54b5c", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104776", "base_commit": "1f56d96cf2c768c3844c68ccb504dfeee841ae15", "patch": "diff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex f6f700de2a6a..8c891d08ce97 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -852,7 +852,7 @@ void TextEdit::_notification(int p_what) {\n \t\t\t}\n \n \t\t\tint first_vis_line = get_first_visible_line() - 1;\n-\t\t\tint draw_amount = visible_rows + (smooth_scroll_enabled ? 1 : 0);\n+\t\t\tint draw_amount = visible_rows + 1;\n \t\t\tdraw_amount += draw_placeholder ? placeholder_wrapped_rows.size() - 1 : get_line_wrap_count(first_vis_line + 1);\n \n \t\t\t// Draw minimap.\n@@ -4639,7 +4639,7 @@ int TextEdit::get_minimap_line_at_pos(const Point2i &p_pos) const {\n \tint minimap_visible_lines = get_minimap_visible_lines();\n \tint visible_rows = get_visible_line_count() + 1;\n \tint first_vis_line = get_first_visible_line() - 1;\n-\tint draw_amount = visible_rows + (smooth_scroll_enabled ? 1 : 0);\n+\tint draw_amount = visible_rows + 1;\n \tdraw_amount += get_line_wrap_count(first_vis_line + 1);\n \tint minimap_line_height = (minimap_char_size.y + minimap_line_spacing);\n \n@@ -8053,7 +8053,7 @@ void TextEdit::_update_scrollbars() {\n \n \tint visible_rows = get_visible_line_count();\n \tint total_rows = draw_placeholder ? placeholder_wrapped_rows.size() : get_total_visible_line_count();\n-\tif (scroll_past_end_of_file_enabled && !fit_content_height) {\n+\tif ((scroll_past_end_of_file_enabled && !fit_content_height) || visible_rows == 0) {\n \t\ttotal_rows += visible_rows - 1;\n \t}\n \n@@ -8076,7 +8076,6 @@ void TextEdit::_update_scrollbars() {\n \t\tv_scroll->set_max(total_rows + _get_visible_lines_offset());\n \t\tv_scroll->set_page(visible_rows + _get_visible_lines_offset());\n \t\tset_v_scroll(get_v_scroll());\n-\n \t} else {\n \t\tfirst_visible_line = 0;\n \t\tfirst_visible_line_wrap_ofs = 0;\n", "test_patch": "diff --git a/tests/scene/test_text_edit.h b/tests/scene/test_text_edit.h\nindex 8a10c0b6ee59..19db4f19e17e 100644\n--- a/tests/scene/test_text_edit.h\n+++ b/tests/scene/test_text_edit.h\n@@ -7920,6 +7920,20 @@ TEST_CASE(\"[SceneTree][TextEdit] viewport\") {\n \tmemdelete(text_edit);\n }\n \n+TEST_CASE(\"[SceneTree][TextEdit] small height value\") {\n+\tTextEdit *text_edit = memnew(TextEdit);\n+\tSceneTree::get_singleton()->get_root()->add_child(text_edit);\n+\n+\ttext_edit->set_size(Size2(800, 32));\n+\ttext_edit->set_text(\"0\\n1\\n2\");\n+\tMessageQueue::get_singleton()->flush();\n+\n+\ttext_edit->set_v_scroll(100);\n+\tCHECK(text_edit->get_v_scroll() < 3);\n+\n+\tmemdelete(text_edit);\n+}\n+\n TEST_CASE(\"[SceneTree][TextEdit] setter getters\") {\n \tTextEdit *text_edit = memnew(TextEdit);\n \tSceneTree::get_singleton()->get_root()->add_child(text_edit);\n", "problem_statement": "TextEdit Scroll Repeats Last Line and Text Pops In\n### Tested versions\n\n- Reproducible in 4.4 Stable, 4.3 Stable, 4.2.2 Stable, 4.2 Stable\n- Not Reproducible in 4.1.4 Stable\n\n### System information\n\nGodot v4.2.stable - macOS 14.5.0 - Vulkan (Forward+) - integrated Apple M1 Pro - Apple M1 Pro (10 Threads)\n\n### Issue description\n\nFor certain heights, the `TextEdit` displays text only displays when the line is fully visible, like a popping into existence effect. This also causes the last line to appear to repeat twice when scrolling down.\n\nFor one line; the following heights have issues: 15-21, 23-24, 26-29, 31-32, 34 px\n\nhttps://github.com/user-attachments/assets/82f8544a-3491-44d5-9da7-ca0a70ed694b\n\n### Steps to reproduce\n\n1. Create a scene with a TextEdit Node\n2. Set the text to \"0\"\n3. Set the size to (100, 32)\n4. Run the scene, and scroll down on the TextEdit\n\n### Minimal reproduction project (MRP)\n\n[MRP.zip](https://github.com/user-attachments/files/19400545/MRP.zip)\n", "hints_text": "", "created_at": "2025-03-29 20:13:47", "merge_commit_sha": "9bbda47794ede4f7fe4b7bc12605c124e0e95bee", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104744", "base_commit": "7598b08ec2ccf6c5bbc2c2020f583fc625e3238b", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 31a8d07fea80..789909b22351 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -148,7 +148,9 @@ def detect_build_env_arch():\n \n \n def get_tools(env: \"SConsEnvironment\"):\n-    if os.name != \"nt\" or env.get(\"use_mingw\"):\n+    from SCons.Tool.MSCommon import msvc_exists\n+\n+    if os.name != \"nt\" or env.get(\"use_mingw\") or not msvc_exists():\n         return [\"mingw\"]\n     else:\n         msvc_arch_aliases = {\"x86_32\": \"x86\", \"arm32\": \"arm\"}\n", "test_patch": "", "problem_statement": "[Windows] Scons isn't detecting MinGW and fails when building\n### Tested versions\n\n- Reproducible in master (4.5.dev) - commit [6b5b84c0c50135e88691e035d3e00c68a2ae5aa4]\n- **Not** reproducible in 4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7735HS with Radeon Graphics (16 threads)\n\n### Issue description\n\nScons fails to detect MinGW (I'm using [LLVM-MinGW](https://github.com/mstorsjo/llvm-mingw/releases/)) which is included in my PATH, then complains it can't find MSVC and errors out. Scons works perfectly fine for me in 4.4 stable.\n\nThis is what I get when trying to build on master:\n\n```\n> scons\nscons: Reading SConscript files ...\nAutomatically detected platform: windows\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink', 'mslib']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\nBuilding for platform \"windows\", architecture \"x86_64\", target \"template_release\".\nKeyError: 'VSWHERE':\n  File \"D:\\Godot Dev\\godot\\SConstruct\", line 623:\n    cc_version = methods.get_compiler_version(env)\n  File \"D:\\Godot Dev\\godot\\methods.py\", line 698:\n    env[\"VSWHERE\"],\n  File \"C:\\Users\\ahmou\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python311\\site-packages\\SCons\\Environment.py\", line 603:\n    return self._dict[key]\n```\n\n### Steps to reproduce\n\nTry building on Windows with MinGW, without MSVC installed\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "What commit specifically are you building from to get an idea of where this is occuring\nUpdated the post to include the commit SHA, it's `6b5b84c0c50135e88691e035d3e00c68a2ae5aa4`\nTo build with MinGW on Windows, you need to specific `mingw=yes` explicitly, otherwise it defaults to MSVC.\n\nI'm surprised it would work differently in 4.4.stable.\n\nCC @Repiteo in case there were recent changes.\n> To build with MinGW on Windows, you need to specific mingw=yes explicitly, otherwise it defaults to MSVC.\r\n\r\nI never had to specify it specifically before. For what it's worth I think falling back to mingw if you don't have MSVC should be the intended behavior.\r\n\r\n~~Also, it turns out compiling with `mingw=yes` doesn't work either. Same error.~~ Nevermind, The command is `use_mingw=yes` and that works fine. My bad!\r\n\r\n<details>\r\n<summary> output </summary>\r\n<pre><code>> scons mingw=yes\r\nscons: Reading SConscript files ...\r\nAutomatically detected platform: windows\r\n\r\nscons: warning: No versions of the MSVC compiler were found.\r\n  Visual Studio C/C++ compilers may not be set correctly.\r\n  Requested tool(s) are: ['msvc']\r\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\r\n\r\nscons: warning: No versions of the MSVC compiler were found.\r\n  Visual Studio C/C++ compilers may not be set correctly.\r\n  Requested tool(s) are: ['msvc', 'mslink']\r\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\r\n\r\nscons: warning: No versions of the MSVC compiler were found.\r\n  Visual Studio C/C++ compilers may not be set correctly.\r\n  Requested tool(s) are: ['msvc', 'mslink', 'mslib']\r\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\r\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\r\nBuilding for platform \"windows\", architecture \"x86_64\", target \"editor\".\r\nKeyError: 'VSWHERE':\r\n  File \"D:\\Godot Dev\\godot\\SConstruct\", line 623:\r\n    cc_version = methods.get_compiler_version(env)\r\n  File \"D:\\Godot Dev\\godot\\methods.py\", line 698:\r\n    env[\"VSWHERE\"],\r\n  File \"C:\\Users\\ahmou\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python311\\site-packages\\SCons\\Environment.py\", line 603:\r\n    return self._dict[key]</code></pre>\r\n</details>\nI haven't tested, but I suspect it may be a regression from #103864.\nI use `scons use_mingw=yes use_llvm=yes` with [LLVM-MinGW](https://github.com/mstorsjo/llvm-mingw/releases/), it works fine for me.\nMinGW should absolutely be the fallback option if MSVC isn't available, but that'll be tricky to test with on a PC that already has that environment integrated. I'll run some tests on a virtual machine & see what I can find.\n\n> Also, it turns out compiling with `mingw=yes` doesn't work either. Same error.\n\nOop, that's the wrong name. You'll want `use_mingw=yes` instead. I'll make `mingw` an alias in the fix PR.\n> MinGW should absolutely be the fallback option if MSVC isn't available, but that'll be tricky to test with on a PC that already has that environment integrated. I'll run some tests on a virtual machine & see what I can find.\n\nThis is supposed to happen already (since 4.0 if not earlier), but it's not working for some reason.", "created_at": "2025-03-28 21:57:24", "merge_commit_sha": "08615299b7aaadee88cdd05662e88d2b337c2719", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104669", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex 42cd8632941d..6e76f06a3095 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -933,15 +933,16 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n+\t\t\t\tconst String file_path = ia.dir->get_file_path(idx);\n+\t\t\t\tconst String class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n+\t\t\t\t\t_queue_update_script_class(file_path, ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n-\t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n+\t\t\t\t\t_queue_update_scene_groups(file_path);\n \t\t\t\t}\n \n-\t\t\t\t_delete_internal_files(ia.dir->files[idx]->file);\n+\t\t\t\t_delete_internal_files(file_path);\n \t\t\t\tmemdelete(ia.dir->files[idx]);\n \t\t\t\tia.dir->files.remove_at(idx);\n \n", "test_patch": "", "problem_statement": ".import / .uid file is not removed when original file is not in root directory and gets removed outside editor\n### Tested versions\n\n4.4 dev4\nLikely earlier too.\n\n### System information\n\nWindows 10.0.19045 - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1060 (NVIDIA; 32.0.15.6603) - Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz (8 threads)\n\n### Issue description\n\nWhen you delete a file outside editor, Godot tries to delete corresponding .import/.uid file. However this only happens if the file is in the project's root directory. If it's in any subdirectory, the other file just stays there and you have to delete it manually.\n\n### Steps to reproduce\n\n1. Open project's root directory in OS' file manager\n2. Delete icon.svg\n3. Focus the editor\n4. The engine will process FileSystem and automatically delete icon.svg.import.\n5. Try again with icon.svg in a subfolder\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "I am confused by a related question: \nIs it safe to copy one project's addons which contain some .uid files to another project? What if the uids are already exist in the target project?\nOr do we need to add .uid into `.gitignore` file if we use a version control tool? Do we need to delete .uid files after we copy scripts from an old project into a new project?\nEach generated .uid file is unique, so if you copy them between projects they will work as expected.\nThanks, I checked the code:\nhttps://github.com/godotengine/godot/blob/cf038deb1033007167a05a4518a0e8b2dae5e93e/core/io/resource_uid.cpp#L88-L100\n\nI can understand the newly generated uid won't be the same as existing uids in a project, but there are some chances that two projects generate the same uid, aren't there?\n\nImagine this situation:\nProject A: `a.gd.uid` which content is `uid://4pmd34mck18a`, \nProject B: `b.gd.uid` which content is also `uid://4pmd34mck18a` ,\nWhen copying `a.gd` and `a.gd.uid` into Project B, some error will occur.\n\nIn fact, for a long time, I have the same concern about copying files like `.tscn` from one project to another project because I fear that the resource ids in `.tscn` will accidentally be same as those in the target project. The newly introduced `.uid` file raised my concern again. \n\nI can't do much to `.tscn`, `.tres` files but I can add .uid into `.gitignore` especially for addons if I want to share them with others but I don't know if this is even necessary or a good idea. Do you have any suggestions?\n> there are some chances that two projects generate the same uid, aren't there?\n\nThere are, but very very low. I think the editor can already deal with duplicate UIDs to some extent, but we can improve it. It's unlikely to be a problem though.\n\n> I can add .uid into .gitignore especially for addons if I want to share them with others but I don't know if this is even necessary or a good idea.\n\nIt's not necessary, but it would work. Note however that scenes automatically refer to files by both path and UID, so if you don't provide script's UID and that script is referenced in a scene, you will get an error while loading. The editor is able to fix UID by checking the path, but the error (warning) is still being printed.", "created_at": "2025-03-26 20:21:52", "merge_commit_sha": "2377309c094f64507e98bc7ff446ccb24d443bfe", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104662", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex 19d59e53c99f..d3648c9faf02 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -685,6 +685,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t} else {\n \t\t\tp_table->total_width += p_table->columns[i].width;\n \t\t}\n+\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t}\n \n \t// Resize to max_width if needed and distribute the remaining space.\n@@ -702,6 +703,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\tp_table->columns[i].width = p_table->columns[i].max_width;\n \t\t\t\tp_table->total_width -= dif;\n \t\t\t\ttotal_ratio -= p_table->columns[i].expand_ratio;\n+\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t}\n \t\t}\n \t\t// Grow.\n@@ -715,6 +717,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\t\t\tint incr = MIN(dif, slice);\n \t\t\t\t\t\tp_table->columns[i].width += incr;\n \t\t\t\t\t\tp_table->total_width += incr;\n+\t\t\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n@@ -745,6 +748,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \n \t\t\tframe->lines[i].text_buf->set_width(p_table->columns[column].width);\n \t\t\tp_table->columns[column].width = MAX(p_table->columns[column].width, ceil(frame->lines[i].text_buf->get_size().x));\n+\t\t\tp_table->columns[column].width_with_padding = MAX(p_table->columns[column].width_with_padding, ceil(frame->lines[i].text_buf->get_size().x + frame->padding.position.x + frame->padding.size.x));\n \n \t\t\tframe->lines[i].offset.y = prev_h;\n \n@@ -780,6 +784,12 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t}\n \t\tidx++;\n \t}\n+\n+\t// Recalculate total width.\n+\tp_table->total_width = 0;\n+\tfor (int i = 0; i < col_count; i++) {\n+\t\tp_table->total_width += p_table->columns[i].width_with_padding + theme_cache.table_h_separation;\n+\t}\n }\n \n int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_ofs, int p_width, float p_vsep, const Color &p_base_color, int p_outline_size, const Color &p_outline_color, const Color &p_font_shadow_color, int p_shadow_outline_size, const Point2 &p_shadow_ofs, int &r_processed_glyphs) {\ndiff --git a/scene/gui/rich_text_label.h b/scene/gui/rich_text_label.h\nindex 013ee15c03fe..dd1cedcd8bb5 100644\n--- a/scene/gui/rich_text_label.h\n+++ b/scene/gui/rich_text_label.h\n@@ -347,6 +347,7 @@ class RichTextLabel : public Control {\n \t\t\tint min_width = 0;\n \t\t\tint max_width = 0;\n \t\t\tint width = 0;\n+\t\t\tint width_with_padding = 0;\n \t\t};\n \n \t\tLocalVector<Column> columns;\n", "test_patch": "", "problem_statement": "RichTextLabel table with padding and BBCode enabled cause misalignment\n### Tested versions\n\nv4.5.dev.custom_build.6b4fda04c\n\n### System information\n\nGodot v4.5.dev (6b4fda04c) - Ubuntu 22.04.5 LTS 22.04 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - D3D12 (AMD Radeon(TM) Graphics) - AMD Ryzen 5 5600H with Radeon Graphics (12 threads)\n\n### Issue description\n\nWhen using a RichTextLabel with BBCode enabled, tables with padding display incorrect horizontal and vertical alignment. This issue only occurs when BBCode is enabled.\nI would like to fix this bug as my first contribution to Godot. I'm already investigating the offset calculation in the relevant functions and would appreciate any guidance from the maintainers on the correct approach.\n\nhttps://github.com/user-attachments/assets/b1a6895c-f446-4fa2-b885-6757e4ca36d9\n\n### Steps to reproduce\n\n1.Create a RichTextLabel node\n2.Enable BBCode (set bbcode_enabled = true)\n3.Set text content with a table that includes padding, for example:\n```\n[table=1]\n[cell bg=black padding=20,20,20,20]Lorem ipsum dolor sit amet, consectetur adipiscing elit.[/cell]\n[/table]\n```\n\n\n### Minimal reproduction project (MRP)\n\n[padding-misalignment.zip](https://github.com/user-attachments/files/19135134/padding-misalignment.zip)\n", "hints_text": "", "created_at": "2025-03-26 18:51:57", "merge_commit_sha": "ca1f4454035804af0a18973e7b86bce87abc9ac4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104614", "base_commit": "1ba856565d726d32e07f86610668966e9904115d", "patch": "diff --git a/scene/gui/control.cpp b/scene/gui/control.cpp\nindex a64de8fb3c5d..57bc748bfe90 100644\n--- a/scene/gui/control.cpp\n+++ b/scene/gui/control.cpp\n@@ -481,9 +481,9 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t}\n \n \t// Validate which positioning properties should be displayed depending on the parent and the layout mode.\n-\tNode *parent_node = get_parent_control();\n-\tif (!parent_node) {\n-\t\t// If there is no parent, display both anchor and container options.\n+\tControl *parent_control = get_parent_control();\n+\tif (!parent_control) {\n+\t\t// If there is no parent control, display both anchor and container options.\n \n \t\t// Set the layout mode to be disabled with the proper value.\n \t\tif (p_property.name == \"layout_mode\") {\n@@ -496,7 +496,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\tif (!use_custom_anchors && (p_property.name.begins_with(\"anchor_\") || p_property.name.begins_with(\"offset_\") || p_property.name.begins_with(\"grow_\"))) {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_EDITOR;\n \t\t}\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\t// If the parent is a container, display only container-related properties.\n \t\tif (p_property.name.begins_with(\"anchor_\") || p_property.name.begins_with(\"offset_\") || p_property.name.begins_with(\"grow_\") || p_property.name == \"anchors_preset\") {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_DEFAULT;\n@@ -508,7 +508,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\t\tp_property.usage |= PROPERTY_USAGE_READ_ONLY;\n \t\t} else if (p_property.name == \"size_flags_horizontal\" || p_property.name == \"size_flags_vertical\") {\n \t\t\t// Filter allowed size flags based on the parent container configuration.\n-\t\t\tContainer *parent_container = Object::cast_to<Container>(parent_node);\n+\t\t\tContainer *parent_container = Object::cast_to<Container>(parent_control);\n \t\t\tVector<int> size_flags;\n \t\t\tif (p_property.name == \"size_flags_horizontal\") {\n \t\t\t\tsize_flags = parent_container->get_allowed_size_flags_horizontal();\n@@ -548,7 +548,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\t\t}\n \t\t}\n \t} else {\n-\t\t// If the parent is NOT a container or not a control at all, display only anchoring-related properties.\n+\t\t// If the parent is a non-container control, display only anchoring-related properties.\n \t\tif (p_property.name.begins_with(\"size_flags_\")) {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_EDITOR;\n \n@@ -570,7 +570,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t}\n \n \t// Disable the property if it's managed by the parent container.\n-\tif (!Object::cast_to<Container>(parent_node)) {\n+\tif (!Object::cast_to<Container>(parent_control)) {\n \t\treturn;\n \t}\n \tbool property_is_managed_by_container = false;\n@@ -905,11 +905,11 @@ void Control::_update_layout_mode() {\n }\n \n Control::LayoutMode Control::_get_layout_mode() const {\n-\tNode *parent_node = get_parent_control();\n+\tControl *parent_control = get_parent_control();\n \t// In these modes the property is read-only.\n-\tif (!parent_node) {\n+\tif (!parent_control) {\n \t\treturn LayoutMode::LAYOUT_MODE_UNCONTROLLED;\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\treturn LayoutMode::LAYOUT_MODE_CONTAINER;\n \t}\n \n@@ -918,20 +918,25 @@ Control::LayoutMode Control::_get_layout_mode() const {\n \t\treturn LayoutMode::LAYOUT_MODE_ANCHORS;\n \t}\n \n-\t// Otherwise fallback on what's stored.\n-\treturn data.stored_layout_mode;\n+\t// Only position/anchors modes are valid for non-container control parent.\n+\tif (data.stored_layout_mode == LayoutMode::LAYOUT_MODE_POSITION || data.stored_layout_mode == LayoutMode::LAYOUT_MODE_ANCHORS) {\n+\t\treturn data.stored_layout_mode;\n+\t}\n+\n+\t// Otherwise fallback to position mode.\n+\treturn LayoutMode::LAYOUT_MODE_POSITION;\n }\n \n Control::LayoutMode Control::_get_default_layout_mode() const {\n-\tNode *parent_node = get_parent_control();\n+\tControl *parent_control = get_parent_control();\n \t// In these modes the property is read-only.\n-\tif (!parent_node) {\n+\tif (!parent_control) {\n \t\treturn LayoutMode::LAYOUT_MODE_UNCONTROLLED;\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\treturn LayoutMode::LAYOUT_MODE_CONTAINER;\n \t}\n \n-\t// Otherwise fallback on the position mode.\n+\t// Otherwise fallback to the position mode.\n \treturn LayoutMode::LAYOUT_MODE_POSITION;\n }\n \n", "test_patch": "", "problem_statement": "Layout Mode becomes `2` when parent type is changed\n### Tested versions\n\n4.5 dev1\nProbably earlier too\n\n### System information\n\nW10\n\n### Issue description\n\nWhen a Control node is under a Container and the Container is changed to Control, the child's Layout Mode changes to `2` (which is Container, but without name?)\n\nhttps://github.com/user-attachments/assets/f0bb6975-4a6a-4516-92b1-93e795917629\n\n### Steps to reproduce\n\n1. Add a Container node\n2. Add a Control as its child\n3. Change Type of the Container to Control\n4. Check the Layout Mode of its child\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Could confirm, saw it before in 4.4 stable.\nIt showing `2` is directly caused by #102743 as it made the actual value be shown in case it doesn't match any value from the `hint_string`.\n\nControl changes `hint_string` for the `layout_mode` in `validate_property` depending on the setup:\nhttps://github.com/godotengine/godot/blob/6b5b84c0c50135e88691e035d3e00c68a2ae5aa4/scene/gui/control.cpp#L489-L490\nhttps://github.com/godotengine/godot/blob/6b5b84c0c50135e88691e035d3e00c68a2ae5aa4/scene/gui/control.cpp#L505-L507\nhttps://github.com/godotengine/godot/blob/6b5b84c0c50135e88691e035d3e00c68a2ae5aa4/scene/gui/control.cpp#L555-L557\n\nSo the actual problem seems to be that it doesn't automatically reset to a valid `layout_mode` according to the current setup? \ud83e\udd14", "created_at": "2025-03-25 16:21:30", "merge_commit_sha": "b7c452a36de2fdd32e96a964ef347df2f08421d1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104599", "base_commit": "6b5b84c0c50135e88691e035d3e00c68a2ae5aa4", "patch": "diff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex ba904f0e9192..02fcbbc7e6a7 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -787,7 +787,6 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tr_info->normal = to_godot(-hit.mPenetrationAxis.Normalized());\n \tr_info->rid = object->get_rid();\n \tr_info->collider_id = object->get_instance_id();\n-\tr_info->shape = 0;\n \tr_info->linear_velocity = object->get_velocity_at_position(hit_point);\n \n \treturn true;\n", "test_patch": "", "problem_statement": "Built-in Jolt Physics colliding shape index is always 0\n### Tested versions\n\n- Reproducible in: v4.4.stable.official [4c311cbee] with built-in Jolt Physics\n- Not reproducible in: v4.3.stable.official [77dcf97d8] with Godot Jolt 0.15.0 Extension from AssetLib\n\n### System information\n\nGodot v4.3.stable - Garuda Linux #1 ZEN SMP PREEMPT_DYNAMIC Fri, 07 Mar 2025 20:18:44 +0000 - X11 - GLES3 (Compatibility) - Mesa Intel(R) HD Graphics 630 (KBL GT2) - Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz (8 Threads)\n\n### Issue description\n\nIssue: When using Godot 4.4 with built-in Jolt Physics, `shape` value in the `get_rest_info()` output dictionary (obtained as ShapeCast3D's `collision_result`) is 0 regardless of the actual shape with which ShapeCast3D collided. \n\nExpected: different shapes have different shape indexes.\n\nThis issue does not occur when using DEFAULT physics on Godot 4.4, and it also doesnt occur when using  Godot Jolt extension or DEFAULT physics on Godot 4.3 version.\n\n### Steps to reproduce\n\n- Open MRP\n- Set project's physics engine to Jolt\n- Launch the game, note the output in the terminal being all 0 (three collision shapes report three different shapes of the same rigid body have index 0)\n- Change project's physics engine to DEFAULT\n- Launch the game, the output in the terminal should read 0 1 2 (three different shapes have different indexes)\n\nIdentical setup in a 4.3 project using the Godot Jolt Extension produces 0 1 2 as expected.\n\n### Minimal reproduction project (MRP)\n\n[ShapeTest4.4.zip](https://github.com/user-attachments/files/19436320/ShapeTest4.4.zip)\n", "hints_text": "Update:\nOn 4.4, downloading the Jolt extension from the AssetLib and using it instead of the built-in Jolt solves the issue presented in the MRP.", "created_at": "2025-03-25 11:38:49", "merge_commit_sha": "b699508b07c40beab8ab332399ec588cb2239240", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104578", "base_commit": "6b5b84c0c50135e88691e035d3e00c68a2ae5aa4", "patch": "diff --git a/scene/animation/tween.cpp b/scene/animation/tween.cpp\nindex 230f55de8427..db0f0e2684ba 100644\n--- a/scene/animation/tween.cpp\n+++ b/scene/animation/tween.cpp\n@@ -542,6 +542,20 @@ Tween::Tween(SceneTree *p_parent_tree) {\n \tvalid = true;\n }\n \n+double PropertyTweener::_get_custom_interpolated_value(const Variant &p_value) {\n+\tconst Variant *argptr = &p_value;\n+\n+\tVariant result;\n+\tCallable::CallError ce;\n+\tcustom_method.callp(&argptr, 1, result, ce);\n+\tif (ce.error != Callable::CallError::CALL_OK) {\n+\t\tERR_FAIL_V_MSG(false, \"Error calling custom method from PropertyTweener: \" + Variant::get_callable_error_text(custom_method, &argptr, 1, ce) + \".\");\n+\t} else if (result.get_type() != Variant::FLOAT) {\n+\t\tERR_FAIL_V_MSG(false, vformat(\"Wrong return type in PropertyTweener custom method. Expected float, got %s.\", Variant::get_type_name(result.get_type())));\n+\t}\n+\treturn result;\n+}\n+\n Ref<PropertyTweener> PropertyTweener::from(const Variant &p_value) {\n \tRef<Tween> tween = _get_tween();\n \tERR_FAIL_COND_V(tween.is_null(), nullptr);\n@@ -638,17 +652,7 @@ bool PropertyTweener::step(double &r_delta) {\n \tif (time < duration) {\n \t\tif (custom_method.is_valid()) {\n \t\t\tconst Variant t = tween->interpolate_variant(0.0, 1.0, time, duration, trans_type, ease_type);\n-\t\t\tconst Variant *argptr = &t;\n-\n-\t\t\tVariant result;\n-\t\t\tCallable::CallError ce;\n-\t\t\tcustom_method.callp(&argptr, 1, result, ce);\n-\t\t\tif (ce.error != Callable::CallError::CALL_OK) {\n-\t\t\t\tERR_FAIL_V_MSG(false, \"Error calling custom method from PropertyTweener: \" + Variant::get_callable_error_text(custom_method, &argptr, 1, ce) + \".\");\n-\t\t\t} else if (result.get_type() != Variant::FLOAT) {\n-\t\t\t\tERR_FAIL_V_MSG(false, vformat(\"Wrong return type in PropertyTweener custom method. Expected float, got %s.\", Variant::get_type_name(result.get_type())));\n-\t\t\t}\n-\n+\t\t\tdouble result = _get_custom_interpolated_value(t);\n \t\t\ttarget_instance->set_indexed(property, Animation::interpolate_variant(initial_val, final_val, result));\n \t\t} else {\n \t\t\ttarget_instance->set_indexed(property, tween->interpolate_variant(initial_val, delta_val, time, duration, trans_type, ease_type));\n@@ -656,7 +660,12 @@ bool PropertyTweener::step(double &r_delta) {\n \t\tr_delta = 0;\n \t\treturn true;\n \t} else {\n-\t\ttarget_instance->set_indexed(property, final_val);\n+\t\tif (custom_method.is_valid()) {\n+\t\t\tdouble final_t = _get_custom_interpolated_value(1.0);\n+\t\t\ttarget_instance->set_indexed(property, Animation::interpolate_variant(initial_val, final_val, final_t));\n+\t\t} else {\n+\t\t\ttarget_instance->set_indexed(property, final_val);\n+\t\t}\n \t\tr_delta = elapsed_time - delay - duration;\n \t\t_finish();\n \t\treturn false;\ndiff --git a/scene/animation/tween.h b/scene/animation/tween.h\nindex 8d4b9eae6b48..d987b6e9a867 100644\n--- a/scene/animation/tween.h\n+++ b/scene/animation/tween.h\n@@ -200,6 +200,8 @@ VARIANT_ENUM_CAST(Tween::EaseType);\n class PropertyTweener : public Tweener {\n \tGDCLASS(PropertyTweener, Tweener);\n \n+\tdouble _get_custom_interpolated_value(const Variant &p_value);\n+\n public:\n \tRef<PropertyTweener> from(const Variant &p_value);\n \tRef<PropertyTweener> from_current();\n", "test_patch": "", "problem_statement": "[Tween] PropertyTweener with a custom interpolator always stops at the 'to' value.\n### Tested versions\n\n- Tested in 4.4 stable (probably a long standing issue)\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3050 (NVIDIA; 32.0.15.7283) - AMD Ryzen 5 4500 6-Core Processor (12 threads)\n\n### Issue description\n\nWhen tweening a property with a custom interpolator, it always set's the property to the final position after the tween finishes, rather than the value it should be at based from the custom interpolator function.\n\nExample:\n\n`func _ready() -> void:\n\ttween = create_tween()\n\ttween.tween_property(self, \"position:x, 500.0, 2.0).set_custom_interpolator(_interpolator)\n\nfunc _interpolator(time: float) -> float:\n\treturn 0.25\n`\nshould be aways at 25% of the way, but after the tween finishes, the x-position goes to 500.\n\n### Steps to reproduce\n\n- Create a function that does not return 1.0 when the input parameter is 1.0.\n- Set that function as the custom interpolator for the PropertyTweener.\n\n### Minimal reproduction project (MRP)\n\n[tween_test_2025-03-24_07-49-49.zip](https://github.com/user-attachments/files/19437132/tween_test_2025-03-24_07-49-49.zip)\n\nThis uses almost the same example given in the docs (https://docs.godotengine.org/en/stable/classes/class_propertytweener.html#class-propertytweener-method-set-custom-interpolator).\n", "hints_text": "", "created_at": "2025-03-24 21:56:37", "merge_commit_sha": "e10974b1886a38883665e46142bd7b4959a611ea", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104485", "base_commit": "cc7217970d02b84122b59569cf7ed3b52cf815a6", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex d9bead1e7832..5611d00814f3 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -579,6 +579,12 @@ void EditorProperty::_notification(int p_what) {\n \t\t\t}\n \t\t} break;\n \t\tcase NOTIFICATION_ENTER_TREE: {\n+\t\t\tEditorInspector *inspector = get_parent_inspector();\n+\t\t\tif (inspector) {\n+\t\t\t\tinspector = inspector->get_root_inspector();\n+\t\t\t}\n+\t\t\tset_shortcut_context(inspector);\n+\n \t\t\tif (has_borders) {\n \t\t\t\tget_parent()->connect(SceneStringName(theme_changed), callable_mp(this, &EditorProperty::_update_property_bg));\n \t\t\t\t_update_property_bg();\n", "test_patch": "", "problem_statement": "Ctrl+C and Ctrl+V shortcuts are broken, they apply to the wrong tab\n### Tested versions\r\n\r\nv4.2.1.stable.mono.official [b09f793f5]\r\n\r\n\r\n\r\n### System information\r\n\r\nGodot v4.2.1.stable.mono - Windows 10.0.19045 - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1060 6GB (NVIDIA; 31.0.15.3623) - AMD Ryzen 5 2600X Six-Core Processor (12 Threads)\r\n\r\n### Issue description\r\n\r\nWhen I try to use Ctrl+C and Ctrl+V to copy and paste an object in my scene, it instead for some reason pastes an option in the `Import` tab.\r\n\r\n- I do not have the `Import` tab open, I have the `Scene` tab open.\r\n- I do not even have something selected in the `FileSystem` tab which would show up in the `Import` tab when I switch to it.\r\n- But nonetheless I get `Set meshes/force_disable_compression` in the output when trying to Ctrl+C and Ctrl+V, which was the most recent setting I changed in the `Import` tab before moving on to other tasks.\r\n\r\nUsing the right click menu and selecting `Copy` and then selecting `Paste` works as intended. For some reason it is just the keyboard shortcut which is broken.\r\n\r\n### Steps to reproduce\r\n\r\n1. change a setting in the `Import` tab\r\n2. try to copy something in the `Scene` tab\r\n3. it will do nothing and the output will show that it just affected whatever setting you changed in the `Import` tab.\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\nOpen a brand new project and follow the steps. Change an import setting of icon.svg and now you cannot Ctrl+C Ctrl+V in the `Scene` tab\n", "hints_text": "- Related to https://github.com/godotengine/godot/issues/70673.\r\n\r\nThis is an editor shortcut focus issue (a shortcut is global when it shouldn't be), which is a recurring issue throughout the editor.", "created_at": "2025-03-22 13:58:17", "merge_commit_sha": "fd27e4f795b7e825aae890c1415e9793c701ca08", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104444", "base_commit": "7598b08ec2ccf6c5bbc2c2020f583fc625e3238b", "patch": "diff --git a/scene/gui/control.cpp b/scene/gui/control.cpp\nindex a64de8fb3c5d..8d34746529e7 100644\n--- a/scene/gui/control.cpp\n+++ b/scene/gui/control.cpp\n@@ -1880,16 +1880,20 @@ void Control::set_mouse_recursive_behavior(RecursiveBehavior p_recursive_mouse_b\n \tif (data.mouse_recursive_behavior == p_recursive_mouse_behavior) {\n \t\treturn;\n \t}\n+\t_set_mouse_recursive_behavior_ignore_cache(p_recursive_mouse_behavior);\n+}\n+\n+void Control::_set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior) {\n \tdata.mouse_recursive_behavior = p_recursive_mouse_behavior;\n \tif (p_recursive_mouse_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n+\t\t\t_propagate_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n+\t\t_propagate_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n \t}\n \n \tif (get_viewport()) {\n@@ -2064,16 +2068,20 @@ void Control::set_focus_recursive_behavior(RecursiveBehavior p_recursive_focus_b\n \tif (data.focus_recursive_behavior == p_recursive_focus_behavior) {\n \t\treturn;\n \t}\n+\t_set_focus_recursive_behavior_ignore_cache(p_recursive_focus_behavior);\n+}\n+\n+void Control::_set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_focus_behavior) {\n \tdata.focus_recursive_behavior = p_recursive_focus_behavior;\n \tif (p_recursive_focus_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n+\t\t\t_propagate_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_focus_behavior_recursively(p_recursive_focus_behavior, false);\n+\t\t_propagate_focus_behavior_recursively(p_recursive_focus_behavior, false);\n \t}\n }\n \n@@ -2449,7 +2457,7 @@ bool Control::_is_focus_disabled_recursively() const {\n \treturn false;\n }\n \n-void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n \tif (is_inside_tree() && (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED || (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_INHERITED && p_focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED)) && has_focus()) {\n \t\trelease_focus();\n \t}\n@@ -2463,7 +2471,7 @@ void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_focus_behavior_recursively(p_focus_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_focus_behavior_recursively(p_focus_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -2480,7 +2488,7 @@ bool Control::_is_parent_mouse_disabled() const {\n \treturn false;\n }\n \n-void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n \tif (p_skip_non_inherited && data.mouse_recursive_behavior != RECURSIVE_BEHAVIOR_INHERITED) {\n \t\treturn;\n \t}\n@@ -2490,7 +2498,7 @@ void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -3450,8 +3458,8 @@ void Control::_notification(int p_notification) {\n \n \t\t\t_update_layout_mode();\n \n-\t\t\tset_focus_recursive_behavior(data.focus_recursive_behavior);\n-\t\t\tset_mouse_recursive_behavior(data.mouse_recursive_behavior);\n+\t\t\t_set_focus_recursive_behavior_ignore_cache(data.focus_recursive_behavior);\n+\t\t\t_set_mouse_recursive_behavior_ignore_cache(data.mouse_recursive_behavior);\n \t\t} break;\n \n \t\tcase NOTIFICATION_UNPARENTED: {\ndiff --git a/scene/gui/control.h b/scene/gui/control.h\nindex 8188b3ba31d0..b2001fdd259f 100644\n--- a/scene/gui/control.h\n+++ b/scene/gui/control.h\n@@ -330,8 +330,10 @@ class Control : public CanvasItem {\n \tvoid _window_find_focus_neighbor(const Vector2 &p_dir, Node *p_at, const Rect2 &p_rect, const Rect2 &p_clamp, real_t p_min, real_t &r_closest_dist_squared, Control **r_closest);\n \tControl *_get_focus_neighbor(Side p_side, int p_count = 0);\n \tbool _is_focus_disabled_recursively() const;\n-\tvoid _apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n-\tvoid _apply_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n+\tvoid _set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n \n \t// Theming.\n \n", "test_patch": "", "problem_statement": "[GUI] Setting a control's recursive mode to disabled does not work on start\n### Tested versions\n\nlatest main branch [2303ce843a362cf5497ca3336451de23793eb711]\n\n### System information\n\nGodot v4.5.dev (2303ce843) - Windows 10 (build 19044) - Multi-window, 4 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4060 Ti (NVIDIA; 32.0.15.7260) - AMD Ryzen 9 5900X 12-Core Processor (24 threads)\n\n### Issue description\n\n#97495 introduces properties for managing children's controls' focus mode and mouse filters. However, this won't work if you set the recursive behavior to `Disable` in the editor.\n\n### Steps to reproduce\n\nhttps://github.com/user-attachments/assets/c498932f-8874-4a14-a693-fe0e09b74443\n\n\n### Minimal reproduction project (MRP)\n\n[MrpRecursiveGuiDisable.zip](https://github.com/user-attachments/files/19391423/MrpRecursiveGuiDisable.zip)\n", "hints_text": "", "created_at": "2025-03-21 14:45:21", "merge_commit_sha": "ba3482926daa6450d21b030cfe029689525c0e51", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104399", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/scene/gui/popup_menu.cpp b/scene/gui/popup_menu.cpp\nindex dadb7e8ceb31..2baaa580c0c8 100644\n--- a/scene/gui/popup_menu.cpp\n+++ b/scene/gui/popup_menu.cpp\n@@ -3036,14 +3036,18 @@ void PopupMenu::popup(const Rect2i &p_bounds) {\n \n \t\tmoved = Vector2();\n \t\tpopup_time_msec = OS::get_singleton()->get_ticks_msec();\n-\t\tif (!is_embedded()) {\n-\t\t\tfloat win_scale = get_parent_visible_window()->get_content_scale_factor();\n-\t\t\tset_content_scale_factor(win_scale);\n-\t\t\tSize2 minsize = get_contents_minimum_size() * win_scale;\n-\t\t\tminsize.height = Math::ceil(minsize.height); // Ensures enough height at fractional content scales to prevent the v_scroll_bar from showing.\n-\t\t\tset_min_size(minsize); // `height` is truncated here by the cast to Size2i for Window.min_size.\n-\t\t\tset_size(Vector2(0, 0)); // Shrinkwraps to min size.\n-\t\t}\n+\n+\t\tSize2 scale = get_parent_viewport()->get_popup_base_transform().get_scale();\n+\t\tCanvasItem *c = Object::cast_to<CanvasItem>(get_parent());\n+\t\tif (c) {\n+\t\t\tscale *= c->get_global_transform_with_canvas().get_scale();\n+\t\t}\n+\t\treal_t popup_scale = MIN(scale.x, scale.y);\n+\t\tset_content_scale_factor(popup_scale);\n+\t\tSize2 minsize = get_contents_minimum_size() * popup_scale;\n+\t\tminsize.height = Math::ceil(minsize.height); // Ensures enough height at fractional content scales to prevent the v_scroll_bar from showing.\n+\t\tset_min_size(minsize); // `height` is truncated here by the cast to Size2i for Window.min_size.\n+\t\tset_size(Vector2(0, 0)); // Shrinkwraps to min size.\n \t\tPopup::popup(p_bounds);\n \t}\n }\ndiff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex 9ecdc25c76d4..f031a72a542b 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -4092,7 +4092,9 @@ bool Tree::edit_selected(bool p_force_edit) {\n \t\treturn false;\n \t}\n \n-\treal_t popup_scale = popup_editor->is_embedded() ? 1.0 : popup_editor->get_parent_visible_window()->get_content_scale_factor();\n+\tSize2 scale = popup_editor->get_parent_viewport()->get_popup_base_transform().get_scale() * get_global_transform_with_canvas().get_scale();\n+\treal_t popup_scale = MIN(scale.x, scale.y);\n+\n \tRect2 rect = _get_item_focus_rect(s);\n \trect.position *= popup_scale;\n \tpopup_edited_item = s;\ndiff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex 56703372ee0e..7eadfea0b79e 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -1562,20 +1562,19 @@ void Viewport::_gui_show_tooltip() {\n \tif (!window) { // Not embedded.\n \t\twindow = gui.tooltip_popup->get_parent_visible_window();\n \t}\n-\tfloat win_scale = window->content_scale_factor;\n+\tSize2 scale = get_popup_base_transform().get_scale();\n+\treal_t popup_scale = MIN(scale.x, scale.y);\n \tPoint2 tooltip_offset = GLOBAL_GET(\"display/mouse_cursor/tooltip_position_offset\");\n-\tif (!gui.tooltip_popup->is_embedded()) {\n-\t\ttooltip_offset *= win_scale;\n-\t}\n+\ttooltip_offset *= popup_scale;\n \tRect2 r(gui.tooltip_pos + tooltip_offset, gui.tooltip_popup->get_contents_minimum_size());\n \tRect2i vr;\n \tif (gui.tooltip_popup->is_embedded()) {\n \t\tvr = gui.tooltip_popup->get_embedder()->get_visible_rect();\n \t} else {\n-\t\tpanel->content_scale_factor = win_scale;\n-\t\tr.size *= win_scale;\n \t\tvr = window->get_usable_parent_rect();\n \t}\n+\tpanel->content_scale_factor = popup_scale;\n+\tr.size *= popup_scale;\n \tr.size = r.size.ceil();\n \tr.size = r.size.min(panel->get_max_size());\n \n", "test_patch": "", "problem_statement": " OptionButton dropdown not properly inheriting scale of parent CanvasLayer in 4.3\n### Tested versions\r\n\r\n- Reproducible in: 4.3.stable\r\n\r\n### System information\r\n\r\nApple - Apple M1 Pro Godot Engine v4.3.stable.official.77dcf97d8 API 4.1 Metal\r\n\r\n### Issue description\r\n\r\nThis is a duplicate of issue #94247 only that I am able to reproduce the same bug in v4.3\r\n\r\n### Steps to reproduce\r\n\r\nIncrease or reduce the scale of the parent Control node, the OptionButton dropdown won't inherit the scale.\r\n\r\n![Screenshot 2024-10-30 at 11 25 03](https://github.com/user-attachments/assets/eaa250cd-11e4-4f72-a0d8-120b75a3a976)\r\n![Screenshot 2024-10-30 at 11 24 43](https://github.com/user-attachments/assets/198c5a15-f48b-496d-968b-3bfd3a69a880)\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[bug-report.zip](https://github.com/user-attachments/files/17575562/bug-report.zip)\n", "hints_text": "Related:\r\n* https://github.com/godotengine/godot/issues/54030\r\n* https://github.com/godotengine/godot/issues/69749", "created_at": "2025-03-20 09:35:47", "merge_commit_sha": "0251fc4476c482a3b25f8e1cf1f32f817158d7ea", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104346", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex 163501dd37c2..41efb74db0bc 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -4764,6 +4764,7 @@ SceneTreeDock::SceneTreeDock(Node *p_scene_root, EditorSelection *p_editor_selec\n \tscene_tree->connect(\"files_dropped\", callable_mp(this, &SceneTreeDock::_files_dropped));\n \tscene_tree->connect(\"script_dropped\", callable_mp(this, &SceneTreeDock::_script_dropped));\n \tscene_tree->connect(\"nodes_dragged\", callable_mp(this, &SceneTreeDock::_nodes_drag_begin));\n+\tscene_tree->get_scene_tree()->get_vscroll_bar()->connect(\"value_changed\", callable_mp(this, &SceneTreeDock::_reset_hovering_timer).unbind(1));\n \n \tscene_tree->get_scene_tree()->connect(SceneStringName(gui_input), callable_mp(this, &SceneTreeDock::_scene_tree_gui_input));\n \tscene_tree->get_scene_tree()->connect(\"item_icon_double_clicked\", callable_mp(this, &SceneTreeDock::_focus_node));\n", "test_patch": "", "problem_statement": "Editor SceneTree inspects nodes while scrolling with drag & drop\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nThere are 2 overlapping actions. If you drag & drop hover over a node in the SceneTree dock, it will inspect the node. Also, if you drag & drop hover near the top / bottom edge of the tree, it will scroll up and down. But currently they conflict, so dragging near the edge will still trigger the \"inspect node\" action, causing stutter during the scroll\n\nRelated to https://github.com/godotengine/godot/pull/103943#issuecomment-2734859037. I have the same fix ready, but just documenting it here\n\n### Steps to reproduce\n\n- Add a bunch of nodes to the scene tree, enough so that there is plenty to scroll.\n- Click and drag a node from the top / bottom, to the other edge to trigger a scroll, and keep cursor in place while it scrolls.\n- After about half a second, some random node in between will be inspected during the scroll.\n\nhttps://github.com/user-attachments/assets/a49f12e1-6362-42b9-a3bc-67354dc54b41\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-03-19 03:04:18", "merge_commit_sha": "5e8c80ab93b73efaf60814da586b22507e8a25ec", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104227", "base_commit": "fde0616a0ea928471436f74b7cf176f9bff56dc7", "patch": "diff --git a/scene/gui/color_picker.cpp b/scene/gui/color_picker.cpp\nindex 426e0092d71b..655988b3d16e 100644\n--- a/scene/gui/color_picker.cpp\n+++ b/scene/gui/color_picker.cpp\n@@ -1138,16 +1138,21 @@ void ColorPicker::add_preset(const Color &p_color) {\n \tList<Color>::Element *e = presets.find(p_color);\n \tif (e) {\n \t\tpresets.move_to_back(e);\n-\t\tpreset_cache.move_to_back(preset_cache.find(p_color));\n \n \t\tpreset_container->move_child(preset_group->get_pressed_button(), preset_container->get_child_count() - 1);\n \t} else {\n \t\tpresets.push_back(p_color);\n-\t\tpreset_cache.push_back(p_color);\n \n \t\t_add_preset_button(_get_preset_size(), p_color);\n \t}\n \n+\tList<Color>::Element *cache_e = preset_cache.find(p_color);\n+\tif (cache_e) {\n+\t\tpreset_cache.move_to_back(cache_e);\n+\t} else {\n+\t\tpreset_cache.push_back(p_color);\n+\t}\n+\n \tif (!palette_name->get_text().is_empty()) {\n \t\tpalette_name->set_text(vformat(\"%s*\", palette_name->get_text().trim_suffix(\"*\")));\n \t\tpalette_name->set_tooltip_text(ETR(\"The changes to this palette have not been saved to a file.\"));\n", "test_patch": "", "problem_statement": "Game crashes when adding color preset after clearing presets in another control\n### Tested versions\n\n- Reproducible in: 4.4 (and previous 4.4.dev builds since saving color palettes was introduced #91604)\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - integrated AMD Radeon 780M Graphics (Advanced Micro Devices, Inc.; 32.0.11039.8001) - AMD Ryzen 7 8845HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\nIf you have multiple `ColorPickers` in the scene and one `ColorPicker` uses saved color palette and it was cleared, trying to add color preset in another `ColorPicker`, if that color was added to the presets before, it would crash the game.\n\nhttps://github.com/user-attachments/assets/1e5da6c7-255e-4d99-9793-721f06493741\n\n### Steps to reproduce\n\n1. Add 2 or more `ColorPicker`s to the scene\n2. Assign different colors to each `ColorPicker`\n3. Run the game\n4. Open Swatches in each `ColorPicker` and add current color to presets\n5. Save presets of one `ColorPicker` as color palette (you will see another issue mentioned in #104223)\n6. Clear presets in the `ColorPicker` that you saved the palette in\n7. In another `ColorPicker`  press the button to add current color to presets without chaning the color before (it should be the same color, as was added to presets for this `ColorPicker` before\n8. The game should crash\n\n### Minimal reproduction project (MRP)\n\n[regression-test-project.zip](https://github.com/user-attachments/files/19270277/regression-test-project.zip)\n", "hints_text": "", "created_at": "2025-03-16 09:40:51", "merge_commit_sha": "380584527b5ab456798ab7fcc23cc7d717fea97d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104208", "base_commit": "0028fd625e2c5b202e204bc12828cbca043213d3", "patch": "diff --git a/platform/windows/SCsub b/platform/windows/SCsub\nindex 1ddefb9c331f..284b43d55de7 100644\n--- a/platform/windows/SCsub\n+++ b/platform/windows/SCsub\n@@ -124,7 +124,7 @@ if env[\"d3d12\"]:\n             Copy(\"$TARGET\", \"$SOURCE\"),\n         )\n \n-if not os.getenv(\"VCINSTALLDIR\"):\n+if not env.msvc:\n     if env[\"debug_symbols\"]:\n         env.AddPostAction(prog, env.Run(platform_windows_builders.make_debug_mingw))\n         if env[\"windows_subsystem\"] == \"gui\":\n", "test_patch": "", "problem_statement": "[Buildsystem] Builds fail with MSVC with separate build symbols\n### Tested versions\n\n- Reproducible in master [0028fd625e2c5b202e204bc12828cbca043213d3]\n- Not reproducible in master [b5bdb88062a31a982c8f3bf4b820188edd53c6c5]\n- Bisected down to #103864 [45053520216b70d5669587b55e6b3d98df201c3d]\n\n### System information\n\nGodot v4.4.stable - Windows 10.0.26100 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2080 (NVIDIA; 32.0.15.7247) - AMD Ryzen 7 3800XT 8-Core Processor (16 Threads)\n\n### Issue description\n\nWhen attempting to build Godot, I'm getting the following error when generating the executable:\n```\nStarting build...\ncmd /c chcp 65001>nul && scons dev_build=yes separate_debug_symbols=yes tests=yes compiledb=yes d3d12=yes\nscons: Reading SConscript files ...\nAutomatically detected platform: windows\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\nBuilding for platform \"windows\", architecture \"x86_64\", target \"editor\".\nINFO: Developer build, with debug optimization level and debug symbols (unless overridden).\nChecking for C header file mntent.h... (cached) no\nscons: done reading SConscript files.\nscons: Building targets ...\nLinking Program bin\\godot.windows.editor.dev.x86_64.exe ...\nGenerating compile_commands.json ...\nGenerating bin\\godot.windows.editor.dev.x86_64.exe ...\nscons: *** [bin\\godot.windows.editor.dev.x86_64.exe] KeyError : 'OBJCOPY'\nTraceback (most recent call last):\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 2677, in __getitem__\n    return self.__dict__['overrides'][key]\nKeyError: 'OBJCOPY'\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Action.py\", line 1434, in execute\n    result = self.execfunction(target=target, source=rsources, env=env)\n  File \"C:\\Users\\kilau\\Development\\godot_dev\\godot4\\platform\\windows\\platform_windows_builders.py\", line 10, in make_debug_mingw\n    os.system(\"{0} --only-keep-debug {1} {1}.debugsymbols\".format(env[\"OBJCOPY\"], dst))\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 2681, in __getitem__\n    return self.__dict__['__subject'].__getitem__(key)\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 603, in __getitem__\n    return self._dict[key]\nKeyError: 'OBJCOPY'\nscons: building terminated because of errors.\nINFO: Time elapsed: 00:00:20.14 \n```\n\n### Steps to reproduce\n\nRun `scons dev_build=yes separate_debug_symbols=yes tests=yes compiledb=yes` on a system with MSVC.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Ran a bisect and narrowed down the regression to #103864 \nThis issue can be worked around by running SCons within the `x64 Native Tools Command Prompt for VS 2022` console.\n\nFor VSCode, this can be setup by adding to your `tasks.json` file:\n``` json\n\"windows\": {\n        \"options\": {\n            \"shell\": {\n                \"executable\": \"cmd.exe\",\n                \"args\": [\n                    \"/C\",\n                    \"\\\"C:\\\\Program Files\\\\Microsoft Visual Studio\\\\2022\\\\Community\\\\VC\\\\Auxiliary\\\\Build\\\\vcvars64.bat\\\"\",\n                    \"&&\"\n                ]\n            }\n        }\n    }\n```\n\nThen, change any build actions to type `shell`.\n\nProcess is documented here: https://code.visualstudio.com/docs/cpp/config-msvc#_run-vs-code-outside-the-developer-command-prompt", "created_at": "2025-03-15 23:17:51", "merge_commit_sha": "2dc6da6336c3c38871730d1eded5190ebbfa51c4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104181", "base_commit": "0028fd625e2c5b202e204bc12828cbca043213d3", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 46d787762d31..8ad90dd0a2e4 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -3152,13 +3152,14 @@ void EditorInspector::update_tree() {\n \tColor sscolor = get_theme_color(SNAME(\"prop_subsection\"), EditorStringName(Editor));\n \tbool sub_inspectors_enabled = EDITOR_GET(\"interface/inspector/open_resources_in_current_inspector\");\n \n-\t// Get the lists of editors to add the beginning.\n-\tfor (Ref<EditorInspectorPlugin> &ped : valid_plugins) {\n-\t\tped->parse_begin(object);\n-\t\t_parse_added_editors(begin_vbox, nullptr, ped);\n-\t}\n-\tif (begin_vbox->get_child_count()) {\n+\tif (!valid_plugins.is_empty()) {\n \t\tbegin_vbox->show();\n+\n+\t\t// Get the lists of editors to add the beginning.\n+\t\tfor (Ref<EditorInspectorPlugin> &ped : valid_plugins) {\n+\t\t\tped->parse_begin(object);\n+\t\t\t_parse_added_editors(begin_vbox, nullptr, ped);\n+\t\t}\n \t}\n \n \tStringName doc_name;\n", "test_patch": "", "problem_statement": "C# inspector warning grows after second change\n### Tested versions\n\n4.4\n\n### System information\n\nW10\n\n### Issue description\n\nWhen you modify a C# script while its node is inspected, you will get `This inspector might be out of date.` warning. If you change the script again, the warning panel grows.\n\nhttps://github.com/user-attachments/assets/a0d47023-2440-46d3-aab7-0806f1ee1559\n\nFurther changes don't make it bigger.\n\n### Steps to reproduce\n\n1. Attach a C# script to a node\n2. Open the script, modify and save it\n3. The inspector should show a warning\n4. Repeat\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "I'm able to reproduce in `4.4-stable` but not in `4.3-stable`. The code for this Control ([InspectorOutOfSyncWarning.cs](https://github.com/godotengine/godot/blob/49cc57a75dfd262bd49698910595becf3aae597b/modules/mono/editor/GodotTools/GodotTools/Inspector/InspectorOutOfSyncWarning.cs)) hasn't changed at all between those 2 versions. Maybe something changed in [editor_inspector.cpp](https://github.com/godotengine/godot/blob/49cc57a75dfd262bd49698910595becf3aae597b/editor/editor_inspector.cpp)?\n\nI've bisected it to d678b095f9998a9a6fb785de3e712ec7605726a4.\nCC @YeldhamDev \nCould you be more descriptive? I'm unable to reproduce this on my end.\nOpen the script in the Godot's script editor and use File -> Save option after modifying the script in any way.\nIn my video the inspector changes after I save the script (with script editor's save option, not save scene).\nI'm sorry, but still nothing:\n\nhttps://github.com/user-attachments/assets/3cfcdad3-7d3a-4f65-8cf4-b0c7c9ad0274\nTry building the project to get rid of the text, and then modify/save the script multiple times. It might not happen on the first try.\nI was just able to reproduce it in a fresh project with all default settings. Although I only tested 4.4 stable, not master.\nAlright, _now_ it happened on my end. Will investigate the cause.\nThis is so odd. From what I'm testing here, it seems that the problem is in the warning's `Label` itself. If for example, I enable `clip_text` and set a custom minimum height, it doesn't happen anymore...", "created_at": "2025-03-15 15:27:02", "merge_commit_sha": "00720d435148478f3ac4ecc0400873b3b7c77527", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104169", "base_commit": "0028fd625e2c5b202e204bc12828cbca043213d3", "patch": "diff --git a/editor/code_editor.cpp b/editor/code_editor.cpp\nindex bc678b5ba1be..1b77ae749e40 100644\n--- a/editor/code_editor.cpp\n+++ b/editor/code_editor.cpp\n@@ -1668,9 +1668,9 @@ void CodeTextEditor::set_error_count(int p_error_count) {\n \terror_button->set_text(itos(p_error_count));\n \terror_button->set_visible(p_error_count > 0);\n \tif (p_error_count > 0) {\n-\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time_with_errors); // Parsing should happen sooner.\n \t} else {\n+\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time);\n \t}\n }\n", "test_patch": "", "problem_statement": "Script Editor - Error Panel stays open after error fixed\n### Tested versions\n\n4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1650 (NVIDIA; 32.0.15.7260) - AMD Ryzen 3 3100 4-Core Processor (8 threads)\n\n### Issue description\n\nScript Editor - Error Panel stays open after error fixed\nin order to close the panel, need to cause an error to have the expand collapse button, this fresh first error after fix also collapses the panel.\n\n### Steps to reproduce\n\ncreate a script.\nmake an error,\nexpand the error panel\nfix the error in script\n> now you have the panel open with no errors but also no way to hide this Error Panel\n\n### Minimal reproduction project (MRP)\n\nAny simple project would do.\n", "hints_text": "It seems like the behaviour is whenever the number of errors changes, the panel is closed, unless the number of errors changes to 0. The logic for deciding if the error button is shown is in `CodeTextEditor::set_error_count`, which hides the error panel if `p_error_count > 0`, and doesn't change the error panel's visibility otherwise. \n\nhttps://github.com/godotengine/godot/blob/0028fd625e2c5b202e204bc12828cbca043213d3/editor/code_editor.cpp#L1667-L1676\n\nThis seems like the opposite of what you might expect, where you want to hide the error panel if there are no errors left, but leave it in its current state otherwise. This expected behaviour is actually how the warning panel behaves.\n\nhttps://github.com/godotengine/godot/blob/0028fd625e2c5b202e204bc12828cbca043213d3/editor/code_editor.cpp#L1678-L1684\n\nThe change in behaviour seems to have been introduced in https://github.com/godotengine/godot/commit/02cc187 where the call to `_set_show_errors_panel` was put in the wrong place", "created_at": "2025-03-15 09:11:45", "merge_commit_sha": "a26c05d7e5831e27b28f6135ec04f664ac4e105d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104154", "base_commit": "28102e6682c7c733a23de461e30d5ae2d33fe755", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex 441ba3141ef4..032d367bc18b 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -2517,24 +2517,38 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \tOS::get_singleton()->_allow_layered = GLOBAL_DEF_RST(\"display/window/per_pixel_transparency/allowed\", false);\n \n #ifdef TOOLS_ENABLED\n-\tif (editor || project_manager) {\n-\t\t// The editor and project manager always detect and use hiDPI if needed.\n-\t\tOS::get_singleton()->_allow_hidpi = true;\n-\t\t// Disable Vulkan overlays in editor, they cause various issues.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_MANGOHUD\", \"1\"); // GH-57403.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_RTSS_LAYER\", \"1\"); // GH-57937.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VKBASALT\", \"1\");\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_reshade_1\", \"1\"); // GH-70849.\n-\t\tOS::get_singleton()->set_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\", \"1\"); // GH-101480.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\", \"1\"); // GH-101480.\n-\t} else {\n-\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_MANGOHUD\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_RTSS_LAYER\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VKBASALT\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_reshade_1\");\n-\t\tOS::get_singleton()->unset_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\");\n+\t{\n+\t\t// Synced with https://github.com/baldurk/renderdoc/blob/2b01465c7/renderdoc/driver/vulkan/vk_layer.cpp#L118-L165\n+\t\tLocalVector<String> layers_to_disable = {\n+\t\t\t\"DISABLE_RTSS_LAYER\", // GH-57937.\n+\t\t\t\"DISABLE_VULKAN_OBS_CAPTURE\", // GH-103800.\n+\t\t\t\"DISABLE_VULKAN_OW_OBS_CAPTURE\", // GH-104154.\n+\t\t\t\"DISABLE_SAMPLE_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_GAMEPP_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_VK_LAYER_TENCENT_wegame_cross_overlay_1\", // GH-104154.\n+\t\t\t\"NODEVICE_SELECT\", // GH-104154.\n+\t\t\t\"VK_LAYER_bandicam_helper_DEBUG_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_bandicam_helper_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_reshade_1\", // GH-70849.\n+\t\t\t\"DISABLE_VK_LAYER_GPUOpen_GRS\", // GH-104154.\n+\t\t\t\"DISABLE_LAYER\", // GH-104154 (fpsmon).\n+\t\t\t\"DISABLE_MANGOHUD\", // GH-57403.\n+\t\t\t\"DISABLE_VKBASALT\",\n+\t\t};\n+\n+\t\tif (editor || project_manager) {\n+\t\t\t// The editor and project manager always detect and use hiDPI if needed.\n+\t\t\tOS::get_singleton()->_allow_hidpi = true;\n+\t\t\t// Disable Vulkan overlays in editor, they cause various issues.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->set_environment(layer_disable, \"1\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->unset_environment(layer_disable);\n+\t\t\t}\n+\t\t}\n \t}\n #endif\n \n", "test_patch": "", "problem_statement": "Godot 4.4 silently closes when using OBS advanced scene switcher (detects active window). GameCapture Mode\n### Tested versions\n\n4.4 issue\n4.3 works fine\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2070 (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (16 threads)\n\n### Issue description\n\n4.4 Godot Crashes when tabbing into other windows using OBS Scene Switcher Plugin(which detects the current window and changes scene)\n\nI will temporarily go back to 4.3 which does not do this.\n\n I'm not sure what options in the editor have changed or if there are some options I can tick to help with this. I've tried many different options. I know the detection of windows isn't youre problem, but why did it work flawlessly in 4.3?\n\nIt only happens if im using GameCapture for Godot 4.4. I just dont want to stream my whole display monitor. I use the advanced scene switcher plugin to make devlogs. Switching scenes between my notes, editor, ect.\n\n\nNo errors. Just my Godot disappears and closes when I tab into other windows. It works fine if Godot isn't Game Capture. \n\nDid anything change in 4.4 for window detection and compatibility with OBS? Ive even tried setting godot 4.4 to single window mode.\n\n### Steps to reproduce\n\nOpen Godot 4.4,\n\nHave scene setup in game capture mode for Godot 4.4.\n\nUse Window Detection with another application ( OBS Automatic Scene Switcher)\n\nScenes automatically switch based on the active window.\n\nGodot crashes when tabbing into other windows.\n\nOpen Godot 4.3\n\nRepeat steps.\n\nGodot does not close/crash\n\n\n### Minimal reproduction project (MRP)\n\nHappens with any 4.4 project. Even brand new ones.\n\nUnable to replicate in 4.3\n", "hints_text": "To clarify. It closes godot when I tab out of godot and then back into Godot. No errors or crash.\n\nOnly thing in the project file is a vulkan cache, no crash logs or anythin.\nConfirmed issue is something with Forward+ mode in 4.4 and windows based window detection.\n\nGodot does not seem to crash using these method on Compatibility mode. YAY!! I can work now!\nCould you test the versions between 4.3 stable and 4.4 stable to find when this problem started? You can download them here: https://godotengine.org/download/archive/ \nFrom further testing, my previous comments about 4.3 working was only due to compatibility render mode. If I use forward+ it still happens in 4.3 stable. Let me try to use a different computer perhaps and do further testing. It will be a few days before I can setup my other computer. Please leave this open if you deem necessary. \nCan you reproduce this after switching back to Forward+/Mobile, then changing `rendering_driver.windows` to `d3d12` in the Project Settings and restarting the editor?\n\nThis is almost certainly caused by a negative interaction between the OBS Vulkan layer and Godot. This layer should probably be blocked from Godot to avoid crashes, but it's not listed here:\n\nhttps://github.com/godotengine/godot/blob/30bb49ec1ff3b3fc463074b8d28bc97d4db50b9f/main/main.cpp#L2515-L2535\nThank you. Confirming in 4.3 and 4.4 stables that switching to d3d12 forward+ allows my OBS scene switching plugin to flawlessly detect the windows. The vulkan seems to be culprit.\n\nWith vulkan = crash when switching windows\nwith d3d12 = perfect\nTo clarify, when in vulkan forward plus. I can tab into Godot fine, but as soon as I tab out, it closes. \n\nIf this is a problem related to the plugin of obs, fair enough. THe plugin that detects windows is\n\nhttps://obsproject.com/forum/resources/advanced-scene-switcher.395/\n\nspecifically the Automatic Scene Switcher tool\nYou linked `Advanced Scene Switcher`. OBS has `Automatic Scene Switcher` built in. I assume this is about the one you linked?\nI can replicate this without any scene switchers. Only affects OBS's `Game Capture` source and Vulkan drivers in Godot. Nothing in the verbose logs. Doesn't even require switching scenes. Hiding and unhiding the source a few times does the trick too.\n\n```\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6094) - 12th Gen Intel(R) Core(TM) i5-12400F (12 threads)\n```\n\nhttps://github.com/user-attachments/assets/d37412ff-da98-4b98-bb99-b4e364924775", "created_at": "2025-03-14 21:37:47", "merge_commit_sha": "14c3ef9a6cbe4971df97a037b9d3fcb7553f7307", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104090", "base_commit": "701505eb4ff698434cba540381dbccdd48de8bb0", "patch": "diff --git a/servers/audio/effects/audio_effect_pitch_shift.cpp b/servers/audio/effects/audio_effect_pitch_shift.cpp\nindex 89273d744b8a..1fba20983c03 100644\n--- a/servers/audio/effects/audio_effect_pitch_shift.cpp\n+++ b/servers/audio/effects/audio_effect_pitch_shift.cpp\n@@ -288,6 +288,9 @@ void SMBPitchShift::smbFft(float *fftBuffer, long fftFrameSize, long sign)\n void AudioEffectPitchShiftInstance::process(const AudioFrame *p_src_frames, AudioFrame *p_dst_frames, int p_frame_count) {\n \t// Avoid distortion by skipping processing if pitch_scale is 1.0.\n \tif (Math::is_equal_approx(base->pitch_scale, 1.0f)) {\n+\t\tfor (int i = 0; i < p_frame_count; i++) {\n+\t\t\tp_dst_frames[i] = p_src_frames[i];\n+\t\t}\n \t\treturn;\n \t}\n \n", "test_patch": "", "problem_statement": "AudioEffectPitchShift cancels out other AudioEffects\n### Tested versions\n\nIssue is found in Godot 4.4\nTested in Godot 4.3 and bug cannot be reproduced\n\n\n\n\n\n\n\n\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7435HS (16 threads)\n\n### Issue description\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nwhen using pitch shift effect in any bus channel, if any other effects are added then pitch shift cancels out the other effects. If they are on the same bus then there is no audio. If effects are separate i.e pitch shift on master bus and other effects on other buses then audio is heard but other effects are cancelled out and their \"effect\" is not heard.\n\n\n\n\n### Steps to reproduce\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nUsing AudioEffectPitchShift on the master bus - works ok\nAdd another effect to the master bus - no audio when play()\nUncheck AudioEffectPitchShift in master bus - audio ok when play()\n\nCreate bus channel, route AudioStreamPlayer2D to new bus,\nmove other effect to new master bus, \nAudioEffectPitchShift remains in master bus - audio is now heard but other effects are cancelled out by AudioEffectPitchShift\nUncheck AudioEffectPitchShift in master bus - new bus effects work again\n\n### Minimal reproduction project (MRP)\n\n[EffectBug.zip](https://github.com/user-attachments/files/19212952/EffectBug.zip)\nAudioEffectPitchShift cancels out other AudioEffects\n### Tested versions\n\nIssue is found in Godot 4.4\nTested in Godot 4.3 and bug cannot be reproduced\n\n\n\n\n\n\n\n\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7435HS (16 threads)\n\n### Issue description\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nwhen using pitch shift effect in any bus channel, if any other effects are added then pitch shift cancels out the other effects. If they are on the same bus then there is no audio. If effects are separate i.e pitch shift on master bus and other effects on other buses then audio is heard but other effects are cancelled out and their \"effect\" is not heard.\n\n\n\n\n### Steps to reproduce\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nUsing AudioEffectPitchShift on the master bus - works ok\nAdd another effect to the master bus - no audio when play()\nUncheck AudioEffectPitchShift in master bus - audio ok when play()\n\nCreate bus channel, route AudioStreamPlayer2D to new bus,\nmove other effect to new master bus, \nAudioEffectPitchShift remains in master bus - audio is now heard but other effects are cancelled out by AudioEffectPitchShift\nUncheck AudioEffectPitchShift in master bus - new bus effects work again\n\n### Minimal reproduction project (MRP)\n\n[EffectBug.zip](https://github.com/user-attachments/files/19212952/EffectBug.zip)\n", "hints_text": "\n", "created_at": "2025-03-13 22:10:59", "merge_commit_sha": "7e4f6bdb59ef4728b280cb74637e89e528e097f3", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104083", "base_commit": "701505eb4ff698434cba540381dbccdd48de8bb0", "patch": "diff --git a/doc/classes/Node.xml b/doc/classes/Node.xml\nindex 15852097fb5b..fd0a2594c293 100644\n--- a/doc/classes/Node.xml\n+++ b/doc/classes/Node.xml\n@@ -1226,6 +1226,9 @@\n \t\t<constant name=\"NOTIFICATION_VP_MOUSE_EXIT\" value=\"1011\">\n \t\t\tNotification received when the mouse cursor leaves the [Viewport]'s visible area, that is not occluded behind other [Control]s or [Window]s, provided its [member Viewport.gui_disable_input] is [code]false[/code] and regardless if it's currently focused or not.\n \t\t</constant>\n+\t\t<constant name=\"NOTIFICATION_WM_POSITION_CHANGED\" value=\"1012\">\n+\t\t\tNotification received when the window is moved.\n+\t\t</constant>\n \t\t<constant name=\"NOTIFICATION_OS_MEMORY_WARNING\" value=\"2009\">\n \t\t\tNotification received from the OS when the application is exceeding its allocated memory.\n \t\t\tImplemented only on iOS.\ndiff --git a/scene/main/node.cpp b/scene/main/node.cpp\nindex 0978aa9ddfb9..ed0add6f43cd 100644\n--- a/scene/main/node.cpp\n+++ b/scene/main/node.cpp\n@@ -3811,6 +3811,7 @@ void Node::_bind_methods() {\n \tBIND_CONSTANT(NOTIFICATION_WM_DPI_CHANGE);\n \tBIND_CONSTANT(NOTIFICATION_VP_MOUSE_ENTER);\n \tBIND_CONSTANT(NOTIFICATION_VP_MOUSE_EXIT);\n+\tBIND_CONSTANT(NOTIFICATION_WM_POSITION_CHANGED);\n \tBIND_CONSTANT(NOTIFICATION_OS_MEMORY_WARNING);\n \tBIND_CONSTANT(NOTIFICATION_TRANSLATION_CHANGED);\n \tBIND_CONSTANT(NOTIFICATION_WM_ABOUT);\n", "test_patch": "", "problem_statement": "`NOTIFICATION_WM_POSITION_CHANGED` is not exposed in GDExtension\n### Tested versions\n\n4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i7-6700K CPU @ 4.00GHz (8 threads)\n\n### Issue description\n\nOriginally reported here https://github.com/godotengine/godot-cpp/issues/1732\n\nThen I realized it better fits here.\nBasically, `extension_api.json` generated by Godot does not expose `NOTIFICATION_WM_POSITION_CHANGED`. Thus, it is not available in godot-cpp.\n\n### Steps to reproduce\n\nCall `godot --dump-extension-api` to generate api file. Observe that `NOTIFICATION_WM_POSITION_CHANGED` is not present.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "This is not exposed at all, it was introduced in:\n* https://github.com/godotengine/godot/pull/99010\n\nBut not exposed\n\nCC @Hilderin \nCan you describe what's your use case for `NOTIFICATION_WM_POSITION_CHANGED`?\nI have a window manager that preserves window positions upon restart. Simple as that.\nWithout this callback you can't reliably save the last position.\n\nAnyway, the callback is not the problem. Because this notification does propagate into my nodes. But there is no `NOTIFICATION_WM_POSITION_CHANGED` define, that I can use to compare to `what` in the `_notification()`. Currently I define it myself in a header `inline static constexpr int NOTIFICATION_WM_POSITION_CHANGED = 1012;`\nAgain, to make it clear, what is actually missing is the actual define in node.hpp.\nThe thing that is missing is a `BIND_ENUM_CONSTANT(NOTIFICATION_WM_POSITION_CHANGED)` if this is indeed required\nYes, this. I fail to understand why it wouldn't be required if it comes to a user, user should be able to match this notification to some value.", "created_at": "2025-03-13 20:13:27", "merge_commit_sha": "08e41090bcecf10dfeea4f42471a2116d8e67b53", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104019", "base_commit": "30b0aadab65fcafb9a160dba2c9abfd005bb62a5", "patch": "diff --git a/.github/actions/godot-cpp-build/action.yml b/.github/actions/godot-cpp-build/action.yml\nindex 7667527246ed..1046f09470e9 100644\n--- a/.github/actions/godot-cpp-build/action.yml\n+++ b/.github/actions/godot-cpp-build/action.yml\n@@ -1,9 +1,6 @@\n name: Build godot-cpp\n description: Build godot-cpp with the provided options.\n \n-env:\n-  GODOT_CPP_BRANCH: 4.4\n-\n inputs:\n   bin:\n     description: Path to the Godot binary.\n@@ -16,6 +13,10 @@ inputs:\n     description: The SCons cache path.\n     default: ${{ github.workspace }}/.scons_cache/\n     type: string\n+  godot-cpp-branch:\n+    description: The godot-cpp branch.\n+    default: master\n+    type: string\n \n runs:\n   using: composite\n@@ -25,7 +26,7 @@ runs:\n       with:\n         submodules: recursive\n         repository: godotengine/godot-cpp\n-        ref: ${{ env.GODOT_CPP_BRANCH }}\n+        ref: ${{ inputs.godot-cpp-branch }}\n         path: godot-cpp\n \n     - name: Extract API\ndiff --git a/.github/workflows/android_builds.yml b/.github/workflows/android_builds.yml\nindex f1c721fb6382..865f826bc0f3 100644\n--- a/.github/workflows/android_builds.yml\n+++ b/.github/workflows/android_builds.yml\n@@ -62,8 +62,8 @@ jobs:\n       - name: Download pre-built Android Swappy Frame Pacing Library\n         uses: dsaltares/fetch-gh-release-asset@1.1.2\n         with:\n-          repo: darksylinc/godot-swappy\n-          version: tags/v2023.3.0.0\n+          repo: godotengine/godot-swappy\n+          version: tags/from-source-2025-01-31\n           file: godot-swappy.7z\n           target: swappy/godot-swappy.7z\n \ndiff --git a/.github/workflows/linux_builds.yml b/.github/workflows/linux_builds.yml\nindex 44aefc77a73b..1cb9637cee50 100644\n--- a/.github/workflows/linux_builds.yml\n+++ b/.github/workflows/linux_builds.yml\n@@ -6,6 +6,7 @@ on:\n env:\n   # Used for the cache key. Add version suffix to force clean build.\n   GODOT_BASE_BRANCH: 4.4\n+  GODOT_CPP_BRANCH: 4.4\n   SCONSFLAGS: verbose=yes warnings=extra werror=yes module_text_server_fb_enabled=yes strict_checks=yes\n   DOTNET_NOLOGO: true\n   DOTNET_CLI_TELEMETRY_OPTOUT: true\n@@ -174,6 +175,7 @@ jobs:\n         with:\n           bin: ${{ matrix.bin }}\n           scons-flags: target=template_debug dev_build=yes verbose=yes\n+          godot-cpp-branch: ${{ env.GODOT_CPP_BRANCH }}\n \n       - name: Save Godot build cache\n         uses: ./.github/actions/godot-cache-save\ndiff --git a/.gitignore b/.gitignore\nindex 2c3bf742ba2e..8adc7b786c63 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -263,6 +263,11 @@ bld/\n !thirdparty/**/arm/\n !thirdparty/**/arm64/\n \n+thirdparty/swappy-frame-pacing/arm64-v8a/abi.json\n+thirdparty/swappy-frame-pacing/armeabi-v7a/abi.json\n+thirdparty/swappy-frame-pacing/x86/abi.json\n+thirdparty/swappy-frame-pacing/x86_64/abi.json\n+\n # Visual Studio 2015/2017 cache/options directory\n .vs/\n \ndiff --git a/core/object/worker_thread_pool.cpp b/core/object/worker_thread_pool.cpp\nindex 08903d61964d..d9ff30576794 100644\n--- a/core/object/worker_thread_pool.cpp\n+++ b/core/object/worker_thread_pool.cpp\n@@ -37,6 +37,8 @@\n \n WorkerThreadPool::Task *const WorkerThreadPool::ThreadData::YIELDING = (Task *)1;\n \n+HashMap<StringName, WorkerThreadPool *> WorkerThreadPool::named_pools;\n+\n void WorkerThreadPool::Task::free_template_userdata() {\n \tERR_FAIL_NULL(template_userdata);\n \tERR_FAIL_NULL(native_func_userdata);\n@@ -184,25 +186,25 @@ void WorkerThreadPool::_thread_function(void *p_user) {\n \twhile (true) {\n \t\tTask *task_to_process = nullptr;\n \t\t{\n-\t\t\tMutexLock lock(singleton->task_mutex);\n+\t\t\tMutexLock lock(thread_data->pool->task_mutex);\n \n-\t\t\tbool exit = singleton->_handle_runlevel(thread_data, lock);\n+\t\t\tbool exit = thread_data->pool->_handle_runlevel(thread_data, lock);\n \t\t\tif (unlikely(exit)) {\n \t\t\t\tbreak;\n \t\t\t}\n \n \t\t\tthread_data->signaled = false;\n \n-\t\t\tif (singleton->task_queue.first()) {\n-\t\t\t\ttask_to_process = singleton->task_queue.first()->self();\n-\t\t\t\tsingleton->task_queue.remove(singleton->task_queue.first());\n+\t\t\tif (thread_data->pool->task_queue.first()) {\n+\t\t\t\ttask_to_process = thread_data->pool->task_queue.first()->self();\n+\t\t\t\tthread_data->pool->task_queue.remove(thread_data->pool->task_queue.first());\n \t\t\t} else {\n \t\t\t\tthread_data->cond_var.wait(lock);\n \t\t\t}\n \t\t}\n \n \t\tif (task_to_process) {\n-\t\t\tsingleton->_process_task(task_to_process);\n+\t\t\tthread_data->pool->_process_task(task_to_process);\n \t\t}\n \t}\n }\n@@ -497,7 +499,7 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (singleton->task_queue.first()) {\n+\t\t\tif (p_caller_pool_thread->pool->task_queue.first()) {\n \t\t\t\ttask_to_process = task_queue.first()->self();\n \t\t\t\ttask_queue.remove(task_queue.first());\n \t\t\t}\n@@ -505,7 +507,9 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\tif (!task_to_process) {\n \t\t\t\tp_caller_pool_thread->awaited_task = p_task;\n \n-\t\t\t\t_unlock_unlockable_mutexes();\n+\t\t\t\tif (this == singleton) {\n+\t\t\t\t\t_unlock_unlockable_mutexes();\n+\t\t\t\t}\n \t\t\t\trelock_unlockables = true;\n \n \t\t\t\tp_caller_pool_thread->cond_var.wait(lock);\n@@ -514,7 +518,7 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\t}\n \t\t}\n \n-\t\tif (relock_unlockables) {\n+\t\tif (relock_unlockables && this == singleton) {\n \t\t\t_lock_unlockable_mutexes();\n \t\t}\n \n@@ -690,9 +694,13 @@ void WorkerThreadPool::wait_for_group_task_completion(GroupID p_group) {\n \t{\n \t\tGroup *group = *groupp;\n \n-\t\t_unlock_unlockable_mutexes();\n+\t\tif (this == singleton) {\n+\t\t\t_unlock_unlockable_mutexes();\n+\t\t}\n \t\tgroup->done_semaphore.wait();\n-\t\t_lock_unlockable_mutexes();\n+\t\tif (this == singleton) {\n+\t\t\t_lock_unlockable_mutexes();\n+\t\t}\n \n \t\tuint32_t max_users = group->tasks_used + 1; // Add 1 because the thread waiting for it is also user. Read before to avoid another thread freeing task after increment.\n \t\tuint32_t finished_users = group->finished.increment(); // fetch happens before inc, so increment later.\n@@ -709,15 +717,15 @@ void WorkerThreadPool::wait_for_group_task_completion(GroupID p_group) {\n #endif\n }\n \n-int WorkerThreadPool::get_thread_index() {\n+int WorkerThreadPool::get_thread_index() const {\n \tThread::ID tid = Thread::get_caller_id();\n-\treturn singleton->thread_ids.has(tid) ? singleton->thread_ids[tid] : -1;\n+\treturn thread_ids.has(tid) ? thread_ids[tid] : -1;\n }\n \n-WorkerThreadPool::TaskID WorkerThreadPool::get_caller_task_id() {\n+WorkerThreadPool::TaskID WorkerThreadPool::get_caller_task_id() const {\n \tint th_index = get_thread_index();\n-\tif (th_index != -1 && singleton->threads[th_index].current_task) {\n-\t\treturn singleton->threads[th_index].current_task->self;\n+\tif (th_index != -1 && threads[th_index].current_task) {\n+\t\treturn threads[th_index].current_task->self;\n \t} else {\n \t\treturn INVALID_TASK_ID;\n \t}\n@@ -766,6 +774,7 @@ void WorkerThreadPool::init(int p_thread_count, float p_low_priority_task_ratio)\n \n \tfor (uint32_t i = 0; i < threads.size(); i++) {\n \t\tthreads[i].index = i;\n+\t\tthreads[i].pool = this;\n \t\tthreads[i].thread.start(&WorkerThreadPool::_thread_function, &threads[i]);\n \t\tthread_ids.insert(threads[i].thread.get_id(), i);\n \t}\n@@ -832,10 +841,33 @@ void WorkerThreadPool::_bind_methods() {\n \tClassDB::bind_method(D_METHOD(\"wait_for_group_task_completion\", \"group_id\"), &WorkerThreadPool::wait_for_group_task_completion);\n }\n \n-WorkerThreadPool::WorkerThreadPool() {\n-\tsingleton = this;\n+WorkerThreadPool *WorkerThreadPool::get_named_pool(const StringName &p_name) {\n+\tWorkerThreadPool **pool_ptr = named_pools.getptr(p_name);\n+\tif (pool_ptr) {\n+\t\treturn *pool_ptr;\n+\t} else {\n+\t\tWorkerThreadPool *pool = memnew(WorkerThreadPool(false));\n+\t\tpool->init();\n+\t\tnamed_pools[p_name] = pool;\n+\t\treturn pool;\n+\t}\n+}\n+\n+WorkerThreadPool::WorkerThreadPool(bool p_singleton) {\n+\tif (p_singleton) {\n+\t\tsingleton = this;\n+\t}\n }\n \n WorkerThreadPool::~WorkerThreadPool() {\n \tfinish();\n+\n+\tif (this == singleton) {\n+\t\tsingleton = nullptr;\n+\t\tfor (KeyValue<StringName, WorkerThreadPool *> &E : named_pools) {\n+\t\t\tE.value->finish();\n+\t\t\tmemdelete(E.value);\n+\t\t}\n+\t\tnamed_pools.clear();\n+\t}\n }\ndiff --git a/core/object/worker_thread_pool.h b/core/object/worker_thread_pool.h\nindex 58e86e3e48eb..76332ec8a3d3 100644\n--- a/core/object/worker_thread_pool.h\n+++ b/core/object/worker_thread_pool.h\n@@ -119,6 +119,7 @@ class WorkerThreadPool : public Object {\n \t\tTask *current_task = nullptr;\n \t\tTask *awaited_task = nullptr; // Null if not awaiting the condition variable, or special value (YIELDING).\n \t\tConditionVariable cond_var;\n+\t\tWorkerThreadPool *pool = nullptr;\n \n \t\tThreadData() :\n \t\t\t\tsignaled(false),\n@@ -166,6 +167,8 @@ class WorkerThreadPool : public Object {\n \n \tuint64_t last_task = 1;\n \n+\tstatic HashMap<StringName, WorkerThreadPool *> named_pools;\n+\n \tstatic void _thread_function(void *p_user);\n \n \tvoid _process_task(Task *task);\n@@ -266,9 +269,12 @@ class WorkerThreadPool : public Object {\n #endif\n \t}\n \n+\t// Note: Do not use this unless you know what you are doing, and it is absolutely necessary. Main thread pool (`get_singleton()`) should be preferred instead.\n+\tstatic WorkerThreadPool *get_named_pool(const StringName &p_name);\n+\n \tstatic WorkerThreadPool *get_singleton() { return singleton; }\n-\tstatic int get_thread_index();\n-\tstatic TaskID get_caller_task_id();\n+\tint get_thread_index() const;\n+\tTaskID get_caller_task_id() const;\n \n #ifdef THREADS_ENABLED\n \t_ALWAYS_INLINE_ static uint32_t thread_enter_unlock_allowance_zone(const MutexLock<BinaryMutex> &p_lock) { return _thread_enter_unlock_allowance_zone(p_lock._get_lock()); }\n@@ -285,7 +291,7 @@ class WorkerThreadPool : public Object {\n \tvoid init(int p_thread_count = -1, float p_low_priority_task_ratio = 0.3);\n \tvoid exit_languages_threads();\n \tvoid finish();\n-\tWorkerThreadPool();\n+\tWorkerThreadPool(bool p_singleton = true);\n \t~WorkerThreadPool();\n };\n \ndiff --git a/core/os/os.h b/core/os/os.h\nindex e0ec320e32ba..c8ac5c8eac7a 100644\n--- a/core/os/os.h\n+++ b/core/os/os.h\n@@ -362,9 +362,9 @@ class OS {\n \t// This is invoked by the GDExtensionManager after loading GDExtensions specified by the project.\n \tvirtual void load_platform_gdextensions() const {}\n \n-\t// Windows only. Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n-\tvirtual bool _test_create_rendering_device_and_gl() const { return true; }\n-\tvirtual bool _test_create_rendering_device() const { return true; }\n+\t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const { return true; }\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const { return true; }\n \n \tOS();\n \tvirtual ~OS();\ndiff --git a/core/variant/callable.cpp b/core/variant/callable.cpp\nindex 402dc6823c0a..0603ea273253 100644\n--- a/core/variant/callable.cpp\n+++ b/core/variant/callable.cpp\n@@ -188,7 +188,7 @@ int Callable::get_argument_count(bool *r_is_valid) const {\n \tif (is_custom()) {\n \t\tbool valid = false;\n \t\treturn custom->get_argument_count(r_is_valid ? *r_is_valid : valid);\n-\t} else if (!is_null()) {\n+\t} else if (is_valid()) {\n \t\treturn get_object()->get_method_argument_count(method, r_is_valid);\n \t} else {\n \t\tif (r_is_valid) {\ndiff --git a/doc/classes/LineEdit.xml b/doc/classes/LineEdit.xml\nindex c6cdacb6ec25..879b179dbfef 100644\n--- a/doc/classes/LineEdit.xml\n+++ b/doc/classes/LineEdit.xml\n@@ -252,7 +252,7 @@\n \t\t\tThe caret's column position inside the [LineEdit]. When set, the text may scroll to accommodate it.\n \t\t</member>\n \t\t<member name=\"caret_force_displayed\" type=\"bool\" setter=\"set_caret_force_displayed\" getter=\"is_caret_force_displayed\" default=\"false\">\n-\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if focus is lost.\n+\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if not editing or focus is lost.\n \t\t</member>\n \t\t<member name=\"caret_mid_grapheme\" type=\"bool\" setter=\"set_caret_mid_grapheme_enabled\" getter=\"is_caret_mid_grapheme_enabled\" default=\"false\">\n \t\t\tAllow moving caret, selecting and removing the individual composite character components.\ndiff --git a/doc/classes/NativeMenu.xml b/doc/classes/NativeMenu.xml\nindex 6081d7afc51e..5eaec56e7ec9 100644\n--- a/doc/classes/NativeMenu.xml\n+++ b/doc/classes/NativeMenu.xml\n@@ -374,7 +374,7 @@\n \t\t\t<param index=\"0\" name=\"rid\" type=\"RID\" />\n \t\t\t<description>\n \t\t\t\tReturns global menu open callback.\n-\t\t\t\tb]Note:[/b] This method is implemented only on macOS.\n+\t\t\t\t[b]Note:[/b] This method is implemented only on macOS.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"get_size\" qualifiers=\"const\">\ndiff --git a/doc/classes/RDTextureView.xml b/doc/classes/RDTextureView.xml\nindex bd8102d5531d..2e03ee44aab4 100644\n--- a/doc/classes/RDTextureView.xml\n+++ b/doc/classes/RDTextureView.xml\n@@ -9,7 +9,7 @@\n \t<tutorials>\n \t</tutorials>\n \t<members>\n-\t\t<member name=\"format_override\" type=\"int\" setter=\"set_format_override\" getter=\"get_format_override\" enum=\"RenderingDevice.DataFormat\" default=\"218\">\n+\t\t<member name=\"format_override\" type=\"int\" setter=\"set_format_override\" getter=\"get_format_override\" enum=\"RenderingDevice.DataFormat\" default=\"232\">\n \t\t\tOptional override for the data format to return sampled values in. The corresponding [RDTextureFormat] must have had this added as a shareable format. The default value of [constant RenderingDevice.DATA_FORMAT_MAX] does not override the format.\n \t\t</member>\n \t\t<member name=\"swizzle_a\" type=\"int\" setter=\"set_swizzle_a\" getter=\"get_swizzle_a\" enum=\"RenderingDevice.TextureSwizzle\" default=\"6\">\ndiff --git a/doc/classes/RDVertexAttribute.xml b/doc/classes/RDVertexAttribute.xml\nindex 364b82526b6c..04e4bb53a045 100644\n--- a/doc/classes/RDVertexAttribute.xml\n+++ b/doc/classes/RDVertexAttribute.xml\n@@ -9,7 +9,7 @@\n \t<tutorials>\n \t</tutorials>\n \t<members>\n-\t\t<member name=\"format\" type=\"int\" setter=\"set_format\" getter=\"get_format\" enum=\"RenderingDevice.DataFormat\" default=\"218\">\n+\t\t<member name=\"format\" type=\"int\" setter=\"set_format\" getter=\"get_format\" enum=\"RenderingDevice.DataFormat\" default=\"232\">\n \t\t\tThe way that this attribute's data is interpreted when sent to a shader.\n \t\t</member>\n \t\t<member name=\"frequency\" type=\"int\" setter=\"set_frequency\" getter=\"get_frequency\" enum=\"RenderingDevice.VertexFrequency\" default=\"0\">\ndiff --git a/doc/classes/RenderingDevice.xml b/doc/classes/RenderingDevice.xml\nindex 8db0272c75bf..2fc0e485447c 100644\n--- a/doc/classes/RenderingDevice.xml\n+++ b/doc/classes/RenderingDevice.xml\n@@ -1871,7 +1871,35 @@\n \t\t<constant name=\"DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM\" value=\"217\" enum=\"DataFormat\">\n \t\t\t16-bit-per-channel unsigned floating-point green/blue/red channel data with normalized value, plus 6 unused bits after each channel. Stored across 3 separate planes (green + blue + red). Values are in the [code][0.0, 1.0][/code] range.\n \t\t</constant>\n-\t\t<constant name=\"DATA_FORMAT_MAX\" value=\"218\" enum=\"DataFormat\">\n+\t\t<constant name=\"DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK\" value=\"218\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK\" value=\"219\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK\" value=\"220\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK\" value=\"221\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK\" value=\"222\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK\" value=\"223\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK\" value=\"224\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK\" value=\"225\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK\" value=\"226\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK\" value=\"227\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK\" value=\"228\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK\" value=\"229\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK\" value=\"230\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK\" value=\"231\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_MAX\" value=\"232\" enum=\"DataFormat\">\n \t\t\tRepresents the size of the [enum DataFormat] enum.\n \t\t</constant>\n \t\t<constant name=\"BARRIER_MASK_VERTEX\" value=\"1\" enum=\"BarrierMask\" is_bitfield=\"true\">\ndiff --git a/drivers/apple/joypad_apple.h b/drivers/apple/joypad_apple.h\nindex 909648e253dd..d89707c03d75 100644\n--- a/drivers/apple/joypad_apple.h\n+++ b/drivers/apple/joypad_apple.h\n@@ -43,6 +43,7 @@ struct GameController {\n \tRumbleContext *rumble_context API_AVAILABLE(macos(11.0), ios(14.0), tvos(14.0)) = nil;\n \tNSInteger ff_effect_timestamp = 0;\n \tbool force_feedback = false;\n+\tbool nintendo_button_layout = false;\n \n \tGameController(int p_joy_id, GCController *p_controller);\n \t~GameController();\ndiff --git a/drivers/apple/joypad_apple.mm b/drivers/apple/joypad_apple.mm\nindex 148ec4cb2718..e14fc96a2841 100644\n--- a/drivers/apple/joypad_apple.mm\n+++ b/drivers/apple/joypad_apple.mm\n@@ -144,6 +144,12 @@ void play_strong_pattern(CHHapticPattern *p_pattern) {\n \t\t}\n \t}\n \n+\tif (@available(macOS 10.15, iOS 13.0, tvOS 13.0, *)) {\n+\t\tif ([controller.productCategory isEqualToString:@\"Switch Pro Controller\"] || [controller.productCategory isEqualToString:@\"Nintendo Switch Joy-Con (L/R)\"]) {\n+\t\t\tnintendo_button_layout = true;\n+\t\t}\n+\t}\n+\n \tint l_joy_id = joy_id;\n \n \tauto BUTTON = [l_joy_id](JoyButton p_button) {\n@@ -155,10 +161,18 @@ void play_strong_pattern(CHHapticPattern *p_pattern) {\n \tif (controller.extendedGamepad != nil) {\n \t\tGCExtendedGamepad *gamepad = controller.extendedGamepad;\n \n-\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::A);\n-\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::B);\n-\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::X);\n-\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\tif (nintendo_button_layout) {\n+\t\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::B);\n+\t\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::A);\n+\t\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::X);\n+\t\t} else {\n+\t\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::A);\n+\t\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::B);\n+\t\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::X);\n+\t\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\t}\n+\n \t\tgamepad.leftShoulder.pressedChangedHandler = BUTTON(JoyButton::LEFT_SHOULDER);\n \t\tgamepad.rightShoulder.pressedChangedHandler = BUTTON(JoyButton::RIGHT_SHOULDER);\n \t\tgamepad.dpad.up.pressedChangedHandler = BUTTON(JoyButton::DPAD_UP);\ndiff --git a/drivers/d3d12/rendering_device_driver_d3d12.cpp b/drivers/d3d12/rendering_device_driver_d3d12.cpp\nindex 29b36f140551..f5772f2e3024 100644\n--- a/drivers/d3d12/rendering_device_driver_d3d12.cpp\n+++ b/drivers/d3d12/rendering_device_driver_d3d12.cpp\n@@ -332,6 +332,20 @@ const RenderingDeviceDriverD3D12::D3D12Format RenderingDeviceDriverD3D12::RD_TO_\n \t/* DATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM */ {},\n \t/* DATA_FORMAT_G16_B16R16_2PLANE_422_UNORM */ {},\n \t/* DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM */ {},\n+\t/* DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK*/ {},\n+\t/* DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK */ {},\n };\n \n Error RenderingDeviceDriverD3D12::DescriptorsHeap::allocate(ID3D12Device *p_device, D3D12_DESCRIPTOR_HEAP_TYPE p_type, uint32_t p_descriptor_count, bool p_for_gpu) {\ndiff --git a/drivers/gles3/effects/copy_effects.cpp b/drivers/gles3/effects/copy_effects.cpp\nindex 47ca832bd7ab..4d74a4996b9f 100644\n--- a/drivers/gles3/effects/copy_effects.cpp\n+++ b/drivers/gles3/effects/copy_effects.cpp\n@@ -243,7 +243,7 @@ void CopyEffects::gaussian_blur(GLuint p_source_texture, int p_mipmap_count, con\n \n \t\tglBindTexture(GL_TEXTURE_2D, p_source_texture);\n \t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_BASE_LEVEL, i - 1);\n-\t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAX_LEVEL, i - 1);\n+\t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAX_LEVEL, i);\n \t\tglFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, p_source_texture, i);\n #ifdef DEV_ENABLED\n \t\tGLenum status = glCheckFramebufferStatus(GL_FRAMEBUFFER);\ndiff --git a/drivers/gles3/rasterizer_canvas_gles3.cpp b/drivers/gles3/rasterizer_canvas_gles3.cpp\nindex 0ca013abd1a0..441636cd26db 100644\n--- a/drivers/gles3/rasterizer_canvas_gles3.cpp\n+++ b/drivers/gles3/rasterizer_canvas_gles3.cpp\n@@ -1152,6 +1152,12 @@ void RasterizerCanvasGLES3::_record_item_commands(const Item *p_item, RID p_rend\n \t\t\t\t\t// Reset base data.\n \t\t\t\t\t_update_transform_2d_to_mat2x3(base_transform * draw_transform, state.instance_data_array[r_index].world);\n \t\t\t\t\t_prepare_canvas_texture(state.canvas_instance_batches[state.current_batch_index].tex, state.canvas_instance_batches[state.current_batch_index].filter, state.canvas_instance_batches[state.current_batch_index].repeat, r_index, texpixel_size);\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[0] = lights[0];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[1] = lights[1];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[2] = lights[2];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[3] = lights[3];\n+\t\t\t\t\tstate.instance_data_array[r_index].flags = base_flags;\n+\t\t\t\t\tstate.instance_data_array[r_index].instance_uniforms_ofs = p_item->instance_allocated_shader_uniforms_offset;\n \n \t\t\t\t\tfor (uint32_t j = 0; j < 3; j++) {\n \t\t\t\t\t\tint offset = j == 0 ? 0 : 1;\ndiff --git a/drivers/gles3/storage/particles_storage.cpp b/drivers/gles3/storage/particles_storage.cpp\nindex 73d7e340d2a8..599412c5b2de 100644\n--- a/drivers/gles3/storage/particles_storage.cpp\n+++ b/drivers/gles3/storage/particles_storage.cpp\n@@ -513,7 +513,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tGLES3::TextureStorage *texture_storage = GLES3::TextureStorage::get_singleton();\n \tGLES3::MaterialStorage *material_storage = GLES3::MaterialStorage::get_singleton();\n \n-\tdouble new_phase = Math::fmod(p_particles->phase + (p_delta / p_particles->lifetime) * p_particles->speed_scale, 1.0);\n+\tdouble new_phase = Math::fmod(p_particles->phase + (p_delta / p_particles->lifetime), 1.0);\n \n \t//update current frame\n \tParticlesFrameParams frame_params;\n@@ -534,7 +534,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tp_particles->phase = new_phase;\n \n \tframe_params.time = RSG::rasterizer->get_total_time();\n-\tframe_params.delta = p_delta * p_particles->speed_scale;\n+\tframe_params.delta = p_delta;\n \tframe_params.random_seed = p_particles->random_seed;\n \tframe_params.explosiveness = p_particles->explosiveness;\n \tframe_params.randomness = p_particles->randomness;\n@@ -1097,8 +1097,6 @@ void ParticlesStorage::update_particles() {\n \t\t\tfixed_fps = particles->fixed_fps;\n \t\t}\n \n-\t\tbool zero_time_scale = Engine::get_singleton()->get_time_scale() <= 0.0;\n-\n \t\tif (particles->clear && particles->pre_process_time > 0.0) {\n \t\t\tdouble frame_time;\n \t\t\tif (fixed_fps > 0) {\n@@ -1115,37 +1113,27 @@ void ParticlesStorage::update_particles() {\n \t\t\t}\n \t\t}\n \n+\t\tdouble time_scale = MAX(particles->speed_scale, 0.0);\n+\n \t\tif (fixed_fps > 0) {\n-\t\t\tdouble frame_time;\n-\t\t\tdouble decr;\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\tframe_time = 0.0;\n-\t\t\t\tdecr = 1.0 / fixed_fps;\n-\t\t\t} else {\n-\t\t\t\tframe_time = 1.0 / fixed_fps;\n-\t\t\t\tdecr = frame_time;\n-\t\t\t}\n+\t\t\tdouble frame_time = 1.0 / fixed_fps;\n \t\t\tdouble delta = RSG::rasterizer->get_frame_delta_time();\n \t\t\tif (delta > 0.1) { //avoid recursive stalls if fps goes below 10\n \t\t\t\tdelta = 0.1;\n \t\t\t} else if (delta <= 0.0) { //unlikely but..\n \t\t\t\tdelta = 0.001;\n \t\t\t}\n-\t\t\tdouble todo = particles->frame_remainder + delta;\n+\t\t\tdouble todo = particles->frame_remainder + delta * time_scale;\n \n \t\t\twhile (todo >= frame_time) {\n \t\t\t\t_particles_process(particles, frame_time);\n-\t\t\t\ttodo -= decr;\n+\t\t\t\ttodo -= frame_time;\n \t\t\t}\n \n \t\t\tparticles->frame_remainder = todo;\n \n \t\t} else {\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\t_particles_process(particles, 0.0);\n-\t\t\t} else {\n-\t\t\t\t_particles_process(particles, RSG::rasterizer->get_frame_delta_time());\n-\t\t\t}\n+\t\t\t_particles_process(particles, RSG::rasterizer->get_frame_delta_time() * time_scale);\n \t\t}\n \n \t\tif (particles->request_process_time > 0.0) {\ndiff --git a/drivers/metal/pixel_formats.mm b/drivers/metal/pixel_formats.mm\nindex c9226590b169..c784faa8397b 100644\n--- a/drivers/metal/pixel_formats.mm\n+++ b/drivers/metal/pixel_formats.mm\n@@ -493,32 +493,46 @@ void clear(T *p_val, size_t p_count = 1) {\n \taddDataFormatDesc(EAC_R11G11_SNORM_BLOCK, EAC_RG11Snorm, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \n \taddDataFormatDesc(ASTC_4x4_UNORM_BLOCK, ASTC_4x4_LDR, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n+\taddDataFormatDesc(ASTC_4x4_SFLOAT_BLOCK, ASTC_4x4_HDR, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_4x4_SRGB_BLOCK, ASTC_4x4_sRGB, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x4_UNORM_BLOCK, ASTC_5x4_LDR, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n+\taddDataFormatDesc(ASTC_5x4_SFLOAT_BLOCK, ASTC_5x4_HDR, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x4_SRGB_BLOCK, ASTC_5x4_sRGB, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x5_UNORM_BLOCK, ASTC_5x5_LDR, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_5x5_SFLOAT_BLOCK, ASTC_5x5_HDR, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x5_SRGB_BLOCK, ASTC_5x5_sRGB, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x5_UNORM_BLOCK, ASTC_6x5_LDR, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_6x5_SFLOAT_BLOCK, ASTC_6x5_HDR, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x5_SRGB_BLOCK, ASTC_6x5_sRGB, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x6_UNORM_BLOCK, ASTC_6x6_LDR, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_6x6_SFLOAT_BLOCK, ASTC_6x6_HDR, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x6_SRGB_BLOCK, ASTC_6x6_sRGB, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x5_UNORM_BLOCK, ASTC_8x5_LDR, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x5_SFLOAT_BLOCK, ASTC_8x5_HDR, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x5_SRGB_BLOCK, ASTC_8x5_sRGB, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x6_UNORM_BLOCK, ASTC_8x6_LDR, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x6_SFLOAT_BLOCK, ASTC_8x6_HDR, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x6_SRGB_BLOCK, ASTC_8x6_sRGB, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x8_UNORM_BLOCK, ASTC_8x8_LDR, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x8_SFLOAT_BLOCK, ASTC_8x8_HDR, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x8_SRGB_BLOCK, ASTC_8x8_sRGB, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x5_UNORM_BLOCK, ASTC_10x5_LDR, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x5_SFLOAT_BLOCK, ASTC_10x5_HDR, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x5_SRGB_BLOCK, ASTC_10x5_sRGB, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x6_UNORM_BLOCK, ASTC_10x6_LDR, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x6_SFLOAT_BLOCK, ASTC_10x6_HDR, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x6_SRGB_BLOCK, ASTC_10x6_sRGB, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x8_UNORM_BLOCK, ASTC_10x8_LDR, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x8_SFLOAT_BLOCK, ASTC_10x8_HDR, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x8_SRGB_BLOCK, ASTC_10x8_sRGB, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x10_UNORM_BLOCK, ASTC_10x10_LDR, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x10_SFLOAT_BLOCK, ASTC_10x10_HDR, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x10_SRGB_BLOCK, ASTC_10x10_sRGB, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x10_UNORM_BLOCK, ASTC_12x10_LDR, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n+\taddDataFormatDesc(ASTC_12x10_SFLOAT_BLOCK, ASTC_12x10_HDR, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x10_SRGB_BLOCK, ASTC_12x10_sRGB, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x12_UNORM_BLOCK, ASTC_12x12_LDR, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n+\taddDataFormatDesc(ASTC_12x12_SFLOAT_BLOCK, ASTC_12x12_HDR, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x12_SRGB_BLOCK, ASTC_12x12_sRGB, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n \n \taddDfFormatDescChromaSubsampling(G8B8G8R8_422_UNORM, GBGR422, 1, 8, 2, 1, 4);\ndiff --git a/drivers/vulkan/rendering_device_driver_vulkan.cpp b/drivers/vulkan/rendering_device_driver_vulkan.cpp\nindex ae15191dd429..9c50c845a70b 100644\n--- a/drivers/vulkan/rendering_device_driver_vulkan.cpp\n+++ b/drivers/vulkan/rendering_device_driver_vulkan.cpp\n@@ -276,6 +276,20 @@ static const VkFormat RD_TO_VK_FORMAT[RDD::DATA_FORMAT_MAX] = {\n \tVK_FORMAT_G16_B16_R16_3PLANE_422_UNORM,\n \tVK_FORMAT_G16_B16R16_2PLANE_422_UNORM,\n \tVK_FORMAT_G16_B16_R16_3PLANE_444_UNORM,\n+\tVK_FORMAT_ASTC_4x4_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_5x4_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_5x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_6x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_6x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x8_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x8_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x10_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_12x10_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_12x12_SFLOAT_BLOCK,\n };\n \n static VkImageLayout RD_TO_VK_LAYOUT[RDD::TEXTURE_LAYOUT_MAX] = {\n@@ -514,6 +528,7 @@ Error RenderingDeviceDriverVulkan::_initialize_device_extensions() {\n \t_register_requested_device_extension(VK_EXT_SUBGROUP_SIZE_CONTROL_EXTENSION_NAME, false);\n \t_register_requested_device_extension(VK_EXT_ASTC_DECODE_MODE_EXTENSION_NAME, false);\n \t_register_requested_device_extension(VK_KHR_BUFFER_DEVICE_ADDRESS_EXTENSION_NAME, false);\n+\t_register_requested_device_extension(VK_EXT_TEXTURE_COMPRESSION_ASTC_HDR_EXTENSION_NAME, false);\n \n \tif (Engine::get_singleton()->is_generate_spirv_debug_info_enabled()) {\n \t\t_register_requested_device_extension(VK_KHR_SHADER_NON_SEMANTIC_INFO_EXTENSION_NAME, true);\n@@ -1547,6 +1562,10 @@ RDD::BufferID RenderingDeviceDriverVulkan::buffer_create(uint64_t p_size, BitFie\n \t\t} break;\n \t\tcase MEMORY_ALLOCATION_TYPE_GPU: {\n \t\t\tvma_usage = VMA_MEMORY_USAGE_AUTO_PREFER_DEVICE;\n+\t\t\tif (!Engine::get_singleton()->is_extra_gpu_memory_tracking_enabled()) {\n+\t\t\t\t// We must set it right now or else vmaFindMemoryTypeIndexForBufferInfo will use wrong parameters.\n+\t\t\t\talloc_create_info.usage = vma_usage;\n+\t\t\t}\n \t\t\talloc_create_info.preferredFlags = VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT;\n \t\t\tif (p_size <= SMALL_ALLOCATION_MAX_SIZE) {\n \t\t\t\tuint32_t mem_type_index = 0;\n@@ -2140,6 +2159,10 @@ void RenderingDeviceDriverVulkan::texture_unmap(TextureID p_texture) {\n }\n \n BitField<RDD::TextureUsageBits> RenderingDeviceDriverVulkan::texture_get_usages_supported_by_format(DataFormat p_format, bool p_cpu_readable) {\n+\tif (p_format >= DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK && p_format <= DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK && !enabled_device_extension_names.has(VK_EXT_TEXTURE_COMPRESSION_ASTC_HDR_EXTENSION_NAME)) {\n+\t\t// Formats that were introduced later with extensions must not reach vkGetPhysicalDeviceFormatProperties if the extension isn't available. This means it's not supported.\n+\t\treturn 0;\n+\t}\n \tVkFormatProperties properties = {};\n \tvkGetPhysicalDeviceFormatProperties(physical_device, RD_TO_VK_FORMAT[p_format], &properties);\n \ndiff --git a/drivers/windows/file_access_windows.cpp b/drivers/windows/file_access_windows.cpp\nindex a8e2a6859bc3..6835b510df73 100644\n--- a/drivers/windows/file_access_windows.cpp\n+++ b/drivers/windows/file_access_windows.cpp\n@@ -418,7 +418,7 @@ uint64_t FileAccessWindows::_get_modified_time(const String &p_file) {\n \t\tfile = file.substr(0, file.length() - 1);\n \t}\n \n-\tHANDLE handle = CreateFileW((LPCWSTR)(file.utf16().get_data()), GENERIC_READ, FILE_SHARE_READ, nullptr, OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS, nullptr);\n+\tHANDLE handle = CreateFileW((LPCWSTR)(file.utf16().get_data()), FILE_READ_ATTRIBUTES, FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE, nullptr, OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS, nullptr);\n \n \tif (handle != INVALID_HANDLE_VALUE) {\n \t\tFILETIME ft_create, ft_write;\ndiff --git a/editor/animation_track_editor.cpp b/editor/animation_track_editor.cpp\nindex dbb23d6f17a6..bb51c16f37b5 100644\n--- a/editor/animation_track_editor.cpp\n+++ b/editor/animation_track_editor.cpp\n@@ -5088,7 +5088,7 @@ void AnimationTrackEditor::_update_nearest_fps_label() {\n \t\tnearest_fps_label->hide();\n \t} else {\n \t\tnearest_fps_label->show();\n-\t\tnearest_fps_label->set_text(\"Nearest FPS: \" + itos(nearest_fps));\n+\t\tnearest_fps_label->set_text(vformat(TTR(\"Nearest FPS: %d\"), nearest_fps));\n \t}\n }\n \n@@ -7688,6 +7688,7 @@ AnimationTrackEditor::AnimationTrackEditor() {\n \tfps_compat->connect(SceneStringName(toggled), callable_mp(this, &AnimationTrackEditor::_update_fps_compat_mode));\n \n \tnearest_fps_label = memnew(Label);\n+\tnearest_fps_label->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \tbottom_hf->add_child(nearest_fps_label);\n \n \tstep = memnew(EditorSpinSlider);\ndiff --git a/editor/connections_dialog.cpp b/editor/connections_dialog.cpp\nindex dca43411e10b..5081be0d2d94 100644\n--- a/editor/connections_dialog.cpp\n+++ b/editor/connections_dialog.cpp\n@@ -453,7 +453,13 @@ void ConnectDialog::_update_ok_enabled() {\n }\n \n void ConnectDialog::_update_warning_label() {\n-\tRef<Script> scr = source->get_node(dst_path)->get_script();\n+\tNode *dst = source->get_node(dst_path);\n+\tif (dst == nullptr) {\n+\t\twarning_label->set_visible(false);\n+\t\treturn;\n+\t}\n+\n+\tRef<Script> scr = dst->get_script();\n \tif (scr.is_null()) {\n \t\twarning_label->set_visible(false);\n \t\treturn;\n@@ -865,9 +871,8 @@ ConnectDialog::ConnectDialog() {\n \thbc_method->add_child(dst_method);\n \tregister_text_enter(dst_method);\n \n-\topen_method_tree = memnew(Button);\n+\topen_method_tree = memnew(Button(TTRC(\"Pick\")));\n \thbc_method->add_child(open_method_tree);\n-\topen_method_tree->set_text(\"Pick\");\n \topen_method_tree->connect(SceneStringName(pressed), callable_mp(this, &ConnectDialog::_open_method_popup));\n \n \tadvanced = memnew(CheckButton(TTR(\"Advanced\")));\ndiff --git a/editor/debugger/debug_adapter/debug_adapter_protocol.cpp b/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\nindex ba4c078d7ed5..00ae9dca7ebb 100644\n--- a/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\n+++ b/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\n@@ -1032,6 +1032,7 @@ void DebugAdapterProtocol::on_debug_paused() {\n void DebugAdapterProtocol::on_debug_stopped() {\n \tnotify_exited();\n \tnotify_terminated();\n+\treset_ids();\n }\n \n void DebugAdapterProtocol::on_debug_output(const String &p_message, int p_type) {\ndiff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 58b02ed2b8a1..87a7433e8cb9 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -3440,6 +3440,8 @@ void EditorInspector::update_tree() {\n \t\t// Recreate the category vbox if it was reset.\n \t\tif (category_vbox == nullptr) {\n \t\t\tcategory_vbox = memnew(VBoxContainer);\n+\t\t\tint separation = get_theme_constant(SNAME(\"v_separation\"), SNAME(\"EditorInspector\"));\n+\t\t\tcategory_vbox->add_theme_constant_override(SNAME(\"separation\"), separation);\n \t\t\tcategory_vbox->hide();\n \t\t\tmain_vbox->add_child(category_vbox);\n \t\t}\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 6b725240f9e2..2261b14acbe3 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -1207,7 +1207,7 @@ void EditorNode::_sources_changed(bool p_exist) {\n \t\t}\n \n \t\t// Start preview thread now that it's safe.\n-\t\tif (!singleton->cmdline_export_mode) {\n+\t\tif (!singleton->cmdline_mode) {\n \t\t\tEditorResourcePreview::get_singleton()->start();\n \t\t}\n \n@@ -1807,7 +1807,7 @@ void EditorNode::_save_scene_with_preview(String p_file, int p_idx) {\n \tsave_scene_progress->step(TTR(\"Saving Scene\"), 4);\n \t_save_scene(p_file, p_idx);\n \n-\tif (!singleton->cmdline_export_mode) {\n+\tif (!singleton->cmdline_mode) {\n \t\tEditorResourcePreview::get_singleton()->check_for_invalidation(p_file);\n \t}\n \n@@ -1867,6 +1867,7 @@ int EditorNode::_save_external_resources(bool p_also_save_external_data) {\n \t\tres->set_edited(false);\n \t}\n \n+\tbool script_was_saved = false;\n \tfor (const String &E : edited_resources) {\n \t\tRef<Resource> res = ResourceCache::get_ref(E);\n \t\tif (res.is_null()) {\n@@ -1876,10 +1877,18 @@ int EditorNode::_save_external_resources(bool p_also_save_external_data) {\n \t\tif (ps.is_valid()) {\n \t\t\tcontinue; // Do not save PackedScenes, this will mess up the editor.\n \t\t}\n+\t\tif (!script_was_saved) {\n+\t\t\tRef<Script> scr = res;\n+\t\t\tscript_was_saved = scr.is_valid();\n+\t\t}\n \t\tResourceSaver::save(res, res->get_path(), flg);\n \t\tsaved++;\n \t}\n \n+\tif (script_was_saved) {\n+\t\tScriptEditor::get_singleton()->update_script_times();\n+\t}\n+\n \tif (p_also_save_external_data) {\n \t\tfor (int i = 0; i < editor_data.get_editor_plugin_count(); i++) {\n \t\t\tEditorPlugin *plugin = editor_data.get_editor_plugin(i);\n@@ -4944,7 +4953,7 @@ bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringNa\n void EditorNode::progress_add_task(const String &p_task, const String &p_label, int p_steps, bool p_can_cancel) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": begin: \" + p_label + \" steps: \" + itos(p_steps));\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->add_task(p_task, p_label, p_steps, p_can_cancel);\n@@ -4954,7 +4963,7 @@ void EditorNode::progress_add_task(const String &p_task, const String &p_label,\n bool EditorNode::progress_task_step(const String &p_task, const String &p_state, int p_step, bool p_force_refresh) {\n \tif (!singleton) {\n \t\treturn false;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(\"\\t\" + p_task + \": step \" + itos(p_step) + \": \" + p_state);\n \t\treturn false;\n \t} else if (singleton->progress_dialog) {\n@@ -4967,7 +4976,7 @@ bool EditorNode::progress_task_step(const String &p_task, const String &p_state,\n void EditorNode::progress_end_task(const String &p_task) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": end\");\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->end_task(p_task);\n@@ -5220,7 +5229,7 @@ Error EditorNode::export_preset(const String &p_preset, const String &p_path, bo\n \texport_defer.android_build_template = p_android_build_template;\n \texport_defer.patch = p_patch;\n \texport_defer.patches = p_patches;\n-\tcmdline_export_mode = true;\n+\tcmdline_mode = true;\n \treturn OK;\n }\n \n@@ -6848,7 +6857,10 @@ EditorNode::EditorNode() {\n \tDEV_ASSERT(!singleton);\n \tsingleton = this;\n \n-\tset_translation_domain(\"godot.editor\");\n+\t// Detecting headless mode, that means the editor is running in command line.\n+\tif (!DisplayServer::get_singleton()->window_can_draw()) {\n+\t\tcmdline_mode = true;\n+\t}\n \n \tResource::_get_local_scene_func = _resource_get_edited_scene;\n \ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex de3af997473a..63788e645f30 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -419,7 +419,7 @@ class EditorNode : public Node {\n \tbool script_distraction_free = false;\n \n \tbool changing_scene = false;\n-\tbool cmdline_export_mode = false;\n+\tbool cmdline_mode = false;\n \tbool convert_old = false;\n \tbool immediate_dialog_confirmed = false;\n \tbool opening_prev = false;\ndiff --git a/editor/export/project_export.cpp b/editor/export/project_export.cpp\nindex 5b93a1a17ec7..0982520acd58 100644\n--- a/editor/export/project_export.cpp\n+++ b/editor/export/project_export.cpp\n@@ -1746,11 +1746,13 @@ ProjectExportDialog::ProjectExportDialog() {\n \texport_error = memnew(Label);\n \tmain_vb->add_child(export_error);\n \texport_error->hide();\n+\texport_error->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_error->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"error_color\"), EditorStringName(Editor)));\n \n \texport_warning = memnew(Label);\n \tmain_vb->add_child(export_warning);\n \texport_warning->hide();\n+\texport_warning->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_warning->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"warning_color\"), EditorStringName(Editor)));\n \n \texport_templates_error = memnew(HBoxContainer);\n@@ -1759,6 +1761,7 @@ ProjectExportDialog::ProjectExportDialog() {\n \n \tLabel *export_error2 = memnew(Label);\n \texport_templates_error->add_child(export_error2);\n+\texport_error2->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_error2->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"error_color\"), EditorStringName(Editor)));\n \texport_error2->set_text(String::utf8(\"\u2022  \") + TTR(\"Export templates for this platform are missing:\") + \" \");\n \ndiff --git a/editor/plugins/polygon_3d_editor_plugin.cpp b/editor/plugins/polygon_3d_editor_plugin.cpp\nindex 9d7567f2528a..f07ce22127c3 100644\n--- a/editor/plugins/polygon_3d_editor_plugin.cpp\n+++ b/editor/plugins/polygon_3d_editor_plugin.cpp\n@@ -560,6 +560,7 @@ Polygon3DEditor::Polygon3DEditor() {\n \tline_material->set_flag(StandardMaterial3D::FLAG_ALBEDO_FROM_VERTEX_COLOR, true);\n \tline_material->set_flag(StandardMaterial3D::FLAG_SRGB_VERTEX_COLOR, true);\n \tline_material->set_flag(StandardMaterial3D::FLAG_DISABLE_FOG, true);\n+\tline_material->set_flag(StandardMaterial3D::FLAG_DISABLE_DEPTH_TEST, true);\n \tline_material->set_albedo(Color(1, 1, 1));\n \n \thandle_material.instantiate();\n@@ -569,6 +570,7 @@ Polygon3DEditor::Polygon3DEditor() {\n \thandle_material->set_flag(StandardMaterial3D::FLAG_ALBEDO_FROM_VERTEX_COLOR, true);\n \thandle_material->set_flag(StandardMaterial3D::FLAG_SRGB_VERTEX_COLOR, true);\n \thandle_material->set_flag(StandardMaterial3D::FLAG_DISABLE_FOG, true);\n+\thandle_material->set_flag(StandardMaterial3D::FLAG_DISABLE_DEPTH_TEST, true);\n \tRef<Texture2D> handle = EditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"Editor3DHandle\"), EditorStringName(EditorIcons));\n \thandle_material->set_point_size(handle->get_width());\n \thandle_material->set_texture(StandardMaterial3D::TEXTURE_ALBEDO, handle);\ndiff --git a/editor/plugins/script_editor_plugin.cpp b/editor/plugins/script_editor_plugin.cpp\nindex af7812abe806..45b921fad613 100644\n--- a/editor/plugins/script_editor_plugin.cpp\n+++ b/editor/plugins/script_editor_plugin.cpp\n@@ -2817,6 +2817,15 @@ void ScriptEditor::save_all_scripts() {\n \t_update_script_names();\n }\n \n+void ScriptEditor::update_script_times() {\n+\tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n+\t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n+\t\tif (se) {\n+\t\t\tse->edited_file_data.last_modified_time = FileAccess::get_modified_time(se->edited_file_data.path);\n+\t\t}\n+\t}\n+}\n+\n void ScriptEditor::apply_scripts() const {\n \tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n \t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n@@ -4205,6 +4214,7 @@ ScriptEditor::ScriptEditor(WindowWrapper *p_wrapper) {\n \toverview_vbox->add_child(buttons_hbox);\n \n \tfilename = memnew(Label);\n+\tfilename->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \tfilename->set_clip_text(true);\n \tfilename->set_h_size_flags(SIZE_EXPAND_FILL);\n \tfilename->set_vertical_alignment(VERTICAL_ALIGNMENT_CENTER);\ndiff --git a/editor/plugins/script_editor_plugin.h b/editor/plugins/script_editor_plugin.h\nindex 02e0529a7cf6..30198f1cb1c6 100644\n--- a/editor/plugins/script_editor_plugin.h\n+++ b/editor/plugins/script_editor_plugin.h\n@@ -569,6 +569,7 @@ class ScriptEditor : public PanelContainer {\n \tPackedStringArray get_unsaved_scripts() const;\n \tvoid save_current_script();\n \tvoid save_all_scripts();\n+\tvoid update_script_times();\n \n \tvoid set_window_layout(Ref<ConfigFile> p_layout);\n \tvoid get_window_layout(Ref<ConfigFile> p_layout);\ndiff --git a/editor/plugins/visual_shader_editor_plugin.cpp b/editor/plugins/visual_shader_editor_plugin.cpp\nindex b8af4603e80f..516ef516154c 100644\n--- a/editor/plugins/visual_shader_editor_plugin.cpp\n+++ b/editor/plugins/visual_shader_editor_plugin.cpp\n@@ -7623,12 +7623,15 @@ class VisualShaderNodePluginInputEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_input_select_item\"), input, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_input_select_item\"), input, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeInput> &p_input) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tinput = p_input;\n+\n \t\tRef<Texture2D> type_icon[] = {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"float\"), EditorStringName(EditorIcons)),\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"int\"), EditorStringName(EditorIcons)),\n@@ -7641,13 +7644,16 @@ class VisualShaderNodePluginInputEditor : public OptionButton {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"ImageTexture\"), EditorStringName(EditorIcons)),\n \t\t};\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n+\n \t\tint to_select = -1;\n \t\tfor (int i = 0; i < input->get_input_index_count(); i++) {\n \t\t\tif (input->get_input_name() == input->get_input_index_name(i)) {\n \t\t\t\tto_select = i + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[input->get_input_index_type(i)], input->get_input_index_name(i));\n+\t\t\tset_item_metadata(-1, input->get_input_index_name(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -7672,10 +7678,12 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_varying_select_item\"), varying, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_varying_select_item\"), varying, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeVarying> &p_varying, VisualShader::Type p_type) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tvarying = p_varying;\n \n@@ -7692,7 +7700,8 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \n \t\tbool is_getter = Ref<VisualShaderNodeVaryingGetter>(p_varying.ptr()).is_valid();\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n \n \t\tint to_select = -1;\n \t\tfor (int i = 0, j = 0; i < varying->get_varyings_count(); i++) {\n@@ -7726,6 +7735,7 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \t\t\t\tto_select = i - j + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[varying->get_varying_type_by_index(i)], varying->get_varying_name_by_index(i));\n+\t\t\tset_item_metadata(-1, varying->get_varying_name_by_index(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -7752,10 +7762,12 @@ class VisualShaderNodePluginParameterRefEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_parameter_ref_select_item\"), parameter_ref, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_parameter_ref_select_item\"), parameter_ref, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeParameterRef> &p_parameter_ref) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tparameter_ref = p_parameter_ref;\n \n@@ -7772,13 +7784,16 @@ class VisualShaderNodePluginParameterRefEditor : public OptionButton {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"ImageTexture\"), EditorStringName(EditorIcons)),\n \t\t};\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n+\n \t\tint to_select = -1;\n \t\tfor (int i = 0; i < p_parameter_ref->get_parameters_count(); i++) {\n \t\t\tif (p_parameter_ref->get_parameter_name() == p_parameter_ref->get_parameter_name_by_index(i)) {\n \t\t\t\tto_select = i + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[p_parameter_ref->get_parameter_type_by_index(i)], p_parameter_ref->get_parameter_name_by_index(i));\n+\t\t\tset_item_metadata(-1, p_parameter_ref->get_parameter_name_by_index(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -8126,6 +8141,7 @@ void EditorPropertyVisualShaderMode::set_option_button_clip(bool p_enable) {\n \n EditorPropertyVisualShaderMode::EditorPropertyVisualShaderMode() {\n \toptions = memnew(OptionButton);\n+\toptions->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \toptions->set_clip_text(true);\n \tadd_child(options);\n \tadd_focusable(options);\ndiff --git a/editor/project_manager.cpp b/editor/project_manager.cpp\nindex c3bd3acf775f..19bcfe8bc516 100644\n--- a/editor/project_manager.cpp\n+++ b/editor/project_manager.cpp\n@@ -1162,8 +1162,6 @@ void ProjectManager::_titlebar_resized() {\n ProjectManager::ProjectManager(bool p_custom_res) {\n \tsingleton = this;\n \n-\tset_translation_domain(\"godot.editor\");\n-\n \t// Turn off some servers we aren't going to be using in the Project Manager.\n \tNavigationServer3D::get_singleton()->set_active(false);\n \tPhysicsServer3D::get_singleton()->set_active(false);\ndiff --git a/editor/project_manager/project_list.cpp b/editor/project_manager/project_list.cpp\nindex b96e40b0b73e..7eeb2f8460a2 100644\n--- a/editor/project_manager/project_list.cpp\n+++ b/editor/project_manager/project_list.cpp\n@@ -68,10 +68,13 @@ void ProjectListItemControl::_notification(int p_what) {\n \t\t\tproject_unsupported_features->set_texture(get_editor_theme_icon(SNAME(\"NodeWarning\")));\n \n \t\t\tfavorite_button->set_texture_normal(get_editor_theme_icon(SNAME(\"Favorites\")));\n+\n \t\t\tif (project_is_missing) {\n \t\t\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"FileBroken\")));\n+#if !defined(ANDROID_ENABLED) && !defined(WEB_ENABLED)\n \t\t\t} else {\n \t\t\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n+#endif\n \t\t\t}\n \t\t} break;\n \n@@ -190,9 +193,6 @@ void ProjectListItemControl::set_is_favorite(bool p_favorite) {\n }\n \n void ProjectListItemControl::set_is_missing(bool p_missing) {\n-\tif (project_is_missing == p_missing) {\n-\t\treturn;\n-\t}\n \tproject_is_missing = p_missing;\n \n \tif (project_is_missing) {\n@@ -201,10 +201,8 @@ void ProjectListItemControl::set_is_missing(bool p_missing) {\n \t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"FileBroken\")));\n \t\texplore_button->set_tooltip_text(TTR(\"Error: Project is missing on the filesystem.\"));\n \t} else {\n-\t\tproject_icon->set_modulate(Color(1, 1, 1, 1.0));\n-\n-\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n #if !defined(ANDROID_ENABLED) && !defined(WEB_ENABLED)\n+\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n \t\texplore_button->set_tooltip_text(TTR(\"Show in File Manager\"));\n #else\n \t\t// Opening the system file manager is not supported on the Android and web editors.\ndiff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex 267d35f99458..1390d8256e08 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -4268,7 +4268,7 @@ List<Node *> SceneTreeDock::paste_nodes(bool p_paste_as_sibling) {\n \t\t\t// and added to the node_clipboard_edited_scene_owned list.\n \t\t\tif (d != dup && E2.key->get_owner() == nullptr) {\n \t\t\t\tif (node_clipboard_edited_scene_owned.find(const_cast<Node *>(E2.key))) {\n-\t\t\t\t\tur->add_do_method(d, \"set_owner\", edited_scene);\n+\t\t\t\t\tur->add_do_method(d, \"set_owner\", owner);\n \t\t\t\t}\n \t\t\t}\n \t\t}\ndiff --git a/main/main.cpp b/main/main.cpp\nindex 10064b350376..9a1ab8771245 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -979,7 +979,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \tString project_path = \".\";\n \tbool upwards = false;\n \tString debug_uri = \"\";\n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \tbool test_rd_creation = false;\n \tbool test_rd_support = false;\n #endif\n@@ -1671,7 +1671,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \t\t} else if (arg == \"--debug-stringnames\") {\n \t\t\tStringName::set_debug_stringnames(true);\n #endif\n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \t\t} else if (arg == \"--test-rd-support\") {\n \t\t\ttest_rd_support = true;\n \t\t} else if (arg == \"--test-rd-creation\") {\n@@ -1880,12 +1880,12 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n #endif\n \t}\n \n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \tif (test_rd_support) {\n \t\t// Test Rendering Device creation and exit.\n \n \t\tOS::get_singleton()->set_crash_handler_silent();\n-\t\tif (OS::get_singleton()->_test_create_rendering_device()) {\n+\t\tif (OS::get_singleton()->_test_create_rendering_device(display_driver)) {\n \t\t\texit_err = ERR_HELP;\n \t\t} else {\n \t\t\texit_err = ERR_UNAVAILABLE;\n@@ -1895,7 +1895,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \t\t// Test OpenGL context and Rendering Device simultaneous creation and exit.\n \n \t\tOS::get_singleton()->set_crash_handler_silent();\n-\t\tif (OS::get_singleton()->_test_create_rendering_device_and_gl()) {\n+\t\tif (OS::get_singleton()->_test_create_rendering_device_and_gl(display_driver)) {\n \t\t\texit_err = ERR_HELP;\n \t\t} else {\n \t\t\texit_err = ERR_UNAVAILABLE;\n@@ -4115,6 +4115,7 @@ int Main::start() {\n \t\tif (editor) {\n \t\t\tOS::get_singleton()->benchmark_begin_measure(\"Startup\", \"Editor\");\n \n+\t\t\tsml->get_root()->set_translation_domain(\"godot.editor\");\n \t\t\tif (editor_pseudolocalization) {\n \t\t\t\ttranslation_server->get_editor_domain()->set_pseudolocalization_enabled(true);\n \t\t\t}\n@@ -4312,6 +4313,7 @@ int Main::start() {\n \t\t\tOS::get_singleton()->benchmark_begin_measure(\"Startup\", \"Project Manager\");\n \t\t\tEngine::get_singleton()->set_editor_hint(true);\n \n+\t\t\tsml->get_root()->set_translation_domain(\"godot.editor\");\n \t\t\tif (editor_pseudolocalization) {\n \t\t\t\ttranslation_server->get_editor_domain()->set_pseudolocalization_enabled(true);\n \t\t\t}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.cpp b/modules/jolt_physics/misc/jolt_math_funcs.cpp\nnew file mode 100644\nindex 000000000000..b0ef5f45747d\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.cpp\n@@ -0,0 +1,70 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.cpp                                                   */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+/*\n+Adapted to Godot from the Jolt Physics library.\n+*/\n+\n+/*\n+Copyright 2021 Jorrit Rouwe\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in\n+the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\n+the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR\n+A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n+ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n+*/\n+\n+#include \"jolt_math_funcs.h\"\n+\n+void JoltMath::decompose(Basis &p_basis, Vector3 &r_scale) {\n+\tVector3 x = p_basis.get_column(Vector3::AXIS_X);\n+\tVector3 y = p_basis.get_column(Vector3::AXIS_Y);\n+\tVector3 z = p_basis.get_column(Vector3::AXIS_Z);\n+\n+\tconst real_t x_dot_x = x.dot(x);\n+\ty -= x * (y.dot(x) / x_dot_x);\n+\tz -= x * (z.dot(x) / x_dot_x);\n+\tconst real_t y_dot_y = y.dot(y);\n+\tz -= y * (z.dot(y) / y_dot_y);\n+\tconst real_t z_dot_z = z.dot(z);\n+\n+\tconst real_t det = x.cross(y).dot(z);\n+\n+\tr_scale = SIGN(det) * Vector3(Math::sqrt(x_dot_x), Math::sqrt(y_dot_y), Math::sqrt(z_dot_z));\n+\n+\tp_basis.set_column(Vector3::AXIS_X, x / r_scale.x);\n+\tp_basis.set_column(Vector3::AXIS_Y, y / r_scale.y);\n+\tp_basis.set_column(Vector3::AXIS_Z, z / r_scale.z);\n+}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.h b/modules/jolt_physics/misc/jolt_math_funcs.h\nnew file mode 100644\nindex 000000000000..ba2d290ac77c\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.h\n@@ -0,0 +1,59 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.h                                                     */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef JOLT_MATH_FUNCS_H\n+#define JOLT_MATH_FUNCS_H\n+\n+#include \"core/math/transform_3d.h\"\n+\n+class JoltMath {\n+public:\n+\t// Note that `p_basis` is mutated to be right-handed orthonormal.\n+\tstatic void decompose(Basis &p_basis, Vector3 &r_scale);\n+\n+\t// Note that `p_transform` is mutated to be right-handed orthonormal.\n+\tstatic _FORCE_INLINE_ void decompose(Transform3D &p_transform, Vector3 &r_scale) {\n+\t\tdecompose(p_transform.basis, r_scale);\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Basis &p_basis, Basis &r_new_basis, Vector3 &r_scale) {\n+\t\tBasis new_basis = p_basis;\n+\t\tdecompose(new_basis, r_scale);\n+\t\tr_new_basis = new_basis;\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Transform3D &p_transform, Transform3D &r_new_transform, Vector3 &r_scale) {\n+\t\tTransform3D new_transform;\n+\t\tdecompose(new_transform, r_scale);\n+\t\tr_new_transform = new_transform;\n+\t}\n+};\n+\n+#endif // JOLT_MATH_FUNCS_H\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex b0a9ffd62225..0a2693ddb634 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -31,6 +31,7 @@\n #include \"jolt_area_3d.h\"\n \n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -370,7 +371,8 @@ void JoltArea3D::set_default_area(bool p_value) {\n void JoltArea3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to area '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -378,8 +380,6 @@ void JoltArea3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex ac2b37470ef1..5bc3aee1bce7 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../joints/jolt_joint_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -543,7 +544,8 @@ JoltBody3D::~JoltBody3D() {\n void JoltBody3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to physics body '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -551,8 +553,6 @@ void JoltBody3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex bfe77e008d59..f32ddad0d469 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_shaped_object_3d.h\"\n \n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_custom_double_sided_shape.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n@@ -347,7 +348,10 @@ void JoltShapedObject3D::commit_shapes(bool p_optimize_compound) {\n void JoltShapedObject3D::add_shape(JoltShape3D *p_shape, Transform3D p_transform, bool p_disabled) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed when adding shape at index %d to physics body '%s'.\", shapes.size(), to_string()));\n \n-\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform.orthonormalized(), p_transform.basis.get_scale(), p_disabled));\n+\tVector3 shape_scale;\n+\tJoltMath::decompose(p_transform, shape_scale);\n+\n+\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform, shape_scale, p_disabled));\n \n \t_shapes_changed();\n }\n@@ -430,8 +434,8 @@ void JoltShapedObject3D::set_shape_transform(int p_index, Transform3D p_transfor\n \tERR_FAIL_INDEX(p_index, (int)shapes.size());\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, \"Failed to correctly set transform for shape at index %d in body '%s'.\");\n \n-\tVector3 new_scale = p_transform.basis.get_scale();\n-\tp_transform.basis.orthonormalize();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \tJoltShapeInstance3D &shape = shapes[p_index];\n \ndiff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex 3852e42d51f2..d7a4afec57ba 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../objects/jolt_area_3d.h\"\n #include \"../objects/jolt_body_3d.h\"\n@@ -288,11 +289,10 @@ bool JoltPhysicsDirectSpaceState3D::_body_motion_cast(const JoltBody3D &p_body,\n \t\tconst Transform3D transform_com_local = transform_local.translated_local(com_scaled);\n \t\tTransform3D transform_com = body_transform * transform_com_local;\n \n-\t\tVector3 scale = transform_com.basis.get_scale();\n+\t\tVector3 scale;\n+\t\tJoltMath::decompose(transform_com, scale);\n \t\tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"body_test_motion was passed an invalid transform along with body '%s'. This results in invalid scaling for shape at index %d.\");\n \n-\t\ttransform_com.basis.orthonormalize();\n-\n \t\treal_t shape_safe_fraction = 1.0;\n \t\treal_t shape_unsafe_fraction = 1.0;\n \n@@ -590,11 +590,10 @@ int JoltPhysicsDirectSpaceState3D::intersect_shape(const ShapeParameters &p_para\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"intersect_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"intersect_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -647,11 +646,10 @@ bool JoltPhysicsDirectSpaceState3D::cast_motion(const ShapeParameters &p_paramet\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tTransform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -684,11 +682,10 @@ bool JoltPhysicsDirectSpaceState3D::collide_shape(const ShapeParameters &p_param\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"collide_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"collide_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -754,11 +751,10 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -890,8 +886,8 @@ bool JoltPhysicsDirectSpaceState3D::body_test_motion(const JoltBody3D &p_body, c\n \tTransform3D transform = p_parameters.from;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, vformat(\"body_test_motion (maybe from move_and_slide?) was passed an invalid transform along with body '%s'.\", p_body.to_string()));\n \n-\tVector3 scale = transform.basis.get_scale();\n-\ttransform.basis.orthonormalize();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \n \tspace->try_optimize();\n \ndiff --git a/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs b/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\nindex 7a07e0a97539..22420e2b63ca 100644\n--- a/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\n+++ b/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\n@@ -191,6 +191,13 @@ private static void EnsureTargetFrameworkMatchesMinimumRequirement(MSBuildProjec\n                 // Otherwise, it can be removed.\n                 if (mainTfmVersion > minTfmVersion)\n                 {\n+                    var propertyTfmVersion = NuGetFramework.Parse(property.Value).Version;\n+                    if (propertyTfmVersion == minTfmVersion)\n+                    {\n+                        // The 'TargetFramework' property already matches the minimum version.\n+                        continue;\n+                    }\n+\n                     property.Value = minTfmValue;\n                 }\n                 else\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\nindex dda776fee5f5..cb180f9a8b3f 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\n@@ -455,6 +455,12 @@ public readonly IntPtr Object\n             get => _data._m_obj_data.obj;\n         }\n \n+        public readonly ulong ObjectId\n+        {\n+            [MethodImpl(MethodImplOptions.AggressiveInlining)]\n+            get => _data._m_obj_data.id;\n+        }\n+\n         public void Dispose()\n         {\n             switch (Type)\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\nindex a48e60a30f60..9e5df0fa5c31 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\n@@ -485,7 +485,14 @@ public static Rid ConvertToRid(in godot_variant p_var)\n                 NativeFuncs.godotsharp_variant_as_rid(p_var);\n \n         public static IntPtr ConvertToGodotObjectPtr(in godot_variant p_var)\n-            => p_var.Type == Variant.Type.Object ? p_var.Object : IntPtr.Zero;\n+        {\n+            if (p_var.Type != Variant.Type.Object || p_var.ObjectId == 0)\n+            {\n+                return IntPtr.Zero;\n+            }\n+\n+            return NativeFuncs.godotsharp_instance_from_id(p_var.ObjectId);\n+        }\n \n         [MethodImpl(MethodImplOptions.AggressiveInlining)]\n         public static GodotObject ConvertToGodotObject(in godot_variant p_var)\ndiff --git a/modules/multiplayer/editor/editor_network_profiler.cpp b/modules/multiplayer/editor/editor_network_profiler.cpp\nindex 1f9444ed72b7..5a2611added9 100644\n--- a/modules/multiplayer/editor/editor_network_profiler.cpp\n+++ b/modules/multiplayer/editor/editor_network_profiler.cpp\n@@ -35,6 +35,7 @@\n #include \"editor/gui/editor_run_bar.h\"\n #include \"editor/themes/editor_scale.h\"\n #include \"scene/gui/check_box.h\"\n+#include \"scene/gui/flow_container.h\"\n \n void EditorNetworkProfiler::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"enable_profiling\", PropertyInfo(Variant::BOOL, \"enable\")));\n@@ -297,30 +298,37 @@ bool EditorNetworkProfiler::is_profiling() {\n }\n \n EditorNetworkProfiler::EditorNetworkProfiler() {\n-\tHBoxContainer *hb = memnew(HBoxContainer);\n-\thb->add_theme_constant_override(\"separation\", 8 * EDSCALE);\n-\tadd_child(hb);\n+\tFlowContainer *container = memnew(FlowContainer);\n+\tcontainer->add_theme_constant_override(SNAME(\"h_separation\"), 8 * EDSCALE);\n+\tcontainer->add_theme_constant_override(SNAME(\"v_separation\"), 2 * EDSCALE);\n+\tadd_child(container);\n \n \tactivate = memnew(Button);\n \tactivate->set_toggle_mode(true);\n \tactivate->set_text(TTR(\"Start\"));\n \tactivate->set_disabled(true);\n \tactivate->connect(SceneStringName(pressed), callable_mp(this, &EditorNetworkProfiler::_activate_pressed));\n-\thb->add_child(activate);\n+\tcontainer->add_child(activate);\n \n \tclear_button = memnew(Button);\n \tclear_button->set_text(TTR(\"Clear\"));\n \tclear_button->set_disabled(true);\n \tclear_button->connect(SceneStringName(pressed), callable_mp(this, &EditorNetworkProfiler::_clear_pressed));\n-\thb->add_child(clear_button);\n+\tcontainer->add_child(clear_button);\n \n \tCheckBox *autostart_checkbox = memnew(CheckBox);\n \tautostart_checkbox->set_text(TTR(\"Autostart\"));\n \tautostart_checkbox->set_pressed(EditorSettings::get_singleton()->get_project_metadata(\"debug_options\", \"autostart_network_profiler\", false));\n \tautostart_checkbox->connect(SceneStringName(toggled), callable_mp(this, &EditorNetworkProfiler::_autostart_toggled));\n-\thb->add_child(autostart_checkbox);\n+\tcontainer->add_child(autostart_checkbox);\n+\n+\tControl *c = memnew(Control);\n+\tc->set_h_size_flags(SIZE_EXPAND_FILL);\n+\tcontainer->add_child(c);\n \n-\thb->add_spacer();\n+\tHBoxContainer *hb = memnew(HBoxContainer);\n+\thb->add_theme_constant_override(SNAME(\"separation\"), 8 * EDSCALE);\n+\tcontainer->add_child(hb);\n \n \tLabel *lb = memnew(Label);\n \t// TRANSLATORS: This is the label for the network profiler's incoming bandwidth.\n@@ -359,7 +367,7 @@ EditorNetworkProfiler::EditorNetworkProfiler() {\n \n \t// RPC\n \tcounters_display = memnew(Tree);\n-\tcounters_display->set_custom_minimum_size(Size2(320, 0) * EDSCALE);\n+\tcounters_display->set_custom_minimum_size(Size2(280, 0) * EDSCALE);\n \tcounters_display->set_v_size_flags(SIZE_EXPAND_FILL);\n \tcounters_display->set_h_size_flags(SIZE_EXPAND_FILL);\n \tcounters_display->set_hide_folding(true);\n@@ -382,7 +390,7 @@ EditorNetworkProfiler::EditorNetworkProfiler() {\n \n \t// Replication\n \treplication_display = memnew(Tree);\n-\treplication_display->set_custom_minimum_size(Size2(320, 0) * EDSCALE);\n+\treplication_display->set_custom_minimum_size(Size2(280, 0) * EDSCALE);\n \treplication_display->set_v_size_flags(SIZE_EXPAND_FILL);\n \treplication_display->set_h_size_flags(SIZE_EXPAND_FILL);\n \treplication_display->set_hide_folding(true);\ndiff --git a/modules/openxr/extensions/platform/openxr_opengl_extension.cpp b/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\nindex c4a05220115b..08b3afb0192e 100644\n--- a/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\n+++ b/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\n@@ -141,7 +141,12 @@ XrGraphicsBindingEGLMNDX OpenXROpenGLExtension::graphics_binding_egl;\n #endif\n \n void *OpenXROpenGLExtension::set_session_create_and_get_next_pointer(void *p_next_pointer) {\n-\tXrVersion desired_version = XR_MAKE_VERSION(3, 3, 0);\n+\tGLint gl_version_major = 0;\n+\tGLint gl_version_minor = 0;\n+\tglGetIntegerv(GL_MAJOR_VERSION, &gl_version_major);\n+\tglGetIntegerv(GL_MINOR_VERSION, &gl_version_minor);\n+\n+\tXrVersion desired_version = XR_MAKE_VERSION(gl_version_major, gl_version_minor, 0);\n \n \tif (!check_graphics_api_support(desired_version)) {\n \t\tprint_line(\"OpenXR: Trying to initialize with OpenGL anyway...\");\ndiff --git a/modules/openxr/register_types.cpp b/modules/openxr/register_types.cpp\nindex 69c119d069e3..785de3d6210b 100644\n--- a/modules/openxr/register_types.cpp\n+++ b/modules/openxr/register_types.cpp\n@@ -225,10 +225,16 @@ void initialize_openxr_module(ModuleInitializationLevel p_level) {\n \t\t}\n \n #ifdef TOOLS_ENABLED\n+\t\t// Register as \"editor\", not \"core\".\n+\t\tClassDB::APIType prev_api = ClassDB::get_current_api();\n+\t\tClassDB::set_current_api(ClassDB::API_EDITOR);\n+\n \t\tGDREGISTER_ABSTRACT_CLASS(OpenXRInteractionProfileEditorBase);\n \t\tGDREGISTER_CLASS(OpenXRInteractionProfileEditor);\n \t\tGDREGISTER_CLASS(OpenXRBindingModifierEditor);\n \n+\t\tClassDB::set_current_api(prev_api);\n+\n \t\tEditorNode::add_init_callback(_editor_init);\n #endif\n \t}\ndiff --git a/modules/text_server_adv/text_server_adv.cpp b/modules/text_server_adv/text_server_adv.cpp\nindex 52a61cd92446..71bded1ff1d5 100644\n--- a/modules/text_server_adv/text_server_adv.cpp\n+++ b/modules/text_server_adv/text_server_adv.cpp\n@@ -1318,11 +1318,12 @@ _FORCE_INLINE_ bool TextServerAdvanced::_ensure_glyph(FontAdvanced *p_font_data,\n \t\t\t} break;\n \t\t}\n \n+\t\tFT_GlyphSlot slot = fd->face->glyph;\n+\t\tbool from_svg = (slot->format == FT_GLYPH_FORMAT_SVG); // Need to check before FT_Render_Glyph as it will change format to bitmap.\n \t\tif (!outline) {\n \t\t\tif (!p_font_data->msdf) {\n-\t\t\t\terror = FT_Render_Glyph(fd->face->glyph, aa_mode);\n+\t\t\t\terror = FT_Render_Glyph(slot, aa_mode);\n \t\t\t}\n-\t\t\tFT_GlyphSlot slot = fd->face->glyph;\n \t\t\tif (!error) {\n \t\t\t\tif (p_font_data->msdf) {\n #ifdef MODULE_MSDFGEN_ENABLED\n@@ -1363,6 +1364,7 @@ _FORCE_INLINE_ bool TextServerAdvanced::_ensure_glyph(FontAdvanced *p_font_data,\n \t\tcleanup_stroker:\n \t\t\tFT_Stroker_Done(stroker);\n \t\t}\n+\t\tgl.from_svg = from_svg;\n \t\tE = fd->glyph_map.insert(p_glyph, gl);\n \t\tr_glyph = E->value;\n \t\treturn gl.found;\n@@ -3312,6 +3314,10 @@ RID TextServerAdvanced::_font_get_glyph_texture_rid(const RID &p_font_rid, const\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -3360,6 +3366,10 @@ Size2 TextServerAdvanced::_font_get_glyph_texture_size(const RID &p_font_rid, co\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -3798,7 +3808,7 @@ void TextServerAdvanced::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\tif (fgl.texture_idx != -1) {\n \t\t\tColor modulate = p_color;\n #ifdef MODULE_FREETYPE_ENABLED\n-\t\t\tif (ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n+\t\t\tif (!fgl.from_svg && ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n \t\t\t\tmodulate.r = modulate.g = modulate.b = 1.0;\n \t\t\t}\n #endif\n@@ -3806,6 +3816,10 @@ void TextServerAdvanced::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t\t}\n \t\t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\t\timg->generate_mipmaps();\ndiff --git a/modules/text_server_adv/text_server_adv.h b/modules/text_server_adv/text_server_adv.h\nindex 6561667e80e6..981cb277f70d 100644\n--- a/modules/text_server_adv/text_server_adv.h\n+++ b/modules/text_server_adv/text_server_adv.h\n@@ -272,6 +272,7 @@ class TextServerAdvanced : public TextServerExtension {\n \t\tRect2 rect;\n \t\tRect2 uv_rect;\n \t\tVector2 advance;\n+\t\tbool from_svg = false;\n \t};\n \n \tstruct FontForSizeAdvanced {\ndiff --git a/modules/text_server_fb/text_server_fb.cpp b/modules/text_server_fb/text_server_fb.cpp\nindex 8ca81368436f..c70f5e00d113 100644\n--- a/modules/text_server_fb/text_server_fb.cpp\n+++ b/modules/text_server_fb/text_server_fb.cpp\n@@ -741,11 +741,12 @@ _FORCE_INLINE_ bool TextServerFallback::_ensure_glyph(FontFallback *p_font_data,\n \t\t\t} break;\n \t\t}\n \n+\t\tFT_GlyphSlot slot = fd->face->glyph;\n+\t\tbool from_svg = (slot->format == FT_GLYPH_FORMAT_SVG); // Need to check before FT_Render_Glyph as it will change format to bitmap.\n \t\tif (!outline) {\n \t\t\tif (!p_font_data->msdf) {\n-\t\t\t\terror = FT_Render_Glyph(fd->face->glyph, aa_mode);\n+\t\t\t\terror = FT_Render_Glyph(slot, aa_mode);\n \t\t\t}\n-\t\t\tFT_GlyphSlot slot = fd->face->glyph;\n \t\t\tif (!error) {\n \t\t\t\tif (p_font_data->msdf) {\n #ifdef MODULE_MSDFGEN_ENABLED\n@@ -786,6 +787,7 @@ _FORCE_INLINE_ bool TextServerFallback::_ensure_glyph(FontFallback *p_font_data,\n \t\tcleanup_stroker:\n \t\t\tFT_Stroker_Done(stroker);\n \t\t}\n+\t\tgl.from_svg = from_svg;\n \t\tE = fd->glyph_map.insert(p_glyph, gl);\n \t\tr_glyph = E->value;\n \t\treturn gl.found;\n@@ -2290,6 +2292,10 @@ RID TextServerFallback::_font_get_glyph_texture_rid(const RID &p_font_rid, const\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -2338,6 +2344,10 @@ Size2 TextServerFallback::_font_get_glyph_texture_size(const RID &p_font_rid, co\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -2729,7 +2739,7 @@ void TextServerFallback::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\tif (fgl.texture_idx != -1) {\n \t\t\tColor modulate = p_color;\n #ifdef MODULE_FREETYPE_ENABLED\n-\t\t\tif (ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n+\t\t\tif (!fgl.from_svg && ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n \t\t\t\tmodulate.r = modulate.g = modulate.b = 1.0;\n \t\t\t}\n #endif\n@@ -2737,6 +2747,10 @@ void TextServerFallback::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t\t}\n \t\t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\t\timg->generate_mipmaps();\ndiff --git a/modules/text_server_fb/text_server_fb.h b/modules/text_server_fb/text_server_fb.h\nindex b66f7189bee0..3338a8a62b1b 100644\n--- a/modules/text_server_fb/text_server_fb.h\n+++ b/modules/text_server_fb/text_server_fb.h\n@@ -219,6 +219,7 @@ class TextServerFallback : public TextServerExtension {\n \t\tRect2 rect;\n \t\tRect2 uv_rect;\n \t\tVector2 advance;\n+\t\tbool from_svg = false;\n \t};\n \n \tstruct FontForSizeFallback {\ndiff --git a/platform/android/README.md b/platform/android/README.md\nindex 01eb9c03a664..4a08bb524180 100644\n--- a/platform/android/README.md\n+++ b/platform/android/README.md\n@@ -12,7 +12,7 @@ using [Gradle](https://gradle.org/) as a build system.\n \n ## Artwork license\n \n-[`logo.png`](logo.png) and [`run_icon.png`](run_icon.png) are licensed under\n+[`logo.svg`](export/logo.svg) and [`run_icon.svg`](export/run_icon.svg) are licensed under\n [Creative Commons Attribution 3.0 Unported](https://developer.android.com/distribute/marketing-tools/brand-guidelines#android_robot)\n per the Android logo usage guidelines:\n \ndiff --git a/platform/android/android_input_handler.cpp b/platform/android/android_input_handler.cpp\nindex 9a5af7a349dd..859f4c3c1b3e 100644\n--- a/platform/android/android_input_handler.cpp\n+++ b/platform/android/android_input_handler.cpp\n@@ -337,7 +337,7 @@ void AndroidInputHandler::process_mouse_event(int p_event_action, int p_event_an\n \t\t} break;\n \n \t\tcase AMOTION_EVENT_ACTION_MOVE: {\n-\t\t\tif (!mouse_event_info.valid) {\n+\t\t\tif (!p_source_mouse_relative && !mouse_event_info.valid) {\n \t\t\t\treturn;\n \t\t\t}\n \ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 571cfd9819c0..cac7c3f48d4e 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -187,7 +187,7 @@ def configure(env: \"SConsEnvironment\"):\n     has_swappy = detect_swappy()\n     if not has_swappy:\n         print_warning(\n-            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/darksylinc/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n+            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/godotengine/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n             + \" thirdparty/swappy-frame-pacing/arm64-v8a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/armeabi-v7a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/x86/libswappy_static.a\\n\"\ndiff --git a/platform/android/java/app/AndroidManifest.xml b/platform/android/java/app/AndroidManifest.xml\nindex 60ce75fd16e2..1d59d15d560f 100644\n--- a/platform/android/java/app/AndroidManifest.xml\n+++ b/platform/android/java/app/AndroidManifest.xml\n@@ -46,7 +46,7 @@\n             android:excludeFromRecents=\"false\"\n             android:exported=\"true\"\n             android:screenOrientation=\"landscape\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:resizeableActivity=\"false\"\n             tools:ignore=\"UnusedAttribute\" >\n \ndiff --git a/platform/android/java/editor/src/main/AndroidManifest.xml b/platform/android/java/editor/src/main/AndroidManifest.xml\nindex a1971554bf7d..b136e348b2c7 100644\n--- a/platform/android/java/editor/src/main/AndroidManifest.xml\n+++ b/platform/android/java/editor/src/main/AndroidManifest.xml\n@@ -41,7 +41,7 @@\n \n         <activity\n             android:name=\".GodotEditor\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"true\"\n             android:icon=\"@mipmap/themed_icon\"\n             android:launchMode=\"singleTask\"\n@@ -59,7 +59,7 @@\n         </activity>\n         <activity\n             android:name=\".GodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -74,7 +74,7 @@\n         </activity>\n         <activity\n             android:name=\".embed.EmbeddedGodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -87,7 +87,7 @@\n             android:screenOrientation=\"userLandscape\" />\n         <activity\n             android:name=\".GodotXRGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:process=\":GodotXRGame\"\n             android:launchMode=\"singleTask\"\n             android:icon=\"@mipmap/ic_play_window\"\ndiff --git a/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java b/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\nindex 6f036c15a32a..d9d1cedc6a0f 100644\n--- a/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\n+++ b/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\n@@ -59,6 +59,7 @@\n import java.util.Collections;\n import java.util.HashSet;\n import java.util.Set;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /**\n  * Handles input related events for the {@link GodotRenderView} view.\n@@ -83,7 +84,7 @@ public class GodotInputHandler implements InputManager.InputDeviceListener, Sens\n \t/**\n \t * Used to decide whether mouse capture can be enabled.\n \t */\n-\tprivate int lastSeenToolType = MotionEvent.TOOL_TYPE_UNKNOWN;\n+\tprivate AtomicInteger lastSeenToolType = new AtomicInteger(MotionEvent.TOOL_TYPE_UNKNOWN);\n \n \tprivate int rotaryInputAxis = ROTARY_INPUT_VERTICAL_AXIS;\n \n@@ -149,7 +150,8 @@ private boolean isKeyEventGameDevice(int source) {\n \t}\n \n \tpublic boolean canCapturePointer() {\n-\t\treturn lastSeenToolType == MotionEvent.TOOL_TYPE_MOUSE;\n+\t\treturn lastSeenToolType.get() == MotionEvent.TOOL_TYPE_MOUSE ||\n+\t\t\t\tlastSeenToolType.get() == MotionEvent.TOOL_TYPE_UNKNOWN;\n \t}\n \n \tpublic void onPointerCaptureChange(boolean hasCapture) {\n@@ -210,7 +212,7 @@ public boolean onKeyDown(final int keyCode, KeyEvent event) {\n \t}\n \n \tpublic boolean onTouchEvent(final MotionEvent event) {\n-\t\tlastSeenToolType = getEventToolType(event);\n+\t\tlastSeenToolType.set(getEventToolType(event));\n \n \t\tthis.scaleGestureDetector.onTouchEvent(event);\n \t\tif (this.gestureDetector.onTouchEvent(event)) {\n@@ -236,7 +238,7 @@ public boolean onTouchEvent(final MotionEvent event) {\n \t}\n \n \tpublic boolean onGenericMotionEvent(MotionEvent event) {\n-\t\tlastSeenToolType = getEventToolType(event);\n+\t\tlastSeenToolType.set(getEventToolType(event));\n \n \t\tif (event.isFromSource(InputDevice.SOURCE_JOYSTICK) && event.getActionMasked() == MotionEvent.ACTION_MOVE) {\n \t\t\t// Check if the device exists\ndiff --git a/platform/android/java_class_wrapper.cpp b/platform/android/java_class_wrapper.cpp\nindex c19196ae8713..4980258d9898 100644\n--- a/platform/android/java_class_wrapper.cpp\n+++ b/platform/android/java_class_wrapper.cpp\n@@ -108,18 +108,21 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\t\t}\n \t\t\t\t} break;\n \t\t\t\tcase ARG_TYPE_CLASS: {\n-\t\t\t\t\tif (p_args[i]->get_type() != Variant::OBJECT && p_args[i]->get_type() != Variant::NIL) {\n+\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n+\t\t\t\t\tif (cn.begins_with(\"L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\t\tcn = cn.substr(1, cn.length() - 2);\n+\t\t\t\t\t}\n+\t\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\") {\n+\t\t\t\t\t\tif (p_args[i]->get_type() != Variant::DICTIONARY) {\n+\t\t\t\t\t\t\targ_expected = Variant::DICTIONARY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::OBJECT && p_args[i]->get_type() != Variant::NIL) {\n \t\t\t\t\t\targ_expected = Variant::OBJECT;\n \t\t\t\t\t} else {\n \t\t\t\t\t\tRef<RefCounted> ref = *p_args[i];\n \t\t\t\t\t\tif (ref.is_valid()) {\n \t\t\t\t\t\t\tif (Object::cast_to<JavaObject>(ref.ptr())) {\n \t\t\t\t\t\t\t\tRef<JavaObject> jo = ref;\n-\t\t\t\t\t\t\t\t//could be faster\n-\t\t\t\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n-\t\t\t\t\t\t\t\tif (cn.begins_with(\"L\") && cn.ends_with(\";\")) {\n-\t\t\t\t\t\t\t\t\tcn = cn.substr(1, cn.length() - 2);\n-\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n \t\t\t\t\t\t\t\tif (!c || !env->IsInstanceOf(jo->instance, c)) {\n \t\t\t\t\t\t\t\t\targ_expected = Variant::OBJECT;\n@@ -132,6 +135,116 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BOOLEAN: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::BOOL) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n+\t\t\t\t\tif (p_args[i]->get_type() != Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::PACKED_BYTE_ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::INT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::INT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_INT64_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::FLOAT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_FLOAT32_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::FLOAT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_FLOAT64_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::STRING) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_STRING_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CALLABLE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::CALLABLE) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::OBJECT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n+\t\t\t\t\t\t\tif (cn.begins_with(\"[L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\t\t\t\tcn = cn.substr(2, cn.length() - 3);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n+\t\t\t\t\t\t\tif (c) {\n+\t\t\t\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\t\t\t\tRef<JavaObject> jo = arr[j];\n+\t\t\t\t\t\t\t\t\tif (jo.is_valid()) {\n+\t\t\t\t\t\t\t\t\t\tif (!env->IsInstanceOf(jo->instance, c)) {\n+\t\t\t\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n \t\t\t\tdefault: {\n \t\t\t\t\tif (p_args[i]->get_type() != Variant::ARRAY) {\n \t\t\t\t\t\targ_expected = Variant::ARRAY;\n@@ -287,13 +400,16 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\tto_free.push_back(jcallable);\n \t\t\t} break;\n \t\t\tcase ARG_TYPE_CLASS: {\n-\t\t\t\tRef<JavaObject> jo = *p_args[i];\n-\t\t\t\tif (jo.is_valid()) {\n-\t\t\t\t\targv[i].l = jo->instance;\n+\t\t\t\tif (p_args[i]->get_type() == Variant::DICTIONARY) {\n+\t\t\t\t\targv[i].l = _variant_to_jvalue(env, Variant::DICTIONARY, p_args[i]).obj;\n \t\t\t\t} else {\n-\t\t\t\t\targv[i].l = nullptr; //I hope this works\n+\t\t\t\t\tRef<JavaObject> jo = *p_args[i];\n+\t\t\t\t\tif (jo.is_valid()) {\n+\t\t\t\t\t\targv[i].l = jo->instance;\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targv[i].l = nullptr; //I hope this works\n+\t\t\t\t\t}\n \t\t\t\t}\n-\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BOOLEAN: {\n \t\t\t\tArray arr = *p_args[i];\n@@ -307,90 +423,171 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjbyteArray a = env->NewByteArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjbyte val = arr[j];\n-\t\t\t\t\tenv->SetByteArrayRegion(a, j, 1, &val);\n+\t\t\t\tjbyteArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewByteArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjbyte val = arr[j];\n+\t\t\t\t\t\tenv->SetByteArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\tPackedByteArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewByteArray(arr.size());\n+\t\t\t\t\tenv->SetByteArrayRegion(a, 0, arr.size(), (const jbyte *)arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjcharArray a = env->NewCharArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjchar val = arr[j];\n-\t\t\t\t\tenv->SetCharArrayRegion(a, j, 1, &val);\n+\t\t\t\tjcharArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewCharArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjchar val = arr[j];\n+\t\t\t\t\t\tenv->SetCharArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\tPackedByteArray arr = *p_args[i];\n+\t\t\t\t\t// The data is expected to be UTF-16 encoded, so the length is half the size of the byte array.\n+\t\t\t\t\tint size = arr.size() / 2;\n+\t\t\t\t\ta = env->NewCharArray(size);\n+\t\t\t\t\tenv->SetCharArrayRegion(a, 0, size, (const jchar *)arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjshortArray a = env->NewShortArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjshort val = arr[j];\n-\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\tjshortArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewShortArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjshort val = arr[j];\n+\t\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\tPackedInt32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewShortArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjshort val = arr[j];\n+\t\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjintArray a = env->NewIntArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjint val = arr[j];\n-\t\t\t\t\tenv->SetIntArrayRegion(a, j, 1, &val);\n+\t\t\t\tjintArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewIntArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjint val = arr[j];\n+\t\t\t\t\t\tenv->SetIntArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\tPackedInt32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewIntArray(arr.size());\n+\t\t\t\t\tenv->SetIntArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjlongArray a = env->NewLongArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjlong val = (int64_t)arr[j];\n-\t\t\t\t\tenv->SetLongArrayRegion(a, j, 1, &val);\n+\t\t\t\tjlongArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewLongArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjlong val = (int64_t)arr[j];\n+\t\t\t\t\t\tenv->SetLongArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT64_ARRAY) {\n+\t\t\t\t\tPackedInt64Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewLongArray(arr.size());\n+\t\t\t\t\tenv->SetLongArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjfloatArray a = env->NewFloatArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjfloat val = arr[j];\n-\t\t\t\t\tenv->SetFloatArrayRegion(a, j, 1, &val);\n+\t\t\t\tjfloatArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewFloatArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjfloat val = arr[j];\n+\t\t\t\t\t\tenv->SetFloatArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_FLOAT32_ARRAY) {\n+\t\t\t\t\tPackedFloat32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewFloatArray(arr.size());\n+\t\t\t\t\tenv->SetFloatArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjdoubleArray a = env->NewDoubleArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjdouble val = arr[j];\n-\t\t\t\t\tenv->SetDoubleArrayRegion(a, j, 1, &val);\n+\t\t\t\tjdoubleArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewDoubleArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjdouble val = arr[j];\n+\t\t\t\t\t\tenv->SetDoubleArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_FLOAT64_ARRAY) {\n+\t\t\t\t\tPackedFloat64Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewDoubleArray(arr.size());\n+\t\t\t\t\tenv->SetDoubleArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING:\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjobjectArray a = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tString s = arr[j];\n-\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n-\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n-\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\tjobjectArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tString s = arr[j];\n+\t\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n+\t\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n+\t\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_STRING_ARRAY) {\n+\t\t\t\t\tPackedStringArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tString s = arr[j];\n+\t\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n+\t\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n+\t\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\targv[i].l = a;\n@@ -410,7 +607,22 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\tto_free.push_back(jarr);\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n-\t\t\t\targv[i].l = nullptr;\n+\t\t\t\tString cn = method->param_sigs[i].operator String();\n+\t\t\t\tif (cn.begins_with(\"[L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\tcn = cn.substr(2, cn.length() - 3);\n+\t\t\t\t}\n+\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n+\t\t\t\tif (c) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\tjobjectArray jarr = env->NewObjectArray(arr.size(), c, nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tRef<JavaObject> jo = arr[j];\n+\t\t\t\t\t\tenv->SetObjectArrayElement(jarr, j, jo->instance);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\targv[i].l = jarr;\n+\t\t\t\t\tto_free.push_back(jarr);\n+\t\t\t\t}\n \t\t\t} break;\n \t\t}\n \t}\n@@ -865,8 +1077,13 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tenv->DeleteLocalRef(java_class);\n \n \t\t\tif (java_class_wrapped.is_valid()) {\n-\t\t\t\tRef<JavaObject> ret = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n-\t\t\t\tvar = ret;\n+\t\t\t\tString cn = java_class_wrapped->get_java_class_name();\n+\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\" || cn == \"java.util.HashMap\") {\n+\t\t\t\t\tvar = _jobject_to_variant(env, obj);\n+\t\t\t\t} else {\n+\t\t\t\t\tRef<JavaObject> ret = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n+\t\t\t\t\tvar = ret;\n+\t\t\t\t}\n \t\t\t\treturn true;\n \t\t\t}\n \n@@ -881,11 +1098,12 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjboolean val;\n-\t\t\t\tenv->GetBooleanArrayRegion((jbooleanArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n+\t\t\t\tenv->GetBooleanArrayRegion((jbooleanArray)arr, i, 1, &val);\n+\t\t\t\tret[i] = (bool)val;\n \t\t\t}\n \n \t\t\tvar = ret;\n@@ -893,106 +1111,85 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjbyte val;\n-\t\t\t\tenv->GetByteArrayRegion((jbyteArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetByteArrayRegion((jbyteArray)arr, 0, count, (int8_t *)ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjchar val;\n-\t\t\t\tenv->GetCharArrayRegion((jcharArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\t// Char arrays are UTF-16 encoded, so it's double the length.\n+\t\t\tret.resize(count * 2);\n+\t\t\tenv->GetCharArrayRegion((jcharArray)arr, 0, count, (jchar *)ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjshort val;\n-\t\t\t\tenv->GetShortArrayRegion((jshortArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n+\t\t\t\tenv->GetShortArrayRegion((jshortArray)arr, i, 1, &val);\n+\t\t\t\tptr[i] = val;\n \t\t\t}\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjint val;\n-\t\t\t\tenv->GetIntArrayRegion((jintArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetIntArrayRegion((jintArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjlong val;\n-\t\t\t\tenv->GetLongArrayRegion((jlongArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back((int64_t)val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetLongArrayRegion((jlongArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjfloat val;\n-\t\t\t\tenv->GetFloatArrayRegion((jfloatArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetFloatArrayRegion((jfloatArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjdouble val;\n-\t\t\t\tenv->GetDoubleArrayRegion((jdoubleArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetDoubleArrayRegion((jdoubleArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n@@ -1002,14 +1199,13 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tbool val = env->CallBooleanMethod(o, JavaClassWrapper::singleton->Boolean_booleanValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tret[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1019,18 +1215,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tuint8_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallByteMethod(o, JavaClassWrapper::singleton->Byte_byteValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = (uint8_t)val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1039,18 +1237,22 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\t// Char arrays are UTF-16 encoded, so it's double the length.\n+\t\t\tret.resize(count * 2);\n \n+\t\t\tjchar *ptr = (jchar *)ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tcount = i;\n+\t\t\t\t\tbreak;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallCharMethod(o, JavaClassWrapper::singleton->Character_characterValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = (jchar)val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1059,18 +1261,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallShortMethod(o, JavaClassWrapper::singleton->Short_shortValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1079,18 +1283,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallIntMethod(o, JavaClassWrapper::singleton->Integer_integerValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1099,18 +1305,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint64_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint64_t val = env->CallLongMethod(o, JavaClassWrapper::singleton->Long_longValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1119,18 +1327,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tfloat *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0.0;\n \t\t\t\t} else {\n \t\t\t\t\tfloat val = env->CallFloatMethod(o, JavaClassWrapper::singleton->Float_floatValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1139,18 +1349,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tdouble *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0.0;\n \t\t\t\t} else {\n \t\t\t\t\tdouble val = env->CallDoubleMethod(o, JavaClassWrapper::singleton->Double_doubleValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1160,18 +1372,18 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t} break;\n \n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING: {\n-\t\t\tArray ret;\n+\t\t\tPackedStringArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tString *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tString val = jstring_to_string((jstring)o, env);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1180,18 +1392,18 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n-\t\t\tArray ret;\n+\t\t\tPackedStringArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tString *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tString val = charsequence_to_string(env, o);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1203,13 +1415,12 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tArray ret;\n \t\t\tjobjectArray jarr = (jobjectArray)obj;\n \t\t\tint count = env->GetArrayLength(jarr);\n+\t\t\tret.resize(count);\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(jarr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tCallable callable = jcallable_to_callable(env, o);\n-\t\t\t\t\tret.push_back(callable);\n+\t\t\t\t\tret[i] = callable;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1218,6 +1429,32 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n+\t\t\tArray ret;\n+\t\t\tjobjectArray jarr = (jobjectArray)obj;\n+\t\t\tint count = env->GetArrayLength(jarr);\n+\t\t\tret.resize(count);\n+\t\t\tfor (int i = 0; i < count; i++) {\n+\t\t\t\tjobject obj = env->GetObjectArrayElement(jarr, i);\n+\t\t\t\tif (obj) {\n+\t\t\t\t\tjclass java_class = env->GetObjectClass(obj);\n+\t\t\t\t\tRef<JavaClass> java_class_wrapped = JavaClassWrapper::singleton->wrap_jclass(java_class);\n+\t\t\t\t\tenv->DeleteLocalRef(java_class);\n+\n+\t\t\t\t\tif (java_class_wrapped.is_valid()) {\n+\t\t\t\t\t\tString cn = java_class_wrapped->get_java_class_name();\n+\t\t\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\" || cn == \"java.util.HashMap\") {\n+\t\t\t\t\t\t\tret[i] = _jobject_to_variant(env, obj);\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tRef<JavaObject> java_obj_wrapped = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n+\t\t\t\t\t\t\tret[i] = java_obj_wrapped;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tenv->DeleteLocalRef(obj);\n+\t\t\t}\n+\n+\t\t\tvar = ret;\n+\t\t\treturn true;\n \t\t} break;\n \t}\n \ndiff --git a/platform/android/java_godot_lib_jni.cpp b/platform/android/java_godot_lib_jni.cpp\nindex 054c809c6e3f..0bb78bb9d974 100644\n--- a/platform/android/java_godot_lib_jni.cpp\n+++ b/platform/android/java_godot_lib_jni.cpp\n@@ -49,6 +49,7 @@\n #include \"core/config/project_settings.h\"\n #include \"core/input/input.h\"\n #include \"main/main.h\"\n+#include \"servers/rendering_server.h\"\n \n #ifndef _3D_DISABLED\n #include \"servers/xr_server.h\"\ndiff --git a/platform/ios/export/export_plugin.cpp b/platform/ios/export/export_plugin.cpp\nindex 84bf722d14f4..7ca7dc1ac675 100644\n--- a/platform/ios/export/export_plugin.cpp\n+++ b/platform/ios/export/export_plugin.cpp\n@@ -2735,6 +2735,42 @@ void EditorExportPlatformIOS::_check_for_changes_poll_thread(void *ud) {\n \t\t\t}\n \t\t}\n \n+\t\t// Enum devices (via Xcode).\n+\t\tif (ea->has_runnable_preset.is_set() && _check_xcode_install() && (FileAccess::exists(\"/usr/bin/xcrun\") || FileAccess::exists(\"/bin/xcrun\"))) {\n+\t\t\tString devices;\n+\t\t\tList<String> args;\n+\t\t\targs.push_back(\"devicectl\");\n+\t\t\targs.push_back(\"list\");\n+\t\t\targs.push_back(\"devices\");\n+\t\t\targs.push_back(\"-j\");\n+\t\t\targs.push_back(\"-\");\n+\t\t\targs.push_back(\"-q\");\n+\t\t\tint ec = 0;\n+\t\t\tError err = OS::get_singleton()->execute(\"xcrun\", args, &devices, &ec, true);\n+\t\t\tif (err == OK && ec == 0) {\n+\t\t\t\tRef<JSON> json;\n+\t\t\t\tjson.instantiate();\n+\t\t\t\terr = json->parse(devices);\n+\t\t\t\tif (err == OK) {\n+\t\t\t\t\tconst Dictionary &data = json->get_data();\n+\t\t\t\t\tconst Dictionary &result = data[\"result\"];\n+\t\t\t\t\tconst Array &devices = result[\"devices\"];\n+\t\t\t\t\tfor (int i = 0; i < devices.size(); i++) {\n+\t\t\t\t\t\tconst Dictionary &device_info = devices[i];\n+\t\t\t\t\t\tconst Dictionary &conn_props = device_info[\"connectionProperties\"];\n+\t\t\t\t\t\tconst Dictionary &dev_props = device_info[\"deviceProperties\"];\n+\t\t\t\t\t\tif (conn_props[\"pairingState\"] == \"paired\" && dev_props[\"developerModeStatus\"] == \"enabled\") {\n+\t\t\t\t\t\t\tDevice nd;\n+\t\t\t\t\t\t\tnd.id = device_info[\"identifier\"];\n+\t\t\t\t\t\t\tnd.name = dev_props[\"name\"].operator String() + \" (devicectl, \" + ((conn_props[\"transportType\"] == \"localNetwork\") ? \"network\" : \"wired\") + \")\";\n+\t\t\t\t\t\t\tnd.wifi = conn_props[\"transportType\"] == \"localNetwork\";\n+\t\t\t\t\t\t\tldevices.push_back(nd);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n \t\t// Update device list.\n \t\t{\n \t\t\tMutexLock lock(ea->device_lock);\n@@ -2922,7 +2958,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\t}\n \t\t}\n \t} else {\n-\t\t// Deploy and run on real device.\n+\t\t// Deploy and run on real device (via Xcode).\n \t\tif (ep.step(\"Installing to device...\", 3)) {\n \t\t\tCLEANUP_AND_RETURN(ERR_SKIP);\n \t\t} else {\ndiff --git a/platform/linuxbsd/README.md b/platform/linuxbsd/README.md\nindex c4f287cc6c8c..e1a95324ad50 100644\n--- a/platform/linuxbsd/README.md\n+++ b/platform/linuxbsd/README.md\n@@ -14,7 +14,7 @@ used by this platform.\n \n ## Artwork license\n \n-[`logo.png`](logo.png) is derived from the [Linux logo](https://isc.tamu.edu/~lewing/linux/):\n+[`logo.svg`](export/logo.svg) is derived from the [Linux logo](https://isc.tamu.edu/~lewing/linux/):\n \n > Permission to use and/or modify this image is granted provided you acknowledge me\n > <lewing@isc.tamu.edu> and [The GIMP](https://isc.tamu.edu/~lewing/gimp/)\ndiff --git a/platform/linuxbsd/os_linuxbsd.cpp b/platform/linuxbsd/os_linuxbsd.cpp\nindex 9fba97d552a0..466841d747f9 100644\n--- a/platform/linuxbsd/os_linuxbsd.cpp\n+++ b/platform/linuxbsd/os_linuxbsd.cpp\n@@ -37,10 +37,12 @@\n #include \"servers/rendering_server.h\"\n \n #ifdef X11_ENABLED\n+#include \"x11/detect_prime_x11.h\"\n #include \"x11/display_server_x11.h\"\n #endif\n \n #ifdef WAYLAND_ENABLED\n+#include \"wayland/detect_prime_egl.h\"\n #include \"wayland/display_server_wayland.h\"\n #endif\n \n@@ -49,6 +51,22 @@\n #include \"modules/regex/regex.h\"\n #endif\n \n+#if defined(RD_ENABLED)\n+#include \"servers/rendering/rendering_device.h\"\n+#endif\n+\n+#if defined(VULKAN_ENABLED)\n+#ifdef X11_ENABLED\n+#include \"x11/rendering_context_driver_vulkan_x11.h\"\n+#endif\n+#ifdef WAYLAND_ENABLED\n+#include \"wayland/rendering_context_driver_vulkan_wayland.h\"\n+#endif\n+#endif\n+#if defined(GLES3_ENABLED)\n+#include \"drivers/gles3/rasterizer_gles3.h\"\n+#endif\n+\n #include <dlfcn.h>\n #include <stdio.h>\n #include <stdlib.h>\n@@ -1180,6 +1198,73 @@ String OS_LinuxBSD::get_system_ca_certificates() {\n \treturn f->get_as_text();\n }\n \n+bool OS_LinuxBSD::_test_create_rendering_device(const String &p_display_driver) const {\n+\t// Tests Rendering Device creation.\n+\n+\tbool ok = false;\n+#if defined(RD_ENABLED)\n+\tError err;\n+\tRenderingContextDriver *rcd = nullptr;\n+\n+#if defined(VULKAN_ENABLED)\n+#ifdef X11_ENABLED\n+\tif (p_display_driver == \"x11\" || p_display_driver.is_empty()) {\n+\t\trcd = memnew(RenderingContextDriverVulkanX11);\n+\t}\n+#endif\n+#ifdef WAYLAND_ENABLED\n+\tif (p_display_driver == \"wayland\") {\n+\t\trcd = memnew(RenderingContextDriverVulkanWayland);\n+\t}\n+#endif\n+#endif\n+\tif (rcd != nullptr) {\n+\t\terr = rcd->initialize();\n+\t\tif (err == OK) {\n+\t\t\tRenderingDevice *rd = memnew(RenderingDevice);\n+\t\t\terr = rd->initialize(rcd);\n+\t\t\tmemdelete(rd);\n+\t\t\trd = nullptr;\n+\t\t\tif (err == OK) {\n+\t\t\t\tok = true;\n+\t\t\t}\n+\t\t}\n+\t\tmemdelete(rcd);\n+\t\trcd = nullptr;\n+\t}\n+#endif\n+\treturn ok;\n+}\n+\n+bool OS_LinuxBSD::_test_create_rendering_device_and_gl(const String &p_display_driver) const {\n+\t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some drivers.\n+\n+#ifdef GLES3_ENABLED\n+#ifdef X11_ENABLED\n+\tif (p_display_driver == \"x11\" || p_display_driver.is_empty()) {\n+#ifdef SOWRAP_ENABLED\n+\t\tif (initialize_xlib(0) != 0) {\n+\t\t\treturn false;\n+\t\t}\n+#endif\n+\t\tDetectPrimeX11::create_context();\n+\t}\n+#endif\n+#ifdef WAYLAND_ENABLED\n+\tif (p_display_driver == \"wayland\") {\n+#ifdef SOWRAP_ENABLED\n+\t\tif (initialize_wayland_egl(0) != 0) {\n+\t\t\treturn false;\n+\t\t}\n+#endif\n+\t\tDetectPrimeEGL::create_context(EGL_PLATFORM_WAYLAND_KHR);\n+\t}\n+#endif\n+\tRasterizerGLES3::make_current(true);\n+#endif\n+\treturn _test_create_rendering_device(p_display_driver);\n+}\n+\n OS_LinuxBSD::OS_LinuxBSD() {\n \tmain_loop = nullptr;\n \ndiff --git a/platform/linuxbsd/os_linuxbsd.h b/platform/linuxbsd/os_linuxbsd.h\nindex 9084061eb96c..92e57304f3c3 100644\n--- a/platform/linuxbsd/os_linuxbsd.h\n+++ b/platform/linuxbsd/os_linuxbsd.h\n@@ -138,6 +138,9 @@ class OS_LinuxBSD : public OS_Unix {\n \n \tvirtual String get_system_ca_certificates() override;\n \n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const override;\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const override;\n+\n \tOS_LinuxBSD();\n \t~OS_LinuxBSD();\n };\ndiff --git a/platform/linuxbsd/wayland/detect_prime_egl.h b/platform/linuxbsd/wayland/detect_prime_egl.h\nindex 3391e020d8b2..eff5d8a2918d 100644\n--- a/platform/linuxbsd/wayland/detect_prime_egl.h\n+++ b/platform/linuxbsd/wayland/detect_prime_egl.h\n@@ -77,9 +77,9 @@ class DetectPrimeEGL {\n \t\t{ nullptr, 0 }\n \t};\n \n+public:\n \tstatic void create_context(EGLenum p_platform_enum);\n \n-public:\n \tstatic int detect_prime(EGLenum p_platform_enum);\n };\n \ndiff --git a/platform/linuxbsd/x11/detect_prime_x11.cpp b/platform/linuxbsd/x11/detect_prime_x11.cpp\nindex c2cb02b93781..5ec5a53b989c 100644\n--- a/platform/linuxbsd/x11/detect_prime_x11.cpp\n+++ b/platform/linuxbsd/x11/detect_prime_x11.cpp\n@@ -60,25 +60,23 @@ typedef GLXContext (*GLXCREATECONTEXTATTRIBSARBPROC)(Display *, GLXFBConfig, GLX\n // To prevent shadowing warnings\n #undef glGetString\n \n-struct vendor {\n-\tconst char *glxvendor = nullptr;\n-\tint priority = 0;\n-};\n-\n-vendor vendormap[] = {\n-\t{ \"Advanced Micro Devices, Inc.\", 30 },\n-\t{ \"AMD\", 30 },\n-\t{ \"NVIDIA Corporation\", 30 },\n-\t{ \"X.Org\", 30 },\n-\t{ \"Intel Open Source Technology Center\", 20 },\n-\t{ \"Intel\", 20 },\n-\t{ \"nouveau\", 10 },\n-\t{ \"Mesa Project\", 0 },\n-\t{ nullptr, 0 }\n-};\n+int silent_error_handler(Display *display, XErrorEvent *error) {\n+\tstatic char message[1024];\n+\tXGetErrorText(display, error->error_code, message, sizeof(message));\n+\tprint_verbose(vformat(\"XServer error: %s\"\n+\t\t\t\t\t\t  \"\\n   Major opcode of failed request: %d\"\n+\t\t\t\t\t\t  \"\\n   Serial number of failed request: %d\"\n+\t\t\t\t\t\t  \"\\n   Current serial number in output stream: %d\",\n+\t\t\tString::utf8(message), (uint64_t)error->request_code, (uint64_t)error->minor_code, (uint64_t)error->serial));\n+\n+\tquick_exit(1);\n+\treturn 0;\n+}\n \n // Runs inside a child. Exiting will not quit the engine.\n-void create_context() {\n+void DetectPrimeX11::create_context() {\n+\tXSetErrorHandler(&silent_error_handler);\n+\n \tDisplay *x11_display = XOpenDisplay(nullptr);\n \tWindow x11_window;\n \tGLXContext glx_context;\n@@ -137,20 +135,7 @@ void create_context() {\n \tXFree(vi);\n }\n \n-int silent_error_handler(Display *display, XErrorEvent *error) {\n-\tstatic char message[1024];\n-\tXGetErrorText(display, error->error_code, message, sizeof(message));\n-\tprint_verbose(vformat(\"XServer error: %s\"\n-\t\t\t\t\t\t  \"\\n   Major opcode of failed request: %d\"\n-\t\t\t\t\t\t  \"\\n   Serial number of failed request: %d\"\n-\t\t\t\t\t\t  \"\\n   Current serial number in output stream: %d\",\n-\t\t\tString::utf8(message), (uint64_t)error->request_code, (uint64_t)error->minor_code, (uint64_t)error->serial));\n-\n-\tquick_exit(1);\n-\treturn 0;\n-}\n-\n-int detect_prime() {\n+int DetectPrimeX11::detect_prime() {\n \tpid_t p;\n \tint priorities[2] = {};\n \tString vendors[2];\n@@ -202,7 +187,6 @@ int detect_prime() {\n \t\t\t// cleaning up these processes, and fork() makes a copy\n \t\t\t// of all globals.\n \t\t\tCoreGlobals::leak_reporting_enabled = false;\n-\t\t\tXSetErrorHandler(&silent_error_handler);\n \n \t\t\tchar string[201];\n \n@@ -253,7 +237,7 @@ int detect_prime() {\n \t}\n \n \tfor (int i = 1; i >= 0; --i) {\n-\t\tvendor *v = vendormap;\n+\t\tconst Vendor *v = vendor_map;\n \t\twhile (v->glxvendor) {\n \t\t\tif (v->glxvendor == vendors[i]) {\n \t\t\t\tpriorities[i] = v->priority;\ndiff --git a/platform/linuxbsd/x11/detect_prime_x11.h b/platform/linuxbsd/x11/detect_prime_x11.h\nindex 62fe42602678..c8da79bf9221 100644\n--- a/platform/linuxbsd/x11/detect_prime_x11.h\n+++ b/platform/linuxbsd/x11/detect_prime_x11.h\n@@ -33,7 +33,30 @@\n \n #if defined(X11_ENABLED) && defined(GLES3_ENABLED)\n \n-int detect_prime();\n+class DetectPrimeX11 {\n+private:\n+\tstruct Vendor {\n+\t\tconst char *glxvendor = nullptr;\n+\t\tint priority = 0;\n+\t};\n+\n+\tstatic constexpr Vendor vendor_map[] = {\n+\t\t{ \"Advanced Micro Devices, Inc.\", 30 },\n+\t\t{ \"AMD\", 30 },\n+\t\t{ \"NVIDIA Corporation\", 30 },\n+\t\t{ \"X.Org\", 30 },\n+\t\t{ \"Intel Open Source Technology Center\", 20 },\n+\t\t{ \"Intel\", 20 },\n+\t\t{ \"nouveau\", 10 },\n+\t\t{ \"Mesa Project\", 0 },\n+\t\t{ nullptr, 0 }\n+\t};\n+\n+public:\n+\tstatic void create_context();\n+\n+\tstatic int detect_prime();\n+};\n \n #endif // X11_ENABLED && GLES3_ENABLED\n \ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex 26c94bf25cf1..56277d85c960 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -2563,7 +2563,8 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\tAtom *atoms = (Atom *)data;\n \t\tAtom wm_act_max_horz;\n \t\tAtom wm_act_max_vert;\n-\t\tif (strcmp(p_atom_name, \"_NET_WM_STATE\") == 0) {\n+\t\tbool checking_state = strcmp(p_atom_name, \"_NET_WM_STATE\") == 0;\n+\t\tif (checking_state) {\n \t\t\twm_act_max_horz = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_HORZ\", False);\n \t\t\twm_act_max_vert = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_VERT\", False);\n \t\t} else {\n@@ -2581,9 +2582,16 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\t\t\tfound_wm_act_max_vert = true;\n \t\t\t}\n \n-\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n-\t\t\t\tretval = true;\n-\t\t\t\tbreak;\n+\t\t\tif (checking_state) {\n+\t\t\t\tif (found_wm_act_max_horz && found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \n@@ -6844,7 +6852,7 @@ DisplayServerX11::DisplayServerX11(const String &p_rendering_driver, WindowMode\n \n \t\t\tif (use_prime == -1) {\n \t\t\t\tprint_verbose(\"Detecting GPUs, set DRI_PRIME in the environment to override GPU detection logic.\");\n-\t\t\t\tuse_prime = detect_prime();\n+\t\t\t\tuse_prime = DetectPrimeX11::detect_prime();\n \t\t\t}\n \n \t\t\tif (use_prime) {\ndiff --git a/platform/web/README.md b/platform/web/README.md\nindex 906eb508fecd..eac2c7fe8e17 100644\n--- a/platform/web/README.md\n+++ b/platform/web/README.md\n@@ -17,6 +17,6 @@ this platform such as the html shell (web page).\n \n ## Artwork license\n \n-[`logo.png`](logo.png) and [`run_icon.png`](run_icon.png) are licensed under\n+[`logo.svg`](export/logo.svg) and [`run_icon.svg`](export/run_icon.svg) are licensed under\n [Creative Commons Attribution 3.0 Unported](https://www.w3.org/html/logo/faq.html#how-licenced)\n per the HTML5 logo usage guidelines.\ndiff --git a/platform/windows/os_windows.cpp b/platform/windows/os_windows.cpp\nindex 7ef3de2dd79c..b0ec6852af2e 100644\n--- a/platform/windows/os_windows.cpp\n+++ b/platform/windows/os_windows.cpp\n@@ -2340,18 +2340,26 @@ void OS_Windows::add_frame_delay(bool p_can_draw) {\n \t\ttarget_ticks += dynamic_delay;\n \t\tuint64_t current_ticks = get_ticks_usec();\n \n-\t\tif (target_ticks > current_ticks + delay_resolution) {\n-\t\t\tuint64_t delay_time = target_ticks - current_ticks - delay_resolution;\n-\t\t\t// Make sure we always sleep for a multiple of delay_resolution to avoid overshooting.\n-\t\t\t// Refer to: https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep#remarks\n-\t\t\tdelay_time = (delay_time / delay_resolution) * delay_resolution;\n-\t\t\tif (delay_time > 0) {\n-\t\t\t\tdelay_usec(delay_time);\n+\t\tif (!is_in_low_processor_usage_mode()) {\n+\t\t\tif (target_ticks > current_ticks + delay_resolution) {\n+\t\t\t\tuint64_t delay_time = target_ticks - current_ticks - delay_resolution;\n+\t\t\t\t// Make sure we always sleep for a multiple of delay_resolution to avoid overshooting.\n+\t\t\t\t// Refer to: https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep#remarks\n+\t\t\t\tdelay_time = (delay_time / delay_resolution) * delay_resolution;\n+\t\t\t\tif (delay_time > 0) {\n+\t\t\t\t\tdelay_usec(delay_time);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t// Busy wait for the remainder of time.\n+\t\t\twhile (get_ticks_usec() < target_ticks) {\n+\t\t\t\tYieldProcessor();\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Use a more relaxed approach for low processor usage mode.\n+\t\t\t// This has worse frame pacing but is more power efficient.\n+\t\t\tif (current_ticks < target_ticks) {\n+\t\t\t\tdelay_usec(target_ticks - current_ticks);\n \t\t\t}\n-\t\t}\n-\t\t// Busy wait for the remainder of time.\n-\t\twhile (get_ticks_usec() < target_ticks) {\n-\t\t\tYieldProcessor();\n \t\t}\n \n \t\tcurrent_ticks = get_ticks_usec();\n@@ -2359,7 +2367,7 @@ void OS_Windows::add_frame_delay(bool p_can_draw) {\n \t}\n }\n \n-bool OS_Windows::_test_create_rendering_device() const {\n+bool OS_Windows::_test_create_rendering_device(const String &p_display_driver) const {\n \t// Tests Rendering Device creation.\n \n \tbool ok = false;\n@@ -2394,7 +2402,7 @@ bool OS_Windows::_test_create_rendering_device() const {\n \treturn ok;\n }\n \n-bool OS_Windows::_test_create_rendering_device_and_gl() const {\n+bool OS_Windows::_test_create_rendering_device_and_gl(const String &p_display_driver) const {\n \t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n \n \tWNDCLASSEXW wc_probe;\n@@ -2438,7 +2446,7 @@ bool OS_Windows::_test_create_rendering_device_and_gl() const {\n \t}\n \n \tif (ok) {\n-\t\tok = _test_create_rendering_device();\n+\t\tok = _test_create_rendering_device(p_display_driver);\n \t}\n \n #ifdef GLES3_ENABLED\ndiff --git a/platform/windows/os_windows.h b/platform/windows/os_windows.h\nindex c46d86a650ef..d9b8233e511e 100644\n--- a/platform/windows/os_windows.h\n+++ b/platform/windows/os_windows.h\n@@ -252,8 +252,8 @@ class OS_Windows : public OS {\n \n \tvoid set_main_window(HWND p_main_window) { main_window = p_main_window; }\n \n-\tvirtual bool _test_create_rendering_device_and_gl() const override;\n-\tvirtual bool _test_create_rendering_device() const override;\n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const override;\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const override;\n \n \tHINSTANCE get_hinstance() { return hInstance; }\n \tOS_Windows(HINSTANCE _hInstance);\ndiff --git a/scene/2d/cpu_particles_2d.cpp b/scene/2d/cpu_particles_2d.cpp\nindex 279bb8ff3d95..b77003509786 100644\n--- a/scene/2d/cpu_particles_2d.cpp\n+++ b/scene/2d/cpu_particles_2d.cpp\n@@ -1194,8 +1194,6 @@ void CPUParticles2D::_notification(int p_what) {\n \n \t\t\t_refresh_interpolation_state();\n \n-\t\t\tset_physics_process_internal(emitting && _interpolation_data.interpolated_follow);\n-\n \t\t\t// If we are interpolated following, then reset physics interpolation\n \t\t\t// when first appearing. This won't be called by canvas item, as in the\n \t\t\t// following mode, is_physics_interpolated() is actually FALSE.\ndiff --git a/scene/3d/navigation_link_3d.cpp b/scene/3d/navigation_link_3d.cpp\nindex 8f9b7a60b513..dc518ee45256 100644\n--- a/scene/3d/navigation_link_3d.cpp\n+++ b/scene/3d/navigation_link_3d.cpp\n@@ -262,6 +262,12 @@ void NavigationLink3D::_notification(int p_what) {\n \t\tcase NOTIFICATION_EXIT_TREE: {\n \t\t\t_link_exit_navigation_map();\n \t\t} break;\n+\n+#ifdef DEBUG_ENABLED\n+\t\tcase NOTIFICATION_VISIBILITY_CHANGED: {\n+\t\t\t_update_debug_mesh();\n+\t\t} break;\n+#endif // DEBUG_ENABLED\n \t}\n }\n \ndiff --git a/scene/3d/voxelizer.cpp b/scene/3d/voxelizer.cpp\nindex 711b265bb641..a4c36deabdec 100644\n--- a/scene/3d/voxelizer.cpp\n+++ b/scene/3d/voxelizer.cpp\n@@ -399,6 +399,9 @@ int Voxelizer::get_bake_steps(Ref<Mesh> &p_mesh) const {\n Voxelizer::BakeResult Voxelizer::plot_mesh(const Transform3D &p_xform, Ref<Mesh> &p_mesh, const Vector<Ref<Material>> &p_materials, const Ref<Material> &p_override_material, BakeStepFunc p_bake_step_func) {\n \tERR_FAIL_COND_V_MSG(!p_xform.is_finite(), BAKE_RESULT_INVALID_PARAMETER, \"Invalid mesh bake transform.\");\n \n+\t// Precalculate for transforming vertex normals\n+\tBasis normal_xform = p_xform.basis.inverse().transposed();\n+\n \tint bake_total = get_bake_steps(p_mesh), bake_current = 0;\n \n \tfor (int i = 0; i < p_mesh->get_surface_count(); i++) {\n@@ -463,7 +466,7 @@ Voxelizer::BakeResult Voxelizer::plot_mesh(const Transform3D &p_xform, Ref<Mesh>\n \n \t\t\t\tif (nr) {\n \t\t\t\t\tfor (int k = 0; k < 3; k++) {\n-\t\t\t\t\t\tnormal[k] = nr[ir[j * 3 + k]];\n+\t\t\t\t\t\tnormal[k] = normal_xform.xform(nr[ir[j * 3 + k]]).normalized();\n \t\t\t\t\t}\n \t\t\t\t}\n \ndiff --git a/scene/animation/animation_blend_space_1d.cpp b/scene/animation/animation_blend_space_1d.cpp\nindex 4716a8fcec3d..acbc892d478f 100644\n--- a/scene/animation/animation_blend_space_1d.cpp\n+++ b/scene/animation/animation_blend_space_1d.cpp\n@@ -380,7 +380,13 @@ AnimationNode::NodeTimeInfo AnimationNodeBlendSpace1D::_process(const AnimationM\n \t\t\t\tRef<AnimationNodeAnimation> na_c = static_cast<Ref<AnimationNodeAnimation>>(blend_points[cur_closest].node);\n \t\t\t\tRef<AnimationNodeAnimation> na_n = static_cast<Ref<AnimationNodeAnimation>>(blend_points[new_closest].node);\n \t\t\t\tif (na_c.is_valid() && na_n.is_valid()) {\n+\t\t\t\t\tna_n->process_state = process_state;\n+\t\t\t\t\tna_c->process_state = process_state;\n+\n \t\t\t\t\tna_n->set_backward(na_c->is_backward());\n+\n+\t\t\t\t\tna_n = nullptr;\n+\t\t\t\t\tna_c = nullptr;\n \t\t\t\t}\n \t\t\t\t// See how much animation remains.\n \t\t\t\tpi.seeked = false;\ndiff --git a/scene/animation/animation_blend_space_2d.cpp b/scene/animation/animation_blend_space_2d.cpp\nindex 7399fea31719..ee1d4121d595 100644\n--- a/scene/animation/animation_blend_space_2d.cpp\n+++ b/scene/animation/animation_blend_space_2d.cpp\n@@ -557,7 +557,13 @@ AnimationNode::NodeTimeInfo AnimationNodeBlendSpace2D::_process(const AnimationM\n \t\t\t\tRef<AnimationNodeAnimation> na_c = static_cast<Ref<AnimationNodeAnimation>>(blend_points[cur_closest].node);\n \t\t\t\tRef<AnimationNodeAnimation> na_n = static_cast<Ref<AnimationNodeAnimation>>(blend_points[new_closest].node);\n \t\t\t\tif (na_c.is_valid() && na_n.is_valid()) {\n+\t\t\t\t\tna_n->process_state = process_state;\n+\t\t\t\t\tna_c->process_state = process_state;\n+\n \t\t\t\t\tna_n->set_backward(na_c->is_backward());\n+\n+\t\t\t\t\tna_n = nullptr;\n+\t\t\t\t\tna_c = nullptr;\n \t\t\t\t}\n \t\t\t\t// See how much animation remains.\n \t\t\t\tpi.seeked = false;\ndiff --git a/scene/debugger/scene_debugger.cpp b/scene/debugger/scene_debugger.cpp\nindex c620c5fd5c80..6b4a00f61719 100644\n--- a/scene/debugger/scene_debugger.cpp\n+++ b/scene/debugger/scene_debugger.cpp\n@@ -1362,7 +1362,7 @@ void RuntimeNodeSelect::_root_window_input(const Ref<InputEvent> &p_event) {\n \n \tif (camera_override) {\n \t\tif (node_select_type == NODE_TYPE_2D) {\n-\t\t\tif (panner->gui_input(p_event, Rect2(Vector2(), root->get_size()))) {\n+\t\t\tif (panner->gui_input(p_event, Rect2(Vector2(), root->get_visible_rect().get_size()))) {\n \t\t\t\treturn;\n \t\t\t}\n \t\t} else if (node_select_type == NODE_TYPE_3D) {\n@@ -1821,8 +1821,9 @@ void RuntimeNodeSelect::_find_canvas_items_at_pos(const Point2 &p_pos, Node *p_n\n }\n \n void RuntimeNodeSelect::_pan_callback(Vector2 p_scroll_vec, Ref<InputEvent> p_event) {\n-\tview_2d_offset.x -= p_scroll_vec.x / view_2d_zoom;\n-\tview_2d_offset.y -= p_scroll_vec.y / view_2d_zoom;\n+\tVector2 scroll = SceneTree::get_singleton()->get_root()->get_screen_transform().affine_inverse().xform(p_scroll_vec);\n+\tview_2d_offset.x -= scroll.x / view_2d_zoom;\n+\tview_2d_offset.y -= scroll.y / view_2d_zoom;\n \n \t_update_view_2d();\n }\ndiff --git a/scene/gui/color_picker.cpp b/scene/gui/color_picker.cpp\nindex aab7c37bbb5e..a5348ad3b290 100644\n--- a/scene/gui/color_picker.cpp\n+++ b/scene/gui/color_picker.cpp\n@@ -2374,7 +2374,7 @@ ColorPicker::ColorPicker() {\n \tswatches_vbc->add_child(palette_box);\n \n \tbtn_preset = memnew(Button);\n-\tbtn_preset->set_text(\"Swatches\");\n+\tbtn_preset->set_text(ETR(\"Swatches\"));\n \tbtn_preset->set_flat(true);\n \tbtn_preset->set_toggle_mode(true);\n \tbtn_preset->set_focus_mode(FOCUS_NONE);\ndiff --git a/scene/gui/line_edit.cpp b/scene/gui/line_edit.cpp\nindex 969e2fd3a35c..f4d66d5a281d 100644\n--- a/scene/gui/line_edit.cpp\n+++ b/scene/gui/line_edit.cpp\n@@ -1733,7 +1733,7 @@ void LineEdit::_validate_caret_can_draw() {\n \t\tdraw_caret = true;\n \t\tcaret_blink_timer = 0.0;\n \t}\n-\tcaret_can_draw = editing && (window_has_focus || (menu && menu->has_focus())) && (has_focus() || caret_force_displayed);\n+\tcaret_can_draw = (caret_force_displayed && !is_part_of_edited_scene()) || (editing && (window_has_focus || (menu && menu->has_focus())) && has_focus());\n }\n \n void LineEdit::delete_char() {\ndiff --git a/scene/gui/spin_box.cpp b/scene/gui/spin_box.cpp\nindex e2e6f076781a..c77fda1ac805 100644\n--- a/scene/gui/spin_box.cpp\n+++ b/scene/gui/spin_box.cpp\n@@ -63,20 +63,39 @@ void SpinBox::_update_text(bool p_only_update_if_value_changed) {\n \t\t\tvalue += \" \" + suffix;\n \t\t}\n \t}\n+\n+\tif (!accepted && update_on_text_changed && !line_edit->get_text().replace(\",\", \".\").contains_char('.')) {\n+\t\tvalue = String::num(get_value(), 0);\n+\t}\n+\n \tline_edit->set_text_with_selection(value);\n }\n \n void SpinBox::_text_submitted(const String &p_string) {\n \tif (p_string.is_empty()) {\n-\t\t_update_text();\n \t\treturn;\n \t}\n \n+\tString text = p_string;\n+\n+\tif (update_on_text_changed) {\n+\t\t// Convert commas ',' to dots '.' for French/German etc. keyboard layouts.\n+\t\ttext = p_string.replace(\",\", \".\");\n+\n+\t\tif (!text.begins_with(\".\") && p_string.ends_with(\".\")) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tif (text.begins_with(\".\")) {\n+\t\t\tline_edit->set_text(\"0.\");\n+\t\t\tline_edit->set_caret_column(line_edit->get_text().length());\n+\t\t\treturn;\n+\t\t}\n+\t}\n+\n \tRef<Expression> expr;\n \texpr.instantiate();\n \n-\t// Convert commas ',' to dots '.' for French/German etc. keyboard layouts.\n-\tString text = p_string.replace(\",\", \".\");\n \ttext = text.replace(\";\", \",\");\n \ttext = TS->parse_number(text);\n \t// Ignore the prefix and suffix in the expression.\n@@ -107,12 +126,17 @@ void SpinBox::_text_submitted(const String &p_string) {\n }\n \n void SpinBox::_text_changed(const String &p_string) {\n+\taccepted = false;\n \tint cursor_pos = line_edit->get_caret_column();\n \n \t_text_submitted(p_string);\n \n+\tString text = p_string.replace(\",\", \".\");\n+\n \t// Line edit 'set_text' method resets the cursor position so we need to undo that.\n-\tline_edit->set_caret_column(cursor_pos);\n+\tif (update_on_text_changed && !text.begins_with(\".\")) {\n+\t\tline_edit->set_caret_column(cursor_pos);\n+\t}\n }\n \n LineEdit *SpinBox::get_line_edit() {\n@@ -192,6 +216,7 @@ void SpinBox::gui_input(const Ref<InputEvent> &p_event) {\n \tif (mb.is_valid() && mb->is_pressed()) {\n \t\tswitch (mb->get_button_index()) {\n \t\t\tcase MouseButton::LEFT: {\n+\t\t\t\taccepted = true;\n \t\t\t\tline_edit->grab_focus();\n \n \t\t\t\tif (mouse_on_up_button || mouse_on_down_button) {\n@@ -291,9 +316,12 @@ void SpinBox::_line_edit_editing_toggled(bool p_toggled_on) {\n \t\t\tline_edit->select_all();\n \t\t}\n \t} else {\n+\t\taccepted = true;\n+\n \t\tif (Input::get_singleton()->is_action_pressed(\"ui_cancel\") || line_edit->get_text().is_empty()) {\n \t\t\t_update_text(); // Revert text if editing was canceled.\n \t\t} else {\n+\t\t\tline_edit->set_text(line_edit->get_text().trim_suffix(\".\").trim_suffix(\",\"));\n \t\t\t_update_text(true); // Update text in case value was changed this frame (e.g. on `focus_exited`).\n \t\t\t_text_submitted(line_edit->get_text());\n \t\t}\ndiff --git a/scene/gui/spin_box.h b/scene/gui/spin_box.h\nindex 79076d3f4692..dcc1f73eb9a2 100644\n--- a/scene/gui/spin_box.h\n+++ b/scene/gui/spin_box.h\n@@ -40,6 +40,7 @@ class SpinBox : public Range {\n \n \tLineEdit *line_edit = nullptr;\n \tbool update_on_text_changed = false;\n+\tbool accepted = true;\n \n \tstruct SizingCache {\n \t\tint buttons_block_width = 0;\ndiff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex ad2202315008..887d4eaf00f1 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -6081,7 +6081,7 @@ void TextEdit::adjust_viewport_to_caret(int p_caret) {\n \t\tset_line_as_last_visible(cur_line, cur_wrap);\n \t}\n \n-\t_adjust_viewport_to_caret_horizontally(p_caret);\n+\t_adjust_viewport_to_caret_horizontally(p_caret, false);\n }\n \n void TextEdit::center_viewport_to_caret(int p_caret) {\n@@ -8186,7 +8186,7 @@ void TextEdit::_scroll_lines_down() {\n \tmerge_overlapping_carets();\n }\n \n-void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret) {\n+void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret, bool p_maximize_selection) {\n \tif (get_line_wrapping_mode() != LineWrappingMode::LINE_WRAPPING_NONE) {\n \t\tfirst_visible_col = 0;\n \t\th_scroll->set_value(first_visible_col);\n@@ -8220,7 +8220,7 @@ void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret) {\n \t\tint ime_end_column = get_caret_column(p_caret) + (ime_selection.y > 0 ? ime_selection.x + ime_selection.y : ime_text.length());\n \t\tcaret_end_pos = _get_column_x_offset_for_line(ime_end_column, get_caret_line(p_caret), ime_end_column);\n \t\tprioritize_end = false;\n-\t} else if (has_selection(p_caret) && get_selection_from_line(p_caret) == get_selection_to_line(p_caret)) {\n+\t} else if (p_maximize_selection && has_selection(p_caret) && get_selection_from_line(p_caret) == get_selection_to_line(p_caret)) {\n \t\t// Use selection if it is on one line.\n \t\tcaret_start_pos = _get_column_x_offset_for_line(get_selection_from_column(p_caret), get_caret_line(p_caret), get_selection_from_column(p_caret));\n \t\tcaret_end_pos = _get_column_x_offset_for_line(get_selection_to_column(p_caret), get_caret_line(p_caret), get_selection_to_column(p_caret));\ndiff --git a/scene/gui/text_edit.h b/scene/gui/text_edit.h\nindex 21c8781e2648..b8d78283403d 100644\n--- a/scene/gui/text_edit.h\n+++ b/scene/gui/text_edit.h\n@@ -539,7 +539,7 @@ class TextEdit : public Control {\n \tvoid _scroll_lines_up();\n \tvoid _scroll_lines_down();\n \n-\tvoid _adjust_viewport_to_caret_horizontally(int p_caret = 0);\n+\tvoid _adjust_viewport_to_caret_horizontally(int p_caret = 0, bool p_maximize_selection = true);\n \n \t// Minimap.\n \tbool draw_minimap = false;\ndiff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex cd6c51de4b2d..dc14294ea05b 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -3506,7 +3506,7 @@ void Tree::gui_input(const Ref<InputEvent> &p_event) {\n \tRef<InputEventKey> k = p_event;\n \n \tbool is_command = k.is_valid() && k->is_command_or_control_pressed();\n-\tif (p_event->is_action(\"ui_right\") && p_event->is_pressed()) {\n+\tif (p_event->is_action(cache.rtl ? \"ui_left\" : \"ui_right\") && p_event->is_pressed()) {\n \t\tif (!cursor_can_exit_tree) {\n \t\t\taccept_event();\n \t\t}\n@@ -3524,7 +3524,7 @@ void Tree::gui_input(const Ref<InputEvent> &p_event) {\n \t\t} else {\n \t\t\t_go_down();\n \t\t}\n-\t} else if (p_event->is_action(\"ui_left\") && p_event->is_pressed()) {\n+\t} else if (p_event->is_action(cache.rtl ? \"ui_right\" : \"ui_left\") && p_event->is_pressed()) {\n \t\tif (!cursor_can_exit_tree) {\n \t\t\taccept_event();\n \t\t}\n@@ -4107,13 +4107,18 @@ bool Tree::edit_selected(bool p_force_edit) {\n \t\t// \"floor()\" centers vertically.\n \t\tVector2 ofs(0, Math::floor((MAX(line_editor->get_minimum_size().height, rect.size.height - value_editor_height) - rect.size.height) / 2));\n \n-\t\tpopup_rect.position = get_screen_position() + rect.position - ofs;\n-\t\tpopup_rect.size = rect.size;\n-\n \t\t// Account for icon.\n \t\tSize2 icon_size = _get_cell_icon_size(c) * popup_scale;\n-\t\tpopup_rect.position.x += icon_size.x;\n-\t\tpopup_rect.size.x -= icon_size.x;\n+\n+\t\tpopup_rect.size = rect.size;\n+\t\tpopup_rect.size.x -= icon_size.x + theme_cache.h_separation;\n+\n+\t\tpopup_rect.position = rect.position - ofs;\n+\t\tpopup_rect.position.x += icon_size.x + theme_cache.h_separation;\n+\t\tif (cache.rtl) {\n+\t\t\tpopup_rect.position.x = get_size().width - popup_rect.position.x - popup_rect.size.x;\n+\t\t}\n+\t\tpopup_rect.position += get_screen_position();\n \n \t\tline_editor->clear();\n \t\tline_editor->set_text(c.mode == TreeItem::CELL_MODE_STRING ? c.text : String::num(c.val, Math::range_step_decimals(c.step)));\ndiff --git a/scene/gui/video_stream_player.cpp b/scene/gui/video_stream_player.cpp\nindex fa965179a4d4..eb6aff27dc92 100644\n--- a/scene/gui/video_stream_player.cpp\n+++ b/scene/gui/video_stream_player.cpp\n@@ -136,6 +136,7 @@ void VideoStreamPlayer::_notification(int p_notification) {\n \t\t} break;\n \n \t\tcase NOTIFICATION_EXIT_TREE: {\n+\t\t\tstop();\n \t\t\tAudioServer::get_singleton()->remove_mix_callback(_mix_audios, this);\n \t\t} break;\n \ndiff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex d0054baeff25..f7fd1a2c5a7e 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -1509,6 +1509,7 @@ void Viewport::_gui_show_tooltip() {\n \t// This way, the custom tooltip from `ConnectionsDockTree` can create\n \t// its own tooltip without conflicting with the default one, even an empty tooltip.\n \tif (base_tooltip && !base_tooltip->is_visible()) {\n+\t\tmemdelete(base_tooltip);\n \t\treturn;\n \t}\n \n@@ -1546,6 +1547,8 @@ void Viewport::_gui_show_tooltip() {\n \tpanel->set_flag(Window::FLAG_POPUP, false);\n \tpanel->set_flag(Window::FLAG_MOUSE_PASSTHROUGH, true);\n \tpanel->set_wrap_controls(true);\n+\tpanel->set_default_canvas_item_texture_filter(get_default_canvas_item_texture_filter());\n+\tpanel->set_default_canvas_item_texture_repeat(get_default_canvas_item_texture_repeat());\n \tpanel->add_child(base_tooltip);\n \tpanel->gui_parent = this;\n \ndiff --git a/scene/resources/curve.cpp b/scene/resources/curve.cpp\nindex e982e4d13575..de68737b8c93 100644\n--- a/scene/resources/curve.cpp\n+++ b/scene/resources/curve.cpp\n@@ -56,7 +56,7 @@ void Curve::set_point_count(int p_count) {\n \tnotify_property_list_changed();\n }\n \n-int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_tangent, TangentMode p_left_mode, TangentMode p_right_mode) {\n+int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_tangent, TangentMode p_left_mode, TangentMode p_right_mode, bool p_mark_dirty) {\n \t// Add a point and preserve order.\n \n \t// Points must remain within the given value and domain ranges.\n@@ -99,7 +99,9 @@ int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_\n \n \tupdate_auto_tangents(ret);\n \n-\tmark_dirty();\n+\tif (p_mark_dirty) {\n+\t\tmark_dirty();\n+\t}\n \n \treturn ret;\n }\n@@ -221,10 +223,12 @@ Curve::TangentMode Curve::get_point_right_mode(int p_index) const {\n \treturn _points[p_index].right_mode;\n }\n \n-void Curve::_remove_point(int p_index) {\n+void Curve::_remove_point(int p_index, bool p_mark_dirty) {\n \tERR_FAIL_UNSIGNED_INDEX((uint32_t)p_index, _points.size());\n \t_points.remove_at(p_index);\n-\tmark_dirty();\n+\tif (p_mark_dirty) {\n+\t\tmark_dirty();\n+\t}\n }\n \n void Curve::remove_point(int p_index) {\n@@ -252,16 +256,13 @@ void Curve::set_point_value(int p_index, real_t p_position) {\n int Curve::set_point_offset(int p_index, real_t p_offset) {\n \tERR_FAIL_UNSIGNED_INDEX_V((uint32_t)p_index, _points.size(), -1);\n \tPoint p = _points[p_index];\n-\t_remove_point(p_index);\n-\tint i = _add_point(Vector2(p_offset, p.position.y));\n-\t_points[i].left_tangent = p.left_tangent;\n-\t_points[i].right_tangent = p.right_tangent;\n-\t_points[i].left_mode = p.left_mode;\n-\t_points[i].right_mode = p.right_mode;\n+\t_remove_point(p_index, false);\n+\tint i = _add_point(Vector2(p_offset, p.position.y), p.left_tangent, p.right_tangent, p.left_mode, p.right_mode, false);\n \tif (p_index != i) {\n \t\tupdate_auto_tangents(p_index);\n \t}\n \tupdate_auto_tangents(i);\n+\tmark_dirty();\n \treturn i;\n }\n \ndiff --git a/scene/resources/curve.h b/scene/resources/curve.h\nindex fb774e879dff..16ce75198455 100644\n--- a/scene/resources/curve.h\n+++ b/scene/resources/curve.h\n@@ -77,15 +77,15 @@ class Curve : public Resource {\n \tvoid set_point_count(int p_count);\n \n \tint add_point(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE);\n \tint add_point_no_update(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE);\n \tvoid remove_point(int p_index);\n \tvoid clear_points();\n \n@@ -127,10 +127,10 @@ class Curve : public Resource {\n \tTangentMode get_point_left_mode(int p_index) const;\n \tTangentMode get_point_right_mode(int p_index) const;\n \n-\tvoid update_auto_tangents(int i);\n+\tvoid update_auto_tangents(int p_index);\n \n \tArray get_data() const;\n-\tvoid set_data(Array input);\n+\tvoid set_data(Array p_input);\n \n \tvoid bake();\n \tvoid _bake() const;\n@@ -150,11 +150,12 @@ class Curve : public Resource {\n private:\n \tvoid mark_dirty();\n \tint _add_point(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n-\tvoid _remove_point(int p_index);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE,\n+\t\t\tbool p_mark_dirty = true);\n+\tvoid _remove_point(int p_index, bool p_mark_dirty = true);\n \n \tLocalVector<Point> _points;\n \tmutable bool _baked_cache_dirty = false;\ndiff --git a/scene/resources/packed_scene.cpp b/scene/resources/packed_scene.cpp\nindex 7f170e0085ec..e550a5beff90 100644\n--- a/scene/resources/packed_scene.cpp\n+++ b/scene/resources/packed_scene.cpp\n@@ -328,7 +328,7 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \n \t\t\t\t\t\tDeferredNodePathProperties dnp;\n \t\t\t\t\t\tdnp.value = props[nprops[j].value];\n-\t\t\t\t\t\tdnp.base = node;\n+\t\t\t\t\t\tdnp.base = node->get_instance_id();\n \t\t\t\t\t\tdnp.property = snames[name_idx];\n \t\t\t\t\t\tdeferred_node_paths.push_back(dnp);\n \t\t\t\t\t\tcontinue;\n@@ -521,25 +521,27 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \n \tfor (const DeferredNodePathProperties &dnp : deferred_node_paths) {\n \t\t// Replace properties stored as NodePaths with actual Nodes.\n+\t\tNode *base = Object::cast_to<Node>(ObjectDB::get_instance(dnp.base));\n+\t\tERR_CONTINUE_EDMSG(!base, vformat(\"Failed to set deferred property '%s' as the base node disappeared.\", dnp.property));\n \t\tif (dnp.value.get_type() == Variant::ARRAY) {\n \t\t\tArray paths = dnp.value;\n \n \t\t\tbool valid;\n-\t\t\tArray array = dnp.base->get(dnp.property, &valid);\n-\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, dnp.base->get_name()));\n+\t\t\tArray array = base->get(dnp.property, &valid);\n+\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, base->get_name()));\n \t\t\tarray = array.duplicate();\n \n \t\t\tarray.resize(paths.size());\n \t\t\tfor (int i = 0; i < array.size(); i++) {\n-\t\t\t\tarray.set(i, dnp.base->get_node_or_null(paths[i]));\n+\t\t\t\tarray.set(i, base->get_node_or_null(paths[i]));\n \t\t\t}\n-\t\t\tdnp.base->set(dnp.property, array);\n+\t\t\tbase->set(dnp.property, array);\n \t\t} else if (dnp.value.get_type() == Variant::DICTIONARY) {\n \t\t\tDictionary paths = dnp.value;\n \n \t\t\tbool valid;\n-\t\t\tDictionary dict = dnp.base->get(dnp.property, &valid);\n-\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, dnp.base->get_name()));\n+\t\t\tDictionary dict = base->get(dnp.property, &valid);\n+\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, base->get_name()));\n \t\t\tdict = dict.duplicate();\n \t\t\tbool convert_key = dict.get_typed_key_builtin() == Variant::OBJECT &&\n \t\t\t\t\tClassDB::is_parent_class(dict.get_typed_key_class_name(), \"Node\");\n@@ -549,17 +551,17 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \t\t\tfor (int i = 0; i < paths.size(); i++) {\n \t\t\t\tVariant key = paths.get_key_at_index(i);\n \t\t\t\tif (convert_key) {\n-\t\t\t\t\tkey = dnp.base->get_node_or_null(key);\n+\t\t\t\t\tkey = base->get_node_or_null(key);\n \t\t\t\t}\n \t\t\t\tVariant value = paths.get_value_at_index(i);\n \t\t\t\tif (convert_value) {\n-\t\t\t\t\tvalue = dnp.base->get_node_or_null(value);\n+\t\t\t\t\tvalue = base->get_node_or_null(value);\n \t\t\t\t}\n \t\t\t\tdict[key] = value;\n \t\t\t}\n-\t\t\tdnp.base->set(dnp.property, dict);\n+\t\t\tbase->set(dnp.property, dict);\n \t\t} else {\n-\t\t\tdnp.base->set(dnp.property, dnp.base->get_node_or_null(dnp.value));\n+\t\t\tbase->set(dnp.property, base->get_node_or_null(dnp.value));\n \t\t}\n \t}\n \ndiff --git a/scene/resources/packed_scene.h b/scene/resources/packed_scene.h\nindex 9f8088910f18..ee2bba2f2088 100644\n--- a/scene/resources/packed_scene.h\n+++ b/scene/resources/packed_scene.h\n@@ -70,7 +70,7 @@ class SceneState : public RefCounted {\n \t};\n \n \tstruct DeferredNodePathProperties {\n-\t\tNode *base = nullptr;\n+\t\tObjectID base;\n \t\tStringName property;\n \t\tVariant value;\n \t};\ndiff --git a/scene/resources/particle_process_material.cpp b/scene/resources/particle_process_material.cpp\nindex 2c54564ff7b3..dd6e659e0612 100644\n--- a/scene/resources/particle_process_material.cpp\n+++ b/scene/resources/particle_process_material.cpp\n@@ -1034,7 +1034,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t\t\tcode += \"\t{\\n\";\n \t\t}\n \t\tcode += \"\t\tfloat vel_mag = length(VELOCITY);\\n\";\n-\t\tcode += \"\t\tfloat vel_infl = clamp(dynamic_params.turb_influence * turbulence_influence, 0.0, 1.0);\\n\";\n+\t\tcode += \"\t\tfloat vel_infl = clamp(dynamic_params.turb_influence * turbulence_influence, 0.0, 1.0) * (DELTA <= 0.0 ? 0.0 : 1.0);\\n\";\n \t\tcode += \"\t\tVELOCITY = mix(VELOCITY, normalize(noise_direction) * vel_mag * (1.0 + (1.0 - vel_infl) * 0.2), vel_infl);\\n\";\n \t\tcode += \"\t\tvel_mag = length(controlled_displacement);\\n\";\n \t\tcode += \"\t\tcontrolled_displacement = mix(controlled_displacement, normalize(noise_direction) * vel_mag * (1.0 + (1.0 - vel_infl) * 0.2), vel_infl);\\n\";\n@@ -1121,9 +1121,16 @@ void ParticleProcessMaterial::_update_shader() {\n \t\tcode += \"\t\tparams.scale *= texture(scale_over_velocity_curve, vec2(0.0)).rgb;\\n\";\n \t\tcode += \"\t}\\n\";\n \t}\n-\tcode += \"\tTRANSFORM[0].xyz *= sign(params.scale.x) * max(abs(params.scale.x), 0.001);\\n\";\n-\tcode += \"\tTRANSFORM[1].xyz *= sign(params.scale.y) * max(abs(params.scale.y), 0.001);\\n\";\n-\tcode += \"\tTRANSFORM[2].xyz *= sign(params.scale.z) * max(abs(params.scale.z), 0.001);\\n\";\n+\t// A scale of 0 results in no emission at some emission amounts (including 3 and 6).\n+\t// `sign(scale)` is unsuitable, because sign(0) returns 0, nullifying the minimum value.\n+\t// The following evaluates to 1 when scale is 0, falling back to a positive minimum value.\n+\tcode += \"\tfloat scale_sign_x = params.scale.x < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_sign_y = params.scale.y < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_sign_z = params.scale.z < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_minimum = 0.001;\\n\";\n+\tcode += \"\tTRANSFORM[0].xyz *= scale_sign_x * max(abs(params.scale.x), scale_minimum);\\n\";\n+\tcode += \"\tTRANSFORM[1].xyz *= scale_sign_y * max(abs(params.scale.y), scale_minimum);\\n\";\n+\tcode += \"\tTRANSFORM[2].xyz *= scale_sign_z * max(abs(params.scale.z), scale_minimum);\\n\";\n \tcode += \"\\n\";\n \tcode += \"\tCUSTOM.z = params.animation_offset + lifetime_percent * params.animation_speed;\\n\\n\";\n \ndiff --git a/scene/theme/default_theme.cpp b/scene/theme/default_theme.cpp\nindex 5ae1e9baa37d..06fe298668f3 100644\n--- a/scene/theme/default_theme.cpp\n+++ b/scene/theme/default_theme.cpp\n@@ -91,6 +91,8 @@ static Ref<ImageTexture> generate_icon(int p_index) {\n \n \tError err = ImageLoaderSVG::create_image_from_string(img, default_theme_icons_sources[p_index], scale, upsample, HashMap<Color, Color>());\n \tERR_FAIL_COND_V_MSG(err != OK, Ref<ImageTexture>(), \"Failed generating icon, unsupported or invalid SVG data in default theme.\");\n+\n+\timg->fix_alpha_edges();\n #else\n \t// If the SVG module is disabled, we can't really display the UI well, but at least we won't crash.\n \t// 16 pixels is used as it's the most common base size for Godot icons.\ndiff --git a/servers/display_server.cpp b/servers/display_server.cpp\nindex c9399d9c65f8..87300bd8b6a2 100644\n--- a/servers/display_server.cpp\n+++ b/servers/display_server.cpp\n@@ -1331,10 +1331,14 @@ bool DisplayServer::is_rendering_device_supported() {\n \n \tError err;\n \n-#ifdef WINDOWS_ENABLED\n-\t// On some NVIDIA drivers combining OpenGL and RenderingDevice can result in crash, offload the check to the subprocess.\n+#if defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED)\n+\t// On some drivers combining OpenGL and RenderingDevice can result in crash, offload the check to the subprocess.\n \tList<String> arguments;\n \targuments.push_back(\"--test-rd-support\");\n+\tif (get_singleton()) {\n+\t\targuments.push_back(\"--display-driver\");\n+\t\targuments.push_back(get_singleton()->get_name().to_lower());\n+\t}\n \n \tString pipe;\n \tint exitcode = 0;\ndiff --git a/servers/rendering/renderer_rd/effects/luminance.cpp b/servers/rendering/renderer_rd/effects/luminance.cpp\nindex 4727e8fd9a9c..ab3ddb67b33b 100644\n--- a/servers/rendering/renderer_rd/effects/luminance.cpp\n+++ b/servers/rendering/renderer_rd/effects/luminance.cpp\n@@ -102,9 +102,10 @@ void Luminance::LuminanceBuffers::configure(RenderSceneBuffersRD *p_render_buffe\n \t\t\ttf.usage_bits = RD::TEXTURE_USAGE_COLOR_ATTACHMENT_BIT | RD::TEXTURE_USAGE_SAMPLING_BIT;\n \t\t} else {\n \t\t\ttf.usage_bits = RD::TEXTURE_USAGE_STORAGE_BIT;\n-\t\t\tif (final) {\n-\t\t\t\ttf.usage_bits |= RD::TEXTURE_USAGE_SAMPLING_BIT;\n-\t\t\t}\n+\t\t}\n+\n+\t\tif (final) {\n+\t\t\ttf.usage_bits |= RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_COPY_TO_BIT;\n \t\t}\n \n \t\tRID texture = RD::get_singleton()->texture_create(tf, RD::TextureView());\n@@ -112,6 +113,7 @@ void Luminance::LuminanceBuffers::configure(RenderSceneBuffersRD *p_render_buffe\n \n \t\tif (final) {\n \t\t\tcurrent = RD::get_singleton()->texture_create(tf, RD::TextureView());\n+\t\t\tRD::get_singleton()->texture_clear(current, Color(0.0, 0.0, 0.0), 0u, 1u, 0u, 1u);\n \t\t\tbreak;\n \t\t}\n \t}\ndiff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 5cea736eeb15..eebc6358ff62 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -1837,7 +1837,7 @@ RendererCanvasRenderRD::RendererCanvasRenderRD() {\n \t\tactions.base_varying_index = 5;\n \n \t\tactions.global_buffer_array_variable = \"global_shader_uniforms.data\";\n-\t\tactions.instance_uniform_index_variable = \"draw_data.instance_uniforms_ofs\";\n+\t\tactions.instance_uniform_index_variable = \"instances.data[instance_index].instance_uniforms_ofs\";\n \n \t\tshader.compiler.initialize(actions);\n \t}\ndiff --git a/servers/rendering/renderer_rd/shader_rd.cpp b/servers/rendering/renderer_rd/shader_rd.cpp\nindex cbdbe151c82f..ed9428a6a351 100644\n--- a/servers/rendering/renderer_rd/shader_rd.cpp\n+++ b/servers/rendering/renderer_rd/shader_rd.cpp\n@@ -555,7 +555,7 @@ void ShaderRD::_compile_version_start(Version *p_version, int p_group) {\n \tcompile_data.version = p_version;\n \tcompile_data.group = p_group;\n \n-\tWorkerThreadPool::GroupID group_task = WorkerThreadPool::get_singleton()->add_template_group_task(this, &ShaderRD::_compile_variant, compile_data, group_to_variant_map[p_group].size(), -1, true, SNAME(\"ShaderCompilation\"));\n+\tWorkerThreadPool::GroupID group_task = WorkerThreadPool::get_named_pool(SNAME(\"ShaderCompilationPool\"))->add_template_group_task(this, &ShaderRD::_compile_variant, compile_data, group_to_variant_map[p_group].size(), -1, true, SNAME(\"ShaderCompilation\"));\n \tp_version->group_compilation_tasks.write[p_group] = group_task;\n }\n \n@@ -563,9 +563,8 @@ void ShaderRD::_compile_version_end(Version *p_version, int p_group) {\n \tif (p_version->group_compilation_tasks.size() <= p_group || p_version->group_compilation_tasks[p_group] == 0) {\n \t\treturn;\n \t}\n-\n \tWorkerThreadPool::GroupID group_task = p_version->group_compilation_tasks[p_group];\n-\tWorkerThreadPool::get_singleton()->wait_for_group_task_completion(group_task);\n+\tWorkerThreadPool::get_named_pool(SNAME(\"ShaderCompilationPool\"))->wait_for_group_task_completion(group_task);\n \tp_version->group_compilation_tasks.write[p_group] = 0;\n \n \tbool all_valid = true;\ndiff --git a/servers/rendering/renderer_rd/shaders/canvas.glsl b/servers/rendering/renderer_rd/shaders/canvas.glsl\nindex c1510a11ca08..e2d9086a5de5 100644\n--- a/servers/rendering/renderer_rd/shaders/canvas.glsl\n+++ b/servers/rendering/renderer_rd/shaders/canvas.glsl\n@@ -48,6 +48,8 @@ layout(set = 1, binding = 0, std140) uniform MaterialUniforms {\n /* clang-format on */\n #endif\n \n+uint instance_index;\n+\n #GLOBALS\n \n #ifdef USE_ATTRIBUTES\n@@ -66,9 +68,9 @@ void main() {\n #endif\n \n #ifdef USE_ATTRIBUTES\n-\tuint instance_index = params.base_instance_index;\n+\tinstance_index = params.base_instance_index;\n #else\n-\tuint instance_index = gl_InstanceIndex + params.base_instance_index;\n+\tinstance_index = gl_InstanceIndex + params.base_instance_index;\n \tinstance_index_interp = instance_index;\n #endif // USE_ATTRIBUTES\n \tconst InstanceData draw_data = instances.data[instance_index];\n@@ -240,7 +242,7 @@ void main() {\n #include \"canvas_uniforms_inc.glsl\"\n \n #ifndef USE_ATTRIBUTES\n-layout(location = 4) in flat uint instance_index;\n+layout(location = 4) in flat uint instance_index_interp;\n #endif // USE_ATTRIBUTES\n \n layout(location = 0) in vec2 uv_interp;\n@@ -287,6 +289,8 @@ vec2 sdf_to_screen_uv(vec2 p_sdf) {\n \treturn p_sdf * canvas_data.sdf_to_screen;\n }\n \n+uint instance_index;\n+\n #GLOBALS\n \n #ifdef LIGHT_CODE_USED\n@@ -302,6 +306,7 @@ vec4 light_compute(\n \t\tvec2 screen_uv,\n \t\tvec2 uv,\n \t\tvec4 color, bool is_directional) {\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \tvec4 light = vec4(0.0);\n \tvec3 light_direction = vec3(0.0);\n \n@@ -461,10 +466,11 @@ void main() {\n \tvec2 vertex = vertex_interp;\n \n #ifdef USE_ATTRIBUTES\n-\tconst InstanceData draw_data = instances.data[params.base_instance_index];\n+\tinstance_index = params.base_instance_index;\n #else\n-\tconst InstanceData draw_data = instances.data[instance_index];\n+\tinstance_index = instance_index_interp;\n #endif // USE_ATTRIBUTES\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \n #if !defined(USE_ATTRIBUTES) && !defined(USE_PRIMITIVE)\n \ndiff --git a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\nindex d82ffed646a0..6924f11e346c 100644\n--- a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n@@ -814,7 +814,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \t\tp_particles->particles_material_uniform_set = RD::get_singleton()->uniform_set_create(uniforms, particles_shader.default_shader_rd, 1);\n \t}\n \n-\tdouble new_phase = Math::fmod((double)p_particles->phase + (p_delta / p_particles->lifetime) * p_particles->speed_scale, 1.0);\n+\tdouble new_phase = Math::fmod((double)p_particles->phase + (p_delta / p_particles->lifetime), 1.0);\n \n \t//move back history (if there is any)\n \tfor (uint32_t i = p_particles->frame_history.size() - 1; i > 0; i--) {\n@@ -839,7 +839,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tp_particles->phase = new_phase;\n \n \tframe_params.time = RendererCompositorRD::get_singleton()->get_total_time();\n-\tframe_params.delta = p_delta * p_particles->speed_scale;\n+\tframe_params.delta = p_delta;\n \tframe_params.random_seed = p_particles->random_seed;\n \tframe_params.explosiveness = p_particles->explosiveness;\n \tframe_params.randomness = p_particles->randomness;\n@@ -1158,6 +1158,10 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \t\t//fill the trail params\n \t\tfor (uint32_t i = 0; i < p_particles->trail_params.size(); i++) {\n \t\t\tuint32_t src_idx = i * p_particles->frame_history.size() / p_particles->trail_params.size();\n+\t\t\tif (p_particles->speed_scale <= 0.0) {\n+\t\t\t\t// Stop trails.\n+\t\t\t\tsrc_idx = 0;\n+\t\t\t}\n \t\t\tp_particles->trail_params[i] = p_particles->frame_history[src_idx];\n \t\t}\n \t} else {\n@@ -1529,7 +1533,6 @@ void ParticlesStorage::update_particles() {\n \t\t\t}\n \t\t}\n \n-\t\tbool zero_time_scale = Engine::get_singleton()->get_time_scale() <= 0.0;\n \t\tdouble todo = particles->request_process_time;\n \t\tif (particles->clear) {\n \t\t\ttodo += particles->pre_process_time;\n@@ -1554,37 +1557,26 @@ void ParticlesStorage::update_particles() {\n \t\t\tparticles->speed_scale = tmp_scale;\n \t\t}\n \n+\t\tdouble time_scale = MAX(particles->speed_scale, 0.0);\n+\n \t\tif (fixed_fps > 0) {\n-\t\t\tdouble frame_time;\n-\t\t\tdouble decr;\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\tframe_time = 0.0;\n-\t\t\t\tdecr = 1.0 / fixed_fps;\n-\t\t\t} else {\n-\t\t\t\tframe_time = 1.0 / fixed_fps;\n-\t\t\t\tdecr = frame_time;\n-\t\t\t}\n+\t\t\tdouble frame_time = 1.0 / fixed_fps;\n \t\t\tdouble delta = RendererCompositorRD::get_singleton()->get_frame_delta_time();\n \t\t\tif (delta > 0.1) { //avoid recursive stalls if fps goes below 10\n \t\t\t\tdelta = 0.1;\n \t\t\t} else if (delta <= 0.0) { //unlikely but..\n \t\t\t\tdelta = 0.001;\n \t\t\t}\n-\t\t\ttodo = particles->frame_remainder + delta;\n+\t\t\ttodo = particles->frame_remainder + delta * time_scale;\n \n \t\t\twhile (todo >= frame_time || particles->clear) {\n \t\t\t\t_particles_process(particles, frame_time);\n-\t\t\t\ttodo -= decr;\n+\t\t\t\ttodo -= frame_time;\n \t\t\t}\n \n \t\t\tparticles->frame_remainder = todo;\n-\n \t\t} else {\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\t_particles_process(particles, 0.0);\n-\t\t\t} else {\n-\t\t\t\t_particles_process(particles, RendererCompositorRD::get_singleton()->get_frame_delta_time());\n-\t\t\t}\n+\t\t\t_particles_process(particles, RendererCompositorRD::get_singleton()->get_frame_delta_time() * time_scale);\n \t\t}\n \n \t\t// Ensure that memory is initialized (the code above should ensure that _particles_process is always called at least once upon clearing).\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\nindex 02b28473951e..6808ebb06376 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n@@ -1275,15 +1275,21 @@ RID TextureStorage::texture_create_from_native_handle(RS::TextureType p_type, Im\n \t\t\tbreak;\n \n \t\tcase Image::FORMAT_ASTC_4x4:\n-\t\tcase Image::FORMAT_ASTC_4x4_HDR:\n \t\t\tformat = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n \t\t\tbreak;\n \n+\t\tcase Image::FORMAT_ASTC_4x4_HDR:\n+\t\t\tformat = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\tbreak;\n+\n \t\tcase Image::FORMAT_ASTC_8x8:\n-\t\tcase Image::FORMAT_ASTC_8x8_HDR:\n \t\t\tformat = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n \t\t\tbreak;\n \n+\t\tcase Image::FORMAT_ASTC_8x8_HDR:\n+\t\t\tformat = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\tbreak;\n+\n \t\tdefault:\n \t\t\t// Arbitrary fallback.\n \t\t\tformat = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n@@ -2197,24 +2203,16 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_ZERO;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_ONE;\n \t\t} break;\n-\t\tcase Image::FORMAT_ASTC_4x4:\n-\t\tcase Image::FORMAT_ASTC_4x4_HDR: {\n+\t\tcase Image::FORMAT_ASTC_4x4: {\n \t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n \t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_4x4) {\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n-\t\t\t\t}\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n \t\t\t} else {\n \t\t\t\t//not supported, reconvert\n \t\t\t\timage->decompress();\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_4x4) {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n-\t\t\t\t} else {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n-\t\t\t\t}\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n+\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n \t\t\t}\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n@@ -2222,24 +2220,31 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n \t\t} break; // astc 4x4\n-\t\tcase Image::FORMAT_ASTC_8x8:\n-\t\tcase Image::FORMAT_ASTC_8x8_HDR: {\n+\t\tcase Image::FORMAT_ASTC_4x4_HDR: {\n+\t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\t} else {\n+\t\t\t\t//not supported, reconvert\n+\t\t\t\timage->decompress();\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n+\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n+\t\t\t}\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n+\n+\t\t} break; // astc 4x4 HDR\n+\t\tcase Image::FORMAT_ASTC_8x8: {\n \t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n \t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_8x8) {\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n-\t\t\t\t}\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n \t\t\t} else {\n \t\t\t\t//not supported, reconvert\n \t\t\t\timage->decompress();\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_8x8) {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n-\t\t\t\t} else {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n-\t\t\t\t}\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n+\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n \t\t\t}\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n@@ -2247,6 +2252,21 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n \t\t} break; // astc 8x8\n+\t\tcase Image::FORMAT_ASTC_8x8_HDR: {\n+\t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\t} else {\n+\t\t\t\t//not supported, reconvert\n+\t\t\t\timage->decompress();\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n+\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n+\t\t\t}\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n+\n+\t\t} break; // astc 8x8 HDR\n \n \t\tdefault: {\n \t\t}\n@@ -2589,7 +2609,7 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break;\n \t\tcase RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK: {\n-\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4_HDR;\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4;\n \t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n \t\t\tr_format.rd_format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n@@ -2597,6 +2617,14 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n+\t\t} break;\n+\t\tcase RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK: {\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4_HDR;\n+\t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break; // astc 4x4\n \t\tcase RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK: {\n \t\t\t// Q: Do we do as we do below, just create the sRGB variant?\n@@ -2608,14 +2636,21 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break;\n \t\tcase RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK: {\n-\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8_HDR;\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8;\n \t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n \t\t\tr_format.rd_format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n-\n+\t\t} break;\n+\t\tcase RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8_HDR;\n+\t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break; // astc 8x8\n \n \t\tdefault: {\ndiff --git a/servers/rendering/renderer_viewport.cpp b/servers/rendering/renderer_viewport.cpp\nindex b816ca7a8ab2..3bbc05b62545 100644\n--- a/servers/rendering/renderer_viewport.cpp\n+++ b/servers/rendering/renderer_viewport.cpp\n@@ -141,12 +141,22 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_OFF;\n \t\t\t}\n \n-\t\t\t// Verify MetalFX upscaling support.\n-\t\t\tif (\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) ||\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL))) {\n-\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported in the current renderer. Falling back to bilinear 3D resolution scaling.\");\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) {\n+\t\t\t\tif (RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\t\t// Prefer MetalFX spatial if it is supported, which will be much more efficient than FSR2,\n+\t\t\t\t\t// as the hardware already will struggle with FSR2.\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling is not supported by the current renderer or hardware. Falling back to MetalFX Spatial scaling.\");\n+\t\t\t\t} else {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported by the current renderer or hardware. Falling back to FSR 2 scaling.\");\n+\t\t\t\t}\n+\t\t\t\tscaling_type = RS::scaling_3d_mode_type(scaling_3d_mode);\n+\t\t\t}\n+\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR;\n+\t\t\t\tWARN_PRINT_ONCE(\"MetalFX spatial upscaling is not supported by the current renderer or hardware. Falling back to FSR scaling.\");\n \t\t\t}\n \n \t\t\tRS::ViewportMSAA msaa_3d = p_viewport->msaa_3d;\n@@ -156,11 +166,9 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tdouble min_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MIN_SCALE) / 1000'000.0;\n \t\t\t\tdouble max_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MAX_SCALE) / 1000'000.0;\n \t\t\t\tif ((double)scaling_3d_scale < min_scale || (double)scaling_3d_scale > max_scale) {\n-\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to bilinear 3D resolution scaling.\", min_scale, max_scale));\n-\t\t\t\t}\n-\n-\t\t\t\tif (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to FSR 2 3D resolution scaling.\", min_scale, max_scale));\n+\t\t\t\t} else if (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n \t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling does not support 3D MSAA. Disabling 3D MSAA internally.\");\n \t\t\t\t\tmsaa_3d = RS::VIEWPORT_MSAA_DISABLED;\n \t\t\t\t}\n@@ -170,7 +178,7 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\tbool use_taa = p_viewport->use_taa;\n \n \t\t\tif (scaling_3d_is_not_bilinear && (scaling_3d_scale >= (1.0 + EPSILON))) {\n-\t\t\t\t// FSR is not designed for downsampling.\n+\t\t\t\t// FSR and MetalFX is not designed for downsampling.\n \t\t\t\t// Fall back to bilinear scaling.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 3D resolution scaling is not designed for downsampling. Falling back to bilinear 3D resolution scaling.\");\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n@@ -184,8 +192,8 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t}\n \n \t\t\tif (use_taa && (scaling_type == RS::VIEWPORT_SCALING_3D_TYPE_TEMPORAL)) {\n-\t\t\t\t// FSR2 can't be used with TAA.\n-\t\t\t\t// Turn it off and prefer using FSR2.\n+\t\t\t\t// Temporal upscalers can't be used with TAA.\n+\t\t\t\t// Turn it off and prefer using the temporal upscaler.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 2 or MetalFX Temporal is not compatible with TAA. Disabling TAA internally.\");\n \t\t\t\tuse_taa = false;\n \t\t\t}\ndiff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9a3e4fd9d7fa..cf6cbf187132 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -7680,6 +7680,20 @@ void RenderingDevice::_bind_methods() {\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16R16_2PLANE_422_UNORM);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_MAX);\n \n #ifndef DISABLE_DEPRECATED\ndiff --git a/servers/rendering/rendering_device_commons.cpp b/servers/rendering/rendering_device_commons.cpp\nindex 03fad5493a01..a11ffe57dd15 100644\n--- a/servers/rendering/rendering_device_commons.cpp\n+++ b/servers/rendering/rendering_device_commons.cpp\n@@ -253,6 +253,20 @@ const char *const RenderingDeviceCommons::FORMAT_NAMES[DATA_FORMAT_MAX] = {\n \t\"G16_B16_R16_3Plane_422_Unorm\",\n \t\"G16_B16R16_2Plane_422_Unorm\",\n \t\"G16_B16_R16_3Plane_444_Unorm\",\n+\t\"Astc_4X4_Sfloat_Block\",\n+\t\"Astc_5X4_Sfloat_Block\",\n+\t\"Astc_5X5_Sfloat_Block\",\n+\t\"Astc_6X5_Sfloat_Block\",\n+\t\"Astc_6X6_Sfloat_Block\",\n+\t\"Astc_8X5_Sfloat_Block\",\n+\t\"Astc_8X6_Sfloat_Block\",\n+\t\"Astc_8X8_Sfloat_Block\",\n+\t\"Astc_10X5_Sfloat_Block\",\n+\t\"Astc_10X6_Sfloat_Block\",\n+\t\"Astc_10X8_Sfloat_Block\",\n+\t\"Astc_10X10_Sfloat_Block\",\n+\t\"Astc_12X10_Sfloat_Block\",\n+\t\"Astc_12X12_Sfloat_Block\",\n };\n \n /*****************/\n@@ -477,6 +491,20 @@ uint32_t RenderingDeviceCommons::get_image_format_pixel_size(DataFormat p_format\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\treturn 1;\n \t\tcase DATA_FORMAT_G8B8G8R8_422_UNORM:\n \t\tcase DATA_FORMAT_B8G8R8G8_422_UNORM:\n@@ -554,42 +582,56 @@ void RenderingDeviceCommons::get_compressed_image_format_block_dimensions(DataFo\n \t\tcase DATA_FORMAT_EAC_R11G11_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_EAC_R11G11_SNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_4x4_UNORM_BLOCK: // Again, not sure about astc.\n-\t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK: {\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_5x4_UNORM_BLOCK: // Unsupported\n \t\tcase DATA_FORMAT_ASTC_5x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_UNORM_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK: {\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n \t\t\tr_w = 8;\n \t\t\tr_h = 8;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_10x5_UNORM_BLOCK: // Unsupported\n \t\tcase DATA_FORMAT_ASTC_10x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t\treturn;\n@@ -642,32 +684,46 @@ uint32_t RenderingDeviceCommons::get_compressed_image_format_block_byte_size(Dat\n \t\t\treturn 16;\n \t\tcase DATA_FORMAT_ASTC_4x4_UNORM_BLOCK: // Again, not sure about astc.\n \t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x4_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\treturn 16;\n \t\tdefault: {\n \t\t}\n@@ -691,7 +747,8 @@ uint32_t RenderingDeviceCommons::get_compressed_image_format_pixel_rshift(DataFo\n \t\tcase DATA_FORMAT_EAC_R11_SNORM_BLOCK:\n \t\t\treturn 1;\n \t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n \t\t\treturn 2;\n \t\t}\n \t\tdefault: {\ndiff --git a/servers/rendering/rendering_device_commons.h b/servers/rendering/rendering_device_commons.h\nindex aa8beed35785..796e3c2b66c6 100644\n--- a/servers/rendering/rendering_device_commons.h\n+++ b/servers/rendering/rendering_device_commons.h\n@@ -270,6 +270,20 @@ class RenderingDeviceCommons : public Object {\n \t\tDATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM,\n \t\tDATA_FORMAT_G16_B16R16_2PLANE_422_UNORM,\n \t\tDATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM,\n+\t\tDATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK, // HDR variant.\n \t\tDATA_FORMAT_MAX,\n \t};\n \ndiff --git a/servers/rendering/shader_language.cpp b/servers/rendering/shader_language.cpp\nindex 59adb53b7866..66a43684a52a 100644\n--- a/servers/rendering/shader_language.cpp\n+++ b/servers/rendering/shader_language.cpp\n@@ -1342,7 +1342,7 @@ void ShaderLanguage::_parse_used_identifier(const StringName &p_identifier, Iden\n \t\t\tbreak;\n \t\tcase IdentifierType::IDENTIFIER_VARYING:\n \t\t\tif (HAS_WARNING(ShaderWarning::UNUSED_VARYING_FLAG) && used_varyings.has(p_identifier)) {\n-\t\t\t\tif (shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_VERTEX && shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_FRAGMENT) {\n+\t\t\t\tif (shader->varyings[p_identifier].stage == ShaderNode::Varying::STAGE_UNKNOWN) {\n \t\t\t\t\tused_varyings[p_identifier].used = true;\n \t\t\t\t}\n \t\t\t}\n@@ -6510,6 +6510,27 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t_set_error(RTR(\"Expected constant expression.\"));\n \t\t\t\t\t\treturn nullptr;\n \t\t\t\t\t}\n+\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n+\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n+\t\t\t\t\t\treturn nullptr;\n+\t\t\t\t\t}\n+#ifdef DEBUG_ENABLED\n+\t\t\t\t\tif (check_warnings) {\n+\t\t\t\t\t\tStringName func_name;\n+\t\t\t\t\t\tBlockNode *b = p_block;\n+\n+\t\t\t\t\t\twhile (b) {\n+\t\t\t\t\t\t\tif (b->parent_function) {\n+\t\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n+\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tb = b->parent_block;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n+\t\t\t\t\t}\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (ident_type == IDENTIFIER_VARYING) {\n \t\t\t\t\t\tTkPos prev_pos = _get_tkpos();\n \t\t\t\t\t\tToken next_token = _get_token();\n@@ -6542,11 +6563,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-\n-\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n-\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n-\t\t\t\t\t\treturn nullptr;\n-\t\t\t\t\t}\n #ifdef DEBUG_ENABLED\n \t\t\t\t\tif (check_position_write && ident_type == IDENTIFIER_BUILTIN_VAR) {\n \t\t\t\t\t\tif (String(identifier) == \"POSITION\") {\n@@ -6564,7 +6580,7 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t_set_tkpos(prev_pos);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-#endif\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (is_const) {\n \t\t\t\t\t\tlast_type = IDENTIFIER_CONSTANT;\n \t\t\t\t\t} else {\n@@ -6656,23 +6672,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\tvarname->is_local = is_local;\n \t\t\t\t\texpr = varname;\n \t\t\t\t}\n-#ifdef DEBUG_ENABLED\n-\t\t\t\tif (check_warnings) {\n-\t\t\t\t\tStringName func_name;\n-\t\t\t\t\tBlockNode *b = p_block;\n-\n-\t\t\t\t\twhile (b) {\n-\t\t\t\t\t\tif (b->parent_function) {\n-\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tb = b->parent_block;\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\n-\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n-\t\t\t\t}\n-#endif // DEBUG_ENABLED\n \t\t\t}\n \t\t} else if (tk.type == TK_OP_ADD) {\n \t\t\tcontinue; //this one does nothing\ndiff --git a/thirdparty/misc/yuv2rgb.h b/thirdparty/misc/yuv2rgb.h\nindex d8f7fd6de2d0..e8ccd427d027 100644\n--- a/thirdparty/misc/yuv2rgb.h\n+++ b/thirdparty/misc/yuv2rgb.h\n@@ -30,6 +30,7 @@ ship it.\n  * 2. At some point or another the code relied on the byte order of a uint32_t, this has been fixed\n  * 3. Output has been reordered to struct { uint8_t r, g, b, a; } precisely in accordance with the function names\n  * 4. Removing unused 'dither' parameter\n+ * 5. Fix last line not being converted (and therefore was transparent)\n  */\n \n #ifndef YUV2RGB_H\n@@ -848,7 +849,6 @@ static void yuv422_2_rgb8888(uint8_t  *dst_ptr,\n \t\t      int32_t   uv_span,\n \t\t      int32_t   dst_span)\n {\n-    height -= 1;\n     while (height > 0)\n     {\n \theight -= width<<16;\n@@ -1020,7 +1020,6 @@ static void yuv444_2_rgb8888(uint8_t  *dst_ptr,\n \t\t      int32_t   uv_span,\n \t\t      int32_t   dst_span)\n {\n-    height -= 1;\n     while (height > 0)\n     {\n \theight -= width<<16;\ndiff --git a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\nindex d29ac01af384..25ce813968f7 100644\n--- a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n+++ b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n@@ -31,11 +31,12 @@\n \n // There are separate versions for each GameSDK component that use this format:\n #define ANDROID_GAMESDK_PACKED_VERSION(MAJOR, MINOR, BUGFIX) \\\n-    ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n+  ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n // Accessors\n #define ANDROID_GAMESDK_MAJOR_VERSION(PACKED) ((PACKED) >> 16)\n #define ANDROID_GAMESDK_MINOR_VERSION(PACKED) (((PACKED) >> 8) & 0xff)\n #define ANDROID_GAMESDK_BUGFIX_VERSION(PACKED) ((PACKED) & 0xff)\n \n-#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX, GIT) \\\n-#MAJOR \".\" #MINOR \".\" #BUGFIX \".\" #GIT\n+#define AGDK_STRINGIFY(NUMBER) #NUMBER\n+#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX) \\\n+  AGDK_STRINGIFY(MAJOR) \".\" AGDK_STRINGIFY(MINOR) \".\" AGDK_STRINGIFY(BUGFIX)\ndiff --git a/thirdparty/swappy-frame-pacing/swappyVk.h b/thirdparty/swappy-frame-pacing/swappyVk.h\nindex 020683cbc43c..654fcbf4a4a7 100644\n--- a/thirdparty/swappy-frame-pacing/swappyVk.h\n+++ b/thirdparty/swappy-frame-pacing/swappyVk.h\n@@ -281,30 +281,30 @@ void SwappyVk_uninjectTracer(const SwappyTracer* tracer);\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyVkFunctionProvider {\n-    /**\n-     * @brief Callback to initialize the function provider.\n-     *\n-     * This function is called by Swappy before any functions are requested.\n-     * E.g. so you can call dlopen on the Vulkan library.\n-     */\n-    bool (*init)();\n-\n-    /**\n-     * @brief Callback to get the address of a function.\n-     *\n-     * This function is called by Swappy to get the address of a Vulkan\n-     * function.\n-     * @param name The null-terminated name of the function.\n-     */\n-    void* (*getProcAddr)(const char* name);\n-\n-    /**\n-     * @brief Callback to close any resources owned by the function provider.\n-     *\n-     * This function is called by Swappy when no more functions will be\n-     * requested, e.g. so you can call dlclose on the Vulkan library.\n-     */\n-    void (*close)();\n+  /**\n+   * @brief Callback to initialize the function provider.\n+   *\n+   * This function is called by Swappy before any functions are requested.\n+   * E.g. so you can call dlopen on the Vulkan library.\n+   */\n+  bool (*init)();\n+\n+  /**\n+   * @brief Callback to get the address of a function.\n+   *\n+   * This function is called by Swappy to get the address of a Vulkan\n+   * function.\n+   * @param name The null-terminated name of the function.\n+   */\n+  void* (*getProcAddr)(const char* name);\n+\n+  /**\n+   * @brief Callback to close any resources owned by the function provider.\n+   *\n+   * This function is called by Swappy when no more functions will be\n+   * requested, e.g. so you can call dlclose on the Vulkan library.\n+   */\n+  void (*close)();\n } SwappyVkFunctionProvider;\n \n /**\n@@ -384,7 +384,8 @@ void SwappyVk_enableStats(VkSwapchainKHR swapchain, bool enabled);\n \n  * @see SwappyVk_enableStats.\n  */\n-void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t image);\n+void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain,\n+                               uint32_t image);\n \n /**\n  * @brief Returns the stats collected, if statistics collection was toggled on.\n@@ -396,11 +397,11 @@ void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t\n  * conditions.\n  *\n  * @param[in]  swapchain   - The swapchain for which stats are being queried.\n- * @param      swappyStats - Pointer to a SwappyStats that will be populated with\n- *                             the collected stats. Cannot be NULL.\n+ * @param      swappyStats - Pointer to a SwappyStats that will be populated\n+ * with the collected stats. Cannot be NULL.\n  * @see SwappyStats\n  */\n-void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n+void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats* swappyStats);\n \n /**\n  * @brief Clears the frame statistics collected so far.\n@@ -413,6 +414,58 @@ void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n  */\n void SwappyVk_clearStats(VkSwapchainKHR swapchain);\n \n+/**\n+ * @brief Reset the swappy pacing mechanism\n+ *\n+ * In cases where the frame timing history is irrelevant (for example during\n+ * scene/level transitions or after loading screens), calling this would\n+ * remove all the history for frame pacing. Calling this entry point\n+ * would reset the frame rate to the initial state at the end of the current\n+ * frame. Then swappy would just pace as normal with fresh state from next\n+ * frame. There are no error conditions associated with this call.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which frame pacing is reset.\n+ */\n+void SwappyVk_resetFramePacing(VkSwapchainKHR swapchain);\n+\n+/**\n+ * @brief Enable/Disable the swappy pacing mechanism\n+ *\n+ * By default frame pacing is enabled when swappy is used, however it can be\n+ * disabled at runtime by calling `SwappyVk_enableFramePacing(swapchain,\n+ * false)`. When the frame pacing is disabled, ::SwappyVk_enableBlockingWait\n+ * will control whether\n+ * ::SwappyVk_queuePresent will return immediately, or will block until the\n+ * previous frame's GPU work is completed. All enabling/disabling effects take\n+ * place from next frame. Once disabled, `SwappyVk_enableFramePacing(swapchain,\n+ * true)` will enable frame pacing again with a fresh frame time state -\n+ * equivalent of calling ::SwappyVk_resetFramePacing().\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, enables frame pacing otherwise disables it\n+ */\n+void SwappyVk_enableFramePacing(VkSwapchainKHR swapchain, bool enable);\n+\n+/**\n+ * @brief Enable/Disable blocking wait when frame-pacing is disabled\n+ *\n+ * By default ::SwappyVk_queuePresent will do a blocking wait until previous\n+ * frame's GPU work is completed. However when frame pacing is disabled, calling\n+ * `SwappyVk_enableBlockingWait(swapchain, false)` will ensure that\n+ * ::SwappyVk_queuePresent returns without waiting for previous frame's GPU\n+ * work. This behaviour impacts the GPU time returned in the\n+ * ::SwappyPostWaitCallback callback. If the last frame's GPU work is done by\n+ * the time ::SwappyVk_queuePresent for this frame is called, then the previous\n+ * frame's GPU time will be returned otherwise `-1` will be delivered in the\n+ * callback for the frame. This setting has no impact when frame pacing is\n+ * enabled.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, ::SwappyVk_queuePresent will block until\n+ * the previous frame's GPU work is complete.\n+ */\n+void SwappyVk_enableBlockingWait(VkSwapchainKHR swapchain, bool enable);\n+\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\ndiff --git a/thirdparty/swappy-frame-pacing/swappy_common.h b/thirdparty/swappy-frame-pacing/swappy_common.h\nindex b711ca910fb3..acceb4243df6 100644\n--- a/thirdparty/swappy-frame-pacing/swappy_common.h\n+++ b/thirdparty/swappy-frame-pacing/swappy_common.h\n@@ -48,22 +48,22 @@\n \n // Internal macros to track Swappy version, do not use directly.\n #define SWAPPY_MAJOR_VERSION 2\n-#define SWAPPY_MINOR_VERSION 0\n+#define SWAPPY_MINOR_VERSION 2\n #define SWAPPY_BUGFIX_VERSION 0\n-#define SWAPPY_PACKED_VERSION                                                  \\\n-    ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n-                                   SWAPPY_BUGFIX_VERSION)\n+#define SWAPPY_PACKED_VERSION                                                \\\n+  ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n+                                 SWAPPY_BUGFIX_VERSION)\n \n // Internal macros to generate a symbol to track Swappy version, do not use\n // directly.\n #define SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n+  PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n #define SWAPPY_VERSION_CONCAT(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n-#define SWAPPY_VERSION_SYMBOL                                          \\\n-    SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n-                          SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n-                          AGDK_GIT_COMMIT)\n+  SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n+#define SWAPPY_VERSION_SYMBOL                                        \\\n+  SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n+                        SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n+                        AGDK_GIT_COMMIT)\n \n // Define this to 1 to enable all logging from Swappy, by default it is\n // disabled in a release build and enabled in a debug build.\n@@ -83,29 +83,29 @@ typedef uint64_t SwappyThreadId;\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyThreadFunctions {\n-    /** @brief Thread start callback.\n-     *\n-     * This function is called by Swappy to start thread_func on a new thread.\n-     * @param user_data A value to be passed the thread function.\n-     * If the thread was started, this function should set the thread_id and\n-     * return 0. If the thread was not started, this function should return a\n-     * non-zero value.\n-     */\n-    int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n-                 void* user_data);\n-\n-    /** @brief Thread join callback.\n-     *\n-     * This function is called by Swappy to join the thread with given id.\n-     */\n-    void (*join)(SwappyThreadId thread_id);\n-\n-    /** @brief Thread joinable callback.\n-     *\n-     * This function is called by Swappy to discover whether the thread with the\n-     * given id is joinable.\n-     */\n-    bool (*joinable)(SwappyThreadId thread_id);\n+  /** @brief Thread start callback.\n+   *\n+   * This function is called by Swappy to start thread_func on a new thread.\n+   * @param user_data A value to be passed the thread function.\n+   * If the thread was started, this function should set the thread_id and\n+   * return 0. If the thread was not started, this function should return a\n+   * non-zero value.\n+   */\n+  int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n+               void* user_data);\n+\n+  /** @brief Thread join callback.\n+   *\n+   * This function is called by Swappy to join the thread with given id.\n+   */\n+  void (*join)(SwappyThreadId thread_id);\n+\n+  /** @brief Thread joinable callback.\n+   *\n+   * This function is called by Swappy to discover whether the thread with the\n+   * given id is joinable.\n+   */\n+  bool (*joinable)(SwappyThreadId thread_id);\n } SwappyThreadFunctions;\n \n #ifdef __cplusplus\n@@ -138,47 +138,46 @@ const char* Swappy_versionString();\n  * ::SwappyGL_enableStats or ::SwappyVk_enableStats.\n  */\n typedef struct SwappyStats {\n-    /** @brief Total frames swapped by swappy */\n-    uint64_t totalFrames;\n-\n-    /** @brief Histogram of the number of screen refreshes a frame waited in the\n-     * compositor queue after rendering was completed.\n-     *\n-     * For example:\n-     *     if a frame waited 2 refresh periods in the compositor queue after\n-     * rendering was done, the frame will be counted in idleFrames[2]\n-     */\n-    uint64_t idleFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * requested presentation time and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the requested\n-     * timestamp swappy set, the frame will be counted in lateFrames[2]\n-     */\n-    uint64_t lateFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between two\n-     * consecutive frames\n-     *\n-     * For example:\n-     *     if frame N was presented 2 refresh periods after frame N-1\n-     *     frame N will be counted in offsetFromPreviousFrame[2]\n-     */\n-    uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * call to Swappy_recordFrameStart and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the call to\n-     * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n-     */\n-    uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n+  /** @brief Total frames swapped by swappy */\n+  uint64_t totalFrames;\n+\n+  /** @brief Histogram of the number of screen refreshes a frame waited in the\n+   * compositor queue after rendering was completed.\n+   *\n+   * For example:\n+   *     if a frame waited 2 refresh periods in the compositor queue after\n+   * rendering was done, the frame will be counted in idleFrames[2]\n+   */\n+  uint64_t idleFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * requested presentation time and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the requested\n+   * timestamp swappy set, the frame will be counted in lateFrames[2]\n+   */\n+  uint64_t lateFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between two\n+   * consecutive frames\n+   *\n+   * For example:\n+   *     if frame N was presented 2 refresh periods after frame N-1\n+   *     frame N will be counted in offsetFromPreviousFrame[2]\n+   */\n+  uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * call to Swappy_recordFrameStart and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the call to\n+   * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n+   */\n+  uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n } SwappyStats;\n \n-\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\n@@ -236,43 +235,43 @@ typedef void (*SwappySwapIntervalChangedCallback)(void*);\n  * Injection of these is optional.\n  */\n typedef struct SwappyTracer {\n-    /**\n-     * Callback called before waiting to queue the frame to the composer.\n-     */\n-    SwappyPreWaitCallback preWait;\n-\n-    /**\n-     * Callback called after wait to queue the frame to the composer is done.\n-     */\n-    SwappyPostWaitCallback postWait;\n-\n-    /**\n-     * Callback called before calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPreSwapBuffersCallback preSwapBuffers;\n-\n-    /**\n-     * Callback called after calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPostSwapBuffersCallback postSwapBuffers;\n-\n-    /**\n-     * Callback called at the start of a frame.\n-     */\n-    SwappyStartFrameCallback startFrame;\n-\n-    /**\n-     * Pointer to some arbitrary data that will be passed as the first argument\n-     * of callbacks.\n-     */\n-    void* userData;\n-\n-    /**\n-     * Callback called when the swap interval was changed.\n-     */\n-    SwappySwapIntervalChangedCallback swapIntervalChanged;\n+  /**\n+   * Callback called before waiting to queue the frame to the composer.\n+   */\n+  SwappyPreWaitCallback preWait;\n+\n+  /**\n+   * Callback called after wait to queue the frame to the composer is done.\n+   */\n+  SwappyPostWaitCallback postWait;\n+\n+  /**\n+   * Callback called before calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPreSwapBuffersCallback preSwapBuffers;\n+\n+  /**\n+   * Callback called after calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPostSwapBuffersCallback postSwapBuffers;\n+\n+  /**\n+   * Callback called at the start of a frame.\n+   */\n+  SwappyStartFrameCallback startFrame;\n+\n+  /**\n+   * Pointer to some arbitrary data that will be passed as the first argument\n+   * of callbacks.\n+   */\n+  void* userData;\n+\n+  /**\n+   * Callback called when the swap interval was changed.\n+   */\n+  SwappySwapIntervalChangedCallback swapIntervalChanged;\n } SwappyTracer;\n \n /** @} */\n", "test_patch": "diff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\nindex abeadbe5eedd..6b4f1b6e8350 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim := $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\nindex d11f81e98537..4b8b001528e9 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim: AnimationPlayer = $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\nindex 4ddfd21ac60f..fb3fe915fd41 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim = $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd b/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\nindex dc7cc9955410..5586317938ee 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\n@@ -1,5 +1,5 @@\n extends Node\n \n func a():\n-    %AnimationPlayer.\u27a1\n+    $UniqueAnimationPlayer.\u27a1\n     pass\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd b/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\nindex 5586317938ee..dc7cc9955410 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\n@@ -1,5 +1,5 @@\n extends Node\n \n func a():\n-    $UniqueAnimationPlayer.\u27a1\n+    %AnimationPlayer.\u27a1\n     pass\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\nsimilarity index 66%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\nindex 402fd1d275de..877ac442a91f 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test := $A\n+@onready var test := $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\nsimilarity index 55%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\nindex 97b288334ed4..0b511e4c72c9 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test := $AnimationPlayer\n+@onready var test := $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\nindex 6188a6e843c0..0dad242872f0 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test = $A\n+@onready var test = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\nindex 80b49439532c..43e6c3bc78f0 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test = $AnimationPlayer\n+@onready var test = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\nindex 7f2cb4e8cc73..f4a0c6d7cec9 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: AnimationPlayer = $AnimationPlayer\n+@onready var test: AnimationPlayer = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\nindex aac450be9f2b..5df4c0ec4c9d 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Node = $A\n+@onready var test: Node = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\nindex 9eb10e49339f..991449d728a5 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Node = $AnimationPlayer\n+@onready var test: Node = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\nindex ff8214c46329..a3cdece9561a 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Area2D = $A\n+@onready var test: Area2D = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\nindex 30cd7d6a21a3..b0c99d4e16a6 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Area2D = $AnimationPlayer\n+@onready var test: Area2D = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/types/local/infered.cfg b/modules/gdscript/tests/scripts/completion/types/local/inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/local/infered.cfg\nrename to modules/gdscript/tests/scripts/completion/types/local/inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/types/local/infered.gd b/modules/gdscript/tests/scripts/completion/types/local/inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/local/infered.gd\nrename to modules/gdscript/tests/scripts/completion/types/local/inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/types/member/infered.cfg b/modules/gdscript/tests/scripts/completion/types/member/inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/member/infered.cfg\nrename to modules/gdscript/tests/scripts/completion/types/member/inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/types/member/infered.gd b/modules/gdscript/tests/scripts/completion/types/member/inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/member/infered.gd\nrename to modules/gdscript/tests/scripts/completion/types/member/inferred.gd\ndiff --git a/modules/gdscript/tests/test_completion.h b/modules/gdscript/tests/test_completion.h\nindex 844c2675e3ea..95201190131d 100644\n--- a/modules/gdscript/tests/test_completion.h\n+++ b/modules/gdscript/tests/test_completion.h\n@@ -161,6 +161,8 @@ static void test_directory(const String &p_dir) {\n \t\t\t\towner = scene->get_node(conf.get_value(\"input\", \"node_path\", \".\"));\n \t\t\t}\n \n+\t\t\t// The only requirement is for the script to be parsable, warnings and errors from the analyzer might happen and completion should still work.\n+\t\t\tERR_PRINT_OFF;\n \t\t\tif (owner != nullptr) {\n \t\t\t\t// Remove the line which contains the sentinel char, to get a valid script.\n \t\t\t\tRef<GDScript> scr;\n@@ -184,6 +186,8 @@ static void test_directory(const String &p_dir) {\n \t\t\t}\n \n \t\t\tGDScriptLanguage::get_singleton()->complete_code(code, res_path, owner, &options, forced, call_hint);\n+\t\t\tERR_PRINT_ON;\n+\n \t\t\tString contains_excluded;\n \t\t\tfor (ScriptLanguage::CodeCompletionOption &option : options) {\n \t\t\t\tfor (const Dictionary &E : exclude) {\ndiff --git a/tests/core/templates/test_a_hash_map.h b/tests/core/templates/test_a_hash_map.h\nindex 4fa6d3bca41c..6e60addc6046 100644\n--- a/tests/core/templates/test_a_hash_map.h\n+++ b/tests/core/templates/test_a_hash_map.h\n@@ -235,9 +235,13 @@ TEST_CASE(\"[AHashMap] Insert, iterate and remove many elements\") {\n TEST_CASE(\"[AHashMap] Insert, iterate and remove many strings\") {\n \tconst int elem_max = 432;\n \tAHashMap<String, String> map;\n+\n+\t// To not print WARNING: Excessive collision count (NN), is the right hash function being used?\n+\tERR_PRINT_OFF;\n \tfor (int i = 0; i < elem_max; i++) {\n \t\tmap.insert(itos(i), itos(i));\n \t}\n+\tERR_PRINT_ON;\n \n \t//insert order should have been kept\n \tint idx = 0;\ndiff --git a/tests/scene/test_code_edit.h b/tests/scene/test_code_edit.h\nindex 1c85d3e41c36..de55fc709603 100644\n--- a/tests/scene/test_code_edit.h\n+++ b/tests/scene/test_code_edit.h\n@@ -4492,7 +4492,8 @@ TEST_CASE(\"[SceneTree][CodeEdit] symbol lookup\") {\n \n \t\tPoint2 caret_pos = code_edit->get_caret_draw_pos();\n \t\tcaret_pos.x += 60;\n-\t\tSEND_GUI_MOUSE_BUTTON_EVENT(caret_pos, MouseButton::NONE, 0, Key::NONE);\n+\n+\t\tSEND_GUI_MOUSE_MOTION_EVENT(caret_pos, MouseButtonMask::NONE, Key::NONE);\n \t\tCHECK(code_edit->get_text_for_symbol_lookup() == \"this is s\" + String::chr(0xFFFF) + \"ome text\");\n \n \t\tSIGNAL_WATCH(code_edit, \"symbol_validate\");\ndiff --git a/tests/scene/test_text_edit.h b/tests/scene/test_text_edit.h\nindex d7192def6212..aa7a9bb23c40 100644\n--- a/tests/scene/test_text_edit.h\n+++ b/tests/scene/test_text_edit.h\n@@ -8014,6 +8014,8 @@ TEST_CASE(\"[SceneTree][TextEdit] gutters\") {\n \tSIGNAL_WATCH(text_edit, \"gutter_removed\");\n \n \tSUBCASE(\"[TextEdit] gutter add and remove\") {\n+\t\ttext_edit->set_text(\"test1\\ntest2\\ntest3\\ntest4\");\n+\n \t\ttext_edit->add_gutter();\n \t\tCHECK(text_edit->get_gutter_count() == 1);\n \t\tCHECK(text_edit->get_gutter_width(0) == 24);\ndiff --git a/tests/test_main.cpp b/tests/test_main.cpp\nindex c12e92708177..2d8f2c769155 100644\n--- a/tests/test_main.cpp\n+++ b/tests/test_main.cpp\n@@ -306,7 +306,7 @@ struct GodotTestCaseListener : public doctest::IReporter {\n \t\t\t// So we have to do this for each test case. Also make sure there is\n \t\t\t// no residual theme from something else.\n \t\t\tThemeDB::get_singleton()->finalize_theme();\n-\t\t\tThemeDB::get_singleton()->initialize_theme_noproject();\n+\t\t\tThemeDB::get_singleton()->initialize_theme();\n \n #ifndef _3D_DISABLED\n \t\t\tphysics_server_3d = PhysicsServer3DManager::get_singleton()->new_default_server();\n", "problem_statement": "Gray line at the bottom of scaled VideoStreamPlayer\n### Tested versions\n\nGodot Engine v4.2.1.stable.official.b09f793f5 - https://godotengine.org\r\n\r\n\n\n### System information\n\nLinux; Vulkan API 1.3.255 - Forward+ - Using Vulkan Device #0: AMD - AMD Radeon RX 5600 XT (RADV NAVI10)  \n\n### Issue description\n\nWhen have a VideoStreamPlayer that's scaled down (in my case, to 50%), when the video plays, it shows a gray line at the bottom.  The gray line is not visible when I play the video at 1:1 scale.\r\n\r\nI don't think this is the same as #62752 -- first, I think my video doesn't have any overscan since its resolution is a multiple of 16, and second, it doesn't manifest as duplication but as a grey line.\r\n\r\n![gray-line](https://github.com/godotengine/godot/assets/77003/13a89274-61ea-4d83-a44f-52dc807e4e7f)\r\n\r\nWeirdly, it seems to depend on some tiny details of the video file.  I have one video file which experiences it, and one that doesn't even though both are the same resolution, frame rate, etc.  The one with the line is made by:\r\n`ffmpeg -r 30  -pattern_type sequence -i out/cat-%06d.png    -map 0:v  -y  cat.ogv`\r\nThe one without is made by:\r\n`theora_png2theora -k 30 -f 30 out/cat-%06d.png -o cat2.ogv`\r\n\r\nUnfortunately, as you can see, the second one produces a video with the wrong color (and I have to run it through ffmpeg anyway to get the audio added; to save you from having to hear my awful voice acting looping over and over, I didn't add the audio to either of the clips in the repro project).  \n\n### Steps to reproduce\n\nThe attached sample code reproduces this issue.  I have a VideoStreamPlayer which is scaled (in this case, the root node is scaled, because that pretty closely matches my actual project).   There are actually two players, to demonstrate that the effect depends on some weird detail of the actual video; the one on the left is the one with the problem (the color mismatch on the right is Theora's fault not Godot's).\n\n### Minimal reproduction project (MRP)\n\n[white-line.zip](https://github.com/godotengine/godot/files/14086142/white-line.zip)\r\n\nMetalFX Temporal upscaling fallback on non-supported rendering drivers does not disable TAA jitter (or fallback to FSR2)\n### Tested versions\n\n- Reproducible in: 4.4.stable\n- MetalFX is not available before 4.4.\n\n### System information\n\nGodot v4.4.stable (4c311cbee) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4090 (nvidia; 570.86.16) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nWhen attempting to use MetalFX Temporal upscaling on an unsupported rendering driver, the TAA jitter is still active despite not being needed with bilinear scaling. MetalFX Spatial upscaling doesn't have this issue, as it doesn't engage TAA jitter in the first place due to its purely spatial nature.\n\nAlternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\ncc @stuartcarnie \n\nhttps://github.com/user-attachments/assets/bde8cd82-63ba-4f82-ba59-0be8e46ea63c\n\n### Steps to reproduce\n\n- Create a project using the Forward+ rendering method.\n- Set the root viewport's 3D scaling mode to MetalFX Temporal using a script on a platform/renderer that doesn't support MetalFX upscaling (Windows, Linux, or macOS when using MoltenVK):\n```gdscript\nfunc _ready() -> void:\n    get_window().scaling_3d_mode = Viewport.SCALING_3D_MODE_METALFX_TEMPORAL\n```\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/godotengine/tps-demo/pull/196\n*Change the check in the demo's code from `== \"metal\"` to `!= \"metal` to test this on unsupported drivers. I suggest using the Ultra Performance scaling mode so the issue is more noticeable.*\n", "hints_text": "I've fixed #62752 and this still happens so I don't think they're related at all.\nIt only happens when texture filter is set to linear. Setting the filter to nearest removes the gray line.\n\nIt's weird that it happens only in one of the videos but the background color is different so that might be the reason.\nVideo on the left with the gray line:\n\n```\n\u276f ffprobe cat.ogv                                                                                  \nInput #0, ogg, from 'cat.ogv':\n  Duration: 00:00:05.73, start: 0.000000, bitrate: 216 kb/s\n  Stream #0:0: Video: theora, yuv444p, 256x256 [SAR 1:1 DAR 1:1], 30 tbr, 30 tbn\n      Metadata:\n        encoder         : Lavc60.31.102 libtheora\n```\n\nVideo on the right (which renders correctly in Godot):\n\n```\n\u276f ffprobe cat2.ogv\n[ogg @ 0x559083ead180] Broken file, keyframe not correctly marked.\nInput #0, ogg, from 'cat2.ogv':\n  Duration: 00:00:05.77, start: 0.000000, bitrate: 65 kb/s\n  Stream #0:0: Video: theora, yuv420p, 256x256, 30 tbr, 30 tbn\n```\n", "created_at": "2025-03-12 12:00:24", "merge_commit_sha": "cc77c02d4756e9cf52637450dec6173c25a391c2", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103999", "base_commit": "7893202fba0e8ec69375fd0c376203cb7544e8f7", "patch": "diff --git a/core/variant/array.cpp b/core/variant/array.cpp\nindex d91612b420ca..2357e3f907ab 100644\n--- a/core/variant/array.cpp\n+++ b/core/variant/array.cpp\n@@ -88,11 +88,11 @@ Array::Iterator Array::end() {\n }\n \n Array::ConstIterator Array::begin() const {\n-\treturn ConstIterator(_p->array.ptr(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr());\n }\n \n Array::ConstIterator Array::end() const {\n-\treturn ConstIterator(_p->array.ptr() + _p->array.size(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr() + _p->array.size());\n }\n \n Variant &Array::operator[](int p_idx) {\n@@ -104,10 +104,6 @@ Variant &Array::operator[](int p_idx) {\n }\n \n const Variant &Array::operator[](int p_idx) const {\n-\tif (unlikely(_p->read_only)) {\n-\t\t*_p->read_only = _p->array[p_idx];\n-\t\treturn *_p->read_only;\n-\t}\n \treturn _p->array[p_idx];\n }\n \ndiff --git a/core/variant/array.h b/core/variant/array.h\nindex 841b6ff8eaa4..a796a2581171 100644\n--- a/core/variant/array.h\n+++ b/core/variant/array.h\n@@ -56,21 +56,19 @@ class Array {\n \t\t_FORCE_INLINE_ bool operator==(const ConstIterator &p_other) const { return element_ptr == p_other.element_ptr; }\n \t\t_FORCE_INLINE_ bool operator!=(const ConstIterator &p_other) const { return element_ptr != p_other.element_ptr; }\n \n-\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr, Variant *p_read_only = nullptr) :\n-\t\t\t\telement_ptr(p_element_ptr), read_only(p_read_only) {}\n+\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr) :\n+\t\t\t\telement_ptr(p_element_ptr) {}\n \t\t_FORCE_INLINE_ ConstIterator() {}\n \t\t_FORCE_INLINE_ ConstIterator(const ConstIterator &p_other) :\n-\t\t\t\telement_ptr(p_other.element_ptr), read_only(p_other.read_only) {}\n+\t\t\t\telement_ptr(p_other.element_ptr) {}\n \n \t\t_FORCE_INLINE_ ConstIterator &operator=(const ConstIterator &p_other) {\n \t\t\telement_ptr = p_other.element_ptr;\n-\t\t\tread_only = p_other.read_only;\n \t\t\treturn *this;\n \t\t}\n \n \tprivate:\n \t\tconst Variant *element_ptr = nullptr;\n-\t\tVariant *read_only = nullptr;\n \t};\n \n \tstruct Iterator {\n@@ -96,7 +94,7 @@ class Array {\n \t\t}\n \n \t\toperator ConstIterator() const {\n-\t\t\treturn ConstIterator(element_ptr, read_only);\n+\t\t\treturn ConstIterator(element_ptr);\n \t\t}\n \n \tprivate:\ndiff --git a/core/variant/variant.h b/core/variant/variant.h\nindex e38f7c9b0bae..f0bd7ec6824e 100644\n--- a/core/variant/variant.h\n+++ b/core/variant/variant.h\n@@ -997,18 +997,10 @@ Array::Iterator &Array::Iterator::operator--() {\n }\n \n const Variant &Array::ConstIterator::operator*() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn *read_only;\n-\t}\n \treturn *element_ptr;\n }\n \n const Variant *Array::ConstIterator::operator->() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn read_only;\n-\t}\n \treturn element_ptr;\n }\n \n", "test_patch": "", "problem_statement": "Callable.callv() will make call with wrong arguments if a const Array is passed\n### Tested versions\r\n\r\n- Reproducible in 4.3.beta2.official [b75f0485b]\r\n\r\n### System information\r\n\r\nWindows 10 - Godot 4.3.beta2.official [b75f0485b]\r\n\r\n### Issue description\r\n\r\nUsing Callable().callv() will result in a call using the wrong arguments, if the Array being passed is a const.\r\nThe bug does not occur if the Array being passed is a var.\r\nThe bug does not occur if we use Callable().bindv().call() instead.\r\n\r\n### Steps to reproduce\r\n\r\nThe following code can demonstrate the bug. The debugger does not show any errors or warnings.\r\n```extends Node2D\r\n\r\nconst arr_const = ['one','two','three','four']\r\nvar arr_var = ['one','two','three','four']\r\n\r\nfunc _ready() -> void:\r\n\t# non-const works\r\n\tsomefunc.callv(arr_var)\r\n\t# const fails\r\n\tsomefunc.callv(arr_const)\r\n\t# temporary workaround\r\n\tsomefunc.bindv(arr_const).call()\r\n\t\r\nfunc somefunc(v1,v2,v3,v4):\r\n\tprint('%s,%s,%s,%s'% [v1,v2,v3,v4])\r\n```\r\nwill print:\r\n```\r\none,two,three,four\r\nfour,four,four,four\r\none,two,three,four\r\n```\r\nThe first and third calls work as expected, with the four arguments in the arrays.\r\nOnly the second call, which used a const Array and .callv(), made a call with all arguments replaced by the last argument.\r\n\r\nIn this example, I use a function directly, but this can be reproduced with any Callable().\r\n\r\nThis seems like a similar issue as #69237, with a similar workaround, but in this case the correct number of arguments was passed.\r\n\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[callablecheck.zip](https://github.com/user-attachments/files/15974691/callablecheck.zip)\r\n\n", "hints_text": "Can confirm that this is still happening in `v4.3.stable.mono.official [77dcf97d8]`.\n\nThank you for the tip about `bindv(const_arr).call()`, I was very confused for a hot second after I realized I could make my actions array const only to have movement stop working \ud83e\udd23", "created_at": "2025-03-11 23:28:28", "merge_commit_sha": "7f6a9380a08557a3e4d91f8767edd299bf696d76", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103943", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 4990a415d6db..d18cf896e629 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -1938,6 +1938,12 @@ void EditorInspectorSection::set_bg_color(const Color &p_bg_color) {\n \tqueue_redraw();\n }\n \n+void EditorInspectorSection::reset_timer() {\n+\tif (dropping_for_unfold && !dropping_unfold_timer->is_stopped()) {\n+\t\tdropping_unfold_timer->start();\n+\t}\n+}\n+\n bool EditorInspectorSection::has_revertable_properties() const {\n \treturn !revertable_properties.is_empty();\n }\n@@ -3478,6 +3484,7 @@ void EditorInspector::update_tree() {\n \t\t\tif (!vbox_per_path[root_vbox].has(acc_path)) {\n \t\t\t\t// If the section does not exists, create it.\n \t\t\t\tEditorInspectorSection *section = memnew(EditorInspectorSection);\n+\t\t\t\tget_root_inspector()->get_v_scroll_bar()->connect(SceneStringName(value_changed), callable_mp(section, &EditorInspectorSection::reset_timer).unbind(1));\n \t\t\t\tcurrent_vbox->add_child(section);\n \t\t\t\tsections.push_back(section);\n \n@@ -3878,6 +3885,7 @@ void EditorInspector::update_tree() {\n \t\t\t\t}\n \n \t\t\t\tEditorInspectorSection *section = memnew(EditorInspectorSection);\n+\t\t\t\tget_root_inspector()->get_v_scroll_bar()->connect(SceneStringName(value_changed), callable_mp(section, &EditorInspectorSection::reset_timer).unbind(1));\n \t\t\t\tfavorites_groups_vbox->add_child(section);\n \t\t\t\tparent_vbox = section->get_vbox();\n \t\t\t\tsection->setup(\"\", section_name, object, sscolor, false);\n@@ -3897,6 +3905,7 @@ void EditorInspector::update_tree() {\n \t\t\t\t\t}\n \n \t\t\t\t\tEditorInspectorSection *section = memnew(EditorInspectorSection);\n+\t\t\t\t\tget_root_inspector()->get_v_scroll_bar()->connect(SceneStringName(value_changed), callable_mp(section, &EditorInspectorSection::reset_timer).unbind(1));\n \t\t\t\t\tvbox->add_child(section);\n \t\t\t\t\tvbox = section->get_vbox();\n \t\t\t\t\tsection->setup(\"\", section_name, object, sscolor, false);\n@@ -5001,4 +5010,5 @@ EditorInspector::EditorInspector() {\n \tset_property_name_style(EditorPropertyNameProcessor::get_singleton()->get_settings_style());\n \n \tset_draw_focus_border(true);\n+\tset_scroll_on_drag_hover(true);\n }\ndiff --git a/editor/editor_inspector.h b/editor/editor_inspector.h\nindex ac7c3d03e76b..a3974c1132ad 100644\n--- a/editor/editor_inspector.h\n+++ b/editor/editor_inspector.h\n@@ -357,6 +357,7 @@ class EditorInspectorSection : public Container {\n \tvoid unfold();\n \tvoid fold();\n \tvoid set_bg_color(const Color &p_bg_color);\n+\tvoid reset_timer();\n \n \tbool has_revertable_properties() const;\n \tvoid property_can_revert_changed(const String &p_path, bool p_can_revert);\ndiff --git a/scene/gui/scroll_container.cpp b/scene/gui/scroll_container.cpp\nindex fdb134c5d0e4..ca7b730e1249 100644\n--- a/scene/gui/scroll_container.cpp\n+++ b/scene/gui/scroll_container.cpp\n@@ -361,6 +361,10 @@ void ScrollContainer::_notification(int p_what) {\n \t\tcase NOTIFICATION_TRANSLATION_CHANGED: {\n \t\t\t_updating_scrollbars = true;\n \t\t\tcallable_mp(this, is_ready() ? &ScrollContainer::_reposition_children : &ScrollContainer::_update_scrollbar_position).call_deferred();\n+\t\t\tif (p_what == NOTIFICATION_THEME_CHANGED) {\n+\t\t\t\tscroll_border = get_theme_constant(SNAME(\"scroll_border\"), SNAME(\"Tree\"));\n+\t\t\t\tscroll_speed = get_theme_constant(SNAME(\"scroll_speed\"), SNAME(\"Tree\"));\n+\t\t\t}\n \t\t} break;\n \n \t\tcase NOTIFICATION_READY: {\n@@ -387,6 +391,43 @@ void ScrollContainer::_notification(int p_what) {\n \t\t\t}\n \t\t} break;\n \n+\t\tcase NOTIFICATION_DRAG_BEGIN: {\n+\t\t\tif (scroll_on_drag_hover && is_visible_in_tree()) {\n+\t\t\t\tset_process_internal(true);\n+\t\t\t}\n+\t\t} break;\n+\n+\t\tcase NOTIFICATION_DRAG_END: {\n+\t\t\tset_process_internal(false);\n+\t\t} break;\n+\n+\t\tcase NOTIFICATION_INTERNAL_PROCESS: {\n+\t\t\tif (scroll_on_drag_hover && get_viewport()->gui_is_dragging()) {\n+\t\t\t\tPoint2 mouse_position = get_viewport()->get_mouse_position() - get_global_position();\n+\t\t\t\tTransform2D xform = get_transform();\n+\t\t\t\tif (Rect2(Point2(), xform.get_scale() * get_size()).grow(scroll_border).has_point(mouse_position)) {\n+\t\t\t\t\tPoint2 point;\n+\n+\t\t\t\t\tif ((Math::abs(mouse_position.x) < Math::abs(mouse_position.x - get_size().width)) && (Math::abs(mouse_position.x) < scroll_border)) {\n+\t\t\t\t\t\tpoint.x = mouse_position.x - scroll_border;\n+\t\t\t\t\t} else if (Math::abs(mouse_position.x - get_size().width) < scroll_border) {\n+\t\t\t\t\t\tpoint.x = mouse_position.x - (get_size().width - scroll_border);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tif ((Math::abs(mouse_position.y) < Math::abs(mouse_position.y - get_size().height)) && (Math::abs(mouse_position.y) < scroll_border)) {\n+\t\t\t\t\t\tpoint.y = mouse_position.y - scroll_border;\n+\t\t\t\t\t} else if (Math::abs(mouse_position.y - get_size().height) < scroll_border) {\n+\t\t\t\t\t\tpoint.y = mouse_position.y - (get_size().height - scroll_border);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tpoint *= scroll_speed * get_process_delta_time();\n+\t\t\t\t\tpoint += Point2(get_h_scroll(), get_v_scroll());\n+\t\t\t\t\th_scroll->set_value(point.x);\n+\t\t\t\t\tv_scroll->set_value(point.y);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} break;\n+\n \t\tcase NOTIFICATION_INTERNAL_PHYSICS_PROCESS: {\n \t\t\tif (drag_touching) {\n \t\t\t\tif (drag_touching_deaccel) {\n@@ -584,6 +625,10 @@ PackedStringArray ScrollContainer::get_configuration_warnings() const {\n \treturn warnings;\n }\n \n+void ScrollContainer::set_scroll_on_drag_hover(bool p_scroll) {\n+\tscroll_on_drag_hover = p_scroll;\n+}\n+\n HScrollBar *ScrollContainer::get_h_scroll_bar() {\n \treturn h_scroll;\n }\ndiff --git a/scene/gui/scroll_container.h b/scene/gui/scroll_container.h\nindex 887a8e3f1c35..7309c9ea6133 100644\n--- a/scene/gui/scroll_container.h\n+++ b/scene/gui/scroll_container.h\n@@ -62,12 +62,15 @@ class ScrollContainer : public Container {\n \tbool drag_touching = false;\n \tbool drag_touching_deaccel = false;\n \tbool beyond_deadzone = false;\n+\tbool scroll_on_drag_hover = false;\n \n \tScrollMode horizontal_scroll_mode = SCROLL_MODE_AUTO;\n \tScrollMode vertical_scroll_mode = SCROLL_MODE_AUTO;\n \n \tint deadzone = 0;\n \tbool follow_focus = false;\n+\tint scroll_border = 20;\n+\tint scroll_speed = 12;\n \n \tstruct ThemeCache {\n \t\tRef<StyleBox> panel_style;\n@@ -123,6 +126,8 @@ class ScrollContainer : public Container {\n \tbool is_following_focus() const;\n \tvoid set_follow_focus(bool p_follow);\n \n+\tvoid set_scroll_on_drag_hover(bool p_scroll);\n+\n \tHScrollBar *get_h_scroll_bar();\n \tVScrollBar *get_v_scroll_bar();\n \tvoid ensure_control_visible(Control *p_control);\n", "test_patch": "", "problem_statement": "ScrollContainer doesn't scroll during drag & drop like Tree does\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nWhile working on #103738, I noticed the SceneTree and FileSystem will scroll while drag & drop is held near the edge, but not the inspector, which is a ScrollContainer\n\n### Steps to reproduce\n\nInspect some node and expand sections until it is scrollable.\nTry dragging something like a file near the edges, it will not scroll.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-03-10 22:14:18", "merge_commit_sha": "1f127770fc7fb800f1244bbbc41f7dca5762556b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103805", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex e65f894c549f..5a3a651fcd9d 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -4662,6 +4662,12 @@ void Main::cleanup(bool p_force) {\n \tResourceSaver::remove_custom_savers();\n \tPropertyListHelper::clear_base_helpers();\n \n+\t// Remove the lock file if the engine exits successfully. Some automated processes such as\n+\t// --export/--import can bypass and/or finish faster than the existing check to remove the lock file.\n+\tif (OS::get_singleton()->get_exit_code() == EXIT_SUCCESS) {\n+\t\tOS::get_singleton()->remove_lock_file();\n+\t}\n+\n \t// Flush before uninitializing the scene, but delete the MessageQueue as late as possible.\n \tmessage_queue->flush();\n \n", "test_patch": "", "problem_statement": "Running with the `--headless` flag does not result in removing the project's recovery mode lock if present\n### Tested versions\n\n4.4.rc1\n\n### System information\n\nGodot v4.4.rc (d91f2cd77) - Windows 11 (build 22631) - Multi-window, 3 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 7900 XT (Advanced Micro Devices, Inc.; 32.0.11037.4004) - AMD Ryzen Threadripper 7970X 32-Cores (64 threads)\n\n### Issue description\n\nRunning with the `--headless flag` does not result in a call to `_remove_lock_file`\n\n### Steps to reproduce\n\nrun any command on a project with the `--headless` flag.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Could you explain what the actual problem is? I assume there's a fault in the code but you don't link to the code you're referring to, and as an issue triager I'm not immediately intimate with what `_remove_lock_file` is, what it's supposed to do and why the absence of calling it would be a problem.\n\nSure, I could spend some time researching it but this is the information a bug report should convey so that contributors can understand a problem (what was expected, what was found, what is the consequence of it) and fix it.\nThe problem is that the lock file is left in place, which leads to a prompt the next time you open the editor. This shouldn't happen.\n[This](https://github.com/godotengine/godot/blame/9f68a816599412c56a4626dd6c47244ebc65ed1f/editor/editor_node.cpp#L1219) is the code I'm referring to.\n`_remove_lock_file` removes the lock file at (on windows) `%appdata%\\Godot\\app_userdata\\PROJECT_NAME\\.recovery_mode_lock`\nIt is used to determine if you should launch in recovery mode.\nThe absence of calling is a problem, because it's indicative of needing to launch in recovery mode.\n\nWhat was expected:\n`_remove_lock_file` is called\nWhat was found:\n`_remove_lock_file` was not called\nConsequence\nThe lock file is not removed, causing an erroneous popup on the next run.\nCC @rsubtil \nAfter staring at this long enough, I wonder if the other timers in this file are even successful. They aren't causing any issues for me presently, but perhaps this is indicative of a bigger issue? In general I wish these timers had more context as to why they're needed and why they have the values they have.\nNote that removing the lock file should only be done when running the editor, not when running the project directly from the command line or project manager.\n\nThis means `--headless` alone should not remove the lock file, but `--headless --editor`, `--headless --import` or `--headless --export` should (`--import` and `--export` both imply `--editor`).\nI've just retested it, and the behavior looks \"mostly\" correct to me on `--headless` mode.\n\nWhen running simply with `--headless` mode, no lock file is created nor removed. This is intended, because this behavior can only occur on editor mode, as @Calinou said. And whenever I do so (`--editor/--import/--export`), the lock file is created, and then eventually deleted. I can't replicate your situation where the timer apparently fails to trigger. I tested this on Linux, so could this be a OS specific bug? Can you provide exact commands of how you're finding this issue?\n\nHowever, when using `--import/--export`, it can happen that each process is finished before the timer is triggered, and the lock file persists after the engine finishes. I can replicate this quite easily on an empty project (since it doesn't have much content to import), so I'll have to account for this scenario too then \ud83d\udc4d.\n\nLastly, to answer your question as to why a timer was used an not a `call_deferred`, it has to do with the order some of these components run. `@tool` scripts run on the next frame, so the first solution used a `call_deferred`. But this fails to catch some scenarios such as `queue_free`ing a editor node, which is delayed another frame. I then added a 2 frame delay, but the issue with this is that the problem just keeps going. Scripts can always be crafted in a way to cause reliable crashes that recovery mode cannot detect, so in the end I chose to instead use a time frame of 1 second instead of engine frames, which starts after the initial import process. It's not a perfect solution, and is essentially a compromise I reached.\nIt seems https://github.com/godotengine/godot/issues/103564 is also related to this, and also happening on Windows, so I'll need to investigate it in there. I can only get a Windows machine on a couple of days though, but once I can test it I'll share my findings.\nThat other issue sounds exactly like my story. I put debug prints in the engine and every time the timer is created, but the method it's supposed to call is not. I run with both `--import` and `--export` and see the same result in both cases. The lock file is created each run, but not removed. When importing I have `godot --import --headless --verbose --quit` I can try running `--import` when I get back to work without `--quit` to see if that makes a difference.\n`--quit` quits after the first process iteration, so that might be why. Try using a larger number of iterations to wait before quitting with `--quit-after N` where N is the number of iterations to wait (start with `2`). Eventually, you should find a large enough value that allows the lock file to be removed.", "created_at": "2025-03-08 11:02:03", "merge_commit_sha": "807ce83f00c14e59dd83d865edf721d90ac9faed", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103792", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/servers/rendering/renderer_viewport.cpp b/servers/rendering/renderer_viewport.cpp\nindex 3a8f445c4be1..45a4ebe1b8a8 100644\n--- a/servers/rendering/renderer_viewport.cpp\n+++ b/servers/rendering/renderer_viewport.cpp\n@@ -145,12 +145,22 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_OFF;\n \t\t\t}\n \n-\t\t\t// Verify MetalFX upscaling support.\n-\t\t\tif (\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) ||\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL))) {\n-\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported in the current renderer. Falling back to bilinear 3D resolution scaling.\");\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) {\n+\t\t\t\tif (RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\t\t// Prefer MetalFX spatial if it is supported, which will be much more efficient than FSR2,\n+\t\t\t\t\t// as the hardware already will struggle with FSR2.\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling is not supported by the current renderer or hardware. Falling back to MetalFX Spatial scaling.\");\n+\t\t\t\t} else {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported by the current renderer or hardware. Falling back to FSR 2 scaling.\");\n+\t\t\t\t}\n+\t\t\t\tscaling_type = RS::scaling_3d_mode_type(scaling_3d_mode);\n+\t\t\t}\n+\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR;\n+\t\t\t\tWARN_PRINT_ONCE(\"MetalFX spatial upscaling is not supported by the current renderer or hardware. Falling back to FSR scaling.\");\n \t\t\t}\n \n \t\t\tRS::ViewportMSAA msaa_3d = p_viewport->msaa_3d;\n@@ -160,11 +170,9 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tdouble min_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MIN_SCALE) / 1000'000.0;\n \t\t\t\tdouble max_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MAX_SCALE) / 1000'000.0;\n \t\t\t\tif ((double)scaling_3d_scale < min_scale || (double)scaling_3d_scale > max_scale) {\n-\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to bilinear 3D resolution scaling.\", min_scale, max_scale));\n-\t\t\t\t}\n-\n-\t\t\t\tif (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to FSR 2 3D resolution scaling.\", min_scale, max_scale));\n+\t\t\t\t} else if (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n \t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling does not support 3D MSAA. Disabling 3D MSAA internally.\");\n \t\t\t\t\tmsaa_3d = RS::VIEWPORT_MSAA_DISABLED;\n \t\t\t\t}\n@@ -174,7 +182,7 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\tbool use_taa = p_viewport->use_taa;\n \n \t\t\tif (scaling_3d_is_not_bilinear && (scaling_3d_scale >= (1.0 + EPSILON))) {\n-\t\t\t\t// FSR is not designed for downsampling.\n+\t\t\t\t// FSR and MetalFX is not designed for downsampling.\n \t\t\t\t// Fall back to bilinear scaling.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 3D resolution scaling is not designed for downsampling. Falling back to bilinear 3D resolution scaling.\");\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n@@ -188,8 +196,8 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t}\n \n \t\t\tif (use_taa && (scaling_type == RS::VIEWPORT_SCALING_3D_TYPE_TEMPORAL)) {\n-\t\t\t\t// FSR2 can't be used with TAA.\n-\t\t\t\t// Turn it off and prefer using FSR2.\n+\t\t\t\t// Temporal upscalers can't be used with TAA.\n+\t\t\t\t// Turn it off and prefer using the temporal upscaler.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 2 or MetalFX Temporal is not compatible with TAA. Disabling TAA internally.\");\n \t\t\t\tuse_taa = false;\n \t\t\t}\n", "test_patch": "", "problem_statement": "MetalFX Temporal upscaling fallback on non-supported rendering drivers does not disable TAA jitter (or fallback to FSR2)\n### Tested versions\n\n- Reproducible in: 4.4.stable\n- MetalFX is not available before 4.4.\n\n### System information\n\nGodot v4.4.stable (4c311cbee) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4090 (nvidia; 570.86.16) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nWhen attempting to use MetalFX Temporal upscaling on an unsupported rendering driver, the TAA jitter is still active despite not being needed with bilinear scaling. MetalFX Spatial upscaling doesn't have this issue, as it doesn't engage TAA jitter in the first place due to its purely spatial nature.\n\nAlternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\ncc @stuartcarnie \n\nhttps://github.com/user-attachments/assets/bde8cd82-63ba-4f82-ba59-0be8e46ea63c\n\n### Steps to reproduce\n\n- Create a project using the Forward+ rendering method.\n- Set the root viewport's 3D scaling mode to MetalFX Temporal using a script on a platform/renderer that doesn't support MetalFX upscaling (Windows, Linux, or macOS when using MoltenVK):\n```gdscript\nfunc _ready() -> void:\n    get_window().scaling_3d_mode = Viewport.SCALING_3D_MODE_METALFX_TEMPORAL\n```\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/godotengine/tps-demo/pull/196\n*Change the check in the demo's code from `== \"metal\"` to `!= \"metal` to test this on unsupported drivers. I suggest using the Ultra Performance scaling mode so the issue is more noticeable.*\n", "hints_text": "> Alternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\nI like this too \u2013 I'll implement that solution.", "created_at": "2025-03-08 04:39:12", "merge_commit_sha": "3b66cb5f8dee1ff3af432388671629a13a481309", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103788", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/platform/macos/godot_content_view.mm b/platform/macos/godot_content_view.mm\nindex eff33208db4b..4e7fc2180cb9 100644\n--- a/platform/macos/godot_content_view.mm\n+++ b/platform/macos/godot_content_view.mm\n@@ -622,7 +622,7 @@ - (void)updateTrackingAreas {\n \t\t[self removeTrackingArea:tracking_area];\n \t}\n \n-\tNSTrackingAreaOptions options = NSTrackingMouseEnteredAndExited | NSTrackingActiveInKeyWindow | NSTrackingCursorUpdate | NSTrackingInVisibleRect;\n+\tNSTrackingAreaOptions options = NSTrackingMouseEnteredAndExited | NSTrackingActiveWhenFirstResponder | NSTrackingCursorUpdate | NSTrackingInVisibleRect;\n \ttracking_area = [[NSTrackingArea alloc] initWithRect:[self bounds] options:options owner:self userInfo:nil];\n \n \t[self addTrackingArea:tracking_area];\n", "test_patch": "", "problem_statement": "Documentation tooltip disappears when you move the mouse - 4.4 dev7\n### Tested versions\n\nGodot 4.4 Dev 7 (MACOS mono build)\n\n### System information\n\nMacOS Sequoia 15.2 running on an M1 Pro\n\n### Issue description\n\nSeveral issues:\n\n1) Tooltip disappears when you move your mouse over it. It should persist instead, and only fade out after like 0.5ms or a second when the mouse is no longer over the tooltip.\n2) Cannot click on any hyperlinks within the tooltip, for example in the video I cannot click on the Color Cheatsheet web link on the bottom\n3) Cannot scroll down\n4) It would be nice to be able to click on documentation links within the tooltip, for example hovering over @export_range, we should be able to also click on the PROPERTY_HINT_RANGE link that comes under \"See also\" in the documentation.\n\nI'm running on an M1 Pro with macOS Sequoia 15.2. Single window mode was off when the issues occurred. With this mode on I still have the same issues.\n\n### Steps to reproduce\n\nJust hover over a keyword and you will notice all the mentioned issues.\n\nhttps://github.com/user-attachments/assets/689e6cf7-392e-4dae-a2e0-9f9a811bbc90\n\n\n### Minimal reproduction project (MRP)\n\nNA\n", "hints_text": "I would like to add to it and say that the Vertical scroll bar Documentation Tooltip doesn't seem to work.\nPlease write what operating system and display manager (X11 and Wayland for Linux) you are using, this may be a platform-specific bug. And whether you are using single window mode (editor setting `interface/editor/single_window_mode`).\n> Please write what operating system and display manager (X11 and Wayland for Linux) you are using, this may be a platform-specific bug. And whether you are using single window mode (editor setting `interface/editor/single_window_mode`).\n\nI'm running on an M1 Pro with macOS Sequoia 15.2. Single window mode was off when the issues occurred. With this mode on I still have the same issues.\n\nOh yeah, what's the difference between the two modes anyway?\nI don't have this bugs on windows 10, maybe OS related.\n\nhttps://github.com/user-attachments/assets/93a1ce4e-d252-4616-ae04-d37b2a3e5a2d\n\nGodot v4.4.dev7 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated AMD Radeon RX 580 2048SP (Advanced Micro Devices, Inc.; 31.0.21921.1000) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n> Please write what operating system and display manager (X11 and Wayland for Linux) you are using, this may be a platform-specific bug. And whether you are using single window mode (editor setting `interface/editor/single_window_mode`).\n\nHere you go, my system info. And yes, since I'm on a laptop, `Single Window Mode` is what I have always enabled.\n\n```\nSystem:\n  Kernel: 6.8.0-51-generic arch: x86_64 bits: 64 compiler: gcc v: 13.3.0 clocksource: tsc\n  Desktop: Cinnamon v: 6.2.9 tk: GTK v: 3.24.41 wm: Muffin v: 6.2.0 vt: 7 dm: LightDM v: 1.30.0\n    Distro: Linux Mint 22 Wilma base: Ubuntu 24.04 noble\nMachine:\n  Type: Laptop System: LENOVO product: 80SL v: Lenovo ideapad 310-14ISK\n    serial: <superuser required> Chassis: type: 10 v: Lenovo ideapad 310-14ISK\n    serial: <superuser required>\n  Mobo: LENOVO model: Toronto 4A2 v: SDK0J40688 WIN serial: <superuser required>\n    part-nu: LENOVO_MT_80SL_BU_idea_FM_Lenovo ideapad 310-14ISK uuid: <superuser required>\n    UEFI: LENOVO v: 0XCN20WW date: 02/19/2016\nBattery:\n  ID-1: BAT0 charge: 24.1 Wh (94.5%) condition: 25.5/30.0 Wh (84.9%) power: 4.1 W volts: 8.3\n    min: 7.4 model: SMP L15M2PB2 type: Li-poly serial: <filter> status: charging\nCPU:\n  Info: dual core model: Intel Core i7-6500U bits: 64 type: MT MCP smt: enabled arch: Skylake\n    rev: 3 cache: L1: 128 KiB L2: 512 KiB L3: 4 MiB\n  Speed (MHz): avg: 2787 min/max: 400/3100 cores: 1: 2787 2: 2787 3: 2787 4: 2787 bogomips: 20799\n  Flags: avx avx2 ht lm nx pae sse sse2 sse3 sse4_1 sse4_2 ssse3 vmx\nGraphics:\n  Device-1: Intel Skylake GT2 [HD Graphics 520] vendor: Lenovo driver: i915 v: kernel arch: Gen-9\n    ports: active: eDP-1 empty: DP-1,HDMI-A-1,HDMI-A-2 bus-ID: 00:02.0 chip-ID: 8086:1916\n    class-ID: 0300\n  Device-2: NVIDIA GM108M [GeForce 920MX] vendor: Lenovo driver: nvidia v: 550.120 arch: Maxwell\n    pcie: speed: 2.5 GT/s lanes: 4 bus-ID: 03:00.0 chip-ID: 10de:134f class-ID: 0302\n  Device-3: Chicony EasyCamera driver: uvcvideo type: USB rev: 2.0 speed: 480 Mb/s lanes: 1\n    bus-ID: 1-4:2 chip-ID: 04f2:b57d class-ID: 0e02 serial: <filter>\n  Display: x11 server: X.Org v: 21.1.11 with: Xwayland v: 23.2.6 driver: X:\n    loaded: modesetting,nvidia unloaded: fbdev,nouveau,vesa dri: iris gpu: i915 display-ID: :0\n    screens: 1\n  Screen-1: 0 s-res: 1366x768 s-dpi: 98 s-size: 355x199mm (13.98x7.83\") s-diag: 407mm (16.02\")\n  Monitor-1: eDP-1 model: BOE Display 0x0698 res: 1366x768 hz: 60 dpi: 112\n    size: 309x173mm (12.17x6.81\") diag: 354mm (13.9\") modes: 1366x768\n  API: EGL v: 1.5 hw: drv: intel iris drv: nvidia platforms: device: 0 drv: nvidia device: 1\n    drv: iris device: 3 drv: swrast surfaceless: drv: nvidia x11: drv: iris\n    inactive: gbm,wayland,device-2\n  API: OpenGL v: 4.6.0 compat-v: 4.5 vendor: intel mesa v: 24.0.9-0ubuntu0.3 glx-v: 1.4\n    direct-render: yes renderer: Mesa Intel HD Graphics 520 (SKL GT2) device-ID: 8086:1916\nAudio:\n  Device-1: Intel Sunrise Point-LP HD Audio vendor: Lenovo driver: snd_hda_intel v: kernel\n    bus-ID: 00:1f.3 chip-ID: 8086:9d70 class-ID: 0403\n  API: ALSA v: k6.8.0-51-generic status: kernel-api\n  Server-1: PipeWire v: 1.0.5 status: active with: 1: pipewire-pulse status: active\n    2: wireplumber status: active 3: pipewire-alsa type: plugin\nNetwork:\n  Device-1: Realtek RTL8111/8168/8211/8411 PCI Express Gigabit Ethernet\n    vendor: Lenovo RTL8111/8168/8411 driver: r8169 v: kernel pcie: speed: 2.5 GT/s lanes: 1\n    port: 4000 bus-ID: 01:00.0 chip-ID: 10ec:8168 class-ID: 0200\n  IF: enp1s0 state: down mac: <filter>\n  Device-2: Intel Dual Band Wireless-AC 3165 Plus Bluetooth driver: iwlwifi v: kernel pcie:\n    speed: 2.5 GT/s lanes: 1 bus-ID: 02:00.0 chip-ID: 8086:3166 class-ID: 0280\n  IF: wlp2s0 state: up mac: <filter>\nBluetooth:\n  Device-1: Intel Bluetooth wireless interface driver: btusb v: 0.8 type: USB rev: 2.0\n    speed: 12 Mb/s lanes: 1 bus-ID: 1-7:4 chip-ID: 8087:0a2a class-ID: e001\n  Report: hciconfig ID: hci0 rfk-id: 2 state: down bt-service: enabled,running rfk-block:\n    hardware: no software: yes address: <filter>\nDrives:\n  Local Storage: total: 931.51 GiB used: 25.72 GiB (2.8%)\n  ID-1: /dev/sda vendor: Western Digital model: WD10JPCX-24UE4T0 size: 931.51 GiB speed: 6.0 Gb/s\n    tech: HDD rpm: 5400 serial: <filter> fw-rev: 1A01 scheme: GPT\nPartition:\n  ID-1: / size: 460.31 GiB used: 25.67 GiB (5.6%) fs: ext4 dev: /dev/sda8\n  ID-2: /boot/efi size: 256 MiB used: 58.5 MiB (22.9%) fs: vfat dev: /dev/sda1\nSwap:\n  ID-1: swap-1 type: partition size: 977 MiB used: 0 KiB (0.0%) priority: -2 dev: /dev/sda4\nUSB:\n  Hub-1: 1-0:1 info: hi-speed hub with single TT ports: 12 rev: 2.0 speed: 480 Mb/s lanes: 1\n    chip-ID: 1d6b:0002 class-ID: 0900\n  Device-1: 1-3:5 info: USB OPTICAL MOUSE type: mouse driver: hid-generic,usbhid interfaces: 1\n    rev: 1.1 speed: 1.5 Mb/s lanes: 1 power: 100mA chip-ID: 0000:3825 class-ID: 0301\n  Device-2: 1-4:2 info: Chicony EasyCamera type: video driver: uvcvideo interfaces: 2 rev: 2.0\n    speed: 480 Mb/s lanes: 1 power: 500mA chip-ID: 04f2:b57d class-ID: 0e02 serial: <filter>\n  Device-3: 1-5:3 info: Realtek RTS5129 Card Reader Controller type: <vendor specific>\n    driver: rtsx_usb,rtsx_usb_ms,rtsx_usb_sdmmc interfaces: 1 rev: 2.0 speed: 480 Mb/s lanes: 1\n    power: 500mA chip-ID: 0bda:0129 class-ID: ff00 serial: <filter>\n  Device-4: 1-7:4 info: Intel Bluetooth wireless interface type: bluetooth driver: btusb\n    interfaces: 2 rev: 2.0 speed: 12 Mb/s lanes: 1 power: 100mA chip-ID: 8087:0a2a class-ID: e001\n  Hub-2: 2-0:1 info: super-speed hub ports: 6 rev: 3.0 speed: 5 Gb/s lanes: 1 chip-ID: 1d6b:0003\n    class-ID: 0900\nSensors:\n  System Temperatures: cpu: 46.0 C pch: 40.5 C mobo: N/A\n  Fan Speeds (rpm): N/A\nRepos:\n  Packages: pm: dpkg pkgs: 2087\n  No active apt repos in: /etc/apt/sources.list\n  Active apt repos in: /etc/apt/sources.list.d/official-package-repositories.list\n    1: deb http: //packages.linuxmint.com wilma main upstream import backport\n    2: deb http: //archive.ubuntu.com/ubuntu noble main restricted universe multiverse\n    3: deb http: //archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse\n    4: deb http: //archive.ubuntu.com/ubuntu noble-backports main restricted universe multiverse\n    5: deb http: //security.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse\n  Active apt repos in: /etc/apt/sources.list.d/vscode.list\n    1: deb [arch=amd64,arm64,armhf] https: //packages.microsoft.com/repos/code stable main\nInfo:\n  Memory: total: 8 GiB available: 7.66 GiB used: 2.52 GiB (32.9%)\n  Processes: 242 Power: uptime: 33m states: freeze,mem,disk suspend: deep wakeups: 0\n    hibernate: platform Init: systemd v: 255 target: graphical (5) default: graphical\n  Compilers: gcc: 13.3.0 Client: Cinnamon v: 6.2.9 inxi: 3.3\n```\n> I would like to add to it and say that the Vertical scroll bar Documentation Tooltip doesn't seem to work.\n\nThis doesn't work for the macOS version as well, tried both mono and standard builds.\nAnd yes I think this is OS related as my Windows 11 setup running in a VM doesn't have any issues, just the mac build.", "created_at": "2025-03-08 03:14:42", "merge_commit_sha": "6e5ec1920ae1a48dad3a6172f35900af1ae57339", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103784", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/scene/2d/navigation_region_2d.cpp b/scene/2d/navigation_region_2d.cpp\nindex 365d5ba4f68e..ef83027fa0c4 100644\n--- a/scene/2d/navigation_region_2d.cpp\n+++ b/scene/2d/navigation_region_2d.cpp\n@@ -181,7 +181,7 @@ void NavigationRegion2D::_notification(int p_what) {\n \n \t\tcase NOTIFICATION_DRAW: {\n #ifdef DEBUG_ENABLED\n-\t\t\tif (is_inside_tree() && (Engine::get_singleton()->is_editor_hint() || NavigationServer2D::get_singleton()->get_debug_enabled()) && navigation_polygon.is_valid()) {\n+\t\t\tif (is_inside_tree() && (Engine::get_singleton()->is_editor_hint() || (NavigationServer2D::get_singleton()->get_debug_enabled() && NavigationServer2D::get_singleton()->get_debug_navigation_enabled())) && navigation_polygon.is_valid()) {\n \t\t\t\t_update_debug_mesh();\n \t\t\t\t_update_debug_edge_connections_mesh();\n \t\t\t\t_update_debug_baking_rect();\n", "test_patch": "", "problem_statement": "NavigationRegion2D visible even though not enabled in Debug\n### Tested versions\n\nv4.4.stable.steam.4c311cbee\n\n### System information\n\nWindows 11 - Godot Engine v4.4.stable.steam.4c311cbee\n\n### Issue description\n\nIf you enable the option Debug > Visible Avoidance, the navigation mesh will also become visible (regardless of whether Visible Navigation is enabled). This was not the case in previous versions.\n\n### Steps to reproduce\n\nCheck Debug > Visible Avoidance\n\n### Minimal reproduction project (MRP)\n\n[new-game.zip](https://github.com/user-attachments/files/19086046/new-game.zip)\n", "hints_text": "This is likely because the \"Visible Avoidance\" option enables the general debug on the NavigationServer in addition to just the visible avoidance debug (which it needs to do to have any debug render).\n\nThe avoidance debug was added far later so most older navigation related Node types likely still have debug code that just looks at the general debug enabled and needs to be updated to also check for the more specific debug enabled.\n\nThere are 3 debug related functions on the NavigationServer.\n`get_debug_enabled()` for the general debug for both navmesh and avoidance.\n`get_debug_navigation_enabled()` which is just the debug for anything navmesh or path related.\n`get_debug_avoidance_enabled()` which is the debug for anything avoidance related.\n\nFor this issue it is likely enough to just add an additional check for the get_debug_navigation_enabled() in the draw function for the NavigationRegion2D but I expect other node types might also need an update.\n\nEDIT:\nNot a regression, the code on the NavigationRegion2D or debug for this is all older. It is more likely that the fixes to visibility now just show the bug more clearly, or user is on an older version without the debug enabled patch that was rolled out for 4.3 as well.", "created_at": "2025-03-08 01:32:28", "merge_commit_sha": "ba5edb2a77dba794a1adb314a4d4df5a7d392ee8", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103758", "base_commit": "f2cc3f12750adae431384d7bac2f75d1c7e506be", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex bc3b4ceeb2b7..fa9dd87bc491 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -65,7 +65,18 @@ void GameViewDebugger::_session_started(Ref<EditorDebuggerSession> p_session) {\n \tsettings[\"editors/panning/warped_mouse_panning\"] = EDITOR_GET(\"editors/panning/warped_mouse_panning\");\n \tsettings[\"editors/panning/2d_editor_pan_speed\"] = EDITOR_GET(\"editors/panning/2d_editor_pan_speed\");\n \tsettings[\"canvas_item_editor/pan_view\"] = DebuggerMarshalls::serialize_key_shortcut(ED_GET_SHORTCUT(\"canvas_item_editor/pan_view\"));\n+#ifndef _3D_DISABLED\n+\tsettings[\"editors/3d/default_fov\"] = EDITOR_GET(\"editors/3d/default_fov\");\n+\tsettings[\"editors/3d/default_z_near\"] = EDITOR_GET(\"editors/3d/default_z_near\");\n+\tsettings[\"editors/3d/default_z_far\"] = EDITOR_GET(\"editors/3d/default_z_far\");\n+\tsettings[\"editors/3d/navigation/invert_x_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_x_axis\");\n+\tsettings[\"editors/3d/navigation/invert_y_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_y_axis\");\n+\tsettings[\"editors/3d/navigation/warped_mouse_panning\"] = EDITOR_GET(\"editors/3d/navigation/warped_mouse_panning\");\n \tsettings[\"editors/3d/freelook/freelook_base_speed\"] = EDITOR_GET(\"editors/3d/freelook/freelook_base_speed\");\n+\tsettings[\"editors/3d/freelook/freelook_sensitivity\"] = EDITOR_GET(\"editors/3d/freelook/freelook_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/orbit_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/orbit_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/translation_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/translation_sensitivity\");\n+#endif // _3D_DISABLED\n \tsetup_data.append(settings);\n \tp_session->send_message(\"scene:runtime_node_select_setup\", setup_data);\n \ndiff --git a/scene/debugger/scene_debugger.cpp b/scene/debugger/scene_debugger.cpp\nindex c620c5fd5c80..5661268f04c3 100644\n--- a/scene/debugger/scene_debugger.cpp\n+++ b/scene/debugger/scene_debugger.cpp\n@@ -1261,7 +1261,18 @@ void RuntimeNodeSelect::_setup(const Dictionary &p_settings) {\n #ifndef _3D_DISABLED\n \tcursor = Cursor();\n \n-\tfreelook_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", FREELOOK_BASE_SPEED);\n+\tcamera_fov = p_settings.get(\"editors/3d/default_fov\", 70);\n+\tcamera_znear = p_settings.get(\"editors/3d/default_z_near\", 0.05);\n+\tcamera_zfar = p_settings.get(\"editors/3d/default_z_far\", 4'000);\n+\n+\tinvert_x_axis = p_settings.get(\"editors/3d/navigation/invert_x_axis\", false);\n+\tinvert_y_axis = p_settings.get(\"editors/3d/navigation/invert_y_axis\", false);\n+\twarped_mouse_panning_3d = p_settings.get(\"editors/3d/navigation/warped_mouse_panning\", true);\n+\n+\tfreelook_base_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", 5);\n+\tfreelook_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/freelook/freelook_sensitivity\", 0.25));\n+\torbit_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/navigation_feel/orbit_sensitivity\", 0.004));\n+\ttranslation_sensitivity = p_settings.get(\"editors/3d/navigation_feel/translation_sensitivity\", 1);\n \n \t/// 3D Selection Box Generation\n \t// Copied from the Node3DEditor implementation.\n@@ -1342,7 +1353,7 @@ void RuntimeNodeSelect::_set_camera_override_enabled(bool p_enabled) {\n \t\t_update_view_2d();\n \n \t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \t}\n #endif // _3D_DISABLED\n }\n@@ -1445,7 +1456,7 @@ void RuntimeNodeSelect::_process_frame() {\n \t\t\tdirection -= up;\n \t\t}\n \n-\t\treal_t speed = freelook_speed;\n+\t\treal_t speed = freelook_base_speed;\n \t\tif (input->is_physical_key_pressed(Key::SHIFT)) {\n \t\t\tspeed *= 3.0;\n \t\t}\n@@ -2011,19 +2022,19 @@ bool RuntimeNodeSelect::_handle_3d_input(const Ref<InputEvent> &p_event) {\n \t\t\tswitch (k->get_physical_keycode()) {\n \t\t\t\tcase Key::EQUAL: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale - 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::MINUS: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale + 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::KEY_0: {\n \t\t\t\t\tcursor.fov_scale = 1;\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n@@ -2063,33 +2074,37 @@ void RuntimeNodeSelect::_set_camera_freelook_enabled(bool p_enabled) {\n }\n \n void RuntimeNodeSelect::_cursor_scale_distance(real_t p_scale) {\n-\treal_t min_distance = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_distance = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_distance = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_distance = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tcursor.distance = CLAMP(cursor.distance * p_scale, min_distance, max_distance);\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n void RuntimeNodeSelect::_scale_freelook_speed(real_t p_scale) {\n-\treal_t min_speed = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_speed = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_speed = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_speed = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tif (unlikely(min_speed > max_speed)) {\n-\t\tfreelook_speed = (min_speed + max_speed) / 2;\n+\t\tfreelook_base_speed = (min_speed + max_speed) / 2;\n \t} else {\n-\t\tfreelook_speed = CLAMP(freelook_speed * p_scale, min_speed, max_speed);\n+\t\tfreelook_base_speed = CLAMP(freelook_base_speed * p_scale, min_speed, max_speed);\n \t}\n }\n \n void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n \tconst Transform3D prev_camera_transform = _get_cursor_transform();\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * freelook_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * freelook_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tcursor.y_rot += relative.x * freelook_sensitivity;\n \n \t// Look is like the opposite of Orbit: the focus point rotates around the camera.\n \tTransform3D camera_transform = _get_cursor_transform();\n@@ -2104,8 +2119,8 @@ void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n-\tconst real_t pan_speed = 1 / 150.0;\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst real_t pan_speed = translation_sensitivity / 150.0;\n \n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2123,17 +2138,35 @@ void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_orbit(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * orbit_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tif (invert_x_axis) {\n+\t\tcursor.y_rot -= relative.x * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.y_rot += relative.x * orbit_sensitivity;\n+\t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n+Point2 RuntimeNodeSelect::_get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_area) const {\n+\tERR_FAIL_COND_V(p_event.is_null(), Point2());\n+\n+\tif (warped_mouse_panning_3d) {\n+\t\treturn Input::get_singleton()->warp_mouse_motion(p_event, p_area);\n+\t}\n+\n+\treturn p_event->get_relative();\n+}\n+\n Transform3D RuntimeNodeSelect::_get_cursor_transform() {\n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2158,13 +2191,13 @@ void RuntimeNodeSelect::_reset_camera_3d() {\n \t\tcursor.x_rot = -camera->get_global_rotation().x;\n \t\tcursor.y_rot = -camera->get_global_rotation().y;\n \n-\t\tcursor.fov_scale = CLAMP(camera->get_fov() / CAMERA_BASE_FOV, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n+\t\tcursor.fov_scale = CLAMP(camera->get_fov() / camera_fov, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n \t} else {\n \t\tcursor.fov_scale = 1.0;\n \t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n }\n #endif // _3D_DISABLED\n #endif\ndiff --git a/scene/debugger/scene_debugger.h b/scene/debugger/scene_debugger.h\nindex 5a56ea9d99b7..b0a365fddfcb 100644\n--- a/scene/debugger/scene_debugger.h\n+++ b/scene/debugger/scene_debugger.h\n@@ -242,20 +242,26 @@ class RuntimeNodeSelect : public Object {\n \tconst double VIEW_3D_MAX_ZOOM = 1'000'000'000'000;\n #else\n \tconst float VIEW_3D_MAX_ZOOM = 10'000;\n-#endif\n-\tconst float CAMERA_ZNEAR = 0.05;\n-\tconst float CAMERA_ZFAR = 4'000;\n+#endif // REAL_T_IS_DOUBLE\n \n-\tconst float CAMERA_BASE_FOV = 75;\n \tconst float CAMERA_MIN_FOV_SCALE = 0.1;\n \tconst float CAMERA_MAX_FOV_SCALE = 2.5;\n \n-\tconst float FREELOOK_BASE_SPEED = 4;\n-\tconst float RADS_PER_PIXEL = 0.004;\n-\n \tbool camera_first_override = true;\n \tbool camera_freelook = false;\n-\treal_t freelook_speed = FREELOOK_BASE_SPEED;\n+\n+\treal_t camera_fov = 0;\n+\treal_t camera_znear = 0;\n+\treal_t camera_zfar = 0;\n+\n+\tbool invert_x_axis = false;\n+\tbool invert_y_axis = false;\n+\tbool warped_mouse_panning_3d = false;\n+\n+\treal_t freelook_base_speed = 0;\n+\treal_t freelook_sensitivity = 0;\n+\treal_t orbit_sensitivity = 0;\n+\treal_t translation_sensitivity = 0;\n \n \tVector2 previous_mouse_position;\n \n@@ -267,7 +273,7 @@ class RuntimeNodeSelect : public Object {\n \tRID sbox_3d_instance_xray_ofs;\n \tTransform3D sbox_3d_xform;\n \tAABB sbox_3d_bounds;\n-#endif\n+#endif // _3D_DISABLED\n \n \tPoint2 selection_position = Point2(INFINITY, INFINITY);\n \tbool list_shortcut_pressed = false;\n@@ -314,6 +320,7 @@ class RuntimeNodeSelect : public Object {\n \tvoid _cursor_look(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_pan(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_orbit(Ref<InputEventWithModifiers> p_event);\n+\tPoint2 _get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_border) const;\n \tTransform3D _get_cursor_transform();\n \tvoid _reset_camera_3d();\n #endif\n", "test_patch": "", "problem_statement": "Sensitivity settings don't work in embedded game window\n### Tested versions\n\nv4.4.stable.official [4c311cbee]\n\n### System information\n\nGodot v4.4.stable - Linux Mint 22.1 (Xia) on X11 - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 960 (nvidia; 550.120) - AMD FX(tm)-6300 Six-Core Processor (6 threads)\n\n### Issue description\n\nThe embedded game window doesn't listen to the sensitivity settings in Editor Settings > Editors > 3D. I think it just uses the default value for every option.\n\nhttps://github.com/user-attachments/assets/b76f5570-d0c7-45b1-8d50-14649f853cf1\n\n### Steps to reproduce\n\n1. Change one of the sensitivity settings in Editor Settings > Editors > 3D such as \"Orbit Sensitivity\" or \"Freelook Sensitivity\".\n2. Play the game, in embedded game window click the camera icon and 3D. The sensitivity hasn't changed.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "cc @YeldhamDev ", "created_at": "2025-03-07 12:52:12", "merge_commit_sha": "f1597b3023ba74b1ef174c3f9c4daf3f3c19a951", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103734", "base_commit": "f2cc3f12750adae431384d7bac2f75d1c7e506be", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex 4fafdefbb598..267514ffde6a 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1338,6 +1338,10 @@ void FileSystemDock::_fs_changed() {\n \t}\n \n \tset_process(false);\n+\tif (had_focus) {\n+\t\thad_focus->grab_focus();\n+\t\thad_focus = nullptr;\n+\t}\n }\n \n void FileSystemDock::_set_scanning_mode() {\n@@ -2675,6 +2679,12 @@ bool FileSystemDock::_matches_all_search_tokens(const String &p_text) {\n }\n \n void FileSystemDock::_rescan() {\n+\tif (tree->has_focus()) {\n+\t\thad_focus = tree;\n+\t} else if (files->has_focus()) {\n+\t\thad_focus = files;\n+\t}\n+\n \t_set_scanning_mode();\n \tEditorFileSystem::get_singleton()->scan();\n }\ndiff --git a/editor/filesystem_dock.h b/editor/filesystem_dock.h\nindex 0ed0de3d59e9..dac535efb8e9 100644\n--- a/editor/filesystem_dock.h\n+++ b/editor/filesystem_dock.h\n@@ -235,6 +235,7 @@ class FileSystemDock : public VBoxContainer {\n \tbool import_dock_needs_update = false;\n \tTreeItem *resources_item = nullptr;\n \tTreeItem *favorites_item = nullptr;\n+\tControl *had_focus = nullptr;\n \n \tbool holding_branch = false;\n \tVector<TreeItem *> tree_items_selected_on_drag_begin;\n", "test_patch": "", "problem_statement": "FileSystem panel loses focus after Renaming or Duplicating files\n**Godot version:**\r\n3.2.alpha 35944aebdeb4c3b5869aaeedaaded02397b7ce92\r\n**OS/device including version:**\r\n5.3.7.arch1-1\r\n**Issue description:**\r\nDeleting, renaming or duplicating a file in the FileSystem panel opens a prompt window. If you close this window while deleting a file (either by confirming the deletion or cancelling it) the FileSystem panel regains focus. This doesn't happen when duplicating or renaming a file. **edit:** [and it would be nice if it did.](https://github.com/godotengine/godot/issues/33126#issuecomment-547577403)\r\n**Steps to reproduce:**\r\n1. Select a file in the FileSystem panel\r\n2. Duplicate the file either by right-click -> Duplicate or the shortcut Ctrl+D\r\n3. Type a new name and press Return(Enter) to confirm\r\n\n", "hints_text": "What would be the intended behaviour?\r\n\r\nI the deleting behaviour correct or the renaming and duplicating behaviour correct?\nOh sorry for being unclear: I believe having the FileSystem panel regain focus after duplicating/renaming should be the way it behaves. This would make it behave the same way as the Scene panel where it's possible to navigate using the arrow keys and duplicate/rename/delete using shortcut keys (trying to do that in the FileSystem means going back and forth from the keyboard and mouse to refocus the panel.)\nStill valid in 3.2.3\r\nAlthough when you do something with keyboard only, the file system keeps the focus properly. It loses it only when you move the mouse over viewport.\n>Although when you do something with keyboard only, the file system keeps the focus properly. It loses it only when you move the mouse over viewport.\r\n\r\nI don't know if the `keyboard only` method has stopped working since KoBeWi's comment.\r\n\r\nBecause for me in:\r\nv3.4.1.stable.official [aa1b95889]\r\nWindows 10 21H1\r\n\r\nThe FileSystem panel doesn't regain focus when renaming (`F2`) or duplicating (`Ctrl d`).\r\n\r\nPressing `arrow up` or `arrow down` doesn't do anything.\r\n\r\nAnd if a Scene panel node (ex: Node2D) was selected before renaming or duplicating.\r\nThen `F2` makes the `Node2D` text editable.\r\n\nSo I tried adding `tree->grab_focus()` at the end of the `FileSystemDock::_duplicate_operation_confirm` function. But:\r\n\r\n- After the rename dialog gets closed, viewport automatically gains focus because the mouse is hovering over it. But if you move the rename dialog so that it no longer hovers over the viewport, after the dialog gets closed, the file system dock properly regains focus. \n@IgorKordiukiewicz  You should probably use `call_deferred()` to restore focus.\nEven after trying to restore focus with `call_deferred()` it doesn't restore it, because the viewport just automatically gains focus when mouse is hovering over it.\nIt regains focus only when moving cursor or closing the dialog. Deferring the call should fix the latter, so it's weird it won't work \ud83e\udd14", "created_at": "2025-03-06 23:34:24", "merge_commit_sha": "3751a4a026b65429bc30bd64f747f1001a086d50", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103670", "base_commit": "134da374975114ef8e05cf81d1d30eff645e310e", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex dd0030d134f6..0a03583b4bf9 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -1888,6 +1888,15 @@ void EditorInspectorSection::gui_input(const Ref<InputEvent> &p_event) {\n \t} else if (mb.is_valid() && !mb->is_pressed()) {\n \t\tqueue_redraw();\n \t}\n+\n+\tRef<InputEventMouseMotion> mm = p_event;\n+\tif (mm.is_valid()) {\n+\t\tint header_height = _get_header_height();\n+\t\tVector2 previous = mm->get_position() - mm->get_relative();\n+\t\tif ((mm->get_position().y >= header_height) != (previous.y >= header_height)) {\n+\t\t\tqueue_redraw();\n+\t\t}\n+\t}\n }\n \n String EditorInspectorSection::get_section() const {\n", "test_patch": "", "problem_statement": "Inspector Section doesn't always update hover state\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nThe hover state on inspector section headers doesn't update when cursor moves in or out of the header rect. It only updates when leaving or entering the entire Control\n\n### Steps to reproduce\n\nCreate any node. Expand an inspector section. Move the cursor in and out of the header rect.\n\nhttps://github.com/user-attachments/assets/b4e0a0fb-9cb2-4e40-8069-f1975cb71dd7\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-03-06 02:09:35", "merge_commit_sha": "cf68b5f6ebe572baff367e64d6e96f25b18c0ad2", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103617", "base_commit": "134da374975114ef8e05cf81d1d30eff645e310e", "patch": "diff --git a/servers/rendering/renderer_rd/shaders/canvas.glsl b/servers/rendering/renderer_rd/shaders/canvas.glsl\nindex 48420e06c9bf..e2d9086a5de5 100644\n--- a/servers/rendering/renderer_rd/shaders/canvas.glsl\n+++ b/servers/rendering/renderer_rd/shaders/canvas.glsl\n@@ -306,6 +306,7 @@ vec4 light_compute(\n \t\tvec2 screen_uv,\n \t\tvec2 uv,\n \t\tvec4 color, bool is_directional) {\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \tvec4 light = vec4(0.0);\n \tvec3 light_direction = vec3(0.0);\n \n", "test_patch": "", "problem_statement": "Accessing `TEXTURE_PIXEL_SIZE` in a light() function leads to shader compilation errors\n### Tested versions\n\n- Reproducible in Godot 4.4-stable.\n- Reproducible in Godot 4.4-rc1.\n- Reproducible in Godot 4.4-dev3.\n- Not reproducible in Godot 4.3-stable.\n- Not reproducible in Godot 4.4-dev1.\n- Not reproducible in Godot 4.4-dev2.\n\nBisection result: a657ea42f1e656695f502a0e5f50ea9e0e041c3e is the first bad commit.\n\n### System information\n\nGodot v4.4.stable (cc10aa775) - Arch Linux #1 SMP PREEMPT_DYNAMIC Thu, 27 Feb 2025 18:09:44 +0000 on Wayland - Wayland display driver, Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Laptop GPU - 11th Gen Intel(R) Core(TM) i7-11800H @ 2.30GHz (16 threads)\n\n### Issue description\n\nAfter opening our project in Godot 4.4, I noticed shader errors printed connected to our light shader code. I narrowed it down to using `TEXTURE_PIXEL_SIZE` in a light() function within a canvas item shader. Related shaders also stopped working.\n\n[godot.log](https://github.com/user-attachments/files/19078527/godot.log)\n\n### Steps to reproduce\n\nAttach this shader to a canvas item node:\n```shader\nshader_type canvas_item;\n\nvoid light() {\n\tvec2 something = TEXTURE_PIXEL_SIZE;\n}\n\n```\n\n### Minimal reproduction project (MRP)\n\n[reproduction.zip](https://github.com/user-attachments/files/19078540/reproduction.zip)\n", "hints_text": "Bisection result: a657ea42f1e656695f502a0e5f50ea9e0e041c3e is the first bad commit.", "created_at": "2025-03-05 07:46:42", "merge_commit_sha": "2f5f3c9a5aa088f7e3e2c5c6619cd2d0a9679b94", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103526", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex 26c94bf25cf1..ead01551939f 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -2563,7 +2563,8 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\tAtom *atoms = (Atom *)data;\n \t\tAtom wm_act_max_horz;\n \t\tAtom wm_act_max_vert;\n-\t\tif (strcmp(p_atom_name, \"_NET_WM_STATE\") == 0) {\n+\t\tbool checking_state = strcmp(p_atom_name, \"_NET_WM_STATE\") == 0;\n+\t\tif (checking_state) {\n \t\t\twm_act_max_horz = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_HORZ\", False);\n \t\t\twm_act_max_vert = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_VERT\", False);\n \t\t} else {\n@@ -2581,9 +2582,16 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\t\t\tfound_wm_act_max_vert = true;\n \t\t\t}\n \n-\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n-\t\t\t\tretval = true;\n-\t\t\t\tbreak;\n+\t\t\tif (checking_state) {\n+\t\t\t\tif (found_wm_act_max_horz && found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \n", "test_patch": "", "problem_statement": "Persistent window state does not work for linux X11 gnome-shell 'tiled/docked/snapped' editor windows\n### Tested versions\n\n- Reproducible on Godot 4.4-stable\n\n### System information\n\nGodot v4.4.stable - Ubuntu 22.04.5 LTS 22.04 on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3050 Laptop GPU - 12th Gen Intel(R) Core(TM) i7-12700H (14 threads)\n\n### Issue description\n\n[Persistent window state](https://godotengine.org/releases/4.4/#persistent-window-state) doesn't work if your window is 'tiled' in X11 gnome.\n\nTested on X11 GNOME Shell 42.9  Xorg: 1:7.7+23ubuntu2\n\n\nIt looks like `_NET_WM_STATE` is `..._MAXIMIZED_VERT` which isn't the same as maximized..\n\nThe window geometry is `0,65+2558x1375`\n\nBut when I re-open it becomes `..._MAXIMIZED_VERT | ..._MAXIMIZED_HORIZ`\nand the window geometry is  `0,64+5120x1376`\n\nBEFORE closing\n```\n_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 89\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 65\n                program specified size: 2558 by 1375\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4045156\n```\n\nAFTER re-opening\n```_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_HORZ, _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 85\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 64\n                program specified size: 5120 by 1376\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4048202\n```\n\n### Steps to reproduce\n\nRe-open the window in gnome window manager after snapping to the left or right\n\n### Minimal reproduction project (MRP)\n\nno MRP possible?\n", "hints_text": "", "created_at": "2025-03-03 22:09:23", "merge_commit_sha": "1f2d135444f68a6a60372e48431d210e7943c6f0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103523", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/platform/android/java_godot_lib_jni.cpp b/platform/android/java_godot_lib_jni.cpp\nindex 054c809c6e3f..0bb78bb9d974 100644\n--- a/platform/android/java_godot_lib_jni.cpp\n+++ b/platform/android/java_godot_lib_jni.cpp\n@@ -49,6 +49,7 @@\n #include \"core/config/project_settings.h\"\n #include \"core/input/input.h\"\n #include \"main/main.h\"\n+#include \"servers/rendering_server.h\"\n \n #ifndef _3D_DISABLED\n #include \"servers/xr_server.h\"\n", "test_patch": "", "problem_statement": "Build error when building for Android with `disable_3d=yes`\n### Tested versions\n\n- Reproducible in: 4.4-stable\n- Not reproducible in 4.3-stable and lower\n\n### System information\n\nArch Linux x86_64 6.13.5-arch1-1\n\n### Issue description\n\nGodot doesn't compile when using the `disable_3d=yes` option in scons\n\n```\nplatform/android/java_godot_lib_jni.cpp:478:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:478:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\n```\n\nTested in Arch Linux and Ubuntu 20.04. No difference.\nThis didn't happen on 4.3 version\nAfter some research it seems like this is connected to this commit: [28d1dcc](https://github.com/godotengine/godot/commit/28d1dccf6370a1754c9bd49b9e5ec3f15db1e535)\n\n### Steps to reproduce\n\n1. Download Godot source code and required build tools\n2. Compile the engine with command `scons platform=android arch=x86_64 disable_3d=yes`\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "hints_text": "", "created_at": "2025-03-03 21:19:38", "merge_commit_sha": "1753893c60ac309c21a77201725fa2820caf7f1e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103480", "base_commit": "dc128dddb603699712ee7633bb635b3d6c661706", "patch": "diff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9a3e4fd9d7fa..638b529676a0 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -3850,6 +3850,9 @@ RID RenderingDevice::render_pipeline_create(RID p_shader, FramebufferFormatID p_\n \tERR_FAIL_NULL_V(shader, RID());\n \tERR_FAIL_COND_V_MSG(shader->is_compute, RID(), \"Compute shaders can't be used in render pipelines\");\n \n+\t// Validate pre-raster shader. One of stages must be vertex shader or mesh shader (not implemented yet).\n+\tERR_FAIL_COND_V_MSG(!shader->stage_bits.has_flag(RDD::PIPELINE_STAGE_VERTEX_SHADER_BIT), RID(), \"Pre-raster shader (vertex shader) is not provided for pipeline creation.\");\n+\n \tFramebufferFormat fb_format;\n \t{\n \t\t_THREAD_SAFE_METHOD_\n", "test_patch": "", "problem_statement": "Creating render pipeline for a `RDShaderFile` that doesn't have vertex shader causes crash\n### Tested versions\n\n4.4.rc3\n\n### System information\n\nGodot v4.4.rc.mono - EndeavourOS  SMP PREEMPT_DYNAMIC Sat, 22 Feb 2025 00:37:05 +0000 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Mobile) - integrated AMD Radeon Graphics (RADV RENOIR) - AMD Ryzen 7 4800U with Radeon Graphics (16 threads)\n\n### Issue description\n\nIf a glsl file only has `#[fragment]` but no `#[vertex]`, it can be successfully compiled and loaded in script. And if it is used in `RenderingDevice.render_pipeline_create`, the game will crash (if it's a tool script, the whole editor will crash).\n\n### Steps to reproduce\n\nRun the MRP, then the game crashes:\n```\nStop reason: signal SIGSEGV: address not mapped to object (fault address: 0x0)\nStop reason: signal SIGSEGV: invalid permissions for mapped object (fault address: 0x7fffa7e21fd0)\n```\nCall stack:\n```\n___lldb_unnamed_symbol2415 (@___lldb_unnamed_symbol2415:686)\n___lldb_unnamed_symbol2417 (@___lldb_unnamed_symbol2417:62)\n___lldb_unnamed_symbol2420 (@___lldb_unnamed_symbol2420:108)\nRenderingDeviceDriverVulkan::render_pipeline_create(RenderingDeviceDriver::ShaderID, RenderingDeviceDriver::VertexFormatID, RenderingDeviceCommons::RenderPrimitive, RenderingDeviceCommons::PipelineRasterizationState, RenderingDeviceCommons::PipelineMultisampleState, RenderingDeviceCommons::PipelineDepthStencilState, RenderingDeviceCommons::PipelineColorBlendState, VectorView<int>, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, RenderingDeviceDriver::RenderPassID, unsigned int, VectorView<RenderingDeviceCommons::PipelineSpecializationConstant>) (/home/luo/godot/drivers/vulkan/rendering_device_driver_vulkan.cpp:5246)\nRenderingDevice::render_pipeline_create(RID, long, long, RenderingDeviceCommons::RenderPrimitive, RenderingDeviceCommons::PipelineRasterizationState const&, RenderingDeviceCommons::PipelineMultisampleState const&, RenderingDeviceCommons::PipelineDepthStencilState const&, RenderingDeviceCommons::PipelineColorBlendState const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, Vector<RenderingDeviceCommons::PipelineSpecializationConstant> const&) (/home/luo/godot/servers/rendering/rendering_device.cpp:3957)\nRenderingDevice::_render_pipeline_create(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&) (/home/luo/godot/servers/rendering/rendering_device.cpp:8269)\nvoid call_with_variant_args_ret_helper<__UnexistingClass, RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&, 0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul>(__UnexistingClass*, RID (__UnexistingClass::*)(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&), Variant const**, Variant&, Callable::CallError&, IndexSequence<0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul>) (/home/luo/godot/core/variant/binder_common.h:767)\nvoid call_with_variant_args_ret_dv<__UnexistingClass, RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&>(__UnexistingClass*, RID (__UnexistingClass::*)(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&), Variant const**, int, Variant&, Callable::CallError&, Vector<Variant> const&) (/home/luo/godot/core/variant/binder_common.h:546)\nMethodBindTR<RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&>::call(Object*, Variant const**, int, Callable::CallError&) const (/home/luo/godot/core/object/method_bind.h:524)\nGDScriptFunction::call(GDScriptInstance*, Variant const**, int, Callable::CallError&, GDScriptFunction::CallState*) (/home/luo/godot/modules/gdscript/gdscript_vm.cpp:2013)\nGDScriptInstance::callp(StringName const&, Variant const**, int, Callable::CallError&) (/home/luo/godot/modules/gdscript/gdscript.cpp:2053)\nNode::_gdvirtual__ready_call() (/home/luo/godot/scene/main/node.h:391)\nNode::_notification(int) (/home/luo/godot/scene/main/node.cpp:227)\nNode::_notificationv(int, bool) (/home/luo/godot/scene/main/node.h:49)\nCanvasItem::_notificationv(int, bool) (/home/luo/godot/scene/main/canvas_item.h:44)\nNode2D::_notificationv(int, bool) (/home/luo/godot/scene/2d/node_2d.h:37)\nObject::notification(int, bool) (/home/luo/godot/core/object/object.cpp:911)\nNode::_propagate_ready() (/home/luo/godot/scene/main/node.cpp:282)\nNode::_propagate_ready() (/home/luo/godot/scene/main/node.cpp:273)\nNode::_set_tree(SceneTree*) (/home/luo/godot/scene/main/node.cpp:3289)\n```\n\n### Minimal reproduction project (MRP)\n\n[RDShaderFileCrash.zip](https://github.com/user-attachments/files/19043836/RDShaderFileCrash.zip)\n", "hints_text": "Can't confirm on Windows 11, so might be platform specific\n\nCan you test previous versions like 4.3 to check if this occurs there as well or if it is specific to 4.4?\nThe same with 4.3. \nMoreover, if there is only a vertex shader but no fragment shader, it reports errors at runtime, but not crash.", "created_at": "2025-03-02 20:48:10", "merge_commit_sha": "6536f5f2df6f7a272c8c1a1598c97cb9dce2baf9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103440", "base_commit": "15ff450680a40391aabbffde0a57ead2cd84db56", "patch": "diff --git a/modules/jolt_physics/misc/jolt_math_funcs.cpp b/modules/jolt_physics/misc/jolt_math_funcs.cpp\nnew file mode 100644\nindex 000000000000..b0ef5f45747d\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.cpp\n@@ -0,0 +1,70 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.cpp                                                   */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+/*\n+Adapted to Godot from the Jolt Physics library.\n+*/\n+\n+/*\n+Copyright 2021 Jorrit Rouwe\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in\n+the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\n+the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR\n+A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n+ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n+*/\n+\n+#include \"jolt_math_funcs.h\"\n+\n+void JoltMath::decompose(Basis &p_basis, Vector3 &r_scale) {\n+\tVector3 x = p_basis.get_column(Vector3::AXIS_X);\n+\tVector3 y = p_basis.get_column(Vector3::AXIS_Y);\n+\tVector3 z = p_basis.get_column(Vector3::AXIS_Z);\n+\n+\tconst real_t x_dot_x = x.dot(x);\n+\ty -= x * (y.dot(x) / x_dot_x);\n+\tz -= x * (z.dot(x) / x_dot_x);\n+\tconst real_t y_dot_y = y.dot(y);\n+\tz -= y * (z.dot(y) / y_dot_y);\n+\tconst real_t z_dot_z = z.dot(z);\n+\n+\tconst real_t det = x.cross(y).dot(z);\n+\n+\tr_scale = SIGN(det) * Vector3(Math::sqrt(x_dot_x), Math::sqrt(y_dot_y), Math::sqrt(z_dot_z));\n+\n+\tp_basis.set_column(Vector3::AXIS_X, x / r_scale.x);\n+\tp_basis.set_column(Vector3::AXIS_Y, y / r_scale.y);\n+\tp_basis.set_column(Vector3::AXIS_Z, z / r_scale.z);\n+}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.h b/modules/jolt_physics/misc/jolt_math_funcs.h\nnew file mode 100644\nindex 000000000000..ba2d290ac77c\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.h\n@@ -0,0 +1,59 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.h                                                     */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef JOLT_MATH_FUNCS_H\n+#define JOLT_MATH_FUNCS_H\n+\n+#include \"core/math/transform_3d.h\"\n+\n+class JoltMath {\n+public:\n+\t// Note that `p_basis` is mutated to be right-handed orthonormal.\n+\tstatic void decompose(Basis &p_basis, Vector3 &r_scale);\n+\n+\t// Note that `p_transform` is mutated to be right-handed orthonormal.\n+\tstatic _FORCE_INLINE_ void decompose(Transform3D &p_transform, Vector3 &r_scale) {\n+\t\tdecompose(p_transform.basis, r_scale);\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Basis &p_basis, Basis &r_new_basis, Vector3 &r_scale) {\n+\t\tBasis new_basis = p_basis;\n+\t\tdecompose(new_basis, r_scale);\n+\t\tr_new_basis = new_basis;\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Transform3D &p_transform, Transform3D &r_new_transform, Vector3 &r_scale) {\n+\t\tTransform3D new_transform;\n+\t\tdecompose(new_transform, r_scale);\n+\t\tr_new_transform = new_transform;\n+\t}\n+};\n+\n+#endif // JOLT_MATH_FUNCS_H\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex b0a9ffd62225..0a2693ddb634 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -31,6 +31,7 @@\n #include \"jolt_area_3d.h\"\n \n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -370,7 +371,8 @@ void JoltArea3D::set_default_area(bool p_value) {\n void JoltArea3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to area '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -378,8 +380,6 @@ void JoltArea3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex ac2b37470ef1..5bc3aee1bce7 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../joints/jolt_joint_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -543,7 +544,8 @@ JoltBody3D::~JoltBody3D() {\n void JoltBody3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to physics body '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -551,8 +553,6 @@ void JoltBody3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex bfe77e008d59..f32ddad0d469 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_shaped_object_3d.h\"\n \n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_custom_double_sided_shape.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n@@ -347,7 +348,10 @@ void JoltShapedObject3D::commit_shapes(bool p_optimize_compound) {\n void JoltShapedObject3D::add_shape(JoltShape3D *p_shape, Transform3D p_transform, bool p_disabled) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed when adding shape at index %d to physics body '%s'.\", shapes.size(), to_string()));\n \n-\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform.orthonormalized(), p_transform.basis.get_scale(), p_disabled));\n+\tVector3 shape_scale;\n+\tJoltMath::decompose(p_transform, shape_scale);\n+\n+\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform, shape_scale, p_disabled));\n \n \t_shapes_changed();\n }\n@@ -430,8 +434,8 @@ void JoltShapedObject3D::set_shape_transform(int p_index, Transform3D p_transfor\n \tERR_FAIL_INDEX(p_index, (int)shapes.size());\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, \"Failed to correctly set transform for shape at index %d in body '%s'.\");\n \n-\tVector3 new_scale = p_transform.basis.get_scale();\n-\tp_transform.basis.orthonormalize();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \tJoltShapeInstance3D &shape = shapes[p_index];\n \ndiff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex 3852e42d51f2..d7a4afec57ba 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../objects/jolt_area_3d.h\"\n #include \"../objects/jolt_body_3d.h\"\n@@ -288,11 +289,10 @@ bool JoltPhysicsDirectSpaceState3D::_body_motion_cast(const JoltBody3D &p_body,\n \t\tconst Transform3D transform_com_local = transform_local.translated_local(com_scaled);\n \t\tTransform3D transform_com = body_transform * transform_com_local;\n \n-\t\tVector3 scale = transform_com.basis.get_scale();\n+\t\tVector3 scale;\n+\t\tJoltMath::decompose(transform_com, scale);\n \t\tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"body_test_motion was passed an invalid transform along with body '%s'. This results in invalid scaling for shape at index %d.\");\n \n-\t\ttransform_com.basis.orthonormalize();\n-\n \t\treal_t shape_safe_fraction = 1.0;\n \t\treal_t shape_unsafe_fraction = 1.0;\n \n@@ -590,11 +590,10 @@ int JoltPhysicsDirectSpaceState3D::intersect_shape(const ShapeParameters &p_para\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"intersect_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"intersect_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -647,11 +646,10 @@ bool JoltPhysicsDirectSpaceState3D::cast_motion(const ShapeParameters &p_paramet\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tTransform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -684,11 +682,10 @@ bool JoltPhysicsDirectSpaceState3D::collide_shape(const ShapeParameters &p_param\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"collide_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"collide_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -754,11 +751,10 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -890,8 +886,8 @@ bool JoltPhysicsDirectSpaceState3D::body_test_motion(const JoltBody3D &p_body, c\n \tTransform3D transform = p_parameters.from;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, vformat(\"body_test_motion (maybe from move_and_slide?) was passed an invalid transform along with body '%s'.\", p_body.to_string()));\n \n-\tVector3 scale = transform.basis.get_scale();\n-\ttransform.basis.orthonormalize();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \n \tspace->try_optimize();\n \n", "test_patch": "", "problem_statement": "Negative scaling is broken when using Jolt Physics\n### Tested versions\n\n\nv4.4.rc2.mono.official [01545c995]\n\nThis error appeared after upgrading to 4.4rc2 from 4.3.  I was previously using the jolt physics add on.  \n\nThis error goes away if i switch to the godot physics engine instead.  It reappears if using jolt.  \n\n### System information\n\nGodot v4.4.rc2.mono - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 3700X 8-Core Processor (16 threads)\n\n### Issue description\n\nWith Jolt Physics enabled, when adding a static body as a child of a VehicleWheel3D I get a flood of quaternion errors:\n\n```\nE 0:00:01:120   get_quaternion: Basis [X: (1.0, 0.0, 0.0), Y: (0.0, 1.0, 0.0), Z: (0.0, 0.0, -1.0)] must be \nnormalized in order to be casted to a Quaternion. Use get_rotation_quaternion() or call orthonormalized() \nif the Basis contains linearly independent vectors.\n  <C++ Error>   Condition \"!is_rotation()\" is true. Returning: Quaternion()\n  <C++ Source>  core/math/basis.cpp:730 @ get_quaternion()\n```\n\nI can get rid of the errors if I move the StaticBody3D outside of the VehicleWheel3D.  I do expect it to work as before.  I prefer adding a staticBody3D as a child of VehicleWheel3D for organizations sake. \n\n### Steps to reproduce\n\n1. Enable Jolt Physics under Project -> Project Settings -> Physics -> 3D -> Physics Engine\n2. Add a VehicleBody3D node with a collision mesh\n3. Add a VehicleWheel3D node\n4. Add a StaticBody3D node as a child of the VehicleWheel3D\n5. Launch the scene and a flood of quaternion errors should appear\n\nIncluding project as well.  Open the project and run.  \n\nThank you.\n\n### Minimal reproduction project (MRP)\n\n[mrpWheelStaticBodyChild.zip](https://github.com/user-attachments/files/19031403/mrpWheelStaticBodyChild.zip)\n", "hints_text": "Suggested fix here\n\nhttps://github.com/godotengine/godot/pull/103426\n\nThere may be other places to reduce calculation repetition, best to get an expert to review before any merge", "created_at": "2025-03-01 19:14:25", "merge_commit_sha": "82c713ec51e91154f24132405b37ec191b305bc2", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103436", "base_commit": "15ff450680a40391aabbffde0a57ead2cd84db56", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 30c558e0bd5d..bc3b4ceeb2b7 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -257,7 +257,7 @@ void GameView::_show_update_window_wrapper() {\n \tPoint2 offset_embedded_process = embedded_process->get_global_position() - get_global_position();\n \n \t// On the first startup, the global position of the embedded process control is invalid because it was\n-\t// never displayed. We will calculated it manually using the minimum size of the window.\n+\t// never displayed. We will calculate it manually using the minimum size of the window.\n \tif (offset_embedded_process == Point2()) {\n \t\toffset_embedded_process.y = wrapped_min_size.y;\n \t}\n@@ -812,9 +812,8 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \t_update_embed_window_size();\n \tRect2i rect = embedded_process->get_screen_embedded_window_rect();\n \n-\t// On the first startup, the global rect of the embedded process control is invalid because it was\n-\t// never displayed. We will calculated it manually.\n-\tif (!window_wrapper->get_window_enabled() && rect.size.y < embedded_process->get_custom_minimum_size().y) {\n+\t// Usually, the global rect of the embedded process control is invalid because it was hidden. We will calculate it manually.\n+\tif (!window_wrapper->get_window_enabled()) {\n \t\tSize2 old_min_size = embedded_process->get_custom_minimum_size();\n \t\tembedded_process->set_custom_minimum_size(Size2i());\n \n", "test_patch": "", "problem_statement": "Invalid startup embedded game location and size after resizing editor main area\n### Tested versions\n\n- Reproductive in Godot 4.4 RC3, RC2\n\n### System information\n\nGodot v4.4.rc3 - Windows 11 (build 26100) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Laptop GPU (NVIDIA; 32.0.15.7260) - AMD Ryzen 7 5800H with Radeon Graphics (16 threads)\n\n### Issue description\n\nWhen the game is embedded in the editor, if when editor main area is resized, the next time the embedded game is started it will startup with the previous location and sizse.\n\n### Steps to reproduce\n\n- Activate embedded without floating window\n- Start the game the first time, location and size will be OK\n- Stop the game\n- Resize a floating dock or the bottom panel when your are not in the Game tab\n- Start the game again\n- For a split second, the game will be displayed at the previous location and size before the resizing in the editor (the location and size of the previous startup)\n\nhttps://github.com/user-attachments/assets/94d29bef-e8b1-4b56-b1f6-6cef7560c6d9\n\n### Minimal reproduction project (MRP)\n\nAny project\n", "hints_text": "", "created_at": "2025-03-01 16:36:54", "merge_commit_sha": "64456e7dd44b8db1de0b4fe51657655ecdee6c4e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103434", "base_commit": "15ff450680a40391aabbffde0a57ead2cd84db56", "patch": "diff --git a/servers/rendering/shader_language.cpp b/servers/rendering/shader_language.cpp\nindex 59adb53b7866..66a43684a52a 100644\n--- a/servers/rendering/shader_language.cpp\n+++ b/servers/rendering/shader_language.cpp\n@@ -1342,7 +1342,7 @@ void ShaderLanguage::_parse_used_identifier(const StringName &p_identifier, Iden\n \t\t\tbreak;\n \t\tcase IdentifierType::IDENTIFIER_VARYING:\n \t\t\tif (HAS_WARNING(ShaderWarning::UNUSED_VARYING_FLAG) && used_varyings.has(p_identifier)) {\n-\t\t\t\tif (shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_VERTEX && shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_FRAGMENT) {\n+\t\t\t\tif (shader->varyings[p_identifier].stage == ShaderNode::Varying::STAGE_UNKNOWN) {\n \t\t\t\t\tused_varyings[p_identifier].used = true;\n \t\t\t\t}\n \t\t\t}\n@@ -6510,6 +6510,27 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t_set_error(RTR(\"Expected constant expression.\"));\n \t\t\t\t\t\treturn nullptr;\n \t\t\t\t\t}\n+\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n+\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n+\t\t\t\t\t\treturn nullptr;\n+\t\t\t\t\t}\n+#ifdef DEBUG_ENABLED\n+\t\t\t\t\tif (check_warnings) {\n+\t\t\t\t\t\tStringName func_name;\n+\t\t\t\t\t\tBlockNode *b = p_block;\n+\n+\t\t\t\t\t\twhile (b) {\n+\t\t\t\t\t\t\tif (b->parent_function) {\n+\t\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n+\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tb = b->parent_block;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n+\t\t\t\t\t}\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (ident_type == IDENTIFIER_VARYING) {\n \t\t\t\t\t\tTkPos prev_pos = _get_tkpos();\n \t\t\t\t\t\tToken next_token = _get_token();\n@@ -6542,11 +6563,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-\n-\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n-\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n-\t\t\t\t\t\treturn nullptr;\n-\t\t\t\t\t}\n #ifdef DEBUG_ENABLED\n \t\t\t\t\tif (check_position_write && ident_type == IDENTIFIER_BUILTIN_VAR) {\n \t\t\t\t\t\tif (String(identifier) == \"POSITION\") {\n@@ -6564,7 +6580,7 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t_set_tkpos(prev_pos);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-#endif\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (is_const) {\n \t\t\t\t\t\tlast_type = IDENTIFIER_CONSTANT;\n \t\t\t\t\t} else {\n@@ -6656,23 +6672,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\tvarname->is_local = is_local;\n \t\t\t\t\texpr = varname;\n \t\t\t\t}\n-#ifdef DEBUG_ENABLED\n-\t\t\t\tif (check_warnings) {\n-\t\t\t\t\tStringName func_name;\n-\t\t\t\t\tBlockNode *b = p_block;\n-\n-\t\t\t\t\twhile (b) {\n-\t\t\t\t\t\tif (b->parent_function) {\n-\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tb = b->parent_block;\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\n-\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n-\t\t\t\t}\n-#endif // DEBUG_ENABLED\n \t\t\t}\n \t\t} else if (tk.type == TK_OP_ADD) {\n \t\t\tcontinue; //this one does nothing\n", "test_patch": "", "problem_statement": "False positive UNUSED_VARYING\n### Tested versions\n\n- Reproducible in: v4.4.rc3.official [15ff45068], v4.4.dev7.official [46c8f8c5c]\n- Not reproducible in: v4.4.dev6.official [1f47e4c4e]\n\n### System information\n\nGodot v4.4.rc3 - Windows 10 (build 19045) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1050 Ti (NVIDIA; 32.0.15.7260) - Intel(R) Core(TM) i3-10105 CPU @ 3.70GHz (8 threads)\n\n### Issue description\n\nGodot reports a varying is not being used, while it is being used.\n\n### Steps to reproduce\n\nCreate or open a shader with a varying and look for warning in the bottom of the shader editor.\n\nFound and reproduced with this shader (included in the MRP below):\n\n```\nshader_type canvas_item;\n\nuniform float level;\n\nvarying vec4 vertex_color;\n\nvoid vertex() {\n\tvertex_color = COLOR;\n}\n\nvoid fragment()\n{\n\tCOLOR = vertex_color;\n\tCOLOR.a *= level;\n}\n```\n\nHere Godot claims `vertex_color` is not being used: `Line 5 (UNUSED_VARYING):The varying 'vertex_color' is declared but never used.`\n\nNote: The shader is based on an example from the documentation at [COLOR and TEXTURE](https://docs.godotengine.org/en/stable/tutorials/shaders/shader_reference/canvas_item_shader.html#color-and-texture):\n\n```\nvarying vec4 vertex_color;\nvoid vertex() {\n  vertex_color = COLOR;\n}\nvoid fragment() {\n  COLOR = vertex_color;\n}\n```\n\n\n### Minimal reproduction project (MRP)\n\n[svwt.zip](https://github.com/user-attachments/files/19036041/svwt.zip)\n", "hints_text": "I haven't bisected but I suspect #95737, cc @Chaosus.\n\nI put this in 4.4 milestone but it will most likely need to wait for 4.4.1 to be fixed as the 4.4 release is imminent - unless the regression fix is really trivial and done quickly.", "created_at": "2025-03-01 15:21:44", "merge_commit_sha": "a03ec29ac57f7c2f9e51267dd9012bddda92e063", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103424", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex cd6c51de4b2d..9a2c24473381 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -2177,7 +2177,7 @@ int Tree::draw_item(const Point2i &p_pos, const Point2 &p_draw_ofs, const Size2\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (!rtl && p_item->cells[i].buttons.size()) {\n+\t\t\tif (!p_item->cells[i].buttons.is_empty()) {\n \t\t\t\tint buttons_width = 0;\n \t\t\t\tfor (int j = p_item->cells[i].buttons.size() - 1; j >= 0; j--) {\n \t\t\t\t\tRef<Texture2D> button_texture = p_item->cells[i].buttons[j].texture;\n", "test_patch": "", "problem_statement": "Tree buttons don't behave the same in Right to Left\n### Tested versions\n\nGodot v4.4.beta1\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nIf tree i set to Right to Left layout direction the buttons in a column doesn't behave the same as in Left to Right direction when scrolling horizontally.\n\nScene tree in editor in LtR:\n\nhttps://github.com/user-attachments/assets/f6c079ad-a05b-4ad0-baeb-ef7c52e05ad6\n\nButtons doesn't move (just a little bit, https://github.com/godotengine/godot/issues/100645) when tree is scrolled. \n\nUsing RtL:\n\nhttps://github.com/user-attachments/assets/eae1bcb4-db75-4500-850c-81e74967ebe5\n\nSee how the buttons doesn't stay visible.\n\n### Steps to reproduce\n\nChange editor to a language with RtL language.\nOpen a scene with nodes in the scene tree\nChange the horizontal scroll position\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-03-01 07:27:42", "merge_commit_sha": "1ef52d80773d29be0279f13bc60e33c577972e1f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103419", "base_commit": "15ff450680a40391aabbffde0a57ead2cd84db56", "patch": "diff --git a/platform/android/java/app/AndroidManifest.xml b/platform/android/java/app/AndroidManifest.xml\nindex 60ce75fd16e2..1d59d15d560f 100644\n--- a/platform/android/java/app/AndroidManifest.xml\n+++ b/platform/android/java/app/AndroidManifest.xml\n@@ -46,7 +46,7 @@\n             android:excludeFromRecents=\"false\"\n             android:exported=\"true\"\n             android:screenOrientation=\"landscape\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:resizeableActivity=\"false\"\n             tools:ignore=\"UnusedAttribute\" >\n \ndiff --git a/platform/android/java/editor/src/main/AndroidManifest.xml b/platform/android/java/editor/src/main/AndroidManifest.xml\nindex a1971554bf7d..b136e348b2c7 100644\n--- a/platform/android/java/editor/src/main/AndroidManifest.xml\n+++ b/platform/android/java/editor/src/main/AndroidManifest.xml\n@@ -41,7 +41,7 @@\n \n         <activity\n             android:name=\".GodotEditor\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"true\"\n             android:icon=\"@mipmap/themed_icon\"\n             android:launchMode=\"singleTask\"\n@@ -59,7 +59,7 @@\n         </activity>\n         <activity\n             android:name=\".GodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -74,7 +74,7 @@\n         </activity>\n         <activity\n             android:name=\".embed.EmbeddedGodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -87,7 +87,7 @@\n             android:screenOrientation=\"userLandscape\" />\n         <activity\n             android:name=\".GodotXRGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:process=\":GodotXRGame\"\n             android:launchMode=\"singleTask\"\n             android:icon=\"@mipmap/ic_play_window\"\n", "test_patch": "", "problem_statement": "Android editor: Game crash after changing device language\n### Tested versions\n\nGodot Engine v4.3.stable.official [77dcf97d8]\n\n### System information\n\nXiaomi Redmi A2+, Android 13, compatible rendering\n\n### Issue description\n\nAfter changing device language, opening the game will hang for a few seconds then exit.\r\nThis issue occur the same way on Android emulator x86\n\n### Steps to reproduce\n\n1. Open the game\r\n2. Leave the game run in background and go to device system settings\r\n3. Change device display language\r\n4. Re-enter the game (the game will hang for a few seconds then exit)\n\n### Minimal reproduction project (MRP)\n\n[demo.zip](https://github.com/user-attachments/files/16936623/demo.zip)\r\n\n", "hints_text": "happening for me to i think the app crashes as a whole leaving a blank screen \nBisecting points to #94661 as the culprit, @m4gr3d\r\n\r\n![Captura 2024-09-25 20-18-16-312603](https://github.com/user-attachments/assets/7a04c88c-228b-4c19-9b4a-bd1706e9f3e4)\r\n\r\n<br>\r\n\r\n<details><summary>Errors + backtrace</summary>\r\n\r\n```\r\n09-25 18:18:36.786 19116 19116 E godot   : USER ERROR: Couldn't load file '/project.binary', error code 12.\r\n09-25 18:18:36.786 19116 19116 E godot   :    at: _load_settings_text_or_binary (core\\config\\project_settings.cpp:803)\r\n09-25 18:18:37.119 19116 19223 I godot   : Godot Engine v4.3.rc.custom_build.4d0da7401 (2024-07-24 17:17:46 UTC) - https://godotengine.org\r\n09-25 18:18:37.701 19116 19223 I godot   : OpenGL API OpenGL ES 3.2 V@415.0 (GIT@912136b, Ie3bb699d95, 1601292290) (Date:09/28/20) - Compatibility - Using Device: Qualcomm - Adreno (TM) 506\r\n09-25 18:18:37.785 19116 19223 I godot   :\r\n09-25 18:18:39.184 19116 19223 I godot   : Selected screen scale:  1.20000004768372\r\n09-25 18:18:39.371 19116 19223 I godot   : Selected screen scale:  1.20000004768372\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"singleton != nullptr\" is true.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: ResourceUID (core\\io\\resource_uid.cpp:263)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.139 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.139 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.139 19116 19116 E godot   : USER ERROR: IP singleton already exist.\r\n09-25 18:19:07.139 19116 19116 E godot   :    at: create (core\\io\\ip.cpp:335)\r\n09-25 18:19:07.139 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.155 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.155 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.162 19116 19116 F libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x3fffffffc in tid 19116 (e.editor.v4.dev), pid 19116 (e.editor.v4.dev)\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : Build fingerprint: 'xiaomi/onc/onc:10/QKQ1.191008.001/V11.0.2.0.QFLMIXM:user/release-keys'\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : Revision: '0'\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : ABI: 'arm64'\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : Timestamp: 2024-09-25 18:19:07-0300\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : pid: 19116, tid: 19116, name: e.editor.v4.dev  >>> org.godotengine.editor.v4.dev <<<\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : uid: 10463\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x3fffffffc\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x0  00000003fffffffc  x1  0000000000000001  x2  0000000000000004  x3  0000000000000003\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x4  0000000000000000  x5  0000000080000080  x6  6e636d47ff4c46ff  x7  7f7f7f7f7f7f7f7f\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x8  00000003fffffffc  x9  0000000000000001  x10 000000736bf55cc0  x11 0000000000000003\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x12 000000736bf54000  x13 0000000000000030  x14 fffffffffc000000  x15 fffffffff8000000\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x16 000000740803e890  x17 0000007408030a28  x18 000000740b804000  x19 000000740a62d000\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x20 0000000000000000  x21 000000740a62d000  x22 0000007ff5010dc0  x23 0000007378cd4f40\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x24 0000000000000008  x25 000000740a7e2020  x26 000000740a62d0b0  x27 0000000000000002\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x28 0000007ff5010b50  x29 0000007ff500a250\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     sp  0000007ff500a230  lr  00000073150d41e4  pc  00000073150d41f4\r\n09-25 18:19:07.560 19675 19675 F DEBUG   :\r\n09-25 18:19:07.560 19675 19675 F DEBUG   : backtrace:\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #00 pc 0000000002d811f4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::setup_remote_filesystem(String const&, int, String const&, String&)+164)\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #01 pc 0000000002d811bc  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::setup_remote_filesystem(String const&, int, String const&, String&)+108)\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #02 pc 0000000002d81170  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::setup_remote_filesystem(String const&, int, String const&, String&)+32)\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #03 pc 0000000002d7b530  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::open_dynamic_library(String const&, void*&, OS::GDExtensionData*)+776)\r\n09-25 18:19:07.562 19675 19675 F DEBUG   :       #04 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.562 19675 19675 F DEBUG   :       #05 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.562 19675 19675 F DEBUG   :       #06 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #07 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #08 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #09 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #10 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #11 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #12 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #13 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #14 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #15 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #16 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #17 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #18 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #19 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #20 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #21 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #22 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #23 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #24 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #25 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #26 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #27 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #28 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #29 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #30 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #31 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #32 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #33 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.565 19675 19675 F DEBUG   :       #34 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.565 19675 19675 F DEBUG   :       #35 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.566 19675 19675 F DEBUG   :       #36 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #37 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #38 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #39 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #40 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #41 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #42 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #43 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #44 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #45 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #46 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #47 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #48 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #49 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #50 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #51 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #52 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #53 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #54 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #55 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #56 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #57 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #58 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #59 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #60 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #61 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #62 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #63 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #64 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #65 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #66 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #67 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #68 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #69 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #70 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #71 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #72 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #73 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #74 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #75 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #76 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #77 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #78 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #79 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #80 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #81 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #82 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #83 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #84 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #85 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #86 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #87 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #88 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #89 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #90 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #91 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #92 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #93 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #94 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #95 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #96 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #97 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #98 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #99 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #100 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #101 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #102 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #103 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #104 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #105 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #106 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #107 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #108 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #109 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #110 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #111 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #112 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #113 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #114 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #115 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #116 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #117 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #118 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #119 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #120 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #121 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #122 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #123 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #124 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #125 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #126 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #127 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #128 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #129 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #130 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #131 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #132 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #133 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #134 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #135 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #136 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #137 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #138 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #139 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #140 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #141 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #142 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #143 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #144 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #145 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #146 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #147 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #148 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #149 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #150 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #151 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #152 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #153 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #154 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #155 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #156 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #157 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #158 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #159 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #160 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #161 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #162 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #163 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #164 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #165 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #166 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #167 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #168 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #169 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #170 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #171 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #172 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #173 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #174 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #175 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #176 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #177 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #178 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #179 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #180 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #181 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #182 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #183 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #184 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #185 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #186 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #187 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #188 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #189 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #190 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #191 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #192 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #193 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #194 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #195 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #196 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #197 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #198 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #199 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #200 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #201 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #202 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #203 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #204 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #205 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #206 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #207 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #208 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #209 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #210 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #211 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #212 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #213 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #214 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #215 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n```\r\n\r\n</details>\r\n\r\nA thing i noticed is when you change the language, attempt to come back make the engine do a entire restart and probably this is undesired as well.", "created_at": "2025-03-01 01:53:18", "merge_commit_sha": "c301b2ad9ab05ffc4108abe19bd6408432ea8579", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103415", "base_commit": "15ff450680a40391aabbffde0a57ead2cd84db56", "patch": "diff --git a/core/io/file_access_encrypted.cpp b/core/io/file_access_encrypted.cpp\nindex f2749157b3d0..f3d89a66971f 100644\n--- a/core/io/file_access_encrypted.cpp\n+++ b/core/io/file_access_encrypted.cpp\n@@ -30,9 +30,17 @@\n \n #include \"file_access_encrypted.h\"\n \n-#include \"core/crypto/crypto_core.h\"\n #include \"core/variant/variant.h\"\n \n+CryptoCore::RandomGenerator *FileAccessEncrypted::_fae_static_rng = nullptr;\n+\n+void FileAccessEncrypted::deinitialize() {\n+\tif (_fae_static_rng) {\n+\t\tmemdelete(_fae_static_rng);\n+\t\t_fae_static_rng = nullptr;\n+\t}\n+}\n+\n Error FileAccessEncrypted::open_and_parse(Ref<FileAccess> p_base, const Vector<uint8_t> &p_key, Mode p_mode, bool p_with_magic, const Vector<uint8_t> &p_iv) {\n \tERR_FAIL_COND_V_MSG(file.is_valid(), ERR_ALREADY_IN_USE, vformat(\"Can't open file while another file from path '%s' is open.\", file->get_path_absolute()));\n \tERR_FAIL_COND_V(p_key.size() != 32, ERR_INVALID_PARAMETER);\n@@ -48,9 +56,15 @@ Error FileAccessEncrypted::open_and_parse(Ref<FileAccess> p_base, const Vector<u\n \t\tkey = p_key;\n \t\tif (p_iv.is_empty()) {\n \t\t\tiv.resize(16);\n-\t\t\tCryptoCore::RandomGenerator rng;\n-\t\t\tERR_FAIL_COND_V_MSG(rng.init(), FAILED, \"Failed to initialize random number generator.\");\n-\t\t\tError err = rng.get_random_bytes(iv.ptrw(), 16);\n+\t\t\tif (unlikely(!_fae_static_rng)) {\n+\t\t\t\t_fae_static_rng = memnew(CryptoCore::RandomGenerator);\n+\t\t\t\tif (_fae_static_rng->init() != OK) {\n+\t\t\t\t\tmemdelete(_fae_static_rng);\n+\t\t\t\t\t_fae_static_rng = nullptr;\n+\t\t\t\t\tERR_FAIL_V_MSG(FAILED, \"Failed to initialize random number generator.\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tError err = _fae_static_rng->get_random_bytes(iv.ptrw(), 16);\n \t\t\tERR_FAIL_COND_V(err != OK, err);\n \t\t} else {\n \t\t\tERR_FAIL_COND_V(p_iv.size() != 16, ERR_INVALID_PARAMETER);\ndiff --git a/core/io/file_access_encrypted.h b/core/io/file_access_encrypted.h\nindex 570955b78352..a1bc0f09dcf6 100644\n--- a/core/io/file_access_encrypted.h\n+++ b/core/io/file_access_encrypted.h\n@@ -31,6 +31,7 @@\n #ifndef FILE_ACCESS_ENCRYPTED_H\n #define FILE_ACCESS_ENCRYPTED_H\n \n+#include \"core/crypto/crypto_core.h\"\n #include \"core/io/file_access.h\"\n \n #define ENCRYPTED_HEADER_MAGIC 0x43454447\n@@ -57,6 +58,8 @@ class FileAccessEncrypted : public FileAccess {\n \n \tvoid _close();\n \n+\tstatic CryptoCore::RandomGenerator *_fae_static_rng;\n+\n public:\n \tError open_and_parse(Ref<FileAccess> p_base, const Vector<uint8_t> &p_key, Mode p_mode, bool p_with_magic = true, const Vector<uint8_t> &p_iv = Vector<uint8_t>());\n \tError open_and_parse_password(Ref<FileAccess> p_base, const String &p_key, Mode p_mode);\n@@ -97,6 +100,8 @@ class FileAccessEncrypted : public FileAccess {\n \n \tvirtual void close() override;\n \n+\tstatic void deinitialize();\n+\n \tFileAccessEncrypted() {}\n \t~FileAccessEncrypted();\n };\ndiff --git a/core/register_core_types.cpp b/core/register_core_types.cpp\nindex 568694bdf4d0..d58097920d91 100644\n--- a/core/register_core_types.cpp\n+++ b/core/register_core_types.cpp\n@@ -45,6 +45,7 @@\n #include \"core/io/config_file.h\"\n #include \"core/io/dir_access.h\"\n #include \"core/io/dtls_server.h\"\n+#include \"core/io/file_access_encrypted.h\"\n #include \"core/io/http_client.h\"\n #include \"core/io/image_loader.h\"\n #include \"core/io/json.h\"\n@@ -455,5 +456,7 @@ void unregister_core_types() {\n \tCoreStringNames::free();\n \tStringName::cleanup();\n \n+\tFileAccessEncrypted::deinitialize();\n+\n \tOS::get_singleton()->benchmark_end_measure(\"Core\", \"Unregister Types\");\n }\n", "test_patch": "", "problem_statement": "Mbed TLS error when exporting with PCK encryption (musl libc)\n### Tested versions\n\n- Reproducible in: 4.4-beta1 and later\n- Not reproducible in: 4.3-stable\n\n### System information\n\nAlpine Linux - musl libc - gcc - Godot 4.4.rc2 - AMD GPU\n\n### Issue description\n\nI have compiled both the editor and the export templates in my system (Alpine Linux with musl libc and GCC) as usual, with my encryption key exported.\nWhen I try to export the game with the PCK encryption enabled, fails at 20% with the following errors:\n\n```\nERROR:  failed\n  ! mbedtls_ctr_drbg_seed returned an error -52.\n   at: init (core/crypto/crypto_core.cpp:73)\nERROR: Failed to initialize random number generator.\n   at: open_and_parse (core/io/file_access_encrypted.cpp:52)\nERROR: Condition \"err != OK\" is true. Returning: ERR_SKIP\n   at: _save_pack_file (editor/export/editor_export_platform.cpp:304)\nERROR: Save PCK: Failed to export project files.\n   at: add_message (editor/export/editor_export_platform.h:243)\n```\n\nIt works OK if I use the same compiled templates in the official 4.4-rc2 release running on my steam deck (GLIBC), so I think that the issue is in my compiled editor, not in the templates.\n\n### Steps to reproduce\n\nI've compiled the editor and templates with the following commands under Alpine Linux (musl libc) using GCC:\n\n```\n# Editor\nscons platform=linuxbsd arch=x86_64 production=yes lto=none\n\n# Templates (export the encryption key here)\nscons platform=windows target=template_debug arch=x86_64 production=yes lto=none\nscons platform=windows target=template_release arch=x86_64 production=yes lto=none\n```\n\n### Minimal reproduction project (MRP)\n\nnone\n", "hints_text": "**UPDATE**\n\nI've just tried to compile the editor without builtin_mbedtls and installed mbedtls-dev on my system:\n\n```\nscons platform=linuxbsd arch=x86_64 production=yes lto=none builtin_mbedtls=no\n```\n\nThe editor builds successfully, but trying to export returns the same error as using the builtin library.\nThis might be an incompatibility between musl libc or other Alpine components and mbedTLS' default entropy function.\n\nDo you get similar errors when using the Asset Library? I expect it might fail to initialize a TLS context too and not be able to download icons of assets.\n> Do you get similar errors when using the Asset Library? I expect it might fail to initialize a TLS context too and not be able to download icons of assets.\n\nIt works ok with the asset library. I can see all the icons and just downloaded an addon without errors.\nIs it working with a new project? It might be system entropy pool size issue, Asset Library likely initialize RNG once, and PCK encryption do it for every file (~probably more in 4.4 than in 4.3, due to IV generation changes~ should actually use it less, but only is `seed` is set). What's `cat /proc/sys/kernel/random/poolsize` command output on your system?\n> It might be system entropy pool size issue\n\nAlso, try setting `seed` in the PCK encryption tab to a non-zero value.\nError `-52` is `MBEDTLS_ERR_CTR_DRBG_ENTROPY_SOURCE_FAILED`, so it is likely related to entropy pool.\n> What's `cat /proc/sys/kernel/random/poolsize` command output on your system?\n\nIt's 256\n\nI will try with a new project, and also setting `seed` in the PCK tab.\n@bruvzg I can confirm that it's working well with a smaller project by default, and with the biggest project setting the `seed` value to a non-zero value.", "created_at": "2025-02-28 22:04:45", "merge_commit_sha": "65161977e9653c7dd0e6013eb70be66357d20aaa", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103403", "base_commit": "1753893c60ac309c21a77201725fa2820caf7f1e", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex f1d13123d659..de52afa91cda 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -1207,7 +1207,7 @@ void EditorNode::_sources_changed(bool p_exist) {\n \t\t}\n \n \t\t// Start preview thread now that it's safe.\n-\t\tif (!singleton->cmdline_export_mode) {\n+\t\tif (!singleton->cmdline_mode) {\n \t\t\tEditorResourcePreview::get_singleton()->start();\n \t\t}\n \n@@ -1807,7 +1807,7 @@ void EditorNode::_save_scene_with_preview(String p_file, int p_idx) {\n \tsave_scene_progress->step(TTR(\"Saving Scene\"), 4);\n \t_save_scene(p_file, p_idx);\n \n-\tif (!singleton->cmdline_export_mode) {\n+\tif (!singleton->cmdline_mode) {\n \t\tEditorResourcePreview::get_singleton()->check_for_invalidation(p_file);\n \t}\n \n@@ -4944,7 +4944,7 @@ bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringNa\n void EditorNode::progress_add_task(const String &p_task, const String &p_label, int p_steps, bool p_can_cancel) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": begin: \" + p_label + \" steps: \" + itos(p_steps));\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->add_task(p_task, p_label, p_steps, p_can_cancel);\n@@ -4954,7 +4954,7 @@ void EditorNode::progress_add_task(const String &p_task, const String &p_label,\n bool EditorNode::progress_task_step(const String &p_task, const String &p_state, int p_step, bool p_force_refresh) {\n \tif (!singleton) {\n \t\treturn false;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(\"\\t\" + p_task + \": step \" + itos(p_step) + \": \" + p_state);\n \t\treturn false;\n \t} else if (singleton->progress_dialog) {\n@@ -4967,7 +4967,7 @@ bool EditorNode::progress_task_step(const String &p_task, const String &p_state,\n void EditorNode::progress_end_task(const String &p_task) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": end\");\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->end_task(p_task);\n@@ -5220,7 +5220,7 @@ Error EditorNode::export_preset(const String &p_preset, const String &p_path, bo\n \texport_defer.android_build_template = p_android_build_template;\n \texport_defer.patch = p_patch;\n \texport_defer.patches = p_patches;\n-\tcmdline_export_mode = true;\n+\tcmdline_mode = true;\n \treturn OK;\n }\n \n@@ -6848,6 +6848,11 @@ EditorNode::EditorNode() {\n \tDEV_ASSERT(!singleton);\n \tsingleton = this;\n \n+\t// Detecting headless mode, that means the editor is running in command line.\n+\tif (!DisplayServer::get_singleton()->window_can_draw()) {\n+\t\tcmdline_mode = true;\n+\t}\n+\n \tResource::_get_local_scene_func = _resource_get_edited_scene;\n \n \t{\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex de3af997473a..63788e645f30 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -419,7 +419,7 @@ class EditorNode : public Node {\n \tbool script_distraction_free = false;\n \n \tbool changing_scene = false;\n-\tbool cmdline_export_mode = false;\n+\tbool cmdline_mode = false;\n \tbool convert_old = false;\n \tbool immediate_dialog_confirmed = false;\n \tbool opening_prev = false;\n", "test_patch": "", "problem_statement": "Headless import always emits errors about `!tasks.has(p_task)`\n### Tested versions\n\n- Reproducible in: 4.4.rc2\n- Reproducible in: 4.4.dev2\n- Not reproducible in: 4.4.dev1\n\n### System information\n\nGodot v4.4.rc2 - Windows 11 (build 26100) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 9 7940HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\n(This is a formal issue for what's mentioned [here](https://github.com/godotengine/godot/issues/100900#issuecomment-2567712127), and potentially a duplicate of #100900 itself, but since that one mentions errors at startup I figured it's possibly a different issue.)\n\nWhen running Godot with `--headless --import` on any project, you're currently met with the following output:\n\n```\nERROR: Do not use progress dialog (task) while flushing the message queue or using call_deferred()!\n   at: add_task (editor/progress_dialog.cpp:183)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true.\n   at: end_task (editor/progress_dialog.cpp:240)\n```\n\nThe import seems to complete successfully despite that, I think.\n\nWhen bisecting it seems that this is a regression stemming from #93064.\n\n### Steps to reproduce\n\n- Create a new project.\n- Run `/path/to/godot --headless --import` in the project folder.\n- Note the errors.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "CC @Hilderin", "created_at": "2025-02-28 16:16:46", "merge_commit_sha": "02bedd8ac272351def33b3a16604bcbe46386b7f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103266", "base_commit": "39c201ca58a8ddf1e99e62c8453294a2662a2fd8", "patch": "diff --git a/editor/editor_dock_manager.cpp b/editor/editor_dock_manager.cpp\nindex 51c15f3db911..32269f91a109 100644\n--- a/editor/editor_dock_manager.cpp\n+++ b/editor/editor_dock_manager.cpp\n@@ -547,10 +547,10 @@ void EditorDockManager::load_docks_from_config(Ref<ConfigFile> p_layout, const S\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\tControl *dock = dock_map[name];\n-\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \n \t\t\tif (!all_docks[dock].enabled) {\n \t\t\t\t// Don't open disabled docks.\n+\t\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\tbool at_bottom = false;\n@@ -563,6 +563,7 @@ void EditorDockManager::load_docks_from_config(Ref<ConfigFile> p_layout, const S\n \t\t\t} else if (i >= 0) {\n \t\t\t\t_move_dock(dock, dock_slot[i], 0);\n \t\t\t}\n+\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \n \t\t\tif (closed_docks.has(name)) {\n \t\t\t\t_move_dock(dock, closed_dock_parent);\n", "test_patch": "", "problem_statement": "Bottom FileSystem dock does not save layout options\n### Tested versions\n\n- Reproducible in: 4.4.beta1.mono to 4.4.rc1.mono\n- Not reproducible in: 4.4.dev7.mono and earlier\n\n### System information\n\nGodot v4.4.rc1.mono - macOS Sequoia (15.3.1) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 Max (Apple8) - Apple M2 Max (12 threads)\n\n### Issue description\n\nThe bottom panel FileSystem dock does not save layout options (Split Mode, View items as list/thumbnails). Reopening the editor causes these layout options to be reset.\nThis issue exists only when the FileSystem dock is placed at the bottom panel, and does not exist when it is placed in any of the 8 slots on the side.\n\n### Steps to reproduce\n\nhttps://github.com/user-attachments/assets/b135bbb2-69f4-45ee-9ada-6a11bcfeb299\n\n1. Open any project.\n2. Move the FileSystem dock to the bottom panel.\n3. In the FileSystem dock, change Split Mode to top/bottom, and set View items as a list.\n4. Close Godot and reopen the project.\n5. Notice the FileSystem dock layout gets reset.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Reverting #100558 seems to fix the issue, CC @KoBeWi ", "created_at": "2025-02-24 23:13:11", "merge_commit_sha": "cc7a951140fbdf9b1173dd3f301f9b256f749284", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103259", "base_commit": "39c201ca58a8ddf1e99e62c8453294a2662a2fd8", "patch": "diff --git a/modules/bcdec/image_decompress_bcdec.cpp b/modules/bcdec/image_decompress_bcdec.cpp\nindex 6d97ca38abef..ad0c1729d64c 100644\n--- a/modules/bcdec/image_decompress_bcdec.cpp\n+++ b/modules/bcdec/image_decompress_bcdec.cpp\n@@ -158,9 +158,12 @@ void image_decompress_bcdec(Image *p_image) {\n \n \t// Compressed images' dimensions should be padded to the upper multiple of 4.\n \t// If they aren't, they need to be realigned (the actual data is correctly padded though).\n-\tif (width % 4 != 0 || height % 4 != 0) {\n-\t\tint new_width = width + (4 - (width % 4));\n-\t\tint new_height = height + (4 - (height % 4));\n+\tconst bool need_width_realign = width % 4 != 0;\n+\tconst bool need_height_realign = height % 4 != 0;\n+\n+\tif (need_width_realign || need_height_realign) {\n+\t\tint new_width = need_width_realign ? width + (4 - (width % 4)) : width;\n+\t\tint new_height = need_height_realign ? height + (4 - (height % 4)) : height;\n \n \t\tprint_verbose(vformat(\"Compressed image's dimensions are not multiples of 4 (%dx%d), aligning to (%dx%d)\", width, height, new_width, new_height));\n \n", "test_patch": "", "problem_statement": "Editor crash on startup caused by loading VRAM compressed texture with specific range of dimensions\n### Tested versions\n\n- Reproduced in 4.4 dev6, all betas, and rc1\n- Not reproduced in 4.4 dev1 through dev5\n\n### System information\n\nGodot v4.4.dev6 - Windows 10.0.19045 - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated Radeon RX 580 Series (Advanced Micro Devices, Inc.; 31.0.21921.1000) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nThe editor crashes after initialization. When running my big project with -v, the last lines displayed are these:\n```\nLoading resource: res://.godot/imported/some_texture.png-1c25004a89b329a9613253a73f2f1983.s3tc.ctex\n\tCompressed image's dimensions are not multiples of 4 (1024x1023), aligning to (1028x1024)\n```\nThe presence of `some_texture.png` actually causes the crash. I copied that texture to an empty project and found out that its dimensions, as well as it having alpha, cause a crash. Note that in the MRP, the above log message doesn't appear, although the same crash happens.\n\nI compiled with debug symbols and debugged in VS code, and the exception message is this:\n`Exception 0xc0000005 encountered at address 0x7ff6f73f5535: Access violation reading location 0x1589ca2d008`\nIt happens in `thirdparty/misc/bcdec.h`\n```\nstatic void bcdec__color_block(const void* compressedBlock, void* decompressedBlock, int destinationPitch, int onlyOpaqueMode) {\n    unsigned short c0, c1;\n    unsigned int refColors[4]; /* 0xAABBGGRR */\n    unsigned char* dstColors;\n    unsigned int colorIndices;\n    int i, j, idx;\n    unsigned int r0, g0, b0, r1, g1, b1, r, g, b;\n\n    c0 = ((unsigned short*)compressedBlock)[0]; <--------- exception here on line 119\n    c1 = ((unsigned short*)compressedBlock)[1];\n```\nAnd here's the call stack in case it helps:\n```\nstatic void bcdec__color_block(const void *, void *, int, int) (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:119)\nbcdec_bc3 (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:287)\nstatic void decompress_image(BCdecFormat, const void *, void *, const unsigned __int64, const unsigned __int64) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:129)\nvoid __cdecl image_decompress_bcdec(class Image *) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:239)\npublic: enum Error __cdecl Image::decompress(void) (c:\\tools\\Godot\\src\\godot\\core\\io\\image.cpp:2670)\npublic: virtual class Ref<class Texture2D> __cdecl EditorTexturePreviewPlugin::generate(class Ref<class Resource> const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\plugins\\editor_preview_plugins.cpp:164)\npublic: virtual class Ref<class Texture2D> __cdecl EditorResourcePreviewGenerator::generate_from_path(class String const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:73)\nprivate: void __cdecl EditorResourcePreview::_generate_preview(class Ref<class ImageTexture> &,class Ref<class ImageTexture> &,struct EditorResourcePreview::QueueItem const &,class String const &,class Dictionary &) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:205)\nprivate: void __cdecl EditorResourcePreview::_iterate(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:379)\nprivate: void __cdecl EditorResourcePreview::_thread(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:407)\nprivate: static void __cdecl EditorResourcePreview::_thread_func(void *) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:139)\nprivate: static void __cdecl Thread::callback(unsigned __int64,struct Thread::Settings const &,void (__cdecl*)(void *),void *) (c:\\tools\\Godot\\src\\godot\\core\\os\\thread.cpp:64)\nvoid std::invoke<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>( * *, unsigned __int64 *, struct Thread::Settings *,  * *, void * *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\type_traits:1741)\nunsigned int std::thread::_Invoke<std::tuple<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>,0,1,2,3,4>(void *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\thread:60)\nstatic unsigned long thread_start<unsigned int (__cdecl*)(void *),1>(void *) (@NoHotPatch:29828)\nBaseThreadInitThunk (@BaseThreadInitThunk:9)\nRtlUserThreadStart (@RtlUserThreadStart:12)\n```\n\n### Steps to reproduce\n\n1. Add a PNG texture to a project with dimensions of 1024x1023, and some alpha on at least one pixel. The MRP's `crash_texture.png` meets these criteria.\n2. Select the PNG in filesystem dock to reveal its import settings, and change the compress mode to \"VRAM compressed\"\n3. Reimport the texture and the editor crashes. It will also crash on each subsequent startup.\n\nOther resolutions that cause crash: 1024x1022, 1024x1021\nNo crash: 1024x1020, 1025x1023, 512x511\n\n### Minimal reproduction project (MRP)\n\n[texture_crash_mrp.zip](https://github.com/user-attachments/files/18947915/texture_crash_mrp.zip)\n", "hints_text": "I can reproduce this crash, bisecting.", "created_at": "2025-02-24 20:44:18", "merge_commit_sha": "9f4ac3c0b093b53dac9717fe672d59b2566d7ebc", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103176", "base_commit": "394508d26dcf1b7a9362453f9009c07d969f1a7e", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 6f57b880441f..bbdcb9e79aa1 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -732,7 +732,7 @@ def configure_mingw(env: \"SConsEnvironment\"):\n         if env[\"use_static_cpp\"]:\n             env.Append(LINKFLAGS=[\"-static\"])\n \n-    if env[\"arch\"] in [\"x86_32\", \"x86_64\"]:\n+    if env[\"arch\"] == \"x86_32\":\n         env[\"x86_libtheora_opt_gcc\"] = True\n \n     env.Append(CCFLAGS=[\"-ffp-contract=off\"])\n", "test_patch": "", "problem_statement": "VideoStreamPlayer causes game to crash upon playing video\n### Tested versions\n\n- Reproducible in v4.4.beta4.official [93d270693]\n- Not reproducible in v4.4.beta3.official [06acfccf8]\n\nThe only VideoStreamPlayer-related commit I saw in beta4 was #101958, so I think it is a likely cause of this issue.\n\n### System information\n\nWindows 11 - both Forward+ and Compatibility - both with and without dedicated GPU\n\n### Issue description\n\nGame closes without displaying any in-editor error messages upon playing a VideoStreamPlayer in 4.4 beta4.\n\n### Steps to reproduce\n\nPlay an Ogg Theora stream through a VideoStreamPlayer, either with `autoplay=true` or `play()`. Seems to affect both Forward+ and Compatibility renderers (haven't tested Mobile).\n\n### Minimal reproduction project (MRP)\n\n[videoplayerbug.zip](https://github.com/user-attachments/files/18838902/videoplayerbug.zip)\nThe main scene can be played to reproduce the issue. In beta3, this works as expected and a blue box moves across the screen. In beta4, the game exits immediately.\nMinGW GCC LTO internal compiler error when linking: cannot read 'LTO_section_decls'\n### Tested versions\n\n- Reproducible in d497631de0c67f22564e1efeb467cf9f061adc80 (commit before merge of workaround #102506) \n- Reproducible in 4.3.beta3 and latest `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) **with #102506 reverted**\n- Not reproducible in 4.3.stable or 4.4.beta2\n\n### System information\n\nFedora 41, mingw64-gcc-14.2.1-3.fc41, mingw64-headers-12.0.0-3.fc41, mingw64-binutils-2.42-2.fc41\n\n### Issue description\n\nThis is the bug report I promised in #102506, describing the actual bug that #102506 just hacks around, but that PR should be reverted and the bug fixed properly. This is very likely to be a GCC or binutils bug, and not a Godot bug.\n\nReproducible this bug requires (for now) to revert #102506 locally, as it seems like reintroducing this unnecessary code prevents the LTO internal compiler error. It's all fairly brittle though and I'm not confident it won't come back as we add/change other code, hence why this is a release blocker.\n\nWhen compiling current `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) with #102506 reverted and the following command, using MinGW-GCC:\n```\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n(mono module and LTO are important)\n\nThe linking steps fails with:\n```\nlto1: internal compiler error: cannot read 'LTO_section_decls' from /tmp/ccf5RNMk.ltrans115.o\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nSee <http://bugzilla.redhat.com/bugzilla> for instructions.\nmake: *** [/tmp/cct9c3iK.mk:347: /tmp/ccf5RNMk.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nOr this:\n```\nlto1: error: two or more sections for .gnu.lto__ZZL39_register_variant_builtin_methods_arrayvEN17Method_Array_back17get_argument_typeEi.lto_priv.0.37928630.b9f437417adc9a80\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/cc3CZrbQ.mk:347: /tmp/ccmO0Wsr.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nI debugged a bit with @bruvzg, who could also reproduce this with mingw-gcc on macOS with GCC 14.2.0. He tried with `-freport-bug` as advised by the error but that seems to prevent the bug.\n\n@Repiteo noted that the second error is similar to the one in #92585 (note: `x86_32` there, while here it's on `x86_64`), which we just worked around at the time by updating the base Fedora version to get newer mingw/gcc/binutils.\n\nBut here we're using the latest version provided on Fedora 41. mingw-headers and mingw-gcc on Fedora 42 aren't newer, but mingw-binutils is at 2.43.1, might be worth testing against.\n\nSince the error popped up between 4.4.beta2 and 4.4.beta3, I bisected it and landed on #102179. There's evidently nothing egregious in that patch that should trigger a LTO crash. Through trial and error, I manage to find a workaround in #102506 by doing a minimal partial revert of #102179. Reintroducing some of that code, even in a path that will never be executed (but could be, as it's checked by an undocumented project setting), seems to prevent the crash.\n\nWe also noticed that the presence of LTO objects from a previous build can also be a cause for the issue. But with a `git clean -fxd` this issue is still reproducible when reverting #102179.\n\nObviously, the problem is deeper so we need to dig. That's where I page @hpvb as the resident expert in debugging GCC bugs :D\n\n### Steps to reproduce\n\nSet up latest mingw with GCC 14.2.\n```\ngit revert e12a424bc569ac5ae9ff2944a8df7fc11b157d71\ngit clean -fxd\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "hints_text": "CC @berarma \nI can't reproduce it on Linux. The MRP works well here.\n\nI'll try it on a machine with Windows 11. In the mean time if someone could get a crash backtrace it may speed things up.\n\nDoes it crash before displaying anything or when the video is already playing?\nCan't reproduce on macOS (using provided videoplayerbug project).\n\nGodot v4.4.beta4 - macOS Sequoia (15.3.1) - Multi-window, 2 monitors - Metal (Forward+) - integrated Apple M1 Pro (Apple7) - Apple M1 Pro (10 threads)\nCan replicate this on Windows 11, will provide a stacktrace soon\nI can't confirm it on a custom build on the same branch, so unsure what is different between the two versions here, so can't provide a stacktrace as it won't occur in a debug build\nWhat compiler and compiler version are you using? What compiler does the official beta use?\n> I can't confirm it on a custom build on the same branch, so unsure what is different between the two versions here, so can't provide a stacktrace as it won't occur in a debug build\n\nThanks for testing it.\n\n> What compiler and compiler version are you using? What compiler does the official beta use?\n\nLooking at the build scripts it seems to be built using ~~mingw-llvm~~ (read comment below from akien-mga).\nTesting a production build currently, using MSVC in both cases, so might be MinGW specific, if it doesn't happen on a production MSVC build someone would need to build using MinGW to test (I don't have an editor build for that set up so it'd be easier if someone using it already can test to avoid the build time)\n> > What compiler and compiler version are you using? What compiler does the official beta use?\n> \n> Looking at the build scripts it seems to be built using mingw-llvm.\n\nIt's actually mingw-gcc 14.2.1 from Fedora 41 for x86_64 and x86_32, and [llvm-mingw](https://github.com/mstorsjo/llvm-mingw/) for arm64 only.\n\nAlso relevant, official builds are made with GCC LTO (`production=yes`), which may be a factor here.\nDoesn't happen in a `production=yes` MSVC build so likely gcc specific\nGCC and Windows specific.\n\nI've been able to reproduce the issue on a Windows 10 VM using the official build, tested that beta3 works on the same VM. Now I'm trying to build a custom version for Windows with D3D12 support but it doesn't run on the same VM because it requries OpenGL3.3 or D3D11. It looks like I haven't built with D3D12 support although I've followed the instructions.\nYou probably need to build with ANGLE to be able to run on that VM. https://docs.godotengine.org/en/stable/contributing/development/compiling/compiling_for_windows.html#compiling-with-angle-support\nI've made a custom build with the command `scons platform=windows debug_symbols=yes optimize=debug d3d12=yes angle_libs=/opt/angle/ linker=mold`, and it works.\n\nNow I'm building with `production=yes`.\nThis is the backtrace and this is the build command: `scons platform=windows d3d12=yes angle_libs=/opt/angle/ linker=mold use_static_cpp=yes lto=auto debug_symbols=yes`\n```\nCrashHandlerException: Program crashed with signal 11\nEngine version: Godot Engine v4.4.beta.custom_build (93d270693079ea7802c9e1334a2e0ecd8529eeed)                          Dumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] _gnu_exception_handler (./mingw-w64-crt/crt/crt_handler.c:223)\n[2] __tmainCRTStartup (./mingw-w64-crt/crt/crtexe.c:321)\n[3] WinMainCRTStartup (./mingw-w64-crt/crt/crtexe.c:176)\n-- END OF BACKTRACE --\n```\n\nIs this an [exception handler crash](https://github.com/godotengine/godot/pull/102900)?\nNot sure why the crash handler backtrace is like this, it's probably a separate issue we need to keep looking into @bruvzg.\n\nI ran the reproduction project through gdb and got a more helpful backtrace:\n```\nThread 1 received signal SIGSEGV, Segmentation fault.\n0x00000001404242e6 in oc_huff_token_decode_c ()\n(gdb) bt\n#0  0x00000001404242e6 in oc_huff_token_decode_c ()\n#1  0x000000014049b09e in VideoStreamPlaybackTheora::update(double) [clone .part.0] ()\n#2  0x0000000142cfd9f2 in VideoStreamPlayer::play() ()\n#3  0x00000001449648c1 in Object::notification(int, bool) ()\n#4  0x0000000142802d1f in Node::_propagate_enter_tree() ()\n#5  0x0000000142803015 in Node::_propagate_enter_tree() ()\n#6  0x000000014282a0c1 in Node::_set_tree(SceneTree*) ()\n#7  0x000000014006f748 in widechar_main(int, wchar_t**) ()\n#8  0x0000000145353ba3 in main ()\n```\n\nHere's how I did it for the record, which might be helpful for @berarma to debug further from Linux:\n\n- Compiled Godot in a `fedora:41` podman container with mingw-gcc and just `scons p=windows lto=full debug_symbols=yes`\n- Installed `wine`, and `mingw64-gdb`, which provides a Windows version of gdb in `/usr/x86_64-w64-mingw32/sys-root/mingw/bin/gdb.exe`\n- `cd` to the MRP folder\n- `wine /usr/x86_64-w64-mingw32/sys-root/mingw/bin/gdb.exe path/to/godot.windows.editor.x86_64.exe`\n- In the gdb prompt, `r --headless video_player.tscn`\n\nI discussed this with @hpvb who had a hunch that it might be related to another GCC LTO bug we're currently debugging in #102867. The flags suggested in https://github.com/godotengine/godot/issues/102867#issuecomment-2663930093 seem to solve this crash indeed in my test.\n@akien-mga, I got the same backtrace as you. The process was a bit different since I'm on Debian, but I just had to translate your steps.\n\nThere seems to be a gap in the backtrace, I'm not directly calling `oc_huff_token_decode_c` in the code but they're next to each other in the backtrace. Also, I can't see line numbers or the source code, gdb complains that there is no symbol table. Without this information it's hard to know what's happening.\n\nIn my tests, setting LTO and default optimization triggered the crash, but it wasn't always the case. Since I couldn't get a good backtrace I put several `printf` in the code to try to narrow down the code causing the crash and then it stopped crashing. The only change was the `printf` lines.\n\nIf I could get the debug symbols to work I could investigate more, without this, I'm out of ideas to try. I'll test a build with the flags suggested in #102867 to confirm your results and follow your work there.\nConfirmed it doesn't crash with the flags in https://github.com/godotengine/godot/issues/102867#issuecomment-2663930093. Tested also adding `d3d12=yes angle=...` both on Wine and Windows and it also works.\n\nI've resorted to reading the assembly to find out the line, and this is the line that causes the segmentation fault:\n\nhttps://github.com/godotengine/godot/blob/e567f49cbb292dd6bb628348e67c1f3c2a3a5f99/thirdparty/libtheora/huffdec.c#L482\n\nThe second argument (_tree) to the function `oc_huff_token_decode_c` is a bad pointer. This function is called with static int16 arrays defined inside static functions for the second argument, like this:\n\nhttps://github.com/godotengine/godot/blob/e567f49cbb292dd6bb628348e67c1f3c2a3a5f99/thirdparty/libtheora/decode.c#L319\n\nAnd this is where the array is defined:\n\nhttps://github.com/godotengine/godot/blob/e567f49cbb292dd6bb628348e67c1f3c2a3a5f99/thirdparty/libtheora/decode.c#L309\n\nThere are several calls to this function in this file, but since I don't have a complete backtrace I can't tell which one is causing the crash. Most of them use these static arrays, while some others use arrays read from the video headers.\n\nI've tried building with `ccflags=\"-fno-inline\"` to try and get a complete backtrace, but it fails with these errors:\n\n```\nlto1: error: two or more sections for .gnu.lto__ZZL40_register_variant_builtin_methods_stringvEN28Method_StringName_hex_to_int18get_argument_countEv.34588887.ba4a6b712d465bb9\nlto1: error: two or more sections for .gnu.lto__ZZN6embree12parallel_forIyZNS_17ParallelRadixSortINS_4sse212PresplitItemEjE17tbbRadixIterationEjbPKS3_PS3_yEUlyE0_EEvT_RKT0_ENKUlRKNS_5rangeIyEEE_clESG_.9227336.fefa44b2c0907de9\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/ccphOoha.mk:305: /tmp/cc6f9UAr.ltrans101.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/ccphOoha.mk:383: /tmp/cc6f9UAr.ltrans127.ltrans.o] Error 1\n./core/templates/sort_array.h: In function 'unguarded_insertion_sort.constprop.isra':\n./core/templates/sort_array.h:288:59: warning: iteration 1537228672809129301 invokes undefined behavior [-Waggressive-loop-optimizations]\n  288 |                         unguarded_linear_insert(i, p_array[i], p_array);\n      |                                                           ^\n./core/templates/sort_array.h:287:45: note: within this loop\n  287 |                 for (int64_t i = p_first; i != p_last; i++) {\n      |                                             ^\nthirdparty/misc/polypartition.cpp: In function 'Triangulate_OPT.isra':\nthirdparty/misc/polypartition.cpp:711:29: warning: argument 1 value '18446744073709551615' exceeds maximum object size 9223372036854775807 [-Walloc-size-larger-than=]\n  711 |   dpstates = new DPState *[n];\n      |                             ^\n/usr/lib/gcc/x86_64-w64-mingw32/12-posix/include/c++/new:128:26: note: in a call to allocation function 'operator new []' declared here\n  128 | _GLIBCXX_NODISCARD void* operator new[](std::size_t) _GLIBCXX_THROW (std::bad_alloc)\n      |                          ^\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/bin/x86_64-w64-mingw32-ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\nscons: *** [bin/godot.windows.editor.x86_64.exe] Error 1\nscons: building terminated because of errors.\n```\nAmended first paragraph in my last comment which didn't make any sense. Had a mental lapse between long builds.\nCould someone who reproduces the issue test these builds from #103077 to confirm that it's fixing the bug?\n\nhttps://github.com/godotengine/godot/pull/103077#issuecomment-2672226330\n> Could someone who reproduces the issue test these builds from [#103077](https://github.com/godotengine/godot/pull/103077) to confirm that it's fixing the bug?\n> \n> [#103077 (comment)](https://github.com/godotengine/godot/pull/103077#issuecomment-2672226330)\n\nI tested the 64-bit version, and it fixes the crash for me.\n\nHowever, the new build has some odd lag spikes in the video that weren't present in beta3. I'm unsure if this is related to the new build flags. I'll try to make a custom build of beta3 with these flags to confirm if they are the cause.\n> > Could someone who reproduces the issue test these builds from [#103077](https://github.com/godotengine/godot/pull/103077) to confirm that it's fixing the bug?\n> > [#103077 (comment)](https://github.com/godotengine/godot/pull/103077#issuecomment-2672226330)\n> \n> I tested the 64-bit version, and it fixes the crash for me.\n> \n> However, the new build has some odd lag spikes in the video that weren't present in beta3. I'm unsure if this is related to the new build flags. I'll try to make a custom build of beta3 with these flags to confirm if they are the cause.\n\nDoes this happen with the MRP? Do they play correctly in `ffplay`?\n\nVideos encoded with FFmpeg could be incorrectly encoded, although they should play the same in `ffplay` and Godot 4.4beta4.\n\nFFmpeg has already been fixed, but you will need a [very recent build](https://github.com/godotengine/godot-docs/pull/10614#issuecomment-2671246526).\n> Does this happen with the MRP? Do they play correctly in `ffplay`?\n> \n> Videos encoded with FFmpeg could be incorrectly encoded, although they should play the same in `ffplay` and Godot 4.4beta4.\n> \n> FFmpeg has already been fixed, but you will need a [very recent build](https://github.com/godotengine/godot-docs/pull/10614#issuecomment-2671246526).\n\nYes, specifically for the MRP above, on my Windows 11 machine (with RTX3070): beta3 produces smooth video output; rc.1 produces lag spikes. This behavior is repeatable.\n\nThe video in the MRP was encoded with `ffmpeg version 7.0.1-full_build-www.gyan.dev`. I'm not sure what you mean regarding ffmpeg being fixed -- was there a bug in their library for Ogg Theora encoding?\n> The video in the MRP was encoded with `ffmpeg version 7.0.1-full_build-www.gyan.dev`. I'm not sure what you mean regarding ffmpeg being fixed -- was there a bug in their library for Ogg Theora encoding?\n\nYes, there were a couple of bugs in FFmpeg that have been recently fixed in their static daily builds.\n\nPlease, re-encode the videos from the source with the newest version to make sure it is not due to those bugs.\nRe-encoded with version `2025-02-20-git-bc1a3bfd2c` of ffmpeg. New MRP: [videoplayerbug.zip](https://github.com/user-attachments/files/18894572/videoplayerbug.zip)\n\nSame issue. beta3 has smooth video playback while rc.1 has lag spikes. I set up beta3 with #103077 to see if the flags are the issue, but it's still compiling.\n\nUpdate: Not reproducible in both beta3 and beta3 with #103077 .\nI can't reproduce on Linux. There are some frame skips on both beta3 and beta4, but that's to be expected on my computer when playing a 1920x1080/144fps video on a decoder without GPU acceleration.\n\nCan you paste the FPS log for both versions?\nBoth versions show 144fps consistently for me. I tried setting max fps to 30 and it actually makes the issue worse (the entire video appears to slow down).\n\nHere's a recording of the playback on RC.1 for me: \n\nhttps://github.com/user-attachments/assets/0177706a-6d54-49ba-9f0b-0896176038d5\nCan you create a new issue with the new MRP and this information? I'm going to investigate it. Thanks!\nThe issue of videos playing with lag spikes has been submitted as #103106.\n> But here we're using the latest version provided on Fedora 41. mingw-headers and mingw-gcc on Fedora 42 aren't newer, but mingw-binutils is at 2.43.1, might be worth testing against.\n\nSo I actually tested reproducing the issue in a `fedora:42` podman container, and it seems fixed there. So it might have been a bug in binutils 2.42 that was fixed in 2.43.1 already.\n\nIf that's the case, we could just update to Fedora 42 already for official builds, or backport binutils 2.43.1.\nIt wouldn't solve the problem for end users whose latest MinGW distribution wouldn't have binutils 2.43.1 yet.\n> So it might have been a bug in binutils 2.42 that was fixed in 2.43.1 already.\n\nmacOS MinGW build I was able to reproduce it with seems to be using binutils 2.43.1.\n\nSources for the MinGW package are:\n```\nurl \"https://downloads.sourceforge.net/project/mingw-w64/mingw-w64/mingw-w64-release/mingw-w64-v12.0.0.tar.bz2\"\nsha256 \"cc41898aac4b6e8dd5cffd7331b9d9515b912df4420a3a612b5ea2955bbeed2f\"\n\nurl \"https://ftp.gnu.org/gnu/binutils/binutils-2.43.1.tar.bz2\"\nsha256 \"becaac5d295e037587b63a42fad57fe3d9d7b83f478eb24b67f9eec5d0f1872f\"\n\nurl \"https://ftp.gnu.org/gnu/gcc/gcc-14.2.0/gcc-14.2.0.tar.xz\"\nsha256 \"a7b39bc69cbf9e25826c5a60ab26477001f7c08d85cec04bc0e29cabed6f3cc9\"\n```\n> macOS MinGW build I was able to reproduce it with seems to be using binutils 2.43.1.\n\nYeah I tested too in a `fedora:41` podman container, installing the mingw-binutils packages from Fedora 42 (`mingw-binutils-generic-2.43.1-3.fc42.x86_64.rpm` and `mingw64-binutils-2.43.1-3.fc42.x86_64.rpm`) and I still reproduce the bug.\n\nSo there might be another component in Fedora 42 that's different, or it's just a coincidence.\nI've been able to reproduce this, I'm doing some work with gdb on the wrapper to see if I can work out what's going on.\nI have not been able to figure out what the problem is exactly, but I have been able to build Godot successfully with LTO with the following ccflags and linkflags: `-fno-use-linker-plugin -fwhole-program` this should result in at least similar optimization as with the normal lto. \n\nAt least for now I recommend using this while I try and figure out with the gcc folk what is up.\nRetested it with current `master` + reverted e12a424bc569ac5ae9ff2944a8df7fc11b157d71 and seems like it's no longer failing on macOS (toolchain is the same), so it's pretty random (probably timing sensitive race condition).\n@bruvzg it is not likely timing sensitive. The problem reproduces with or without using multiple threads.\n\nThe problem is almost certainly in the \"Whole Program Analysis\" (WPA) phase of LTO. This is the phase that will partition the LTO work into smaller objects to be processed in series or in parallel. This phase seems to partition the work wrong, which then results in the 115th partition to not be linkable.\n\nThe issue is that almost *any* change to the build will cause the problem to go away. For instance just turning LTO off for literally *any* of the .a or .o files, just one, causes the link to succeed.\n\nBecause of this the problem is turning out to be very hard to debug. But I'm afraid that it is not a race condition. ", "created_at": "2025-02-22 16:15:10", "merge_commit_sha": "58e4e34564b5f4cb37325212a50250eef2d35e31", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103105", "base_commit": "8ed125b42908d0d46d3b8967e3a3bc03f809b3af", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 0da2dceb5f4d..b4897bcd48f9 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -95,9 +95,11 @@ void EmbeddedProcess::set_keep_aspect(bool p_keep_aspect) {\n \t}\n }\n \n-Rect2i EmbeddedProcess::_get_global_embedded_window_rect() {\n-\tRect2i control_rect = get_global_rect();\n-\tcontrol_rect = Rect2i(control_rect.position + margin_top_left, (control_rect.size - get_margins_size()).maxi(1));\n+Rect2i EmbeddedProcess::get_adjusted_embedded_window_rect(Rect2i p_rect) {\n+\tRect2i control_rect = Rect2i(p_rect.position + margin_top_left, (p_rect.size - get_margins_size()).maxi(1));\n+\tif (window) {\n+\t\tcontrol_rect.position += window->get_position();\n+\t}\n \tif (window_size != Size2i()) {\n \t\tRect2i desired_rect = Rect2i();\n \t\tif (!keep_aspect && control_rect.size.x >= window_size.x && control_rect.size.y >= window_size.y) {\n@@ -116,12 +118,7 @@ Rect2i EmbeddedProcess::_get_global_embedded_window_rect() {\n }\n \n Rect2i EmbeddedProcess::get_screen_embedded_window_rect() {\n-\tRect2i rect = _get_global_embedded_window_rect();\n-\tif (window) {\n-\t\trect.position += window->get_position();\n-\t}\n-\n-\treturn rect;\n+\treturn get_adjusted_embedded_window_rect(get_global_rect());\n }\n \n int EmbeddedProcess::get_margin_size(Side p_side) const {\ndiff --git a/editor/plugins/embedded_process.h b/editor/plugins/embedded_process.h\nindex 55988be3f0b4..298424b0c553 100644\n--- a/editor/plugins/embedded_process.h\n+++ b/editor/plugins/embedded_process.h\n@@ -83,6 +83,7 @@ class EmbeddedProcess : public Control {\n \tvoid set_keep_aspect(bool p_keep_aspect);\n \tvoid queue_update_embedded_process();\n \n+\tRect2i get_adjusted_embedded_window_rect(Rect2i p_rect);\n \tRect2i get_screen_embedded_window_rect();\n \tint get_margin_size(Side p_side) const;\n \tSize2 get_margins_size();\ndiff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 6318bf6d1645..30c558e0bd5d 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -812,10 +812,28 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \t_update_embed_window_size();\n \tRect2i rect = embedded_process->get_screen_embedded_window_rect();\n \n+\t// On the first startup, the global rect of the embedded process control is invalid because it was\n+\t// never displayed. We will calculated it manually.\n+\tif (!window_wrapper->get_window_enabled() && rect.size.y < embedded_process->get_custom_minimum_size().y) {\n+\t\tSize2 old_min_size = embedded_process->get_custom_minimum_size();\n+\t\tembedded_process->set_custom_minimum_size(Size2i());\n+\n+\t\tControl *container = EditorNode::get_singleton()->get_editor_main_screen()->get_control();\n+\t\trect = container->get_global_rect();\n+\n+\t\tSize2 wrapped_min_size = window_wrapper->get_minimum_size();\n+\t\trect.position.y += wrapped_min_size.y;\n+\t\trect.size.y -= wrapped_min_size.y;\n+\n+\t\trect = embedded_process->get_adjusted_embedded_window_rect(rect);\n+\n+\t\tembedded_process->set_custom_minimum_size(old_min_size);\n+\t}\n+\n \t// When using the floating window, we need to force the position and size from the\n \t// editor/project settings, because the get_screen_embedded_window_rect of the\n \t// embedded_process will be updated only on the next frame.\n-\tif (p_idx == 0 && window_wrapper->get_window_enabled()) {\n+\tif (window_wrapper->get_window_enabled()) {\n \t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n \t\tif (placement.position != Point2i(INT_MAX, INT_MAX)) {\n \t\t\trect.position = placement.position;\n", "test_patch": "", "problem_statement": "Embedded Game window wrong first startup location and size\n### Tested versions\n\nReproductible since Godot 4.4 beta 4\nNot reprodictible in Godot 4.4 beta 3\n\n### System information\n\nGodot v4.4.rc (8ed125b42) - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 32.0.15.7216) - 11th Gen Intel(R) Core(TM) i5-11600KF @ 3.90GHz (12 threads)\n\n### Issue description\n\nWhen the game is started and the game is embedded inside the editor without the floating window and if the Game View tab was not accessed, the location and the size of the embedded game is wrong at the first startup of the game.\n\nhttps://github.com/user-attachments/assets/f3623b5f-65c0-42ab-8422-b19c5e4dc2cc\n\n### Steps to reproduce\n\n- Open the editor, set embedding at true and floating window at false\n- Go to another tab then Game View\n- Close the editor\n- Reopen a project in the editor\n- Start the game without going to the Game View\n- You will see the game for a split second really small and not correctly positionned on startup\n\n### Minimal reproduction project (MRP)\n\nAny project\n", "hints_text": "", "created_at": "2025-02-21 01:31:26", "merge_commit_sha": "ba47acab0a74de766b5a63cfb49547e4d75d4de5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102986", "base_commit": "49cc57a75dfd262bd49698910595becf3aae597b", "patch": "diff --git a/doc/classes/SceneTree.xml b/doc/classes/SceneTree.xml\nindex 77baef9d0898..9a31492d2018 100644\n--- a/doc/classes/SceneTree.xml\n+++ b/doc/classes/SceneTree.xml\n@@ -58,6 +58,7 @@\n \t\t\t\t1. The current scene node is immediately removed from the tree. From that point, [method Node.get_tree] called on the current (outgoing) scene will return [code]null[/code]. [member current_scene] will be [code]null[/code], too, because the new scene is not available yet.\n \t\t\t\t2. At the end of the frame, the formerly current scene, already removed from the tree, will be deleted (freed from memory) and then the new scene will be instantiated and added to the tree. [method Node.get_tree] and [member current_scene] will be back to working as usual.\n \t\t\t\tThis ensures that both scenes aren't running at the same time, while still freeing the previous scene in a safe way similar to [method Node.queue_free].\n+\t\t\t\tIf you want to reliably access the new scene, await the [signal scene_changed] signal.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"create_timer\">\n@@ -312,6 +313,17 @@\n \t\t\t\tEmitted immediately before [method Node._process] is called on every node in this tree.\n \t\t\t</description>\n \t\t</signal>\n+\t\t<signal name=\"scene_changed\">\n+\t\t\t<description>\n+\t\t\t\tEmitted after the new scene is added to scene tree and initialized. Can be used to reliably access [member current_scene] when changing scenes.\n+\t\t\t\t[codeblock]\n+\t\t\t\t# This code should be inside an autoload.\n+\t\t\t\tget_tree().change_scene_to_file(other_scene_path)\n+\t\t\t\tawait get_tree().scene_changed\n+\t\t\t\tprint(get_tree().current_scene) # Prints the new scene.\n+\t\t\t\t[/codeblock]\n+\t\t\t</description>\n+\t\t</signal>\n \t\t<signal name=\"tree_changed\">\n \t\t\t<description>\n \t\t\t\tEmitted any time the tree's hierarchy changes (nodes being moved, renamed, etc.).\ndiff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 4043eb55ac96..557fced85ed1 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -1517,6 +1517,8 @@ void SceneTree::_flush_scene_change() {\n \tpending_new_scene = nullptr;\n \t// Update display for cursor instantly.\n \troot->update_mouse_cursor_state();\n+\n+\temit_signal(SNAME(\"scene_changed\"));\n }\n \n Error SceneTree::change_scene_to_file(const String &p_path) {\n@@ -1784,6 +1786,7 @@ void SceneTree::_bind_methods() {\n \tADD_PROPERTY(PropertyInfo(Variant::BOOL, \"physics_interpolation\"), \"set_physics_interpolation_enabled\", \"is_physics_interpolation_enabled\");\n \n \tADD_SIGNAL(MethodInfo(\"tree_changed\"));\n+\tADD_SIGNAL(MethodInfo(\"scene_changed\"));\n \tADD_SIGNAL(MethodInfo(\"tree_process_mode_changed\")); //editor only signal, but due to API hash it can't be removed in run-time\n \tADD_SIGNAL(MethodInfo(\"node_added\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n \tADD_SIGNAL(MethodInfo(\"node_removed\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n", "test_patch": "", "problem_statement": "`change_scene_to_*` needs to await for two `process_frame`s\n### Tested versions\r\n\r\nGodot 4.2+\r\n\r\n### System information\r\n\r\nArch Linux\r\n\r\n### Issue description\r\n\r\n`change_scene_to_*()` methods always change scene in a deferred way.\r\n\r\nThe documentation says scene change happens at the end of the frame. But I have to await `SceneTree.process_frame` twice instead of once since #78988.\r\n\r\nhttps://github.com/godotengine/godot/blob/2d0ee20ff30461b6b10f6fdfba87511a0ebc6642/doc/classes/SceneTree.xml#L55-L56\r\n\r\n```gdscript\r\nvar tree := get_tree()\r\n\r\ntree.change_scene_to_file(path)\r\n\r\nawait tree.process_frame\r\n# expected & old behavior: new scene available here\r\n# actual: still not available\r\n\r\nawait tree.process_frame\r\n# actual: new scene available here\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nSee above, or use the MRP.\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[test-change-scene.zip](https://github.com/godotengine/godot/files/13700325/test-change-scene.zip)\r\n\n", "hints_text": "Okay, I thought it's because I put the code snippet inside `_unhandled_input()` and `process_frame` signals the start of `process()`.\r\n\r\nBut doesn't `_unhandled_input()` happen at the end of last frame by default?\n`_unhandled_input()` happens without delay right after `_input()` and the other `_*_input()` calls.\r\nThe execution of physics picking happens asynchronously in the next frame.\r\n\n@Sauermann Where does it happen inside a frame relative to `_process()`?\r\n\r\n* Before `_process()`: Then that explains it. But what signal should I await for (besides awaiting for `process_frame` twice) in order to access the new scene?\r\n* After `_process()`: Then it's a bug.\nThat I don't know. I haven't yet looked into the order of things happening within a single frame.\n```GDScript\r\nfunc change_scene(path: String) -> void:\r\n\tprint(\"------ changing to %s ------\" % path)\r\n\tvar tree := get_tree()\r\n\t\r\n\tprint(\"[Before] %s\" % tree.current_scene, \" - frame: \", Engine.get_process_frames())\r\n\ttree.change_scene_to_file(path)\r\n\t\r\n\tawait tree.process_frame\r\n\tprint(\"[after tree.process_frame] %s\" % tree.current_scene, \" - frame: \", Engine.get_process_frames())\r\n\t\r\n\tawait tree.process_frame\r\n\tprint(\"[after tree.process_frame] %s\" % tree.current_scene, \" - frame: \", Engine.get_process_frames())\r\n```\r\n\r\nOutput:\r\n```\r\n[Before] OldScene:<Node2D#27095205063> - frame: 65\r\n[after tree.process_frame] <Object#null> - frame: 65\r\n[after tree.process_frame] NewScene:<Node2D#29645341898> - frame: 66\r\n```\r\n\r\nThe first await isn't really waiting, when the call comes from `_unhandled_input` or `_input`.\r\nHowever, if you instead use `_process`:\r\n```\r\nfunc _process(delta: float) -> void:\r\n\tif Input.is_action_just_pressed(\"ui_accept\"):\r\n\t\tAutoload.change_scene(\"res://old_scene.tscn\")\r\n```\r\nThe output will now be:\r\n```\r\n[Before] OldScene:<Node2D#27095205063> - frame: 101\r\n[after tree.process_frame 1] NewScene:<Node2D#31088182474> - frame: 102\r\n[after tree.process_frame 2] NewScene:<Node2D#31088182474> - frame: 103\r\n```\r\nIf nothing else, this works as a work-around for the MRP.\nThis seems like an important caveat with `await tree.process_frame` that we should document.\n> Where does it happen inside a frame relative to `_process()`?\r\n> \r\n> * Before `_process()`: Then that explains it. But what signal should I await for (besides awaiting for `process_frame` twice) in order to access the new scene?\r\n> \r\n> * After `_process()`: Then it's a bug.\r\n\r\nIt's kinda irrelevant whether it happens before/after `_process()`. If `change_scene_to_*` is called anywhere outside [`process()`](https://github.com/godotengine/godot/blob/2d0ee20ff30461b6b10f6fdfba87511a0ebc6642/scene/main/scene_tree.cpp#L486-L558) (within the red interval in the diagram below) then it's guaranteed that after awaiting `process_frame` signal the scene change has not happened yet because flushing scene change is done within `process()` after emitting `process_frame` signal.\r\n\r\nThe same can be told about the black interval in the diagram below.\r\n\r\nFor awaiting single `process_frame` to be enough the `change_scene_to_*` would need to be called somewhere within the pink interval (so e.g. in `_process()`, like in https://github.com/godotengine/godot/issues/86286#issuecomment-1860662955).\r\n\r\n![dCDWa8XAe4](https://github.com/godotengine/godot/assets/9283098/d79a82ca-1c68-45f6-a8e6-2c15bc5d60e7)\r\n\r\n\r\n> [!NOTE]\r\n> I kinda ignored threading when analyzing this so it might be not that simple. :upside_down_face:\r\n\r\n---\r\n\r\nAnyway here's I think a somehow reliable way to detect/await the scene change:\r\n```gdscript\r\nextends Node\r\n\r\nsignal _scene_changed\r\n\r\n@onready var _tree: SceneTree = get_tree()\r\n\r\nfunc change_scene(path: String) -> Error:\r\n\tvar error: Error = _tree.change_scene_to_file(path)\r\n\tif error == OK:\r\n\t\tif not _tree.node_added.is_connected(_on_node_added):\r\n\t\t\t_tree.node_added.connect(_on_node_added)\r\n\t\tawait _scene_changed\r\n\t\t# Scene changed (and ready).\r\n\treturn error\r\n\r\nfunc _on_node_added(node: Node) -> void:\r\n\tif node == _tree.current_scene:\r\n\t\t_tree.node_added.disconnect(_on_node_added)\r\n\t\t# Here `_tree.current_scene` is already changed.\r\n\t\t# But note we are in the middle of executing `tree.root.add_child(current_scene)`.\r\n\t\t# So likely deferring it a little further is wanted, e.g. until its `ready` signal.\r\n\t\tawait _tree.current_scene.ready\r\n\t\t_scene_changed.emit()\r\n```\r\nGiven it's autoloaded as `SceneChanger` it could be used like `var error = await SceneChanger.change_scene(path)`.\r\n\r\nIt works because `current_scene` is assigned before `add_child()`:\r\nhttps://github.com/godotengine/godot/blob/bf8dd73e9d88d6ab146506699f43230b12c6a2b0/scene/main/scene_tree.cpp#L1396-L1406\nThanks for the workaround. I think `await tree.tree_changed` also works if the user can guarentee autoloads don't touch the scene tree during the scene change.\nI wish there was a signal `scene_changed` built into SceneTree. There's no signal that I know which happens at the end of the frame, after the physics and process calls. That's when the scene change happens.\r\n\r\nIs there some proposal for this to happen?\r\n\r\nFor reference, here's a [processing diagram](/godotengine/godot-docs/issues/9305) that I did for Godot 4. Here we can see how the input is handled at the very start of the frame and the scene is changed after the SceneTree.process_frame signal. Exactly as @kleonc explained.\r\n\r\nAnother possible workaround could be a timer in idle processing mode. It would trigger just after the scene change. So `await get_tree().create_timer(0).timeout`.", "created_at": "2025-02-18 09:48:51", "merge_commit_sha": "6ffe44d322ae50d1a061d93a3494e43d1803c0bb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102922", "base_commit": "f42e612da286b14b3a50eff7935615b3bc132c37", "patch": "diff --git a/editor/renames_map_3_to_4.cpp b/editor/renames_map_3_to_4.cpp\nindex ca5d3cbf2ab7..278d57d73a6f 100644\n--- a/editor/renames_map_3_to_4.cpp\n+++ b/editor/renames_map_3_to_4.cpp\n@@ -1523,7 +1523,6 @@ const char *RenamesMap3To4::class_renames[][2] = {\n \t{ \"GradientTexture\", \"GradientTexture2D\" },\n \t{ \"HeightMapShape\", \"HeightMapShape3D\" },\n \t{ \"HingeJoint\", \"HingeJoint3D\" },\n-\t{ \"IP_Unix\", \"IPUnix\" },\n \t{ \"ImmediateGeometry\", \"ImmediateMesh\" },\n \t{ \"ImmediateGeometry3D\", \"ImmediateMesh\" },\n \t{ \"InterpolatedCamera\", \"Camera3D\" },\n", "test_patch": "", "problem_statement": "Godot 3 project to Godot 4 conversion failed but nothing is displayed to the user\n### Tested versions\n\nTested in 4.4.dev7 only.\n\n### System information\n\nGodot v4.4.dev7 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated GeForce GTX 780M - Intel(R) Core(TM) i7-4700HQ CPU @ 2.40GHz (8 threads)\n\n### Issue description\n\nI tried to convert [this project](https://github.com/adcomp/Godot3_2D_Island_OpenSimplexNoise) to Godot 4 and it failed whatever option picked (full project or project file only).\nThe project conversion window shows **nothing at all**.\n\nAlthough, in log, there are these:\n\n> Starting conversion.\nERROR: Class \"IPUnix\" does not exist in Godot 4, so it cannot be used in the conversion.\n   at: test_array_names (editor/project_converter_3_to_4.cpp:1172)\nERROR: Found function which is used in the converter, but it cannot be found in Godot 4. Rename this element or remove its entry if it's obsolete.\n   at: test_array_names (editor/project_converter_3_to_4.cpp:1222)\nERROR: Cannot start converting due to problems with data in arrays.\n   at: convert (editor/project_converter_3_to_4.cpp:334)\n\nThe error message regarding _IPUnix_ class is weird cause it is even not used in the project.\nAnd this project is pretty small (one scene and one script), nothing fancy and just a few old stuff which have been modified like _export_ and _getset_ syntax, _lock/unlock_ functions of Image object no longer needed/available.\n\n### Steps to reproduce\n\nDownload and convert the project given in the issue description.\nNo errors shown to the user.\nProject list remain as it was before and the project doesn't appear in the list.\n\n### Minimal reproduction project (MRP)\n\n[this project](https://github.com/adcomp/Godot3_2D_Island_OpenSimplexNoise)\n", "hints_text": "Loading the project into the editor from the command line, using the -v -e command line parameters will actually see Godot loading the project more or less successfully but it displays a range of other errors. And the project will not run when launched.\nWhen running the converter from project manager it doesn't display any errors, you need to look into console.\nAnd yeah, converter seems to be broken right now, due to IPUnix class being gone.", "created_at": "2025-02-16 17:39:00", "merge_commit_sha": "fd446dcbe33340c526e237bf7e0bed77093187ce", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102833", "base_commit": "750640cede4741a6a526fa5172a199bbb1ac0758", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 638262fb8bec..efc5719d2def 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -446,6 +446,10 @@ GameView::EmbedAvailability GameView::_get_embed_available() {\n \tif (get_tree()->get_root()->is_embedding_subwindows()) {\n \t\treturn EMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE;\n \t}\n+\tString display_driver = GLOBAL_GET(\"display/display_server/driver\");\n+\tif (display_driver == \"headless\" || display_driver == \"wayland\") {\n+\t\treturn EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER;\n+\t}\n \n \tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n \tif (placement.force_fullscreen) {\n@@ -489,7 +493,14 @@ void GameView::_update_ui() {\n \t\t\t}\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_FEATURE_NOT_SUPPORTED:\n-\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\tif (DisplayServer::get_singleton()->get_name() == \"Wayland\") {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on Wayland.\\nWayland can be disabled in the Editor Settings (Run > Platforms > Linux/*BSD > Prefer Wayland).\"));\n+\t\t\t} else {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER:\n+\t\t\tstate_label->set_text(vformat(TTR(\"Game embedding not available for the Display Server: '%s'.\\nDisplay Server can be modified in the Project Settings (Display > Display Server > Driver).\"), GLOBAL_GET(\"display/display_server/driver\")));\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_MINIMIZED:\n \t\t\tstate_label->set_text(TTR(\"Game embedding not available when the game starts minimized.\\nConsider overriding the window mode project setting with the editor feature tag to Windowed to use game embedding while leaving the exported project intact.\"));\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6be2d961ba08..6e08c269b063 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -108,6 +108,7 @@ class GameView : public VBoxContainer {\n \t\tEMBED_NOT_AVAILABLE_MAXIMIZED,\n \t\tEMBED_NOT_AVAILABLE_FULLSCREEN,\n \t\tEMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE,\n+\t\tEMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER,\n \t};\n \n \tinline static GameView *singleton = nullptr;\n", "test_patch": "", "problem_statement": "\"Game Embedding not available on your OS\" EndeavorOS Hyprland\n### Tested versions\n\nReproducible in: 4.4.beta3\n\n### System information\n\nGodot v4.4.beta3 - EndeavourOS #1 SMP PREEMPT_DYNAMIC Sun, 02 Feb 2025 01:02:29 +0000 on Wayland - Wayland display driver, Single-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) HD Graphics 500 (APL 2) - Intel(R) Celeron(R) CPU N3350 @ 1.10GHz (2 threads)\n\n### Issue description\n\nWas going to test for the first time the game embedding from 4.4 and was surprised to seed it did not work, the devlogs said it was available for linux so that got me wondering if it was a Hyprland issue, but I could not find anything online, or on the issues, easily available.\n\n### Steps to reproduce\n\n- Create any new project\n- Run any scene\n- Open game tab\n\n### Minimal reproduction project (MRP)\n\nAny godot project\n", "hints_text": "The message is effectively not very clear in your situation. Right now, the Game Embedding is not available when Godot Editor is using the Wayland display driver. It only support x11. It works on Linux Wayland if using X11 display driver.\n\nIt's documented in the original PR: https://github.com/godotengine/godot/pull/99010\n\nI'll check if the message could be adjusted for Linux.", "created_at": "2025-02-14 00:27:32", "merge_commit_sha": "b2aae7b72962ad1514d14d09b41b45ae837170ab", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102813", "base_commit": "1a0bf546772edc19837e96b5ac07a47a9f8a8b34", "patch": "diff --git a/editor/gui/scene_tree_editor.cpp b/editor/gui/scene_tree_editor.cpp\nindex ab834929cd58..5aedd940e482 100644\n--- a/editor/gui/scene_tree_editor.cpp\n+++ b/editor/gui/scene_tree_editor.cpp\n@@ -924,12 +924,19 @@ void SceneTreeEditor::_update_tree(bool p_scroll_to_selected) {\n \t\t// If pinned state changed, update the currently pinned node.\n \t\tif (AnimationPlayerEditor::get_singleton()->is_pinned() != node_cache.current_has_pin) {\n \t\t\tnode_cache.current_has_pin = AnimationPlayerEditor::get_singleton()->is_pinned();\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n \t\t}\n \t\t// If the current pinned node changed update both the old and new node.\n \t\tif (node_cache.current_pinned_node != pinned_node) {\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n-\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t// get_editing_node() will return deleted nodes. If the nodes are not in cache don't try to mark them.\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n+\t\t\tif (node_cache.has(node_cache.current_pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t}\n \t\t\tnode_cache.current_pinned_node = pinned_node;\n \t\t}\n \n@@ -2373,6 +2380,10 @@ HashMap<Node *, SceneTreeEditor::CachedNode>::Iterator SceneTreeEditor::NodeCach\n \treturn I;\n }\n \n+bool SceneTreeEditor::NodeCache::has(Node *p_node) {\n+\treturn get(p_node, false).operator bool();\n+}\n+\n void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \tif (!p_node) {\n \t\treturn;\n@@ -2382,6 +2393,11 @@ void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \t\teditor->selected = nullptr;\n \t}\n \n+\tif (p_node == current_pinned_node) {\n+\t\tcurrent_pinned_node = nullptr;\n+\t\tcurrent_has_pin = false;\n+\t}\n+\n \teditor->marked.erase(p_node);\n \n \tHashMap<Node *, CachedNode>::Iterator I = cache.find(p_node);\n@@ -2419,6 +2435,7 @@ void SceneTreeEditor::NodeCache::mark_dirty(Node *p_node, bool p_parents) {\n \t\tif (!p_parents) {\n \t\t\tbreak;\n \t\t}\n+\n \t\tnode = node->get_parent();\n \t}\n }\n@@ -2483,4 +2500,6 @@ void SceneTreeEditor::NodeCache::clear() {\n \t}\n \tcache.clear();\n \tto_delete.clear();\n+\tcurrent_pinned_node = nullptr;\n+\tcurrent_has_pin = false;\n }\ndiff --git a/editor/gui/scene_tree_editor.h b/editor/gui/scene_tree_editor.h\nindex e789e9692419..d29c4df0cdb2 100644\n--- a/editor/gui/scene_tree_editor.h\n+++ b/editor/gui/scene_tree_editor.h\n@@ -90,6 +90,7 @@ class SceneTreeEditor : public Control {\n \n \t\tHashMap<Node *, CachedNode>::Iterator add(Node *p_node, TreeItem *p_item);\n \t\tHashMap<Node *, CachedNode>::Iterator get(Node *p_node, bool p_deleted_ok = true);\n+\t\tbool has(Node *p_node);\n \t\tvoid remove(Node *p_node, bool p_recursive = false);\n \t\tvoid mark_dirty(Node *p_node, bool p_parents = true);\n \t\tvoid mark_children_dirty(Node *p_node, bool p_recursive = false);\n", "test_patch": "", "problem_statement": "Editor crash when interacting with a re-opened scene containing an animation player\n### Tested versions\n\nAt least 4.4.beta1 to current head `6dc78c8aa17ad46e701e0c4e7b7632c2f0e098f1` but involves code introduced in  https://github.com/godotengine/godot/pull/99700 or a related PR cc @hpvb \n\n~~As far as I've seen, the crash does not happen if the editor is compiled with `dev_build=yes`~~\n\n### System information\n\nGodot v4.4.beta.mono (6dc78c8aa) - macOS Sequoia (15.2.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 (Apple8) - Apple M2 (8 threads)\n\n### Issue description\n\nAfter closing and re-opening a scene containing an animation player and then either selecting a node or closing the scene tab several times, either SIGSEGV or SIGBUS crashes the editor. From lldb:\n```\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x3d9ec6003f8001a8)\n  * frame #0: 0x0000000102cb4df8 godot.macos.editor.arm64`Node::get_parent() const\n    frame #1: 0x0000000102468e1c godot.macos.editor.arm64`SceneTreeEditor::_update_tree(bool) + 500\n    frame #2: 0x0000000104bd0394 godot.macos.editor.arm64`CallQueue::_call_function(Callable const&, Variant const*, int, bool) + 336\n    frame #3: 0x0000000104bd06b0 godot.macos.editor.arm64`CallQueue::flush() + 352\n    frame #4: 0x0000000102ceb6d0 godot.macos.editor.arm64`SceneTree::physics_process(double) + 244\n    frame #5: 0x00000001003f366c godot.macos.editor.arm64`Main::iteration() + 596\n    frame #6: 0x0000000100383878 godot.macos.editor.arm64`OS_MacOS::run() + 148\n    frame #7: 0x00000001003b0ad4 godot.macos.editor.arm64`main + 388\n    frame #8: 0x0000000196350274 dyld`start + 2840\n```\nPresumably some call is getting inlined between _update_tree and get_parent?\n\n### Steps to reproduce\n\nClose and reopen the same scene several times in a row, optionally interacting with a node. In my tests, I saw a crash after anywhere between 1 and 4 close/reopen cycles with the last user action being any of opening the scene, closing the scene, or selecting a node in the tree.\n\n### Minimal reproduction project (MRP)\n\n[glb_test.zip](https://github.com/user-attachments/files/18680946/glb_test.zip)\n", "hints_text": "I tried to reproduce the issue on Linux with scenes from the 2D platformer demo in 4.4.beta2 but didn't get any crash.\n\nIt might be system specific, or scene specific. Is your scene particularly complex or using some specific node types which might be relevant?\n\nThe crash trace is a bit confusing, `SceneTreeEditor::_update_tree(bool) + 500` (if 500 is the line number) seems to be an empty line in `_update_node`, while `_update_tree` is much further down.\nThe 500 is in this case the function address offset. I agree the trace is weird though as it shows a get_parent call from _update_tree, which unless I missed something does not happen and I'm not sure what intermediary call might've been inlined to allow that. I don't remember exactly what conditions or versions I tested, and it might be system specific although I tested it in a pretty barebones scene before. I'll test again with beta2 on mac/linux/windows and see what comes up (also I'll change my lldb output format to maybe be clearer lol)\n\nEdit: I'm able to consistently reproduce this on macos in beta1 and beta2, both standard and mono, for scenes containing an AnimationPlayer, although re \"consistently\" I'm pretty sure it's a race condition somewhere as sometimes the crash happens on 1st interaction and sometimes it takes like a minute of spam open/closing the scene and clicking randomly on nodes. I'm going to try to repro on windows + linux and then see if I can get a better trace.\n\n[glb_test.zip](https://github.com/user-attachments/files/18680946/glb_test.zip)\n\nEdit 2: I was able to repro on Windows although it was waaaaay less likely than on the macbook. I was only able to get it to crash twice, both times with `STATUS_HEAP_CORRUPTION`. I only tested beta2 standard since on the macbook it didn't seem to matter.\n\nEdit 3: And I'm also able to repro on my older linux laptop also with beta2 pretty easily with SIGSEGV, although the info I get in console is completely useless.\nGood news(?) it does actually happen with debugging stuff enabled, I just was unlucky when previously testing it. Looks like maybe there's a race to update the pinned node and it can end up stale in certain cases:\n```\n[3] SceneTreeEditor::NodeCache::mark_dirty(Node*, bool) (in godot.macos.editor.dev.arm64.mono) (/Users/adam/code/godot/editor/gui/scene_tree_editor.cpp:2420)\n[4] SceneTreeEditor::_update_tree(bool) (in godot.macos.editor.dev.arm64.mono) (/Users/adam/code/godot/editor/gui/scene_tree_editor.cpp:932)\n```\nhttps://github.com/godotengine/godot/blob/master/editor/gui/scene_tree_editor.cpp#L932\n\nhttps://github.com/godotengine/godot/blob/master/editor/gui/scene_tree_editor.cpp#L2420\n\nIt sorta makes sense that I didn't run into this when testing the original pr before (besides the crash being sorta rare) since I was mostly using the test scene with thousands of empty base nodes and no AnimationPlayer. At worst, the mark dirty could check for instance validity rather than null but I'll try looking for a nicer solution.\nThank you for the great report and the digging!\n\nI want to have a look to see how a node actually gets in that state in the editor. It might need a different signal being handled. If a \"bad node\" can make it into that codepath then it would cause problems elsewhere as well, in code I didn't even touch.\n\nThis might have been a preexisting issue that was just even more rare before.\nMaybe there's a different triggering condition but the only thing I can think of is that the only time `current_pinned_node` is set is 1) if there's a current root node and 2) if the current pin is different from the previous pin, so the old pin always sticks around and if that node has already been freed the crash occurs. My first thought was just to reset all the fields in `node_cache.clear()`, so it would always be nulled when the edited scene changes, but that didn't work. I think since the old code updated the full tree each time it would be unlikely that this same crash could happen.\n\nEdit: ok I _did_ notice before while doing repro that I very rarely got a different offset and now it looks like `AnimationPlayerEditor::get_editing_node()` can actually give back an already freed node. So either it's freed by the time the the tree updates and it crashes or it's freed by the next time the tree updates and it crashes. Clearing the cache on the tree being reset only covers the second case.\nI understand what needs to happen, a PR is incoming! I'm on a trip this weekend so it might not be until Monday.\nWere you able to repro or were you going off of my description/stack trace? My impression was we needed to both clear the cache values when the tree was cleared and also update the AnimationPlayerEditor to clear its editing node when the scene was changed as well, but I wasn't sure of a good mechanism for the latter.\nSorry, it'll have to be tomorrow due to $reallife, I read through all of the code on the train and I figured out the cases you were referring to! I really do know how to fix it :)\n\nWe have signals to tell us when nodes get invalidated, but we never update the node pin cache. It should all work just fine if we make sure we update that cache also in response to the correct signals!\nNo worries, I was mostly asking because so far nobody else has mentioned being able to repro and it seems potentially multifaceted. I cleaned up the stashed changes I was messing around with last week here https://github.com/a-johnston/godot/commit/f230e9722b6c228d306308b69315c983825ac809 and while I think this addresses the issue I also don't know if it's just less likely (since it seems like a race) or if this goes too far and impacts some other functionality.\n\nEdit- maybe should mention I was testing opening/closing a tab, switching between two tabs with possible pins, and having multiple pinnable nodes within the same tab", "created_at": "2025-02-13 16:53:27", "merge_commit_sha": "25a3b38a838c7b9acb673c6de5ed684a7127ceae", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102774", "base_commit": "b607110ad211778a6426a00ca9c8cd99c0eb383c", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex b27665548f4b..79bf8975411b 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2204,6 +2204,10 @@\n \t\t\tThe CA certificates bundle to use for TLS connections. If this is set to a non-empty value, this will [i]override[/i] Godot's default [url=https://github.com/godotengine/godot/blob/master/thirdparty/certs/ca-certificates.crt]Mozilla certificate bundle[/url]. If left empty, the default certificate bundle will be used.\n \t\t\tIf in doubt, leave this setting empty.\n \t\t</member>\n+\t\t<member name=\"network/tls/enable_tls_v1.3\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n+\t\t\tIf [code]true[/code], enable TLSv1.3 negotiation.\n+\t\t\t[b]Note:[/b] This is experimental, and may cause connections to fail in some cases (notably, if the remote server uses TLS handshake fragmentation).\n+\t\t</member>\n \t\t<member name=\"physics/2d/default_angular_damp\" type=\"float\" setter=\"\" getter=\"\" default=\"1.0\">\n \t\t\tThe default rotational motion damping in 2D. Damping is used to gradually slow down physical objects over time. RigidBodies will fall back to this value when combining their own damping values and no area damping value is present.\n \t\t\tSuggested values are in the range [code]0[/code] to [code]30[/code]. At value [code]0[/code] objects will keep moving with the same velocity. Greater values will stop the object faster. A value equal to or greater than the physics tick rate ([member physics/common/physics_ticks_per_second]) will bring the object to a stop in one iteration.\ndiff --git a/modules/mbedtls/register_types.cpp b/modules/mbedtls/register_types.cpp\nindex bf65dfb0b76a..c0eca6ee18e0 100644\n--- a/modules/mbedtls/register_types.cpp\n+++ b/modules/mbedtls/register_types.cpp\n@@ -35,6 +35,8 @@\n #include \"packet_peer_mbed_dtls.h\"\n #include \"stream_peer_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n #include <psa/crypto.h>\n #endif\n@@ -50,6 +52,8 @@ void initialize_mbedtls_module(ModuleInitializationLevel p_level) {\n \t\treturn;\n \t}\n \n+\tGLOBAL_DEF(\"network/tls/enable_tls_v1.3\", false);\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n \tint status = psa_crypto_init();\n \tERR_FAIL_COND_MSG(status != PSA_SUCCESS, \"Failed to initialize psa crypto. The mbedTLS modules will not work.\");\ndiff --git a/modules/mbedtls/tls_context_mbedtls.cpp b/modules/mbedtls/tls_context_mbedtls.cpp\nindex f5c196596eb2..33c4cfd5450e 100644\n--- a/modules/mbedtls/tls_context_mbedtls.cpp\n+++ b/modules/mbedtls/tls_context_mbedtls.cpp\n@@ -30,6 +30,8 @@\n \n #include \"tls_context_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n static void my_debug(void *ctx, int level,\n \t\tconst char *file, int line,\n \t\tconst char *str) {\n@@ -144,6 +146,11 @@ Error TLSContextMbedTLS::init_server(int p_transport, Ref<TLSOptions> p_options,\n \t\tcookies = p_cookies;\n \t\tmbedtls_ssl_conf_dtls_cookies(&conf, mbedtls_ssl_cookie_write, mbedtls_ssl_cookie_check, &(cookies->cookie_ctx));\n \t}\n+\n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \tmbedtls_ssl_setup(&tls, &conf);\n \treturn OK;\n }\n@@ -187,6 +194,10 @@ Error TLSContextMbedTLS::init_client(int p_transport, const String &p_hostname,\n \t\t}\n \t}\n \n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \t// Set valid CAs\n \tmbedtls_ssl_conf_ca_chain(&conf, &(cas->cert), nullptr);\n \tmbedtls_ssl_setup(&tls, &conf);\n", "test_patch": "", "problem_statement": "[4.4 beta 1] TLS Handshake Error with Godot HTTPRequest\n### Tested versions\n\n4.4 beta 1 \n\n\n### System information\n\nWindows 11 - Godot 4.4 beta 1 - Vulkan (Mobile)\n\n### Issue description\n\nI\u2019m encountering a TLS handshake error when trying to make a request to https://graph.oculus.com/ using Godot's HTTPRequest.\n\n* Requests to https://www.google.com/ work without any issues.\n* Python's requests library can access the URL without any problems.\n* The same https://graph.oculus.com/ URL works correctly in Postman.\n* I attempted to create a certificate bundle as well, but it was unsuccessful.\n* This issue appears to be specific to Godot.\n\nCPP ERROR:\n\nE 0:00:01:0639   StreamPeerMbedTLS::_do_handshake: TLS handshake error: -28800\n  <C++ Source>   modules\\mbedtls\\stream_peer_mbedtls.cpp:88 @ StreamPeerMbedTLS::_do_handshake()\n\n### Steps to reproduce\n\n* Create simple project\n* Add a HTTPRequest node\n* Add script:\n```\nextends Node3D\n\n@onready var http: HTTPRequest = $HTTPRequest\n\nfunc _ready() -> void:\n\thttp.request(\"https://graph.oculus.com/\")\n\tprint(await http.request_completed)\n```\n* Run\n\n\n### Minimal reproduction project (MRP)\n\n[teste-vr.zip](https://github.com/user-attachments/files/18505403/teste-vr.zip)\n", "hints_text": "I am not in the right area right now, but try running a TLS analyzer on https://graph.oculus.com and https://www.google.com/ and see what's different.\nHello @fire , below is the analysis I performed using the tool: [SSLLabs](https://www.ssllabs.com/). The following key details were observed:\n\n---\n\n#### **TLS Version Support**\n- **Google**: Supports TLS versions starting from **TLS 1.0**.\n- **Meta**: Supports TLS versions starting from **TLS 1.2**.\n\n---\n\n#### **Key Usage**\n- **Google**: Utilizes an **RSA key** of **2048 bits** for its SSL certificate.\n- **Meta**: Utilizes an **EC key** of **256 bits** for its SSL certificate.\n\n---\n\n#### **Cipher Suites**\n\n**Google supports the following Cipher Suites:**\n\n- **TLS 1.3 (No server preference)**\n  - TLS_AES_128_GCM_SHA256 (0x1301): ECDH x25519 (eq. 3072 bits RSA), FS, 128-bit\n  - TLS_AES_256_GCM_SHA384 (0x1302): ECDH x25519 (eq. 3072 bits RSA), FS, 256-bit\n  - TLS_CHACHA20_POLY1305_SHA256 (0x1303): ECDH x25519 (eq. 3072 bits RSA), FS, 256-bit\n\n- **TLS 1.2 (Server-preferred order)**\n  - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b): ECDH x25519, FS, 128-bit\n  - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca9): ECDH x25519, FS, 256-bit\n  - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 (0xc02c): ECDH x25519, FS, 256-bit\n  - Other suites (WEAK):\n    - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013): FS, 128-bit\n    - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014): FS, 256-bit\n    - TLS_RSA_WITH_AES_128_GCM_SHA256 (0x9c): WEAK, 128-bit\n    - TLS_RSA_WITH_AES_256_GCM_SHA384 (0x9d): WEAK, 256-bit\n\n---\n\n**Meta supports the following Cipher Suites:**\n\n- **TLS 1.3 (Server-preferred order)**\n  - TLS_AES_128_GCM_SHA256 (0x1301): ECDH x25519, FS, 128-bit\n  - TLS_CHACHA20_POLY1305_SHA256 (0x1303): ECDH x25519, FS, 256-bit\n  - TLS_AES_256_GCM_SHA384 (0x1302): ECDH x25519, FS, 256-bit\n\n- **TLS 1.2 (Server-preferred order)**\n  - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f): ECDH secp256r1, FS, 128-bit\n  - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030): ECDH secp256r1, FS, 256-bit\n  - Other suites (WEAK):\n    - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013): FS, 128-bit\n    - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014): FS, 256-bit\n\n---\n\nI can confirm the issue (on Debian 12), the error (-28800, i.e. -0x7080) is `MBEDTLS_ERR_SSL_FEATURE_UNAVAILABLE`, so it seems we are either hitting a limitation of our build flags, or this is an issue with MBEDTLS not falling back to TLS 1.2 when a 1.3 is not available (e.g., TLS Handshake record layer fragmentation).\nIndeed, running in verbose mode I get:\n\n```\nthirdparty/mbedtls/library/ssl_tls13_generic.c:1552: Perform PSA-based ECDH/FFDH computation.\nthirdparty/mbedtls/library/ssl_tls13_client.c:1949: Switch to handshake keys for inbound traffic\nthirdparty/mbedtls/library/ssl_msg.c:5070: Ignore ChangeCipherSpec in TLS 1.3 compatibility mode\nthirdparty/mbedtls/library/ssl_msg.c:3297: TLS handshake fragmentation not supported\nthirdparty/mbedtls/library/ssl_msg.c:4244: mbedtls_ssl_handle_message_type() returned -28800 (-0x7080)\nthirdparty/mbedtls/library/ssl_tls13_client.c:2372: mbedtls_ssl_read_record() returned -28800 (-0x7080)\n```\n\nSo my suspects on TLS Handshake record layer fragmentation being the cause seems to be correct. Will investigate if we can try to fallback to TLS 1.2 manually in that scenario.\nThis appears to be a regression:\n- Reproducible in 4.4.dev3 and later, all the way to current `master` (296de7da830fa03425edf544427543087817e649)\n- Not reproducible in 4.3.stable, 4.4.dev1 and 4.4.dev2\n\nSo it was introduced in 4.4.dev3. Most likely from #96394 as @Faless already identified.\nFor reference, this is the mbedTLS issue -> https://github.com/Mbed-TLS/mbedtls/issues/1840\nAnd this https://github.com/Mbed-TLS/mbedtls/pull/9872 seems to be the most up to date PR implementing the missing feature (sadly the 3.x backport is not yet provided).\n\nI also have a branch implementing \"retrying\" the TLS connection using 1.2 in that scenario ( https://github.com/Faless/godot/tree/tls/fallback_to_tls12 ) but it's very hacky, and I don't particularly like the solution tbh (it forces us to keep track of a bunch of settings to re-attempt the TCP reconnection).\n\nI've been thinking about an alternative adding a global setting, and a TLSOption one, to force the maximum version of TLS to 1.2 instead, and let the devs handle this if necessary until mbedTLS implements the feature (hopefully soon?).", "created_at": "2025-02-12 15:44:17", "merge_commit_sha": "8add5838ace498c70ade956b4e1dded73cc3631d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102737", "base_commit": "ad9abe841d9bb47a397c5e1a314ced1c5abc1ccd", "patch": "diff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex 8135a9b96644..aec082791ef5 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -39,6 +39,7 @@\n #include \"editor/multi_node_edit.h\"\n #include \"editor/plugins/editor_context_menu_plugin.h\"\n #include \"editor/plugins/editor_plugin.h\"\n+#include \"scene/property_utils.h\"\n #include \"scene/resources/packed_scene.h\"\n \n void EditorSelectionHistory::cleanup_history() {\n@@ -536,15 +537,18 @@ Variant EditorData::instantiate_custom_type(const String &p_type, const String &\n \t\t\tif (get_custom_types()[p_inherits][i].name == p_type) {\n \t\t\t\tRef<Script> script = get_custom_types()[p_inherits][i].script;\n \n-\t\t\t\tVariant ob = ClassDB::instantiate(p_inherits);\n-\t\t\t\tERR_FAIL_COND_V(!ob, Variant());\n+\t\t\t\t// Store in a variant to initialize the refcount if needed.\n+\t\t\t\tVariant v = ClassDB::instantiate(p_inherits);\n+\t\t\t\tERR_FAIL_COND_V(!v, Variant());\n+\t\t\t\tObject *ob = v;\n+\n \t\t\t\tNode *n = Object::cast_to<Node>(ob);\n \t\t\t\tif (n) {\n \t\t\t\t\tn->set_name(p_type);\n \t\t\t\t}\n-\t\t\t\tn->set_meta(SceneStringName(_custom_type_script), script);\n-\t\t\t\t((Object *)ob)->set_script(script);\n-\t\t\t\treturn ob;\n+\t\t\t\tPropertyUtils::assign_custom_type_script(ob, script);\n+\t\t\t\tob->set_script(script);\n+\t\t\t\treturn v;\n \t\t\t}\n \t\t}\n \t}\n@@ -988,12 +992,13 @@ Variant EditorData::script_class_instance(const String &p_class) {\n \t\tRef<Script> script = script_class_load_script(p_class);\n \t\tif (script.is_valid()) {\n \t\t\t// Store in a variant to initialize the refcount if needed.\n-\t\t\tVariant obj = ClassDB::instantiate(script->get_instance_base_type());\n-\t\t\tif (obj) {\n-\t\t\t\tObject::cast_to<Object>(obj)->set_meta(SceneStringName(_custom_type_script), script);\n-\t\t\t\tobj.operator Object *()->set_script(script);\n+\t\t\tVariant v = ClassDB::instantiate(script->get_instance_base_type());\n+\t\t\tif (v) {\n+\t\t\t\tObject *obj = v;\n+\t\t\t\tPropertyUtils::assign_custom_type_script(obj, script);\n+\t\t\t\tobj->set_script(script);\n \t\t\t}\n-\t\t\treturn obj;\n+\t\t\treturn v;\n \t\t}\n \t}\n \treturn Variant();\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 38839a8bbc61..a733e1ce4e1d 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -4751,7 +4751,7 @@ Ref<Script> EditorNode::get_object_custom_type_base(const Object *p_object) cons\n \n \tconst Node *node = Object::cast_to<const Node>(p_object);\n \tif (node && node->has_meta(SceneStringName(_custom_type_script))) {\n-\t\treturn node->get_meta(SceneStringName(_custom_type_script));\n+\t\treturn PropertyUtils::get_custom_type_script(node);\n \t}\n \n \tRef<Script> scr = p_object->get_script();\ndiff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex b46cda63c70b..2bc022f1d1cb 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -2834,7 +2834,7 @@ void SceneTreeDock::_update_script_button() {\n \t\t\tRef<Script> cts;\n \n \t\t\tif (n->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\t\tcts = n->get_meta(SceneStringName(_custom_type_script));\n+\t\t\t\tcts = PropertyUtils::get_custom_type_script(n);\n \t\t\t}\n \n \t\t\tif (selection.size() == 1) {\n@@ -3114,7 +3114,7 @@ void SceneTreeDock::_replace_node(Node *p_node, Node *p_by_node, bool p_keep_pro\n \n \t\t// If we're dealing with a custom node type, we need to create a default instance of the custom type instead of the native type for property comparison.\n \t\tif (oldnode->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\tRef<Script> cts = oldnode->get_meta(SceneStringName(_custom_type_script));\n+\t\t\tRef<Script> cts = PropertyUtils::get_custom_type_script(oldnode);\n \t\t\tdefault_oldnode = Object::cast_to<Node>(get_editor_data()->script_class_instance(cts->get_global_name()));\n \t\t\tif (default_oldnode) {\n \t\t\t\tdefault_oldnode->set_name(cts->get_global_name());\n@@ -3618,7 +3618,7 @@ void SceneTreeDock::_script_dropped(const String &p_file, NodePath p_to) {\n \t} else {\n \t\t// Check if dropped script is compatible.\n \t\tif (n->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\tRef<Script> ct_scr = n->get_meta(SceneStringName(_custom_type_script));\n+\t\t\tRef<Script> ct_scr = PropertyUtils::get_custom_type_script(n);\n \t\t\tif (!scr->inherits_script(ct_scr)) {\n \t\t\t\tString custom_type_name = ct_scr->get_global_name();\n \ndiff --git a/scene/property_utils.cpp b/scene/property_utils.cpp\nindex 9cae7d2a3a8a..dc9a56a294a9 100644\n--- a/scene/property_utils.cpp\n+++ b/scene/property_utils.cpp\n@@ -92,7 +92,7 @@ Variant PropertyUtils::get_property_default_value(const Object *p_object, const\n \t// Handle special case \"script\" property, where the default value is either null or the custom type script.\n \t// Do this only if there's no states stack cache to trace for default values.\n \tif (!p_states_stack_cache && p_property == CoreStringName(script) && p_object->has_meta(SceneStringName(_custom_type_script))) {\n-\t\tRef<Script> ct_scr = p_object->get_meta(SceneStringName(_custom_type_script));\n+\t\tRef<Script> ct_scr = get_custom_type_script(p_object);\n \t\tif (r_is_valid) {\n \t\t\t*r_is_valid = true;\n \t\t}\n@@ -282,3 +282,29 @@ Vector<SceneState::PackState> PropertyUtils::get_node_states_stack(const Node *p\n \t}\n \treturn states_stack_ret;\n }\n+\n+void PropertyUtils::assign_custom_type_script(Object *p_object, const Ref<Script> &p_script) {\n+\tERR_FAIL_NULL(p_object);\n+\tERR_FAIL_COND(p_script.is_null());\n+\n+\tconst String &path = p_script->get_path();\n+\tERR_FAIL_COND(!path.is_resource_file());\n+\n+\tResourceUID::ID script_uid = ResourceLoader::get_resource_uid(path);\n+\tif (script_uid != ResourceUID::INVALID_ID) {\n+\t\tp_object->set_meta(SceneStringName(_custom_type_script), ResourceUID::get_singleton()->id_to_text(script_uid));\n+\t}\n+}\n+\n+Ref<Script> PropertyUtils::get_custom_type_script(const Object *p_object) {\n+\tVariant custom_script = p_object->get_meta(SceneStringName(_custom_type_script));\n+#ifndef DISABLE_DEPRECATED\n+\tif (custom_script.get_type() == Variant::OBJECT) {\n+\t\t// Convert old script meta.\n+\t\tRef<Script> script_object(custom_script);\n+\t\tassign_custom_type_script(const_cast<Object *>(p_object), script_object);\n+\t\treturn script_object;\n+\t}\n+#endif\n+\treturn ResourceLoader::load(custom_script);\n+}\ndiff --git a/scene/property_utils.h b/scene/property_utils.h\nindex 0bf040ad267a..0fa532440413 100644\n--- a/scene/property_utils.h\n+++ b/scene/property_utils.h\n@@ -46,6 +46,9 @@ class PropertyUtils {\n \t// in the tree, since every owner found while traversing towards the root gets a chance\n \t// to override property values.)\n \tstatic Vector<SceneState::PackState> get_node_states_stack(const Node *p_node, const Node *p_owner = nullptr, bool *r_instantiated_by_owner = nullptr);\n+\n+\tstatic void assign_custom_type_script(Object *p_object, const Ref<Script> &p_script);\n+\tstatic Ref<Script> get_custom_type_script(const Object *p_object);\n };\n \n #endif // PROPERTY_UTILS_H\n", "test_patch": "", "problem_statement": "Deserializing custom resource created through inspector results in parser error\n### Tested versions\n\n- Reproducible in: 4.4.beta3\n- Not reproducible in: 4.3.stable\n\n### System information\n\nGodot v4.4.beta3 - Windows 11 (build 26100) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 9 7940HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\nWhen doing `bytes_to_var_with_objects(var_to_bytes_with_objects(some_custom_resource))` where `some_custom_resource` was specifically created through the editor inspector, and not through something like `MyResource.new()`, you end up with a debugger break saying:\n\n```\nParser Error: Class \"MyResource\" hides a global script class.\n```\n\nThe exact same setup seemingly worked in 4.3-stable.\n\n### Steps to reproduce\n\n1. Open the MRP.\n2. Run the main scene.\n3. Note error.\n\n### Minimal reproduction project (MRP)\n\n[resource-serialization-error.zip](https://github.com/user-attachments/files/18710656/resource-serialization-error.zip)\n", "hints_text": "Can confirm, but happens for me in 4.3.stable and even in 4.2.2.stable, at least in my testing using the MRP\nIf you recreate that same setup in 4.3 (i.e. don't use the MRP project) the error won't show.\n\nIt might be related to the `metadata/_custom_type_script` property added to the `sub_resource` as of 4.4.\n\nI was planning on providing a 4.3-stable MRP instead, but there's some other strange issue happening in the upgrade process (that I need to report as well) which forced me to provide a 4.4 repro instead.\nThat makes sense when clarified!\n\nWith this added information I can pinpoint it as being introduced between dev3 and dev4\nI just realized I could have just provided two MRPs in the first place, so here's one for 4.3, with no error: [resource-serialization-error-4.3.zip](https://github.com/user-attachments/files/18711303/resource-serialization-error-4.3.zip)\nWill bisect now that I know the span\nBisected to:\n* https://github.com/godotengine/godot/pull/91341\n\nCC @bjornmp @KoBeWi \n\nChange was to close:\n* https://github.com/godotengine/godot/issues/37479\n* https://github.com/godotengine/godot-proposals/issues/7905\n\n---\n\nRelated issue:\n* https://github.com/godotengine/godot/issues/100154\n\nWhich was supposed to be solved by:\n* https://github.com/godotengine/godot/pull/101001\n`bytes_to_var_with_objects` will for some reason embed resources instead of referencing them. Custom type resources have hidden `_custom_type_script` metadata, which gets duplicated. The same would happen if you export a variable of type Script.\n\nTo fix it there needs to be an exception, similar to #100177.\nThough a more comprehensive fix would be changing `_custom_type_script` to String. It would fix all duplication problems.", "created_at": "2025-02-12 00:00:14", "merge_commit_sha": "c6b6278cbe6158ee172fcfa51b464c5961aafc34", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102726", "base_commit": "5da6deaaca27f3d4ec5281d5b791408570919f15", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex c48b05002c82..7d41d2faa601 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2330,6 +2330,7 @@\n \t\t</member>\n \t\t<member name=\"physics/3d/run_on_separate_thread\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n \t\t\tIf [code]true[/code], the 3D physics server runs on a separate thread, making better use of multi-core CPUs. If [code]false[/code], the 3D physics server runs on the main thread. Running the physics server on a separate thread can increase performance, but restricts API access to only physics process.\n+\t\t\t[b]Note:[/b] When [member physics/3d/physics_engine] is set to [code]Jolt Physics[/code], enabling this setting will prevent the 3D physics server from being able to provide any context when reporting errors and warnings, and will instead always refer to nodes as [code]&lt;unknown&gt;[/code].\n \t\t</member>\n \t\t<member name=\"physics/3d/sleep_threshold_angular\" type=\"float\" setter=\"\" getter=\"\" default=\"0.139626\">\n \t\t\tThreshold angular velocity under which a 3D physics body will be considered inactive. See [constant PhysicsServer3D.SPACE_PARAM_BODY_ANGULAR_VELOCITY_SLEEP_THRESHOLD].\ndiff --git a/modules/jolt_physics/jolt_physics_server_3d.h b/modules/jolt_physics/jolt_physics_server_3d.h\nindex 7dac7610f71a..416e3df56aec 100644\n--- a/modules/jolt_physics/jolt_physics_server_3d.h\n+++ b/modules/jolt_physics/jolt_physics_server_3d.h\n@@ -421,6 +421,7 @@ class JoltPhysicsServer3D final : public PhysicsServer3D {\n \n \tvirtual int get_process_info(PhysicsServer3D::ProcessInfo p_process_info) override;\n \n+\tbool is_on_separate_thread() const { return on_separate_thread; }\n \tbool is_active() const { return active; }\n \n \tvoid free_space(JoltSpace3D *p_space);\ndiff --git a/modules/jolt_physics/objects/jolt_object_3d.cpp b/modules/jolt_physics/objects/jolt_object_3d.cpp\nindex 1c2019d9fa3f..e9e6d504e0e7 100644\n--- a/modules/jolt_physics/objects/jolt_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_object_3d.h\"\n \n+#include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n #include \"../spaces/jolt_layers.h\"\n #include \"../spaces/jolt_space_3d.h\"\n@@ -137,6 +138,12 @@ bool JoltObject3D::can_interact_with(const JoltObject3D &p_other) const {\n }\n \n String JoltObject3D::to_string() const {\n+\tstatic const String fallback_name = \"<unknown>\";\n+\n+\tif (JoltPhysicsServer3D::get_singleton()->is_on_separate_thread()) {\n+\t\treturn fallback_name; // Calling `Object::to_string` is not thread-safe.\n+\t}\n+\n \tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n+\treturn instance != nullptr ? instance->to_string() : fallback_name;\n }\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\nindex 281591af9a6c..040d98dace9f 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n@@ -727,8 +727,3 @@ bool JoltSoftBody3D::is_vertex_pinned(int p_index) const {\n \n \treturn pinned_vertices.has(physics_index);\n }\n-\n-String JoltSoftBody3D::to_string() const {\n-\tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n-}\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.h b/modules/jolt_physics/objects/jolt_soft_body_3d.h\nindex f236310f6c69..4d7eb039426b 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.h\n@@ -167,8 +167,6 @@ class JoltSoftBody3D final : public JoltObject3D {\n \tvoid unpin_all_vertices();\n \n \tbool is_vertex_pinned(int p_index) const;\n-\n-\tString to_string() const;\n };\n \n #endif // JOLT_SOFT_BODY_3D_H\n", "test_patch": "", "problem_statement": "Jolt Physics warnings for PhysicalBone3D fail to report bone names when running physics on separate thread\n### Tested versions\n\n- Reproducible in 4.4-beta2, 4.4-beta3\n- Not reproducible in 4.3 (no Jolt implementation)\n\n### System information\n\nGodot v4.4.beta3 - Fedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4080 SUPER (nvidia; 565.77) - AMD Ryzen 7 8700F 8-Core Processor (16 threads)\n\n### Issue description\n\nI am using the native Jolt Physics engine on a separate thread via project settings (`physics/3d/run_on_separate_thread`). I have an armature that needs updating, so Jolt is emitting warnings. However, the warning is attempting to fetch the names of the problem bones, which is not thread-safe, so the warning text is malformed and is passed with multiple errors (as seen below).\n\n```\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine_001). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects '' and ''.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\n\nWhen physics is set to run on the main thread, the problem resolves, showing the warnings as normal, including the bone names (expected behavior).\n```\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3027113173784>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3027146728218>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3102627426828>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3102660981262>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\nShould the warning itself be deferred to the main thread?\n\n### Steps to reproduce\n\n1. Set physics to run on a separate thread `physics/3d/run_on_separate_thread`\n2. Switch Physics Engine to Jolt Physics\n3. Set up a Skeleton3D with PhysicalBone3D bones that have joint properties unsupported in Jolt (i.e. a Pinjoint configured with impulse clamping)\n4. Restart editor to see errors in console, or launch game to see them in debugger\n\n### Minimal reproduction project (MRP)\n\nWarnings should appear as soon as this project is opened and imported.\n\n[physicalbone3d_report_2025-02-09_17-35-51.zip](https://github.com/user-attachments/files/18726415/physicalbone3d_report_2025-02-09_17-35-51.zip)\n", "hints_text": "> However, the warning is attempting to fetch the names of the problem bones, which is not thread-safe, so the warning text is malformed and is passed with multiple errors (as seen below).\n\nThat is indeed problematic, and happens in more places than just this particular warning.\n\nI'll need to see how to best fix this. The fact that I'm even reporting node names from the physics server to begin with is highly questionable, and arguably breaks the \"separation of concerns\" between the scene side of things and the servers, but the errors/warnings are somewhat useless without any context.\n\nIdeally they would be actual configuration warnings on the nodes themselves I guess. The current way of doing it is mostly a crude carry-over from the extension, where there weren't a lot of better options, but I also didn't want the Jolt module to \"spill over\" into other parts of the codebase while it's still experimental.\n> The fact that I'm even reporting node names from the physics server to begin with is highly questionable, and arguably breaks the \"separation of concerns\" between the scene side of things and the servers.\n\nHaving the node names reported by itself to help with debug is not the problem, but having a server rely back on anything from the SceneTree or nodes is.\n\nSo those node name strings would need a copy stored inside the server that maps to whatever server internal object. The server can not ask back anything from the SceneTree outside of very specifically designed callbacks, it is in general the wrong direction.\n> So those node name strings would need a copy stored inside the server that maps to whatever server internal object.\n\nI guess the issue with that is nodes changing names, or just initializing them late, with no ability (with the current interface) for the server to pick up on that change. I suppose that's a minor concession though, since it's likely to be a niche problem.\n\nThe bigger loss would be the inability to provide meaningful errors in release exports, since the stored node names would come at a potentially non-trivial memory cost, and thus rightfully shouldn't be stored in such builds. But seeing as how error-checking in Godot is sometimes compiled out entirely in release exports, I guess there's precedent for that already.\n\nIt does seem like the least invasive option though. Any sort of deferral of the error to the main thread would at the very least require a set of custom error macros in order to report the correct file and line, and you're still left with the conceptual problem of grabbing scene stuff from the server at times when it might not be appropriate to do so.\nThe server should not be responsible to pick up such node changes. It is the node duty to make those changes known to a server.\n\n\nE.g. could add a generic xyz_set_meta() function for all the RID types to the PhysicsServer API that allows to add random stuff with a Dictionary to them for debug and the nodes could call that everytime stuff like their name changes.\nWhile an API like that does seem mildly useful in general, adding to the physics server interface just for this (and at this late stage) seems unfortunate, and also makes the server error reporting more of a commitment than I intended for it to be.\n\nI would probably prefer to skip the metadata part and just have the server pull the names once, and then we could change/improve this for 4.5 instead.\nI'd suggest we should properly weigh the cost of adding a potentially heavy or hacky debugging infrastructure in servers, versus simply not providing the extra useful information we'd like to provide here.\n\nIt's a design constraint of Godot that once things are at the server level, it's not possible to go back to the scene structure. The Jolt integration inherits this design limitation and should maybe not try to work it around.\n\nA proper debugging infrastructure to be able to go back to scene level when needed for descriptive errors might be worth considering, but this is proposal material and not specific to Jolt warnings.\n\nIn this specific case, usage of invalid joint types while using the Jolt backend would be better checked at the node level via Node configuration warnings. Or we just live with only the physics server generic error, and users can grep their scenes and source code to find which scenes use unsupported joints.\nFor 4.4 I would just reduce the error detail and go with a generic error without any node names or specifics. It is imo too late in the 4.4 cycle for any of those other changes that require more work. They can be done for 4.5 and if kept simple enough maybe even backported with a patch later.\n\nI am not sure how feasible it is to add specific physics backend errors to node config warnings. Imo nodes should not really care what backend is available.\nWarnings/errors without context might be fine for this particular warning, since you can indeed (in the worst case) grep for the specific property and maybe find the offending node. There are however a few warnings/errors that relate to numerical values, such as the ones for invalid scaling, and which can end up triggering only at runtime in certain cases. Providing no context for those errors is likely to be frustrating to the point of being detrimental, so I'll probably opt to remove those entirely in that case.\nI threw together a PR for removing the various scene contexts: #102717\n\nLet me know what you think.", "created_at": "2025-02-11 20:22:40", "merge_commit_sha": "9ac02ccbcba7bb260575ef9ca5ffa87d49e1ebf7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102719", "base_commit": "1a0bf546772edc19837e96b5ac07a47a9f8a8b34", "patch": "diff --git a/platform/web/display_server_web.cpp b/platform/web/display_server_web.cpp\nindex 89cc6339d28b..180c05ef411d 100644\n--- a/platform/web/display_server_web.cpp\n+++ b/platform/web/display_server_web.cpp\n@@ -576,9 +576,17 @@ void DisplayServerWeb::_mouse_update_mode() {\n \n void DisplayServerWeb::mouse_set_mode(MouseMode p_mode) {\n \tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n-\tif (p_mode == mouse_mode_base) {\n+\n+\tif (mouse_mode_override_enabled) {\n+\t\tmouse_mode_base = p_mode;\n+\t\t// No need to update, as override is enabled.\n+\t\treturn;\n+\t}\n+\tif (p_mode == mouse_mode_base && p_mode == mouse_get_mode()) {\n+\t\t// No need to update, as it is currently set as the correct mode.\n \t\treturn;\n \t}\n+\n \tmouse_mode_base = p_mode;\n \t_mouse_update_mode();\n }\n@@ -596,9 +604,17 @@ DisplayServer::MouseMode DisplayServerWeb::mouse_get_mode() const {\n \n void DisplayServerWeb::mouse_set_mode_override(MouseMode p_mode) {\n \tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n-\tif (p_mode == mouse_mode_override) {\n+\n+\tif (!mouse_mode_override_enabled) {\n+\t\tmouse_mode_override = p_mode;\n+\t\t// No need to update, as override is not enabled.\n+\t\treturn;\n+\t}\n+\tif (p_mode == mouse_mode_override && p_mode == mouse_get_mode()) {\n+\t\t// No need to update, as it is currently set as the correct mode.\n \t\treturn;\n \t}\n+\n \tmouse_mode_override = p_mode;\n \t_mouse_update_mode();\n }\n", "test_patch": "", "problem_statement": "[Web] `Input.mouse_mode` can't capture mouse after user presses escape key in browser\n### Tested versions\n\n- Reproducible in Godot 4.4.beta2\n- Not Reproducible in 4.3\n\n### System information\n\nGodot v4.4.beta2 - Linux Mint 22 (Wilma) on X11 - X11 display driver, Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4060 Ti (nvidia; 550.120) - AMD Ryzen 9 3900X 12-Core Processor (24 threads)\n\n### Issue description\n\nI have discovered an edge case that likely happens often. When the mouse is captured browsers tend to tell the user that they can press escape to free there mouse. If we capture the users mouse and then they press escape we can not again capture it with the current behavior. Even though the engine knows that the mouse has been released. To capture the mouse again after the user has pressed escape we must first tell the engine to release the mouse and then capture it again. So that they engine executes the correct sequence.\n\nNote: https://github.com/godotengine/godot/issues/100758#issuecomment-2624679816\n\n### Steps to reproduce\n\n\n1. Extract MRP\n2. Open MRP in Godot 4.4.beta2\n3. Ensure exports are managed for Godot 4.4.beta2\n4. Run the MRP in the browser.\n5. Capture the mouse using the button provided.\n6. Press the escape key \"esc\".\n7. Observe that your mouse is released and visible.\n8. Attempt to capture the mouse using the button provided that says \"Capture Mouse\".\n9. Observe this does not work.\n10. Press the button that says \"Capture Mouse After Release\".\n11. Observe this works.\n\nAlternatively for step 10. You can also press space bar or press the \"Release Mouse\" button. and then you can press the \"Capture Mouse\" button and it will work.\n\n### Minimal reproduction project (MRP)\n\n[web-mouse-capture-part-2.zip](https://github.com/user-attachments/files/18608637/web-mouse-capture-part-2.zip)\n", "hints_text": "", "created_at": "2025-02-11 17:02:44", "merge_commit_sha": "9f2b673c6132af06895a071d879eb0ca98862c29", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102715", "base_commit": "5da6deaaca27f3d4ec5281d5b791408570919f15", "patch": "diff --git a/platform/web/js/libs/audio.position.worklet.js b/platform/web/js/libs/audio.position.worklet.js\nindex 7dbeb8a0adde..155d4e6e8765 100644\n--- a/platform/web/js/libs/audio.position.worklet.js\n+++ b/platform/web/js/libs/audio.position.worklet.js\n@@ -35,16 +35,20 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\tsuper(...args);\n \t\tthis.lastPostTime = currentTime;\n \t\tthis.position = 0;\n+\t\tthis.ended = false;\n \n \t\tthis.port.onmessage = (event) => {\n-\t\t\tif (event?.data?.type === 'clear') {\n-\t\t\t\tthis.lastPostTime = currentTime;\n-\t\t\t\tthis.position = 0;\n+\t\t\tif (event?.data?.type === 'ended') {\n+\t\t\t\tthis.ended = true;\n \t\t\t}\n \t\t};\n \t}\n \n \tprocess(inputs, _outputs, _parameters) {\n+\t\tif (this.ended) {\n+\t\t\treturn false;\n+\t\t}\n+\n \t\tif (inputs.length > 0) {\n \t\t\tconst input = inputs[0];\n \t\t\tif (input.length > 0) {\n@@ -55,7 +59,7 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\t// Posting messages is expensive. Let's limit the number of posts.\n \t\tif (currentTime - this.lastPostTime > POST_THRESHOLD_S) {\n \t\t\tthis.lastPostTime = currentTime;\n-\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n+\t\t\tthis.port.postMessage({ type: 'position', data: this.position });\n \t\t}\n \n \t\treturn true;\ndiff --git a/platform/web/js/libs/library_godot_audio.js b/platform/web/js/libs/library_godot_audio.js\nindex c5fa7d5f0fad..d04862795308 100644\n--- a/platform/web/js/libs/library_godot_audio.js\n+++ b/platform/web/js/libs/library_godot_audio.js\n@@ -621,28 +621,24 @@ class SampleNode {\n \t\tif (this.isCanceled) {\n \t\t\treturn;\n \t\t}\n-\t\tthis.getPositionWorklet();\n-\t\tthis._source.connect(this._positionWorklet);\n+\t\tthis._source.connect(this.getPositionWorklet());\n \t\tif (start) {\n \t\t\tthis.start();\n \t\t}\n \t}\n \n \t/**\n-\t * Get a AudioWorkletProcessor from the pool, or create one if no processor is available.\n+\t * Get a AudioWorkletProcessor\n+\t * @returns {AudioWorkletNode}\n \t */\n \tgetPositionWorklet() {\n \t\tif (this._positionWorklet != null) {\n-\t\t\treturn;\n-\t\t}\n-\t\tif (GodotAudio.audioPositionWorkletPool.length == 0) {\n-\t\t\tthis._positionWorklet = new AudioWorkletNode(\n-\t\t\t\tGodotAudio.ctx,\n-\t\t\t\t'godot-position-reporting-processor'\n-\t\t\t);\n-\t\t} else {\n-\t\t\tthis._positionWorklet = GodotAudio.audioPositionWorkletPool.pop();\n+\t\t\treturn this._positionWorklet;\n \t\t}\n+\t\tthis._positionWorklet = new AudioWorkletNode(\n+\t\t\tGodotAudio.ctx,\n+\t\t\t'godot-position-reporting-processor'\n+\t\t);\n \t\tthis._positionWorklet.port.onmessage = (event) => {\n \t\t\tswitch (event.data['type']) {\n \t\t\tcase 'position':\n@@ -652,6 +648,7 @@ class SampleNode {\n \t\t\t\t// Do nothing.\n \t\t\t}\n \t\t};\n+\t\treturn this._positionWorklet;\n \t}\n \n \t/**\n@@ -681,8 +678,7 @@ class SampleNode {\n \t\tif (this._positionWorklet) {\n \t\t\tthis._positionWorklet.disconnect();\n \t\t\tthis._positionWorklet.port.onmessage = null;\n-\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n-\t\t\tGodotAudio.audioPositionWorkletPool.push(this._positionWorklet);\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'ended' });\n \t\t\tthis._positionWorklet = null;\n \t\t}\n \n@@ -1199,7 +1195,6 @@ const _GodotAudio = {\n \n \t\t/** @type {Promise} */\n \t\taudioPositionWorkletPromise: null,\n-\t\taudioPositionWorkletPool: [],\n \n \t\t/**\n \t\t * Converts linear volume to Db.\n", "test_patch": "", "problem_statement": "Playing many audio samples causes ever increasing cpu usage in web export\n### Tested versions\n\nv4.4.beta2.official [a013481b0]\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 26100) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nIn web export of my game after playing for a while, the audio starts to crackle. I think I narrowed it down to playing lots of audio samples over time. Even thought the audio samples are short and finish quickly, the cpu usage goes up over time and does not come back down. \n\n\n### Steps to reproduce\n\nI've attached a simple project that plays 100 audio samples each time the 'play' button is pressed.\n\nExport MRP as a no-thread web app. Open in Chrome or Firefox and open the browser's task manager. \nFind WebAudioTest task and note CPU usage (starts low - a few % on my computer)\nClick the play button a bunch of times. CPU starts increasing and doesn't drop again.\nEventually CPU usage becomes so high that audio starts to crackle as well.\n\nMRP also includes a short python script to start a local server:\nD:\\...\\webaudiotest>python server.py \n\n### Minimal reproduction project (MRP)\n\n[webaudiotest.zip](https://github.com/user-attachments/files/18698995/webaudiotest.zip)\n", "hints_text": "Poked around a bit and I think the root cause it that GodotPositionReportingProcessor.process always returns true and is forced to remain active and keeps processing (no data) even after the sample has finished playing.\n\nSee comment here: https://github.com/godotengine/godot/pull/102163/files#r1945897924\n", "created_at": "2025-02-11 15:48:12", "merge_commit_sha": "66d66807ab862d602ceb7b75a11f7df65d909c99", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102677", "base_commit": "296de7da830fa03425edf544427543087817e649", "patch": "diff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 172d6e547118..6da4d24e7256 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -3299,6 +3299,8 @@ void RendererCanvasRenderRD::_prepare_batch_texture_info(RID p_texture, TextureS\n \n RendererCanvasRenderRD::~RendererCanvasRenderRD() {\n \tRendererRD::MaterialStorage *material_storage = RendererRD::MaterialStorage::get_singleton();\n+\tRendererRD::TextureStorage *texture_storage = RendererRD::TextureStorage::get_singleton();\n+\n \t//canvas state\n \n \tmaterial_storage->material_free(default_canvas_group_material);\n@@ -3346,7 +3348,9 @@ RendererCanvasRenderRD::~RendererCanvasRenderRD() {\n \t\t}\n \t}\n \n-\tRendererRD::TextureStorage::get_singleton()->canvas_texture_free(default_canvas_texture);\n+\t// Disable the callback, as we're tearing everything down\n+\ttexture_storage->canvas_texture_set_invalidation_callback(default_canvas_texture, nullptr, nullptr);\n+\ttexture_storage->canvas_texture_free(default_canvas_texture);\n \t//pipelines don't need freeing, they are all gone after shaders are gone\n \n \tmemdelete(shader.default_version_data);\n", "test_patch": "", "problem_statement": "\"Attempted to free invalid ID\" errors are printed when exiting a project run with Debug Canvas Item Redraw\n### Tested versions\n\n- Reproducible in: 4.4.beta2, 4.4.beta2\n- Not reproducible in: 4.3.stable, 4.4.beta1\n\n### System information\n\nGodot v4.4.beta (36d90c73a) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (nvidia; 565.77) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nRunning the MRP with `--debug-canvas-item-redraw` will result in the following on exit:\n\n```\nERROR: Attempted to free invalid ID: 4509715660816\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\nERROR: Attempted to free invalid ID: 4526895530004\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\nERROR: Attempted to free invalid ID: 4539780431895\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\n```\n\nThe invalid IDs are the usually same on every run (in this particular project), especially the first one. No further information about this is printed when using `--verbose`.\n\nThe feature still works correctly, so it's not a big issue but we should still aim to fix it.\n\nI've bisected this to https://github.com/godotengine/godot/pull/101931. cc @stuartcarnie \n\n### Steps to reproduce\n\n- Add a CheckButton node.\n- With the editor being run from a terminal (so you can see all errors on exit), enable **Debug > Visible Canvas Item Redraw** or run the project with `--debug-canvas-item-redraw` when using Forward+ or Mobile.\n- Exit the project and notice errors being printed in the terminal.\n\n### Minimal reproduction project (MRP)\n\n[test_debug_canvas_item_redraw.zip](https://github.com/user-attachments/files/18739163/test_debug_canvas_item_redraw.zip)\n", "hints_text": "", "created_at": "2025-02-10 21:18:34", "merge_commit_sha": "cfe0fd62d03bf58104dcda98f0db7d26326f0ba7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102627", "base_commit": "261e7d32d37445de3ef3a9804346552fdac6096e", "patch": "diff --git a/platform/android/export/export_plugin.cpp b/platform/android/export/export_plugin.cpp\nindex 578f723e700f..0f50f725258c 100644\n--- a/platform/android/export/export_plugin.cpp\n+++ b/platform/android/export/export_plugin.cpp\n@@ -55,6 +55,10 @@\n #include \"modules/modules_enabled.gen.h\" // For mono.\n #include \"modules/svg/image_loader_svg.h\"\n \n+#ifdef MODULE_MONO_ENABLED\n+#include \"modules/mono/utils/path_utils.h\"\n+#endif\n+\n #ifdef ANDROID_ENABLED\n #include \"../os_android.h\"\n #endif\n@@ -2526,6 +2530,43 @@ bool EditorExportPlatformAndroid::has_valid_username_and_password(const Ref<Edit\n \treturn valid;\n }\n \n+#ifdef MODULE_MONO_ENABLED\n+bool _validate_dotnet_tfm(const String &required_tfm, String &r_error) {\n+\tString assembly_name = path::get_csharp_project_name();\n+\tString project_path = ProjectSettings::get_singleton()->globalize_path(\"res://\" + assembly_name + \".csproj\");\n+\n+\tif (!FileAccess::exists(project_path)) {\n+\t\treturn true;\n+\t}\n+\n+\tString pipe;\n+\tList<String> args;\n+\targs.push_back(\"build\");\n+\targs.push_back(project_path);\n+\targs.push_back(\"--getProperty:TargetFramework\");\n+\n+\tint exitcode;\n+\tError err = OS::get_singleton()->execute(\"dotnet\", args, &pipe, &exitcode, true);\n+\tif (err != OK || exitcode != 0) {\n+\t\tif (err != OK) {\n+\t\t\tWARN_PRINT(\"Failed to execute dotnet command. Error \" + String(error_names[err]));\n+\t\t} else if (exitcode != 0) {\n+\t\t\tprint_line(pipe);\n+\t\t\tWARN_PRINT(\"dotnet command exited with code \" + itos(exitcode) + \". See output above for more details.\");\n+\t\t}\n+\t\tr_error += vformat(TTR(\"Unable to determine the C# project's TFM, it may be incompatible. The export template only supports '%s'. Make sure the project targets '%s' or consider using gradle builds instead.\"), required_tfm, required_tfm) + \"\\n\";\n+\t} else {\n+\t\tString tfm = pipe.strip_edges();\n+\t\tif (tfm != required_tfm) {\n+\t\t\tr_error += vformat(TTR(\"C# project targets '%s' but the export template only supports '%s'. Consider using gradle builds instead.\"), tfm, required_tfm) + \"\\n\";\n+\t\t\treturn false;\n+\t\t}\n+\t}\n+\n+\treturn true;\n+}\n+#endif\n+\n bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<EditorExportPreset> &p_preset, String &r_error, bool &r_missing_templates, bool p_debug) const {\n \tString err;\n \tbool valid = false;\n@@ -2534,6 +2575,15 @@ bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<Edito\n #ifdef MODULE_MONO_ENABLED\n \t// Android export is still a work in progress, keep a message as a warning.\n \terr += TTR(\"Exporting to Android when using C#/.NET is experimental.\") + \"\\n\";\n+\n+\tif (!gradle_build_enabled) {\n+\t\t// For template exports we only support .NET 8 because the template\n+\t\t// includes .jar dependencies that may only be compatible with .NET 8.\n+\t\tif (!_validate_dotnet_tfm(\"net8.0\", err)) {\n+\t\t\tr_error = err;\n+\t\t\treturn false;\n+\t\t}\n+\t}\n #endif\n \n \t// Look for export templates (first official, and if defined custom templates).\n", "test_patch": "", "problem_statement": "(4.4.beta1) Android app crashes when exported with .NET 9\n### Tested versions\n\n**Reproducible:**\n4.4.beta1\n4.4.dev7\n\n**Not Reproducible:**\n4.4.dev3\n\n### System information\n\nGodot v4.4.beta1.mono - Windows 10 (build 19045) - OpenGL 3 (Compatibility)\n\n### Issue description\n\nWhen exporting to Android with .NET 9 using Gradle Build via the Remote Deploy, the app crashes immediately at startup.\n\nNote:  .NET 8 works fine, but .NET 9 causes the app to crash\n\nusing the command at runtime:\n**adb logcat|grep godot**\n\n> 01-22 19:27:18.818  1895  3450 I ActivityTaskManager: START u0 {act=android.intent.action.MAIN flg=0x10000000 cmp=com.example.test_android/com.godot.game.GodotApp} from uid 2000\n01-22 19:27:18.857  1895  2224 I ActivityManager: Start proc 1876:com.example.test_android/u0a411 for next-top-activity {com.example.test_android/com.godot.game.GodotApp}\n01-22 19:27:19.885  1895  2006 W ActivityTaskManager:   Force finishing activity com.example.test_android/com.godot.game.GodotApp\n01-22 19:27:19.987  1895  2220 I GameServiceProviderInstance: Failed to remove task overlay. This is expected if the task is already destroyed: GameSessionRecord{mTaskId=306, mState=GAME_SESSION_ATTACHED, mRootComponentName=ComponentInfo{com.example.test_android/com.godot.game.GodotApp}, mIGameSession=android.service.games.IGameSession$Stub$Proxy@3a45eaa, mSurfacePackage=android.view.SurfaceControlViewHost$SurfacePackage@3504a9b}\n01-22 19:27:20.386  1895  2200 W ActivityTaskManager: Activity top resumed state loss timeout for ActivityRecord{691de90 u0 com.example.test_android/com.godot.game.GodotApp} t-1 f}}\n\n\n\n\n\n\n\n### Steps to reproduce\n\n1. Godot 4.4.beta1\n2. Create a new project\n3. Create C# script and attach to a node in the main scene\n4. Update the visual studio project to target .NET 9: \n` <TargetFramework>net9.0</TargetFramework>`\n4. Remote Deploy to Android with Gradle Build\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "This is likely because .NET 9 introduced a new Java class (`net.dot.android.crypto.DotnetX509KeyManager`) in https://github.com/dotnet/runtime/pull/103337 and we're embedding the `System.Security.Cryptography.Native.Android` jar library from .NET 8. We were hoping the Java library wouldn't change often so it would remain compatible with newer versions for a while.", "created_at": "2025-02-09 18:50:37", "merge_commit_sha": "0b9fd7e1902e8fc9e58c5a4846a1b0e8b22ac665", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102618", "base_commit": "36d90c73a843afa2807a0b8dcbfbf52bdb8a759c", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 72c87bfc1c6d..17c6ede2d248 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -40,6 +40,12 @@ void EmbeddedProcess::_notification(int p_what) {\n \t\tcase NOTIFICATION_ENTER_TREE: {\n \t\t\twindow = get_window();\n \t\t} break;\n+\t\tcase NOTIFICATION_PROCESS: {\n+\t\t\tif (updated_embedded_process_queued) {\n+\t\t\t\tupdated_embedded_process_queued = false;\n+\t\t\t\t_update_embedded_process();\n+\t\t\t}\n+\t\t} break;\n \t\tcase NOTIFICATION_DRAW: {\n \t\t\t_draw();\n \t\t} break;\n@@ -179,6 +185,7 @@ void EmbeddedProcess::embed_process(OS::ProcessID p_pid) {\n \tstart_embedding_time = OS::get_singleton()->get_ticks_msec();\n \tembedding_grab_focus = has_focus();\n \ttimer_update_embedded_process->start();\n+\tset_process(true);\n \tset_notify_transform(true);\n \n \t// Attempt to embed the process, but if it has just started and the window is not ready yet,\n@@ -196,6 +203,7 @@ void EmbeddedProcess::reset() {\n \tembedding_grab_focus = false;\n \ttimer_embedding->stop();\n \ttimer_update_embedded_process->stop();\n+\tset_process(false);\n \tset_notify_transform(false);\n \tqueue_redraw();\n }\n@@ -251,11 +259,6 @@ void EmbeddedProcess::_timer_update_embedded_process_timeout() {\n \t\t\tqueue_update_embedded_process();\n \t\t}\n \t}\n-\n-\tif (updated_embedded_process_queued) {\n-\t\tupdated_embedded_process_queued = false;\n-\t\t_update_embedded_process();\n-\t}\n }\n \n void EmbeddedProcess::_update_embedded_process() {\n", "test_patch": "", "problem_statement": "[4.4 Beta 3] Embedded game window lags when changing positions and scale.\n### Tested versions\n\n- Reproductible in: v4.4.beta3.official [06acfccf8]\n\n### System information\n\nGodot v4.4.beta3 - Fedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 (nvidia; 565.77) - AMD Ryzen 9 7900X 12-Core Processor (24 threads)\n\n### Issue description\n\nWhen embedding the game window (either on a floating workspace or on the editor \"Game\" tab) and moving the \"main\" window, the embedded window will lag behind. This did not happen in earlier versions of the engine and I don't know if it happens on Windows.\n\nBETA 2\n\nhttps://github.com/user-attachments/assets/1e1b4f09-66a6-49bb-aee1-3af18d63956d\n\n---\n\nBETA 3\n\nhttps://github.com/user-attachments/assets/c5c0705d-1ae6-49c4-82ec-fa4ead231005\n\n### Steps to reproduce\n\n- Run a project on 4.4.beta3 with `Embed game on Next Play` enabled;\n- Move / scale the main window that's holding the embedded window around.\n\n### Minimal reproduction project (MRP)\n\nNot including an MRP since this can be replicated with an empty project.\n", "hints_text": "That's a side effect of #102251.\nOn low spec machine on Windows resizing the floating window was very slow. The embedded window is now updated less frequently, causing this out of sync effect. I'll try to think of another method to fix #102251 and still keep the embedded window in sync as much as possible.", "created_at": "2025-02-09 13:46:59", "merge_commit_sha": "fa85645c1a27d61e172023bd2c6ec7c2c02e527d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102538", "base_commit": "15ff450680a40391aabbffde0a57ead2cd84db56", "patch": "diff --git a/modules/fbx/fbx_document.cpp b/modules/fbx/fbx_document.cpp\nindex d6c304d0564a..e62639ee58bd 100644\n--- a/modules/fbx/fbx_document.cpp\n+++ b/modules/fbx/fbx_document.cpp\n@@ -251,18 +251,16 @@ static bool _thread_pool_init_fn(void *user, ufbx_thread_pool_context ctx, const\n \treturn true;\n }\n \n-static bool _thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count) {\n+static void _thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count) {\n \tThreadPoolFBX *pool = (ThreadPoolFBX *)user;\n \tThreadPoolFBX::Group &pool_group = pool->groups[group];\n \tpool_group.start_index = start_index;\n \tpool_group.task_id = pool->pool->add_native_group_task(_thread_pool_task, &pool_group, (int)count, -1, true, \"ufbx\");\n-\treturn true;\n }\n \n-static bool _thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index) {\n+static void _thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index) {\n \tThreadPoolFBX *pool = (ThreadPoolFBX *)user;\n \tpool->pool->wait_for_group_task_completion(pool->groups[group].task_id);\n-\treturn true;\n }\n \n String FBXDocument::_gen_unique_name(HashSet<String> &unique_names, const String &p_name) {\ndiff --git a/thirdparty/README.md b/thirdparty/README.md\nindex 309508fc4e80..237c8fc904da 100644\n--- a/thirdparty/README.md\n+++ b/thirdparty/README.md\n@@ -976,7 +976,7 @@ Patches:\n ## ufbx\n \n - Upstream: https://github.com/ufbx/ufbx\n-- Version: 0.15.0 (24eea6f40929fe0f679b7950def378edb003afdb, 2024)\n+- Version: 0.17.1 (6ca5309972f03625e6990f3084ff4c1cc55a09b6, 2025)\n - License: MIT\n \n Files extracted from upstream source:\ndiff --git a/thirdparty/ufbx/ufbx.c b/thirdparty/ufbx/ufbx.c\nindex 77bd3dea623f..0e6f13d2f513 100644\n--- a/thirdparty/ufbx/ufbx.c\n+++ b/thirdparty/ufbx/ufbx.c\n@@ -600,7 +600,7 @@ extern \"C\" {\n \t#endif\n #endif\n \n-#if !defined(UFBX_STANDARD_C) && !defined(UFBX_NO_SSE) && (defined(_MSC_VER) && defined(_M_X64) && !defined(_M_ARM64EC)) || ((defined(__GNUC__) || defined(__clang__)) && defined(__x86_64__)) || defined(UFBX_USE_SSE)\n+#if defined(UFBX_USE_SSE) || (!defined(UFBX_STANDARD_C) && !defined(UFBX_NO_SSE) && ((defined(_MSC_VER) && defined(_M_X64) && !defined(_M_ARM64EC)) || ((defined(__GNUC__) || defined(__clang__)) && defined(__x86_64__))))\n \t#define UFBXI_HAS_SSE 1\n \t#include <xmmintrin.h>\n \t#include <emmintrin.h>\n@@ -830,7 +830,7 @@ ufbx_static_assert(sizeof_f64, sizeof(double) == 8);\n \n // -- Version\n \n-#define UFBX_SOURCE_VERSION ufbx_pack_version(0, 15, 0)\n+#define UFBX_SOURCE_VERSION ufbx_pack_version(0, 17, 1)\n ufbx_abi_data_def const uint32_t ufbx_source_version = UFBX_SOURCE_VERSION;\n \n ufbx_static_assert(source_header_version, UFBX_SOURCE_VERSION/1000u == UFBX_HEADER_VERSION/1000u);\n@@ -968,7 +968,7 @@ ufbx_static_assert(source_header_version, UFBX_SOURCE_VERSION/1000u == UFBX_HEAD\n \t#define ufbxi_regression_assert(cond) (void)0\n #endif\n \n-#if defined(UFBX_REGRESSION) || defined(UFBX_DEV)\n+#if defined(UFBX_REGRESSION) || defined(UFBX_DEV) || defined(UFBX_UBSAN)\n \t#define ufbxi_dev_assert(cond) ufbx_assert(cond)\n #else\n \t#define ufbxi_dev_assert(cond) (void)0\n@@ -1400,7 +1400,7 @@ static ufbxi_noinline void ufbxi_bigint_shift_left(ufbxi_bigint *bigint, uint32_\n \tbigint->length += words + (b.limbs[b.length - 1] >> 1 >> bits_down != 0 ? 1 : 0);\n \tb.limbs[b.length] = 0;\n \tif (b.length <= 3 && words <= 3) {\n-\t\tufbxi_bigint_limb l0 = ufbxi_maybe_uninit(b.length >= 0, b.limbs[0], ~0u);\n+\t\tufbxi_bigint_limb l0 = b.limbs[0];\n \t\tufbxi_bigint_limb l1 = ufbxi_maybe_uninit(b.length >= 1, b.limbs[1], ~0u);\n \t\tufbxi_bigint_limb l2 = ufbxi_maybe_uninit(b.length >= 2, b.limbs[2], ~0u);\n \t\tb.limbs[0] = 0;\n@@ -1491,6 +1491,7 @@ static ufbxi_noinline double ufbxi_parse_double(const char *str, size_t max_leng\n \t\t\t\tdigits = digits * 10 + (uint64_t)(c - '0');\n \t\t\t\tnum_digits++;\n \t\t\t\tif (num_digits >= 18) {\n+\t\t\t\t\tufbxi_dev_assert(num_digits < ufbxi_arraycount(ufbxi_pow5_tab));\n \t\t\t\t\tufbxi_bigint_mad(&big_mantissa, ufbxi_pow5_tab[num_digits] << num_digits, digits);\n \t\t\t\t\tdigits = 0;\n \t\t\t\t\tnum_digits = 0;\n@@ -1553,6 +1554,7 @@ static ufbxi_noinline double ufbxi_parse_double(const char *str, size_t max_leng\n \t\tbig_mantissa.length = (digits >> 32u) ? 2 : digits ? 1 : 0;\n \t\tif (big_mantissa.length == 0) return negative ? -0.0 : 0.0;\n \t} else {\n+\t\tufbxi_dev_assert(num_digits < ufbxi_arraycount(ufbxi_pow5_tab));\n \t\tufbxi_bigint_mad(&big_mantissa, ufbxi_pow5_tab[num_digits] << num_digits, digits);\n \t}\n \n@@ -6438,6 +6440,8 @@ typedef struct {\n \tbool parse_threaded;\n \tufbxi_thread_pool thread_pool;\n \n+\tuint8_t *base64_table;\n+\n } ufbxi_context;\n \n static ufbxi_noinline int ufbxi_fail_imp(ufbxi_context *uc, const char *cond, const char *func, uint32_t line)\n@@ -10009,6 +10013,66 @@ ufbxi_nodiscard static ufbxi_noinline int ufbxi_ascii_read_float_array(ufbxi_con\n \treturn 1;\n }\n \n+ufbxi_noinline static int ufbxi_setup_base64(ufbxi_context *uc)\n+{\n+\tuint8_t *table = ufbxi_push(&uc->tmp, uint8_t, 256);\n+\tufbxi_check(table);\n+\tuc->base64_table = table;\n+\n+\tmemset(table, 0x80, 256);\n+\tufbxi_nounroll for (char c = 'A'; c <= 'Z'; c++) table[(size_t)c] = (uint8_t)(c - 'A');\n+\tufbxi_nounroll for (char c = 'a'; c <= 'z'; c++) table[(size_t)c] = (uint8_t)(26 + (c - 'a'));\n+\tufbxi_nounroll for (char c = '0'; c <= '9'; c++) table[(size_t)c] = (uint8_t)(52 + (c - '0'));\n+\ttable[(size_t)'+'] = 62;\n+\ttable[(size_t)'/'] = 63;\n+\ttable[(size_t)'='] = 0x40;\n+\n+\treturn 1;\n+}\n+\n+ufbxi_noinline static int ufbxi_decode_base64(ufbxi_context *uc, ufbx_string *p_result, const char *src, size_t src_length, bool *p_failed)\n+{\n+\tif (!uc->base64_table) ufbxi_check(ufbxi_setup_base64(uc));\n+\n+\tuint8_t *table = uc->base64_table;\n+\tuint32_t error_mask = 0, pad_error = 0;\n+\n+\tchar *p = (char*)p_result->data;\n+\tfor (size_t i = 0; i + 4 <= src_length; i += 4) {\n+\t\tuint32_t a = table[(size_t)(uint8_t)src[i + 0]];\n+\t\tuint32_t b = table[(size_t)(uint8_t)src[i + 1]];\n+\t\tuint32_t c = table[(size_t)(uint8_t)src[i + 2]];\n+\t\tuint32_t d = table[(size_t)(uint8_t)src[i + 3]];\n+\t\tpad_error = error_mask;\n+\t\terror_mask |= a | b | c | d;\n+\n+\t\tp[0] = (char)(uint8_t)(a << 2 | b >> 4);\n+\t\tp[1] = (char)(uint8_t)(b << 4 | c >> 2);\n+\t\tp[2] = (char)(uint8_t)(c << 6 | d);\n+\t\tp += 3;\n+\t}\n+\n+\tif (src_length >= 4) {\n+\t\tconst char *end = src + src_length - 4;\n+\t\tuint32_t padding = 0;\n+\t\tpadding |= end[0] == '=' ? 0x8 : 0x0;\n+\t\tpadding |= end[1] == '=' ? 0x4 : 0x0;\n+\t\tpadding |= end[2] == '=' ? 0x2 : 0x0;\n+\t\tpadding |= end[3] == '=' ? 0x1 : 0x0;\n+\t\tif (padding <= 0x1) p -= padding; // \"xxx=\" or \"xxxx\"\n+\t\telse if (padding == 0x3) p -= 2;  // \"xx==\"\n+\t\telse pad_error |= 0x40;           // anything else\n+\t}\n+\n+\tif (((error_mask & 0x80) != 0 || (pad_error & 0x40) != 0 || src_length % 4 != 0) && !*p_failed) {\n+\t\tufbxi_check(ufbxi_warnf(UFBX_WARNING_BAD_BASE64_CONTENT, \"Ignored bad base64 embedded content\"));\n+\t\t*p_failed = true;\n+\t}\n+\n+\tp_result->length = ufbxi_to_size(p - p_result->data);\n+\treturn 1;\n+}\n+\n // Recursion limited by check at the start\n ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *uc, uint32_t depth, ufbxi_parse_state parent_state, bool *p_end, ufbxi_buf *tmp_buf, bool recursive)\n \tufbxi_recursive_function(int, ufbxi_ascii_parse_node, (uc, depth, parent_state, p_end, tmp_buf, recursive), UFBXI_MAX_NODE_DEPTH + 1,\n@@ -10054,6 +10118,7 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *\n \tint arr_type = 0;\n \tufbxi_buf *arr_buf = NULL;\n \tsize_t arr_elem_size = 0;\n+\tbool arr_error = false;\n \n \t// Check if the values of the node we're parsing currently should be\n \t// treated as an array.\n@@ -10134,13 +10199,16 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *\n \t\t\t\t\tbool raw = arr_type == 's';\n \t\t\t\t\tufbx_string *v = ufbxi_push(&uc->tmp_stack, ufbx_string, 1);\n \t\t\t\t\tufbxi_check(v);\n-\t\t\t\t\tv->data = tok->str_data;\n-\t\t\t\t\tv->length = tok->str_len;\n \t\t\t\t\tif (arr_type == 'C') {\n \t\t\t\t\t\tufbxi_buf *buf = uc->opts.retain_dom ? &uc->result : tmp_buf;\n-\t\t\t\t\t\tv->data = ufbxi_push_copy(buf, char, v->length, v->data);\n+\t\t\t\t\t\tsize_t capacity = tok->str_len / 4 * 3 + 3;\n+\t\t\t\t\t\tv->data = ufbxi_push(buf, char, capacity);\n \t\t\t\t\t\tufbxi_check(v->data);\n+\t\t\t\t\t\tufbxi_check(ufbxi_decode_base64(uc, v, tok->str_data, tok->str_len, &arr_error));\n+\t\t\t\t\t\tufbx_assert(v->length <= capacity);\n \t\t\t\t\t} else {\n+\t\t\t\t\t\tv->data = tok->str_data;\n+\t\t\t\t\t\tv->length = tok->str_len;\n \t\t\t\t\t\tufbxi_check(ufbxi_push_string_place_str(&uc->string_pool, v, raw));\n \t\t\t\t\t}\n \t\t\t\t} else {\n@@ -10324,6 +10392,10 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *\n \t\t\t\tif (num_values > 0) {\n \t\t\t\t\tufbxi_pop_size(&uc->tmp_stack, arr_elem_size, num_values, arr_data, false);\n \t\t\t\t}\n+\t\t\t} else if (arr_error) {\n+\t\t\t\tufbxi_pop_size(&uc->tmp_stack, arr_elem_size, num_values, NULL, false);\n+\t\t\t\tnum_values = 0;\n+\t\t\t\tarr_data = (void*)ufbxi_zero_size_buffer;\n \t\t\t} else {\n \t\t\t\tarr_data = ufbxi_push_pop_size(arr_buf, &uc->tmp_stack, arr_elem_size, num_values);\n \t\t\t}\n@@ -11454,28 +11526,6 @@ ufbxi_nodiscard static ufbxi_noinline int ufbxi_load_maps(ufbxi_context *uc)\n \n // -- Reading the parsed data\n \n-ufbxi_noinline static void ufbxi_decode_base64(char *dst, const char *src, size_t src_length)\n-{\n-\tuint8_t table[256] = { 0 };\n-\tfor (char c = 'A'; c <= 'Z'; c++) table[(size_t)c] = (uint8_t)(c - 'A');\n-\tfor (char c = 'a'; c <= 'z'; c++) table[(size_t)c] = (uint8_t)(26 + (c - 'a'));\n-\tfor (char c = '0'; c <= '9'; c++) table[(size_t)c] = (uint8_t)(52 + (c - '0'));\n-\ttable[(size_t)'+'] = 62;\n-\ttable[(size_t)'/'] = 63;\n-\n-\tfor (size_t i = 0; i + 4 <= src_length; i += 4) {\n-\t\tuint32_t a = table[(size_t)(uint8_t)src[i + 0]];\n-\t\tuint32_t b = table[(size_t)(uint8_t)src[i + 1]];\n-\t\tuint32_t c = table[(size_t)(uint8_t)src[i + 2]];\n-\t\tuint32_t d = table[(size_t)(uint8_t)src[i + 3]];\n-\n-\t\tdst[0] = (char)(uint8_t)(a << 2 | b >> 4);\n-\t\tdst[1] = (char)(uint8_t)(b << 4 | c >> 2);\n-\t\tdst[2] = (char)(uint8_t)(c << 6 | d);\n-\t\tdst += 3;\n-\t}\n-}\n-\n ufbxi_nodiscard ufbxi_noinline static int ufbxi_read_embedded_blob(ufbxi_context *uc, ufbx_blob *dst_blob, ufbxi_node *node)\n {\n \tif (!node) return 1;\n@@ -11485,15 +11535,15 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_read_embedded_blob(ufbxi_context\n \t\tufbx_string content;\n \t\tsize_t num_parts = content_arr->size;\n \t\tufbx_string *parts = (ufbx_string*)content_arr->data;\n-\t\tif (num_parts == 1) {\n+\n+\t\tif (num_parts == 1 && !uc->from_ascii) {\n \t\t\tcontent = parts[0];\n \t\t} else {\n \t\t\tsize_t total_size = 0;\n \t\t\tufbxi_for(ufbx_string, part, parts, num_parts) {\n \t\t\t\ttotal_size += part->length;\n \t\t\t}\n-\t\t\tufbxi_buf *dst_buf = uc->from_ascii ? &uc->tmp_parse : &uc->result;\n-\t\t\tchar *dst = ufbxi_push(dst_buf, char, total_size);\n+\t\t\tchar *dst = ufbxi_push(&uc->result, char, total_size);\n \t\t\tufbxi_check(dst);\n \t\t\tcontent.data = dst;\n \t\t\tcontent.length = total_size;\n@@ -11503,23 +11553,8 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_read_embedded_blob(ufbxi_context\n \t\t\t}\n \t\t}\n \n-\t\tif (uc->from_ascii) {\n-\t\t\tif (content.length % 4 == 0) {\n-\t\t\t\tsize_t padding = 0;\n-\t\t\t\twhile (padding < 2 && padding < content.length && content.data[content.length - 1 - padding] == '=') {\n-\t\t\t\t\tpadding++;\n-\t\t\t\t}\n-\n-\t\t\t\tdst_blob->size = content.length / 4 * 3 - padding;\n-\t\t\t\tdst_blob->data = ufbxi_push(&uc->result, char, dst_blob->size + 3);\n-\t\t\t\tufbxi_check(dst_blob->data);\n-\n-\t\t\t\tufbxi_decode_base64((char*)dst_blob->data, content.data, content.length);\n-\t\t\t}\n-\t\t} else {\n-\t\t\tdst_blob->data = content.data;\n-\t\t\tdst_blob->size = content.length;\n-\t\t}\n+\t\tdst_blob->data = content.data;\n+\t\tdst_blob->size = content.length;\n \t}\n \n \treturn 1;\ndiff --git a/thirdparty/ufbx/ufbx.h b/thirdparty/ufbx/ufbx.h\nindex 1fc9a103655b..8cd336fe776f 100644\n--- a/thirdparty/ufbx/ufbx.h\n+++ b/thirdparty/ufbx/ufbx.h\n@@ -267,7 +267,7 @@ struct ufbx_converter { };\n // `ufbx_source_version` contains the version of the corresponding source file.\n // HINT: The version can be compared numerically to the result of `ufbx_pack_version()`,\n // for example `#if UFBX_VERSION >= ufbx_pack_version(0, 12, 0)`.\n-#define UFBX_HEADER_VERSION ufbx_pack_version(0, 15, 0)\n+#define UFBX_HEADER_VERSION ufbx_pack_version(0, 17, 1)\n #define UFBX_VERSION UFBX_HEADER_VERSION\n \n // -- Basic types\n@@ -1354,7 +1354,7 @@ struct ufbx_mesh {\n \t// The winding of the faces has been reversed.\n \tbool reversed_winding;\n \n-\t// Normals have been generated instead of evalauted.\n+\t// Normals have been generated instead of evaluated.\n \t// Either from missing normals (via `ufbx_load_opts.generate_missing_normals`), skinning,\n \t// tessellation, or subdivision.\n \tbool generated_normals;\n@@ -1566,7 +1566,7 @@ struct ufbx_camera {\n \t// Projection mode (perspective/orthographic).\n \tufbx_projection_mode projection_mode;\n \n-\t// If set to `true`, `resolution` reprensents actual pixel values, otherwise\n+\t// If set to `true`, `resolution` represents actual pixel values, otherwise\n \t// it's only useful for its aspect ratio.\n \tbool resolution_is_pixels;\n \n@@ -3509,6 +3509,9 @@ typedef enum ufbx_warning_type UFBX_ENUM_REPR {\n \t// HINT: You can use `ufbx_unicode_error_handling` to adjust behavior.\n \tUFBX_WARNING_BAD_UNICODE,\n \n+\t// Invalid base64-encoded embedded content ignored.\n+\tUFBX_WARNING_BAD_BASE64_CONTENT,\n+\n \t// Non-node element connected to root.\n \tUFBX_WARNING_BAD_ELEMENT_CONNECTED_TO_ROOT,\n \n@@ -4085,7 +4088,8 @@ typedef struct ufbx_open_memory_opts {\n \tuint32_t _end_zero;\n } ufbx_open_memory_opts;\n \n-// Detailed error stack frame\n+// Detailed error stack frame.\n+// NOTE: You must compile `ufbx.c` with `UFBX_ENABLE_ERROR_STACK` to enable the error stack.\n typedef struct ufbx_error_frame {\n \tuint32_t source_line;\n \tufbx_string function;\n@@ -4183,30 +4187,48 @@ UFBX_ENUM_TYPE(ufbx_error_type, UFBX_ERROR_TYPE, UFBX_ERROR_DUPLICATE_OVERRIDE);\n // Error description with detailed stack trace\n // HINT: You can use `ufbx_format_error()` for formatting the error\n typedef struct ufbx_error {\n+\n+\t// Type of the error, or `UFBX_ERROR_NONE` if successful.\n \tufbx_error_type type;\n+\n+\t// Description of the error type.\n \tufbx_string description;\n+\n+\t// Internal error stack.\n+\t// NOTE: You must compile `ufbx.c` with `UFBX_ENABLE_ERROR_STACK` to enable the error stack.\n \tuint32_t stack_size;\n \tufbx_error_frame stack[UFBX_ERROR_STACK_MAX_DEPTH];\n+\n+\t// Additional error information, such as missing file filename.\n+\t// `info` is a NULL-terminated UTF-8 string containing `info_length` bytes, excluding the trailing `'\\0'`.\n \tsize_t info_length;\n \tchar info[UFBX_ERROR_INFO_LENGTH];\n+\n } ufbx_error;\n \n // -- Progress callbacks\n \n+// Loading progress information.\n typedef struct ufbx_progress {\n \tuint64_t bytes_read;\n \tuint64_t bytes_total;\n } ufbx_progress;\n \n+// Progress result returned from `ufbx_progress_fn()` callback.\n+// Determines whether ufbx should continue or abort the loading.\n typedef enum ufbx_progress_result UFBX_ENUM_REPR {\n+\n+\t// Continue loading the file.\n \tUFBX_PROGRESS_CONTINUE = 0x100,\n+\n+\t// Cancel loading and fail with `UFBX_ERROR_CANCELLED`.\n \tUFBX_PROGRESS_CANCEL = 0x200,\n \n \tUFBX_ENUM_FORCE_WIDTH(UFBX_PROGRESS_RESULT)\n } ufbx_progress_result;\n \n-// Called periodically with the current progress\n-// Return `false` to cancel further processing\n+// Called periodically with the current progress.\n+// Return `UFBX_PROGRESS_CANCEL` to cancel further processing.\n typedef ufbx_progress_result ufbx_progress_fn(void *user, const ufbx_progress *progress);\n \n typedef struct ufbx_progress_cb {\n@@ -4509,33 +4531,71 @@ typedef struct ufbx_baked_anim {\n } ufbx_baked_anim;\n \n // -- Thread API\n-//\n-// NOTE: This API is still experimental and may change.\n-// Documentation is currently missing on purpose.\n \n+// Internal thread pool handle.\n+// Passed to `ufbx_thread_pool_run_task()` from an user thread to run ufbx tasks.\n+// HINT: This context can store a user pointer via `ufbx_thread_pool_set_user_ptr()`.\n typedef uintptr_t ufbx_thread_pool_context;\n \n+// Thread pool creation information from ufbx.\n typedef struct ufbx_thread_pool_info {\n \tuint32_t max_concurrent_tasks;\n } ufbx_thread_pool_info;\n \n+// Initialize the thread pool.\n+// Return `true` on success.\n typedef bool ufbx_thread_pool_init_fn(void *user, ufbx_thread_pool_context ctx, const ufbx_thread_pool_info *info);\n-typedef bool ufbx_thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count);\n-typedef bool ufbx_thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index);\n+\n+// Run tasks `count` tasks in threads.\n+// You must call `ufbx_thread_pool_run_task()` with indices `[start_index, start_index + count)`.\n+// The threads are launched in batches indicated by `group`, see `UFBX_THREAD_GROUP_COUNT` for more information.\n+// Ideally, you should run all the task indices in parallel within each `ufbx_thread_pool_run_fn()` call.\n+typedef void ufbx_thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count);\n+\n+// Wait for previous tasks spawned in `ufbx_thread_pool_run_fn()` to finish.\n+// `group` specifies the batch to wait for, `max_index` contains `start_index + count` from that group instance.\n+typedef void ufbx_thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index);\n+\n+// Free the thread pool.\n typedef void ufbx_thread_pool_free_fn(void *user, ufbx_thread_pool_context ctx);\n \n+// Thread pool interface.\n+// See functions above for more information.\n+//\n+// Hypothetical example of calls, where `UFBX_THREAD_GROUP_COUNT=2` for simplicity:\n+//\n+//   run_fn(group=0, start_index=0, count=4)   -> t0 := threaded { ufbx_thread_pool_run_task(0..3) }\n+//   run_fn(group=1, start_index=4, count=10)  -> t1 := threaded { ufbx_thread_pool_run_task(4..10) }\n+//   wait_fn(group=0, max_index=4)             -> wait_threads(t0)\n+//   run_fn(group=0, start_index=10, count=15) -> t0 := threaded { ufbx_thread_pool_run_task(10..14) }\n+//   wait_fn(group=1, max_index=10)            -> wait_threads(t1)\n+//   wait_fn(group=0, max_index=15)            -> wait_threads(t0)\n+//\n typedef struct ufbx_thread_pool {\n-\tufbx_thread_pool_init_fn *init_fn;\n-\tufbx_thread_pool_run_fn *run_fn;\n-\tufbx_thread_pool_wait_fn *wait_fn;\n-\tufbx_thread_pool_free_fn *free_fn;\n+\tufbx_thread_pool_init_fn *init_fn; // < Optional\n+\tufbx_thread_pool_run_fn *run_fn;   // < Required\n+\tufbx_thread_pool_wait_fn *wait_fn; // < Required\n+\tufbx_thread_pool_free_fn *free_fn; // < Optional\n \tvoid *user;\n } ufbx_thread_pool;\n \n+// Thread pool options.\n typedef struct ufbx_thread_opts {\n+\n+\t// Thread pool interface.\n+\t// HINT: You can use `extra/ufbx_os.h` to provide a thread pool.\n \tufbx_thread_pool pool;\n+\n+\t// Maximum of tasks to have in-flight.\n+\t// Default: 2048\n \tsize_t num_tasks;\n+\n+\t// Maximum amount of memory to use for batched threaded processing.\n+\t// Default: 32MB\n+\t// NOTE: The actual used memory usage might be higher, if there are individual tasks\n+\t// that rqeuire a high amount of memory.\n \tsize_t memory_limit;\n+\n } ufbx_thread_opts;\n \n // -- Main API\n@@ -5202,7 +5262,7 @@ ufbx_abi ufbx_string ufbx_find_string(const ufbx_props *props, const char *name,\n ufbx_abi ufbx_blob ufbx_find_blob_len(const ufbx_props *props, const char *name, size_t name_len, ufbx_blob def);\n ufbx_abi ufbx_blob ufbx_find_blob(const ufbx_props *props, const char *name, ufbx_blob def);\n \n-// Find property in `props` with concatendated `parts[num_parts]`.\n+// Find property in `props` with concatenated `parts[num_parts]`.\n ufbx_abi ufbx_prop *ufbx_find_prop_concat(const ufbx_props *props, const ufbx_string *parts, size_t num_parts);\n \n // Get an element connected to a property.\n", "test_patch": "", "problem_statement": "Fix FBX ASCII files that have embedded textures with ufbx update\n### Tested versions\n\n- Reproducable in https://github.com/godotengine/godot/commit/394508d26dcf1b7a9362453f9009c07d969f1a7e\n\n### System information\n\nGodot v4.4.beta unknown - macOS Sequoia (15.3.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 Pro (Apple8) - Apple M2 Pro (12 threads)\n\n### Issue description\n\nUpdate from upstream ufbx developer @bqqbarbhg \n\ncommit 963b87ec4390fcae35f2bb197216fddd5b8eccf2 tag v0.17.0 fixes an actual (but quite rare) issue with FBX ASCII files that have embedded textures\n\nThe task is to update the ufbx library in Godot which is a copy, paste and update legal information.\n\n### Steps to reproduce\n\n- Download case from https://github.com/ufbx/ufbx/issues/177\n- Import with ufbx\n- Does not match expectations\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/drywolf/ufbx_base64_decode_bugfix\n\n", "hints_text": "", "created_at": "2025-02-07 16:06:47", "merge_commit_sha": "d7c9c3a5f6f6aed6c5d10fc3854244d939286169", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102530", "base_commit": "3f56b3b23916ff54a1715cb8444304ce3c50283d", "patch": "diff --git a/editor/debugger/script_editor_debugger.cpp b/editor/debugger/script_editor_debugger.cpp\nindex 1363fca3c2c9..c4242f7dff60 100644\n--- a/editor/debugger/script_editor_debugger.cpp\n+++ b/editor/debugger/script_editor_debugger.cpp\n@@ -543,7 +543,7 @@ void ScriptEditorDebugger::_parse_message(const String &p_msg, uint64_t p_thread\n \t\ttime_vals.push_back(oe.sec);\n \t\ttime_vals.push_back(oe.msec);\n \t\tbool e;\n-\t\tString time = String(\"%d:%02d:%02d:%04d\").sprintf(time_vals, &e);\n+\t\tString time = String(\"%d:%02d:%02d:%03d\").sprintf(time_vals, &e);\n \n \t\t// Rest of the error data.\n \t\tbool source_is_project_file = oe.source_file.begins_with(\"res://\");\n", "test_patch": "", "problem_statement": "push_warning/error show a leading 0 in the timestamp for the milliseconds\n### Tested versions\n\n- v4.4.beta.gentoo [a013481b0]\n\n### System information\n\nLinux Gentoo Wayland\n\n### Issue description\n\nI was doing some good-ol' push_warning() debugging of my project and I was getting confused why some warnings were suddenly delayed by 900 msec. As it turns out, the Editor prints an additional zero when printing the timestamp.\n\nObserved behaviour:\n```\nW 0:00:00:0990   main.gd:10 @ ticker(): TICK 37\nW 0:00:01:0007   main.gd:10 @ ticker(): TICK 38\n```\n\nExpected behaviour:\n```\nW 0:00:00:990   main.gd:10 @ ticker(): TICK 37\nW 0:00:01:007   main.gd:10 @ ticker(): TICK 38\n```\n\nThe most likely culprit for this is in : `ScriptEditorDebugger::_parse_message` with the offending line being `String time = String(\"%d:%02d:%02d:%04d\").sprintf(time_vals, &e);`\n\n\n### Steps to reproduce\n\nDo a bunch of push_warnings and/or push_errors and observe the millisecond field in the timestamp.\n\n### Minimal reproduction project (MRP)\n\n* Create a new scene\n* Attach the following script and run the scene\n\n```gdscript\nextends Node\n\nfunc _ready() -> void:\n\tticker()\n\nfunc ticker() -> void:\n\tfor i in range(1, 100):\n\t\tpush_warning('TICK ', i)\n\t\tpush_error('TICK ', i)\n\t\tawait get_tree().physics_frame\n\n\tget_tree().quit()\n```\n", "hints_text": "This is also present in all previous 4.x versions, introduced in:\n* https://github.com/godotengine/godot/pull/36244\n\nBack before 4.0\n\nSimple to solve by returning to the previous format of `\"%d:%02d:%02d:%03d\"`", "created_at": "2025-02-07 13:04:26", "merge_commit_sha": "fc8ec5a4cabd786b425ec48eb17e699b2ae83144", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102513", "base_commit": "36d90c73a843afa2807a0b8dcbfbf52bdb8a759c", "patch": "diff --git a/core/io/resource_uid.cpp b/core/io/resource_uid.cpp\nindex 8a8c86087d45..a73adf9d7478 100644\n--- a/core/io/resource_uid.cpp\n+++ b/core/io/resource_uid.cpp\n@@ -154,6 +154,19 @@ String ResourceUID::get_id_path(ID p_id) const {\n \tERR_FAIL_COND_V_MSG(p_id == INVALID_ID, String(), \"Invalid UID.\");\n \tMutexLock l(mutex);\n \tconst ResourceUID::Cache *cache = unique_ids.getptr(p_id);\n+\n+#if TOOLS_ENABLED\n+\t// On startup, the scan_for_uid_on_startup callback should be set and will\n+\t// execute EditorFileSystem::scan_for_uid, which scans all project files\n+\t// to reload the UID cache before the first scan.\n+\t// Note: EditorFileSystem::scan_for_uid sets scan_for_uid_on_startup to nullptr\n+\t//       once the first scan_for_uid is complete.\n+\tif (!cache && scan_for_uid_on_startup) {\n+\t\tscan_for_uid_on_startup();\n+\t\tcache = unique_ids.getptr(p_id);\n+\t}\n+#endif\n+\n \tERR_FAIL_COND_V_MSG(!cache, String(), vformat(\"Unrecognized UID: \\\"%s\\\".\", id_to_text(p_id)));\n \tconst CharString &cs = cache->cs;\n \treturn String::utf8(cs.ptr());\ndiff --git a/core/io/resource_uid.h b/core/io/resource_uid.h\nindex 6d96953fcc1d..2912168dcb4b 100644\n--- a/core/io/resource_uid.h\n+++ b/core/io/resource_uid.h\n@@ -37,6 +37,8 @@\n \n class FileAccess;\n \n+typedef void (*ResourceUIDScanForUIDOnStartup)();\n+\n class ResourceUID : public Object {\n \tGDCLASS(ResourceUID, Object)\n public:\n@@ -63,6 +65,8 @@ class ResourceUID : public Object {\n \tstatic void _bind_methods();\n \n public:\n+\tinline static ResourceUIDScanForUIDOnStartup scan_for_uid_on_startup = nullptr;\n+\n \tString id_to_text(ID p_id) const;\n \tID text_to_id(const String &p_text) const;\n \ndiff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex 2d10e4305eaa..4c5663c3b99f 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -48,6 +48,9 @@\n #include \"scene/resources/packed_scene.h\"\n \n EditorFileSystem *EditorFileSystem::singleton = nullptr;\n+int EditorFileSystem::nb_files_total = 0;\n+EditorFileSystem::ScannedDirectory *EditorFileSystem::first_scan_root_dir = nullptr;\n+\n //the name is the version, to keep compatibility with different versions of Godot\n #define CACHE_FILE_NAME \"filesystem_cache10\"\n \n@@ -237,16 +240,72 @@ EditorFileSystem::ScannedDirectory::~ScannedDirectory() {\n \t}\n }\n \n-void EditorFileSystem::_first_scan_filesystem() {\n-\tEditorProgress ep = EditorProgress(\"first_scan_filesystem\", TTR(\"Project initialization\"), 5);\n+void EditorFileSystem::_load_first_scan_root_dir() {\n \tRef<DirAccess> d = DirAccess::create(DirAccess::ACCESS_RESOURCES);\n \tfirst_scan_root_dir = memnew(ScannedDirectory);\n \tfirst_scan_root_dir->full_path = \"res://\";\n+\n+\tnb_files_total = _scan_new_dir(first_scan_root_dir, d);\n+}\n+\n+void EditorFileSystem::scan_for_uid() {\n+\t// Load file structure into memory.\n+\t_load_first_scan_root_dir();\n+\n+\t// Load extensions for which an .import should exists.\n+\tList<String> extensionsl;\n+\tHashSet<String> import_extensions;\n+\tResourceFormatImporter::get_singleton()->get_recognized_extensions(&extensionsl);\n+\tfor (const String &E : extensionsl) {\n+\t\timport_extensions.insert(E);\n+\t}\n+\n+\t// Scan the file system to load uid.\n+\t_scan_for_uid_directory(first_scan_root_dir, import_extensions);\n+\n+\t// It's done, resetting the callback method to prevent a second scan.\n+\tResourceUID::scan_for_uid_on_startup = nullptr;\n+}\n+\n+void EditorFileSystem::_scan_for_uid_directory(const ScannedDirectory *p_scan_dir, const HashSet<String> &p_import_extensions) {\n+\tfor (ScannedDirectory *scan_sub_dir : p_scan_dir->subdirs) {\n+\t\t_scan_for_uid_directory(scan_sub_dir, p_import_extensions);\n+\t}\n+\n+\tfor (const String &scan_file : p_scan_dir->files) {\n+\t\tconst String ext = scan_file.get_extension().to_lower();\n+\n+\t\tif (ext == \"uid\" || ext == \"import\") {\n+\t\t\tcontinue;\n+\t\t}\n+\n+\t\tconst String path = p_scan_dir->full_path.path_join(scan_file);\n+\t\tResourceUID::ID uid = ResourceUID::INVALID_ID;\n+\t\tif (p_import_extensions.has(ext)) {\n+\t\t\tif (FileAccess::exists(path + \".import\")) {\n+\t\t\t\tuid = ResourceFormatImporter::get_singleton()->get_resource_uid(path);\n+\t\t\t}\n+\t\t} else {\n+\t\t\tuid = ResourceLoader::get_resource_uid(path);\n+\t\t}\n+\n+\t\tif (uid != ResourceUID::INVALID_ID) {\n+\t\t\tif (!ResourceUID::get_singleton()->has_id(uid)) {\n+\t\t\t\tResourceUID::get_singleton()->add_id(uid, path);\n+\t\t\t}\n+\t\t}\n+\t}\n+}\n+\n+void EditorFileSystem::_first_scan_filesystem() {\n+\tEditorProgress ep = EditorProgress(\"first_scan_filesystem\", TTR(\"Project initialization\"), 5);\n \tHashSet<String> existing_class_names;\n \tHashSet<String> extensions;\n \n-\tep.step(TTR(\"Scanning file structure...\"), 0, true);\n-\tnb_files_total = _scan_new_dir(first_scan_root_dir, d);\n+\tif (!first_scan_root_dir) {\n+\t\tep.step(TTR(\"Scanning file structure...\"), 0, true);\n+\t\t_load_first_scan_root_dir();\n+\t}\n \n \t// Preloading GDExtensions file extensions to prevent looping on all the resource loaders\n \t// for each files in _first_scan_process_scripts.\n@@ -440,6 +499,7 @@ void EditorFileSystem::_scan_filesystem() {\n \t\tsd = first_scan_root_dir;\n \t\t// Will be updated on scan.\n \t\tResourceUID::get_singleton()->clear();\n+\t\tResourceUID::scan_for_uid_on_startup = nullptr;\n \t\tprocessed_files = memnew(HashSet<String>());\n \t} else {\n \t\tRef<DirAccess> d = DirAccess::create(DirAccess::ACCESS_RESOURCES);\ndiff --git a/editor/editor_file_system.h b/editor/editor_file_system.h\nindex 5b78b86a3f3f..4f9302e045f8 100644\n--- a/editor/editor_file_system.h\n+++ b/editor/editor_file_system.h\n@@ -182,7 +182,7 @@ class EditorFileSystem : public Node {\n \tstatic void _thread_func(void *_userdata);\n \n \tEditorFileSystemDirectory *new_filesystem = nullptr;\n-\tScannedDirectory *first_scan_root_dir = nullptr;\n+\tstatic ScannedDirectory *first_scan_root_dir;\n \n \tbool filesystem_changed_queued = false;\n \tbool scanning = false;\n@@ -192,13 +192,17 @@ class EditorFileSystem : public Node {\n \tfloat scan_total;\n \tString filesystem_settings_version_for_import;\n \tbool revalidate_import_files = false;\n-\tint nb_files_total = 0;\n+\tstatic int nb_files_total;\n \n \tvoid _notify_filesystem_changed();\n \tvoid _scan_filesystem();\n \tvoid _first_scan_filesystem();\n \tvoid _first_scan_process_scripts(const ScannedDirectory *p_scan_dir, List<String> &p_gdextension_extensions, HashSet<String> &p_existing_class_names, HashSet<String> &p_extensions);\n \n+\tstatic void _scan_for_uid_directory(const ScannedDirectory *p_scan_dir, const HashSet<String> &p_import_extensions);\n+\n+\tstatic void _load_first_scan_root_dir();\n+\n \tHashSet<String> late_update_files;\n \n \tvoid _save_late_updated_files();\n@@ -255,7 +259,7 @@ class EditorFileSystem : public Node {\n \tHashSet<String> valid_extensions;\n \tHashSet<String> import_extensions;\n \n-\tint _scan_new_dir(ScannedDirectory *p_dir, Ref<DirAccess> &da);\n+\tstatic int _scan_new_dir(ScannedDirectory *p_dir, Ref<DirAccess> &da);\n \tvoid _process_file_system(const ScannedDirectory *p_scan_dir, EditorFileSystemDirectory *p_dir, ScanProgress &p_progress, HashSet<String> *p_processed_files);\n \n \tThread thread_sources;\n@@ -412,6 +416,8 @@ class EditorFileSystem : public Node {\n \n \tstatic bool _should_skip_directory(const String &p_path);\n \n+\tstatic void scan_for_uid();\n+\n \tvoid add_import_format_support_query(Ref<EditorFileSystemImportFormatSupportQuery> p_query);\n \tvoid remove_import_format_support_query(Ref<EditorFileSystemImportFormatSupportQuery> p_query);\n \tEditorFileSystem();\ndiff --git a/main/main.cpp b/main/main.cpp\nindex c65e6ba8acb4..6cd9c89fa8b7 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -3444,6 +3444,17 @@ Error Main::setup2(bool p_show_boot_logo) {\n \t// This loads global classes, so it must happen before custom loaders and savers are registered\n \tScriptServer::init_languages();\n \n+#if TOOLS_ENABLED\n+\n+\t// Setting up the callback to execute a scan for UIDs on disk when a UID\n+\t// does not exist in the UID cache on startup. This prevents invalid UID errors\n+\t// when opening a project without a UID cache file or with an invalid cache.\n+\tif (editor) {\n+\t\tResourceUID::scan_for_uid_on_startup = EditorFileSystem::scan_for_uid;\n+\t}\n+\n+#endif\n+\n \ttheme_db->initialize_theme();\n \taudio_server->load_default_bus_layout();\n \n@@ -3496,9 +3507,21 @@ void Main::setup_boot_logo() {\n \n \tif (show_logo) { //boot logo!\n \t\tconst bool boot_logo_image = GLOBAL_DEF_BASIC(\"application/boot_splash/show_image\", true);\n-\t\tconst String boot_logo_path = ResourceUID::ensure_path(GLOBAL_DEF_BASIC(PropertyInfo(Variant::STRING, \"application/boot_splash/image\", PROPERTY_HINT_FILE, \"*.png\"), String())).strip_edges();\n \t\tconst bool boot_logo_scale = GLOBAL_DEF_BASIC(\"application/boot_splash/fullsize\", true);\n \t\tconst bool boot_logo_filter = GLOBAL_DEF_BASIC(\"application/boot_splash/use_filter\", true);\n+\t\tString boot_logo_path = GLOBAL_DEF_BASIC(PropertyInfo(Variant::STRING, \"application/boot_splash/image\", PROPERTY_HINT_FILE, \"*.png\"), String());\n+\n+\t\t// If the UID cache is missing or invalid, it could be 'normal' for the UID to not exist in memory.\n+\t\t// It's too soon to scan the project files since the ResourceFormatImporter is not loaded yet,\n+\t\t// so to prevent printing errors, we will just skip the custom boot logo this time.\n+\t\tif (boot_logo_path.begins_with(\"uid://\")) {\n+\t\t\tconst ResourceUID::ID logo_id = ResourceUID::get_singleton()->text_to_id(boot_logo_path);\n+\t\t\tif (ResourceUID::get_singleton()->has_id(logo_id)) {\n+\t\t\t\tboot_logo_path = ResourceUID::get_singleton()->get_id_path(logo_id).strip_edges();\n+\t\t\t} else {\n+\t\t\t\tboot_logo_path = String();\n+\t\t\t}\n+\t\t}\n \n \t\tRef<Image> boot_logo;\n \n@@ -4215,7 +4238,7 @@ int Main::start() {\n \n #ifdef TOOLS_ENABLED\n \t\t\tif (editor) {\n-\t\t\t\tif (!recovery_mode && (game_path != String(GLOBAL_GET(\"application/run/main_scene\")) || !editor_node->has_scenes_in_session())) {\n+\t\t\t\tif (!recovery_mode && (game_path != ResourceUID::ensure_path(String(GLOBAL_GET(\"application/run/main_scene\"))) || !editor_node->has_scenes_in_session())) {\n \t\t\t\t\tError serr = editor_node->load_scene(local_game_path);\n \t\t\t\t\tif (serr != OK) {\n \t\t\t\t\t\tERR_PRINT(\"Failed to load scene\");\n", "test_patch": "", "problem_statement": "[4.4.dev7] The `Default Environment` setting is reset after the \"cold\" project loading (`res://` | `uid://` issue)\n### Tested versions\n\n- reproducible in 4.4.dev7 (maybe 4.4.x)\n- not reproducible: 4.3.stable\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6636) - 12th Gen Intel(R) Core(TM) i5-12400 (12 threads)\n\n### Issue description\n\nThe default environment setting (`rendering/environment/defaults/default_environment`) is reset after the **\"cold\"** project loading (deleting the `.godot` folder and loading project for the first time). However, it stays on place if it was saved as `res://...` path, not as `uid://...` value. Seems like `uid` related bug.\n\n### Steps to reproduce\n\nSteps for 4.4.dev7: \n- create new project;\n- create an `Environment` asset;\n- set it as default in `Project Settings`;\n- close the project;\n- delete the `.godot` folder;\n- open the project.\n\nNot reproduced with 4.3 -> 4.4 migration because its value will still be saved as `res://`, not `uid://`.\n\n### Minimal reproduction project (MRP)\n\n[test.zip](https://github.com/user-attachments/files/18270863/test.zip)\n\n", "hints_text": "Seems like the `Main Scene` (`run/main_scene`) setting has a similar issue: Godot will not open the `Main Scene` after the \"cold\" loading if it is saved as `uid://` value, but open perfectly fine if it is saved as `res://`. Shoud I create a separate issue for that? Pretty sure it is the same, but in theory can require a fix in several places.\nP.S.: The `Main Scene` setting is automatically replaced with `uid` after manually changing it to `res`.\nThis maybe due to running scan of filesystem after loading environment and main scene, or something like what. Needs investigating\nThe environment is loaded in SceneTree constructor, which happens before any filesystem scan that could load the UID. And interestingly, the code deletes the settting if file can't be found.\nhttps://github.com/godotengine/godot/blob/9630d4e2fc1d0fdef6f46f24e236548549f31d49/scene/main/scene_tree.cpp#L1970-L1984\nAfter analyzing the problem further, I have identified a few related issues and concerns:\n\n1. Before the first scan, the only source to link a UID to a path is the UID cache, which presents several issues:\n   - CI/CD will not function properly without the cache file being included in source control.\n   - If a file is moved outside the editor (e.g., due to a Git pull while the editor is closed), the correct paths will not be available when the editor starts.\n   - Any attempt to access a UID before the first scan will fail.\n\n2. There is a missing `ResourceUID::ensure_path(` call in the comparison within `main.cpp`:\n   The line `game_path != String(GLOBAL_GET(\"application/run/main_scene\"))` should include this call to ensure the UID is converted in the same way as when `game_path` is initialized.\n\nI seriously believe that the only way to ensure the UID cache is up to date is to reload the UID files before the first call to `ResourceUID::path_to_uid`. One possible solution is to make `EditorFileSystem::_scan_new_dir` a static method and invoke it in `main.cpp`. By storing the `ScannedDirectory`, we could reuse it in `EditorFileSystem::_first_scan_filesystem`, thus preventing a double scan. \n\nHowever, the main challenge with this approach is that it will be difficult to display a progress bar during the first scan, as the main window is created after the initial call to `ResourceUID::path_to_uid`. Maybe creating a temporaire small loading window could be an idea.\nAfter a bit more investigating, this approach will not work perfectly. The main issue is the possibility to have custom `ResourceLoader` with custom `get_resource_uid` methods from plugins and GDExtensions. I guess it would be difficult to load these plugins sooner in the editor startup. So the best approach should probably be to refactor the code the load the resource after the `EditorFileSystem` first scan when in the Editor. It's just very difficult to find every places the access `ResourceUid` before the first scan.", "created_at": "2025-02-07 03:06:27", "merge_commit_sha": "94b7399176c0ed4b07c65b49ff5bad6bd76b3781", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102454", "base_commit": "c394eaa45c8ed3b343fb5126b5381a659cfb6564", "patch": "diff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9716a42c97b9..055fcbeda64f 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -721,7 +721,6 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t_check_transfer_worker_buffer(buffer);\n \n \tBufferGetDataRequest get_data_request;\n-\tuint32_t flushed_copies = 0;\n \tget_data_request.callback = p_callback;\n \tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n \tget_data_request.size = p_size;\n@@ -738,22 +737,26 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\treturn err;\n \t\t}\n \n-\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n+\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\tif (flush_frames) {\n \t\t\tif (_buffer_make_mutable(buffer, p_buffer)) {\n \t\t\t\t// The buffer must be mutable to be used as a copy source.\n \t\t\t\tdraw_graph.add_synchronization();\n \t\t\t}\n \n-\t\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t\t}\n-\n-\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t}\n \n \t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\tif (flush_frames) {\n+\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n+\t\t}\n+\n \t\tRDD::BufferCopyRegion region;\n \t\tregion.src_offset = submit_from + p_offset;\n \t\tregion.dst_offset = block_write_offset;\n@@ -775,7 +778,7 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\tdraw_graph.add_synchronization();\n \t\t}\n \n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t}\n@@ -2098,7 +2101,6 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \tuint32_t block_write_offset;\n \tuint32_t block_write_amount;\n \tStagingRequiredAction required_action;\n-\tuint32_t flushed_copies = 0;\n \tfor (uint32_t i = 0; i < tex->mipmaps; i++) {\n \t\tuint32_t image_total = get_image_format_required_size(tex->format, tex->width, tex->height, tex->depth, i + 1, &w, &h, &d);\n \t\tuint32_t tight_mip_size = image_total - mipmap_offset;\n@@ -2119,17 +2121,21 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t\t\t\t\tError err = _staging_buffer_allocate(download_staging_buffers, to_allocate, required_align, block_write_offset, block_write_amount, required_action, false);\n \t\t\t\t\tERR_FAIL_COND_V(err, ERR_CANT_CREATE);\n \n-\t\t\t\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n-\t\t\t\t\t\tfor (uint32_t j = flushed_copies; j < get_data_request.frame_local_count; j++) {\n+\t\t\t\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tfor (uint32_t j = 0; j < get_data_request.frame_local_count; j++) {\n \t\t\t\t\t\t\tuint32_t local_index = get_data_request.frame_local_index + j;\n \t\t\t\t\t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t\t\t\t}\n \n \t\t\t\t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\t\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_texture_copy_regions.size();\n+\t\t\t\t\t}\n+\n \t\t\t\t\tRDD::BufferTextureCopyRegion copy_region;\n \t\t\t\t\tcopy_region.buffer_offset = block_write_offset;\n \t\t\t\t\tcopy_region.texture_subresources.aspect = tex->read_aspect_flags;\n@@ -2154,12 +2160,11 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t}\n \n \tif (get_data_request.frame_local_count > 0) {\n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t}\n \n-\t\tflushed_copies = get_data_request.frame_local_count;\n \t\tframes[frame].download_texture_get_data_requests.push_back(get_data_request);\n \t}\n \n", "test_patch": "", "problem_statement": "Editor crashes when callback for `RD::texture_get_data_async` is an empty method\n\n\n### Tested versions\n\n- Reproducable in 4.4-beta2, 4.4-beta1, 4.4-dev7\n\n(All versions with [#100110](https://github.com/godotengine/godot/pull/100110))\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 22631) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6094) - 12th Gen Intel(R) Core(TM) i5-12400F (12 threads)\n\n### Issue description\n\nWhen calling `RD::texture_get_data_async` from a tool script on every process and passing a callback to an empty method the Editor crashes after about 5 seconds.\n\n```\nERROR: FATAL: Index p_index = 8278 is out of bounds (count = 82).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nCrashHandlerException: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta2.official (a013481b0911e59cc3f3dea7ebb732450c3e1460)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n\n(no backtrace.. same with --verbose)\n```\n\nRunning the game does not trigger the crash. It only seems to be happening in the editor.\n\nHaving something happen in the callback also doesn't seem to trigger the crash or perhaps delays it to great extend. I doubt that the empty callback is the root cause. It probably just triggers whatever is wrong with using it in the editor faster. Though, I'm speculating here.\n\nIf this wasn't intended to work in the editor, there should be a guard.\n\n### Steps to reproduce\n\n- Uncommennt `@tool` at the top of node.gd\n- save\n- reopen the scene\n- switch to 2D\n- wait for about 5s\n\nAlso try uncommenting the print statement in the callback. That seems to stop the crash.\n\n### Minimal reproduction project (MRP)\n\n[texture-get-data-async-empty-callback-editor-crash.zip](https://github.com/user-attachments/files/18656439/texture-get-data-async-empty-callback-editor-crash.zip)\n", "hints_text": "Also crashes on my Linux install.\n\n\nGodot v4.4.beta2 - Debian GNU/Linux 12 (bookworm) 12 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) UHD Graphics 620 (WHL GT2) - Intel(R) Core(TM) i5-8365U CPU @ 1.60GHz (8 threads)\n\n```\nERROR: FATAL: Index p_index = 8469 is out of bounds (count = 171).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nhandle_crash: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta2.official (a013481b0911e59cc3f3dea7ebb732450c3e1460)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] /lib/x86_64-linux-gnu/libc.so.6(+0x3c050) [0x7f152fc99050] (??:0)\n[2] /home/henry/godot44.x86_64() [0x3d88fb6] (??:0)\n[3] /home/henry/godot44.x86_64() [0x3e14b80] (??:0)\n[4] /home/henry/godot44.x86_64() [0xb822bf] (??:0)\n[5] /home/henry/godot44.x86_64() [0xa087e6] (??:0)\n[6] /home/henry/godot44.x86_64() [0x28a33ba] (??:0)\n[7] /home/henry/godot44.x86_64() [0x4735d08] (??:0)\n[8] /home/henry/godot44.x86_64() [0x28b42ac] (??:0)\n[9] /home/henry/godot44.x86_64() [0x29032a3] (??:0)\n[10] /home/henry/godot44.x86_64() [0x29038c9] (??:0)\n[11] /home/henry/godot44.x86_64() [0x50ea5d] (??:0)\n[12] /home/henry/godot44.x86_64() [0x4208c3] (??:0)\n[13] /lib/x86_64-linux-gnu/libc.so.6(+0x2724a) [0x7f152fc8424a] (??:0)\n[14] /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x85) [0x7f152fc84305] (??:0)\n[15] /home/henry/godot44.x86_64() [0x44359a] (??:0)\n-- END OF BACKTRACE --\n================================================================\n```\nConfirmed in the current `master` branch (eee39f004b42a4948af90cdebedf65c34a4a4970). Backtrace:\n```\nERROR: FATAL: Index p_index = 8304 is out of bounds (count = 56).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nhandle_crash: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta.custom_build (eee39f004b42a4948af90cdebedf65c34a4a4970)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] /lib64/libc.so.6(+0x1a050) [0x7f7351eaf050] (??:0)\n[2] LocalVector<RenderingDeviceDriver::BufferTextureCopyRegion, unsigned int, false, false>::operator[](unsigned int) (/home/akien/Godot/godot/./core/templates/local_vector.h:178 (discriminator 2))\n[3] RenderingDevice::texture_get_data_async(RID, unsigned int, Callable const&) (/home/akien/Godot/godot/./servers/rendering/rendering_device.cpp:2159 (discriminator 1))\n[4] void call_with_validated_variant_args_ret_helper<__UnexistingClass, Error, RID, unsigned int, Callable const&, 0ul, 1ul, 2ul>(__UnexistingClass*, Error (__UnexistingClass::*)(RID, unsigned int, Callable const&), Variant const**, Variant*, IndexSequence<0ul, 1ul, 2ul>) (/home/akien/Godot/godot/./core/variant/binder_common.h:386 (discriminator 3))\n[5] void call_with_validated_object_instance_args_ret<__UnexistingClass, Error, RID, unsigned int, Callable const&>(__UnexistingClass*, Error (__UnexistingClass::*)(RID, unsigned int, Callable const&), Variant const**, Variant*) (/home/akien/Godot/godot/./core/variant/binder_common.h:674)\n[6] MethodBindTR<Error, RID, unsigned int, Callable const&>::validated_call(Object*, Variant const**, Variant*) const (/home/akien/Godot/godot/./core/object/method_bind.h:538)\n[7] GDScriptFunction::call(GDScriptInstance*, Variant const**, int, Callable::CallError&, GDScriptFunction::CallState*) (/home/akien/Godot/godot/./modules/gdscript/gdscript_vm.cpp:2247)\n[8] GDScriptInstance::callp(StringName const&, Variant const**, int, Callable::CallError&) (/home/akien/Godot/godot/./modules/gdscript/gdscript.cpp:2073 (discriminator 1))\n[9] Node::_gdvirtual__process_call(double) (/home/akien/Godot/godot/./scene/main/node.h:387 (discriminator 2))\n[10] Node::_notification(int) (/home/akien/Godot/godot/./scene/main/node.cpp:56)\n[11] Node::_notificationv(int, bool) (/home/akien/Godot/godot/./scene/main/node.h:49 (discriminator 14))\n[12] Object::notification(int, bool) (/home/akien/Godot/godot/./core/object/object.cpp:914)\n[13] SceneTree::_process_group(SceneTree::ProcessGroup*, bool) (/home/akien/Godot/godot/./scene/main/scene_tree.cpp:1060)\n[14] SceneTree::_process(bool) (/home/akien/Godot/godot/./scene/main/scene_tree.cpp:1132 (discriminator 2))\n[15] SceneTree::process(double) (/home/akien/Godot/godot/./scene/main/scene_tree.cpp:580)\n[16] Main::iteration() (/home/akien/Godot/godot/main/main.cpp:4473 (discriminator 3))\n[17] OS_LinuxBSD::run() (/home/akien/Godot/godot/platform/linuxbsd/os_linuxbsd.cpp:962 (discriminator 1))\n[18] godot-git(main+0x14b) [0x66347f1] (/home/akien/Godot/godot/platform/linuxbsd/godot_linuxbsd.cpp:85)\n[19] /lib64/libc.so.6(+0x3248) [0x7f7351e98248] (??:0)\n[20] /lib64/libc.so.6(__libc_start_main+0x8b) [0x7f7351e9830b] (??:0)\n[21] godot-git(_start+0x25) [0x66345e5] (??:?)\n-- END OF BACKTRACE --\n================================================================\n```\n\nIt's only reproducible in 4.4+ as the API doesn't exist in 4.3. The method was introduced in 4.4.dev7 with #100110 and that version crashes too.\n\nSpamming this function in `_process` definitely doesn't sound like a good idea and a supported use case, but it shouldn't crash.\n\nCC @DarioSamo @clayjohn \n> Spamming this function in _process definitely doesn't sound like a good idea and a supported use case, but it shouldn't crash.\n\n@akien-mga I'm working on NDI Output for Godot, so I need the texture every frame. ~~Is there a better place to call it from? Like on a draw notification/signal?~~ Now that you mention it, calling it every process doesn't make sense. The RenderingServer emits `frame_post_draw`. That'd be a better time to call the function.\nThis could be unrelated, but let's say I call `RD::texture_get_data_async` to request texture data, but in the meantime the Object/Node that owns the method pointed to by the Callable gets freed / deconstructed. Would that cause a crash? I think that's what I'm seeing here now that I'm calling it on `RenderingServer::frame_post_draw` instead of on every process.\n\n```\nrequest texture\nreceive texture\nrequest texture\nreceive texture\ndeconstructed!\nreceive texture <-- note this\n\n================================================================\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.4.beta.custom_build (0b6a717ac17f1d6bd7963740cf2c2128b36ff7aa)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] <couldn't map PC to fn name>\n[1] <couldn't map PC to fn name>\n[2] <couldn't map PC to fn name>\n[3] <couldn't map PC to fn name>\n[4] CallableCustomExtension::call (C:\\Users\\Henry\\Documents\\godot\\core\\extension\\gdextension_interface.cpp:173)\n[5] Callable::callp (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\callable.cpp:58)\n[6] CallableCustomBind::call (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\callable_bind.cpp:151)\n[7] Callable::callp (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\callable.cpp:58)\n[8] Callable::call<Vector<unsigned char> > (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\variant.h:961)\n[9] RenderingDevice::_stall_for_frame (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_device.cpp:6575)\n[10] RenderingDevice::_begin_frame (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_device.cpp:6353)\n[11] RenderingDevice::swap_buffers (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_device.cpp:6223)\n[12] RenderingServerDefault::_draw (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_server_default.cpp:91)\n[13] RenderingServerDefault::draw (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_server_default.cpp:417)\n[14] Main::iteration (C:\\Users\\Henry\\Documents\\godot\\main\\main.cpp:4490)\n[15] OS_Windows::run (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\os_windows.cpp:2062)\n[16] widechar_main (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\godot_windows.cpp:97)\n[17] _main (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\godot_windows.cpp:124)\n[18] main (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\godot_windows.cpp:136)\n[19] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[20] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n================================================================\n```\n\n> This could be unrelated, but let's say I call `RD::texture_get_data_async` to request texture data, but in the meantime the Object/Node that owns the method pointed to by the Callable gets freed / deconstructed. Would that cause a crash? I think that's what I'm seeing here now that I'm calling it on `RenderingServer::frame_post_draw` instead of on every process.\n\nThat'd likely lead to a crash yes. You're responsible for the lifetime of your objects and you shouldn't destroy them until the callback comes back.\n\nYou could easily work around that by handing off that responsibility to an object that always lives and is in charge of redirecting the data to the object.\n\nThat said, I'll still investigate the original stack trace to see if it can be reproduced in the situation that was mentioned in the OP first.", "created_at": "2025-02-05 12:50:41", "merge_commit_sha": "2687833dec98903d4365b7c183e7c3079635f9cb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102401", "base_commit": "f0f5319b0b5b56db9f8023ac4132088df9e86b9e", "patch": "diff --git a/modules/gdscript/gdscript_editor.cpp b/modules/gdscript/gdscript_editor.cpp\nindex cccfff6a8449..062d522b6818 100644\n--- a/modules/gdscript/gdscript_editor.cpp\n+++ b/modules/gdscript/gdscript_editor.cpp\n@@ -3956,10 +3956,14 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t} else {\n \t\t\t\t\t\t\tconst int dot_pos = doc_enum_name.rfind_char('.');\n \t\t\t\t\t\t\tif (dot_pos >= 0) {\n+\t\t\t\t\t\t\t\tError err = OK;\n \t\t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n-\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n-\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\tif (base_type.class_type != nullptr) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = GDScriptCache::get_shallow_script(base_type.script_path, err);\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n \t\t\t\t\t\t\t\t\tconst String enum_name = doc_enum_name.substr(dot_pos + 1);\n \t\t\t\t\t\t\t\t\tif (base_type.class_type->has_member(enum_name)) {\n \t\t\t\t\t\t\t\t\t\tconst GDScriptParser::ClassNode::Member member = base_type.class_type->get_member(enum_name);\n@@ -3972,8 +3976,19 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t} else if (base_type.script_type.is_valid()) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = base_type.script_type;\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n+\t\t\t\t\t\t\t\t\t// TODO: Find a way to obtain enum value location for a script\n+\t\t\t\t\t\t\t\t\tr_result.location = base_type.script_type->get_member_line(doc_enum_name.substr(dot_pos + 1));\n+\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\treturn OK;\n+\t\t\t\t\t\t\t\treturn err;\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t} else if (Variant::has_builtin_method(Variant::DICTIONARY, p_symbol)) {\n", "test_patch": "", "problem_statement": "Ctrl-Click on enum value/member does nothing\n### Tested versions\n\n- reproducible in: 4.4.dev7\n- reproducible on master (tested with a 03-Jan-2025 build - `v4.4.dev.gh-101012 [c37ada786]`)\n- works in: 4.4.dev6\n\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nI mentioned this here: https://github.com/godotengine/godot/issues/100680#issuecomment-2557966392\nWhile general control-click was restored with https://github.com/godotengine/godot/pull/100707 the enum issue remains.\n\nCTRL-clicking on an enum value/member does nothing (well, it actually navigates to the beginning of the line).\n\nE.g. enum like this:\n```\nclass_name E extends Object\n\nenum Team {\n\tNone,\n\tOne,\n}\n\nfunc test():\n\tvar t = E.Team.None\n```\nand CTRL-clicking on the `None` of `E.Team.None` does not take you to the `None` under `enum Team`.\n\n\n### Steps to reproduce\n\nOpen enum.gd in MRP - same code as in description.\n\n### Minimal reproduction project (MRP)\n\n[44dev7enum.zip](https://github.com/user-attachments/files/18303044/44dev7enum.zip)\n\n", "hints_text": "Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. \n\nhttps://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n\nIt seems that changing the class's documentation updates something and it suddenly works.\n\nI couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n> Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. https://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n> \n> It seems that changing the class's documentation updates something and it suddenly works.\n> \n> I couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n\nYes, ctrl-click change https://github.com/godotengine/godot/pull/100707 went into master after dev7.\n\nOkay that makes sense but still that behavior where adding documentation effects Ctrl+click is very weird... can you reproduce it on your computer?", "created_at": "2025-02-04 09:29:03", "merge_commit_sha": "54ffb8ab3e62cabbc62421381b63751890b42774", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102392", "base_commit": "0b6a717ac17f1d6bd7963740cf2c2128b36ff7aa", "patch": "diff --git a/editor/editor_properties_array_dict.cpp b/editor/editor_properties_array_dict.cpp\nindex 9663157ff990..93c5a70cf907 100644\n--- a/editor/editor_properties_array_dict.cpp\n+++ b/editor/editor_properties_array_dict.cpp\n@@ -447,6 +447,7 @@ void EditorPropertyArray::update_property() {\n \t\t\tsize_slider = memnew(EditorSpinSlider);\n \t\t\tsize_slider->set_step(1);\n \t\t\tsize_slider->set_max(INT32_MAX);\n+\t\t\tsize_slider->set_editing_integer(true);\n \t\t\tsize_slider->set_h_size_flags(SIZE_EXPAND_FILL);\n \t\t\tsize_slider->set_read_only(is_read_only());\n \t\t\tsize_slider->connect(SceneStringName(value_changed), callable_mp(this, &EditorPropertyArray::_length_changed));\n", "test_patch": "", "problem_statement": "Exported array in inspector has slider for array size\n### Tested versions\n\n- Reproducible in v4.4.beta.custom_build [eee39f004]\n\n### System information\n\nGodot v4.4.beta (eee39f004) - macOS Sequoia (15.3.0) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon Pro 5500 XT OpenGL Engine - Intel(R) Core(TM) i7-10700K CPU @ 3.80GHz (16 threads)\n\n### Issue description\n\nThe array size field in the editor inspector includes a slider, which is effectively useless because it has such a large range:\n\nhttps://github.com/user-attachments/assets/99cebd43-0dd0-4e40-9eba-456725123e22\n\n[In `editor/editor_properties_array_dict.cpp` at line 449, we can see that its maximum value is indeed `INT32_MAX`](https://github.com/godotengine/godot/blob/eee39f004b42a4948af90cdebedf65c34a4a4970/editor/editor_properties_array_dict.cpp#L449):\n```cpp\nsize_slider->set_max(INT32_MAX);\n```\n\nThis number is so large that even with the slider just *barely* moved off to the right, the array is being given over 5,000,000 elements. There is also noticeable lag in the editor as this is done.\n\n### Steps to reproduce\n\nCreate an exported array in a GDScript class:\n```gdscript\n@export var my_array: Array[int] = []\n```\n\nThen, attach it to a node in the editor. Select the node and expand the array, and observe the slider on the \"Size:\" field. Try to drag it, and notice that the array size becomes *very* large.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-02-04 03:14:02", "merge_commit_sha": "ceded4eac25bec2e0c3c3a33318f661b223e8e6e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102379", "base_commit": "eee39f004b42a4948af90cdebedf65c34a4a4970", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex b79d1243ba6c..97335821374e 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -4138,7 +4138,8 @@ void EditorInspector::expand_revertable() {\n }\n \n void EditorInspector::set_scroll_offset(int p_offset) {\n-\tset_v_scroll(p_offset);\n+\t// This can be called before the container finishes sorting its children, so defer it.\n+\tcallable_mp((ScrollContainer *)this, &ScrollContainer::set_v_scroll).call_deferred(p_offset);\n }\n \n int EditorInspector::get_scroll_offset() const {\n", "test_patch": "", "problem_statement": "Inspector size wrong after switching between scenes\n### Tested versions\n\nGodot 4.4.beta2\n\nNot happening in 4.4.dev4\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nIf you scroll down in the inspector and then switch to another scene and back the inspector will not have correct size and scrollbar anymore. \n\nhttps://github.com/user-attachments/assets/07da0f72-224b-4f67-a022-2e9f4b4ee85b\n\nyou can also see in the video that the scrollbar is wrongly shown in the inspector of the other scene.\n\n### Steps to reproduce\n\n^\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Can confirm, bisecting\nBisected to https://github.com/godotengine/godot/pull/97415\n\nCC @YeldhamDev ", "created_at": "2025-02-03 21:29:00", "merge_commit_sha": "af8a5fd6eac86deb61c129f7dc84ed15c99b8d2e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102312", "base_commit": "1586c5674bbafe1d7f4bd457d446f132b475890c", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex d96ee851374e..6cc54ab34c97 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -230,6 +230,8 @@ void GameView::_instance_starting(int p_idx, List<String> &r_arguments) {\n \t\twindow_wrapper->set_window_title(appname);\n \n \t\t_show_update_window_wrapper();\n+\n+\t\tembedded_process->grab_focus();\n \t}\n \n \t_update_arguments_for_instance(p_idx, r_arguments);\n", "test_patch": "", "problem_statement": "Floating game window doesn't get focus when launched\n### Tested versions\n\nGodot v4.4.beta2\n\n### System information\n\nFedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nFloating game window doesn't get focus when launched. \nThe editor behind still has focus so if you have script open you will accidentally edit the script.\n\nhttps://github.com/user-attachments/assets/5b4bea64-89b8-4f38-954b-770208a80159\n\nIn 4.4.beta1 the game window has focus correctly first time you launch it, but after that it behaves same as beta2\n\n### Steps to reproduce\n\nHave script open \nLaunch scene\nPress some buttons\nSwitch back to the script and see that you have typed in the script\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-02-02 02:18:03", "merge_commit_sha": "bbf29a537f3d2875bba4304b1543d4bf0278b6d9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102247", "base_commit": "f0f5319b0b5b56db9f8023ac4132088df9e86b9e", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 1638c437125d..a348607a6e94 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -67,20 +67,10 @@ void EmbeddedProcess::_notification(int p_what) {\n \t\t} break;\n \t\tcase NOTIFICATION_APPLICATION_FOCUS_IN: {\n \t\t\tapplication_has_focus = true;\n-\t\t\tif (embedded_process_was_focused) {\n-\t\t\t\tembedded_process_was_focused = false;\n-\t\t\t\t// Refocus the embedded process if it was focused when the application lost focus,\n-\t\t\t\t// but do not refocus if the embedded process is currently focused (indicating it just lost focus)\n-\t\t\t\t// or if the current window is a different popup or secondary window.\n-\t\t\t\tif (embedding_completed && current_process_id != focused_process_id && window && window->has_focus()) {\n-\t\t\t\t\tgrab_focus();\n-\t\t\t\t\tqueue_update_embedded_process();\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\tlast_application_focus_time = OS::get_singleton()->get_ticks_msec();\n \t\t} break;\n \t\tcase NOTIFICATION_APPLICATION_FOCUS_OUT: {\n \t\t\tapplication_has_focus = false;\n-\t\t\tembedded_process_was_focused = embedding_completed && current_process_id == focused_process_id;\n \t\t} break;\n \t}\n }\n@@ -286,14 +276,27 @@ void EmbeddedProcess::_check_mouse_over() {\n \t// This method checks if the mouse is over the embedded process while the current application is focused.\n \t// The goal is to give focus to the embedded process as soon as the mouse hovers over it,\n \t// allowing the user to interact with it immediately without needing to click first.\n-\tif (!is_visible_in_tree() || !embedding_completed || !application_has_focus || !window || !window->has_focus() || Input::get_singleton()->is_mouse_button_pressed(MouseButton::LEFT) || Input::get_singleton()->is_mouse_button_pressed(MouseButton::RIGHT)) {\n+\tif (!embedding_completed || !application_has_focus || !window || has_focus() || !is_visible_in_tree() || !window->has_focus() || Input::get_singleton()->is_mouse_button_pressed(MouseButton::LEFT) || Input::get_singleton()->is_mouse_button_pressed(MouseButton::RIGHT)) {\n+\t\treturn;\n+\t}\n+\n+\t// Before checking whether the mouse is truly inside the embedded process, ensure\n+\t// the editor has enough time to re-render. When a breakpoint is hit in the script editor,\n+\t// `_check_mouse_over` may be triggered before the editor hides the game workspace.\n+\t// This prevents the embedded process from regaining focus immediately after the editor has taken it.\n+\tif (OS::get_singleton()->get_ticks_msec() - last_application_focus_time < 500) {\n \t\treturn;\n \t}\n \n-\tbool focused = has_focus();\n+\t// Input::is_mouse_button_pressed is not sufficient to detect the mouse button state\n+\t// while the floating game window is being resized.\n+\tBitField<MouseButtonMask> mouse_button_mask = DisplayServer::get_singleton()->mouse_get_button_state();\n+\tif (!mouse_button_mask.is_empty()) {\n+\t\treturn;\n+\t}\n \n \t// Not stealing focus from a textfield.\n-\tif (!focused && get_viewport()->gui_get_focus_owner() && get_viewport()->gui_get_focus_owner()->is_text_field()) {\n+\tif (get_viewport()->gui_get_focus_owner() && get_viewport()->gui_get_focus_owner()->is_text_field()) {\n \t\treturn;\n \t}\n \n@@ -309,14 +312,17 @@ void EmbeddedProcess::_check_mouse_over() {\n \t\treturn;\n \t}\n \n-\t// When we already have the focus and the user moves the mouse over the embedded process,\n-\t// we just need to refocus the process.\n-\tif (focused) {\n-\t\tqueue_update_embedded_process();\n-\t} else {\n-\t\tgrab_focus();\n-\t\tqueue_redraw();\n+\t// When there's a modal window, we don't want to grab the focus to prevent\n+\t// the game window to go in front of the modal window.\n+\tif (_get_current_modal_window()) {\n+\t\treturn;\n \t}\n+\n+\t// Force \"regrabbing\" the game window focus.\n+\tlast_updated_embedded_process_focused = false;\n+\n+\tgrab_focus();\n+\tqueue_redraw();\n }\n \n void EmbeddedProcess::_check_focused_process_id() {\n@@ -325,17 +331,48 @@ void EmbeddedProcess::_check_focused_process_id() {\n \t\tfocused_process_id = process_id;\n \t\tif (focused_process_id == current_process_id) {\n \t\t\t// The embedded process got the focus.\n-\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n-\t\t\tif (has_focus()) {\n-\t\t\t\t// Redraw to updated the focus style.\n-\t\t\t\tqueue_redraw();\n-\t\t\t} else {\n-\t\t\t\tgrab_focus();\n+\n+\t\t\t// Refocus the current model when focusing the embedded process.\n+\t\t\tWindow *modal_window = _get_current_modal_window();\n+\t\t\tif (!modal_window) {\n+\t\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n+\t\t\t\tif (has_focus()) {\n+\t\t\t\t\t// Redraw to updated the focus style.\n+\t\t\t\t\tqueue_redraw();\n+\t\t\t\t} else {\n+\t\t\t\t\tgrab_focus();\n+\t\t\t\t}\n \t\t\t}\n \t\t} else if (has_focus()) {\n \t\t\trelease_focus();\n \t\t}\n \t}\n+\n+\t// Ensure that the opened modal dialog is refocused when the focused process is the embedded process.\n+\tif (!application_has_focus && focused_process_id == current_process_id) {\n+\t\tWindow *modal_window = _get_current_modal_window();\n+\t\tif (modal_window) {\n+\t\t\tif (modal_window->get_mode() == Window::MODE_MINIMIZED) {\n+\t\t\t\tmodal_window->set_mode(Window::MODE_WINDOWED);\n+\t\t\t}\n+\t\t\tcallable_mp(modal_window, &Window::grab_focus).call_deferred();\n+\t\t}\n+\t}\n+}\n+\n+Window *EmbeddedProcess::_get_current_modal_window() {\n+\tVector<DisplayServer::WindowID> wl = DisplayServer::get_singleton()->get_window_list();\n+\tfor (const DisplayServer::WindowID &window_id : wl) {\n+\t\tWindow *w = Window::get_from_id(window_id);\n+\t\tif (!w) {\n+\t\t\tcontinue;\n+\t\t}\n+\n+\t\tif (w->is_exclusive()) {\n+\t\t\treturn w;\n+\t\t}\n+\t}\n+\treturn nullptr;\n }\n \n void EmbeddedProcess::_bind_methods() {\ndiff --git a/editor/plugins/embedded_process.h b/editor/plugins/embedded_process.h\nindex 3e800923a75d..6f56f255e618 100644\n--- a/editor/plugins/embedded_process.h\n+++ b/editor/plugins/embedded_process.h\n@@ -37,7 +37,7 @@ class EmbeddedProcess : public Control {\n \tGDCLASS(EmbeddedProcess, Control);\n \n \tbool application_has_focus = true;\n-\tbool embedded_process_was_focused = false;\n+\tuint64_t last_application_focus_time = 0;\n \tOS::ProcessID focused_process_id = 0;\n \tOS::ProcessID current_process_id = 0;\n \tbool embedding_grab_focus = false;\n@@ -68,6 +68,7 @@ class EmbeddedProcess : public Control {\n \tvoid _check_focused_process_id();\n \tbool _is_embedded_process_updatable();\n \tRect2i _get_global_embedded_window_rect();\n+\tWindow *_get_current_modal_window();\n \n protected:\n \tstatic void _bind_methods();\ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex d0ddac4b7f9e..1a407bdd4b2f 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -2986,7 +2986,8 @@ Error DisplayServerWindows::embed_process(WindowID p_window, OS::ProcessID p_pid\n \t// (e.g., a screen to the left of the main screen).\n \tconst Rect2i adjusted_rect = Rect2i(p_rect.position + _get_screens_origin(), p_rect.size);\n \n-\tSetWindowPos(ep->window_handle, nullptr, adjusted_rect.position.x, adjusted_rect.position.y, adjusted_rect.size.x, adjusted_rect.size.y, SWP_NOZORDER | SWP_NOACTIVATE | SWP_ASYNCWINDOWPOS);\n+\t// Use HWND_BOTTOM to prevent reordering of the embedded window over another popup.\n+\tSetWindowPos(ep->window_handle, HWND_BOTTOM, adjusted_rect.position.x, adjusted_rect.position.y, adjusted_rect.size.x, adjusted_rect.size.y, SWP_NOZORDER | SWP_NOACTIVATE | SWP_ASYNCWINDOWPOS);\n \n \tif (ep->is_visible != p_visible) {\n \t\tif (p_visible) {\n", "test_patch": "", "problem_statement": "Embed Game focus over modal popups\n### Tested versions\n\n- Reproductible in 4.4 beta 2 and master\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 32.0.15.6636) - 11th Gen Intel(R) Core(TM) i5-11600KF @ 3.90GHz (12 threads)\n\n### Issue description\n\nThe embedding is enabled in the editor and the game is running. If a modal popup is visible and the use click on the game window, the game window appears in front of the modal popup. If this popup is small enough, it disappears and the editor is not available (ex: stop button).\n\nhttps://github.com/user-attachments/assets/9ce74cc1-e7f0-44e8-87b8-fc60c69519e5\n\n\n\n### Steps to reproduce\n\n- Enable Embed Game and disable Make Floating\n- Run the game\n- While inside the Game tab, display a modal popup (ex: Settings, Create node, etc...)\n- Click the game window\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "hints_text": "", "created_at": "2025-01-31 15:37:12", "merge_commit_sha": "bd87c3a76b7e74729ddcbf4821de70c236569198", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102218", "base_commit": "134da374975114ef8e05cf81d1d30eff645e310e", "patch": "diff --git a/modules/gdscript/gdscript_parser.cpp b/modules/gdscript/gdscript_parser.cpp\nindex 077ab6f04667..4b95f5a83613 100644\n--- a/modules/gdscript/gdscript_parser.cpp\n+++ b/modules/gdscript/gdscript_parser.cpp\n@@ -3123,13 +3123,9 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\t\tcase DictionaryNode::LUA_TABLE:\n \t\t\t\t\tif (key != nullptr && key->type != Node::IDENTIFIER && key->type != Node::LITERAL) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (key != nullptr && key->type == Node::LITERAL && static_cast<LiteralNode *>(key)->value.get_type() != Variant::STRING) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (!match(GDScriptTokenizer::Token::EQUAL)) {\n \t\t\t\t\t\tif (match(GDScriptTokenizer::Token::COLON)) {\n@@ -3169,6 +3165,21 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\tif (key != nullptr && value != nullptr) {\n \t\t\t\tdictionary->elements.push_back({ key, value });\n \t\t\t}\n+\n+\t\t\t// Do phrase level recovery by inserting an imaginary expression for missing keys or values.\n+\t\t\t// This ensures the successfully parsed expression is part of the AST and can be analyzed.\n+\t\t\tif (key != nullptr && value == nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ key, dummy });\n+\t\t\t} else if (key == nullptr && value != nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ dummy, value });\n+\t\t\t}\n+\n \t\t} while (match(GDScriptTokenizer::Token::COMMA) && !is_at_end());\n \t}\n \tpop_multiline();\ndiff --git a/modules/gdscript/gdscript_parser.h b/modules/gdscript/gdscript_parser.h\nindex 5da2bc80207f..8afc6b5f05a6 100644\n--- a/modules/gdscript/gdscript_parser.h\n+++ b/modules/gdscript/gdscript_parser.h\n@@ -1453,6 +1453,18 @@ class GDScriptParser {\n \n \t\treturn node;\n \t}\n+\n+\t// Allocates a node for patching up the parse tree when an error occurred.\n+\t// Such nodes don't track their extents as they don't relate to actual tokens.\n+\ttemplate <typename T>\n+\tT *alloc_recovery_node() {\n+\t\tT *node = memnew(T);\n+\t\tnode->next = list;\n+\t\tlist = node;\n+\n+\t\treturn node;\n+\t}\n+\n \tvoid clear();\n \tvoid push_error(const String &p_message, const Node *p_origin = nullptr);\n #ifdef DEBUG_ENABLED\n", "test_patch": "diff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.cfg\nnew file mode 100644\nindex 000000000000..8920916a8984\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+exclude=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.gd\nnew file mode 100644\nindex 000000000000..7795c0636d4d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.gd\n@@ -0,0 +1,6 @@\n+extends Node\n+\n+var test = {\n+    t = 1,\n+    AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.cfg\nnew file mode 100644\nindex 000000000000..689a99b70c6d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+exclude=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.gd\nnew file mode 100644\nindex 000000000000..9ba440a10db4\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.gd\n@@ -0,0 +1,10 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    t = 1,\n+    TestEnum.\u27a1 = 1,\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.gd\nnew file mode 100644\nindex 000000000000..d5f087b3bd66\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    t = AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.gd\nnew file mode 100644\nindex 000000000000..9eb72aed30b9\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    = TestEnum.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.gd\nnew file mode 100644\nindex 000000000000..394aa28b6319\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.gd\n@@ -0,0 +1,6 @@\n+extends Node\n+\n+var test = {\n+    t = 1,\n+    e AutoTranslateMode.\u27a1,\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.gd\nnew file mode 100644\nindex 000000000000..17fc79b52d14\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    1 = TestEnum.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.gd\nnew file mode 100644\nindex 000000000000..aa6c52ae8071\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.gd\n@@ -0,0 +1,6 @@\n+extends Node\n+\n+var test = {\n+    t = 1,\n+    1 AutoTranslateMode.\u27a1,\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.gd\nnew file mode 100644\nindex 000000000000..ad3009532b56\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.gd\nnew file mode 100644\nindex 000000000000..d5a50261cc52\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    AutoTranslateMode.\u27a1:\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.gd\nnew file mode 100644\nindex 000000000000..a2b6fa0106e7\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    TestEnum.\u27a1 \"test\"\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.gd\nnew file mode 100644\nindex 000000000000..ac7b3f8614c1\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    AutoTranslateMode.\u27a1: 1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.gd\nnew file mode 100644\nindex 000000000000..5ea4cab76fc1\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    1: AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.gd\nnew file mode 100644\nindex 000000000000..fd14b2152ddd\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    : TestEnum.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.gd\nnew file mode 100644\nindex 000000000000..befd4cc0cce9\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    1 AutoTranslateMode.\u27a1\n+}\n", "problem_statement": "[3.x] Autocomplete fails when typing the key before the value in a dictionary\n**Godot version:**\r\nGodot 3.2.stable.official\r\n\r\n**OS/device including version:**\r\nWindows 10 home\r\n\r\n**Issue description:**\r\nWhen adding a key to the dictionary, the autocomplete does not work until I enter the value. The workaround is to start by entering `:any_value` then moving the cursor back and entering the key for the autocomplete to work.\r\n\r\n**Steps to reproduce:**\r\nCreate the following script and try to add a key value pair to `data`, the enum does not autocomplete until a value is added :\r\n```\r\nextends Reference\r\n\r\nvar\tdata = {InnerClass.INNER_ENUM_VALUE_1:1}\r\n\r\nclass InnerClass:\r\n\tenum {INNER_ENUM_VALUE_1}\r\n\r\n```\r\n**Minimal reproduction project:**\r\nDon't need a project, just the above script.\n", "hints_text": "", "created_at": "2025-01-30 23:32:28", "merge_commit_sha": "bef5d1e4f87da43a19c4ab2c8ff17704f88bb9b4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102184", "base_commit": "56d82044702465912ced016654d203587cabe084", "patch": "diff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 3c1809c3586b..99273ffa81c7 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -559,11 +559,6 @@ void SceneTree::iteration_prepare() {\n \t\t// are flushed before pumping the interpolation prev and currents.\n \t\tflush_transform_notifications();\n \t\tVisualServer::get_singleton()->tick();\n-\n-\t\t// Any objects performing client physics interpolation\n-\t\t// should be given an opportunity to keep their previous transforms\n-\t\t// up to date before each new physics tick.\n-\t\t_client_physics_interpolation.physics_process();\n \t}\n }\n \n@@ -572,6 +567,11 @@ void SceneTree::iteration_end() {\n \t// to be flushed to the VisualServer before finishing a physics tick.\n \tif (_physics_interpolation_enabled) {\n \t\tflush_transform_notifications();\n+\n+\t\t// Any objects performing client physics interpolation\n+\t\t// should be given an opportunity to keep their previous transforms\n+\t\t// up to date.\n+\t\t_client_physics_interpolation.physics_process();\n \t}\n }\n \n", "test_patch": "", "problem_statement": "`get_global_transform_interpolated()` may return wrong value when FPS < physics ticks per second\n### Tested versions\n\n- Reproducible in v3.6.stable.official [de2f0f147]\n- Reproducible in v4.4.dev1.official [28a72fa43]\n- Reproducible in v4.4.beta1.official [d33da79d3]\n- Reproducible in v4.4.beta.custom_build [a013481b0]\n\n### System information\n\nGodot v4.4.beta (a013481b0) - CachyOS Linux #1 SMP PREEMPT_DYNAMIC Mon, 20 Jan 2025 21:26:55 +0000 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) HD Graphics 620 (KBL GT2) - Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz (4 threads)\n\n### Issue description\n\nWhen FPS drops below `physics_ticks_per_second` the function `get_global_transform_interpolated()` sometimes returns wrong value.\n\nWhen calling `get_global_transform_interpolated()` in a `_process()` I expect to get the most recent interpolated transform regardless of how many physics ticks happen between successive process frames. I think the actual returned value may be interpolated transform only after 1 physics tick that occurred directly after the previous process frame.\n\nThe issue is about functionality introduced to `4.4.dev1` in https://github.com/godotengine/godot/pull/92391 but it is also reproducible in `3.6` version of physics interpolation.\n\n### Steps to reproduce\n\nRun the MRP and notice NinePatchRect is constantly jittering.\n\nIn order to reproduce the issue the project has `max_fps` set lower than `physics_ticks_per_second`.\n\nIf needed I can provide even more simplified MRP without the usage of `Camera3D.unproject_position()`.\n\n### Minimal reproduction project (MRP)\n\nGodot 4.x project:\n[test-physics-interpolation-maxfps.zip](https://github.com/user-attachments/files/18580802/test-physics-interpolation-maxfps.zip)\n\nGodot 3.x project:\n[Test Physics Interpolation max_fps Godot3.zip](https://github.com/user-attachments/files/18580804/Test.Physics.Interpolation.max_fps.Godot3.zip)\n", "hints_text": "Related #94060.\n\nUPDATE:\nAh! I think I understand the difference here, maybe the timeout is not working. There should be a timeout which prevents this. Will investigate.\nYou are absolutely right, I must have subconsciously assumed the frame rate would be higher than the tick rate, because it only updates the previous transform during the frame call. I'll put in a mechanism to fix this. \ud83d\udc4d \n\nUPDATE:\nTurns out there is already a mechanism to deal with tick rate higher than the frame rate, and it is working fine in a test project. So there is something special about your MRP which is causing the behaviour seen, still investigating.\n\nModifying your project so the target is not a physics object seems to work fine (as in my MRP), so it looks to be something to do with the timing that the physics engine is updating the Ball, relative to when the interpolation records it. Will probably have to look more tomorrow.\nThink I've got it, the client interpolation pump was being updated _before_ the physics had called back to update the item transforms during the iteration. This seemed not to be a problem when the frame rate was higher than tick rate, but caused a glitch the other way round when there was more than 1 tick per frame.\n\nIt looks fairly simple to fix by moving the point in the iteration we update the client interpolation pump.\n\nWell done for spotting this! \ud83d\udc4d \n\nAlso likely it was missed because most of the testing was on non-physics objects (to simplify things).", "created_at": "2025-01-30 11:52:01", "merge_commit_sha": "a4349590c5a037945cfa4b4f770edf3b70adda35", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Linux Headless w/ Mono (target=release_debug, tools=yes)', '.github/workflows/runner.yml']", "['Static Checks (clang-format, black format, file format, documentation checks)', '.github/workflows/runner.yml']"], ["['Linux Server w/ Mono (target=release, tools=no)', '.github/workflows/runner.yml']", "['Editor (target=release_debug, tools=yes)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102163", "base_commit": "a013481b0911e59cc3f3dea7ebb732450c3e1460", "patch": "diff --git a/platform/web/js/libs/audio.position.worklet.js b/platform/web/js/libs/audio.position.worklet.js\nindex bf3ac4ae2d23..7dbeb8a0adde 100644\n--- a/platform/web/js/libs/audio.position.worklet.js\n+++ b/platform/web/js/libs/audio.position.worklet.js\n@@ -28,10 +28,20 @@\n /* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n /**************************************************************************/\n \n+const POST_THRESHOLD_S = 0.1;\n+\n class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n-\tconstructor() {\n-\t\tsuper();\n+\tconstructor(...args) {\n+\t\tsuper(...args);\n+\t\tthis.lastPostTime = currentTime;\n \t\tthis.position = 0;\n+\n+\t\tthis.port.onmessage = (event) => {\n+\t\t\tif (event?.data?.type === 'clear') {\n+\t\t\t\tthis.lastPostTime = currentTime;\n+\t\t\t\tthis.position = 0;\n+\t\t\t}\n+\t\t};\n \t}\n \n \tprocess(inputs, _outputs, _parameters) {\n@@ -39,10 +49,15 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\t\tconst input = inputs[0];\n \t\t\tif (input.length > 0) {\n \t\t\t\tthis.position += input[0].length;\n-\t\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n-\t\t\t\treturn true;\n \t\t\t}\n \t\t}\n+\n+\t\t// Posting messages is expensive. Let's limit the number of posts.\n+\t\tif (currentTime - this.lastPostTime > POST_THRESHOLD_S) {\n+\t\t\tthis.lastPostTime = currentTime;\n+\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n+\t\t}\n+\n \t\treturn true;\n \t}\n }\ndiff --git a/platform/web/js/libs/library_godot_audio.js b/platform/web/js/libs/library_godot_audio.js\nindex 0c83e3587d84..c5fa7d5f0fad 100644\n--- a/platform/web/js/libs/library_godot_audio.js\n+++ b/platform/web/js/libs/library_godot_audio.js\n@@ -460,7 +460,11 @@ class SampleNode {\n \t\tconst sampleNodeBus = this.getSampleNodeBus(bus);\n \t\tsampleNodeBus.setVolume(options.volume);\n \n-\t\tthis.connectPositionWorklet(options.start);\n+\t\tthis.connectPositionWorklet(options.start).catch((err) => {\n+\t\t\tconst newErr = new Error('Failed to create PositionWorklet.');\n+\t\t\tnewErr.cause = err;\n+\t\t\tGodotRuntime.error(newErr);\n+\t\t});\n \t}\n \n \t/**\n@@ -612,44 +616,34 @@ class SampleNode {\n \t * Sets up and connects the source to the GodotPositionReportingProcessor\n \t * If the worklet module is not loaded in, it will be added\n \t */\n-\tconnectPositionWorklet(start) {\n-\t\ttry {\n-\t\t\tthis._positionWorklet = this.createPositionWorklet();\n-\t\t\tthis._source.connect(this._positionWorklet);\n-\t\t\tif (start) {\n-\t\t\t\tthis.start();\n-\t\t\t}\n-\t\t} catch (error) {\n-\t\t\tif (error?.name !== 'InvalidStateError') {\n-\t\t\t\tthrow error;\n-\t\t\t}\n-\t\t\tconst path = GodotConfig.locate_file('godot.audio.position.worklet.js');\n-\t\t\tGodotAudio.ctx.audioWorklet\n-\t\t\t\t.addModule(path)\n-\t\t\t\t.then(() => {\n-\t\t\t\t\tif (!this.isCanceled) {\n-\t\t\t\t\t\tthis._positionWorklet = this.createPositionWorklet();\n-\t\t\t\t\t\tthis._source.connect(this._positionWorklet);\n-\t\t\t\t\t\tif (start) {\n-\t\t\t\t\t\t\tthis.start();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}).catch((addModuleError) => {\n-\t\t\t\t\tGodotRuntime.error('Failed to create PositionWorklet.', addModuleError);\n-\t\t\t\t});\n+\tasync connectPositionWorklet(start) {\n+\t\tawait GodotAudio.audioPositionWorkletPromise;\n+\t\tif (this.isCanceled) {\n+\t\t\treturn;\n+\t\t}\n+\t\tthis.getPositionWorklet();\n+\t\tthis._source.connect(this._positionWorklet);\n+\t\tif (start) {\n+\t\t\tthis.start();\n \t\t}\n \t}\n \n \t/**\n-\t * Creates the AudioWorkletProcessor used to track playback position.\n-\t * @returns {AudioWorkletNode}\n+\t * Get a AudioWorkletProcessor from the pool, or create one if no processor is available.\n \t */\n-\tcreatePositionWorklet() {\n-\t\tconst worklet = new AudioWorkletNode(\n-\t\t\tGodotAudio.ctx,\n-\t\t\t'godot-position-reporting-processor'\n-\t\t);\n-\t\tworklet.port.onmessage = (event) => {\n+\tgetPositionWorklet() {\n+\t\tif (this._positionWorklet != null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tif (GodotAudio.audioPositionWorkletPool.length == 0) {\n+\t\t\tthis._positionWorklet = new AudioWorkletNode(\n+\t\t\t\tGodotAudio.ctx,\n+\t\t\t\t'godot-position-reporting-processor'\n+\t\t\t);\n+\t\t} else {\n+\t\t\tthis._positionWorklet = GodotAudio.audioPositionWorkletPool.pop();\n+\t\t}\n+\t\tthis._positionWorklet.port.onmessage = (event) => {\n \t\t\tswitch (event.data['type']) {\n \t\t\tcase 'position':\n \t\t\t\tthis._playbackPosition = (parseInt(event.data.data, 10) / this.getSample().sampleRate) + this.offset;\n@@ -658,7 +652,6 @@ class SampleNode {\n \t\t\t\t// Do nothing.\n \t\t\t}\n \t\t};\n-\t\treturn worklet;\n \t}\n \n \t/**\n@@ -688,6 +681,8 @@ class SampleNode {\n \t\tif (this._positionWorklet) {\n \t\t\tthis._positionWorklet.disconnect();\n \t\t\tthis._positionWorklet.port.onmessage = null;\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n+\t\t\tGodotAudio.audioPositionWorkletPool.push(this._positionWorklet);\n \t\t\tthis._positionWorklet = null;\n \t\t}\n \n@@ -731,7 +726,10 @@ class SampleNode {\n \t\tconst pauseTime = this.isPaused\n \t\t\t? this.pauseTime\n \t\t\t: 0;\n-\t\tthis.connectPositionWorklet();\n+\t\tif (this._positionWorklet != null) {\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n+\t\t\tthis._source.connect(this._positionWorklet);\n+\t\t}\n \t\tthis._source.start(this.startTime, this.offset + pauseTime);\n \t\tthis.isStarted = true;\n \t}\n@@ -1199,6 +1197,10 @@ const _GodotAudio = {\n \t\tdriver: null,\n \t\tinterval: 0,\n \n+\t\t/** @type {Promise} */\n+\t\taudioPositionWorkletPromise: null,\n+\t\taudioPositionWorkletPool: [],\n+\n \t\t/**\n \t\t * Converts linear volume to Db.\n \t\t * @param {number} linear Linear value to convert.\n@@ -1265,6 +1267,10 @@ const _GodotAudio = {\n \t\t\t\tonlatencyupdate(computed_latency);\n \t\t\t}, 1000);\n \t\t\tGodotOS.atexit(GodotAudio.close_async);\n+\n+\t\t\tconst path = GodotConfig.locate_file('godot.audio.position.worklet.js');\n+\t\t\tGodotAudio.audioPositionWorkletPromise = ctx.audioWorklet.addModule(path);\n+\n \t\t\treturn ctx.destination.channelCount;\n \t\t},\n \n", "test_patch": "", "problem_statement": "v4.4 Sound quickly regresses on the Web: freezes, noises, crackles\n### Tested versions\n\nReproducible in: v4.4.dev3.official [f4af8201b], v4.4.dev2, v4.4.dev1\r\nNot reproducible in: v4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.4.dev3 - Windows 10.0.19045 - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - GeForce GT 740M - Intel(R) Core(TM) i5-3317U CPU @ 1.70GHz (4 threads)\n\n### Issue description\n\nOn the Web over time, the sound begins to freeze, break and crackle terribly. The heavier the stage and the weaker the hardware on which the game is launched, the faster it happens. For example, the sounds in the game I created start to freeze after a minute on a modern computer. On a weak laptop almost immediately. And immediately on a phone. Also, in remote debugging, this degradation of sounds occurs more slowly than when exporting a project.\r\n\r\nI tried different solutions, but they all didn't work. Because of this, I had to move the whole project to version 4.3 and that solved the problem.\r\n\r\nSo at the moment version 4.4 is not playable on web platforms. At least for me.\r\n\r\nFor testing I created separate projects for 4.4 and 4.3. with a minimum number of objects just so that there is at least some load on the engine.\n\n### Steps to reproduce\n\nRun the project in remote debugging on the Web.\r\nWait a few minutes (depending on your hardware). My sound began to degrade sharply at the 3rd minute.\r\nIf you want, try to run the same project on version 4.3. You won't find any such problems, no matter how much you play.\n\n### Minimal reproduction project (MRP)\n\n[audiotest-4.4.zip](https://github.com/user-attachments/files/17602861/audiotest-4.4.zip)\r\n\r\n[audiotest-4.3.zip](https://github.com/user-attachments/files/17602859/audiotest-4.3.zip)\r\n\n", "hints_text": "I confirm the problem. It is played on Linux in Chrome and FireFox browsers.\nI also confirm the issue. Here is my (work-in-progress) project exported from two different Godot versions:\n\n- [Froge 4.3](https://rburing.itch.io/froge-4-3?secret=LEGEJVXHEuaHXoqmv2zlZ0u1SU) (exported from Godot 4.3-stable)\n- [Froge 4.4](https://rburing.itch.io/froge-4-4?secret=ZnPD765il6PkacENN3CyUeStyU) (exported from Godot 4.4-beta1)\n\nStart the game and wait about 2 minutes (the exact time may depend on your device).\n\nThe looped music (an .ogg file played by an AudioStreamPlayer) starts to stutter, crackle, and slow down.\n\nTested on Firefox on Linux.\n\nI can provide the project source upon request.\n\ncc @adamscott \nI've narrowed down the issue, it started on 4.4-dev1. For completeness: [Froge 4.4-dev1](https://rburing.itch.io/froge-4-4-dev1?secret=N7HUGjKguo20JFpm36RWKGrpotM).\n\nMy guess is that maybe it has something to do with looping and floating point precision.\n\nEdit: Probably related to\n\n- https://github.com/godotengine/godot/pull/95197\n\n", "created_at": "2025-01-29 22:04:30", "merge_commit_sha": "a7e5469155defaceb4dfa223fec0fa46b73ad40e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102144", "base_commit": "a013481b0911e59cc3f3dea7ebb732450c3e1460", "patch": "diff --git a/core/math/basis.cpp b/core/math/basis.cpp\nindex e5f3431eef84..18959f3c0162 100644\n--- a/core/math/basis.cpp\n+++ b/core/math/basis.cpp\n@@ -455,6 +455,11 @@ void Basis::get_rotation_axis_angle_local(Vector3 &p_axis, real_t &p_angle) cons\n }\n \n Vector3 Basis::get_euler(EulerOrder p_order) const {\n+\t// This epsilon value results in angles within a +/- 0.04 degree range being simplified/truncated.\n+\t// Based on testing, this is the largest the epsilon can be without the angle truncation becoming\n+\t// visually noticeable.\n+\tconst real_t epsilon = 0.00000025;\n+\n \tswitch (p_order) {\n \t\tcase EulerOrder::XYZ: {\n \t\t\t// Euler angles in XYZ convention.\n@@ -466,8 +471,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sy = rows[0][2];\n-\t\t\tif (sy < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sy > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sy < (1.0f - epsilon)) {\n+\t\t\t\tif (sy > -(1.0f - epsilon)) {\n \t\t\t\t\t// is this a pure Y rotation?\n \t\t\t\t\tif (rows[1][0] == 0 && rows[0][1] == 0 && rows[1][2] == 0 && rows[2][1] == 0 && rows[1][1] == 1) {\n \t\t\t\t\t\t// return the simplest form (human friendlier in editor and scripts)\n@@ -501,8 +506,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sz = rows[0][1];\n-\t\t\tif (sz < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sz > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sz < (1.0f - epsilon)) {\n+\t\t\t\tif (sz > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(rows[2][1], rows[1][1]);\n \t\t\t\t\teuler.y = Math::atan2(rows[0][2], rows[0][0]);\n \t\t\t\t\teuler.z = Math::asin(-sz);\n@@ -532,8 +537,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\treal_t m12 = rows[1][2];\n \n-\t\t\tif (m12 < (1 - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (m12 > -(1 - (real_t)CMP_EPSILON)) {\n+\t\t\tif (m12 < (1 - epsilon)) {\n+\t\t\t\tif (m12 > -(1 - epsilon)) {\n \t\t\t\t\t// is this a pure X rotation?\n \t\t\t\t\tif (rows[1][0] == 0 && rows[0][1] == 0 && rows[0][2] == 0 && rows[2][0] == 0 && rows[0][0] == 1) {\n \t\t\t\t\t\t// return the simplest form (human friendlier in editor and scripts)\n@@ -568,8 +573,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sz = rows[1][0];\n-\t\t\tif (sz < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sz > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sz < (1.0f - epsilon)) {\n+\t\t\t\tif (sz > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(-rows[1][2], rows[1][1]);\n \t\t\t\t\teuler.y = Math::atan2(-rows[2][0], rows[0][0]);\n \t\t\t\t\teuler.z = Math::asin(sz);\n@@ -596,8 +601,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \t\t\t//        -cx*sy            sx                    cx*cy\n \t\t\tVector3 euler;\n \t\t\treal_t sx = rows[2][1];\n-\t\t\tif (sx < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sx > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sx < (1.0f - epsilon)) {\n+\t\t\t\tif (sx > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::asin(sx);\n \t\t\t\t\teuler.y = Math::atan2(-rows[2][0], rows[2][2]);\n \t\t\t\t\teuler.z = Math::atan2(-rows[0][1], rows[1][1]);\n@@ -624,8 +629,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \t\t\t//        -sy               cy*sx                 cy*cx\n \t\t\tVector3 euler;\n \t\t\treal_t sy = rows[2][0];\n-\t\t\tif (sy < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sy > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sy < (1.0f - epsilon)) {\n+\t\t\t\tif (sy > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(rows[2][1], rows[2][2]);\n \t\t\t\t\teuler.y = Math::asin(-sy);\n \t\t\t\t\teuler.z = Math::atan2(rows[1][0], rows[0][0]);\n", "test_patch": "diff --git a/tests/core/math/test_basis.h b/tests/core/math/test_basis.h\nindex f8c5ef279dcd..6166986286e4 100644\n--- a/tests/core/math/test_basis.h\n+++ b/tests/core/math/test_basis.h\n@@ -93,9 +93,9 @@ void test_rotation(Vector3 deg_original_euler, EulerOrder rot_order) {\n \n \tBasis res = to_rotation.inverse() * rotation_from_computed_euler;\n \n-\tCHECK_MESSAGE((res.get_column(0) - Vector3(1.0, 0.0, 0.0)).length() <= 0.1, vformat(\"Fail due to X %s\\n\", String(res.get_column(0))));\n-\tCHECK_MESSAGE((res.get_column(1) - Vector3(0.0, 1.0, 0.0)).length() <= 0.1, vformat(\"Fail due to Y %s\\n\", String(res.get_column(1))));\n-\tCHECK_MESSAGE((res.get_column(2) - Vector3(0.0, 0.0, 1.0)).length() <= 0.1, vformat(\"Fail due to Z %s\\n\", String(res.get_column(2))));\n+\tCHECK_MESSAGE((res.get_column(0) - Vector3(1.0, 0.0, 0.0)).length() <= 0.001, vformat(\"Fail due to X %s\\n\", String(res.get_column(0))));\n+\tCHECK_MESSAGE((res.get_column(1) - Vector3(0.0, 1.0, 0.0)).length() <= 0.001, vformat(\"Fail due to Y %s\\n\", String(res.get_column(1))));\n+\tCHECK_MESSAGE((res.get_column(2) - Vector3(0.0, 0.0, 1.0)).length() <= 0.001, vformat(\"Fail due to Z %s\\n\", String(res.get_column(2))));\n \n \t// Double check `to_rotation` decomposing with XYZ rotation order.\n \tconst Vector3 euler_xyz_from_rotation = to_rotation.get_euler(EulerOrder::XYZ);\n@@ -103,9 +103,9 @@ void test_rotation(Vector3 deg_original_euler, EulerOrder rot_order) {\n \n \tres = to_rotation.inverse() * rotation_from_xyz_computed_euler;\n \n-\tCHECK_MESSAGE((res.get_column(0) - Vector3(1.0, 0.0, 0.0)).length() <= 0.1, vformat(\"Double check with XYZ rot order failed, due to X %s\\n\", String(res.get_column(0))));\n-\tCHECK_MESSAGE((res.get_column(1) - Vector3(0.0, 1.0, 0.0)).length() <= 0.1, vformat(\"Double check with XYZ rot order failed, due to Y %s\\n\", String(res.get_column(1))));\n-\tCHECK_MESSAGE((res.get_column(2) - Vector3(0.0, 0.0, 1.0)).length() <= 0.1, vformat(\"Double check with XYZ rot order failed, due to Z %s\\n\", String(res.get_column(2))));\n+\tCHECK_MESSAGE((res.get_column(0) - Vector3(1.0, 0.0, 0.0)).length() <= 0.001, vformat(\"Double check with XYZ rot order failed, due to X %s\\n\", String(res.get_column(0))));\n+\tCHECK_MESSAGE((res.get_column(1) - Vector3(0.0, 1.0, 0.0)).length() <= 0.001, vformat(\"Double check with XYZ rot order failed, due to Y %s\\n\", String(res.get_column(1))));\n+\tCHECK_MESSAGE((res.get_column(2) - Vector3(0.0, 0.0, 1.0)).length() <= 0.001, vformat(\"Double check with XYZ rot order failed, due to Z %s\\n\", String(res.get_column(2))));\n \n \tINFO(vformat(\"Rotation order: %s\\n.\", get_rot_order_name(rot_order)));\n \tINFO(vformat(\"Original Rotation: %s\\n\", String(deg_original_euler)));\n@@ -176,6 +176,12 @@ TEST_CASE(\"[Basis] Euler conversions\") {\n \tvectors_to_test.push_back(Vector3(120.0, -150.0, -130.0));\n \tvectors_to_test.push_back(Vector3(120.0, 150.0, -130.0));\n \tvectors_to_test.push_back(Vector3(120.0, 150.0, 130.0));\n+\tvectors_to_test.push_back(Vector3(89.9, 0.0, 0.0));\n+\tvectors_to_test.push_back(Vector3(-89.9, 0.0, 0.0));\n+\tvectors_to_test.push_back(Vector3(0.0, 89.9, 0.0));\n+\tvectors_to_test.push_back(Vector3(0.0, -89.9, 0.0));\n+\tvectors_to_test.push_back(Vector3(0.0, 0.0, 89.9));\n+\tvectors_to_test.push_back(Vector3(0.0, 0.0, -89.9));\n \n \tfor (int h = 0; h < euler_order_to_test.size(); h += 1) {\n \t\tfor (int i = 0; i < vectors_to_test.size(); i += 1) {\n", "problem_statement": "Potential problem in look_at()\n### Godot version\n\n3.3.2.stable.official\n\n### System information\n\nmacOS 11.3.1 GLES3\n\n### Issue description\n\nWhen using the `look_at()` function in a script attached to a camera, there seems to be some sort of discretization effect occurring in my tests; for a camera positioned at e.g. `(0,90,0)` looking towards `(0,0,0)`, I see rendering artifacts. These artifacts persist for a small region around `(0,0,0)` on the `x,z` plane (approx. +/- 0.1 units).\r\n\r\nThis effect is particularly jarring when it manifests as part of an animated movement, producing an effect almost like a magnet snapping the camera view direction onto the target location at `(0,0,0)`.\r\n\r\nI've attached an example project to demonstrate this effect; a camera is located at `(0,90,0)` above a simple plane, and the `look_at()` method is invoked in the camera's `_process()` method. The target position is slowly moved left and right via a `sin()` function, and the effect is visible when the camera looks in the vicinity of `(0,0,0)`.\r\n\r\nAm I missing something important, here?\n\n### Steps to reproduce\n\nSee issue description, and attached project file.\n\n### Minimal reproduction project\n\n[Weird.zip](https://github.com/godotengine/godot/files/6697007/Weird.zip)\r\n\n", "hints_text": "Looks more like a problem with `OmniLight`'s shadow. Duplicate (_edit: only the shadow visual artifact part_) of #25750?\r\n\r\n- Plane's depth/width subdivision = 0:\r\n![Godot_v3 3 2-stable_win64_sgiu2cLQ8G](https://user-images.githubusercontent.com/9283098/122996666-6c03f880-d3ab-11eb-96bb-c74e6370a841.png)\r\n\r\n- Plane's depth/width subdivision = 3:\r\n![Godot_v3 3 2-stable_win64_nV6YpehB9n](https://user-images.githubusercontent.com/9283098/122998137-fa2cae80-d3ac-11eb-9b4f-908c5732ce47.png)\r\n\r\n\r\n\n\r\n\r\nhttps://user-images.githubusercontent.com/4098291/123001028-e74ab780-d375-11eb-8122-51d5fcdd2211.mov\r\n\r\nIt's not just a rendering artifact, I think there's also a \"jump\" or \"snap\" effect on the camera view vector. At least there is for me! :)\nI can reproduce this on 3.3.2 on Linux, so this is not an OS-specific issue. I have no idea where the issue is coming from though\u2026\r\n\r\nCan you reproduce this if you move everything away from the origin? Visually, it should look identical but without the bug occurring.\n> It's not just a rendering artifact, I think there's also a \"jump\" or \"snap\" effect on the camera view vector. At least there is for me! :)\r\n\r\nYou're right, the rendering artifact is gone when shadow is disabled in `OmniLight` but for `targetPos.x == targetPos.y == 0.0` and `abs(targetPos.z) < 0.403` it looks (incorrectly) like we're looking at `targetPos == (0, 0, 0)`.\nSimply moving the camera from `(0,90,0)` to `(1,90,0)` (but keeping the target as `(0,0,f(sin t))`) seems to fix the \"snapping magnet\" issue.\r\n\r\nIf I then change the dynamic camera target from `(0,0,f(sin t))` to `(1,0,f(sin t))` (i.e., the camera view vector is back along `(0,-1,0)`) someone puts the pesky magnet back onto the camera ...\nSmells like a numerical issue when calculating the inverse of a transform matrix, maybe?\r\n\r\nOr perhaps a pesky `if (x < epilson) { y = constant; } /* prevent DBZ */` sort of issue somewhere?", "created_at": "2025-01-29 05:07:52", "merge_commit_sha": "4fcd9598dee15d9cd386f6c9c2a0c76623568267", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102099", "base_commit": "6dc78c8aa17ad46e701e0c4e7b7632c2f0e098f1", "patch": "diff --git a/editor/export/editor_export_platform.cpp b/editor/export/editor_export_platform.cpp\nindex b931e6feba29..8b44a6f88ab0 100644\n--- a/editor/export/editor_export_platform.cpp\n+++ b/editor/export/editor_export_platform.cpp\n@@ -50,6 +50,26 @@\n #include \"scene/resources/image_texture.h\"\n #include \"scene/resources/packed_scene.h\"\n \n+class EditorExportSaveProxy {\n+\tHashSet<String> saved_paths;\n+\tEditorExportPlatform::EditorExportSaveFunction save_func;\n+\tbool tracking_saves = false;\n+\n+public:\n+\tbool has_saved(const String &p_path) const { return saved_paths.has(p_path); }\n+\n+\tError save_file(void *p_userdata, const String &p_path, const Vector<uint8_t> &p_data, int p_file, int p_total, const Vector<String> &p_enc_in_filters, const Vector<String> &p_enc_ex_filters, const Vector<uint8_t> &p_key, uint64_t p_seed) {\n+\t\tif (tracking_saves) {\n+\t\t\tsaved_paths.insert(p_path.simplify_path().trim_prefix(\"res://\"));\n+\t\t}\n+\n+\t\treturn save_func(p_userdata, p_path, p_data, p_file, p_total, p_enc_in_filters, p_enc_ex_filters, p_key, p_seed);\n+\t}\n+\n+\tEditorExportSaveProxy(EditorExportPlatform::EditorExportSaveFunction p_save_func, bool p_track_saves) :\n+\t\t\tsave_func(p_save_func), tracking_saves(p_track_saves) {}\n+};\n+\n static int _get_pad(int p_alignment, int p_n) {\n \tint rest = p_n % p_alignment;\n \tint pad = 0;\n@@ -60,17 +80,6 @@ static int _get_pad(int p_alignment, int p_n) {\n \treturn pad;\n }\n \n-template <typename T>\n-static bool _has_pack_path(const T &p_paths, const String &p_path) {\n-\tfor (const String &E : p_paths) {\n-\t\tif (E.simplify_path().trim_prefix(\"res://\") == p_path) {\n-\t\t\treturn true;\n-\t\t}\n-\t}\n-\n-\treturn false;\n-}\n-\n #define PCK_PADDING 16\n \n bool EditorExportPlatform::fill_log_messages(RichTextLabel *p_log, Error p_err) {\n@@ -1140,9 +1149,10 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t}\n \t}\n \n+\tEditorExportSaveProxy save_proxy(p_save_func, p_remove_func != nullptr);\n+\n \tError err = OK;\n \tVector<Ref<EditorExportPlugin>> export_plugins = EditorExport::get_singleton()->get_export_plugins();\n-\tVector<String> extra_paths;\n \n \tstruct SortByName {\n \t\tbool operator()(const Ref<EditorExportPlugin> &left, const Ref<EditorExportPlugin> &right) const {\n@@ -1163,12 +1173,10 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t}\n \t\t}\n \t\tfor (int j = 0; j < export_plugins[i]->extra_files.size(); j++) {\n-\t\t\terr = p_save_func(p_udata, export_plugins[i]->extra_files[j].path, export_plugins[i]->extra_files[j].data, 0, paths.size(), enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\terr = save_proxy.save_file(p_udata, export_plugins[i]->extra_files[j].path, export_plugins[i]->extra_files[j].data, 0, paths.size(), enc_in_filters, enc_ex_filters, key, seed);\n \t\t\tif (err != OK) {\n \t\t\t\treturn err;\n \t\t\t}\n-\n-\t\t\textra_paths.push_back(export_plugins[i]->extra_files[j].path);\n \t\t}\n \n \t\texport_plugins.write[i]->_clear();\n@@ -1281,7 +1289,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t}\n \n \t\t\tfor (int j = 0; j < export_plugins[i]->extra_files.size(); j++) {\n-\t\t\t\terr = p_save_func(p_udata, export_plugins[i]->extra_files[j].path, export_plugins[i]->extra_files[j].data, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\terr = save_proxy.save_file(p_udata, export_plugins[i]->extra_files[j].path, export_plugins[i]->extra_files[j].data, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\t\t\tif (err != OK) {\n \t\t\t\t\treturn err;\n \t\t\t\t}\n@@ -1290,8 +1298,6 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t\t\tpath_remaps.push_back(path);\n \t\t\t\t\tpath_remaps.push_back(export_plugins[i]->extra_files[j].path);\n \t\t\t\t}\n-\n-\t\t\t\textra_paths.push_back(export_plugins[i]->extra_files[j].path);\n \t\t\t}\n \n \t\t\tif (export_plugins[i]->skipped) {\n@@ -1313,7 +1319,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\tif (importer_type == \"keep\") {\n \t\t\t\t// Just keep file as-is.\n \t\t\t\tVector<uint8_t> array = FileAccess::get_file_as_bytes(path);\n-\t\t\t\terr = p_save_func(p_udata, path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\terr = save_proxy.save_file(p_udata, path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \n \t\t\t\tif (err != OK) {\n \t\t\t\t\treturn err;\n@@ -1356,13 +1362,13 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t\tsarr.resize(cs.size());\n \t\t\t\tmemcpy(sarr.ptrw(), cs.ptr(), sarr.size());\n \n-\t\t\t\terr = p_save_func(p_udata, path + \".import\", sarr, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\terr = save_proxy.save_file(p_udata, path + \".import\", sarr, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\t\t\tif (err != OK) {\n \t\t\t\t\treturn err;\n \t\t\t\t}\n \t\t\t\t// Now actual remapped file:\n \t\t\t\tsarr = FileAccess::get_file_as_bytes(export_path);\n-\t\t\t\terr = p_save_func(p_udata, export_path, sarr, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\terr = save_proxy.save_file(p_udata, export_path, sarr, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\t\t\tif (err != OK) {\n \t\t\t\t\treturn err;\n \t\t\t\t}\n@@ -1392,14 +1398,14 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t\t\tif (remap == \"path\") {\n \t\t\t\t\t\tString remapped_path = config->get_value(\"remap\", remap);\n \t\t\t\t\t\tVector<uint8_t> array = FileAccess::get_file_as_bytes(remapped_path);\n-\t\t\t\t\t\terr = p_save_func(p_udata, remapped_path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\t\t\terr = save_proxy.save_file(p_udata, remapped_path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\t\t\t\t} else if (remap.begins_with(\"path.\")) {\n \t\t\t\t\t\tString feature = remap.get_slice(\".\", 1);\n \n \t\t\t\t\t\tif (remap_features.has(feature)) {\n \t\t\t\t\t\t\tString remapped_path = config->get_value(\"remap\", remap);\n \t\t\t\t\t\t\tVector<uint8_t> array = FileAccess::get_file_as_bytes(remapped_path);\n-\t\t\t\t\t\t\terr = p_save_func(p_udata, remapped_path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\t\t\t\terr = save_proxy.save_file(p_udata, remapped_path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\t\t\t\t\t} else {\n \t\t\t\t\t\t\t// Remove paths if feature not enabled.\n \t\t\t\t\t\t\tconfig->erase_section_key(\"remap\", remap);\n@@ -1425,7 +1431,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t\tsarr.resize(cs.size());\n \t\t\t\tmemcpy(sarr.ptrw(), cs.ptr(), sarr.size());\n \n-\t\t\t\terr = p_save_func(p_udata, path + \".import\", sarr, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\terr = save_proxy.save_file(p_udata, path + \".import\", sarr, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \n \t\t\t\tif (err != OK) {\n \t\t\t\t\treturn err;\n@@ -1446,7 +1452,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t}\n \n \t\t\tVector<uint8_t> array = FileAccess::get_file_as_bytes(export_path);\n-\t\t\terr = p_save_func(p_udata, export_path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\terr = save_proxy.save_file(p_udata, export_path, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\t\tif (err != OK) {\n \t\t\t\treturn err;\n \t\t\t}\n@@ -1510,7 +1516,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t\t\t\tnew_file.write[j] = utf8[j];\n \t\t\t\t}\n \n-\t\t\t\terr = p_save_func(p_udata, from + \".remap\", new_file, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\t\t\terr = save_proxy.save_file(p_udata, from + \".remap\", new_file, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\t\t\tif (err != OK) {\n \t\t\t\t\treturn err;\n \t\t\t\t}\n@@ -1532,7 +1538,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t\t} else {\n \t\t\tarray = FileAccess::get_file_as_bytes(forced_export[i]);\n \t\t}\n-\t\terr = p_save_func(p_udata, forced_export[i], array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\terr = save_proxy.save_file(p_udata, forced_export[i], array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\n@@ -1541,7 +1547,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \tDictionary int_export = get_internal_export_files(p_preset, p_debug);\n \tfor (const Variant &int_name : int_export.keys()) {\n \t\tconst PackedByteArray &array = int_export[int_name];\n-\t\terr = p_save_func(p_udata, int_name, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\t\terr = save_proxy.save_file(p_udata, int_name, array, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\n@@ -1553,22 +1559,16 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \tVector<uint8_t> data = FileAccess::get_file_as_bytes(engine_cfb);\n \tDirAccess::remove_file_or_error(engine_cfb);\n \n-\terr = p_save_func(p_udata, \"res://\" + config_file, data, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n+\terr = save_proxy.save_file(p_udata, \"res://\" + config_file, data, idx, total, enc_in_filters, enc_ex_filters, key, seed);\n \tif (err != OK) {\n \t\treturn err;\n \t}\n \n \tif (p_remove_func) {\n-\t\tfor (const String &E : PackedData::get_singleton()->get_file_paths()) {\n-\t\t\tString simplified_path = E.simplify_path();\n-\t\t\tif (simplified_path == config_file) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n-\t\t\tString pack_path = simplified_path.trim_suffix(\".remap\");\n-\n-\t\t\tif (!_has_pack_path(paths, pack_path) && !_has_pack_path(extra_paths, pack_path) && !_has_pack_path(path_remaps, pack_path) && !_has_pack_path(forced_export, pack_path)) {\n-\t\t\t\terr = p_remove_func(p_udata, E);\n+\t\tHashSet<String> currently_loaded_paths = PackedData::get_singleton()->get_file_paths();\n+\t\tfor (const String &path : currently_loaded_paths) {\n+\t\t\tif (!save_proxy.has_saved(path)) {\n+\t\t\t\terr = p_remove_func(p_udata, path);\n \t\t\t\tif (err != OK) {\n \t\t\t\t\treturn err;\n \t\t\t\t}\n", "test_patch": "", "problem_statement": "Exported patch PCKs incorrectly mark imported resources for removal\n### Tested versions\n\n- Reproducible in: 4.4.beta [6dc78c8aa17ad46e701e0c4e7b7632c2f0e098f1]\n\n### System information\n\nWindows 11 (10.0.26100)\n\n### Issue description\n\nCurrently when exporting a PCK as a patch, where you've only changed something like a single `*.gd` file, and then inspect the resulting `*.pck` file, you'll find that pretty much every imported asset and their corresponding `*.import` file have been saved to the patch as a removal (size 0 with `PACK_FILE_REMOVAL` flag set).\n\nThe expected result would of course be for the patch to only contain the changed `*.gd` file, or its corresponding `*.gdc` file in the case of binary tokenization.\n\nIt's unclear if this is a regression or if I somehow let this slip through as part of my contribution to #97356.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Export the project using \"Export PCK/ZIP\" with \"Export as Patch\" disabled.\n- Add the newly exported pack as a base pack under the \"Patches\" tab in the export dialog.\n- Add a newline somewhere in `my_script.gd`.\n- Export the project using \"Export PCK/ZIP\" with \"Export as Patch\" enabled.\n- Inspect both PCK files using whatever method you prefer (e.g. [GodotPckTool](https://github.com/hhyyrylainen/GodotPckTool)).\n- Note how the second exported PCK contains not only `my_script.gdc`, but also `icon.svg.import` and `.godot/imported/icon.svg-*.ctex`, both with a size of 0 (and flag bit 2 set).\n\n(I've also included ready-made `exports/main.pck` and `exports/patch.pck` with the MRP.)\n\n### Minimal reproduction project (MRP)\n\n[pck-removal-bug.zip](https://github.com/user-attachments/files/18563102/pck-removal-bug.zip)\n", "hints_text": "", "created_at": "2025-01-27 20:00:20", "merge_commit_sha": "d421cccf0bbab8a987b62b9e49f559531147519b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102045", "base_commit": "b15b24b087e792335d919fd83055f50f276fbe22", "patch": "diff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex b1945eb47a2e..3a8d6ff6c584 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -5853,16 +5853,20 @@ Error DisplayServerX11::remove_embedded_process(OS::ProcessID p_pid) {\n \t// Handle bad window errors silently because just in case the embedded window was closed.\n \tint (*oldHandler)(Display *, XErrorEvent *) = XSetErrorHandler(&bad_window_error_handler);\n \n-\t// Send the message to gracefully close the window.\n-\tXEvent ev;\n-\tmemset(&ev, 0, sizeof(ev));\n-\tev.xclient.type = ClientMessage;\n-\tev.xclient.window = ep->process_window;\n-\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n-\tev.xclient.format = 32;\n-\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n-\tev.xclient.data.l[1] = CurrentTime;\n-\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\t// Check if the window is still valid.\n+\tXWindowAttributes attr;\n+\tif (XGetWindowAttributes(x11_display, ep->process_window, &attr)) {\n+\t\t// Send the message to gracefully close the window.\n+\t\tXEvent ev;\n+\t\tmemset(&ev, 0, sizeof(ev));\n+\t\tev.xclient.type = ClientMessage;\n+\t\tev.xclient.window = ep->process_window;\n+\t\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n+\t\tev.xclient.format = 32;\n+\t\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n+\t\tev.xclient.data.l[1] = CurrentTime;\n+\t\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\t}\n \n \t// Restore default error handler.\n \tXSetErrorHandler(oldHandler);\n", "test_patch": "", "problem_statement": "\"Unhandled XServer error\" is printed every time the project is stopped when running from the editor with game embedding\n### Tested versions\n\n- Reproducible in: 4.4.beta b15b24b08\n- Not reproducible in: 4.4.beta1\n\n### System information\n\nGodot v4.4.beta (b15b24b08) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (nvidia; 565.77) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\n\"Unhandled XServer error\" is printed every time the project is stopped when running from the editor with game embedding:\n\n```\nERROR: Unhandled XServer error: BadWindow (invalid Window parameter)\n   Major opcode of failed request: 25\n   Serial number of failed request: 0\n   Current serial number in output stream: 53707\n   at: default_window_error_handler (platform/linuxbsd/x11/display_server_x11.cpp:1180)\n```\n\nSome notes: \n\n- This occurs regardless of the game embedding type (within the editor or as a floating window), as long as game embedding is used.\n- This does not occur when running the project without the editor, or with game window embedding disabled.\n- There appears to be no negative consequences to this error, but it's annoying to see in the Output panel regardless.\n- This only occurs when quitting by pressing <kbd>F8</kbd>. Pressing <kbd>Alt + F4</kbd>, pressing the window manager's close button at the top of the window (for the floating window).\n- **However**, if you press <kbd>Alt + F4</kbd> with the game window embedded in the editor (not floating) and the game window is focused, the error will also occur. This also occurs if you use `xkill` and target the running project window.\n\n### Steps to reproduce\n\n- Create a new project, add any node and run it with game window embedding enabled.\n- Stop the project by pressing <kbd>F8</kbd>.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-01-26 01:35:49", "merge_commit_sha": "4793965c1f6c3b6a4fbff6ea83e0c7b8e266cb1a", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101987", "base_commit": "b0655dc86f096b3496a9ab5b18965676d4fb35ba", "patch": "diff --git a/platform/linuxbsd/wayland/display_server_wayland.cpp b/platform/linuxbsd/wayland/display_server_wayland.cpp\nindex 532eaa6bcf49..f9b34ff043bf 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.cpp\n+++ b/platform/linuxbsd/wayland/display_server_wayland.cpp\n@@ -1033,7 +1033,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \t\tHashMap<CursorShape, CustomCursor>::Iterator cursor_c = custom_cursors.find(p_shape);\n \n \t\tif (cursor_c) {\n-\t\t\tif (cursor_c->value.rid == p_cursor->get_rid() && cursor_c->value.hotspot == p_hotspot) {\n+\t\t\tif (cursor_c->value.resource == p_cursor && cursor_c->value.hotspot == p_hotspot) {\n \t\t\t\t// We have a cached cursor. Nice.\n \t\t\t\twayland_thread.cursor_set_shape(p_shape);\n \t\t\t\treturn;\n@@ -1049,7 +1049,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \n \t\tCustomCursor &cursor = custom_cursors[p_shape];\n \n-\t\tcursor.rid = p_cursor->get_rid();\n+\t\tcursor.resource = p_cursor;\n \t\tcursor.hotspot = p_hotspot;\n \n \t\twayland_thread.cursor_shape_set_custom_image(p_shape, image, p_hotspot);\ndiff --git a/platform/linuxbsd/wayland/display_server_wayland.h b/platform/linuxbsd/wayland/display_server_wayland.h\nindex 8c3bac9c7e3b..43a8b01b3208 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.h\n+++ b/platform/linuxbsd/wayland/display_server_wayland.h\n@@ -101,7 +101,7 @@ class DisplayServerWayland : public DisplayServer {\n \t};\n \n \tstruct CustomCursor {\n-\t\tRID rid;\n+\t\tRef<Resource> resource;\n \t\tPoint2i hotspot;\n \t};\n \n", "test_patch": "", "problem_statement": "Wayland Cursor custom image doesn't update when using Image instead of Texture2D\n### Tested versions\n\n- v4.4.beta.gentoo [4ce466d7f]\n\n### System information\n\nLinux Gentoo using Wayland\n\n### Issue description\n\nWhen using the Wayland DisplayServer you can only update the custom mouse cursor once if you are using Image instead of Texture2D resources and the images have the same hotspot.\n\nThe function `Input.set_custom_mouse_cursor` claims that it is okay to use either an Image or a Texture2D as a custom cursor image. The caching code in `DisplayServerWayland::cursor_set_custom_image` checks for cursor reuse using \"get_rid()\" on the provided resource. Since an Image does not have a RID, any image will always enter the branch `// We have a cached cursor. Nice.`.\n\nBug is visible since #96647 was fixed, although the underlying bug was already older than that.\n\n### Workarounds\n* Use Texture2D instead of image resources - may cause undesired overhead to convert back to image\n* Reset the cursor in between - may cause cursor flickering\n* Move the hotspot locations to force a cache miss - unwanted extra work to make images suitable with different hotspots\n\n### Steps to reproduce\n\n* Force editor and game to use the Wayland display server\n* Make sure the referenced `img1` and `img2` are imported as Image and not as Texture.\n\n```gdscript\nInput.set_custom_mouse_cursor(img1, Input.CURSOR_ARROW)\n# Correctly shows img1 as the cursor\nInput.set_custom_mouse_cursor(img2, Input.CURSOR_ARROW)\n# Still shows img1 as the cursor\n```\n\n### Minimal reproduction project (MRP)\n\n[wayland-cursor-reproducer.zip](https://github.com/user-attachments/files/18510307/wayland-cursor-reproducer.zip)\n", "hints_text": "Hi, thank you for you report and for the thorough analysis!\n\n> Since an Image does not have a RID\n\nShoot, I really had no idea. You just saved me from _a lot_ of debugging :D\n\nYou see, this `Image` thing is actually relatively new. For a long time the custom cursor method only supported `Texture2D` but then #88970 allowed images and this quirk slipped right through.\n\nI'll fix this ASAP!", "created_at": "2025-01-24 14:36:43", "merge_commit_sha": "4f3dddbbffb272b561b89f8bbc28955040750c7e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101931", "base_commit": "b0655dc86f096b3496a9ab5b18965676d4fb35ba", "patch": "diff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 02e2486fb9c9..de376599de4c 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -2971,8 +2971,23 @@ void RendererCanvasRenderRD::_uniform_set_invalidation_callback(void *p_userdata\n \tstatic_cast<RendererCanvasRenderRD *>(singleton)->rid_set_to_uniform_set.erase(*key);\n }\n \n+void RendererCanvasRenderRD::_canvas_texture_invalidation_callback(bool p_deleted, void *p_userdata) {\n+\tKeyValue<RID, TightLocalVector<RID>> *kv = static_cast<KeyValue<RID, TightLocalVector<RID>> *>(p_userdata);\n+\tRD *rd = RD::get_singleton();\n+\tfor (RID rid : kv->value) {\n+\t\t// the invalidation callback will take care of clearing rid_set_to_uniform_set cache also\n+\t\trd->free(rid);\n+\t}\n+\tkv->value.clear();\n+\tif (p_deleted) {\n+\t\tstatic_cast<RendererCanvasRenderRD *>(singleton)->canvas_texture_to_uniform_set.erase(kv->key);\n+\t}\n+}\n+\n void RendererCanvasRenderRD::_render_batch(RD::DrawListID p_draw_list, CanvasShaderData *p_shader_data, RenderingDevice::FramebufferFormatID p_framebuffer_format, Light *p_lights, Batch const *p_batch, RenderingMethod::RenderInfo *r_render_info) {\n \t{\n+\t\tRendererRD::TextureStorage *ts = RendererRD::TextureStorage::get_singleton();\n+\n \t\tRIDSetKey key(\n \t\t\t\tp_batch->tex_info->state,\n \t\t\t\tstate.canvas_instance_data_buffers[state.current_data_buffer_index].instance_buffers[p_batch->instance_buffer_index]);\n@@ -2992,6 +3007,19 @@ void RendererCanvasRenderRD::_render_batch(RD::DrawListID p_draw_list, CanvasSha\n \t\t\tconst RIDCache::Pair *iter = rid_set_to_uniform_set.insert(key, rid);\n \t\t\tuniform_set = &iter->data;\n \t\t\tRD::get_singleton()->uniform_set_set_invalidation_callback(rid, RendererCanvasRenderRD::_uniform_set_invalidation_callback, (void *)&iter->key);\n+\n+\t\t\t// If this is a CanvasTexture, it must be tracked so that any changes to the diffuse, normal\n+\t\t\t// or specular channels invalidate all associated uniform sets.\n+\t\t\tif (ts->owns_canvas_texture(p_batch->tex_info->state.texture)) {\n+\t\t\t\tKeyValue<RID, TightLocalVector<RID>> *kv = nullptr;\n+\t\t\t\tif (HashMap<RID, TightLocalVector<RID>>::Iterator i = canvas_texture_to_uniform_set.find(p_batch->tex_info->state.texture); i == canvas_texture_to_uniform_set.end()) {\n+\t\t\t\t\tkv = &*canvas_texture_to_uniform_set.insert(p_batch->tex_info->state.texture, { *uniform_set });\n+\t\t\t\t} else {\n+\t\t\t\t\ti->value.push_back(rid);\n+\t\t\t\t\tkv = &*i;\n+\t\t\t\t}\n+\t\t\t\tts->canvas_texture_set_invalidation_callback(p_batch->tex_info->state.texture, RendererCanvasRenderRD::_canvas_texture_invalidation_callback, kv);\n+\t\t\t}\n \t\t}\n \n \t\tif (state.current_batch_uniform_set != *uniform_set) {\ndiff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.h b/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\nindex 3b071cd804a1..0605b18ba44e 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\n@@ -485,9 +485,14 @@ class RendererCanvasRenderRD : public RendererCanvasRender {\n \n \tstatic void _before_evict(RendererCanvasRenderRD::RIDSetKey &p_key, RID &p_rid);\n \tstatic void _uniform_set_invalidation_callback(void *p_userdata);\n+\tstatic void _canvas_texture_invalidation_callback(bool p_deleted, void *p_userdata);\n \n \ttypedef LRUCache<RIDSetKey, RID, HashableHasher<RIDSetKey>, HashMapComparatorDefault<RIDSetKey>, _before_evict> RIDCache;\n \tRIDCache rid_set_to_uniform_set;\n+\t/// Maps a CanvasTexture to its associated uniform sets, which must\n+\t/// be invalidated when the CanvasTexture is updated, such as changing the\n+\t/// diffuse texture.\n+\tHashMap<RID, TightLocalVector<RID>> canvas_texture_to_uniform_set;\n \n \tstruct Batch {\n \t\t// Position in the UBO measured in bytes\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\nindex a297b9717816..69ae3d971a4e 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n@@ -43,9 +43,15 @@ using namespace RendererRD;\n void TextureStorage::CanvasTexture::clear_cache() {\n \tinfo_cache[0] = CanvasTextureCache();\n \tinfo_cache[1] = CanvasTextureCache();\n+\tif (invalidated_callback != nullptr) {\n+\t\tinvalidated_callback(false, invalidated_callback_userdata);\n+\t}\n }\n \n TextureStorage::CanvasTexture::~CanvasTexture() {\n+\tif (invalidated_callback != nullptr) {\n+\t\tinvalidated_callback(true, invalidated_callback_userdata);\n+\t}\n }\n \n ///////////////////////////////////////////////////////////////////////////\n@@ -735,6 +741,16 @@ TextureStorage::CanvasTextureInfo TextureStorage::canvas_texture_get_info(RID p_\n \treturn res;\n }\n \n+void TextureStorage::canvas_texture_set_invalidation_callback(RID p_canvas_texture, InvalidationCallback p_callback, void *p_userdata) {\n+\tCanvasTexture *ct = canvas_texture_owner.get_or_null(p_canvas_texture);\n+\tif (!ct) {\n+\t\treturn;\n+\t}\n+\n+\tct->invalidated_callback = p_callback;\n+\tct->invalidated_callback_userdata = p_userdata;\n+}\n+\n /* Texture API */\n \n RID TextureStorage::texture_allocate() {\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.h b/servers/rendering/renderer_rd/storage_rd/texture_storage.h\nindex bfee1e367e0c..2073c34ded7b 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.h\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.h\n@@ -90,6 +90,8 @@ class TextureStorage : public RendererTextureStorage {\n \t\t_FORCE_INLINE_ bool is_null() const { return diffuse.is_null(); }\n \t};\n \n+\ttypedef void (*InvalidationCallback)(bool p_deleted, void *p_userdata);\n+\n private:\n \tfriend class LightStorage;\n \tfriend class MaterialStorage;\n@@ -118,6 +120,9 @@ class TextureStorage : public RendererTextureStorage {\n \t\tRS::CanvasItemTextureRepeat texture_repeat = RS::CANVAS_ITEM_TEXTURE_REPEAT_DEFAULT;\n \t\tCanvasTextureCache info_cache[2];\n \n+\t\tInvalidationCallback invalidated_callback = nullptr;\n+\t\tvoid *invalidated_callback_userdata = nullptr;\n+\n \t\tSize2i size_cache = Size2i(1, 1);\n \t\tbool use_normal_cache = false;\n \t\tbool use_specular_cache = false;\n@@ -499,6 +504,7 @@ class TextureStorage : public RendererTextureStorage {\n \tvirtual void canvas_texture_set_texture_repeat(RID p_item, RS::CanvasItemTextureRepeat p_repeat) override;\n \n \tCanvasTextureInfo canvas_texture_get_info(RID p_texture, RS::CanvasItemTextureFilter p_base_filter, RS::CanvasItemTextureRepeat p_base_repeat, bool p_use_srgb, bool p_texture_is_data);\n+\tvoid canvas_texture_set_invalidation_callback(RID p_canvas_texture, InvalidationCallback p_callback, void *p_userdata);\n \n \t/* Texture API */\n \n", "test_patch": "", "problem_statement": "[4.4beta1] Script modification of CanvasTexture doesn't update\n### Tested versions\n\nv4.4.beta1.official [d33da79d3]\n\n### System information\n\nGodot v4.4.beta1 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Mobile) - dedicated AMD Radeon RX 6600 (Advanced Micro Devices, Inc.; 32.0.11027.1003) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nAltering the `.diffuse_texture` of a CanvasTexture at runtime via script causes no visual update. This causes my player character to no longer turn around.\n\n### Steps to reproduce\n\nModify the `.diffuse_texture` of a CanvasTexture via script. It doesn't change visually.\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/EmilyV99/godot-bug-examples/tree/texture-diffuse-mrp\n\nPressing left/right changes the diffuse texture to face the pressed direction. Nothing happens at all visually.\n", "hints_text": "possibly related to #101702 \nAh, it isn't just script modification either- using an `AnimatedTexture` as a diffuse texture fails to animate at all. So yeah, CanvasTextures seem to just be caching something and never updating it for any reason whatsoever.", "created_at": "2025-01-22 19:46:11", "merge_commit_sha": "21e1115ed3dd8f165f01b6d6ebd89c3d517c1f2f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101895", "base_commit": "a7146ef807a7676f51a8a63cf4441ad647f4be66", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex b1f7a8498a3a..f0f1a915f011 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -652,14 +652,20 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \tr_arguments.insert_after(N, itos(rect.size.x) + \"x\" + itos(rect.size.y));\n }\n \n-void GameView::_window_before_closing() {\n+void GameView::_window_close_request() {\n \t// Before the parent window closed, we close the embedded game. That prevents\n \t// the embedded game to be seen without a parent window for a fraction of second.\n \tif (EditorRunBar::get_singleton()->is_playing() && (embedded_process->is_embedding_completed() || embedded_process->is_embedding_in_progress())) {\n+\t\t// Try to gracefully close the window. That way, the NOTIFICATION_WM_CLOSE_REQUEST\n+\t\t// notification should be propagated in the game process.\n \t\tembedded_process->reset();\n-\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n-\t\t// actually closes.\n-\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\n+\t\t// When the embedding is not complete, we need to kill the process.\n+\t\tif (embedded_process->is_embedding_in_progress()) {\n+\t\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n+\t\t\t// actually closes.\n+\t\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\t\t}\n \t}\n }\n \n@@ -829,7 +835,8 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tp_debugger->connect(\"session_started\", callable_mp(this, &GameView::_sessions_changed));\n \tp_debugger->connect(\"session_stopped\", callable_mp(this, &GameView::_sessions_changed));\n \n-\tp_wrapper->connect(\"window_before_closing\", callable_mp(this, &GameView::_window_before_closing));\n+\tp_wrapper->set_override_close_request(true);\n+\tp_wrapper->connect(\"window_close_requested\", callable_mp(this, &GameView::_window_close_request));\n \tp_wrapper->connect(\"window_size_changed\", callable_mp(this, &GameView::_update_floating_window_settings));\n }\n \ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 959da73dcde8..273652dae821 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -162,7 +162,7 @@ class GameView : public VBoxContainer {\n \tvoid _camera_override_button_toggled(bool p_pressed);\n \tvoid _camera_override_menu_id_pressed(int p_id);\n \n-\tvoid _window_before_closing();\n+\tvoid _window_close_request();\n \tvoid _update_floating_window_settings();\n \tvoid _attach_script_debugger();\n \tvoid _detach_script_debugger();\ndiff --git a/editor/window_wrapper.cpp b/editor/window_wrapper.cpp\nindex 37a3efc91e90..22e2fda68567 100644\n--- a/editor/window_wrapper.cpp\n+++ b/editor/window_wrapper.cpp\n@@ -101,12 +101,6 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \n \tNode *parent = _get_wrapped_control_parent();\n \n-\t// In the GameView plugin, we need to the the signal before the window is actually closed\n-\t// to prevent the embedded game to be seen the parent window for a fraction of a second.\n-\tif (!p_visible) {\n-\t\temit_signal(\"window_before_closing\");\n-\t}\n-\n \tif (wrapped_control->get_parent() != parent) {\n \t\t// Move the control to the window.\n \t\twrapped_control->reparent(parent, false);\n@@ -120,7 +114,7 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \t}\n \n \twindow->set_visible(p_visible);\n-\tif (!p_visible) {\n+\tif (!p_visible && !override_close_request) {\n \t\temit_signal(\"window_close_requested\");\n \t}\n \temit_signal(\"window_visibility_changed\", p_visible);\n@@ -141,10 +135,17 @@ void WindowWrapper::_window_size_changed() {\n \temit_signal(SNAME(\"window_size_changed\"));\n }\n \n+void WindowWrapper::_window_close_request() {\n+\tif (override_close_request) {\n+\t\temit_signal(\"window_close_requested\");\n+\t} else {\n+\t\tset_window_enabled(false);\n+\t}\n+}\n+\n void WindowWrapper::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"window_visibility_changed\", PropertyInfo(Variant::BOOL, \"visible\")));\n \tADD_SIGNAL(MethodInfo(\"window_close_requested\"));\n-\tADD_SIGNAL(MethodInfo(\"window_before_closing\"));\n \tADD_SIGNAL(MethodInfo(\"window_size_changed\"));\n }\n \n@@ -330,6 +331,10 @@ void WindowWrapper::grab_window_focus() {\n \t}\n }\n \n+void WindowWrapper::set_override_close_request(bool p_enabled) {\n+\toverride_close_request = p_enabled;\n+}\n+\n WindowWrapper::WindowWrapper() {\n \tif (!EditorNode::get_singleton()->is_multi_window_enabled()) {\n \t\treturn;\n@@ -342,7 +347,7 @@ WindowWrapper::WindowWrapper() {\n \tadd_child(window);\n \twindow->hide();\n \n-\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::set_window_enabled).bind(false));\n+\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::_window_close_request));\n \twindow->connect(\"size_changed\", callable_mp(this, &WindowWrapper::_window_size_changed));\n \n \tShortcutBin *capturer = memnew(ShortcutBin);\ndiff --git a/editor/window_wrapper.h b/editor/window_wrapper.h\nindex 3f4e9385861c..e33c8c179d53 100644\n--- a/editor/window_wrapper.h\n+++ b/editor/window_wrapper.h\n@@ -50,12 +50,15 @@ class WindowWrapper : public MarginContainer {\n \n \tRef<Shortcut> enable_shortcut;\n \n+\tbool override_close_request = false;\n+\n \tRect2 _get_default_window_rect() const;\n \tNode *_get_wrapped_control_parent() const;\n \n \tvoid _set_window_enabled_with_rect(bool p_visible, const Rect2 p_rect);\n \tvoid _set_window_rect(const Rect2 p_rect);\n \tvoid _window_size_changed();\n+\tvoid _window_close_request();\n \n protected:\n \tstatic void _bind_methods();\n@@ -84,6 +87,8 @@ class WindowWrapper : public MarginContainer {\n \tvoid set_margins_enabled(bool p_enabled);\n \tvoid grab_window_focus();\n \n+\tvoid set_override_close_request(bool p_enabled);\n+\n \tWindowWrapper();\n \t~WindowWrapper();\n };\ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex b17f72dc5c04..b1945eb47a2e 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -5849,6 +5849,24 @@ Error DisplayServerX11::remove_embedded_process(OS::ProcessID p_pid) {\n \t}\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n+\n+\t// Handle bad window errors silently because just in case the embedded window was closed.\n+\tint (*oldHandler)(Display *, XErrorEvent *) = XSetErrorHandler(&bad_window_error_handler);\n+\n+\t// Send the message to gracefully close the window.\n+\tXEvent ev;\n+\tmemset(&ev, 0, sizeof(ev));\n+\tev.xclient.type = ClientMessage;\n+\tev.xclient.window = ep->process_window;\n+\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n+\tev.xclient.format = 32;\n+\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n+\tev.xclient.data.l[1] = CurrentTime;\n+\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\n+\t// Restore default error handler.\n+\tXSetErrorHandler(oldHandler);\n+\n \tembedded_processes.erase(p_pid);\n \tmemdelete(ep);\n \ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex ac7fa8b3c69e..1d3a6f0ca4f2 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -2975,6 +2975,9 @@ Error DisplayServerWindows::remove_embedded_process(OS::ProcessID p_pid) {\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n \n+\t// Send a close message to gracefully close the process.\n+\tPostMessage(ep->window_handle, WM_CLOSE, 0, 0);\n+\n \t// This is a workaround to ensure the parent window correctly regains focus after the\n \t// embedded window is closed. When the embedded window is closed while it has focus,\n \t// the parent window (the editor) does not become active. It appears focused but is not truly activated.\n", "test_patch": "", "problem_statement": "Closing game running in editor no longer sends NotificationWMCloseRequest - v4.4Beta1\n### Tested versions\n\n- Reproducible in 4.4Beta1 .NET\n- Not reproducible in 4.3 .NET\n\n### System information\n\nWindows 11 - Godot_v4.4-beta1_mono_win64\n\n### Issue description\n\nWhen closing the game while running it via the editor, a NotificationWMCloseRequest is no longer sent in 4.4.\n\n### Steps to reproduce\n\nSee minimal reproduction project\n\n### Minimal reproduction project (MRP)\n\nAttached is a simple 'save on exit' project that will demonstrate the issue.  When running the game in the editor interface in 4.3, the entire game state will be saved upon closing (and loaded when you next restart the game).  When running the game in the editor interface in 4.4, the game will no longer save because a NotificationWMCloseRequest is no longer sent when the game is closing.\n\nNote: The `StageManager` class is responsible for receiving the NotificationWMCloseRequest in this project.\n\n[BrackeysFirstSavedGame.zip](https://github.com/user-attachments/files/18483606/BrackeysFirstSavedGame.zip)\n", "hints_text": "Seems like another issue with embedded mode.\n\nIt is still work if you run the project in non-embedded mode. `NOTIFICATION_WM_CLOSE_REQUEST` is sent when `close` button in the window title is pressed, not when the game exits. It's not emitted when closing by any other means (like `get_tree().quit()` for example).\n\nWhen running in an embedded / floating mode, the actual window title bar is not visible, and closing the floating window stops the game instantly (same as pressing the stop button in the editor).\nI disabled embedded-mode and, you are correct, everything appears to be working again.\n\nI think it would be preferable as a future enhancement to cause quitting the game while in embedded mode or via clicking the `Stop Running Project` button to trigger a `NOTIFICATION_WM_CLOSE_REQUEST`, but it can maybe be argued this is not a regression.", "created_at": "2025-01-22 02:01:55", "merge_commit_sha": "76f074b01d089cdfa0272b5515585979b6607da9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101803", "base_commit": "7b1ed520bdcca21d36e25e2094802b9b33dae2c6", "patch": "diff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex d1a40e7b105c..ac2b37470ef1 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -210,20 +210,6 @@ void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \tp_jolt_body.MoveKinematic(new_position, new_rotation, p_step);\n }\n \n-void JoltBody3D::_pre_step_rigid(float p_step, JPH::Body &p_jolt_body) {\n-\t_integrate_forces(p_step, p_jolt_body);\n-\t_enqueue_call_queries();\n-}\n-\n-void JoltBody3D::_pre_step_kinematic(float p_step, JPH::Body &p_jolt_body) {\n-\t_update_gravity(p_jolt_body);\n-\t_move_kinematic(p_step, p_jolt_body);\n-\n-\tif (reports_contacts()) {\n-\t\t_enqueue_call_queries();\n-\t}\n-}\n-\n JPH::EAllowedDOFs JoltBody3D::_calculate_allowed_dofs() const {\n \tif (is_static()) {\n \t\treturn JPH::EAllowedDOFs::All;\n@@ -1237,13 +1223,18 @@ void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID:\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID_LINEAR: {\n-\t\t\t_pre_step_rigid(p_step, p_jolt_body);\n+\t\t\t_integrate_forces(p_step, p_jolt_body);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_KINEMATIC: {\n-\t\t\t_pre_step_kinematic(p_step, p_jolt_body);\n+\t\t\t_update_gravity(p_jolt_body);\n+\t\t\t_move_kinematic(p_step, p_jolt_body);\n \t\t} break;\n \t}\n \n+\tif (_should_call_queries()) {\n+\t\t_enqueue_call_queries();\n+\t}\n+\n \tcontact_count = 0;\n }\n \ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.h b/modules/jolt_physics/objects/jolt_body_3d.h\nindex 4f5d4006edcf..9b9472e73ae8 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_body_3d.h\n@@ -110,6 +110,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvirtual void _add_to_space() override;\n \n+\tbool _should_call_queries() const { return state_sync_callback.is_valid() || custom_integration_callback.is_valid(); }\n \tvoid _enqueue_call_queries();\n \tvoid _dequeue_call_queries();\n \n@@ -117,9 +118,6 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvoid _move_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n-\tvoid _pre_step_rigid(float p_step, JPH::Body &p_jolt_body);\n-\tvoid _pre_step_kinematic(float p_step, JPH::Body &p_jolt_body);\n-\n \tJPH::EAllowedDOFs _calculate_allowed_dofs() const;\n \n \tJPH::MassProperties _calculate_mass_properties(const JPH::Shape &p_shape) const;\n", "test_patch": "", "problem_statement": "Jolt Physics and sync_to_physics prevents any AnimatableBody3D transforms\n### Tested versions\n\n- Reproducible: 4.4.beta1\n- Not reproducible: 4.4.dev7\n\n### System information\n\nGodot v4.4.beta1 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1070 (NVIDIA; 32.0.15.6094) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nUsing the Jolt physics engine and enabling `AnimatableBody3D.sync_to_physics` stops the object from moving at all when setting a transform, position or similar.\n\nDisabling `sync_to_physics`, or switching to the Godot physics engine fixes the problem.\n\n \n\n### Steps to reproduce\n\nCreate an `AnimatableBody3D` Node. Set `sync_to_physics` to true. Use the Jolt physics engine.\n\n### Minimal reproduction project (MRP)\n\n[jolt-transform-bug.zip](https://github.com/user-attachments/files/18464415/jolt-transform-bug.zip)\n\n", "hints_text": "I guess https://github.com/godotengine/godot/pull/100056 now depends on this \nThis looks to be yet another regression caused by #100983.", "created_at": "2025-01-19 15:34:02", "merge_commit_sha": "7c69fbd292a9aeb28399d1743866b9c70561bc77", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101760", "base_commit": "7b1ed520bdcca21d36e25e2094802b9b33dae2c6", "patch": "diff --git a/modules/websocket/wsl_peer.cpp b/modules/websocket/wsl_peer.cpp\nindex 9ffc343571e8..f50b4c480652 100644\n--- a/modules/websocket/wsl_peer.cpp\n+++ b/modules/websocket/wsl_peer.cpp\n@@ -860,10 +860,12 @@ void WSLPeer::close(int p_code, String p_reason) {\n \t\t}\n \t}\n \n-\theartbeat_waiting = false;\n-\tin_buffer.clear();\n-\tpacket_buffer.resize(0);\n-\tpending_message.clear();\n+\tif (ready_state == STATE_CLOSED) {\n+\t\theartbeat_waiting = false;\n+\t\tin_buffer.clear();\n+\t\tpacket_buffer.resize(0);\n+\t\tpending_message.clear();\n+\t}\n }\n \n IPAddress WSLPeer::get_connected_host() const {\n", "test_patch": "", "problem_statement": "[4.4.dev5] Websockets stuck in STATE_CLOSING\n### Tested versions\n\nStarting with 4.4.dev5\nConfirmed to work with 4.4.dev4\n\n### System information\n\nGodot v4.4.dev5 - Windows 10.0.26100 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 6700 XT (Advanced Micro Devices, Inc.; 32.0.12033.1030) - Intel(R) Core(TM) i5-9600K CPU @ 3.70GHz (6 threads)\n\n### Issue description\n\nClient WebSocketPeers get stuck on STATE_CLOSING when close() is called.\n\n### Steps to reproduce\n\n- Download MRP with any Godot version >= 4.4.dev5\n- Click on \"Client disconnect\"\n- Check output\n\n### Minimal reproduction project (MRP)\n\n[100948.zip](https://github.com/user-attachments/files/18277136/100948.zip)\n\n", "hints_text": "", "created_at": "2025-01-18 15:00:47", "merge_commit_sha": "7a63dc94ae9c7e4db1144bd47096fe8010c09046", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101752", "base_commit": "7b1ed520bdcca21d36e25e2094802b9b33dae2c6", "patch": "diff --git a/core/core_bind.cpp b/core/core_bind.cpp\nindex 6974d98234cc..acd589783ece 100644\n--- a/core/core_bind.cpp\n+++ b/core/core_bind.cpp\n@@ -113,12 +113,12 @@ PackedStringArray ResourceLoader::get_dependencies(const String &p_path) {\n }\n \n bool ResourceLoader::has_cached(const String &p_path) {\n-\tString local_path = ProjectSettings::get_singleton()->localize_path(p_path);\n+\tString local_path = ::ResourceLoader::_validate_local_path(p_path);\n \treturn ResourceCache::has(local_path);\n }\n \n Ref<Resource> ResourceLoader::get_cached_ref(const String &p_path) {\n-\tString local_path = ProjectSettings::get_singleton()->localize_path(p_path);\n+\tString local_path = ::ResourceLoader::_validate_local_path(p_path);\n \treturn ResourceCache::get_ref(local_path);\n }\n \ndiff --git a/core/io/resource_loader.cpp b/core/io/resource_loader.cpp\nindex 8f873d859b65..7cc91ef4318b 100644\n--- a/core/io/resource_loader.cpp\n+++ b/core/io/resource_loader.cpp\n@@ -495,7 +495,7 @@ void ResourceLoader::_run_load_task(void *p_userdata) {\n \tcurr_load_task = curr_load_task_backup;\n }\n \n-static String _validate_local_path(const String &p_path) {\n+String ResourceLoader::_validate_local_path(const String &p_path) {\n \tResourceUID::ID uid = ResourceUID::get_singleton()->text_to_id(p_path);\n \tif (uid != ResourceUID::INVALID_ID) {\n \t\treturn ResourceUID::get_singleton()->get_id_path(uid);\ndiff --git a/core/io/resource_loader.h b/core/io/resource_loader.h\nindex f933e88b23bf..56052b6a6fc4 100644\n--- a/core/io/resource_loader.h\n+++ b/core/io/resource_loader.h\n@@ -36,6 +36,10 @@\n #include \"core/object/worker_thread_pool.h\"\n #include \"core/os/thread.h\"\n \n+namespace core_bind {\n+class ResourceLoader;\n+}\n+\n class ConditionVariable;\n \n template <int Tag>\n@@ -101,6 +105,7 @@ typedef void (*ResourceLoadedCallback)(Ref<Resource> p_resource, const String &p\n \n class ResourceLoader {\n \tfriend class LoadToken;\n+\tfriend class core_bind::ResourceLoader;\n \n \tenum {\n \t\tMAX_LOADERS = 64\n@@ -217,6 +222,8 @@ class ResourceLoader {\n \n \tstatic bool _ensure_load_progress();\n \n+\tstatic String _validate_local_path(const String &p_path);\n+\n public:\n \tstatic Error load_threaded_request(const String &p_path, const String &p_type_hint = \"\", bool p_use_sub_threads = false, ResourceFormatLoader::CacheMode p_cache_mode = ResourceFormatLoader::CACHE_MODE_REUSE);\n \tstatic ThreadLoadStatus load_threaded_get_status(const String &p_path, float *r_progress = nullptr);\n", "test_patch": "", "problem_statement": "[4.4beta1] ResourceLoader.has_cached() does not return proper values for UIDs\n### Tested versions\n\nReproducible in 4.4 dev 4, 5, 6, 7, and beta 1. Probably in previous 4.4 dev builds as well.\n\n### System information\n\nGodot v4.4.beta1 - Arch Linux #1 SMP PREEMPT_DYNAMIC Fri, 10 Jan 2025 00:39:41 +0000 on Wayland - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated AMD Radeon RX 6600 XT (RADV NAVI23) - AMD Ryzen 5 5600X 6-Core Processor (12 threads)\n\n### Issue description\n\nPassing a UID into `ResourceLoader.has_cached()` returns `false` for a resource that is cached. Passing the resource path for the resource with the same UID properly returns `true`.\n\n### Steps to reproduce\n\n1. Create a Sprite2D node and attach the `icon.svg` as the texture.\n2. Attach a script to the Sprite2D node to see if the `icon.svg` resource is cached. Something like:\n```\nextends Sprite2D\n\nvar resource_path: String = \"res://icon.svg\"\nvar uid: String = \"\" # Insert UID of icon.svg here.\n\n\nfunc _ready():\n\tprint(\"ResourceLoader.has_cached results:\\nResource Path: \",\n\t\t\tResourceLoader.has_cached(resource_path), \" UID: \", ResourceLoader.has_cached(uid))\n```\n3. Observe that passing the resource path returns `true` whereas passing the UID returns `false`.\n\n### Minimal reproduction project (MRP)\n\n[resource-loader-bug.zip](https://github.com/user-attachments/files/18463852/resource-loader-bug.zip)\n", "hints_text": "While ResourceLoader class in core has been properly changed to handle UIDs, the `has_cached()` function has no ResourceLoader equivalent and is just handled in `core_bind.cpp`.\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/core_bind.cpp#L115-L118\nDoing a brief once over of the `localize_path()` function, it does not seem to be able to handle UIDs.\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/config/project_settings.cpp#L149-L213\nSomewhere in this chain, UIDs probably need to be properly handled as the rest of ResourceLoader functions seem fit to handle them.\n\nEdit: As reference, ResourceLoader passes `path`s to this function and refers to the returned path as the `local_path`:\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/io/resource_loader.cpp#L498-L507\n`ResourceLoader.get_cached_ref()` probably has the same problem.\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/core_bind.cpp#L120-L122", "created_at": "2025-01-18 12:32:53", "merge_commit_sha": "376b1c9de9c05b5cedfc9f53daed294e8148f964", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101726", "base_commit": "b15b24b087e792335d919fd83055f50f276fbe22", "patch": "diff --git a/SConstruct b/SConstruct\nindex 94bef048a072..8f8f329f233d 100644\n--- a/SConstruct\n+++ b/SConstruct\n@@ -107,22 +107,11 @@ for x in sorted(glob.glob(\"platform/*\")):\n     sys.path.remove(tmppath)\n     sys.modules.pop(\"detect\")\n \n-custom_tools = [\"default\"]\n-\n-platform_arg = ARGUMENTS.get(\"platform\", ARGUMENTS.get(\"p\", False))\n-\n-if platform_arg == \"android\":\n-    custom_tools = [\"clang\", \"clang++\", \"as\", \"ar\", \"link\"]\n-elif platform_arg == \"web\":\n-    # Use generic POSIX build toolchain for Emscripten.\n-    custom_tools = [\"cc\", \"c++\", \"ar\", \"link\", \"textfile\", \"zip\"]\n-elif os.name == \"nt\" and methods.get_cmdline_bool(\"use_mingw\", False):\n-    custom_tools = [\"mingw\"]\n-\n # We let SCons build its default ENV as it includes OS-specific things which we don't\n-# want to have to pull in manually.\n+# want to have to pull in manually. However we enforce no \"tools\", which we register\n+# further down after parsing our platform-specific configuration.\n # Then we prepend PATH to make it take precedence, while preserving SCons' own entries.\n-env = Environment(tools=custom_tools)\n+env = Environment(tools=[])\n env.PrependENVPath(\"PATH\", os.getenv(\"PATH\"))\n env.PrependENVPath(\"PKG_CONFIG_PATH\", os.getenv(\"PKG_CONFIG_PATH\"))\n if \"TERM\" in os.environ:  # Used for colored output.\n@@ -168,11 +157,7 @@ if profile:\n opts = Variables(customs, ARGUMENTS)\n \n # Target build options\n-if env.scons_version >= (4, 3):\n-    opts.Add([\"platform\", \"p\"], \"Target platform (%s)\" % \"|\".join(platform_list), \"\")\n-else:\n-    opts.Add(\"platform\", \"Target platform (%s)\" % \"|\".join(platform_list), \"\")\n-    opts.Add(\"p\", \"Alias for 'platform'\", \"\")\n+opts.Add(([\"platform\", \"p\"], \"Target platform (%s)\" % \"|\".join(platform_list), \"\"))\n opts.Add(EnumVariable(\"target\", \"Compilation target\", \"editor\", (\"editor\", \"template_release\", \"template_debug\")))\n opts.Add(EnumVariable(\"arch\", \"CPU architecture\", \"auto\", [\"auto\"] + architectures, architecture_aliases))\n opts.Add(BoolVariable(\"dev_build\", \"Developer build with dev-only debugging code (DEV_ENABLED)\", False))\n@@ -312,10 +297,7 @@ if env[\"import_env_vars\"]:\n \n # Platform selection: validate input, and add options.\n \n-if env.scons_version < (4, 3) and not env[\"platform\"]:\n-    env[\"platform\"] = env[\"p\"]\n-\n-if env[\"platform\"] == \"\":\n+if not env[\"platform\"]:\n     # Missing `platform` argument, try to detect platform automatically\n     if (\n         sys.platform.startswith(\"linux\")\n@@ -330,7 +312,7 @@ if env[\"platform\"] == \"\":\n     elif sys.platform == \"win32\":\n         env[\"platform\"] = \"windows\"\n \n-    if env[\"platform\"] != \"\":\n+    if env[\"platform\"]:\n         print(f'Automatically detected platform: {env[\"platform\"]}')\n \n # Deprecated aliases kept for compatibility.\n@@ -352,7 +334,7 @@ if env[\"platform\"] not in platform_list:\n \n     if env[\"platform\"] == \"list\":\n         print(text)\n-    elif env[\"platform\"] == \"\":\n+    elif not env[\"platform\"]:\n         print_error(\"Could not detect platform automatically.\\n\" + text)\n     else:\n         print_error(f'Invalid target platform \"{env[\"platform\"]}\".\\n' + text)\n@@ -434,6 +416,23 @@ env.modules_detected = modules_detected\n opts.Update(env, {**ARGUMENTS, **env.Dictionary()})\n Help(opts.GenerateHelpText(env))\n \n+\n+# FIXME: Tool assignment happening at this stage is a direct consequence of getting the platform logic AFTER the SCons\n+# environment was already been constructed. Fixing this would require a broader refactor where all options are setup\n+# ahead of time with native validator/converter functions.\n+tmppath = \"./platform/\" + env[\"platform\"]\n+sys.path.insert(0, tmppath)\n+import detect\n+\n+custom_tools = [\"default\"]\n+try:  # Platform custom tools are optional\n+    custom_tools = detect.get_tools(env)\n+except AttributeError:\n+    pass\n+for tool in custom_tools:\n+    env.Tool(tool)\n+\n+\n # add default include paths\n \n env.Prepend(CPPPATH=[\"#\"])\n@@ -515,10 +514,6 @@ if not env[\"deprecated\"]:\n if env[\"precision\"] == \"double\":\n     env.Append(CPPDEFINES=[\"REAL_T_IS_DOUBLE\"])\n \n-tmppath = \"./platform/\" + env[\"platform\"]\n-sys.path.insert(0, tmppath)\n-import detect\n-\n # Default num_jobs to local cpu count if not user specified.\n # SCons has a peculiarity where user-specified options won't be overridden\n # by SetOption, so we can rely on this to know if we should use our default.\n@@ -587,7 +582,7 @@ if env[\"dev_mode\"]:\n if env[\"production\"]:\n     env[\"use_static_cpp\"] = methods.get_cmdline_bool(\"use_static_cpp\", True)\n     env[\"debug_symbols\"] = methods.get_cmdline_bool(\"debug_symbols\", False)\n-    if platform_arg == \"android\":\n+    if env[\"platform\"] == \"android\":\n         env[\"swappy\"] = methods.get_cmdline_bool(\"swappy\", True)\n     # LTO \"auto\" means we handle the preferred option in each platform detect.py.\n     env[\"lto\"] = ARGUMENTS.get(\"lto\", \"auto\")\ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 03a208391cf3..571cfd9819c0 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -19,6 +19,10 @@ def can_build():\n     return os.path.exists(get_env_android_sdk_root())\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    return [\"clang\", \"clang++\", \"as\", \"ar\", \"link\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable\n \ndiff --git a/platform/web/detect.py b/platform/web/detect.py\nindex 87315a405f27..9b9234480408 100644\n--- a/platform/web/detect.py\n+++ b/platform/web/detect.py\n@@ -28,6 +28,11 @@ def can_build():\n     return WhereIs(\"emcc\") is not None\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    # Use generic POSIX build toolchain for Emscripten.\n+    return [\"cc\", \"c++\", \"ar\", \"link\", \"textfile\", \"zip\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable\n \ndiff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 943de74a3e9d..db65bb64a7b5 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -155,6 +155,13 @@ def detect_build_env_arch():\n     return \"\"\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    if os.name != \"nt\" or env[\"use_mingw\"]:\n+        return [\"mingw\"]\n+    else:\n+        return [\"default\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable, EnumVariable\n \n@@ -326,10 +333,6 @@ def setup_mingw(env: \"SConsEnvironment\"):\n         print_error(\"No valid compilers found, use MINGW_PREFIX environment variable to set MinGW path.\")\n         sys.exit(255)\n \n-    env.Tool(\"mingw\")\n-    env.AppendUnique(CCFLAGS=env.get(\"ccflags\", \"\").split())\n-    env.AppendUnique(RCFLAGS=env.get(\"rcflags\", \"\").split())\n-\n     print(\"Using MinGW, arch %s\" % (env[\"arch\"]))\n \n \n", "test_patch": "", "problem_statement": "SCons detect configure removes LINKFLAGS added beforehand (eg. command line)\n### Tested versions\n\nReproducible: Master\nNot Reproducible: 4.3\n\n### System information\n\nGodot v4.4.dev (bb2225753) - Windows 11 (build 22631) - Multi-window, 3 monitors - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 4070 (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 3700X 8-Core Processor (16 threads)\n\n### Issue description\n\nHey,\n\nbuilding with SCons on Master does not respect linkflags in the command line anymore (4.3 is not a problem).\nThats the build command I use:\n```scons dev_build=yes use_mingw=yes use_llvm=yes dev_mode=yes compiledb=yes linkflags=\"-Wl,-pdb=\" ccflags=\"-g -gcodeview\"```\nAnd it does not add the linkflags anymore.\n\nI could narrow it down to https://github.com/godotengine/godot/blob/1aaf20b1f1f3ab59f04db74b166540327a3f1f90/SConstruct#L616\nAdding a linkflag parameter before is ignored and after not.\nAs this was already there in 4.3, I cannot exactly tell what brought up the behavior in the current master.\n\n\n\n\n### Steps to reproduce\n\nAdd ```env.Append(LINKFLAGS=[\"-Whatever\"])``` before: https://github.com/godotengine/godot/blob/1aaf20b1f1f3ab59f04db74b166540327a3f1f90/SConstruct#L616\nIt is removed.\nAdd ```env.Append(LINKFLAGS=[\"-Whatever\"])``` after the line and it is added.\n\n### Minimal reproduction project (MRP)\n\n---\n", "hints_text": "Confirmed, that's a regression from #98105.\n\nThe `env.Tool(\"mingw\")` added in this PR in the setup function resets flags, and then it just manually reparses 2 of the potential user-defined flags but not `linkflags`.\n\nI'd question whether this change was necessary, this PR seems to add a number of hacks. (Not that it wasn't hacky before, but at least those were battle-tested hacks :P)", "created_at": "2025-01-17 23:15:25", "merge_commit_sha": "46434b0f2ee25f036ce36a7c928438b766ce1fc5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101664", "base_commit": "fc827bbe256e47e1d7ec6945deb9c1e79724dac9", "patch": "diff --git a/scene/3d/physics/vehicle_body_3d.cpp b/scene/3d/physics/vehicle_body_3d.cpp\nindex c5c9153059d5..c508d4ff4ffe 100644\n--- a/scene/3d/physics/vehicle_body_3d.cpp\n+++ b/scene/3d/physics/vehicle_body_3d.cpp\n@@ -852,18 +852,26 @@ void VehicleBody3D::_body_state_changed(PhysicsDirectBodyState3D *p_state) {\n \tfor (int i = 0; i < wheels.size(); i++) {\n \t\tVehicleWheel3D &wheel = *wheels[i];\n \t\tVector3 relpos = wheel.m_raycastInfo.m_hardPointWS - p_state->get_transform().origin;\n-\t\tVector3 vel = p_state->get_linear_velocity() + (p_state->get_angular_velocity()).cross(relpos); // * mPos);\n+\t\tVector3 vel = p_state->get_linear_velocity() + (p_state->get_angular_velocity()).cross(relpos);\n \n \t\tif (wheel.m_raycastInfo.m_isInContact) {\n \t\t\tconst Transform3D &chassisWorldTransform = p_state->get_transform();\n \n+\t\t\t// Get forward vector.\n \t\t\tVector3 fwd(\n \t\t\t\t\tchassisWorldTransform.basis[0][Vector3::AXIS_Z],\n \t\t\t\t\tchassisWorldTransform.basis[1][Vector3::AXIS_Z],\n \t\t\t\t\tchassisWorldTransform.basis[2][Vector3::AXIS_Z]);\n \n+\t\t\t// Apply steering rotation to forward vector for steerable wheels.\n+\t\t\tif (wheel.steers) {\n+\t\t\t\tBasis steering_mat(Vector3(0, 1, 0), wheel.m_steering);\n+\t\t\t\tfwd = steering_mat.xform(fwd);\n+\t\t\t}\n+\n \t\t\treal_t proj = fwd.dot(wheel.m_raycastInfo.m_contactNormalWS);\n \t\t\tfwd -= wheel.m_raycastInfo.m_contactNormalWS * proj;\n+\t\t\tfwd.normalize();\n \n \t\t\treal_t proj2 = fwd.dot(vel);\n \n", "test_patch": "", "problem_statement": "get_rpm() on VehicleWheel3D is calculated incorrectly\n### Tested versions\n\n- Reproducible in: 4.2 stable, 4.3 stable, 4.4.dev7, 4.4 stable\n\n### System information\n\nGodot v4.3.stable (77dcf97d8) - Windows 10.0.26100 - Vulkan (Forward+) - integrated Intel(R) UHD Graphics (Intel Corporation; 31.0.101.2130) - Intel(R) Core(TM) i7-10610U CPU @ 1.80GHz (8 Threads)\n\n### Issue description\n\nWhen you call get_rpm on a VehicleWheel3D when the steering angle is not equal to 0, it returns the wrong RPM. The only workaround I have found is to use trigonometry:\n```gdscript\nvar corrected_rpm = wheel.get_rpm() / cos(wheel.steering)\n```\n\n### Steps to reproduce\n\n- Create a VehicleBody3D\n- Create a VehicleWheel3D as a child\n- Spin up the wheel (engine_force or with friction against the ground)\n- Turn the wheel with steering on the VehicleBody3D\n- Call get_rpm() on the VehicleWheel3D which now gives the wrong rpm\n\n### Minimal reproduction project (MRP)\n\n[vehicle-bug.zip](https://github.com/user-attachments/files/18447812/vehicle-bug.zip)\n", "hints_text": "After some digging it looks like the vehicle implementation is heavily based on the [Bullet Physics vehicle](https://github.com/bulletphysics/bullet3/blob/master/src/BulletDynamics/Vehicle/btRaycastVehicle.cpp). Bullet has the exact same broken code as godot:\n\n```cpp\n\tfor (int i = 0; i < wheels.size(); i++) {\n\t\tVehicleWheel3D &wheel = *wheels[i];\n\t\tVector3 relpos = wheel.m_raycastInfo.m_hardPointWS - p_state->get_transform().origin;\n\t\tVector3 vel = p_state->get_linear_velocity() + (p_state->get_angular_velocity()).cross(relpos); // * mPos);\n\n\t\tif (wheel.m_raycastInfo.m_isInContact) {\n\t\t\tconst Transform3D &chassisWorldTransform = p_state->get_transform();\n\n\t\t\tVector3 fwd(\n\t\t\t\t\tchassisWorldTransform.basis[0][Vector3::AXIS_Z],\n\t\t\t\t\tchassisWorldTransform.basis[1][Vector3::AXIS_Z],\n\t\t\t\t\tchassisWorldTransform.basis[2][Vector3::AXIS_Z]);\n\n\t\t\treal_t proj = fwd.dot(wheel.m_raycastInfo.m_contactNormalWS);\n\t\t\tfwd -= wheel.m_raycastInfo.m_contactNormalWS * proj;\n\n\t\t\treal_t proj2 = fwd.dot(vel);\n\t\t\t\n\t\t\twheel.m_deltaRotation = (proj2 * step) / (wheel.m_wheelRadius);\n\t\t}\n\n\t\twheel.m_rotation += wheel.m_deltaRotation;\n\t\twheel.m_rpm = ((wheel.m_deltaRotation / step) * 60) / Math_TAU;\n\n\t\twheel.m_deltaRotation *= real_t(0.99); //damping of rotation when not in contact\n\t}\n```\n\nAs for how to fix it I am still trying to figure out. This code also does not spin up the wheel when off the ground which should also happen when there is engine_power.", "created_at": "2025-01-17 04:01:45", "merge_commit_sha": "50eed0142f8b7b712e56932bc6d0e9c5b7641598", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101625", "base_commit": "0726d3c7d5125d1a72ec318a2ec4ff11f9f7f8bb", "patch": "diff --git a/scene/gui/scroll_container.cpp b/scene/gui/scroll_container.cpp\nindex f3c50c626c17..3bad76baada4 100644\n--- a/scene/gui/scroll_container.cpp\n+++ b/scene/gui/scroll_container.cpp\n@@ -292,16 +292,20 @@ void ScrollContainer::_gui_focus_changed(Control *p_control) {\n void ScrollContainer::ensure_control_visible(Control *p_control) {\n \tERR_FAIL_COND_MSG(!is_ancestor_of(p_control), \"Must be an ancestor of the control.\");\n \n-\tRect2 global_rect = get_global_rect();\n-\tRect2 other_rect = p_control->get_global_rect();\n+\t// Just eliminate the rotation of this ScrollContainer.\n+\tTransform2D other_in_this = get_global_transform().affine_inverse() * p_control->get_global_transform();\n+\n+\tSize2 size = get_size();\n+\tRect2 other_rect = other_in_this.xform(Rect2(Point2(), p_control->get_size()));\n+\n \tfloat side_margin = v_scroll->is_visible() ? v_scroll->get_size().x : 0.0f;\n \tfloat bottom_margin = h_scroll->is_visible() ? h_scroll->get_size().y : 0.0f;\n \n-\tVector2 diff = Vector2(MAX(MIN(other_rect.position.x - (is_layout_rtl() ? side_margin : 0.0f), global_rect.position.x), other_rect.position.x + other_rect.size.x - global_rect.size.x + (!is_layout_rtl() ? side_margin : 0.0f)),\n-\t\t\tMAX(MIN(other_rect.position.y, global_rect.position.y), other_rect.position.y + other_rect.size.y - global_rect.size.y + bottom_margin));\n+\tVector2 diff = Vector2(MAX(MIN(other_rect.position.x - (is_layout_rtl() ? side_margin : 0.0f), 0.0f), other_rect.position.x + other_rect.size.x - size.x + (!is_layout_rtl() ? side_margin : 0.0f)),\n+\t\t\tMAX(MIN(other_rect.position.y, 0.0f), other_rect.position.y + other_rect.size.y - size.y + bottom_margin));\n \n-\tset_h_scroll(get_h_scroll() + (diff.x - global_rect.position.x));\n-\tset_v_scroll(get_v_scroll() + (diff.y - global_rect.position.y));\n+\tset_h_scroll(get_h_scroll() + diff.x);\n+\tset_v_scroll(get_v_scroll() + diff.y);\n }\n \n void ScrollContainer::_reposition_children() {\n", "test_patch": "", "problem_statement": "Follow Focus not working as expected in a rotated `ScrollContainer`\n### Tested versions\nBad: v4.0.stable.official [92bee43ad], master\n\n### System information\n\nGodot v4.4.dev (e19746352) - Linux Mint 22 (Wilma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1050 Ti (nvidia; 535.183.01) - Intel(R) Core(TM) i5-7300HQ CPU @ 2.50GHz (4 threads)\n\n### Issue description\n\nhttps://github.com/user-attachments/assets/443244ff-871d-42f7-b653-a80cc0ff159d\n\nNavigating down in a rotating `ScrollContainer` with follow focus enabled, the focused control is not fully visible. Note the StyleBox border.\n\n### Steps to reproduce\n\n1. Import and run the MRP;\n2. Select any node inside the `ScrollContainer` and navigate using `Tab`/`Shift + Tab`.\n3. Navigate down to reproduce the issue.\n\n### Minimal reproduction project (MRP)\n\n[MRP.zip](https://github.com/user-attachments/files/18432280/MRP.zip)\n", "hints_text": "", "created_at": "2025-01-16 05:02:17", "merge_commit_sha": "69c5b0307086a61fdc4377dc2a07b3918ad33107", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101616", "base_commit": "4ce466d7fa79e351d4295d5bb47e3266089c3a59", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex f626891bd8ea..caf877f40789 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1486,6 +1486,11 @@ void FileSystemDock::_try_move_item(const FileOrFolder &p_item, const String &p_\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tRef<Resource> res = ResourceCache::get_ref(old_path);\n+\t\t\t\tif (res.is_valid()) {\n+\t\t\t\t\tres->set_path_cache(new_path);\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \ndiff --git a/editor/plugins/script_editor_plugin.cpp b/editor/plugins/script_editor_plugin.cpp\nindex 77dd61b26346..1a1e5697c2d2 100644\n--- a/editor/plugins/script_editor_plugin.cpp\n+++ b/editor/plugins/script_editor_plugin.cpp\n@@ -1170,11 +1170,10 @@ void ScriptEditor::_live_auto_reload_running_scripts() {\n bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \tdisk_changed_list->clear();\n \tTreeItem *r = disk_changed_list->create_item();\n-\tdisk_changed_list->set_hide_root(true);\n \n \tbool need_ask = false;\n \tbool need_reload = false;\n-\tbool use_autoreload = bool(EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\"));\n+\tbool use_autoreload = EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\");\n \n \tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n \t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n@@ -1188,12 +1187,12 @@ bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \t\t\t\tcontinue; //internal script, who cares\n \t\t\t}\n \n-\t\t\tuint64_t last_date = edited_res->get_last_modified_time();\n-\t\t\tuint64_t date = FileAccess::get_modified_time(edited_res->get_path());\n+\t\t\tuint64_t last_date = se->edited_file_data.last_modified_time;\n+\t\t\tuint64_t date = FileAccess::get_modified_time(se->edited_file_data.path);\n \n \t\t\tif (last_date != date) {\n \t\t\t\tTreeItem *ti = disk_changed_list->create_item(r);\n-\t\t\t\tti->set_text(0, edited_res->get_path().get_file());\n+\t\t\t\tti->set_text(0, se->edited_file_data.path.get_file());\n \n \t\t\t\tif (!use_autoreload || se->is_unsaved()) {\n \t\t\t\t\tneed_ask = true;\n@@ -2231,11 +2230,6 @@ void ScriptEditor::_update_script_names() {\n \t\t\tRef<Texture2D> icon = se->get_theme_icon();\n \t\t\tString path = se->get_edited_resource()->get_path();\n \t\t\tbool saved = !path.is_empty();\n-\t\t\tif (saved) {\n-\t\t\t\t// The script might be deleted, moved, or renamed, so make sure\n-\t\t\t\t// to update original path to previously edited resource.\n-\t\t\t\tse->set_meta(\"_edit_res_path\", path);\n-\t\t\t}\n \t\t\tString name = se->get_name();\n \t\t\tRef<Script> scr = se->get_edited_resource();\n \n@@ -2633,7 +2627,8 @@ bool ScriptEditor::edit(const Ref<Resource> &p_resource, int p_line, int p_col,\n \n \t// If we delete a script within the filesystem, the original resource path\n \t// is lost, so keep it as metadata to figure out the exact tab to delete.\n-\tse->set_meta(\"_edit_res_path\", p_resource->get_path());\n+\tse->edited_file_data.path = p_resource->get_path();\n+\tse->edited_file_data.last_modified_time = FileAccess::get_modified_time(p_resource->get_path());\n \tif (se->get_edit_menu()) {\n \t\tse->get_edit_menu()->hide();\n \t\tmenu_hb->add_child(se->get_edit_menu());\n@@ -3042,6 +3037,15 @@ void ScriptEditor::_files_moved(const String &p_old_file, const String &p_new_fi\n \tif (!script_editor_cache->has_section(p_old_file)) {\n \t\treturn;\n \t}\n+\n+\tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n+\t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n+\t\tif (se && se->edited_file_data.path == p_old_file) {\n+\t\t\tse->edited_file_data.path = p_new_file;\n+\t\t\tbreak;\n+\t\t}\n+\t}\n+\n \tVariant state = script_editor_cache->get_value(p_old_file, \"state\");\n \tscript_editor_cache->erase_section(p_old_file);\n \tscript_editor_cache->set_value(p_new_file, \"state\", state);\n@@ -3064,7 +3068,7 @@ void ScriptEditor::_file_removed(const String &p_removed_file) {\n \t\tif (!se) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (se->get_meta(\"_edit_res_path\") == p_removed_file) {\n+\t\tif (se->edited_file_data.path == p_removed_file) {\n \t\t\t// The script is deleted with no undo, so just close the tab.\n \t\t\t_close_tab(i, false, false);\n \t\t}\n@@ -4414,9 +4418,10 @@ ScriptEditor::ScriptEditor(WindowWrapper *p_wrapper) {\n \t\tvbc->add_child(files_are_newer_label);\n \n \t\tdisk_changed_list = memnew(Tree);\n-\t\tvbc->add_child(disk_changed_list);\n+\t\tdisk_changed_list->set_hide_root(true);\n \t\tdisk_changed_list->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \t\tdisk_changed_list->set_v_size_flags(SIZE_EXPAND_FILL);\n+\t\tvbc->add_child(disk_changed_list);\n \n \t\tLabel *what_action_label = memnew(Label);\n \t\twhat_action_label->set_text(TTR(\"What action should be taken?\"));\ndiff --git a/editor/plugins/script_editor_plugin.h b/editor/plugins/script_editor_plugin.h\nindex 892a6155d5b7..50e6cfd91cd6 100644\n--- a/editor/plugins/script_editor_plugin.h\n+++ b/editor/plugins/script_editor_plugin.h\n@@ -173,6 +173,11 @@ class ScriptEditorBase : public VBoxContainer {\n \tstatic void _bind_methods();\n \n public:\n+\tstruct EditedFileData {\n+\t\tString path;\n+\t\tuint64_t last_modified_time = -1;\n+\t} edited_file_data;\n+\n \tvirtual void add_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \tvirtual void set_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \ndiff --git a/editor/plugins/script_text_editor.cpp b/editor/plugins/script_text_editor.cpp\nindex ece9616b69b2..79de2e4cebb5 100644\n--- a/editor/plugins/script_text_editor.cpp\n+++ b/editor/plugins/script_text_editor.cpp\n@@ -456,6 +456,7 @@ void ScriptTextEditor::convert_indent() {\n \n void ScriptTextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void ScriptTextEditor::goto_line(int p_line, int p_column) {\ndiff --git a/editor/plugins/text_editor.cpp b/editor/plugins/text_editor.cpp\nindex ee2d592ed3fd..6af3befe1c41 100644\n--- a/editor/plugins/text_editor.cpp\n+++ b/editor/plugins/text_editor.cpp\n@@ -302,6 +302,7 @@ void TextEditor::convert_indent() {\n \n void TextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void TextEditor::goto_line(int p_line, int p_column) {\n", "test_patch": "", "problem_statement": "Duplicating a script triggers modified outside Godot dialog\n### Tested versions\n\nGodot v4.4.dev7\n\nTried v4.4.dev2 too and it did not happen there\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - Wayland display driver, Single-window\n\n### Issue description\n\nIf you duplicate a script in FileSystem with the script open and then either save the open file or focus another window and then back to Godot it triggers the modified outside Godot dialog for the open script.\n\nhttps://github.com/user-attachments/assets/ddfba1e6-8ac9-4812-a46a-3fa22d1bbd4a\n\n\n### Steps to reproduce\n\n^\n\n### Minimal reproduction project (MRP)\n\n[doc.zip](https://github.com/user-attachments/files/18423743/doc.zip)\n", "hints_text": "Bisecting\nBisected to [2430b7f9b41c84e37c4d47f5adde9cdb9c9b1d59], so would be based on universal UIDs:\n* https://github.com/godotengine/godot/pull/97352\n\nUnsure what exactly is going on though \nThis is caused by wrong implementation of change detection in script editor. It uses Resource's `last_modifed_time`, which seems to not be a last modified time of the file. This line causes the script's \"modified time\" to change, causing mismatch with the actual time of the file.\nhttps://github.com/godotengine/godot/blob/4ce466d7fa79e351d4295d5bb47e3266089c3a59/editor/editor_file_system.cpp#L2984", "created_at": "2025-01-16 00:03:34", "merge_commit_sha": "6fdf91cc2f3f186197f22b72bfe12c5db6354608", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101570", "base_commit": "1b7b009674e05b566be11a5377b935f5d3d6c0ee", "patch": "diff --git a/editor/editor_properties.cpp b/editor/editor_properties.cpp\nindex 69b44a3e8f88..b1a4bb76f325 100644\n--- a/editor/editor_properties.cpp\n+++ b/editor/editor_properties.cpp\n@@ -2599,6 +2599,17 @@ void EditorPropertyColor::_color_changed(const Color &p_color) {\n \tget_edited_object()->set(get_edited_property(), p_color);\n }\n \n+void EditorPropertyColor::_picker_created() {\n+\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_popup_opening));\n+\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n+}\n+\n+void EditorPropertyColor::_popup_opening() {\n+\tEditorNode::get_singleton()->setup_color_picker(picker->get_picker());\n+\tlast_color = picker->get_pick_color();\n+\twas_checked = !is_checkable() || is_checked();\n+}\n+\n void EditorPropertyColor::_popup_closed() {\n \tget_edited_object()->set(get_edited_property(), was_checked ? Variant(last_color) : Variant());\n \tif (!picker->get_pick_color().is_equal_approx(last_color)) {\n@@ -2606,11 +2617,6 @@ void EditorPropertyColor::_popup_closed() {\n \t}\n }\n \n-void EditorPropertyColor::_picker_opening() {\n-\tlast_color = picker->get_pick_color();\n-\twas_checked = !is_checkable() || is_checked();\n-}\n-\n void EditorPropertyColor::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_ENTER_TREE:\n@@ -2654,9 +2660,7 @@ EditorPropertyColor::EditorPropertyColor() {\n \tadd_child(picker);\n \tpicker->set_flat(true);\n \tpicker->connect(\"color_changed\", callable_mp(this, &EditorPropertyColor::_color_changed));\n-\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(EditorNode::get_singleton(), &EditorNode::setup_color_picker).bind(picker->get_picker()));\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_picker_opening));\n+\tpicker->connect(\"picker_created\", callable_mp(this, &EditorPropertyColor::_picker_created), CONNECT_ONE_SHOT);\n }\n \n ////////////// NODE PATH //////////////////////\ndiff --git a/editor/editor_properties.h b/editor/editor_properties.h\nindex bcdae5342d28..6fe8cc3c3f38 100644\n--- a/editor/editor_properties.h\n+++ b/editor/editor_properties.h\n@@ -593,8 +593,9 @@ class EditorPropertyColor : public EditorProperty {\n \tGDCLASS(EditorPropertyColor, EditorProperty);\n \tColorPickerButton *picker = nullptr;\n \tvoid _color_changed(const Color &p_color);\n+\tvoid _picker_created();\n+\tvoid _popup_opening();\n \tvoid _popup_closed();\n-\tvoid _picker_opening();\n \n \tColor last_color;\n \tbool live_changes_enabled = true;\n", "test_patch": "", "problem_statement": "Inspector loads slowly when there's many Color properties\n### Tested versions\n\nReproducible in 4.4.dev7, and probably many versions earlier.\n\n### System information\n\nWindows 11\n\n### Issue description\n\nInspectors (or project/editor settings) that contain many Color properties will load slowly. Additionally, they can be slow to switch away from.\n\n### Steps to reproduce\n\nFor example, check out:\n```\nEditor Settings > Text Editor > Theme     (the worst example)\nEditor Settings > Editors > 3D Gizmos\nEditor Settings > Editors > Visual Editors\nProject Settings > Debug > Shapes\n```\n\n\n\n### Minimal reproduction project (MRP)\n\nAlso, I made an MPR that has a Node with an exported `Array[Color]`, and some extra Color properties. Try repeatedly switching between the `Colorful` and `Colorless` nodes (make sure the Array is expanded).\n\n[color_picker.zip](https://github.com/user-attachments/files/18418402/color_picker.zip)\n", "hints_text": "", "created_at": "2025-01-15 03:12:27", "merge_commit_sha": "a7146ef807a7676f51a8a63cf4441ad647f4be66", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101565", "base_commit": "4ce466d7fa79e351d4295d5bb47e3266089c3a59", "patch": "diff --git a/editor/plugins/script_text_editor.cpp b/editor/plugins/script_text_editor.cpp\nindex ece9616b69b2..b7712c4a532d 100644\n--- a/editor/plugins/script_text_editor.cpp\n+++ b/editor/plugins/script_text_editor.cpp\n@@ -2337,7 +2337,7 @@ void ScriptTextEditor::_make_context_menu(bool p_selection, bool p_color, bool p\n \tif (p_color || p_open_docs || p_goto_definition) {\n \t\tcontext_menu->add_separator();\n \t\tif (p_open_docs) {\n-\t\t\tcontext_menu->add_item(TTR(\"Lookup Symbol\"), LOOKUP_SYMBOL);\n+\t\t\tcontext_menu->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_symbol\"), LOOKUP_SYMBOL);\n \t\t}\n \t\tif (p_color) {\n \t\t\tcontext_menu->add_item(TTR(\"Pick Color\"), EDIT_PICK_COLOR);\n@@ -2491,6 +2491,7 @@ void ScriptTextEditor::_enable_code_editor() {\n \tedit_hb->add_child(goto_menu);\n \tgoto_menu->get_popup()->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_function\"), SEARCH_LOCATE_FUNCTION);\n \tgoto_menu->get_popup()->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_line\"), SEARCH_GOTO_LINE);\n+\tgoto_menu->get_popup()->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_symbol\"), LOOKUP_SYMBOL);\n \tgoto_menu->get_popup()->add_separator();\n \n \tgoto_menu->get_popup()->add_submenu_node_item(TTR(\"Bookmarks\"), bookmarks_menu);\n@@ -2675,6 +2676,7 @@ void ScriptTextEditor::register_editor() {\n \tED_SHORTCUT_OVERRIDE(\"script_text_editor/goto_function\", \"macos\", KeyModifierMask::CTRL | KeyModifierMask::META | Key::J);\n \n \tED_SHORTCUT(\"script_text_editor/goto_line\", TTRC(\"Go to Line...\"), KeyModifierMask::CMD_OR_CTRL | Key::L);\n+\tED_SHORTCUT(\"script_text_editor/goto_symbol\", TTRC(\"Lookup Symbol\"));\n \n \tED_SHORTCUT(\"script_text_editor/toggle_breakpoint\", TTRC(\"Toggle Breakpoint\"), Key::F9);\n \tED_SHORTCUT_OVERRIDE(\"script_text_editor/toggle_breakpoint\", \"macos\", KeyModifierMask::META | KeyModifierMask::SHIFT | Key::B);\n", "test_patch": "", "problem_statement": " Lookup Symbol shortcut cannot be specified in the Editor shortcut settings\n### Tested versions\n\nRepro in 4.2\n\n### System information\n\nmacOS Sonoma non-mono version\n\n### Issue description\n\n\" Lookup Symbol\" shortcut cannot be specified in the Editor shortcut settings, and I think it's probably just being overlooked. So I could use my preferred shortcut to look at the definition. It's supported in all major IDEs and I'm not the only one needing this in Godot: https://www.reddit.com/r/godot/comments/150ej30/shortcut_for_go_to_definitionlook_up_symbol/\r\n\n\n### Steps to reproduce\n\nGo to Editor > Editor Settings > shortcuts and search for Lookup Symbol and nothing shows\n\n### Minimal reproduction project (MRP)\n\nNA\n", "hints_text": "@tpcmurray Please don't bump issues without contributing significant new information. Use the :+1: reaction button on the first post instead.\nThis might close godotengine/godot-proposals#4577 (forgive if this was obvious -- I came considering fixing and thought it useful to cross link these two.)\r\n\r\np.s. thx for fixing already -- keenly awaiting this landing!", "created_at": "2025-01-14 23:59:32", "merge_commit_sha": "1351d3098e62c2523fe379b9abaa86afcf6024ce", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101489", "base_commit": "a013481b0911e59cc3f3dea7ebb732450c3e1460", "patch": "diff --git a/core/config/project_settings.cpp b/core/config/project_settings.cpp\nindex fdcd4f9b6064..a12b89683118 100644\n--- a/core/config/project_settings.cpp\n+++ b/core/config/project_settings.cpp\n@@ -1263,10 +1263,10 @@ void ProjectSettings::refresh_global_class_list() {\n \tArray script_classes = get_global_class_list();\n \tfor (int i = 0; i < script_classes.size(); i++) {\n \t\tDictionary c = script_classes[i];\n-\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\tcontinue;\n \t\t}\n-\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t}\n }\n \ndiff --git a/core/object/script_language.cpp b/core/object/script_language.cpp\nindex 4ef53dba1dff..33bf7ab48a0f 100644\n--- a/core/object/script_language.cpp\n+++ b/core/object/script_language.cpp\n@@ -269,10 +269,10 @@ void ScriptServer::init_languages() {\n \n \t\t\tfor (const Variant &script_class : script_classes) {\n \t\t\t\tDictionary c = script_class;\n-\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n-\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t\t}\n \t\t\tProjectSettings::get_singleton()->clear(\"_global_script_classes\");\n \t\t}\n@@ -281,10 +281,10 @@ void ScriptServer::init_languages() {\n \t\tArray script_classes = ProjectSettings::get_singleton()->get_global_class_list();\n \t\tfor (const Variant &script_class : script_classes) {\n \t\t\tDictionary c = script_class;\n-\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\tcontinue;\n \t\t\t}\n-\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t}\n \t}\n \n@@ -390,7 +390,7 @@ void ScriptServer::global_classes_clear() {\n \tinheriters_cache.clear();\n }\n \n-void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path) {\n+void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool) {\n \tERR_FAIL_COND_MSG(p_class == p_base || (global_classes.has(p_base) && get_global_class_native_base(p_base) == p_class), \"Cyclic inheritance in script class.\");\n \tGlobalScriptClass *existing = global_classes.getptr(p_class);\n \tif (existing) {\n@@ -399,6 +399,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\t\texisting->base = p_base;\n \t\t\texisting->path = p_path;\n \t\t\texisting->language = p_language;\n+\t\t\texisting->is_abstract = p_is_abstract;\n+\t\t\texisting->is_tool = p_is_tool;\n \t\t\tinheriters_cache_dirty = true;\n \t\t}\n \t} else {\n@@ -407,6 +409,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\tg.language = p_language;\n \t\tg.path = p_path;\n \t\tg.base = p_base;\n+\t\tg.is_abstract = p_is_abstract;\n+\t\tg.is_tool = p_is_tool;\n \t\tglobal_classes[p_class] = g;\n \t\tinheriters_cache_dirty = true;\n \t}\n@@ -480,6 +484,16 @@ StringName ScriptServer::get_global_class_native_base(const String &p_class) {\n \treturn base;\n }\n \n+bool ScriptServer::is_global_class_abstract(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_abstract;\n+}\n+\n+bool ScriptServer::is_global_class_tool(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_tool;\n+}\n+\n void ScriptServer::get_global_class_list(List<StringName> *r_global_classes) {\n \tList<StringName> classes;\n \tfor (const KeyValue<StringName, GlobalScriptClass> &E : global_classes) {\n@@ -507,12 +521,15 @@ void ScriptServer::save_global_classes() {\n \tget_global_class_list(&gc);\n \tArray gcarr;\n \tfor (const StringName &E : gc) {\n+\t\tconst GlobalScriptClass &global_class = global_classes[E];\n \t\tDictionary d;\n \t\td[\"class\"] = E;\n-\t\td[\"language\"] = global_classes[E].language;\n-\t\td[\"path\"] = global_classes[E].path;\n-\t\td[\"base\"] = global_classes[E].base;\n+\t\td[\"language\"] = global_class.language;\n+\t\td[\"path\"] = global_class.path;\n+\t\td[\"base\"] = global_class.base;\n \t\td[\"icon\"] = class_icons.get(E, \"\");\n+\t\td[\"is_abstract\"] = global_class.is_abstract;\n+\t\td[\"is_tool\"] = global_class.is_tool;\n \t\tgcarr.push_back(d);\n \t}\n \tProjectSettings::get_singleton()->store_global_class_list(gcarr);\ndiff --git a/core/object/script_language.h b/core/object/script_language.h\nindex 6ceeb4287512..8158d633ae14 100644\n--- a/core/object/script_language.h\n+++ b/core/object/script_language.h\n@@ -62,6 +62,8 @@ class ScriptServer {\n \t\tStringName language;\n \t\tString path;\n \t\tStringName base;\n+\t\tbool is_abstract = false;\n+\t\tbool is_tool = false;\n \t};\n \n \tstatic HashMap<StringName, GlobalScriptClass> global_classes;\n@@ -86,7 +88,7 @@ class ScriptServer {\n \tstatic void thread_exit();\n \n \tstatic void global_classes_clear();\n-\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path);\n+\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool);\n \tstatic void remove_global_class(const StringName &p_class);\n \tstatic void remove_global_class_by_path(const String &p_path);\n \tstatic bool is_global_class(const StringName &p_class);\n@@ -94,6 +96,8 @@ class ScriptServer {\n \tstatic String get_global_class_path(const String &p_class);\n \tstatic StringName get_global_class_base(const String &p_class);\n \tstatic StringName get_global_class_native_base(const String &p_class);\n+\tstatic bool is_global_class_abstract(const String &p_class);\n+\tstatic bool is_global_class_tool(const String &p_class);\n \tstatic void get_global_class_list(List<StringName> *r_global_classes);\n \tstatic void get_inheriters_list(const StringName &p_base_type, List<StringName> *r_classes);\n \tstatic void save_global_classes();\n@@ -443,7 +447,7 @@ class ScriptLanguage : public Object {\n \tvirtual void frame();\n \n \tvirtual bool handles_global_class_type(const String &p_type) const { return false; }\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const { return String(); }\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const { return String(); }\n \n \tvirtual ~ScriptLanguage() {}\n };\ndiff --git a/core/object/script_language_extension.h b/core/object/script_language_extension.h\nindex 09c395e71e8d..715ec43fb35a 100644\n--- a/core/object/script_language_extension.h\n+++ b/core/object/script_language_extension.h\n@@ -672,7 +672,7 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \n \tGDVIRTUAL1RC_REQUIRED(Dictionary, _get_global_class_name, const String &)\n \n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override {\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override {\n \t\tDictionary ret;\n \t\tGDVIRTUAL_CALL(_get_global_class_name, p_path, ret);\n \t\tif (!ret.has(\"name\")) {\n@@ -684,6 +684,12 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \t\tif (r_icon_path != nullptr && ret.has(\"icon_path\")) {\n \t\t\t*r_icon_path = ret[\"icon_path\"];\n \t\t}\n+\t\tif (r_is_abstract != nullptr && ret.has(\"is_abstract\")) {\n+\t\t\t*r_is_abstract = ret[\"is_abstract\"];\n+\t\t}\n+\t\tif (r_is_tool != nullptr && ret.has(\"is_tool\")) {\n+\t\t\t*r_is_tool = ret[\"is_tool\"];\n+\t\t}\n \t\treturn ret[\"name\"];\n \t}\n };\ndiff --git a/editor/connections_dialog.cpp b/editor/connections_dialog.cpp\nindex 429467d3403c..dca43411e10b 100644\n--- a/editor/connections_dialog.cpp\n+++ b/editor/connections_dialog.cpp\n@@ -1446,7 +1446,7 @@ void ConnectionsDock::update_tree() {\n \t\t\t\tdoc_class_name = String();\n \t\t\t}\n \n-\t\t\tclass_icon = editor_data.get_script_icon(script_base);\n+\t\t\tclass_icon = editor_data.get_script_icon(script_base->get_path());\n \t\t\tif (class_icon.is_null() && has_theme_icon(native_base, EditorStringName(EditorIcons))) {\n \t\t\t\tclass_icon = get_editor_theme_icon(native_base);\n \t\t\t}\ndiff --git a/editor/create_dialog.cpp b/editor/create_dialog.cpp\nindex 7f1670bcb648..5eebb1c492e5 100644\n--- a/editor/create_dialog.cpp\n+++ b/editor/create_dialog.cpp\n@@ -257,14 +257,9 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\tinherits = ClassDB::get_parent_class(p_type);\n \t\tinherited_type = TypeCategory::CPP_TYPE;\n \t} else {\n-\t\tif (p_type_category == TypeCategory::PATH_TYPE || ScriptServer::is_global_class(p_type)) {\n-\t\t\tRef<Script> scr;\n-\t\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n-\t\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n-\t\t\t\tscr = ResourceLoader::load(p_type, \"Script\");\n-\t\t\t} else {\n-\t\t\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_type);\n-\t\t\t}\n+\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n+\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n+\t\t\tRef<Script> scr = ResourceLoader::load(p_type, \"Script\");\n \t\t\tERR_FAIL_COND(scr.is_null());\n \n \t\t\tRef<Script> base = scr->get_base_script();\n@@ -286,6 +281,10 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\t\t\t\tinherited_type = TypeCategory::PATH_TYPE;\n \t\t\t\t}\n \t\t\t}\n+\t\t} else if (ScriptServer::is_global_class(p_type)) {\n+\t\t\tinherits = ScriptServer::get_global_class_base(p_type);\n+\t\t\tbool is_native_class = ClassDB::class_exists(inherits);\n+\t\t\tinherited_type = is_native_class ? TypeCategory::CPP_TYPE : TypeCategory::OTHER_TYPE;\n \t\t} else {\n \t\t\tinherits = custom_type_parents[p_type];\n \t\t\tif (ClassDB::class_exists(inherits)) {\n@@ -315,18 +314,14 @@ void CreateDialog::_configure_search_option_item(TreeItem *r_item, const StringN\n \t\tr_item->set_metadata(0, p_type);\n \t\tr_item->set_text(0, p_type);\n \n-\t\tString script_path = ScriptServer::get_global_class_path(p_type);\n-\t\tRef<Script> scr = ResourceLoader::load(script_path, \"Script\");\n-\n-\t\tERR_FAIL_COND(scr.is_null());\n-\t\tis_abstract = scr->is_abstract();\n+\t\tis_abstract = ScriptServer::is_global_class_abstract(p_type);\n \n \t\tString tooltip = TTR(\"Script path: %s\");\n-\t\tbool is_tool = scr->is_tool();\n+\t\tbool is_tool = ScriptServer::is_global_class_tool(p_type);\n \t\tif (is_tool) {\n \t\t\ttooltip = TTR(\"The script will run in the editor.\") + \"\\n\" + tooltip;\n \t\t}\n-\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, script_path));\n+\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, ScriptServer::get_global_class_path(p_type)));\n \t\tif (is_tool) {\n \t\t\tint button_index = r_item->get_button_count(0) - 1;\n \t\t\tr_item->set_button_color(0, button_index, get_theme_color(SNAME(\"accent_color\"), EditorStringName(Editor)));\ndiff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex 73af9f39a6f5..f31e6aba4169 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -983,20 +983,6 @@ bool EditorData::script_class_is_parent(const String &p_class, const String &p_i\n \treturn true;\n }\n \n-StringName EditorData::script_class_get_base(const String &p_class) const {\n-\tRef<Script> script = script_class_load_script(p_class);\n-\tif (script.is_null()) {\n-\t\treturn StringName();\n-\t}\n-\n-\tRef<Script> base_script = script->get_base_script();\n-\tif (base_script.is_null()) {\n-\t\treturn ScriptServer::get_global_class_base(p_class);\n-\t}\n-\n-\treturn script->get_language()->get_global_class_name(base_script->get_path());\n-}\n-\n Variant EditorData::script_class_instance(const String &p_class) {\n \tif (ScriptServer::is_global_class(p_class)) {\n \t\tRef<Script> script = script_class_load_script(p_class);\n@@ -1026,22 +1012,25 @@ void EditorData::script_class_set_icon_path(const String &p_class, const String\n \t_script_class_icon_paths[p_class] = p_icon_path;\n }\n \n-String EditorData::script_class_get_icon_path(const String &p_class) const {\n-\tif (!ScriptServer::is_global_class(p_class)) {\n-\t\treturn String();\n-\t}\n-\n+String EditorData::script_class_get_icon_path(const String &p_class, bool *r_valid) const {\n \tString current = p_class;\n-\tString ret = _script_class_icon_paths[current];\n-\twhile (ret.is_empty()) {\n-\t\tcurrent = script_class_get_base(current);\n+\twhile (true) {\n \t\tif (!ScriptServer::is_global_class(current)) {\n+\t\t\t// If the classnames chain has a native class ancestor, we're done with success.\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = ClassDB::class_exists(current);\n+\t\t\t}\n \t\t\treturn String();\n \t\t}\n-\t\tret = _script_class_icon_paths.has(current) ? _script_class_icon_paths[current] : String();\n+\t\tHashMap<StringName, String>::ConstIterator E = _script_class_icon_paths.find(current);\n+\t\tif ((bool)E) {\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = true;\n+\t\t\t}\n+\t\t\treturn E->value;\n+\t\t}\n+\t\tcurrent = ScriptServer::get_global_class_base(current);\n \t}\n-\n-\treturn ret;\n }\n \n StringName EditorData::script_class_get_name(const String &p_path) const {\n@@ -1126,28 +1115,42 @@ Ref<Texture2D> EditorData::_load_script_icon(const String &p_path) const {\n \treturn nullptr;\n }\n \n-Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n+Ref<Texture2D> EditorData::get_script_icon(const String &p_script_path) {\n \t// Take from the local cache, if available.\n-\tif (_script_icon_cache.has(p_script)) {\n+\tif (_script_icon_cache.has(p_script_path)) {\n \t\t// Can be an empty value if we can't resolve any icon for this script.\n \t\t// An empty value is still cached to avoid unnecessary attempts at resolving it again.\n-\t\treturn _script_icon_cache[p_script];\n+\t\treturn _script_icon_cache[p_script_path];\n+\t}\n+\n+\t// Fast path in case the whole hierarchy is made of global classes.\n+\tStringName class_name = script_class_get_name(p_script_path);\n+\t{\n+\t\tif (class_name != StringName()) {\n+\t\t\tbool icon_valid = false;\n+\t\t\tString icon_path = script_class_get_icon_path(class_name, &icon_valid);\n+\t\t\tif (icon_valid) {\n+\t\t\t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n+\t\t\t\t_script_icon_cache[p_script_path] = icon;\n+\t\t\t\treturn icon;\n+\t\t\t}\n+\t\t}\n \t}\n \n-\tRef<Script> base_scr = p_script;\n+\tRef<Script> base_scr = ResourceLoader::load(p_script_path, \"Script\");\n \twhile (base_scr.is_valid()) {\n \t\t// Check for scripted classes.\n \t\tString icon_path;\n-\t\tStringName class_name = script_class_get_name(base_scr->get_path());\n-\t\tif (base_scr->is_built_in() || class_name == StringName()) {\n+\t\tStringName base_class_name = script_class_get_name(base_scr->get_path());\n+\t\tif (base_scr->is_built_in() || base_class_name == StringName()) {\n \t\t\ticon_path = base_scr->get_class_icon_path();\n \t\t} else {\n-\t\t\ticon_path = script_class_get_icon_path(class_name);\n+\t\t\ticon_path = script_class_get_icon_path(base_class_name);\n \t\t}\n \n \t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n \t\tif (icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = icon;\n+\t\t\t_script_icon_cache[p_script_path] = icon;\n \t\t\treturn icon;\n \t\t}\n \n@@ -1155,7 +1158,7 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\t// TODO: Should probably be deprecated in 4.x\n \t\tconst EditorData::CustomType *ctype = get_custom_type_by_path(base_scr->get_path());\n \t\tif (ctype && ctype->icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = ctype->icon;\n+\t\t\t_script_icon_cache[p_script_path] = ctype->icon;\n \t\t\treturn ctype->icon;\n \t\t}\n \n@@ -1163,21 +1166,16 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\tbase_scr = base_scr->get_base_script();\n \t}\n \n-\t// No custom icon was found in the inheritance chain, so check the base\n-\t// class of the script instead.\n-\tString base_type;\n-\tp_script->get_language()->get_global_class_name(p_script->get_path(), &base_type);\n-\n \t// Check if the base type is an extension-defined type.\n-\tRef<Texture2D> ext_icon = extension_class_get_icon(base_type);\n+\tRef<Texture2D> ext_icon = extension_class_get_icon(class_name);\n \tif (ext_icon.is_valid()) {\n-\t\t_script_icon_cache[p_script] = ext_icon;\n+\t\t_script_icon_cache[p_script_path] = ext_icon;\n \t\treturn ext_icon;\n \t}\n \n \t// If no icon found, cache it as null.\n-\t_script_icon_cache[p_script] = Ref<Texture>();\n-\treturn nullptr;\n+\t_script_icon_cache[p_script_path] = Ref<Texture2D>();\n+\treturn Ref<Texture2D>();\n }\n \n void EditorData::clear_script_icon_cache() {\ndiff --git a/editor/editor_data.h b/editor/editor_data.h\nindex 5b49304c73f2..943c661b6b2e 100644\n--- a/editor/editor_data.h\n+++ b/editor/editor_data.h\n@@ -147,7 +147,7 @@ class EditorData {\n \n \tHashMap<StringName, String> _script_class_icon_paths;\n \tHashMap<String, StringName> _script_class_file_to_path;\n-\tHashMap<Ref<Script>, Ref<Texture>> _script_icon_cache;\n+\tHashMap<String, Ref<Texture>> _script_icon_cache;\n \n \tRef<Texture2D> _load_script_icon(const String &p_path) const;\n \n@@ -241,7 +241,6 @@ class EditorData {\n \tvoid notify_scene_saved(const String &p_path);\n \n \tbool script_class_is_parent(const String &p_class, const String &p_inherits);\n-\tStringName script_class_get_base(const String &p_class) const;\n \tVariant script_class_instance(const String &p_class);\n \n \tRef<Script> script_class_load_script(const String &p_class) const;\n@@ -249,7 +248,7 @@ class EditorData {\n \tStringName script_class_get_name(const String &p_path) const;\n \tvoid script_class_set_name(const String &p_path, const StringName &p_class);\n \n-\tString script_class_get_icon_path(const String &p_class) const;\n+\tString script_class_get_icon_path(const String &p_class, bool *r_valid = nullptr) const;\n \tvoid script_class_set_icon_path(const String &p_class, const String &p_icon_path);\n \tvoid script_class_clear_icon_paths() { _script_class_icon_paths.clear(); }\n \tvoid script_class_save_icon_paths();\n@@ -257,7 +256,7 @@ class EditorData {\n \n \tRef<Texture2D> extension_class_get_icon(const String &p_class) const;\n \n-\tRef<Texture2D> get_script_icon(const Ref<Script> &p_script);\n+\tRef<Texture2D> get_script_icon(const String &p_script_path);\n \tvoid clear_script_icon_cache();\n \n \tEditorData();\ndiff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex b8ce3ff65bf7..1db6c2a188e4 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -49,7 +49,7 @@\n \n EditorFileSystem *EditorFileSystem::singleton = nullptr;\n //the name is the version, to keep compatibility with different versions of Godot\n-#define CACHE_FILE_NAME \"filesystem_cache8\"\n+#define CACHE_FILE_NAME \"filesystem_cache10\"\n \n int EditorFileSystemDirectory::find_file_index(const String &p_file) const {\n \tfor (int i = 0; i < files.size(); i++) {\n@@ -166,19 +166,19 @@ uint64_t EditorFileSystemDirectory::get_file_import_modified_time(int p_idx) con\n }\n \n String EditorFileSystemDirectory::get_file_script_class_name(int p_idx) const {\n-\treturn files[p_idx]->script_class_name;\n+\treturn files[p_idx]->class_info.name;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_extends(int p_idx) const {\n-\treturn files[p_idx]->script_class_extends;\n+\treturn files[p_idx]->class_info.extends;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_icon_path(int p_idx) const {\n-\treturn files[p_idx]->script_class_icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n String EditorFileSystemDirectory::get_file_icon_path(int p_idx) const {\n-\treturn files[p_idx]->icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n StringName EditorFileSystemDirectory::get_file_type(int p_idx) const {\n@@ -303,13 +303,13 @@ void EditorFileSystem::_first_scan_process_scripts(const ScannedDirectory *p_sca\n \t\t\tconst String type = ResourceLoader::get_resource_type(path);\n \n \t\t\tif (ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n-\t\t\t\tString script_class_extends;\n-\t\t\t\tString script_class_icon_path;\n-\t\t\t\tString script_class_name = _get_global_script_class(type, path, &script_class_extends, &script_class_icon_path);\n-\t\t\t\t_register_global_class_script(path, path, type, script_class_name, script_class_extends, script_class_icon_path);\n+\t\t\t\tconst ScriptClassInfo &info = _get_global_script_class(type, path);\n+\t\t\t\tScriptClassInfoUpdate update(info);\n+\t\t\t\tupdate.type = type;\n+\t\t\t\t_register_global_class_script(path, path, update);\n \n-\t\t\t\tif (!script_class_name.is_empty()) {\n-\t\t\t\t\tp_existing_class_names.insert(script_class_name);\n+\t\t\t\tif (!info.name.is_empty()) {\n+\t\t\t\t\tp_existing_class_names.insert(info.name);\n \t\t\t\t}\n \t\t\t}\n \t\t}\n@@ -383,33 +383,25 @@ void EditorFileSystem::_scan_filesystem() {\n \t\t\t\t\tname = cpath.path_join(name);\n \n \t\t\t\t\tFileCache fc;\n-\t\t\t\t\tfc.type = split[1];\n-\t\t\t\t\tif (fc.type.contains_char('/')) {\n-\t\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n-\t\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n-\t\t\t\t\t}\n+\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n+\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n \t\t\t\t\tfc.uid = split[2].to_int();\n \t\t\t\t\tfc.modification_time = split[3].to_int();\n \t\t\t\t\tfc.import_modification_time = split[4].to_int();\n \t\t\t\t\tfc.import_valid = split[5].to_int() != 0;\n \t\t\t\t\tfc.import_group_file = split[6].strip_edges();\n-\t\t\t\t\tfc.script_class_name = split[7].get_slice(\"<>\", 0);\n-\t\t\t\t\tfc.script_class_extends = split[7].get_slice(\"<>\", 1);\n-\t\t\t\t\tfc.script_class_icon_path = split[7].get_slice(\"<>\", 2);\n-\t\t\t\t\tfc.import_md5 = split[7].get_slice(\"<>\", 3);\n-\t\t\t\t\tString dest_paths = split[7].get_slice(\"<>\", 4);\n-\t\t\t\t\tif (!dest_paths.is_empty()) {\n-\t\t\t\t\t\tfc.import_dest_paths = dest_paths.split(\"<*>\");\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tString deps = split[8].strip_edges();\n-\t\t\t\t\tif (deps.length()) {\n-\t\t\t\t\t\tVector<String> dp = deps.split(\"<>\");\n-\t\t\t\t\t\tfor (int i = 0; i < dp.size(); i++) {\n-\t\t\t\t\t\t\tconst String &path = dp[i];\n-\t\t\t\t\t\t\tfc.deps.push_back(path);\n-\t\t\t\t\t\t}\n+\t\t\t\t\t{\n+\t\t\t\t\t\tconst Vector<String> &slices = split[7].split(\"<>\");\n+\t\t\t\t\t\tERR_CONTINUE(slices.size() < 7);\n+\t\t\t\t\t\tfc.class_info.name = slices[0];\n+\t\t\t\t\t\tfc.class_info.extends = slices[1];\n+\t\t\t\t\t\tfc.class_info.icon_path = slices[2];\n+\t\t\t\t\t\tfc.class_info.is_abstract = slices[3].to_int();\n+\t\t\t\t\t\tfc.class_info.is_tool = slices[4].to_int();\n+\t\t\t\t\t\tfc.import_md5 = slices[5];\n+\t\t\t\t\t\tfc.import_dest_paths = slices[6].split(\"<*>\");\n \t\t\t\t\t}\n+\t\t\t\t\tfc.deps = split[8].strip_edges().split(\"<>\");\n \n \t\t\t\t\tfile_cache[name] = fc;\n \t\t\t\t}\n@@ -859,7 +851,7 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\t}\n \n \t\t\t\tif (ClassDB::is_parent_class(ia.new_file->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(new_file_path, ia.new_file->type, ia.new_file->script_class_name, ia.new_file->script_class_extends, ia.new_file->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(new_file_path, ScriptClassInfoUpdate::from_file_info(ia.new_file));\n \t\t\t\t}\n \t\t\t\tif (ia.new_file->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(new_file_path);\n@@ -870,9 +862,9 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString script_class_name = ia.dir->files[idx]->script_class_name;\n+\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), \"\", \"\", \"\", \"\");\n+\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n@@ -883,11 +875,11 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tia.dir->files.remove_at(idx);\n \n \t\t\t\t// Restore another script with the same global class name if it exists.\n-\t\t\t\tif (!script_class_name.is_empty()) {\n+\t\t\t\tif (!class_name.is_empty()) {\n \t\t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n-\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, script_class_name, old_fi);\n+\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, class_name, old_fi);\n \t\t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \n@@ -1161,10 +1153,8 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = fc->import_md5;\n \t\t\t\tfi->import_dest_paths = fc->import_dest_paths;\n \t\t\t\tfi->import_valid = fc->import_valid;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n \t\t\t\tfi->import_group_file = fc->import_group_file;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\t// Ensures backward compatibility when the project is loaded for the first time with the added import_md5\n \t\t\t\t// and import_dest_paths properties in the file cache.\n@@ -1202,7 +1192,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t} else {\n \t\t\t\t// Using get_resource_import_info() to prevent calling 3 times ResourceFormatImporter::_get_path_and_type.\n \t\t\t\tResourceFormatImporter::get_singleton()->get_resource_import_info(path, fi->type, fi->uid, fi->import_group_file);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->modified_time = 0;\n \t\t\t\tfi->import_modified_time = 0;\n \t\t\t\tfi->import_md5 = \"\";\n@@ -1227,22 +1217,20 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = \"\";\n \t\t\t\tfi->import_dest_paths = Vector<String>();\n \t\t\t\tfi->import_valid = true;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\tif (first_scan && ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n \t\t\t\t\tbool update_script = false;\n-\t\t\t\t\tString old_class_name = fi->script_class_name;\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n-\t\t\t\t\tif (old_class_name != fi->script_class_name) {\n+\t\t\t\t\tString old_class_name = fi->class_info.name;\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n+\t\t\t\t\tif (old_class_name != fi->class_info.name) {\n \t\t\t\t\t\tupdate_script = true;\n-\t\t\t\t\t} else if (!fi->script_class_name.is_empty() && (!ScriptServer::is_global_class(fi->script_class_name) || ScriptServer::get_global_class_path(fi->script_class_name) != path)) {\n+\t\t\t\t\t} else if (!fi->class_info.name.is_empty() && (!ScriptServer::is_global_class(fi->class_info.name) || ScriptServer::get_global_class_path(fi->class_info.name) != path)) {\n \t\t\t\t\t\t// This script has a class name but is not in the global class names or the path of the class has changed.\n \t\t\t\t\t\tupdate_script = true;\n \t\t\t\t\t}\n \t\t\t\t\tif (update_script) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t} else {\n@@ -1256,7 +1244,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t}\n \t\t\t\tfi->uid = ResourceLoader::get_resource_uid(path);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->deps = _get_dependencies(path);\n \t\t\t\tfi->modified_time = mt;\n \t\t\t\tfi->import_modified_time = 0;\n@@ -1267,7 +1255,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t// Files in dep_update_list are forced for rescan to update dependencies. They don't need other updates.\n \t\t\t\tif (!dep_update_list.has(path)) {\n \t\t\t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t\t_queue_update_scene_groups(path);\n@@ -1428,7 +1416,7 @@ void EditorFileSystem::_scan_fs_changes(EditorFileSystemDirectory *p_dir, ScanPr\n \t\t\t\t\tif (fi->type == \"\" && other_file_extensions.has(ext)) {\n \t\t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t\t}\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\t\tfi->import_valid = (fi->type == \"TextFile\" || fi->type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(path);\n \t\t\t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(path);\n \n@@ -1587,7 +1575,7 @@ void EditorFileSystem::_remove_invalid_global_class_names(const HashSet<String>\n \n String EditorFileSystem::_get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info) {\n \tfor (EditorFileSystemDirectory::FileInfo *fi : p_dir->files) {\n-\t\tif (fi->script_class_name == p_class_name) {\n+\t\tif (fi->class_info.name == p_class_name) {\n \t\t\tr_file_info = fi;\n \t\t\treturn p_dir->get_path().path_join(fi->file);\n \t\t}\n@@ -1768,7 +1756,7 @@ void EditorFileSystem::_save_filesystem_cache(EditorFileSystemDirectory *p_dir,\n \t\tcache_string.append(itos(file_info->import_modified_time));\n \t\tcache_string.append(itos(file_info->import_valid));\n \t\tcache_string.append(file_info->import_group_file);\n-\t\tcache_string.append(String(\"<>\").join({ file_info->script_class_name, file_info->script_class_extends, file_info->script_class_icon_path, file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n+\t\tcache_string.append(String(\"<>\").join({ file_info->class_info.name, file_info->class_info.extends, file_info->class_info.icon_path, itos(file_info->class_info.is_abstract), itos(file_info->class_info.is_tool), file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n \t\tcache_string.append(String(\"<>\").join(file_info->deps));\n \n \t\tp_file->store_line(String(\"::\").join(cache_string));\n@@ -1980,29 +1968,21 @@ Vector<String> EditorFileSystem::_get_dependencies(const String &p_path) {\n \treturn ret;\n }\n \n-String EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const {\n+EditorFileSystem::ScriptClassInfo EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path) const {\n+\tScriptClassInfo info;\n \tfor (int i = 0; i < ScriptServer::get_language_count(); i++) {\n \t\tif (ScriptServer::get_language(i)->handles_global_class_type(p_type)) {\n-\t\t\tString global_name;\n-\t\t\tString extends;\n-\t\t\tString icon_path;\n-\n-\t\t\tglobal_name = ScriptServer::get_language(i)->get_global_class_name(p_path, &extends, &icon_path);\n-\t\t\t*r_extends = extends;\n-\t\t\t*r_icon_path = icon_path;\n-\t\t\treturn global_name;\n+\t\t\tinfo.name = ScriptServer::get_language(i)->get_global_class_name(p_path, &info.extends, &info.icon_path, &info.is_abstract, &info.is_tool);\n \t\t}\n \t}\n-\t*r_extends = String();\n-\t*r_icon_path = String();\n-\treturn String();\n+\treturn info;\n }\n \n void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInfo *file_info) {\n \tString icon_path;\n \tif (file_info->resource_script_class != StringName()) {\n \t\ticon_path = EditorNode::get_editor_data().script_class_get_icon_path(file_info->resource_script_class);\n-\t} else if (file_info->script_class_icon_path.is_empty() && !file_info->deps.is_empty()) {\n+\t} else if (file_info->class_info.icon_path.is_empty() && !file_info->deps.is_empty()) {\n \t\tconst String &script_dep = file_info->deps[0]; // Assuming the first dependency is a script.\n \t\tconst String &script_path = script_dep.contains(\"::\") ? script_dep.get_slice(\"::\", 2) : script_dep;\n \t\tif (!script_path.is_empty()) {\n@@ -2014,7 +1994,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t\t\t\tint script_file;\n \t\t\t\t\tEditorFileSystemDirectory *efsd = find_file(script_path, &script_file);\n \t\t\t\t\tif (efsd) {\n-\t\t\t\t\t\ticon_path = efsd->files[script_file]->script_class_icon_path;\n+\t\t\t\t\t\ticon_path = efsd->files[script_file]->class_info.icon_path;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tfile_icon_cache.insert(script_path, icon_path);\n@@ -2029,7 +2009,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t}\n \t}\n \n-\tfile_info->icon_path = icon_path;\n+\tfile_info->class_info.icon_path = icon_path;\n }\n \n void EditorFileSystem::_update_files_icon_path(EditorFileSystemDirectory *edp) {\n@@ -2068,10 +2048,10 @@ void EditorFileSystem::_update_script_classes() {\n \t\t}\n \n \t\tint step_count = 0;\n-\t\tfor (const KeyValue<String, ScriptInfo> &E : update_script_paths) {\n-\t\t\t_register_global_class_script(E.key, E.key, E.value.type, E.value.script_class_name, E.value.script_class_extends, E.value.script_class_icon_path);\n+\t\tfor (const KeyValue<String, ScriptClassInfoUpdate> &E : update_script_paths) {\n+\t\t\t_register_global_class_script(E.key, E.key, E.value);\n \t\t\tif (ep) {\n-\t\t\t\tep->step(E.value.script_class_name, step_count++, false);\n+\t\t\t\tep->step(E.value.name, step_count++, false);\n \t\t\t}\n \t\t}\n \n@@ -2181,16 +2161,10 @@ void EditorFileSystem::_process_update_pending() {\n \t_update_pending_scene_groups();\n }\n \n-void EditorFileSystem::_queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update) {\n \tMutexLock update_script_lock(update_script_mutex);\n \n-\tScriptInfo si;\n-\tsi.type = p_type;\n-\tsi.script_class_name = p_script_class_name;\n-\tsi.script_class_extends = p_script_class_extends;\n-\tsi.script_class_icon_path = p_script_class_icon_path;\n-\tupdate_script_paths.insert(p_path, si);\n-\n+\tupdate_script_paths.insert(p_path, p_script_update);\n \tupdate_script_paths_documentation.insert(p_path);\n }\n \n@@ -2291,8 +2265,10 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (ClassDB::is_parent_class(fs->files[cpos]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(file, fs->files[cpos]->type, \"\", \"\", \"\");\n-\t\t\t\t\tif (!fs->files[cpos]->script_class_icon_path.is_empty()) {\n+\t\t\t\t\tScriptClassInfoUpdate update;\n+\t\t\t\t\tupdate.type = fs->files[cpos]->type;\n+\t\t\t\t\t_queue_update_script_class(file, update);\n+\t\t\t\t\tif (!fs->files[cpos]->class_info.icon_path.is_empty()) {\n \t\t\t\t\t\tupdate_files_icon_cache = true;\n \t\t\t\t\t}\n \t\t\t\t}\n@@ -2349,16 +2325,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t}\n \n \t\t\tEditorFileSystemDirectory::FileInfo *fi = fs->files[cpos];\n-\t\t\tconst String old_script_class_icon_path = fi->script_class_icon_path;\n-\t\t\tconst String old_class_name = fi->script_class_name;\n+\t\t\tconst String old_script_class_icon_path = fi->class_info.icon_path;\n+\t\t\tconst String old_class_name = fi->class_info.name;\n \t\t\tfi->type = type;\n \t\t\tfi->resource_script_class = script_class;\n \t\t\tfi->uid = uid;\n-\t\t\tfi->script_class_name = _get_global_script_class(type, file, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\tfi->class_info = _get_global_script_class(type, file);\n \t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(file);\n \t\t\tfi->modified_time = FileAccess::get_modified_time(file);\n \t\t\tfi->deps = _get_dependencies(file);\n-\t\t\tfi->import_valid = type == \"TextFile\" || type == \"OtherFile\" || ResourceLoader::is_import_valid(file);\n+\t\t\tfi->import_valid = (type == \"TextFile\" || type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(file);\n \n \t\t\tif (uid != ResourceUID::INVALID_ID) {\n \t\t\t\tif (ResourceUID::get_singleton()->has_id(uid)) {\n@@ -2384,7 +2360,7 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\tEditorResourcePreview::get_singleton()->check_for_invalidation(file);\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t_queue_update_script_class(file, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t_queue_update_script_class(file, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t}\n \t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t_queue_update_scene_groups(file);\n@@ -2392,16 +2368,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Resource\"))) {\n \t\t\t\tfiles_to_update_icon_path.push_back(fi);\n-\t\t\t} else if (old_script_class_icon_path != fi->script_class_icon_path) {\n+\t\t\t} else if (old_script_class_icon_path != fi->class_info.icon_path) {\n \t\t\t\tupdate_files_icon_cache = true;\n \t\t\t}\n \n \t\t\t// Restore another script as the global class name if multiple scripts had the same old class name.\n-\t\t\tif (!old_class_name.is_empty() && fi->script_class_name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n+\t\t\tif (!old_class_name.is_empty() && fi->class_info.name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n \t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n \t\t\t\tString old_file = _get_file_by_class_name(filesystem, old_class_name, old_fi);\n \t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t}\n \t\t\t}\n \t\t\tupdated = true;\n@@ -2435,16 +2411,16 @@ HashSet<String> EditorFileSystem::get_valid_extensions() const {\n \treturn valid_extensions;\n }\n \n-void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update) {\n \tScriptServer::remove_global_class_by_path(p_search_path); // First remove, just in case it changed\n \n-\tif (p_script_class_name.is_empty()) {\n+\tif (p_script_update.name.is_empty()) {\n \t\treturn;\n \t}\n \n \tString lang;\n \tfor (int j = 0; j < ScriptServer::get_language_count(); j++) {\n-\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_type)) {\n+\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_script_update.type)) {\n \t\t\tlang = ScriptServer::get_language(j)->get_name();\n \t\t\tbreak;\n \t\t}\n@@ -2453,9 +2429,9 @@ void EditorFileSystem::_register_global_class_script(const String &p_search_path\n \t\treturn; // No lang found that can handle this global class\n \t}\n \n-\tScriptServer::add_global_class(p_script_class_name, p_script_class_extends, lang, p_target_path);\n-\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_class_name, p_script_class_icon_path);\n-\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_class_name);\n+\tScriptServer::add_global_class(p_script_update.name, p_script_update.extends, lang, p_target_path, p_script_update.is_abstract, p_script_update.is_tool);\n+\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_update.name, p_script_update.icon_path);\n+\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_update.name);\n }\n \n void EditorFileSystem::register_global_class_script(const String &p_search_path, const String &p_target_path) {\n@@ -2463,7 +2439,7 @@ void EditorFileSystem::register_global_class_script(const String &p_search_path,\n \tEditorFileSystemDirectory *efsd = find_file(p_search_path, &index_file);\n \tif (efsd) {\n \t\tconst EditorFileSystemDirectory::FileInfo *fi = efsd->files[index_file];\n-\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, ScriptClassInfoUpdate::from_file_info(fi));\n \t} else {\n \t\tScriptServer::remove_global_class_by_path(p_search_path);\n \t}\ndiff --git a/editor/editor_file_system.h b/editor/editor_file_system.h\nindex 61041209a7fd..5b78b86a3f3f 100644\n--- a/editor/editor_file_system.h\n+++ b/editor/editor_file_system.h\n@@ -66,11 +66,15 @@ class EditorFileSystemDirectory : public Object {\n \t\tString import_group_file;\n \t\tVector<String> deps;\n \t\tbool verified = false; //used for checking changes\n-\t\t// These are for script resources only.\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n-\t\tString icon_path;\n+\t\t// This is for script resources only.\n+\t\tstruct ScriptClassInfo {\n+\t\t\tString name;\n+\t\t\tString extends;\n+\t\t\tString icon_path;\n+\t\t\tbool is_abstract = false;\n+\t\t\tbool is_tool = false;\n+\t\t};\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tVector<FileInfo *> files;\n@@ -203,9 +207,11 @@ class EditorFileSystem : public Node {\n \n \tstatic EditorFileSystem *singleton;\n \n+\tusing ScriptClassInfo = EditorFileSystemDirectory::FileInfo::ScriptClassInfo;\n+\n \t/* Used for reading the filesystem cache file */\n \tstruct FileCache {\n-\t\tString type;\n+\t\tStringName type;\n \t\tString resource_script_class;\n \t\tResourceUID::ID uid = ResourceUID::INVALID_ID;\n \t\tuint64_t modification_time = 0;\n@@ -215,9 +221,7 @@ class EditorFileSystem : public Node {\n \t\tVector<String> deps;\n \t\tbool import_valid = false;\n \t\tString import_group_file;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tHashMap<String, FileCache> file_cache;\n@@ -288,17 +292,27 @@ class EditorFileSystem : public Node {\n \t\t}\n \t};\n \n-\tstruct ScriptInfo {\n-\t\tString type;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\tstruct ScriptClassInfoUpdate : public ScriptClassInfo {\n+\t\tStringName type;\n+\t\tScriptClassInfoUpdate() = default;\n+\t\texplicit ScriptClassInfoUpdate(const ScriptClassInfo &p_info) :\n+\t\t\t\tScriptClassInfo(p_info) {}\n+\t\tstatic ScriptClassInfoUpdate from_file_info(const EditorFileSystemDirectory::FileInfo *p_fi) {\n+\t\t\tScriptClassInfoUpdate update;\n+\t\t\tupdate.type = p_fi->type;\n+\t\t\tupdate.name = p_fi->class_info.name;\n+\t\t\tupdate.extends = p_fi->class_info.extends;\n+\t\t\tupdate.icon_path = p_fi->class_info.icon_path;\n+\t\t\tupdate.is_abstract = p_fi->class_info.is_abstract;\n+\t\t\tupdate.is_tool = p_fi->class_info.is_tool;\n+\t\t\treturn update;\n+\t\t}\n \t};\n \n \tMutex update_script_mutex;\n-\tHashMap<String, ScriptInfo> update_script_paths;\n+\tHashMap<String, ScriptClassInfoUpdate> update_script_paths;\n \tHashSet<String> update_script_paths_documentation;\n-\tvoid _queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update);\n \tvoid _update_script_classes();\n \tvoid _update_script_documentation();\n \tvoid _process_update_pending();\n@@ -312,7 +326,7 @@ class EditorFileSystem : public Node {\n \tvoid _update_pending_scene_groups();\n \tvoid _get_all_scenes(EditorFileSystemDirectory *p_dir, HashSet<String> &r_list);\n \n-\tString _get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const;\n+\tScriptClassInfo _get_global_script_class(const String &p_type, const String &p_path) const;\n \n \tstatic Error _resource_import(const String &p_path);\n \tstatic Ref<Resource> _load_resource_on_startup(ResourceFormatImporter *p_importer, const String &p_path, Error *r_error, bool p_use_sub_threads, float *r_progress, ResourceFormatLoader::CacheMode p_cache_mode);\n@@ -359,7 +373,7 @@ class EditorFileSystem : public Node {\n \tvoid _remove_invalid_global_class_names(const HashSet<String> &p_existing_class_names);\n \tString _get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info);\n \n-\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update);\n \n protected:\n \tvoid _notification(int p_what);\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 4b7abdf2b072..3ada85d3de91 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -4805,13 +4805,13 @@ void EditorNode::_pick_main_scene_custom_action(const String &p_custom_action_na\n \t}\n }\n \n-Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback, bool p_fallback_script_to_theme) {\n+Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback, bool p_fallback_script_to_theme) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \tEditorData &ed = EditorNode::get_editor_data();\n \n \t// Check for a script icon first.\n-\tif (p_script.is_valid()) {\n-\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script);\n+\tif (!p_script_path.is_empty()) {\n+\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script_path);\n \t\tif (script_icon.is_valid()) {\n \t\t\treturn script_icon;\n \t\t}\n@@ -4819,14 +4819,15 @@ Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, cons\n \t\tif (p_fallback_script_to_theme) {\n \t\t\t// Look for the native base type in the editor theme. This is relevant for\n \t\t\t// scripts extending other scripts and for built-in classes.\n-\t\t\tString script_class_name = p_script->get_language()->get_global_class_name(p_script->get_path());\n \t\t\tString base_type;\n-\t\t\tif (script_class_name.is_empty()) {\n-\t\t\t\tbase_type = p_script->get_instance_base_type();\n+\t\t\tif (ScriptServer::is_global_class(p_class)) {\n+\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(p_class);\n \t\t\t} else {\n-\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(script_class_name);\n+\t\t\t\tRef<Script> scr = ResourceLoader::load(p_script_path, \"Script\");\n+\t\t\t\tif (scr.is_valid()) {\n+\t\t\t\t\tbase_type = scr->get_instance_base_type();\n+\t\t\t\t}\n \t\t\t}\n-\n \t\t\tif (theme.is_valid() && theme->has_icon(base_type, EditorStringName(EditorIcons))) {\n \t\t\t\treturn theme->get_icon(base_type, EditorStringName(EditorIcons));\n \t\t\t}\n@@ -4899,21 +4900,21 @@ Ref<Texture2D> EditorNode::get_object_icon(const Object *p_object, const String\n \tif (Object::cast_to<MultiNodeEdit>(p_object)) {\n \t\treturn get_class_icon(Object::cast_to<MultiNodeEdit>(p_object)->get_edited_class_name(), p_fallback);\n \t} else {\n-\t\treturn _get_class_or_script_icon(p_object->get_class(), scr, p_fallback);\n+\t\treturn _get_class_or_script_icon(p_object->get_class(), scr.is_valid() ? scr->get_path() : String(), p_fallback);\n \t}\n }\n \n Ref<Texture2D> EditorNode::get_class_icon(const String &p_class, const String &p_fallback) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \n-\tRef<Script> scr;\n+\tString script_path;\n \tif (ScriptServer::is_global_class(p_class)) {\n-\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_class);\n+\t\tscript_path = ScriptServer::get_global_class_path(p_class);\n \t} else if (ResourceLoader::exists(p_class)) { // If the script is not a class_name we check if the script resource exists.\n-\t\tscr = ResourceLoader::load(p_class);\n+\t\tscript_path = p_class;\n \t}\n \n-\treturn _get_class_or_script_icon(p_class, scr, p_fallback, true);\n+\treturn _get_class_or_script_icon(p_class, script_path, p_fallback, true);\n }\n \n bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringName &p_class) {\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex b77f6553fe96..2410996c948e 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -648,7 +648,7 @@ class EditorNode : public Node {\n \tvoid _feature_profile_changed();\n \tbool _is_class_editor_disabled_by_feature_profile(const StringName &p_class);\n \n-\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n+\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n \n \tvoid _pick_main_scene_custom_action(const String &p_custom_action_name);\n \ndiff --git a/modules/gdscript/gdscript.cpp b/modules/gdscript/gdscript.cpp\nindex db5a3b65ccb0..2383401630c4 100644\n--- a/modules/gdscript/gdscript.cpp\n+++ b/modules/gdscript/gdscript.cpp\n@@ -2831,7 +2831,7 @@ bool GDScriptLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == \"GDScript\";\n }\n \n-String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tError err;\n \tRef<FileAccess> f = FileAccess::open(p_path, FileAccess::READ, &err);\n \tif (err) {\n@@ -2932,6 +2932,12 @@ String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_b\n \tif (r_icon_path) {\n \t\t*r_icon_path = c->simplified_icon_path;\n \t}\n+\tif (r_is_abstract) {\n+\t\t*r_is_abstract = false;\n+\t}\n+\tif (r_is_tool) {\n+\t\t*r_is_tool = parser.is_tool();\n+\t}\n \treturn c->identifier != nullptr ? String(c->identifier->name) : String();\n }\n \ndiff --git a/modules/gdscript/gdscript.h b/modules/gdscript/gdscript.h\nindex ed04482f4811..9e96b8833496 100644\n--- a/modules/gdscript/gdscript.h\n+++ b/modules/gdscript/gdscript.h\n@@ -638,7 +638,7 @@ class GDScriptLanguage : public ScriptLanguage {\n \t/* GLOBAL CLASSES */\n \n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \tvoid add_orphan_subclass(const String &p_qualified_name, const ObjectID &p_subclass);\n \tRef<GDScript> get_orphan_subclass(const String &p_qualified_name);\ndiff --git a/modules/mono/csharp_script.cpp b/modules/mono/csharp_script.cpp\nindex e9a821c65a95..76c3ca3cb3eb 100644\n--- a/modules/mono/csharp_script.cpp\n+++ b/modules/mono/csharp_script.cpp\n@@ -445,9 +445,9 @@ bool CSharpLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == get_type();\n }\n \n-String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tString class_name;\n-\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, &class_name);\n+\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, r_is_abstract, r_is_tool, &class_name);\n \treturn class_name;\n }\n \ndiff --git a/modules/mono/csharp_script.h b/modules/mono/csharp_script.h\nindex 525357a4c413..4dfed135f861 100644\n--- a/modules/mono/csharp_script.h\n+++ b/modules/mono/csharp_script.h\n@@ -530,7 +530,7 @@ class CSharpLanguage : public ScriptLanguage {\n \n \t/* SCRIPT GLOBAL CLASS FUNCTIONS */\n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \t/* DEBUGGER FUNCTIONS */\n \tString debug_get_error() const override;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\nindex c7be0464b6c8..b0ff041fa49a 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n@@ -19,7 +19,7 @@ public unsafe struct ManagedCallbacks\n         public delegate* unmanaged<godot_string_name*, IntPtr, IntPtr> ScriptManagerBridge_CreateManagedForGodotObjectBinding;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_variant**, int, godot_bool> ScriptManagerBridge_CreateManagedForGodotObjectScriptInstance;\n         public delegate* unmanaged<IntPtr, godot_string_name*, void> ScriptManagerBridge_GetScriptNativeName;\n-        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n+        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_bool*, godot_bool*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n         public delegate* unmanaged<IntPtr, IntPtr, void> ScriptManagerBridge_SetGodotObjectPtr;\n         public delegate* unmanaged<IntPtr, godot_string_name*, godot_variant**, int, godot_bool*, void> ScriptManagerBridge_RaiseEventSignal;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_bool> ScriptManagerBridge_ScriptIsOrInherits;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\nindex e53f05f05825..a327b9cd354b 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n@@ -199,7 +199,7 @@ internal static unsafe void GetScriptNativeName(IntPtr scriptPtr, godot_string_n\n         }\n \n         [UnmanagedCallersOnly]\n-        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_string* outClassName)\n+        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_bool* outIsAbstract, godot_bool* outIsTool, godot_string* outClassName)\n         {\n             // This method must always return the outBaseType for every script, even if the script is\n             // not a global class. But if the script is not a global class it must return an empty\n@@ -254,6 +254,16 @@ internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_s\n                 }\n             }\n \n+            if (outIsAbstract != null)\n+            {\n+                *outIsAbstract = scriptType.IsAbstract.ToGodotBool();\n+            }\n+\n+            if (outIsTool != null)\n+            {\n+                *outIsTool = Attribute.IsDefined(scriptType, typeof(ToolAttribute)).ToGodotBool();\n+            }\n+\n             if (!IsGlobalClass(scriptType))\n             {\n                 // Scripts that are not global classes should not have a name.\ndiff --git a/modules/mono/mono_gd/gd_mono_cache.h b/modules/mono/mono_gd/gd_mono_cache.h\nindex 7c24f28b3a2a..f618921cd02b 100644\n--- a/modules/mono/mono_gd/gd_mono_cache.h\n+++ b/modules/mono/mono_gd/gd_mono_cache.h\n@@ -85,7 +85,7 @@ struct ManagedCallbacks {\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectBinding = GCHandleIntPtr(GD_CLR_STDCALL *)(const StringName *, Object *);\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectScriptInstance = bool(GD_CLR_STDCALL *)(const CSharpScript *, Object *, const Variant **, int32_t);\n \tusing FuncScriptManagerBridge_GetScriptNativeName = void(GD_CLR_STDCALL *)(const CSharpScript *, StringName *);\n-\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, String *);\n+\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, bool *, bool *, String *);\n \tusing FuncScriptManagerBridge_SetGodotObjectPtr = void(GD_CLR_STDCALL *)(GCHandleIntPtr, Object *);\n \tusing FuncScriptManagerBridge_RaiseEventSignal = void(GD_CLR_STDCALL *)(GCHandleIntPtr, const StringName *, const Variant **, int32_t, bool *);\n \tusing FuncScriptManagerBridge_ScriptIsOrInherits = bool(GD_CLR_STDCALL *)(const CSharpScript *, const CSharpScript *);\n", "test_patch": "diff --git a/modules/gdscript/tests/gdscript_test_runner.cpp b/modules/gdscript/tests/gdscript_test_runner.cpp\nindex 14dd79da9048..c7f92daa646a 100644\n--- a/modules/gdscript/tests/gdscript_test_runner.cpp\n+++ b/modules/gdscript/tests/gdscript_test_runner.cpp\n@@ -368,7 +368,9 @@ static bool generate_class_index_recursive(const String &p_dir) {\n \t\t\t}\n \t\t\tString base_type;\n \t\t\tString source_file = current_dir.path_join(next);\n-\t\t\tString class_name = GDScriptLanguage::get_singleton()->get_global_class_name(source_file, &base_type);\n+\t\t\tbool is_abstract = false;\n+\t\t\tbool is_tool = false;\n+\t\t\tString class_name = GDScriptLanguage::get_singleton()->get_global_class_name(source_file, &base_type, nullptr, &is_abstract, &is_tool);\n \t\t\tif (class_name.is_empty()) {\n \t\t\t\tnext = dir->get_next();\n \t\t\t\tcontinue;\n@@ -376,7 +378,7 @@ static bool generate_class_index_recursive(const String &p_dir) {\n \t\t\tERR_FAIL_COND_V_MSG(ScriptServer::is_global_class(class_name), false,\n \t\t\t\t\t\"Class name '\" + class_name + \"' from \" + source_file + \" is already used in \" + ScriptServer::get_global_class_path(class_name));\n \n-\t\t\tScriptServer::add_global_class(class_name, base_type, gdscript_name, source_file);\n+\t\t\tScriptServer::add_global_class(class_name, base_type, gdscript_name, source_file, is_abstract, is_tool);\n \t\t}\n \n \t\tnext = dir->get_next();\ndiff --git a/modules/gdscript/tests/test_gdscript.cpp b/modules/gdscript/tests/test_gdscript.cpp\nindex 7e93569e3901..ec20ed19fb9b 100644\n--- a/modules/gdscript/tests/test_gdscript.cpp\n+++ b/modules/gdscript/tests/test_gdscript.cpp\n@@ -297,10 +297,10 @@ void test(TestType p_type) {\n \tTypedArray<Dictionary> script_classes = ProjectSettings::get_singleton()->get_global_class_list();\n \tfor (int i = 0; i < script_classes.size(); i++) {\n \t\tDictionary c = script_classes[i];\n-\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\tcontinue;\n \t\t}\n-\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t}\n \n \tVector<uint8_t> buf;\n", "problem_statement": "Excessive error spam when a global script is not valid\n### Tested versions\n\n4.4 dev7\n\n### System information\n\nW10\n\n### Issue description\n\nIf you have a global script (with `class_name`) and it has an error, the error will be spammed occasionally when using editor. I observed it e.g. when opening CreateDialog to add a node (happens once), or every time you try to autocomplete something.\nhttps://github.com/user-attachments/assets/97e7b7f2-e148-42ee-a481-025a07a2d38f\nWhat's relevant though is that the error appears at all. It means the script is loaded and/or parsed needlessly *very often* and it probably applies to all global scripts. We should find a way to avoid that. The scripts should be parsed only after they change and use some cache whenever the editor needs something script-related.\n\n### Steps to reproduce\n\n1. Add a script with class name\n2. Introduce some parsing error, e.g. a random word wherever\n3. In another script, try autocompleting something\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-01-13 12:54:50", "merge_commit_sha": "acddf31c39f719b9012b1b3248ac28450238855b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101210", "base_commit": "4cf02312f6674083c5a628b4701643e1157c85f0", "patch": "diff --git a/servers/rendering/dummy/storage/material_storage.cpp b/servers/rendering/dummy/storage/material_storage.cpp\nindex e8b553ca7636..b22971a750cd 100644\n--- a/servers/rendering/dummy/storage/material_storage.cpp\n+++ b/servers/rendering/dummy/storage/material_storage.cpp\n@@ -30,6 +30,8 @@\n \n #include \"material_storage.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n using namespace RendererDummy;\n \n MaterialStorage *MaterialStorage::singleton = nullptr;\n@@ -42,6 +44,103 @@ MaterialStorage::MaterialStorage() {\n \n MaterialStorage::~MaterialStorage() {\n \tsingleton = nullptr;\n+\tglobal_shader_variables.clear();\n+}\n+\n+void MaterialStorage::global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) {\n+\tERR_FAIL_COND(global_shader_variables.has(p_name));\n+\n+\tglobal_shader_variables[p_name] = p_type;\n+}\n+\n+void MaterialStorage::global_shader_parameter_remove(const StringName &p_name) {\n+\tif (!global_shader_variables.has(p_name)) {\n+\t\treturn;\n+\t}\n+\n+\tglobal_shader_variables.erase(p_name);\n+}\n+\n+Vector<StringName> MaterialStorage::global_shader_parameter_get_list() const {\n+\tVector<StringName> names;\n+\tfor (const KeyValue<StringName, RS::GlobalShaderParameterType> &E : global_shader_variables) {\n+\t\tnames.push_back(E.key);\n+\t}\n+\tnames.sort_custom<StringName::AlphCompare>();\n+\treturn names;\n+}\n+\n+RS::GlobalShaderParameterType MaterialStorage::global_shader_parameter_get_type(const StringName &p_name) const {\n+\tif (!global_shader_variables.has(p_name)) {\n+\t\tprint_line(\"don't have name, sorry\");\n+\t\treturn RS::GLOBAL_VAR_TYPE_MAX;\n+\t}\n+\n+\treturn global_shader_variables[p_name];\n+}\n+\n+void MaterialStorage::global_shader_parameters_load_settings(bool p_load_textures) {\n+\tList<PropertyInfo> settings;\n+\tProjectSettings::get_singleton()->get_property_list(&settings);\n+\n+\tfor (const PropertyInfo &E : settings) {\n+\t\tif (E.name.begins_with(\"shader_globals/\")) {\n+\t\t\tStringName name = E.name.get_slice(\"/\", 1);\n+\t\t\tDictionary d = GLOBAL_GET(E.name);\n+\n+\t\t\tERR_CONTINUE(!d.has(\"type\"));\n+\t\t\tERR_CONTINUE(!d.has(\"value\"));\n+\n+\t\t\tString type = d[\"type\"];\n+\n+\t\t\tstatic const char *global_var_type_names[RS::GLOBAL_VAR_TYPE_MAX] = {\n+\t\t\t\t\"bool\",\n+\t\t\t\t\"bvec2\",\n+\t\t\t\t\"bvec3\",\n+\t\t\t\t\"bvec4\",\n+\t\t\t\t\"int\",\n+\t\t\t\t\"ivec2\",\n+\t\t\t\t\"ivec3\",\n+\t\t\t\t\"ivec4\",\n+\t\t\t\t\"rect2i\",\n+\t\t\t\t\"uint\",\n+\t\t\t\t\"uvec2\",\n+\t\t\t\t\"uvec3\",\n+\t\t\t\t\"uvec4\",\n+\t\t\t\t\"float\",\n+\t\t\t\t\"vec2\",\n+\t\t\t\t\"vec3\",\n+\t\t\t\t\"vec4\",\n+\t\t\t\t\"color\",\n+\t\t\t\t\"rect2\",\n+\t\t\t\t\"mat2\",\n+\t\t\t\t\"mat3\",\n+\t\t\t\t\"mat4\",\n+\t\t\t\t\"transform_2d\",\n+\t\t\t\t\"transform\",\n+\t\t\t\t\"sampler2D\",\n+\t\t\t\t\"sampler2DArray\",\n+\t\t\t\t\"sampler3D\",\n+\t\t\t\t\"samplerCube\",\n+\t\t\t\t\"samplerExternalOES\"\n+\t\t\t};\n+\n+\t\t\tRS::GlobalShaderParameterType gvtype = RS::GLOBAL_VAR_TYPE_MAX;\n+\n+\t\t\tfor (int i = 0; i < RS::GLOBAL_VAR_TYPE_MAX; i++) {\n+\t\t\t\tif (global_var_type_names[i] == type) {\n+\t\t\t\t\tgvtype = RS::GlobalShaderParameterType(i);\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tERR_CONTINUE(gvtype == RS::GLOBAL_VAR_TYPE_MAX); //type invalid\n+\n+\t\t\tif (!global_shader_variables.has(name)) {\n+\t\t\t\tglobal_shader_parameter_add(name, gvtype, Variant());\n+\t\t\t}\n+\t\t}\n+\t}\n }\n \n RID MaterialStorage::shader_allocate() {\n@@ -131,3 +230,56 @@ void MaterialStorage::get_shader_parameter_list(RID p_shader, List<PropertyInfo>\n \t\tp_param_list->push_back(pi);\n \t}\n }\n+\n+RID MaterialStorage::material_allocate() {\n+\treturn material_owner.allocate_rid();\n+}\n+\n+void MaterialStorage::material_initialize(RID p_rid) {\n+\tmaterial_owner.initialize_rid(p_rid, DummyMaterial());\n+}\n+\n+void MaterialStorage::material_free(RID p_rid) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_rid);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial_owner.free(p_rid);\n+}\n+\n+void MaterialStorage::material_set_shader(RID p_material, RID p_shader) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial->shader = p_shader;\n+}\n+\n+void MaterialStorage::material_set_next_pass(RID p_material, RID p_next_material) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial->next_pass = p_next_material;\n+}\n+\n+void MaterialStorage::material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\tDummyShader *shader = shader_owner.get_or_null(material->shader);\n+\n+\tif (shader) {\n+\t\tfor (const KeyValue<StringName, ShaderLanguage::ShaderNode::Uniform> &E : shader->uniforms) {\n+\t\t\tif (E.value.scope != ShaderLanguage::ShaderNode::Uniform::SCOPE_INSTANCE) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tRendererMaterialStorage::InstanceShaderParam p;\n+\t\t\tp.info = ShaderLanguage::uniform_to_property_info(E.value);\n+\t\t\tp.info.name = E.key; //supply name\n+\t\t\tp.index = E.value.instance_index;\n+\t\t\tp.default_value = ShaderLanguage::constant_value_to_variant(E.value.default_value, E.value.type, E.value.array_size, E.value.hint);\n+\t\t\tr_parameters->push_back(p);\n+\t\t}\n+\t}\n+\tif (material->next_pass.is_valid()) {\n+\t\tmaterial_get_instance_shader_parameters(material->next_pass, r_parameters);\n+\t}\n+}\ndiff --git a/servers/rendering/dummy/storage/material_storage.h b/servers/rendering/dummy/storage/material_storage.h\nindex 9422c395e2e6..ef46cf3b9b4f 100644\n--- a/servers/rendering/dummy/storage/material_storage.h\n+++ b/servers/rendering/dummy/storage/material_storage.h\n@@ -42,6 +42,8 @@ class MaterialStorage : public RendererMaterialStorage {\n private:\n \tstatic MaterialStorage *singleton;\n \n+\tHashMap<StringName, RS::GlobalShaderParameterType> global_shader_variables;\n+\n \tstruct DummyShader {\n \t\tHashMap<StringName, ShaderLanguage::ShaderNode::Uniform> uniforms;\n \t};\n@@ -50,6 +52,13 @@ class MaterialStorage : public RendererMaterialStorage {\n \n \tShaderCompiler dummy_compiler;\n \n+\tstruct DummyMaterial {\n+\t\tRID shader;\n+\t\tRID next_pass;\n+\t};\n+\n+\tmutable RID_Owner<DummyMaterial> material_owner;\n+\n public:\n \tstatic MaterialStorage *get_singleton() { return singleton; }\n \n@@ -58,16 +67,16 @@ class MaterialStorage : public RendererMaterialStorage {\n \n \t/* GLOBAL SHADER UNIFORM API */\n \n-\tvirtual void global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) override {}\n-\tvirtual void global_shader_parameter_remove(const StringName &p_name) override {}\n-\tvirtual Vector<StringName> global_shader_parameter_get_list() const override { return Vector<StringName>(); }\n+\tvirtual void global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) override;\n+\tvirtual void global_shader_parameter_remove(const StringName &p_name) override;\n+\tvirtual Vector<StringName> global_shader_parameter_get_list() const override;\n \n \tvirtual void global_shader_parameter_set(const StringName &p_name, const Variant &p_value) override {}\n \tvirtual void global_shader_parameter_set_override(const StringName &p_name, const Variant &p_value) override {}\n \tvirtual Variant global_shader_parameter_get(const StringName &p_name) const override { return Variant(); }\n-\tvirtual RS::GlobalShaderParameterType global_shader_parameter_get_type(const StringName &p_name) const override { return RS::GLOBAL_VAR_TYPE_MAX; }\n+\tvirtual RS::GlobalShaderParameterType global_shader_parameter_get_type(const StringName &p_name) const override;\n \n-\tvirtual void global_shader_parameters_load_settings(bool p_load_textures = true) override {}\n+\tvirtual void global_shader_parameters_load_settings(bool p_load_textures = true) override;\n \tvirtual void global_shader_parameters_clear() override {}\n \n \tvirtual int32_t global_shader_parameters_instance_allocate(RID p_instance) override { return 0; }\n@@ -95,23 +104,26 @@ class MaterialStorage : public RendererMaterialStorage {\n \tvirtual RS::ShaderNativeSourceCode shader_get_native_source_code(RID p_shader) const override { return RS::ShaderNativeSourceCode(); }\n \n \t/* MATERIAL API */\n-\tvirtual RID material_allocate() override { return RID(); }\n-\tvirtual void material_initialize(RID p_rid) override {}\n-\tvirtual void material_free(RID p_rid) override {}\n+\n+\tbool owns_material(RID p_rid) { return material_owner.owns(p_rid); }\n+\n+\tvirtual RID material_allocate() override;\n+\tvirtual void material_initialize(RID p_rid) override;\n+\tvirtual void material_free(RID p_rid) override;\n \n \tvirtual void material_set_render_priority(RID p_material, int priority) override {}\n-\tvirtual void material_set_shader(RID p_shader_material, RID p_shader) override {}\n+\tvirtual void material_set_shader(RID p_shader_material, RID p_shader) override;\n \n \tvirtual void material_set_param(RID p_material, const StringName &p_param, const Variant &p_value) override {}\n \tvirtual Variant material_get_param(RID p_material, const StringName &p_param) const override { return Variant(); }\n \n-\tvirtual void material_set_next_pass(RID p_material, RID p_next_material) override {}\n+\tvirtual void material_set_next_pass(RID p_material, RID p_next_material) override;\n \n \tvirtual bool material_is_animated(RID p_material) override { return false; }\n \tvirtual bool material_casts_shadows(RID p_material) override { return false; }\n \tvirtual RS::CullMode material_get_cull_mode(RID p_material) const override { return RS::CULL_MODE_DISABLED; }\n \n-\tvirtual void material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) override {}\n+\tvirtual void material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) override;\n \tvirtual void material_update_dependency(RID p_material, DependencyTracker *p_instance) override {}\n };\n \ndiff --git a/servers/rendering/dummy/storage/utilities.h b/servers/rendering/dummy/storage/utilities.h\nindex 4e20dee640e5..02e163fd8e8e 100644\n--- a/servers/rendering/dummy/storage/utilities.h\n+++ b/servers/rendering/dummy/storage/utilities.h\n@@ -77,6 +77,9 @@ class Utilities : public RendererUtilities {\n \t\t} else if (RendererDummy::MaterialStorage::get_singleton()->owns_shader(p_rid)) {\n \t\t\tRendererDummy::MaterialStorage::get_singleton()->shader_free(p_rid);\n \t\t\treturn true;\n+\t\t} else if (RendererDummy::MaterialStorage::get_singleton()->owns_material(p_rid)) {\n+\t\t\tRendererDummy::MaterialStorage::get_singleton()->material_free(p_rid);\n+\t\t\treturn true;\n \t\t}\n \t\treturn false;\n \t}\n", "test_patch": "", "problem_statement": "Sometimes when exporting in \"--headless\" mode, shaders with \"global uniform\" doesn't work\n### Tested versions\n\nReproduced: v4.3.stable.mono\n\n### System information\n\nGodot v4.3.stable.mono - Windows 10.0.19045 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2060 (NVIDIA; 32.0.15.6094) - AMD Ryzen 5 1600 Six-Core Processor (12 Threads)\n\n### Issue description\n\nSimilar to https://github.com/godotengine/godot/issues/102362, which seems only visual, but in some cases might change into completely breaking a shader.\nThe issue happens when you have shader with global uniforms (correctly added to the Project Settings) and export it.\n\nBehavior of exporting the project normally or via cmd and that of exporting it **via cmd with --headless** mode is different. Doing it the first method works correctly, doing it the second method breaks the shaders with global uniforms. \n\nBut importantly, the working of the exported shader will be based on **how the project was exported for the first time** \n\nSo:\n1. Export normally -> shader works in the build\n2. Export with --headless -> shader still work in the build\n\nBUT:\n1. Export with --headless -> shader does NOT work in the build\n2. **Export normally -> shader STILL does NOT work in the build**\n\nI traced this behavior to the \".godot/exported\" folder - if you remove it, you \"restart\" the process, as above.\n\nI noticed it first when setting up my CI pipeline (with Github Actions). As there is no .godot folder on the machine, and it uses --headless, it's gonna break the shaders every time. Only fix I found was including .godot/exported in the source control.\n\n\n### Steps to reproduce\n\n1. In empty project, create shader that uses \"global uniform\". Then create material using that shader and apply it on some mesh (not sure if required)\n2. Add the required global uniforms in Project Settings\n3. Remove the  \".godot/exported\" folder (if exists)\n4. Export the project using command line using \"--headless\" mode. (In case of MRP I use godot --headless --export-release \"Windows Desktop\" \"build/Shader Test.exe\")\n5. Notice the shader does not use the uniform correctly in the build\n\n### Minimal reproduction project (MRP)\n\n[shader-test.zip](https://github.com/user-attachments/files/18642930/shader-test.zip)\n", "hints_text": "", "created_at": "2025-01-07 04:51:54", "merge_commit_sha": "a0c3798fba393a02ec087b0cfdbe5e526c3c7769", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101205", "base_commit": "8c6dbff6d35eb613c83f065c408a49ab02fa7f67", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex ad850b574c38..8f0add25eacd 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -820,6 +820,7 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t}\n \n \tint line_count = 0;\n+\tbool has_visible_chars = false;\n \t// Bottom margin for text clipping.\n \tfloat v_limit = theme_cache.normal_style->get_margin(SIDE_BOTTOM);\n \tSize2 ctrl_size = get_size();\n@@ -843,8 +844,6 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\tfloat length = l.text_buf->get_line_size(line).x;\n \n \t\t// Draw line.\n-\t\tline_count++;\n-\n \t\tif (rtl) {\n \t\t\toff.x = p_width - l.offset.x - width;\n \t\t\tif (!lrtl && p_frame == main) { // Skip Scrollbar.\n@@ -1290,6 +1289,7 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\t\t\t\t\tbool skip = (trim_chars && l.char_offset + glyphs[i].end > visible_characters) || (trim_glyphs_ltr && (processed_glyphs_step >= visible_glyphs)) || (trim_glyphs_rtl && (processed_glyphs_step < total_glyphs - visible_glyphs));\n \t\t\t\t\t\tif (!skip) {\n \t\t\t\t\t\t\tif (txt_visible) {\n+\t\t\t\t\t\t\t\thas_visible_chars = true;\n \t\t\t\t\t\t\t\tif (step == DRAW_STEP_TEXT) {\n \t\t\t\t\t\t\t\t\tif (frid != RID()) {\n \t\t\t\t\t\t\t\t\t\tTS->font_draw_glyph(frid, ci, glyphs[i].font_size, fx_offset + char_off, gl, font_color);\n@@ -1410,6 +1410,10 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \n \t\tr_processed_glyphs = processed_glyphs_step;\n \t\toff.y += TS->shaped_text_get_descent(rid);\n+\t\tif (has_visible_chars) {\n+\t\t\tline_count++;\n+\t\t\thas_visible_chars = false;\n+\t\t}\n \t}\n \n \treturn line_count;\n", "test_patch": "", "problem_statement": "RichTextLabel `get_visible_line_count()` does not work with `visible_characters` anymore\n### Godot version\n\n4.0.2\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\n`get_visible_line_count()` used to take `visible_characters` into account, but now the value seems ignored. Visible line count returns the value as if all characters were visible (although it returns 0 for 0).\n\n### Steps to reproduce\n\n1. Add RichTextLabel\r\n2. Put multiline text\r\n3. Set `visible_characters` to 1\r\n4. Attach this script\r\n```GDScript\r\nextends RichTextLabel\r\n\r\nfunc _process(delta: float) -> void:\r\n\tprint(get_visible_line_count())\r\n```\r\n5. Notice it doesn't print 1\n\n### Minimal reproduction project\n\nN/A\nRichTextLabel `get_visible_line_count()` does not work with `visible_characters` anymore\n### Godot version\n\n4.0.2\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\n`get_visible_line_count()` used to take `visible_characters` into account, but now the value seems ignored. Visible line count returns the value as if all characters were visible (although it returns 0 for 0).\n\n### Steps to reproduce\n\n1. Add RichTextLabel\r\n2. Put multiline text\r\n3. Set `visible_characters` to 1\r\n4. Attach this script\r\n```GDScript\r\nextends RichTextLabel\r\n\r\nfunc _process(delta: float) -> void:\r\n\tprint(get_visible_line_count())\r\n```\r\n5. Notice it doesn't print 1\n\n### Minimal reproduction project\n\nN/A\n", "hints_text": "I managed to fix the issue in my project by changing `visible_characters_behavior` to Characters Before Shaping (idk why I had it changed, probably to fix some other issue). However I can't reproduce the fix in a minimal project xd The above code still yields broken behavior. What's more, if you set `visible_characters` to 1, nothing will be displayed (it's as if visible characters begin with the set value - 1). It works if you set it in `_process()`, but visible line count is still wrong.\nStill seems reproducible in 4.1 beta 3.\nI tried to fix this but I can't figure it out. The culprit lies here, as the counter goes up regardless of how many lines are actually visible (they do need to be processed anyway, to get the right offsets):\r\nhttps://github.com/godotengine/godot/blob/f28964805e44a5c068ce8fd9d1e00697fcd922dc/scene/gui/rich_text_label.cpp#L1974\r\nhttps://github.com/godotengine/godot/blob/f28964805e44a5c068ce8fd9d1e00697fcd922dc/scene/gui/rich_text_label.cpp#L865\r\n\r\nBut yeah...\nI managed to fix the issue in my project by changing `visible_characters_behavior` to Characters Before Shaping (idk why I had it changed, probably to fix some other issue). However I can't reproduce the fix in a minimal project xd The above code still yields broken behavior. What's more, if you set `visible_characters` to 1, nothing will be displayed (it's as if visible characters begin with the set value - 1). It works if you set it in `_process()`, but visible line count is still wrong.\nStill seems reproducible in 4.1 beta 3.\nI tried to fix this but I can't figure it out. The culprit lies here, as the counter goes up regardless of how many lines are actually visible (they do need to be processed anyway, to get the right offsets):\r\nhttps://github.com/godotengine/godot/blob/f28964805e44a5c068ce8fd9d1e00697fcd922dc/scene/gui/rich_text_label.cpp#L1974\r\nhttps://github.com/godotengine/godot/blob/f28964805e44a5c068ce8fd9d1e00697fcd922dc/scene/gui/rich_text_label.cpp#L865\r\n\r\nBut yeah...", "created_at": "2025-01-07 02:40:11", "merge_commit_sha": "2e657bf2ae5b275c6e74ab54e0190a4309bd07ff", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101162", "base_commit": "da4f9339ea7f614f5965e6a6b918b8c8285f2e1d", "patch": "diff --git a/scene/resources/particle_process_material.cpp b/scene/resources/particle_process_material.cpp\nindex dd81b1c4380d..13bc02014b01 100644\n--- a/scene/resources/particle_process_material.cpp\n+++ b/scene/resources/particle_process_material.cpp\n@@ -523,6 +523,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tfloat animation_offset;\\n\";\n \tcode += \"\tfloat lifetime;\\n\";\n \tcode += \"\tvec4 color;\\n\";\n+\tcode += \"\tfloat emission_texture_position;\\n\";\n \tcode += \"};\\n\\n\";\n \n \tcode += \"struct DynamicsParameters {\\n\";\n@@ -579,11 +580,15 @@ void ParticleProcessMaterial::_update_shader() {\n \tif (color_initial_ramp.is_valid()) {\n \t\tcode += \"\tparams.color *= texture(color_initial_ramp, vec2(rand_from_seed(alt_seed)));\\n\";\n \t}\n-\tif (emission_color_texture.is_valid() && (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS)) {\n-\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n-\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n-\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n-\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n+\t\tcode += \"\tparams.emission_texture_position = rand_from_seed(alt_seed);\\n\";\n+\n+\t\tif (emission_color_texture.is_valid()) {\n+\t\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n+\t\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\t\t}\n \t}\n \tcode += \"}\\n\\n\";\n \n@@ -614,7 +619,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t}\n \tcode += \"}\\n\\n\";\n \n-\tcode += \"vec3 calculate_initial_position(inout uint alt_seed) {\\n\";\n+\tcode += \"vec3 calculate_initial_position(inout DisplayParameters params, inout uint alt_seed) {\\n\";\n \tcode += \"\tfloat pi = 3.14159;\\n\";\n \tcode += \"\tvec3 pos = vec3(0.0);\\n\";\n \tcode += \"\t{ // Emission shape.\\n\";\n@@ -639,7 +644,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t\tcode += \"\t\tpos = vec3(rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0) * emission_box_extents;\\n\";\n \t}\n \tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tcode += \"\t\tpos = texelFetch(emission_texture_points, emission_tex_ofs, 0).xyz;\\n\";\n@@ -860,7 +865,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\t\tTRANSFORM[2].xyz = vec3(0.0, 0.0, 1.0);\\n\";\n \tcode += \"\t}\\n\";\n \tcode += \"\tif (RESTART_POSITION) {\\n\";\n-\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(alt_seed);\\n\";\n+\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(params, alt_seed);\\n\";\n \tif (turbulence_enabled) {\n \t\tcode += \"\t\tfloat initial_turbulence_displacement = mix(turbulence_initial_displacement_min, turbulence_initial_displacement_max, rand_from_seed(alt_seed));\\n\";\n \t\tcode += \"\t\tvec3 noise_direction = get_noise_direction(TRANSFORM[3].xyz);\\n\";\n@@ -871,7 +876,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tif (RESTART_VELOCITY) {\\n\";\n \tcode += \"\t\tVELOCITY = get_random_direction_from_spread(alt_seed, spread) * dynamic_params.initial_velocity_multiplier;\\n\";\n \tif (emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tif (particle_flags[PARTICLE_FLAG_DISABLE_Z]) {\n", "test_patch": "", "problem_statement": "GPUParticles2D emission mask captures random color instead of pixel color\n### Tested versions\n\n- Reproducible in: v4.2.stable.mono.official [46dc27791]\n\n### System information\n\nGodot v4.2.stable.mono - Windows 10.0.22621 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 31.0.15.4629) - 13th Gen Intel(R) Core(TM) i5-13600KF (20 Threads)\n\n### Issue description\n\nEmission mask for GPUParticles2D captures colors incorrectly, instead of copying colors from place where particles spawned, it uses random color from mask texture\n\n### Steps to reproduce\n\n1. Create `GPUParticles2D` node\r\n2. Set `Amount` to 10000 to make it look more detailed\r\n3. Create `ParticlesProcessMaterial` for it\r\n4. Load emission mask for it, using some color texture and with options `Solid pixels` and `Capture Colors from Pixels` (`centered` doesn't matter)\r\n5. View result\n\n### Minimal reproduction project (MRP)\n\n[Bug.zip](https://github.com/godotengine/godot/files/14071691/Bug.zip)\r\n\n", "hints_text": "", "created_at": "2025-01-05 22:26:47", "merge_commit_sha": "33c0fc5508f47af8fcd4b49d08d55a9021aef590", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101127", "base_commit": "bdf625bd54958c737fa6b7213b07581cc91059ad", "patch": "diff --git a/modules/gdscript/gdscript_editor.cpp b/modules/gdscript/gdscript_editor.cpp\nindex c20c17f34860..7ee8d8c42614 100644\n--- a/modules/gdscript/gdscript_editor.cpp\n+++ b/modules/gdscript/gdscript_editor.cpp\n@@ -3684,12 +3684,12 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::GROUP:\n \t\t\t\t\t\treturn ERR_BUG;\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::CLASS: {\n-\t\t\t\t\t\tString type_name;\n-\t\t\t\t\t\tString enum_name;\n-\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(member.get_datatype()), type_name, enum_name);\n+\t\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(member.get_datatype()), doc_type_name, doc_enum_name);\n \n \t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS;\n-\t\t\t\t\t\tr_result.class_name = type_name;\n+\t\t\t\t\t\tr_result.class_name = doc_type_name;\n \t\t\t\t\t} break;\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::CONSTANT:\n \t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n@@ -3712,11 +3712,11 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t}\n \n \t\t\t\tif (member.type != GDScriptParser::ClassNode::Member::CLASS) {\n-\t\t\t\t\tString type_name;\n-\t\t\t\t\tString enum_name;\n-\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), type_name, enum_name);\n+\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), doc_type_name, doc_enum_name);\n \n-\t\t\t\t\tr_result.class_name = type_name;\n+\t\t\t\t\tr_result.class_name = doc_type_name;\n \t\t\t\t\tr_result.class_member = name;\n \t\t\t\t}\n \n@@ -3934,21 +3934,35 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\tcase GDScriptParser::DataType::ENUM: {\n \t\t\t\tif (base_type.is_meta_type) {\n \t\t\t\t\tif (base_type.enum_values.has(p_symbol)) {\n-\t\t\t\t\t\tString type_name;\n-\t\t\t\t\t\tString enum_name;\n-\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), type_name, enum_name);\n+\t\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), doc_type_name, doc_enum_name);\n \n-\t\t\t\t\t\tif (CoreConstants::is_global_enum(enum_name)) {\n+\t\t\t\t\t\tif (CoreConstants::is_global_enum(doc_enum_name)) {\n \t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n \t\t\t\t\t\t\tr_result.class_name = \"@GlobalScope\";\n \t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\treturn OK;\n \t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tconst int dot_pos = enum_name.rfind_char('.');\n+\t\t\t\t\t\t\tconst int dot_pos = doc_enum_name.rfind_char('.');\n \t\t\t\t\t\t\tif (dot_pos >= 0) {\n \t\t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n-\t\t\t\t\t\t\t\tr_result.class_name = enum_name.left(dot_pos);\n+\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n \t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\tif (base_type.class_type != nullptr) {\n+\t\t\t\t\t\t\t\t\tconst String enum_name = doc_enum_name.substr(dot_pos + 1);\n+\t\t\t\t\t\t\t\t\tif (base_type.class_type->has_member(enum_name)) {\n+\t\t\t\t\t\t\t\t\t\tconst GDScriptParser::ClassNode::Member member = base_type.class_type->get_member(enum_name);\n+\t\t\t\t\t\t\t\t\t\tif (member.type == GDScriptParser::ClassNode::Member::ENUM) {\n+\t\t\t\t\t\t\t\t\t\t\tfor (const GDScriptParser::EnumNode::Value &value : member.m_enum->values) {\n+\t\t\t\t\t\t\t\t\t\t\t\tif (value.identifier->name == p_symbol) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\tr_result.location = value.line;\n+\t\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\treturn OK;\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n", "test_patch": "", "problem_statement": "Ctrl-Click on enum value/member does nothing\n### Tested versions\n\n- reproducible in: 4.4.dev7\n- reproducible on master (tested with a 03-Jan-2025 build - `v4.4.dev.gh-101012 [c37ada786]`)\n- works in: 4.4.dev6\n\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nI mentioned this here: https://github.com/godotengine/godot/issues/100680#issuecomment-2557966392\nWhile general control-click was restored with https://github.com/godotengine/godot/pull/100707 the enum issue remains.\n\nCTRL-clicking on an enum value/member does nothing (well, it actually navigates to the beginning of the line).\n\nE.g. enum like this:\n```\nclass_name E extends Object\n\nenum Team {\n\tNone,\n\tOne,\n}\n\nfunc test():\n\tvar t = E.Team.None\n```\nand CTRL-clicking on the `None` of `E.Team.None` does not take you to the `None` under `enum Team`.\n\n\n### Steps to reproduce\n\nOpen enum.gd in MRP - same code as in description.\n\n### Minimal reproduction project (MRP)\n\n[44dev7enum.zip](https://github.com/user-attachments/files/18303044/44dev7enum.zip)\n\n", "hints_text": "Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. \n\nhttps://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n\nIt seems that changing the class's documentation updates something and it suddenly works.\n\nI couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n> Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. https://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n> \n> It seems that changing the class's documentation updates something and it suddenly works.\n> \n> I couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n\nYes, ctrl-click change https://github.com/godotengine/godot/pull/100707 went into master after dev7.\n\nOkay that makes sense but still that behavior where adding documentation effects Ctrl+click is very weird... can you reproduce it on your computer?", "created_at": "2025-01-04 14:14:17", "merge_commit_sha": "0b6a717ac17f1d6bd7963740cf2c2128b36ff7aa", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100983", "base_commit": "2582793d408ade0b6ed42f913ae33e7da5fb9184", "patch": "diff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex 50ee2699a244..eccd7c385478 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -59,6 +59,26 @@ JPH::ObjectLayer JoltArea3D::_get_object_layer() const {\n \treturn space->map_to_object_layer(_get_broad_phase_layer(), collision_layer, collision_mask);\n }\n \n+bool JoltArea3D::_has_pending_events() const {\n+\tif (body_monitor_callback.is_valid()) {\n+\t\tfor (const KeyValue<JPH::BodyID, Overlap> &E : bodies_by_id) {\n+\t\t\tif (!E.value.pending_added.is_empty() || !E.value.pending_removed.is_empty()) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (area_monitor_callback.is_valid()) {\n+\t\tfor (const KeyValue<JPH::BodyID, Overlap> &E : areas_by_id) {\n+\t\t\tif (!E.value.pending_added.is_empty() || !E.value.pending_removed.is_empty()) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\treturn false;\n+}\n+\n void JoltArea3D::_add_to_space() {\n \tjolt_shape = build_shape();\n \n@@ -90,6 +110,18 @@ void JoltArea3D::_add_to_space() {\n \tjolt_settings = nullptr;\n }\n \n+void JoltArea3D::_enqueue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->enqueue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n+void JoltArea3D::_dequeue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->dequeue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n void JoltArea3D::_add_shape_pair(Overlap &p_overlap, const JPH::BodyID &p_body_id, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id) {\n \tconst JoltReadableBody3D other_jolt_body = space->read_body(p_body_id);\n \tconst JoltShapedObject3D *other_object = other_jolt_body.as_shaped();\n@@ -270,6 +302,8 @@ void JoltArea3D::_space_changing() {\n \t\t_force_bodies_exited(true);\n \t\t_force_areas_exited(true);\n \t}\n+\n+\t_dequeue_call_queries();\n }\n \n void JoltArea3D::_space_changed() {\n@@ -304,7 +338,8 @@ void JoltArea3D::_gravity_changed() {\n }\n \n JoltArea3D::JoltArea3D() :\n-\t\tJoltShapedObject3D(OBJECT_TYPE_AREA) {\n+\t\tJoltShapedObject3D(OBJECT_TYPE_AREA),\n+\t\tcall_queries_element(this) {\n }\n \n bool JoltArea3D::is_default_area() const {\n@@ -659,7 +694,13 @@ void JoltArea3D::area_exited(const JPH::BodyID &p_body_id) {\n \toverlap->shape_pairs.clear();\n }\n \n-void JoltArea3D::call_queries(JPH::Body &p_jolt_body) {\n+void JoltArea3D::call_queries() {\n \t_flush_events(bodies_by_id, body_monitor_callback);\n \t_flush_events(areas_by_id, area_monitor_callback);\n }\n+\n+void JoltArea3D::post_step(float p_step, JPH::Body &p_jolt_body) {\n+\tif (_has_pending_events()) {\n+\t\t_enqueue_call_queries();\n+\t}\n+}\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.h b/modules/jolt_physics/objects/jolt_area_3d.h\nindex d151a7d05ad3..18410c34cfc2 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.h\n+++ b/modules/jolt_physics/objects/jolt_area_3d.h\n@@ -89,6 +89,8 @@ class JoltArea3D final : public JoltShapedObject3D {\n \n \ttypedef HashMap<JPH::BodyID, Overlap, BodyIDHasher> OverlapsById;\n \n+\tSelfList<JoltArea3D> call_queries_element;\n+\n \tOverlapsById bodies_by_id;\n \tOverlapsById areas_by_id;\n \n@@ -115,8 +117,13 @@ class JoltArea3D final : public JoltShapedObject3D {\n \n \tvirtual JPH::EMotionType _get_motion_type() const override { return JPH::EMotionType::Kinematic; }\n \n+\tbool _has_pending_events() const;\n+\n \tvirtual void _add_to_space() override;\n \n+\tvoid _enqueue_call_queries();\n+\tvoid _dequeue_call_queries();\n+\n \tvoid _add_shape_pair(Overlap &p_overlap, const JPH::BodyID &p_body_id, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id);\n \tbool _remove_shape_pair(Overlap &p_overlap, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id);\n \n@@ -217,10 +224,12 @@ class JoltArea3D final : public JoltShapedObject3D {\n \tvoid body_exited(const JPH::BodyID &p_body_id, bool p_notify = true);\n \tvoid area_exited(const JPH::BodyID &p_body_id);\n \n-\tvoid call_queries(JPH::Body &p_jolt_body);\n+\tvoid call_queries();\n \n \tvirtual bool has_custom_center_of_mass() const override { return false; }\n \tvirtual Vector3 get_center_of_mass_custom() const override { return Vector3(); }\n+\n+\tvirtual void post_step(float p_step, JPH::Body &p_jolt_body) override;\n };\n \n #endif // JOLT_AREA_3D_H\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex 59ba42c6ca91..3768dc8d0a9c 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -128,6 +128,7 @@ void JoltBody3D::_add_to_space() {\n \tjolt_settings->mAllowDynamicOrKinematic = true;\n \tjolt_settings->mCollideKinematicVsNonDynamic = reports_all_kinematic_contacts();\n \tjolt_settings->mUseManifoldReduction = !reports_contacts();\n+\tjolt_settings->mAllowSleeping = is_sleep_actually_allowed();\n \tjolt_settings->mLinearDamping = 0.0f;\n \tjolt_settings->mAngularDamping = 0.0f;\n \tjolt_settings->mMaxLinearVelocity = JoltProjectSettings::get_max_linear_velocity();\n@@ -153,11 +154,19 @@ void JoltBody3D::_add_to_space() {\n \tjolt_settings = nullptr;\n }\n \n-void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n-\tif (!p_jolt_body.IsActive()) {\n-\t\treturn;\n+void JoltBody3D::_enqueue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->enqueue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n+void JoltBody3D::_dequeue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->dequeue_call_queries(&call_queries_element);\n \t}\n+}\n \n+void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n \t_update_gravity(p_jolt_body);\n \n \tif (!custom_integrator) {\n@@ -182,8 +191,6 @@ void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n \t\tp_jolt_body.AddForce(to_jolt(constant_force));\n \t\tp_jolt_body.AddTorque(to_jolt(constant_torque));\n \t}\n-\n-\tsync_state = true;\n }\n \n void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n@@ -201,27 +208,19 @@ void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \t}\n \n \tp_jolt_body.MoveKinematic(new_position, new_rotation, p_step);\n-\n-\tsync_state = true;\n-}\n-\n-void JoltBody3D::_pre_step_static(float p_step, JPH::Body &p_jolt_body) {\n-\t// Nothing to do.\n }\n \n void JoltBody3D::_pre_step_rigid(float p_step, JPH::Body &p_jolt_body) {\n \t_integrate_forces(p_step, p_jolt_body);\n+\t_enqueue_call_queries();\n }\n \n void JoltBody3D::_pre_step_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \t_update_gravity(p_jolt_body);\n-\n \t_move_kinematic(p_step, p_jolt_body);\n \n \tif (reports_contacts()) {\n-\t\t// This seems to emulate the behavior of Godot Physics, where kinematic bodies are set as active (and thereby\n-\t\t// have their state synchronized on every step) only if its max reported contacts is non-zero.\n-\t\tsync_state = true;\n+\t\t_enqueue_call_queries();\n \t}\n }\n \n@@ -428,6 +427,20 @@ void JoltBody3D::_update_possible_kinematic_contacts() {\n \t}\n }\n \n+void JoltBody3D::_update_sleep_allowed() {\n+\tconst bool value = is_sleep_actually_allowed();\n+\n+\tif (!in_space()) {\n+\t\tjolt_settings->mAllowSleeping = value;\n+\t\treturn;\n+\t}\n+\n+\tconst JoltWritableBody3D body = space->write_body(jolt_id);\n+\tERR_FAIL_COND(body.is_invalid());\n+\n+\tbody->SetAllowSleeping(value);\n+}\n+\n void JoltBody3D::_destroy_joint_constraints() {\n \tfor (JoltJoint3D *joint : joints) {\n \t\tjoint->destroy();\n@@ -460,6 +473,7 @@ void JoltBody3D::_mode_changed() {\n \t_update_object_layer();\n \t_update_kinematic_transform();\n \t_update_mass_properties();\n+\t_update_sleep_allowed();\n \twake_up();\n }\n \n@@ -478,6 +492,7 @@ void JoltBody3D::_space_changing() {\n \n \t_destroy_joint_constraints();\n \t_exit_all_areas();\n+\t_dequeue_call_queries();\n }\n \n void JoltBody3D::_space_changed() {\n@@ -486,9 +501,8 @@ void JoltBody3D::_space_changed() {\n \t_update_kinematic_transform();\n \t_update_group_filter();\n \t_update_joint_constraints();\n+\t_update_sleep_allowed();\n \t_areas_changed();\n-\n-\tsync_state = false;\n }\n \n void JoltBody3D::_areas_changed() {\n@@ -519,11 +533,18 @@ void JoltBody3D::_axis_lock_changed() {\n \n void JoltBody3D::_contact_reporting_changed() {\n \t_update_possible_kinematic_contacts();\n+\t_update_sleep_allowed();\n+\twake_up();\n+}\n+\n+void JoltBody3D::_sleep_allowed_changed() {\n+\t_update_sleep_allowed();\n \twake_up();\n }\n \n JoltBody3D::JoltBody3D() :\n-\t\tJoltShapedObject3D(OBJECT_TYPE_BODY) {\n+\t\tJoltShapedObject3D(OBJECT_TYPE_BODY),\n+\t\tcall_queries_element(this) {\n }\n \n JoltBody3D::~JoltBody3D() {\n@@ -573,7 +594,7 @@ Variant JoltBody3D::get_state(PhysicsServer3D::BodyState p_state) const {\n \t\t\treturn is_sleeping();\n \t\t}\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\treturn can_sleep();\n+\t\t\treturn is_sleep_allowed();\n \t\t}\n \t\tdefault: {\n \t\t\tERR_FAIL_V_MSG(Variant(), vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -596,7 +617,7 @@ void JoltBody3D::set_state(PhysicsServer3D::BodyState p_state, const Variant &p_\n \t\t\tset_is_sleeping(p_value);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\tset_can_sleep(p_value);\n+\t\t\tset_is_sleep_allowed(p_value);\n \t\t} break;\n \t\tdefault: {\n \t\t\tERR_FAIL_MSG(vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -712,6 +733,10 @@ bool JoltBody3D::is_sleeping() const {\n \treturn !body->IsActive();\n }\n \n+bool JoltBody3D::is_sleep_actually_allowed() const {\n+\treturn sleep_allowed && !(is_kinematic() && reports_contacts());\n+}\n+\n void JoltBody3D::set_is_sleeping(bool p_enabled) {\n \tif (!in_space()) {\n \t\tsleep_initially = p_enabled;\n@@ -727,27 +752,14 @@ void JoltBody3D::set_is_sleeping(bool p_enabled) {\n \t}\n }\n \n-bool JoltBody3D::can_sleep() const {\n-\tif (!in_space()) {\n-\t\treturn jolt_settings->mAllowSleeping;\n-\t}\n-\n-\tconst JoltReadableBody3D body = space->read_body(jolt_id);\n-\tERR_FAIL_COND_V(body.is_invalid(), false);\n-\n-\treturn body->GetAllowSleeping();\n-}\n-\n-void JoltBody3D::set_can_sleep(bool p_enabled) {\n-\tif (!in_space()) {\n-\t\tjolt_settings->mAllowSleeping = p_enabled;\n+void JoltBody3D::set_is_sleep_allowed(bool p_enabled) {\n+\tif (sleep_allowed == p_enabled) {\n \t\treturn;\n \t}\n \n-\tconst JoltWritableBody3D body = space->write_body(jolt_id);\n-\tERR_FAIL_COND(body.is_invalid());\n+\tsleep_allowed = p_enabled;\n \n-\tbody->SetAllowSleeping(p_enabled);\n+\t_sleep_allowed_changed();\n }\n \n Basis JoltBody3D::get_principal_inertia_axes() const {\n@@ -1187,11 +1199,7 @@ void JoltBody3D::remove_joint(JoltJoint3D *p_joint) {\n \t_joints_changed();\n }\n \n-void JoltBody3D::call_queries(JPH::Body &p_jolt_body) {\n-\tif (!sync_state) {\n-\t\treturn;\n-\t}\n-\n+void JoltBody3D::call_queries() {\n \tif (custom_integration_callback.is_valid()) {\n \t\tconst Variant direct_state_variant = get_direct_state();\n \t\tconst Variant *args[2] = { &direct_state_variant, &custom_integration_userdata };\n@@ -1218,8 +1226,6 @@ void JoltBody3D::call_queries(JPH::Body &p_jolt_body) {\n \t\t\tERR_PRINT_ONCE(vformat(\"Failed to call state synchronization callback for '%s'. It returned the following error: '%s'.\", to_string(), Variant::get_callable_error_text(state_sync_callback, args, 1, ce)));\n \t\t}\n \t}\n-\n-\tsync_state = false;\n }\n \n void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n@@ -1227,7 +1233,7 @@ void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n \n \tswitch (mode) {\n \t\tcase PhysicsServer3D::BODY_MODE_STATIC: {\n-\t\t\t_pre_step_static(p_step, p_jolt_body);\n+\t\t\t// Will never happen.\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID:\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID_LINEAR: {\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.h b/modules/jolt_physics/objects/jolt_body_3d.h\nindex dc1e258bec86..8e5a149437a3 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_body_3d.h\n@@ -57,6 +57,8 @@ class JoltBody3D final : public JoltShapedObject3D {\n \t};\n \n private:\n+\tSelfList<JoltBody3D> call_queries_element;\n+\n \tLocalVector<RID> exceptions;\n \tLocalVector<Contact> contacts;\n \tLocalVector<JoltArea3D *> areas;\n@@ -96,7 +98,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tuint32_t locked_axes = 0;\n \n-\tbool sync_state = false;\n+\tbool sleep_allowed = true;\n \tbool sleep_initially = false;\n \tbool custom_center_of_mass = false;\n \tbool custom_integrator = false;\n@@ -108,11 +110,13 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvirtual void _add_to_space() override;\n \n+\tvoid _enqueue_call_queries();\n+\tvoid _dequeue_call_queries();\n+\n \tvoid _integrate_forces(float p_step, JPH::Body &p_jolt_body);\n \n \tvoid _move_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n-\tvoid _pre_step_static(float p_step, JPH::Body &p_jolt_body);\n \tvoid _pre_step_rigid(float p_step, JPH::Body &p_jolt_body);\n \tvoid _pre_step_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n@@ -128,6 +132,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid _update_group_filter();\n \tvoid _update_joint_constraints();\n \tvoid _update_possible_kinematic_contacts();\n+\tvoid _update_sleep_allowed();\n \n \tvoid _destroy_joint_constraints();\n \n@@ -144,6 +149,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid _exceptions_changed();\n \tvoid _axis_lock_changed();\n \tvoid _contact_reporting_changed();\n+\tvoid _sleep_allowed_changed();\n \n public:\n \tJoltBody3D();\n@@ -175,8 +181,9 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid put_to_sleep() { set_is_sleeping(true); }\n \tvoid wake_up() { set_is_sleeping(false); }\n \n-\tbool can_sleep() const;\n-\tvoid set_can_sleep(bool p_enabled);\n+\tbool is_sleep_allowed() const { return sleep_allowed; }\n+\tbool is_sleep_actually_allowed() const;\n+\tvoid set_is_sleep_allowed(bool p_enabled);\n \n \tBasis get_principal_inertia_axes() const;\n \tVector3 get_inverse_inertia() const;\n@@ -238,7 +245,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid add_joint(JoltJoint3D *p_joint);\n \tvoid remove_joint(JoltJoint3D *p_joint);\n \n-\tvoid call_queries(JPH::Body &p_jolt_body);\n+\tvoid call_queries();\n \n \tvirtual void pre_step(float p_step, JPH::Body &p_jolt_body) override;\n \ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex 9c83718fb6e6..577e8157a53d 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -160,13 +160,14 @@ void JoltShapedObject3D::_update_shape() {\n \tconst JoltWritableBody3D body = space->write_body(jolt_id);\n \tERR_FAIL_COND(body.is_invalid());\n \n-\tprevious_jolt_shape = jolt_shape;\n-\tjolt_shape = build_shape();\n-\n-\tif (jolt_shape == previous_jolt_shape) {\n+\tJPH::ShapeRefC new_shape = build_shape();\n+\tif (new_shape == jolt_shape) {\n \t\treturn;\n \t}\n \n+\tprevious_jolt_shape = jolt_shape;\n+\tjolt_shape = new_shape;\n+\n \tspace->get_body_iface().SetShape(jolt_id, jolt_shape, false, JPH::EActivation::DontActivate);\n \n \t_shapes_built();\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\nindex c9e834fd42e2..281591af9a6c 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n@@ -438,7 +438,7 @@ void JoltSoftBody3D::set_is_sleeping(bool p_enabled) {\n \t}\n }\n \n-bool JoltSoftBody3D::can_sleep() const {\n+bool JoltSoftBody3D::is_sleep_allowed() const {\n \tif (!in_space()) {\n \t\treturn true;\n \t}\n@@ -449,7 +449,7 @@ bool JoltSoftBody3D::can_sleep() const {\n \treturn body->GetAllowSleeping();\n }\n \n-void JoltSoftBody3D::set_can_sleep(bool p_enabled) {\n+void JoltSoftBody3D::set_is_sleep_allowed(bool p_enabled) {\n \tif (!in_space()) {\n \t\treturn;\n \t}\n@@ -532,7 +532,7 @@ Variant JoltSoftBody3D::get_state(PhysicsServer3D::BodyState p_state) const {\n \t\t\treturn is_sleeping();\n \t\t}\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\treturn can_sleep();\n+\t\t\treturn is_sleep_allowed();\n \t\t}\n \t\tdefault: {\n \t\t\tERR_FAIL_V_MSG(Variant(), vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -555,7 +555,7 @@ void JoltSoftBody3D::set_state(PhysicsServer3D::BodyState p_state, const Variant\n \t\t\tset_is_sleeping(p_value);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\tset_can_sleep(p_value);\n+\t\t\tset_is_sleep_allowed(p_value);\n \t\t} break;\n \t\tdefault: {\n \t\t\tERR_FAIL_MSG(vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.h b/modules/jolt_physics/objects/jolt_soft_body_3d.h\nindex 45e8be2e7bf4..f236310f6c69 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.h\n@@ -124,8 +124,8 @@ class JoltSoftBody3D final : public JoltObject3D {\n \tbool is_sleeping() const;\n \tvoid set_is_sleeping(bool p_enabled);\n \n-\tbool can_sleep() const;\n-\tvoid set_can_sleep(bool p_enabled);\n+\tbool is_sleep_allowed() const;\n+\tvoid set_is_sleep_allowed(bool p_enabled);\n \n \tvoid put_to_sleep() { set_is_sleeping(true); }\n \tvoid wake_up() { set_is_sleeping(false); }\ndiff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\nindex 85cf08d4c921..85a29a244bdd 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n@@ -86,10 +86,6 @@ void JoltContactListener3D::OnSoftBodyContactAdded(const JPH::Body &p_soft_body,\n \n #endif\n \n-bool JoltContactListener3D::_is_listening_for(const JPH::Body &p_body) const {\n-\treturn listening_for.has(p_body.GetID());\n-}\n-\n bool JoltContactListener3D::_try_override_collision_response(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings) {\n \tif (p_jolt_body1.IsSensor() || p_jolt_body2.IsSensor()) {\n \t\treturn false;\n@@ -178,16 +174,19 @@ bool JoltContactListener3D::_try_apply_surface_velocities(const JPH::Body &p_jol\n \treturn true;\n }\n \n-bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings) {\n-\tif (p_body1.IsSensor() || p_body2.IsSensor()) {\n+bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings) {\n+\tif (p_jolt_body1.IsSensor() || p_jolt_body2.IsSensor()) {\n \t\treturn false;\n \t}\n \n-\tif (!_is_listening_for(p_body1) && !_is_listening_for(p_body2)) {\n+\tconst JoltBody3D *body1 = reinterpret_cast<JoltBody3D *>(p_jolt_body1.GetUserData());\n+\tconst JoltBody3D *body2 = reinterpret_cast<JoltBody3D *>(p_jolt_body2.GetUserData());\n+\n+\tif (!body1->reports_contacts() && !body2->reports_contacts()) {\n \t\treturn false;\n \t}\n \n-\tconst JPH::SubShapeIDPair shape_pair(p_body1.GetID(), p_manifold.mSubShapeID1, p_body2.GetID(), p_manifold.mSubShapeID2);\n+\tconst JPH::SubShapeIDPair shape_pair(p_jolt_body1.GetID(), p_manifold.mSubShapeID1, p_jolt_body2.GetID(), p_manifold.mSubShapeID2);\n \n \tManifold &manifold = [&]() -> Manifold & {\n \t\tconst MutexLock write_lock(write_mutex);\n@@ -201,8 +200,7 @@ bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JP\n \tmanifold.depth = p_manifold.mPenetrationDepth;\n \n \tJPH::CollisionEstimationResult collision;\n-\n-\tJPH::EstimateCollisionResponse(p_body1, p_body2, p_manifold, collision, p_settings.mCombinedFriction, p_settings.mCombinedRestitution, JoltProjectSettings::get_bounce_velocity_threshold(), 5);\n+\tJPH::EstimateCollisionResponse(p_jolt_body1, p_jolt_body2, p_manifold, collision, p_settings.mCombinedFriction, p_settings.mCombinedRestitution, JoltProjectSettings::get_bounce_velocity_threshold(), 5);\n \n \tfor (JPH::uint i = 0; i < contact_count; ++i) {\n \t\tconst JPH::RVec3 relative_point1 = JPH::RVec3(p_manifold.mRelativeContactPointsOn1[i]);\n@@ -211,8 +209,8 @@ bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JP\n \t\tconst JPH::RVec3 world_point1 = p_manifold.mBaseOffset + relative_point1;\n \t\tconst JPH::RVec3 world_point2 = p_manifold.mBaseOffset + relative_point2;\n \n-\t\tconst JPH::Vec3 velocity1 = p_body1.GetPointVelocity(world_point1);\n-\t\tconst JPH::Vec3 velocity2 = p_body2.GetPointVelocity(world_point2);\n+\t\tconst JPH::Vec3 velocity1 = p_jolt_body1.GetPointVelocity(world_point1);\n+\t\tconst JPH::Vec3 velocity2 = p_jolt_body2.GetPointVelocity(world_point2);\n \n \t\tconst JPH::CollisionEstimationResult::Impulse &impulse = collision.mImpulses[i];\n \n@@ -532,13 +530,7 @@ void JoltContactListener3D::_flush_area_exits() {\n \tarea_exits.clear();\n }\n \n-void JoltContactListener3D::listen_for(JoltShapedObject3D *p_object) {\n-\tlistening_for.insert(p_object->get_jolt_id());\n-}\n-\n void JoltContactListener3D::pre_step() {\n-\tlistening_for.clear();\n-\n #ifdef DEBUG_ENABLED\n \tdebug_contact_count = 0;\n #endif\ndiff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.h b/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\nindex 26136abd83ac..41b3c9ef3bb2 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\n@@ -85,7 +85,6 @@ class JoltContactListener3D final\n \t};\n \n \tHashMap<JPH::SubShapeIDPair, Manifold, ShapePairHasher> manifolds_by_shape_pair;\n-\tHashSet<JPH::BodyID, BodyIDHasher> listening_for;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_overlaps;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_enters;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_exits;\n@@ -107,12 +106,10 @@ class JoltContactListener3D final\n \tvirtual void OnSoftBodyContactAdded(const JPH::Body &p_soft_body, const JPH::SoftBodyManifold &p_manifold) override;\n #endif\n \n-\tbool _is_listening_for(const JPH::Body &p_body) const;\n-\n \tbool _try_override_collision_response(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings);\n \tbool _try_override_collision_response(const JPH::Body &p_jolt_soft_body, const JPH::Body &p_jolt_other_body, JPH::SoftBodyContactSettings &p_settings);\n \tbool _try_apply_surface_velocities(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings);\n-\tbool _try_add_contacts(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings);\n+\tbool _try_add_contacts(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings);\n \tbool _try_evaluate_area_overlap(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold);\n \tbool _try_remove_contacts(const JPH::SubShapeIDPair &p_shape_pair);\n \tbool _try_remove_area_overlap(const JPH::SubShapeIDPair &p_shape_pair);\n@@ -131,8 +128,6 @@ class JoltContactListener3D final\n \texplicit JoltContactListener3D(JoltSpace3D *p_space) :\n \t\t\tspace(p_space) {}\n \n-\tvoid listen_for(JoltShapedObject3D *p_object);\n-\n \tvoid pre_step();\n \tvoid post_step();\n \ndiff --git a/modules/jolt_physics/spaces/jolt_space_3d.cpp b/modules/jolt_physics/spaces/jolt_space_3d.cpp\nindex 57d813df2b95..78bdf778f554 100644\n--- a/modules/jolt_physics/spaces/jolt_space_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_space_3d.cpp\n@@ -63,55 +63,36 @@ constexpr double DEFAULT_SOLVER_ITERATIONS = 8;\n } // namespace\n \n void JoltSpace3D::_pre_step(float p_step) {\n-\tbody_accessor.acquire_all();\n-\n \tcontact_listener->pre_step();\n \n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSoftBody()) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n-\t\t\tJoltShapedObject3D *object = reinterpret_cast<JoltShapedObject3D *>(jolt_body->GetUserData());\n-\n-\t\t\tobject->pre_step(p_step, *jolt_body);\n+\tconst JPH::BodyLockInterface &lock_iface = get_lock_iface();\n+\tconst JPH::BodyID *active_rigid_bodies = physics_system->GetActiveBodiesUnsafe(JPH::EBodyType::RigidBody);\n+\tconst JPH::uint32 active_rigid_body_count = physics_system->GetNumActiveBodies(JPH::EBodyType::RigidBody);\n \n-\t\t\tif (object->reports_contacts()) {\n-\t\t\t\tcontact_listener->listen_for(object);\n-\t\t\t}\n-\t\t}\n+\tfor (JPH::uint32 i = 0; i < active_rigid_body_count; i++) {\n+\t\tJPH::Body *jolt_body = lock_iface.TryGetBody(active_rigid_bodies[i]);\n+\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\t\tobject->pre_step(p_step, *jolt_body);\n \t}\n-\n-\tbody_accessor.release();\n }\n \n void JoltSpace3D::_post_step(float p_step) {\n-\tbody_accessor.acquire_all();\n-\n \tcontact_listener->post_step();\n \n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSoftBody()) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n+\t// WARNING: The list of active bodies may have changed between `pre_step` and `post_step`.\n \n-\t\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\tconst JPH::BodyLockInterface &lock_iface = get_lock_iface();\n+\tconst JPH::BodyID *active_rigid_bodies = physics_system->GetActiveBodiesUnsafe(JPH::EBodyType::RigidBody);\n+\tconst JPH::uint32 active_rigid_body_count = physics_system->GetNumActiveBodies(JPH::EBodyType::RigidBody);\n \n-\t\t\tobject->post_step(p_step, *jolt_body);\n-\t\t}\n+\tfor (JPH::uint32 i = 0; i < active_rigid_body_count; i++) {\n+\t\tJPH::Body *jolt_body = lock_iface.TryGetBody(active_rigid_bodies[i]);\n+\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\t\tobject->post_step(p_step, *jolt_body);\n \t}\n-\n-\tbody_accessor.release();\n }\n \n JoltSpace3D::JoltSpace3D(JPH::JobSystem *p_job_system) :\n-\t\tbody_accessor(this),\n \t\tjob_system(p_job_system),\n \t\ttemp_allocator(new JoltTempAllocator()),\n \t\tlayers(new JoltLayers()),\n@@ -208,44 +189,21 @@ void JoltSpace3D::step(float p_step) {\n \t_post_step(p_step);\n \n \tbodies_added_since_optimizing = 0;\n-\thas_stepped = true;\n \tstepping = false;\n }\n \n void JoltSpace3D::call_queries() {\n-\tif (!has_stepped) {\n-\t\t// We need to skip the first invocation of this method, because there will be pending notifications that need to\n-\t\t// be flushed first, which can cause weird conflicts with things like `_integrate_forces`. This happens to also\n-\t\t// emulate the behavior of Godot Physics, where (active) collision objects must register to have `call_queries`\n-\t\t// invoked, which they don't do until the physics step, which happens after this.\n-\t\t//\n-\t\t// TODO: This would be better solved by just doing what Godot Physics does with `GodotSpace*D::active_list`.\n-\t\treturn;\n-\t}\n-\n-\tbody_accessor.acquire_all();\n-\n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (!jolt_body->IsSensor() && !jolt_body->IsSoftBody()) {\n-\t\t\t\tJoltBody3D *body = reinterpret_cast<JoltBody3D *>(jolt_body->GetUserData());\n-\t\t\t\tbody->call_queries(*jolt_body);\n-\t\t\t}\n-\t\t}\n+\twhile (body_call_queries_list.first()) {\n+\t\tJoltBody3D *body = body_call_queries_list.first()->self();\n+\t\tbody_call_queries_list.remove(body_call_queries_list.first());\n+\t\tbody->call_queries();\n \t}\n \n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSensor()) {\n-\t\t\t\tJoltArea3D *area = reinterpret_cast<JoltArea3D *>(jolt_body->GetUserData());\n-\t\t\t\tarea->call_queries(*jolt_body);\n-\t\t\t}\n-\t\t}\n+\twhile (area_call_queries_list.first()) {\n+\t\tJoltArea3D *body = area_call_queries_list.first()->self();\n+\t\tarea_call_queries_list.remove(area_call_queries_list.first());\n+\t\tbody->call_queries();\n \t}\n-\n-\tbody_accessor.release();\n }\n \n double JoltSpace3D::get_param(PhysicsServer3D::SpaceParameter p_param) const {\n@@ -445,6 +403,30 @@ void JoltSpace3D::try_optimize() {\n \tbodies_added_since_optimizing = 0;\n }\n \n+void JoltSpace3D::enqueue_call_queries(SelfList<JoltBody3D> *p_body) {\n+\tif (!p_body->in_list()) {\n+\t\tbody_call_queries_list.add(p_body);\n+\t}\n+}\n+\n+void JoltSpace3D::enqueue_call_queries(SelfList<JoltArea3D> *p_area) {\n+\tif (!p_area->in_list()) {\n+\t\tarea_call_queries_list.add(p_area);\n+\t}\n+}\n+\n+void JoltSpace3D::dequeue_call_queries(SelfList<JoltBody3D> *p_body) {\n+\tif (p_body->in_list()) {\n+\t\tbody_call_queries_list.remove(p_body);\n+\t}\n+}\n+\n+void JoltSpace3D::dequeue_call_queries(SelfList<JoltArea3D> *p_area) {\n+\tif (p_area->in_list()) {\n+\t\tarea_call_queries_list.remove(p_area);\n+\t}\n+}\n+\n void JoltSpace3D::add_joint(JPH::Constraint *p_jolt_ref) {\n \tphysics_system->AddConstraint(p_jolt_ref);\n }\ndiff --git a/modules/jolt_physics/spaces/jolt_space_3d.h b/modules/jolt_physics/spaces/jolt_space_3d.h\nindex eb666644eae6..989df9a49853 100644\n--- a/modules/jolt_physics/spaces/jolt_space_3d.h\n+++ b/modules/jolt_physics/spaces/jolt_space_3d.h\n@@ -48,6 +48,7 @@\n #include <stdint.h>\n \n class JoltArea3D;\n+class JoltBody3D;\n class JoltContactListener3D;\n class JoltJoint3D;\n class JoltLayers;\n@@ -55,7 +56,8 @@ class JoltObject3D;\n class JoltPhysicsDirectSpaceState3D;\n \n class JoltSpace3D {\n-\tJoltBodyWriter3D body_accessor;\n+\tSelfList<JoltBody3D>::List body_call_queries_list;\n+\tSelfList<JoltArea3D>::List area_call_queries_list;\n \n \tRID rid;\n \n@@ -73,7 +75,6 @@ class JoltSpace3D {\n \n \tbool active = false;\n \tbool stepping = false;\n-\tbool has_stepped = false;\n \n \tvoid _pre_step(float p_step);\n \tvoid _post_step(float p_step);\n@@ -132,6 +133,11 @@ class JoltSpace3D {\n \n \tvoid try_optimize();\n \n+\tvoid enqueue_call_queries(SelfList<JoltBody3D> *p_body);\n+\tvoid enqueue_call_queries(SelfList<JoltArea3D> *p_area);\n+\tvoid dequeue_call_queries(SelfList<JoltBody3D> *p_body);\n+\tvoid dequeue_call_queries(SelfList<JoltArea3D> *p_area);\n+\n \tvoid add_joint(JPH::Constraint *p_jolt_ref);\n \tvoid add_joint(JoltJoint3D *p_joint);\n \tvoid remove_joint(JPH::Constraint *p_jolt_ref);\n", "test_patch": "", "problem_statement": "`RigidBody3D` frozen as kinematic doesn't always report contacts with Jolt Physics\n### Tested versions\n\nReproducible in: 4.4.dev [a7a2a12bfd1c34057f158f4510841bcc766a9348]\n\n### System information\n\nWindows 11 (10.0.26100)\n\n### Issue description\n\nThis is an issue introduced by #100533.\n\nIn short, a `RigidBody3D` frozen with `FREEZE_MODE_KINEMATIC` and `contact_monitor` enabled (along with a non-zero `max_contacts_reported`) is currently only able to report contacts when moving.\n\nThis differs from Godot Physics, where contacts are reported regardless if such a body is stationary or moving.\n\nThe reason for this is that #100533 made it so contacts are only reported for active/awake bodies. The problem with this is that kinematic bodies are only considered to be active/awake for the physics step after having moved, which meant that you'd have to be moving the kinematic body in order for contacts to be reported for it.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Run the main scene.\n- Note how no contact is reported in the Output window until the capsule starts moving.\n- Switch physics engine to `GodotPhysics3D`.\n- Note how contacts are reported right as the box falls on top of the capsule.\n\n### Minimal reproduction project (MRP)\n\n[jolt-kinematic-contacts.zip](https://github.com/user-attachments/files/18219118/jolt-kinematic-contacts.zip)\n`RigidBody3D` frozen as kinematic doesn't always report contacts with Jolt Physics\n### Tested versions\n\nReproducible in: 4.4.dev [a7a2a12bfd1c34057f158f4510841bcc766a9348]\n\n### System information\n\nWindows 11 (10.0.26100)\n\n### Issue description\n\nThis is an issue introduced by #100533.\n\nIn short, a `RigidBody3D` frozen with `FREEZE_MODE_KINEMATIC` and `contact_monitor` enabled (along with a non-zero `max_contacts_reported`) is currently only able to report contacts when moving.\n\nThis differs from Godot Physics, where contacts are reported regardless if such a body is stationary or moving.\n\nThe reason for this is that #100533 made it so contacts are only reported for active/awake bodies. The problem with this is that kinematic bodies are only considered to be active/awake for the physics step after having moved, which meant that you'd have to be moving the kinematic body in order for contacts to be reported for it.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Run the main scene.\n- Note how no contact is reported in the Output window until the capsule starts moving.\n- Switch physics engine to `GodotPhysics3D`.\n- Note how contacts are reported right as the box falls on top of the capsule.\n\n### Minimal reproduction project (MRP)\n\n[jolt-kinematic-contacts.zip](https://github.com/user-attachments/files/18219118/jolt-kinematic-contacts.zip)\n", "hints_text": "\n", "created_at": "2024-12-31 17:45:41", "merge_commit_sha": "1f2d535f78a323fdd7471053af2be3fcaeed4158", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100920", "base_commit": "efa144396d8003c4b3021bca8242ce5cda4d131f", "patch": "diff --git a/editor/export/editor_export_platform.cpp b/editor/export/editor_export_platform.cpp\nindex cb496fc9f09e..1cf47f348659 100644\n--- a/editor/export/editor_export_platform.cpp\n+++ b/editor/export/editor_export_platform.cpp\n@@ -35,6 +35,7 @@\n #include \"core/extension/gdextension.h\"\n #include \"core/io/file_access_encrypted.h\"\n #include \"core/io/file_access_pack.h\" // PACK_HEADER_MAGIC, PACK_FORMAT_VERSION\n+#include \"core/io/resource_uid.h\"\n #include \"core/io/zip_io.h\"\n #include \"core/version.h\"\n #include \"editor/editor_file_system.h\"\n@@ -925,8 +926,8 @@ Vector<String> EditorExportPlatform::get_forced_export_files() {\n \n \tfiles.push_back(ProjectSettings::get_singleton()->get_global_class_list_path());\n \n-\tString icon = GLOBAL_GET(\"application/config/icon\");\n-\tString splash = GLOBAL_GET(\"application/boot_splash/image\");\n+\tString icon = ResourceUID::ensure_path(GLOBAL_GET(\"application/config/icon\"));\n+\tString splash = ResourceUID::ensure_path(GLOBAL_GET(\"application/boot_splash/image\"));\n \tif (!icon.is_empty() && FileAccess::exists(icon)) {\n \t\tfiles.push_back(icon);\n \t}\n", "test_patch": "", "problem_statement": "Icon and splash screen raw files are not included in exported project\n### Tested versions\n\n- Reproducible in 4.4.dev5\n- Not reproducible in 4.4.dev4\nRegression from #97912\n\n### System information\n\nGodot v4.4.dev7 - Arch Linux #1 SMP PREEMPT_DYNAMIC Thu, 19 Dec 2024 21:29:01 +0000 on Wayland - X11 display driver, Single-window, 1 monitor - OpenGL 3 (Compatibility) - Mesa Intel(R) Graphics (ADL GT2) - 12th Gen Intel(R) Core(TM) i5-1235U (12 threads)\n\n### Issue description\n\nIcon and splash screen files are not included in export project due to saved as UIDs in ProjectSettings. Instead, file at path uid:/<someUIDhere> is exported, but it is ignored by engine, so icon and splash screen doesn't work.\n\n### Steps to reproduce\n\n1. Set custom icon and splash screen. They will be saved in ProjectSettings as UIDs.\n2. Export project.\n3. Run project. Notice default splash screen and icon.\n\n### Minimal reproduction project (MRP)\n\n[mrp.zip](https://github.com/user-attachments/files/18272161/mrp.zip)\n1. Run in editor. Everything works.\n2. Export and run. Icon and splash don't work.\n\n", "hints_text": "", "created_at": "2024-12-30 05:25:10", "merge_commit_sha": "1022c6b9074472d5be457c8c93caf8846a4f96fb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100916", "base_commit": "efa144396d8003c4b3021bca8242ce5cda4d131f", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 9d14e702be41..03c2f2067e9c 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -296,6 +296,7 @@ void EmbeddedProcess::_check_focused_process_id() {\n \t\tfocused_process_id = process_id;\n \t\tif (focused_process_id == current_process_id) {\n \t\t\t// The embedded process got the focus.\n+\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n \t\t\tif (has_focus()) {\n \t\t\t\t// Redraw to updated the focus style.\n \t\t\t\tqueue_redraw();\n@@ -312,6 +313,7 @@ void EmbeddedProcess::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"embedding_completed\"));\n \tADD_SIGNAL(MethodInfo(\"embedding_failed\"));\n \tADD_SIGNAL(MethodInfo(\"embedded_process_updated\"));\n+\tADD_SIGNAL(MethodInfo(\"embedded_process_focused\"));\n }\n \n EmbeddedProcess::EmbeddedProcess() {\ndiff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex f7e58258d425..d611f0a773cf 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -260,6 +260,12 @@ void GameView::_embedded_process_updated() {\n \tgame_size_label->set_text(vformat(\"%dx%d\", game_rect.size.x, game_rect.size.y));\n }\n \n+void GameView::_embedded_process_focused() {\n+\tif (embed_on_play && !window_wrapper->get_window_enabled()) {\n+\t\tEditorNode::get_singleton()->get_editor_main_screen()->select(EditorMainScreen::EDITOR_GAME);\n+\t}\n+}\n+\n void GameView::_project_settings_changed() {\n \t// Update the window size and aspect ratio.\n \t_update_embed_window_size();\n@@ -730,6 +736,7 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tembedded_process->connect(\"embedding_failed\", callable_mp(this, &GameView::_embedding_failed));\n \tembedded_process->connect(\"embedding_completed\", callable_mp(this, &GameView::_embedding_completed));\n \tembedded_process->connect(\"embedded_process_updated\", callable_mp(this, &GameView::_embedded_process_updated));\n+\tembedded_process->connect(\"embedded_process_focused\", callable_mp(this, &GameView::_embedded_process_focused));\n \tembedded_process->set_custom_minimum_size(Size2i(100, 100));\n \n \tstate_label = memnew(Label());\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6568f07b746c..64d679657c33 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -143,6 +143,7 @@ class GameView : public VBoxContainer {\n \tvoid _embedding_completed();\n \tvoid _embedding_failed();\n \tvoid _embedded_process_updated();\n+\tvoid _embedded_process_focused();\n \tvoid _project_settings_changed();\n \n \tvoid _update_ui();\n", "test_patch": "", "problem_statement": "Debugging embedded game does not refocus on continue\n### Tested versions\n\nGodot v4.4.dev (99a8ab795)\n\n### System information\n\nGodot v4.4.dev (99a8ab795) - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Laptop GPU (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 5800H with Radeon Graphics (16 threads)\n\n### Issue description\n\nWhen the game is embedded without the floating window, after hitting a breakpoint in the script editor, when I pressed Continue, the game tab is not refocused and Godot enters a wierd state where the editor is not focused, the game is probably focused but not visible.\n\n### Steps to reproduce\n\n- In the Game Workspace, enabled Embed and disable Floating Window\n- Attach a script and add a breakpoint anywhere\n- Start the game\n- Hit the breakpoint\n- Press Continue\n\nhttps://github.com/user-attachments/assets/fe304f67-773d-4948-9ec7-790e06b28db6\n\n\n### Minimal reproduction project (MRP)\n\n[test-godot-focus-debugging.zip](https://github.com/user-attachments/files/18269775/test-godot-focus-debugging.zip)\n\n", "hints_text": "", "created_at": "2024-12-29 23:19:19", "merge_commit_sha": "9ec36eb243a9df1ad83bc867b007d0159c299363", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100913", "base_commit": "9630d4e2fc1d0fdef6f46f24e236548549f31d49", "patch": "diff --git a/doc/classes/TextEdit.xml b/doc/classes/TextEdit.xml\nindex 89e2a2017af1..826a491888df 100644\n--- a/doc/classes/TextEdit.xml\n+++ b/doc/classes/TextEdit.xml\n@@ -349,9 +349,12 @@\n \t\t<method name=\"get_line_column_at_pos\" qualifiers=\"const\">\n \t\t\t<return type=\"Vector2i\" />\n \t\t\t<param index=\"0\" name=\"position\" type=\"Vector2i\" />\n-\t\t\t<param index=\"1\" name=\"allow_out_of_bounds\" type=\"bool\" default=\"true\" />\n+\t\t\t<param index=\"1\" name=\"clamp_line\" type=\"bool\" default=\"true\" />\n+\t\t\t<param index=\"2\" name=\"clamp_column\" type=\"bool\" default=\"true\" />\n \t\t\t<description>\n-\t\t\t\tReturns the line and column at the given position. In the returned vector, [code]x[/code] is the column, [code]y[/code] is the line. If [param allow_out_of_bounds] is [code]false[/code] and the position is not over the text, both vector values will be set to [code]-1[/code].\n+\t\t\t\tReturns the line and column at the given position. In the returned vector, [code]x[/code] is the column and [code]y[/code] is the line.\n+\t\t\t\tIf [param clamp_line] is [code]false[/code] and [param position] is below the last line, [code]Vector2i(-1, -1)[/code] is returned.\n+\t\t\t\tIf [param clamp_column] is [code]false[/code] and [param position] is outside the column range of the line, [code]Vector2i(-1, -1)[/code] is returned.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"get_line_count\" qualifiers=\"const\">\ndiff --git a/misc/extension_api_validation/4.3-stable.expected b/misc/extension_api_validation/4.3-stable.expected\nindex 7b5889f464b9..9c96811f875f 100644\n--- a/misc/extension_api_validation/4.3-stable.expected\n+++ b/misc/extension_api_validation/4.3-stable.expected\n@@ -309,3 +309,10 @@ Validate extension JSON: API was removed: classes/EditorSceneFormatImporter/meth\n \n This virtual method, and the internal public `get_import_flags`, were never used by the engine, since it was open sourced.\n So we're removing it despite the compat breakage as there's no way for users to rely on this affecting engine behavior.\n+\n+\n+GH-100913\n+---------\n+Validate extension JSON: Error: Field 'classes/TextEdit/methods/get_line_column_at_pos/arguments': size changed value in new API, from 2 to 3.\n+\n+Added optional argument to disallow positions that are outside the column range of the line. Compatibility method registered.\ndiff --git a/scene/gui/code_edit.cpp b/scene/gui/code_edit.cpp\nindex 7f8b4dca7862..be8b6f075d9c 100644\n--- a/scene/gui/code_edit.cpp\n+++ b/scene/gui/code_edit.cpp\n@@ -421,7 +421,7 @@ void CodeEdit::gui_input(const Ref<InputEvent> &p_gui_input) {\n \t\t\t\t\t\tmpos.x = get_size().x - mpos.x;\n \t\t\t\t\t}\n \n-\t\t\t\t\tPoint2i pos = get_line_column_at_pos(mpos, false);\n+\t\t\t\t\tPoint2i pos = get_line_column_at_pos(mpos, false, false);\n \t\t\t\t\tint line = pos.y;\n \t\t\t\t\tint col = pos.x;\n \n@@ -443,18 +443,18 @@ void CodeEdit::gui_input(const Ref<InputEvent> &p_gui_input) {\n \n \t\tif (symbol_lookup_on_click_enabled) {\n \t\t\tif (mm->is_command_or_control_pressed() && mm->get_button_mask().is_empty()) {\n-\t\t\t\tsymbol_lookup_pos = get_line_column_at_pos(mpos);\n+\t\t\t\tsymbol_lookup_pos = get_line_column_at_pos(mpos, false, false);\n \t\t\t\tsymbol_lookup_new_word = get_word_at_pos(mpos);\n \t\t\t\tif (symbol_lookup_new_word != symbol_lookup_word) {\n \t\t\t\t\temit_signal(SNAME(\"symbol_validate\"), symbol_lookup_new_word);\n \t\t\t\t}\n-\t\t\t} else if (!mm->is_command_or_control_pressed() || (!mm->get_button_mask().is_empty() && symbol_lookup_pos != get_line_column_at_pos(mpos))) {\n+\t\t\t} else if (!mm->is_command_or_control_pressed() || (!mm->get_button_mask().is_empty() && symbol_lookup_pos != get_line_column_at_pos(mpos, false, false))) {\n \t\t\t\tset_symbol_lookup_word_as_valid(false);\n \t\t\t}\n \t\t}\n \n \t\tif (symbol_tooltip_on_hover_enabled) {\n-\t\t\tsymbol_tooltip_pos = get_line_column_at_pos(mpos, false);\n+\t\t\tsymbol_tooltip_pos = get_line_column_at_pos(mpos, false, false);\n \t\t\tsymbol_tooltip_word = get_word_at_pos(mpos);\n \t\t\tsymbol_tooltip_timer->start();\n \t\t}\n@@ -2388,7 +2388,7 @@ bool CodeEdit::is_symbol_lookup_on_click_enabled() const {\n \n String CodeEdit::get_text_for_symbol_lookup() const {\n \tPoint2i mp = get_local_mouse_pos();\n-\tPoint2i pos = get_line_column_at_pos(mp, false);\n+\tPoint2i pos = get_line_column_at_pos(mp, false, false);\n \tint line = pos.y;\n \tint col = pos.x;\n \ndiff --git a/scene/gui/text_edit.compat.inc b/scene/gui/text_edit.compat.inc\nindex bf73229868ef..d15740390e9d 100644\n--- a/scene/gui/text_edit.compat.inc\n+++ b/scene/gui/text_edit.compat.inc\n@@ -34,8 +34,13 @@ void TextEdit::_set_selection_mode_compat_86978(SelectionMode p_mode, int p_line\n \tset_selection_mode(p_mode);\n }\n \n+Point2i TextEdit::_get_line_column_at_pos_bind_compat_100913(const Point2i &p_pos, bool p_allow_out_of_bounds) const {\n+\treturn get_line_column_at_pos(p_pos, p_allow_out_of_bounds, true);\n+}\n+\n void TextEdit::_bind_compatibility_methods() {\n \tClassDB::bind_compatibility_method(D_METHOD(\"set_selection_mode\", \"mode\", \"line\", \"column\", \"caret_index\"), &TextEdit::_set_selection_mode_compat_86978, DEFVAL(-1), DEFVAL(-1), DEFVAL(0));\n+\tClassDB::bind_compatibility_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"allow_out_of_bounds\"), &TextEdit::_get_line_column_at_pos_bind_compat_100913, DEFVAL(true));\n }\n \n #endif\ndiff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex addbff1e979a..b707a5a93342 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -4397,9 +4397,12 @@ Point2 TextEdit::get_local_mouse_pos() const {\n }\n \n String TextEdit::get_word_at_pos(const Vector2 &p_pos) const {\n-\tPoint2i pos = get_line_column_at_pos(p_pos);\n+\tPoint2i pos = get_line_column_at_pos(p_pos, false, false);\n \tint row = pos.y;\n \tint col = pos.x;\n+\tif (row < 0 || col < 0) {\n+\t\treturn \"\";\n+\t}\n \n \tString s = text[row];\n \tif (s.length() == 0) {\n@@ -4435,7 +4438,7 @@ String TextEdit::get_word_at_pos(const Vector2 &p_pos) const {\n \treturn String();\n }\n \n-Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_of_bounds) const {\n+Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_clamp_line, bool p_clamp_column) const {\n \tfloat rows = p_pos.y - theme_cache.style_normal->get_margin(SIDE_TOP);\n \tif (!editable) {\n \t\trows -= theme_cache.style_readonly->get_offset().y / 2;\n@@ -4462,10 +4465,10 @@ Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_\n \n \tint visible_lines = get_visible_line_count_in_range(first_vis_line, row);\n \tif (rows > visible_lines) {\n-\t\tif (!p_allow_out_of_bounds) {\n-\t\t\treturn Point2i(-1, -1);\n+\t\tif (p_clamp_line) {\n+\t\t\treturn Point2i(text[row].length(), row);\n \t\t}\n-\t\treturn Point2i(text[row].length(), row);\n+\t\treturn Point2i(-1, -1);\n \t}\n \n \tint colx = p_pos.x - (theme_cache.style_normal->get_margin(SIDE_LEFT) + gutters_width + gutter_padding);\n@@ -4482,6 +4485,11 @@ Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_\n \t} else {\n \t\tcolx -= wrap_indent;\n \t}\n+\n+\tif (!p_clamp_column && (colx < 0 || colx > TS->shaped_text_get_size(text_rid).x)) {\n+\t\treturn Point2i(-1, -1);\n+\t}\n+\n \tint col = TS->shaped_text_hit_test_position(text_rid, colx);\n \tif (!caret_mid_grapheme_enabled) {\n \t\tcol = TS->shaped_text_closest_character_pos(text_rid, col);\n@@ -6740,7 +6748,7 @@ void TextEdit::_bind_methods() {\n \n \tClassDB::bind_method(D_METHOD(\"get_word_at_pos\", \"position\"), &TextEdit::get_word_at_pos);\n \n-\tClassDB::bind_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"allow_out_of_bounds\"), &TextEdit::get_line_column_at_pos, DEFVAL(true));\n+\tClassDB::bind_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"clamp_line\", \"clamp_column\"), &TextEdit::get_line_column_at_pos, DEFVAL(true), DEFVAL(true));\n \tClassDB::bind_method(D_METHOD(\"get_pos_at_line_column\", \"line\", \"column\"), &TextEdit::get_pos_at_line_column);\n \tClassDB::bind_method(D_METHOD(\"get_rect_at_line_column\", \"line\", \"column\"), &TextEdit::get_rect_at_line_column);\n \ndiff --git a/scene/gui/text_edit.h b/scene/gui/text_edit.h\nindex ef5110963023..8609b86eccf0 100644\n--- a/scene/gui/text_edit.h\n+++ b/scene/gui/text_edit.h\n@@ -658,6 +658,7 @@ class TextEdit : public Control {\n \n #ifndef DISABLE_DEPRECATED\n \tvoid _set_selection_mode_compat_86978(SelectionMode p_mode, int p_line = -1, int p_column = -1, int p_caret = 0);\n+\tPoint2i _get_line_column_at_pos_bind_compat_100913(const Point2i &p_pos, bool p_allow_out_of_bounds = true) const;\n \tstatic void _bind_compatibility_methods();\n #endif // DISABLE_DEPRECATED\n \n@@ -860,7 +861,7 @@ class TextEdit : public Control {\n \n \tString get_word_at_pos(const Vector2 &p_pos) const;\n \n-\tPoint2i get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_of_bounds = true) const;\n+\tPoint2i get_line_column_at_pos(const Point2i &p_pos, bool p_clamp_line = true, bool p_clamp_column = true) const;\n \tPoint2i get_pos_at_line_column(int p_line, int p_column) const;\n \tRect2i get_rect_at_line_column(int p_line, int p_column) const;\n \n", "test_patch": "", "problem_statement": "Documentation tooltip trigger area includes end-of-line and whitespace surrounding a symbol\n### Tested versions\n\nv4.4.dev7.official [46c8f8c5c]\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - Intel(R) Iris(R) Xe Graphics (Intel Corporation; 32.0.101.5768) - 11th Gen Intel(R) Core(TM) i7-1185G7 @ 3.00GHz (8 threads)\n\n### Issue description\n\nThe symbol info / documentation tooltips (#91060) are triggered by hovering in the empty space at the end of a line or the whitespace surrounding a symbol.\n\nhttps://github.com/user-attachments/assets/d15df433-edad-4044-8bb5-b02c89c869ec\n\n\n### Steps to reproduce\n\nStop the mouse cursor in the space surrounding a hoverable symbol.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2024-12-29 19:50:20", "merge_commit_sha": "e87f4f67b0c1cde93b3a282a8e5815f51a7a9865", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100860", "base_commit": "99a8ab795d65e816ea7c452aa0fb55d02385c048", "patch": "diff --git a/scene/gui/spin_box.cpp b/scene/gui/spin_box.cpp\nindex ffe6e2bb9785..e76170623955 100644\n--- a/scene/gui/spin_box.cpp\n+++ b/scene/gui/spin_box.cpp\n@@ -40,7 +40,7 @@ Size2 SpinBox::get_minimum_size() const {\n \treturn ms;\n }\n \n-void SpinBox::_update_text(bool p_keep_line_edit) {\n+void SpinBox::_update_text(bool p_only_update_if_value_changed) {\n \tdouble step = get_step();\n \tif (use_custom_arrow_step && custom_arrow_step != 0.0) {\n \t\tstep = custom_arrow_step;\n@@ -50,6 +50,11 @@ void SpinBox::_update_text(bool p_keep_line_edit) {\n \t\tvalue = TS->format_number(value);\n \t}\n \n+\tif (p_only_update_if_value_changed && value == last_text_value) {\n+\t\treturn;\n+\t}\n+\tlast_text_value = value;\n+\n \tif (!line_edit->is_editing()) {\n \t\tif (!prefix.is_empty()) {\n \t\t\tvalue = prefix + \" \" + value;\n@@ -58,17 +63,12 @@ void SpinBox::_update_text(bool p_keep_line_edit) {\n \t\t\tvalue += \" \" + suffix;\n \t\t}\n \t}\n-\n-\tif (p_keep_line_edit && value == last_updated_text && value != line_edit->get_text()) {\n-\t\treturn;\n-\t}\n-\n \tline_edit->set_text_with_selection(value);\n-\tlast_updated_text = value;\n }\n \n void SpinBox::_text_submitted(const String &p_string) {\n \tif (p_string.is_empty()) {\n+\t\t_update_text();\n \t\treturn;\n \t}\n \n@@ -288,14 +288,12 @@ void SpinBox::_line_edit_editing_toggled(bool p_toggled_on) {\n \t\t\tline_edit->select_all();\n \t\t}\n \t} else {\n-\t\t// Discontinue because the focus_exit was caused by canceling or the text is empty.\n \t\tif (Input::get_singleton()->is_action_pressed(\"ui_cancel\") || line_edit->get_text().is_empty()) {\n-\t\t\t_update_text();\n-\t\t\treturn;\n+\t\t\t_update_text(); // Revert text if editing was canceled.\n+\t\t} else {\n+\t\t\t_update_text(true); // Update text in case value was changed this frame (e.g. on `focus_exited`).\n+\t\t\t_text_submitted(line_edit->get_text());\n \t\t}\n-\n-\t\tline_edit->deselect();\n-\t\t_text_submitted(line_edit->get_text());\n \t}\n }\n \ndiff --git a/scene/gui/spin_box.h b/scene/gui/spin_box.h\nindex 564294649c94..79076d3f4692 100644\n--- a/scene/gui/spin_box.h\n+++ b/scene/gui/spin_box.h\n@@ -58,13 +58,13 @@ class SpinBox : public Range {\n \tvoid _range_click_timeout();\n \tvoid _release_mouse_from_drag_mode();\n \n-\tvoid _update_text(bool p_keep_line_edit = false);\n+\tvoid _update_text(bool p_only_update_if_value_changed = false);\n \tvoid _text_submitted(const String &p_string);\n \tvoid _text_changed(const String &p_string);\n \n \tString prefix;\n \tString suffix;\n-\tString last_updated_text;\n+\tString last_text_value;\n \tdouble custom_arrow_step = 0.0;\n \tbool use_custom_arrow_step = false;\n \n", "test_patch": "", "problem_statement": "Setting SpinBox value with signal gets overwritten by the LineEdit's text value when the LineEdit is about to lose focus.\n### Tested versions\n\n- Reproducible in v4.4.dev7.official [46c8f8c5c]\n- Reproducible in v4.3.stable.official [77dcf97d8]\n- Reproducible in v4.2.2.stable.official [15073afe3]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.19045 - GLES3 (Compatibility) - NVIDIA GeForce GTX 750 Ti (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i5-6400 CPU @ 2.70GHz (4 Threads)\n\n### Issue description\n\nWhen setting a SpinBox value with a signal **when the SpinBox's LineEdit still has focus** and is about to lose focus the value is first set correctly but then is set again to the LineEdit's displayed value. If the value is set with `set_value_no_signal` to prevent emmiting a signal, the SpinBox will emit the `value_changed` signal with the incorrect value.\n\nhttps://github.com/user-attachments/assets/32618d3e-910a-418e-b913-0fc2db197b9d\n\n\n### Steps to reproduce\n\nUsing the MRP:\n\n1. Click on the SpinBox's LineEdit.\n2. Click on the LineEdit next to it (Or any other node. This is just so that the SpinBox loses focus)\n3. The value will be set correctly (and a signal emmited depending on what method to set the value was used)\n4. The value will then be set to whatever the SpinBox's LineEdit is displaying instead of the set value and a signal will be emmited.\n\nThe MRP has prints to inform of the values the moment before and after they are set.\n\nI've seen that the issue only occours if the value is set right before the SpinBox loses focus.\n\nThe issue is prevented if you ALSO set the SpinBox's value to its TextBox:\n`spin_box.get_line_edit().text = str(spin_box.value)`\n\n### Minimal reproduction project (MRP)\n\n[debugging.zip](https://github.com/user-attachments/files/18256719/debugging.zip)\n\n", "hints_text": "", "created_at": "2024-12-27 21:19:46", "merge_commit_sha": "2850b7113c7de26c79a3d86acf7595713a6d71e5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100792", "base_commit": "0f95e9f8e665cedaa5aace5f6f86de2b4b5a8c60", "patch": "diff --git a/doc/classes/EditorScenePostImportPlugin.xml b/doc/classes/EditorScenePostImportPlugin.xml\nindex 0004ec65c646..ddcbb757ad32 100644\n--- a/doc/classes/EditorScenePostImportPlugin.xml\n+++ b/doc/classes/EditorScenePostImportPlugin.xml\n@@ -71,6 +71,7 @@\n \t\t\t<param index=\"0\" name=\"scene\" type=\"Node\" />\n \t\t\t<description>\n \t\t\t\tPre Process the scene. This function is called right after the scene format loader loaded the scene and no changes have been made.\n+\t\t\t\tPre process may be used to adjust internal import options in the [code]\"nodes\"[/code], [code]\"meshes\"[/code], [code]\"animations\"[/code] or [code]\"materials\"[/code] keys inside [code]get_option_value(\"_subresources\")[/code].\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"add_import_option\">\ndiff --git a/editor/import/3d/resource_importer_scene.cpp b/editor/import/3d/resource_importer_scene.cpp\nindex 695c12150df3..fe9e58014197 100644\n--- a/editor/import/3d/resource_importer_scene.cpp\n+++ b/editor/import/3d/resource_importer_scene.cpp\n@@ -2934,38 +2934,22 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \n \tDictionary subresources = p_options[\"_subresources\"];\n \n-\tDictionary node_data;\n-\tif (subresources.has(\"nodes\")) {\n-\t\tnode_data = subresources[\"nodes\"];\n-\t}\n-\n-\tDictionary material_data;\n-\tif (subresources.has(\"materials\")) {\n-\t\tmaterial_data = subresources[\"materials\"];\n-\t}\n-\n-\tDictionary animation_data;\n-\tif (subresources.has(\"animations\")) {\n-\t\tanimation_data = subresources[\"animations\"];\n-\t}\n-\n-\tDictionary mesh_data;\n-\tif (subresources.has(\"meshes\")) {\n-\t\tmesh_data = subresources[\"meshes\"];\n-\t}\n-\n \tError err = OK;\n \n \t// Check whether any of the meshes or animations have nonexistent save paths\n \t// and if they do, fail the import immediately.\n-\terr = _check_resource_save_paths(mesh_data);\n-\tif (err != OK) {\n-\t\treturn err;\n+\tif (subresources.has(\"meshes\")) {\n+\t\terr = _check_resource_save_paths(subresources[\"meshes\"]);\n+\t\tif (err != OK) {\n+\t\t\treturn err;\n+\t\t}\n \t}\n \n-\terr = _check_resource_save_paths(animation_data);\n-\tif (err != OK) {\n-\t\treturn err;\n+\tif (subresources.has(\"animations\")) {\n+\t\terr = _check_resource_save_paths(subresources[\"animations\"]);\n+\t\tif (err != OK) {\n+\t\t\treturn err;\n+\t\t}\n \t}\n \n \tList<String> missing_deps; // for now, not much will be done with this\n@@ -3005,6 +2989,27 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \t\tpost_importer_plugins.write[i]->pre_process(scene, p_options);\n \t}\n \n+\t// data in _subresources may be modified by pre_process(), so wait until now to check.\n+\tDictionary node_data;\n+\tif (subresources.has(\"nodes\")) {\n+\t\tnode_data = subresources[\"nodes\"];\n+\t}\n+\n+\tDictionary material_data;\n+\tif (subresources.has(\"materials\")) {\n+\t\tmaterial_data = subresources[\"materials\"];\n+\t}\n+\n+\tDictionary animation_data;\n+\tif (subresources.has(\"animations\")) {\n+\t\tanimation_data = subresources[\"animations\"];\n+\t}\n+\n+\tDictionary mesh_data;\n+\tif (subresources.has(\"meshes\")) {\n+\t\tmesh_data = subresources[\"meshes\"];\n+\t}\n+\n \tfloat fps = 30;\n \tif (p_options.has(SNAME(\"animation/fps\"))) {\n \t\tfps = (float)p_options[SNAME(\"animation/fps\")];\n", "test_patch": "", "problem_statement": "Unable to assign Skeleton with Import Script\n### Tested versions\r\n\r\n- Reproducible in all 4.x versions.\r\n\r\n### System information\r\n\r\nGodot v4.3.rc3.mono - Linux Mint 22 (Wilma) - X11 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4060 Ti (nvidia; 535.183.01) - AMD Ryzen 7 5700X 8-Core Processor (16 Threads)\r\n\r\n### Issue description\r\n\r\nThe ConfigFile class set_value method erases key/value pair when value is set to null (this is per class docs for ConfigFile.set_value). However, some files such as .glb.import files have required keys stored with explicit values for some options.\r\n\r\nThere is already the method erase_section() and erase_section_key(), and we need the ability to write null values to key/value pairs.\r\n\r\nExample for when we need to be able to write an explicit null:\r\n```\r\n[params]\r\n\r\n{_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"rest_pose/external_animation_library\": null,\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nIf this value is not set, then the entire PATH:Armature/Skeleton3D node is over written by the engine on the next import.\r\nThus an entry to set skeleton  ex. {\"nodes\" : {\"PATH:Armature/Skeleton3D\": {\"retarget/bone_map\": Resource(\"res://bone_map.tres\")}}} will also be erased and unset.\r\n\r\nTo justification that a change is needed:\r\n\r\nIf one copies and pastes a correct but partial entry, the editor will erase the incomplete entry upon next import...example:\r\n```\r\n_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nbecomes:\r\n`_subresources={}`\r\n\r\n\r\n\r\n\r\nIf one copies and pastes the complete correct node entry with the required null value, the editor is fine.  example:\r\n```\r\n_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"rest_pose/external_animation_library\": null,\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nTherefore one must conclude that the Class used to read and write configuration files such as .import files, should be able to write key/value pairs that include explicit null values.\r\n\r\nThere is already the method erase_section() and erase_section_key(), and we need the ability to write null values to key/value pairs.\r\n\r\n### Steps to reproduce\r\n\r\n\r\n```\r\n@tool # Needed so it runs in editor.\r\nextends EditorScenePostImport\r\n\r\nvar config = ConfigFile.new()\r\n\r\nfunc _post_import(scene):\r\n\tset_skeleton()\r\n\r\nfunc set_skeleton() -> void:\r\n\tvar bone_map : BoneMap = load(\"res://explosive_bone_map.tres\")\r\n\tconfig.load(\"res://relax.glb.import\")\r\n\tvar rest_pose_node : Dictionary\r\n\trest_pose_node = {\"nodes\" : {\"PATH:Armature/Skeleton3D\": {\"rest_post/external_animation_library\": null}}}\r\n\tconfig.set_value(\"params\", \"_subresources\", rest_pose_node)\r\n\tconfig.save(\"res://relax.glb.import\")\r\n\r\n```\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[Animation Test.zip](https://github.com/user-attachments/files/16593811/Animation.Test.zip)\r\n\r\nEDIT: I said FBX by mistake up above, I corrected that to GLB....I am not sure if that's important or not...I would expect the import file behavior to be the same for either.\n", "hints_text": "The FBX code should be changed instead to accept a missing `rest_pose/external_animation_library`.\r\n\r\nChanging the way ConfigFile behaves would break compat.\n@lyuma Could look into this.\nSo there are two things going on here:\r\n\r\nOne is that there's a stray null in the .import file. I have a PR which should fix this, but the null doesn't do anything and so this is a purely cosmetic fix: I don't think this issue is a release blocker.\r\n\r\nThe second problem relates to the discussion from #95413, where I advised use of ConfigFile (typoed as ConfigMap) for modifying the .import file. The issue is that the config file likely will be overwritten after the import finishes, and hence it is not possible to modify the .import from within a PostImport script (or PostImportPlugin) in the way the MRP is doing.\r\n\r\nUnfortunately I'm not aware of a clean way to do what that MRP is trying to do. In my code, I run a script which modifies the .import files specifically when an import is not currently happening, then trigger a reimport after. There's definitely a big API gap here.\r\n\r\nI don't have a suggestion on how to fix the MRP to work correctly, but the closest thing I can think to suggest is run the code outside the import (perhaps in a call_deferred) and then run reimport_files on EditorFileSystem. Make sure to avoid an infinite loop, since the reimport_files will run the script again.\nThank you Lyuma.\r\n\r\nyeah, ok....doing it outside of the import process kind of defeats the point. I was trying to automate all necessary configurations and modifications to an animation library during the import process because this stuff gets written to the res file in the .godot/import folder, the setting the bones up was the last piece of this particular puzzle to fully automate it.\r\n\r\nEDIT: Another thought, I wonder if I could run a tool script that will set the import script up prior to import? Then I could just trigger an import and the skeleton could already be in place before that happens.\r\n\r\nEDIT2: OK, that checks out ... I replicated that workflow manually by cutting the import script configuration item and the _subresources configuration with an external text editor, saving the file, then letting godot reimport and resetting those 2 settings back to default. Then, I pasted those lines back in to the file from the external text editor, saved the file, and triggered another import....Godot set the skeleton and ran the import script with intended results.\r\n\r\nVery kludgy, but it works for now, so thanks\r\n\n> doing it outside of the import process kind of defeats the point\r\n\r\nYeah I agree the usecase of changing settings during import makes sense. I'll try and see if there's a way we can improve the APIs in 4.4 to account for this. Though either way, `EditorScenePostImport` is too late because it literally is the last thing that runs.... so the way your script was written still would have to be changed.\r\n\r\nIn my opinion, `EditorScenePostImportPlugin`, and other such plugins that happen earlier in the import flow, would ideally have a way to adjust import options on the fly without doing a reimport. This is something I hope to make possible in 4.4\n> > doing it outside of the import process kind of defeats the point\r\n> \r\n> Yeah I agree the usecase of changing settings during import makes sense. I'll try and see if there's a way we can improve the APIs in 4.4 to account for this. Though either way, `EditorScenePostImport` is too late because it literally is the last thing that runs.... so the way your script was written still would have to be changed.\r\n> \r\n> In my opinion, `EditorScenePostImportPlugin`, and other such plugins that happen earlier in the import flow, would ideally have a way to adjust import options on the fly without doing a reimport. This is something I hope to make possible in 4.4\r\n\r\nHi Lyuma,\r\nHave you had a chance to look into this? I don't see anything in the PRs that addresses it, but maybe I am just missing it. I am still hoping to fully automate this process so I am not doing it by hand 1600+ times.\r\n\r\nThanks,\r\nScot\r\n\n> > This is something I hope to make possible in 4.4\n> \nBeen fighting with stress and I haven't gotten anywhere near progressing on my ambitious priorities that I put down for 4.4 (I work on Godot as a volunteer).\n\nIf you want to increase the chance that I make this before the 4.4 feature freeze, could you propose some ideas for your dream API to change .import options during import? Like an extra function in post import plugin? Having some direction would help me focus.\n> > This is something I hope to make possible in 4.4\r\n> Been fighting with stress and I haven't gotten anywhere near progressing on my ambitious priorities that I put down for 4.4 (I work on Godot as a volunteer). If you want to increase the chance that I make this before the 4.4 feature freeze, could you propose some ideas for your dream API to change .import options during import? Like an extra function in post import plugin? Having some direction would help me focus.\r\n\r\nLyuma, sorry you are dealing with stress. That really sucks, thank you for what you are able to accomplish. Being the lead dev (whether in name or action) on a section of the engine I am sure has a cost to you.\r\n\r\nReally the most important thing to me is the ability to assign a skeleton from script. The way it is now, I have to manually import the asset (model or animation), assign the skeleton through the UI, reimport, and THEN assign the import script and reimport again.\r\n\r\nBest case be ability to import through script only\r\n\r\nBUT \r\n\r\nIt would already be much better if I could simply assign the skeleton within the script so I don't have so many manual operations per asset (i.e. import, assign script, reimport  (3 ops) vs.  import, open, assign skeleton, reimport, assign script, reimport (6 ops). That alone would cut the work of importing thousands of assets in half.\r\n\r\nThank you for all the hard work you do. \nFrom reading the Godot code, I did find out that you can actually call `get_option_value()` from the `_pre_process` method of EditorScenePostImportPlugin with the argument `_subresources`, and that will return a Dictionary which allows you to modify settings such as the BoneMap of the Armature/Skeleton3D node, without actually needing to modify .import before import. If it were better documented, I think this is pretty reasonable solution.\n\nYou do need to be careful of course when modifying such settings, and having the user go through this instead of having a convenient API will reduce the chance that someone does this unintentionally and makes a mistake, so I would be curious if this gets you unstuck.\n\nThat said, I came here to see if I could improve Godot's APIs.\n\nSo the two things I'm trying to decide between are:\n\n1. To make the options dict mutable (the EditorFileSystem code actually writes the .import file afterwards, so there's no technical reason that it needs to be passed as `const` to the importers.\n\nI do worry there is more of a stylistic reason not to do this: it feels a bit late to modify import options, while the file is already in the process of being imported, particularly the global options since many of them take effect before even the `pre_process` method of `EditorScenePostImportPlugin`. So making it too easy for users to accidentally edit the import options (if the options dictionary is mutable), could lead to inadvertent corruption of the .import settings. It also means we could get into conflicts between plugins since the order things get modified might matter. It just doesn't feel good to rush this into 4.4\n\n2. Add a callback in EditorFileSystem before import, but after assigning the default project settings, so the import settings can be changed. The problem is, I don't think this helps your situation. I think the `_pre_process` is the perfect place to do this, since then you have access to the Node tree and you know which node is the skeleton and so on.\n\nBut if you want to set a setting like `nodes/import_as_skeleton_bones` (which is often useful when importing animation files, for example), that cannot be done from a post-import plugin, since that option is consumed by the GLTF import code. For this type of option, the ability to adjust import settings from EditorFileSystem might be helpful. The main problem I have here is it might imply building a whole plugin system, for a relatively niche usecase: the desired settings are not the default, but you only know the filename and nothing else, how would it know what settings to write to the .import file before the import begins, without knowing more context about the file.\n\nAnyway, maybe I'm just making an excuse to not work on this API for 4.4. But I am really curious if the EditorScenePostImportPlugin idea I had with _subresources works for you, since that would solve most of the problems:\n\n```gd\nextends EditorScenePostImportPlugin\n\nfunc _pre_process(scene: Node):\n\tsubresources = get_option_value(\"_subresources\")\n\tif not subresources.has(\"nodes\"):\n\t\tsubresources[\"nodes\"] = {}\n\n\tvar bone_map : BoneMap = load(\"res://explosive_bone_map.tres\")\n\n\t# Possibly do some recursive search on scene to determine the actual Skeleton3D node. Sometimes it is not inside Armature.\n\tnode_path = \"Armature/Skeleton3D\"\n\tif not subresources[\"nodes\"].has(\"PATH:\" + node_path):\n\t\tsubresources[\"nodes\"][\"PATH:\" + node_path] = {}\n\t\t# Set it in the if statement to allow the user to override after the first import.\n\t\tsubresources[\"nodes\"][\"PATH:\" + node_path][\"retarget/bone_map\"] = bone_map\n```\n\nOoh I think I see the problem... resource_importer_scene.cpp pre-caches the nodes dictionary and fails if it was not assigned to begin with...\n```cpp\n\tDictionary subresources = p_options[\"_subresources\"];\n\n\tDictionary node_data;\n\tif (subresources.has(\"nodes\")) {\n\t\tnode_data = subresources[\"nodes\"];\n\t}\n\n\tDictionary material_data;\n\tif (subresources.has(\"materials\")) {\n\t\tmaterial_data = subresources[\"materials\"];\n\t}\n\n\tDictionary animation_data;\n\tif (subresources.has(\"animations\")) {\n\t\tanimation_data = subresources[\"animations\"];\n\t}\n\n\tDictionary mesh_data;\n\tif (subresources.has(\"meshes\")) {\n\t\tmesh_data = subresources[\"meshes\"];\n\t}\n```\nI think we should simply move these if statements after the _pre_process function, and that's something I should be able to change for Godot 4.4", "created_at": "2024-12-24 15:38:27", "merge_commit_sha": "a7d84fa022334da4e198affc0fe3cd79e8becce5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100786", "base_commit": "fdbf6ecc9f06d665f1dc4a5e3867a54d91ae7f0f", "patch": "diff --git a/editor/import/3d/resource_importer_scene.cpp b/editor/import/3d/resource_importer_scene.cpp\nindex 81af2e0543aa..211ee77ca197 100644\n--- a/editor/import/3d/resource_importer_scene.cpp\n+++ b/editor/import/3d/resource_importer_scene.cpp\n@@ -1303,9 +1303,9 @@ Node *ResourceImporterScene::_post_fix_animations(Node *p_node, Node *p_root, co\n \t\t\t\tDictionary anim_settings = p_animation_data[name];\n \n \t\t\t\t{\n-\t\t\t\t\tint slices_count = anim_settings[\"slices/amount\"];\n+\t\t\t\t\tint slice_count = anim_settings[\"slices/amount\"];\n \n-\t\t\t\t\tfor (int i = 0; i < slices_count; i++) {\n+\t\t\t\t\tfor (int i = 0; i < slice_count; i++) {\n \t\t\t\t\t\tString slice_name = anim_settings[\"slice_\" + itos(i + 1) + \"/name\"];\n \t\t\t\t\t\tint from_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/start_frame\"];\n \t\t\t\t\t\tint end_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/end_frame\"];\n@@ -1531,8 +1531,26 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n \t\t\t\t\t\t\tif (matdata.has(\"use_external/enabled\") && bool(matdata[\"use_external/enabled\"]) && matdata.has(\"use_external/path\")) {\n \t\t\t\t\t\t\t\tString path = matdata[\"use_external/path\"];\n \t\t\t\t\t\t\t\tRef<Material> external_mat = ResourceLoader::load(path);\n+\t\t\t\t\t\t\t\tif (external_mat.is_null()) {\n+\t\t\t\t\t\t\t\t\tif (matdata.has(\"use_external/fallback_path\")) {\n+\t\t\t\t\t\t\t\t\t\tString fallback_save_path = matdata[\"use_external/fallback_path\"];\n+\t\t\t\t\t\t\t\t\t\tif (!fallback_save_path.is_empty()) {\n+\t\t\t\t\t\t\t\t\t\t\texternal_mat = ResourceLoader::load(fallback_save_path);\n+\t\t\t\t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n+\t\t\t\t\t\t\t\t\t\t\t\tpath = fallback_save_path;\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n \t\t\t\t\t\t\t\t\tm->set_surface_material(i, external_mat);\n+\t\t\t\t\t\t\t\t\tif (!path.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t\t\t\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(path);\n+\t\t\t\t\t\t\t\t\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\t\t\t\t\t\t\t\t\tmatdata[\"use_external/path\"] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\tmatdata[\"use_external/fallback_path\"] = external_mat->get_path();\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n@@ -1784,13 +1802,14 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n }\n \n Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> anim, bool p_save_to_file, const String &p_save_to_path, bool p_keep_custom_tracks) {\n-\tif (!p_save_to_file || !p_save_to_path.is_resource_file()) {\n+\tString res_path = ResourceUID::ensure_path(p_save_to_path);\n+\tif (!p_save_to_file || !res_path.is_resource_file()) {\n \t\treturn anim;\n \t}\n \n-\tif (FileAccess::exists(p_save_to_path) && p_keep_custom_tracks) {\n+\tif (FileAccess::exists(res_path) && p_keep_custom_tracks) {\n \t\t// Copy custom animation tracks from previously imported files.\n-\t\tRef<Animation> old_anim = ResourceLoader::load(p_save_to_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n+\t\tRef<Animation> old_anim = ResourceLoader::load(res_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n \t\tif (old_anim.is_valid()) {\n \t\t\tfor (int i = 0; i < old_anim->get_track_count(); i++) {\n \t\t\t\tif (!old_anim->track_is_imported(i)) {\n@@ -1801,16 +1820,21 @@ Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> ani\n \t\t}\n \t}\n \n-\tif (ResourceCache::has(p_save_to_path)) {\n-\t\tRef<Animation> old_anim = ResourceCache::get_ref(p_save_to_path);\n+\tif (ResourceCache::has(res_path)) {\n+\t\tRef<Animation> old_anim = ResourceCache::get_ref(res_path);\n \t\tif (old_anim.is_valid()) {\n \t\t\told_anim->copy_from(anim);\n \t\t\tanim = old_anim;\n \t\t}\n \t}\n-\tanim->set_path(p_save_to_path, true); // Set path to save externally.\n-\tError err = ResourceSaver::save(anim, p_save_to_path, ResourceSaver::FLAG_CHANGE_PATH);\n-\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + p_save_to_path);\n+\tanim->set_path(res_path, true); // Set path to save externally.\n+\tError err = ResourceSaver::save(anim, res_path, ResourceSaver::FLAG_CHANGE_PATH);\n+\n+\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + res_path);\n+\tif (p_save_to_path.begins_with(\"uid://\")) {\n+\t\t// slow\n+\t\tResourceSaver::set_uid(res_path, ResourceUID::get_singleton()->text_to_id(p_save_to_path));\n+\t}\n \treturn anim;\n }\n \n@@ -2041,6 +2065,7 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MESH: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/shadow_meshes\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lightmap_uv\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lods\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n@@ -2049,11 +2074,13 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MATERIAL: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"use_external/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/path\", PROPERTY_HINT_FILE, \"*.material,*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t} break;\n \t\tcase INTERNAL_IMPORT_CATEGORY_ANIMATION: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"settings/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/keep_custom_tracks\"), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slices/amount\", PROPERTY_HINT_RANGE, \"0,256,1\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), 0));\n \n@@ -2063,7 +2090,8 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/end_frame\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \".res,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/keep_custom_tracks\"), false));\n \t\t\t}\n \t\t} break;\n@@ -2527,7 +2555,7 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \n \t\t\t\t\tif (bool(mesh_settings.get(\"save_to_file/enabled\", false))) {\n \t\t\t\t\t\tsave_to_file = mesh_settings.get(\"save_to_file/path\", String());\n-\t\t\t\t\t\tif (!save_to_file.is_resource_file()) {\n+\t\t\t\t\t\tif (!ResourceUID::ensure_path(save_to_file).is_resource_file()) {\n \t\t\t\t\t\t\tsave_to_file = \"\";\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n@@ -2581,16 +2609,24 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \t\t\t\tsrc_mesh_node->get_mesh()->optimize_indices();\n \n \t\t\t\tif (!save_to_file.is_empty()) {\n-\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_to_file);\n+\t\t\t\t\tString save_res_path = ResourceUID::ensure_path(save_to_file);\n+\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_res_path);\n \t\t\t\t\tif (existing.is_valid()) {\n \t\t\t\t\t\t//if somehow an existing one is useful, create\n \t\t\t\t\t\texisting->reset_state();\n \t\t\t\t\t}\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh(existing);\n \n-\t\t\t\t\tResourceSaver::save(mesh, save_to_file); //override\n+\t\t\t\t\tError err = ResourceSaver::save(mesh, save_res_path); //override\n+\t\t\t\t\tif (err != OK) {\n+\t\t\t\t\t\tWARN_PRINT(vformat(\"Failed to save mesh %s to '%s'.\", mesh->get_name(), save_res_path));\n+\t\t\t\t\t}\n+\t\t\t\t\tif (err == OK && save_to_file.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t// slow\n+\t\t\t\t\t\tResourceSaver::set_uid(save_res_path, ResourceUID::get_singleton()->text_to_id(save_to_file));\n+\t\t\t\t\t}\n \n-\t\t\t\t\tmesh->set_path(save_to_file, true); //takeover existing, if needed\n+\t\t\t\t\tmesh->set_path(save_res_path, true); //takeover existing, if needed\n \n \t\t\t\t} else {\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh();\n@@ -2868,14 +2904,66 @@ Node *ResourceImporterScene::pre_import(const String &p_source_file, const HashM\n \treturn scene;\n }\n \n-Error ResourceImporterScene::_check_resource_save_paths(const Dictionary &p_data) {\n+static Error convert_path_to_uid(ResourceUID::ID p_source_id, const String &p_hash_str, Dictionary &p_settings, const String &p_path_key, const String &p_fallback_path_key) {\n+\tconst String &raw_save_path = p_settings[p_path_key];\n+\tString save_path = ResourceUID::ensure_path(raw_save_path);\n+\tif (raw_save_path.begins_with(\"uid://\")) {\n+\t\tif (save_path.is_empty() || !DirAccess::exists(save_path.get_base_dir())) {\n+\t\t\tif (p_settings.has(p_fallback_path_key)) {\n+\t\t\t\tString fallback_save_path = p_settings[p_fallback_path_key];\n+\t\t\t\tif (!fallback_save_path.is_empty() && DirAccess::exists(fallback_save_path.get_base_dir())) {\n+\t\t\t\t\tsave_path = fallback_save_path;\n+\t\t\t\t\tResourceUID::get_singleton()->add_id(ResourceUID::get_singleton()->text_to_id(raw_save_path), save_path);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tp_settings[p_fallback_path_key] = save_path;\n+\t\t}\n+\t}\n+\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\tif (!save_path.is_empty() && !raw_save_path.begins_with(\"uid://\")) {\n+\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(save_path);\n+\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t} else {\n+\t\t\tResourceUID::ID save_id = hash64_murmur3_64(p_hash_str.hash64(), p_source_id) & 0x7FFFFFFFFFFFFFFF;\n+\t\t\tif (ResourceUID::get_singleton()->has_id(save_id)) {\n+\t\t\t\tif (save_path != ResourceUID::get_singleton()->get_id_path(save_id)) {\n+\t\t\t\t\t// The user has specified a path which does not match the default UID.\n+\t\t\t\t\tsave_id = ResourceUID::get_singleton()->create_id();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(save_id);\n+\t\t\tResourceUID::get_singleton()->add_id(save_id, save_path);\n+\t\t}\n+\t\tp_settings[p_fallback_path_key] = save_path;\n+\t}\n+\treturn OK;\n+}\n+\n+Error ResourceImporterScene::_check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data) {\n \tArray keys = p_data.keys();\n-\tfor (int i = 0; i < keys.size(); i++) {\n-\t\tconst Dictionary &settings = p_data[keys[i]];\n+\tfor (int di = 0; di < keys.size(); di++) {\n+\t\tDictionary settings = p_data[keys[di]];\n \n \t\tif (bool(settings.get(\"save_to_file/enabled\", false)) && settings.has(\"save_to_file/path\")) {\n-\t\t\tconst String save_path = ResourceUID::ensure_path(settings[\"save_to_file/path\"]);\n-\t\t\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix;\n+\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings, \"save_to_file/path\", \"save_to_file/fallback_path\");\n+\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Resource save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t}\n+\n+\t\tif (settings.has(\"slices/amount\")) {\n+\t\t\tint slice_count = settings[\"slices/amount\"];\n+\t\t\tfor (int si = 0; si < slice_count; si++) {\n+\t\t\t\tif (bool(settings.get(\"slice_\" + itos(si + 1) + \"/save_to_file/enabled\", false)) &&\n+\t\t\t\t\t\tsettings.has(\"slice_\" + itos(si + 1) + \"/save_to_file/path\")) {\n+\t\t\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix + itos(si + 1);\n+\t\t\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings,\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/path\",\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/fallback_path\");\n+\t\t\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Slice save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t\t\t}\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -2940,14 +3028,14 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \t// Check whether any of the meshes or animations have nonexistent save paths\n \t// and if they do, fail the import immediately.\n \tif (subresources.has(\"meshes\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"meshes\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"m\", subresources[\"meshes\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\n \t}\n \n \tif (subresources.has(\"animations\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"animations\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"a\", subresources[\"animations\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\ndiff --git a/editor/import/3d/resource_importer_scene.h b/editor/import/3d/resource_importer_scene.h\nindex af79746a4c34..68c06efbabbc 100644\n--- a/editor/import/3d/resource_importer_scene.h\n+++ b/editor/import/3d/resource_importer_scene.h\n@@ -210,7 +210,7 @@ class ResourceImporterScene : public ResourceImporter {\n \t\tSHAPE_TYPE_AUTOMATIC,\n \t};\n \n-\tstatic Error _check_resource_save_paths(const Dictionary &p_data);\n+\tstatic Error _check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data);\n \tArray _get_skinned_pose_transforms(ImporterMeshInstance3D *p_src_mesh_node);\n \tvoid _replace_owner(Node *p_node, Node *p_scene, Node *p_new_owner);\n \tNode *_generate_meshes(Node *p_node, const Dictionary &p_mesh_data, bool p_generate_lods, bool p_create_shadow_meshes, LightBakeMode p_light_bake_mode, float p_lightmap_texel_size, const Vector<uint8_t> &p_src_lightmap_cache, Vector<Vector<uint8_t>> &r_lightmap_caches);\ndiff --git a/editor/import/3d/scene_import_settings.cpp b/editor/import/3d/scene_import_settings.cpp\nindex 71b010a97026..609835385b1e 100644\n--- a/editor/import/3d/scene_import_settings.cpp\n+++ b/editor/import/3d/scene_import_settings.cpp\n@@ -1585,6 +1585,10 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\tcontinue; //ignore\n \t\t}\n \t\tString path = item->get_text(1);\n+\t\tString uid_path = path;\n+\t\tif (path.begins_with(\"uid://\")) {\n+\t\t\tpath = ResourceUID::uid_to_path(uid_path);\n+\t\t}\n \t\tif (!path.is_resource_file()) {\n \t\t\tcontinue;\n \t\t}\n@@ -1601,9 +1605,11 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\t\tEditorNode::get_singleton()->add_io_error(TTR(\"Can't make material external to file, write error:\") + \"\\n\\t\" + path);\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n+\t\t\t\tuid_path = ResourceUID::path_to_uid(path);\n \n \t\t\t\tmd.settings[\"use_external/enabled\"] = true;\n-\t\t\t\tmd.settings[\"use_external/path\"] = path;\n+\t\t\t\tmd.settings[\"use_external/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"use_external/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_MESH_SAVE_PATHS: {\n@@ -1611,14 +1617,16 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\tMeshData &md = mesh_map[id];\n \n \t\t\t\tmd.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tmd.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tmd.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"save_to_file/fallback_path\"] = path;\n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_ANIMATION_SAVE_PATHS: {\n \t\t\t\tERR_CONTINUE(!animation_map.has(id));\n \t\t\t\tAnimationData &ad = animation_map[id];\n \n \t\t\t\tad.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tad.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tad.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tad.settings[\"save_to_file/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t}\n", "test_patch": "", "problem_statement": "Resources saved to file from an imported scene do not save with consistent UIDs\n### Godot version\r\n\r\nv4.0.beta.custom_build [98e0d5995]\r\n\r\n### System information\r\n\r\nFedora 36\r\n\r\n### Issue description\r\n\r\nIf \"save to file\" is enabled for meshes or animations in an imported scene, the saved resources are given a random UID if the file doesn't already exist.\r\nThis is annoying if you've `.gitignore`d these files, which makes sense to do since they're auto-generated from glTF files. For example, I did so for the vehicle meshes in the [Truck Town](https://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town) demo. If you clone this repo right now, opening any of the vehicle scenes gives multiple invalid UID errors because when the mesh `.res` files are generated they don't get the same UIDs.\r\n\r\nI don't know how UIDs work, but I assume the way to fix this would be to remember what UID the resources are saved to in the glTF's `.import` file? That way it would be generated with the same UID every time.\r\n\r\n### Steps to reproduce\r\n\r\n1. Save a mesh or animation resource from a scene to a file using the advanced import options\r\n2. Reference that resource in a scene and save it\r\n3. Delete the resource and reimport the scene to regenerate it\r\n4. Open the scene referencing the resource, notice the invalid UID error\r\n\r\n### Minimal reproduction project\r\n\r\nhttps://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town\n", "hints_text": "Related https://github.com/godotengine/godot/issues/62258\nI'm having this problem in 4.1.1 and it's causing me to lose work. Once these warnings have appeared, the next time you open your project, references in resources affected will be missing entirely. This has caused models to go missing, which have to be reassigned in the scenes they were used in, and materials go missing from those models.\r\n\r\nThe thing costing me the most time is that for some reason, even though I have external materials (not from the .glb file), those that are referenced in the .glb as \"use external\" are affected by this issue as well. They lose their reference to the shader they were using, causing all the parameters for that material to be removed, so I have to reconfigure everything on top of reassigning the reference.\r\n\r\nThis issue seems to be intermittent or at least somewhat random, I had time where it didn't happen, but now it is happening frequently enough to halt development of 3D assets until this bug is resolved. It happens on some models/materials and not on others, there doesn't seem to be a common factor between instances.\r\n\r\nIs there a reason this issue is not assigned to a milestone? I know there are other people affected by this issue, here and on the Godot forums. And it seems to have been around in some form on older versions too.\n> I'm having this problem in 4.1.1 and it's causing me to lose work. Once these warnings have appeared, the next time you open your project, references in resources affected will be missing entirely. This has caused models to go missing, which have to be reassigned in the scenes they were used in, and materials go missing from those models.\r\n\r\nI noticed something similar, but I couldn't figure out how to reproduce it so I didn't open a separate issue.\r\nWhat was happening in my case was that the meshes were being saved with the same exact UID as the imported scene. So when loading scenes or resources referencing the mesh, it would try to load the scene they came from instead. But you can't assign a PackedScene to a property that expects a Mesh, so it just assigned null without any errors.\r\nTo fix it, I removed the line from the `.import` file that stored the UID, then deleted the mesh files, then reimported.\r\n\r\n\r\n\nThis sounds like a bug that could cause some pretty severe (but possibly rare) problems.\r\nI also noticed that when I tried to use the dependency menu to point towards the right resource instead, setting it just did nothing, but that would make sense if the UID's were the same.\r\n\r\nI did find that deleting the mesh imports and re-importing the `.glb` fixed those temporarily. But it seemed to come back quickly. I didn't try deleting the line from the `.import` file, is that the one for the `.glb`?\r\nUnfortunately, this \"fix\" won't work for my broken materials, as they are not imported from the `.glb`.\r\nI still don't know why those are being broken in the same way, it has to be because of the UID overlap, I'm just not sure what it was overlapping with. I think I remember the shader reference pointing towards the `.glb` or a mesh or something else, but the shader is completely separate to the imported `.glb`.\r\n\r\nNot sure what we are supposed to do with the invalid UID warning, as it seems to be able to fallback to the text path, but not allow us to fix the UID's.\n> This sounds like a bug that could cause some pretty severe (but possibly rare) problems.\r\n\r\n@VentaGhost I can confirm this.\r\nRight now I pretty much cannot properly use git with my project because the .res files will have tons of diffs and it is really bad. If I had any back-end knowledge, I'd immediately go fix it myself, but I do not. :c\n@betalars So this issue is still happening in the latest version? I had hoped some of the UID changes that came with 4.2 would fix this. Is this with an existing project from before 4.2 or with a new project created with 4.2? Because I wonder if it's just an issue with your project files. Still very unfortunate there isn't a way to fix this, this bug has basically killed that project I was working on because it kept resetting my materials. Might try importing everything to a fresh project at some point but I'd rather not waste time if the bug still exists.\r\nBy any chance are you working on Linux? Because I'd expect more people to have experienced this bug especially with large projects unless it's platform specific?\n@VantaGhost there still seems to be an issue, [as demonstrated in this demo project](https://github.com/betalars/godot-uuid-bug) when initialising a new Project in Godot 4.2\r\n\r\nIn the last commit, something about the res file changes.\r\n\r\nSteps to \"reproduce\":\r\n\r\n1. `git clone git@github.com:betalars/godot-uuid-bug.git`\r\n2. open the project in godot\r\n3. `git diff`\r\n\r\nHowever, I think this is actually a new issue, as the UUID included in the scene seems to be consistent.\r\n\r\nHow I forced this error to happen on my side:\r\n1. I initialised the Repo\r\n2. Added a Suzanne res, umported it to the main scene\r\n3. git commit\r\n4. closed godot\r\n5. deleted .godot\r\n6. re-opend godot\r\n7. suddenly: [a diff](https://github.com/betalars/godot-uuid-bug/commit/b50a8f5ad64fc5d5669691efc49451ae1fd9c115)\r\n\r\n@AThousandShips can you try to look into this? I think the [issue I've opened before](https://github.com/godotengine/godot/issues/87614) may be it's own problem.\r\n\r\nI use nixos as an OS\nUnable to do so right now, someone else might be able to look into it\nUpdate: it is a known issue", "created_at": "2024-12-24 12:42:28", "merge_commit_sha": "16816f426b2de8c10ed394b6a8d260ffcb5f3a30", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100766", "base_commit": "0f95e9f8e665cedaa5aace5f6f86de2b4b5a8c60", "patch": "diff --git a/drivers/metal/metal_objects.mm b/drivers/metal/metal_objects.mm\nindex b44c496e4f6f..04900a0e5162 100644\n--- a/drivers/metal/metal_objects.mm\n+++ b/drivers/metal/metal_objects.mm\n@@ -56,6 +56,10 @@\n \n #import <os/signpost.h>\n \n+// We have to undefine these macros because they are defined in NSObjCRuntime.h.\n+#undef MIN\n+#undef MAX\n+\n void MDCommandBuffer::begin() {\n \tDEV_ASSERT(commandBuffer == nil);\n \tcommandBuffer = queue.commandBufferWithUnretainedReferences;\n@@ -764,6 +768,7 @@\n \t\t[render.encoder setVertexBuffers:render.vertex_buffers.ptr()\n \t\t\t\t\t\t\t\t offsets:render.vertex_offsets.ptr()\n \t\t\t\t\t\t\t   withRange:NSMakeRange(first, p_binding_count)];\n+\t\trender.dirty.clear_flag(RenderState::DIRTY_VERTEX);\n \t} else {\n \t\trender.dirty.set_flag(RenderState::DIRTY_VERTEX);\n \t}\n@@ -1082,7 +1087,7 @@\n \n \tUniformSet const &set = p_shader->sets[index];\n \n-\tfor (uint32_t i = 0; i < uniforms.size(); i++) {\n+\tfor (uint32_t i = 0; i < MIN(uniforms.size(), set.uniforms.size()); i++) {\n \t\tRDD::BoundUniform const &uniform = uniforms[i];\n \t\tUniformInfo ui = set.uniforms[i];\n \ndiff --git a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\nindex 7bd2d75c74a3..2ed4efd1572e 100644\n--- a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n@@ -541,13 +541,15 @@ void ParticlesStorage::_particles_allocate_emission_buffer(Particles *particles)\n \n void ParticlesStorage::_particles_ensure_unused_emission_buffer(Particles *particles) {\n \tif (particles->unused_emission_storage_buffer.is_null()) {\n-\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\t// For rendering devices that do not support empty arrays (like C++),\n+\t\t// we need to size the buffer with at least 1 element.\n+\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(ParticleEmissionBuffer));\n \t}\n }\n \n void ParticlesStorage::_particles_ensure_unused_trail_buffer(Particles *particles) {\n \tif (particles->unused_trail_storage_buffer.is_null()) {\n-\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(16 * sizeof(float)); // Size of mat4.\n \t}\n }\n \n", "test_patch": "", "problem_statement": "Metal: Error compiling compute shader on iPhone A12\nWhen compiling the `particles.glsl` shader for an A12 or earlier device, it fails with the following error:\n\n```\nvalidateComputeFunctionArguments:1083: failed assertion `Compute Function(main0): argument src_particles[0] from buffer(4) with offset(0) and length(16) has space for 16 bytes, but argument has a length(128).'\n```\n\n> [!NOTE]\n>\n> Disabling API validation allows the app to run.\n\nThe issue is that when using classic binding (i.e. not argument buffers), the ABI for the shader passes the structures as arguments to the entry point:\n\n```metal\nstruct ParticleEmission\n{\n    float4x4 xform;\n    packed_float3 velocity;\n    uint flags;\n    float4 color;\n    float4 custom;\n};\n\nstruct SourceEmission\n{\n    int particle_count;\n    uint pad0;\n    uint pad1;\n    uint pad2;\n    ParticleEmission data[1];\n};\n\nkernel void main0(device SourceEmission& src_particles [[buffer(5)]], uint3 gl_GlobalInvocationID [[thread_position_in_grid]])\n{\n// ...\n```\n\nNote that the `src_particles` argument is a `struct SourceEmission`. Note again that this struct has an embedded type `struct ParticleEmission[1]`. Metal doesn't support unsized arrays, but SPRIV-Cross works around it by passing an embedded struct of size `1`. Interestingly, Metal is a variant of C++, and even Godot's definition has to use a sized array for the structure definition:\n\nhttps://github.com/godotengine/godot/blob/2450dee1bc1495daa2b7bdf06c7b3ddfbf8007e1/servers/rendering/renderer_rd/storage_rd/particles_storage.h#L157\n\nThe issue is that when Godot binds an empty emission buffer, it does not need to account for this, so it allocates a size 16:\n\nhttps://github.com/godotengine/godot/blob/d9ef826c545e7d623279c312ca837b947a4989b3/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp#L544\n\n_Originally posted by @TCROC in https://github.com/godotengine/godot/issues/99820#issuecomment-2558697999_\n            \n", "hints_text": "", "created_at": "2024-12-23 15:27:45", "merge_commit_sha": "13992bbf7bf0d14f0dcdcb3ace8e1d49d4d5bdd9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100540", "base_commit": "6e2cf2aa7b78a25d1b054f2ec0f02cd658482f84", "patch": "diff --git a/modules/camera/camera_linux.cpp b/modules/camera/camera_linux.cpp\nindex 60217709af8c..b774d1be3554 100644\n--- a/modules/camera/camera_linux.cpp\n+++ b/modules/camera/camera_linux.cpp\n@@ -52,6 +52,9 @@ void CameraLinux::_update_devices() {\n \n \t\t\tfor (int i = feeds.size() - 1; i >= 0; i--) {\n \t\t\t\tRef<CameraFeedLinux> feed = (Ref<CameraFeedLinux>)feeds[i];\n+\t\t\t\tif (feed.is_null()) {\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n \t\t\t\tString device_name = feed->get_device_name();\n \t\t\t\tif (!_is_active(device_name)) {\n \t\t\t\t\tremove_feed(feed);\n@@ -84,6 +87,9 @@ void CameraLinux::_update_devices() {\n bool CameraLinux::_has_device(const String &p_device_name) {\n \tfor (int i = 0; i < feeds.size(); i++) {\n \t\tRef<CameraFeedLinux> feed = (Ref<CameraFeedLinux>)feeds[i];\n+\t\tif (feed.is_null()) {\n+\t\t\tcontinue;\n+\t\t}\n \t\tif (feed->get_device_name() == p_device_name) {\n \t\t\treturn true;\n \t\t}\ndiff --git a/modules/camera/camera_macos.mm b/modules/camera/camera_macos.mm\nindex bd718a0cb6c8..d242444b0b5a 100644\n--- a/modules/camera/camera_macos.mm\n+++ b/modules/camera/camera_macos.mm\n@@ -323,6 +323,9 @@ - (void)dealloc {\n \t// remove devices that are gone..\n \tfor (int i = feeds.size() - 1; i >= 0; i--) {\n \t\tRef<CameraFeedMacOS> feed = (Ref<CameraFeedMacOS>)feeds[i];\n+\t\tif (feed.is_null()) {\n+\t\t\tcontinue;\n+\t\t}\n \n \t\tif (![devices containsObject:feed->get_device()]) {\n \t\t\t// remove it from our array, this will also destroy it ;)\n@@ -334,6 +337,9 @@ - (void)dealloc {\n \t\tbool found = false;\n \t\tfor (int i = 0; i < feeds.size() && !found; i++) {\n \t\t\tRef<CameraFeedMacOS> feed = (Ref<CameraFeedMacOS>)feeds[i];\n+\t\t\tif (feed.is_null()) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n \t\t\tif (feed->get_device() == device) {\n \t\t\t\tfound = true;\n \t\t\t};\n", "test_patch": "", "problem_statement": "Adding custom camera feeds to `CameraServer` leads to crash on Linux\n### Tested versions\n\nv4.4.dev.custom_build [4364ed6cc]\n\n### System information\n\nGodot v4.4.dev (4364ed6cc) - Freedesktop SDK 24.08 (Flatpak runtime) on Wayland - Wayland display driver, Single-window, 1 monitor - Vulkan (Forward+) - dedicated AMD Radeon RX 6650 XT (RADV NAVI23) - 12th Gen Intel(R) Core(TM) i5-12500 (12 threads)\n\n### Issue description\n\nWhen a custom `CameraFeed` is added to `CameraServer` through either GDScript or GDExtension, the scene will crash with error about caller thread, then crash with signal 11:\n\n```\nERROR: Caller thread can't call this function in this node (/root). Use call_deferred() or call_thread_group() instead.\n   at: propagate_notification (scene/main/node.cpp:2523)\n```\n\n### Steps to reproduce\n\n```gdscript\nvar feed := CameraFeed.new()\n\nfunc _ready() -> void:\n\tCameraServer.add_feed(feed)\n```\n\n### Minimal reproduction project (MRP)\n\nNone\n", "hints_text": "No crash on windows 10, maybe OS related.\n\nGodot v4.4.dev (2b7ea6223) - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated AMD Radeon RX 580 2048SP (Advanced Micro Devices, Inc.; 31.0.21921.1000) - AMD Ryzen 5 3600 6-Core Processor (12 threads)", "created_at": "2024-12-18 02:50:38", "merge_commit_sha": "48167ff06e93fe7ded601520eb2578b94fa8dbbc", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100533", "base_commit": "abf47965fca199f73d435c94b1be5be73c3f9964", "patch": "diff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\nindex 21fb76464b27..85cf08d4c921 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n@@ -407,24 +407,28 @@ void JoltContactListener3D::_flush_contacts() {\n \t\tconst JPH::SubShapeIDPair &shape_pair = E.key;\n \t\tManifold &manifold = E.value;\n \n-\t\tconst JPH::BodyID body_ids[2] = { shape_pair.GetBody1ID(), shape_pair.GetBody2ID() };\n-\t\tconst JoltReadableBodies3D jolt_bodies = space->read_bodies(body_ids, 2);\n+\t\tconst JoltReadableBody3D jolt_body1 = space->read_body(shape_pair.GetBody1ID());\n+\t\tconst JoltReadableBody3D jolt_body2 = space->read_body(shape_pair.GetBody2ID());\n \n-\t\tJoltBody3D *body1 = jolt_bodies[0].as_body();\n+\t\tJoltBody3D *body1 = jolt_body1.as_body();\n \t\tERR_FAIL_NULL(body1);\n \n-\t\tJoltBody3D *body2 = jolt_bodies[1].as_body();\n+\t\tJoltBody3D *body2 = jolt_body2.as_body();\n \t\tERR_FAIL_NULL(body2);\n \n \t\tconst int shape_index1 = body1->find_shape_index(shape_pair.GetSubShapeID1());\n \t\tconst int shape_index2 = body2->find_shape_index(shape_pair.GetSubShapeID2());\n \n-\t\tfor (const Contact &contact : manifold.contacts1) {\n-\t\t\tbody1->add_contact(body2, manifold.depth, shape_index1, shape_index2, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\tif (jolt_body1->IsActive()) {\n+\t\t\tfor (const Contact &contact : manifold.contacts1) {\n+\t\t\t\tbody1->add_contact(body2, manifold.depth, shape_index1, shape_index2, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\t\t}\n \t\t}\n \n-\t\tfor (const Contact &contact : manifold.contacts2) {\n-\t\t\tbody2->add_contact(body1, manifold.depth, shape_index2, shape_index1, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\tif (jolt_body2->IsActive()) {\n+\t\t\tfor (const Contact &contact : manifold.contacts2) {\n+\t\t\t\tbody2->add_contact(body1, manifold.depth, shape_index2, shape_index1, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\t\t}\n \t\t}\n \n \t\tmanifold.contacts1.clear();\n", "test_patch": "", "problem_statement": "Jolt Physics: state.get_contact_collider_position() Fails for Sleeping Bodies Despite get_contact_count() > 0\n### Tested versions\n\n- Reproducible in: 4.3.stable\n\n### System information\n\nWindows 10 - Vulkan (Forward+) - NVIDIA RTX 3060\n\n### Issue description\n\n**Jolt was just integrated to Godot, so I believe this should be in Godot issues. If not let me know!**\n\nWhen using Jolt Physics in Godot 4, and trying to get collision contact points between bodies, calling state.get_contact_collider_position(index) for a RigidBody3D results in an \"Index out of bounds\" error if the body gets in sleep mode. This occurs even when get_contact_count() reports a value greater than 0. The error does not occur with default Godot Physics\n\nThe error:\n```\n_physics_process(): Index p_contact_idx = 0 is out of bounds (body->get_contact_count() = 0).\n  <C++ Source>   src\\objects\\jolt_physics_direct_body_state_3d.cpp:217 @ _get_contact_collider_position()\n```\n\nThis behavior affects contact point calculations for bodies that are stationary but still colliding with other objects\n\n### Steps to reproduce\n\n1. Set up a scene with two colliding RigidBody3D objects.\n2. Ensure Jolt Physics is installed and defined as current physics engine\n3. Enable contact_monitor and set max_contacts_reported to a non-zero value (e.g., 5).\n4. Let one of the bodies come to rest, causing it to enter sleep mode.\n5. Execute the code below inside the body that has come to a rest:\n\n```\nextends RigidBody3D\n\nfunc _ready() -> void:\n\tcontact_monitor = true\n\tmax_contacts_reported = 5\n\nfunc _physics_process(_delta: float) -> void:\n\t# Get body rid\n\tvar rid := get_rid()\n\t# Get body physics state\n\tvar state := PhysicsServer3D.body_get_direct_state(rid)\n\t\n\tfor i in get_contact_count():\n\t\tprint(\"Contact count: \", get_contact_count(),\n\t\t\t\"  \", state.get_contact_collider_position(i))\n```\n\n**Expected Behavior:**\nstate.get_contact_collider_position(index) should return valid contact points if get_contact_count() > 0, even when the body is in sleep mode.\n\n**Observed Behavior:**\nAn \"Index out of bounds\" error occurs, and get_contact_collider_position() fails.\n\n### Minimal reproduction project (MRP)\n\nI had to remove macOS, Linux and android libraries from the Jolt folder to make the file small enough to upload. You can always reinstall jolt add-on to make sure.\n\n[BugJoltContact.zip](https://github.com/user-attachments/files/18168435/BugJoltContact.zip)\n\n\n\n", "hints_text": "", "created_at": "2024-12-17 22:30:58", "merge_commit_sha": "6e2cf2aa7b78a25d1b054f2ec0f02cd658482f84", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100510", "base_commit": "4364ed6ccd001cbfe7cb781d074100695c878d90", "patch": "diff --git a/editor/editor_paths.cpp b/editor/editor_paths.cpp\nindex 8e9df68f3b70..cd17559ac3dc 100644\n--- a/editor/editor_paths.cpp\n+++ b/editor/editor_paths.cpp\n@@ -237,6 +237,17 @@ EditorPaths::EditorPaths() {\n \t\t}\n \t}\n \n+\t// Temporary dir.\n+\t{\n+\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\tdir->make_dir_recursive(temp_dir);\n+\t\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\t\tERR_PRINT(\"Could not create editor temporary directory: \" + temp_dir);\n+\t\t\t\tpaths_valid = false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n \t// Validate or create project-specific editor data dir,\n \t// including shader cache subdir.\n \tif (Engine::get_singleton()->is_project_manager_hint() || (Main::is_cmdline_tool() && !ProjectSettings::get_singleton()->is_project_loaded())) {\n", "test_patch": "", "problem_statement": "Can't export project in self-contained mode\n### Tested versions\n\nRegression from #100150\n\n### System information\n\nW10\n\n### Issue description\n\nWhen using portable mode (the `._sc_` thing), exporting project results in:\n```\n  ERROR: Couldn't save project.binary at 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Can't open file from path 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Cannot remove non-existent file or directory: 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: C:\\godot_source\\editor\\export\\editor_export_platform.h:241 - Save ZIP: Failed to move temporary file \"C:/godot_source/bin/editor_data/temp/packtmp\" to \"C:/Program Files/Godot/BugReports/Repro/.export/project.zip\".\n```\nAlthough after further testing, seems like temp folder is missing for some reason and it's not created automatically. I didn't test if it's a problem in non-portable mode (it would happen with a clean Godot installation).\n\n### Steps to reproduce\n\n1. Enable [self-contained mode](https://docs.godotengine.org/en/stable/tutorials/io/data_paths.html#doc-data-paths-self-contained-mode)\n2. Export project\n3. The exported files are not created\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2024-12-17 14:19:52", "merge_commit_sha": "2b7ea6223bd0bdaa75706849c9dee1a82b2e2d01", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100506", "base_commit": "4364ed6ccd001cbfe7cb781d074100695c878d90", "patch": "diff --git a/.github/workflows/linux_builds.yml b/.github/workflows/linux_builds.yml\nindex 193942a1bb3a..6b786a7b5849 100644\n--- a/.github/workflows/linux_builds.yml\n+++ b/.github/workflows/linux_builds.yml\n@@ -140,6 +140,18 @@ jobs:\n           python-version: 3.8\n           scons-version: 4.0\n \n+      - name: Force remove preinstalled .NET SDKs\n+        if: matrix.build-mono\n+        run: |\n+          sudo rm -rf /usr/share/dotnet/sdk/*\n+\n+      - name: Setup older .NET SDK as baseline\n+        if: matrix.build-mono\n+        uses: actions/setup-dotnet@v4\n+        with:\n+          # Targeting the oldest version we want to support to ensure it still builds.\n+          dotnet-version: '8.0.100'\n+\n       - name: Compilation\n         uses: ./.github/actions/godot-build\n         with:\n@@ -163,6 +175,7 @@ jobs:\n       - name: Build .NET solutions\n         if: matrix.build-mono\n         run: |\n+          dotnet --info\n           ./modules/mono/build_scripts/build_assemblies.py --godot-output-dir=./bin --godot-platform=linuxbsd\n \n       - name: Prepare artifact\ndiff --git a/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj b/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj\nindex ee607ff279e2..d291199ad04d 100644\n--- a/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj\n+++ b/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj\n@@ -8,7 +8,7 @@\n   </PropertyGroup>\n \n   <ItemGroup>\n-    <PackageReference Include=\"Microsoft.CodeAnalysis.CSharp\" Version=\"4.9.2\" PrivateAssets=\"all\" />\n+    <PackageReference Include=\"Microsoft.CodeAnalysis.CSharp\" Version=\"4.8.0\" PrivateAssets=\"all\" />\n     <PackageReference Include=\"Microsoft.CodeAnalysis.Analyzers\" Version=\"3.3.4\" PrivateAssets=\"all\" />\n   </ItemGroup>\n \n", "test_patch": "", "problem_statement": ".NET: Building GodotSharp is broken in current `master` branch\n### Tested versions\n\n- Reproducible in 4.4.dev (4364ed6ccd001cbfe7cb781d074100695c878d90)\n- Not reproducible in 4.4.dev6 and earlier\n\n### System information\n\nFedora 41, .NET 8.0.111\n\n### Issue description\n\nWhen building the GodotSharp assemblies, I get these errors:\n\n```\n$ ./modules/mono/build_scripts/build_assemblies.py --godot-output-dir ./bin\nRunning MSBuild:  /usr/bin/dotnet msbuild /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp.sln /restore /t:Build /p:Configuration=Debug /p:NoWarn=1591\n\nWelcome to .NET 8.0!\n---------------------\nSDK Version: 8.0.111\n\n----------------\nInstalled an ASP.NET Core HTTPS development certificate.\nTo trust the certificate, view the instructions: https://aka.ms/dotnet-https-linux\n\n----------------\nWrite your first app: https://aka.ms/dotnet-hello-world\nFind out what's new: https://aka.ms/dotnet-whats-new\nExplore documentation: https://aka.ms/dotnet-docs\nReport issues and find source on GitHub: https://github.com/dotnet/core\nUse 'dotnet --help' to see available commands or visit: https://aka.ms/dotnet-cli\n--------------------------------------------------------------------------------------\nMSBuild version 17.8.5+b5265ef37 for .NET\n  Determining projects to restore...\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj (in 419 ms).\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharpEditor/GodotSharpEditor.csproj (in 419 ms).\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotPlugins/GodotPlugins.csproj (in 419 ms).\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj (in 4.05 sec).\n  Godot.SourceGenerators.Internal -> /home/akien/Godot/godot/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/bin/Debug/netstandard2.0/Godot.SourceGenerators.Internal.dll\nCSC : warning CS9057: The analyzer assembly '/home/akien/Godot/godot/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/bin/Debug/netstandard2.0/Godot.SourceGenerators.Internal.dll' references version '4.9.0.0' of the compiler, which is newer than the currently running version '4.8.0.0'. [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(7,13): error CS0234: The type or namespace name 'SourceGenerators' does not exist in the namespace 'Godot' (are you missing an assembly reference?) [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(18,6): error CS0246: The type or namespace name 'GenerateUnmanagedCallbacksAttribute' could not be found (are you missing a using directive or an assembly reference?) [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(18,6): error CS0246: The type or namespace name 'GenerateUnmanagedCallbacks' could not be found (are you missing a using directive or an assembly reference?) [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(185,36): error CS8795: Partial method 'NativeFuncs.godotsharp_variant_new_copy(out godot_variant, scoped in godot_variant)' must have an implementation part because it has accessibility modifiers. [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(319,36): error CS8795: Partial method 'NativeFuncs.godotsharp_string_name_new_copy(out godot_string_name, scoped in godot_string_name)' must have an implementation part because it has accessibility modifiers. [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n```\netc.\n\nFull error log:\n[godotsharp-errors.txt](https://github.com/user-attachments/files/18163050/godotsharp-errors.txt)\n\nThis appears to be a recent regression, possibly from #92131?\n\n<details>\n<summary>dotnet --info</summary>\n\n```\n.NET SDK:\n Version:           8.0.111\n Commit:            ad116b5ce0\n Workload version:  8.0.100-manifests.7198dcc9\n\nRuntime Environment:\n OS Name:     fedora\n OS Version:  41\n OS Platform: Linux\n RID:         fedora.41-x64\n Base Path:   /usr/lib64/dotnet/sdk/8.0.111/\n\n.NET workloads installed:\n Workload version: 8.0.100-manifests.7198dcc9\nThere are no installed workloads to display.\n\nHost:\n  Version:      8.0.11\n  Architecture: x64\n  Commit:       9cb3b725e3\n\n.NET SDKs installed:\n  8.0.111 [/usr/lib64/dotnet/sdk]\n\n.NET runtimes installed:\n  Microsoft.AspNetCore.App 8.0.11 [/usr/lib64/dotnet/shared/Microsoft.AspNetCore.App]\n  Microsoft.NETCore.App 8.0.11 [/usr/lib64/dotnet/shared/Microsoft.NETCore.App]\n\nOther architectures found:\n  None\n\nEnvironment variables:\n  DOTNET_ROOT       [/usr/lib64/dotnet]\n\nglobal.json file:\n  Not found\n\nLearn more:\n  https://aka.ms/dotnet/info\n\nDownload .NET:\n  https://aka.ms/dotnet/download\n```\n\n</details>\n\n### Steps to reproduce\n\n```\nscons module_mono_enabled=yes\n./bin/godot.blabla --generate-mono-glue modules/mono/glue\n./modules/mono/build_scripts/build_assemblies.py --godot-output-dir ./bin\n```\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "hints_text": "> This appears to be a recent regression, possibly from [#92131](https://github.com/godotengine/godot/pull/92131)?\n\nI confirm that reverting that PR locally fixes the issue for me.", "created_at": "2024-12-17 10:00:56", "merge_commit_sha": "f1cf8ebfd6fbb1396e48577cae7d4656c0e3ac71", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100408", "base_commit": "4364ed6ccd001cbfe7cb781d074100695c878d90", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 7591208aa02c..d89593b5aeb0 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -2085,7 +2085,7 @@ void EditorNode::_dialog_action(String p_file) {\n \t\t\tload_scene(p_file);\n \t\t} break;\n \t\tcase SETTINGS_PICK_MAIN_SCENE: {\n-\t\t\tProjectSettings::get_singleton()->set(\"application/run/main_scene\", p_file);\n+\t\t\tProjectSettings::get_singleton()->set(\"application/run/main_scene\", ResourceUID::path_to_uid(p_file));\n \t\t\tProjectSettings::get_singleton()->save();\n \t\t\t// TODO: Would be nice to show the project manager opened with the highlighted field.\n \n@@ -2134,7 +2134,7 @@ void EditorNode::_dialog_action(String p_file) {\n \t\t} break;\n \n \t\tcase FILE_SAVE_AND_RUN_MAIN_SCENE: {\n-\t\t\tProjectSettings::get_singleton()->set(\"application/run/main_scene\", p_file);\n+\t\t\tProjectSettings::get_singleton()->set(\"application/run/main_scene\", ResourceUID::path_to_uid(p_file));\n \t\t\tProjectSettings::get_singleton()->save();\n \n \t\t\tif (file->get_file_mode() == EditorFileDialog::FILE_MODE_SAVE_FILE) {\n@@ -3962,25 +3962,25 @@ Error EditorNode::load_scene(const String &p_scene, bool p_ignore_broken_deps, b\n \t\treturn OK;\n \t}\n \n+\tString lpath = ResourceUID::ensure_path(p_scene);\n \tif (!p_set_inherited) {\n \t\tfor (int i = 0; i < editor_data.get_edited_scene_count(); i++) {\n-\t\t\tif (editor_data.get_scene_path(i) == p_scene) {\n+\t\t\tif (editor_data.get_scene_path(i) == lpath) {\n \t\t\t\t_set_current_scene(i);\n \t\t\t\treturn OK;\n \t\t\t}\n \t\t}\n \n-\t\tif (!p_force_open_imported && FileAccess::exists(p_scene + \".import\")) {\n-\t\t\topen_imported->set_text(vformat(TTR(\"Scene '%s' was automatically imported, so it can't be modified.\\nTo make changes to it, a new inherited scene can be created.\"), p_scene.get_file()));\n+\t\tif (!p_force_open_imported && FileAccess::exists(lpath + \".import\")) {\n+\t\t\topen_imported->set_text(vformat(TTR(\"Scene '%s' was automatically imported, so it can't be modified.\\nTo make changes to it, a new inherited scene can be created.\"), lpath.get_file()));\n \t\t\topen_imported->popup_centered();\n \t\t\tnew_inherited_button->grab_focus();\n-\t\t\topen_import_request = p_scene;\n+\t\t\topen_import_request = lpath;\n \t\t\treturn OK;\n \t\t}\n \t}\n \n-\tString lpath = ProjectSettings::get_singleton()->localize_path(p_scene);\n-\n+\tlpath = ProjectSettings::get_singleton()->localize_path(lpath);\n \tif (!lpath.begins_with(\"res://\")) {\n \t\tshow_accept(TTR(\"Error loading scene, it must be inside the project path. Use 'Import' to open the scene, then save it inside the project path.\"), TTR(\"OK\"));\n \t\topening_prev = false;\n@@ -4081,7 +4081,7 @@ Error EditorNode::load_scene(const String &p_scene, bool p_ignore_broken_deps, b\n \n \tset_edited_scene(new_scene);\n \n-\tString config_file_path = EditorPaths::get_singleton()->get_project_settings_dir().path_join(p_scene.get_file() + \"-editstate-\" + p_scene.md5_text() + \".cfg\");\n+\tString config_file_path = EditorPaths::get_singleton()->get_project_settings_dir().path_join(lpath.get_file() + \"-editstate-\" + lpath.md5_text() + \".cfg\");\n \tRef<ConfigFile> editor_state_cf;\n \teditor_state_cf.instantiate();\n \tError editor_state_cf_err = editor_state_cf->load(config_file_path);\ndiff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex 9bf21a543884..ac95f0346d56 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -270,7 +270,7 @@ void FileSystemDock::_create_tree(TreeItem *p_parent, EditorFileSystemDirectory\n \n \t// Create all items for the files in the subdirectory.\n \tif (display_mode == DISPLAY_MODE_TREE_ONLY) {\n-\t\tString main_scene = GLOBAL_GET(\"application/run/main_scene\");\n+\t\tconst String main_scene = ResourceUID::ensure_path(GLOBAL_GET(\"application/run/main_scene\"));\n \n \t\t// Build the list of the files to display.\n \t\tList<FileInfo> file_list;\n@@ -1125,7 +1125,7 @@ void FileSystemDock::_update_file_list(bool p_keep_selection) {\n \tsort_file_info_list(file_list, file_sort);\n \n \t// Fills the ItemList control node from the FileInfos.\n-\tString main_scene = GLOBAL_GET(\"application/run/main_scene\");\n+\tconst String main_scene = ResourceUID::ensure_path(GLOBAL_GET(\"application/run/main_scene\"));\n \tfor (FileInfo &E : file_list) {\n \t\tFileInfo *finfo = &(E);\n \t\tString fname = finfo->name;\n@@ -2379,7 +2379,7 @@ void FileSystemDock::_file_option(int p_option, const Vector<String> &p_selected\n \t\tcase FILE_MAIN_SCENE: {\n \t\t\t// Set as main scene with selected scene file.\n \t\t\tif (p_selected.size() == 1) {\n-\t\t\t\tProjectSettings::get_singleton()->set(\"application/run/main_scene\", p_selected[0]);\n+\t\t\t\tProjectSettings::get_singleton()->set(\"application/run/main_scene\", ResourceUID::path_to_uid(p_selected[0]));\n \t\t\t\tProjectSettings::get_singleton()->save();\n \t\t\t\t_update_tree(get_uncollapsed_paths());\n \t\t\t\t_update_file_list(true);\ndiff --git a/main/main.cpp b/main/main.cpp\nindex b3b6d960e7a1..b8dec2154b24 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -3817,8 +3817,8 @@ int Main::start() {\n \n #endif // TOOLS_ENABLED\n \n-\tif (script.is_empty() && game_path.is_empty() && String(GLOBAL_GET(\"application/run/main_scene\")) != \"\") {\n-\t\tgame_path = GLOBAL_GET(\"application/run/main_scene\");\n+\tif (script.is_empty() && game_path.is_empty()) {\n+\t\tgame_path = ResourceUID::ensure_path(GLOBAL_GET(\"application/run/main_scene\"));\n \t}\n \n #ifdef TOOLS_ENABLED\n", "test_patch": "", "problem_statement": "Exported project fails to start when UID is saved in project settings\n### Tested versions\n\n- Reproducible in Godot master (c2e4ae782a399adf42c664d3d21d8defe49ba8e5)\n\n### System information\n\nWindows 10\n\n### Issue description\n\nIf you set the main scene through the project manager dialog Godot now saves the UID in the project file:\n```\nconfig_version=5\n\n[application]\n\nconfig/name=\"test-export\"\nrun/main_scene=\"uid://dg450amr7gaby\"\nconfig/features=PackedStringArray(\"4.4\", \"GL Compatibility\")\nconfig/icon=\"res://icon.svg\"\n```\n\nThis works fine in the editor but after exporting your project, Godot can no longer run the project:\n```\nPS C:\\projects\\export> Godot Engine v4.4.dev.custom_build.c2e4ae782 (2024-12-11 17:48:18 UTC) - https://godotengine.org\nOpenGL API 3.3.0 NVIDIA 566.03 - Compatibility - Using Device: NVIDIA - NVIDIA GeForce RTX 4070 Ti\n\nERROR: No loader found for resource: res://uid:/dg450amr7gaby (expected type: )\n   at: (core\\io\\resource_loader.cpp:327)\nERROR: Failed loading scene: res://uid:/dg450amr7gaby.\n   at: (main\\main.cpp:4214)\n```\n\nThe fault is caused by this line of code:\n```\neditor_node.cpp:3973 if (!p_force_open_imported && FileAccess::exists(p_scene + \".import\")) {\n```\nIt attempts to load the file `res://uid:/dg450amr7gaby.import` which does not exist.\n\n### Steps to reproduce\n\n- Create a new project\n- Create a scene, add some stuff to it\n- Save the scene\n- Select the scene as your main scene in the project manager (IMPORTANT, If you run your scene and select \"use current scene\" it will save the proper file path and work)\n- Export your project\n\n### Minimal reproduction project (MRP)\n\n[test-export.zip](https://github.com/user-attachments/files/18125819/test-export.zip)\n\n", "hints_text": "> The fault is caused by this line of code:\neditor_node.cpp:3973 if (!p_force_open_imported && FileAccess::exists(p_scene + \".import\")) {\n\nHow can it cause the bug if it's editor code?\n> > The fault is caused by this line of code:\n> > editor_node.cpp:3973 if (!p_force_open_imported && FileAccess::exists(p_scene + \".import\")) {\n> \n> How can it cause the bug if it's editor code?\n\nI presume it means the export step is doing something wrong, and thus the resulting PCK is invalid and different from if there was no bug.\nThen the error would appear during export, but it's not the case.\nThere are two issues here and the description is mixed up. The quoted line causes error on editor startup, if no scene was restored (so it tries to open main scene)\nOwh that last bit might be a fluke of testing on my end, I might have run it with a dev/editor build to try and trap the error as with a runtime build it just quits silently.\n\nThe bottom line is:\n- exporting the project with the UIDs in the `project.godot` file -> exported project fails to load and just quits\n- editing the `project.godot` to add proper paths (or select \"use current scene\" when running a project) -> exported project works\nJust to rule out there is an issue with my custom build. Just reproduced this with Godot 4.4 dev 6 with the following steps:\n\n1. Download Godot 4.4 dev 6 and run\n2. Create a new project\n3. Download export templats\n4. Create a new scene, add `DirectionalLight3D`, `WorldEnvironment`, `Camera3D` and `MeshInstance3D` with a `BoxMesh` to create the most basic scene possible\n5. Save this scene\n6. Open project manager, select Run, set the main scene to the scene you just saved\n7. Press run button in toolbar to test, project works\n8. Open export window\n9. Add `Windows Desktop` export preset\n10. Press Export Project and save the project in a new folder\n11. Run the exported project, project fails to load.\nJust a detail, this seems to be a duplicate of #100084 but this one has more detail, maybe is good consolidate everything here or at least keep an eye to close both when the fix is done.", "created_at": "2024-12-14 19:03:29", "merge_commit_sha": "e237dd0691473ee569e4cae4c8fc8051b69655e9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100235", "base_commit": "a372214a4a047ccf63d23c4406337b30e55ff60b", "patch": "diff --git a/core/object/object.h b/core/object/object.h\nindex da8e8d1b86ee..11b94a7fbf0a 100644\n--- a/core/object/object.h\n+++ b/core/object/object.h\n@@ -572,7 +572,7 @@ class Object {\n \t\tCONNECT_PERSIST = 2, // hint for scene to save this connection\n \t\tCONNECT_ONE_SHOT = 4,\n \t\tCONNECT_REFERENCE_COUNTED = 8,\n-\t\tCONNECT_INHERITED = 16, // Whether or not the connection is in an instance of a scene.\n+\t\tCONNECT_INHERITED = 16, // Used in editor builds.\n \t};\n \n \tstruct Connection {\ndiff --git a/scene/resources/packed_scene.cpp b/scene/resources/packed_scene.cpp\nindex 8b1cbdf488a5..d6748ed2e64f 100644\n--- a/scene/resources/packed_scene.cpp\n+++ b/scene/resources/packed_scene.cpp\n@@ -1060,12 +1060,6 @@ Error SceneState::_parse_connections(Node *p_owner, Node *p_node, HashMap<String\n \t\t\t\tcontinue;\n \t\t\t}\n \n-\t\t\t// Don't include signals that are from scene instances\n-\t\t\t// (they are already saved in the scenes themselves).\n-\t\t\tif (c.flags & CONNECT_INHERITED) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n \t\t\t// only connections that originate or end into main saved scene are saved\n \t\t\t// everything else is discarded\n \n", "test_patch": "diff --git a/tests/scene/test_packed_scene.h b/tests/scene/test_packed_scene.h\nindex 3698b00c6b86..df23c251c00b 100644\n--- a/tests/scene/test_packed_scene.h\n+++ b/tests/scene/test_packed_scene.h\n@@ -96,6 +96,8 @@ TEST_CASE(\"[PackedScene] Signals Preserved when Packing Scene\") {\n \t\tCHECK_EQ(state->get_connection_count(), 3);\n \t}\n \n+\t/*\n+\t// FIXME: This subcase requires GH-48064 to be fixed.\n \tSUBCASE(\"Signals that should not be saved\") {\n \t\tint subscene_flags = Object::CONNECT_PERSIST | Object::CONNECT_INHERITED;\n \t\t// subscene node to itself\n@@ -115,6 +117,7 @@ TEST_CASE(\"[PackedScene] Signals Preserved when Packing Scene\") {\n \t\tRef<SceneState> state = packed_scene->get_state();\n \t\tCHECK_EQ(state->get_connection_count(), 0);\n \t}\n+\t*/\n \n \tmemdelete(main_scene_root);\n }\n", "problem_statement": "4.4-dev6: Signals don't work in exported builds if .godot dir was created by dev6\n### Tested versions\n\n- Reproducible in: v4.4.dev6.official [1f47e4c4e]\n- Not reproducible in: v4.4.dev5.official [9e6098432]\n\n### System information\n\nGodot v4.4.dev6 - Ubuntu 24.04.1 LTS 24.04 on X11 - X11 display driver, Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1060 6GB (nvidia; 535.183.01) - Intel(R) Core(TM) i5-4570 CPU @ 3.20GHz (4 threads)\n\n### Issue description\n\nIn 4.4-dev6, _signals do not work, at all_ in exported builds. The signal handlers are never called. I have tried both built-in signals (such as clicking a button) and custom signals (calling `.emit()`).\n\nHowever, the circumstances are extremely weird. It is not tied to the Godot version you used to export, but rather, _the Godot version that created the `.godot` directory_.\n\nTo elaborate:\n* If you create a new project in 4.4-dev6, then export it, signals are broken.\n* If you create a project in 4.4-dev5, then upgrade to 4.4-dev6, then export, signals work.\n* However, if you delete the `.godot` directory, then re-open with 4.4-dev6, signals are broken.\n* But, if you then re-open the project (with the `.godot` dir created in dev6) in 4.4-dev5, and export, signals are still broken!\n\nSo this bug can manifest in 4.4-dev5 and earlier, but only if the `.godot` dir was created by dev6.\n\nI'm at a loss to explain this behaviour, but I have tested it extensively (on Linux), both on a \"real\" project and in a minimal repro. I have compared the \"good\" and \"bad\" `.godot` directories and can't see much that would distinguish them - the binary `.scn` files are different but you would expect those to regenerate every time you re-save the scene. And shader cache files are different, but you wouldn't expect that to affect something as unrelated as signals.\n\nAnd to be clear, everything works fine in the editor. It's only broken for exported builds.\n\nI have tested both the Linux native and Web exports, and the issue affects both.\n\n### Steps to reproduce\n\n1. Create a new project using 4.4-dev6.\n2. Create a new \"User Interface\" scene.\n3. Attach a script to the scene.\n4. Add a Button to the scene and give it some text.\n5. In the editor, connect the Button's `pressed()` signal up to a new method.\n6. Add the code `print('Button pressed')` to the signal handler. For good measure, also `$Button.text = 'Pressed'`.\n7. Run the project (setting the scene as the main scene) and verify that clicking the button prints \"Button pressed\" to the console and changes the button text.\n8. Project > Export and add a Linux native export, without changing any settings.\n9. Export Project. Ensure that \"Export With Debug\" is ticked.\n10. From the command line, run `New Game Project.x86_64`.\n11. Observe that clicking the button has no effect, neither printing to the console, nor changing the text.\n\nAs mentioned above, there are some very weird interactions if we change Godot versions:\n- Open the project in dev5 - it is still broken.\n- Delete the `.godot` dir and re-open in dev5 - it now works.\n- Open the project in dev6 - it still works.\n- Delete the `.godot` dir and re-open in dev6 - it is now broken again.\n\n### Minimal reproduction project (MRP)\n\n[signal-repro.zip](https://github.com/user-attachments/files/18038555/signal-repro.zip)\n\n", "hints_text": "Just looking at the dev6 changelog, a possible commit that might have caused this is #97303. (Because perhaps the \"avoid duplicating signals\" avoided something necessary to do with signals, and wrote that into the PackedScene inside the `.godot` directory, which means signals don't fire even if it's loaded in old versions.)\nI tested the issue (on the Web platform, running dev5 and dev6 as explained) and I can confirm it.\nI can confirm too that the regression is caused by #97303. I reverted the PR from master, then created a project with it. And it works when exported.\nCC @cixil \nThe problem seems to be how the `CONNECT_INHERITED` is applied.\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/scene/resources/packed_scene.cpp#L609\nChanging this to use `GEN_EDIT_STATE_MAIN` fixes the bug, but it's probably not the right fix.\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/editor/export/editor_export_platform.cpp#L825\nThe bug happens, because scenes are processed during export if you have `editor/export/convert_text_resources_to_binary` enabled, and due to wrong inheritance state, the connections are lost.\nWell there is another case of this bug (or at least I think it is related). Signal connections don't work in scenes instantiated by plugins, like custom main screens.\n\nEDIT:\nOk confirmed it to be the same problem.\n\nEDIT2:\nIt's actually caused by my specific way of creating some nodes. I pack a scene and then instantiate it multiple times.\n\nEDIT3:\nThese might be related: #48064 #85372 #85606\nDon't know if it matters, but you can get around this bug by connecting signals via code instead of the UI.\nConfirmed on android XR builds. Good to know ^_^\nCan anyone explain exactly what the role is for this flag:\n\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/core/object/object.h#L575\n\nand these enums?:\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/scene/resources/packed_scene.h#L126-L131\n\nre @KoBeWi's comment\nI don't quite understand why the inherited flag would be *added*  during instantiation, isn't this flag just supposed to be a way for the editor to determine which connections are a part of the scene?\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/scene/resources/packed_scene.cpp#L609\n\nEDIT: Ah I see this is added when instantiated scenes are added as children in the editor? I forget the same code is used in the game runtime and in the editor\nThe flag is temporary. All connections that belong to a different scene than the currently opened one will get the flag once the scene is loaded; this applies to instances and inherited scenes.\nI guess a simple fix to #97303 could be to add `#ifdef TOOLS_ENABLED` around the check for the inherited flag (haven't tested). But I'm not sure if this issue points to an incorrect use of `CONNECT_INHERITED` that should be fixed instead.\nThe problem exists in the editor.", "created_at": "2024-12-10 09:15:06", "merge_commit_sha": "c2e4ae782a399adf42c664d3d21d8defe49ba8e5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100221", "base_commit": "a372214a4a047ccf63d23c4406337b30e55ff60b", "patch": "diff --git a/drivers/unix/dir_access_unix.cpp b/drivers/unix/dir_access_unix.cpp\nindex 816ffd7a322f..6d3e4c7dbf19 100644\n--- a/drivers/unix/dir_access_unix.cpp\n+++ b/drivers/unix/dir_access_unix.cpp\n@@ -438,11 +438,19 @@ Error DirAccessUnix::remove(String p_path) {\n \t\treturn FAILED;\n \t}\n \n+\tint err;\n \tif (S_ISDIR(flags.st_mode) && !is_link(p_path)) {\n-\t\treturn ::rmdir(p_path.utf8().get_data()) == 0 ? OK : FAILED;\n+\t\terr = ::rmdir(p_path.utf8().get_data());\n \t} else {\n-\t\treturn ::unlink(p_path.utf8().get_data()) == 0 ? OK : FAILED;\n+\t\terr = ::unlink(p_path.utf8().get_data());\n \t}\n+\tif (err != 0) {\n+\t\treturn FAILED;\n+\t}\n+\tif (remove_notification_func != nullptr) {\n+\t\tremove_notification_func(p_path);\n+\t}\n+\treturn OK;\n }\n \n bool DirAccessUnix::is_link(String p_file) {\n@@ -552,6 +560,8 @@ DirAccessUnix::DirAccessUnix() {\n \tchange_dir(current_dir);\n }\n \n+DirAccessUnix::RemoveNotificationFunc DirAccessUnix::remove_notification_func = nullptr;\n+\n DirAccessUnix::~DirAccessUnix() {\n \tlist_dir_end();\n }\ndiff --git a/drivers/unix/dir_access_unix.h b/drivers/unix/dir_access_unix.h\nindex 8d13ff1fa88d..adf1fa80e7be 100644\n--- a/drivers/unix/dir_access_unix.h\n+++ b/drivers/unix/dir_access_unix.h\n@@ -52,6 +52,9 @@ class DirAccessUnix : public DirAccess {\n \tvirtual bool is_hidden(const String &p_name);\n \n public:\n+\ttypedef void (*RemoveNotificationFunc)(const String &p_file);\n+\tstatic RemoveNotificationFunc remove_notification_func;\n+\n \tvirtual Error list_dir_begin() override; ///< This starts dir listing\n \tvirtual String get_next() override;\n \tvirtual bool current_is_dir() const override;\ndiff --git a/drivers/unix/file_access_unix.cpp b/drivers/unix/file_access_unix.cpp\nindex f2e4b3966be8..048d42529029 100644\n--- a/drivers/unix/file_access_unix.cpp\n+++ b/drivers/unix/file_access_unix.cpp\n@@ -443,7 +443,7 @@ void FileAccessUnix::close() {\n \t_close();\n }\n \n-CloseNotificationFunc FileAccessUnix::close_notification_func = nullptr;\n+FileAccessUnix::CloseNotificationFunc FileAccessUnix::close_notification_func = nullptr;\n \n FileAccessUnix::~FileAccessUnix() {\n \t_close();\ndiff --git a/drivers/unix/file_access_unix.h b/drivers/unix/file_access_unix.h\nindex 66e4bccc2525..fb9d684714c3 100644\n--- a/drivers/unix/file_access_unix.h\n+++ b/drivers/unix/file_access_unix.h\n@@ -38,8 +38,6 @@\n \n #if defined(UNIX_ENABLED)\n \n-typedef void (*CloseNotificationFunc)(const String &p_file, int p_flags);\n-\n class FileAccessUnix : public FileAccess {\n \tFILE *f = nullptr;\n \tint flags = 0;\n@@ -56,6 +54,7 @@ class FileAccessUnix : public FileAccess {\n #endif\n \n public:\n+\ttypedef void (*CloseNotificationFunc)(const String &p_file, int p_flags);\n \tstatic CloseNotificationFunc close_notification_func;\n \n \tvirtual Error open_internal(const String &p_path, int p_mode_flags) override; ///< open a file\ndiff --git a/platform/web/os_web.cpp b/platform/web/os_web.cpp\nindex 51facbaa845d..8f59c8ad668c 100644\n--- a/platform/web/os_web.cpp\n+++ b/platform/web/os_web.cpp\n@@ -224,6 +224,18 @@ void OS_Web::file_access_close_callback(const String &p_file, int p_flags) {\n \t}\n }\n \n+void OS_Web::dir_access_remove_callback(const String &p_file) {\n+\tOS_Web *os = OS_Web::get_singleton();\n+\tbool is_file_persistent = p_file.begins_with(\"/userfs\");\n+#ifdef TOOLS_ENABLED\n+\t// Hack for editor persistence (can we track).\n+\tis_file_persistent = is_file_persistent || p_file.begins_with(\"/home/web_user/\");\n+#endif\n+\tif (is_file_persistent) {\n+\t\tos->idb_needs_sync = true;\n+\t}\n+}\n+\n void OS_Web::update_pwa_state_callback() {\n \tif (OS_Web::get_singleton()) {\n \t\tOS_Web::get_singleton()->pwa_is_waiting = true;\n@@ -287,4 +299,5 @@ OS_Web::OS_Web() {\n \t_set_logger(memnew(CompositeLogger(loggers)));\n \n \tFileAccessUnix::close_notification_func = file_access_close_callback;\n+\tDirAccessUnix::remove_notification_func = dir_access_remove_callback;\n }\ndiff --git a/platform/web/os_web.h b/platform/web/os_web.h\nindex 1ddb745965ac..8965cc4424b7 100644\n--- a/platform/web/os_web.h\n+++ b/platform/web/os_web.h\n@@ -53,6 +53,7 @@ class OS_Web : public OS_Unix {\n \tWASM_EXPORT static void main_loop_callback();\n \n \tWASM_EXPORT static void file_access_close_callback(const String &p_file, int p_flags);\n+\tWASM_EXPORT static void dir_access_remove_callback(const String &p_file);\n \tWASM_EXPORT static void fs_sync_callback();\n \tWASM_EXPORT static void update_pwa_state_callback();\n \n", "test_patch": "", "problem_statement": "[Web] Cannot remove files with `DirAccess.remove_absolute`\n### Tested versions\n\nReproducible: 4.4.dev5 and 4.4dev6\n\n### System information\n\nGodot v4.4.dev6 - Windows 10.0.22631 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 3060 Laptop GPU (NVIDIA; 32.0.15.6603) - 12th Gen Intel(R) Core(TM) i5-12500H (16 threads)\n\n### Issue description\n\n\nOn the exported project, I am creating a file in `user://` folder, then letting users remove it. `DirAccess.remove_absolute(filepath)` returns 0 (successful), but after restarting the scene Ctrl + Refresh, the file is seen there again. \n\n\n### Steps to reproduce\n\nList folders in `user://`, if empty create a file there.\n\nDelete using `DirAccess.remove_absolute(\"user://filename\")`.\nRestart the game via refresh button on the browser.\n\n```\nListing folder: user://\ntest.js:459 [\"text.txt\"]\ntest.js:459 File stored at: user://text.txt\ntest.js:459 Listing folder: user://\ntest.js:459 [\"text.txt\"]\ntest.js:459 Deleting: user://text.txt\ntest.js:459 Deleted user://text.txt\ntest.js:459 Listing folder: user://\ntest.js:459 []\n```\nAfter refreshing,\n\n```\nListing folder: user://\ntest.js:459 [\"text.txt\"]`\n```\n\nThe `text.txt` is still there.\n\n### Minimal reproduction project (MRP)\n\n[testbug.zip](https://github.com/user-attachments/files/18067479/testbug.zip)\n\nExport as web and launch it. Check the Dev Console.\n", "hints_text": "", "created_at": "2024-12-09 22:32:03", "merge_commit_sha": "89b18de032f8a92c890e7f7b01cf5305597052d9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100150", "base_commit": "aa8d9b83f66488dbb2c9c918e9016ef80f821fb4", "patch": "diff --git a/editor/export/codesign.cpp b/editor/export/codesign.cpp\nindex cc53068d4812..f02895fadf1c 100644\n--- a/editor/export/codesign.cpp\n+++ b/editor/export/codesign.cpp\n@@ -214,7 +214,7 @@ bool CodeSignCodeResources::add_nested_file(const String &p_root, const String &\n \n \tVector<String> files_to_add;\n \tif (LipO::is_lipo(p_exepath)) {\n-\t\tString tmp_path_name = EditorPaths::get_singleton()->get_cache_dir().path_join(\"_lipo\");\n+\t\tString tmp_path_name = EditorPaths::get_singleton()->get_temp_dir().path_join(\"_lipo\");\n \t\tError err = da->make_dir_recursive(tmp_path_name);\n \t\tERR_FAIL_COND_V_MSG(err != OK, false, vformat(\"CodeSign/CodeResources: Failed to create \\\"%s\\\" subfolder.\", tmp_path_name));\n \t\tLipO lip;\n@@ -1248,7 +1248,7 @@ Error CodeSign::_codesign_file(bool p_use_hardened_runtime, bool p_force, const\n \tVector<String> files_to_sign;\n \tif (LipO::is_lipo(main_exe)) {\n \t\tprint_verbose(vformat(\"CodeSign: Executable is fat, extracting...\"));\n-\t\tString tmp_path_name = EditorPaths::get_singleton()->get_cache_dir().path_join(\"_lipo\");\n+\t\tString tmp_path_name = EditorPaths::get_singleton()->get_temp_dir().path_join(\"_lipo\");\n \t\tError err = da->make_dir_recursive(tmp_path_name);\n \t\tif (err != OK) {\n \t\t\tr_error_msg = vformat(TTR(\"Failed to create \\\"%s\\\" subfolder.\"), tmp_path_name);\ndiff --git a/editor/export/editor_export_platform.cpp b/editor/export/editor_export_platform.cpp\nindex 72fa20f6716b..cb496fc9f09e 100644\n--- a/editor/export/editor_export_platform.cpp\n+++ b/editor/export/editor_export_platform.cpp\n@@ -1528,7 +1528,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t}\n \n \tString config_file = \"project.binary\";\n-\tString engine_cfb = EditorPaths::get_singleton()->get_cache_dir().path_join(\"tmp\" + config_file);\n+\tString engine_cfb = EditorPaths::get_singleton()->get_temp_dir().path_join(\"tmp\" + config_file);\n \tProjectSettings::get_singleton()->save_custom(engine_cfb, custom_map, custom_list);\n \tVector<uint8_t> data = FileAccess::get_file_as_bytes(engine_cfb);\n \tDirAccess::remove_file_or_error(engine_cfb);\n@@ -1832,9 +1832,9 @@ Error EditorExportPlatform::save_pack(const Ref<EditorExportPreset> &p_preset, b\n \n \t// Create the temporary export directory if it doesn't exist.\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n-\tda->make_dir_recursive(EditorPaths::get_singleton()->get_cache_dir());\n+\tda->make_dir_recursive(EditorPaths::get_singleton()->get_temp_dir());\n \n-\tString tmppath = EditorPaths::get_singleton()->get_cache_dir().path_join(\"packtmp\");\n+\tString tmppath = EditorPaths::get_singleton()->get_temp_dir().path_join(\"packtmp\");\n \tRef<FileAccess> ftmp = FileAccess::open(tmppath, FileAccess::WRITE);\n \tif (ftmp.is_null()) {\n \t\tadd_message(EXPORT_MESSAGE_ERROR, TTR(\"Save PCK\"), vformat(TTR(\"Cannot create file \\\"%s\\\".\"), tmppath));\n@@ -2094,7 +2094,7 @@ Error EditorExportPlatform::save_zip(const Ref<EditorExportPreset> &p_preset, bo\n \t\tp_save_func = _save_zip_file;\n \t}\n \n-\tString tmppath = EditorPaths::get_singleton()->get_cache_dir().path_join(\"packtmp\");\n+\tString tmppath = EditorPaths::get_singleton()->get_temp_dir().path_join(\"packtmp\");\n \n \tRef<FileAccess> io_fa;\n \tzlib_filefunc_def io = zipio_create_io(&io_fa);\ndiff --git a/platform/android/export/export_plugin.cpp b/platform/android/export/export_plugin.cpp\nindex 293044a8fa0c..cc0f75802b5f 100644\n--- a/platform/android/export/export_plugin.cpp\n+++ b/platform/android/export/export_plugin.cpp\n@@ -2085,7 +2085,7 @@ Error EditorExportPlatformAndroid::run(const Ref<EditorExportPreset> &p_preset,\n \t\tp_debug_flags.set_flag(DEBUG_FLAG_REMOTE_DEBUG_LOCALHOST);\n \t}\n \n-\tString tmp_export_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"tmpexport.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n+\tString tmp_export_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"tmpexport.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n \n #define CLEANUP_AND_RETURN(m_err)                         \\\n \t{                                                     \\\n@@ -3445,7 +3445,7 @@ Error EditorExportPlatformAndroid::export_project_helper(const Ref<EditorExportP\n \tRef<FileAccess> io2_fa;\n \tzlib_filefunc_def io2 = zipio_create_io(&io2_fa);\n \n-\tString tmp_unaligned_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"tmpexport-unaligned.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n+\tString tmp_unaligned_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"tmpexport-unaligned.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n \n #define CLEANUP_AND_RETURN(m_err)                            \\\n \t{                                                        \\\ndiff --git a/platform/ios/export/export_plugin.cpp b/platform/ios/export/export_plugin.cpp\nindex 742127a10e18..667c883e386a 100644\n--- a/platform/ios/export/export_plugin.cpp\n+++ b/platform/ios/export/export_plugin.cpp\n@@ -2433,7 +2433,7 @@ Error EditorExportPlatformIOS::_export_project_helper(const Ref<EditorExportPres\n \tif (p_preset->get(\"application/generate_simulator_library_if_missing\").operator bool()) {\n \t\tString sim_lib_path = dest_dir + String(binary_name + \".xcframework\").path_join(\"ios-arm64_x86_64-simulator\").path_join(\"libgodot.a\");\n \t\tString dev_lib_path = dest_dir + String(binary_name + \".xcframework\").path_join(\"ios-arm64\").path_join(\"libgodot.a\");\n-\t\tString tmp_lib_path = EditorPaths::get_singleton()->get_cache_dir().path_join(binary_name + \"_lipo_\");\n+\t\tString tmp_lib_path = EditorPaths::get_singleton()->get_temp_dir().path_join(binary_name + \"_lipo_\");\n \t\tuint32_t cputype = 0;\n \t\tuint32_t cpusubtype = 0;\n \t\tif (!_archive_has_arm64(sim_lib_path, &cputype, &cpusubtype) && _archive_has_arm64(dev_lib_path) && FileAccess::exists(dev_lib_path)) {\n@@ -3111,19 +3111,19 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \tString id = \"tmpexport.\" + uitos(OS::get_singleton()->get_unix_time());\n \n \tRef<DirAccess> filesystem_da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n-\tERR_FAIL_COND_V_MSG(filesystem_da.is_null(), ERR_CANT_CREATE, \"Cannot create DirAccess for path '\" + EditorPaths::get_singleton()->get_cache_dir() + \"'.\");\n-\tfilesystem_da->make_dir_recursive(EditorPaths::get_singleton()->get_cache_dir().path_join(id));\n-\tString tmp_export_path = EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.ipa\");\n-\n-#define CLEANUP_AND_RETURN(m_err)                                                                           \\\n-\t{                                                                                                       \\\n-\t\tif (filesystem_da->change_dir(EditorPaths::get_singleton()->get_cache_dir().path_join(id)) == OK) { \\\n-\t\t\tfilesystem_da->erase_contents_recursive();                                                      \\\n-\t\t\tfilesystem_da->change_dir(\"..\");                                                                \\\n-\t\t\tfilesystem_da->remove(id);                                                                      \\\n-\t\t}                                                                                                   \\\n-\t\treturn m_err;                                                                                       \\\n-\t}                                                                                                       \\\n+\tERR_FAIL_COND_V_MSG(filesystem_da.is_null(), ERR_CANT_CREATE, \"Cannot create DirAccess for path '\" + EditorPaths::get_singleton()->get_temp_dir() + \"'.\");\n+\tfilesystem_da->make_dir_recursive(EditorPaths::get_singleton()->get_temp_dir().path_join(id));\n+\tString tmp_export_path = EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.ipa\");\n+\n+#define CLEANUP_AND_RETURN(m_err)                                                                          \\\n+\t{                                                                                                      \\\n+\t\tif (filesystem_da->change_dir(EditorPaths::get_singleton()->get_temp_dir().path_join(id)) == OK) { \\\n+\t\t\tfilesystem_da->erase_contents_recursive();                                                     \\\n+\t\t\tfilesystem_da->change_dir(\"..\");                                                               \\\n+\t\t\tfilesystem_da->remove(id);                                                                     \\\n+\t\t}                                                                                                  \\\n+\t\treturn m_err;                                                                                      \\\n+\t}                                                                                                      \\\n \t((void)0)\n \n \tDevice dev = devices[p_device];\n@@ -3193,7 +3193,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\targs.push_back(\"simctl\");\n \t\t\targs.push_back(\"install\");\n \t\t\targs.push_back(dev.id);\n-\t\t\targs.push_back(EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n+\t\t\targs.push_back(EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n \n \t\t\tString log;\n \t\t\tint ec;\n@@ -3246,7 +3246,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\targs.push_back(dev.id);\n \t\t\targs.push_back(\"--justlaunch\");\n \t\t\targs.push_back(\"--bundle\");\n-\t\t\targs.push_back(EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n+\t\t\targs.push_back(EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n \t\t\tString app_args;\n \t\t\tfor (const String &E : cmd_args_list) {\n \t\t\t\tapp_args += E + \" \";\n@@ -3285,7 +3285,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\targs.push_back(\"app\");\n \t\t\targs.push_back(\"-d\");\n \t\t\targs.push_back(dev.id);\n-\t\t\targs.push_back(EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n+\t\t\targs.push_back(EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n \n \t\t\tString log;\n \t\t\tint ec;\ndiff --git a/platform/linuxbsd/export/export_plugin.cpp b/platform/linuxbsd/export/export_plugin.cpp\nindex 7cd77dd5937c..9362aee5e4cf 100644\n--- a/platform/linuxbsd/export/export_plugin.cpp\n+++ b/platform/linuxbsd/export/export_plugin.cpp\n@@ -88,7 +88,7 @@ Error EditorExportPlatformLinuxBSD::export_project(const Ref<EditorExportPreset>\n \n \t// Setup temp folder.\n \tString path = p_path;\n-\tString tmp_dir_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name);\n+\tString tmp_dir_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name);\n \n \tRef<DirAccess> tmp_app_dir = DirAccess::create_for_path(tmp_dir_path);\n \tif (export_as_zip) {\n@@ -468,7 +468,7 @@ Error EditorExportPlatformLinuxBSD::run(const Ref<EditorExportPreset> &p_preset,\n \n \tEditorProgress ep(\"run\", TTR(\"Running...\"), 5);\n \n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"linuxbsd\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"linuxbsd\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\ndiff --git a/platform/macos/export/export_plugin.cpp b/platform/macos/export/export_plugin.cpp\nindex b9f9d8d613a8..d795adbe33b2 100644\n--- a/platform/macos/export/export_plugin.cpp\n+++ b/platform/macos/export/export_plugin.cpp\n@@ -1592,7 +1592,7 @@ Error EditorExportPlatformMacOS::export_project(const Ref<EditorExportPreset> &p\n \t\ttmp_app_path_name = p_path;\n \t\tscr_path = p_path.get_basename() + \".command\";\n \t} else {\n-\t\ttmp_base_path_name = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name);\n+\t\ttmp_base_path_name = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name);\n \t\ttmp_app_path_name = tmp_base_path_name.path_join(tmp_app_dir_name);\n \t\tscr_path = tmp_base_path_name.path_join(pkg_name + \".command\");\n \t}\n@@ -1987,9 +1987,9 @@ Error EditorExportPlatformMacOS::export_project(const Ref<EditorExportPreset> &p\n \n \t\tbool sandbox = p_preset->get(\"codesign/entitlements/app_sandbox/enabled\");\n \t\tString ent_path = p_preset->get(\"codesign/entitlements/custom_file\");\n-\t\tString hlp_ent_path = sandbox ? EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name + \"_helper.entitlements\") : ent_path;\n+\t\tString hlp_ent_path = sandbox ? EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name + \"_helper.entitlements\") : ent_path;\n \t\tif (sign_enabled && (ent_path.is_empty())) {\n-\t\t\tent_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name + \".entitlements\");\n+\t\t\tent_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name + \".entitlements\");\n \n \t\t\tRef<FileAccess> ent_f = FileAccess::open(ent_path, FileAccess::WRITE);\n \t\t\tif (ent_f.is_valid()) {\n@@ -2269,7 +2269,7 @@ Error EditorExportPlatformMacOS::export_project(const Ref<EditorExportPreset> &p\n \t\t} else if (export_format == \"app\" && noto_enabled) {\n \t\t\t// Create temporary ZIP.\n \t\t\tif (err == OK) {\n-\t\t\t\tnoto_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name + \".zip\");\n+\t\t\t\tnoto_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name + \".zip\");\n \n \t\t\t\tif (ep.step(TTR(\"Making ZIP\"), 3)) {\n \t\t\t\t\treturn ERR_SKIP;\n@@ -2554,7 +2554,7 @@ Error EditorExportPlatformMacOS::run(const Ref<EditorExportPreset> &p_preset, in\n \n \tEditorProgress ep(\"run\", TTR(\"Running...\"), 5);\n \n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"macos\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"macos\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\ndiff --git a/platform/web/export/editor_http_server.cpp b/platform/web/export/editor_http_server.cpp\nindex 9cf862eb1ed1..26b9a626db05 100644\n--- a/platform/web/export/editor_http_server.cpp\n+++ b/platform/web/export/editor_http_server.cpp\n@@ -86,7 +86,7 @@ void EditorHTTPServer::_send_response() {\n \n \tconst String req_file = path.get_file();\n \tconst String req_ext = path.get_extension();\n-\tconst String cache_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"web\");\n+\tconst String cache_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"web\");\n \tconst String filepath = cache_path.path_join(req_file);\n \n \tif (!mimes.has(req_ext) || !FileAccess::exists(filepath)) {\ndiff --git a/platform/web/export/export_plugin.cpp b/platform/web/export/export_plugin.cpp\nindex 9e60a76fdc2c..9d212d81ffe9 100644\n--- a/platform/web/export/export_plugin.cpp\n+++ b/platform/web/export/export_plugin.cpp\n@@ -817,7 +817,7 @@ Error EditorExportPlatformWeb::run(const Ref<EditorExportPreset> &p_preset, int\n }\n \n Error EditorExportPlatformWeb::_export_project(const Ref<EditorExportPreset> &p_preset, int p_debug_flags) {\n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"web\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"web\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\ndiff --git a/platform/windows/export/export_plugin.cpp b/platform/windows/export/export_plugin.cpp\nindex 8d3f4bb26911..65fbc59310fb 100644\n--- a/platform/windows/export/export_plugin.cpp\n+++ b/platform/windows/export/export_plugin.cpp\n@@ -257,7 +257,7 @@ Error EditorExportPlatformWindows::export_project(const Ref<EditorExportPreset>\n \n \t// Setup temp folder.\n \tString path = p_path;\n-\tString tmp_dir_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name);\n+\tString tmp_dir_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name);\n \tRef<DirAccess> tmp_app_dir = DirAccess::create_for_path(tmp_dir_path);\n \tif (export_as_zip) {\n \t\tif (tmp_app_dir.is_null()) {\n@@ -501,7 +501,7 @@ Error EditorExportPlatformWindows::_rcedit_add_data(const Ref<EditorExportPreset\n \t\t}\n \t}\n \n-\tString tmp_icon_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"_rcedit.ico\");\n+\tString tmp_icon_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"_rcedit.ico\");\n \tif (!icon_path.is_empty()) {\n \t\tif (_process_icon(p_preset, icon_path, tmp_icon_path) != OK) {\n \t\t\tadd_message(EXPORT_MESSAGE_WARNING, TTR(\"Resources Modification\"), vformat(TTR(\"Invalid icon file \\\"%s\\\".\"), icon_path));\n@@ -1004,7 +1004,7 @@ Error EditorExportPlatformWindows::run(const Ref<EditorExportPreset> &p_preset,\n \n \tEditorProgress ep(\"run\", TTR(\"Running...\"), 5);\n \n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"windows\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"windows\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\n", "test_patch": "", "problem_statement": "Cannot export project when $HOME is readonly\n### Tested versions\n\n- Tested on Godot 4.3-stable [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - NixOS #1-NixOS SMP PREEMPT_DYNAMIC Wed Aug 14 11:59:04 UTC 2024 - Wayland - Vulkan (Forward+) - integrated Intel(R) HD Graphics 4600 (HSW GT2) - Intel(R) Core(TM) i5-4210M CPU @ 2.60GHz (4 Threads)\n\n### Issue description\n\nWhen $HOME is readonly or otherwise invalid (e.g /var/empty, /dev/null) exporting a project fails.\r\nCommand ran `godot --headless --export-debug \"Linux\"`\r\n\r\nThis matters for CI builds where build users may set $HOME to /var/empty to avoid using the root user.\n\n### Steps to reproduce\n\nCreate the default Linux export template\r\nSet $HOME to a readonly/invalid path (/var/empty, /dev/null both tested to fail)\r\nExecute `godot --headless --export-debug \"Linux\"`\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2024-12-07 18:07:08", "merge_commit_sha": "6cbf7c77c2994ca9f57c4aa6f63b3d991cb584d7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100125", "base_commit": "aa8d9b83f66488dbb2c9c918e9016ef80f821fb4", "patch": "diff --git a/drivers/gles3/shaders/scene.glsl b/drivers/gles3/shaders/scene.glsl\nindex 2022c8ee436f..1867930b2922 100644\n--- a/drivers/gles3/shaders/scene.glsl\n+++ b/drivers/gles3/shaders/scene.glsl\n@@ -974,6 +974,10 @@ layout(std140) uniform MultiviewData { // ubo:8\n multiview_data;\n #endif\n \n+uniform highp mat4 world_transform;\n+uniform highp uint instance_offset;\n+uniform highp uint model_flags;\n+\n /* clang-format off */\n \n #GLOBALS\n@@ -1199,10 +1203,7 @@ ivec2 multiview_uv(ivec2 uv) {\n }\n #endif\n \n-uniform highp mat4 world_transform;\n uniform mediump float opaque_prepass_threshold;\n-uniform highp uint model_flags;\n-uniform highp uint instance_offset;\n \n #if defined(RENDER_MATERIAL)\n layout(location = 0) out vec4 albedo_output_buffer;\n", "test_patch": "", "problem_statement": "Shader with instance uniforms fails in compatibility\n### Tested versions\n\nv4.4.dev4.official [36e6207bb]\n\n\n### System information\n\nGodot v4.4.dev4 - Windows 10.0.22631 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6094) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nAttached project uses both a global and 2 instance uniforms.\n\nActual error is: \n```\nE 0:00:01:0046   _display_error_with_code: SceneShaderGLES3: Fragment shader compilation failed:\n0(445) : error C1503: undefined variable \"instance_offset\"\n```\n\nLooks like definition is after use.\nFrom the output log (filtered by instance_offset):\n```\n445: \t\tvec2 m_d=vec2((((global_shader_uniforms[m_iTime].x) * 0.00050000002375) + (global_shader_uniforms[(instance_offset+1u)].x)), 0.0);\n672: uniform highp uint instance_offset;\n```\n\n\n\n### Steps to reproduce\n\nRun attached project.\n\n\n### Minimal reproduction project (MRP)\n\n[instance-test.zip](https://github.com/user-attachments/files/18031254/instance-test.zip)\n\n", "hints_text": "looked into this a little bit and correct me if i'm wrong but i believe the error is coming from one of these function calls\nhttps://github.com/godotengine/godot/blob/eb5103093c1bfd4d527ec1255d28e9bc8d3625b5/drivers/gles3/shader_gles3.cpp#L373-L376\nwhich are OpenGL functions. not too sure how to proceed from here\nIt's a shader source compile error. Godot generates the shader code from a template. See https://github.com/godotengine/godot/blob/master/drivers/gles3/shaders/scene.glsl\n\nIf I move the declaration for instance_offset up, it works. \nI can make a PR for the diff below, but I'm not sure if I moved it to a \"good\" place (right after scene_data) and/or if the other variables in that block should maybe be moved, too.\n\n```\ndiff --git a/drivers/gles3/shaders/scene.glsl b/drivers/gles3/shaders/scene.glsl\nindex 2022c8ee43..778c4f953d 100644\n--- a/drivers/gles3/shaders/scene.glsl\n+++ b/drivers/gles3/shaders/scene.glsl\n@@ -206,6 +206,8 @@ layout(std140) uniform SceneData { // ubo:2\n }\n scene_data;\n \n+uniform highp uint instance_offset;\n+\n #ifdef USE_ADDITIVE_LIGHTING\n \n #if defined(ADDITIVE_OMNI) || defined(ADDITIVE_SPOT)\n@@ -430,7 +432,6 @@ uniform highp mat4 world_transform;\n uniform highp vec3 compressed_aabb_position;\n uniform highp vec3 compressed_aabb_size;\n uniform highp vec4 uv_scale;\n-uniform highp uint instance_offset;\n \n uniform highp uint model_flags;\n \n@@ -965,6 +966,8 @@ layout(std140) uniform SceneData { // ubo:2\n }\n scene_data;\n \n+uniform highp uint instance_offset;\n+\n #ifdef USE_MULTIVIEW\n layout(std140) uniform MultiviewData { // ubo:8\n        highp mat4 projection_matrix_view[MAX_VIEWS];\n@@ -1202,7 +1205,6 @@ ivec2 multiview_uv(ivec2 uv) {\n uniform highp mat4 world_transform;\n uniform mediump float opaque_prepass_threshold;\n uniform highp uint model_flags;\n-uniform highp uint instance_offset;\n \n #if defined(RENDER_MATERIAL)\n layout(location = 0) out vec4 albedo_output_buffer;\n```", "created_at": "2024-12-06 22:53:22", "merge_commit_sha": "736dcf72ccda9901411f19bd42d4fd5b9f8374f6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100069", "base_commit": "aa8d9b83f66488dbb2c9c918e9016ef80f821fb4", "patch": "diff --git a/editor/editor_settings_dialog.cpp b/editor/editor_settings_dialog.cpp\nindex 8989b9cf9b9b..2f7dfe16072e 100644\n--- a/editor/editor_settings_dialog.cpp\n+++ b/editor/editor_settings_dialog.cpp\n@@ -314,6 +314,10 @@ void EditorSettingsDialog::_event_config_confirmed() {\n \n void EditorSettingsDialog::_update_builtin_action(const String &p_name, const Array &p_events) {\n \tArray old_input_array = EditorSettings::get_singleton()->get_builtin_action_overrides(p_name);\n+\tif (old_input_array.is_empty()) {\n+\t\tList<Ref<InputEvent>> defaults = InputMap::get_singleton()->get_builtins_with_feature_overrides_applied()[current_edited_identifier];\n+\t\told_input_array = _event_list_to_array_helper(defaults);\n+\t}\n \n \tEditorUndoRedoManager *undo_redo = EditorUndoRedoManager::get_singleton();\n \tundo_redo->create_action(vformat(TTR(\"Edit Built-in Action: %s\"), p_name));\n@@ -321,11 +325,11 @@ void EditorSettingsDialog::_update_builtin_action(const String &p_name, const Ar\n \tundo_redo->add_undo_method(EditorSettings::get_singleton(), \"mark_setting_changed\", \"builtin_action_overrides\");\n \tundo_redo->add_do_method(EditorSettings::get_singleton(), \"set_builtin_action_override\", p_name, p_events);\n \tundo_redo->add_undo_method(EditorSettings::get_singleton(), \"set_builtin_action_override\", p_name, old_input_array);\n+\tundo_redo->add_do_method(this, \"_update_shortcuts\");\n+\tundo_redo->add_undo_method(this, \"_update_shortcuts\");\n \tundo_redo->add_do_method(this, \"_settings_changed\");\n \tundo_redo->add_undo_method(this, \"_settings_changed\");\n \tundo_redo->commit_action();\n-\n-\t_update_shortcuts();\n }\n \n void EditorSettingsDialog::_update_shortcut_events(const String &p_path, const Array &p_events) {\n", "test_patch": "", "problem_statement": "Editor Settings Shortcuts: Undoing changes to built-in actions creates empty action\n### Tested versions\n\nv4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.22631 - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 980 Ti (NVIDIA; 32.0.15.6603) - 13th Gen Intel(R) Core(TM) i7-13700K (24 Threads)\n\n### Issue description\n\nTwo issues happen when undoing/redoing changes to the built-in actions in the Shortcuts list:\n \n1. Undo/redo have a 1 second delay\n2. Undoing back to the default shortcut results in an empty shortcut rather than the default.\n\nhttps://github.com/user-attachments/assets/b24c9694-a1d1-4979-9b5e-63cc22127cc2\n\n\n\n### Steps to reproduce\n\n- Change one of the built-in editor shortcuts\n- Undo with Ctrl-Z\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2024-12-05 20:16:46", "merge_commit_sha": "4d77bbf4907fdffc43cbf3d46c35bf6f6bd9371e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31998", "base_commit": "502d47203e7e10b273c66e5a2ee7bb1d67593dc0", "patch": "diff --git a/depends/packages/capnp.mk b/depends/packages/capnp.mk\nindex 7f41d3b5a4ed3..dff92d9e61fe8 100644\n--- a/depends/packages/capnp.mk\n+++ b/depends/packages/capnp.mk\n@@ -4,6 +4,7 @@ $(package)_download_path=$(native_$(package)_download_path)\n $(package)_download_file=$(native_$(package)_download_file)\n $(package)_file_name=$(native_$(package)_file_name)\n $(package)_sha256_hash=$(native_$(package)_sha256_hash)\n+$(package)_patches=abi_placement_new.patch\n \n define $(package)_set_vars :=\n   $(package)_config_opts := -DBUILD_TESTING=OFF\n@@ -12,6 +13,10 @@ define $(package)_set_vars :=\n   $(package)_cxxflags += -fdebug-prefix-map=$($(package)_extract_dir)=/usr -fmacro-prefix-map=$($(package)_extract_dir)=/usr\n endef\n \n+define $(package)_preprocess_cmds\n+  patch -p2 < $($(package)_patch_dir)/abi_placement_new.patch\n+endef\n+\n define $(package)_config_cmds\n   $($(package)_cmake) .\n endef\ndiff --git a/depends/patches/capnp/abi_placement_new.patch b/depends/patches/capnp/abi_placement_new.patch\nnew file mode 100644\nindex 0000000000000..9aef85db8e86b\n--- /dev/null\n+++ b/depends/patches/capnp/abi_placement_new.patch\n@@ -0,0 +1,71 @@\n+From 74560f26f75dda4257dce541ca362a1e763b2971 Mon Sep 17 00:00:00 2001\n+From: Ryan Ofsky <ryan@ofsky.org>\n+Date: Thu, 6 Feb 2025 08:39:05 -0500\n+Subject: [PATCH 1/1] Avoid gcc/clang ABI incompatibility caused by\n+ PlacementNew\n+\n+GCC and clang do not use same calling convention for passing empty struct\n+parameters. There is more information about this in\n+https://itanium-cxx-abi.github.io/cxx-abi/cxx-abi-dev/archives/2015-December/002869.html\n+\n+Unfortunately this can create an issue in capnproto if it is built without\n+optimizations in GCC, and the resulting static libraries are used in a clang\n+program, or vice versa.\n+\n+Depending on what order libraries are specified on the linker command line, and\n+whether code compiled with the other compiler is calling any header functions\n+that cause weak a `operator new(unsigned int, kj::_::PlacementNew, void*)`\n+symbol to be defined in its own objects, this can cause the linker to link a\n+GCC-generated `kj::ctor` with a clang-generated `operator new`, and the\n+resulting program to crash due to the compilers using different calling\n+conventions for `operator new`.\n+\n+This problem is difficult to avoid in general, but pretty easy to avoid here by\n+changing `operator new` parameter order so the empty struct parameter is last.\n+\n+This change should be beneficial for capnproto users that may be compiling it\n+without optimizations, and not necessarily using a single compiler to build all\n+their dependencies.\n+\n+The problem does not occur if any optimizations are enabled because `operator\n+new` calls are inlined in that case.\n+---\n+ c++/src/kj/common.h | 11 +++++++----\n+ 1 file changed, 7 insertions(+), 4 deletions(-)\n+\n+diff --git a/c++/src/kj/common.h b/c++/src/kj/common.h\n+index b8edde3c..28ab11d6 100644\n+--- a/c++/src/kj/common.h\n++++ b/c++/src/kj/common.h\n+@@ -1034,24 +1034,27 @@ private:\n+ \n+ // We want placement new, but we don't want to #include <new>.  operator new cannot be defined in\n+ // a namespace, and defining it globally conflicts with the definition in <new>.  So we have to\n+-// define a dummy type and an operator new that uses it.\n++// define a dummy type and an operator new that uses it.  The dummy type is intentionally passed\n++// as the last parameter so clang and GCC ABI calling conventions for empty struct struct parameters\n++// are compatible, and there are not segfaults trying to call clang operator new/delete from GCC or\n++// vice versa.\n+ \n+ namespace _ {  // private\n+ struct PlacementNew {};\n+ }  // namespace _ (private)\n+ } // namespace kj\n+ \n+-inline void* operator new(size_t, kj::_::PlacementNew, void* __p) noexcept {\n++inline void* operator new(size_t, void* __p, kj::_::PlacementNew) noexcept {\n+   return __p;\n+ }\n+ \n+-inline void operator delete(void*, kj::_::PlacementNew, void* __p) noexcept {}\n++inline void operator delete(void*, void* __p, kj::_::PlacementNew) noexcept {}\n+ \n+ namespace kj {\n+ \n+ template <typename T, typename... Params>\n+ inline void ctor(T& location, Params&&... params) {\n+-  new (_::PlacementNew(), &location) T(kj::fwd<Params>(params)...);\n++  new (&location, _::PlacementNew()) T(kj::fwd<Params>(params)...);\n+ }\n+ \n+ template <typename T>\n", "test_patch": "", "problem_statement": "test: 32-bit Clang `ipc_test` failure at `-O0`\nNoticed as part of this branch #29796, however it can also be reproduced with master (8fa10edcd1706a1f0dc9d8c3adbc8efa3c7755bf) by reproducing the equivalent CI & setting C(XX)FLAGS to -O0:\n```bash\nmake -C depends/ MULTIPROCESS=1 NO_QT=1 NO_WALLET=1 NO_ZMQ=1 NO_USDT=1 CFLAGS=\"-O0\" CXXFLAGS=\"-O0\" DEBUG=1 -j19 HOST=i686-pc-linux-gnu\ncmake -B build --toolchain /root/ci_scratch/depends/i686-pc-linux-gnu/toolchain.cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER='clang;-m32' -DCMAKE_CXX_COMPILER='clang++;-m32'\ncmake --build build -j18\n```\n\n```bash\n./build/src/test/test_bitcoin --run_test=ipc*\nRunning 2 test cases...\nterminate called after throwing an instance of 'kj::ExceptionImpl'\n  what():  /root/ci_scratch/depends/i686-pc-linux-gnu/include/kj/common.h:1797: failed: expected start <= end && end <= size_; Out-of-bounds ArrayPtr::slice().\nstack: 5ca0dd6d 5c78b5db 5c8cc599 5ca0adc9 5c94fb37 5c950070 5c9cd709 5c9cf58a 5c9d72fd 5c9d025e 5c776f11 5bf6351d 5bf6347d 5bf633cd 5bf6337b 5bf6331d 5bf63194 f7afa4b0 f773dff6 f77d55b7\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\nunknown location(0): fatal error: in \"ipc_tests/ipc_tests\": signal: SIGABRT (application abort requested)\ntest/ipc_tests.cpp(12): last checkpoint: \"ipc_tests\" test entry\ntest_bitcoin: common/args.cpp:578: void ArgsManager::AddArg(const std::string &, const std::string &, unsigned int, const OptionsCategory &): Assertion `ret.second' failed.\nunknown location(0): fatal error: in \"ipc_tests/parse_address_test\": signal: SIGABRT (application abort requested)\ntest/ipc_tests.cpp(20): last checkpoint: \"parse_address_test\" fixture ctor\n\n*** 2 failures are detected in the test module \"Bitcoin Core Test Suite\"\n```\n", "hints_text": "cc @ryanofsky \nI tried those steps except I left off the ` -DCMAKE_C_COMPILER='clang;-m32' -DCMAKE_CXX_COMPILER='clang++;-m32'` part and the test passed without a problem.\n\nIs the clang part important? It seems odd to use gcc for the depends build and clang for the bitcoin build, and when when I tried the adding the clang arguments specified, cmake complained about not being able to find libstdc++, which maybe makes sense because, I don't know if it is supposed to work with the gnu library.\n\nIf there are any easier steps to reproduce this maybe using docker, or just a CI run I can look at that would be helpful. I ran into countless problems just getting i686 default build to work at all on my machine, so it is hard to know what things may be particular to the configuration this is happening in.\n> If there are any easier steps to reproduce this maybe using docker,\n\nRunning `time env -i HOME=\"$HOME\" PATH=\"$PATH\" USER=\"$USER\" bash -c 'FILE_ENV=\"./ci/test/00_setup_env_i686_multiprocess.sh\" ./ci/test_run_all.sh'` with the branch from #29796.\n\n> or just a CI run I can look at that would be helpful.\n\nhttps://github.com/bitcoin/bitcoin/pull/29796/checks?check_run_id=36485685971\nThanks was able to get a stack trace by running `cd /ci_container_base/ci/scratch/build-i686-pc-linux-gnu`, `gdb -ex run --args ./src/test/test_bitcoin -t ipc_tests`, and `bt` in container:\n\n```c++\n#0  0xf7f4b5b9 in __kernel_vsyscall ()\n#1  0xf79e6037 in ?? () from /lib32/libc.so.6\n#2  0xf7994c51 in raise () from /lib32/libc.so.6\n#3  0xf797c2b7 in abort () from /lib32/libc.so.6\n#4  0xf7d4bf71 in ?? () from /lib32/libstdc++.so.6\n#5  0xf7d65a97 in ?? () from /lib32/libstdc++.so.6\n#6  0xf7d4b8f9 in std::terminate() () from /lib32/libstdc++.so.6\n#7  0xf7d65ddc in __cxa_throw () from /lib32/libstdc++.so.6\n#8  0x597d7e12 in kj::ExceptionCallback::RootExceptionCallback::onFatalException (this=0x5c8344b0, exception=...) at /usr/src/kj/exception.c++:1107\n#9  0x597d6085 in kj::throwFatalException (exception=..., ignoreCount=1) at /usr/src/kj/exception.c++:1194\n#10 0x597d05e5 in kj::_::Debug::Fault::fatal (this=0xf75cbc28) at /usr/src/kj/debug.c++:371\n#11 0x597cf19a in kj::_::inlineRequireFailure (file=0x59e9a314 \"/ci_container_base/depends/i686-pc-linux-gnu/include/kj/common.h\", line=1797, expectation=0x59e9a2f7 \"start <= end && end <= size_\", \n    macroArgs=0x59e9a2d4 \"\\\"Out-of-bounds ArrayPtr::slice().\\\"\", message=0x59e9a2b0 \"Out-of-bounds ArrayPtr::slice().\") at /usr/src/kj/common.c++:36\n#12 0x5954afc8 in kj::ArrayPtr<char const>::slice (this=0xf75cbd54, start=1498659230, end=13) at /usr/src/kj/common.h:1797\n#13 0x5968bd88 in kj::StringPtr::slice (this=0xf75cbd54, start=1498659230) at /usr/src/kj/string.h:734\n#14 0x597cc1e4 in kj::CidrRange::CidrRange (this=0x5a9ddc80 <kj::_::reservedCidrs()::result>, pattern=...) at /usr/src/kj/cidr.c++:53\n#15 0x597105fe in kj::_::reservedCidrs () at /usr/src/kj/async-io.c++:3007\n#16 0x59710b37 in kj::_::NetworkFilter::NetworkFilter (this=0x5c838b70) at /usr/src/kj/async-io.c++:3038\n#17 0x5978e80c in kj::(anonymous namespace)::SocketNetwork::SocketNetwork (this=0x5c838b68, lowLevel=...) at /usr/src/kj/async-io-unix.c++:1742\n#18 0x5979068d in kj::(anonymous namespace)::AsyncIoProviderImpl::AsyncIoProviderImpl (this=0x5c838b60, lowLevel=...) at /usr/src/kj/async-io-unix.c++:1974\n#19 0x59798404 in kj::heap<kj::(anonymous namespace)::AsyncIoProviderImpl, kj::(anonymous namespace)::LowLevelAsyncIoProviderImpl&> () at /usr/src/kj/memory.h:609\n#20 0x59791361 in kj::setupAsyncIo () at /usr/src/kj/async-io-unix.c++:2058\n#21 0x595373c2 in mp::EventLoop::EventLoop(char const*, std::function<void (bool, std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >)>, void*) (this=0xf75cc110, \n    exe_name=0x59b257f6 \"IpcPipeTest\", log_fn=..., context=0x0) at /usr/src/mp/proxy.cpp:158\n#22 0x58a4064e in IpcPipeTest()::$_0::operator()() const (this=0x5c8542d4) at ./test/ipc_test.cpp:60\n#23 0x58a405ae in std::__invoke_impl<void, IpcPipeTest()::$_0>(std::__invoke_other, IpcPipeTest()::$_0&&) (__f=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/13/../../../../include/c++/13/bits/invoke.h:61\n#24 0x58a404fe in std::__invoke<IpcPipeTest()::$_0>(IpcPipeTest()::$_0&&) (__fn=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/13/../../../../include/c++/13/bits/invoke.h:96\n#25 0x58a404ac in std::thread::_Invoker<std::tuple<IpcPipeTest()::$_0> >::_M_invoke<0u>(std::_Index_tuple<0u>) (this=0x5c8542d4)\n    at /usr/bin/../lib/gcc/x86_64-linux-gnu/13/../../../../include/c++/13/bits/std_thread.h:292\n#26 0x58a4044e in std::thread::_Invoker<std::tuple<IpcPipeTest()::$_0> >::operator()() (this=0x5c8542d4) at /usr/bin/../lib/gcc/x86_64-linux-gnu/13/../../../../include/c++/13/bits/std_thread.h:299\n#27 0x58a402c5 in std::thread::_State_impl<std::thread::_Invoker<std::tuple<IpcPipeTest()::$_0> > >::_M_run() (this=0x5c8542d0)\n    at /usr/bin/../lib/gcc/x86_64-linux-gnu/13/../../../../include/c++/13/bits/std_thread.h:244\n#28 0xf7d98d21 in ?? () from /lib32/libstdc++.so.6\n#29 0xf79e4157 in ?? () from /lib32/libc.so.6\n#30 0xf7a78e08 in ?? () from /lib32/libc.so.6\n```\nStack trace seems to be showing something going wrong in capnproto code, but unclear what the cause is. The crash is happening in the CidrRange::CidrRange constructor here:\n\nhttps://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/cidr.c%2B%2B#L53\n\nwhich is being called on a static list of address patterns:\n\nhttps://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/async-io.c%2B%2B#L2999-L3007\n\nAll of the patterns look valid so no reason there should be a parsing exception like seems to be happening. It seems like this might be a more strange compiler / build issue\ngdb shows invalid results being returned from `pattern.findFirst('/')` call where pattern is `192.0.0.0/24`\n\nhttps://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/cidr.c%2B%2B#L51C48-L51C57\n\n```\n#14 0x5971f1e4 in kj::CidrRange::CidrRange (this=0x5a930c80 <kj::_::reservedCidrs()::result>, pattern=...) at /usr/src/kj/cidr.c++:53\n(gdb) p pattern\n$6 = {content = {<kj::DisallowConstCopyIfNotConst<char const>> = {<No data fields>}, ptr = 0x59e13a45 \"192.0.0.0/24\", size_ = 13}}\n(gdb) p slashPos\n$7 = 1497950621\n(gdb) p pattern.findFirst('/')\n$8 = {ptr = {isSet = true, {value = 2155537998}}}\n```\nI thought I tracked down the problem, and some change I made to the test caused it to pass, but rerunning the the fix in a new container, it no longer works, so I have to go back.\n\nHere were notes I was about to post about potential problem & fix. In any case I suspect problem would be avoided if we just consistently used gcc or clang for this build and didn't try to mix them.\n\n---\n\nTest failure seems to be caused by the container using incompatible ABI versions for the depends build and the main build. The depends build is using gcc with ABI version 18:\n\n```bash\ngcc -E -x c++ - -dM <<< \"\" | grep ABI\n#define __GXX_ABI_VERSION 1018\n```\n\nThe bitcoin build is using clang with ABI version 2:\n\n```bash\nclang++ -E -x c++ - -dM <<< \"\" | grep ABI\n#define __GXX_ABI_VERSION 1002\n```\n\nIn clang, the ABI version is determined when the compiler is built, but in gcc you can control it with the `-fabi-version` option, so the following change seems to fix the build:\n\n```diff\n--- a/depends/hosts/linux.mk\n+++ b/depends/hosts/linux.mk\n@@ -1,5 +1,5 @@\n linux_CFLAGS=-pipe -std=$(C_STANDARD)\n-linux_CXXFLAGS=-pipe -std=$(CXX_STANDARD)\n+linux_CXXFLAGS=-pipe -std=$(CXX_STANDARD) -fabi-version=2\n \n ifneq ($(LTO),)\n linux_AR = $(host_toolchain)gcc-ar\n--- a/depends/packages/libmultiprocess.mk\n+++ b/depends/packages/libmultiprocess.mk\n@@ -27,3 +27,5 @@ endef\n define $(package)_stage_cmds\n   $(MAKE) DESTDIR=$($(package)_staging_dir) install-lib\n endef\n+\n+$(package)_cxxflags += -fabi-version=11\n\n```\n\nFirst part of the diff setting ` -fabi-version=2` in the depends build is the main fix. The second part of the diff setting ` -fabi-version=11` is a workaround for an issue that happened specifically with the multiprocess package. Because when `-fabi-version` is set to 10 or below there is a compile error:\n\n\n<details><summary>error: no matching function for call to \u2018std::__uniq_ptr_data</summary>\n<p>\n\n```c++\n[ 20%] Building CXX object CMakeFiles/mputil.dir/src/mp/util.cpp.o\nIn file included from /usr/include/c++/13/bits/shared_ptr_base.h:59,\n                 from /usr/include/c++/13/bits/shared_ptr.h:53,\n                 from /usr/include/c++/13/condition_variable:45,\n                 from /usr/include/c++/13/future:41,\n                 from /ci_container_base/depends/work/build/i686-pc-linux-gnu/libmultiprocess/07c917f7ca910d66abc6d3873162fc9061704074-722fc6d9234/include/mp/util.h:11,\n                 from /ci_container_base/depends/work/build/i686-pc-linux-gnu/libmultiprocess/07c917f7ca910d66abc6d3873162fc9061704074-722fc6d9234/src/mp/util.cpp:6:\n/usr/include/c++/13/bits/unique_ptr.h: In instantiation of \u2018constexpr std::unique_ptr<_Tp, _Dp>::unique_ptr() [with _Del = std::__future_base::_Result_base::_Deleter; <template-parameter-2-2> = void; _Tp = std::__future_base::_Result_base; _Dp = std::__future_base::_Result_base::_Deleter]\u2019:\n/usr/include/c++/13/future:340:34:   required from here\n/usr/include/c++/13/bits/unique_ptr.h:305:11: error: no matching function for call to \u2018std::__uniq_ptr_data<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter, true, true>::__uniq_ptr_data()\u2019\n  305 |         : _M_t()\n      |           ^~~~~~\n/usr/include/c++/13/bits/unique_ptr.h:241:40: note: candidate: \u2018template<class _Del> std::__uniq_ptr_data<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter, true, true>::__uniq_ptr_data(std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::pointer, _Del&&) [inherited from std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>]\u2019\n  241 |       using __uniq_ptr_impl<_Tp, _Dp>::__uniq_ptr_impl;\n      |                                        ^~~~~~~~~~~~~~~\n/usr/include/c++/13/bits/unique_ptr.h:241:40: note:   template argument deduction/substitution failed:\n/usr/include/c++/13/bits/unique_ptr.h:305:11: note:   candidate expects 2 arguments, 0 provided\n  305 |         : _M_t()\n      |           ^~~~~~\n/usr/include/c++/13/bits/unique_ptr.h:241:40: note: candidate: \u2018std::__uniq_ptr_data<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter, true, true>::__uniq_ptr_data(std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>::pointer) [inherited from std::__uniq_ptr_impl<std::__future_base::_Result_base, std::__future_base::_Result_base::_Deleter>]\u2019\n  241 |       using __uniq_ptr_impl<_Tp, _Dp>::__uniq_ptr_impl;\n      |                                        ^~~~~~~~~~~~~~~\n/usr/include/c++/13/bits/unique_ptr.h:241:40: note:   candidate expects 1 argument, 0 provided\n/usr/include/c++/13/bits/unique_ptr.h:242:7: note: candidate: \u2018std::__uniq_ptr_data<_Tp, _Dp, <anonymous>, <anonymous> >::__uniq_ptr_data(std::__uniq_ptr_data<_Tp, _Dp, <anonymous>, <anonymous> >&&) [with _Tp = std::__future_base::_Result_base; _Dp = std::__future_base::_Result_base::_Deleter; bool <anonymous> = true; bool <anonymous> = true]\u2019\n  242 |       __uniq_ptr_data(__uniq_ptr_data&&) = default;\n      |       ^~~~~~~~~~~~~~~\n/usr/include/c++/13/bits/unique_ptr.h:242:7: note:   candidate expects 1 argument, 0 provided\nmake[4]: *** [CMakeFiles/mputil.dir/build.make:76: CMakeFiles/mputil.dir/src/mp/util.cpp.o] Error 1\n```\n\n</p>\n</details>\nInteresting that this did not result in a compile or link failure instead.\n\nI switched to clang in commit fad0f21c3caba129106799fe6c14aff323ef99f2 to avoid OOM with g++, (which was before switching to 32-bit in commit fae0295a799499268caca9c385ac4d7061543980), but now that the CI machines have more memory, it should be fine if this CI task takes more memory and time.\n\nHappy to review a pull, if someone submits one.\nCan confirm switching from clang to gcc does seem to fix this. `-Wno-error=documentation` also had to be dropped because gcc does not support it.\n\n```c++\n--- a/ci/test/00_setup_env_i686_multiprocess.sh\n+++ b/ci/test/00_setup_env_i686_multiprocess.sh\n@@ -10,15 +10,12 @@ export HOST=i686-pc-linux-gnu\n export CONTAINER_NAME=ci_i686_multiprocess\n export CI_IMAGE_NAME_TAG=\"docker.io/ubuntu:24.04\"\n export CI_IMAGE_PLATFORM=\"linux/amd64\"\n-export PACKAGES=\"llvm clang g++-multilib\"\n-export DEP_OPTS=\"DEBUG=1 MULTIPROCESS=1\"\n+export PACKAGES=\"g++-multilib\"\n+export DEP_OPTS=\"DEBUG=1 MULTIPROCESS=1 NO_QT=1\"\n export GOAL=\"install\"\n export TEST_RUNNER_EXTRA=\"--v2transport\"\n export BITCOIN_CONFIG=\"\\\n  -DCMAKE_BUILD_TYPE=Debug \\\n- -DCMAKE_C_COMPILER='clang;-m32' \\\n- -DCMAKE_CXX_COMPILER='clang++;-m32' \\\n- -DCMAKE_CXX_FLAGS='-Wno-error=documentation' \\\n  -DAPPEND_CPPFLAGS='-DBOOST_MULTI_INDEX_ENABLE_SAFE_MODE' \\\n \"\n export BITCOIND=bitcoin-node  # Used in functional tests\n```\n\n---\n\n> Interesting that this did not result in a compile or link failure instead.\n\nI was just seeing a lot of strange things here. Theoretically, I think it should be fine to use gcc and clang together. Some other things I noticed: when I ran gdb I could step into the [findFirst](https://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/common.h#L1882-L1920) methods and see it looking for the '/' character and `pos` pointing to the right place but then the return value was wrong (a very large number instead of the position of the character). Also in I couldn't even tell which findFirst overload I was in because line number did not seem to correspond to the source file.\n\nWhen I added the -fabi-version flags and rebuilt I saw the ipc tests run and passed, and the  -fabi-version fix worked twice in two different containers when I applied it manually, but did not seem to work when it was already applied at the beginning of the build. So I think something else I was doing in my rebuild steps, like reconfiguring cmake was causing the problem to go away. So I don't know. I want to debug more but I think I already spent way too much time on this.\nI tried to repeat previous steps rebuilding depends and test_bitcoin in container to figure out what I was doing that caused the test to stop crashing, but it seems to crash reliably, so I can't work out what I other changes I might have made while trying -fabi-version flags in https://github.com/bitcoin/bitcoin/issues/31772#issuecomment-2634917217 that would have caused it not to crash.\n\nAdditionally, I went back to original build and debugged it with GDB, and could easily step through and see where the bug is happening when I run with:\n\n```bash\ngdb -ex 'b findFirst' -ex run --args ./src/test/test_bitcoin -t ipc_tests\n```\n\nEverything works well up until reaching the `ArrayPtr<const char>::findFirst` method:\n\nhttps://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/common.h#L1882-L1890\n\nThe method also seems to work fine until it reaches the `return pos - ptr;` line. Because the function returns a Maybe value, this calls Maybe constructor:\n\nhttps://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/common.h#L1389\n\nwhich has a NullableValue member and calls NullableValue constructor:\n\nhttps://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/common.h#L1158\n\nwhich calls a function called ctor:\n\nhttps://github.com/capnproto/capnproto/blob/b34ec28cceaf15b1082b74b50f03f770873c3636/c%2B%2B/src/kj/common.h#L1061\n\nand unfortunately that function seems to be completely broken and not do anything. The `ctor` function is supposed to construct a `T` value inside the `NullableValue<T>` object, but it fails to do that. In this case `T` is a `size_t` object so it is supposed to assign the `pos - ptr` size that was computed into the `Maybe<size_t>` object that is being returned. But it doesn't do this. So the `Maybe<size_t>` object is only half-initialized as `{isSet = true, {value = 1497966205}}`, where the value 1497966205 is just the preexisting value it held before it was constructed, and is much longer than the size of the string being searched, so the code later throws an exception when there is an attempt to slice the \"192.0.0.0/24\" string at that position.\n\nThis bug seems like it is is probably a compiler bug, but not one is necessarily going to happen reliably because if the unitialized memory location started of as 0 instead 1497966205, crash would not happen. So I'm not sure switching bitcoin compiler from clang to gcc really fixes the problem, or just makes it appear not to happen. And I\"m not sure what I was doing before that caused the problem to disappear as well. It seems like there might be just be a problem with this version of gcc and -O0 and this piece of code.\n\nNext steps might be to look at generated assembly and confirm compiler is really producing buggy code or try to reproduce a minimal test case. Another thing we could try to do is update to a new version of gcc. Version here seems to be `gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0`\n\nHere is disassembly of relevant functions:\n\n<details><summary>disassembly</summary>\n<p>\n\n```c++\n(gdb) disassemble /s\nDump of assembler code for function _ZNK2kj8ArrayPtrIKcE9findFirstERS1_:\n/usr/src/kj/common.h:\n1883    inline Maybe<size_t> ArrayPtr<const char>::findFirst(const char& c) const {\n   0x5977156c <+0>:     push   %ebp\n   0x5977156d <+1>:     mov    %esp,%ebp\n   0x5977156f <+3>:     push   %ebx\n   0x59771570 <+4>:     sub    $0x24,%esp\n   0x59771573 <+7>:     call   0x566e8da0 <__x86.get_pc_thunk.bx>\n   0x59771578 <+12>:    add    $0x121eff0,%ebx\n   0x5977157e <+18>:    mov    0x8(%ebp),%eax\n   0x59771581 <+21>:    mov    %eax,-0x1c(%ebp)\n   0x59771584 <+24>:    mov    0xc(%ebp),%eax\n   0x59771587 <+27>:    mov    %eax,-0x20(%ebp)\n   0x5977158a <+30>:    mov    0x10(%ebp),%eax\n   0x5977158d <+33>:    mov    %eax,-0x24(%ebp)\n=> 0x59771590 <+36>:    mov    %gs:0x14,%eax\n   0x59771596 <+42>:    mov    %eax,-0xc(%ebp)\n   0x59771599 <+45>:    xor    %eax,%eax\n\n1884      const char* pos = reinterpret_cast<const char*>(memchr(ptr, c, size_));\n   0x5977159b <+47>:    mov    -0x20(%ebp),%eax\n   0x5977159e <+50>:    mov    0x4(%eax),%ecx\n   0x597715a1 <+53>:    mov    -0x24(%ebp),%eax\n   0x597715a4 <+56>:    movzbl (%eax),%eax\n   0x597715a7 <+59>:    movsbl %al,%edx\n   0x597715aa <+62>:    mov    -0x20(%ebp),%eax\n   0x597715ad <+65>:    mov    (%eax),%eax\n   0x597715af <+67>:    sub    $0x4,%esp\n   0x597715b2 <+70>:    push   %ecx\n   0x597715b3 <+71>:    push   %edx\n   0x597715b4 <+72>:    push   %eax\n   0x597715b5 <+73>:    call   0x5664a880 <memchr@plt>\n   0x597715ba <+78>:    add    $0x10,%esp\n   0x597715bd <+81>:    mov    %eax,-0x10(%ebp)\n\n1885      if (pos == nullptr) {\n   0x597715c0 <+84>:    cmpl   $0x0,-0x10(%ebp)\n   0x597715c4 <+88>:    jne    0x597715d8 <_ZNK2kj8ArrayPtrIKcE9findFirstERS1_+108>\n\n1886        return nullptr;\n   0x597715c6 <+90>:    sub    $0x8,%esp\n   0x597715c9 <+93>:    push   $0x0\n   0x597715cb <+95>:    push   -0x1c(%ebp)\n   0x597715ce <+98>:    call   0x595224a6 <_ZN2kj5MaybeIjEC2EDn>\n   0x597715d3 <+103>:   add    $0x10,%esp\n   0x597715d6 <+106>:   jmp    0x597715f9 <_ZNK2kj8ArrayPtrIKcE9findFirstERS1_+141>\n\n1887      } else {\n1888        return pos - ptr;\n   0x597715d8 <+108>:   mov    -0x20(%ebp),%eax\n   0x597715db <+111>:   mov    (%eax),%eax\n   0x597715dd <+113>:   mov    -0x10(%ebp),%edx\n   0x597715e0 <+116>:   sub    %eax,%edx\n   0x597715e2 <+118>:   mov    %edx,%eax\n   0x597715e4 <+120>:   mov    %eax,-0x14(%ebp)\n   0x597715e7 <+123>:   sub    $0x8,%esp\n   0x597715ea <+126>:   lea    -0x14(%ebp),%eax\n   0x597715ed <+129>:   push   %eax\n   0x597715ee <+130>:   push   -0x1c(%ebp)\n   0x597715f1 <+133>:   call   0x595224d0 <_ZN2kj5MaybeIjEC2EOj>\n   0x597715f6 <+138>:   add    $0x10,%esp\n\n1889      }\n1890    }\n   0x597715f9 <+141>:   mov    -0xc(%ebp),%eax\n   0x597715fc <+144>:   sub    %gs:0x14,%eax\n   0x59771603 <+151>:   je     0x5977160a <_ZNK2kj8ArrayPtrIKcE9findFirstERS1_+158>\n   0x59771605 <+153>:   call   0x597cf290 <__stack_chk_fail_local>\n   0x5977160a <+158>:   mov    -0x1c(%ebp),%eax\n   0x5977160d <+161>:   mov    -0x4(%ebp),%ebx\n   0x59771610 <+164>:   leave\n   0x59771611 <+165>:   ret    $0x4\nEnd of assembler dump.\n(gdb) disassemble /s _ZN2kj5MaybeIjEC2EOj\nDump of assembler code for function _ZN2kj5MaybeIjEC2EOj:\n/usr/src/kj/common.h:\n1389      Maybe(T&& t): ptr(kj::mv(t)) {}\n   0x595224d0 <+0>:     push   %ebp\n   0x595224d1 <+1>:     mov    %esp,%ebp\n   0x595224d3 <+3>:     push   %esi\n   0x595224d4 <+4>:     push   %ebx\n   0x595224d5 <+5>:     call   0x566e8da0 <__x86.get_pc_thunk.bx>\n   0x595224da <+10>:    add    $0x146e08e,%ebx\n   0x595224e0 <+16>:    mov    0x8(%ebp),%esi\n   0x595224e3 <+19>:    sub    $0xc,%esp\n   0x595224e6 <+22>:    push   0xc(%ebp)\n   0x595224e9 <+25>:    call   0x59502e4c <_ZN2kj2mvIjEEOT_RS1_>\n   0x595224ee <+30>:    add    $0x10,%esp\n   0x595224f1 <+33>:    sub    $0x8,%esp\n   0x595224f4 <+36>:    push   %eax\n   0x595224f5 <+37>:    push   %esi\n   0x595224f6 <+38>:    call   0x5952b7d8 <_ZN2kj1_13NullableValueIjEC2EOj>\n   0x595224fb <+43>:    add    $0x10,%esp\n   0x595224fe <+46>:    nop\n   0x595224ff <+47>:    lea    -0x8(%ebp),%esp\n   0x59522502 <+50>:    pop    %ebx\n   0x59522503 <+51>:    pop    %esi\n   0x59522504 <+52>:    pop    %ebp\n   0x59522505 <+53>:    ret\nEnd of assembler dump.\n(gdb) disassemble /s _ZN2kj1_13NullableValueIjEC2EOj\nDump of assembler code for function _ZN2kj1_13NullableValueIjEC2EOj:\n/usr/src/kj/common.h:\n1156      inline NullableValue(T&& t)\n   0x5952b7d8 <+0>:     push   %ebp\n   0x5952b7d9 <+1>:     mov    %esp,%ebp\n   0x5952b7db <+3>:     push   %ebx\n   0x5952b7dc <+4>:     sub    $0x4,%esp\n   0x5952b7df <+7>:     call   0x566e8da0 <__x86.get_pc_thunk.bx>\n   0x5952b7e4 <+12>:    add    $0x1464d84,%ebx\n\n1157          : isSet(true) {\n   0x5952b7ea <+18>:    mov    0x8(%ebp),%eax\n   0x5952b7ed <+21>:    movb   $0x1,(%eax)\n\n1158        ctor(value, kj::mv(t));\n   0x5952b7f0 <+24>:    sub    $0xc,%esp\n   0x5952b7f3 <+27>:    push   0xc(%ebp)\n   0x5952b7f6 <+30>:    call   0x59502e4c <_ZN2kj2mvIjEEOT_RS1_>\n   0x5952b7fb <+35>:    add    $0x10,%esp\n   0x5952b7fe <+38>:    mov    0x8(%ebp),%edx\n   0x5952b801 <+41>:    add    $0x4,%edx\n   0x5952b804 <+44>:    sub    $0x8,%esp\n   0x5952b807 <+47>:    push   %eax\n   0x5952b808 <+48>:    push   %edx\n   0x5952b809 <+49>:    call   0x595314f8 <_ZN2kj4ctorIjIjEEEvRT_DpOT0_>\n   0x5952b80e <+54>:    add    $0x10,%esp\n\n1159      }\n   0x5952b811 <+57>:    nop\n   0x5952b812 <+58>:    mov    -0x4(%ebp),%ebx\n   0x5952b815 <+61>:    leave\n   0x5952b816 <+62>:    ret\nEnd of assembler dump.\n(gdb) disassemble /s _ZN2kj4ctorIjIjEEEvRT_DpOT0_\n\nDump of assembler code for function _ZN2kj4ctorIjIjEEEvRT_DpOT0_:\n/usr/src/kj/common.h:\n1060    inline void ctor(T& location, Params&&... params) {\n   0x595314f8 <+0>:     push   %ebp\n   0x595314f9 <+1>:     mov    %esp,%ebp\n   0x595314fb <+3>:     push   %esi\n   0x595314fc <+4>:     push   %ebx\n   0x595314fd <+5>:     call   0x566e8da0 <__x86.get_pc_thunk.bx>\n   0x59531502 <+10>:    add    $0x145f066,%ebx\n\n1061      new (_::PlacementNew(), &location) T(kj::fwd<Params>(params)...);\n   0x59531508 <+16>:    sub    $0x4,%esp\n   0x5953150b <+19>:    push   0x8(%ebp)\n   0x5953150e <+22>:    push   %eax\n   0x5953150f <+23>:    push   $0x4\n   0x59531511 <+25>:    call   0x58a0ec00 <_ZnwjN2kj1_12PlacementNewEPv>\n   0x59531516 <+30>:    add    $0x10,%esp\n   0x59531519 <+33>:    mov    %eax,%esi\n   0x5953151b <+35>:    test   %esi,%esi\n   0x5953151d <+37>:    je     0x59531531 <_ZN2kj4ctorIjIjEEEvRT_DpOT0_+57>\n   0x5953151f <+39>:    sub    $0xc,%esp\n   0x59531522 <+42>:    push   0xc(%ebp)\n   0x59531525 <+45>:    call   0x59502e70 <_ZN2kj3fwdIjEEOT_RNS_8NoInfer_IS1_E4TypeE>\n   0x5953152a <+50>:    add    $0x10,%esp\n   0x5953152d <+53>:    mov    (%eax),%eax\n   0x5953152f <+55>:    mov    %eax,(%esi)\n\n1062    }\n   0x59531531 <+57>:    nop\n   0x59531532 <+58>:    lea    -0x8(%ebp),%esp\n   0x59531535 <+61>:    pop    %ebx\n   0x59531536 <+62>:    pop    %esi\n   0x59531537 <+63>:    pop    %ebp\n   0x59531538 <+64>:    ret\nEnd of assembler dump.\n(gdb) \nDump of assembler code for function _ZN2kj4ctorIjIjEEEvRT_DpOT0_:\n/usr/src/kj/common.h:\n1060    inline void ctor(T& location, Params&&... params) {\n   0x595314f8 <+0>:     push   %ebp\n   0x595314f9 <+1>:     mov    %esp,%ebp\n   0x595314fb <+3>:     push   %esi\n   0x595314fc <+4>:     push   %ebx\n   0x595314fd <+5>:     call   0x566e8da0 <__x86.get_pc_thunk.bx>\n   0x59531502 <+10>:    add    $0x145f066,%ebx\n\n1061      new (_::PlacementNew(), &location) T(kj::fwd<Params>(params)...);\n   0x59531508 <+16>:    sub    $0x4,%esp\n   0x5953150b <+19>:    push   0x8(%ebp)\n   0x5953150e <+22>:    push   %eax\n   0x5953150f <+23>:    push   $0x4\n   0x59531511 <+25>:    call   0x58a0ec00 <_ZnwjN2kj1_12PlacementNewEPv>\n   0x59531516 <+30>:    add    $0x10,%esp\n   0x59531519 <+33>:    mov    %eax,%esi\n   0x5953151b <+35>:    test   %esi,%esi\n   0x5953151d <+37>:    je     0x59531531 <_ZN2kj4ctorIjIjEEEvRT_DpOT0_+57>\n   0x5953151f <+39>:    sub    $0xc,%esp\n   0x59531522 <+42>:    push   0xc(%ebp)\n   0x59531525 <+45>:    call   0x59502e70 <_ZN2kj3fwdIjEEOT_RNS_8NoInfer_IS1_E4TypeE>\n   0x5953152a <+50>:    add    $0x10,%esp\n   0x5953152d <+53>:    mov    (%eax),%eax\n   0x5953152f <+55>:    mov    %eax,(%esi)\n\n1062    }\n   0x59531531 <+57>:    nop\n   0x59531532 <+58>:    lea    -0x8(%ebp),%esp\n   0x59531535 <+61>:    pop    %ebx\n   0x59531536 <+62>:    pop    %esi\n   0x59531537 <+63>:    pop    %ebp\n   0x59531538 <+64>:    ret\nEnd of assembler dump.\n(gdb) disassemble /s _ZnwjN2kj1_12PlacementNewEPv\nDump of assembler code for function _ZnwjN2kj1_12PlacementNewEPv:\n/ci_container_base/depends/i686-pc-linux-gnu/include/kj/common.h:\n1051    inline void* operator new(size_t, kj::_::PlacementNew, void* __p) noexcept {\n   0x58a0ec00 <+0>:     endbr32\n   0x58a0ec04 <+4>:     push   %ebp\n   0x58a0ec05 <+5>:     mov    %esp,%ebp\n   0x58a0ec07 <+7>:     push   %ebx\n   0x58a0ec08 <+8>:     sub    $0x14,%esp\n   0x58a0ec0b <+11>:    call   0x58a0ec10 <_ZnwjN2kj1_12PlacementNewEPv+16>\n   0x58a0ec10 <+16>:    pop    %eax\n   0x58a0ec11 <+17>:    add    $0x1f81958,%eax\n   0x58a0ec17 <+23>:    mov    %eax,-0x14(%ebp)\n   0x58a0ec1a <+26>:    mov    0xc(%ebp),%eax\n   0x58a0ec1d <+29>:    mov    0x8(%ebp),%eax\n   0x58a0ec20 <+32>:    mov    %gs:0x14,%eax\n   0x58a0ec26 <+38>:    mov    %eax,-0x8(%ebp)\n\n1052      return __p;\n   0x58a0ec29 <+41>:    mov    0xc(%ebp),%eax\n   0x58a0ec2c <+44>:    mov    %eax,-0x10(%ebp)\n   0x58a0ec2f <+47>:    mov    %gs:0x14,%eax\n   0x58a0ec35 <+53>:    mov    -0x8(%ebp),%ecx\n   0x58a0ec38 <+56>:    cmp    %ecx,%eax\n   0x58a0ec3a <+58>:    jne    0x58a0ec49 <_ZnwjN2kj1_12PlacementNewEPv+73>\n   0x58a0ec40 <+64>:    mov    -0x10(%ebp),%eax\n   0x58a0ec43 <+67>:    add    $0x14,%esp\n   0x58a0ec46 <+70>:    pop    %ebx\n   0x58a0ec47 <+71>:    pop    %ebp\n   0x58a0ec48 <+72>:    ret\n   0x58a0ec49 <+73>:    mov    -0x14(%ebp),%ebx\n   0x58a0ec4c <+76>:    call   0x56649250 <__stack_chk_fail@plt>\nEnd of assembler dump.\n(gdb) disassemble /s _ZN2kj3fwdIjEEOT_RNS_8NoInfer_IS1_E4TypeE\nDump of assembler code for function _ZN2kj3fwdIjEEOT_RNS_8NoInfer_IS1_E4TypeE:\n/ci_container_base/depends/i686-pc-linux-gnu/include/kj/common.h:\n700     template<typename T> constexpr T&& fwd(NoInfer<T>& t) noexcept { return static_cast<T&&>(t); }\n   0x59502e70 <+0>:     push   %ebp\n   0x59502e71 <+1>:     mov    %esp,%ebp\n   0x59502e73 <+3>:     call   0x584df28a <__x86.get_pc_thunk.ax>\n   0x59502e78 <+8>:     add    $0x148d6f0,%eax\n   0x59502e7d <+13>:    mov    0x8(%ebp),%eax\n   0x59502e80 <+16>:    pop    %ebp\n   0x59502e81 <+17>:    ret\nEnd of assembler dump.\n```\n\n</p>\n</details>\n\nWhen I fed this to chatgpt (https://chatgpt.com/share/67a2aa92-e100-800a-b5b3-999982d1a648) it claimed to find a bug in the dissembly where operator new function is not interpreting its parameters correctly, and I could confirm this with gdb (at least to the best of my understanding, I am not that familiar with assembly and calling conventions). But gdb definitely showed operator new returning the wrong address (source address not destination address), which explained why the destination was not being updated and contained a garbage value.\n\nSo I think there is pretty good evidence that this version of gcc contains a bug with -O0 and is miscompiling the code. Again I'm not sure if we care about this or not. It's an older version of gcc so might be logical to just update it. Or just not compile this code with -O0.\n\n\n\n> This bug seems like it is is probably a compiler bug, but not one is necessarily going to happen reliably because if the unitialized memory location started of as 0 instead 1497966205, crash would not happen. So I'm not sure switching bitcoin compiler from clang to gcc really fixes the problem, or just makes it appear not to happen. And I\"m not sure what I was doing before that caused the problem to disappear as well. It seems like there might be just be a problem with this version of gcc and -O0 and this piece of code.\n> \n> Next steps might be to look at generated assembly and confirm compiler is really producing buggy code or try to reproduce a minimal test case. Another thing we could try to do is update to a new version of gcc. Version here seems to be `gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0`\n\nInteresting. It would be nice to reduce this, if someone wants to spend more time on this. However, I am not familiar with libmp and the build process around it, so if someone manages to produce one (or two) cpp files (even if large) with the corresponding compiler flags, I am happy to take it from there and minimize further.\n> Interesting. It would be nice to reduce this\n\nSo I reduced the failure down to a standalone case, but it could be reduced further. Now it is unclear to me if there is a compiler bug here or not, because this is caused by a very specific interaction between the two compiler versions we are using:\n\n- gcc version Ubuntu 13.3.0-6ubuntu2~24.04\n- clang version 18.1.3 (1ubuntu1)\n\nand maybe the specific flags we are using. The bug happens because the linker links together the\n\n- `_ZN2kj4ctorIjIjEEEvRT_DpOT0_` function (`void kj::ctor<unsigned int, unsigned int>(unsigned int&, unsigned int&&)`)\n\ngenerated by GCC in the capnproto static libraries\n\n-  `_ZnwjN2kj1_12PlacementNewEPv` function (`operator new(unsigned int, kj::_::PlacementNew, void*)`)\n\ngenerated by clang in the `libbitcoin_ipc_test.a` library.\n\nThis happens due to linker command line order. The `ipc_test` library comes before the kj static libraries in the command line, but it only contains an `operator new` symbol, not a `ctor` symbol, while kj static libraries contain both symbols. The link will prefer the first symbol definition it sees so it uses the `operator new` from bitcoin together with the `ctor` from libkj and this does not work because gcc `ctor` calls clang `operator new` with a calling convention it is not expecting (as described by chatgpt above).\n\nHere's the reduced test case I have which reproduces the bug with the same code and flags as the CI build:\n\n```c++\ncat > test.h <<EOS\n#include <cstddef>\ntemplate <typename T> struct NoInfer_ { typedef T Type; };\ntemplate <typename T> using NoInfer = typename NoInfer_<T>::Type;\n\ntemplate<typename T> constexpr T&& fwd(NoInfer<T>& t) noexcept { return static_cast<T&&>(t); }\n\nstruct PlacementNew {};\n\nvoid* operator new(size_t, PlacementNew, void* __p) noexcept;\n\ntemplate <typename T, typename... Params>\ninline void ctor(T& location, Params&&... params) {\n  new (PlacementNew(), &location) T(fwd<Params>(params)...);\n}\nEOS\n\ncat > test_gcc.cpp <<EOS\n#include \"test.h\"\ntemplate void ctor<size_t, size_t>(size_t&, size_t&&);\nEOS\n\ncat > test_clang.cpp <<EOS\n#include \"test.h\"\n#include <iostream>\n\nvoid* operator new(size_t, PlacementNew, void* __p) noexcept {\n  return __p;\n}\n\nsize_t f() {\n    size_t i = 10;\n    size_t j = 20;\n    ctor(i, std::move(j));\n    return i;\n}\n\nint main() {\n    std::cout << \"i = \" << f() << std::endl;\n}\nEOS\n\ng++ -m32 -D_GLIBCXX_DEBUG -D_GLIBCXX_DEBUG_PEDANTIC -D_LIBCPP_HARDENING_MODE=_LIBCPP_HARDENING_MODE_DEBUG -pipe -std=c++20 -O0 -g -fPIC -Wall -Wextra -Wno-strict-aliasing -Wno-sign-compare -Wno-unused-parameter -pthread -c test_gcc.cpp -o test_gcc.o\nclang++ -m32 -Wno-error=documentation -O0 -ftrapv -O0 -g3 -g3 -fstack-protector-all -fcf-protection=full -fstack-clash-protection -fPIE -c test_clang.cpp -o test_clang.o\nclang++ -m32 -Wno-error=documentation -O0 -ftrapv -O0 -g3 -g3 -fstack-protector-all -fcf-protection=full -fstack-clash-protection -Wl,-z,relro -Wl,-z,now -Wl,-z,separate-code -fPIE -pie test_gcc.o test_clang.o\n./a.out\n```\n\nIf the test case were compiled properly it would print 20, but due to the calling convention problem here it prints 10, because the line `ctor(i, std::move(j));` is supposed to assign `j` (20) to `i`, but doesn't do that because `operator new` returns a garbage value.\n\nI confirmed that adding `-fabi-version=2` to gcc command line above does not fix the problem (the program still prints 10 instead of 20). But I did not experiment further to see which of the compiler flags we are passing may be causing the incompatibility, or if the flags are irrelevant and gcc and clang just disagree on the calling convention for this `operator new`.\n\nI am not sure if there is a general solution for this problem. If linker order were changed so that kj libraries were always specified first before the bitcoin library, that would prevent crashing inside kj libraries, but then it might cause a similar crash in the bitcoin code.\n\nAll of this suggests that if you are using depends, and you want to change the compiler or pass different flags in bitcoin, you really need to make the same changes in both builds. Mixing different flags and compiler versions might not be a good idea.\nFollowing seem to be minimal flags to reproduce this issue. None of the other flags except for `-fPIC` was making any difference, and without `-fPIC` the program just segfaults instead of printing the wrong value:\n\n```bash\ng++ -m32 -fPIC -c test_gcc.cpp -o test_gcc.o\nclang++ -m32 -fPIC -c test_clang.cpp -o test_clang.o\nclang++ -m32 -fPIC test_gcc.o test_clang.o\n./a.out\n```\n\nSo it seems like this version of gcc and clang just always (regardless of flags) assume incompatible calling conventions for `operator new` and can't be used together here.\n\nFix for the bug should just be to use either clang or gcc for this CI build and not try to use both.\nThis also seems to be a known issue: \"It has come to my attention that GCC and clang generate incompatible code\nfor passing an argument of an empty class type.\" https://itanium-cxx-abi.github.io/cxx-abi/cxx-abi-dev/archives/2015-December/002869.html\nI wonder if there is a way to detect those at compile or link time. Other than that, printing a warning when mixing two compilers when compiling with depends may be useful? \n> Other than that, printing a warning when mixing two compilers when compiling with depends may be useful?\n\nWhy only depends though? If the issue is generally mixing compilers/flags, then using Clang + system libs on any (gcc-based) Linux system (potentially) has the same problem. It's currently the case that we use Clang + (GCC built) system libs in at least the ASAN,fuzz,valgrind CIs, and Clang + GCC depends libs in the 32-bit job.\n> Why only depends though? If the issue is generally mixing compilers/flags, then using Clang + system libs on any (gcc-based) Linux system (potentially) has the same problem.\n\nYes this issue is not specific to depends, and could theoretically could happen if, for example an ubuntu library package was compiled with gcc and exposed a function with an empty struct parameter, and you tried to use the library with clang. \n\nThe point of having an ABI is to prevent issues like this and allow different compilers to interoperate, but this is a corner case where something hasn't been standardized. Also, in this case, issue goes away if either package is compiled with any optimization (even `-O` is sufficient) because this makes the call to `operator new` inlined. And this issue could also be masked by having a different linker command line order that would cause linker to choose compatible `ctor` and `operator new` symbol definitions instead of incompatible ones.\n\nGiven corner case nature of this problem, I'm thinking it would be good to send a patch to upstream capnproto to avoid the issue by changing parameter order. Following patch seems to fix the issue in our CI job:\n\n```diff\ndiff --git a/depends/packages/capnp.mk b/depends/packages/capnp.mk\nindex 0c211cbc455d..00ccf08acf4b 100644\n--- a/depends/packages/capnp.mk\n+++ b/depends/packages/capnp.mk\n@@ -5,6 +5,12 @@ $(package)_download_file=$(native_$(package)_download_file)\n $(package)_file_name=$(native_$(package)_file_name)\n $(package)_sha256_hash=$(native_$(package)_sha256_hash)\n \n+$(package)_patches = abifix.patch\n+\n+define $(package)_preprocess_cmds\n+  patch -p2 < $($(package)_patch_dir)/abifix.patch\n+endef\n+\n define $(package)_set_vars :=\n   $(package)_config_opts := -DBUILD_TESTING=OFF\n   $(package)_config_opts += -DWITH_OPENSSL=OFF\ndiff --git a/depends/patches/capnp/abifix.patch b/depends/patches/capnp/abifix.patch\nnew file mode 100644\nindex 000000000000..1386aadc7452\n--- /dev/null\n+++ b/depends/patches/capnp/abifix.patch\n@@ -0,0 +1,35 @@\n+diff --git a/c++/src/kj/common.h b/c++/src/kj/common.h\n+index 237c41d3..dc2e6381 100644\n+--- a/c++/src/kj/common.h\n++++ b/c++/src/kj/common.h\n+@@ -1041,24 +1041,26 @@ private:\n+ \n+ // We want placement new, but we don't want to #include <new>.  operator new cannot be defined in\n+ // a namespace, and defining it globally conflicts with the definition in <new>.  So we have to\n+-// define a dummy type and an operator new that uses it.\n++// define a dummy type and an operator new that uses it. The dummy type is intentionally passed\n++// as the last parameter to avoid an ABI issues caused by GCC and clang using incompatible calling\n++// conventions for passing empty struct parameters.\n+ \n+ namespace _ {  // private\n+ struct PlacementNew {};\n+ }  // namespace _ (private)\n+ } // namespace kj\n+ \n+-inline void* operator new(size_t, kj::_::PlacementNew, void* __p) noexcept {\n++inline void* operator new(size_t, void* __p, kj::_::PlacementNew) noexcept {\n+   return __p;\n+ }\n+ \n+-inline void operator delete(void*, kj::_::PlacementNew, void* __p) noexcept {}\n++inline void operator delete(void*, void* __p, kj::_::PlacementNew) noexcept {}\n+ \n+ namespace kj {\n+ \n+ template <typename T, typename... Params>\n+ inline void ctor(T& location, Params&&... params) {\n+-  new (_::PlacementNew(), &location) T(kj::fwd<Params>(params)...);\n++  new (&location, _::PlacementNew()) T(kj::fwd<Params>(params)...);\n+ }\n+ \n+ template <typename T>\n```\n\n\nSubmitted patch in https://github.com/capnproto/capnproto/pull/2235", "created_at": "2025-03-05 15:13:02", "merge_commit_sha": "a5a582d852eb2640da6372bfce98ef298ce043b1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31983", "base_commit": "15717f0ef3960969ee550a4a41741987b86684dc", "patch": "diff --git a/cmake/ccache.cmake b/cmake/ccache.cmake\nindex d1cc204c8e463..0bfd3a41f62db 100644\n--- a/cmake/ccache.cmake\n+++ b/cmake/ccache.cmake\n@@ -23,6 +23,8 @@ if(NOT MSVC)\n   else()\n     set(WITH_CCACHE OFF)\n   endif()\n+else()\n+  set(WITH_CCACHE OFF)\n endif()\n \n mark_as_advanced(CCACHE_EXECUTABLE)\n", "test_patch": "", "problem_statement": "cmake: incorrectly reporting MSVC as using ccache\nMentioned by @stickies-v. The CMake configure currently outputs that MSVC builds are using ccache, i.e (https://github.com/bitcoin/bitcoin/actions/runs/13063954360/job/36452895056#step:8:2374):\n```bash\nTreat compiler warnings as errors ..... ON\nUse ccache for compiling .............. ON\n```\n\nHowever that's a bug, as MSVC is currently excluded entirely from using ccache: \nhttps://github.com/bitcoin/bitcoin/blob/8fa10edcd1706a1f0dc9d8c3adbc8efa3c7755bf/cmake/ccache.cmake#L4-L6\n", "hints_text": "Hey, can I contribute to this issue\n\n@vijayabhaskar78 \n\n> Hey, can I contribute to this issue\n\nSure! No need to ask :)\n@hebasto sir Proposing a fix for #31771:\n\n    Set USE_CCACHE=OFF for MSVC in cmake/ccache.cmake.\n    Update status reporting in CMakeLists.txt.\n\nQuestions:\n\n    Does this align with project conventions?\n    Any edge cases (MinGW/cross-compile) to test?\nI don't understand the motivation for setting `CMAKE_<lang>_COMPILER_LAUNCHER` from inside the project. Ideally, the project should not interfere with compiler launchers at all.\n\nThis gives individual users as well as CI instances the highest flexibility.\n\nAssuming I have `ENV{CMAKE_CXX_COMPILER_LAUNCHER}` set locally to use [`sccache`](https://github.com/mozilla/sccache). What is the expected behavior when `cmake/ccache.cmake` invokes `list(APPEND CMAKE_CXX_COMPILER_LAUNCHER ${CCACHE_EXECUTABLE})`? Will it use `sccache`, `ccache`, or both?\n@purpleKarrot Should we remove the CMAKE_*_COMPILER_LAUNCHER assignments from ccache.cmake to prioritize user/CI flexibility? This would:\n\n    Avoid conflicts with external launchers like sccache set via ENV{CMAKE_CXX_COMPILER_LAUNCHER}.\n    Follow CMake best practices by letting users control launchers externally.\n    Prevent invalid command chains (e.g., sccache;ccache;cl.exe) when multiple launchers are set.\n\nIf agreed, I can update the PR to delete these lines and add documentation instead\nI'm a newbie to this repository. Can you help me to understand it?\n@vijayabhaskar78, I am a newbe in this repository too, but I am not a newbie with CMake ;-)\nMy recommendation would be to remove `cmake/ccache.cmake` for the reason you wrote.\nBut let the original authors of that file chime in.\nOK let us see \n@fanquake @hebasto @purpleKarrot  \n\n### **Problem Summary**  \n\n- **False Reporting:** CMake incorrectly reports `ccache` as \"ON\" for MSVC builds despite excluding it in `cmake/ccache.cmake`.  \n- **Launcher Conflicts:** Forced `CMAKE_*_COMPILER_LAUNCHER` assignments override user/CI settings (e.g., `sccache`).  \n\n### **Proposed Fix**  \n\n#### **1. Delete `cmake/ccache.cmake`**  \n\n```bash\nrm cmake/ccache.cmake\n```\n\n- **Why?** Removes forced `ccache` logic conflicting with external launchers.  \n- **Impact:** Users/CI regain full control via `CMAKE_CXX_COMPILER_LAUNCHER`.  \n\n#### **2. Update Status Message**  \n\n```cmake\nif(DEFINED ENV{CMAKE_CXX_COMPILER_LAUNCHER})  \n  message(STATUS \"Compiler launcher .............. $ENV{CMAKE_CXX_COMPILER_LAUNCHER}\")  \nelse()  \n  message(STATUS \"Use ccache for compiling .............. NO\")  \nendif()\n```\n\n- **Result:** Accurately reflects whether a launcher (e.g., `ccache`) is active.  \n\n#### **3. Document MSVC + `ccache` Workflow**  \n\nAdd to `doc/build-windows.md`:  \n\n\n### **Caching MSVC Builds**  \n- **Step 1**: Use Ninja:  \n  ```sh\n  -G \"Ninja\"\n  ```\n- **Step 2**: Configure launcher:  \n  ```sh\n  cmake -B build -DCMAKE_CXX_COMPILER_LAUNCHER=ccache\n  ```\n- **Step 3**: Use `/Z7` (not `/Zi`) for debug flags.  \n\n\n### **Why This Approach?**  \n\n- **Flexibility:** No forced `ccache`/generator logic. Users/CI control launchers via CMake/env vars.  \n- **CMake Compliance:** Follows [CMake best practices](https://cmake.org/cmake/help/latest/envvar/CMAKE_LANG_COMPILER_LAUNCHER.html).  \n- **Simplification:** Deletes 50+ lines of error-prone code.  \n\n### **Feedback Requested**  \n\n- @purpleKarrot: Does this address your concerns about launcher flexibility?  \n- Maintainers (@fanquake, @hebasto): Any objections to deleting `ccache.cmake`?  \n\n\n> I don't understand the motivation for setting `CMAKE_<lang>_COMPILER_LAUNCHER` from inside the project.\n\nI'm also ignorantly curious about this. Is it primarily a requirement from the feature parity list with the prior `autotools`?\n\nhttps://gist.github.com/hebasto/2ef97d3a726bfce08ded9df07f7dab5e\n\nIs the msvc configure summary a blocker for the release? I've removed the milestone from https://github.com/bitcoin/bitcoin/pull/30861 because it looks more like an involved feature than a bugfix, so maybe it can be removed here as well?", "created_at": "2025-03-04 11:47:57", "merge_commit_sha": "c2341ebb5bb6e487806d953bc8d6905e91b5bab9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31849", "base_commit": "af3dee0b8d456a8aa9ade9c6e7f4283a90590eae", "patch": "diff --git a/depends/Makefile b/depends/Makefile\nindex 2841d50ae4a84..f03db29eb3069 100644\n--- a/depends/Makefile\n+++ b/depends/Makefile\n@@ -203,6 +203,7 @@ endif\n $(host_prefix)/toolchain.cmake : toolchain.cmake.in $(host_prefix)/.stamp_$(final_build_id)\n \t@mkdir -p $(@D)\n \tsed -e 's|@depends_crosscompiling@|$(crosscompiling)|' \\\n+            -e 's|@host@|$(host)|' \\\n             -e 's|@host_system_name@|$($(host_os)_cmake_system_name)|' \\\n             -e 's|@host_system_version@|$($(host_os)_cmake_system_version)|' \\\n             -e 's|@host_arch@|$(host_arch)|' \\\ndiff --git a/depends/toolchain.cmake.in b/depends/toolchain.cmake.in\nindex ac24f74ad4f71..28188f6347cfd 100644\n--- a/depends/toolchain.cmake.in\n+++ b/depends/toolchain.cmake.in\n@@ -13,6 +13,10 @@ if(@depends_crosscompiling@)\n   set(CMAKE_SYSTEM_NAME @host_system_name@)\n   set(CMAKE_SYSTEM_VERSION @host_system_version@)\n   set(CMAKE_SYSTEM_PROCESSOR @host_arch@)\n+\n+  set(CMAKE_C_COMPILER_TARGET @host@)\n+  set(CMAKE_CXX_COMPILER_TARGET @host@)\n+  set(CMAKE_OBJCXX_COMPILER_TARGET @host@)\n endif()\n \n if(NOT DEFINED CMAKE_C_FLAGS_INIT)\n", "test_patch": "", "problem_statement": "build: depends cross-compile using Clang fails\nSeems like CMake is getting confused, and trying to build and link a `x86_64` binary, when it's meant to be (and thinks it is, according to the  configure output) building for `aarch64`:\n```bash\nmake -C depends/ CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib STRIP=llvm-strip NO_QT=1 NO_WALLET=1 NO_USDT=1 NO_ZMQ=1 -j18 HOST=aarch64-linux-gnu\n<snip>\ncopying packages: boost libevent\nto: /root/ci_scratch/depends/aarch64-linux-gnu\nTo build Bitcoin Core with these packages, pass '--toolchain /root/ci_scratch/depends/aarch64-linux-gnu/toolchain.cmake' to the first CMake invocation.\n\ncmake -B build --toolchain /root/ci_scratch/depends/aarch64-linux-gnu/toolchain.cmake\n<snip>\nCross compiling ....................... TRUE, for Linux, aarch64\nC++ compiler .......................... Clang 18.1.3, /usr/bin/clang++\n<snip>\ncmake --build build -j18 --target bitcoind --verbose\n[ 98%] Linking CXX executable bitcoind\ncd /root/ci_scratch/build/src && /usr/bin/cmake -E cmake_link_script CMakeFiles/bitcoind.dir/link.txt --verbose=1\n/usr/bin/clang++ -pipe -std=c++20 -O2 -O2 -g -fstack-protector-all -fcf-protection=full -fstack-clash-protection -Wl,-z,relro -Wl,-z,now -Wl,-z,separate-code -fPIE -pie CMakeFiles/bitcoind.dir/bitcoind.cpp.o CMakeFiles/bitcoind.dir/init/bitcoind.cpp.o -o bitcoind  libbitcoin_node.a libbitcoin_common.a libbitcoin_consensus.a secp256k1/lib/libsecp256k1.a util/libbitcoin_util.a crypto/libbitcoin_crypto.a crypto/libbitcoin_crypto_sse41.a crypto/libbitcoin_crypto_avx2.a crypto/libbitcoin_crypto_x86_shani.a ../libleveldb.a ../libcrc32c.a ../libcrc32c_sse42.a ../libminisketch.a univalue/libunivalue.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_pthreads.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_core.a  \n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a: error adding symbols: file in wrong format\nclang++: error: linker command failed with exit code 1 (use -v to see invocation)\ngmake[3]: *** [src/CMakeFiles/bitcoind.dir/build.make:130: src/bitcoind] Error 1\n```\nMaybe there's something missing from the toolchain that we should be passing through. The libs in depends have been compiled for aarch64, i.e:\n```bash\nobjdump -x /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a | grep aarch64\nIn archive /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a:\nevent_tagging.c.o:     file format elf64-littleaarch64\narchitecture: aarch64, flags 0x00000011:\nhttp.c.o:     file format elf64-littleaarch64\n```\n\nHowever CMake is building x86_64 object files:\n```bash\nfile build/CMakeFiles/leveldb.dir/src/leveldb/db/filename.cc.o\nbuild/CMakeFiles/leveldb.dir/src/leveldb/db/filename.cc.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), with debug_info, not stripped\n```\nand binaries:\n```bash\nfile build/src/bitcoin-util \nbuild/src/bitcoin-util: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=4ccab1d492154df5dd9a115e6bbc52371d7439b1, for GNU/Linux 3.2.0, with debug_info, not stripped\n```\n", "hints_text": "Maybe dumb question but are you building on a x86_64 system where `clang` and `clang++` executables produce x86_64 binaries? If so I would guess this is caused by your `CC=clang CXX=clang++` variables.\n> are you building on a x86_64 system where clang and clang++ executables produce x86_64 binaries?\n\nYes.\n\n>  If so I would guess this is caused by your CC=clang CXX=clang++ variables.\n\nNot sure I follow. Depends was configured to cross-compile for aarch64-linux using Clang as the compiler. This has worked fine and produced aarch64 code and libraries. We then pass the toolchain file from depends to CMake (which should contain everything CMake needs to know produce aarch64 linux binaries using the just compiled aarch64 libraries). CMake has configured using Clang as the compiler, and think it's cross-compiling for `aarch64`, according to it's own output:\n> Cross compiling ....................... TRUE, for Linux, aarch64\n\nThen it proceeds to produce `x86_64` code.\nCC=clang CXX=clang++ specify paths to specific compiler binaries, and compiler binaries usually have a default platform that they target. On an x86_64 system they will usually produce x86_64 binaries unless passed additional flags which I don't think the depends system is using.\n\nThe host string aarch64-linux-gnu you are specifying will be used to find the right compiler binaries for that host by default, but if you are overriding the compiler, the compiler you specified will take precedence.\n\nI could be wrong about this or misunderstanding something fundamental but I'd try to do this without the CC=clang CXX=clang++ AR=... stuff if that makes any sense for your use case. If it doesn't make sense please ignore.\n\nYou could also try CC=aarch64-linux-gnu-clang etc or whatever the aarch64 cross-compiler path is\n> You could also try CC=aarch64-linux-gnu-clang etc or whatever the aarch64 cross-compiler path is\n\nYou don't really need to do this with, clang, it is natively a cross-compiler. You can (generally) just pass `--target=whatever`, and generate code for that target, without needing a specially compiled `clang` binary. In this case, by specifying `HOST=aarch64-linux-gnu`, I end up with compiler invocations like `clang --target=aarch64-linux-gnu`, and everything works as expected in depends. The issue seems to be that these flags are not being properly propogated into the CMake toolchain file, and then missing for the Core build.\n> > You could also try CC=aarch64-linux-gnu-clang etc or whatever the aarch64 cross-compiler path is\n> \n> You don't really need to do this with, clang, it is natively a cross-compiler.\n\nYes that is what I meant by \"compiler binaries usually have a default platform that they target\".\n\nMaybe I misunderstood context for your post and thought you were reporting a bug and looking for a workaround, not just reporting a bug. I think I agree that dropping CC=clang or specifying CC=aarch64-linux-gnu-clang would just be workarounds.", "created_at": "2025-02-12 17:00:20", "merge_commit_sha": "e563cb5c60629b2a64c6672a0868d879adf258d7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31844", "base_commit": "96d30ed4f96ff060d91462c6660f34b9b9c26847", "patch": "diff --git a/cmake/module/InstallBinaryComponent.cmake b/cmake/module/InstallBinaryComponent.cmake\nnew file mode 100644\nindex 0000000000000..c7b2ed9ae6a48\n--- /dev/null\n+++ b/cmake/module/InstallBinaryComponent.cmake\n@@ -0,0 +1,26 @@\n+# Copyright (c) 2025-present The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or https://opensource.org/license/mit/.\n+\n+include_guard(GLOBAL)\n+include(GNUInstallDirs)\n+\n+function(install_binary_component component)\n+  cmake_parse_arguments(PARSE_ARGV 1\n+    IC                # prefix\n+    \"HAS_MANPAGE\"     # options\n+    \"\"                # one_value_keywords\n+    \"\"                # multi_value_keywords\n+  )\n+  set(target_name ${component})\n+  install(TARGETS ${target_name}\n+    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n+    COMPONENT ${component}\n+  )\n+  if(INSTALL_MAN AND IC_HAS_MANPAGE)\n+    install(FILES ${PROJECT_SOURCE_DIR}/doc/man/${target_name}.1\n+      DESTINATION ${CMAKE_INSTALL_MANDIR}/man1\n+      COMPONENT ${component}\n+    )\n+  endif()\n+endfunction()\ndiff --git a/cmake/module/Maintenance.cmake b/cmake/module/Maintenance.cmake\nindex 61251d24397b3..bc3868184bf4c 100644\n--- a/cmake/module/Maintenance.cmake\n+++ b/cmake/module/Maintenance.cmake\n@@ -103,7 +103,7 @@ function(add_macos_deploy_target)\n \n     add_custom_command(\n       OUTPUT ${PROJECT_BINARY_DIR}/${macos_app}/Contents/MacOS/Bitcoin-Qt\n-      COMMAND ${CMAKE_COMMAND} --install ${PROJECT_BINARY_DIR} --config $<CONFIG> --component GUI --prefix ${macos_app}/Contents/MacOS --strip\n+      COMMAND ${CMAKE_COMMAND} --install ${PROJECT_BINARY_DIR} --config $<CONFIG> --component bitcoin-qt --prefix ${macos_app}/Contents/MacOS --strip\n       COMMAND ${CMAKE_COMMAND} -E rename ${macos_app}/Contents/MacOS/bin/$<TARGET_FILE_NAME:bitcoin-qt> ${macos_app}/Contents/MacOS/Bitcoin-Qt\n       COMMAND ${CMAKE_COMMAND} -E rm -rf ${macos_app}/Contents/MacOS/bin\n       VERBATIM\ndiff --git a/src/CMakeLists.txt b/src/CMakeLists.txt\nindex 8c42359d2d550..07544f59cfa04 100644\n--- a/src/CMakeLists.txt\n+++ b/src/CMakeLists.txt\n@@ -2,7 +2,6 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or https://opensource.org/license/mit/.\n \n-include(GNUInstallDirs)\n include(AddWindowsResources)\n \n configure_file(${PROJECT_SOURCE_DIR}/cmake/bitcoin-build-config.h.in bitcoin-build-config.h USE_SOURCE_PERMISSIONS @ONLY)\n@@ -170,8 +169,8 @@ target_link_libraries(bitcoin_common\n     $<$<PLATFORM_ID:Windows>:ws2_32>\n )\n \n+include(InstallBinaryComponent)\n \n-set(installable_targets)\n if(ENABLE_WALLET)\n   add_subdirectory(wallet)\n \n@@ -189,7 +188,7 @@ if(ENABLE_WALLET)\n       bitcoin_util\n       Boost::headers\n     )\n-    list(APPEND installable_targets bitcoin-wallet)\n+    install_binary_component(bitcoin-wallet HAS_MANPAGE)\n   endif()\n endif()\n \n@@ -318,7 +317,7 @@ if(BUILD_DAEMON)\n     bitcoin_node\n     $<TARGET_NAME_IF_EXISTS:bitcoin_wallet>\n   )\n-  list(APPEND installable_targets bitcoind)\n+  install_binary_component(bitcoind HAS_MANPAGE)\n endif()\n if(WITH_MULTIPROCESS AND BUILD_DAEMON)\n   add_executable(bitcoin-node\n@@ -331,7 +330,7 @@ if(WITH_MULTIPROCESS AND BUILD_DAEMON)\n     bitcoin_ipc\n     $<TARGET_NAME_IF_EXISTS:bitcoin_wallet>\n   )\n-  list(APPEND installable_targets bitcoin-node)\n+  install_binary_component(bitcoin-node)\n endif()\n \n if(WITH_MULTIPROCESS AND BUILD_TESTS)\n@@ -374,7 +373,7 @@ if(BUILD_CLI)\n     libevent::core\n     libevent::extra\n   )\n-  list(APPEND installable_targets bitcoin-cli)\n+  install_binary_component(bitcoin-cli HAS_MANPAGE)\n endif()\n \n \n@@ -387,7 +386,7 @@ if(BUILD_TX)\n     bitcoin_util\n     univalue\n   )\n-  list(APPEND installable_targets bitcoin-tx)\n+  install_binary_component(bitcoin-tx HAS_MANPAGE)\n endif()\n \n \n@@ -399,7 +398,7 @@ if(BUILD_UTIL)\n     bitcoin_common\n     bitcoin_util\n   )\n-  list(APPEND installable_targets bitcoin-util)\n+  install_binary_component(bitcoin-util HAS_MANPAGE)\n endif()\n \n \n@@ -445,17 +444,3 @@ endif()\n if(BUILD_FUZZ_BINARY)\n   add_subdirectory(test/fuzz)\n endif()\n-\n-\n-install(TARGETS ${installable_targets}\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-)\n-unset(installable_targets)\n-\n-if(INSTALL_MAN)\n-  # TODO: these stubs are no longer needed. man pages should be generated at install time.\n-  install(DIRECTORY ../doc/man/\n-    DESTINATION ${CMAKE_INSTALL_MANDIR}/man1\n-    FILES_MATCHING PATTERN *.1\n-  )\n-endif()\ndiff --git a/src/bench/CMakeLists.txt b/src/bench/CMakeLists.txt\nindex c55bbb1e05f8a..43b0dcdabe6c6 100644\n--- a/src/bench/CMakeLists.txt\n+++ b/src/bench/CMakeLists.txt\n@@ -81,6 +81,4 @@ add_test(NAME bench_sanity_check_high_priority\n   COMMAND bench_bitcoin -sanity-check -priority-level=high\n )\n \n-install(TARGETS bench_bitcoin\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-)\n+install_binary_component(bench_bitcoin)\ndiff --git a/src/kernel/CMakeLists.txt b/src/kernel/CMakeLists.txt\nindex 2e07ba042a40a..9dae4b88111e6 100644\n--- a/src/kernel/CMakeLists.txt\n+++ b/src/kernel/CMakeLists.txt\n@@ -2,6 +2,8 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or https://opensource.org/license/mit/.\n \n+include(GNUInstallDirs)\n+\n # TODO: libbitcoinkernel is a work in progress consensus engine\n #       library, as more and more modules are decoupled from the\n #       consensus engine, this list will shrink to only those\n@@ -121,24 +123,23 @@ if(NOT BUILD_SHARED_LIBS)\n   set(all_kernel_static_link_libs \"\")\n   get_target_static_link_libs(bitcoinkernel all_kernel_static_link_libs)\n \n-  install(TARGETS ${all_kernel_static_link_libs} ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT Kernel)\n+  install(TARGETS ${all_kernel_static_link_libs} ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT bitcoinkernel)\n   list(TRANSFORM all_kernel_static_link_libs PREPEND \"-l\")\n   # LIBS_PRIVATE is substituted in the pkg-config file.\n   list(JOIN all_kernel_static_link_libs \" \" LIBS_PRIVATE)\n endif()\n \n configure_file(${PROJECT_SOURCE_DIR}/libbitcoinkernel.pc.in ${PROJECT_BINARY_DIR}/libbitcoinkernel.pc @ONLY)\n-install(FILES ${PROJECT_BINARY_DIR}/libbitcoinkernel.pc DESTINATION \"${CMAKE_INSTALL_LIBDIR}/pkgconfig\" COMPONENT Kernel)\n+install(FILES ${PROJECT_BINARY_DIR}/libbitcoinkernel.pc DESTINATION \"${CMAKE_INSTALL_LIBDIR}/pkgconfig\" COMPONENT bitcoinkernel)\n \n-include(GNUInstallDirs)\n install(TARGETS bitcoinkernel\n   RUNTIME\n     DESTINATION ${CMAKE_INSTALL_BINDIR}\n-    COMPONENT Kernel\n+    COMPONENT bitcoinkernel\n   LIBRARY\n     DESTINATION ${CMAKE_INSTALL_LIBDIR}\n-    COMPONENT Kernel\n+    COMPONENT bitcoinkernel\n   ARCHIVE\n     DESTINATION ${CMAKE_INSTALL_LIBDIR}\n-    COMPONENT Kernel\n+    COMPONENT bitcoinkernel\n )\ndiff --git a/src/qt/CMakeLists.txt b/src/qt/CMakeLists.txt\nindex a1f39037f220b..7fbbd81c415ae 100644\n--- a/src/qt/CMakeLists.txt\n+++ b/src/qt/CMakeLists.txt\n@@ -236,7 +236,7 @@ target_link_libraries(bitcoin-qt\n )\n \n import_plugins(bitcoin-qt)\n-set(installable_targets bitcoin-qt)\n+install_binary_component(bitcoin-qt HAS_MANPAGE)\n if(WIN32)\n   set_target_properties(bitcoin-qt PROPERTIES WIN32_EXECUTABLE TRUE)\n endif()\n@@ -253,17 +253,12 @@ if(WITH_MULTIPROCESS)\n     bitcoin_ipc\n   )\n   import_plugins(bitcoin-gui)\n-  list(APPEND installable_targets bitcoin-gui)\n+  install_binary_component(bitcoin-gui)\n   if(WIN32)\n     set_target_properties(bitcoin-gui PROPERTIES WIN32_EXECUTABLE TRUE)\n   endif()\n endif()\n \n-install(TARGETS ${installable_targets}\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-  COMPONENT GUI\n-)\n-\n if(BUILD_GUI_TESTS)\n   add_subdirectory(test)\n endif()\n", "test_patch": "diff --git a/ci/test/00_setup_env_mac_native_fuzz.sh b/ci/test/00_setup_env_mac_native_fuzz.sh\nindex 1a453a4353f8c..cacf2423ac30a 100755\n--- a/ci/test/00_setup_env_mac_native_fuzz.sh\n+++ b/ci/test/00_setup_env_mac_native_fuzz.sh\n@@ -14,3 +14,4 @@ export OSX_SDK=\"\"\n export RUN_UNIT_TESTS=false\n export RUN_FUNCTIONAL_TESTS=false\n export RUN_FUZZ_TESTS=true\n+export GOAL=\"all\"\ndiff --git a/ci/test/00_setup_env_native_fuzz.sh b/ci/test/00_setup_env_native_fuzz.sh\nindex 1b5a27bb6cd15..84e57311dcd3a 100755\n--- a/ci/test/00_setup_env_native_fuzz.sh\n+++ b/ci/test/00_setup_env_native_fuzz.sh\n@@ -14,7 +14,7 @@ export NO_DEPENDS=1\n export RUN_UNIT_TESTS=false\n export RUN_FUNCTIONAL_TESTS=false\n export RUN_FUZZ_TESTS=true\n-export GOAL=\"install\"\n+export GOAL=\"all\"\n export CI_CONTAINER_CAP=\"--cap-add SYS_PTRACE\"  # If run with (ASan + LSan), the container needs access to ptrace (https://github.com/google/sanitizers/issues/764)\n export BITCOIN_CONFIG=\"\\\n  -DBUILD_FOR_FUZZING=ON \\\ndiff --git a/src/qt/test/CMakeLists.txt b/src/qt/test/CMakeLists.txt\nindex e1e617661b4d6..3acdfeade3421 100644\n--- a/src/qt/test/CMakeLists.txt\n+++ b/src/qt/test/CMakeLists.txt\n@@ -45,6 +45,4 @@ if(WIN32 AND VCPKG_TARGET_TRIPLET)\n   )\n endif()\n \n-install(TARGETS test_bitcoin-qt\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-)\n+install_binary_component(test_bitcoin-qt)\ndiff --git a/src/test/CMakeLists.txt b/src/test/CMakeLists.txt\nindex 859b913206782..6523407e912e6 100644\n--- a/src/test/CMakeLists.txt\n+++ b/src/test/CMakeLists.txt\n@@ -213,6 +213,4 @@ endfunction()\n \n add_all_test_targets()\n \n-install(TARGETS test_bitcoin\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-)\n+install_binary_component(test_bitcoin)\n", "problem_statement": "build: `cmake --install` fails if only select targets are built\nNoticed this when going to update the [lighting docs](https://github.com/ElementsProject/lightning/blob/master/doc/getting-started/getting-started/installation.md), porting what they do using Autotools. i.e:\n```bash\n./autogen.sh\n./configure\nmake src/bitcoind src/bitcoin-cli\nmake install\n```\n\nIf you attempt the same with master:\n```bash\ncmake -B build\ncmake --build build --target bitcoind bitcoin-cli\ncmake --install build\n-- Install configuration: \"RelWithDebInfo\"\nCMake Error at build/src/test/cmake_install.cmake:57 (file):\n  file INSTALL cannot find \"/root/ci_scratch/build/src/test/test_bitcoin\": No\n  such file or directory.\nCall Stack (most recent call first):\n  build/src/cmake_install.cmake:77 (include)\n  build/cmake_install.cmake:57 (include)\n```\n\nThe output of `cmake --build build --target list_install_components` just prints (if configured with the kernel):\n```bash\ncmake --build build --target list_install_components \n> Available install components are: \"Kernel\" \"Unspecified\"\n```\nso it seems like component based install either isn't yet possible, or the names are not easily discoverable.\n\nOtherwise, I don't think we should fail to install because we can't find a binary the user didn't want.\n", "hints_text": "This is frustrating, but it seems to be how CMake works. `cmake --install build` doesn't force any builds, but `make -C build install` does.\n\nI think what you're really looking for is a way to only build/install certain binaries. For that, the workaround would be to name each one as a separate component. That would allow for:\n```cmake\ncmake -B build\ncmake --build build --target bitcoind bitcoin-cli\ncmake --install build --component bitcoind bitcoin-cli\n```\n> I think what you're really looking for is a way to only build/install certain binaries. For that, the workaround would be to name each one as a separate component. That would allow for:\n> \n> cmake -B build\n> cmake --build build --target bitcoind bitcoin-cli\n> cmake --install build --component bitcoind bitcoin-cli\n\nI agree. We have already [done](https://github.com/bitcoin/bitcoin/pull/30835) it for the `bitcoinkernel` target.\n\nOn the other hand, the [`CMAKE_SKIP_INSTALL_ALL_DEPENDENCY`](https://cmake.org/cmake/help/latest/variable/CMAKE_SKIP_INSTALL_ALL_DEPENDENCY.html) variable seems not a proper solution because it affects the `all` target.", "created_at": "2025-02-11 20:39:22", "merge_commit_sha": "73e2ec13737ea497fec2545aab23564e1b8c4adb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31826", "base_commit": "43e71f74988b2ad87e4bfc0e1b5c921ab86ec176", "patch": "diff --git a/src/random.cpp b/src/random.cpp\nindex 5b605e988d0c5..6acbbcc210a15 100644\n--- a/src/random.cpp\n+++ b/src/random.cpp\n@@ -192,11 +192,13 @@ uint64_t GetRdSeed() noexcept\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n \n bool g_rndr_supported = false;\n+bool g_rndrrs_supported = false;\n \n void InitHardwareRand()\n {\n     if (getauxval(AT_HWCAP2) & HWCAP2_RNG) {\n         g_rndr_supported = true;\n+        g_rndrrs_supported = VerifyRNDRRS();\n     }\n }\n \n@@ -204,8 +206,10 @@ void ReportHardwareRand()\n {\n     // This must be done in a separate function, as InitHardwareRand() may be indirectly called\n     // from global constructors, before logging is initialized.\n-    if (g_rndr_supported) {\n+    if (g_rndr_supported && g_rndrrs_supported) {\n         LogPrintf(\"Using RNDR and RNDRRS as additional entropy sources\\n\");\n+    } else if (g_rndr_supported) {\n+        LogPrintf(\"Using RNDR as an additional entropy source\\n\");\n     }\n }\n \n@@ -227,24 +231,43 @@ uint64_t GetRNDR() noexcept\n     return r1;\n }\n \n-/** Read 64 bits of entropy using rndrrs.\n- *\n+// Helper function to retrieve random value using RNDRRS\n+bool GetRNDRRSInternal(uint64_t &r1) noexcept\n+{\n+    uint8_t ok = 0;\n+    __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n+                     : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n+    return ok != 0;\n+}\n+\n+\n+/** Read 64 bits of entropy using RNDRRS.\n  * Must only be called when RNDRRS is supported.\n  */\n uint64_t GetRNDRRS() noexcept\n {\n-    uint8_t ok = 0;\n     uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n+    while (!GetRNDRRSInternal(r1)) {\n         __asm__ volatile(\"yield\");\n-    } while (true);\n+    }\n     return r1;\n }\n \n+/** Verify if RNDRRS is supported and functional.\n+ * Return true if it works within the retry limit.\n+ */\n+bool VerifyRNDRRS() noexcept\n+{\n+    uint64_t test;\n+    for (int retry = 0; retry < 10; ++retry) {\n+        if (GetRNDRRSInternal(test)) {\n+            return true;\n+        }\n+        __asm__ volatile(\"yield\");\n+    }\n+    return false;\n+}\n+\n #else\n /* Access to other hardware random number generators could be added here later,\n  * assuming it is sufficiently fast (in the order of a few hundred CPU cycles).\n@@ -295,7 +318,7 @@ void SeedHardwareSlow(CSHA512& hasher) noexcept {\n         return;\n     }\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n+    if (g_rndrrs_supported) {\n         for (int i = 0; i < 4; ++i) {\n             uint64_t out = GetRNDRRS();\n             hasher.Write((const unsigned char*)&out, sizeof(out));\n", "test_patch": "", "problem_statement": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13\n### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_\n", "hints_text": "", "created_at": "2025-02-08 10:17:10", "merge_commit_sha": "139640079ff52de5a7935e98225da76686ef32cb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31590", "base_commit": "41a2ce9b7d7354c633c104bab5653f1f60eb2068", "patch": "diff --git a/src/script/descriptor.cpp b/src/script/descriptor.cpp\nindex 2e1a30744ec11..499af47ee553f 100644\n--- a/src/script/descriptor.cpp\n+++ b/src/script/descriptor.cpp\n@@ -312,15 +312,7 @@ class ConstPubkeyProvider final : public PubkeyProvider\n     bool ToPrivateString(const SigningProvider& arg, std::string& ret) const override\n     {\n         CKey key;\n-        if (m_xonly) {\n-            for (const auto& keyid : XOnlyPubKey(m_pubkey).GetKeyIDs()) {\n-                arg.GetKey(keyid, key);\n-                if (key.IsValid()) break;\n-            }\n-        } else {\n-            arg.GetKey(m_pubkey.GetID(), key);\n-        }\n-        if (!key.IsValid()) return false;\n+        if (!GetPrivKey(/*pos=*/0, arg, key)) return false;\n         ret = EncodeSecret(key);\n         return true;\n     }\n@@ -331,7 +323,8 @@ class ConstPubkeyProvider final : public PubkeyProvider\n     }\n     bool GetPrivKey(int pos, const SigningProvider& arg, CKey& key) const override\n     {\n-        return arg.GetKey(m_pubkey.GetID(), key);\n+        return m_xonly ? arg.GetKeyByXOnly(XOnlyPubKey(m_pubkey), key) :\n+                         arg.GetKey(m_pubkey.GetID(), key);\n     }\n     std::optional<CPubKey> GetRootPubKey() const override\n     {\n@@ -1716,7 +1709,7 @@ struct KeyParser {\n         if (miniscript::IsTapscript(m_script_ctx) && end - begin == 32) {\n             XOnlyPubKey pubkey;\n             std::copy(begin, end, pubkey.begin());\n-            if (auto pubkey_provider = InferPubkey(pubkey.GetEvenCorrespondingCPubKey(), ParseContext(), *m_in)) {\n+            if (auto pubkey_provider = InferXOnlyPubkey(pubkey, ParseContext(), *m_in)) {\n                 m_keys.emplace_back();\n                 m_keys.back().push_back(std::move(pubkey_provider));\n                 return key;\ndiff --git a/src/script/signingprovider.h b/src/script/signingprovider.h\nindex efdfd9ee566b0..5b1da681f837f 100644\n--- a/src/script/signingprovider.h\n+++ b/src/script/signingprovider.h\n@@ -136,6 +136,8 @@ class TaprootBuilder\n     std::vector<std::tuple<uint8_t, uint8_t, std::vector<unsigned char>>> GetTreeTuples() const;\n     /** Returns true if there are any tapscripts */\n     bool HasScripts() const { return !m_branch.empty(); }\n+\n+    bool operator==(const TaprootBuilder& other) const { return GetTreeTuples() == other.GetTreeTuples(); }\n };\n \n /** Given a TaprootSpendData and the output key, reconstruct its script tree.\n", "test_patch": "diff --git a/src/test/descriptor_tests.cpp b/src/test/descriptor_tests.cpp\nindex 288ffc66eb6b2..1b4020e0a061c 100644\n--- a/src/test/descriptor_tests.cpp\n+++ b/src/test/descriptor_tests.cpp\n@@ -62,6 +62,15 @@ bool EqualDescriptor(std::string a, std::string b)\n     return a == b;\n }\n \n+bool EqualSigningProviders(const FlatSigningProvider& a, const FlatSigningProvider& b)\n+{\n+    return a.scripts == b.scripts\n+        && a.pubkeys == b.pubkeys\n+        && a.origins == b.origins\n+        && a.keys == b.keys\n+        && a.tr_trees == b.tr_trees;\n+}\n+\n std::string UseHInsteadOfApostrophe(const std::string& desc)\n {\n     std::string ret = desc;\n@@ -214,6 +223,15 @@ void DoCheck(std::string prv, std::string pub, const std::string& norm_pub, int\n             BOOST_CHECK_MESSAGE(EqualDescriptor(prv, prv1), \"Private ser: \" + prv1 + \" Private desc: \" + prv);\n         }\n         BOOST_CHECK(!parse_pub->ToPrivateString(keys_pub, prv1));\n+\n+        // Check that both can ExpandPrivate and get the same SigningProviders\n+        FlatSigningProvider priv_prov;\n+        parse_priv->ExpandPrivate(0, keys_priv, priv_prov);\n+\n+        FlatSigningProvider pub_prov;\n+        parse_pub->ExpandPrivate(0, keys_priv, pub_prov);\n+\n+        BOOST_CHECK_MESSAGE(EqualSigningProviders(priv_prov, pub_prov), \"Private desc: \" + prv + \" Pub desc: \" + pub);\n     }\n \n     // Check that private can produce the normalized descriptors\n@@ -808,6 +826,31 @@ BOOST_AUTO_TEST_CASE(descriptor_test)\n                 {{0x80000000UL + 48, 0x80000000UL + 1, 0x80000000UL, 0x80000000UL + 2, 1, 0}, {0x80000000UL + 48, 0x80000000UL + 1, 0x80000000UL, 0x80000000UL + 2, 1, 1}, {0x80000000UL + 48, 0x80000000UL + 1, 0x80000000UL, 0x80000000UL + 2, 1, 2}},\n             }\n     );\n+    CheckMultipath(\"tr(xprv9yYge4PS54XkYT9KiLfCRwc8Jeuz8DucxQGtuEecJZYhKNiqbPxYHTPzXtskmzWBqdqkRAGsghNmZzNsfU2wstaB3XjDQFPv567aQSSuPyo,l:pk(xprvA1ADjaN8H3HGnZSmt4VF7YdWoV9oNq8jhqhurxsrYycBAFK555cECoaY22KWt6BTRNLuvobW5VQTF89PN3iA485LAg7epazevPyjCa4xTzd/<2;3>))\",\n+        \"tr(xpub6CY33ZvKuS63kwDnpNCCo5YrrgkUXgdUKdCVhd4Dru5gCB3z8wGnqFiUP98Za5pYSYF5KmvBHTY3Ra8FAJGggzBjuHS69WzN8gscPupuZwK,l:pk(xpub6E9a95u27Qqa13XEz62FUgaFMWzHnHrb54dWfMHU7K9A33eDccvUkbu1sHYoByHAgJdR326rWqn9pGZgZHz1afDprW5gGwS4gUX8Ri6aGPZ/<2;3>))\",\n+        {\n+            \"tr(xprv9yYge4PS54XkYT9KiLfCRwc8Jeuz8DucxQGtuEecJZYhKNiqbPxYHTPzXtskmzWBqdqkRAGsghNmZzNsfU2wstaB3XjDQFPv567aQSSuPyo,l:pk(xprvA1ADjaN8H3HGnZSmt4VF7YdWoV9oNq8jhqhurxsrYycBAFK555cECoaY22KWt6BTRNLuvobW5VQTF89PN3iA485LAg7epazevPyjCa4xTzd/2))\",\n+            \"tr(xprv9yYge4PS54XkYT9KiLfCRwc8Jeuz8DucxQGtuEecJZYhKNiqbPxYHTPzXtskmzWBqdqkRAGsghNmZzNsfU2wstaB3XjDQFPv567aQSSuPyo,l:pk(xprvA1ADjaN8H3HGnZSmt4VF7YdWoV9oNq8jhqhurxsrYycBAFK555cECoaY22KWt6BTRNLuvobW5VQTF89PN3iA485LAg7epazevPyjCa4xTzd/3))\",\n+        },\n+        {\n+            \"tr(xpub6CY33ZvKuS63kwDnpNCCo5YrrgkUXgdUKdCVhd4Dru5gCB3z8wGnqFiUP98Za5pYSYF5KmvBHTY3Ra8FAJGggzBjuHS69WzN8gscPupuZwK,l:pk(xpub6E9a95u27Qqa13XEz62FUgaFMWzHnHrb54dWfMHU7K9A33eDccvUkbu1sHYoByHAgJdR326rWqn9pGZgZHz1afDprW5gGwS4gUX8Ri6aGPZ/2))\",\n+            \"tr(xpub6CY33ZvKuS63kwDnpNCCo5YrrgkUXgdUKdCVhd4Dru5gCB3z8wGnqFiUP98Za5pYSYF5KmvBHTY3Ra8FAJGggzBjuHS69WzN8gscPupuZwK,l:pk(xpub6E9a95u27Qqa13XEz62FUgaFMWzHnHrb54dWfMHU7K9A33eDccvUkbu1sHYoByHAgJdR326rWqn9pGZgZHz1afDprW5gGwS4gUX8Ri6aGPZ/3))\",\n+        },\n+        {\n+            \"tr(xpub6CY33ZvKuS63kwDnpNCCo5YrrgkUXgdUKdCVhd4Dru5gCB3z8wGnqFiUP98Za5pYSYF5KmvBHTY3Ra8FAJGggzBjuHS69WzN8gscPupuZwK,l:pk(xpub6E9a95u27Qqa13XEz62FUgaFMWzHnHrb54dWfMHU7K9A33eDccvUkbu1sHYoByHAgJdR326rWqn9pGZgZHz1afDprW5gGwS4gUX8Ri6aGPZ/2))\",\n+            \"tr(xpub6CY33ZvKuS63kwDnpNCCo5YrrgkUXgdUKdCVhd4Dru5gCB3z8wGnqFiUP98Za5pYSYF5KmvBHTY3Ra8FAJGggzBjuHS69WzN8gscPupuZwK,l:pk(xpub6E9a95u27Qqa13XEz62FUgaFMWzHnHrb54dWfMHU7K9A33eDccvUkbu1sHYoByHAgJdR326rWqn9pGZgZHz1afDprW5gGwS4gUX8Ri6aGPZ/3))\",\n+        },\n+        XONLY_KEYS,\n+        {\n+            {{\"512094cb097990da64eebbad7b979b1326f3cbe356357abf4deb4c4ff80c7acbe902\"}},\n+            {{\"5120f091450b88c606f5cbc3f0cebe89e00bc5dd27f92e22f54da06439bc0c401f41\"}},\n+        },\n+        OutputType::BECH32M,\n+        {\n+            {{2}, {}},\n+            {{3}, {}},\n+        }\n+    );\n     CheckUnparsable(\"pkh(xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U/<0;1>/<2;3>)\", \"pkh(xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/<0;1>/<2;3>)\", \"pkh(): Multiple multipath key path specifiers found\");\n     CheckUnparsable(\"pkh([deadbeef/<0;1>]xprv9s21ZrQH143K31xYSDQpPDxsXRTUcvj2iNHm5NUtrGiGG5e2DtALGdso3pGz6ssrdK4PFmM8NSpSBHNqPqm55Qn3LqFtT2emdEXVYsCzC2U/0)\", \"pkh([deadbeef/<0;1>]xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/0)\", \"pkh(): Key path value \\'<0;1>\\' specifies multipath in a section where multipath is not allowed\");\n     CheckUnparsable(\"tr(xprv9s21ZrQH143K2Zu2kTVKcQi9nKhfgJUkYqG73wXsHuhATm1wkt6kcSZeTYEw2PL7krZtJopEYDvBdYWdAai3n3TWUTCVfHvPHqTYJv7smYe/6/*,{pk(xprvA1RpRA33e1JQ7ifknakTFpgNXPmW2YvmhqLQYMmrj4xJXXWYpDPS3xz7iAxn8L39njGVyuoseXzU6rcxFLJ8HFsTjSyQbLYnMpCqE2VbFWc/<1;2;3>/0/*),pk(xprv9s21ZrQH143K3jUwNHoqQNrtzJnJmx4Yup8NkNLdVQCymYbPbJXnPhwkfTfxZfptcs3rLAPUXS39oDLgrNKQGwbGsEmJJ8BU3RzQuvShEG4/0/0/<3;4>/*)})\", \"tr(xpub6B4sSbNr8XFYXqqKB7PeUemqgEaVtCLjgd5Lf2VYtezSHozC7ffCvVNCyu9TCgHntRQdimjV3tHbxmNfocxtuh6saNtZEw91gjXLRhQ3Yar/6/*,{pk(xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/<1;2;3>/0/*),pk(xpub6AhFhZJJGt9YB8i85RfrJ8jT3T2FF5EejDCXqXfm1DAczFEXkk8HD3CXTg2TmKM8wTbSnSw3wPg5JuyLitUrpRmkjn2BQXyZnqJx16AGy94/0/0/<3;4>/*)})\", \"tr(): Multipath subscripts have mismatched lengths\");\n", "problem_statement": "P2TR Spending Bug - Signing Transaction Failed\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nSome Segwit Version 1 Addresses generated with [Achow101's Rust-Vanitygen](https://github.com/achow101/rust-vanitygen), or more generally some random Addresses imported using the `tr(<WIF Private Key>)` Descriptor, cause an issue when spending coins using them. Generally, the \"Signing transaction failed\" error occurs and the transaction is not created. Though, a workaround still allows to spend the coins.\n\nI don't know if the issue is exclusive to P2TR, but never encountered such problems with Vanity Version 0 Addresses in the past... I also did not encounter such issue with P2TR Addresses directly generated in Bitcoin Core with `getnewaddress` or so.\n\nMaybe it is the same issue as #5828, which was however not been reported with a concrete and reproducible example, and was closed since long... If so, then it would mean that other Address Types may be affected as TapRoot did not exist at this time. I have not found other duplicates, but sorry if I missed one...\n\n### Expected behaviour\n\nBeing able to spend using these Addresses without workarounds.\n\n### Steps to reproduce\n\n* Optional: Generate a Vanity P2TR Address with the [Achow101's Rust-Vanitygen](https://github.com/achow101/rust-vanitygen), modding it or converting the Private Key from Mainnet to Testnet if necessary. Or simply some [random WIF Private Key](https://learnmeabitcoin.com/technical/keys/private-key/wif/). Some Addresses will work, others exhibit the present issue... It seems that there is a significant proportion falling in the second case...\n* For convenience, you can simply use this one made for this Bug Report:\n```\ninternal_privkey: cNKAo2ZRsaWKcP481cEfj3astPyBrfq56JBtLeRhHUvTSuk2z4MR\ninternal_pubkey: ac414af4b822d67307fe81bef0a72ddf0be9e6ff129eb1270b1168126f619619\nAddress: tb1ptestamfzz5zguhrad6xuf7afua0csz5m6k2qclpnpkvsl20t856sxz2d89\n```\n* Import the Address, for example in Testnet4 via the Bitcoin-Qt Console: \n```\nimportdescriptors '[{\"desc\": \"tr(cNKAo2ZRsaWKcP481cEfj3astPyBrfq56JBtLeRhHUvTSuk2z4MR)#vhsk8sfh\", \"timestamp\":0}]'\n```\n* Optional: get some coins from a Testnet4 Faucet (or any other source) for this tb1ptestamfzz5zguhrad6xuf7afua0csz5m6k2qclpnpkvsl20t856sxz2d89 Address. When I submitted the Issue, there were some coins left...\n* Optional: Send some amount involving this Address. Immediately after importing the Address, it appears that there is no particular issue. See Transaction [a301d660523de70542d30490052f9e04ba3f9b5e26482745c7dbdc952802f103](https://mempool.space/testnet4/tx/a301d660523de70542d30490052f9e04ba3f9b5e26482745c7dbdc952802f103).\n* Restart Bitcoin Core, and try sending again some amount. The interface now shows a \"Signing transaction failed\" dialog followed by \"Transaction creation failed!\". Or, in the Console,\n```\nsendtoaddress tb1qn9rvr53m7qvrpysx48svuxsgahs88xfsskx367 0.0001\nSigning transaction failed (code -6)\n```\n* However, if a new Wallet is created, and the Descriptor is imported again as above, sending coins is possible again (until Bitcoin Core is restarted again). The process can be repeated to further reuse the Address (which is obviously not practical).\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@228aba2c4d9ac0b2ca3edd3c2cdf0a92e55f669b\n\n### Operating system and version\n\nDebian 13 Testing\n\n### Machine specifications\n\n_No response_\n", "hints_text": "", "created_at": "2025-01-02 05:04:40", "merge_commit_sha": "d7f56cc5d9e12ad31dd1ce8b34c3ff4ec5c1b70c", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31384", "base_commit": "94ca99ac51dddbee79d6409ebcc43b1119b0aca9", "patch": "diff --git a/doc/release-notes-31384.md b/doc/release-notes-31384.md\nnew file mode 100644\nindex 0000000000000..9256ec16f4621\n--- /dev/null\n+++ b/doc/release-notes-31384.md\n@@ -0,0 +1,34 @@\n+- Node and Mining\n+\n+---\n+\n+- **PR #31384** fixed an issue where block reserved weight for fixed-size block header, transactions count,\n+  and coinbase transaction was done in two separate places.\n+  Before this pull request, the policy default for the maximum block weight was `3,996,000` WU, calculated by\n+  subtracting `4,000 WU` from the `4,000,000 WU` consensus limit to account for the fixed-size block header,\n+  transactions count, and coinbase transaction. During block assembly, Bitcoin Core clamped custom `-blockmaxweight`\n+  value to not be more than the policy default.\n+\n+  Additionally, the mining code added another `4,000 WU` to the initial reservation, reducing the effective block template\n+  size to `3,992,000 WU`.\n+\n+  Due to this issue, the total reserved weight was always `8,000 WU`, meaning that even when specifying a `-blockmaxweight`\n+  higher than the policy default, the actual block size never exceeded `3,992,000 WU`.\n+\n+  The fix consolidates the reservation into a single place and introduces a new startup option,\n+  `-blockreservedweight` (default: `8,000 WU`). This startup option specifies the reserved weight for\n+  the fixed-size block header, transactions count, and coinbase transaction.\n+  The default value of `-blockreservedweight` was chosen to preserve the previous behavior.\n+\n+  **Upgrade Note:** The default `-blockreservedweight` ensures backward compatibility for users who relied on the previous behavior.\n+\n+  Users who manually set `-blockmaxweight` to its maximum value of `4,000,000 WU` should be aware that this\n+  value previously had no effect since it was clamped to `3,996,000 WU`.\n+\n+  Users lowering `-blockreservedweight` should ensure that the total weight (for the block header, transaction count, and coinbase transaction)\n+   does not exceed the reduced value.\n+\n+  As a safety check, Bitcoin core will **fail to start** when `-blockreservedweight` init parameter value is lower than `2000` weight units.\n+\n+  Bitcoin Core will also **fail to start** if the `-blockmaxweight` or `-blockreservedweight` init parameter exceeds\n+  consensus limit of `4,000,000` weight units.\ndiff --git a/src/init.cpp b/src/init.cpp\nindex 1f597cb7cb29e..03c525d5b4983 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -19,6 +19,7 @@\n #include <common/args.h>\n #include <common/system.h>\n #include <consensus/amount.h>\n+#include <consensus/consensus.h>\n #include <deploymentstatus.h>\n #include <hash.h>\n #include <httprpc.h>\n@@ -648,6 +649,7 @@ void SetupServerArgs(ArgsManager& argsman, bool can_listen_ipc)\n \n \n     argsman.AddArg(\"-blockmaxweight=<n>\", strprintf(\"Set maximum BIP141 block weight (default: %d)\", DEFAULT_BLOCK_MAX_WEIGHT), ArgsManager::ALLOW_ANY, OptionsCategory::BLOCK_CREATION);\n+    argsman.AddArg(\"-blockreservedweight=<n>\", strprintf(\"Reserve space for the fixed-size block header plus the largest coinbase transaction the mining software may add to the block. (default: %d).\", DEFAULT_BLOCK_RESERVED_WEIGHT), ArgsManager::ALLOW_ANY, OptionsCategory::BLOCK_CREATION);\n     argsman.AddArg(\"-blockmintxfee=<amt>\", strprintf(\"Set lowest fee rate (in %s/kvB) for transactions to be included in block creation. (default: %s)\", CURRENCY_UNIT, FormatMoney(DEFAULT_BLOCK_MIN_TX_FEE)), ArgsManager::ALLOW_ANY, OptionsCategory::BLOCK_CREATION);\n     argsman.AddArg(\"-blockversion=<n>\", \"Override block version to test forking scenarios\", ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::BLOCK_CREATION);\n \n@@ -1015,6 +1017,23 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         }\n     }\n \n+    if (args.IsArgSet(\"-blockmaxweight\")) {\n+        const auto max_block_weight = args.GetIntArg(\"-blockmaxweight\", DEFAULT_BLOCK_MAX_WEIGHT);\n+        if (max_block_weight > MAX_BLOCK_WEIGHT) {\n+            return InitError(strprintf(_(\"Specified -blockmaxweight (%d) exceeds consensus maximum block weight (%d)\"), max_block_weight, MAX_BLOCK_WEIGHT));\n+        }\n+    }\n+\n+    if (args.IsArgSet(\"-blockreservedweight\")) {\n+        const auto block_reserved_weight = args.GetIntArg(\"-blockreservedweight\", DEFAULT_BLOCK_RESERVED_WEIGHT);\n+        if (block_reserved_weight > MAX_BLOCK_WEIGHT) {\n+            return InitError(strprintf(_(\"Specified -blockreservedweight (%d) exceeds consensus maximum block weight (%d)\"), block_reserved_weight, MAX_BLOCK_WEIGHT));\n+        }\n+        if (block_reserved_weight < MINIMUM_BLOCK_RESERVED_WEIGHT) {\n+            return InitError(strprintf(_(\"Specified -blockreservedweight (%d) is lower than minimum safety value of (%d)\"), block_reserved_weight, MINIMUM_BLOCK_RESERVED_WEIGHT));\n+        }\n+    }\n+\n     nBytesPerSigOp = args.GetIntArg(\"-bytespersigop\", nBytesPerSigOp);\n \n     if (!g_wallet_init_interface.ParameterInteraction()) return false;\ndiff --git a/src/ipc/capnp/mining.capnp b/src/ipc/capnp/mining.capnp\nindex 50b07bda708b7..e57d6679e184a 100644\n--- a/src/ipc/capnp/mining.capnp\n+++ b/src/ipc/capnp/mining.capnp\n@@ -35,7 +35,7 @@ interface BlockTemplate $Proxy.wrap(\"interfaces::BlockTemplate\") {\n \n struct BlockCreateOptions $Proxy.wrap(\"node::BlockCreateOptions\") {\n     useMempool @0 :Bool $Proxy.name(\"use_mempool\");\n-    coinbaseMaxAdditionalWeight @1 :UInt64 $Proxy.name(\"coinbase_max_additional_weight\");\n+    blockReservedWeight @1 :UInt64 $Proxy.name(\"block_reserved_weight\");\n     coinbaseOutputMaxAdditionalSigops @2 :UInt64 $Proxy.name(\"coinbase_output_max_additional_sigops\");\n }\n \ndiff --git a/src/node/miner.cpp b/src/node/miner.cpp\nindex 0ff5a1eadead1..b595d91ed97a7 100644\n--- a/src/node/miner.cpp\n+++ b/src/node/miner.cpp\n@@ -67,11 +67,12 @@ void RegenerateCommitments(CBlock& block, ChainstateManager& chainman)\n \n static BlockAssembler::Options ClampOptions(BlockAssembler::Options options)\n {\n-    Assert(options.coinbase_max_additional_weight <= DEFAULT_BLOCK_MAX_WEIGHT);\n+    Assert(options.block_reserved_weight <= MAX_BLOCK_WEIGHT);\n+    Assert(options.block_reserved_weight >= MINIMUM_BLOCK_RESERVED_WEIGHT);\n     Assert(options.coinbase_output_max_additional_sigops <= MAX_BLOCK_SIGOPS_COST);\n-    // Limit weight to between coinbase_max_additional_weight and DEFAULT_BLOCK_MAX_WEIGHT for sanity:\n-    // Coinbase (reserved) outputs can safely exceed -blockmaxweight, but the rest of the block template will be empty.\n-    options.nBlockMaxWeight = std::clamp<size_t>(options.nBlockMaxWeight, options.coinbase_max_additional_weight, DEFAULT_BLOCK_MAX_WEIGHT);\n+    // Limit weight to between block_reserved_weight and MAX_BLOCK_WEIGHT for sanity:\n+    // block_reserved_weight can safely exceed -blockmaxweight, but the rest of the block template will be empty.\n+    options.nBlockMaxWeight = std::clamp<size_t>(options.nBlockMaxWeight, options.block_reserved_weight, MAX_BLOCK_WEIGHT);\n     return options;\n }\n \n@@ -91,14 +92,15 @@ void ApplyArgsManOptions(const ArgsManager& args, BlockAssembler::Options& optio\n         if (const auto parsed{ParseMoney(*blockmintxfee)}) options.blockMinFeeRate = CFeeRate{*parsed};\n     }\n     options.print_modified_fee = args.GetBoolArg(\"-printpriority\", options.print_modified_fee);\n+    options.block_reserved_weight = args.GetIntArg(\"-blockreservedweight\", options.block_reserved_weight);\n }\n \n void BlockAssembler::resetBlock()\n {\n     inBlock.clear();\n \n-    // Reserve space for coinbase tx\n-    nBlockWeight = m_options.coinbase_max_additional_weight;\n+    // Reserve space for fixed-size block header, txs count, and coinbase tx.\n+    nBlockWeight = m_options.block_reserved_weight;\n     nBlockSigOpsCost = m_options.coinbase_output_max_additional_sigops;\n \n     // These counters do not include coinbase tx\n@@ -386,7 +388,7 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n             ++nConsecutiveFailed;\n \n             if (nConsecutiveFailed > MAX_CONSECUTIVE_FAILURES && nBlockWeight >\n-                    m_options.nBlockMaxWeight - m_options.coinbase_max_additional_weight) {\n+                    m_options.nBlockMaxWeight - m_options.block_reserved_weight) {\n                 // Give up if we're close to full and haven't succeeded in a while\n                 break;\n             }\ndiff --git a/src/node/miner.h b/src/node/miner.h\nindex 3c4c66b0badf0..18e19ea158d7c 100644\n--- a/src/node/miner.h\n+++ b/src/node/miner.h\n@@ -176,7 +176,9 @@ class BlockAssembler\n     /** Construct a new block template */\n     std::unique_ptr<CBlockTemplate> CreateNewBlock();\n \n+    /** The number of transactions in the last assembled block (excluding coinbase transaction) */\n     inline static std::optional<int64_t> m_last_block_num_txs{};\n+    /** The weight of the last assembled block (including reserved weight for block header, txs count and coinbase tx) */\n     inline static std::optional<int64_t> m_last_block_weight{};\n \n private:\ndiff --git a/src/node/types.h b/src/node/types.h\nindex 4b0de084ab3d0..290bbc23f1401 100644\n--- a/src/node/types.h\n+++ b/src/node/types.h\n@@ -14,6 +14,7 @@\n #define BITCOIN_NODE_TYPES_H\n \n #include <cstddef>\n+#include <policy/policy.h>\n #include <script/script.h>\n \n namespace node {\n@@ -34,11 +35,10 @@ struct BlockCreateOptions {\n      */\n     bool use_mempool{true};\n     /**\n-     * The maximum additional weight which the pool will add to the coinbase\n-     * scriptSig, witness and outputs. This must include any additional\n-     * weight needed for larger CompactSize encoded lengths.\n+     * The default reserved weight for the fixed-size block header,\n+     * transaction count and coinbase transaction.\n      */\n-    size_t coinbase_max_additional_weight{4000};\n+    size_t block_reserved_weight{DEFAULT_BLOCK_RESERVED_WEIGHT};\n     /**\n      * The maximum additional sigops which the pool will add in coinbase\n      * transaction outputs.\ndiff --git a/src/policy/policy.h b/src/policy/policy.h\nindex 4412f2db87ab1..2151ec13dd04a 100644\n--- a/src/policy/policy.h\n+++ b/src/policy/policy.h\n@@ -20,7 +20,14 @@ class CFeeRate;\n class CScript;\n \n /** Default for -blockmaxweight, which controls the range of block weights the mining code will create **/\n-static constexpr unsigned int DEFAULT_BLOCK_MAX_WEIGHT{MAX_BLOCK_WEIGHT - 4000};\n+static constexpr unsigned int DEFAULT_BLOCK_MAX_WEIGHT{MAX_BLOCK_WEIGHT};\n+/** Default for -blockreservedweight **/\n+static constexpr unsigned int DEFAULT_BLOCK_RESERVED_WEIGHT{8000};\n+/** This accounts for the block header, var_int encoding of the transaction count and a minimally viable\n+ * coinbase transaction. It adds an additional safety margin, because even with a thorough understanding\n+ * of block serialization, it's easy to make a costly mistake when trying to squeeze every last byte.\n+ * Setting a lower value is prevented at startup. */\n+static constexpr unsigned int MINIMUM_BLOCK_RESERVED_WEIGHT{2000};\n /** Default for -blockmintxfee, which sets the minimum feerate for a transaction in blocks created by mining code **/\n static constexpr unsigned int DEFAULT_BLOCK_MIN_TX_FEE{1000};\n /** The maximum weight for transactions we're willing to relay/mine */\ndiff --git a/src/rpc/mining.cpp b/src/rpc/mining.cpp\nindex 5e3d1120e3201..702925785bfc8 100644\n--- a/src/rpc/mining.cpp\n+++ b/src/rpc/mining.cpp\n@@ -419,8 +419,8 @@ static RPCHelpMan getmininginfo()\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"blocks\", \"The current block\"},\n-                        {RPCResult::Type::NUM, \"currentblockweight\", /*optional=*/true, \"The block weight of the last assembled block (only present if a block was ever assembled)\"},\n-                        {RPCResult::Type::NUM, \"currentblocktx\", /*optional=*/true, \"The number of block transactions of the last assembled block (only present if a block was ever assembled)\"},\n+                        {RPCResult::Type::NUM, \"currentblockweight\", /*optional=*/true, \"The block weight (including reserved weight for block header, txs count and coinbase tx) of the last assembled block (only present if a block was ever assembled)\"},\n+                        {RPCResult::Type::NUM, \"currentblocktx\", /*optional=*/true, \"The number of block transactions (excluding coinbase) of the last assembled block (only present if a block was ever assembled)\"},\n                         {RPCResult::Type::STR_HEX, \"bits\", \"The current nBits, compact representation of the block difficulty target\"},\n                         {RPCResult::Type::NUM, \"difficulty\", \"The current difficulty\"},\n                         {RPCResult::Type::STR_HEX, \"target\", \"The current target\"},\n", "test_patch": "diff --git a/src/test/fuzz/mini_miner.cpp b/src/test/fuzz/mini_miner.cpp\nindex 817bc0f18e566..baa28affceca9 100644\n--- a/src/test/fuzz/mini_miner.cpp\n+++ b/src/test/fuzz/mini_miner.cpp\n@@ -13,6 +13,7 @@\n \n #include <node/miner.h>\n #include <node/mini_miner.h>\n+#include <node/types.h>\n #include <primitives/transaction.h>\n #include <random.h>\n #include <txmempool.h>\n@@ -157,9 +158,10 @@ FUZZ_TARGET(mini_miner_selection, .init = initialize_miner)\n             }\n         }\n \n-        // Stop if pool reaches DEFAULT_BLOCK_MAX_WEIGHT because BlockAssembler will stop when the\n+        const auto block_adjusted_max_weight = MAX_BLOCK_WEIGHT - DEFAULT_BLOCK_RESERVED_WEIGHT;\n+        // Stop if pool reaches block_adjusted_max_weight because BlockAssembler will stop when the\n         // block template reaches that, but the MiniMiner will keep going.\n-        if (pool.GetTotalTxSize() + GetVirtualTransactionSize(*tx) >= DEFAULT_BLOCK_MAX_WEIGHT) break;\n+        if (pool.GetTotalTxSize() + GetVirtualTransactionSize(*tx) >= block_adjusted_max_weight) break;\n         TestMemPoolEntryHelper entry;\n         const CAmount fee{ConsumeMoney(fuzzed_data_provider, /*max=*/MAX_MONEY/100000)};\n         assert(MoneyRange(fee));\n@@ -181,7 +183,7 @@ FUZZ_TARGET(mini_miner_selection, .init = initialize_miner)\n \n     node::BlockAssembler::Options miner_options;\n     miner_options.blockMinFeeRate = target_feerate;\n-    miner_options.nBlockMaxWeight = DEFAULT_BLOCK_MAX_WEIGHT;\n+    miner_options.nBlockMaxWeight = MAX_BLOCK_WEIGHT;\n     miner_options.test_block_validity = false;\n     miner_options.coinbase_output_script = CScript() << OP_0;\n \ndiff --git a/test/functional/mining_basic.py b/test/functional/mining_basic.py\nindex 979eda7d04218..29fb8241e33a6 100755\n--- a/test/functional/mining_basic.py\n+++ b/test/functional/mining_basic.py\n@@ -26,7 +26,11 @@\n     CBlock,\n     CBlockHeader,\n     COIN,\n+    DEFAULT_BLOCK_RESERVED_WEIGHT,\n+    MAX_BLOCK_WEIGHT,\n+    MINIMUM_BLOCK_RESERVED_WEIGHT,\n     ser_uint256,\n+    WITNESS_SCALE_FACTOR\n )\n from test_framework.p2p import P2PDataStore\n from test_framework.test_framework import BitcoinTestFramework\n@@ -77,7 +81,7 @@ def mine_chain(self):\n         mining_info = self.nodes[0].getmininginfo()\n         assert_equal(mining_info['blocks'], 200)\n         assert_equal(mining_info['currentblocktx'], 0)\n-        assert_equal(mining_info['currentblockweight'], 4000)\n+        assert_equal(mining_info['currentblockweight'], DEFAULT_BLOCK_RESERVED_WEIGHT)\n \n         self.log.info('test blockversion')\n         self.restart_node(0, extra_args=[f'-mocktime={t}', '-blockversion=1337'])\n@@ -193,6 +197,116 @@ def test_pruning(self):\n         assert_equal(result, \"inconclusive\")\n         assert_equal(prune_node.getblock(pruned_blockhash, verbosity=0), pruned_block)\n \n+\n+    def send_transactions(self, utxos, fee_rate, target_vsize):\n+        \"\"\"\n+        Helper to create and send transactions with the specified target virtual size and fee rate.\n+        \"\"\"\n+        for utxo in utxos:\n+            self.wallet.send_self_transfer(\n+                from_node=self.nodes[0],\n+                utxo_to_spend=utxo,\n+                target_vsize=target_vsize,\n+                fee_rate=fee_rate,\n+            )\n+\n+    def verify_block_template(self, expected_tx_count, expected_weight):\n+        \"\"\"\n+        Create a block template and check that it satisfies the expected transaction count and total weight.\n+        \"\"\"\n+        response = self.nodes[0].getblocktemplate(NORMAL_GBT_REQUEST_PARAMS)\n+        self.log.info(f\"Testing block template: contains {expected_tx_count} transactions, and total weight <= {expected_weight}\")\n+        assert_equal(len(response[\"transactions\"]), expected_tx_count)\n+        total_weight = sum(transaction[\"weight\"] for transaction in response[\"transactions\"])\n+        assert_greater_than_or_equal(expected_weight, total_weight)\n+\n+    def test_block_max_weight(self):\n+        self.log.info(\"Testing default and custom -blockmaxweight startup options.\")\n+\n+        # Restart the node to allow large transactions\n+        LARGE_TXS_COUNT = 10\n+        LARGE_VSIZE = int(((MAX_BLOCK_WEIGHT - DEFAULT_BLOCK_RESERVED_WEIGHT) / WITNESS_SCALE_FACTOR) / LARGE_TXS_COUNT)\n+        HIGH_FEERATE = Decimal(\"0.0003\")\n+        self.restart_node(0, extra_args=[f\"-datacarriersize={LARGE_VSIZE}\"])\n+\n+        # Ensure the mempool is empty\n+        assert_equal(len(self.nodes[0].getrawmempool()), 0)\n+\n+        # Generate UTXOs and send 10 large transactions with a high fee rate\n+        utxos = [self.wallet.get_utxo(confirmed_only=True) for _ in range(LARGE_TXS_COUNT + 4)] # Add 4 more utxos that will be used in the test later\n+        self.send_transactions(utxos[:LARGE_TXS_COUNT], HIGH_FEERATE, LARGE_VSIZE)\n+\n+        # Send 2 normal transactions with a lower fee rate\n+        NORMAL_VSIZE = int(2000 / WITNESS_SCALE_FACTOR)\n+        NORMAL_FEERATE = Decimal(\"0.0001\")\n+        self.send_transactions(utxos[LARGE_TXS_COUNT:LARGE_TXS_COUNT + 2], NORMAL_FEERATE, NORMAL_VSIZE)\n+\n+        # Check that the mempool contains all transactions\n+        self.log.info(f\"Testing that the mempool contains {LARGE_TXS_COUNT + 2} transactions.\")\n+        assert_equal(len(self.nodes[0].getrawmempool()), LARGE_TXS_COUNT + 2)\n+\n+        # Verify the block template includes only the 10 high-fee transactions\n+        self.log.info(\"Testing that the block template includes only the 10 large transactions.\")\n+        self.verify_block_template(\n+            expected_tx_count=LARGE_TXS_COUNT,\n+            expected_weight=MAX_BLOCK_WEIGHT - DEFAULT_BLOCK_RESERVED_WEIGHT,\n+        )\n+\n+        # Test block template creation with custom -blockmaxweight\n+        custom_block_weight = MAX_BLOCK_WEIGHT - 2000\n+        # Reducing the weight by 2000 units will prevent 1 large transaction from fitting into the block.\n+        self.restart_node(0, extra_args=[f\"-datacarriersize={LARGE_VSIZE}\", f\"-blockmaxweight={custom_block_weight}\"])\n+\n+        self.log.info(\"Testing the block template with custom -blockmaxweight to include 9 large and 2 normal transactions.\")\n+        self.verify_block_template(\n+            expected_tx_count=11,\n+            expected_weight=MAX_BLOCK_WEIGHT - DEFAULT_BLOCK_RESERVED_WEIGHT - 2000,\n+        )\n+\n+        # Ensure the block weight does not exceed the maximum\n+        self.log.info(f\"Testing that the block weight will never exceed {MAX_BLOCK_WEIGHT - DEFAULT_BLOCK_RESERVED_WEIGHT}.\")\n+        self.restart_node(0, extra_args=[f\"-datacarriersize={LARGE_VSIZE}\", f\"-blockmaxweight={MAX_BLOCK_WEIGHT}\"])\n+        self.log.info(\"Sending 2 additional normal transactions to fill the mempool to the maximum block weight.\")\n+        self.send_transactions(utxos[LARGE_TXS_COUNT + 2:], NORMAL_FEERATE, NORMAL_VSIZE)\n+        self.log.info(f\"Testing that the mempool's weight matches the maximum block weight: {MAX_BLOCK_WEIGHT}.\")\n+        assert_equal(self.nodes[0].getmempoolinfo()['bytes'] * WITNESS_SCALE_FACTOR, MAX_BLOCK_WEIGHT)\n+\n+        self.log.info(\"Testing that the block template includes only 10 transactions and cannot reach full block weight.\")\n+        self.verify_block_template(\n+            expected_tx_count=LARGE_TXS_COUNT,\n+            expected_weight=MAX_BLOCK_WEIGHT - DEFAULT_BLOCK_RESERVED_WEIGHT,\n+        )\n+\n+        self.log.info(\"Test -blockreservedweight startup option.\")\n+        # Lowering the -blockreservedweight by 4000 will allow for two more transactions.\n+        self.restart_node(0, extra_args=[f\"-datacarriersize={LARGE_VSIZE}\", \"-blockreservedweight=4000\"])\n+        self.verify_block_template(\n+            expected_tx_count=12,\n+            expected_weight=MAX_BLOCK_WEIGHT - 4000,\n+        )\n+\n+        self.log.info(\"Test that node will fail to start when user provide invalid -blockreservedweight\")\n+        self.stop_node(0)\n+        self.nodes[0].assert_start_raises_init_error(\n+            extra_args=[f\"-blockreservedweight={MAX_BLOCK_WEIGHT + 1}\"],\n+            expected_msg=f\"Error: Specified -blockreservedweight ({MAX_BLOCK_WEIGHT + 1}) exceeds consensus maximum block weight ({MAX_BLOCK_WEIGHT})\",\n+        )\n+\n+        self.log.info(f\"Test that node will fail to start when user provide -blockreservedweight below {MINIMUM_BLOCK_RESERVED_WEIGHT}\")\n+        self.stop_node(0)\n+        self.nodes[0].assert_start_raises_init_error(\n+            extra_args=[f\"-blockreservedweight={MINIMUM_BLOCK_RESERVED_WEIGHT - 1}\"],\n+            expected_msg=f\"Error: Specified -blockreservedweight ({MINIMUM_BLOCK_RESERVED_WEIGHT - 1}) is lower than minimum safety value of ({MINIMUM_BLOCK_RESERVED_WEIGHT})\",\n+        )\n+\n+        self.log.info(\"Test that node will fail to start when user provide invalid -blockmaxweight\")\n+        self.stop_node(0)\n+        self.nodes[0].assert_start_raises_init_error(\n+            extra_args=[f\"-blockmaxweight={MAX_BLOCK_WEIGHT + 1}\"],\n+            expected_msg=f\"Error: Specified -blockmaxweight ({MAX_BLOCK_WEIGHT + 1}) exceeds consensus maximum block weight ({MAX_BLOCK_WEIGHT})\",\n+        )\n+\n+\n     def run_test(self):\n         node = self.nodes[0]\n         self.wallet = MiniWallet(node)\n@@ -418,6 +532,7 @@ def chain_tip(b_hash, *, status='headers-only', branchlen=1):\n         assert_equal(node.submitblock(hexdata=block.serialize().hex()), 'duplicate')  # valid\n \n         self.test_blockmintxfee_parameter()\n+        self.test_block_max_weight()\n         self.test_timewarp()\n         self.test_pruning()\n \ndiff --git a/test/functional/test_framework/messages.py b/test/functional/test_framework/messages.py\nindex b4a5d9d5efa69..9ebb683a9db0a 100755\n--- a/test/functional/test_framework/messages.py\n+++ b/test/functional/test_framework/messages.py\n@@ -33,6 +33,8 @@\n \n MAX_LOCATOR_SZ = 101\n MAX_BLOCK_WEIGHT = 4000000\n+DEFAULT_BLOCK_RESERVED_WEIGHT = 8000\n+MINIMUM_BLOCK_RESERVED_WEIGHT = 2000\n MAX_BLOOM_FILTER_SIZE = 36000\n MAX_BLOOM_HASH_FUNCS = 50\n \n", "problem_statement": "Duplicate coinbase transaction space reservation in CreateNewBlock\nIn `BlockAssembler::CreateNewBlock`, we initiate `nBlockWeight` to 4000 WU, reserving space for\r\ncoinbase transaction.\r\n\r\nLatter on, while iterating on transactions for block inclusion in `addPackagesTxs`, we verify that candidate package doesn't overflow the max block weight. This check is done in `TestPackage` against `nBlockMaxWeight`. However, default value is DEFAULT_BLOCK_MAX_WEIGHT which is equal to MAX_BLOCK_WEIGHT - 4000 (L20 in `src/policy/policy.cpp`). So block weight assembled is starting at 4000 WU and can't overflow 3996000 WU.\r\n\r\nDo we have duplicated coinbase transaction space reservation ? I can see this a safety margin to avoid creating invalid blocks if you create inflated coinbase transaction, at the price of few weight units leftover.\r\n\r\nIf so, maybe we should leave it as it is but document this behavior, I was surprised hitting this while scratching unrelated tests.\r\n\r\nSee [comment](https://github.com/bitcoin/bitcoin/pull/11100#discussion_r135124178) in #11100\n", "hints_text": "This is actually pretty interesting: I quickly looked through the weight of the last 50-60 blocks and F2Pool is the ONLY pool generating blocks with total weight higher greater than 3,996,000. I started writing a unit test for this, it seems like that double coinbase reservation may actually put miners who rely on bitcoin core template generation at a disadvantage.\r\n\r\nAnd actually it looks like ALL of F2Pool's recent blocks are actually > 3,996,000 in weight. They may be the only pool using their own software to create block templates?\n> And actually it looks like ALL of F2Pool's recent blocks are actually > 3,996,000 in weight. They may be the only pool using their own software to create block templates?\r\n\r\nI'm fairly certain they use Bitcoin Core. You can control the max block weight with `-blockmaxweight` (default is 3996000 WU). Also, F2Pool is known for running with custom patches on top of Bitcoin Core to maximize fees: e.g. they reduced the number of sigops reserved for the coinbase. This [bit them twice](https://twitter.com/0xB10C/status/1643871608401014785) a few months ago due to not keeping that patch up-to-date.\r\n\r\nEnd of last year, Poolin also mined blocks with more than the default max block weight. See for example [762816](https://miningpool.observer/template-and-block/00000000000000000002373c6610fe88ca7a48023a7ffac351f1ff388dea93cb). The EclipseMC pool mined a few, for example, [752015](https://miningpool.observer/template-and-block/00000000000000000006e05b1e14860d33517d10bad0cf38f62aa452c1365bd2), the Huobi Pool with e.g. [710871](https://miningpool.observer/template-and-block/0000000000000000000451109149b22d6716fd1c9200c08ee295b0c6b6d82d28), and the KuCoin Pool too with, for example, [751909](https://miningpool.observer/template-and-block/000000000000000000063efdbd724ae035ce4b56d512a041ad2bd139374152ff).\n@0xB10C thanks for these great insights. What do you think about the issue? The `4000` is reserved in two places:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/f4a8269dfc144cc918570bdb870aa5143a11c1fe/src/node/miner.cpp#L97\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/f4a8269dfc144cc918570bdb870aa5143a11c1fe/src/policy/policy.h#L23\r\n\r\nShould we remove one of these?\nI agree that reserving 4000 WU twice is confusing. However, I'm not familiar enough with the code to judge on which to remove.\nTIL about this, despite having authored #30356.\r\n\r\nI think `-blockmaxweight` should refer to the actual worst case block, i.e. assuming the pool uses all 4000 WU. So its default should be equal to `MAX_BLOCK_WEIGHT`. It's documentation should clarify this.\r\n\r\nWe do need to make sure that if a miner has been setting `-blockmaxweight=4000000` manually, nothing breaks.\r\n\r\nAn additional argument for having `-blockmaxweight` not adjust for the reservation, is that in Stratum v2 each connected Template Provider (i.e. a pool or an individual miner making its own templates) can specify how much space to reserve. So `4000` only applies to `getblocktemplate` users, whereas `-blockmaxweight` applies everywhere.\r\n\r\nIt would be good to have a functional test for this.\r\n\r\nSome history:\r\n\r\n`MAX_BLOCK_COST` was initially introduced for a setting called `-blockmaxcost` as part of the main SegWit pull request #8149. It existed alongside `-blockmaxsize` and was effectively a way to limit the amount of witness data.\r\n\r\nAt the time `DEFAULT_BLOCK_MAX_SIZE` was `750000`, i.e. 3/4th of the maximum size. So `DEFAULT_BLOCK_MAX_WEIGHT` was set to 3 million, 3/4th of the maximum weight.\r\n\r\nLater on the combination of #8363 and #11100 replaced the confusing `MAX_BLOCK_COST`, `-blockmaxsize` and `-blockmaxcost` by just `DEFAULT_BLOCK_MAX_WEIGHT` and `-blockmaxweight`. That first PR kept the 3/4th of the maximum default.\r\n\r\nThe second PR #11100 changed the default to 4 million. It also introduced the 4000 adjustment. Unfortunately increasing the default caused a bunch of arguing, which probably didn't aid in review.\r\n\r\nHowever the mistake _was_ caught in review, but considered not to be a big deal:\r\nhttps://github.com/bitcoin/bitcoin/pull/11100#discussion_r135124178 (PR description also links to this comment)\r\n\r\nI do think we should fix this, because the alternative is that people start patching this stuff themselves and make very expensive mistakes. \nNote that the reserved weight is NOT only used for the coinbase transaction. The block header takes up 320 WU (80 bytes * 4) and the `var_int` for the number of transactions takes up either 4 WU (1 byte `var_int` for up to 252 txns in the block) or 12 WU (3 byte `var_int` for up to 65535 txns). For most mainnet blocks this is an additional 332 WU. \r\n\r\nSee also: https://delvingbitcoin.org/t/analyzing-mining-pool-behavior-to-address-bitcoin-cores-double-coinbase-reservation-issue/1351/4?u=0xb10c", "created_at": "2024-11-27 19:57:29", "merge_commit_sha": "6b165f5906fc53bd10bedff85a6ef26e0aabdc5c", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31112", "base_commit": "ebe4cac38bf6c510b00b8e080acab079c54016d6", "patch": "diff --git a/src/bench/checkqueue.cpp b/src/bench/checkqueue.cpp\nindex d1454f3634d63..8134154eb112b 100644\n--- a/src/bench/checkqueue.cpp\n+++ b/src/bench/checkqueue.cpp\n@@ -34,9 +34,9 @@ static void CCheckQueueSpeedPrevectorJob(benchmark::Bench& bench)\n         explicit PrevectorJob(FastRandomContext& insecure_rand){\n             p.resize(insecure_rand.randrange(PREVECTOR_SIZE*2));\n         }\n-        bool operator()()\n+        std::optional<int> operator()()\n         {\n-            return true;\n+            return std::nullopt;\n         }\n     };\n \n@@ -62,7 +62,7 @@ static void CCheckQueueSpeedPrevectorJob(benchmark::Bench& bench)\n         }\n         // control waits for completion by RAII, but\n         // it is done explicitly here for clarity\n-        control.Wait();\n+        control.Complete();\n     });\n }\n BENCHMARK(CCheckQueueSpeedPrevectorJob, benchmark::PriorityLevel::HIGH);\ndiff --git a/src/checkqueue.h b/src/checkqueue.h\nindex a1de000714d59..be41bf8bac71d 100644\n--- a/src/checkqueue.h\n+++ b/src/checkqueue.h\n@@ -11,19 +11,24 @@\n \n #include <algorithm>\n #include <iterator>\n+#include <optional>\n #include <vector>\n \n /**\n  * Queue for verifications that have to be performed.\n   * The verifications are represented by a type T, which must provide an\n-  * operator(), returning a bool.\n+  * operator(), returning an std::optional<R>.\n+  *\n+  * The overall result of the computation is std::nullopt if all invocations\n+  * return std::nullopt, or one of the other results otherwise.\n   *\n   * One thread (the master) is assumed to push batches of verifications\n   * onto the queue, where they are processed by N-1 worker threads. When\n   * the master is done adding work, it temporarily joins the worker pool\n   * as an N'th worker, until all jobs are done.\n+  *\n   */\n-template <typename T>\n+template <typename T, typename R = std::remove_cvref_t<decltype(std::declval<T>()().value())>>\n class CCheckQueue\n {\n private:\n@@ -47,7 +52,7 @@ class CCheckQueue\n     int nTotal GUARDED_BY(m_mutex){0};\n \n     //! The temporary evaluation result.\n-    bool fAllOk GUARDED_BY(m_mutex){true};\n+    std::optional<R> m_result GUARDED_BY(m_mutex);\n \n     /**\n      * Number of verifications that haven't completed yet.\n@@ -62,24 +67,28 @@ class CCheckQueue\n     std::vector<std::thread> m_worker_threads;\n     bool m_request_stop GUARDED_BY(m_mutex){false};\n \n-    /** Internal function that does bulk of the verification work. */\n-    bool Loop(bool fMaster) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    /** Internal function that does bulk of the verification work. If fMaster, return the final result. */\n+    std::optional<R> Loop(bool fMaster) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n     {\n         std::condition_variable& cond = fMaster ? m_master_cv : m_worker_cv;\n         std::vector<T> vChecks;\n         vChecks.reserve(nBatchSize);\n         unsigned int nNow = 0;\n-        bool fOk = true;\n+        std::optional<R> local_result;\n+        bool do_work;\n         do {\n             {\n                 WAIT_LOCK(m_mutex, lock);\n                 // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n                 if (nNow) {\n-                    fAllOk &= fOk;\n+                    if (local_result.has_value() && !m_result.has_value()) {\n+                        std::swap(local_result, m_result);\n+                    }\n                     nTodo -= nNow;\n-                    if (nTodo == 0 && !fMaster)\n+                    if (nTodo == 0 && !fMaster) {\n                         // We processed the last element; inform the master it can exit and return the result\n                         m_master_cv.notify_one();\n+                    }\n                 } else {\n                     // first iteration\n                     nTotal++;\n@@ -88,18 +97,19 @@ class CCheckQueue\n                 while (queue.empty() && !m_request_stop) {\n                     if (fMaster && nTodo == 0) {\n                         nTotal--;\n-                        bool fRet = fAllOk;\n+                        std::optional<R> to_return = std::move(m_result);\n                         // reset the status for new work later\n-                        fAllOk = true;\n+                        m_result = std::nullopt;\n                         // return the current status\n-                        return fRet;\n+                        return to_return;\n                     }\n                     nIdle++;\n                     cond.wait(lock); // wait\n                     nIdle--;\n                 }\n                 if (m_request_stop) {\n-                    return false;\n+                    // return value does not matter, because m_request_stop is only set in the destructor.\n+                    return std::nullopt;\n                 }\n \n                 // Decide how many work units to process now.\n@@ -112,12 +122,15 @@ class CCheckQueue\n                 vChecks.assign(std::make_move_iterator(start_it), std::make_move_iterator(queue.end()));\n                 queue.erase(start_it, queue.end());\n                 // Check whether we need to do work at all\n-                fOk = fAllOk;\n+                do_work = !m_result.has_value();\n             }\n             // execute work\n-            for (T& check : vChecks)\n-                if (fOk)\n-                    fOk = check();\n+            if (do_work) {\n+                for (T& check : vChecks) {\n+                    local_result = check();\n+                    if (local_result.has_value()) break;\n+                }\n+            }\n             vChecks.clear();\n         } while (true);\n     }\n@@ -146,8 +159,9 @@ class CCheckQueue\n     CCheckQueue(CCheckQueue&&) = delete;\n     CCheckQueue& operator=(CCheckQueue&&) = delete;\n \n-    //! Wait until execution finishes, and return whether all evaluations were successful.\n-    bool Wait() EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    //! Join the execution until completion. If at least one evaluation wasn't successful, return\n+    //! its error.\n+    std::optional<R> Complete() EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n     {\n         return Loop(true /* master thread */);\n     }\n@@ -188,11 +202,11 @@ class CCheckQueue\n  * RAII-style controller object for a CCheckQueue that guarantees the passed\n  * queue is finished before continuing.\n  */\n-template <typename T>\n+template <typename T, typename R = std::remove_cvref_t<decltype(std::declval<T>()().value())>>\n class CCheckQueueControl\n {\n private:\n-    CCheckQueue<T> * const pqueue;\n+    CCheckQueue<T, R> * const pqueue;\n     bool fDone;\n \n public:\n@@ -207,13 +221,12 @@ class CCheckQueueControl\n         }\n     }\n \n-    bool Wait()\n+    std::optional<R> Complete()\n     {\n-        if (pqueue == nullptr)\n-            return true;\n-        bool fRet = pqueue->Wait();\n+        if (pqueue == nullptr) return std::nullopt;\n+        auto ret = pqueue->Complete();\n         fDone = true;\n-        return fRet;\n+        return ret;\n     }\n \n     void Add(std::vector<T>&& vChecks)\n@@ -226,7 +239,7 @@ class CCheckQueueControl\n     ~CCheckQueueControl()\n     {\n         if (!fDone)\n-            Wait();\n+            Complete();\n         if (pqueue != nullptr) {\n             LEAVE_CRITICAL_SECTION(pqueue->m_control_mutex);\n         }\ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex 95f3bc58d7d82..1cc4259919452 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2103,10 +2103,16 @@ void UpdateCoins(const CTransaction& tx, CCoinsViewCache& inputs, CTxUndo &txund\n     AddCoins(inputs, tx, nHeight);\n }\n \n-bool CScriptCheck::operator()() {\n+std::optional<std::pair<ScriptError, std::string>> CScriptCheck::operator()() {\n     const CScript &scriptSig = ptxTo->vin[nIn].scriptSig;\n     const CScriptWitness *witness = &ptxTo->vin[nIn].scriptWitness;\n-    return VerifyScript(scriptSig, m_tx_out.scriptPubKey, witness, nFlags, CachingTransactionSignatureChecker(ptxTo, nIn, m_tx_out.nValue, cacheStore, *m_signature_cache, *txdata), &error);\n+    ScriptError error{SCRIPT_ERR_UNKNOWN_ERROR};\n+    if (VerifyScript(scriptSig, m_tx_out.scriptPubKey, witness, nFlags, CachingTransactionSignatureChecker(ptxTo, nIn, m_tx_out.nValue, cacheStore, *m_signature_cache, *txdata), &error)) {\n+        return std::nullopt;\n+    } else {\n+        auto debug_str = strprintf(\"input %i of %s (wtxid %s), spending %s:%i\", nIn, ptxTo->GetHash().ToString(), ptxTo->GetWitnessHash().ToString(), ptxTo->vin[nIn].prevout.hash.ToString(), ptxTo->vin[nIn].prevout.n);\n+        return std::make_pair(error, std::move(debug_str));\n+    }\n }\n \n ValidationCache::ValidationCache(const size_t script_execution_cache_bytes, const size_t signature_cache_bytes)\n@@ -2195,9 +2201,7 @@ bool CheckInputScripts(const CTransaction& tx, TxValidationState& state,\n         CScriptCheck check(txdata.m_spent_outputs[i], tx, validation_cache.m_signature_cache, i, flags, cacheSigStore, &txdata);\n         if (pvChecks) {\n             pvChecks->emplace_back(std::move(check));\n-        } else if (!check()) {\n-            ScriptError error{check.GetScriptError()};\n-\n+        } else if (auto result = check(); result.has_value()) {\n             if (flags & STANDARD_NOT_MANDATORY_VERIFY_FLAGS) {\n                 // Check whether the failure was caused by a\n                 // non-mandatory script verification check, such as\n@@ -2209,21 +2213,23 @@ bool CheckInputScripts(const CTransaction& tx, TxValidationState& state,\n                 // data providers.\n                 CScriptCheck check2(txdata.m_spent_outputs[i], tx, validation_cache.m_signature_cache, i,\n                         flags & ~STANDARD_NOT_MANDATORY_VERIFY_FLAGS, cacheSigStore, &txdata);\n-                if (check2())\n-                    return state.Invalid(TxValidationResult::TX_NOT_STANDARD, strprintf(\"non-mandatory-script-verify-flag (%s)\", ScriptErrorString(check.GetScriptError())));\n-\n-                // If the second check failed, it failed due to a mandatory script verification\n-                // flag, but the first check might have failed on a non-mandatory script\n-                // verification flag.\n-                //\n-                // Avoid reporting a mandatory script check failure with a non-mandatory error\n-                // string by reporting the error from the second check.\n-                error = check2.GetScriptError();\n+                auto mandatory_result = check2();\n+                if (!mandatory_result.has_value()) {\n+                    return state.Invalid(TxValidationResult::TX_NOT_STANDARD, strprintf(\"non-mandatory-script-verify-flag (%s)\", ScriptErrorString(result->first)), result->second);\n+                } else {\n+                    // If the second check failed, it failed due to a mandatory script verification\n+                    // flag, but the first check might have failed on a non-mandatory script\n+                    // verification flag.\n+                    //\n+                    // Avoid reporting a mandatory script check failure with a non-mandatory error\n+                    // string by reporting the error from the second check.\n+                    result = mandatory_result;\n+                }\n             }\n \n             // MANDATORY flag failures correspond to\n             // TxValidationResult::TX_CONSENSUS.\n-            return state.Invalid(TxValidationResult::TX_CONSENSUS, strprintf(\"mandatory-script-verify-flag-failed (%s)\", ScriptErrorString(error)));\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, strprintf(\"mandatory-script-verify-flag-failed (%s)\", ScriptErrorString(result->first)), result->second);\n         }\n     }\n \n@@ -2589,8 +2595,8 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n         for (const auto& tx : block.vtx) {\n             for (size_t o = 0; o < tx->vout.size(); o++) {\n                 if (view.HaveCoin(COutPoint(tx->GetHash(), o))) {\n-                    LogPrintf(\"ERROR: ConnectBlock(): tried to overwrite transaction\\n\");\n-                    return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-BIP30\");\n+                    state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-BIP30\",\n+                                  \"tried to overwrite transaction\");\n                 }\n             }\n         }\n@@ -2629,6 +2635,7 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n     blockundo.vtxundo.reserve(block.vtx.size() - 1);\n     for (unsigned int i = 0; i < block.vtx.size(); i++)\n     {\n+        if (!state.IsValid()) break;\n         const CTransaction &tx = *(block.vtx[i]);\n \n         nInputs += tx.vin.size();\n@@ -2640,14 +2647,15 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n             if (!Consensus::CheckTxInputs(tx, tx_state, view, pindex->nHeight, txfee)) {\n                 // Any transaction validation failure in ConnectBlock is a block consensus failure\n                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS,\n-                            tx_state.GetRejectReason(), tx_state.GetDebugMessage());\n-                LogError(\"%s: Consensus::CheckTxInputs: %s, %s\\n\", __func__, tx.GetHash().ToString(), state.ToString());\n-                return false;\n+                              tx_state.GetRejectReason(),\n+                              tx_state.GetDebugMessage() + \" in transaction \" + tx.GetHash().ToString());\n+                break;\n             }\n             nFees += txfee;\n             if (!MoneyRange(nFees)) {\n-                LogPrintf(\"ERROR: %s: accumulated fee in the block out of range.\\n\", __func__);\n-                return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-accumulated-fee-outofrange\");\n+                state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-accumulated-fee-outofrange\",\n+                              \"accumulated fee in the block out of range\");\n+                break;\n             }\n \n             // Check that transaction is BIP68 final\n@@ -2659,8 +2667,9 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n             }\n \n             if (!SequenceLocks(tx, nLockTimeFlags, prevheights, *pindex)) {\n-                LogPrintf(\"ERROR: %s: contains a non-BIP68-final transaction\\n\", __func__);\n-                return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-nonfinal\");\n+                state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-nonfinal\",\n+                              \"contains a non-BIP68-final transaction \" + tx.GetHash().ToString());\n+                break;\n             }\n         }\n \n@@ -2670,8 +2679,8 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n         // * witness (when witness enabled in flags and excludes coinbase)\n         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);\n         if (nSigOpsCost > MAX_BLOCK_SIGOPS_COST) {\n-            LogPrintf(\"ERROR: ConnectBlock(): too many sigops\\n\");\n-            return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-blk-sigops\");\n+            state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-blk-sigops\", \"too many sigops\");\n+            break;\n         }\n \n         if (!tx.IsCoinBase())\n@@ -2683,9 +2692,7 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n                 // Any transaction validation failure in ConnectBlock is a block consensus failure\n                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS,\n                               tx_state.GetRejectReason(), tx_state.GetDebugMessage());\n-                LogError(\"ConnectBlock(): CheckInputScripts on %s failed with %s\\n\",\n-                    tx.GetHash().ToString(), state.ToString());\n-                return false;\n+                break;\n             }\n             control.Add(std::move(vChecks));\n         }\n@@ -2705,14 +2712,18 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n              Ticks<MillisecondsDouble>(m_chainman.time_connect) / m_chainman.num_blocks_total);\n \n     CAmount blockReward = nFees + GetBlockSubsidy(pindex->nHeight, params.GetConsensus());\n-    if (block.vtx[0]->GetValueOut() > blockReward) {\n-        LogPrintf(\"ERROR: ConnectBlock(): coinbase pays too much (actual=%d vs limit=%d)\\n\", block.vtx[0]->GetValueOut(), blockReward);\n-        return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-cb-amount\");\n+    if (block.vtx[0]->GetValueOut() > blockReward && state.IsValid()) {\n+        state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-cb-amount\",\n+                      strprintf(\"coinbase pays too much (actual=%d vs limit=%d)\", block.vtx[0]->GetValueOut(), blockReward));\n     }\n \n-    if (!control.Wait()) {\n-        LogPrintf(\"ERROR: %s: CheckQueue failed\\n\", __func__);\n-        return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"block-validation-failed\");\n+    auto parallel_result = control.Complete();\n+    if (parallel_result.has_value() && state.IsValid()) {\n+        state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, strprintf(\"mandatory-script-verify-flag-failed (%s)\", ScriptErrorString(parallel_result->first)), parallel_result->second);\n+    }\n+    if (!state.IsValid()) {\n+        LogInfo(\"Block validation error: %s\", state.ToString());\n+        return false;\n     }\n     const auto time_4{SteadyClock::now()};\n     m_chainman.time_verify += time_4 - time_2;\n@@ -2722,8 +2733,9 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n              Ticks<SecondsDouble>(m_chainman.time_verify),\n              Ticks<MillisecondsDouble>(m_chainman.time_verify) / m_chainman.num_blocks_total);\n \n-    if (fJustCheck)\n+    if (fJustCheck) {\n         return true;\n+    }\n \n     if (!m_blockman.WriteUndoDataForBlock(blockundo, state, *pindex)) {\n         return false;\ndiff --git a/src/validation.h b/src/validation.h\nindex 723babca31568..6b67dc485b837 100644\n--- a/src/validation.h\n+++ b/src/validation.h\n@@ -335,7 +335,6 @@ class CScriptCheck\n     unsigned int nIn;\n     unsigned int nFlags;\n     bool cacheStore;\n-    ScriptError error{SCRIPT_ERR_UNKNOWN_ERROR};\n     PrecomputedTransactionData *txdata;\n     SignatureCache* m_signature_cache;\n \n@@ -348,9 +347,7 @@ class CScriptCheck\n     CScriptCheck(CScriptCheck&&) = default;\n     CScriptCheck& operator=(CScriptCheck&&) = default;\n \n-    bool operator()();\n-\n-    ScriptError GetScriptError() const { return error; }\n+    std::optional<std::pair<ScriptError, std::string>> operator()();\n };\n \n // CScriptCheck is used a lot in std::vector, make sure that's efficient\n", "test_patch": "diff --git a/src/test/checkqueue_tests.cpp b/src/test/checkqueue_tests.cpp\nindex b7014db4a5b9e..2463ce6da565b 100644\n--- a/src/test/checkqueue_tests.cpp\n+++ b/src/test/checkqueue_tests.cpp\n@@ -42,28 +42,26 @@ static const unsigned int QUEUE_BATCH_SIZE = 128;\n static const int SCRIPT_CHECK_THREADS = 3;\n \n struct FakeCheck {\n-    bool operator()() const\n+    std::optional<int> operator()() const\n     {\n-        return true;\n+        return std::nullopt;\n     }\n };\n \n struct FakeCheckCheckCompletion {\n     static std::atomic<size_t> n_calls;\n-    bool operator()()\n+    std::optional<int> operator()()\n     {\n         n_calls.fetch_add(1, std::memory_order_relaxed);\n-        return true;\n+        return std::nullopt;\n     }\n };\n \n-struct FailingCheck {\n-    bool fails;\n-    FailingCheck(bool _fails) : fails(_fails){};\n-    bool operator()() const\n-    {\n-        return !fails;\n-    }\n+struct FixedCheck\n+{\n+    std::optional<int> m_result;\n+    FixedCheck(std::optional<int> result) : m_result(result){};\n+    std::optional<int> operator()() const { return m_result; }\n };\n \n struct UniqueCheck {\n@@ -71,11 +69,11 @@ struct UniqueCheck {\n     static std::unordered_multiset<size_t> results GUARDED_BY(m);\n     size_t check_id;\n     UniqueCheck(size_t check_id_in) : check_id(check_id_in){};\n-    bool operator()()\n+    std::optional<int> operator()()\n     {\n         LOCK(m);\n         results.insert(check_id);\n-        return true;\n+        return std::nullopt;\n     }\n };\n \n@@ -83,9 +81,9 @@ struct UniqueCheck {\n struct MemoryCheck {\n     static std::atomic<size_t> fake_allocated_memory;\n     bool b {false};\n-    bool operator()() const\n+    std::optional<int> operator()() const\n     {\n-        return true;\n+        return std::nullopt;\n     }\n     MemoryCheck(const MemoryCheck& x)\n     {\n@@ -110,9 +108,9 @@ struct FrozenCleanupCheck {\n     static std::condition_variable cv;\n     static std::mutex m;\n     bool should_freeze{true};\n-    bool operator()() const\n+    std::optional<int> operator()() const\n     {\n-        return true;\n+        return std::nullopt;\n     }\n     FrozenCleanupCheck() = default;\n     ~FrozenCleanupCheck()\n@@ -149,7 +147,7 @@ std::atomic<size_t> MemoryCheck::fake_allocated_memory{0};\n // Queue Typedefs\n typedef CCheckQueue<FakeCheckCheckCompletion> Correct_Queue;\n typedef CCheckQueue<FakeCheck> Standard_Queue;\n-typedef CCheckQueue<FailingCheck> Failing_Queue;\n+typedef CCheckQueue<FixedCheck> Fixed_Queue;\n typedef CCheckQueue<UniqueCheck> Unique_Queue;\n typedef CCheckQueue<MemoryCheck> Memory_Queue;\n typedef CCheckQueue<FrozenCleanupCheck> FrozenCleanup_Queue;\n@@ -174,7 +172,7 @@ void CheckQueueTest::Correct_Queue_range(std::vector<size_t> range)\n             total -= vChecks.size();\n             control.Add(std::move(vChecks));\n         }\n-        BOOST_REQUIRE(control.Wait());\n+        BOOST_REQUIRE(!control.Complete().has_value());\n         BOOST_REQUIRE_EQUAL(FakeCheckCheckCompletion::n_calls, i);\n     }\n }\n@@ -217,27 +215,27 @@ BOOST_AUTO_TEST_CASE(test_CheckQueue_Correct_Random)\n }\n \n \n-/** Test that failing checks are caught */\n+/** Test that distinct failing checks are caught */\n BOOST_AUTO_TEST_CASE(test_CheckQueue_Catches_Failure)\n {\n-    auto fail_queue = std::make_unique<Failing_Queue>(QUEUE_BATCH_SIZE, SCRIPT_CHECK_THREADS);\n+    auto fixed_queue = std::make_unique<Fixed_Queue>(QUEUE_BATCH_SIZE, SCRIPT_CHECK_THREADS);\n     for (size_t i = 0; i < 1001; ++i) {\n-        CCheckQueueControl<FailingCheck> control(fail_queue.get());\n+        CCheckQueueControl<FixedCheck> control(fixed_queue.get());\n         size_t remaining = i;\n         while (remaining) {\n             size_t r = m_rng.randrange(10);\n \n-            std::vector<FailingCheck> vChecks;\n+            std::vector<FixedCheck> vChecks;\n             vChecks.reserve(r);\n             for (size_t k = 0; k < r && remaining; k++, remaining--)\n-                vChecks.emplace_back(remaining == 1);\n+                vChecks.emplace_back(remaining == 1 ? std::make_optional<int>(17 * i) : std::nullopt);\n             control.Add(std::move(vChecks));\n         }\n-        bool success = control.Wait();\n+        auto result = control.Complete();\n         if (i > 0) {\n-            BOOST_REQUIRE(!success);\n-        } else if (i == 0) {\n-            BOOST_REQUIRE(success);\n+            BOOST_REQUIRE(result.has_value() && *result == static_cast<int>(17 * i));\n+        } else {\n+            BOOST_REQUIRE(!result.has_value());\n         }\n     }\n }\n@@ -245,17 +243,17 @@ BOOST_AUTO_TEST_CASE(test_CheckQueue_Catches_Failure)\n // future blocks, ie, the bad state is cleared.\n BOOST_AUTO_TEST_CASE(test_CheckQueue_Recovers_From_Failure)\n {\n-    auto fail_queue = std::make_unique<Failing_Queue>(QUEUE_BATCH_SIZE, SCRIPT_CHECK_THREADS);\n+    auto fail_queue = std::make_unique<Fixed_Queue>(QUEUE_BATCH_SIZE, SCRIPT_CHECK_THREADS);\n     for (auto times = 0; times < 10; ++times) {\n         for (const bool end_fails : {true, false}) {\n-            CCheckQueueControl<FailingCheck> control(fail_queue.get());\n+            CCheckQueueControl<FixedCheck> control(fail_queue.get());\n             {\n-                std::vector<FailingCheck> vChecks;\n-                vChecks.resize(100, false);\n-                vChecks[99] = end_fails;\n+                std::vector<FixedCheck> vChecks;\n+                vChecks.resize(100, FixedCheck(std::nullopt));\n+                vChecks[99] = FixedCheck(end_fails ? std::make_optional<int>(2) : std::nullopt);\n                 control.Add(std::move(vChecks));\n             }\n-            bool r =control.Wait();\n+            bool r = !control.Complete().has_value();\n             BOOST_REQUIRE(r != end_fails);\n         }\n     }\n@@ -329,8 +327,8 @@ BOOST_AUTO_TEST_CASE(test_CheckQueue_FrozenCleanup)\n         CCheckQueueControl<FrozenCleanupCheck> control(queue.get());\n         std::vector<FrozenCleanupCheck> vChecks(1);\n         control.Add(std::move(vChecks));\n-        bool waitResult = control.Wait(); // Hangs here\n-        assert(waitResult);\n+        auto result = control.Complete(); // Hangs here\n+        assert(!result);\n     });\n     {\n         std::unique_lock<std::mutex> l(FrozenCleanupCheck::m);\ndiff --git a/src/test/fuzz/checkqueue.cpp b/src/test/fuzz/checkqueue.cpp\nindex 6320b500b6f4b..6b93886c7112b 100644\n--- a/src/test/fuzz/checkqueue.cpp\n+++ b/src/test/fuzz/checkqueue.cpp\n@@ -19,9 +19,10 @@ struct DumbCheck {\n     {\n     }\n \n-    bool operator()() const\n+    std::optional<int> operator()() const\n     {\n-        return result;\n+        if (result) return std::nullopt;\n+        return 1;\n     }\n };\n } // namespace\n@@ -45,7 +46,7 @@ FUZZ_TARGET(checkqueue)\n         check_queue_1.Add(std::move(checks_1));\n     }\n     if (fuzzed_data_provider.ConsumeBool()) {\n-        (void)check_queue_1.Wait();\n+        (void)check_queue_1.Complete();\n     }\n \n     CCheckQueueControl<DumbCheck> check_queue_control{&check_queue_2};\n@@ -53,6 +54,6 @@ FUZZ_TARGET(checkqueue)\n         check_queue_control.Add(std::move(checks_2));\n     }\n     if (fuzzed_data_provider.ConsumeBool()) {\n-        (void)check_queue_control.Wait();\n+        (void)check_queue_control.Complete();\n     }\n }\ndiff --git a/src/test/miner_tests.cpp b/src/test/miner_tests.cpp\nindex f6ae6549bc4e3..c5ecf7022e18e 100644\n--- a/src/test/miner_tests.cpp\n+++ b/src/test/miner_tests.cpp\n@@ -403,8 +403,7 @@ void MinerTestingSetup::TestBasicMining(const CScript& scriptPubKey, const std::\n         tx.vout[0].nValue -= LOWFEE;\n         hash = tx.GetHash();\n         AddToMempool(tx_mempool, entry.Fee(LOWFEE).Time(Now<NodeSeconds>()).SpendsCoinbase(false).FromTx(tx));\n-        // Should throw block-validation-failed\n-        BOOST_CHECK_EXCEPTION(AssemblerForTest(tx_mempool).CreateNewBlock(scriptPubKey), std::runtime_error, HasReason(\"block-validation-failed\"));\n+        BOOST_CHECK_EXCEPTION(AssemblerForTest(tx_mempool).CreateNewBlock(scriptPubKey), std::runtime_error, HasReason(\"mandatory-script-verify-flag-failed\"));\n \n         // Delete the dummy blocks again.\n         while (m_node.chainman->ActiveChain().Tip()->nHeight > nHeight) {\ndiff --git a/src/test/script_p2sh_tests.cpp b/src/test/script_p2sh_tests.cpp\nindex 096de0724f4e6..bb408b7b0f519 100644\n--- a/src/test/script_p2sh_tests.cpp\n+++ b/src/test/script_p2sh_tests.cpp\n@@ -121,7 +121,7 @@ BOOST_AUTO_TEST_CASE(sign)\n         {\n             CScript sigSave = txTo[i].vin[0].scriptSig;\n             txTo[i].vin[0].scriptSig = txTo[j].vin[0].scriptSig;\n-            bool sigOK = CScriptCheck(txFrom.vout[txTo[i].vin[0].prevout.n], CTransaction(txTo[i]), signature_cache, 0, SCRIPT_VERIFY_P2SH | SCRIPT_VERIFY_STRICTENC, false, &txdata)();\n+            bool sigOK = !CScriptCheck(txFrom.vout[txTo[i].vin[0].prevout.n], CTransaction(txTo[i]), signature_cache, 0, SCRIPT_VERIFY_P2SH | SCRIPT_VERIFY_STRICTENC, false, &txdata)().has_value();\n             if (i == j)\n                 BOOST_CHECK_MESSAGE(sigOK, strprintf(\"VerifySignature %d %d\", i, j));\n             else\ndiff --git a/src/test/transaction_tests.cpp b/src/test/transaction_tests.cpp\nindex f38c015f6d7ab..8beeec499158a 100644\n--- a/src/test/transaction_tests.cpp\n+++ b/src/test/transaction_tests.cpp\n@@ -588,7 +588,7 @@ BOOST_AUTO_TEST_CASE(test_big_witness_transaction)\n         control.Add(std::move(vChecks));\n     }\n \n-    bool controlCheck = control.Wait();\n+    bool controlCheck = !control.Complete().has_value();\n     assert(controlCheck);\n }\n \ndiff --git a/test/functional/feature_block.py b/test/functional/feature_block.py\nindex 43bf61c174a02..384ca311c74e5 100755\n--- a/test/functional/feature_block.py\n+++ b/test/functional/feature_block.py\n@@ -88,7 +88,6 @@ def set_test_params(self):\n         self.extra_args = [[\n             '-acceptnonstdtxn=1',  # This is a consensus block test, we don't care about tx policy\n             '-testactivationheight=bip34@2',\n-            '-par=1', # Until https://github.com/bitcoin/bitcoin/issues/30960 is fixed\n         ]]\n \n     def run_test(self):\ndiff --git a/test/functional/feature_cltv.py b/test/functional/feature_cltv.py\nindex dc01f8fa8f068..557fcc7cea648 100755\n--- a/test/functional/feature_cltv.py\n+++ b/test/functional/feature_cltv.py\n@@ -87,7 +87,6 @@ def set_test_params(self):\n         self.noban_tx_relay = True\n         self.extra_args = [[\n             f'-testactivationheight=cltv@{CLTV_HEIGHT}',\n-            '-par=1',  # Use only one script thread to get the exact reject reason for testing\n             '-acceptnonstdtxn=1',  # cltv_invalidate is nonstandard\n         ]]\n         self.setup_clean_chain = True\n@@ -175,7 +174,7 @@ def run_test(self):\n             block.hashMerkleRoot = block.calc_merkle_root()\n             block.solve()\n \n-            with self.nodes[0].assert_debug_log(expected_msgs=[f'CheckInputScripts on {block.vtx[-1].hash} failed with {expected_cltv_reject_reason}']):\n+            with self.nodes[0].assert_debug_log(expected_msgs=[f'Block validation error: {expected_cltv_reject_reason}']):\n                 peer.send_and_ping(msg_block(block))\n                 assert_equal(int(self.nodes[0].getbestblockhash(), 16), tip)\n                 peer.sync_with_ping()\ndiff --git a/test/functional/feature_csv_activation.py b/test/functional/feature_csv_activation.py\nindex df02bcc6ad8d8..d5b6d0dba9d09 100755\n--- a/test/functional/feature_csv_activation.py\n+++ b/test/functional/feature_csv_activation.py\n@@ -99,7 +99,6 @@ def set_test_params(self):\n         self.noban_tx_relay = True\n         self.extra_args = [[\n             f'-testactivationheight=csv@{CSV_ACTIVATION_HEIGHT}',\n-            '-par=1',  # Use only one script thread to get the exact reject reason for testing\n         ]]\n         self.supports_cli = False\n \ndiff --git a/test/functional/feature_dersig.py b/test/functional/feature_dersig.py\nindex 48b0b745c600f..1d18803f45ab1 100755\n--- a/test/functional/feature_dersig.py\n+++ b/test/functional/feature_dersig.py\n@@ -51,7 +51,6 @@ def set_test_params(self):\n         self.noban_tx_relay = True\n         self.extra_args = [[\n             f'-testactivationheight=dersig@{DERSIG_HEIGHT}',\n-            '-par=1',  # Use only one script thread to get the exact log msg for testing\n         ]]\n         self.setup_clean_chain = True\n         self.rpc_timeout = 240\n@@ -131,7 +130,7 @@ def run_test(self):\n         block.hashMerkleRoot = block.calc_merkle_root()\n         block.solve()\n \n-        with self.nodes[0].assert_debug_log(expected_msgs=[f'CheckInputScripts on {block.vtx[-1].hash} failed with mandatory-script-verify-flag-failed (Non-canonical DER signature)']):\n+        with self.nodes[0].assert_debug_log(expected_msgs=[f'Block validation error: mandatory-script-verify-flag-failed (Non-canonical DER signature)']):\n             peer.send_and_ping(msg_block(block))\n             assert_equal(int(self.nodes[0].getbestblockhash(), 16), tip)\n             peer.sync_with_ping()\ndiff --git a/test/functional/feature_nulldummy.py b/test/functional/feature_nulldummy.py\nindex a53f78c13d8d9..885bc4855b029 100755\n--- a/test/functional/feature_nulldummy.py\n+++ b/test/functional/feature_nulldummy.py\n@@ -57,7 +57,6 @@ def set_test_params(self):\n         self.extra_args = [[\n             f'-testactivationheight=segwit@{COINBASE_MATURITY + 5}',\n             '-addresstype=legacy',\n-            '-par=1',  # Use only one script thread to get the exact reject reason for testing\n         ]]\n \n     def create_transaction(self, *, txid, input_details=None, addr, amount, privkey):\ndiff --git a/test/functional/feature_taproot.py b/test/functional/feature_taproot.py\nindex 443c1c33da6ca..daf11a9ae6cc6 100755\n--- a/test/functional/feature_taproot.py\n+++ b/test/functional/feature_taproot.py\n@@ -1285,7 +1285,6 @@ def skip_test_if_missing_module(self):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n-        self.extra_args = [[\"-par=1\"]]\n \n     def block_submit(self, node, txs, msg, err_msg, cb_pubkey=None, fees=0, sigops_weight=0, witness=False, accept=False):\n \ndiff --git a/test/functional/p2p_segwit.py b/test/functional/p2p_segwit.py\nindex ac35762427e4b..677a1120d6afe 100755\n--- a/test/functional/p2p_segwit.py\n+++ b/test/functional/p2p_segwit.py\n@@ -214,6 +214,9 @@ def set_test_params(self):\n         self.noban_tx_relay = True\n         # This test tests SegWit both pre and post-activation, so use the normal BIP9 activation.\n         self.extra_args = [\n+            # -par=1 should not affect validation outcome or logging/reported failures. It is kept\n+            # here to exercise the code path still (as it is distinct for multithread script\n+            # validation).\n             [\"-acceptnonstdtxn=1\", f\"-testactivationheight=segwit@{SEGWIT_HEIGHT}\", \"-par=1\"],\n             [\"-acceptnonstdtxn=0\", f\"-testactivationheight=segwit@{SEGWIT_HEIGHT}\"],\n         ]\n@@ -507,10 +510,6 @@ def test_v0_outputs_arent_spendable(self):\n             # When the block is serialized without witness, validation fails because the transaction is\n             # invalid (transactions are always validated with SCRIPT_VERIFY_WITNESS so a segwit v0 transaction\n             # without a witness is invalid).\n-            # Note: The reject reason for this failure could be\n-            # 'block-validation-failed' (if script check threads > 1) or\n-            # 'mandatory-script-verify-flag-failed (Witness program was passed an\n-            # empty witness)' (otherwise).\n             test_witness_block(self.nodes[0], self.test_node, block, accepted=False, with_witness=False,\n                                reason='mandatory-script-verify-flag-failed (Witness program was passed an empty witness)')\n \n@@ -1015,7 +1014,7 @@ def test_extra_witness_data(self):\n         tx2.vout.append(CTxOut(tx.vout[0].nValue, CScript([OP_TRUE])))\n         tx2.wit.vtxinwit.extend([CTxInWitness(), CTxInWitness()])\n         tx2.wit.vtxinwit[0].scriptWitness.stack = [CScript([CScriptNum(1)]), CScript([CScriptNum(1)]), witness_script]\n-        tx2.wit.vtxinwit[1].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx2.wit.vtxinwit[1].scriptWitness.stack = []\n \n         block = self.build_next_block()\n         self.update_witness_block_with_transactions(block, [tx2])\n", "problem_statement": "log/dump more information if a CheckQueue failure occurs\nI recently saw this on a node running master (90a5786bba4baac1c0270e1f4bf5bb8c790e10de iirc):\r\n```bash\r\n2024-09-23T13:12:14Z UpdateTip: new best=00000000000000000000d3ebbca24c44745cfa14153e758d29af82275e00c00f height=862523 version=0x20026000 log2_work=95.170324 tx=1084781037 date='2024-09-23T13:03:46Z' progress=0.999997 cache=302.1MiB(2120379txo)\r\n2024-09-23T13:12:14Z UpdateTip: new best=0000000000000000000164dcfef37624f2cc6b177032bbca57631285c2cd0267 height=862524 version=0x20150000 log2_work=95.170337 tx=1084782848 date='2024-09-23T13:05:37Z' progress=0.999998 cache=302.4MiB(2117708txo)\r\n2024-09-23T13:12:15Z New outbound-full-relay v1 peer connected: version: 70016, blocks=862524, peer=25\r\n2024-09-23T13:13:09Z Saw new header hash=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 height=862525\r\n2024-09-23T13:13:09Z Saw new cmpctblock header hash=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 peer=1\r\n2024-09-23T13:13:10Z ERROR: ConnectBlock: CheckQueue failed\r\n2024-09-23T13:13:10Z InvalidChainFound: invalid block=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084  height=862525  log2_work=95.170350  date=2024-09-23T13:12:13Z\r\n2024-09-23T13:13:10Z InvalidChainFound:  current best=0000000000000000000164dcfef37624f2cc6b177032bbca57631285c2cd0267  height=862524  log2_work=95.170337  date=2024-09-23T13:05:37Z\r\n2024-09-23T13:13:10Z [error] ConnectTip: ConnectBlock 00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 failed, block-validation-failed\r\n2024-09-23T13:13:10Z InvalidChainFound: invalid block=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084  height=862525  log2_work=95.170350  date=2024-09-23T13:12:13Z\r\n2024-09-23T13:13:10Z InvalidChainFound:  current best=0000000000000000000164dcfef37624f2cc6b177032bbca57631285c2cd0267  height=862524  log2_work=95.170337  date=2024-09-23T13:05:37Z\r\n2024-09-23T13:13:16Z New outbound-full-relay v2 peer connected: version: 70016, blocks=862525, peer=27\r\n2024-09-23T13:13:23Z New outbound-full-relay v1 peer connected: version: 70016, blocks=862525, peer=28\r\n```\r\n\r\nIn this case it was possible to restart the node with `-par=1`, to output the actual failure:\r\n```bash\r\n2024-09-23T14:19:04Z [error] ConnectTip: ConnectBlock 00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 failed, mandatory-script-verify-flag-failed (Script evaluated without error but finished with a false/empty top stack element)\r\n```\r\n\r\nHowever it would also be useful to get that information in either case. The cause of the `ConnectBlock` failure here has currently been put down to hardware.\n", "hints_text": "", "created_at": "2024-10-18 15:41:15", "merge_commit_sha": "3867d2421ae45c9093ceb355f5373c09e6f93c5d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30986", "base_commit": "70e20ea024ce4f39abc4022e1ba19d5a6db2a207", "patch": "diff --git a/contrib/devtools/gen-manpages.py b/contrib/devtools/gen-manpages.py\nindex 92acd9a40373c..14c8c408e83af 100755\n--- a/contrib/devtools/gen-manpages.py\n+++ b/contrib/devtools/gen-manpages.py\n@@ -6,6 +6,7 @@\n import subprocess\n import sys\n import tempfile\n+import argparse\n \n BINARIES = [\n 'src/bitcoind',\n@@ -16,6 +17,18 @@\n 'src/qt/bitcoin-qt',\n ]\n \n+parser = argparse.ArgumentParser(\n+    formatter_class=argparse.RawDescriptionHelpFormatter,\n+)\n+parser.add_argument(\n+    \"-s\",\n+    \"--skip-missing-binaries\",\n+    action=\"store_true\",\n+    default=False,\n+    help=\"skip generation for binaries that are not found in the build path\",\n+)\n+args = parser.parse_args()\n+\n # Paths to external utilities.\n git = os.getenv('GIT', 'git')\n help2man = os.getenv('HELP2MAN', 'help2man')\n@@ -38,8 +51,12 @@\n     try:\n         r = subprocess.run([abspath, \"--version\"], stdout=subprocess.PIPE, check=True, text=True)\n     except IOError:\n-        print(f'{abspath} not found or not an executable', file=sys.stderr)\n-        sys.exit(1)\n+        if(args.skip_missing_binaries):\n+            print(f'{abspath} not found or not an executable. Skipping...', file=sys.stderr)\n+            continue\n+        else:\n+            print(f'{abspath} not found or not an executable', file=sys.stderr)\n+            sys.exit(1)\n     # take first line (which must contain version)\n     verstr = r.stdout.splitlines()[0]\n     # last word of line is the actual version e.g. v22.99.0-5c6b3d5b3508\n@@ -51,6 +68,10 @@\n \n     versions.append((abspath, verstr, copyright))\n \n+if not versions:\n+    print(f'No binaries found in {builddir}. Please ensure the binaries are present in {builddir}, or set another build path using the BUILDDIR env variable.')\n+    sys.exit(1)\n+\n if any(verstr.endswith('-dirty') for (_, verstr, _) in versions):\n     print(\"WARNING: Binaries were built from a dirty tree.\")\n     print('man pages generated from dirty binaries should NOT be committed.')\n", "test_patch": "", "problem_statement": "gen-manpages.py should skip nonexistent binaries and still work for the existent binaries\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nBy executing `BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py`, if one binary is not found, it will stop the generation of all manpages.\r\n\r\nFor example: Executing gen-manpages.py without bitcoin-qt. The command exits after detecting that bitcoin-qt does not exist, and no manpage is generated, even though only bitcoin-qt is missing.\r\n\r\n```bash\r\n\u279c  bitcoin git:(master) \u2717 BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py\r\n/home/andre/repos/bitcoin/build/src/qt/bitcoin-qt not found or not an executable\r\n\u279c  bitcoin git:(master) \u2717 \r\n```\r\n\r\nInitially, I thought this behavior was intended, but after investigating the older shell script implementation `gen-manpages.sh`, I realized that\u2019s not the case. `gen-manpages.sh` was able to generate all the manpages and just warned the user about missing binaries.\r\n\r\nExample using the last version of the shell script: https://github.com/bitcoin/bitcoin/blob/a5edd191be93aff8f9c0f60f04e711e2e78ecc77/contrib/devtools/gen-manpages.sh\r\n\r\n```bash\r\n\u279c  bitcoin git:(master) \u2717 BUILDDIR=$PWD/build contrib/devtools/gen-manpages.sh\r\ncontrib/devtools/gen-manpages.sh: line 25: /home/andre/repos/bitcoin/build/src/qt/bitcoin-qt: No such file or directory\r\nhelp2man: can't get `--help' info from /home/andre/repos/bitcoin/build/src/qt/bitcoin-qt\r\nTry `--no-discard-stderr' if option outputs to stderr\r\n\u279c  bitcoin git:(master) \u2717 git status\r\nOn branch master\r\nYour branch is up to date with 'origin/master'.\r\n\r\nChanges not staged for commit:\r\n  (use \"git add <file>...\" to update what will be committed)\r\n  (use \"git restore <file>...\" to discard changes in working directory)\r\n\tmodified:   doc/man/bitcoin-cli.1\r\n\tmodified:   doc/man/bitcoin-tx.1\r\n\tmodified:   doc/man/bitcoin-util.1\r\n\tmodified:   doc/man/bitcoin-wallet.1\r\n\tmodified:   doc/man/bitcoind.1\r\n\r\n```\r\n\r\nThe script warned about `bitcoin-qt` being missing but still generated the other manpages, as you can see with the git status command.\n\n### Expected behaviour\n\n```sh\r\n\u279c  bitcoin git:(master) \u2717 BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py\r\n/home/andre/repos/bitcoin/build/src/qt/bitcoin-qt not found or not an executable. Skipping...\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoind.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-cli.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-tx.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-wallet.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-util.1\u2026\r\n```\n\n### Steps to reproduce\n\nRun `BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py` without having one of the binaries compiled e.g. bitcoin-qt.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster\n\n### Operating system and version\n\nDebian\n\n### Machine specifications\n\n_No response_\n", "hints_text": "", "created_at": "2024-09-26 21:37:58", "merge_commit_sha": "7590e93bc73b3bbac641f05d490fd5c984156b33", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30962", "base_commit": "393f323bd60b9d47be697820a7ddf075700a7273", "patch": "diff --git a/src/validation.cpp b/src/validation.cpp\nindex b47b1d09ae1e9..5da3387ad296f 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2020,7 +2020,8 @@ void Chainstate::CheckForkWarningConditions()\n \n     // Before we get past initial download, we cannot reliably alert about forks\n     // (we assume we don't get stuck on a fork before finishing our initial sync)\n-    if (m_chainman.IsInitialBlockDownload()) {\n+    // Also not applicable to the background chainstate\n+    if (m_chainman.IsInitialBlockDownload() || this->GetRole() == ChainstateRole::BACKGROUND) {\n         return;\n     }\n \n", "test_patch": "", "problem_statement": "`invalidateblock` during background validation\nIf you call `invalidateblock` (on the tip) during background validation, the node will currently do the following:\r\n#### bitcoin-cli invalidateblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:01:15Z [background validation] UpdateTip: new best=0000000000000000008dd2857255b2e5fc0c3955740c74dac6bafd0de09c344e height=482000 version=0x20000000 log2_work=86.991735 tx=249395394 date='2017-08-25T19:52:51Z' progress=0.230269 cache=238.7MiB(1748399txo)\r\n2024-09-24T13:02:42Z Saw new header hash=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671\r\n2024-09-24T13:02:45Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81087txo)\r\n2024-09-24T13:02:52Z [background validation] UpdateTip: new best=000000000000000000b7738efb4c4acbc841c032294d2e6ab09295f4117c7b3a height=484000 version=0x20000002 log2_work=87.061771 tx=252628356 date='2017-09-07T11:50:44Z' progress=0.233253 cache=688.5MiB(5222117txo)\r\n2024-09-24T13:02:58Z UpdateTip: new best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec height=862670 version=0x3fff0000 log2_work=95.172216 tx=1085323202 date='2024-09-24T13:00:39Z' progress=0.999999 cache=11.8MiB(77967txo)\r\n2024-09-24T13:02:58Z InvalidChainFound: invalid block=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe  height=862671  log2_work=95.172229  date=2024-09-24T13:02:21Z\r\n2024-09-24T13:02:58Z InvalidChainFound:  current best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec  height=862670  log2_work=95.172216  date=2024-09-24T13:00:39Z\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\n<repeat for every new block processed in the background validation>\r\n```\r\n#### bitcoin-cli reconsiderblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81332txo)\r\n2024-09-24T13:03:16Z New outbound-full-relay v2 peer connected: version: 70016, blocks=862671, peer=69\r\n2024-09-24T13:04:44Z [background validation] UpdateTip: new best=000000000000000000a2a8104d61651f76c666b70754d6e9346176385f7afa24 height=486000 version=0x20000000 log2_work=87.131847 tx=255540060 date='2017-09-19T09:09:00Z' progress=0.235942 cache=1014.2MiB(7475508txo)\r\n2024-09-24T13:06:42Z [background validation] UpdateTip: new best=000000000000000000f980eebec0616501eead146975f1df5ca9a1db40309547 height=488000 version=0x20000000 log2_work=87.210415 tx=258791302 date='2017-10-02T21:02:34Z' progress=0.238943 cache=1284.3MiB(9681780txo)\r\n2024-09-24T13:08:01Z [background validation] UpdateTip: new best=000000000000000000de069137b17b8d5a3dfbd5b145b2dcfb203f15d0c4de90 height=490000 version=0x20000000 log2_work=87.286453 tx=262368718 date='2017-10-15T17:57:17Z' progress=0.242246 cache=1521.0MiB(11621530txo)\r\n```\r\n\r\nPrinting these warning messages does not seem useful, or even the correct thing to do during a background sync; as the chain being warned about, is still our best, active chain?\n", "hints_text": "", "created_at": "2024-09-24 18:22:17", "merge_commit_sha": "da612cea032ba241e2d82418baf171b06e5f0142", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30884", "base_commit": "e43ce250c6fb65cc0c8903296c8ab228539d2204", "patch": "diff --git a/src/addrdb.cpp b/src/addrdb.cpp\nindex e9838d722291e..b89141c88e324 100644\n--- a/src/addrdb.cpp\n+++ b/src/addrdb.cpp\n@@ -73,7 +73,7 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n         remove(pathTmp);\n         return false;\n     }\n-    if (!FileCommit(fileout.Get())) {\n+    if (!fileout.Commit()) {\n         fileout.fclose();\n         remove(pathTmp);\n         LogError(\"%s: Failed to flush file %s\\n\", __func__, fs::PathToString(pathTmp));\ndiff --git a/src/bench/streams_findbyte.cpp b/src/bench/streams_findbyte.cpp\nindex 5098262e9afa6..004bf8ffc9dc7 100644\n--- a/src/bench/streams_findbyte.cpp\n+++ b/src/bench/streams_findbyte.cpp\n@@ -19,7 +19,7 @@ static void FindByte(benchmark::Bench& bench)\n     uint8_t data[file_size] = {0};\n     data[file_size-1] = 1;\n     file << data;\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n     BufferedFile bf{file, /*nBufSize=*/file_size + 1, /*nRewindIn=*/file_size};\n \n     bench.run([&] {\ndiff --git a/src/index/blockfilterindex.cpp b/src/index/blockfilterindex.cpp\nindex 41bdca9df562a..26de7eee32fc0 100644\n--- a/src/index/blockfilterindex.cpp\n+++ b/src/index/blockfilterindex.cpp\n@@ -151,7 +151,7 @@ bool BlockFilterIndex::CustomCommit(CDBBatch& batch)\n         LogError(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n-    if (!FileCommit(file.Get())) {\n+    if (!file.Commit()) {\n         LogError(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n@@ -201,11 +201,11 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n             LogPrintf(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!TruncateFile(last_file.Get(), pos.nPos)) {\n+        if (!last_file.Truncate(pos.nPos)) {\n             LogPrintf(\"%s: Failed to truncate filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!FileCommit(last_file.Get())) {\n+        if (!last_file.Commit()) {\n             LogPrintf(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\ndiff --git a/src/index/txindex.cpp b/src/index/txindex.cpp\nindex 80f615ed0e77b..425a7f00a0d08 100644\n--- a/src/index/txindex.cpp\n+++ b/src/index/txindex.cpp\n@@ -87,10 +87,7 @@ bool TxIndex::FindTx(const uint256& tx_hash, uint256& block_hash, CTransactionRe\n     CBlockHeader header;\n     try {\n         file >> header;\n-        if (fseek(file.Get(), postx.nTxOffset, SEEK_CUR)) {\n-            LogError(\"%s: fseek(...) failed\\n\", __func__);\n-            return false;\n-        }\n+        file.seek(postx.nTxOffset, SEEK_CUR);\n         file >> TX_WITH_WITNESS(tx);\n     } catch (const std::exception& e) {\n         LogError(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\nindex b40ca0260beee..44c2808c3bd46 100644\n--- a/src/node/blockstorage.cpp\n+++ b/src/node/blockstorage.cpp\n@@ -683,7 +683,7 @@ bool BlockManager::UndoWriteToDisk(const CBlockUndo& blockundo, FlatFilePos& pos\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write undo data\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\n@@ -981,7 +981,7 @@ bool BlockManager::WriteBlockToDisk(const CBlock& block, FlatFilePos& pos) const\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write block\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\ndiff --git a/src/node/mempool_persist.cpp b/src/node/mempool_persist.cpp\nindex a265c2e12d15a..ff7de8c64a259 100644\n--- a/src/node/mempool_persist.cpp\n+++ b/src/node/mempool_persist.cpp\n@@ -199,8 +199,8 @@ bool DumpMempool(const CTxMemPool& pool, const fs::path& dump_path, FopenFn mock\n         LogInfo(\"Writing %d unbroadcast transactions to file.\\n\", unbroadcast_txids.size());\n         file << unbroadcast_txids;\n \n-        if (!skip_file_commit && !FileCommit(file.Get()))\n-            throw std::runtime_error(\"FileCommit failed\");\n+        if (!skip_file_commit && !file.Commit())\n+            throw std::runtime_error(\"Commit failed\");\n         file.fclose();\n         if (!RenameOver(dump_path + \".new\", dump_path)) {\n             throw std::runtime_error(\"Rename failed\");\ndiff --git a/src/node/utxo_snapshot.cpp b/src/node/utxo_snapshot.cpp\nindex 976421e455391..7d589c886b824 100644\n--- a/src/node/utxo_snapshot.cpp\n+++ b/src/node/utxo_snapshot.cpp\n@@ -73,9 +73,11 @@ std::optional<uint256> ReadSnapshotBaseBlockhash(fs::path chaindir)\n     }\n     afile >> base_blockhash;\n \n-    if (std::fgetc(afile.Get()) != EOF) {\n+    int64_t position = afile.tell();\n+    afile.seek(0, SEEK_END);\n+    if (position != afile.tell()) {\n         LogPrintf(\"[snapshot] warning: unexpected trailing data in %s\\n\", read_from_str);\n-    } else if (std::ferror(afile.Get())) {\n+    } else if (afile.IsError()) {\n         LogPrintf(\"[snapshot] warning: i/o error reading %s\\n\", read_from_str);\n     }\n     return base_blockhash;\ndiff --git a/src/streams.cpp b/src/streams.cpp\nindex cdd36a86feb17..5f7baf92b9e8e 100644\n--- a/src/streams.cpp\n+++ b/src/streams.cpp\n@@ -4,21 +4,29 @@\n \n #include <span.h>\n #include <streams.h>\n+#include <util/fs_helpers.h>\n \n #include <array>\n \n+AutoFile::AutoFile(std::FILE* file, std::vector<std::byte> data_xor)\n+    : m_file{file}, m_xor{std::move(data_xor)}\n+{\n+    if (!IsNull()) {\n+        auto pos{std::ftell(m_file)};\n+        if (pos >= 0) m_position = pos;\n+    }\n+}\n+\n std::size_t AutoFile::detail_fread(Span<std::byte> dst)\n {\n     if (!m_file) throw std::ios_base::failure(\"AutoFile::read: file handle is nullptr\");\n-    if (m_xor.empty()) {\n-        return std::fread(dst.data(), 1, dst.size(), m_file);\n-    } else {\n-        const auto init_pos{std::ftell(m_file)};\n-        if (init_pos < 0) throw std::ios_base::failure(\"AutoFile::read: ftell failed\");\n-        std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n-        util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n-        return ret;\n+    size_t ret = std::fread(dst.data(), 1, dst.size(), m_file);\n+    if (!m_xor.empty()) {\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::read: position unknown\");\n+        util::Xor(dst.subspan(0, ret), m_xor, *m_position);\n     }\n+    if (m_position.has_value()) *m_position += ret;\n+    return ret;\n }\n \n void AutoFile::seek(int64_t offset, int origin)\n@@ -29,18 +37,23 @@ void AutoFile::seek(int64_t offset, int origin)\n     if (std::fseek(m_file, offset, origin) != 0) {\n         throw std::ios_base::failure(feof() ? \"AutoFile::seek: end of file\" : \"AutoFile::seek: fseek failed\");\n     }\n+    if (origin == SEEK_SET) {\n+        m_position = offset;\n+    } else if (origin == SEEK_CUR && m_position.has_value()) {\n+        *m_position += offset;\n+    } else {\n+        int64_t r{std::ftell(m_file)};\n+        if (r < 0) {\n+            throw std::ios_base::failure(\"AutoFile::seek: ftell failed\");\n+        }\n+        m_position = r;\n+    }\n }\n \n int64_t AutoFile::tell()\n {\n-    if (IsNull()) {\n-        throw std::ios_base::failure(\"AutoFile::tell: file handle is nullptr\");\n-    }\n-    int64_t r{std::ftell(m_file)};\n-    if (r < 0) {\n-        throw std::ios_base::failure(\"AutoFile::tell: ftell failed\");\n-    }\n-    return r;\n+    if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::tell: position unknown\");\n+    return *m_position;\n }\n \n void AutoFile::read(Span<std::byte> dst)\n@@ -60,6 +73,7 @@ void AutoFile::ignore(size_t nSize)\n             throw std::ios_base::failure(feof() ? \"AutoFile::ignore: end of file\" : \"AutoFile::ignore: fread failed\");\n         }\n         nSize -= nNow;\n+        if (m_position.has_value()) *m_position += nNow;\n     }\n }\n \n@@ -70,19 +84,34 @@ void AutoFile::write(Span<const std::byte> src)\n         if (std::fwrite(src.data(), 1, src.size(), m_file) != src.size()) {\n             throw std::ios_base::failure(\"AutoFile::write: write failed\");\n         }\n+        if (m_position.has_value()) *m_position += src.size();\n     } else {\n-        auto current_pos{std::ftell(m_file)};\n-        if (current_pos < 0) throw std::ios_base::failure(\"AutoFile::write: ftell failed\");\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::write: position unknown\");\n         std::array<std::byte, 4096> buf;\n         while (src.size() > 0) {\n             auto buf_now{Span{buf}.first(std::min<size_t>(src.size(), buf.size()))};\n             std::copy(src.begin(), src.begin() + buf_now.size(), buf_now.begin());\n-            util::Xor(buf_now, m_xor, current_pos);\n+            util::Xor(buf_now, m_xor, *m_position);\n             if (std::fwrite(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n                 throw std::ios_base::failure{\"XorFile::write: failed\"};\n             }\n             src = src.subspan(buf_now.size());\n-            current_pos += buf_now.size();\n+            *m_position += buf_now.size();\n         }\n     }\n }\n+\n+bool AutoFile::Commit()\n+{\n+    return ::FileCommit(m_file);\n+}\n+\n+bool AutoFile::IsError()\n+{\n+    return ferror(m_file);\n+}\n+\n+bool AutoFile::Truncate(unsigned size)\n+{\n+    return ::TruncateFile(m_file, size);\n+}\ndiff --git a/src/streams.h b/src/streams.h\nindex c2a9dea2878d1..431a4d77c6ced 100644\n--- a/src/streams.h\n+++ b/src/streams.h\n@@ -390,9 +390,10 @@ class AutoFile\n protected:\n     std::FILE* m_file;\n     std::vector<std::byte> m_xor;\n+    std::optional<int64_t> m_position;\n \n public:\n-    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={}) : m_file{file}, m_xor{std::move(data_xor)} {}\n+    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={});\n \n     ~AutoFile() { fclose(); }\n \n@@ -419,12 +420,6 @@ class AutoFile\n         return ret;\n     }\n \n-    /** Get wrapped FILE* without transfer of ownership.\n-     * @note Ownership of the FILE* will remain with this class. Use this only if the scope of the\n-     * AutoFile outlives use of the passed pointer.\n-     */\n-    std::FILE* Get() const { return m_file; }\n-\n     /** Return true if the wrapped FILE* is nullptr, false otherwise.\n      */\n     bool IsNull() const { return m_file == nullptr; }\n@@ -458,6 +453,10 @@ class AutoFile\n         ::Unserialize(*this, obj);\n         return *this;\n     }\n+\n+    bool Commit();\n+    bool IsError();\n+    bool Truncate(unsigned size);\n };\n \n /** Wrapper around an AutoFile& that implements a ring buffer to\ndiff --git a/src/util/asmap.cpp b/src/util/asmap.cpp\nindex f50cd8a28c12d..04b0673c49b42 100644\n--- a/src/util/asmap.cpp\n+++ b/src/util/asmap.cpp\n@@ -203,10 +203,10 @@ std::vector<bool> DecodeAsmap(fs::path path)\n         LogPrintf(\"Failed to open asmap file from disk\\n\");\n         return bits;\n     }\n-    fseek(filestr, 0, SEEK_END);\n-    int length = ftell(filestr);\n+    file.seek(0, SEEK_END);\n+    int length = file.tell();\n     LogPrintf(\"Opened asmap file %s (%d bytes) from disk\\n\", fs::quoted(fs::PathToString(path)), length);\n-    fseek(filestr, 0, SEEK_SET);\n+    file.seek(0, SEEK_SET);\n     uint8_t cur_byte;\n     for (int i = 0; i < length; ++i) {\n         file >> cur_byte;\n", "test_patch": "diff --git a/src/test/fuzz/autofile.cpp b/src/test/fuzz/autofile.cpp\nindex 45316b6b218db..81761c7bf9694 100644\n--- a/src/test/fuzz/autofile.cpp\n+++ b/src/test/fuzz/autofile.cpp\n@@ -56,7 +56,6 @@ FUZZ_TARGET(autofile)\n                 WriteToStream(fuzzed_data_provider, auto_file);\n             });\n     }\n-    (void)auto_file.Get();\n     (void)auto_file.IsNull();\n     if (fuzzed_data_provider.ConsumeBool()) {\n         FILE* f = auto_file.release();\ndiff --git a/src/test/streams_tests.cpp b/src/test/streams_tests.cpp\nindex 9217f05945f0c..777122df6d03a 100644\n--- a/src/test/streams_tests.cpp\n+++ b/src/test/streams_tests.cpp\n@@ -261,7 +261,7 @@ BOOST_AUTO_TEST_CASE(streams_buffered_file)\n     for (uint8_t j = 0; j < 40; ++j) {\n         file << j;\n     }\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n \n     // The buffer size (second arg) must be greater than the rewind\n     // amount (third arg).\n@@ -391,7 +391,7 @@ BOOST_AUTO_TEST_CASE(streams_buffered_file_skip)\n     for (uint8_t j = 0; j < 40; ++j) {\n         file << j;\n     }\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n \n     // The buffer is 25 bytes, allow rewinding 10 bytes.\n     BufferedFile bf{file, 25, 10};\n@@ -444,7 +444,7 @@ BOOST_AUTO_TEST_CASE(streams_buffered_file_rand)\n         for (uint8_t i = 0; i < fileSize; ++i) {\n             file << i;\n         }\n-        std::rewind(file.Get());\n+        file.seek(0, SEEK_SET);\n \n         size_t bufSize = m_rng.randrange(300) + 1;\n         size_t rewindSize = m_rng.randrange(bufSize);\n", "problem_statement": "28.0rc1 synchronizes much slower on Windows\nBitcoin Core 28.0rc1 (both pre-built and self-built binary) on Windows 10 synchronizes much slower than 27.0 after around block 120,000 when blocks stop being almost empty. I'm running with default settings (dbcache=450, pruning disabled).\r\n\r\nTime to synchronize to block 300,000: (measured around 10 runs each, alternating between the versions)\r\n27.0: **695 seconds**\r\n28.0rc1: **2760 seconds**\r\n\r\n![28.0rc1](https://github.com/user-attachments/assets/060a1e18-7f97-4e86-9ba8-5bf867b3510e)\r\n\r\nRunning the Linux pre-built binary in WSL doesn't show the slowdown, so it's probably limited to Windows.\r\n\r\n~~I'm going to bisect this, but that will definitely take me a while. If anyone suspects a commit/PR that I should look at first that might help.~~ I've bisected this down to #28052, for more details see https://github.com/bitcoin/bitcoin/issues/30833#issuecomment-2335184072.\n", "hints_text": "Try whether #28280 had any impact.\nI actually benchmarked #28280 right before it got merged: https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2268695679\r\n\r\nFrom the results it definitely seems that PR is not to blame and the regression happened later.\nhttps://github.com/bitcoin/bitcoin/pull/30326?\nReason I suspect #30326 is because `try_emplace` must be doing more work than just `find` and is only called after blocks stop being empty because previous coins are now being looked up to be spent.\r\n\r\nRelevant stackoverflow https://stackoverflow.com/questions/24209592/performance-of-emplace-is-worse-than-check-followed-by-emplace\n@andrewtoth I cannot imagine that causing a 5x slowdown, though?\nOnly did one run of each but I have basically the opposite result: 4406 seconds for 27.1, and 2949 for 28.0rc1.\n@vostrnad when you say synchronizes, do you mean running with `-reindex-chainstate` or are you starting with a fresh data directory and downloading blocks from peers? If the latter, are you downloading blocks from a node in your local network?\n@andrewtoth I updated the OP. I'm synchronizing from a local node with a fresh datadir each time.\n@vostrnad  I'm trying to get a Windows box setup to reproduce this myself, but if you get a chance, could you do a run of both again with `-debug=bench` set, and post the final set of `[bench]` logs that get written to debug.log? Those might help narrow where the slowdown is coming from.\nI've bisected this down to #28052. From the benchmark results it appears to be solely responsible for the slowdown between 27.0 and 28.0rc1 (so #30326 should be fine @andrewtoth).\r\n\r\nBenchmark results: (fresh sync to block 300,000 from a local node, using default settings, all binaries self-built using Mingw-w64, around 6 runs each)\r\n\r\nd82283950f5ff3b2116e705f931c6e89e5fdd0be (v27.0): **738s \u00b1 16s**\r\nfa7f7ac040a9467c307b20e77dc47c87d7377ded (first commit of #28052): **733s \u00b1 21s**\r\nfa895c72832f9555b52d5bb1dba1093f73de3136 (top commit of #28052): **2827s \u00b1 9s**\r\n88f0419c1ab1e5f3ccf425435e530d8ceb72c7f1 (v28.0rc1): **2815 \u00b1 13s**\r\n\r\n![blocksxor](https://github.com/user-attachments/assets/180f6600-fe2f-4cef-8bcd-6c5fa6c405fc)\r\n\n@vostrnad Does the performance on Windows recover if you run with the `-blocksxor=0` option?\n@sipa No, it's exactly the same with `-blocksxor=0`.\n> @sipa No, it's exactly the same with `-blocksxor=0`.\r\n\r\nThis has uncovered a bug in #28052, `InitBlocksdirXorKey` does not return an empty `std::vector<std::byte>` when the `-blocksxor=0` argument is used, it instead [returns](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1185) a [vector with 8 bytes equal to zero](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1152):\r\n\r\n```cpp\r\nstatic auto InitBlocksdirXorKey(const BlockManager::Options& opts)\r\n{\r\n    std::array<std::byte, 8> xor_key{};\r\n    \r\n    if (opts.use_xor && fs::is_empty(opts.blocks_dir)) {\r\n        // Only use random fresh key when the boolean option is set and on the\r\n        // very first start of the program.\r\n        FastRandomContext{}.fillrand(xor_key);\r\n    }\r\n    \r\n    // [...]\r\n    return std::vector<std::byte>{xor_key.begin(), xor_key.end()};\r\n}\r\n```\r\n\r\nIn turn, this causes us to go through the XOR logic of [`AutoFile::detail_fread()`](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/streams.cpp#L10-L22) and [`AutoFile::write()`](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/streams.cpp#L66-L88) since the block autofiles' `std::vector<std::byte> m_xor` are [initialized](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1190) to the return value of `InitBlocksdirXorKey`.\r\n\r\nE.g.: https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/streams.cpp#L10-L23\r\n\r\nI have a branch off of `28.x` (https://github.com/davidgumberg/bitcoin/commit/aa0be4031cbe5bed407bc7a1753875cc1c4ddccb) that should fix this issue when `-blocksxor=0` but I haven't tested yet\r\n\r\nI also managed to reproduce (n=1) the issue on Windows 10 LTSC Build 17763:\r\n\r\n```bash\r\nbitcoind.exe -dbcache=450 -stopatheight=300000 -debug=bench -connect=localnode:8333\r\n```\r\n\r\n28.0rc1 took 7,368 seconds\r\n27.1 took 3,594 seconds\n> This has uncovered a bug in https://github.com/bitcoin/bitcoin/pull/28052, InitBlocksdirXorKey does not return an empty std::vector<std::byte> when the -blocksxor=0 argument is used, it instead [returns](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1185) a [vector with 8 bytes equal to zero](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1152):\r\n\r\nI may be missing something because I am looking at the blocksxor stuff the first time but that doesn't seem to be a bug. When XOR is disabled we still write the xor file with zeros. There is even a functional test for that behavior: https://github.com/bitcoin/bitcoin/blob/master/test/functional/feature_blocksxor.py#L64 Your branch seems to change that expected behavior.\nSeems worth experimenting with:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src%2Fstreams.cpp#L76-L80\r\n\r\nI wonder if the array creation, the copy, or the xoring here are the long pole in the tent? Experimenting with the all 0s xor key can help isolate.\r\n\r\nI'll have to take a look, but do we have any IBD tests/benches mimicking a significant IBD (e.g. first 400k blocks)? It would be good to catch performence regressions automatically.\r\n\r\nSomething on [bitcoinperf.com](https://codespeed.bitcoinperf.com/comparison/)? (looks like maybe the data there is stale)\r\n\r\nOr something like a functional test that has two nodes, one node creating a chain of similar complexity/size (if we don't want to store that part of mainnet), then the second node does IBD from first? Ci could run the test and be set to timeout for an excessively long IBD (which albeit is subjective so not ideal). Maybe it's better to leave CI out of this?\n> > This has uncovered a bug in #28052, InitBlocksdirXorKey does not return an empty std::vectorstd::byte when the -blocksxor=0 argument is used, it instead [returns](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1185) a [vector with 8 bytes equal to zero](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1152):\r\n> \r\n> I may be missing something because I am looking at the blocksxor stuff the first time but that doesn't seem to be a bug. When XOR is disabled we still write the xor file with zeros. There is even a functional test for that behavior: https://github.com/bitcoin/bitcoin/blob/master/test/functional/feature_blocksxor.py#L64 Your branch seems to change that expected behavior.\r\n\r\nYou're right, creating an xor.dat with all zeroes when `-blocksxor=0` was intended, so not a bug in that PR. Still, the fact that when a user disables xor'ing blocks we still perform all the usual XOR logic, but with an XOR pattern of zeroes doesn't make sense to me, and it seems like an unintended side effect of https://github.com/bitcoin/bitcoin/pull/28052 .\r\n\r\nI tested https://github.com/davidgumberg/bitcoin/commit/aa0be4031cbe5bed407bc7a1753875cc1c4ddccb with `-blocksxor=0` and the same Windows setup and the performance regression goes away.\r\n\r\nI'm still investigating, but my bench logs indicate that the regression is coming from writing block undo data, the difference between the (reported) total block connection time between v27.1 and v28.0rc1 is +1,337.85 seconds for v28, and the difference in (reported) time spent writing undo block data is +1,579.31s for v28:\r\n\r\n<details>\r\n\r\n<summary>Version 28.0 rc1 bench logs</summary>\r\n\r\n```diff\r\n [bench]   - Using cached block\r\n [bench]   - Load block from disk: 0.57ms\r\n [bench]     - Sanity checks: 0.02ms [5.37s (0.02ms/blk)]\r\n [bench]     - Fork checks: 0.40ms [159.15s (0.53ms/blk)]\r\n [bench]       - Connect 512 transactions: 2.95ms (0.006ms/tx, 0.002ms/txin) [303.09s (1.01ms/blk)]\r\n [bench]     - Verify 1180 txins: 3.45ms (0.003ms/txin) [425.49s (1.42ms/blk)]\r\n+[bench]     - Write undo data: 26.38ms [2296.37s (7.65ms/blk)]\r\n [bench]     - Index writing: 0.46ms [148.03s (0.49ms/blk)]\r\n [bench]   - Connect total: 31.98ms [3281.81s (10.94ms/blk)]\r\n [bench]   - Flush: 2.44ms [246.56s (0.82ms/blk)]\r\n [bench]   - Writing chainstate: 0.89ms [107.89s (0.36ms/blk)]\r\n UpdateTip: new best=000000000000000049a0914d83df36982c77ac1f65ade6a52bdced2ce312aba9 height=300001 version=0x00000002 log2_work=78.499665 tx=38464301 date='2014-05-10T06:51:23Z' progress=0.035833 cache=641.2MiB(5186028txo)\r\n [bench]   - Connect postprocess: 0.64ms [261.25s (0.87ms/blk)]\r\n+[bench] - Connect block: 36.53ms [4041.91s (13.47ms/blk)]\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Version 27.1 bench logs</summary>\r\n\r\n```diff\r\n [bench]   - Using cached block\r\n [bench]   - Load block from disk: 1.03ms\r\n [bench]     - Sanity checks: 0.02ms [5.58s (0.02ms/blk)]\r\n [bench]     - Fork checks: 0.36ms [154.95s (0.52ms/blk)]\r\n [bench]       - Connect 173 transactions: 1.39ms (0.008ms/tx, 0.003ms/txin) [330.82s (1.10ms/blk)]\r\n [bench]     - Verify 435 txins: 2.02ms (0.005ms/txin) [478.57s (1.60ms/blk)]\r\n+[bench]     - Write undo data: 1.24ms [717.06s (2.39ms/blk)]\r\n [bench]     - Index writing: 0.33ms [152.89s (0.51ms/blk)]\r\n [bench]   - Connect total: 5.11ms [1754.52s (5.85ms/blk)]\r\n [bench]   - Flush: 1.35ms [310.98s (1.04ms/blk)]\r\n [bench]   - Writing chainstate: 0.33ms [149.58s (0.50ms/blk)]\r\n UpdateTip: new best=000000000000000082aee4ff546c1db5e1aa5f9bfbaa0c76300a792b3e91fce7 height=300003 version=0x00000002 log2_work=78.499897 tx=38464563 date='2014-05-10T06:58:47Z' progress=0.035342 cache=510.6MiB(4668409txo)\r\n [bench]   - Connect postprocess: 0.86ms [356.88s (1.19ms/blk)]\r\n+[bench] - Connect block: 8.68ms [2704.06s (9.01ms/blk)]\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>\r\n\r\nMy modified branch of 28.x with `-blocksxor=0` bench logs\r\n\r\n</summary>\r\n\r\n```diff\r\n [bench]   - Using cached block\r\n [bench]   - Load block from disk: 0.23ms\r\n [bench]     - Sanity checks: 0.01ms [5.35s (0.02ms/blk)]\r\n [bench]     - Fork checks: 0.29ms [150.64s (0.50ms/blk)]\r\n [bench]       - Connect 512 transactions: 2.18ms (0.004ms/tx, 0.002ms/txin) [308.30s (1.03ms/blk)]\r\n [bench]     - Verify 1180 txins: 2.58ms (0.002ms/txin) [448.44s (1.49ms/blk)]\r\n+[bench]     - Write undo data: 1.62ms [758.14s (2.53ms/blk)]\r\n [bench]     - Index writing: 0.30ms [127.39s (0.42ms/blk)]\r\n [bench]   - Connect total: 5.72ms [1710.90s (5.70ms/blk)]\r\n [bench]   - Flush: 2.31ms [258.95s (0.86ms/blk)]\r\n [bench]   - Writing chainstate: 0.49ms [142.43s (0.47ms/blk)]\r\n UpdateTip: new best=000000000000000049a0914d83df36982c77ac1f65ade6a52bdced2ce312aba9 height=300001 version=0x00000002 log2_work=78.499665 tx=38464301 date='2014-05-10T06:51:23Z' progress=0.035817 cache=641.2MiB(5186028txo)\r\n [bench]   - Connect postprocess: 0.89ms [305.06s (1.02ms/blk)]\r\n+[bench] - Connect block: 9.64ms [2531.72s (8.44ms/blk)]\r\n```\r\n\r\n</details>\n@davidgumberg Well from the (apparently mistaken) assumption that the XOR logic comes with no material performance cost, it made sense to always want to use it (even with a pattern of zero), just from a perspective of minimizing different code branch combinations.\n\nIf the XOR logic is too slow (on some systems), as it appears to be, we have two options:\n* Disabling it when (nonzero) XORing is not enabled, but that leaves us with the uncomfortable choice to make of (perhaps selectively) disabling (nonzero) XORing by default, as Windows users will otherwise still suffer with 28.0.\n* Fixing the performance issue.\n> My bench logs indicate that the regression is coming from writing block undo data, the difference between the (reported) total block connection time between v27.1 and v28.0rc1 is +1,337.85 seconds for v28, and the difference in (reported) time spent writing undo block data is +1,579.31s for v28:\r\n\r\nThis is saying that the total time for writing undo block data exceeds total block connection time. But, writing undo block data is a subsection of block connection time, so it should always be less no?\r\n\r\nAlso, the logs show `Using cached block`, meaning it is not counting saving the block itself to disk in the `Connect block` benchmark. So, actually saving the blocks in `AcceptBlock` might be taking even more time than writing the undo blocks.\n@andrewtoth \r\n>> My bench logs indicate that the regression is coming from writing block undo data, the difference between the (reported) total block connection time between v27.1 and v28.0rc1 is +1,337.85 seconds for v28, and the difference in (reported) time spent writing undo block data is +1,579.31s for v28:\r\n>\r\n> This is saying that the total time for writing undo block data exceeds total block connection time. But, writing undo block data is a subsection of block connection time, so it should always be less no?\r\n\r\nSorry, I did not express that well, the two numbers I gave are the delta between v27.1 and v28.0rc1, total time spent writing undo block data is 2,296.37s in v28 and 717.06s in v27.1. Total time spent doing block connection is 4041.91s in v28.0rc1 and 2704.06s in v27.1.\r\n \r\nOther parts of the v28 sync are faster (at least in my n=1 run~~s~~) , e.g. flushing the temporary `CCoinsViewCache` takes ~60 fewer seconds in v28 compensating for the increased time spent writing undo data.\r\n\r\n> Also, the logs show Using cached block, meaning it is not counting saving the block itself to disk in the Connect block benchmark. So, actually saving the blocks in AcceptBlock might be taking even more time than writing the undo blocks.\r\n\r\nI see, I guess that explains why the difference in wall clock time taken (v28 took 3,774 more seconds) is more than double the size of the slowdown reported by the ConnectBlock bench logs (v28 took 1,337.85 seconds longer doing block connection).\r\n\r\n---\r\n\r\n@tdb3\r\n> Seems worth experimenting with:\r\n> \r\n> https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src%2Fstreams.cpp#L76-L80\r\n> \r\n> I wonder if the array creation, the copy, or the xoring here are the long pole in the tent? Experimenting with the all 0s xor key can help isolate.\r\n\r\nIt seems there was some prior discussion around this in #28060 which may be of interest:\r\nhttps://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260260590\r\n\r\n---\r\n\r\nI wonder if this issue could be caused by number of calls we make to `fwrite` because of the write buffering in xor path of `AutoFile::write()`, maybe platforms other than windows are optimizing our writes into batches behind the scenes? I don't know much about how I/O works behind the scenes, just a guess.\n> I wonder if this issue could be caused by number of calls we make to `fwrite` because of the write buffering in xor path of `AutoFile::write()`, maybe platforms other than windows are optimizing our writes into batches behind the scenes? I don't know much about how I/O works behind the scenes, just a guess.\r\n\r\nI have not checked, but this would be my guess.\nThe xor patch didn't change buffering. Yes, in theory there is a 4096 byte max buffer, however, this is never hit in practice. Undo data consists of small integers (4 bytes or 1 byte) and short strings (like output scripts).\r\n\r\nI expect that if you print the number of writes before and after, they are exactly the same. If you also print the size of the writes they should show a histogram where 1-byte writes are the most common (probably all varint), followed by various writes all shorter than 33 bytes (or whatever the largest output script is).\r\n\r\nI don't have Windows, so I can't say what is happening there and why something is observable there, while the same isn't observable on Linux.\r\n\r\nIt may be useful to run the Xor benchmark on the same machine in Windows and on Linux, to see if the performance differs there: `./bench_bitcoin -filter=Xor -min-time=100`.\r\n\r\nAlso, it is possible to write a new benchmark, to see if the xor overhead is unexpectely large inside AutoFile:\r\n\r\n```diff\r\ndiff --git a/src/bench/xor.cpp b/src/bench/xor.cpp\r\nindex fc9dc5d172..96cb952c3b 100644\r\n--- a/src/bench/xor.cpp\r\n+++ b/src/bench/xor.cpp\r\n@@ -21,4 +21,19 @@ static void Xor(benchmark::Bench& bench)\r\n     });\r\n }\r\n \r\n+static void AutoFileXor(benchmark::Bench& bench)\r\n+{\r\n+    FastRandomContext frc{/*fDeterministic=*/true};\r\n+    auto data{frc.randbytes<std::byte>(4'000'000)};\r\n+    auto key{frc.randbytes<std::byte>(8)};\r\n+\r\n+    auto path{path_to_a_temp_file_on_the_storage_device_under_test};\r\n+\r\n+    bench.batch(data.size()).unit(\"byte\").run([&] {\r\n+        AutoFile f{fsbridge::fopen(path, \"wb+\"), key};\r\n+        f << data;\r\n+    });\r\n+}\r\n+\r\n BENCHMARK(Xor, benchmark::PriorityLevel::HIGH);\r\n+BENCHMARK(AutoFileXor, benchmark::PriorityLevel::HIGH);\r\n```\r\n\r\n<!---\r\n\r\nGenerally, when providing an xor pattern to an `AutoFile` before using its `write` method, it is expected that the `write` is slower. This should hold on any platform and the relative slowdown should depend on the write speed of the underlying storage, as well as the CPU speed.\nApart from the benchmark, it may also be useful to create a flamegraph/heatmap, so that it is easy to see where the time is spent.\nI managed to get bitcoind compiled on my windows installation (Windows 10 Pro 22H2, MSVC 2022), didn't observe a notable difference in the benchmarks.\r\nI'm still in the process of trying to test the sync speed, but if it's due to the undo data, then a reindex-chainstate should be sufficient to see the difference?! Did anyone try that already?\n> I managed to get bitcoind compiled on my windows installation (Windows 10 Pro 22H2, MSVC 2022), didn't observe a notable difference in the benchmarks.\r\n\r\nI hope everyone measuring performance on Windows has disabled all antivirus software, at least for the data directory. Right?\n@hebasto Yes, I have disabled antivirus for both the data directory and the directory where the binaries are located, I checked that the antivirus CPU utilization stays low during the benchmarks, and I'm using identical directory locations for both versions so they wouldn't be treated differently by the antivirus anyway.\nDiscussion from today's IRC meeting is that we should move forward with @davidgumberg's patch and default to false on Windows for this release.", "created_at": "2024-09-12 15:57:22", "merge_commit_sha": "9f1aa88d4d9596aeb5220fa30ee3972294b62793", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30821", "base_commit": "d6a1b94ffdd845cd4886fd468f0e5910740eaf1d", "patch": "diff --git a/src/txmempool.h b/src/txmempool.h\nindex d0cb41a078ec2..7fdf1c5a39ae9 100644\n--- a/src/txmempool.h\n+++ b/src/txmempool.h\n@@ -23,7 +23,17 @@\n #include <util/result.h>\n #include <util/feefrac.h>\n \n+// This works around a bug in Boost <= 1.80.0 when using Clang >=18.\n+// See https://github.com/bitcoin/bitcoin/issues/30751.\n+#if defined(__clang__)\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wenum-constexpr-conversion\"\n+#endif\n #include <boost/multi_index/hashed_index.hpp>\n+#if defined(__clang__)\n+#pragma clang diagnostic pop\n+#endif\n+\n #include <boost/multi_index/identity.hpp>\n #include <boost/multi_index/indexed_by.hpp>\n #include <boost/multi_index/ordered_index.hpp>\n", "test_patch": "", "problem_statement": "build: Boost 1.74.0 incompatible with Clang 18\nPointed out here: https://github.com/bitcoin/bitcoin/pull/30739#pullrequestreview-2267576746.\r\nCompiling with Clang 18 and Boost 1.74.0 fails:\r\n```bash\r\nIn file included from /usr/include/boost/mpl/integral_c.hpp:32:\r\n/usr/include/boost/mpl/aux_/integral_wrapper.hpp:73:31: error: integer value -1 is outside the valid range of values [0, 3] for the enumeration type 'udt_builtin_mixture_enum' [-Wenum-constexpr-conversion]\r\n   73 |     typedef AUX_WRAPPER_INST( BOOST_MPL_AUX_STATIC_CAST(AUX_WRAPPER_VALUE_TYPE, (value - 1)) ) prior;\r\n      |                               ^\r\n/usr/include/boost/mpl/aux_/static_cast.hpp:24:47: note: expanded from macro 'BOOST_MPL_AUX_STATIC_CAST'\r\n   24 | #   define BOOST_MPL_AUX_STATIC_CAST(T, expr) static_cast<T>(expr)\r\n      |                                               ^\r\nIn file included from ../../../src/test/validation_chainstatemanager_tests.cpp:8:\r\nIn file included from ../../../src/node/chainstatemanager_args.h:9:\r\nIn file included from ../../../src/validation.h:28:\r\nIn file included from ../../../src/txmempool.h:26:\r\nIn file included from /usr/include/boost/multi_index/hashed_index.hpp:38:\r\nIn file included from /usr/include/boost/multi_index/detail/node_handle.hpp:22:\r\nIn file included from /usr/include/boost/multi_index_container_fwd.hpp:18:\r\nIn file included from /usr/include/boost/multi_index/indexed_by.hpp:17:\r\nIn file included from /usr/include/boost/mpl/vector.hpp:36:\r\nIn file included from /usr/include/boost/mpl/vector/vector20.hpp:18:\r\nIn file included from /usr/include/boost/mpl/vector/vector10.hpp:18:\r\nIn file included from /usr/include/boost/mpl/vector/vector0.hpp:24:\r\nIn file included from /usr/include/boost/mpl/vector/aux_/clear.hpp:18:\r\nIn file included from /usr/include/boost/mpl/vector/aux_/vector0.hpp:22:\r\nIn file included from /usr/include/boost/mpl/vector/aux_/iterator.hpp:19:\r\nIn file included from /usr/include/boost/mpl/plus.hpp:19:\r\nIn file included from /usr/include/boost/mpl/aux_/arithmetic_op.hpp:17:\r\nIn file included from /usr/include/boost/mpl/integral_c.hpp:32:\r\n/usr/include/boost/mpl/aux_/integral_wrapper.hpp:73:31: error: integer value -1 is outside the valid range of values [0, 3] for the enumeration type 'int_float_mixture_enum' [-Wenum-constexpr-conversion]\r\n/usr/include/boost/mpl/aux_/static_cast.hpp:24:47: note: expanded from macro 'BOOST_MPL_AUX_STATIC_CAST'\r\n   24 | #   define BOOST_MPL_AUX_STATIC_CAST(T, expr) static_cast<T>(expr)\r\n      |                                               ^\r\n2 errors generated.\r\n```\r\n\r\nThe same failure does not happen with GCC (12), but may do with later versions: https://sourceware.org/bugzilla/show_bug.cgi?id=31331.\r\n\r\nGiven our documentation currently claims that Boost `1.73.0` is supported, this should be fixed in some way, the documentation updated to drop support for this version, etc. Although, it looks like part of the fix for the Boost code only landed as of 1.86.0? https://github.com/boostorg/mpl/issues/69 (currently the latest release).\n", "hints_text": "> Boost code only landed as of 1.86.0?\r\n\r\nUgh. I guess depends can be bumped, but using that as the minimum requirement seems a bit strict.\r\n\r\nWhile this is technically UB, is it actually observable in the compiled `bitcoind`?\n> Compiling with Clang 18 and Boost 1.74.0 fails:\r\n\r\nClang 18 is used for macOS targets in Guix. Why does it work?\nBecause it's not using 1.74.0? The change to Boost Numeric in 1.81.0 may be enough to avoid the issue.\nMaybe the fixes can be reverted, then an objdump of `bitcoind` can be compared to see if it differs? If not, then it could be dead code that just happens to be compiled.\r\n\r\nIn that case, maybe turning the error into a warning could be an alternative?\ncan confirm this issue exists with boost 1.76 as well, under the same environment.\nFwiw, I also ran across this problem (Ubuntu 20.04) while trying to run `clang-tidy-diff` on my code. A workaround is to just install and use clang-17.\r\n```\r\ncmake -B build -DCMAKE_C_COMPILER=clang-17 -DCMAKE_CXX_COMPILER=clang++-17 -DCMAKE_EXPORT_COMPILE_COMMANDS=ON\r\ncmake --build build -j $(nproc)\r\ngit diff HEAD~2 | ( cd ./src/ && clang-tidy-diff -p2 -path ../build -j $(nproc) )\r\n```\n> Fwiw, I also ran across this problem (Ubuntu 20.04)\r\n\r\nI guess you also installed a different boost version, because the 1.71 boost version in Ubuntu Focal 20.04 is not supported starting with https://github.com/bitcoin/bitcoin/pull/29066 and shouldn't even pass the `cmake -B` command.\n> > Fwiw, I also ran across this problem (Ubuntu 20.04)\r\n> \r\n> I guess you also installed a different boost version, because the 1.71 boost version in Ubuntu Focal 20.04 is not supported starting with #29066 and shouldn't even pass the `cmake -B` command.\r\n\r\nYup, I have boost 1.74.0.3 installed.\r\n```sh\r\ndpkg -s libboost-dev | grep 'Version'\r\nVersion: 1.74.0.3ubuntu7\r\n```", "created_at": "2024-09-05 13:24:12", "merge_commit_sha": "7f472e9bcd27c15533499b2faa35194b5897a6e2", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30697", "base_commit": "6d546336e800f7b8990fececab6bc08413f28690", "patch": "diff --git a/src/interfaces/chain.h b/src/interfaces/chain.h\nindex af45f81f95e45..be596b17657cb 100644\n--- a/src/interfaces/chain.h\n+++ b/src/interfaces/chain.h\n@@ -96,6 +96,17 @@ struct BlockInfo {\n     BlockInfo(const uint256& hash LIFETIMEBOUND) : hash(hash) {}\n };\n \n+//! The action to be taken after updating a settings value.\n+//! WRITE indicates that the updated value must be written to disk,\n+//! while SKIP_WRITE indicates that the change will be kept in memory-only\n+//! without persisting it.\n+enum class SettingsAction {\n+    WRITE,\n+    SKIP_WRITE\n+};\n+\n+using SettingsUpdate = std::function<std::optional<interfaces::SettingsAction>(common::SettingsValue&)>;\n+\n //! Interface giving clients (wallet processes, maybe other analysis tools in\n //! the future) ability to access to the chain state, receive notifications,\n //! estimate fees, and submit transactions.\n@@ -344,9 +355,16 @@ class Chain\n     //! Return <datadir>/settings.json setting value.\n     virtual common::SettingsValue getRwSetting(const std::string& name) = 0;\n \n-    //! Write a setting to <datadir>/settings.json. Optionally just update the\n-    //! setting in memory and do not write the file.\n-    virtual bool updateRwSetting(const std::string& name, const common::SettingsValue& value, bool write=true) = 0;\n+    //! Updates a setting in <datadir>/settings.json.\n+    //! Depending on the action returned by the update function, this will either\n+    //! update the setting in memory or write the updated settings to disk.\n+    virtual bool updateRwSetting(const std::string& name, const SettingsUpdate& update_function) = 0;\n+\n+    //! Replace a setting in <datadir>/settings.json with a new value.\n+    virtual bool overwriteRwSetting(const std::string& name, common::SettingsValue& value, bool write = true) = 0;\n+\n+    //! Delete a given setting in <datadir>/settings.json.\n+    virtual bool deleteRwSettings(const std::string& name, bool write = true) = 0;\n \n     //! Synchronously send transactionAddedToMempool notifications about all\n     //! current mempool transactions to the specified handler and return after\ndiff --git a/src/node/interfaces.cpp b/src/node/interfaces.cpp\nindex 9fe08eb3dd3d4..54b986c926afd 100644\n--- a/src/node/interfaces.cpp\n+++ b/src/node/interfaces.cpp\n@@ -814,14 +814,32 @@ class ChainImpl : public Chain\n         });\n         return result;\n     }\n-    bool updateRwSetting(const std::string& name, const common::SettingsValue& value, bool write) override\n+    bool updateRwSetting(const std::string& name,\n+                         const interfaces::SettingsUpdate& update_settings_func) override\n     {\n+        std::optional<interfaces::SettingsAction> action;\n         args().LockSettings([&](common::Settings& settings) {\n-            if (value.isNull()) {\n-                settings.rw_settings.erase(name);\n-            } else {\n-                settings.rw_settings[name] = value;\n-            }\n+            auto* ptr_value = common::FindKey(settings.rw_settings, name);\n+            // Create value if it doesn't exist\n+            auto& value = ptr_value ? *ptr_value : settings.rw_settings[name];\n+            action = update_settings_func(value);\n+        });\n+        if (!action) return false;\n+        // Now dump value to disk if requested\n+        return *action == interfaces::SettingsAction::SKIP_WRITE || args().WriteSettingsFile();\n+    }\n+    bool overwriteRwSetting(const std::string& name, common::SettingsValue& value, bool write) override\n+    {\n+        if (value.isNull()) return deleteRwSettings(name, write);\n+        return updateRwSetting(name, [&](common::SettingsValue& settings) {\n+            settings = std::move(value);\n+            return write ? interfaces::SettingsAction::WRITE : interfaces::SettingsAction::SKIP_WRITE;\n+        });\n+    }\n+    bool deleteRwSettings(const std::string& name, bool write) override\n+    {\n+        args().LockSettings([&](common::Settings& settings) {\n+            settings.rw_settings.erase(name);\n         });\n         return !write || args().WriteSettingsFile();\n     }\ndiff --git a/src/wallet/load.cpp b/src/wallet/load.cpp\nindex e26347d437af3..129b5c7c2a0a7 100644\n--- a/src/wallet/load.cpp\n+++ b/src/wallet/load.cpp\n@@ -69,7 +69,7 @@ bool VerifyWallets(WalletContext& context)\n             // Pass write=false because no need to write file and probably\n             // better not to. If unnamed wallet needs to be added next startup\n             // and the setting is empty, this code will just run again.\n-            chain.updateRwSetting(\"wallet\", wallets, /* write= */ false);\n+            chain.overwriteRwSetting(\"wallet\", wallets, /*write=*/false);\n         }\n     }\n \ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\nindex 5584b43520aa6..e2d7429f94dbc 100644\n--- a/src/wallet/wallet.cpp\n+++ b/src/wallet/wallet.cpp\n@@ -93,25 +93,30 @@ namespace wallet {\n \n bool AddWalletSetting(interfaces::Chain& chain, const std::string& wallet_name)\n {\n-    common::SettingsValue setting_value = chain.getRwSetting(\"wallet\");\n-    if (!setting_value.isArray()) setting_value.setArray();\n-    for (const common::SettingsValue& value : setting_value.getValues()) {\n-        if (value.isStr() && value.get_str() == wallet_name) return true;\n-    }\n-    setting_value.push_back(wallet_name);\n-    return chain.updateRwSetting(\"wallet\", setting_value);\n+    const auto update_function = [&wallet_name](common::SettingsValue& setting_value) {\n+        if (!setting_value.isArray()) setting_value.setArray();\n+        for (const auto& value : setting_value.getValues()) {\n+            if (value.isStr() && value.get_str() == wallet_name) return interfaces::SettingsAction::SKIP_WRITE;\n+        }\n+        setting_value.push_back(wallet_name);\n+        return interfaces::SettingsAction::WRITE;\n+    };\n+    return chain.updateRwSetting(\"wallet\", update_function);\n }\n \n bool RemoveWalletSetting(interfaces::Chain& chain, const std::string& wallet_name)\n {\n-    common::SettingsValue setting_value = chain.getRwSetting(\"wallet\");\n-    if (!setting_value.isArray()) return true;\n-    common::SettingsValue new_value(common::SettingsValue::VARR);\n-    for (const common::SettingsValue& value : setting_value.getValues()) {\n-        if (!value.isStr() || value.get_str() != wallet_name) new_value.push_back(value);\n-    }\n-    if (new_value.size() == setting_value.size()) return true;\n-    return chain.updateRwSetting(\"wallet\", new_value);\n+    const auto update_function = [&wallet_name](common::SettingsValue& setting_value) {\n+        if (!setting_value.isArray()) return interfaces::SettingsAction::SKIP_WRITE;\n+        common::SettingsValue new_value(common::SettingsValue::VARR);\n+        for (const auto& value : setting_value.getValues()) {\n+            if (!value.isStr() || value.get_str() != wallet_name) new_value.push_back(value);\n+        }\n+        if (new_value.size() == setting_value.size()) return interfaces::SettingsAction::SKIP_WRITE;\n+        setting_value = std::move(new_value);\n+        return interfaces::SettingsAction::WRITE;\n+    };\n+    return chain.updateRwSetting(\"wallet\", update_function);\n }\n \n static void UpdateWalletSetting(interfaces::Chain& chain,\n", "test_patch": "diff --git a/src/wallet/test/wallet_tests.cpp b/src/wallet/test/wallet_tests.cpp\nindex 44ffddb168701..12d5a3b3eba0f 100644\n--- a/src/wallet/test/wallet_tests.cpp\n+++ b/src/wallet/test/wallet_tests.cpp\n@@ -329,6 +329,40 @@ BOOST_FIXTURE_TEST_CASE(importwallet_rescan, TestChain100Setup)\n     }\n }\n \n+// This test verifies that wallet settings can be added and removed\n+// concurrently, ensuring no race conditions occur during either process.\n+BOOST_FIXTURE_TEST_CASE(write_wallet_settings_concurrently, TestingSetup)\n+{\n+    WalletContext context;\n+    context.chain = m_node.chain.get();\n+    const auto NUM_WALLETS{5};\n+\n+    // Since we're counting the number of wallets, ensure we start without any.\n+    BOOST_REQUIRE(context.chain->getRwSetting(\"wallet\").isNull());\n+\n+    const auto& check_concurrent_wallet = [&](const auto& settings_function, int num_expected_wallets) {\n+        std::vector<std::thread> threads;\n+        threads.reserve(NUM_WALLETS);\n+        for (auto i{0}; i < NUM_WALLETS; ++i) threads.emplace_back(settings_function, i);\n+        for (auto& t : threads) t.join();\n+\n+        auto wallets = context.chain->getRwSetting(\"wallet\");\n+        BOOST_CHECK_EQUAL(wallets.getValues().size(), num_expected_wallets);\n+    };\n+\n+    // Add NUM_WALLETS wallets concurrently, ensure we end up with NUM_WALLETS stored.\n+    check_concurrent_wallet([&context](int i) {\n+        Assert(AddWalletSetting(*context.chain, strprintf(\"wallet_%d\", i)));\n+    },\n+                            /*num_expected_wallets=*/NUM_WALLETS);\n+\n+    // Remove NUM_WALLETS wallets concurrently, ensure we end up with 0 wallets.\n+    check_concurrent_wallet([&context](int i) {\n+        Assert(RemoveWalletSetting(*context.chain, strprintf(\"wallet_%d\", i)));\n+    },\n+                            /*num_expected_wallets=*/0);\n+}\n+\n // Check that GetImmatureCredit() returns a newly calculated value instead of\n // the cached value after a MarkDirty() call.\n //\n", "problem_statement": "wallet: setting changes are subject to race conditions\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nCreating two wallets with `load_on_startup=true` simultaneously will result in only one of the wallets being added to the startup file.\n\n### Expected behaviour\n\nBoth wallets should be added.\n\n### Steps to reproduce\n\nI don't have an easy script to reproduce this, but the issue is quite visible in the code:\r\nhttps://github.com/bitcoin/bitcoin/blob/389cf32aca0be6c4b01151c92cc3be79c120f197/src/wallet/wallet.cpp#L94\r\n\r\nThe setting gets read from a backing JSON file, manipulated in memory, and then saved to the file, without any lock being taken out.\r\n\r\nIt's likely possible to demonstrate this with a quick BASH or python script that fires up bitcoind and creates two wallets simultaneously.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\n27.1\n\n### Operating system and version\n\nMacOS Sonoma 14.6.1\n\n### Machine specifications\n\n_No response_\n", "hints_text": "@wydengyre  \r\nThanks for reporting the issue.\r\n\r\n> It's likely possible to demonstrate this with a quick BASH or Python script that starts `bitcoind` and creates two wallets simultaneously.\r\n\r\nI tried to recreate this in the functional test by spawning threads and calling `createwallet` simultaneously with `load_on_startup=True`.\r\n\r\n<details>  \r\n<summary>See the diff</summary>\r\n\r\n```diff\r\ndiff --git a/test/functional/wallet_startup.py b/test/functional/wallet_startup.py\r\nindex 6feb00af8e1..2fed858c098 100755\r\n--- a/test/functional/wallet_startup.py\r\n+++ b/test/functional/wallet_startup.py\r\n@@ -6,6 +6,7 @@\r\n\r\n Verify that a bitcoind node can maintain a list of wallets loading on startup\r\n \"\"\"\r\n+from threading import Thread\r\n from test_framework.test_framework import BitcoinTestFramework\r\n from test_framework.util import (\r\n     assert_equal,\r\n@@ -56,6 +57,31 @@ class WalletStartupTest(BitcoinTestFramework):\r\n         self.nodes[0].loadwallet(filename='')\r\n         self.restart_node(0)\r\n         assert_equal(set(self.nodes[0].listwallets()), set(('w2', 'w3')))\r\n+        self.nodes[0].unloadwallet(wallet_name='w2', load_on_startup=False)\r\n+        self.nodes[0].unloadwallet(wallet_name='w3', load_on_startup=False)\r\n+        self.test_simultaneous_wallet()\r\n+\r\n+    def test_simultaneous_wallet(self):\r\n+        self.log.info(\"Testing simultaneous creation of wallets with load_on_startup=true\")\r\n+        create_wallet_func = lambda node, wallet_name: node.createwallet(wallet_name=wallet_name, load_on_startup=True)\r\n+        # Create threads for wallet creation\r\n+        threads = []\r\n+        wallet_names = []\r\n+        for i in range(1, 10):\r\n+            wallet_name = f\"wallet{i}\"\r\n+            wallet_names.append(wallet_name)\r\n+            t = Thread(target=create_wallet_func, args=(self.nodes[0].cli, wallet_name), name=f\"Thread{i}\")\r\n+            t.start()\r\n+            threads.append(t)\r\n+        for t in threads:\r\n+            t.join()\r\n+\r\n+        # Restart the node to check if the wallets load on startup\r\n+        self.restart_node(0)\r\n+        # Ensure all wallets have the option\r\n+        for wallet in wallet_names:\r\n+            wallet in self.nodes[0].listwallets()\r\n+\r\n\r\n if __name__ == '__main__':\r\n     WalletStartupTest(__file__).main()\r\n\r\n```\r\n</details>\r\nAfter running the script the race condition you described was not happening.\r\n\r\n---\r\n`AddWalletSetting` is reading the current settings adding the new setting and then updating the settings by invoking `updateRwSetting` with the new settings.\r\nIIUC `updateRwSettings` lock a mutex  which will disallow the race condition you are describing\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/2f7d9aec4d049701fccfc029f44934d187467432/src/node/interfaces.cpp#L154-L164\r\n\r\nAm I missing something here?\r\ncc @furszy \n@ismaelsadeeq, the race is one level above.\r\n`AddWalletSetting` obtains a copy of the 'wallet' settings json array, modifies it without any lock, and then calls `updateRwSetting`, which entirely replaces the existing value. If two threads access `AddWalletSetting` simultaneously, they both obtain the same 'wallet' settings array, append their new wallet, and store it. Only the data from the thread that executes the write operation last survives.\r\nThe same issue occurs on `RemoveWalletSetting`. The guard should likely be implemented at a higher level, such as in `UpdateWalletSetting`.\r\n\r\nThe race can be replicated running the following unit test:\r\n```\r\nBOOST_FIXTURE_TEST_CASE(write_wallet_settings_concurretly, TestingSetup)\r\n{\r\n    interfaces::Chain& chain = *m_node.chain;\r\n    std::vector<std::thread> threads;\r\n    const int NUM_WALLETS = 5;\r\n    for (int i=0; i<NUM_WALLETS; i++) {\r\n        threads.emplace_back([&] {\r\n            BOOST_CHECK_MESSAGE(AddWalletSetting(chain, strprintf(\"wallet_%d\", i)), strprintf(\"write wallet_%d failed\", i));\r\n        });\r\n    }\r\n    for (auto& t : threads) t.join();\r\n\r\n    auto wallets = chain.getRwSetting(\"wallet\");\r\n    BOOST_CHECK_EQUAL(wallets.getValues().size(), NUM_WALLETS);\r\n}\r\n```\n\r\nYes, I encountered the race condition after running the test with the diff you provided.\r\n\r\nI believe I fixed the race condition by locking the wallet context mutex in both `AddWalletSetting` and `RemoveWalletSetting`.\r\nHowever, the test will still fail because the loop variable `i` is captured by reference. This means that all threads share the same reference to `i`, leading to situations where multiple threads might update the same wallet name. As a result, the size of the settings can become non-deterministic.\r\n\r\n\r\nI updated the test to instead capture by value.\r\n\r\n```diff\r\ndiff --git a/src/wallet/test/wallet_tests.cpp b/src/wallet/test/wallet_tests.cpp\r\nindex 44ffddb1687..8cdf2276ff5 100644\r\n--- a/src/wallet/test/wallet_tests.cpp\r\n+++ b/src/wallet/test/wallet_tests.cpp\r\n@@ -329,6 +329,23 @@ BOOST_FIXTURE_TEST_CASE(importwallet_rescan, TestChain100Setup)\r\n     }\r\n }\r\n \r\n+BOOST_FIXTURE_TEST_CASE(write_wallet_settings_concurretly, TestingSetup)\r\n+{\r\n+    WalletContext context;\r\n+    context.chain = m_node.chain.get();\r\n+    std::vector<std::thread> threads;\r\n+    const int NUM_WALLETS = 5;\r\n+    for (int i=0; i<NUM_WALLETS; i++) {\r\n+        threads.emplace_back([i, &context] {\r\n+            BOOST_CHECK_MESSAGE(AddWalletSetting(context, strprintf(\"wallet_%d\", i)), strprintf(\"write wallet_%d failed\", i));\r\n+        });\r\n+    }\r\n+    for (auto& t : threads) t.join();\r\n+\r\n+    auto wallets = context.chain->getRwSetting(\"wallet\");\r\n+    BOOST_CHECK_EQUAL(wallets.getValues().size(), NUM_WALLETS);\r\n+}\r\n+\r\n // Check that GetImmatureCredit() returns a newly calculated value instead of\r\n // the cached value after a MarkDirty() call.\r\n //\r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex 5584b43520a..b6e714decb0 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -91,38 +91,40 @@ using util::ToString;\r\n \r\n namespace wallet {\r\n \r\n-bool AddWalletSetting(interfaces::Chain& chain, const std::string& wallet_name)\r\n+bool AddWalletSetting(WalletContext& context, const std::string& wallet_name)\r\n {\r\n-    common::SettingsValue setting_value = chain.getRwSetting(\"wallet\");\r\n+    LOCK(context.wallets_mutex);\r\n+    common::SettingsValue setting_value = context.chain->getRwSetting(\"wallet\");\r\n     if (!setting_value.isArray()) setting_value.setArray();\r\n     for (const common::SettingsValue& value : setting_value.getValues()) {\r\n         if (value.isStr() && value.get_str() == wallet_name) return true;\r\n     }\r\n     setting_value.push_back(wallet_name);\r\n-    return chain.updateRwSetting(\"wallet\", setting_value);\r\n+    return context.chain->updateRwSetting(\"wallet\", setting_value);\r\n }\r\n \r\n-bool RemoveWalletSetting(interfaces::Chain& chain, const std::string& wallet_name)\r\n+bool RemoveWalletSetting(WalletContext& context, const std::string& wallet_name)\r\n {\r\n-    common::SettingsValue setting_value = chain.getRwSetting(\"wallet\");\r\n+    LOCK(context.wallets_mutex);\r\n+    common::SettingsValue setting_value = context.chain->getRwSetting(\"wallet\");\r\n     if (!setting_value.isArray()) return true;\r\n     common::SettingsValue new_value(common::SettingsValue::VARR);\r\n     for (const common::SettingsValue& value : setting_value.getValues()) {\r\n         if (!value.isStr() || value.get_str() != wallet_name) new_value.push_back(value);\r\n     }\r\n     if (new_value.size() == setting_value.size()) return true;\r\n-    return chain.updateRwSetting(\"wallet\", new_value);\r\n+    return context.chain->updateRwSetting(\"wallet\", new_value);\r\n }\r\n \r\n-static void UpdateWalletSetting(interfaces::Chain& chain,\r\n+static void UpdateWalletSetting(WalletContext& context,\r\n                                 const std::string& wallet_name,\r\n                                 std::optional<bool> load_on_startup,\r\n                                 std::vector<bilingual_str>& warnings)\r\n {\r\n     if (!load_on_startup) return;\r\n-    if (load_on_startup.value() && !AddWalletSetting(chain, wallet_name)) {\r\n+    if (load_on_startup.value() && !AddWalletSetting(context, wallet_name)) {\r\n         warnings.emplace_back(Untranslated(\"Wallet load on startup setting could not be updated, so wallet may not be loaded next node startup.\"));\r\n-    } else if (!load_on_startup.value() && !RemoveWalletSetting(chain, wallet_name)) {\r\n+    } else if (!load_on_startup.value() && !RemoveWalletSetting(context, wallet_name)) {\r\n         warnings.emplace_back(Untranslated(\"Wallet load on startup setting could not be updated, so wallet may still be loaded next node startup.\"));\r\n     }\r\n }\r\n@@ -157,7 +159,6 @@ bool RemoveWallet(WalletContext& context, const std::shared_ptr<CWallet>& wallet\r\n {\r\n     assert(wallet);\r\n \r\n-    interfaces::Chain& chain = wallet->chain();\r\n     std::string name = wallet->GetName();\r\n \r\n     // Unregister with the validation interface which also drops shared pointers.\r\n@@ -172,7 +173,7 @@ bool RemoveWallet(WalletContext& context, const std::shared_ptr<CWallet>& wallet\r\n     wallet->NotifyUnload();\r\n \r\n     // Write the wallet setting\r\n-    UpdateWalletSetting(chain, name, load_on_start, warnings);\r\n+    UpdateWalletSetting(context, name, load_on_start, warnings);\r\n \r\n     return true;\r\n }\r\n@@ -293,7 +294,7 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\r\n         wallet->postInitProcess();\r\n \r\n         // Write the wallet setting\r\n-        UpdateWalletSetting(*context.chain, name, load_on_start, warnings);\r\n+        UpdateWalletSetting(context, name, load_on_start, warnings);\r\n \r\n         return wallet;\r\n     } catch (const std::runtime_error& e) {\r\n@@ -474,7 +475,7 @@ std::shared_ptr<CWallet> CreateWallet(WalletContext& context, const std::string&\r\n     wallet->postInitProcess();\r\n \r\n     // Write the wallet settings\r\n-    UpdateWalletSetting(*context.chain, name, load_on_start, warnings);\r\n+    UpdateWalletSetting(context, name, load_on_start, warnings);\r\n \r\n     // Legacy wallets are being deprecated, warn if a newly created wallet is legacy\r\n     if (!(wallet_creation_flags & WALLET_FLAG_DESCRIPTORS)) {\r\n@@ -4324,7 +4325,7 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\r\n             }\r\n \r\n             // Add the wallet to settings\r\n-            UpdateWalletSetting(*context.chain, wallet_name, /*load_on_startup=*/true, warnings);\r\n+            UpdateWalletSetting(context, wallet_name, /*load_on_startup=*/true, warnings);\r\n         }\r\n         if (data->solvable_descs.size() > 0) {\r\n             wallet.WalletLogPrintf(\"Making a new watchonly wallet containing the unwatched solvable scripts\\n\");\r\n@@ -4361,7 +4362,7 @@ bool DoMigration(CWallet& wallet, WalletContext& context, bilingual_str& error,\r\n             }\r\n \r\n             // Add the wallet to settings\r\n-            UpdateWalletSetting(*context.chain, wallet_name, /*load_on_startup=*/true, warnings);\r\n+            UpdateWalletSetting(context, wallet_name, /*load_on_startup=*/true, warnings);\r\n         }\r\n     }\r\n \r\ndiff --git a/src/wallet/wallet.h b/src/wallet/wallet.h\r\nindex 3ea1cf48b22..ad2e2817c46 100644\r\n--- a/src/wallet/wallet.h\r\n+++ b/src/wallet/wallet.h\r\n@@ -1112,10 +1112,10 @@ public:\r\n };\r\n \r\n //! Add wallet name to persistent configuration so it will be loaded on startup.\r\n-bool AddWalletSetting(interfaces::Chain& chain, const std::string& wallet_name);\r\n+bool AddWalletSetting(WalletContext& context, const std::string& wallet_name);\r\n \r\n //! Remove wallet name from persistent configuration so it will not be loaded on startup.\r\n-bool RemoveWalletSetting(interfaces::Chain& chain, const std::string& wallet_name);\r\n+bool RemoveWalletSetting(WalletContext& context, const std::string& wallet_name);\r\n \r\n struct MigrationResult {\r\n     std::string wallet_name;\r\n```\r\n\r\nI believe this is the right fix and that locking the wallet mutex there is safe. If this does not introduce any issues, I will create a PR and include @furszy as a co-author since he provided the test.", "created_at": "2024-08-22 14:56:11", "merge_commit_sha": "78567b052d7f541fc1d24a2199d980dedb3305f4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30666", "base_commit": "6fc4692797121b54de0c54e5b09ee47f322c038a", "patch": "diff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex 7ffd03e71af5a..4a7af39b15144 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -1648,6 +1648,7 @@ void ReconsiderBlock(ChainstateManager& chainman, uint256 block_hash) {\n         }\n \n         chainman.ActiveChainstate().ResetBlockFailureFlags(pblockindex);\n+        chainman.RecalculateBestHeader();\n     }\n \n     BlockValidationState state;\ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex 8e4ea8eda2f62..dcaa8dba26602 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2045,8 +2045,9 @@ void Chainstate::InvalidChainFound(CBlockIndex* pindexNew)\n     if (!m_chainman.m_best_invalid || pindexNew->nChainWork > m_chainman.m_best_invalid->nChainWork) {\n         m_chainman.m_best_invalid = pindexNew;\n     }\n+    SetBlockFailureFlags(pindexNew);\n     if (m_chainman.m_best_header != nullptr && m_chainman.m_best_header->GetAncestor(pindexNew->nHeight) == pindexNew) {\n-        m_chainman.m_best_header = m_chain.Tip();\n+        m_chainman.RecalculateBestHeader();\n     }\n \n     LogPrintf(\"%s: invalid block=%s  height=%d  log2_work=%f  date=%s\\n\", __func__,\n@@ -3785,6 +3786,17 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n     return true;\n }\n \n+void Chainstate::SetBlockFailureFlags(CBlockIndex* invalid_block)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    for (auto& [_, block_index] : m_blockman.m_block_index) {\n+        if (block_index.GetAncestor(invalid_block->nHeight) == invalid_block && !(block_index.nStatus & BLOCK_FAILED_MASK)) {\n+            block_index.nStatus |= BLOCK_FAILED_CHILD;\n+        }\n+    }\n+}\n+\n void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     AssertLockHeld(cs_main);\n \n@@ -6396,6 +6408,17 @@ std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n \n+void ChainstateManager::RecalculateBestHeader()\n+{\n+    AssertLockHeld(cs_main);\n+    m_best_header = ActiveChain().Tip();\n+    for (auto& entry : m_blockman.m_block_index) {\n+        if (!(entry.second.nStatus & BLOCK_FAILED_MASK) && m_best_header->nChainWork < entry.second.nChainWork) {\n+            m_best_header = &entry.second;\n+        }\n+    }\n+}\n+\n bool ChainstateManager::ValidatedSnapshotCleanup()\n {\n     AssertLockHeld(::cs_main);\ndiff --git a/src/validation.h b/src/validation.h\nindex 059ae52bdf4ca..29ff6bd94cd4e 100644\n--- a/src/validation.h\n+++ b/src/validation.h\n@@ -735,6 +735,9 @@ class Chainstate\n         EXCLUSIVE_LOCKS_REQUIRED(!m_chainstate_mutex)\n         LOCKS_EXCLUDED(::cs_main);\n \n+    /** Set invalidity status to all descendants of a block */\n+    void SetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     /** Remove invalidity status from a block and its descendants. */\n     void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n@@ -1321,6 +1324,11 @@ class ChainstateManager\n     //! nullopt.\n     std::optional<int> GetSnapshotBaseHeight() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! If, due to invalidation / reconsideration of blocks, the previous\n+    //! best header is no longer valid / guaranteed to be the most-work\n+    //! header in our block-index not known to be invalid, recalculate it.\n+    void RecalculateBestHeader() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     CCheckQueue<CScriptCheck>& GetCheckQueue() { return m_script_check_queue; }\n \n     ~ChainstateManager();\n", "test_patch": "diff --git a/test/functional/rpc_getchaintips.py b/test/functional/rpc_getchaintips.py\nindex 1bd4413ce1ec2..226e995307cef 100755\n--- a/test/functional/rpc_getchaintips.py\n+++ b/test/functional/rpc_getchaintips.py\n@@ -10,6 +10,10 @@\n - verify that getchaintips now returns two chain tips.\n \"\"\"\n \n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n \n@@ -18,44 +22,73 @@ def set_test_params(self):\n         self.num_nodes = 4\n \n     def run_test(self):\n+        self.log.info(\"Test getchaintips behavior with two chains of different length\")\n         tips = self.nodes[0].getchaintips()\n         assert_equal(len(tips), 1)\n         assert_equal(tips[0]['branchlen'], 0)\n         assert_equal(tips[0]['height'], 200)\n         assert_equal(tips[0]['status'], 'active')\n \n-        # Split the network and build two chains of different lengths.\n+        self.log.info(\"Split the network and build two chains of different lengths.\")\n         self.split_network()\n         self.generate(self.nodes[0], 10, sync_fun=lambda: self.sync_all(self.nodes[:2]))\n         self.generate(self.nodes[2], 20, sync_fun=lambda: self.sync_all(self.nodes[2:]))\n \n-        tips = self.nodes[1].getchaintips ()\n-        assert_equal (len (tips), 1)\n+        tips = self.nodes[1].getchaintips()\n+        assert_equal(len(tips), 1)\n         shortTip = tips[0]\n-        assert_equal (shortTip['branchlen'], 0)\n-        assert_equal (shortTip['height'], 210)\n-        assert_equal (tips[0]['status'], 'active')\n+        assert_equal(shortTip['branchlen'], 0)\n+        assert_equal(shortTip['height'], 210)\n+        assert_equal(tips[0]['status'], 'active')\n \n-        tips = self.nodes[3].getchaintips ()\n-        assert_equal (len (tips), 1)\n+        tips = self.nodes[3].getchaintips()\n+        assert_equal(len(tips), 1)\n         longTip = tips[0]\n-        assert_equal (longTip['branchlen'], 0)\n-        assert_equal (longTip['height'], 220)\n-        assert_equal (tips[0]['status'], 'active')\n+        assert_equal(longTip['branchlen'], 0)\n+        assert_equal(longTip['height'], 220)\n+        assert_equal(tips[0]['status'], 'active')\n \n-        # Join the network halves and check that we now have two tips\n+        self.log.info(\"Join the network halves and check that we now have two tips\")\n         # (at least at the nodes that previously had the short chain).\n-        self.join_network ()\n+        self.join_network()\n \n-        tips = self.nodes[0].getchaintips ()\n-        assert_equal (len (tips), 2)\n-        assert_equal (tips[0], longTip)\n+        tips = self.nodes[0].getchaintips()\n+        assert_equal(len(tips), 2)\n+        assert_equal(tips[0], longTip)\n \n-        assert_equal (tips[1]['branchlen'], 10)\n-        assert_equal (tips[1]['status'], 'valid-fork')\n+        assert_equal(tips[1]['branchlen'], 10)\n+        assert_equal(tips[1]['status'], 'valid-fork')\n         tips[1]['branchlen'] = 0\n         tips[1]['status'] = 'active'\n-        assert_equal (tips[1], shortTip)\n+        assert_equal(tips[1], shortTip)\n+\n+        self.log.info(\"Test getchaintips behavior with invalid blocks\")\n+        self.disconnect_nodes(0, 1)\n+        n0 = self.nodes[0]\n+        tip = int(n0.getbestblockhash(), 16)\n+        start_height = self.nodes[0].getblockcount()\n+        # Create invalid block (too high coinbase)\n+        block_time = n0.getblock(n0.getbestblockhash())['time'] + 1\n+        invalid_block = create_block(tip, create_coinbase(start_height+1, nValue=100), block_time)\n+        invalid_block.solve()\n+\n+        block_time += 1\n+        block2 = create_block(invalid_block.sha256, create_coinbase(2), block_time, version=4)\n+        block2.solve()\n+\n+        self.log.info(\"Submit headers-only chain\")\n+        n0.submitheader(invalid_block.serialize().hex())\n+        n0.submitheader(block2.serialize().hex())\n+        tips = n0.getchaintips()\n+        assert_equal(len(tips), 3)\n+        assert_equal(tips[0]['status'], 'headers-only')\n+\n+        self.log.info(\"Submit invalid block that invalidates the headers-only chain\")\n+        n0.submitblock(invalid_block.serialize().hex())\n+        tips = n0.getchaintips()\n+        assert_equal(len(tips), 3)\n+        assert_equal(tips[0]['status'], 'invalid')\n+\n \n if __name__ == '__main__':\n     GetChainTipsTest(__file__).main()\ndiff --git a/test/functional/rpc_invalidateblock.py b/test/functional/rpc_invalidateblock.py\nindex db79d55259007..e2eb033f09c75 100755\n--- a/test/functional/rpc_invalidateblock.py\n+++ b/test/functional/rpc_invalidateblock.py\n@@ -6,6 +6,10 @@\n \n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.address import ADDRESS_BCRT1_UNSPENDABLE_DESCRIPTOR\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n from test_framework.util import (\n     assert_equal,\n     assert_raises_rpc_error,\n@@ -35,12 +39,33 @@ def run_test(self):\n         self.connect_nodes(0, 1)\n         self.sync_blocks(self.nodes[0:2])\n         assert_equal(self.nodes[0].getblockcount(), 6)\n-        badhash = self.nodes[1].getblockhash(2)\n+\n+        # Add a header to the tip of node 0 without submitting the block. This shouldn't\n+        # affect results since this chain will be invalidated next.\n+        tip = self.nodes[0].getbestblockhash()\n+        block_time = self.nodes[0].getblock(self.nodes[0].getbestblockhash())['time'] + 1\n+        block = create_block(int(tip, 16), create_coinbase(self.nodes[0].getblockcount()), block_time, version=4)\n+        block.solve()\n+        self.nodes[0].submitheader(block.serialize().hex())\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"] + 1)\n \n         self.log.info(\"Invalidate block 2 on node 0 and verify we reorg to node 0's original chain\")\n+        badhash = self.nodes[1].getblockhash(2)\n+        self.nodes[0].invalidateblock(badhash)\n+        assert_equal(self.nodes[0].getblockcount(), 4)\n+        assert_equal(self.nodes[0].getbestblockhash(), besthash_n0)\n+        # Should report consistent blockchain info\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"])\n+\n+        self.log.info(\"Reconsider block 6 on node 0 again and verify that the best header is set correctly\")\n+        self.nodes[0].reconsiderblock(tip)\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"] + 1)\n+\n+        self.log.info(\"Invalidate block 2 on node 0 and verify we reorg to node 0's original chain again\")\n         self.nodes[0].invalidateblock(badhash)\n         assert_equal(self.nodes[0].getblockcount(), 4)\n         assert_equal(self.nodes[0].getbestblockhash(), besthash_n0)\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"])\n \n         self.log.info(\"Make sure we won't reorg to a lower work chain:\")\n         self.connect_nodes(1, 2)\n@@ -83,6 +108,8 @@ def run_test(self):\n         self.nodes[1].reconsiderblock(blocks[-4])\n         # Should be back at the tip by now\n         assert_equal(self.nodes[1].getbestblockhash(), blocks[-1])\n+        # Should report consistent blockchain info\n+        assert_equal(self.nodes[1].getblockchaininfo()[\"headers\"], self.nodes[1].getblockchaininfo()[\"blocks\"])\n \n         self.log.info(\"Verify that invalidating an unknown block throws an error\")\n         assert_raises_rpc_error(-5, \"Block not found\", self.nodes[1].invalidateblock, \"00\" * 32)\n", "problem_statement": "Header inconsistency after invalidate/reconsider block\nDemonstration using regtest.\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 0,\r\n  \"headers\": 0,\r\n```\r\n\r\nMine a block\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 1,\r\n  \"headers\": 1,\r\n```\r\nCall invalidateblock\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 0,\r\n  \"headers\": 0,\r\n# getchaintips\r\n    \"height\": 1,\r\n    \"hash\": \"06702ef73c7d8629294f8b6386646f888d60979932ba2ee45e3495d8f25006b5\",\r\n    \"branchlen\": 1,\r\n    \"status\": \"invalid\"\r\n  },\r\n  {\r\n    \"height\": 0,\r\n    \"hash\": \"0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206\",\r\n    \"branchlen\": 0,\r\n    \"status\": \"active\"\r\n```\r\nCall reconsiderblock\r\n```bash\r\n# getchaintips\r\n    \"height\": 1,\r\n    \"hash\": \"06702ef73c7d8629294f8b6386646f888d60979932ba2ee45e3495d8f25006b5\",\r\n    \"branchlen\": 0,\r\n    \"status\": \"active\"\r\n```\r\n\r\nHeader count returned by getblockchaininfo is now < # of blocks.\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 1,\r\n  \"headers\": 0,\r\n```\n", "hints_text": "Is this a regression?\n> Is this a regression?\r\n\r\nCan recreate the same behaviour with builds of 23.x and 22.x.", "created_at": "2024-08-16 17:36:29", "merge_commit_sha": "85bcfeea23568053ea09013fb8263fa1511d7123", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30588", "base_commit": "1afa3c84fcdcad3b54ec13f29d7957ec1c2b01d0", "patch": "diff --git a/depends/packages/zeromq.mk b/depends/packages/zeromq.mk\nindex 7620df5477727..df018a1032247 100644\n--- a/depends/packages/zeromq.mk\n+++ b/depends/packages/zeromq.mk\n@@ -10,6 +10,7 @@ $(package)_patches += builtin_sha1.patch\n $(package)_patches += fix_have_windows.patch\n $(package)_patches += openbsd_kqueue_headers.patch\n $(package)_patches += cmake_minimum.patch\n+$(package)_patches += cacheline_undefined.patch\n $(package)_patches += no_librt.patch\n \n define $(package)_set_vars\n@@ -25,6 +26,7 @@ define $(package)_preprocess_cmds\n   patch -p1 < $($(package)_patch_dir)/remove_libstd_link.patch && \\\n   patch -p1 < $($(package)_patch_dir)/macos_mktemp_check.patch && \\\n   patch -p1 < $($(package)_patch_dir)/builtin_sha1.patch && \\\n+  patch -p1 < $($(package)_patch_dir)/cacheline_undefined.patch && \\\n   patch -p1 < $($(package)_patch_dir)/fix_have_windows.patch && \\\n   patch -p1 < $($(package)_patch_dir)/openbsd_kqueue_headers.patch && \\\n   patch -p1 < $($(package)_patch_dir)/cmake_minimum.patch && \\\ndiff --git a/depends/patches/zeromq/cacheline_undefined.patch b/depends/patches/zeromq/cacheline_undefined.patch\nnew file mode 100644\nindex 0000000000000..02bd2a5fe5d5a\n--- /dev/null\n+++ b/depends/patches/zeromq/cacheline_undefined.patch\n@@ -0,0 +1,15 @@\n+Use proper STREQUAL instead of EQUAL to compare strings.txt\n+\n+See: https://github.com/zeromq/libzmq/pull/4711.\n+\n+--- a/CMakeLists.txt\n++++ b/CMakeLists.txt\n+@@ -476,7 +476,7 @@ execute_process(\n+ if(CACHELINE_SIZE STREQUAL \"\"\n+    OR CACHELINE_SIZE EQUAL 0\n+    OR CACHELINE_SIZE EQUAL -1\n+-   OR CACHELINE_SIZE EQUAL \"undefined\")\n++   OR CACHELINE_SIZE STREQUAL \"undefined\")\n+   set(ZMQ_CACHELINE_SIZE 64)\n+ else()\n+   set(ZMQ_CACHELINE_SIZE ${CACHELINE_SIZE})\n", "test_patch": "", "problem_statement": "build: Native ./depends build fails on s390x\nSteps to reproduce on a fresh s390x machine:\r\n\r\n```\r\nmake NO_QT=1 NO_WALLET=1 NO_UPNP=1 NO_NATPMP=1 -j $(nproc)\r\n```\r\n\r\n(Cross-compilation to s390x works)\r\n\r\n\r\nOutput:\r\n\r\n```\r\nBuilding zeromq...\r\nmake[1]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[2]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\n[  1%] Building CXX object CMakeFiles/objects.dir/src/address.cpp.o\r\nIn file included from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/precompiled.hpp:16,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/address.cpp:3:\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/platform.hpp:22:28: error: 'undefined' was not declared in this scope\r\n   22 | #define ZMQ_CACHELINE_SIZE undefined\r\n      |                            ^~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/command.hpp:191:26: note: in expansion of macro 'ZMQ_CACHELINE_SIZE'\r\n  191 | __attribute__ ((aligned (ZMQ_CACHELINE_SIZE)))\r\n      |                          ^~~~~~~~~~~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/platform.hpp:22:28: error: 'undefined' was not declared in this scope\r\n   22 | #define ZMQ_CACHELINE_SIZE undefined\r\n      |                            ^~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/yqueue.hpp:34:45: note: in expansion of macro 'ZMQ_CACHELINE_SIZE'\r\n   34 | template <typename T, int N, size_t ALIGN = ZMQ_CACHELINE_SIZE> class yqueue_t\r\n      |                                             ^~~~~~~~~~~~~~~~~~\r\nIn file included from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/mailbox.hpp:12,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ctx.hpp:11,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/address.cpp:6:\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:155:18: error: template argument 3 is invalid\r\n  155 |     yqueue_t<T, N> _queue;\r\n      |                  ^\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In constructor 'zmq::ypipe_t<T, N>::ypipe_t()':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:26:16: error: request for member 'push' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   26 |         _queue.push ();\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:30:32: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   30 |         _r = _w = _f = &_queue.back ();\r\n      |                                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:31:25: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   31 |         _c.set (&_queue.back ());\r\n      |                         ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'void zmq::ypipe_t<T, N>::write(const T&, bool)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:50:16: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   50 |         _queue.back () = value_;\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:51:16: error: request for member 'push' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   51 |         _queue.push ();\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:55:26: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   55 |             _f = &_queue.back ();\r\n      |                          ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::unwrite(T*)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:66:27: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   66 |         if (_f == &_queue.back ())\r\n      |                           ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:68:16: error: request for member 'unpush' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   68 |         _queue.unpush ();\r\n      |                ^~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:69:26: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   69 |         *value_ = _queue.back ();\r\n      |                          ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::check_read()':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:104:21: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  104 |         if (&_queue.front () != _r && _r)\r\n      |                     ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:111:30: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  111 |         _r = _c.cas (&_queue.front (), NULL);\r\n      |                              ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:117:21: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  117 |         if (&_queue.front () == _r || !_r)\r\n      |                     ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::read(T*)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:134:26: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  134 |         *value_ = _queue.front ();\r\n      |                          ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:135:16: error: request for member 'pop' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  135 |         _queue.pop ();\r\n      |                ^~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::probe(bool (*)(const T&))':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:147:31: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  147 |         return (*fn_) (_queue.front ());\r\n      |                               ^~~~~\r\nAt global scope:\r\ncc1plus: note: unrecognized command-line option '-Wno-tautological-constant-compare' may have been intended to silence earlier diagnostics\r\nmake[3]: *** [CMakeFiles/objects.dir/build.make:90: CMakeFiles/objects.dir/src/address.cpp.o] Error 1\r\nmake[3]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[2]: *** [CMakeFiles/Makefile2:88: CMakeFiles/objects.dir/all] Error 2\r\nmake[2]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[1]: *** [Makefile:136: all] Error 2\r\nmake[1]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake: *** [funcs.mk:301: /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/.stamp_built] Error 2\r\n```\r\n\r\n\n", "hints_text": "", "created_at": "2024-08-05 12:47:37", "merge_commit_sha": "43740f4971f45cd5499470b6a085b3ecd8b96d28", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30435", "base_commit": "4d6af61d879914a660e73db5c2f2e6c4d0aa8243", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e4b65fbfa94f6..03969b00bb661 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -296,10 +296,11 @@ void Shutdown(NodeContext& node)\n \n     StopTorControl();\n \n+    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n     // After everything has been shut down, but before things get flushed, stop the\n-    // scheduler and load block thread.\n+    // the scheduler. After this point, SyncWithValidationInterfaceQueue() should not be called anymore\n+    // as this would prevent the shutdown from completing.\n     if (node.scheduler) node.scheduler->stop();\n-    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n \n     // After the threads that potentially access these pointers have been stopped,\n     // destruct and reset all to nullptr.\n", "test_patch": "", "problem_statement": "Shutdown during reindex-chainstate can block forever\nDuring `Shutdown`, we stop the scheduler before waiting on the load-block thread. But the load-block thread can call `LimitValidationInterfaceQueue` via `ActivateBestChain`. `LimitValidationInterfaceQueue` then schedules a dummy call and waits for it. But since the scheduler has stopped, it never gets there, and blocks forever. Shutdown remains joined to the thread, and also never exits.\r\n\r\nCan we just wait for the load-block thread before killing the scheduler?\n", "hints_text": "I've observed such behavior but did not notice the reasons.\r\n\r\nThanks @luke-jr!\nI had what I think was a similar issue (scriptcheck thread hanging, waiting on `SyncWithValidationInterfaceQueue` to complete). I found the changing `SyncWithValidationInterfaceQueue` to be:\r\n\r\n```c++\r\nvoid SyncWithValidationInterfaceQueue()\r\n{\r\n    AssertLockNotHeld(cs_main);\r\n    // Block until the validation queue drains\r\n    auto promise = std::make_shared<std::promise<void>>();\r\n    CallFunctionInValidationInterfaceQueue([promise] {\r\n        promise->set_value();\r\n    });\r\n    std::future_status status;\r\n    do {\r\n        status = promise->get_future().wait_for(10s);\r\n    } while (status != std::future_status::ready); // && !ShutdownRequested());\r\n}\r\n```\r\n\r\nfixed my problem. In particular, `Shutdown()` calls `scheduler->stop()` before `StopScriptCheckWorkerThreads()` which gives a deadlock: scheduler is stopped, but worker threads can't complete because they're waiting for the scheduler to finish off the promise. Just having the scriptcheck threads exit early isn't enough, because after the scriptcheck threads have finished `FlushBackgroundCallbacks()` is called which does the `promise->set_value()` above, so `promise` still needs to exist, hence making it a `shared_ptr`.\nI also experienced this issue - my bitcoind hanged and when I dumped the running threads, it was waiting on `LimitValidationInterfaceQueue` but the scheduler thread had already exited. I did not have `reindex-chainstate` enabled. I think this can happen in any situation where the callbacks aren't cleared quickly enough and `SyncWithValidationInterfaceQueue` is called.", "created_at": "2024-07-12 05:21:12", "merge_commit_sha": "1d24d383b45ec54b65da2c9ea86554f45a8f1b06", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30404", "base_commit": "bd5d1688b4311e21c0e0ff89a3ae02ef7d0543b8", "patch": "diff --git a/src/node/warnings.cpp b/src/node/warnings.cpp\nindex b99c845900abf..87389e472b934 100644\n--- a/src/node/warnings.cpp\n+++ b/src/node/warnings.cpp\n@@ -28,8 +28,7 @@ Warnings::Warnings()\n }\n bool Warnings::Set(warning_type id, bilingual_str message)\n {\n-    LOCK(m_mutex);\n-    const auto& [_, inserted]{m_warnings.insert({id, std::move(message)})};\n+    const auto& [_, inserted]{WITH_LOCK(m_mutex, return m_warnings.insert({id, std::move(message)}))};\n     if (inserted) uiInterface.NotifyAlertChanged();\n     return inserted;\n }\n", "test_patch": "", "problem_statement": "Double lock detected in `Warnings::GetMessages()`\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nRunning `bitcoin-qt -testnet` results in it eventually deadlocking due to a double lock in the warnings code.\n\n### Expected behaviour\n\nShould not double lock.\n\n### Steps to reproduce\n\n1. Build with `--enable-debug` (or define `DEBUG_LOCKORDER`\r\n2. Run `bitcoin-qt -testnet`, and either sync or reindex\r\n3. It will assert and crash on its own (without `DEBUG_LOCKORDER`, it will eventually hang)\n\n### Relevant log output\n\n\r\n```\r\n2024-07-05T23:22:12.212000Z [scheduler] [../../../src/qt/bitcoin.cpp:215] [DebugMessageHandler] [qt] GUI: ClientModel: NotifyAlertChanged\r\n2024-07-05T23:22:12.212029Z [scheduler] [../../../src/sync.cpp:129] [double_lock_detected] DOUBLE LOCK DETECTED\r\n2024-07-05T23:22:12.212052Z [scheduler] [../../../src/sync.cpp:130] [double_lock_detected] Lock order:\r\n2024-07-05T23:22:12.212072Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:31 (in thread 'scheduler')\r\n2024-07-05T23:22:12.212092Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler')\r\nAssertion failed: detected double lock for 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler'), details in debug log.\r\n```\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nbd5d1688b4311e21c0e0ff89a3ae02ef7d0543b8\n\n### Operating system and version\n\nArch\n\n### Machine specifications\n\n_No response_\n", "hints_text": "cc @stickies-v as you were the last to touch the warnings code.", "created_at": "2024-07-06 22:15:15", "merge_commit_sha": "a83f050dbe1392fc6b1b6c2a140c7346653b40d3", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30248", "base_commit": "feab35189bc00bc4cf15e9dcb5cf6b34ff3a1e91", "patch": "diff --git a/src/wallet/migrate.cpp b/src/wallet/migrate.cpp\nindex 09254a76ad89a..d7d8577374346 100644\n--- a/src/wallet/migrate.cpp\n+++ b/src/wallet/migrate.cpp\n@@ -551,7 +551,7 @@ void BerkeleyRODatabase::Open()\n     // }\n \n     // Check the last page number\n-    uint32_t expected_last_page = (size / page_size) - 1;\n+    uint32_t expected_last_page{uint32_t((size / page_size) - 1)};\n     if (outer_meta.last_page != expected_last_page) {\n         throw std::runtime_error(\"Last page number could not fit in file\");\n     }\n", "test_patch": "", "problem_statement": "fuzz: wallet_bdb_parser: implicit-signed-integer-truncation wallet/migrate.cpp:554:35 \nFull error:\r\n\r\n```\r\nwallet/migrate.cpp:554:35: runtime error: implicit conversion from type 'int64_t' (aka 'long') of value -1 (64-bit, signed) to type 'uint32_t' (aka 'unsigned int') changed the value to 4294967295 (32-bit, unsigned)\r\n```\r\n\r\nThe code:\r\n\r\n```cpp\r\nuint32_t expected_last_page = (size / page_size) - 1;\r\n```\r\n\r\nThis may lead to a fuzz runtime error when `(size / page_size)` is `0`. I don't think this can lead to issues for real users, because it can only happen with corrupt files and the next line should throw `\"Last page number could not fit in file\"`, or in the case where `outer_meta.last_page` is corrupt as well, and equal to `4294967295`, the following read should fail and throw.\n", "hints_text": "Found by @murchandamus in https://github.com/bitcoin-core/qa-assets/pull/186#issuecomment-2154348655\r\n\r\n```\r\nRun wallet_bdb_parser with args ['/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz', '-runs=1', PosixPath('/ci_container_base/ci/scratch/qa-assets/fuzz_seed_corpus/wallet_bdb_parser')]INFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 1090373666\r\nINFO: Loaded 1 modules   (584206 inline 8-bit counters): 584206 [0x55fc8b5c2ec8, 0x55fc8b6518d6), \r\nINFO: Loaded 1 PC tables (584206 PCs): 584206 [0x55fc8b6518d8,0x55fc8bf3b9b8), \r\nINFO:       43 files found in /ci_container_base/ci/scratch/qa-assets/fuzz_seed_corpus/wallet_bdb_parser\r\nINFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes\r\nINFO: seed corpus: files: 43 min: 1b max: 1237b total: 31691b rss: 160Mb\r\nwallet/migrate.cpp:554:35: runtime error: implicit conversion from type 'int64_t' (aka 'long') of value -1 (64-bit, signed) to type 'uint32_t' (aka 'unsigned int') changed the value to 4294967295 (32-bit, unsigned)\r\n    #0 0x55fc897e51c3 in wallet::BerkeleyRODatabase::Open() src/wallet/migrate.cpp:554:35\r\n    #1 0x55fc897f58de in wallet::BerkeleyRODatabase::BerkeleyRODatabase(fs::path const&, bool) src/./wallet/migrate.h:29:19\r\n    #2 0x55fc897eb8fc in std::__detail::_MakeUniq<wallet::BerkeleyRODatabase>::__single_object std::make_unique<wallet::BerkeleyRODatabase, fs::path&>(fs::path&) /usr/bin/../lib/gcc/x86_64-linux-gnu/13/../../../../include/c++/13/bits/unique_ptr.h:1070:34\r\n    #3 0x55fc897eb8fc in wallet::MakeBerkeleyRODatabase(fs::path const&, wallet::DatabaseOptions const&, wallet::DatabaseStatus&, bilingual_str&) src/wallet/migrate.cpp:775:50\r\n    #4 0x55fc88560dab in wallet_bdb_parser_fuzz_target(Span<unsigned char const>) src/wallet/test/fuzz/wallet_bdb_parser.cpp:57:13\r\n    #5 0x55fc88adfc3d in std::function<void (Span<unsigned char const>)>::operator()(Span<unsigned char const>) const /usr/bin/../lib/gcc/x86_64-linux-gnu/13/../../../../include/c++/13/bits/std_function.h:591:9\r\n    #6 0x55fc88adfc3d in LLVMFuzzerTestOneInput src/test/fuzz/fuzz.cpp:201:5\r\n    #7 0x55fc88402484 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x1ab6484) (BuildId: e6ce4f280e684054dbb9f999521c5970ef6be186)\r\n    #8 0x55fc88401b79 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x1ab5b79) (BuildId: e6ce4f280e684054dbb9f999521c5970ef6be186)\r\n    #9 0x55fc88403796 in fuzzer::Fuzzer::ReadAndExecuteSeedCorpora(std::vector<fuzzer::SizedFile, std::allocator<fuzzer::SizedFile>>&) (/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x1ab7796) (BuildId: e6ce4f280e684054dbb9f999521c5970ef6be186)\r\n    #10 0x55fc88403ca7 in fuzzer::Fuzzer::Loop(std::vector<fuzzer::SizedFile, std::allocator<fuzzer::SizedFile>>&) (/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x1ab7ca7) (BuildId: e6ce4f280e684054dbb9f999521c5970ef6be186)\r\n    #11 0x55fc883f119f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x1aa519f) (BuildId: e6ce4f280e684054dbb9f999521c5970ef6be186)\r\n    #12 0x55fc8841b826 in main (/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x1acf826) (BuildId: e6ce4f280e684054dbb9f999521c5970ef6be186)\r\n    #13 0x7f7a35bbf1c9  (/lib/x86_64-linux-gnu/libc.so.6+0x2a1c9) (BuildId: 08134323d00289185684a4cd177d202f39c2a5f3)\r\n    #14 0x7f7a35bbf28a in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2a28a) (BuildId: 08134323d00289185684a4cd177d202f39c2a5f3)\r\n    #15 0x55fc883e6184 in _start (/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x1a9a184) (BuildId: e6ce4f280e684054dbb9f999521c5970ef6be186)\r\n\r\nSUMMARY: UndefinedBehaviorSanitizer: implicit-signed-integer-truncation wallet/migrate.cpp:554:35 \r\nMS: 0 ; base unit: 0000000000000000000000000000000000000000\r\nartifact_prefix='./'; Test unit written to ./crash-1376869be72eebcc87fe737020add634b1a29533\r\n```\r\n\r\nFile: https://github.com/bitcoin-core/qa-assets/blob/24c507b3ea6263e6b121fb8dced01123065c44c2/fuzz_seed_corpus/wallet_bdb_parser/1376869be72eebcc87fe737020add634b1a29533", "created_at": "2024-06-07 15:33:02", "merge_commit_sha": "c6de072a215e8f893098abbab74e0ac1267c3f8b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30147", "base_commit": "323b0acfcb9380ce4b3c12a3d0b341d7bb3bfe08", "patch": "diff --git a/contrib/verify-binaries/README.md b/contrib/verify-binaries/README.md\nindex 04d683e69b559..0f3e16a5bc9d3 100644\n--- a/contrib/verify-binaries/README.md\n+++ b/contrib/verify-binaries/README.md\n@@ -50,6 +50,7 @@ Get JSON output and don't prompt for user input (no auto key import):\n \n ```sh\n ./contrib/verify-binaries/verify.py --json pub 22.0-x86\n+./contrib/verify-binaries/verify.py --json pub 23.0-rc5-linux-gnu\n ```\n \n Rely only on local GPG state and manually specified keys, while requiring a\n@@ -57,14 +58,15 @@ threshold of at least 10 trusted signatures:\n ```sh\n ./contrib/verify-binaries/verify.py \\\n     --trusted-keys 74E2DEF5D77260B98BC19438099BAD163C70FBFA,9D3CC86A72F8494342EA5FD10A41BDC3F4FAFF1C \\\n-    --min-good-sigs 10 pub 22.0-x86\n+    --min-good-sigs 10 pub 22.0-linux\n ```\n \n-If you only want to download the binaries for a certain platform, add the corresponding suffix, e.g.:\n+If you only want to download the binaries for a certain architecture and/or platform, add the corresponding suffix, e.g.:\n \n ```sh\n-./contrib/verify-binaries/verify.py pub 24.0.1-darwin\n-./contrib/verify-binaries/verify.py pub 23.1-rc1-win64\n+./contrib/verify-binaries/verify.py pub 25.2-x86_64-linux\n+./contrib/verify-binaries/verify.py pub 24.1-rc1-darwin\n+./contrib/verify-binaries/verify.py pub 27.0-win64-setup.exe\n ```\n \n If you do not want to keep the downloaded binaries, specify the cleanup option.\ndiff --git a/contrib/verify-binaries/verify.py b/contrib/verify-binaries/verify.py\nindex 12e6e10d8a4de..6c07b36c9d8cd 100755\n--- a/contrib/verify-binaries/verify.py\n+++ b/contrib/verify-binaries/verify.py\n@@ -97,23 +97,17 @@ def bool_from_env(key, default=False) -> bool:\n \n \n VERSION_FORMAT = \"<major>.<minor>[.<patch>][-rc[0-9]][-platform]\"\n-VERSION_EXAMPLE = \"22.0-x86_64 or 23.1-rc1-darwin\"\n+VERSION_EXAMPLE = \"22.0 or 23.1-rc1-darwin.dmg or 27.0-x86_64-linux-gnu\"\n \n def parse_version_string(version_str):\n-    parts = version_str.split('-')\n-    version_base = parts[0]\n-    version_rc = \"\"\n-    version_os = \"\"\n-    if len(parts) == 2:  # \"<version>-rcN\" or \"version-platform\"\n-        if \"rc\" in parts[1]:\n-            version_rc = parts[1]\n-        else:\n-            version_os = parts[1]\n-    elif len(parts) == 3:  # \"<version>-rcN-platform\"\n-        version_rc = parts[1]\n-        version_os = parts[2]\n+    # \"<version>[-rcN][-platform]\"\n+    version_base, _, platform = version_str.partition('-')\n+    rc = \"\"\n+    if platform.startswith(\"rc\"): # \"<version>-rcN[-platform]\"\n+        rc, _, platform = platform.partition('-')\n+    # else \"<version>\" or \"<version>-platform\"\n \n-    return version_base, version_rc, version_os\n+    return version_base, rc, platform\n \n \n def download_with_wget(remote_file, local_file):\n@@ -514,7 +508,9 @@ def cleanup():\n     # Extract hashes and filenames\n     hashes_to_verify = parse_sums_file(SUMS_FILENAME, [os_filter])\n     if not hashes_to_verify:\n-        log.error(\"no files matched the platform specified\")\n+        available_versions = [\"-\".join(line[1].split(\"-\")[2:]) for line in parse_sums_file(SUMS_FILENAME, [])]\n+        closest_match = difflib.get_close_matches(os_filter, available_versions, cutoff=0, n=1)[0]\n+        log.error(f\"No files matched the platform specified. Did you mean: {closest_match}\")\n         return ReturnCode.NO_BINARIES_MATCH\n \n     # remove binaries that are known not to be hosted by bitcoincore.org\n", "test_patch": "diff --git a/contrib/verify-binaries/test.py b/contrib/verify-binaries/test.py\nindex 22d718ece334a..875606ec22678 100755\n--- a/contrib/verify-binaries/test.py\n+++ b/contrib/verify-binaries/test.py\n@@ -12,6 +12,21 @@ def main():\n     expect_code(run_verify(\"\", \"pub\", '0.32.awefa.12f9h'), 11, \"Malformed version should fail\")\n     expect_code(run_verify('--min-good-sigs 20', \"pub\", \"22.0\"), 9, \"--min-good-sigs 20 should fail\")\n \n+    print(\"- testing verification (22.0-x86_64-linux-gnu.tar.gz)\", flush=True)\n+    _220_x86_64_linux_gnu = run_verify(\"--json\", \"pub\", \"22.0-x86_64-linux-gnu.tar.gz\")\n+    try:\n+        result = json.loads(_220_x86_64_linux_gnu.stdout.decode())\n+    except Exception:\n+        print(\"failed on 22.0-x86_64-linux-gnu.tar.gz --json:\")\n+        print_process_failure(_220_x86_64_linux_gnu)\n+        raise\n+\n+    expect_code(_220_x86_64_linux_gnu, 0, \"22.0-x86_64-linux-gnu.tar.gz should succeed\")\n+    v = result['verified_binaries']\n+    assert result['good_trusted_sigs']\n+    assert len(v) == 1\n+    assert v['bitcoin-22.0-x86_64-linux-gnu.tar.gz'] == '59ebd25dd82a51638b7a6bb914586201e67db67b919b2a1ff08925a7936d1b16'\n+\n     print(\"- testing verification (22.0)\", flush=True)\n     _220 = run_verify(\"--json\", \"pub\", \"22.0\")\n     try:\n", "problem_statement": "bug: verify-binaries/verify.py incorrectly parses version string; gives error or downloads wrong files\n### Current behaviour\r\n\r\nWhen I run:\r\n`./verify.py pub 27.0-x86_64-linux-gnu` instead of downloading the version I told it, it downloads every version in the SHA256SUMS file starting with the first.\r\n\r\nThe `version_os` and (also `version_rc`) are completely ignored which causes wrong files to download when an -rcN is intended.\r\n\r\nWhen I attempt to work around and give it a 1 dash string such as\r\n`./verify.py pub 27.0-x86_64` it will start with bitcoin-27.0-x86_64-apple-darwin which is not useful if I only needed bitcoin-27.0-x86_64-linux-gnu.\r\n\r\nUpdate: it will also parse `\"27.0-aarch64\"` wrong. Setting `rc_version=\"aarch64\"` which causes no file found errors. But this is a valid string.\r\n\r\n### Expected behaviour\r\n\r\nI expected it to only download bitcoin-27.0-x86_64-linux-gnu.tar.gz when I run `./verify.py pub 27.0-x86_64-linux-gnu`.\r\nI expected `rc_version` to be set to the `-rcN` release candidate number as per the comments and documentation.\r\n\r\n### Steps to reproduce\r\n\r\nFollow the instructions in the README.md \r\n> If you only want to download the binaries for a certain platform, add the corresponding suffix, e.g.:\r\n\r\nBut instead of the examples, give it a platform suffix with any dashes and it will ignore the requested platform.\r\nOr give \"<version>-aarch64\" and aarch64 it will be interpreted as a release candidate number causing errors.\r\n\r\n### Relevant log output\r\n\r\n```\r\n./verify.py pub 27.0-x86_64-linux-gnu\r\n[INFO] got file https://bitcoincore.org/bin/bitcoin-core-27.0/SHA256SUMS.asc as SHA256SUMS.asc\r\n[WARNING] https://bitcoin.org failed to provide file (https://bitcoin.org/bin/bitcoin-core-27.0/SHA256SUMS.asc). Continuing based solely upon https://bitcoincore.org.\r\n[INFO] got file https://bitcoincore.org/bin/bitcoin-core-27.0/SHA256SUMS as SHA256SUMS\r\n[WARNING] https://bitcoin.org failed to provide file (https://bitcoin.org/bin/bitcoin-core-27.0/SHA256SUMS). Continuing based solely upon https://bitcoincore.org.\r\n[INFO] got 3 good signatures\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('1E4AED62986CD25D', 'Wladimir J. van der Laan <laanwj@protonmail.com>', trusted=False, status='')\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('17565732E08E5E41', 'Ava Chow <me@achow101.com>', trusted=False, status='')\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('3152347D07DA627C', 'Stephan Oeste (it) <it@oeste.de>', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('410108112E7EA81F', 'hebasto@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('C2371D91CB716EA7', 'sebastian.falbesoner@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('E7E2984B6289C93A', 'pinheadmz@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('2EEB9F5CC09526C1', 'fanquake@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('F62711DBDCA8AE56', 'kvaciral@protonmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('57FF9BDBCC301009', '', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('8E4256593F177720', 'gugger@gmail.com', trusted=False, status='')\r\n[INFO] removing *-unsigned binaries (bitcoin-27.0-arm64-apple-darwin-unsigned.tar.gz, bitcoin-27.0-arm64-apple-darwin-unsigned.zip, bitcoin-27.0-x86_64-apple-darwin-unsigned.tar.gz, bitcoin-27.0-x86_64-apple-darwin-unsigned.zip, bitcoin-27.0-win64-setup-unsigned.exe, bitcoin-27.0-win64-unsigned.tar.gz) from verification since https://bitcoincore.org does not host *-unsigned binaries\r\n[INFO] removing *-debug binaries (bitcoin-27.0-aarch64-linux-gnu-debug.tar.gz, bitcoin-27.0-arm-linux-gnueabihf-debug.tar.gz, bitcoin-27.0-powerpc64-linux-gnu-debug.tar.gz, bitcoin-27.0-powerpc64le-linux-gnu-debug.tar.gz, bitcoin-27.0-riscv64-linux-gnu-debug.tar.gz, bitcoin-27.0-x86_64-linux-gnu-debug.tar.gz, bitcoin-27.0-win64-debug.zip) from verification since https://bitcoincore.org does not host *-debug binaries\r\n[INFO] removing *-codesignatures binaries (bitcoin-27.0-codesignatures-27.0.tar.gz) from verification since https://bitcoincore.org does not host *-codesignatures binaries\r\n[INFO] downloading bitcoin-27.0-aarch64-linux-gnu.tar.gz to /tmp/bitcoin_verify_binaries.27.0-x86_64-linux-gnu\r\n```\r\n\r\n```\r\namnesia@amnesia:~/.local/share/bitcoin-core$ ./verify.py pub 27.0-aarch64\r\n[ERROR] couldn't fetch file (https://bitcoincore.org/bin/bitcoin-core-27.0/test.aarch64/SHA256SUMS.asc). Have you specified the version number in the following format?\r\n<major>.<minor>[.<patch>][-rc[0-9]][-platform] (example: 22.0-x86_64 or 23.1-rc1-darwin)\r\nwget output:\r\n  --2024-05-21 12:28:08--  https://bitcoincore.org/bin/bitcoin-core-27.0/test.aarch64/SHA256SUMS.asc\r\n  Resolving bitcoincore.org (bitcoincore.org)... 198.251.83.116\r\n  Connecting to bitcoincore.org (bitcoincore.org)|198.251.83.116|:443... connected.\r\n  HTTP request sent, awaiting response... 404 Not Found\r\n  2024-05-21 12:28:14 ERROR 404: Not Found.\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\ngit clone\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nmaster / 27.0\r\n\r\n### Operating system and version\r\n\r\nDebian 12\r\n\r\n### Machine specifications\r\n\r\nVM, 4GB RAM, virtIO SSD, wired\n", "hints_text": "I would like to be assigned to this issue and will send a PR in an hour.", "created_at": "2024-05-21 17:18:00", "merge_commit_sha": "2cd7c6bd939e4e37b00b5b822b62eb933f720dc6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30097", "base_commit": "42d5a1ff25a8045b6f4c09fa1fb71736dbccc034", "patch": "diff --git a/src/crypto/sha256_sse4.cpp b/src/crypto/sha256_sse4.cpp\nindex f4557291cefe5..f0e255a23cb56 100644\n--- a/src/crypto/sha256_sse4.cpp\n+++ b/src/crypto/sha256_sse4.cpp\n@@ -13,6 +13,13 @@\n namespace sha256_sse4\n {\n void Transform(uint32_t* s, const unsigned char* chunk, size_t blocks)\n+#if defined(__clang__) && !defined(__OPTIMIZE__)\n+  /*\n+  clang is unable to compile this with -O0 and -fsanitize=address.\n+  See upstream bug: https://github.com/llvm/llvm-project/issues/92182\n+  */\n+  __attribute__((no_sanitize(\"address\")))\n+#endif\n {\n     static const uint32_t K256 alignas(16) [] = {\n         0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5,\n", "test_patch": "", "problem_statement": "Compilation failure with `-O0` + `-fsanitize=address`  due to inline asm\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nConfigure with\r\n```\r\n./configure --enable-fuzz --enable-debug --with-sanitizers=address,fuzzer,undefined,integer CC=clang CXX=clang++\r\n```\r\n\r\nCompile fails:\r\n```\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:1882: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:2591: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:3284: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:4686: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:5395: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:6088: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:7490: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:8199: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:8892: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:10312: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:11021: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:11714: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:12859: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:13356: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:13853: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:14900: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:15397: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:15894: note: instantiated into assembly here\r\n18 errors generated.\r\nmake[2]: *** [Makefile:14531: crypto/libbitcoin_crypto_base_la-sha256_sse4.lo] Error 1\r\n```\n\n### Expected behaviour\n\nIt should successfully compile with the debug symbols so that fuzz crashes can be debugged.\r\n\r\nPreviously, it was possible to work around this issue by using `--disable-asm` however that was removed in #29407\n\n### Steps to reproduce\n\nSee above configure .\r\n\r\n`--enable-debug` and `--enable-fuzz` individually do not result in compilation failure. I am only seeing this when using them together.\n\n### Relevant log output\n\n[config.log](https://github.com/bitcoin/bitcoin/files/14854906/config.log)\r\n\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@0d509bab45d292caeaf34600e57b5928757c6005\n\n### Operating system and version\n\nArch w/ linux kernel 6.8.2\n\n### Machine specifications\n\n_No response_\n", "hints_text": "Recalling the IRC discussion, I presume this happens since `-O0` in https://github.com/bitcoin/bitcoin/pull/16435 ?\nRef:\r\n\r\n```\r\n1802024-04-01T18:09:22  <cfields> clang++ -std=c++20 -O0 -fsanitize=address -c crypto/sha256_sse4.cpp -o out.o\r\n```\r\n\r\nhttps://www.erisian.com.au/bitcoin-core-dev/log-2024-04-02.html\nThe broken combination is `clang++ -std=c++20 -O0 -fsanitize=address -c crypto/sha256_sse4.cpp -o out.o`, pointed out by Cory. Happens for me with Clang-18.\nI guess the next step is to followup / file an issue with LLVM. I've got #29796 open which may \"fix\" this by just dropping `-O0`, depending on the outcome of discussion.\nFWIW, unable to reproduce on arm64 macOS 14.4.1 with Homebrew clang 17.0.6.\r\n\nIt only happens on x86-64, because the asm is in that format.\nIn addition to the discussion in #29781, I'll PR a change to make this work with `DISABLE_OPTIMIZED_SHA256` as a fallback. I'm doing that as part of a larger refactor of the crypto defines, though.\nHow about adding something like:\r\n\r\n```diff\r\n--- a/configure.ac\r\n+++ b/configure.ac\r\n@@ -349,7 +349,14 @@ esac\r\n if test \"$enable_debug\" = \"yes\"; then\r\n \r\n   dnl Disable all optimizations\r\n-  AX_CHECK_COMPILE_FLAG([-O0], [DEBUG_CXXFLAGS=\"$DEBUG_CXXFLAGS -O0\"], [], [$CXXFLAG_WERROR])\r\n+  case \"$use_sanitizers\" in\r\n+    *address*)\r\n+      AX_CHECK_COMPILE_FLAG([-Og], [DEBUG_CXXFLAGS=\"$DEBUG_CXXFLAGS -Og\"], [], [$CXXFLAG_WERROR])\r\n+      ;;\r\n+    *)\r\n+      AX_CHECK_COMPILE_FLAG([-O0], [DEBUG_CXXFLAGS=\"$DEBUG_CXXFLAGS -O0\"], [], [$CXXFLAG_WERROR])\r\n+      ;;\r\n+  esac\r\n```\r\n\r\nin the meantime?", "created_at": "2024-05-13 18:16:52", "merge_commit_sha": "ae2658caacc1f3d8ab48d6b8ece481b1e9707fbb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30065", "base_commit": "d661e2b1b771abafb0b152842d775d3150032230", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e60feecf108be..3c4b72d3e4ffe 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -147,11 +147,12 @@ static constexpr bool DEFAULT_STOPAFTERBLOCKIMPORT{false};\n // Win32 LevelDB doesn't use filedescriptors, and the ones used for\n // accessing block files don't count towards the fd_set size limit\n // anyway.\n-#define MIN_CORE_FILEDESCRIPTORS 0\n+#define MIN_LEVELDB_FDS 0\n #else\n-#define MIN_CORE_FILEDESCRIPTORS 150\n+#define MIN_LEVELDB_FDS 150\n #endif\n \n+static constexpr int MIN_CORE_FDS = MIN_LEVELDB_FDS + NUM_FDS_MESSAGE_CAPTURE;\n static const char* DEFAULT_ASMAP_FILENAME=\"ip_asn.map\";\n \n /**\n@@ -834,8 +835,7 @@ void InitLogging(const ArgsManager& args)\n namespace { // Variables internal to initialization process only\n \n int nMaxConnections;\n-int nUserMaxConnections;\n-int nFD;\n+int available_fds;\n ServiceFlags nLocalServices = ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);\n int64_t peer_connect_timeout;\n std::set<BlockFilterType> g_enabled_filter_types;\n@@ -987,27 +987,33 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"Cannot set -listen=0 together with -listenonion=1\"));\n     }\n \n-    // Make sure enough file descriptors are available\n-    int nBind = std::max(nUserBind, size_t(1));\n-    nUserMaxConnections = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n-    nMaxConnections = std::max(nUserMaxConnections, 0);\n-\n-    nFD = RaiseFileDescriptorLimit(nMaxConnections + MIN_CORE_FILEDESCRIPTORS + MAX_ADDNODE_CONNECTIONS + nBind + NUM_FDS_MESSAGE_CAPTURE);\n+    // Make sure enough file descriptors are available. We need to reserve enough FDs to account for the bare minimum,\n+    // plus all manual connections and all bound interfaces. Any remainder will be available for connection sockets\n \n-#ifdef USE_POLL\n-    int fd_max = nFD;\n-#else\n-    int fd_max = FD_SETSIZE;\n+    // Number of bound interfaces (we have at least one)\n+    int nBind = std::max(nUserBind, size_t(1));\n+    // Maximum number of connections with other nodes, this accounts for all types of outbounds and inbounds except for manual\n+    int user_max_connection = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n+    if (user_max_connection < 0) {\n+        return InitError(Untranslated(\"-maxconnections must be greater or equal than zero\"));\n+    }\n+    // Reserve enough FDs to account for the bare minimum, plus any manual connections, plus the bound interfaces\n+    int min_required_fds = MIN_CORE_FDS + MAX_ADDNODE_CONNECTIONS + nBind;\n+\n+    // Try raising the FD limit to what we need (available_fds may be smaller than the requested amount if this fails)\n+    available_fds = RaiseFileDescriptorLimit(user_max_connection + min_required_fds);\n+    // If we are using select instead of poll, our actual limit may be even smaller\n+#ifndef USE_POLL\n+    available_fds = std::min(FD_SETSIZE, available_fds);\n #endif\n+    if (available_fds < min_required_fds)\n+        return InitError(strprintf(_(\"Not enough file descriptors available. %d available, %d required.\"), available_fds, min_required_fds));\n+\n     // Trim requested connection counts, to fit into system limitations\n-    // <int> in std::min<int>(...) to work around FreeBSD compilation issue described in #2695\n-    nMaxConnections = std::max(std::min<int>(nMaxConnections, fd_max - nBind - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE), 0);\n-    if (nFD < MIN_CORE_FILEDESCRIPTORS)\n-        return InitError(_(\"Not enough file descriptors available.\"));\n-    nMaxConnections = std::min(nFD - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE, nMaxConnections);\n+    nMaxConnections = std::min(available_fds - min_required_fds, user_max_connection);\n \n-    if (nMaxConnections < nUserMaxConnections)\n-        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), nUserMaxConnections, nMaxConnections));\n+    if (nMaxConnections < user_max_connection)\n+        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), user_max_connection, nMaxConnections));\n \n     // ********************************************************* Step 3: parameter-to-internal-flags\n     if (auto result{init::SetLoggingCategories(args)}; !result) return InitError(util::ErrorString(result));\n@@ -1155,7 +1161,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         return false;\n     }\n \n-    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, nFD);\n+    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, available_fds);\n \n     // Warn about relative -datadir path.\n     if (args.IsArgSet(\"-datadir\") && !args.GetPathArg(\"-datadir\").is_absolute()) {\n", "test_patch": "", "problem_statement": "Improve minimum file descriptor accounting and documentation\n#16003 has been closed, and I've pulled out the unrelated p2p change. However I think it's worth someone following up and taking a look at our startup file descriptor accounting. \r\n\r\nAs mentioned in #16003, if `bitcoind` is started somewhere that the maximum number of open file descriptors is limited, we can run into some nonsensical behaviour. Such as a \"negative\" number of maximum connections:\r\n\r\n```bash\r\n# using bash\r\nulimit -n 150\r\nsrc/bitcoind\r\n[init] Using at most -8 automatic connections (150 file descriptors available)\r\n```\r\n\r\nIt's also impossible to shutdown `bitcoind` from this state as the `opencon` thread will never exit.\r\n\r\nIt would be good for someone to look through this code, document assumptions, and fix issues like the above.\r\n\r\nYou do not need to request permission to start working on this. You are encouraged to comment on the issue if you are planning to work on it. This will help other contributors monitor which issues are actively being addressed and is also an effective way to request assistance if and when you need it.\r\n\r\nFor guidance on contributing, please read [CONTRIBUTING.md](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md) before opening your pull request.\r\n\n", "hints_text": "Hii @fanquake  I would like to be assigned to work on this issue as my first contribution to bitcoin-core.\r\n\r\nThanks.\r\n\r\nEdit : Started working on this :) \nThanks @MrSquanchee!\r\n\r\nI've added most of my thoughts on this in the closed issue above. As of now, the FD counts are pretty much hardcoded in, and I think it would be nice to get away from that in a modular way if we want things like a configurable number of inbound/outbound/feeler connections, lots of RPC threads, FDs used by future changes that will have possibly missed modifying the initial FD count, etc. \r\n\r\nThere's also the concept of \"soft limits\" of FDs, which is currently implemented in a way that reduces the possible maximum of 125 inbound connections when we allocate them to *some* other stuff, but I think this \"soft limit\" should be applied to the maximum number of FDs available to the process. This would be nice, as most Linux distros give you 1024 FDs, which would allow for much more varied configurations and eliminate the need to reduce the 125 inbound count.\r\n\r\nThere's also an assumption that every system will use the same count, which I'm not sure will be true in the future, or is true now (I didn't really have a large enough test bed of OSes when I opened the issue, which was kind of discouraging). Something that actually measures the number of FDs open by the process might also be helpful, instead of assuming we've measured correctly.\r\n\r\nWith that in mind, something that tells us the number of required, requested, and allocated FDs on startup would be informative. Similar to what I had in the closed issue, which is what causes the bug above (the allocated number of FDs returned gets reduced lower than the required number of FDs). So if we don't get our requested amount, we can *possibly* revamp our counts in such a way that we still meet the required amount. \r\n\r\nOn another note: arbitrarily changing FD counts to critical things is not a solution in my mind, but in support of more robust configs, there's at least some bigger nodes that need to vary these counts, and probably a sane minimum we can use for most stuff (current values could be a sane minimum and default maximum for some things, ie. feeler connections).\nAlso, don't hesitate to pick our brains in #bitcoin-core-dev on freenode or pm me on there! :)\nThere is no formal assignment process on Bitcoin Core @MrSquanchee so we can't stop somebody else from working on it if they want to. But it is helpful to know you are working on it.\nHii Guys, Thanks for reminding me about this. I have been a bit busy. I would not mind if anyone else would want to work on this Issue.\r\nMight start working on bitcoin later :)\nIf anyone is looking for somewhere to get started, I've cleaned up the file descriptor code in `init.cpp` a little [here](https://github.com/troygiorshev/bitcoin/commit/d9e1c1e83afc29782e26c1ae020539dc15444f75).\n> If anyone is looking for somewhere to get started, I've cleaned up the file descriptor code in `init.cpp` a little [here](https://github.com/troygiorshev/bitcoin/commit/d9e1c1e83afc29782e26c1ae020539dc15444f75).\r\n\r\nI've also taken the liberty to meddle with this: here's a [branch](https://github.com/NelsonFrancisco/bitcoin/compare/master...NelsonFrancisco:n2021-31-03-fd)\r\n\r\nMade a branch with a \"sanitizing\" of this code before trying to achieve the issue here. I found the \"nMaxConnections\" variable value to be really hard to track, so I've thrown an error, if -maxconnections is less than 0, and used a temporary variable before finally defining nMaxConnections. So, I believe I changed no behavior besides the error throwing.\r\n\r\nI believe also, that \"AppInitParameterInteraction\" should be divided into several functions. It simply does too much, IMO. Maybe in a separated commit, what do you think?\r\n\r\nSo, for the problem in itself: is it possible for the nMaxConnections variable to get a negative value? What's the best approach to solve this? Change the following calculation `nFD - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE` ?\nIs anyone working on this? I am very new to open source and would like to start networking :)\r\n\nIn addition to improving fd planning, I wonder if we should have all our fd allocations check if they exceed our known limitations, and if so, close the new fd, kill a random p2p socket, and try again?", "created_at": "2024-05-08 19:47:35", "merge_commit_sha": "2756797ecaf07b1a39645282e879bc70890e3f0b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-29985", "base_commit": "a46065e36cf868265c909dc5edf29dc17be53c1f", "patch": "diff --git a/depends/packages/qt.mk b/depends/packages/qt.mk\nindex 0acf4cf565504..d057b2d410a18 100644\n--- a/depends/packages/qt.mk\n+++ b/depends/packages/qt.mk\n@@ -22,6 +22,7 @@ $(package)_patches += fix-macos-linker.patch\n $(package)_patches += memory_resource.patch\n $(package)_patches += utc_from_string_no_optimize.patch\n $(package)_patches += windows_lto.patch\n+$(package)_patches += zlib-timebits64.patch\n \n $(package)_qttranslations_file_name=qttranslations-$($(package)_suffix)\n $(package)_qttranslations_sha256_hash=24d4c58bc2a40c0f44f59ee64af4192c7d0038c1e45af61646cfc5b65058f271\n@@ -251,6 +252,7 @@ define $(package)_preprocess_cmds\n   patch -p1 -i $($(package)_patch_dir)/utc_from_string_no_optimize.patch && \\\n   patch -p1 -i $($(package)_patch_dir)/guix_cross_lib_path.patch && \\\n   patch -p1 -i $($(package)_patch_dir)/windows_lto.patch && \\\n+  patch -p1 -i $($(package)_patch_dir)/zlib-timebits64.patch && \\\n   mkdir -p qtbase/mkspecs/macx-clang-linux &&\\\n   cp -f qtbase/mkspecs/macx-clang/qplatformdefs.h qtbase/mkspecs/macx-clang-linux/ &&\\\n   cp -f $($(package)_patch_dir)/mac-qmake.conf qtbase/mkspecs/macx-clang-linux/qmake.conf && \\\ndiff --git a/depends/patches/qt/zlib-timebits64.patch b/depends/patches/qt/zlib-timebits64.patch\nnew file mode 100644\nindex 0000000000000..139c1dfa77f3e\n--- /dev/null\n+++ b/depends/patches/qt/zlib-timebits64.patch\n@@ -0,0 +1,31 @@\n+From a566e156b3fa07b566ddbf6801b517a9dba04fa3 Mon Sep 17 00:00:00 2001\n+From: Mark Adler <madler@alumni.caltech.edu>\n+Date: Sat, 29 Jul 2023 22:13:09 -0700\n+Subject: [PATCH] Avoid compiler complaints if _TIME_BITS defined when building\n+ zlib.\n+\n+zlib does not use time_t, so _TIME_BITS is irrelevant. However it\n+may be defined anyway as part of a sledgehammer indiscriminately\n+applied to all builds.\n+\n+From https://github.com/madler/zlib/commit/a566e156b3fa07b566ddbf6801b517a9dba04fa3.patch\n+---\n+ qtbase/src/3rdparty/zlib/src/gzguts.h | 5 ++---\n+ 1 file changed, 2 insertions(+), 3 deletions(-)\n+\n+diff --git a/qtbase/src/3rdparty/zlib/src/gzguts.h b/qtbase/src/3rdparty/zlib/src/gzguts.h\n+index e23f831f5..f9375047e 100644\n+--- a/qtbase/src/3rdparty/zlib/src/gzguts.h\n++++ b/qtbase/src/3rdparty/zlib/src/gzguts.h\n+@@ -26,9 +26,8 @@\n+ #  ifndef _LARGEFILE_SOURCE\n+ #    define _LARGEFILE_SOURCE 1\n+ #  endif\n+-#  ifdef _FILE_OFFSET_BITS\n+-#    undef _FILE_OFFSET_BITS\n+-#  endif\n++#  undef _FILE_OFFSET_BITS\n++#  undef _TIME_BITS\n+ #endif\n+ \n+ #ifdef HAVE_HIDDEN\n", "test_patch": "", "problem_statement": "depends: Cross-compiling `qt` for `arm-linux-gnueabihf` fails\nOn Ubuntu 24.04 with glibc 2.39:\r\n```\r\ncompiling ../3rdparty/zlib/src/gzclose.c\r\nIn file included from /usr/arm-linux-gnueabihf/include/features.h:394,\r\n                 from /usr/arm-linux-gnueabihf/include/bits/libc-header-start.h:33,\r\n                 from /usr/arm-linux-gnueabihf/include/stdio.h:28,\r\n                 from ../3rdparty/zlib/src/gzguts.h:40,\r\n                 from ../3rdparty/zlib/src/gzclose.c:6:\r\n/usr/arm-linux-gnueabihf/include/features-time64.h:26:5: error: #error \"_TIME_BITS=64 is allowed only with _FILE_OFFSET_BITS=64\"\r\n   26 | #   error \"_TIME_BITS=64 is allowed only with _FILE_OFFSET_BITS=64\"\r\n      |     ^~~~~\r\n```\r\n\r\nSome similar issues in https://bugreports.qt.io suggest to switch from the builtin `zlib` to a system one. But that doesn't look like an option for us.\n", "hints_text": "This is caused by the 32 to 64 bit time_t transition (for the 2038 epoch problem). It will affect all 32-bit Linux systems.\r\n\r\nI would guess solving this requires a minimal patch to the zlib inside Qt to make the right combination of defines. i'll take a look at it.", "created_at": "2024-04-28 11:42:13", "merge_commit_sha": "ad42d63519839b5751db0f294b5de7cfdc332e61", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-29850", "base_commit": "3f6a6da3b08da15c10cbf2806f672da4a57254f6", "patch": "diff --git a/src/net.cpp b/src/net.cpp\nindex e388f05b037ad..3e959c187c2c7 100644\n--- a/src/net.cpp\n+++ b/src/net.cpp\n@@ -2256,7 +2256,11 @@ void CConnman::ThreadDNSAddressSeed()\n             if (!resolveSource.SetInternal(host)) {\n                 continue;\n             }\n-            unsigned int nMaxIPs = 256; // Limits number of IPs learned from a DNS seed\n+            // Limit number of IPs learned from a single DNS seed. This limit exists to prevent the results from\n+            // one DNS seed from dominating AddrMan. Note that the number of results from a UDP DNS query is\n+            // bounded to 33 already, but it is possible for it to use TCP where a larger number of results can be\n+            // returned.\n+            unsigned int nMaxIPs = 32;\n             const auto addresses{LookupHost(host, nMaxIPs, true)};\n             if (!addresses.empty()) {\n                 for (const CNetAddr& ip : addresses) {\n", "test_patch": "", "problem_statement": "Decreasing nMaxIPs when learning from DNS seeds\nCurrently, our `nMaxIPs` when learning from DNS seeds is 256. @TheBlueMatt pointed out to me that if one of the seeds decided to actually return that many addresses, it would bias the addresses we add to `AddrMan` and consequently choose as our initial outbound peers. A quick `drill -t` of all the current seeds show that none yielded more than 26 results, meaning that if any of the seeds decided to return all 256 results (perhaps malicious ones), results from that seed would take over more than half of `AddrMan`.\r\n\r\nIf there were no TCP-fallback, this wouldn't be too much of a problem as at maximum we could fit around 31 IPs in a UDP packet. However, it seems that `glibc` [uses the TCP-fallback](https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1811471) by default, which would mean that obtaining 256 IPs is entirely possible.\n", "hints_text": "wrote a little python 3 script that will list number of answers with the same `getaddrinfo` call as what we use:\r\n```python3\r\nimport socket\r\n\r\nseeds = [\"seed.bitcoin.sipa.be\",\r\n         \"dnsseed.bluematt.me\",\r\n         \"dnsseed.bitcoin.dashjr.org\",\r\n         \"seed.bitcoinstats.com\",\r\n         \"seed.bitcoin.jonasschnelli.ch\",\r\n         \"seed.btc.petertodd.org\",\r\n         \"seed.bitcoin.sprovoost.nl\",\r\n         \"dnsseed.emzy.de\"]\r\n\r\nfor seed in seeds:\r\n    result = len(socket.getaddrinfo(seed, None, family=socket.AF_UNSPEC, type=socket.SOCK_STREAM, proto=socket.IPPROTO_TCP, flags=socket.AI_ADDRCONFIG))\r\n    print(\"{:>4}\\t{}\".format(result, seed))\r\n```\r\n-----\r\nHere's the result:\r\n```\r\n  25    seed.bitcoin.sipa.be\r\n  33    dnsseed.bluematt.me\r\n  38    dnsseed.bitcoin.dashjr.org\r\n  50    seed.bitcoinstats.com\r\n  38    seed.bitcoin.jonasschnelli.ch\r\n  23    seed.btc.petertodd.org\r\n  35    seed.bitcoin.sprovoost.nl\r\n  41    dnsseed.emzy.de\r\n```\nGiven the range of # of results (23-50), I'd be interested in what people think a good `nMaxIPs` choice would be.\nEvenly divided by the limit on whichever bucket DNS seeds go into?\n> Evenly divided by the limit on whichever bucket DNS seeds go into?\r\n\r\n@pstratem Not 100% sure what you mean, could you elaborate a little?\n@dongcarl Given the range of responses `nMaxIPs=32` sounds like a good number.\r\n\r\nHow easy would it be to update the DNS seeders to always return up to 32 addresses and then in bitcoin-core only accept 32 addresses from a DNS seeder. \n@EthanHeilman That's not actually up to the seeder implementation, as recursive resolving may transform the response in various ways. And it's also restricted to being able to fit in a UDP packet.\n@sipa Do recursive revolvers transform DNS responses except for censorship, billing and malware purposes?\n> Do recursive revolvers transform DNS responses except for censorship, billing and malware purposes?\r\n\r\nNope, they largely do not. If the response has been modified, something has gone wrong...\n32, indeed, seems like a good number. With my hostname, 33 across v4+v6 fits neatly in the two 500 byte payload responses with an authority section, though if the server doesn't have an authority/additional section you could go a bit higher. To avoid biasing, we probably want a limit that is the ~minimum of all the seeds.\r\n\r\n@petertodd and @sipa looks like y'all should be able to increase the number of responses your seeds provide?\r\n\r\nWhile we're at it @cdecker looks like your seed violates the DNS spec for non-EDNS requests (it sends back 739 bytes if you query for v6 addresses, though your limit for v4 looks OK).\r\n\r\nOf course that said, we could also probably look at the number of requests that use EDNS, and use (and provide) a larger limit if thats common enough (TCP fallback isn't sooo expensive). I don't, however, know if @sipa's seeder supports EDNS which would be a blocker.\r\n\r\n```\r\n$  dig +nodnssec +noedns @ns.as397444.net dnsseed.bluematt.me\r\n...\r\ndnsseed.bluematt.me.\t3600\tIN\tCNAME\tx1.dnsseed.bluematt.me.\r\n...\r\n;; MSG SIZE  rcvd: 486\r\n```\r\n\r\n```\r\n$  dig +nodnssec +noedns @ns.as397444.net dnsseed.bluematt.me AAAA\r\n...\r\ndnsseed.bluematt.me.\t3600\tIN\tCNAME\tx1.dnsseed.bluematt.me.\r\n...\r\n;; MSG SIZE  rcvd: 486\r\n```\n> While we're at it @cdecker looks like your seed violates the DNS spec for non-EDNS requests (it sends back 739 bytes if you query for v6 addresses, though your limit for v4 looks OK).\r\n\r\nI'll fix that asap, thanks for the heads up\n@sipa ", "created_at": "2024-04-11 12:45:06", "merge_commit_sha": "3310a965bd491755fa2c67879f12ebd0b4fb0bae", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-29656", "base_commit": "2aff9a36c352640a263e8b5de469710f7e80eb54", "patch": "diff --git a/src/chain.h b/src/chain.h\nindex e8a8c066c8e1b..c46392c5355c5 100644\n--- a/src/chain.h\n+++ b/src/chain.h\n@@ -102,7 +102,7 @@ enum BlockStatus : uint32_t {\n      *\n      * If a block's validity is at least VALID_TRANSACTIONS, CBlockIndex::nTx will be set. If a block and all previous\n      * blocks back to the genesis block or an assumeutxo snapshot block are at least VALID_TRANSACTIONS,\n-     * CBlockIndex::nChainTx will be set.\n+     * CBlockIndex::m_chain_tx_count will be set.\n      */\n     BLOCK_VALID_TRANSACTIONS =    3,\n \n@@ -173,8 +173,7 @@ class CBlockIndex\n     //! This value will be non-zero if this block and all previous blocks back\n     //! to the genesis block or an assumeutxo snapshot block have reached the\n     //! VALID_TRANSACTIONS level.\n-    //! Change to 64-bit type before 2024 (assuming worst case of 60 byte transactions).\n-    unsigned int nChainTx{0};\n+    uint64_t m_chain_tx_count{0};\n \n     //! Verification status of this block. See enum BlockStatus\n     //!\n@@ -254,10 +253,10 @@ class CBlockIndex\n      * Does not imply the transactions are consensus-valid (ConnectTip might fail)\n      * Does not imply the transactions are still stored on disk. (IsBlockPruned might return true)\n      *\n-     * Note that this will be true for the snapshot base block, if one is loaded, since its nChainTx value will have\n+     * Note that this will be true for the snapshot base block, if one is loaded, since its m_chain_tx_count value will have\n      * been set manually based on the related AssumeutxoData entry.\n      */\n-    bool HaveNumChainTxs() const { return nChainTx != 0; }\n+    bool HaveNumChainTxs() const { return m_chain_tx_count != 0; }\n \n     NodeSeconds Time() const\n     {\ndiff --git a/src/kernel/chainparams.cpp b/src/kernel/chainparams.cpp\nindex 2b729e3b7a9b4..aa6d80556a073 100644\n--- a/src/kernel/chainparams.cpp\n+++ b/src/kernel/chainparams.cpp\n@@ -180,7 +180,7 @@ class CMainParams : public CChainParams {\n         chainTxData = ChainTxData{\n             // Data from RPC: getchaintxstats 4096 000000000000000000026811d149d4d261995ec5b3f64f439a0a10e1a464af9a\n             .nTime    = 1704194835,\n-            .nTxCount = 946728933,\n+            .tx_count = 946728933,\n             .dTxRate  = 6.569290261471664,\n         };\n     }\n@@ -272,7 +272,7 @@ class CTestNetParams : public CChainParams {\n             {\n                 .height = 2'500'000,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xf841584909f68e47897952345234e37fcd9128cd818f41ee6c3ca68db8071be7\")},\n-                .nChainTx = 66484552,\n+                .m_chain_tx_count = 66484552,\n                 .blockhash = uint256S(\"0x0000000000000093bcb68c03a9a168ae252572d348a2eaeba2cdf9231d73206f\")\n             }\n         };\n@@ -280,7 +280,7 @@ class CTestNetParams : public CChainParams {\n         chainTxData = ChainTxData{\n             // Data from RPC: getchaintxstats 4096 000000000001323071f38f21ea5aae529ece491eadaccce506a59bcc2d968917\n             .nTime    = 1703579240,\n-            .nTxCount = 67845391,\n+            .tx_count = 67845391,\n             .dTxRate  = 1.464436832560951,\n         };\n     }\n@@ -312,7 +312,7 @@ class SigNetParams : public CChainParams {\n             chainTxData = ChainTxData{\n                 // Data from RPC: getchaintxstats 4096 0000000870f15246ba23c16e370a7ffb1fc8a3dcf8cb4492882ed4b0e3d4cd26\n                 .nTime    = 1706331472,\n-                .nTxCount = 2425380,\n+                .tx_count = 2425380,\n                 .dTxRate  = 0.008277759863833788,\n             };\n         } else {\n@@ -382,7 +382,7 @@ class SigNetParams : public CChainParams {\n             {\n                 .height = 160'000,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xfe0a44309b74d6b5883d246cb419c6221bcccf0b308c9b59b7d70783dbdf928a\")},\n-                .nChainTx = 2289496,\n+                .m_chain_tx_count = 2289496,\n                 .blockhash = uint256S(\"0x0000003ca3c99aff040f2563c2ad8f8ec88bd0fd6b8f0895cfaf1ef90353a62c\")\n             }\n         };\n@@ -498,21 +498,21 @@ class CRegTestParams : public CChainParams\n             {   // For use by unit tests\n                 .height = 110,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0x6657b736d4fe4db0cbc796789e812d5dba7f5c143764b1b6905612f1830609d1\")},\n-                .nChainTx = 111,\n+                .m_chain_tx_count = 111,\n                 .blockhash = uint256S(\"0x696e92821f65549c7ee134edceeeeaaa4105647a3c4fd9f298c0aec0ab50425c\")\n             },\n             {\n                 // For use by fuzz target src/test/fuzz/utxo_snapshot.cpp\n                 .height = 200,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0x4f34d431c3e482f6b0d67b64609ece3964dc8d7976d02ac68dd7c9c1421738f2\")},\n-                .nChainTx = 201,\n+                .m_chain_tx_count = 201,\n                 .blockhash = uint256S(\"0x5e93653318f294fb5aa339d00bbf8cf1c3515488ad99412c37608b139ea63b27\"),\n             },\n             {\n                 // For use by test/functional/feature_assumeutxo.py\n                 .height = 299,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xa4bf3407ccb2cc0145c49ebba8fa91199f8a3903daf0883875941497d2493c27\")},\n-                .nChainTx = 334,\n+                .m_chain_tx_count = 334,\n                 .blockhash = uint256S(\"0x3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0\")\n             },\n         };\ndiff --git a/src/kernel/chainparams.h b/src/kernel/chainparams.h\nindex 5d45a1fa9c07f..e367de2f93982 100644\n--- a/src/kernel/chainparams.h\n+++ b/src/kernel/chainparams.h\n@@ -50,11 +50,11 @@ struct AssumeutxoData {\n     //! The expected hash of the deserialized UTXO set.\n     AssumeutxoHash hash_serialized;\n \n-    //! Used to populate the nChainTx value, which is used during BlockManager::LoadBlockIndex().\n+    //! Used to populate the m_chain_tx_count value, which is used during BlockManager::LoadBlockIndex().\n     //!\n     //! We need to hardcode the value here because this is computed cumulatively using block data,\n     //! which we do not necessarily have at the time of snapshot load.\n-    unsigned int nChainTx;\n+    uint64_t m_chain_tx_count;\n \n     //! The hash of the base block for this snapshot. Used to refer to assumeutxo data\n     //! prior to having a loaded blockindex.\n@@ -69,7 +69,7 @@ struct AssumeutxoData {\n  */\n struct ChainTxData {\n     int64_t nTime;    //!< UNIX timestamp of last known number of transactions\n-    int64_t nTxCount; //!< total number of transactions between genesis and that timestamp\n+    uint64_t tx_count; //!< total number of transactions between genesis and that timestamp\n     double dTxRate;   //!< estimated number of transactions per second after that timestamp\n };\n \ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\nindex 29b624cb12f57..bfb11e9fcd4f4 100644\n--- a/src/node/blockstorage.cpp\n+++ b/src/node/blockstorage.cpp\n@@ -410,11 +410,11 @@ bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockha\n         m_snapshot_height = au_data.height;\n         CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};\n \n-        // Since nChainTx (responsible for estimated progress) isn't persisted\n+        // Since m_chain_tx_count (responsible for estimated progress) isn't persisted\n         // to disk, we must bootstrap the value for assumedvalid chainstates\n         // from the hardcoded assumeutxo chainparams.\n-        base->nChainTx = au_data.nChainTx;\n-        LogPrintf(\"[snapshot] set nChainTx=%d for %s\\n\", au_data.nChainTx, snapshot_blockhash->ToString());\n+        base->m_chain_tx_count = au_data.m_chain_tx_count;\n+        LogPrintf(\"[snapshot] set m_chain_tx_count=%d for %s\\n\", au_data.m_chain_tx_count, snapshot_blockhash->ToString());\n     } else {\n         // If this isn't called with a snapshot blockhash, make sure the cached snapshot height\n         // is null. This is relevant during snapshot completion, when the blockman may be loaded\n@@ -449,15 +449,15 @@ bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockha\n                 if (m_snapshot_height && pindex->nHeight == *m_snapshot_height &&\n                         pindex->GetBlockHash() == *snapshot_blockhash) {\n                     // Should have been set above; don't disturb it with code below.\n-                    Assert(pindex->nChainTx > 0);\n-                } else if (pindex->pprev->nChainTx > 0) {\n-                    pindex->nChainTx = pindex->pprev->nChainTx + pindex->nTx;\n+                    Assert(pindex->m_chain_tx_count > 0);\n+                } else if (pindex->pprev->m_chain_tx_count > 0) {\n+                    pindex->m_chain_tx_count = pindex->pprev->m_chain_tx_count + pindex->nTx;\n                 } else {\n-                    pindex->nChainTx = 0;\n+                    pindex->m_chain_tx_count = 0;\n                     m_blocks_unlinked.insert(std::make_pair(pindex->pprev, pindex));\n                 }\n             } else {\n-                pindex->nChainTx = pindex->nTx;\n+                pindex->m_chain_tx_count = pindex->nTx;\n             }\n         }\n         if (!(pindex->nStatus & BLOCK_FAILED_MASK) && pindex->pprev && (pindex->pprev->nStatus & BLOCK_FAILED_MASK)) {\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex 9772b26aea585..02f9ecef341f7 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -1725,16 +1725,16 @@ static RPCHelpMan getchaintxstats()\n \n     UniValue ret(UniValue::VOBJ);\n     ret.pushKV(\"time\", (int64_t)pindex->nTime);\n-    if (pindex->nChainTx) {\n-        ret.pushKV(\"txcount\", pindex->nChainTx);\n+    if (pindex->m_chain_tx_count) {\n+        ret.pushKV(\"txcount\", pindex->m_chain_tx_count);\n     }\n     ret.pushKV(\"window_final_block_hash\", pindex->GetBlockHash().GetHex());\n     ret.pushKV(\"window_final_block_height\", pindex->nHeight);\n     ret.pushKV(\"window_block_count\", blockcount);\n     if (blockcount > 0) {\n         ret.pushKV(\"window_interval\", nTimeDiff);\n-        if (pindex->nChainTx != 0 && past_block.nChainTx != 0) {\n-            const auto window_tx_count = pindex->nChainTx - past_block.nChainTx;\n+        if (pindex->m_chain_tx_count != 0 && past_block.m_chain_tx_count != 0) {\n+            const auto window_tx_count = pindex->m_chain_tx_count - past_block.m_chain_tx_count;\n             ret.pushKV(\"window_tx_count\", window_tx_count);\n             if (nTimeDiff > 0) {\n                 ret.pushKV(\"txrate\", double(window_tx_count) / nTimeDiff);\n@@ -2799,7 +2799,7 @@ UniValue CreateUTXOSnapshot(\n     result.pushKV(\"base_height\", tip->nHeight);\n     result.pushKV(\"path\", path.utf8string());\n     result.pushKV(\"txoutset_hash\", maybe_stats->hashSerialized.ToString());\n-    result.pushKV(\"nchaintx\", tip->nChainTx);\n+    result.pushKV(\"nchaintx\", tip->m_chain_tx_count);\n     return result;\n }\n \ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex d6b3924cda0e3..9126d8e928e30 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2956,7 +2956,7 @@ static void UpdateTipLog(\n     LogPrintf(\"%s%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\",\n         prefix, func_name,\n         tip->GetBlockHash().ToString(), tip->nHeight, tip->nVersion,\n-        log(tip->nChainWork.getdouble()) / log(2.0), (unsigned long)tip->nChainTx,\n+        log(tip->nChainWork.getdouble()) / log(2.0), tip->m_chain_tx_count,\n         FormatISO8601DateTime(tip->GetBlockTime()),\n         GuessVerificationProgress(params.TxData(), tip),\n         coins_tip.DynamicMemoryUsage() * (1.0 / (1 << 20)),\n@@ -3846,17 +3846,17 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n {\n     AssertLockHeld(cs_main);\n     pindexNew->nTx = block.vtx.size();\n-    // Typically nChainTx will be 0 at this point, but it can be nonzero if this\n+    // Typically m_chain_tx_count will be 0 at this point, but it can be nonzero if this\n     // is a pruned block which is being downloaded again, or if this is an\n-    // assumeutxo snapshot block which has a hardcoded nChainTx value from the\n+    // assumeutxo snapshot block which has a hardcoded m_chain_tx_count value from the\n     // snapshot metadata. If the pindex is not the snapshot block and the\n-    // nChainTx value is not zero, assert that value is actually correct.\n-    auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->nChainTx : 0); };\n-    if (!Assume(pindexNew->nChainTx == 0 || pindexNew->nChainTx == prev_tx_sum(*pindexNew) ||\n+    // m_chain_tx_count value is not zero, assert that value is actually correct.\n+    auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->m_chain_tx_count : 0); };\n+    if (!Assume(pindexNew->m_chain_tx_count == 0 || pindexNew->m_chain_tx_count == prev_tx_sum(*pindexNew) ||\n                 pindexNew == GetSnapshotBaseBlock())) {\n-        LogWarning(\"Internal bug detected: block %d has unexpected nChainTx %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n-            pindexNew->nHeight, pindexNew->nChainTx, prev_tx_sum(*pindexNew), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n-        pindexNew->nChainTx = 0;\n+        LogWarning(\"Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n+            pindexNew->nHeight, pindexNew->m_chain_tx_count, prev_tx_sum(*pindexNew), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n+        pindexNew->m_chain_tx_count = 0;\n     }\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n@@ -3877,15 +3877,15 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n         while (!queue.empty()) {\n             CBlockIndex *pindex = queue.front();\n             queue.pop_front();\n-            // Before setting nChainTx, assert that it is 0 or already set to\n+            // Before setting m_chain_tx_count, assert that it is 0 or already set to\n             // the correct value. This assert will fail after receiving the\n             // assumeutxo snapshot block if assumeutxo snapshot metadata has an\n-            // incorrect hardcoded AssumeutxoData::nChainTx value.\n-            if (!Assume(pindex->nChainTx == 0 || pindex->nChainTx == prev_tx_sum(*pindex))) {\n-                LogWarning(\"Internal bug detected: block %d has unexpected nChainTx %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n-                   pindex->nHeight, pindex->nChainTx, prev_tx_sum(*pindex), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n+            // incorrect hardcoded AssumeutxoData::m_chain_tx_count value.\n+            if (!Assume(pindex->m_chain_tx_count == 0 || pindex->m_chain_tx_count == prev_tx_sum(*pindex))) {\n+                LogWarning(\"Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n+                   pindex->nHeight, pindex->m_chain_tx_count, prev_tx_sum(*pindex), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n             }\n-            pindex->nChainTx = prev_tx_sum(*pindex);\n+            pindex->m_chain_tx_count = prev_tx_sum(*pindex);\n             pindex->nSequenceId = nBlockSequenceId++;\n             for (Chainstate *c : GetAll()) {\n                 c->TryAddBlockIndexCandidate(pindex);\n@@ -5333,17 +5333,17 @@ void ChainstateManager::CheckBlockIndex()\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n         }\n-        // Make sure nChainTx sum is correctly computed.\n+        // Make sure m_chain_tx_count sum is correctly computed.\n         if (!pindex->pprev) {\n-            // If no previous block, nTx and nChainTx must be the same.\n-            assert(pindex->nChainTx == pindex->nTx);\n-        } else if (pindex->pprev->nChainTx > 0 && pindex->nTx > 0) {\n-            // If previous nChainTx is set and number of transactions in block is known, sum must be set.\n-            assert(pindex->nChainTx == pindex->nTx + pindex->pprev->nChainTx);\n+            // If no previous block, nTx and m_chain_tx_count must be the same.\n+            assert(pindex->m_chain_tx_count == pindex->nTx);\n+        } else if (pindex->pprev->m_chain_tx_count > 0 && pindex->nTx > 0) {\n+            // If previous m_chain_tx_count is set and number of transactions in block is known, sum must be set.\n+            assert(pindex->m_chain_tx_count == pindex->nTx + pindex->pprev->m_chain_tx_count);\n         } else {\n-            // Otherwise nChainTx should only be set if this is a snapshot\n+            // Otherwise m_chain_tx_count should only be set if this is a snapshot\n             // block, and must be set if it is.\n-            assert((pindex->nChainTx != 0) == (pindex == snap_base));\n+            assert((pindex->m_chain_tx_count != 0) == (pindex == snap_base));\n         }\n \n         // Chainstate-specific checks on setBlockIndexCandidates\n@@ -5548,13 +5548,13 @@ bool Chainstate::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n }\n \n //! Guess how far we are in the verification process at the given block index\n-//! require cs_main if pindex has not been validated yet (because nChainTx might be unset)\n+//! require cs_main if pindex has not been validated yet (because m_chain_tx_count might be unset)\n double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pindex) {\n     if (pindex == nullptr)\n         return 0.0;\n \n-    if (!Assume(pindex->nChainTx > 0)) {\n-        LogWarning(\"Internal bug detected: block %d has unset nChainTx (%s %s). Please report this issue here: %s\\n\",\n+    if (!Assume(pindex->m_chain_tx_count > 0)) {\n+        LogWarning(\"Internal bug detected: block %d has unset m_chain_tx_count (%s %s). Please report this issue here: %s\\n\",\n                    pindex->nHeight, PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n         return 0.0;\n     }\n@@ -5563,13 +5563,13 @@ double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pin\n \n     double fTxTotal;\n \n-    if (pindex->nChainTx <= data.nTxCount) {\n-        fTxTotal = data.nTxCount + (nNow - data.nTime) * data.dTxRate;\n+    if (pindex->m_chain_tx_count <= data.tx_count) {\n+        fTxTotal = data.tx_count + (nNow - data.nTime) * data.dTxRate;\n     } else {\n-        fTxTotal = pindex->nChainTx + (nNow - pindex->GetBlockTime()) * data.dTxRate;\n+        fTxTotal = pindex->m_chain_tx_count + (nNow - pindex->GetBlockTime()) * data.dTxRate;\n     }\n \n-    return std::min<double>(pindex->nChainTx / fTxTotal, 1.0);\n+    return std::min<double>(pindex->m_chain_tx_count / fTxTotal, 1.0);\n }\n \n std::optional<uint256> ChainstateManager::SnapshotBlockhash() const\n@@ -6026,7 +6026,7 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     assert(index);\n     assert(index == snapshot_start_block);\n-    index->nChainTx = au_data.nChainTx;\n+    index->m_chain_tx_count = au_data.m_chain_tx_count;\n     snapshot_chainstate.setBlockIndexCandidates.insert(snapshot_start_block);\n \n     LogPrintf(\"[snapshot] validated snapshot (%.2f MB)\\n\",\n", "test_patch": "diff --git a/src/test/blockchain_tests.cpp b/src/test/blockchain_tests.cpp\nindex bc509d73acc2f..4ecc15041cc5c 100644\n--- a/src/test/blockchain_tests.cpp\n+++ b/src/test/blockchain_tests.cpp\n@@ -110,4 +110,11 @@ BOOST_FIXTURE_TEST_CASE(get_prune_height, TestChain100Setup)\n     CheckGetPruneHeight(blockman, chain, 100);\n }\n \n+BOOST_AUTO_TEST_CASE(num_chain_tx_max)\n+{\n+    CBlockIndex block_index{};\n+    block_index.m_chain_tx_count = std::numeric_limits<uint64_t>::max();\n+    BOOST_CHECK_EQUAL(block_index.m_chain_tx_count, std::numeric_limits<uint64_t>::max());\n+}\n+\n BOOST_AUTO_TEST_SUITE_END()\ndiff --git a/src/test/fuzz/utxo_snapshot.cpp b/src/test/fuzz/utxo_snapshot.cpp\nindex 60d9d39b73f09..d82f16676537a 100644\n--- a/src/test/fuzz/utxo_snapshot.cpp\n+++ b/src/test/fuzz/utxo_snapshot.cpp\n@@ -113,9 +113,9 @@ FUZZ_TARGET(utxo_snapshot, .init = initialize_chain)\n             if (index->nHeight == chainman.GetSnapshotBaseHeight()) {\n                 auto params{chainman.GetParams().AssumeutxoForHeight(index->nHeight)};\n                 Assert(params.has_value());\n-                Assert(params.value().nChainTx == index->nChainTx);\n+                Assert(params.value().m_chain_tx_count == index->m_chain_tx_count);\n             } else {\n-                Assert(index->nChainTx == 0);\n+                Assert(index->m_chain_tx_count == 0);\n             }\n         }\n         Assert(g_chain->size() == coinscache.GetCacheSize());\ndiff --git a/src/test/pmt_tests.cpp b/src/test/pmt_tests.cpp\nindex edecf70c6f6cc..5b7ccc8e7a105 100644\n--- a/src/test/pmt_tests.cpp\n+++ b/src/test/pmt_tests.cpp\n@@ -29,10 +29,10 @@ BOOST_FIXTURE_TEST_SUITE(pmt_tests, BasicTestingSetup)\n \n BOOST_AUTO_TEST_CASE(pmt_test1)\n {\n-    static const unsigned int nTxCounts[] = {1, 4, 7, 17, 56, 100, 127, 256, 312, 513, 1000, 4095};\n+    static const unsigned int tx_counts[] = {1, 4, 7, 17, 56, 100, 127, 256, 312, 513, 1000, 4095};\n \n     for (int i = 0; i < 12; i++) {\n-        unsigned int nTx = nTxCounts[i];\n+        unsigned int nTx = tx_counts[i];\n \n         // build a block with some dummy transactions\n         CBlock block;\ndiff --git a/src/test/util/chainstate.h b/src/test/util/chainstate.h\nindex a4636365ca3e3..e604b44c16a95 100644\n--- a/src/test/util/chainstate.h\n+++ b/src/test/util/chainstate.h\n@@ -99,7 +99,7 @@ CreateAndActivateUTXOSnapshot(\n                 assert(pindex->IsValid(BlockStatus::BLOCK_VALID_TREE));\n                 pindex->nStatus = BlockStatus::BLOCK_VALID_TREE;\n                 pindex->nTx = 0;\n-                pindex->nChainTx = 0;\n+                pindex->m_chain_tx_count = 0;\n                 pindex->nSequenceId = 0;\n                 pindex = pindex->pprev;\n             }\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\nindex f93e3cdfb1b77..cf819f8751dd8 100644\n--- a/src/test/validation_chainstatemanager_tests.cpp\n+++ b/src/test/validation_chainstatemanager_tests.cpp\n@@ -285,7 +285,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         const auto& au_data = ::Params().AssumeutxoForHeight(snapshot_height);\n         const CBlockIndex* tip = WITH_LOCK(chainman.GetMutex(), return chainman.ActiveTip());\n \n-        BOOST_CHECK_EQUAL(tip->nChainTx, au_data->nChainTx);\n+        BOOST_CHECK_EQUAL(tip->m_chain_tx_count, au_data->m_chain_tx_count);\n \n         // To be checked against later when we try loading a subsequent snapshot.\n         uint256 loaded_snapshot_blockhash{*chainman.SnapshotBlockhash()};\n@@ -465,7 +465,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         if (i < last_assumed_valid_idx && i >= assumed_valid_start_idx) {\n             index->nStatus = BlockStatus::BLOCK_VALID_TREE;\n             index->nTx = 0;\n-            index->nChainTx = 0;\n+            index->m_chain_tx_count = 0;\n         }\n \n         ++num_indexes;\ndiff --git a/src/test/validation_tests.cpp b/src/test/validation_tests.cpp\nindex 93a884be6d3d7..546d2f7b4d55b 100644\n--- a/src/test/validation_tests.cpp\n+++ b/src/test/validation_tests.cpp\n@@ -143,11 +143,11 @@ BOOST_AUTO_TEST_CASE(test_assumeutxo)\n \n     const auto out110 = *params->AssumeutxoForHeight(110);\n     BOOST_CHECK_EQUAL(out110.hash_serialized.ToString(), \"6657b736d4fe4db0cbc796789e812d5dba7f5c143764b1b6905612f1830609d1\");\n-    BOOST_CHECK_EQUAL(out110.nChainTx, 111U);\n+    BOOST_CHECK_EQUAL(out110.m_chain_tx_count, 111U);\n \n     const auto out110_2 = *params->AssumeutxoForBlockhash(uint256S(\"0x696e92821f65549c7ee134edceeeeaaa4105647a3c4fd9f298c0aec0ab50425c\"));\n     BOOST_CHECK_EQUAL(out110_2.hash_serialized.ToString(), \"6657b736d4fe4db0cbc796789e812d5dba7f5c143764b1b6905612f1830609d1\");\n-    BOOST_CHECK_EQUAL(out110_2.nChainTx, 111U);\n+    BOOST_CHECK_EQUAL(out110_2.m_chain_tx_count, 111U);\n }\n \n BOOST_AUTO_TEST_CASE(block_malleation)\n", "problem_statement": "Update nChainTx to 64bit type\nhttps://github.com/bitcoin/bitcoin/blob/8106b268cde8e97a7c330afdda39b6bb55e5574a/src/chain.h#L178-L186\r\n\r\nHey, it's 2024! `nChainTx` seems to currently be 953368191 (height 826100), which is hex `38d3 3e7f`, so we're only 22% of the way to an overflow, and would still need another 200k blocks (~ four years) full of 60 byte transactions to get there.\n", "hints_text": "Background: https://github.com/bitcoin/bitcoin/pull/13875 and https://github.com/bitcoin/bitcoin/pull/1677\nWould this be a hard fork because it would be loosening the conditions for validation?\n> Would this be a hard fork because it would be loosening the conditions for validation?\r\n\r\nI don't think so, since I don't think the value of `nChainTx` is used in validation (or do you see a spot where it is?). It's used for logging (progress estimation), and whether it is 0 is used in `HaveNumChainTxs`. The latter could become problematic in case of an overflow, since if the `unsigned int` would overflow exactly to zero (which is a bit unlikely given that there are a few thousand txns in each block but ceratainly possible) the node would crash in https://github.com/bitcoin/bitcoin/blob/478ac185be49feffd1231366c07e06068683f941/src/validation.cpp#L3017.\n^^^ The above was the line that I was referencing. Thank you. \nThere was also the idea of dropping this number entirely: https://github.com/bitcoin/bitcoin/pull/13875#issuecomment-410472259\r\n\r\nThough see also https://github.com/bitcoin/bitcoin/pull/13875#issuecomment-750715082\n> Though see also https://github.com/bitcoin/bitcoin/pull/13875#issuecomment-750715082\r\n\r\nThis is `nTx`, not `nChainTx`.\nFor reference, I removed `nChainTx` from consensus in https://github.com/bitcoin/bitcoin/pull/29349. The next steps would be to add a member to `CChain` to account for the sum of `nTx`, and update it when `SetTip` is called. Then, update the RPC, wallet and estimate functions to derive the `nChainTx` they need from the `nChainTx` at the tip, walking the relevant portion of the chain.\r\n\r\nThis is possible, but I am not sure if it is worth it, because:\r\n\r\n* It is more code overall.\r\n* The RPC, wallet, and logging code is slower when it has to walk the chain.\r\n\r\nThe benefit mainly seems to be to reduce the memory footprint? On 64-bit platforms, `sizeof(CBlockIndex)` is 144. Adding 4 bytes or removing 4 bytes is less than 10% of cost or savings. Ref: https://godbolt.org/z/rKEPYTh4j\r\n\r\nRemoving `nTx` is even harder, so less worth it. Especially, given that it could be reduced to 16 bits in the memory layout, if needed.\r\n\r\nThis leads to an alternative solution to not increase the memory footprint: Move the 32+32 bits used for nTx and nChainTx into a single 64-bit blob, where the 16 bit are for nTx and the remaining for nChainTx. But, again, the overall heap memory usage shouldn't change much, either way.\n> This leads to an alternative solution to not increase the memory footprint: Move the 32+32 bits used for nTx and nChainTx into a single 64-bit blob, where the 16 bit are for nTx and the remaining for nChainTx. But, again, the overall heap memory usage shouldn't change much, either way.\r\n\r\nThis does seem like an nice and easy solution. Would be good to incorporate in #29331\r\n\r\nAs a tangent, I was thinking along the same lines last week before implementing #29370 and came up with worse solution, taking advantage of the fact that when `nChainTx` is set, you can derive `nTx` by subtracting `nChainTx - pprev->nChainTx`. In case it's interesting:\r\n\r\n<details><summary>nChainTx hack</summary>\r\n<p>\r\n\r\n```c++\r\nclass CBlockIndex\r\n{\r\npublic:\r\n    CBlockIndex* pprev{nullptr};\r\n\r\n    // Indicate whether num_tx_value contains total number of transactions in\r\n    // this block, or total number of transactions in the chain up and including\r\n    // this block.\r\n    enum NumTxType { UNSET = 0, BLOCK_TX = 1, CHAIN_TX = 2 };\r\n    NumTxType num_tx_type : 4 {UNSET};\r\n    uint64_t num_tx_value : 60;\r\n\r\n    uint64_t NumBlockTx()\r\n    {\r\n        if (num_tx_type == BLOCK_TX) return num_tx_value;\r\n        if (num_tx_type == CHAIN_TX) {\r\n            assert(pprev && pprev->num_tx_type == CHAIN_TX);\r\n            return num_tx_value - pprev->num_tx_value;\r\n        }\r\n        return 0;\r\n    }\r\n\r\n    uint64_t NumChainTx()\r\n    {\r\n        return num_tx_type == CHAIN_TX ? num_tx_value : 0;\r\n    }\r\n};\r\n```\r\n\r\n\n> This does seem like an nice and easy solution. Would be good to incorporate in #29331\r\n\r\nNot sure if it so easy. On 32-bit platforms, `nTx` currently starts at byte 60, so making it 16-bit will still eat 32-bit with padding. So forcing a 64-bit blob of both values is needed, but that requires changing all code that uses either field. Not sure if worth it for a +-5% memory difference?\n> Not sure if it so easy. On 32-bit platforms, `nTx` currently starts at byte 60, so making it 16-bit will still eat 32-bit with padding.\r\n\r\nI didn't test on a 32-bit platform, but aren't bitfields a good solution to this? The following seems to work for me, increasing `nChainTx` range without increasing `CBlockIndex` size on x86_64 (144 bytes):\r\n\r\n\r\n<details><summary>diff</summary>\r\n<p>\r\n\r\n```diff\r\n--- a/src/chain.h\r\n+++ b/src/chain.h\r\n@@ -178,7 +178,7 @@ public:\r\n     //! Note: this value is faked during UTXO snapshot load to ensure that\r\n     //! LoadBlockIndex() will load index entries for blocks that we lack data for.\r\n     //! @sa ActivateSnapshot\r\n-    unsigned int nTx{0};\r\n+    uint16_t nTx : 16 {0};\r\n \r\n     //! (memory only) Number of transactions in the chain up to and including this block.\r\n     //! This value will be non-zero only if and only if transactions for this block and all its parents are available.\r\n@@ -188,7 +188,7 @@ public:\r\n     //! have the underlying block data available during snapshot load.\r\n     //! @sa AssumeutxoData\r\n     //! @sa ActivateSnapshot\r\n-    unsigned int nChainTx{0};\r\n+    uint64_t nChainTx : 48 {0};\r\n \r\n     //! Verification status of this block. See enum BlockStatus\r\n     //!\r\n@@ -412,7 +412,12 @@ public:\r\n \r\n         READWRITE(VARINT_MODE(obj.nHeight, VarIntMode::NONNEGATIVE_SIGNED));\r\n         READWRITE(VARINT(obj.nStatus));\r\n-        READWRITE(VARINT(obj.nTx));\r\n+\r\n+        unsigned int num_tx;\r\n+        SER_WRITE(obj, num_tx = obj.nTx);\r\n+        READWRITE(VARINT(num_tx));\r\n+        SER_READ(obj, obj.nTx = num_tx);\r\n+\r\n         if (obj.nStatus & (BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO)) READWRITE(VARINT_MODE(obj.nFile, VarIntMode::NONNEGATIVE_SIGNED));\r\n         if (obj.nStatus & BLOCK_HAVE_DATA) READWRITE(VARINT(obj.nDataPos));\r\n         if (obj.nStatus & BLOCK_HAVE_UNDO) READWRITE(VARINT(obj.nUndoPos));\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -5119,7 +5119,7 @@ double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pin\r\n \r\n     double fTxTotal;\r\n \r\n-    if (pindex->nChainTx <= data.nTxCount) {\r\n+    if (static_cast<int64_t>(pindex->nChainTx) <= data.nTxCount) {\r\n         fTxTotal = data.nTxCount + (nNow - data.nTime) * data.dTxRate;\r\n     } else {\r\n         fTxTotal = pindex->nChainTx + (nNow - pindex->GetBlockTime()) * data.dTxRate;\r\n```\r\n\r\n\n> bitfields\r\n\r\nJup, that didn't work for me. Or maybe I did something wrong. See https://godbolt.org/z/z6EoWKbjY\r\n\r\n```\r\n   60:0-15 |   int16_t nTx\r\n   64:0-47 |   int64_t nChainTx\r\n```\r\n\r\n(nTx eats byte 60-64, even though it is only a two byte bitfield)\n> Jup, that didn't work for me. Or maybe I did something wrong. See https://godbolt.org/z/z6EoWKbjY\r\n\r\nIt's not that surprising that the compiler adds padding so the struct member with uint64_t type is inside a field aligned to 8 bytes. But if you move the two bitfield members to begin on an 8 byte boundary (like between the nDataPos and nUndoPos fields, or to the beginning of the struct, it does get packed without extra padding). So I think the diff above is an easy way to avoid consuming extra memory on 64 bit platforms, even though we could go further with more changes to get the same optimization on 32 bit.\n> > bitfields\r\n> \r\n> Jup, that didn't work for me. Or maybe I did something wrong. See https://godbolt.org/z/z6EoWKbjY\r\n> \r\n> ```\r\n>    60:0-15 |   int16_t nTx\r\n>    64:0-47 |   int64_t nChainTx\r\n> ```\r\n> \r\n> (nTx eats byte 60-64, even though it is only a two byte bitfield)\r\n\r\nI think the problem here is you have an odd number of 32-bit pointers prior to `nTx`, so it's misaligned to be combined with `nChainTx`. So you end up with `nTx [4B-6B padding] nChainTx nStatus [4B padding]`. Moving `nStatus` prior to `nTx` gives an even number of 32-bit objects prior to `nTx`, so drops the size back down.\nWhen updating this should also update the type of the `AssumeutxoData::nChainTx` field:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/1cd2e29870e4ad3b7c57b1d567df0e6df56572b0/src/kernel/chainparams.h#L57", "created_at": "2024-03-14 23:34:35", "merge_commit_sha": "1a19a4d960eed040ab9e97532596c612ef8a60cc", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-29612", "base_commit": "a786fd2041913d82ca90b561de309421bd24e41b", "patch": "diff --git a/src/kernel/chainparams.cpp b/src/kernel/chainparams.cpp\nindex 26c261eba2725..de142cd2c9189 100644\n--- a/src/kernel/chainparams.cpp\n+++ b/src/kernel/chainparams.cpp\n@@ -542,3 +542,33 @@ std::unique_ptr<const CChainParams> CChainParams::TestNet()\n {\n     return std::make_unique<const CTestNetParams>();\n }\n+\n+std::vector<int> CChainParams::GetAvailableSnapshotHeights() const\n+{\n+    std::vector<int> heights;\n+    heights.reserve(m_assumeutxo_data.size());\n+\n+    for (const auto& data : m_assumeutxo_data) {\n+        heights.emplace_back(data.height);\n+    }\n+    return heights;\n+}\n+\n+std::optional<ChainType> GetNetworkForMagic(MessageStartChars& message)\n+{\n+    const auto mainnet_msg = CChainParams::Main()->MessageStart();\n+    const auto testnet_msg = CChainParams::TestNet()->MessageStart();\n+    const auto regtest_msg = CChainParams::RegTest({})->MessageStart();\n+    const auto signet_msg = CChainParams::SigNet({})->MessageStart();\n+\n+    if (std::equal(message.begin(), message.end(), mainnet_msg.data())) {\n+        return ChainType::MAIN;\n+    } else if (std::equal(message.begin(), message.end(), testnet_msg.data())) {\n+        return ChainType::TESTNET;\n+    } else if (std::equal(message.begin(), message.end(), regtest_msg.data())) {\n+        return ChainType::REGTEST;\n+    } else if (std::equal(message.begin(), message.end(), signet_msg.data())) {\n+        return ChainType::SIGNET;\n+    }\n+    return std::nullopt;\n+}\ndiff --git a/src/kernel/chainparams.h b/src/kernel/chainparams.h\nindex 7a5539bc71c54..f396c1b42caee 100644\n--- a/src/kernel/chainparams.h\n+++ b/src/kernel/chainparams.h\n@@ -93,6 +93,7 @@ class CChainParams\n     const Consensus::Params& GetConsensus() const { return consensus; }\n     const MessageStartChars& MessageStart() const { return pchMessageStart; }\n     uint16_t GetDefaultPort() const { return nDefaultPort; }\n+    std::vector<int> GetAvailableSnapshotHeights() const;\n \n     const CBlock& GenesisBlock() const { return genesis; }\n     /** Default value for -checkmempool and -checkblockindex argument */\n@@ -183,4 +184,6 @@ class CChainParams\n     ChainTxData chainTxData;\n };\n \n+std::optional<ChainType> GetNetworkForMagic(MessageStartChars& pchMessageStart);\n+\n #endif // BITCOIN_KERNEL_CHAINPARAMS_H\ndiff --git a/src/node/utxo_snapshot.h b/src/node/utxo_snapshot.h\nindex 1160bb55f0762..256a4a601d32f 100644\n--- a/src/node/utxo_snapshot.h\n+++ b/src/node/utxo_snapshot.h\n@@ -6,16 +6,22 @@\n #ifndef BITCOIN_NODE_UTXO_SNAPSHOT_H\n #define BITCOIN_NODE_UTXO_SNAPSHOT_H\n \n+#include <chainparams.h>\n+#include <kernel/chainparams.h>\n #include <kernel/cs_main.h>\n #include <serialize.h>\n #include <sync.h>\n #include <uint256.h>\n+#include <util/chaintype.h>\n #include <util/fs.h>\n \n #include <cstdint>\n #include <optional>\n #include <string_view>\n \n+// UTXO set snapshot magic bytes\n+static constexpr std::array<uint8_t, 5> SNAPSHOT_MAGIC_BYTES = {'u', 't', 'x', 'o', 0xff};\n+\n class Chainstate;\n \n namespace node {\n@@ -23,10 +29,14 @@ namespace node {\n //! assumeutxo Chainstate can be constructed.\n class SnapshotMetadata\n {\n+    const uint16_t m_version{1};\n+    const std::set<uint16_t> m_supported_versions{1};\n public:\n     //! The hash of the block that reflects the tip of the chain for the\n     //! UTXO set contained in this snapshot.\n     uint256 m_base_blockhash;\n+    uint32_t m_base_blockheight;\n+\n \n     //! The number of coins in the UTXO set contained in this snapshot. Used\n     //! during snapshot load to estimate progress of UTXO set reconstruction.\n@@ -35,11 +45,55 @@ class SnapshotMetadata\n     SnapshotMetadata() { }\n     SnapshotMetadata(\n         const uint256& base_blockhash,\n+        const int base_blockheight,\n         uint64_t coins_count) :\n             m_base_blockhash(base_blockhash),\n+            m_base_blockheight(base_blockheight),\n             m_coins_count(coins_count) { }\n \n-    SERIALIZE_METHODS(SnapshotMetadata, obj) { READWRITE(obj.m_base_blockhash, obj.m_coins_count); }\n+    template <typename Stream>\n+    inline void Serialize(Stream& s) const {\n+        s << SNAPSHOT_MAGIC_BYTES;\n+        s << m_version;\n+        s << Params().MessageStart();\n+        s << m_base_blockheight;\n+        s << m_base_blockhash;\n+        s << m_coins_count;\n+    }\n+\n+    template <typename Stream>\n+    inline void Unserialize(Stream& s) {\n+        // Read the snapshot magic bytes\n+        std::array<uint8_t, SNAPSHOT_MAGIC_BYTES.size()> snapshot_magic;\n+        s >> snapshot_magic;\n+        if (snapshot_magic != SNAPSHOT_MAGIC_BYTES) {\n+            throw std::ios_base::failure(\"Invalid UTXO set snapshot magic bytes. Please check if this is indeed a snapshot file or if you are using an outdated snapshot format.\");\n+        }\n+\n+        // Read the version\n+        uint16_t version;\n+        s >> version;\n+        if (m_supported_versions.find(version) == m_supported_versions.end()) {\n+            throw std::ios_base::failure(strprintf(\"Version of snapshot %s does not match any of the supported versions.\", version));\n+        }\n+\n+        // Read the network magic (pchMessageStart)\n+        MessageStartChars message;\n+        s >> message;\n+        if (!std::equal(message.begin(), message.end(), Params().MessageStart().data())) {\n+            auto metadata_network = GetNetworkForMagic(message);\n+            if (metadata_network) {\n+                std::string network_string{ChainTypeToString(metadata_network.value())};\n+                throw std::ios_base::failure(strprintf(\"The network of the snapshot (%s) does not match the network of this node (%s).\", network_string, Params().GetChainTypeString()));\n+            } else {\n+                throw std::ios_base::failure(\"This snapshot has been created for an unrecognized network. This could be a custom signet, a new testnet or possibly caused by data corruption.\");\n+            }\n+        }\n+\n+        s >> m_base_blockheight;\n+        s >> m_base_blockhash;\n+        s >> m_coins_count;\n+    }\n };\n \n //! The file in the snapshot chainstate dir which stores the base blockhash. This is\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex eed004806a83b..f429826fcbe44 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -34,6 +34,7 @@\n #include <rpc/server_util.h>\n #include <rpc/util.h>\n #include <script/descriptor.h>\n+#include <serialize.h>\n #include <streams.h>\n #include <sync.h>\n #include <txdb.h>\n@@ -2690,29 +2691,60 @@ UniValue CreateUTXOSnapshot(\n         tip->nHeight, tip->GetBlockHash().ToString(),\n         fs::PathToString(path), fs::PathToString(temppath)));\n \n-    SnapshotMetadata metadata{tip->GetBlockHash(), maybe_stats->coins_count};\n+    SnapshotMetadata metadata{tip->GetBlockHash(), tip->nHeight, maybe_stats->coins_count};\n \n     afile << metadata;\n \n     COutPoint key;\n+    Txid last_hash;\n     Coin coin;\n     unsigned int iter{0};\n+    size_t written_coins_count{0};\n+    std::vector<std::pair<uint32_t, Coin>> coins;\n+\n+    // To reduce space the serialization format of the snapshot avoids\n+    // duplication of tx hashes. The code takes advantage of the guarantee by\n+    // leveldb that keys are lexicographically sorted.\n+    // In the coins vector we collect all coins that belong to a certain tx hash\n+    // (key.hash) and when we have them all (key.hash != last_hash) we write\n+    // them to file using the below lambda function.\n+    // See also https://github.com/bitcoin/bitcoin/issues/25675\n+    auto write_coins_to_file = [&](AutoFile& afile, const Txid& last_hash, const std::vector<std::pair<uint32_t, Coin>>& coins, size_t& written_coins_count) {\n+        afile << last_hash;\n+        WriteCompactSize(afile, coins.size());\n+        for (const auto& [n, coin] : coins) {\n+            WriteCompactSize(afile, n);\n+            afile << coin;\n+            ++written_coins_count;\n+        }\n+    };\n \n+    pcursor->GetKey(key);\n+    last_hash = key.hash;\n     while (pcursor->Valid()) {\n         if (iter % 5000 == 0) node.rpc_interruption_point();\n         ++iter;\n         if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n-            afile << key;\n-            afile << coin;\n+            if (key.hash != last_hash) {\n+                write_coins_to_file(afile, last_hash, coins, written_coins_count);\n+                last_hash = key.hash;\n+                coins.clear();\n+            }\n+            coins.emplace_back(key.n, coin);\n         }\n-\n         pcursor->Next();\n     }\n \n+    if (!coins.empty()) {\n+        write_coins_to_file(afile, last_hash, coins, written_coins_count);\n+    }\n+\n+    CHECK_NONFATAL(written_coins_count == maybe_stats->coins_count);\n+\n     afile.fclose();\n \n     UniValue result(UniValue::VOBJ);\n-    result.pushKV(\"coins_written\", maybe_stats->coins_count);\n+    result.pushKV(\"coins_written\", written_coins_count);\n     result.pushKV(\"base_hash\", tip->GetBlockHash().ToString());\n     result.pushKV(\"base_height\", tip->nHeight);\n     result.pushKV(\"path\", path.utf8string());\n@@ -2772,12 +2804,22 @@ static RPCHelpMan loadtxoutset()\n     }\n \n     SnapshotMetadata metadata;\n-    afile >> metadata;\n+    try {\n+        afile >> metadata;\n+    } catch (const std::ios_base::failure& e) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, strprintf(\"Unable to parse metadata: %s\", e.what()));\n+    }\n \n     uint256 base_blockhash = metadata.m_base_blockhash;\n+    int base_blockheight = metadata.m_base_blockheight;\n     if (!chainman.GetParams().AssumeutxoForBlockhash(base_blockhash).has_value()) {\n+        auto available_heights = chainman.GetParams().GetAvailableSnapshotHeights();\n+        std::string heights_formatted = Join(available_heights, \", \", [&](const auto& i) { return ToString(i); });\n         throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to load UTXO snapshot, \"\n-            \"assumeutxo block hash in snapshot metadata not recognized (%s)\", base_blockhash.ToString()));\n+            \"assumeutxo block hash in snapshot metadata not recognized (hash: %s, height: %s). The following snapshot heights are available: %s.\",\n+            base_blockhash.ToString(),\n+            base_blockheight,\n+            heights_formatted));\n     }\n     CBlockIndex* snapshot_start_block = WITH_LOCK(::cs_main,\n             return chainman.m_blockman.LookupBlockIndex(base_blockhash));\ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex f57851b4f7e01..e6199e5cf96f0 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -5660,69 +5660,81 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n         return false;\n     }\n \n-    COutPoint outpoint;\n-    Coin coin;\n     const uint64_t coins_count = metadata.m_coins_count;\n     uint64_t coins_left = metadata.m_coins_count;\n \n-    LogPrintf(\"[snapshot] loading coins from snapshot %s\\n\", base_blockhash.ToString());\n+    LogPrintf(\"[snapshot] loading %d coins from snapshot %s\\n\", coins_left, base_blockhash.ToString());\n     int64_t coins_processed{0};\n \n     while (coins_left > 0) {\n         try {\n-            coins_file >> outpoint;\n-            coins_file >> coin;\n-        } catch (const std::ios_base::failure&) {\n-            LogPrintf(\"[snapshot] bad snapshot format or truncated snapshot after deserializing %d coins\\n\",\n-                      coins_count - coins_left);\n-            return false;\n-        }\n-        if (coin.nHeight > base_height ||\n-            outpoint.n >= std::numeric_limits<decltype(outpoint.n)>::max() // Avoid integer wrap-around in coinstats.cpp:ApplyHash\n-        ) {\n-            LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins\\n\",\n-                      coins_count - coins_left);\n-            return false;\n-        }\n-        if (!MoneyRange(coin.out.nValue)) {\n-            LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins - bad tx out value\\n\",\n-                      coins_count - coins_left);\n-            return false;\n-        }\n+            Txid txid;\n+            coins_file >> txid;\n+            size_t coins_per_txid{0};\n+            coins_per_txid = ReadCompactSize(coins_file);\n+\n+            if (coins_per_txid > coins_left) {\n+                LogPrintf(\"[snapshot] mismatch in coins count in snapshot metadata and actual snapshot data\\n\");\n+                return false;\n+            }\n \n-        coins_cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            for (size_t i = 0; i < coins_per_txid; i++) {\n+                COutPoint outpoint;\n+                Coin coin;\n+                outpoint.n = static_cast<uint32_t>(ReadCompactSize(coins_file));\n+                outpoint.hash = txid;\n+                coins_file >> coin;\n+                if (coin.nHeight > base_height ||\n+                    outpoint.n >= std::numeric_limits<decltype(outpoint.n)>::max() // Avoid integer wrap-around in coinstats.cpp:ApplyHash\n+                ) {\n+                    LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins\\n\",\n+                              coins_count - coins_left);\n+                    return false;\n+                }\n+                if (!MoneyRange(coin.out.nValue)) {\n+                    LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins - bad tx out value\\n\",\n+                              coins_count - coins_left);\n+                    return false;\n+                }\n+                coins_cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n \n-        --coins_left;\n-        ++coins_processed;\n+                --coins_left;\n+                ++coins_processed;\n \n-        if (coins_processed % 1000000 == 0) {\n-            LogPrintf(\"[snapshot] %d coins loaded (%.2f%%, %.2f MB)\\n\",\n-                coins_processed,\n-                static_cast<float>(coins_processed) * 100 / static_cast<float>(coins_count),\n-                coins_cache.DynamicMemoryUsage() / (1000 * 1000));\n-        }\n+                if (coins_processed % 1000000 == 0) {\n+                    LogPrintf(\"[snapshot] %d coins loaded (%.2f%%, %.2f MB)\\n\",\n+                        coins_processed,\n+                        static_cast<float>(coins_processed) * 100 / static_cast<float>(coins_count),\n+                        coins_cache.DynamicMemoryUsage() / (1000 * 1000));\n+                }\n \n-        // Batch write and flush (if we need to) every so often.\n-        //\n-        // If our average Coin size is roughly 41 bytes, checking every 120,000 coins\n-        // means <5MB of memory imprecision.\n-        if (coins_processed % 120000 == 0) {\n-            if (m_interrupt) {\n-                return false;\n-            }\n+                // Batch write and flush (if we need to) every so often.\n+                //\n+                // If our average Coin size is roughly 41 bytes, checking every 120,000 coins\n+                // means <5MB of memory imprecision.\n+                if (coins_processed % 120000 == 0) {\n+                    if (m_interrupt) {\n+                        return false;\n+                    }\n \n-            const auto snapshot_cache_state = WITH_LOCK(::cs_main,\n-                return snapshot_chainstate.GetCoinsCacheSizeState());\n+                    const auto snapshot_cache_state = WITH_LOCK(::cs_main,\n+                        return snapshot_chainstate.GetCoinsCacheSizeState());\n \n-            if (snapshot_cache_state >= CoinsCacheSizeState::CRITICAL) {\n-                // This is a hack - we don't know what the actual best block is, but that\n-                // doesn't matter for the purposes of flushing the cache here. We'll set this\n-                // to its correct value (`base_blockhash`) below after the coins are loaded.\n-                coins_cache.SetBestBlock(GetRandHash());\n+                    if (snapshot_cache_state >= CoinsCacheSizeState::CRITICAL) {\n+                        // This is a hack - we don't know what the actual best block is, but that\n+                        // doesn't matter for the purposes of flushing the cache here. We'll set this\n+                        // to its correct value (`base_blockhash`) below after the coins are loaded.\n+                        coins_cache.SetBestBlock(GetRandHash());\n \n-                // No need to acquire cs_main since this chainstate isn't being used yet.\n-                FlushSnapshotToDisk(coins_cache, /*snapshot_loaded=*/false);\n+                        // No need to acquire cs_main since this chainstate isn't being used yet.\n+                        FlushSnapshotToDisk(coins_cache, /*snapshot_loaded=*/false);\n+                    }\n+                }\n             }\n+        } catch (const std::ios_base::failure&) {\n+            LogPrintf(\"[snapshot] bad snapshot format or truncated snapshot after deserializing %d coins\\n\",\n+                      coins_processed);\n+            return false;\n         }\n     }\n \n@@ -5735,7 +5747,8 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     bool out_of_coins{false};\n     try {\n-        coins_file >> outpoint;\n+        Txid txid;\n+        coins_file >> txid;\n     } catch (const std::ios_base::failure&) {\n         // We expect an exception since we should be out of coins.\n         out_of_coins = true;\ndiff --git a/src/validation.h b/src/validation.h\nindex 28b045fe80cab..ea6b6cad7e26a 100644\n--- a/src/validation.h\n+++ b/src/validation.h\n@@ -885,6 +885,12 @@ class ChainstateManager\n     CBlockIndex* m_best_invalid GUARDED_BY(::cs_main){nullptr};\n \n     //! Internal helper for ActivateSnapshot().\n+    //!\n+    //! De-serialization of a snapshot that is created with\n+    //! CreateUTXOSnapshot() in rpc/blockchain.cpp.\n+    //! To reduce space the serialization format of the snapshot avoids\n+    //! duplication of tx hashes. The code takes advantage of the guarantee by\n+    //! leveldb that keys are lexicographically sorted.\n     [[nodiscard]] bool PopulateAndValidateSnapshot(\n         Chainstate& snapshot_chainstate,\n         AutoFile& coins_file,\n", "test_patch": "diff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\nindex 4bf66a55ebf91..1f6b7368a20c9 100644\n--- a/src/test/validation_chainstatemanager_tests.cpp\n+++ b/src/test/validation_chainstatemanager_tests.cpp\n@@ -226,10 +226,13 @@ struct SnapshotTestSetup : TestChain100Setup {\n                 // A UTXO is missing but count is correct\n                 metadata.m_coins_count -= 1;\n \n-                COutPoint outpoint;\n+                Txid txid;\n+                auto_infile >> txid;\n+                // coins size\n+                (void)ReadCompactSize(auto_infile);\n+                // vout index\n+                (void)ReadCompactSize(auto_infile);\n                 Coin coin;\n-\n-                auto_infile >> outpoint;\n                 auto_infile >> coin;\n         }));\n \ndiff --git a/test/functional/feature_assumeutxo.py b/test/functional/feature_assumeutxo.py\nindex 2842d82d804ae..bb5ee6815abdd 100755\n--- a/test/functional/feature_assumeutxo.py\n+++ b/test/functional/feature_assumeutxo.py\n@@ -75,41 +75,75 @@ def expected_error(log_msg=\"\", rpc_details=\"\"):\n             with self.nodes[1].assert_debug_log([log_msg]):\n                 assert_raises_rpc_error(-32603, f\"Unable to load UTXO snapshot{rpc_details}\", self.nodes[1].loadtxoutset, bad_snapshot_path)\n \n+        self.log.info(\"  - snapshot file with invalid file magic\")\n+        parsing_error_code = -22\n+        bad_magic = 0xf00f00f000\n+        with open(bad_snapshot_path, 'wb') as f:\n+            f.write(bad_magic.to_bytes(5, \"big\") + valid_snapshot_contents[5:])\n+        assert_raises_rpc_error(parsing_error_code, \"Unable to parse metadata: Invalid UTXO set snapshot magic bytes. Please check if this is indeed a snapshot file or if you are using an outdated snapshot format.\", self.nodes[1].loadtxoutset, bad_snapshot_path)\n+\n+        self.log.info(\"  - snapshot file with unsupported version\")\n+        for version in [0, 2]:\n+            with open(bad_snapshot_path, 'wb') as f:\n+                f.write(valid_snapshot_contents[:5] + version.to_bytes(2, \"little\") + valid_snapshot_contents[7:])\n+            assert_raises_rpc_error(parsing_error_code, f\"Unable to parse metadata: Version of snapshot {version} does not match any of the supported versions.\", self.nodes[1].loadtxoutset, bad_snapshot_path)\n+\n+        self.log.info(\"  - snapshot file with mismatching network magic\")\n+        invalid_magics = [\n+            # magic, name, real\n+            [0xf9beb4d9, \"main\", True],\n+            [0x0b110907, \"test\", True],\n+            [0x0a03cf40, \"signet\", True],\n+            [0x00000000, \"\", False],\n+            [0xffffffff, \"\", False],\n+        ]\n+        for [magic, name, real] in invalid_magics:\n+            with open(bad_snapshot_path, 'wb') as f:\n+                f.write(valid_snapshot_contents[:7] + magic.to_bytes(4, 'big') + valid_snapshot_contents[11:])\n+            if real:\n+                assert_raises_rpc_error(parsing_error_code, f\"Unable to parse metadata: The network of the snapshot ({name}) does not match the network of this node (regtest).\", self.nodes[1].loadtxoutset, bad_snapshot_path)\n+            else:\n+                assert_raises_rpc_error(parsing_error_code, \"Unable to parse metadata: This snapshot has been created for an unrecognized network. This could be a custom signet, a new testnet or possibly caused by data corruption.\", self.nodes[1].loadtxoutset, bad_snapshot_path)\n+\n         self.log.info(\"  - snapshot file referring to a block that is not in the assumeutxo parameters\")\n         prev_block_hash = self.nodes[0].getblockhash(SNAPSHOT_BASE_HEIGHT - 1)\n         bogus_block_hash = \"0\" * 64  # Represents any unknown block hash\n+        # The height is not used for anything critical currently, so we just\n+        # confirm the manipulation in the error message\n+        bogus_height = 1337\n         for bad_block_hash in [bogus_block_hash, prev_block_hash]:\n             with open(bad_snapshot_path, 'wb') as f:\n-                # block hash of the snapshot base is stored right at the start (first 32 bytes)\n-                f.write(bytes.fromhex(bad_block_hash)[::-1] + valid_snapshot_contents[32:])\n-            error_details = f\", assumeutxo block hash in snapshot metadata not recognized ({bad_block_hash})\"\n+                f.write(valid_snapshot_contents[:11] + bogus_height.to_bytes(4, \"little\") + bytes.fromhex(bad_block_hash)[::-1] + valid_snapshot_contents[47:])\n+            error_details = f\", assumeutxo block hash in snapshot metadata not recognized (hash: {bad_block_hash}, height: {bogus_height}). The following snapshot heights are available: 110, 299.\"\n             expected_error(rpc_details=error_details)\n \n         self.log.info(\"  - snapshot file with wrong number of coins\")\n-        valid_num_coins = int.from_bytes(valid_snapshot_contents[32:32 + 8], \"little\")\n+        valid_num_coins = int.from_bytes(valid_snapshot_contents[47:47 + 8], \"little\")\n         for off in [-1, +1]:\n             with open(bad_snapshot_path, 'wb') as f:\n-                f.write(valid_snapshot_contents[:32])\n+                f.write(valid_snapshot_contents[:47])\n                 f.write((valid_num_coins + off).to_bytes(8, \"little\"))\n-                f.write(valid_snapshot_contents[32 + 8:])\n+                f.write(valid_snapshot_contents[47 + 8:])\n             expected_error(log_msg=f\"bad snapshot - coins left over after deserializing 298 coins\" if off == -1 else f\"bad snapshot format or truncated snapshot after deserializing 299 coins\")\n \n-        self.log.info(\"  - snapshot file with alternated UTXO data\")\n+        self.log.info(\"  - snapshot file with alternated but parsable UTXO data results in different hash\")\n         cases = [\n             # (content, offset, wrong_hash, custom_message)\n             [b\"\\xff\" * 32, 0, \"7d52155c9a9fdc4525b637ef6170568e5dad6fabd0b1fdbb9432010b8453095b\", None],  # wrong outpoint hash\n-            [(1).to_bytes(4, \"little\"), 32, \"9f4d897031ab8547665b4153317ae2fdbf0130c7840b66427ebc48b881cb80ad\", None],  # wrong outpoint index\n-            [b\"\\x81\", 36, \"3da966ba9826fb6d2604260e01607b55ba44e1a5de298606b08704bc62570ea8\", None],  # wrong coin code VARINT\n-            [b\"\\x80\", 36, \"091e893b3ccb4334378709578025356c8bcb0a623f37c7c4e493133c988648e5\", None],  # another wrong coin code\n-            [b\"\\x84\\x58\", 36, None, \"[snapshot] bad snapshot data after deserializing 0 coins\"],  # wrong coin case with height 364 and coinbase 0\n-            [b\"\\xCA\\xD2\\x8F\\x5A\", 41, None, \"[snapshot] bad snapshot data after deserializing 0 coins - bad tx out value\"],  # Amount exceeds MAX_MONEY\n+            [(2).to_bytes(1, \"little\"), 32, None, \"[snapshot] bad snapshot data after deserializing 1 coins\"],  # wrong outpoint hash\n+            [b\"\\x01\", 33, \"9f4d897031ab8547665b4153317ae2fdbf0130c7840b66427ebc48b881cb80ad\", None],  # wrong outpoint index\n+            [b\"\\x81\", 34, \"3da966ba9826fb6d2604260e01607b55ba44e1a5de298606b08704bc62570ea8\", None],  # wrong coin code VARINT\n+            [b\"\\x80\", 34, \"091e893b3ccb4334378709578025356c8bcb0a623f37c7c4e493133c988648e5\", None],  # another wrong coin code\n+            [b\"\\x84\\x58\", 34, None, \"[snapshot] bad snapshot data after deserializing 0 coins\"],  # wrong coin case with height 364 and coinbase 0\n+            [b\"\\xCA\\xD2\\x8F\\x5A\", 39, None, \"[snapshot] bad snapshot data after deserializing 0 coins - bad tx out value\"],  # Amount exceeds MAX_MONEY\n         ]\n \n         for content, offset, wrong_hash, custom_message in cases:\n             with open(bad_snapshot_path, \"wb\") as f:\n-                f.write(valid_snapshot_contents[:(32 + 8 + offset)])\n+                # Prior to offset: Snapshot magic, snapshot version, network magic, height, hash, coins count\n+                f.write(valid_snapshot_contents[:(5 + 2 + 4 + 4 + 32 + 8 + offset)])\n                 f.write(content)\n-                f.write(valid_snapshot_contents[(32 + 8 + offset + len(content)):])\n+                f.write(valid_snapshot_contents[(5 + 2 + 4 + 4 + 32 + 8 + offset + len(content)):])\n \n             log_msg = custom_message if custom_message is not None else f\"[snapshot] bad snapshot content hash: expected a4bf3407ccb2cc0145c49ebba8fa91199f8a3903daf0883875941497d2493c27, got {wrong_hash}\"\n             expected_error(log_msg=log_msg)\ndiff --git a/test/functional/rpc_dumptxoutset.py b/test/functional/rpc_dumptxoutset.py\nindex 1ea6cf52d1db1..c92c8da357042 100755\n--- a/test/functional/rpc_dumptxoutset.py\n+++ b/test/functional/rpc_dumptxoutset.py\n@@ -43,7 +43,7 @@ def run_test(self):\n         # UTXO snapshot hash should be deterministic based on mocked time.\n         assert_equal(\n             sha256sum_file(str(expected_path)).hex(),\n-            'b1bacb602eacf5fbc9a7c2ef6eeb0d229c04e98bdf0c2ea5929012cd0eae3830')\n+            '2f775f82811150d310527b5ff773f81fb0fb517e941c543c1f7c4d38fd2717b3')\n \n         assert_equal(\n             out['txoutset_hash'], 'a0b7baa3bf5ccbd3279728f230d7ca0c44a76e9923fca8f32dbfd08d65ea496a')\n", "problem_statement": "Possible savings in `dumptxoutset` serialization format (~20%)\n**Is your feature request related to a problem? Please describe.**\r\n\r\nSize of the serialized UTXO set\r\n\r\n**Describe the solution you'd like**\r\n\r\nThe serialization format of the serialized UTXO set from `dumptxoutset` is a list of `(COutPoint, Coin)`.\r\n\r\nHowever, many out points refer to the same transaction so we can group by `Txid` with:\r\n`list(Txid, list((vout,Coin))`\r\n\r\nSince the cursor is already iterating through sorted `Txid` this doesn't add complexity to the serialization code.\r\n\r\nConsidering the UTXO at height 745995:\r\n```\r\nserialized_size: ~5.3Gb\r\ntotal_elements: 83_082_178\r\nuniques_txids: 49_517_483\r\nbytes_lost: total_elements // due to the additional byte for the length of the inner list\r\nbytes_savings: (total_elements-unique_txids)*32 - bytes_lost ~= 1Gb\r\n```\r\n\r\n**Describe alternatives you've considered**\r\n\r\nAdditional bytes could be saved by leveraging the duplications in scripts (address reuse). However, this is not considered worthy because the format would lose the streaming property and also because we don't want to optimize on something which is not recommended.\r\n\r\nThe byte lost for expressing the length of the inner list could be optimized with a special byte containing both the length of the list and the first vout, since usually both vout and this value are very small they should fit on a single byte most of the time having a fallback for edge cases.\r\n\r\n**Additional context**\r\n\r\nTagging @jamesob author of https://github.com/bitcoin/bitcoin/pull/16899\r\nassumeutxo summary https://github.com/bitcoin/bitcoin/pull/15606\r\n\n", "hints_text": "", "created_at": "2024-03-10 16:31:48", "merge_commit_sha": "413844f1c2a3d8f7cfef822f348f26df488b03c7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18828", "base_commit": "773a4b919853369166811becb87b9e78ad918211", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/MainPage.cpp b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\nindex 5daf396b72e..054c8480ccf 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n@@ -38,6 +38,7 @@ using namespace winrt::Windows::System;\n using namespace winrt::Windows::UI::Xaml::Controls;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static const std::wstring_view openJsonTag{ L\"OpenJson_Nav\" };\r\n static const std::wstring_view launchTag{ L\"Launch_Nav\" };\r\n static const std::wstring_view interactionTag{ L\"Interaction_Nav\" };\r\n static const std::wstring_view renderingTag{ L\"Rendering_Nav\" };\r\n@@ -324,6 +325,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \r\n             if (const auto navString = clickedItemContainer.Tag().try_as<hstring>())\r\n             {\r\n+                if (*navString == openJsonTag)\r\n+                {\r\n+                    const auto window = CoreWindow::GetForCurrentThread();\r\n+                    const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n+                    const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n+                    const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n+                                            WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n+                    const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n+                    OpenJson.raise(nullptr, target);\r\n+                    return;\r\n+                }\r\n                 _Navigate(*navString, BreadcrumbSubPage::None);\r\n             }\r\n             else if (const auto profile = clickedItemContainer.Tag().try_as<Editor::ProfileViewModel>())\r\n@@ -575,27 +587,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         }\r\n     }\r\n \r\n-    void MainPage::OpenJsonTapped(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& /*args*/)\r\n-    {\r\n-        const auto window = CoreWindow::GetForCurrentThread();\r\n-        const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n-        const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n-        const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n-                                WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n-\r\n-        const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-        OpenJson.raise(nullptr, target);\r\n-    }\r\n-\r\n-    void MainPage::OpenJsonKeyDown(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args)\r\n-    {\r\n-        if (args.Key() == VirtualKey::Enter || args.Key() == VirtualKey::Space)\r\n-        {\r\n-            const auto target = args.KeyStatus().IsMenuKeyDown ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-            OpenJson.raise(nullptr, target);\r\n-        }\r\n-    }\r\n-\r\n     void MainPage::SaveButton_Click(const IInspectable& /*sender*/, const RoutedEventArgs& /*args*/)\r\n     {\r\n         _settingsClone.LogSettingChanges(false);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.h b/src/cascadia/TerminalSettingsEditor/MainPage.h\nindex 81724effb11..582f8813b1d 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.h\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.h\n@@ -30,8 +30,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \n         void UpdateSettings(const Model::CascadiaSettings& settings);\n \n-        void OpenJsonKeyDown(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args);\n-        void OpenJsonTapped(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& args);\n         void SettingsNav_Loaded(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\n         void SettingsNav_ItemInvoked(const Microsoft::UI::Xaml::Controls::NavigationView& sender, const Microsoft::UI::Xaml::Controls::NavigationViewItemInvokedEventArgs& args);\n         void SaveButton_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.xaml b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\nindex 3a0773062aa..c6d36e8f200 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n@@ -171,8 +171,8 @@\n             <!--  The OpenJson item needs both Tapped and KeyDown handler  -->\r\n             <muxc:NavigationViewItem x:Name=\"OpenJsonNavItem\"\r\n                                      x:Uid=\"Nav_OpenJSON\"\r\n-                                     KeyDown=\"OpenJsonKeyDown\"\r\n-                                     Tapped=\"OpenJsonTapped\">\r\n+                                     SelectsOnInvoked=\"False\"\r\n+                                     Tag=\"OpenJson_Nav\">\r\n                 <muxc:NavigationViewItem.Icon>\r\n                     <FontIcon Glyph=\"&#xE713;\" />\r\n                 </muxc:NavigationViewItem.Icon>\r\n", "test_patch": "", "problem_statement": "[Settings]: In scan mode, Screen Reader users are not able to open 'Open JSON file' control.\n### Windows Terminal version\n\n1.12.3472.0\n\n### Windows build number\n\n10.0.22504.1010\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 22504.1010)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\nTool: Accessibility Insights for Windows Version 1.1.1741.1\n\n### Steps to reproduce\n\n**Repro Steps:**\r\n1. Open Windows Terminal.\r\n2. Open Settings page using 'Ctr+,'.\r\n3. Open Narrator using 'Win+Ctrl+ Enter' key. Turn ON Narrator scan mode using 'Caps lock + Space' key.\r\n4. Now navigate to 'Open JSON file' control and try to activate it then observe the issue.\r\n\r\n**User Experience:**\r\nScreen Reader users will be impacted here as they are not able to activate a control in scan mode which will not enhance the UX of those users.\r\n\r\n**Guideline Reference:**\r\nEN 301 549 V3.2.1: 11.5.2.12 Execution of available actions\r\n\r\n**Attachments:**\r\n[Uploading In scan mode, Screen Reader users are not able to open 'Open JSON file' control..zip\u2026]()\n\n### Expected Behavior\n\nIn scan mode, Screen Reader users should be able to open 'Open JSON file' control using 'Enter' key.\n\n### Actual Behavior\n\nIn scan mode, Screen Reader users are not able to open 'Open JSON file' control using 'Enter' key. Screen Reader Users is only able to open JSON file in Scan off mode.\n", "hints_text": "Copying over some relevant information from #12319:\r\n> > PowerToys v0.55 settings has a NavigationView. It doesn't have this issue.\r\nXAML Controls Gallery also doesn't have this issue.\r\n\r\n> Hmm. That might actually be on us then. PT Settings is also XAML Islands IIRC, so if their NavView works, then it's probably how we're using it.\r\n\r\nThere's a chance this is on https://github.com/microsoft/microsoft-ui-xaml, but we need to verify that first.", "created_at": "2025-04-23 19:00:06", "merge_commit_sha": "a8a47b93671361e529ff9f967d0e7c1b028eebb9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18826", "base_commit": "68d9e0d0389101d65f91e5f3bd3fda34df7564f3", "patch": "diff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex 90f6d5936f5..5824bcb2f2a 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -4,8 +4,6 @@\n #include \"precomp.h\"\r\n #include \"renderer.hpp\"\r\n \r\n-#pragma hdrstop\r\n-\r\n using namespace Microsoft::Console::Render;\r\n using namespace Microsoft::Console::Types;\r\n \r\n@@ -90,6 +88,11 @@ IRenderData* Renderer::GetRenderData() const noexcept\n             _pData->UnlockConsole();\r\n         });\r\n \r\n+        if (_isSynchronizingOutput)\r\n+        {\r\n+            _synchronizeWithOutput();\r\n+        }\r\n+\r\n         // Last chance check if anything scrolled without an explicit invalidate notification since the last frame.\r\n         _CheckViewportAndScroll();\r\n \r\n@@ -183,6 +186,71 @@ void Renderer::NotifyPaintFrame() noexcept\n     _thread.NotifyPaint();\r\n }\r\n \r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputBegin() noexcept\r\n+{\r\n+    // Kick the render thread into calling `_synchronizeWithOutput()`.\r\n+    _isSynchronizingOutput = true;\r\n+}\r\n+\r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputEnd() noexcept\r\n+{\r\n+    // Unblock `_synchronizeWithOutput()` from the `WaitOnAddress` call.\r\n+    _isSynchronizingOutput = false;\r\n+    WakeByAddressSingle(&_isSynchronizingOutput);\r\n+\r\n+    // It's crucial to give the render thread at least a chance to gain the lock.\r\n+    // Otherwise, a VT application could continuously spam DECSET 2026 (Synchronized Output) and\r\n+    // essentially drop our renderer to 10 FPS, because `_isSynchronizingOutput` is always true.\r\n+    //\r\n+    // Obviously calling LockConsole/UnlockConsole here is an awful, ugly hack,\r\n+    // since there's no guarantee that this is the same lock as the one the VT parser uses.\r\n+    // But the alternative is Denial-Of-Service of the render thread.\r\n+    //\r\n+    // Note that this causes raw throughput of DECSET 2026 to be comparatively low, but that's fine.\r\n+    // Apps that use DECSET 2026 don't produce that sequence continuously, but rather at a fixed rate.\r\n+    _pData->UnlockConsole();\r\n+    _pData->LockConsole();\r\n+}\r\n+\r\n+void Renderer::_synchronizeWithOutput() noexcept\r\n+{\r\n+    constexpr DWORD timeout = 100;\r\n+\r\n+    UINT64 start = 0;\r\n+    DWORD elapsed = 0;\r\n+    bool wrong = false;\r\n+\r\n+    QueryUnbiasedInterruptTime(&start);\r\n+\r\n+    // Wait for `_isSynchronizingOutput` to be set to false or for a timeout to occur.\r\n+    while (true)\r\n+    {\r\n+        // We can't call a blocking function while holding the console lock, so release it temporarily.\r\n+        _pData->UnlockConsole();\r\n+        const auto ok = WaitOnAddress(&_isSynchronizingOutput, &wrong, sizeof(_isSynchronizingOutput), timeout - elapsed);\r\n+        _pData->LockConsole();\r\n+\r\n+        if (!ok || !_isSynchronizingOutput)\r\n+        {\r\n+            break;\r\n+        }\r\n+\r\n+        UINT64 now;\r\n+        QueryUnbiasedInterruptTime(&now);\r\n+        elapsed = static_cast<DWORD>((now - start) / 10000);\r\n+        if (elapsed >= timeout)\r\n+        {\r\n+            break;\r\n+        }\r\n+    }\r\n+\r\n+    // If a timeout occurred, `_isSynchronizingOutput` may still be true.\r\n+    // Set it to false now to skip calling `_synchronizeWithOutput()` on the next frame.\r\n+    _isSynchronizingOutput = false;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Called when the system has requested we redraw a portion of the console.\r\n // Arguments:\r\ndiff --git a/src/renderer/base/renderer.hpp b/src/renderer/base/renderer.hpp\nindex d5f6be56d18..c8c30457604 100644\n--- a/src/renderer/base/renderer.hpp\n+++ b/src/renderer/base/renderer.hpp\n@@ -35,6 +35,8 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT PaintFrame();\r\n \r\n         void NotifyPaintFrame() noexcept;\r\n+        void SynchronizedOutputBegin() noexcept;\r\n+        void SynchronizedOutputEnd() noexcept;\r\n         void TriggerSystemRedraw(const til::rect* const prcDirtyClient);\r\n         void TriggerRedraw(const Microsoft::Console::Types::Viewport& region);\r\n         void TriggerRedraw(const til::point* const pcoord);\r\n@@ -91,6 +93,7 @@ namespace Microsoft::Console::Render\n \r\n         [[nodiscard]] HRESULT _PaintFrame() noexcept;\r\n         [[nodiscard]] HRESULT _PaintFrameForEngine(_In_ IRenderEngine* const pEngine) noexcept;\r\n+        void _synchronizeWithOutput() noexcept;\r\n         bool _CheckViewportAndScroll();\r\n         [[nodiscard]] HRESULT _PaintBackground(_In_ IRenderEngine* const pEngine);\r\n         void _PaintBufferOutput(_In_ IRenderEngine* const pEngine);\r\n@@ -124,6 +127,7 @@ namespace Microsoft::Console::Render\n         std::function<void()> _pfnBackgroundColorChanged;\r\n         std::function<void()> _pfnFrameColorChanged;\r\n         std::function<void()> _pfnRendererEnteredErrorState;\r\n+        bool _isSynchronizingOutput = false;\r\n         bool _forceUpdateViewport = false;\r\n \r\n         til::point_span _lastSelectionPaintSpan{};\r\ndiff --git a/src/renderer/base/thread.cpp b/src/renderer/base/thread.cpp\nindex 467bef73585..39b7ec60783 100644\n--- a/src/renderer/base/thread.cpp\n+++ b/src/renderer/base/thread.cpp\n@@ -34,7 +34,7 @@ DWORD WINAPI RenderThread::_ThreadProc()\n \r\n         // Between waiting on _hEvent and calling PaintFrame() there should be a minimal delay,\r\n         // so that a key press progresses to a drawing operation as quickly as possible.\r\n-        // As such, we wait for the renderer to complete _before_ waiting on _hEvent.\r\n+        // As such, we wait for the renderer to complete _before_ waiting on `_redraw`.\r\n         renderer->WaitUntilCanRender();\r\n \r\n         _redraw.wait();\r\n@@ -78,6 +78,8 @@ void RenderThread::EnablePainting() noexcept\n     }\r\n }\r\n \r\n+// This function is meant to only be called by `Renderer`. You should use `TriggerTeardown()` instead,\r\n+// even if you plan to call `EnablePainting()` later, because that ensures proper synchronization.\r\n void RenderThread::DisablePainting() noexcept\r\n {\r\n     _enable.ResetEvent();\r\ndiff --git a/src/terminal/adapter/DispatchTypes.hpp b/src/terminal/adapter/DispatchTypes.hpp\nindex f1adb1457c8..b99dd997dde 100644\n--- a/src/terminal/adapter/DispatchTypes.hpp\n+++ b/src/terminal/adapter/DispatchTypes.hpp\n@@ -544,6 +544,7 @@ namespace Microsoft::Console::VirtualTerminal::DispatchTypes\n         ALTERNATE_SCROLL = DECPrivateMode(1007),\r\n         ASB_AlternateScreenBuffer = DECPrivateMode(1049),\r\n         XTERM_BracketedPasteMode = DECPrivateMode(2004),\r\n+        SO_SynchronizedOutput = DECPrivateMode(2026),\r\n         GCM_GraphemeClusterMode = DECPrivateMode(2027),\r\n         W32IM_Win32InputMode = DECPrivateMode(9001),\r\n     };\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 9158b962ab3..c8f4c5eb85e 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1914,6 +1914,19 @@ void AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n     case DispatchTypes::ModeParams::XTERM_BracketedPasteMode:\n         _api.SetSystemMode(ITerminalApi::Mode::BracketedPaste, enable);\n         break;\n+    case DispatchTypes::ModeParams::SO_SynchronizedOutput:\n+        if (_renderer)\n+        {\n+            if (enable)\n+            {\n+                _renderer->SynchronizedOutputBegin();\n+            }\n+            else\n+            {\n+                _renderer->SynchronizedOutputEnd();\n+            }\n+        }\n+        break;\n     case DispatchTypes::ModeParams::GCM_GraphemeClusterMode:\n         break;\n     case DispatchTypes::ModeParams::W32IM_Win32InputMode:\n", "test_patch": "", "problem_statement": "Implement synchronized update control sequences\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\n\r\nhttps://gitlab.com/gnachman/iterm2/-/wikis/synchronized-updates-spec\r\n\r\nThe goal of synchronized updates is to avoid showing a half-drawn screen, such as while paging through a document in an editor.\r\n\r\nA new control sequence is proposed that indicates the beginning and end of a update. No new content should be rendered by the terminal emulator until the update ends, at which point any changes made during the update should be applied atomically.\r\n\r\nThe purpose of this sequence is to provide a hint to the terminal emulator about how to draw atomically. If it turns out to be too difficult to do under some particular input, the hint can be safely ignored\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\n\n```[tasklist]\n### Tasks\n```\n\n", "hints_text": "Yea okay, this seems well thought out. I like that there are contingincies included for \"what happens when the client app disconnects before sending an \\<end\\>\". Plus, I think we did add support for DCS sequences relatively recently, so this shouldn't be too bad. \r\n\r\nPart of the trick here is gonna be conpty, and the way we use that to render the _effects_ of output on the console buffer. I'd guess that this would have to be implemented in `conhost`, and then at the end of the synchronized update, conhost would render _once_ to the terminal. That makes sense to me. \nNote that this idea was discussed in terminal-wg a while back, and I think it was generally agreed that a DCS sequence was a bad choice for this. One of the benefits of this functionality is that it shouldn't require feature detection - if a terminal doesn't support it, then you just don't get the optimisation. However, that's not the case if you're using a DCS sequence, because there are a number of terminals that will output garbage if you send them an unrecognised DCS. So now an app can't really use this functionality unless they first determine whether it's supported somehow.\r\n\r\nAs is typical for terminal-wg, there was no official conclusion to the discussion, but the general consensus seemed to have been that a DECSET private mode sequence would be preferable, and the mode number that was settled on was 2026. I know at least one terminal has implemented synchronized updates via mode 2026, and at least one application is using that mode.\r\n\r\nAlso I know @gnachman has said \"If I had it to do over again, I'd push for DECSET/DECRST\", but he hasn't actually agreed to supporting the proposed mode in iTerm2 as far as I'm aware. If we're going to implement this, I'd much rather we used a DECSET mode than DCS, but I'd also like to have seen some definite commitment to that approach from people like iTerm2.\n> However, that's not the case if you're using a DCS sequence, because there are a number of terminals that will output garbage if you send them an unrecognised DCS\r\n\r\nGuh, I hate that. Maybe we come up with an agreement between us and iTerm2 to move forward onto a DECSET/DECRST implementation. We'd obviously have to still support the DCS version of the sequence, but maybe we can help push the ecosystem forward a bit here. Here's what I'm thinking:\r\n\r\n* We implement support for the DCS version of this sequence.\r\n* _At the same time_, as we add support for the DCS version, we add support for the DECSET/DECRST version. \r\n* **At the same time**, iTerm2 adds support for the DECSET/DECRST version. \r\n\r\nAt this point, we'd update any existing documentation to suggest that app developers use the new version of the sequence, and the old one is deprecated. Terminal emulators that haven't been updated with support for the new sequence will silently ignore it. Apps that aren't updated to use the new sequence will still continue to work (and will _start_ working on the console/Terminal).\r\n\r\nThis would obviously require buyoff from @gnachman, but this seems like a reasonable path, and one that would work cross-platform. Thoughts?\r\n\r\n##### notes: terminal-wg [pr](https://gitlab.freedesktop.org/terminal-wg/specifications/-/merge_requests/2)\nI am fine with this. I believe Kitty has also implemented support for this control sequence, so check with @kovidgoyal too.\nYou can go ahead and use DECSET/DECRESET if it floats your boat. Since you are also implementing support for the DCS version, I dont really care. I will note that the only terminals that dont support DCS sequences are Apple's and the Linux kernel console. Using DECSET/DECRESET means that no future modifications can be made to the protocol to implement additional features. Which will mean in the long term that DECSET/DECRESET will be the deprecated ones, but hey, no harm in having them, just another redundant code path. Just be careful when choosing numbers for the codes to not conflict with existing uses, which was one of the motivations for choosing DCS in the first place. \n> Just be careful when choosing numbers for the codes to not conflict with existing uses,\r\n\r\nI like to compare that feature a little bit to double buffering in graphics APIs, such as OpenGL (first released in 1992), wich is also there to avoid tearing effects. That standard had never changed. So i am pretty confident it won't need any feature extension here, too.\r\n\r\n\nThat's not a valid comparison. OpenGL's double bufferring buffers a single thing, a pixel buffer, and over a fast local link. In the terminal case you are bufferring terminal state beyond just what is drawn on the screen and over latency variable, lossy networks. \n> That's not a valid comparison. OpenGL's double bufferring buffers a single thing, a pixel buffer, and over a fast local link. In the terminal case you are bufferring terminal state beyond just what is drawn on the screen and over latency variable, lossy networks.\r\n\r\n@kovidgoyal i do not want to fight over little differences when I explicitly did not say equal but like. That would be way to off-topic. Feel free to ignore my opinion. ;-)\n@zadjii-msft good morning. I'd like to ask if there there had been actually any brainstorming progress on the msft side of the fence? I stilll do also think that DECSM/DECRM are the right choice, and I came back to see if here was any progress until then. :)\nI actually hacked together a basic implementation of this a while back (just the mode 2026 approach) which I've been using in my local fork. We didn't have the ability to do DCS at the time, and I was also waiting to see what iTerm2 would do. But I suspect now that gnachman has changed his mind about supporting mode 2026 (it would have taken all of 3 lines of code if he was going to do it). So if it were up to me, I'd say we should just do the mode and ignore the DCS approach. Supporting both will push apps to use DCS, which is exactly what we want to avoid.\r\n\r\nEven if we don't care about all the other terminals that will be negatively effected by the use of DCS (which I can assure you is more than two), the Windows console itself didn't support DCS until very recently. So there are still likely to be a significant number of users on an older version of Windows that'll break if sent a DCS sequence, and upgrading is not always an option (I know, because several of my computers are on older versions that aren't being offered upgrades).\r\n\r\nIf it turns out there are actually apps using the DCS sequence that can't be persuaded to add support for the mode, then we can always reconsider adding a DCS alias later (but preferably when the #6328 fix is more widely deployed).\n> I'd say we should just do the mode and ignore the DCS approach. Supporting both will push apps to use DCS, which is exactly what we want to avoid.\r\n\r\nI am all in, and absolutely agree with you on that decision. \r\n\r\nFor reference, I've put together the spec as well with the (more interestingly maybe) list of supporting software for the \"synchronized rendering\" feature [here](https://gist.github.com/christianparpart/d8a62cc1ab659194337d73e399004036). @j4james I can't await adding you (your branch / PR) once ready to it, too. Looking forward to it. :)\nI'm happy to do DECSET 2026. I've been busy, but will do it now.\n> I'm happy to do DECSET 2026. I've been busy, but will do it now.\r\n\r\nI am really happy to hear from you. Looking forward to it.\nDone in commit f7efeb4bbaa5ba2796f94c3bab32e5c64ee9c743\nAny updates or progress on this?", "created_at": "2025-04-23 00:30:35", "merge_commit_sha": "773a4b919853369166811becb87b9e78ad918211", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18797", "base_commit": "f83b98e100ff9ba8dc244d820ab79604f20ed373", "patch": "diff --git a/src/host/readDataCooked.cpp b/src/host/readDataCooked.cpp\nindex 8b88f2d4a38..ea086b12301 100644\n--- a/src/host/readDataCooked.cpp\n+++ b/src/host/readDataCooked.cpp\n@@ -1119,12 +1119,33 @@ void COOKED_READ_DATA::_redisplay()\n         output.append(L\"\\x1b[J\");\r\n     }\r\n \r\n-    // Disable the cursor when opening a popup, reenable it when closing them.\r\n+    // Backup the attributes (DECSC) and disable the cursor when opening a popup (DECTCEM).\r\n+    // Restore the attributes (DECRC) reenable the cursor when closing them (DECTCEM).\r\n     if (const auto popupOpened = !_popups.empty(); _popupOpened != popupOpened)\r\n     {\r\n-        wchar_t buf[] = L\"\\x1b[?25l\";\r\n-        buf[5] = popupOpened ? 'l' : 'h';\r\n-        output.append(&buf[0], 6);\r\n+        wchar_t buf[] =\r\n+            // Back/restore cursor position & attributes (commonly supported)\r\n+            L\"\\u001b7\"\r\n+            // Show/hide cursor (commonly supported)\r\n+            \"\\u001b[?25l\"\r\n+            // The popup code uses XTPUSHSGR (CSI # {) / XTPOPSGR (CSI # }) to draw the popups in the popup-colors,\r\n+            // while properly restoring the previous VT attributes. On terminals that support them, the following\r\n+            // won't do anything. On other terminals however, it'll reset the attributes to default.\r\n+            // This is important as the first thing the popup drawing code uses CSI K to erase the previous contents\r\n+            // and CSI m to reset the attributes on terminals that don't support XTPUSHSGR/XTPOPSGR. In order for\r\n+            // the first CSI K to behave as if there had a previous CSI m, we must emit an initial CSI m here.\r\n+            // (rarely supported)\r\n+            \"\\x1b[#{\\x1b[m\\x1b[#}\";\r\n+\r\n+        buf[1] = popupOpened ? '7' : '8';\r\n+        buf[7] = popupOpened ? 'l' : 'h';\r\n+\r\n+        // When the popup closes we skip the XTPUSHSGR/XTPOPSGR sequence. This is crucial because we\r\n+        // use DECRC to restore the cursor position and attributes with a widely supported sequence.\r\n+        // If we emitted that XTPUSHSGR/XTPOPSGR sequence it would reset the attributes again.\r\n+        const size_t len = popupOpened ? 19 : 8;\r\n+\r\n+        output.append(buf, len);\r\n         _popupOpened = popupOpened;\r\n     }\r\n \r\n@@ -1595,10 +1616,10 @@ void COOKED_READ_DATA::_popupDrawPrompt(std::vector<Line>& lines, const til::Coo\n     str.append(suffix);\r\n \r\n     std::wstring line;\r\n-    line.append(L\"\\x1b[K\");\r\n+    line.append(L\"\\x1b[#{\\x1b[K\");\r\n     _appendPopupAttr(line);\r\n     const auto res = _layoutLine(line, str, 0, 0, width);\r\n-    line.append(L\"\\x1b[m\");\r\n+    line.append(L\"\\x1b[m\\x1b[#}\");\r\n \r\n     lines.emplace_back(std::move(line), 0, 0, res.column);\r\n }\r\n@@ -1654,7 +1675,7 @@ void COOKED_READ_DATA::_popupDrawCommandList(std::vector<Line>& lines, const til\n         const auto selected = index == cl.selected && !stackedCommandNumberPopup;\r\n \r\n         std::wstring line;\r\n-        line.append(L\"\\x1b[K\");\r\n+        line.append(L\"\\x1b[#{\\x1b[K\");\r\n         _appendPopupAttr(line);\r\n \r\n         wchar_t scrollbarChar = L' ';\r\n@@ -1681,7 +1702,7 @@ void COOKED_READ_DATA::_popupDrawCommandList(std::vector<Line>& lines, const til\n         }\r\n         else\r\n         {\r\n-            line.append(L\"\\x1b[m \");\r\n+            line.append(L\"\\x1b[m\\x1b[#} \");\r\n         }\r\n \r\n         fmt::format_to(std::back_inserter(line), FMT_COMPILE(L\"{:{}}: \"), index, indexWidth);\r\n@@ -1690,7 +1711,7 @@ void COOKED_READ_DATA::_popupDrawCommandList(std::vector<Line>& lines, const til\n \r\n         if (selected)\r\n         {\r\n-            line.append(L\"\\x1b[m\");\r\n+            line.append(L\"\\x1b[m\\x1b[#}\");\r\n         }\r\n \r\n         line.append(L\"\\r\\n\");\r\n", "test_patch": "", "problem_statement": "Functionality of cmd.exe \"color\" command broken since 1.22\n### Windows Terminal version\n\n1.22.10731.0\n\n### Windows build number\n\n10.0.26100.3624\n\n### Other Software\n\nNew history list (F7) implementation changes the default text/background colors of console and does not restore them back on close. Probably, introduced in #17445.\n\n### Steps to reproduce\n\n* Run command prompt (cmd.exe) in Terminal\n* Type `help` command. Help will be displayed.\n* Type `color E0` command. Colors of text and background will change,\n* Type `help` command again. Help will be displayed with new color. You can type other commands, they will also produce output using new colors.\n* Press F7, select `help` command from the list and press Enter, Help will be displayed with **original** color that was active before the `color E0` command was executed. All subsequent commands will also use this color.\n\n\n### Expected Behavior\n\nColor change made by `color E0` command will remain active after history usage,\n\n### Actual Behavior\n\nResult of `color E0` command is reverted by F7 implementation,\n", "hints_text": "", "created_at": "2025-04-14 20:05:48", "merge_commit_sha": "8b01f546cb5c1d5895d0fa517fd6bbedc9991a1b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18627", "base_commit": "35bd60782fec6486e6f7fd10ffa4d9c5de70790d", "patch": "diff --git a/src/cascadia/LocalTests_TerminalApp/TabTests.cpp b/src/cascadia/LocalTests_TerminalApp/TabTests.cpp\nindex 477e6dcf0ea..941d5fa06fe 100644\n--- a/src/cascadia/LocalTests_TerminalApp/TabTests.cpp\n+++ b/src/cascadia/LocalTests_TerminalApp/TabTests.cpp\n@@ -287,7 +287,7 @@ namespace TerminalAppLocalTests\n             NewTabArgs args{ newTerminalArgs };\r\n             ActionAndArgs newTabAction{ ShortcutAction::NewTab, args };\r\n             // push the arg onto the front\r\n-            page->_startupActions.Append(newTabAction);\r\n+            page->_startupActions.push_back(std::move(newTabAction));\r\n             Log::Comment(L\"Added a single newTab action\");\r\n \r\n             auto app = ::winrt::Windows::UI::Xaml::Application::Current();\r\ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex b2ae698205a..69648929637 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -752,13 +752,11 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         if (const auto& realArgs = actionArgs.ActionArgs().try_as<ExecuteCommandlineArgs>())\r\n         {\r\n-            auto actions = winrt::single_threaded_vector<ActionAndArgs>(\r\n-                TerminalPage::ConvertExecuteCommandlineToActions(realArgs));\r\n-\r\n-            if (actions.Size() != 0)\r\n+            auto actions = ConvertExecuteCommandlineToActions(realArgs);\r\n+            if (!actions.empty())\r\n             {\r\n                 actionArgs.Handled(true);\r\n-                ProcessStartupActions(actions, false);\r\n+                ProcessStartupActions(std::move(actions), false);\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex 7604b4d7d56..7db179c9067 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -62,7 +62,6 @@ namespace winrt::TerminalApp::implementation\n     TerminalPage::TerminalPage(TerminalApp::WindowProperties properties, const TerminalApp::ContentManager& manager) :\n         _tabs{ winrt::single_threaded_observable_vector<TerminalApp::TabBase>() },\n         _mruTabs{ winrt::single_threaded_observable_vector<TerminalApp::TabBase>() },\n-        _startupActions{ winrt::single_threaded_vector<ActionAndArgs>() },\n         _manager{ manager },\n         _hostingHwnd{},\n         _WindowProperties{ std::move(properties) }\n@@ -297,7 +296,7 @@ namespace winrt::TerminalApp::implementation\n         // GH#12267: Don't forget about defterm handoff here. If we're being\n         // created for embedding, then _yea_, we don't need to handoff to an\n         // elevated window.\n-        if (!_startupActions || IsRunningElevated() || _shouldStartInboundListener || _startupActions.Size() == 0)\n+        if (_startupActions.empty() || IsRunningElevated() || _shouldStartInboundListener)\n         {\n             // there aren't startup actions, or we're elevated. In that case, go for it.\n             return false;\n@@ -375,7 +374,7 @@ namespace winrt::TerminalApp::implementation\n     // - <none>\n     void TerminalPage::HandoffToElevated(const CascadiaSettings& settings)\n     {\n-        if (!_startupActions)\n+        if (_startupActions.empty())\n         {\n             return;\n         }\n@@ -489,7 +488,7 @@ namespace winrt::TerminalApp::implementation\n         {\n             _startupState = StartupState::InStartup;\n \n-            ProcessStartupActions(_startupActions, true);\n+            ProcessStartupActions(std::move(_startupActions), true);\n \n             // If we were told that the COM server needs to be started to listen for incoming\n             // default application connections, start it now.\n@@ -546,80 +545,56 @@ namespace winrt::TerminalApp::implementation\n     //   nt -d .` from inside another directory to work as expected.\n     // Return Value:\n     // - <none>\n-    safe_void_coroutine TerminalPage::ProcessStartupActions(Windows::Foundation::Collections::IVector<ActionAndArgs> actions,\n-                                                            const bool initial,\n-                                                            const winrt::hstring cwd,\n-                                                            const winrt::hstring env)\n+    safe_void_coroutine TerminalPage::ProcessStartupActions(std::vector<ActionAndArgs> actions, const bool initial, const winrt::hstring cwd, const winrt::hstring env)\n     {\n-        auto weakThis{ get_weak() };\n-\n-        // Handle it on a subsequent pass of the UI thread.\n-        co_await wil::resume_foreground(Dispatcher(), CoreDispatcherPriority::Normal);\n+        const auto strong = get_strong();\n \n         // If the caller provided a CWD, \"switch\" to that directory, then switch\n-        // back once we're done. This looks weird though, because we have to set\n-        // up the scope_exit _first_. We'll release the scope_exit if we don't\n-        // actually need it.\n-\n+        // back once we're done.\n         auto originalVirtualCwd{ _WindowProperties.VirtualWorkingDirectory() };\n-        auto restoreCwd = wil::scope_exit([&originalVirtualCwd, this]() {\n-            // ignore errors, we'll just power on through. We'd rather do\n-            // something rather than fail silently if the directory doesn't\n-            // actually exist.\n-            _WindowProperties.VirtualWorkingDirectory(originalVirtualCwd);\n-        });\n-\n-        // Literally the same thing with env vars too\n         auto originalVirtualEnv{ _WindowProperties.VirtualEnvVars() };\n-        auto restoreEnv = wil::scope_exit([&originalVirtualEnv, this]() {\n-            _WindowProperties.VirtualEnvVars(originalVirtualEnv);\n+        auto restoreCwd = wil::scope_exit([&]() {\n+            if (!cwd.empty())\n+            {\n+                // ignore errors, we'll just power on through. We'd rather do\n+                // something rather than fail silently if the directory doesn't\n+                // actually exist.\n+                _WindowProperties.VirtualWorkingDirectory(originalVirtualCwd);\n+                _WindowProperties.VirtualEnvVars(originalVirtualEnv);\n+            }\n         });\n+        _WindowProperties.VirtualWorkingDirectory(cwd);\n+        _WindowProperties.VirtualEnvVars(env);\n \n-        if (cwd.empty())\n+        for (size_t i = 0; i < actions.size(); ++i)\n         {\n-            // We didn't actually need to change the virtual CWD, so we don't\n-            // need to restore it\n-            restoreCwd.release();\n-        }\n-        else\n-        {\n-            _WindowProperties.VirtualWorkingDirectory(cwd);\n-        }\n+            if (i != 0)\n+            {\n+                // Each action may rely on the XAML layout of a preceding action.\n+                // Most importantly, this is the case for the combination of NewTab + SplitPane,\n+                // as the former appears to only have a layout size after at least 1 resume_foreground,\n+                // while the latter relies on that information. This is also why it uses Low priority.\n+                //\n+                // Curiously, this does not seem to be required when using startupActions, but only when\n+                // tearing out a tab (this currently creates a new window with injected startup actions).\n+                // This indicates that this is really more of an architectural issue and not a fundamental one.\n+                co_await wil::resume_foreground(Dispatcher(), CoreDispatcherPriority::Low);\n+            }\n \n-        if (env.empty())\n-        {\n-            restoreEnv.release();\n-        }\n-        else\n-        {\n-            _WindowProperties.VirtualEnvVars(env);\n+            _actionDispatch->DoAction(actions[i]);\n         }\n \n-        if (auto page{ weakThis.get() })\n+        // GH#6586: now that we're done processing all startup commands,\n+        // focus the active control. This will work as expected for both\n+        // commandline invocations and for `wt` action invocations.\n+        if (const auto& terminalTab{ _GetFocusedTabImpl() })\n         {\n-            for (const auto& action : actions)\n+            if (const auto& content{ terminalTab->GetActiveContent() })\n             {\n-                if (auto page{ weakThis.get() })\n-                {\n-                    _actionDispatch->DoAction(action);\n-                }\n-                else\n-                {\n-                    co_return;\n-                }\n-            }\n-\n-            // GH#6586: now that we're done processing all startup commands,\n-            // focus the active control. This will work as expected for both\n-            // commandline invocations and for `wt` action invocations.\n-            if (const auto& terminalTab{ _GetFocusedTabImpl() })\n-            {\n-                if (const auto& content{ terminalTab->GetActiveContent() })\n-                {\n-                    content.Focus(FocusState::Programmatic);\n-                }\n+                content.Focus(FocusState::Programmatic);\n             }\n         }\n+\n         if (initial)\n         {\n             _CompleteInitialization();\n@@ -3664,13 +3639,9 @@ namespace winrt::TerminalApp::implementation\n     // - actions: a list of Actions to process on startup.\n     // Return Value:\n     // - <none>\n-    void TerminalPage::SetStartupActions(std::vector<ActionAndArgs>& actions)\n+    void TerminalPage::SetStartupActions(std::vector<ActionAndArgs> actions)\n     {\n-        // The fastest way to copy all the actions out of the std::vector and\n-        // put them into a winrt::IVector is by making a copy, then moving the\n-        // copy into the winrt vector ctor.\n-        auto listCopy = actions;\n-        _startupActions = winrt::single_threaded_vector<ActionAndArgs>(std::move(listCopy));\n+        _startupActions = std::move(actions);\n     }\n \n     // Routine Description:\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex d094e07f0fe..9837f9fe618 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -128,7 +128,7 @@ namespace winrt::TerminalApp::implementation\n         void Maximized(bool newMaximized);\n         void RequestSetMaximized(bool newMaximized);\n \n-        void SetStartupActions(std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs>& actions);\n+        void SetStartupActions(std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> actions);\n \n         void SetInboundListener(bool isEmbedding);\n         static std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> ConvertExecuteCommandlineToActions(const Microsoft::Terminal::Settings::Model::ExecuteCommandlineArgs& args);\n@@ -146,7 +146,7 @@ namespace winrt::TerminalApp::implementation\n         void ActionSaveFailed(winrt::hstring message);\n         void ShowTerminalWorkingDirectory();\n \n-        safe_void_coroutine ProcessStartupActions(Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::ActionAndArgs> actions,\n+        safe_void_coroutine ProcessStartupActions(std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> actions,\n                                                   const bool initial,\n                                                   const winrt::hstring cwd = winrt::hstring{},\n                                                   const winrt::hstring env = winrt::hstring{});\n@@ -255,7 +255,7 @@ namespace winrt::TerminalApp::implementation\n         winrt::Windows::UI::Xaml::Controls::Grid::LayoutUpdated_revoker _layoutUpdatedRevoker;\n         StartupState _startupState{ StartupState::NotInitialized };\n \n-        Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::ActionAndArgs> _startupActions;\n+        std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> _startupActions;\n         bool _shouldStartInboundListener{ false };\n         bool _isEmbeddingInboundListener{ false };\n \ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.cpp b/src/cascadia/TerminalApp/TerminalWindow.cpp\nindex 055d6123ccf..4d644666e1c 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.cpp\n+++ b/src/cascadia/TerminalApp/TerminalWindow.cpp\n@@ -1054,12 +1054,8 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         _contentBounds = bounds;\r\n \r\n-        const auto& args = _contentStringToActions(content, true);\r\n-\r\n-        for (const auto& action : args)\r\n-        {\r\n-            _initialContentArgs.push_back(action);\r\n-        }\r\n+        const auto args = _contentStringToActions(content, true);\r\n+        _initialContentArgs = wil::to_vector(args);\r\n     }\r\n \r\n     // Method Description:\r\n@@ -1085,7 +1081,7 @@ namespace winrt::TerminalApp::implementation\n         if (_appArgs->ExitCode() == 0)\r\n         {\r\n             auto& parsedArgs = _appArgs->ParsedArgs();\r\n-            auto actions = winrt::single_threaded_vector<ActionAndArgs>(std::move(parsedArgs.GetStartupActions()));\r\n+            auto& actions = parsedArgs.GetStartupActions();\r\n \r\n             _root->ProcessStartupActions(actions, false, _appArgs->CurrentDirectory(), _appArgs->CurrentEnvironment());\r\n \r\n@@ -1200,7 +1196,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         try\r\n         {\r\n-            const auto& args = ActionAndArgs::Deserialize(content);\r\n+            const auto args = ActionAndArgs::Deserialize(content);\r\n             if (args == nullptr ||\r\n                 args.Size() == 0)\r\n             {\r\n@@ -1244,9 +1240,9 @@ namespace winrt::TerminalApp::implementation\n \r\n             const bool replaceFirstWithNewTab = tabIndex >= _root->NumberOfTabs();\r\n \r\n-            const auto& args = _contentStringToActions(content, replaceFirstWithNewTab);\r\n+            auto args = _contentStringToActions(content, replaceFirstWithNewTab);\r\n \r\n-            _root->AttachContent(args, tabIndex);\r\n+            _root->AttachContent(std::move(args), tabIndex);\r\n         }\r\n     }\r\n     void TerminalWindow::SendContentToOther(winrt::TerminalApp::RequestReceiveContentArgs args)\r\n", "test_patch": "", "problem_statement": "Drag tab into new window lost all panels besides the first\n### Windows Terminal version\n\nPreview 1.23.10353.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nCreate two tabs. In the second one split the screen in two panels. Drag this second tab into a new window.\n\n### Expected Behavior\n\nThe new window will have both panels. Terminal 1.21.10351.0 works as expected.\n\n### Actual Behavior\n\nThe new window have only the terminal in the first panel. From the task explorer, the processes in the lost panels doesn't become detach, they are just killed. \n", "hints_text": "oh dear, yep that's pretty bad. Thanks for filing!", "created_at": "2025-02-25 15:41:33", "merge_commit_sha": "e1b28e72b39bf1adae9e02b550c4810a5f4e221c", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18518", "base_commit": "8b78be5f4ae40f720d980ed41075cd11e9eb0814", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.cpp b/src/cascadia/TerminalApp/CommandPalette.cpp\nindex bcee25c72dd..6d5540703fc 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.cpp\n+++ b/src/cascadia/TerminalApp/CommandPalette.cpp\n@@ -530,6 +530,79 @@ namespace winrt::TerminalApp::implementation\n         }\n     }\n \n+    // Method Description:\n+    // - This event is called when the user's mouse pointer enters an individual\n+    //   item from the list. We'll get the item that was hovered and \"preview\"\n+    //   the command that the user hovered. To do that, we'll dispatch the switch\n+    //   to tab command for this tab, but not dismiss the switcher.\n+    //\n+    // Arguments:\n+    // - sender: the UI element that raised the event.\n+    // Return Value:\n+    // - <none>\n+    void CommandPalette::_listItemPointerEntered(const winrt::Windows::Foundation::IInspectable& sender,\n+                                                 const winrt::Windows::UI::Xaml::Input::PointerRoutedEventArgs& /*args*/)\n+    {\n+        // cancel any pending exit timer to prevent an unwanted preview revert\n+        if (_pointerExitTimer)\n+        {\n+            _pointerExitTimer.Stop();\n+        }\n+\n+        const auto listViewItem = sender.try_as<winrt::Windows::UI::Xaml::Controls::ListViewItem>();\n+        if (_currentMode == CommandPaletteMode::ActionMode && listViewItem)\n+        {\n+            const auto enteredItem = listViewItem.Content();\n+            if (const auto filteredCommand{ enteredItem.try_as<winrt::TerminalApp::FilteredCommand>() })\n+            {\n+                if (const auto actionPaletteItem{ filteredCommand.Item().try_as<winrt::TerminalApp::ActionPaletteItem>() })\n+                {\n+                    // immediately preview the hovered command\n+                    PreviewAction.raise(*this, actionPaletteItem.Command());\n+                }\n+            }\n+        }\n+    }\n+\n+    // Method Description:\n+    // - This event is called when the user's mouse pointer exits an individual\n+    //   item from the list. We then revert to previewing the selected item rather\n+    //   than the hovered one, using a short delay (via a DispatcherTimer) to smooth\n+    //   transitions when rapidly moving between items.\n+    //\n+    // Arguments:\n+    // - <none>\n+    // Return Value:\n+    // - <none>\n+    void CommandPalette::_listItemPointerExited(const winrt::Windows::Foundation::IInspectable& /*sender*/,\n+                                                const winrt::Windows::UI::Xaml::Input::PointerRoutedEventArgs& /*args*/)\n+    {\n+        // if there is no exit timer, create one\n+        if (!_pointerExitTimer)\n+        {\n+            _pointerExitTimer = winrt::Windows::UI::Xaml::DispatcherTimer();\n+            _pointerExitTimer.Interval(std::chrono::milliseconds(10));\n+            _pointerExitTimer.Tick([this](auto const&, auto const&) {\n+                // when the timer ticks, revert the preview to the selected command\n+                const auto selectedCommand = _filteredActionsView().SelectedItem();\n+                if (const auto filteredCommand{ selectedCommand.try_as<winrt::TerminalApp::FilteredCommand>() })\n+                {\n+                    if (_currentMode == CommandPaletteMode::ActionMode && filteredCommand)\n+                    {\n+                        if (const auto actionPaletteItem{ filteredCommand.Item().try_as<winrt::TerminalApp::ActionPaletteItem>() })\n+                        {\n+                            PreviewAction.raise(*this, actionPaletteItem.Command());\n+                        }\n+                    }\n+                }\n+                _pointerExitTimer.Stop();\n+            });\n+        }\n+\n+        // restart the timer\n+        _pointerExitTimer.Start();\n+    }\n+\n     void CommandPalette::_listItemSelectionChanged(const Windows::Foundation::IInspectable& /*sender*/, const Windows::UI::Xaml::Controls::SelectionChangedEventArgs& e)\n     {\n         // We don't care about...\n@@ -1214,6 +1287,9 @@ namespace winrt::TerminalApp::implementation\n \n         ParentCommandName(L\"\");\n         _currentNestedCommands.Clear();\n+\n+        // revert any preview\n+        _filteredActionsView().SelectedIndex(-1);\n         PreviewAction.raise(*this, nullptr);\n     }\n \n@@ -1306,6 +1382,10 @@ namespace winrt::TerminalApp::implementation\n         else\n         {\n             itemContainer.DataContext(args.Item());\n+\n+            // attach the pointer event handlers to the container\n+            itemContainer.PointerEntered({ this, &CommandPalette::_listItemPointerEntered });\n+            itemContainer.PointerExited({ this, &CommandPalette::_listItemPointerExited });\n         }\n     }\n \ndiff --git a/src/cascadia/TerminalApp/CommandPalette.h b/src/cascadia/TerminalApp/CommandPalette.h\nindex 58e34bb1f90..0da7ee13344 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.h\n+++ b/src/cascadia/TerminalApp/CommandPalette.h\n@@ -78,6 +78,8 @@ namespace winrt::TerminalApp::implementation\n \n         Windows::Foundation::Collections::IVector<winrt::TerminalApp::FilteredCommand> _commandsToFilter();\n \n+        winrt::Windows::UI::Xaml::DispatcherTimer _pointerExitTimer{ nullptr }; // timer to debounce pointer exit events (used to smooth preview transitions)\n+\n         bool _lastFilterTextWasEmpty{ true };\n \n         void _populateCommands();\n@@ -103,6 +105,10 @@ namespace winrt::TerminalApp::implementation\n \n         void _listItemClicked(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Controls::ItemClickEventArgs& e);\n \n+        void _listItemPointerEntered(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::PointerRoutedEventArgs& args);\n+\n+        void _listItemPointerExited(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::Input::PointerRoutedEventArgs& args);\n+\n         void _listItemSelectionChanged(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Controls::SelectionChangedEventArgs& e);\n \n         void _moveBackButtonClicked(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs&);\n", "test_patch": "", "problem_statement": "Request: \"Select color scheme...\" mouse-hover should provide color-scheme preview\n### Description of the new feature\n\nThis is a tiny quality-of-life improvement request:\n\nCTRL + SHIFT + P   ----> \"Select color scheme...\"\n\nWe see now see a dropdown of all our color schemes.\nThe UP and DOWN arrows trigger a preview of the highlighted color-scheme.\nBut hovering the mouse over a color-scheme ...only results in a 'gentle highlight', no preview.\n\nMy request: hovering over a color-scheme should also trigger a preview in the current tab.\n\nThis may seem trivial, but it would be much appreciated.\n\n\n### Proposed technical implementation details\n\n_No response_\n", "hints_text": "You know, in retrospect it's surprising we missed this. Thank you!", "created_at": "2025-02-06 03:06:38", "merge_commit_sha": "a86c90a045f0850cfc0d9aef550f8606ac0b205a", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18483", "base_commit": "d6b56ae81843ba98b6716ff2102ade87a461b38d", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.cpp b/src/cascadia/TerminalApp/CommandPalette.cpp\nindex 4817cd52424..bcee25c72dd 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.cpp\n+++ b/src/cascadia/TerminalApp/CommandPalette.cpp\n@@ -359,7 +359,7 @@ namespace winrt::TerminalApp::implementation\n             _switchToMode(CommandPaletteMode::CommandlineMode);\n             e.Handled(true);\n         }\n-        else if (key == VirtualKey::C && ctrlDown)\n+        else if ((key == VirtualKey::C || key == VirtualKey::Insert) && ctrlDown)\n         {\n             _searchBox().CopySelectionToClipboard();\n             e.Handled(true);\n", "test_patch": "", "problem_statement": "Ctrl+Insert does not copy the selected text from Command Palette\n# Environment\r\n\r\n```none\r\nWindows build number: 10.0.19042.867\r\nWindows Terminal version (if applicable): 1.6.10571.0\r\n```\r\n\r\n# Steps to reproduce\r\n\r\n1. Delete any saved Windows Terminal settings.\r\n2. Start Windows Terminal.\r\n3. Use the mouse to select some text in the pane.\r\n4. Press Ctrl+Shift+P to open the command palette.\r\n5. Type `abc`.\r\n6. Press Ctrl+A to select the text `abc`.\r\n7. Press Ctrl+Insert.\r\n\r\n# Expected behavior\r\n\r\nThe text `abc` should be copied to the clipboard, and the command palette should remain open.\r\n\r\n# Actual behavior\r\n\r\nThe command palette closes, and the text that you selected in the pane is copied to the clipboard.\r\n\r\n# Notes\r\n\r\nIf you copy by pressing Ctrl+C instead of Ctrl+Insert, then it works as expected.\n", "hints_text": "I see, <https://github.com/microsoft/terminal/pull/9056> added special handling for Ctrl+C and Ctrl+V in the command palette, but not for Ctrl+Insert and Shift+Insert.\nWait holy _what now_ - Does <kbd>ctrl+Ins</kbd> just work (pretty much) everywhere in the OS? I did _not_ know that. TIL! That sems like an easy enough fix.\nWikipedia lists Ctrl+Insert copying as being part of the [IBM Common User Access](https://en.wikipedia.org/wiki/IBM_Common_User_Access) standard.\nWe have _got_ to figure out what to do about key bindings and how they impact or do not impact certain scopes.\nI'm inclined to reject a pull request at this point that adds a fourth band-aid to the command palette (AND THE SEARCH BOX) by introducing another \"did the user press THIS key?\" check.\nMaybe the precedence could depend on the action to which the key is bound.\nWhat a headache. Everything starts with us not getting some keys in KeyDown handler (as they get handled by inner controls). As a result we register to PreviewKeyDown, that propagates top down. And this gives the key bindings a priority over the controls (e.g., ctrl+c key binding would get priority over ctrl+c in search box). To address this we have added special flows in the PreviewKeyDown handler, covering ctr+c, but not ctrl+insert (which I would expect to work if it was not bound).\n\nAs Dustin mentioned we need to find a good approach.\n\nI really don't understand the decision not to bubble up some keys.\nIf I am renaming a tab in Windows Terminal Preview 1.7.572.0 and press the Left arrow key when the insertion point is already at the beginning of the edit box, then it closes the edit box and commits the change as if I had pressed Enter. Is that a consequence of keys being bubbled up and the edit box deciding not to handle the key? If so, I hope this behavior won't spread to the command palette and the find box.\n> \r\n> \r\n> If I am renaming a tab in Windows Terminal Preview 1.7.572.0 and press the Left arrow key when the insertion point is already at the beginning of the edit box, then it closes the edit box and commits the change as if I had pressed Enter. Is that a consequence of keys being bubbled up and the edit box deciding not to handle the key? If so, I hope this behavior won't spread to the command palette and the find box.\r\n\r\n@KalleOlaviNiemitalo - not sure how you find all these :smile:. I think this one is unrelated, the Left key switches to another tab (I guess the TabView catches it and decides to switch to an adjacent), causing the renamer box to lose focus. If we want to fix this, we should probably open a separate ticket\r\n\nHello everyone! I'd like to address this issue by adding a conditional check for `CTRL` with either `Insert` or `C` for the copy action, similar to the approach used in [PR #9056](https://github.com/microsoft/terminal/pull/9056). \n\nI noticed that `Insert` is just a virtual key (rather than a modifier), which means it doesn't trigger the same way on \"KeyDown.\" So, while this doesn't solve the underlying issues mentioned in the comments, it should fix the copy behaviour in the command palette with minimal changes.\n\nPlease let me know if this direction works for you! If this sounds good, I can create a new branch and a draft PR. \ud83d\ude0a\nI would also like to take this up.", "created_at": "2025-01-31 02:58:02", "merge_commit_sha": "2e92a15464929401bf10f94d7ca5ebce62dc0a11", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18462", "base_commit": "08f9afe31547c109536eb260171fe3b83835d1ff", "patch": "diff --git a/.github/actions/spelling/allow/allow.txt b/.github/actions/spelling/allow/allow.txt\nindex 630edfebce7..a936b3df359 100644\n--- a/.github/actions/spelling/allow/allow.txt\n+++ b/.github/actions/spelling/allow/allow.txt\n@@ -11,6 +11,7 @@ colorbrewer\n commandlines\n consvc\n copyable\n+CText\n dalet\n dcs\n deselection\ndiff --git a/src/cascadia/TerminalConnection/ConptyConnection.cpp b/src/cascadia/TerminalConnection/ConptyConnection.cpp\nindex 0a0b26aa934..075eb734356 100644\n--- a/src/cascadia/TerminalConnection/ConptyConnection.cpp\n+++ b/src/cascadia/TerminalConnection/ConptyConnection.cpp\n@@ -428,6 +428,20 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n             TerminalOutput.raise(L\"\\r\\n\");\n             TerminalOutput.raise(badPathText);\n         }\n+        // If the requested action requires elevation, display appropriate message\n+        else if (hr == HRESULT_FROM_WIN32(ERROR_ELEVATION_REQUIRED))\n+        {\n+            const auto elevationText = RS_(L\"ElevationRequired\");\n+            TerminalOutput.raise(L\"\\r\\n\");\n+            TerminalOutput.raise(elevationText);\n+        }\n+        // If the requested executable was not found, display appropriate message\n+        else if (hr == HRESULT_FROM_WIN32(ERROR_FILE_NOT_FOUND))\n+        {\n+            const auto fileNotFoundText = RS_(L\"FileNotFound\");\n+            TerminalOutput.raise(L\"\\r\\n\");\n+            TerminalOutput.raise(fileNotFoundText);\n+        }\n \n         _transitionToState(ConnectionState::Failed);\n \ndiff --git a/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw b/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\nindex 3532e310491..82c7291a607 100644\n--- a/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\n@@ -209,7 +209,7 @@\n   </data>\r\n   <data name=\"CtrlDToClose\" xml:space=\"preserve\">\r\n     <value>You can now close this terminal with Ctrl+D, or press Enter to restart.</value>\r\n-\t  <comment>\"Ctrl+D\" and \"Enter\" represent keys the user will press (control+D and Enter).</comment>\r\n+    <comment>\"Ctrl+D\" and \"Enter\" represent keys the user will press (control+D and Enter).</comment>\r\n   </data>\r\n   <data name=\"ProcessFailedToLaunch\" xml:space=\"preserve\">\r\n     <value>[error {0} when launching `{1}']</value>\r\n@@ -220,4 +220,10 @@\n     <value>Could not access starting directory \"{0}\"</value>\r\n     <comment>The first argument {0} is a path to a directory on the filesystem, as provided by the user.</comment>\r\n   </data>\r\n-</root>\r\n+  <data name=\"ElevationRequired\" xml:space=\"preserve\">\r\n+    <value>The requested operation requires elevation.</value>\r\n+  </data>\r\n+  <data name=\"FileNotFound\" xml:space=\"preserve\">\r\n+    <value>The system cannot find the file specified.</value>\r\n+  </data>\r\n+</root>\n\\ No newline at end of file\n", "test_patch": "", "problem_statement": "Show a more descriptive error message when the ConptyConnection fails to start for some reason\n# Description of the new feature/enhancement\r\n\r\nShow a speaking error message, when it is necessary to run Terminal with admin privileges. See https://github.com/microsoft/terminal/issues/4272 for the problem\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\nShow a more descriptive error message when the ConptyConnection fails to start for some reason\n# Description of the new feature/enhancement\r\n\r\nShow a speaking error message, when it is necessary to run Terminal with admin privileges. See https://github.com/microsoft/terminal/issues/4272 for the problem\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\n", "hints_text": "How about just displaying the error message that matches the error code, like so:\r\n\r\n```\r\n[error 0x800702e4 when launching `C:\\Program Files\\PowerShell\\6\\pwsh.exe']\r\nThe requested operation requires elevation.\r\n```\r\n\r\nOr does Windows Terminal have to recognize the 0x800702e4 code specifically and display something more verbose?\nI think displaying the error message would be perfectly fine. I had to google it. With the error message, this wouldn't have been necessary.\nCould even extend that to process exit codes that look like NTSTATUS error codes:\r\n\r\n```\r\n[process exited with code 3221225786]\r\nThe application terminated as a result of a CTRL+C.\r\n```\r\n\r\nThat would have a greater risk of false matches, though.\nThis isn't a bad idea, and I bet @DHowett thought about something like this when he first added the error codes\nYeah, we can definitely do better with these error messages!\nFor those who'd like to try this themselves, I added a similar kind of error message in #10045. \r\n\r\nCollected relevant error messages:\r\n\r\nSymbolic Name | Error Description | Header\r\n-- | -- | --\r\nERROR_ELEVATION_REQUIRED | The requested operation requires elevation. | winerror.h\r\nSTATUS_CONTROL_C_EXIT | {Application Exit by CTRL+C} The application terminated as a result of a CTRL+C. | ntstatus.h\r\n[MSG_DIR_BAD_COMMAND_OR_FILE ](https://github.com/microsoft/terminal/issues/11073)| '%1' is not recognized as an internal or external command, operable program or batch file. | cmdmsg.h\r\n\r\n\nHello , I have read through the issue and I want to try to help in adding the new error message , Can someone guide me as to how to recreate the same runtime conditions as in #4272 ?\n@Harshit-Agarwal-2022, create a Windows Terminal profile that runs `%windir%\\system32\\msconfig.exe`, and try to start that profile.  The application requires elevation, and this causes error 2147943140 (0x800702e4) as in <https://github.com/microsoft/terminal/issues/4272> (unless Windows Terminal itself is elevated).\n@Harshit-Agarwal-2022 You still working on this issue?\n\n@ATOMworkplace I was facing some issues with vs 2022 while building the terminal repo on my local system so i havent started with the issue yet , you can work on it if you want , I was able to recreate the error log using @KalleOlaviNiemitalo 's instructions\n@Harshit-Agarwal-2022 Sure, thanks for letting me know, I'll give it a try and see what I can do.\nHow about just displaying the error message that matches the error code, like so:\r\n\r\n```\r\n[error 0x800702e4 when launching `C:\\Program Files\\PowerShell\\6\\pwsh.exe']\r\nThe requested operation requires elevation.\r\n```\r\n\r\nOr does Windows Terminal have to recognize the 0x800702e4 code specifically and display something more verbose?\nI think displaying the error message would be perfectly fine. I had to google it. With the error message, this wouldn't have been necessary.\nCould even extend that to process exit codes that look like NTSTATUS error codes:\r\n\r\n```\r\n[process exited with code 3221225786]\r\nThe application terminated as a result of a CTRL+C.\r\n```\r\n\r\nThat would have a greater risk of false matches, though.\nThis isn't a bad idea, and I bet @DHowett thought about something like this when he first added the error codes\nYeah, we can definitely do better with these error messages!\nFor those who'd like to try this themselves, I added a similar kind of error message in #10045. \r\n\r\nCollected relevant error messages:\r\n\r\nSymbolic Name | Error Description | Header\r\n-- | -- | --\r\nERROR_ELEVATION_REQUIRED | The requested operation requires elevation. | winerror.h\r\nSTATUS_CONTROL_C_EXIT | {Application Exit by CTRL+C} The application terminated as a result of a CTRL+C. | ntstatus.h\r\n[MSG_DIR_BAD_COMMAND_OR_FILE ](https://github.com/microsoft/terminal/issues/11073)| '%1' is not recognized as an internal or external command, operable program or batch file. | cmdmsg.h\r\n\r\n\nHello , I have read through the issue and I want to try to help in adding the new error message , Can someone guide me as to how to recreate the same runtime conditions as in #4272 ?\n@Harshit-Agarwal-2022, create a Windows Terminal profile that runs `%windir%\\system32\\msconfig.exe`, and try to start that profile.  The application requires elevation, and this causes error 2147943140 (0x800702e4) as in <https://github.com/microsoft/terminal/issues/4272> (unless Windows Terminal itself is elevated).\n@Harshit-Agarwal-2022 You still working on this issue?\n\n@ATOMworkplace I was facing some issues with vs 2022 while building the terminal repo on my local system so i havent started with the issue yet , you can work on it if you want , I was able to recreate the error log using @KalleOlaviNiemitalo 's instructions\n@Harshit-Agarwal-2022 Sure, thanks for letting me know, I'll give it a try and see what I can do.", "created_at": "2025-01-26 06:32:10", "merge_commit_sha": "f7e853cd9f515ff0c7e52ab0eb0604bb95d47ba3", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18445", "base_commit": "25392ea6042242eceeb95cca29ca18784cf0ee7b", "patch": "diff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex 55f9bac881d..b77cf969f49 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -1354,6 +1354,7 @@ PNMLINK\n pntm\n POBJECT\n Podcast\n+POINTERUPDATE\n POINTSLIST\n policheck\n POLYTEXTW\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 3724edd542c..d40ea2feb7f 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -47,66 +47,6 @@ constexpr std::wstring_view StateCollapsed{ L\"Collapsed\" };\n DEFINE_ENUM_FLAG_OPERATORS(winrt::Microsoft::Terminal::Control::CopyFormat);\r\n DEFINE_ENUM_FLAG_OPERATORS(winrt::Microsoft::Terminal::Control::MouseButtonState);\r\n \r\n-// WinUI 3's UIElement.ProtectedCursor property allows someone to set the cursor on a per-element basis.\r\n-// This would allow us to hide the cursor when the TermControl has input focus and someone starts typing.\r\n-// Unfortunately, no equivalent exists for WinUI 2 so we fake it with the CoreWindow.\r\n-// There are 3 downsides:\r\n-// * SetPointerCapture() is global state and may interfere with other components.\r\n-// * You can't start dragging the cursor (for text selection) while it's still hidden.\r\n-// * The CoreWindow covers the union of all window rectangles, so the cursor is hidden even if it's outside\r\n-//   the current foreground window, but still on top of another Terminal window in the background.\r\n-static void hideCursorUntilMoved()\r\n-{\r\n-    static bool cursorIsHidden;\r\n-    static const auto shouldVanish = []() {\r\n-        BOOL shouldVanish = TRUE;\r\n-        SystemParametersInfoW(SPI_GETMOUSEVANISH, 0, &shouldVanish, 0);\r\n-        if (!shouldVanish)\r\n-        {\r\n-            return false;\r\n-        }\r\n-\r\n-        const auto window = CoreWindow::GetForCurrentThread();\r\n-        static constexpr auto releaseCapture = [](CoreWindow window, PointerEventArgs) {\r\n-            if (cursorIsHidden)\r\n-            {\r\n-                window.ReleasePointerCapture();\r\n-            }\r\n-        };\r\n-        static constexpr auto restoreCursor = [](CoreWindow window, PointerEventArgs) {\r\n-            if (cursorIsHidden)\r\n-            {\r\n-                cursorIsHidden = false;\r\n-                window.PointerCursor(CoreCursor{ CoreCursorType::Arrow, 0 });\r\n-            }\r\n-        };\r\n-\r\n-        winrt::Windows::Foundation::TypedEventHandler<CoreWindow, PointerEventArgs> releaseCaptureHandler{ releaseCapture };\r\n-        std::ignore = window.PointerMoved(releaseCaptureHandler);\r\n-        std::ignore = window.PointerPressed(releaseCaptureHandler);\r\n-        std::ignore = window.PointerReleased(releaseCaptureHandler);\r\n-        std::ignore = window.PointerWheelChanged(releaseCaptureHandler);\r\n-        std::ignore = window.PointerCaptureLost(restoreCursor);\r\n-        return true;\r\n-    }();\r\n-\r\n-    if (shouldVanish && !cursorIsHidden)\r\n-    {\r\n-        try\r\n-        {\r\n-            const auto window = CoreWindow::GetForCurrentThread();\r\n-            window.PointerCursor(nullptr);\r\n-            window.SetPointerCapture();\r\n-            cursorIsHidden = true;\r\n-        }\r\n-        catch (...)\r\n-        {\r\n-            // Swallow the 0x80070057 \"Failed to get pointer information.\" exception that randomly occurs.\r\n-            // Curiously, it doesn't happen during the PointerCursor() but during the SetPointerCapture() call (thanks, WinUI).\r\n-        }\r\n-    }\r\n-}\r\n-\r\n // InputPane::GetForCurrentView() does not reliably work for XAML islands,\r\n // as it assumes that there's a 1:1 relationship between windows and threads.\r\n //\r\n@@ -1551,8 +1491,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             return;\r\n         }\r\n \r\n-        hideCursorUntilMoved();\r\n-\r\n         const auto ch = e.Character();\r\n         const auto keyStatus = e.KeyStatus();\r\n         const auto scanCode = gsl::narrow_cast<WORD>(keyStatus.ScanCode);\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.cpp b/src/cascadia/WindowsTerminal/IslandWindow.cpp\nindex 4c950cb986d..4b965be4022 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.cpp\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.cpp\n@@ -26,6 +26,48 @@ using VirtualKeyModifiers = winrt::Windows::System::VirtualKeyModifiers;\n #define XAML_HOSTING_WINDOW_CLASS_NAME L\"CASCADIA_HOSTING_WINDOW_CLASS\"\r\n #define IDM_SYSTEM_MENU_BEGIN 0x1000\r\n \r\n+// WinUI doesn't support the \"Hide cursor on input\" setting which is why all the modern Windows apps\r\n+// are broken in that respect. We want to support it though, so we implement an imitation of it here.\r\n+// We use the classic ShowCursor() API to hide it on keydown and show it on a select few messages.\r\n+// WinUI's SetPointerCapture() cannot be used for this, because it races with internal WinUI code\r\n+// calling that function and has proven itself to be very unreliable in practice.\r\n+//\r\n+// With UWP half the input stack got split off, and so most input events get rerouted through\r\n+// the CoreInput child window running in another thread (aka InputHost aka Windows.UI.Input).\r\n+// HideCursor() is called by WindowEmperor because WM_KEYDOWN is otherwise sent directly to that\r\n+// CoreInput window. Same for WM_POINTERUPDATE which we use to reliably detect cursor movement.\r\n+// WM_ACTIVATE on the other hand is only sent to each specific window and cannot be hooked by\r\n+// inspecting the MSG struct coming from GetMessage. That's why the code must be here.\r\n+// Best not think about this too much...\r\n+bool IslandWindow::IsCursorHidden() noexcept\r\n+{\r\n+    return _cursorHidden;\r\n+}\r\n+\r\n+void IslandWindow::HideCursor() noexcept\r\n+{\r\n+    static const auto shouldVanish = []() noexcept {\r\n+        BOOL shouldVanish = TRUE;\r\n+        SystemParametersInfoW(SPI_GETMOUSEVANISH, 0, &shouldVanish, 0);\r\n+        return shouldVanish != FALSE;\r\n+    }();\r\n+\r\n+    if (!_cursorHidden && shouldVanish)\r\n+    {\r\n+        ShowCursor(FALSE);\r\n+        _cursorHidden = true;\r\n+    }\r\n+}\r\n+\r\n+void IslandWindow::ShowCursorMaybe(const UINT message) noexcept\r\n+{\r\n+    if (_cursorHidden && (message == WM_ACTIVATE || message == WM_POINTERUPDATE))\r\n+    {\r\n+        _cursorHidden = false;\r\n+        ShowCursor(TRUE);\r\n+    }\r\n+}\r\n+\r\n IslandWindow::IslandWindow() noexcept :\r\n     _interopWindowHandle{ nullptr },\r\n     _rootGrid{ nullptr },\r\n@@ -425,6 +467,11 @@ void IslandWindow::_OnGetMinMaxInfo(const WPARAM /*wParam*/, const LPARAM lParam\n \r\n [[nodiscard]] LRESULT IslandWindow::MessageHandler(UINT const message, WPARAM const wparam, LPARAM const lparam) noexcept\r\n {\r\n+    if (IsCursorHidden())\r\n+    {\r\n+        ShowCursorMaybe(message);\r\n+    }\r\n+\r\n     switch (message)\r\n     {\r\n     case WM_GETMINMAXINFO:\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.h b/src/cascadia/WindowsTerminal/IslandWindow.h\nindex 8432d4e8134..47d4e38ce98 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.h\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.h\n@@ -14,6 +14,10 @@ class IslandWindow :\n     public BaseWindow<IslandWindow>\n {\n public:\n+    static bool IsCursorHidden() noexcept;\n+    static void HideCursor() noexcept;\n+    static void ShowCursorMaybe(const UINT message) noexcept;\n+\n     IslandWindow() noexcept;\n     virtual ~IslandWindow() override;\n \n@@ -143,7 +147,7 @@ class IslandWindow :\n     bool _minimizeToNotificationArea{ false };\n \n     std::unordered_map<UINT, SystemMenuItemInfo> _systemMenuItems;\n-    UINT _systemMenuNextItemId;\n+    UINT _systemMenuNextItemId = 0;\n     void _resetSystemMenu();\n \n private:\n@@ -154,4 +158,6 @@ class IslandWindow :\n     // though the total height will take into account the non-client area\n     // and the requirements of components hosted in the client area\n     static constexpr float minimumHeight = 0;\n+\n+    inline static bool _cursorHidden;\n };\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 59f26b50b16..16e128d077b 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -417,6 +417,16 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n                 _dispatchSpecialKey(msg);\r\n                 continue;\r\n             }\r\n+\r\n+            if (msg.message == WM_KEYDOWN)\r\n+            {\r\n+                IslandWindow::HideCursor();\r\n+            }\r\n+        }\r\n+\r\n+        if (IslandWindow::IsCursorHidden())\r\n+        {\r\n+            IslandWindow::ShowCursorMaybe(msg.message);\r\n         }\r\n \r\n         TranslateMessage(&msg);\r\n", "test_patch": "", "problem_statement": "[Terminal Canary] Cursor doesn't show up in Terminal\n### Windows Terminal version\n\n1.23.10011.0\n\n### Windows build number\n\n10.0.27764.1000\n\n### Other Software\n\nsudo for Windows (1.0.1)\n\n### Steps to reproduce\n\n1. Launch Terminal Canary \n2. Launch a command with `sudo`\n3. Hover over the terminal with the cursor\n\n### Expected Behavior\n\nThe cursor should be visible when you hover over the Terminal launched with administrative privileges.\n\n### Actual Behavior\n\nCursor isn't showing when you hover over the Terminal.\n\nhttps://github.com/user-attachments/assets/b0ace3d3-c69e-475b-bac9-c864db5d76c7\n\n\n", "hints_text": "Thanks for the report! This was most likely fixed by #18345. It took a while to merge it because we were out on vacation. It should be available in the next canary build (tomorrow?).\nStill happens even in the latest build. New plan: Ditch WinRT, and do it via Win32.", "created_at": "2025-01-21 13:02:50", "merge_commit_sha": "c56fb1b2d287db9ef1eb97545a81760e3faf3452", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18444", "base_commit": "25392ea6042242eceeb95cca29ca18784cf0ee7b", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 59f26b50b16..91e1a9bdb92 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -387,6 +387,9 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     MSG msg{};\r\n     while (GetMessageW(&msg, nullptr, 0, 0))\r\n     {\r\n+        // This is `if (WM_KEYDOWN || WM_KEYUP || WM_SYSKEYDOWN || WM_SYSKEYUP)`.\r\n+        // It really doesn't need to be written that obtuse, but it at\r\n+        // least nicely mirrors our `keyDown = msg.message & 1` logic.\r\n         // FYI: For the key-down/up messages the lowest bit indicates if it's up.\r\n         if ((msg.message & ~1) == WM_KEYDOWN || (msg.message & ~1) == WM_SYSKEYDOWN)\r\n         {\r\n@@ -401,7 +404,7 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n                 loggedInteraction = true;\r\n             }\r\n \r\n-            const bool keyDown = msg.message & 1;\r\n+            const bool keyDown = (msg.message & 1) == 0;\r\n             if (\r\n                 // GH#638: The Xaml input stack doesn't allow an application to suppress the \"caret browsing\"\r\n                 // dialog experience triggered when you press F7. Official recommendation from the Xaml\r\n@@ -438,15 +441,13 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     __assume(false);\r\n }\r\n \r\n-void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\r\n+void WindowEmperor::_dispatchSpecialKey(const MSG& msg) const\r\n {\r\n-    const auto hwnd = msg.hwnd;\r\n+    // Each CoreInput window is a child of our IslandWindow.\r\n+    // We can figure out the IslandWindow HWND via GetAncestor().\r\n+    const auto hwnd = GetAncestor(msg.hwnd, GA_ROOT);\r\n     AppHost* window = nullptr;\r\n \r\n-    // Just in case someone has targed a specific HWND,\r\n-    // we'll try to dispatch it to the corresponding class.\r\n-    // Usually this will not find anything because under WinUI the hidden CoreInput\r\n-    // window is responsible for all input handling (for whatever reason).\r\n     for (const auto& h : _windows)\r\n     {\r\n         const auto w = h->GetWindow();\r\n@@ -457,6 +458,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n         }\r\n     }\r\n \r\n+    // Fallback.\r\n     if (!window)\r\n     {\r\n         window = _mostRecentWindow();\r\n@@ -468,7 +470,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n \r\n     const auto vkey = gsl::narrow_cast<uint32_t>(msg.wParam);\r\n     const auto scanCode = gsl::narrow_cast<uint8_t>(msg.lParam >> 16);\r\n-    const bool keyDown = msg.message & 1;\r\n+    const bool keyDown = (msg.message & 1) == 0;\r\n     window->OnDirectKeyEvent(vkey, scanCode, keyDown);\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.h b/src/cascadia/WindowsTerminal/WindowEmperor.h\nindex 6b9b101507f..ca30159ac2d 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.h\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.h\n@@ -50,7 +50,7 @@ class WindowEmperor\n     AppHost* _mostRecentWindow() const noexcept;\r\n     bool _summonWindow(const SummonWindowSelectionArgs& args) const;\r\n     void _summonAllWindows() const;\r\n-    void _dispatchSpecialKey(MSG& msg) const;\r\n+    void _dispatchSpecialKey(const MSG& msg) const;\r\n     void _dispatchCommandline(winrt::TerminalApp::CommandlineArgs args);\r\n     safe_void_coroutine _dispatchCommandlineCurrentDesktop(winrt::TerminalApp::CommandlineArgs args);\r\n     LRESULT _messageHandler(HWND window, UINT message, WPARAM wParam, LPARAM lParam) noexcept;\r\n", "test_patch": "", "problem_statement": "Alt and F7 don't work in 1.23.3481.0\n### Windows Terminal version\n\n1.23.3481.0\n\n### Windows build number\n\n10.0.19045.5247\n\n### Other Software\n\nFAR Manager 3.0.6401.0 x64\n\nwhen migrate from canary build terminal-1.23.3461.0 to next canary build terminal-1.23.3481.0\ni have trouble with keys: Alt/RAlt and F7\n\n### Steps to reproduce\n\nrun utility KeyEvents.exe and press Alt and F7\n\n\n\n### Expected Behavior\n\nresult when press Alt:\n\nterminal-1.23.3461.0 - good behavior\n02:56:37 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n02:56:37 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\nresult when press f7:\n\nterminal-1.23.3461.0 - good behavior\n\n03:08:36 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:08:36 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n### Actual Behavior\n\nresult when press Alt:\n\nterminal-1.23.3481.0 - bad behavior\n02:54:44 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n\n\nresult when press f7:\n\nterminal-1.23.3481.0 - bad behavior\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n", "hints_text": "@lhecker @DHowett \n\nafter close issue is out:\nterminal-1.23.10061.0\nterminal-1.23.10081.0\n\nbut nothing fixed. \nThe problem still exists...", "created_at": "2025-01-21 12:52:11", "merge_commit_sha": "b33bde199226da043efc15f9cb90cc9971996898", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18434", "base_commit": "25392ea6042242eceeb95cca29ca18784cf0ee7b", "patch": "diff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 7b4893fef1a..b2ae698205a 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -118,7 +118,7 @@ namespace winrt::TerminalApp::implementation\n     void TerminalPage::_HandleCloseWindow(const IInspectable& /*sender*/,\r\n                                           const ActionEventArgs& args)\r\n     {\r\n-        CloseRequested.raise(nullptr, nullptr);\r\n+        CloseWindow();\r\n         args.Handled(true);\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 87e7b17437b..23258c25095 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -182,7 +182,6 @@ namespace winrt::TerminalApp::implementation\n         til::typed_event<IInspectable, IInspectable> SummonWindowRequested;\n         til::typed_event<IInspectable, winrt::Microsoft::Terminal::Control::WindowSizeChangedEventArgs> WindowSizeChanged;\n \n-        til::typed_event<IInspectable, IInspectable> CloseRequested;\n         til::typed_event<IInspectable, IInspectable> OpenSystemMenu;\n         til::typed_event<IInspectable, IInspectable> QuitRequested;\n         til::typed_event<IInspectable, winrt::Microsoft::Terminal::Control::ShowWindowArgs> ShowWindowChanged;\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.idl b/src/cascadia/TerminalApp/TerminalPage.idl\nindex 2679d775b09..2788cedd10c 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.idl\n+++ b/src/cascadia/TerminalApp/TerminalPage.idl\n@@ -95,7 +95,6 @@ namespace TerminalApp\n         event Windows.Foundation.TypedEventHandler<Object, Object> SummonWindowRequested;\n         event Windows.Foundation.TypedEventHandler<Object, Microsoft.Terminal.Control.WindowSizeChangedEventArgs> WindowSizeChanged;\n \n-        event Windows.Foundation.TypedEventHandler<Object, Object> CloseRequested;\n         event Windows.Foundation.TypedEventHandler<Object, Object> OpenSystemMenu;\n         event Windows.Foundation.TypedEventHandler<Object, Microsoft.Terminal.Control.ShowWindowArgs> ShowWindowChanged;\n \ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.h b/src/cascadia/TerminalApp/TerminalWindow.h\nindex a722468a547..7467b64241d 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.h\n+++ b/src/cascadia/TerminalApp/TerminalWindow.h\n@@ -219,7 +219,6 @@ namespace winrt::TerminalApp::implementation\n         FORWARDED_TYPED_EVENT(SetTaskbarProgress, winrt::Windows::Foundation::IInspectable, winrt::Windows::Foundation::IInspectable, _root, SetTaskbarProgress);\r\n         FORWARDED_TYPED_EVENT(IdentifyWindowsRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, IdentifyWindowsRequested);\r\n         FORWARDED_TYPED_EVENT(SummonWindowRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, SummonWindowRequested);\r\n-        FORWARDED_TYPED_EVENT(CloseRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, CloseRequested);\r\n         FORWARDED_TYPED_EVENT(OpenSystemMenu, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, OpenSystemMenu);\r\n         FORWARDED_TYPED_EVENT(QuitRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, QuitRequested);\r\n         FORWARDED_TYPED_EVENT(ShowWindowChanged, Windows::Foundation::IInspectable, winrt::Microsoft::Terminal::Control::ShowWindowArgs, _root, ShowWindowChanged);\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.idl b/src/cascadia/TerminalApp/TerminalWindow.idl\nindex 24ce090e378..f0bf2a98bd2 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.idl\n+++ b/src/cascadia/TerminalApp/TerminalWindow.idl\n@@ -122,7 +122,6 @@ namespace TerminalApp\n         event Windows.Foundation.TypedEventHandler<Object, Object> IdentifyWindowsRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> IsQuakeWindowChanged;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> SummonWindowRequested;\r\n-        event Windows.Foundation.TypedEventHandler<Object, Object> CloseRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> OpenSystemMenu;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> QuitRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, TerminalApp.SystemMenuChangeArgs> SystemMenuChangeRequested;\r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.cpp b/src/cascadia/WindowsTerminal/AppHost.cpp\nindex ac255aa95b2..0fd623aad61 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.cpp\n+++ b/src/cascadia/WindowsTerminal/AppHost.cpp\n@@ -213,9 +213,6 @@ void AppHost::Initialize()\n     _windowCallbacks.WindowCloseButtonClicked = _window->WindowCloseButtonClicked([this]() {\r\n         _windowLogic.CloseWindow();\r\n     });\r\n-    // If the user requests a close in another way handle the same as if the 'X'\r\n-    // was clicked.\r\n-    _revokers.CloseRequested = _windowLogic.CloseRequested(winrt::auto_revoke, { this, &AppHost::_CloseRequested });\r\n \r\n     // Add an event handler to plumb clicks in the titlebar area down to the\r\n     // application layer.\r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.h b/src/cascadia/WindowsTerminal/AppHost.h\nindex fba8274b176..be987ef0c7a 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.h\n+++ b/src/cascadia/WindowsTerminal/AppHost.h\n@@ -138,7 +138,6 @@ class AppHost : public std::enable_shared_from_this<AppHost>\n     struct Revokers\r\n     {\r\n         winrt::TerminalApp::TerminalWindow::Initialized_revoker Initialized;\r\n-        winrt::TerminalApp::TerminalWindow::CloseRequested_revoker CloseRequested;\r\n         winrt::TerminalApp::TerminalWindow::RequestedThemeChanged_revoker RequestedThemeChanged;\r\n         winrt::TerminalApp::TerminalWindow::FullscreenChanged_revoker FullscreenChanged;\r\n         winrt::TerminalApp::TerminalWindow::FocusModeChanged_revoker FocusModeChanged;\r\n", "test_patch": "", "problem_statement": "Windows Terminal Alt+F4 behaviour\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.3880\n\n### Other Software\n\nAlso reproducible in:\r\nWindows Terminal Preview\r\nVersion: 1.21.1772.0\n\n### Steps to reproduce\n\n1. Start Windows Terminal.\r\n2. Open Settings -> Interaction -> Warn when closing more than one tab -> On -> Save.\r\n3. Close Settings tab and open any second terminal tab.\r\n4. Try to close terminal window with the X button in the upper right corner. It will ask for confirmation.\r\n5. Try to close terminal window with Alt+F4 shortcut. It will close window without confirmation.\r\n6. When Settings tab is active, it sometimes asks for confilmation when I press Alt+F4, but mostly not.\n\n### Expected Behavior\n\nWindows Terminal should ask for confirmation when closing window in any way: titlebar button, Alt+F4, Alt+Space menu, Taskbar menu, etc.\n\n### Actual Behavior\n\nPressing Alt+F4 shortcut will close Window Terminal window without confirmation, but pressing title bar 'close' button shows confirmation according to \"Settings -> Interaction -> Warn when closing more than one tab\" configuration.\n", "hints_text": "I think this may be a known problem, because there are a few open issues related to the close confirmation that could potentially cover this scenario. Possibly #2976 or #6549.\nIndeed, looks like those are similar, but I think this case is quite straightforward and could be fixed directly, without discussion of complex logic and consequences.\r\nActually, Alt+F4 seems to be the only unhandled way of closing the window. Alt+Space menu, taskbar menu and close button all show confirmations correctly.\nSo this was fixed a long time ago (see #2526), but it creeped up again?\r\n\r\nI did a work-around by reassigning `alt+f4` to [`quit`](https://learn.microsoft.com/en-us/windows/terminal/customize-settings/actions#quit):\r\n\r\n```json\r\n{ \"command\": \"quit\", \"keys\": \"alt+f4\" }\r\n```\r\n\r\n`quit` shows a confirmation dialog asking to close the window, regardless if [`confirmCloseAllTabs`](https://learn.microsoft.com/en-us/windows/terminal/customize-settings/appearance#show-close-all-tabs-popup) setting is explicitly set to `false` or not present.\n@codenotworking , thanks, with this workaround it indeed asks confirmation, but it's for the whole app now. Still, its better than nothing. Feels safer with confirmation :)\nCan't wait for this to be added. \r\n\r\nWhen you have 4 tabs open, and some of the tabs have 6 carefully arranged panes, some monitoring active processes \r\n\r\nAnd you have 4 screens, so you think your Alt-F4 is going to the app under your mouse pointer, but you haven't actually clicked it yet...\r\n\r\n...BAM! LOST ALL THAT WORK! OMG\r\n\r\nCan't wait for this to be fixed :) \nI'd like to work on this issue. ", "created_at": "2025-01-16 01:39:19", "merge_commit_sha": "fb7b0e1218ccc54394f700159195c87eb9b64d6e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18347", "base_commit": "7423dd3b2a8726631f1c4c0a0c7b5f9fcd7def08", "patch": "diff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 9501f64a85e..707415015a6 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -437,7 +437,8 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n     }\r\n \r\n     // 0. Useful tools/vars\r\n-    const auto bufferSize = _activeBuffer().GetSize();\r\n+    const auto& buffer = _activeBuffer();\r\n+    const auto bufferSize = buffer.GetSize();\r\n     const auto viewportHeight = _GetMutableViewport().Height();\r\n \r\n     // The patterns are stored relative to the \"search area\". Initially, this search area will be the viewport,\r\n@@ -504,8 +505,18 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n     };\r\n \r\n     // 1. Look for the hyperlink\r\n-    til::point searchStart = dir == SearchDirection::Forward ? _selection->start : til::point{ bufferSize.Left(), _VisibleStartIndex() };\r\n-    til::point searchEnd = dir == SearchDirection::Forward ? til::point{ bufferSize.RightInclusive(), _VisibleEndIndex() } : _selection->start;\r\n+    til::point searchStart;\r\n+    til::point searchEnd;\r\n+    if (dir == SearchDirection::Forward)\r\n+    {\r\n+        searchStart = _selection->start;\r\n+        searchEnd = til::point{ bufferSize.RightInclusive(), _VisibleEndIndex() };\r\n+    }\r\n+    else\r\n+    {\r\n+        searchStart = til::point{ bufferSize.Left(), _VisibleStartIndex() };\r\n+        searchEnd = _selection->start;\r\n+    }\r\n \r\n     // 1.A) Try searching the current viewport (no scrolling required)\r\n     auto resultList = _patternIntervalTree.findContained(convertToSearchArea(searchStart), convertToSearchArea(searchEnd));\r\n@@ -547,27 +558,81 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n                 searchArea = Viewport::FromDimensions(searchStart, { searchEnd.x + 1, searchEnd.y + 1 });\r\n             }\r\n         }\r\n+    }\r\n \r\n-        // 1.C) Nothing was found. Bail!\r\n-        if (!result.has_value())\r\n+    // 2. We found a hyperlink from the pattern tree. Look for embedded hyperlinks too!\r\n+    // Use the result (if one was found) to narrow down the search.\r\n+    if (dir == SearchDirection::Forward)\r\n+    {\r\n+        searchStart = _selection->start;\r\n+        searchEnd = (result ? result->first : buffer.GetLastNonSpaceCharacter());\r\n+    }\r\n+    else\r\n+    {\r\n+        searchStart = (result ? result->second : bufferSize.Origin());\r\n+        searchEnd = _selection->start;\r\n+    }\r\n+\r\n+    // Careful! Selection can point to RightExclusive(), which doesn't contain data!\r\n+    // Clamp to be safe.\r\n+    auto initialPos = dir == SearchDirection::Forward ? searchStart : searchEnd;\r\n+    bufferSize.Clamp(initialPos);\r\n+    auto iter = buffer.GetCellDataAt(initialPos);\r\n+    while (dir == SearchDirection::Forward ? iter.Pos() < searchEnd : iter.Pos() > searchStart)\r\n+    {\r\n+        // Don't let us select the same hyperlink again\r\n+        if (iter.Pos() < _selection->start || iter.Pos() > _selection->end)\r\n         {\r\n-            return;\r\n+            if (auto attr = iter->TextAttr(); attr.IsHyperlink())\r\n+            {\r\n+                // Found an embedded hyperlink!\r\n+                const auto hyperlinkId = attr.GetHyperlinkId();\r\n+\r\n+                // Expand the start to include the entire hyperlink\r\n+                TextBufferCellIterator hyperlinkStartIter{ buffer, iter.Pos() };\r\n+                while (hyperlinkStartIter.Pos() > searchStart && attr.IsHyperlink() && attr.GetHyperlinkId() == hyperlinkId)\r\n+                {\r\n+                    --hyperlinkStartIter;\r\n+                    attr = hyperlinkStartIter->TextAttr();\r\n+                }\r\n+                if (hyperlinkStartIter.Pos() != bufferSize.Origin())\r\n+                {\r\n+                    // undo a move to be inclusive\r\n+                    ++hyperlinkStartIter;\r\n+                }\r\n+\r\n+                // Expand the end to include the entire hyperlink\r\n+                // No need to undo a move! We'll decrement in the next step anyways.\r\n+                TextBufferCellIterator hyperlinkEndIter{ buffer, iter.Pos() };\r\n+                attr = hyperlinkEndIter->TextAttr();\r\n+                while (hyperlinkEndIter.Pos() < searchEnd && attr.IsHyperlink() && attr.GetHyperlinkId() == hyperlinkId)\r\n+                {\r\n+                    ++hyperlinkEndIter;\r\n+                    attr = hyperlinkEndIter->TextAttr();\r\n+                }\r\n+\r\n+                result = { hyperlinkStartIter.Pos(), hyperlinkEndIter.Pos() };\r\n+                break;\r\n+            }\r\n         }\r\n+        iter += dir == SearchDirection::Forward ? 1 : -1;\r\n     }\r\n \r\n-    // 2. Select the hyperlink\r\n+    // 3. Select the hyperlink, if one exists\r\n+    if (!result.has_value())\r\n     {\r\n-        auto selection{ _selection.write() };\r\n-        wil::hide_name _selection;\r\n-        selection->start = result->first;\r\n-        selection->pivot = result->first;\r\n-        selection->end = result->second;\r\n-        _selectionIsTargetingUrl = true;\r\n-        _selectionEndpoint = SelectionEndpoint::End;\r\n+        return;\r\n     }\r\n-\r\n-    // 3. Scroll to the selected area (if necessary)\r\n-    _ScrollToPoint(_selection->end);\r\n+    auto selection{ _selection.write() };\r\n+    wil::hide_name _selection;\r\n+    selection->start = result->first;\r\n+    selection->pivot = result->first;\r\n+    selection->end = result->second;\r\n+    _selectionIsTargetingUrl = true;\r\n+    _selectionEndpoint = SelectionEndpoint::End;\r\n+\r\n+    // 4. Scroll to the selected area (if necessary)\r\n+    _ScrollToPoint(selection->end);\r\n }\r\n \r\n Terminal::UpdateSelectionParams Terminal::ConvertKeyEventToUpdateSelectionParams(const ControlKeyStates mods, const WORD vkey) const noexcept\r\n", "test_patch": "", "problem_statement": "Move to OSC 8 hyperlinks with keyboard in mark mode\n# Description of the new feature/enhancement\r\n\r\nCurrently you can cycle through URLs in the scrollback buffer with tab and shift+tab in mark mode. It would be nice if this also worked with OSC 8 hyperlinks.\r\n\r\nRight now this:\r\n```bash\r\nprintf '\\e]8;;http://example.com\\e\\\\This is a link\\e]8;;\\e\\\\\\nhttp://example.com\\n'\r\n```\r\nonly lets you shift+tab back to the plain text link, not the OSC 8 one, which you would have to navigate to using the arrow keys.\n", "hints_text": "", "created_at": "2024-12-21 00:19:09", "merge_commit_sha": "35bd60782fec6486e6f7fd10ffa4d9c5de70790d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18325", "base_commit": "19460f98e059f1b4993a06afe5db2e412fa4b84d", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 66bc375d0af..6c25d4c8ade 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -170,6 +170,14 @@ static wil::unique_mutex acquireMutexOrAttemptHandoff(const wchar_t* className,\n                 .cbData = gsl::narrow<DWORD>(payload.size()),\r\n                 .lpData = payload.data(),\r\n             };\r\n+\r\n+            // Allow the existing instance to gain foreground rights.\r\n+            DWORD processId = 0;\r\n+            if (GetWindowThreadProcessId(hwnd, &processId) && processId)\r\n+            {\r\n+                AllowSetForegroundWindow(processId);\r\n+            }\r\n+\r\n             if (SendMessageTimeoutW(hwnd, WM_COPYDATA, 0, reinterpret_cast<LPARAM>(&cds), SMTO_ABORTIFHUNG | SMTO_ERRORONEXIT, 5000, nullptr))\r\n             {\r\n                 return {};\r\n", "test_patch": "", "problem_statement": "New window instances do not gain foreground rights\n### Windows Terminal version\n\n1.23.3471.0\n\n### Windows build number\n\n_No response_\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n* Set \"New instance behavior\" to \"Create a new window\"\n* Launch from the start menu (= first window, first tab)\n* Explicitly minimize\n* Launch from the start menu again\n\n### Expected Behavior\n\nNew window is in the foreground.\n\n### Actual Behavior\n\nNew window fails to gain foreground rights.\n", "hints_text": "Can we `AllowSetForeground`? I suppose we don't know the PID of the instance holding the mutex, do we. hmm....", "created_at": "2024-12-13 16:36:26", "merge_commit_sha": "50060452ea115b85e2af672434db8a1c1e140f1f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18229", "base_commit": "282670a092e3f60a0d9cf11b53d01a36a004edd5", "patch": "diff --git a/src/host/settings.cpp b/src/host/settings.cpp\nindex 746bd91564f..4650fbf9eb1 100644\n--- a/src/host/settings.cpp\n+++ b/src/host/settings.cpp\n@@ -36,7 +36,7 @@ Settings::Settings() :\n     _bAutoPosition(true),\r\n     _uHistoryBufferSize(DEFAULT_NUMBER_OF_COMMANDS),\r\n     _uNumberOfHistoryBuffers(DEFAULT_NUMBER_OF_BUFFERS),\r\n-    _bHistoryNoDup(true),\r\n+    _bHistoryNoDup(false),\r\n     // ColorTable initialized below\r\n     _uCodePage(ServiceLocator::LocateGlobals().uiOEMCP),\r\n     _uScrollScale(1),\r\n@@ -110,7 +110,7 @@ void Settings::ApplyDesktopSpecificDefaults()\n     _bQuickEdit = TRUE;\r\n     _uHistoryBufferSize = 50;\r\n     _uNumberOfHistoryBuffers = 4;\r\n-    _bHistoryNoDup = true;\r\n+    _bHistoryNoDup = FALSE;\r\n \r\n     _renderSettings.ResetColorTable();\r\n \r\ndiff --git a/src/propsheet/registry.cpp b/src/propsheet/registry.cpp\nindex 3a7283e080e..64d392aa76d 100644\n--- a/src/propsheet/registry.cpp\n+++ b/src/propsheet/registry.cpp\n@@ -79,7 +79,7 @@ VOID InitRegistryValues(\n     pStateInfo->CursorSize = 25;\r\n     pStateInfo->HistoryBufferSize = 25;\r\n     pStateInfo->NumberOfHistoryBuffers = 4;\r\n-    pStateInfo->HistoryNoDup = 1;\r\n+    pStateInfo->HistoryNoDup = 0;\r\n \r\n     // clang-format off\r\n     if (pStateInfo->fIsV2Console)\r\n", "test_patch": "", "problem_statement": "Can't cycle through command history using the down-arrow\n### Windows Terminal version\n\n1.21.2911.0\n\n### Windows build number\n\n10.0.22631.4391\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nI used to be able to run\n\n```\n> echo 1\n1\n> echo 2\n2\n> echo 3\n3\n```\nand then press UP ARROW three times to repeat `echo 1` and then DOWN ARROW to cycle through `echo 2`, `echo 3`, `echo 1`, etc. Now the first DOWN ARROW does nothing.\n\nI think both Command Prompt and PowerShell had this behavior. I do know I used that pattern of cycling through the history for Command Prompt quite frequently, but now I find that I must press UP ARROW three times each time I want to cycle through the last three commands. It would be nice to have the old behavior back.\n\nI haven't found any documentation or bug reports that addresses this issue. Thanks in advance for your help.\n\n### Expected Behavior\n\nAfter pressing UP ARROW three times and ENTER to execute the third command back in history, I expected pressing DOWN ARROW followed by ENTER to execute each of the past 3 commands in sequence ad infinitum.\n\n\n### Actual Behavior\n\nAfter pressing UP ARROW three times and ENTER to execute the third command back in history, pressing DOWN ARROW does nothing. No previous command is recalled from history.\n", "hints_text": "As a temporary measure, downgrading to release v1.21.2361.0 or lower rolls back this change.\nThank you. I rolled back to v1.21.2361.0 (which works well enough and resolves this issue for the time being) and look forward to the release of v1.23.\nApparently that's how cmd has always worked if \"Discard old duplicates\" is enabled, huh. I wonder if I should double-down by changing the \"Discard old duplicates\" behavior and add the \"circling\" that you describe, or if I should revert enabling it by default under Windows Terminal.\ni think a problem here is that the \"replay\" behaviour working consistently is dependent on not deleting old duplicate commands, since if you delete an old duplicate, you change the command sequence\n\ni.e. with dedup\n```\ncls\necho 1\necho 2\necho 3\n...\necho 2\n```\nmeans that \"replaying\" from cls onwards would then run\n```\ncls\necho 1\necho 3\n```\ni think that, if there can't be configuration on the user end, not having dedup is the better option since the only downside (afaik) is that it's inefficient usage of the history buffer (and to my knowledge that shoudn't be an issue if the history buffer is set to any reasonable size)", "created_at": "2024-11-21 02:22:29", "merge_commit_sha": "220c7cd92e23e2250285dae25f6d530117c69750", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18171", "base_commit": "8598ed78d58cf6b10372fca4132bfa9553ac6735", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex e9f123f7007..8c3fa8220d0 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -2537,6 +2537,11 @@\n           \"description\": \"When set to true, the Terminal's tab row will display a shield icon when the Terminal is running with administrator privileges\",\n           \"type\": \"boolean\"\n         },\n+        \"showTabsFullscreen\": {\n+          \"default\": false,\n+          \"description\": \"When set to true, tabs remain visible in fullscreen mode. When set to false, tabs will be hidden when entering fullscreen mode.\",\n+          \"type\": \"boolean\"\n+        },\n         \"useAcrylicInTabRow\": {\n           \"default\": false,\n           \"description\": \"When set to true, the tab row will have an acrylic material background with 50% opacity.\",\ndiff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 0eba4511a92..cf0df031750 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -243,10 +243,12 @@ namespace winrt::TerminalApp::implementation\n     // - Handle changes in tab layout.\r\n     void TerminalPage::_UpdateTabView()\r\n     {\r\n-        // Never show the tab row when we're fullscreen. Otherwise:\r\n-        // Show tabs when there's more than 1, or the user has chosen to always\r\n-        // show the tab bar.\r\n-        const auto isVisible = (!_isFullscreen && !_isInFocusMode) &&\r\n+        // The tab row should only be visible if:\r\n+        // - we're not in focus mode\r\n+        // - we're not in full screen, or the user has enabled fullscreen tabs\r\n+        // - there is more than one tab, or the user has chosen to always show tabs\r\n+        const auto isVisible = !_isInFocusMode &&\r\n+                               (!_isFullscreen || _showTabsFullscreen) &&\r\n                                (_settings.GlobalSettings().ShowTabsInTitlebar() ||\r\n                                 (_tabs.Size() > 1) ||\r\n                                 _settings.GlobalSettings().AlwaysShowTabs());\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex e73ba93193b..c71596b7080 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -269,6 +269,7 @@ namespace winrt::TerminalApp::implementation\n         _layoutUpdatedRevoker = _tabContent.LayoutUpdated(winrt::auto_revoke, { this, &TerminalPage::_OnFirstLayout });\n \n         _isAlwaysOnTop = _settings.GlobalSettings().AlwaysOnTop();\n+        _showTabsFullscreen = _settings.GlobalSettings().ShowTabsFullscreen();\n \n         // DON'T set up Toasts/TeachingTips here. They should be loaded and\n         // initialized the first time they're opened, in whatever method opens\n@@ -3599,6 +3600,8 @@ namespace winrt::TerminalApp::implementation\n         _isAlwaysOnTop = _settings.GlobalSettings().AlwaysOnTop();\n         AlwaysOnTopChanged.raise(*this, nullptr);\n \n+        _showTabsFullscreen = _settings.GlobalSettings().ShowTabsFullscreen();\n+\n         // Settings AllowDependentAnimations will affect whether animations are\n         // enabled application-wide, so we don't need to check it each time we\n         // want to create an animation.\n@@ -4023,6 +4026,37 @@ namespace winrt::TerminalApp::implementation\n         return _isAlwaysOnTop;\n     }\n \n+    // Method Description:\n+    // - Returns true if the tab row should be visible when we're in full screen\n+    //   state.\n+    // Arguments:\n+    // - <none>\n+    // Return Value:\n+    // - true if the tab row should be visible in full screen state\n+    bool TerminalPage::ShowTabsFullscreen() const\n+    {\n+        return _showTabsFullscreen;\n+    }\n+\n+    // Method Description:\n+    // - Updates the visibility of the tab row when in fullscreen state.\n+    void TerminalPage::SetShowTabsFullscreen(bool newShowTabsFullscreen)\n+    {\n+        if (_showTabsFullscreen == newShowTabsFullscreen)\n+        {\n+            return;\n+        }\n+\n+        _showTabsFullscreen = newShowTabsFullscreen;\n+\n+        // if we're currently in fullscreen, update tab view to make\n+        // sure tabs are given the correct visibility\n+        if (_isFullscreen)\n+        {\n+            _UpdateTabView();\n+        }\n+    }\n+\n     void TerminalPage::SetFullscreen(bool newFullscreen)\n     {\n         if (_isFullscreen == newFullscreen)\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 87e7b17437b..f749479b090 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -121,6 +121,8 @@ namespace winrt::TerminalApp::implementation\n         bool FocusMode() const;\n         bool Fullscreen() const;\n         bool AlwaysOnTop() const;\n+        bool ShowTabsFullscreen() const;\n+        void SetShowTabsFullscreen(bool newShowTabsFullscreen);\n         void SetFullscreen(bool);\n         void SetFocusMode(const bool inFocusMode);\n         void Maximized(bool newMaximized);\n@@ -229,6 +231,7 @@ namespace winrt::TerminalApp::implementation\n         bool _isFullscreen{ false };\n         bool _isMaximized{ false };\n         bool _isAlwaysOnTop{ false };\n+        bool _showTabsFullscreen{ false };\n \n         std::optional<uint32_t> _loadFromPersistedLayoutIdx{};\n \ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.cpp b/src/cascadia/TerminalApp/TerminalWindow.cpp\nindex 569b236374a..055d6123ccf 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.cpp\n+++ b/src/cascadia/TerminalApp/TerminalWindow.cpp\n@@ -289,6 +289,11 @@ namespace winrt::TerminalApp::implementation\n         return _settings.GlobalSettings().AlwaysOnTop();\r\n     }\r\n \r\n+    bool TerminalWindow::GetInitialShowTabsFullscreen()\r\n+    {\r\n+        return _settings.GlobalSettings().ShowTabsFullscreen();\r\n+    }\r\n+\r\n     bool TerminalWindow::GetMinimizeToNotificationArea()\r\n     {\r\n         return _settings.GlobalSettings().MinimizeToNotificationArea();\r\n@@ -981,6 +986,11 @@ namespace winrt::TerminalApp::implementation\n         return _root ? _root->AlwaysOnTop() : false;\r\n     }\r\n \r\n+    bool TerminalWindow::ShowTabsFullscreen() const\r\n+    {\r\n+        return _root ? _root->ShowTabsFullscreen() : false;\r\n+    }\r\n+\r\n     void TerminalWindow::SetSettingsStartupArgs(const std::vector<ActionAndArgs>& actions)\r\n     {\r\n         for (const auto& action : actions)\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.h b/src/cascadia/TerminalApp/TerminalWindow.h\nindex a722468a547..0fd63a6362c 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.h\n+++ b/src/cascadia/TerminalApp/TerminalWindow.h\n@@ -89,6 +89,7 @@ namespace winrt::TerminalApp::implementation\n         bool Fullscreen() const;\r\n         void Maximized(bool newMaximized);\r\n         bool AlwaysOnTop() const;\r\n+        bool ShowTabsFullscreen() const;\r\n         bool AutoHideWindow();\r\n         void IdentifyWindow();\r\n \r\n@@ -106,6 +107,7 @@ namespace winrt::TerminalApp::implementation\n         Microsoft::Terminal::Settings::Model::LaunchMode GetLaunchMode();\r\n         bool GetShowTabsInTitlebar();\r\n         bool GetInitialAlwaysOnTop();\r\n+        bool GetInitialShowTabsFullscreen();\r\n         float CalcSnappedDimension(const bool widthOrHeight, const float dimension) const;\r\n \r\n         Windows::UI::Xaml::UIElement GetRoot() noexcept;\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.idl b/src/cascadia/TerminalApp/TerminalWindow.idl\nindex 24ce090e378..63c9169caf8 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.idl\n+++ b/src/cascadia/TerminalApp/TerminalWindow.idl\n@@ -69,6 +69,7 @@ namespace TerminalApp\n         void Maximized(Boolean newMaximized);\r\n         Boolean AlwaysOnTop { get; };\r\n         Boolean AutoHideWindow { get; };\r\n+        Boolean ShowTabsFullscreen { get; };\r\n \r\n         void IdentifyWindow();\r\n         void SetPersistedLayoutIdx(UInt32 idx);\r\n@@ -82,6 +83,7 @@ namespace TerminalApp\n         Microsoft.Terminal.Settings.Model.LaunchMode GetLaunchMode();\r\n         Boolean GetShowTabsInTitlebar();\r\n         Boolean GetInitialAlwaysOnTop();\r\n+        Boolean GetInitialShowTabsFullscreen();\r\n         Single CalcSnappedDimension(Boolean widthOrHeight, Single dimension);\r\n         void TitlebarClicked();\r\n         void CloseWindow();\r\ndiff --git a/src/cascadia/TerminalApp/TitlebarControl.cpp b/src/cascadia/TerminalApp/TitlebarControl.cpp\nindex 1debd030544..1ed82f39ca6 100644\n--- a/src/cascadia/TerminalApp/TitlebarControl.cpp\n+++ b/src/cascadia/TerminalApp/TitlebarControl.cpp\n@@ -12,6 +12,8 @@\n \r\n #include \"TitlebarControl.g.cpp\"\r\n \r\n+using namespace winrt::Windows::UI::Xaml;\r\n+\r\n namespace winrt::TerminalApp::implementation\r\n {\r\n     TitlebarControl::TitlebarControl(uint64_t handle) :\r\n@@ -77,6 +79,11 @@ namespace winrt::TerminalApp::implementation\n         }\r\n     }\r\n \r\n+    void TitlebarControl::FullscreenChanged(const bool fullscreen)\r\n+    {\r\n+        MinMaxCloseControl().Visibility(fullscreen ? Visibility::Collapsed : Visibility::Visible);\r\n+    }\r\n+\r\n     void TitlebarControl::_OnMaximizeOrRestore(byte flag)\r\n     {\r\n         POINT point1 = {};\r\ndiff --git a/src/cascadia/TerminalApp/TitlebarControl.h b/src/cascadia/TerminalApp/TitlebarControl.h\nindex 8020ff90956..1008253ba8d 100644\n--- a/src/cascadia/TerminalApp/TitlebarControl.h\n+++ b/src/cascadia/TerminalApp/TitlebarControl.h\n@@ -22,6 +22,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         void SetWindowVisualState(WindowVisualState visualState);\r\n         void Root_SizeChanged(const IInspectable& sender, const Windows::UI::Xaml::SizeChangedEventArgs& e);\r\n+        void FullscreenChanged(const bool fullscreen);\r\n \r\n         void Minimize_Click(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void Maximize_Click(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\ndiff --git a/src/cascadia/TerminalApp/TitlebarControl.idl b/src/cascadia/TerminalApp/TitlebarControl.idl\nindex b7a06ba987e..8f934fae951 100644\n--- a/src/cascadia/TerminalApp/TitlebarControl.idl\n+++ b/src/cascadia/TerminalApp/TitlebarControl.idl\n@@ -22,6 +22,7 @@ namespace TerminalApp\n     {\r\n         TitlebarControl(UInt64 parentWindowHandle);\r\n         void SetWindowVisualState(WindowVisualState visualState);\r\n+        void FullscreenChanged(Boolean fullscreen);\r\n \r\n         void HoverButton(CaptionButton button);\r\n         void PressButton(CaptionButton button);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml b/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml\nindex f227268613d..854fd733766 100644\n--- a/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml\n@@ -64,6 +64,12 @@\n                           Style=\"{StaticResource ToggleSwitchInExpanderStyle}\" />\r\n         </local:SettingContainer>\r\n \r\n+        <!--  Show tabs in full screen  -->\r\n+        <local:SettingContainer x:Uid=\"Globals_ShowTabsFullscreen\">\r\n+            <ToggleSwitch IsOn=\"{x:Bind ViewModel.ShowTabsFullscreen, Mode=TwoWay}\"\r\n+                          Style=\"{StaticResource ToggleSwitchInExpanderStyle}\" />\r\n+        </local:SettingContainer>\r\n+\r\n         <!--  Show Acrylic in Tab Row  -->\r\n         <local:SettingContainer x:Uid=\"Globals_AcrylicTabRow\">\r\n             <ToggleSwitch IsOn=\"{x:Bind ViewModel.UseAcrylicInTabRow, Mode=TwoWay}\"\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h\nindex 7c19b543f5b..108636a747f 100644\n--- a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h\n@@ -32,6 +32,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         void ShowTitlebarToggled(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& args);\r\n \r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, AlwaysShowTabs);\r\n+        PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, ShowTabsFullscreen);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, ShowTabsInTitlebar);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, UseAcrylicInTabRow);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, ShowTitleInTitlebar);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl\nindex 7f39f92709f..fb75021608c 100644\n--- a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl\n@@ -26,6 +26,7 @@ namespace Microsoft.Terminal.Settings.Editor\n         void ShowTitlebarToggled(IInspectable sender, Windows.UI.Xaml.RoutedEventArgs args);\r\n \r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, AlwaysShowTabs);\r\n+        PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, ShowTabsFullscreen);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, ShowTabsInTitlebar);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, UseAcrylicInTabRow);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, ShowTitleInTitlebar);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex d7a0c3efe36..67990bafcbc 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -2276,6 +2276,14 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n+  <data name=\"Globals_ShowTabsFullscreen.Header\" xml:space=\"preserve\">\r\n+    <value>Show tabs in full screen</value>\r\n+    <comment>Header for a control to toggle if the app should show the tabs when in full screen state.</comment>\r\n+  </data>\r\n+  <data name=\"Globals_ShowTabsFullscreen.HelpText\" xml:space=\"preserve\">\r\n+    <value>When enabled, the tab bar will be visible when the app is full screen.</value>\r\n+    <comment>A description for what the \"show tabs in full screen\" setting does.</comment>\r\n+  </data>\r\n   <data name=\"Profile_PathTranslationStyle.[using:Windows.UI.Xaml.Automation]AutomationProperties.Name\" xml:space=\"preserve\">\r\n     <value>Path translation</value>\r\n     <comment>Name for a control to select how file and directory paths are translated.</comment>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl b/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl\nindex b04073273ba..cee08a2656d 100644\n--- a/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl\n+++ b/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl\n@@ -57,6 +57,7 @@ namespace Microsoft.Terminal.Settings.Model\n         INHERITABLE_SETTING(Int32, InitialRows);\r\n         INHERITABLE_SETTING(Int32, InitialCols);\r\n         INHERITABLE_SETTING(Boolean, AlwaysShowTabs);\r\n+        INHERITABLE_SETTING(Boolean, ShowTabsFullscreen);\r\n         INHERITABLE_SETTING(NewTabPosition, NewTabPosition);\r\n         INHERITABLE_SETTING(Boolean, ShowTitleInTitlebar);\r\n         INHERITABLE_SETTING(Boolean, ConfirmCloseAllTabs);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/MTSMSettings.h b/src/cascadia/TerminalSettingsModel/MTSMSettings.h\nindex c2553db2e47..e74a5c8b3b0 100644\n--- a/src/cascadia/TerminalSettingsModel/MTSMSettings.h\n+++ b/src/cascadia/TerminalSettingsModel/MTSMSettings.h\n@@ -68,7 +68,8 @@ Author(s):\n     X(bool, EnableUnfocusedAcrylic, \"compatibility.enableUnfocusedAcrylic\", true)                                                                                                                     \\\r\n     X(winrt::Windows::Foundation::Collections::IVector<Model::NewTabMenuEntry>, NewTabMenu, \"newTabMenu\", winrt::single_threaded_vector<Model::NewTabMenuEntry>({ Model::RemainingProfilesEntry{} })) \\\r\n     X(bool, AllowHeadless, \"compatibility.allowHeadless\", false)                                                                                                                                      \\\r\n-    X(hstring, SearchWebDefaultQueryUrl, \"searchWebDefaultQueryUrl\", L\"https://www.bing.com/search?q=%22%s%22\")\r\n+    X(hstring, SearchWebDefaultQueryUrl, \"searchWebDefaultQueryUrl\", L\"https://www.bing.com/search?q=%22%s%22\")                                                                                       \\\r\n+    X(bool, ShowTabsFullscreen, \"showTabsFullscreen\", false)\r\n \r\n // Also add these settings to:\r\n // * Profile.idl\r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.cpp b/src/cascadia/WindowsTerminal/AppHost.cpp\nindex c7db8e38e1a..ea38d7dcdfc 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.cpp\n+++ b/src/cascadia/WindowsTerminal/AppHost.cpp\n@@ -193,6 +193,7 @@ void AppHost::Initialize()\n \r\n     _window->SetAlwaysOnTop(_windowLogic.GetInitialAlwaysOnTop());\r\n     _window->SetAutoHideWindow(_windowLogic.AutoHideWindow());\r\n+    _window->SetShowTabsFullscreen(_windowLogic.GetInitialShowTabsFullscreen());\r\n \r\n     // MORE EVENT HANDLERS HERE!\r\n     // MAKE SURE THEY ARE ALL:\r\n@@ -1023,6 +1024,7 @@ void AppHost::_HandleSettingsChanged(const winrt::Windows::Foundation::IInspecta\n \r\n     _window->SetMinimizeToNotificationAreaBehavior(_windowLogic.GetMinimizeToNotificationArea());\r\n     _window->SetAutoHideWindow(_windowLogic.AutoHideWindow());\r\n+    _window->SetShowTabsFullscreen(_windowLogic.ShowTabsFullscreen());\r\n     _updateTheme();\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.cpp b/src/cascadia/WindowsTerminal/IslandWindow.cpp\nindex 4c950cb986d..693569791ec 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.cpp\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.cpp\n@@ -848,6 +848,11 @@ void IslandWindow::ShowWindowChanged(const bool showOrHide)\n     }\r\n }\r\n \r\n+void IslandWindow::SetShowTabsFullscreen(const bool newShowTabsFullscreen)\r\n+{\r\n+    _showTabsFullscreen = newShowTabsFullscreen;\r\n+}\r\n+\r\n // Method Description\r\n // - Flash the taskbar icon, indicating to the user that something needs their attention\r\n void IslandWindow::FlashTaskbar()\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.h b/src/cascadia/WindowsTerminal/IslandWindow.h\nindex 8432d4e8134..ef050291e07 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.h\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.h\n@@ -46,6 +46,7 @@ class IslandWindow :\n     void FullscreenChanged(const bool fullscreen);\n     void SetAlwaysOnTop(const bool alwaysOnTop);\n     void ShowWindowChanged(const bool showOrHide);\n+    virtual void SetShowTabsFullscreen(const bool newShowTabsFullscreen);\n \n     void FlashTaskbar();\n     void SetTaskbarProgress(const size_t state, const size_t progress);\n@@ -105,6 +106,7 @@ class IslandWindow :\n     bool _borderless{ false };\n     bool _alwaysOnTop{ false };\n     bool _fullscreen{ false };\n+    bool _showTabsFullscreen{ false };\n     bool _fWasMaximizedBeforeFullscreen{ false };\n     RECT _rcWindowBeforeFullscreen{};\n     RECT _rcWorkBeforeFullscreen{};\n@@ -112,6 +114,7 @@ class IslandWindow :\n \n     virtual void _SetIsBorderless(const bool borderlessEnabled);\n     virtual void _SetIsFullscreen(const bool fullscreenEnabled);\n+\n     void _RestoreFullscreenPosition(const RECT& rcWork);\n     void _SetFullscreenPosition(const RECT& rcMonitor, const RECT& rcWork);\n \ndiff --git a/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp b/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp\nindex 3c66105885c..414e4043f88 100644\n--- a/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp\n+++ b/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp\n@@ -1129,7 +1129,7 @@ void NonClientIslandWindow::_SetIsBorderless(const bool borderlessEnabled)\n \r\n // Method Description:\r\n // - Enable or disable fullscreen mode. When entering fullscreen mode, we'll\r\n-//   need to manually hide the entire titlebar.\r\n+//   need to check whether to hide the titlebar.\r\n // - See also IslandWindow::_SetIsFullscreen, which does additional work.\r\n // Arguments:\r\n // - fullscreenEnabled: If true, we're entering fullscreen mode. If false, we're leaving.\r\n@@ -1138,10 +1138,7 @@ void NonClientIslandWindow::_SetIsBorderless(const bool borderlessEnabled)\n void NonClientIslandWindow::_SetIsFullscreen(const bool fullscreenEnabled)\r\n {\r\n     IslandWindow::_SetIsFullscreen(fullscreenEnabled);\r\n-    if (_titlebar)\r\n-    {\r\n-        _titlebar.Visibility(_IsTitlebarVisible() ? Visibility::Visible : Visibility::Collapsed);\r\n-    }\r\n+    _UpdateTitlebarVisibility();\r\n     // GH#4224 - When the auto-hide taskbar setting is enabled, then we don't\r\n     // always get another window message to trigger us to remove the drag bar.\r\n     // So, make sure to update the size of the drag region here, so that it\r\n@@ -1149,16 +1146,42 @@ void NonClientIslandWindow::_SetIsFullscreen(const bool fullscreenEnabled)\n     _ResizeDragBarWindow();\r\n }\r\n \r\n+void NonClientIslandWindow::SetShowTabsFullscreen(const bool newShowTabsFullscreen)\r\n+{\r\n+    IslandWindow::SetShowTabsFullscreen(newShowTabsFullscreen);\r\n+\r\n+    // don't waste time recalculating UI elements if we're not\r\n+    // in fullscreen state - this setting doesn't affect other\r\n+    // window states\r\n+    if (_fullscreen)\r\n+    {\r\n+        _UpdateTitlebarVisibility();\r\n+    }\r\n+}\r\n+\r\n+void NonClientIslandWindow::_UpdateTitlebarVisibility()\r\n+{\r\n+    if (!_titlebar)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    const auto showTitlebar = _IsTitlebarVisible();\r\n+    _titlebar.Visibility(showTitlebar ? Visibility::Visible : Visibility::Collapsed);\r\n+    _titlebar.FullscreenChanged(_fullscreen);\r\n+}\r\n+\r\n // Method Description:\r\n-// - Returns true if the titlebar is visible. For things like fullscreen mode,\r\n-//   borderless mode (aka \"focus mode\"), this will return false.\r\n+// - Returns true if the titlebar is visible. For borderless mode (aka \"focus mode\"),\r\n+//   this will return false. For fullscreen, this will return false unless the user\r\n+//   has enabled fullscreen tabs.\r\n // Arguments:\r\n // - <none>\r\n // Return Value:\r\n // - true iff the titlebar is visible\r\n bool NonClientIslandWindow::_IsTitlebarVisible() const\r\n {\r\n-    return !(_fullscreen || _borderless);\r\n+    return !_borderless && (!_fullscreen || _showTabsFullscreen);\r\n }\r\n \r\n void NonClientIslandWindow::SetTitlebarBackground(winrt::Windows::UI::Xaml::Media::Brush brush)\r\ndiff --git a/src/cascadia/WindowsTerminal/NonClientIslandWindow.h b/src/cascadia/WindowsTerminal/NonClientIslandWindow.h\nindex 76e093a2340..bdf64f98409 100644\n--- a/src/cascadia/WindowsTerminal/NonClientIslandWindow.h\n+++ b/src/cascadia/WindowsTerminal/NonClientIslandWindow.h\n@@ -46,6 +46,7 @@ class NonClientIslandWindow : public IslandWindow\n     void OnApplicationThemeChanged(const winrt::Windows::UI::Xaml::ElementTheme& requestedTheme) override;\r\n \r\n     void SetTitlebarBackground(winrt::Windows::UI::Xaml::Media::Brush brush);\r\n+    void SetShowTabsFullscreen(const bool newShowTabsFullscreen) override;\r\n \r\n     virtual void UseMica(const bool newValue, const double titlebarOpacity) override;\r\n \r\n@@ -92,6 +93,7 @@ class NonClientIslandWindow : public IslandWindow\n     void _UpdateFrameMargins() const noexcept;\r\n     void _UpdateMaximizedState();\r\n     void _UpdateIslandPosition(const UINT windowWidth, const UINT windowHeight);\r\n+    void _UpdateTitlebarVisibility();\r\n \r\n     struct Revokers\r\n     {\r\n", "test_patch": "", "problem_statement": "No tabs in fullscreen, focus mode or not\n### Windows Terminal version (or Windows build number)\n\n1.11.2421.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nUse F11 to switch between full screen and windowed mode. In the latter, tabs appear fine. In the former, there are never tabs shown. Setting a keybind for focus toggle will only affect the windowed mode, and I cannot get tabs in full screen mode under any circumstances.\r\n\r\nI've tried opening multiple tabs to make sure it wasn't a \"auto-hide the tabs if there's only one session open\" case.\n\n### Expected Behavior\n\nI would expect full screen mode to honor the focus mode.\n\n### Actual Behavior\n\nFocus mode is not honored and tabs will never appear in full screen mode.\n", "hints_text": "I suppose I have this tracked as a bullet point in #3486, but not a top level issue. Congrats, this thread is now the \"Add a setting to have tabs always visible in fullscreen mode\" thread\nThat explains why I didn't find it when I did a search. If I'd known, I wouldn't have opened this issue. Feel free to close.\nAny chance to add the option to show tabs in full screen mode? would be nice to have that option to toggle on/off \nI mean, yea, there's a chance - someone just needs to write the code now \ud83d\ude09 \n> Any chance to add the option to show tabs in full screen mode? would be nice to have that option to toggle on/off\r\n\r\nIt would be better if the tabs show up when you hover over the top instead of having it always in full-screen mode.\nWadda ya know, that's also on the backlog, see #5677\n+1 for always show tabs making it so that it always shows tabs", "created_at": "2024-11-09 15:31:40", "merge_commit_sha": "27f775ee9e4a1484895bc2aae916dc6a9d6a8b11", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18132", "base_commit": "fa8273065f7d95b0a2588e27a174ad443755bc17", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.xaml b/src/cascadia/TerminalApp/CommandPalette.xaml\nindex eb47534f9c5..2ed0c136e5f 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.xaml\n+++ b/src/cascadia/TerminalApp/CommandPalette.xaml\n@@ -23,6 +23,27 @@\n \r\n     <UserControl.Resources>\r\n         <ResourceDictionary>\r\n+            <!--  KeyChordText styles  -->\r\n+            <Style x:Key=\"KeyChordBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n+                <Setter Property=\"Background\" Value=\"Transparent\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <Style x:Key=\"KeyChordTextBlockStyle\"\r\n+                   TargetType=\"TextBlock\">\r\n+                <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <!--  ParsedCommandLineText styles  -->\r\n+            <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n+                <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n+            </Style>\r\n+\r\n             <DataTemplate x:Key=\"ListItemTemplate\"\r\n                           x:DataType=\"local:FilteredCommand\">\r\n                 <ListViewItem HorizontalContentAlignment=\"Stretch\"\r\n@@ -69,12 +90,12 @@\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n                             Background=\"{ThemeResource FlyoutPresenterBackground}\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n                 </Grid>\r\n@@ -118,12 +139,12 @@\n                             HorizontalAlignment=\"Right\"\r\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n \r\n@@ -219,79 +240,6 @@\n                                                GeneralItemTemplate=\"{StaticResource GeneralItemTemplate}\"\r\n                                                NestedItemTemplate=\"{StaticResource NestedItemTemplate}\"\r\n                                                TabItemTemplate=\"{StaticResource TabItemTemplate}\" />\r\n-\r\n-            <ResourceDictionary.ThemeDictionaries>\r\n-                <ResourceDictionary x:Key=\"Dark\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"Light\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"HighContrast\">\r\n-\r\n-                    <!--  KeyChordText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-\r\n-                    <!--  ParsedCommandLineText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-                </ResourceDictionary>\r\n-            </ResourceDictionary.ThemeDictionaries>\r\n         </ResourceDictionary>\r\n     </UserControl.Resources>\r\n \r\n@@ -375,7 +323,7 @@\n                     Padding=\"16,12\"\r\n                     HorizontalAlignment=\"Stretch\"\r\n                     VerticalAlignment=\"Center\"\r\n-                    Style=\"{ThemeResource ParsedCommandLineBorderStyle}\"\r\n+                    Style=\"{StaticResource ParsedCommandLineBorderStyle}\"\r\n                     Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(ParsedCommandLineText), Mode=OneWay}\">\r\n \r\n                 <ScrollViewer MaxHeight=\"200\"\r\n", "test_patch": "", "problem_statement": "[Windows Terminal - Command Palette]: 'Shortcut keys' in 'Command Palette' are not visible in high contrast themes for focused or hovered rows.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Pre-requisite:**\r\nSettings>Accessibility>Contrast themes>Aquatic/Desert theme>Reopen the application.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Follow the above-mentioned pre-requisite step.\r\n3. Now open any application like 'Windows Terminal'.\r\n4. Open command Palette by pressing 'Ctrl + Shift + P' keys.\r\n5. 'Command Palette' will open.\r\n6.  Now navigate to any row by up/down arrow keys or hover with mouse.\r\n7. Observe the issue.\r\n\r\n**User experience:**\r\nUsers relying on high contrast themes, especially those with visual impairments, may find it challenging to see the shortcut keys in the Command Palette. This issue impacts navigation efficiency, as users cannot easily identify or use the shortcuts for commands.\r\n\r\n**MAS Reference Link:**\r\n[MAS 4.3.1 \u2013 No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)\r\n\r\n**Attachment:**\r\n[Shortcut keys is not visible in high contrast themes.zip](https://github.com/user-attachments/files/16973765/Shortcut.keys.is.not.visible.in.high.contrast.themes.zip)\n\n### Expected Behavior\n\nThe shortcut keys for commands in the Command Palette should be clearly visible in high contrast themes when rows are focused or hovered. Proper contrast between the text and background should ensure that users can easily see the shortcut keys.\n\n### Actual Behavior\n\nThe shortcut keys associated with the commands in the Command Palette are not visible or are poorly visible when focused or hovered in high contrast themes. The lack of proper contrast makes it difficult to see the shortcut keys, impairing navigation.\n", "hints_text": "", "created_at": "2024-10-31 18:20:02", "merge_commit_sha": "e83434ff7e921b19f216bcd0dde3fe2dd8be6c04", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18116", "base_commit": "8d3f12b1c065a965974cd6b5bc7a81176ffb0f1b", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex ec903dc5b80..9774c51844c 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -733,6 +733,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The name or GUID of the profile to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\n@@ -804,6 +807,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The ID of the action to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex b3111e9b639..99064fef8bb 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,7 +989,7 @@ namespace winrt::TerminalApp::implementation\n \n                 for (auto&& [profileIndex, remainingProfile] : remainingProfilesEntry.Profiles())\n                 {\n-                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex));\n+                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex, {}));\n                 }\n \n                 break;\n@@ -1003,7 +1003,7 @@ namespace winrt::TerminalApp::implementation\n                     break;\n                 }\n \n-                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex());\n+                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex(), profileEntry.Icon());\n                 items.push_back(profileItem);\n                 break;\n             }\n@@ -1013,7 +1013,7 @@ namespace winrt::TerminalApp::implementation\n                 const auto actionId = actionEntry.ActionId();\n                 if (_settings.ActionMap().GetActionByID(actionId))\n                 {\n-                    auto actionItem = _CreateNewTabFlyoutAction(actionId);\n+                    auto actionItem = _CreateNewTabFlyoutAction(actionId, actionEntry.Icon());\n                     items.push_back(actionItem);\n                 }\n \n@@ -1028,7 +1028,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given profile with the given index.\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex, const winrt::hstring& iconPathOverride)\n     {\n         auto profileMenuItem = WUX::Controls::MenuFlyoutItem{};\n \n@@ -1049,9 +1049,10 @@ namespace winrt::TerminalApp::implementation\n         auto profileName = profile.Name();\n         profileMenuItem.Text(profileName);\n \n-        // If there's an icon set for this profile, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = profile.EvaluatedIcon();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this profile, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? profile.EvaluatedIcon() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\n@@ -1112,7 +1113,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given action\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride)\n     {\n         auto actionMenuItem = WUX::Controls::MenuFlyoutItem{};\n         const auto action{ _settings.ActionMap().GetActionByID(actionId) };\n@@ -1125,9 +1126,10 @@ namespace winrt::TerminalApp::implementation\n \n         actionMenuItem.Text(action.Name());\n \n-        // If there's an icon set for this action, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = action.IconPath();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this action, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? action.IconPath() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 9e5d3029c7f..30627d5b7ee 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -316,8 +316,8 @@ namespace winrt::TerminalApp::implementation\n         void _CreateNewTabFlyout();\n         std::vector<winrt::Windows::UI::Xaml::Controls::MenuFlyoutItemBase> _CreateNewTabFlyoutItems(winrt::Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::NewTabMenuEntry> entries);\n         winrt::Windows::UI::Xaml::Controls::IconElement _CreateNewTabFlyoutIcon(const winrt::hstring& icon);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex, const winrt::hstring& iconPathOverride);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride);\n \n         void _OpenNewTabDropdown();\n         HRESULT _OpenNewTab(const Microsoft::Terminal::Settings::Model::INewContentArgs& newContentArgs);\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\nindex b48207e74e9..6f7773e715c 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ActionIdKey{ \"id\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ActionEntry::ActionEntry() noexcept :\r\n     ActionEntryT<ActionEntry, NewTabMenuEntry>(NewTabMenuEntryType::Action)\r\n@@ -22,6 +23,7 @@ Json::Value ActionEntry::ToJson() const\n     auto json = NewTabMenuEntry::ToJson();\r\n \r\n     JsonUtils::SetValueForKey(json, ActionIdKey, _ActionId);\r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n \r\n     return json;\r\n }\r\n@@ -31,6 +33,7 @@ winrt::com_ptr<NewTabMenuEntry> ActionEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ActionEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ActionIdKey, entry->_ActionId);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.h b/src/cascadia/TerminalSettingsModel/ActionEntry.h\nindex 9c89077828c..711cec13bfc 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.h\n@@ -28,6 +28,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         static com_ptr<NewTabMenuEntry> FromJson(const Json::Value& json);\r\n \r\n         WINRT_PROPERTY(winrt::hstring, ActionId);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n     };\r\n }\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\nindex 84bc3777695..acf1f33f6f4 100644\n--- a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n+++ b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n@@ -33,6 +33,7 @@ namespace Microsoft.Terminal.Settings.Model\n \r\n         Profile Profile;\r\n         Int32 ProfileIndex;\r\n+        String Icon;\r\n     }\r\n \r\n     [default_interface] runtimeclass ActionEntry : NewTabMenuEntry\r\n@@ -40,6 +41,7 @@ namespace Microsoft.Terminal.Settings.Model\n         ActionEntry();\r\n \r\n         String ActionId;\r\n+        String Icon;\r\n     }\r\n \r\n     enum FolderEntryInlining\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\nindex c857eea8678..5f01a293beb 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ProfileKey{ \"profile\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ProfileEntry::ProfileEntry() noexcept :\r\n     ProfileEntry{ winrt::hstring{} }\r\n@@ -46,6 +47,8 @@ Json::Value ProfileEntry::ToJson() const\n         JsonUtils::SetValueForKey(json, ProfileKey, _Profile.Guid());\r\n     }\r\n \r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n+\r\n     return json;\r\n }\r\n \r\n@@ -54,6 +57,7 @@ winrt::com_ptr<NewTabMenuEntry> ProfileEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ProfileEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ProfileKey, entry->_ProfileName);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.h b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\nindex fe0f4573d29..9ea78497f1f 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n@@ -41,6 +41,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n \r\n         WINRT_PROPERTY(Model::Profile, Profile);\r\n         WINRT_PROPERTY(int, ProfileIndex);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n \r\n     private:\r\n         winrt::hstring _ProfileName;\r\n", "test_patch": "", "problem_statement": "In newTabMenu allow assignment/override of the icon property for the action items\n### Description of the new feature\n\nHi.\n\nOne small cosmetic suggestion. \n\nCurrently, I can define actions->command which I can then select as the action in newTabMenu.\nIf I would like to have an icon (or glyph) for that item displayed in the newTabMenu, icon needs to be defined at the level of actions->command. That will result in icon being visible in the command palette as well, which I'd like to avoid (I don't like it visually to have only one or a few items with the icon in a long list of commands).\n\nWould it be possible to have a possibility to define \"icon\" for newTabMenu action items (\"type\": \"action\"). That would allow assignment of desired icons/glyphs to desired commands only in newTabMenu and not in command palette.\n\nOther option would be to have a property on the actions->command item level that would allow for the icon not to be displayed in the command palette (e.g. iconVisibility to have one of the following values: \"newtabmenu\", \"commandpalette\", \"both\", \"none\").\n\nOne more thing that could work is to allow the whole custom command to be excluded from the command palette.\n\nThank you in advance!\n\n### Proposed technical implementation details\n\n_No response_\n", "hints_text": "It should totally let you do that! This must have just been overlooked in the initial implementation. \n\nSomething like:\n\n```json\n        {\n            \"type\": \"action\",\n            \"id\": \"User.scrollToMark.D3F0B923\",\n            \"icon\": \"d:\\\\dev\\\\public\\\\terminal\\\\res\\\\terminal.ico\"\n        }\n```\n\nshould totally work. Thanks for filing!\n\n(We should probably allow that for profile entries too)", "created_at": "2024-10-27 11:52:46", "merge_commit_sha": "5b634657980ecfa2d65e9ffec622dfd842839628", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18109", "base_commit": "8d3f12b1c065a965974cd6b5bc7a81176ffb0f1b", "patch": "diff --git a/src/cascadia/TerminalApp/TabBase.cpp b/src/cascadia/TerminalApp/TabBase.cpp\nindex 2d5e8da4433..55f2cffcb57 100644\n--- a/src/cascadia/TerminalApp/TabBase.cpp\n+++ b/src/cascadia/TerminalApp/TabBase.cpp\n@@ -458,45 +458,67 @@ namespace winrt::TerminalApp::implementation\n             deselectedFontBrush.Color(winrt::Windows::UI::Colors::White());\r\n         }\r\n \r\n-        // Prior to MUX 2.7, we set TabViewItemHeaderBackground, but now we can\r\n-        // use TabViewItem().Background() for that. HOWEVER,\r\n-        // TabViewItem().Background() only sets the color of the tab background\r\n-        // when the TabViewItem is unselected. So we still need to set the other\r\n-        // properties ourselves.\r\n-        //\r\n-        // In GH#11294 we thought we'd still need to set\r\n-        // TabViewItemHeaderBackground manually, but GH#11382 discovered that\r\n-        // Background() was actually okay after all.\r\n-\r\n-        const auto& tabItemResources{ TabViewItem().Resources() };\r\n-\r\n-        TabViewItem().Background(deselectedTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundSelected\"), selectedTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPointerOver\"), hoverTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPressed\"), selectedTabBrush);\r\n-\r\n-        // Similarly, TabViewItem().Foreground()  sets the color for the text\r\n-        // when the TabViewItem isn't selected, but not when it is hovered,\r\n-        // pressed, dragged, or selected, so we'll need to just set them all\r\n-        // anyways.\r\n-        TabViewItem().Foreground(deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForeground\"), deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundSelected\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPointerOver\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPressed\"), fontBrush);\r\n-\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForeground\"), deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPressed\"), secondaryFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPointerOver\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderPressedCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderPointerOverCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderSelectedCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPressed\"), subtleFillColorTertiaryBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\"), subtleFillColorSecondaryBrush);\r\n-\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundActiveTab\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundPressed\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundPointerOver\"), fontBrush);\r\n+        // Add the empty theme dictionaries\r\n+        const auto& tabItemThemeResources{ TabViewItem().Resources().ThemeDictionaries() };\r\n+        ResourceDictionary lightThemeDictionary;\r\n+        ResourceDictionary darkThemeDictionary;\r\n+        ResourceDictionary highContrastThemeDictionary;\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"Light\"), lightThemeDictionary);\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"Dark\"), darkThemeDictionary);\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"HighContrast\"), highContrastThemeDictionary);\r\n+\r\n+        // Now actually set the resources we want in them.\r\n+        // Before, we used to put these on the ResourceDictionary directly.\r\n+        // However, HighContrast mode may require some adjustments. So let's just add\r\n+        //   all three so we can make those adjustments on the HighContrast version.\r\n+        for (const auto& [k, v] : tabItemThemeResources)\r\n+        {\r\n+            const bool isHighContrast = winrt::unbox_value<hstring>(k) == L\"HighContrast\";\r\n+            const auto& currentDictionary = v.as<ResourceDictionary>();\r\n+\r\n+            // TabViewItem.Background\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackground\"), deselectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundSelected\"), selectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPointerOver\"), isHighContrast ? fontBrush : hoverTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPressed\"), selectedTabBrush);\r\n+\r\n+            // TabViewItem.Foreground (aka text)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForeground\"), deselectedFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundSelected\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPointerOver\"), isHighContrast ? selectedTabBrush : fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPressed\"), fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Foreground (aka X)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForeground\"), deselectedFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPressed\"), isHighContrast ? deselectedFontBrush : secondaryFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPointerOver\"), isHighContrast ? deselectedFontBrush : fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Foreground _when_ interacting with the tab\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderPressedCloseButtonForeground\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderPointerOverCloseButtonForeground\"), isHighContrast ? selectedTabBrush : fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderSelectedCloseButtonForeground\"), fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Background (aka X button)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackground\"), deselectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPressed\"), isHighContrast ? selectedTabBrush : subtleFillColorTertiaryBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\"), isHighContrast ? selectedTabBrush : subtleFillColorSecondaryBrush);\r\n+\r\n+            // A few miscellaneous resources that WinUI said may be removed in the future\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundActiveTab\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundPressed\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundPointerOver\"), fontBrush);\r\n+\r\n+            // Add a few extra ones for high contrast mode\r\n+            // BODGY: contrary to the docs, Insert() seems to throw if the value already exists\r\n+            //   Make sure you don't touch any that already exist here!\r\n+            if (isHighContrast)\r\n+            {\r\n+                // TabViewItem.CloseButton.Border: in HC mode, the border makes the button more clearly visible\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushPressed\"), fontBrush);\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushPointerOver\"), fontBrush);\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushSelected\"), fontBrush);\r\n+            }\r\n+        }\r\n \r\n         _RefreshVisualState();\r\n     }\r\n@@ -511,36 +533,55 @@ namespace winrt::TerminalApp::implementation\n     void TabBase::_ClearTabBackgroundColor()\r\n     {\r\n         static const winrt::hstring keys[] = {\r\n+            // TabViewItem.Background\r\n             L\"TabViewItemHeaderBackground\",\r\n             L\"TabViewItemHeaderBackgroundSelected\",\r\n             L\"TabViewItemHeaderBackgroundPointerOver\",\r\n             L\"TabViewItemHeaderBackgroundPressed\",\r\n+\r\n+            // TabViewItem.Foreground (aka text)\r\n             L\"TabViewItemHeaderForeground\",\r\n             L\"TabViewItemHeaderForegroundSelected\",\r\n             L\"TabViewItemHeaderForegroundPointerOver\",\r\n             L\"TabViewItemHeaderForegroundPressed\",\r\n+\r\n+            // TabViewItem.CloseButton.Foreground (aka X)\r\n             L\"TabViewItemHeaderCloseButtonForeground\",\r\n-            L\"TabViewItemHeaderCloseButtonForegroundPressed\",\r\n+            L\"TabViewItemHeaderForegroundSelected\",\r\n             L\"TabViewItemHeaderCloseButtonForegroundPointerOver\",\r\n+            L\"TabViewItemHeaderCloseButtonForegroundPressed\",\r\n+\r\n+            // TabViewItem.CloseButton.Foreground _when_ interacting with the tab\r\n             L\"TabViewItemHeaderPressedCloseButtonForeground\",\r\n             L\"TabViewItemHeaderPointerOverCloseButtonForeground\",\r\n             L\"TabViewItemHeaderSelectedCloseButtonForeground\",\r\n+\r\n+            // TabViewItem.CloseButton.Background (aka X button)\r\n+            L\"TabViewItemHeaderCloseButtonBackground\",\r\n             L\"TabViewItemHeaderCloseButtonBackgroundPressed\",\r\n             L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\",\r\n+\r\n+            // A few miscellaneous resources that WinUI said may be removed in the future\r\n             L\"TabViewButtonForegroundActiveTab\",\r\n             L\"TabViewButtonForegroundPressed\",\r\n-            L\"TabViewButtonForegroundPointerOver\"\r\n+            L\"TabViewButtonForegroundPointerOver\",\r\n+\r\n+            // TabViewItem.CloseButton.Border: in HC mode, the border makes the button more clearly visible\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushPressed\",\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushPointerOver\",\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushSelected\"\r\n         };\r\n \r\n-        const auto& tabItemResources{ TabViewItem().Resources() };\r\n+        const auto& tabItemThemeResources{ TabViewItem().Resources().ThemeDictionaries() };\r\n \r\n         // simply clear any of the colors in the tab's dict\r\n         for (const auto& keyString : keys)\r\n         {\r\n-            auto key = winrt::box_value(keyString);\r\n-            if (tabItemResources.HasKey(key))\r\n+            const auto key = winrt::box_value(keyString);\r\n+            for (const auto& [_, v] : tabItemThemeResources)\r\n             {\r\n-                tabItemResources.Remove(key);\r\n+                const auto& themeDictionary = v.as<ResourceDictionary>();\r\n+                themeDictionary.Remove(key);\r\n             }\r\n         }\r\n \r\n", "test_patch": "", "problem_statement": "[High Contrast] Colored tabs lose color when unfocused\n### Windows Terminal version\n\n1.14.1262.0\n\n### Windows build number\n\n10.0.22621.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Enter high contrast mode\r\n2. color a tab\r\n3. switch focus to another tab\n\n### Expected Behavior\n\ncolored tab should still retain the color\n\n### Actual Behavior\n\ncolored tab reverted to high contrast color (until focused again).\n", "hints_text": "", "created_at": "2024-10-25 22:46:54", "merge_commit_sha": "72df7ac20ea3e9d306ed68f2f600eee51f227f7b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18107", "base_commit": "8d3f12b1c065a965974cd6b5bc7a81176ffb0f1b", "patch": "diff --git a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\nindex 26823366401..217f4e88879 100644\n--- a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n@@ -193,6 +193,9 @@\n   <data name=\"TabCloseSubMenu\" xml:space=\"preserve\">\r\n     <value>Close</value>\r\n   </data>\r\n+  <data name=\"TabMoveSubMenu\" xml:space=\"preserve\">\r\n+    <value>Move tab</value>\r\n+  </data>\r\n   <data name=\"TabCloseAfter\" xml:space=\"preserve\">\r\n     <value>Close tabs to the right</value>\r\n   </data>\r\n@@ -941,4 +944,10 @@\n   <data name=\"CloseSnippetsPaneButton.[using:Windows.UI.Xaml.Controls]ToolTipService.ToolTip\" xml:space=\"preserve\">\r\n     <value>Close pane</value>\r\n   </data>\r\n-</root>\r\n+  <data name=\"TabMoveLeft\" xml:space=\"preserve\">\r\n+    <value>Move left</value>\r\n+  </data>\r\n+  <data name=\"TabMoveRight\" xml:space=\"preserve\">\r\n+    <value>Move right</value>\r\n+  </data>\r\n+</root>\n\\ No newline at end of file\ndiff --git a/src/cascadia/TerminalApp/TabBase.cpp b/src/cascadia/TerminalApp/TabBase.cpp\nindex 2d5e8da4433..0cedab37d0a 100644\n--- a/src/cascadia/TerminalApp/TabBase.cpp\n+++ b/src/cascadia/TerminalApp/TabBase.cpp\n@@ -7,6 +7,7 @@\n #include \"TabBase.g.cpp\"\r\n #include \"Utils.h\"\r\n #include \"ColorHelper.h\"\r\n+#include \"../inc/WindowingBehavior.h\"\r\n \r\n using namespace winrt;\r\n using namespace winrt::Windows::UI::Xaml;\r\n@@ -56,10 +57,72 @@ namespace winrt::TerminalApp::implementation\n                 tab->RequestFocusActiveControl.raise();\r\n             }\r\n         });\r\n+        _AppendMoveMenuItems(contextMenuFlyout);\r\n         _AppendCloseMenuItems(contextMenuFlyout);\r\n         TabViewItem().ContextFlyout(contextMenuFlyout);\r\n     }\r\n \r\n+    void TabBase::_AppendMoveMenuItems(winrt::Windows::UI::Xaml::Controls::MenuFlyout flyout)\r\n+    {\r\n+        auto weakThis{ get_weak() };\r\n+\r\n+        // Move to new window\r\n+        {\r\n+            Controls::FontIcon moveTabToNewWindowTabSymbol;\r\n+            moveTabToNewWindowTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n+            moveTabToNewWindowTabSymbol.Glyph(L\"\\xE8A7\");\r\n+\r\n+            _moveToNewWindowMenuItem.Click([weakThis](auto&&, auto&&) {\r\n+                if (auto tab{ weakThis.get() })\r\n+                {\r\n+                    MoveTabArgs args{ winrt::to_hstring(NewWindow), MoveTabDirection::Forward };\r\n+                    ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n+                    tab->_dispatch.DoAction(*tab, actionAndArgs);\r\n+                }\r\n+            });\r\n+            _moveToNewWindowMenuItem.Text(RS_(L\"MoveTabToNewWindowText\"));\r\n+            _moveToNewWindowMenuItem.Icon(moveTabToNewWindowTabSymbol);\r\n+\r\n+            const auto moveTabToNewWindowToolTip = RS_(L\"MoveTabToNewWindowToolTip\");\r\n+            WUX::Controls::ToolTipService::SetToolTip(_moveToNewWindowMenuItem, box_value(moveTabToNewWindowToolTip));\r\n+            Automation::AutomationProperties::SetHelpText(_moveToNewWindowMenuItem, moveTabToNewWindowToolTip);\r\n+        }\r\n+\r\n+        // Move left\r\n+        {\r\n+            _moveLeftMenuItem.Click([weakThis](auto&&, auto&&) {\r\n+                if (auto tab{ weakThis.get() })\r\n+                {\r\n+                    MoveTabArgs args{ hstring{}, MoveTabDirection::Backward };\r\n+                    ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n+                    tab->_dispatch.DoAction(*tab, actionAndArgs);\r\n+                }\r\n+            });\r\n+            _moveLeftMenuItem.Text(RS_(L\"TabMoveLeft\"));\r\n+        }\r\n+\r\n+        // Move right\r\n+        {\r\n+            _moveRightMenuItem.Click([weakThis](auto&&, auto&&) {\r\n+                if (auto tab{ weakThis.get() })\r\n+                {\r\n+                    MoveTabArgs args{ hstring{}, MoveTabDirection::Forward };\r\n+                    ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n+                    tab->_dispatch.DoAction(*tab, actionAndArgs);\r\n+                }\r\n+            });\r\n+            _moveRightMenuItem.Text(RS_(L\"TabMoveRight\"));\r\n+        }\r\n+\r\n+        // Create a sub-menu for our extended move tab items.\r\n+        Controls::MenuFlyoutSubItem moveSubMenu;\r\n+        moveSubMenu.Text(RS_(L\"TabMoveSubMenu\"));\r\n+        moveSubMenu.Items().Append(_moveToNewWindowMenuItem);\r\n+        moveSubMenu.Items().Append(_moveRightMenuItem);\r\n+        moveSubMenu.Items().Append(_moveLeftMenuItem);\r\n+        flyout.Items().Append(moveSubMenu);\r\n+    }\r\n+\r\n     // Method Description:\r\n     // - Append the close menu items to the context menu flyout\r\n     // Arguments:\r\n@@ -75,7 +138,9 @@ namespace winrt::TerminalApp::implementation\n         _closeTabsAfterMenuItem.Click([weakThis](auto&&, auto&&) {\r\n             if (auto tab{ weakThis.get() })\r\n             {\r\n-                tab->_CloseTabsAfter();\r\n+                CloseTabsAfterArgs args{ tab->_TabViewIndex };\r\n+                ActionAndArgs closeTabsAfter{ ShortcutAction::CloseTabsAfter, args };\r\n+                tab->_dispatch.DoAction(*tab, closeTabsAfter);\r\n             }\r\n         });\r\n         _closeTabsAfterMenuItem.Text(RS_(L\"TabCloseAfter\"));\r\n@@ -88,7 +153,9 @@ namespace winrt::TerminalApp::implementation\n         _closeOtherTabsMenuItem.Click([weakThis](auto&&, auto&&) {\r\n             if (auto tab{ weakThis.get() })\r\n             {\r\n-                tab->_CloseOtherTabs();\r\n+                CloseOtherTabsArgs args{ tab->_TabViewIndex };\r\n+                ActionAndArgs closeOtherTabs{ ShortcutAction::CloseOtherTabs, args };\r\n+                tab->_dispatch.DoAction(*tab, closeOtherTabs);\r\n             }\r\n         });\r\n         _closeOtherTabsMenuItem.Text(RS_(L\"TabCloseOther\"));\r\n@@ -129,33 +196,27 @@ namespace winrt::TerminalApp::implementation\n     }\r\n \r\n     // Method Description:\r\n-    // - Enable the Close menu items based on tab index and total number of tabs\r\n+    // - Enable menu items based on tab index and total number of tabs\r\n     // Arguments:\r\n     // - <none>\r\n     // Return Value:\r\n     // - <none>\r\n-    void TabBase::_EnableCloseMenuItems()\r\n+    void TabBase::_EnableMenuItems()\r\n     {\r\n-        // close other tabs is enabled only if there are other tabs\r\n-        _closeOtherTabsMenuItem.IsEnabled(TabViewNumTabs() > 1);\r\n-        // close tabs after is enabled only if there are other tabs on the right\r\n-        _closeTabsAfterMenuItem.IsEnabled(TabViewIndex() < TabViewNumTabs() - 1);\r\n-    }\r\n+        const auto tabIndex = TabViewIndex();\r\n+        const auto numOfTabs = TabViewNumTabs();\r\n \r\n-    void TabBase::_CloseTabsAfter()\r\n-    {\r\n-        CloseTabsAfterArgs args{ _TabViewIndex };\r\n-        ActionAndArgs closeTabsAfter{ ShortcutAction::CloseTabsAfter, args };\r\n+        // enabled if there are other tabs\r\n+        _closeOtherTabsMenuItem.IsEnabled(numOfTabs > 1);\r\n \r\n-        _dispatch.DoAction(closeTabsAfter);\r\n-    }\r\n+        // enabled if there are other tabs on the right\r\n+        _closeTabsAfterMenuItem.IsEnabled(tabIndex < numOfTabs - 1);\r\n \r\n-    void TabBase::_CloseOtherTabs()\r\n-    {\r\n-        CloseOtherTabsArgs args{ _TabViewIndex };\r\n-        ActionAndArgs closeOtherTabs{ ShortcutAction::CloseOtherTabs, args };\r\n+        // enabled if not left-most tab\r\n+        _moveLeftMenuItem.IsEnabled(tabIndex > 0);\r\n \r\n-        _dispatch.DoAction(closeOtherTabs);\r\n+        // enabled if not last tab\r\n+        _moveRightMenuItem.IsEnabled(tabIndex < numOfTabs - 1);\r\n     }\r\n \r\n     void TabBase::UpdateTabViewIndex(const uint32_t idx, const uint32_t numTabs)\r\n@@ -164,7 +225,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         TabViewIndex(idx);\r\n         TabViewNumTabs(numTabs);\r\n-        _EnableCloseMenuItems();\r\n+        _EnableMenuItems();\r\n         _UpdateSwitchToTabKeyChord();\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TabBase.h b/src/cascadia/TerminalApp/TabBase.h\nindex 9a538550b8d..aa4928c669b 100644\n--- a/src/cascadia/TerminalApp/TabBase.h\n+++ b/src/cascadia/TerminalApp/TabBase.h\n@@ -54,6 +54,9 @@ namespace winrt::TerminalApp::implementation\n         winrt::Windows::UI::Xaml::FocusState _focusState{ winrt::Windows::UI::Xaml::FocusState::Unfocused };\r\n         winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _closeOtherTabsMenuItem{};\r\n         winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _closeTabsAfterMenuItem{};\r\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _moveToNewWindowMenuItem{};\r\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _moveRightMenuItem{};\r\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _moveLeftMenuItem{};\r\n         winrt::TerminalApp::ShortcutActionDispatch _dispatch;\r\n         Microsoft::Terminal::Settings::Model::IActionMapView _actionMap{ nullptr };\r\n         winrt::hstring _keyChord{};\r\n@@ -69,10 +72,9 @@ namespace winrt::TerminalApp::implementation\n \r\n         virtual void _MakeTabViewItem();\r\n \r\n+        void _AppendMoveMenuItems(winrt::Windows::UI::Xaml::Controls::MenuFlyout flyout);\r\n         winrt::Windows::UI::Xaml::Controls::MenuFlyoutSubItem _AppendCloseMenuItems(winrt::Windows::UI::Xaml::Controls::MenuFlyout flyout);\r\n-        void _EnableCloseMenuItems();\r\n-        void _CloseTabsAfter();\r\n-        void _CloseOtherTabs();\r\n+        void _EnableMenuItems();\r\n         void _UpdateSwitchToTabKeyChord();\r\n         void _UpdateToolTip();\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.cpp b/src/cascadia/TerminalApp/TerminalTab.cpp\nindex 0a01e83d13e..e81e452708e 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.cpp\n+++ b/src/cascadia/TerminalApp/TerminalTab.cpp\n@@ -10,7 +10,6 @@\n #include \"Utils.h\"\r\n #include \"ColorHelper.h\"\r\n #include \"AppLogic.h\"\r\n-#include \"../inc/WindowingBehavior.h\"\r\n \r\n using namespace winrt;\r\n using namespace winrt::Windows::UI::Xaml;\r\n@@ -1443,23 +1442,6 @@ namespace winrt::TerminalApp::implementation\n             Automation::AutomationProperties::SetHelpText(splitTabMenuItem, splitTabToolTip);\r\n         }\r\n \r\n-        Controls::MenuFlyoutItem moveTabToNewWindowMenuItem;\r\n-        {\r\n-            // \"Move tab to new window\"\r\n-            Controls::FontIcon moveTabToNewWindowTabSymbol;\r\n-            moveTabToNewWindowTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n-            moveTabToNewWindowTabSymbol.Glyph(L\"\\xE8A7\");\r\n-\r\n-            moveTabToNewWindowMenuItem.Click({ get_weak(), &TerminalTab::_moveTabToNewWindowClicked });\r\n-            moveTabToNewWindowMenuItem.Text(RS_(L\"MoveTabToNewWindowText\"));\r\n-            moveTabToNewWindowMenuItem.Icon(moveTabToNewWindowTabSymbol);\r\n-\r\n-            const auto moveTabToNewWindowToolTip = RS_(L\"MoveTabToNewWindowToolTip\");\r\n-\r\n-            WUX::Controls::ToolTipService::SetToolTip(moveTabToNewWindowMenuItem, box_value(moveTabToNewWindowToolTip));\r\n-            Automation::AutomationProperties::SetHelpText(moveTabToNewWindowMenuItem, moveTabToNewWindowToolTip);\r\n-        }\r\n-\r\n         Controls::MenuFlyoutItem closePaneMenuItem = _closePaneMenuItem;\r\n         {\r\n             // \"Close pane\"\r\n@@ -1535,12 +1517,15 @@ namespace winrt::TerminalApp::implementation\n         contextMenuFlyout.Items().Append(renameTabMenuItem);\r\n         contextMenuFlyout.Items().Append(duplicateTabMenuItem);\r\n         contextMenuFlyout.Items().Append(splitTabMenuItem);\r\n-        contextMenuFlyout.Items().Append(moveTabToNewWindowMenuItem);\r\n+        _AppendMoveMenuItems(contextMenuFlyout);\r\n         contextMenuFlyout.Items().Append(exportTabMenuItem);\r\n         contextMenuFlyout.Items().Append(findMenuItem);\r\n         contextMenuFlyout.Items().Append(restartConnectionMenuItem);\r\n         contextMenuFlyout.Items().Append(menuSeparator);\r\n \r\n+        auto closeSubMenu = _AppendCloseMenuItems(contextMenuFlyout);\r\n+        closeSubMenu.Items().Append(closePaneMenuItem);\r\n+\r\n         // GH#5750 - When the context menu is dismissed with ESC, toss the focus\r\n         // back to our control.\r\n         contextMenuFlyout.Closed([weakThis](auto&&, auto&&) {\r\n@@ -1560,8 +1545,6 @@ namespace winrt::TerminalApp::implementation\n                 }\r\n             }\r\n         });\r\n-        auto closeSubMenu = _AppendCloseMenuItems(contextMenuFlyout);\r\n-        closeSubMenu.Items().Append(closePaneMenuItem);\r\n \r\n         TabViewItem().ContextFlyout(contextMenuFlyout);\r\n     }\r\n@@ -2001,13 +1984,6 @@ namespace winrt::TerminalApp::implementation\n         actionAndArgs.Action(ShortcutAction::ExportBuffer);\r\n         _dispatch.DoAction(*this, actionAndArgs);\r\n     }\r\n-    void TerminalTab::_moveTabToNewWindowClicked(const winrt::Windows::Foundation::IInspectable& /* sender */,\r\n-                                                 const winrt::Windows::UI::Xaml::RoutedEventArgs& /* args */)\r\n-    {\r\n-        MoveTabArgs args{ winrt::to_hstring(NewWindow), MoveTabDirection::Forward };\r\n-        ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n-        _dispatch.DoAction(*this, actionAndArgs);\r\n-    }\r\n     void TerminalTab::_findClicked(const winrt::Windows::Foundation::IInspectable& /* sender */,\r\n                                    const winrt::Windows::UI::Xaml::RoutedEventArgs& /* args */)\r\n     {\r\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.h b/src/cascadia/TerminalApp/TerminalTab.h\nindex f38895a3da6..5a2f67b295d 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.h\n+++ b/src/cascadia/TerminalApp/TerminalTab.h\n@@ -196,7 +196,6 @@ namespace winrt::TerminalApp::implementation\n         void _splitTabClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void _closePaneClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void _exportTextClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n-        void _moveTabToNewWindowClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void _findClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n \r\n         void _bubbleRestartTerminalRequested(TerminalApp::TerminalPaneContent sender, const winrt::Windows::Foundation::IInspectable& args);\r\n", "test_patch": "", "problem_statement": "[WCAG 2.2] [Windows Terminal - Multiple Tab]: No single pointer alternative is provided to move the tabs.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Open Multiple tabs and navigate among the tabs.\r\n3. Now, verify whether any single pointer alternative is provided to move the tabs or not.\r\n5. Observe the issue.\r\n\r\n**User experience:**\r\nUsers who struggle with performing dragging movements will feel difficulty to move tabs, if there is no single pointer alternative is provided to perform the action.\r\n\r\n**WCAG Reference Link:**\r\n[Understanding Success Criterion 2.5.7: Dragging Movements | WAI | W3C](https://www.w3.org/WAI/WCAG22/Understanding/dragging-movements)\r\n\r\n**Attachment:**\r\n[No single pointer alternative is provided to move the tabs.zip](https://github.com/user-attachments/files/16958526/No.single.pointer.alternative.is.provided.to.move.the.tabs.zip)\n\n### Expected Behavior\n\nA single pointer alternative mechanism should be provided to the users to move the tabs.\n\n### Actual Behavior\n\nUser can be able to move the tabs here & there by using mouse, but no alternative method is available for the user to perform action using single pointer.\n", "hints_text": "We've found some similar issues:\n\n\n- #16717 , similarity score: 87%\n  \n\nIf any of the above are duplicates, please consider closing this issue out and adding additional context in the original issue.\n\n> Note: You can give me feedback by \ud83d\udc4d or \ud83d\udc4e this comment.\nThis is a /dup of #16717.\r\n\r\nPlease refer to the discussion in that thread for further details.\nHi! We've identified this issue as a duplicate of another one that already exists on this Issue Tracker. This specific instance is being closed in favor of tracking the concern over on the referenced thread. Thanks for your report!\n<!-- Policy app identification https://img.shields.io/static/v1?label=PullRequestIssueManagement. -->\n@carlos-zamora,\r\nHaving keyboard shortcut to move the tabs cannot be consider as a single pointer alternative.\r\n\r\nSuggestion: A button can be defined in a context menu of tabs using which users can move the tab.\nIs there precedent for something like this in Edge?\r\n\r\nExpanding out \"Move tab to new window\" to \"Move Tab > {To new window, To the left, To the right, ...}\" as a nested menu might be an option here", "created_at": "2024-10-24 20:32:07", "merge_commit_sha": "d8089e903e3beef02763c06ad043ce166adbc9b0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18106", "base_commit": "8e4da6e938430e11535e444032cfa2c32a6ab1a2", "patch": "diff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex b77cf969f49..1a896e0ced6 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -163,6 +163,7 @@ CBN\n cbt\n Ccc\n CCCBB\n+CCCDDD\n cch\n CCHAR\n CCmd\n@@ -369,6 +370,7 @@ DColor\n dcommon\n DComposition\n dde\n+DDDCCC\n DDESHARE\n DDevice\n DEADCHAR\ndiff --git a/src/buffer/out/Row.cpp b/src/buffer/out/Row.cpp\nindex 7a46215b6fc..63ba83f4cd5 100644\n--- a/src/buffer/out/Row.cpp\n+++ b/src/buffer/out/Row.cpp\n@@ -80,11 +80,12 @@ constexpr OutIt copy_n_small(InIt first, Diff count, OutIt dest)\n     return dest;\r\n }\r\n \r\n-CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept :\r\n+CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t charsLength, til::CoordType currentColumn, til::CoordType columnCount) noexcept :\r\n     _chars{ chars },\r\n     _charOffsets{ charOffsets },\r\n-    _lastCharOffset{ lastCharOffset },\r\n-    _currentColumn{ currentColumn }\r\n+    _charsLength{ charsLength },\r\n+    _currentColumn{ currentColumn },\r\n+    _columnCount{ columnCount }\r\n {\r\n }\r\n \r\n@@ -92,7 +93,7 @@ CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* cha\n // This function in particular returns the glyph's first column.\r\n til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept\r\n {\r\n-    targetOffset = clamp(targetOffset, 0, _lastCharOffset);\r\n+    targetOffset = clamp(targetOffset, 0, _charsLength);\r\n \r\n     // This code needs to fulfill two conditions on top of the obvious (a forward/backward search):\r\n     // A: We never want to stop on a column that is marked with CharOffsetsTrailer (= \"GetLeadingColumn\").\r\n@@ -130,10 +131,14 @@ til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) no\n til::CoordType CharToColumnMapper::GetTrailingColumnAt(ptrdiff_t offset) noexcept\r\n {\r\n     auto col = GetLeadingColumnAt(offset);\r\n-    // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n-    // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n-    for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+\r\n+    if (col < _columnCount)\r\n     {\r\n+        // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n+        // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n+        for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+        {\r\n+        }\r\n     }\r\n     return col;\r\n }\r\n@@ -1114,6 +1119,9 @@ std::wstring_view ROW::GetText() const noexcept\n     return { _chars.data(), width };\r\n }\r\n \r\n+// Arguments:\r\n+// - columnBegin: inclusive\r\n+// - columnEnd: exclusive\r\n std::wstring_view ROW::GetText(til::CoordType columnBegin, til::CoordType columnEnd) const noexcept\r\n {\r\n     const auto columns = GetReadableColumnCount();\r\n@@ -1219,15 +1227,15 @@ T ROW::_adjustForward(T column) const noexcept\n }\r\n \r\n // Creates a CharToColumnMapper given an offset into _chars.data().\r\n-// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120).\r\n+// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120].\r\n CharToColumnMapper ROW::_createCharToColumnMapper(ptrdiff_t offset) const noexcept\r\n {\r\n     const auto charsSize = _charSize();\r\n-    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize - 1);\r\n+    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize);\r\n     // We can sort of guess what column belongs to what offset because BMP glyphs are very common and\r\n     // UTF-16 stores them in 1 char. In other words, usually a ROW will have N chars for N columns.\r\n     const auto guessedColumn = gsl::narrow_cast<til::CoordType>(clamp(offset, 0, _columnCount));\r\n-    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn };\r\n+    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn, _columnCount };\r\n }\r\n \r\n const std::optional<ScrollbarData>& ROW::GetScrollbarData() const noexcept\r\ndiff --git a/src/buffer/out/Row.hpp b/src/buffer/out/Row.hpp\nindex d2c19036baf..44156d1b881 100644\n--- a/src/buffer/out/Row.hpp\n+++ b/src/buffer/out/Row.hpp\n@@ -71,7 +71,7 @@ struct RowCopyTextFromState\n // into a ROW's text this class can tell you what cell that pointer belongs to.\r\n struct CharToColumnMapper\r\n {\r\n-    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept;\r\n+    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn, til::CoordType columnCount) noexcept;\r\n \r\n     til::CoordType GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept;\r\n     til::CoordType GetTrailingColumnAt(ptrdiff_t offset) noexcept;\r\n@@ -85,8 +85,9 @@ struct CharToColumnMapper\n \r\n     const wchar_t* _chars;\r\n     const uint16_t* _charOffsets;\r\n-    ptrdiff_t _lastCharOffset;\r\n+    ptrdiff_t _charsLength;\r\n     til::CoordType _currentColumn;\r\n+    til::CoordType _columnCount;\r\n };\r\n \r\n class ROW final\r\ndiff --git a/src/buffer/out/UTextAdapter.cpp b/src/buffer/out/UTextAdapter.cpp\nindex ff0861ce54d..717d97812aa 100644\n--- a/src/buffer/out/UTextAdapter.cpp\n+++ b/src/buffer/out/UTextAdapter.cpp\n@@ -411,16 +411,13 @@ Microsoft::Console::ICU::unique_uregex Microsoft::Console::ICU::CreateRegex(cons\n     return unique_uregex{ re };\r\n }\r\n \r\n-// Returns an inclusive point range given a text start and end position.\r\n+// Returns a half-open [beg,end) range given a text start and end position.\r\n // This function is designed to be used with uregex_start64/uregex_end64.\r\n til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegularExpression* re)\r\n {\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     const auto nativeIndexBeg = uregex_start64(re, 0, &status);\r\n-    auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n-\r\n-    // The parameters are given as a half-open [beg,end) range, but the point_span we return in closed [beg,end].\r\n-    nativeIndexEnd--;\r\n+    const auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n \r\n     const auto& textBuffer = *static_cast<const TextBuffer*>(ut->context);\r\n     til::point_span ret;\r\n@@ -439,7 +436,7 @@ til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegula\n     if (utextAccess(ut, nativeIndexEnd, true))\r\n     {\r\n         const auto y = accessCurrentRow(ut);\r\n-        ret.end.x = textBuffer.GetRowByOffset(y).GetTrailingColumnAtCharOffset(ut->chunkOffset);\r\n+        ret.end.x = textBuffer.GetRowByOffset(y).GetLeadingColumnAtCharOffset(ut->chunkOffset);\r\n         ret.end.y = y;\r\n     }\r\n     else\r\ndiff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex a920854b732..df30a3ffb23 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -1118,6 +1118,14 @@ void TextBuffer::TriggerNewTextNotification(const std::wstring_view newText)\n     }\r\n }\r\n \r\n+void TextBuffer::TriggerSelection()\r\n+{\r\n+    if (_isActiveBuffer && _renderer)\r\n+    {\r\n+        _renderer->TriggerSelection();\r\n+    }\r\n+}\r\n+\r\n // Method Description:\r\n // - get delimiter class for buffer cell position\r\n // - used for double click selection and uia word navigation\r\n@@ -1132,6 +1140,213 @@ DelimiterClass TextBuffer::_GetDelimiterClassAt(const til::point pos, const std:\n     return GetRowByOffset(realPos.y).DelimiterClassAt(realPos.x, wordDelimiters);\r\n }\r\n \r\n+til::point TextBuffer::GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos < bufferSize.Origin())\r\n+    {\r\n+        // can't move further back, so return early at origin\r\n+        return bufferSize.Origin();\r\n+    }\r\n+    else if (pos >= limit)\r\n+    {\r\n+        // clamp to limit,\r\n+        // but still do movement\r\n+        pos = limit;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     CCC___|   -->   |CCC___  CCC|___\r\n+    //     DDD___|   -->   |DDD___  DDD|___\r\n+    //     ___CCC|   -->   ___|CCC  ___|CCC\r\n+    //     DDDCCC|   -->   DDD|CCC  DDD|CCC\r\n+    //     ___DDD|   -->   ___|DDD  ___|DDD\r\n+    //     CCCDDD|   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the beginning of the delimiter class run\r\n+    // 2. (includeWhitespace) if we were on a ControlChar, go back one more delimiter class run\r\n+    const auto initialDelimiter = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.Left())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the left boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+    else if (initialDelimiter == DelimiterClass::ControlChar)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+        pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+til::point TextBuffer::GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // can't move further forward,\r\n+        // so return early at limit\r\n+        return limit;\r\n+    }\r\n+    else if (const auto origin{ bufferSize.Origin() }; pos < origin)\r\n+    {\r\n+        // clamp to origin,\r\n+        // but still do movement\r\n+        pos = origin;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     |CCC___   -->   CCC___|  CCC|___\r\n+    //     |DDD___   -->   DDD___|  DDD|___\r\n+    //     |___CCC   -->   ___|CCC  ___|CCC\r\n+    //     |DDDCCC   -->   DDD|CCC  DDD|CCC\r\n+    //     |___DDD   -->   ___|DDD  ___|DDD\r\n+    //     |CCCDDD   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the end of the delimiter class run\r\n+    // 2. (includeWhitespace) if the next delimiter class run is a ControlChar, go forward one more delimiter class run\r\n+    pos = _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the right boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+\r\n+    if (const auto nextDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+        nextDelimClass == DelimiterClass::ControlChar)\r\n+    {\r\n+        return _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+bool TextBuffer::IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    if (!bufferSize.IsInExclusiveBounds(pos))\r\n+    {\r\n+        // not in bounds\r\n+        return false;\r\n+    }\r\n+\r\n+    // buffer boundaries are always word boundaries\r\n+    if (pos == bufferSize.Origin() || pos == bufferSize.BottomInclusiveRightExclusive())\r\n+    {\r\n+        return true;\r\n+    }\r\n+\r\n+    // at beginning of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.Left())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y - 1);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // at end of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // we can treat text as contiguous,\r\n+    // use DecrementInBounds (not exclusive) here\r\n+    auto prevPos = pos;\r\n+    bufferSize.DecrementInBounds(prevPos);\r\n+    const auto prevDelimiterClass = _GetDelimiterClassAt(prevPos, wordDelimiters);\r\n+\r\n+    // if we changed delimiter class\r\n+    // and the current delimiter class is not a control char,\r\n+    // we're at a word boundary\r\n+    const auto currentDelimiterClass = _GetDelimiterClassAt(pos, wordDelimiters);\r\n+    return prevDelimiterClass != currentDelimiterClass && currentDelimiterClass != DelimiterClass::ControlChar;\r\n+}\r\n+\r\n+til::point TextBuffer::_GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.Origin(); pos = nextPos)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.RightExclusive())\r\n+        {\r\n+            // wrapped onto previous line,\r\n+            // check if it was forced to wrap\r\n+            const auto& row = GetRowByOffset(nextPos.y);\r\n+            if (!row.WasWrapForced())\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (_GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class, we're done (don't apply move)\r\n+            return pos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+// Method Description:\r\n+// - Get the exclusive position for the end of the current delimiter class run\r\n+// Arguments:\r\n+// - pos - the buffer position being within the current delimiter class\r\n+// - wordDelimiters - what characters are we considering for the separation of words\r\n+til::point TextBuffer::_GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.BottomInclusiveRightExclusive(); pos = nextPos)\r\n+    {\r\n+        bufferSize.IncrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.Left())\r\n+        {\r\n+            // wrapped onto next line,\r\n+            // check if it was forced to wrap or switched delimiter class\r\n+            const auto& row = GetRowByOffset(pos.y);\r\n+            if (!row.WasWrapForced() || _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (bufferSize.IsInBounds(nextPos) && _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class,\r\n+            // apply the move and return\r\n+            return nextPos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n // Method Description:\r\n // - Get the til::point for the beginning of the word you are on\r\n // Arguments:\r\n@@ -1520,13 +1735,14 @@ til::point TextBuffer::GetGlyphStart(const til::point pos, std::optional<til::po\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    // limit is exclusive, so we need to move back to be within valid bounds\r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    // if we're on a trailing byte, move to the leading byte\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n         bufferSize.DecrementInBounds(resultPos, true);\r\n     }\r\n@@ -1548,12 +1764,13 @@ til::point TextBuffer::GetGlyphEnd(const til::point pos, bool accessibilityMode,\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n     {\r\n         bufferSize.IncrementInBounds(resultPos, true);\r\n     }\r\n@@ -1610,6 +1827,31 @@ bool TextBuffer::MoveToNextGlyph(til::point& pos, bool allowExclusiveEnd, std::o\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move forward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.IncrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Update pos to be the beginning of the previous glyph/character. This is used for accessibility\r\n // Arguments:\r\n@@ -1642,6 +1884,31 @@ bool TextBuffer::MoveToPreviousGlyph(til::point& pos, std::optional<til::point>\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move backward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.DecrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Determines the line-by-line rectangles based on two COORDs\r\n // - expands the rectangles to support wide glyphs\r\n@@ -1660,12 +1927,10 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n {\r\n     std::vector<til::inclusive_rect> textRects;\r\n \r\n-    const auto bufferSize = GetSize();\r\n-\r\n     // (0,0) is the top-left of the screen\r\n     // the physically \"higher\" coordinate is closer to the top-left\r\n     // the physically \"lower\" coordinate is closer to the bottom-right\r\n-    const auto [higherCoord, lowerCoord] = bufferSize.CompareInBounds(start, end) <= 0 ?\r\n+    const auto [higherCoord, lowerCoord] = start <= end ?\r\n                                                std::make_tuple(start, end) :\r\n                                                std::make_tuple(end, start);\r\n \r\n@@ -1686,6 +1951,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n         }\r\n         else\r\n         {\r\n+            const auto bufferSize = GetSize();\r\n             textRow.left = (row == higherCoord.y) ? higherCoord.x : bufferSize.Left();\r\n             textRow.right = (row == lowerCoord.y) ? lowerCoord.x : bufferSize.RightInclusive();\r\n         }\r\n@@ -1710,7 +1976,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n // - Else if a blockSelection, returns spans corresponding to each line in the block selection\r\n // Arguments:\r\n // - start: beginning of the text region of interest (inclusive)\r\n-// - end: the other end of the text region of interest (inclusive)\r\n+// - end: the other end of the text region of interest (exclusive)\r\n // - blockSelection: when enabled, get spans for each line covered by the block\r\n // - bufferCoordinates: when enabled, treat the coordinates as relative to\r\n //                      the buffer rather than the screen.\r\n@@ -1780,31 +2046,17 @@ void TextBuffer::_ExpandTextRow(til::inclusive_rect& textRow) const\n \r\n     // expand left side of rect\r\n     til::point targetPoint{ textRow.left, textRow.top };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.Left())\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.DecrementInExclusiveBounds(targetPoint);\r\n         textRow.left = targetPoint.x;\r\n     }\r\n \r\n     // expand right side of rect\r\n     targetPoint = { textRow.right, textRow.bottom };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.RightInclusive())\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.IncrementInExclusiveBounds(targetPoint);\r\n         textRow.right = targetPoint.x;\r\n     }\r\n }\r\n@@ -1821,8 +2073,8 @@ size_t TextBuffer::SpanLength(const til::point coordStart, const til::point coor\n // - Retrieves the plain text data between the specified coordinates.\r\n // Arguments:\r\n // - trimTrailingWhitespace - remove the trailing whitespace at the end of the result.\r\n-// - start - where to start getting text (should be at or prior to \"end\")\r\n-// - end - where to end getting text\r\n+// - start - where to start getting text (should be at or prior to \"end\") (inclusive)\r\n+// - end - where to end getting text (exclusive)\r\n // Return Value:\r\n // - Just the text.\r\n std::wstring TextBuffer::GetPlainText(const til::point start, const til::point end) const\r\n@@ -1851,7 +2103,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto maxX = req.bufferCoordinates ? req.maxX : ScreenToBufferLineInclusive(til::point{ req.maxX, iRow }, lineRendition).x;\r\n \r\n         rowBeg = minX;\r\n-        rowEnd = maxX + 1; // +1 to get an exclusive end\r\n+        rowEnd = maxX;\r\n     }\r\n     else\r\n     {\r\n@@ -1860,7 +2112,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto end = req.bufferCoordinates ? req.end : ScreenToBufferLineInclusive(req.end, lineRendition);\r\n \r\n         rowBeg = iRow != beg.y ? 0 : beg.x;\r\n-        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x + 1; // +1 to get an exclusive end\r\n+        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x;\r\n     }\r\n \r\n     // Our selection mechanism doesn't stick to glyph boundaries at the moment.\r\n@@ -1905,7 +2157,7 @@ std::wstring TextBuffer::GetPlainText(const CopyRequest& req) const\n         const auto& row = GetRowByOffset(iRow);\r\n         const auto& [rowBeg, rowEnd, addLineBreak] = _RowCopyHelper(req, iRow, row);\r\n \r\n-        // save selected text\r\n+        // save selected text (exclusive end)\r\n         selectedText += row.GetText(rowBeg, rowEnd);\r\n \r\n         if (addLineBreak && iRow != req.end.y)\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex c97de9e7523..775417caab0 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -170,9 +170,15 @@ class TextBuffer final\n     void TriggerScroll();\r\n     void TriggerScroll(const til::point delta);\r\n     void TriggerNewTextNotification(const std::wstring_view newText);\r\n+    void TriggerSelection();\r\n \r\n     til::point GetWordStart(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     til::point GetWordEnd(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    til::point GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    til::point GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    bool IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n     bool MoveToNextWord(til::point& pos, const std::wstring_view wordDelimiters, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousWord(til::point& pos, const std::wstring_view wordDelimiters) const;\r\n \r\n@@ -180,6 +186,8 @@ class TextBuffer final\n     til::point GetGlyphEnd(const til::point pos, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToNextGlyph(til::point& pos, bool allowBottomExclusive = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousGlyph(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n \r\n     const std::vector<til::inclusive_rect> GetTextRects(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n     std::vector<til::point_span> GetTextSpans(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n@@ -322,6 +330,8 @@ class TextBuffer final\n     void _SetFirstRowIndex(const til::CoordType FirstRowIndex) noexcept;\r\n     void _ExpandTextRow(til::inclusive_rect& selectionRow) const;\r\n     DelimiterClass _GetDelimiterClassAt(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForAccessibility(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForSelection(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordEndForAccessibility(const til::point target, const std::wstring_view wordDelimiters, const til::point limit) const;\r\ndiff --git a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\nindex be9e941c757..81974fe83ab 100644\n--- a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n+++ b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n@@ -49,15 +49,15 @@ class UTextAdapterTests\n             return { { beg, 0 }, { end, 0 } };\r\n         };\r\n \r\n-        auto expected = std::vector{ s(0, 2), s(8, 10) };\r\n+        auto expected = std::vector{ s(0, 3), s(8, 11) };\r\n         auto actual = buffer.SearchText(L\"abc\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(5, 5) };\r\n+        expected = std::vector{ s(5, 6) };\r\n         actual = buffer.SearchText(L\"\ud835\udcb7\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(12, 15) };\r\n+        expected = std::vector{ s(12, 16) };\r\n         actual = buffer.SearchText(L\"\u30cd\u30b3\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex b46da5236af..72a8e85ad55 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1200,7 +1200,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         const auto bufferSize{ _terminal->GetTextBuffer().GetSize() };\r\n         info.StartAtLeftBoundary = _terminal->GetSelectionAnchor().x == bufferSize.Left();\r\n-        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightInclusive();\r\n+        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightExclusive();\r\n         return info;\r\n     }\r\n \r\n@@ -1217,8 +1217,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             return;\r\n         }\r\n \r\n+        // clamp the converted position to be within the viewport bounds\r\n+        // x: allow range of [0, RightExclusive]\r\n+        // GH #18106: right exclusive needed for selection to support exclusive end\r\n         til::point terminalPosition{\r\n-            std::clamp(position.x, 0, _terminal->GetViewport().Width() - 1),\r\n+            std::clamp(position.x, 0, _terminal->GetViewport().Width()),\r\n             std::clamp(position.y, 0, _terminal->GetViewport().Height() - 1)\r\n         };\r\n \r\n@@ -2722,7 +2725,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bufferSize.DecrementInBounds(inclusiveEnd);\r\n \r\n         _terminal->SelectNewRegion(s.start, inclusiveEnd);\r\n-        _renderer->TriggerSelection();\r\n     }\r\n \r\n     void ControlCore::SelectCommand(const bool goUp)\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex 1da3b89ab1d..f4c0feed2a3 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -241,7 +241,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                               const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                               const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         const auto altEnabled = modifiers.IsAltPressed();\r\n         const auto shiftEnabled = modifiers.IsShiftPressed();\r\n@@ -338,7 +338,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                             const Core::Point pixelPosition,\r\n                                             const bool pointerPressedInBounds)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n         // Returning true from this function indicates that the caller should do no further processing of this movement.\r\n         bool handledCompletely = false;\r\n \r\n@@ -372,7 +372,19 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // _touchdown_ point here. We want to start the selection\r\n                     // from where the user initially clicked, not where they are\r\n                     // now.\r\n-                    _core->SetSelectionAnchor(_getTerminalPosition(til::point{ touchdownPoint }));\r\n+                    auto termPos = _getTerminalPosition(til::point{ touchdownPoint }, false);\r\n+                    if (dx < 0)\r\n+                    {\r\n+                        // _getTerminalPosition(_, false) will floor the x-value,\r\n+                        //   meaning that the selection will start on the left-side\r\n+                        //   of the current cell. This is great if the use is dragging\r\n+                        //   towards the right.\r\n+                        // If the user is dragging towards the left (dx < 0),\r\n+                        //   we want to select the current cell, so place the anchor on the right\r\n+                        //   side of the current cell.\r\n+                        termPos.x++;\r\n+                    }\r\n+                    _core->SetSelectionAnchor(termPos);\r\n \r\n                     // stop tracking the touchdown point\r\n                     _singleClickTouchdownPos = std::nullopt;\r\n@@ -428,7 +440,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                                const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                                const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, false);\r\n         // Short-circuit isReadOnly check to avoid warning dialog\r\n         if (!_core->IsInReadOnlyMode() && _canSendVTMouseInput(modifiers))\r\n         {\r\n@@ -475,7 +487,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                           const Core::Point pixelPosition,\r\n                                           const Control::MouseButtonState buttonState)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         // Short-circuit isReadOnly check to avoid warning dialog.\r\n         //\r\n@@ -662,7 +674,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - cursorPosition: in pixels, relative to the origin of the control\r\n     void ControlInteractivity::SetEndSelectionPoint(const Core::Point pixelPosition)\r\n     {\r\n-        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }));\r\n+        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }, true));\r\n         _selectionNeedsToBeCopied = true;\r\n     }\r\n \r\n@@ -672,12 +684,22 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Arguments:\r\n     // - pixelPosition: the (x,y) position of a given point (i.e.: mouse cursor).\r\n     //    NOTE: origin (0,0) is top-left.\r\n+    // - roundToNearestCell: if true, round the x-value. Otherwise, floor it (standard int division)\r\n     // Return Value:\r\n     // - the corresponding viewport terminal position for the given Point parameter\r\n-    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition)\r\n+    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell)\r\n     {\r\n         // Get the size of the font, which is in pixels\r\n-        const til::size fontSize{ _core->GetFont().GetSize() };\r\n+        const auto fontSize{ _core->GetFont().GetSize() };\r\n+\r\n+        if (roundToNearestCell)\r\n+        {\r\n+            // GH#5099: round the x-value to the nearest cell\r\n+            til::point result;\r\n+            result.x = gsl::narrow_cast<til::CoordType>(std::round(gsl::narrow_cast<double>(pixelPosition.x) / fontSize.width));\r\n+            result.y = pixelPosition.y / fontSize.height;\r\n+            return result;\r\n+        }\r\n         // Convert the location in pixels to characters within the current viewport.\r\n         return pixelPosition / fontSize;\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 18d55b53cfa..dcf2c811d02 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -155,7 +155,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bool _canSendVTMouseInput(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers);\r\n         bool _shouldSendAlternateScroll(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers, const int32_t delta);\r\n \r\n-        til::point _getTerminalPosition(const til::point pixelPosition);\r\n+        til::point _getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell);\r\n \r\n         bool _sendMouseEventHelper(const til::point terminalPosition,\r\n                                    const unsigned int pointerUpdateKind,\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 67a1523e99b..9e6350df044 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -478,7 +478,7 @@ bool Terminal::ShouldSendAlternateScroll(const unsigned int uiButton,\n // - The position relative to the viewport\r\n std::wstring Terminal::GetHyperlinkAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos));\r\n+    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos, false));\r\n }\r\n \r\n std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\r\n@@ -502,12 +502,8 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n         result = GetHyperlinkIntervalFromViewportPosition(viewportPos);\r\n         if (result.has_value())\r\n         {\r\n-            // GetPlainText and _ConvertToBufferCell work with inclusive coordinates, but interval's\r\n-            // stop point is (horizontally) exclusive, so let's just update it.\r\n-            result->stop.x--;\r\n-\r\n-            result->start = _ConvertToBufferCell(result->start);\r\n-            result->stop = _ConvertToBufferCell(result->stop);\r\n+            result->start = _ConvertToBufferCell(result->start, false);\r\n+            result->stop = _ConvertToBufferCell(result->stop, true);\r\n         }\r\n     }\r\n     else\r\n@@ -544,7 +540,7 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n // - The hyperlink ID\r\n uint16_t Terminal::GetHyperlinkIdAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos))->TextAttr().GetHyperlinkId();\r\n+    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos, false))->TextAttr().GetHyperlinkId();\r\n }\r\n \r\n // Method description:\r\n@@ -1466,7 +1462,6 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n                 // PointTree uses half-open ranges and viewport-relative coordinates.\r\n                 range.start.y -= beg;\r\n                 range.end.y -= beg;\r\n-                range.end.x++;\r\n                 intervals.push_back(PointTree::interval(range.start, range.end, 0));\r\n             } while (uregex_findNext(re.get(), &status));\r\n         }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex 0ff2cb1955e..1459c39fc3c 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -478,7 +478,7 @@ class Microsoft::Terminal::Core::Terminal final :\n     std::vector<til::point_span> _GetSelectionSpans() const noexcept;\r\n     std::pair<til::point, til::point> _PivotSelection(const til::point targetPos, bool& targetStart) const noexcept;\r\n     std::pair<til::point, til::point> _ExpandSelectionAnchors(std::pair<til::point, til::point> anchors) const;\r\n-    til::point _ConvertToBufferCell(const til::point viewportPos) const;\r\n+    til::point _ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const;\r\n     void _ScrollToPoint(const til::point pos);\r\n     void _MoveByChar(SelectionDirection direction, til::point& pos);\r\n     void _MoveByWord(SelectionDirection direction, til::point& pos);\r\ndiff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 6a800f329dd..9501f64a85e 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -93,14 +93,21 @@ const til::point Terminal::GetSelectionEnd() const noexcept\n til::point Terminal::SelectionStartForRendering() const\r\n {\r\n     auto pos{ _selection->start };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n     if (pos.x != bufferSize.Left())\r\n     {\r\n         // In general, we need to draw the marker one before the\r\n         // beginning of the selection.\r\n         // When we're at the left boundary, we want to\r\n         // flip the marker, so we skip this step.\r\n-        bufferSize.DecrementInBounds(pos);\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -112,14 +119,21 @@ til::point Terminal::SelectionStartForRendering() const\n til::point Terminal::SelectionEndForRendering() const\r\n {\r\n     auto pos{ _selection->end };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n-    if (pos.x != bufferSize.RightInclusive())\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        // In general, we need to draw the marker one after the\r\n-        // end of the selection.\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // sln->end is exclusive\r\n+        // In general, we need to draw the marker on the same cell.\r\n         // When we're at the right boundary, we want to\r\n-        // flip the marker, so we skip this step.\r\n-        bufferSize.IncrementInBounds(pos);\r\n+        // flip the marker, so we move one cell to the left.\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -157,7 +171,7 @@ void Terminal::MultiClickSelection(const til::point viewportPos, SelectionExpans\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = expansionMode;\r\n@@ -179,7 +193,7 @@ void Terminal::SetSelectionAnchor(const til::point viewportPos)\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = SelectionExpansion::Char;\r\n@@ -198,7 +212,7 @@ void Terminal::SetSelectionEnd(const til::point viewportPos, std::optional<Selec\n // - based on the selection expansion mode\r\n // Arguments:\r\n // - viewportPos: the (x,y) coordinate on the visible viewport\r\n-// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for ShiftClick\r\n+// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for Shift+Click\r\n void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewportPos, std::optional<SelectionExpansion> newExpansionMode)\r\n {\r\n     wil::hide_name _selection;\r\n@@ -209,7 +223,12 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n         return;\r\n     }\r\n \r\n-    const auto textBufferPos = _ConvertToBufferCell(viewportPos);\r\n+    auto textBufferPos = _ConvertToBufferCell(viewportPos, true);\r\n+    if (newExpansionMode && *newExpansionMode == SelectionExpansion::Char && textBufferPos >= selection->pivot)\r\n+    {\r\n+        // Shift+Click forwards should highlight the clicked space\r\n+        _activeBuffer().GetSize().IncrementInExclusiveBounds(textBufferPos);\r\n+    }\r\n \r\n     // if this is a shiftClick action, we need to overwrite the _multiClickSelectionMode value (even if it's the same)\r\n     // Otherwise, we may accidentally expand during other selection-based actions\r\n@@ -248,7 +267,7 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n // - the new start/end for a selection\r\n std::pair<til::point, til::point> Terminal::_PivotSelection(const til::point targetPos, bool& targetStart) const noexcept\r\n {\r\n-    if (targetStart = _activeBuffer().GetSize().CompareInBounds(targetPos, _selection->pivot) <= 0)\r\n+    if (targetStart = targetPos <= _selection->pivot)\r\n     {\r\n         // target is before pivot\r\n         // treat target as start\r\n@@ -273,17 +292,31 @@ std::pair<til::point, til::point> Terminal::_ExpandSelectionAnchors(std::pair<ti\n     auto start = anchors.first;\r\n     auto end = anchors.second;\r\n \r\n-    const auto bufferSize = _activeBuffer().GetSize();\r\n+    const auto& buffer = _activeBuffer();\r\n+    const auto bufferSize = buffer.GetSize();\r\n     switch (_multiClickSelectionMode)\r\n     {\r\n     case SelectionExpansion::Line:\r\n         start = { bufferSize.Left(), start.y };\r\n-        end = { bufferSize.RightInclusive(), end.y };\r\n+        end = { bufferSize.RightExclusive(), end.y };\r\n         break;\r\n     case SelectionExpansion::Word:\r\n-        start = _activeBuffer().GetWordStart(start, _wordDelimiters);\r\n-        end = _activeBuffer().GetWordEnd(end, _wordDelimiters);\r\n+    {\r\n+        start = buffer.GetWordStart2(start, _wordDelimiters, false);\r\n+\r\n+        // GH#5099: We round to the nearest cell boundary,\r\n+        //   so we would normally prematurely expand to the next word\r\n+        //   as we approach it during a 2x-click+drag.\r\n+        //   To remedy this, decrement the end's position by 1.\r\n+        //   However, only do this when expanding right (it's correct\r\n+        //   as is when expanding left).\r\n+        if (end > _selection->pivot)\r\n+        {\r\n+            bufferSize.DecrementInExclusiveBounds(end);\r\n+        }\r\n+        end = buffer.GetWordEnd2(end, _wordDelimiters, false);\r\n         break;\r\n+    }\r\n     case SelectionExpansion::Char:\r\n     default:\r\n         // no expansion is necessary\r\n@@ -376,9 +409,9 @@ void Terminal::ExpandSelectionToWord()\n         const auto& buffer = _activeBuffer();\r\n         auto selection{ _selection.write() };\r\n         wil::hide_name _selection;\r\n-        selection->start = buffer.GetWordStart(selection->start, _wordDelimiters);\r\n+        selection->start = buffer.GetWordStart2(selection->start, _wordDelimiters, false);\r\n         selection->pivot = selection->start;\r\n-        selection->end = buffer.GetWordEnd(selection->end, _wordDelimiters);\r\n+        selection->end = buffer.GetWordEnd2(selection->end, _wordDelimiters, false);\r\n \r\n         // if we're targeting both endpoints, instead just target \"end\"\r\n         if (WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) && WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::End))\r\n@@ -529,7 +562,6 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n         selection->start = result->first;\r\n         selection->pivot = result->first;\r\n         selection->end = result->second;\r\n-        bufferSize.DecrementInBounds(selection->end);\r\n         _selectionIsTargetingUrl = true;\r\n         _selectionEndpoint = SelectionEndpoint::End;\r\n     }\r\n@@ -625,7 +657,7 @@ void Terminal::UpdateSelection(SelectionDirection direction, SelectionExpansion\n     }\r\n     auto targetPos{ WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) ? _selection->start : _selection->end };\r\n \r\n-    // 2 Perform the movement\r\n+    // 2. Perform the movement\r\n     switch (mode)\r\n     {\r\n     case SelectionExpansion::Char:\r\n@@ -695,12 +727,12 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n-        _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphStart(pos);\r\n+        _activeBuffer().MoveToPreviousGlyph2(pos);\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphEnd(pos);\r\n+        // We need the limit to be the mutable viewport here,\r\n+        // otherwise we're allowed to navigate by character past the mutable bottom\r\n+        _activeBuffer().MoveToNextGlyph2(pos, _GetMutableViewport().BottomInclusiveRightExclusive());\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -714,7 +746,7 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n         const auto bufferSize{ _activeBuffer().GetSize() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + 1 };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -722,61 +754,45 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n \r\n void Terminal::_MoveByWord(SelectionDirection direction, til::point& pos)\r\n {\r\n+    const auto& buffer = _activeBuffer();\r\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n     {\r\n-        const auto wordStartPos{ _activeBuffer().GetWordStart(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(_selection->pivot, pos) < 0)\r\n-        {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = wordStartPos;\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        }\r\n-        else if (wordStartPos == pos)\r\n-        {\r\n-            // already at the beginning of the current word,\r\n-            // move to the beginning of the previous word\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // move to the beginning of the current word\r\n-            pos = wordStartPos;\r\n+            // didn't move because we're already at the beginning of a word,\r\n+            // so move to the beginning of the previous word\r\n+            buffer.GetSize().DecrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Right:\r\n     {\r\n-        const auto wordEndPos{ _activeBuffer().GetWordEnd(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(pos, _selection->pivot) < 0)\r\n+        const auto mutableViewportEndExclusive = _GetMutableViewport().BottomInclusiveRightExclusive();\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        }\r\n-        else if (wordEndPos == pos)\r\n-        {\r\n-            // already at the end of the current word,\r\n-            // move to the end of the next word\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n-        {\r\n-            // move to the end of the current word\r\n-            pos = wordEndPos;\r\n+            // didn't move because we're already at the end of a word,\r\n+            // so move to the end of the next word\r\n+            buffer.GetSize().IncrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Up:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordStart2(pos, _wordDelimiters, true);\r\n         break;\r\n     case SelectionDirection::Down:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordEnd2(pos, _wordDelimiters, true);\r\n         break;\r\n     }\r\n }\r\n@@ -790,7 +806,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         pos = { bufferSize.Left(), pos.y };\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        pos = { bufferSize.RightInclusive(), pos.y };\r\n+        pos = { bufferSize.RightExclusive(), pos.y };\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -804,7 +820,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         const auto viewportHeight{ _GetMutableViewport().Height() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + viewportHeight };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -821,7 +837,7 @@ void Terminal::_MoveByBuffer(SelectionDirection direction, til::point& pos) noex\n         break;\r\n     case SelectionDirection::Right:\r\n     case SelectionDirection::Down:\r\n-        pos = { bufferSize.RightInclusive(), _GetMutableViewport().BottomInclusive() };\r\n+        pos = { bufferSize.RightExclusive(), _GetMutableViewport().BottomInclusive() };\r\n         break;\r\n     }\r\n }\r\n@@ -901,13 +917,17 @@ Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singl\n // - convert viewport position to the corresponding location on the buffer\r\n // Arguments:\r\n // - viewportPos: a coordinate on the viewport\r\n+// - allowRightExclusive: if true, clamp to the right exclusive boundary of the buffer.\r\n+//     Careful! This position doesn't point to any data in the buffer!\r\n // Return Value:\r\n // - the corresponding location on the buffer\r\n-til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\r\n+til::point Terminal::_ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const\r\n {\r\n     const auto yPos = _VisibleStartIndex() + viewportPos.y;\r\n     til::point bufferPos = { viewportPos.x, yPos };\r\n-    _activeBuffer().GetSize().Clamp(bufferPos);\r\n+    const auto bufferSize = _activeBuffer().GetSize();\r\n+    bufferPos.x = std::clamp(bufferPos.x, bufferSize.Left(), allowRightExclusive ? bufferSize.RightExclusive() : bufferSize.RightInclusive());\r\n+    bufferPos.y = std::clamp(bufferPos.y, bufferSize.Top(), bufferSize.BottomInclusive());\r\n     return bufferPos;\r\n }\r\n \r\n@@ -917,7 +937,7 @@ til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\n // - pos: a coordinate relative to the buffer (not viewport)\r\n void Terminal::_ScrollToPoint(const til::point pos)\r\n {\r\n-    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInBounds(pos))\r\n+    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInExclusiveBounds(pos))\r\n     {\r\n         if (const auto amtAboveView = visibleViewport.Top() - pos.y; amtAboveView > 0)\r\n         {\r\ndiff --git a/src/cascadia/TerminalCore/terminalrenderdata.cpp b/src/cascadia/TerminalCore/terminalrenderdata.cpp\nindex 006d87aabe5..d7bca1077cc 100644\n--- a/src/cascadia/TerminalCore/terminalrenderdata.cpp\n+++ b/src/cascadia/TerminalCore/terminalrenderdata.cpp\n@@ -201,6 +201,11 @@ til::CoordType Terminal::_ScrollToPoints(const til::point coordStart, const til:\n     return _VisibleStartIndex();\r\n }\r\n \r\n+// Method Description:\r\n+// - selects the region from coordStart to coordEnd\r\n+// Arguments:\r\n+// - coordStart - The start point (inclusive)\r\n+// - coordEnd - The end point (inclusive)\r\n void Terminal::SelectNewRegion(const til::point coordStart, const til::point coordEnd)\r\n {\r\n     const auto newScrollOffset = _ScrollToPoints(coordStart, coordEnd);\r\n@@ -210,6 +215,7 @@ void Terminal::SelectNewRegion(const til::point coordStart, const til::point coo\n     const auto newCoordEnd = til::point{ coordEnd.x, coordEnd.y - newScrollOffset };\r\n     SetSelectionAnchor(newCoordStart);\r\n     SetSelectionEnd(newCoordEnd, SelectionExpansion::Char);\r\n+    _activeBuffer().TriggerSelection();\r\n }\r\n \r\n const std::wstring_view Terminal::GetConsoleTitle() const noexcept\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\nindex e018e1fd2ad..999809cb397 100644\n--- a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n@@ -419,7 +419,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -440,7 +440,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -450,7 +450,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -460,7 +460,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -502,7 +502,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -663,7 +663,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 26, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 27, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -673,7 +673,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -731,7 +731,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 29, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 30, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -741,7 +741,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -804,7 +804,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 1, 1 };\r\n-            const til::point expectedEnd{ 1, 2 };\r\n+            const til::point expectedEnd{ 2, 2 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\nindex 49fcd6d21eb..282b1995da7 100644\n--- a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n@@ -438,8 +438,9 @@ namespace ControlUnitTests\n         // The viewport is on row 21, so the selection will be on:\r\n         // {(5, 5)+(0, 21)} to {(5, 5)+(0, 21)}\r\n         til::point expectedAnchor{ 5, 26 };\r\n+        til::point expectedEnd{ 6, 26 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Scroll up a line, with the left mouse button selected\");\r\n         interactivity->MouseWheel(modifiers,\r\n@@ -449,10 +450,11 @@ namespace ControlUnitTests\n \r\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The viewport is now on row 20, so the selection will be on:\r\n-        // {(5, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n-        til::point newExpectedAnchor{ 5, 25 };\r\n+        // {(5 + 1, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n+        // NOTE: newExpectedAnchor should be expectedEnd moved up one row\r\n+        til::point newExpectedAnchor{ 6, 25 };\r\n         // Remember, the anchor is always before the end in the buffer. So yes,\r\n-        // se started the selection on 5,26, but now that's the end.\r\n+        // we started the selection on 5,26, but now that's the end.\r\n         VERIFY_ARE_EQUAL(newExpectedAnchor, core->_terminal->GetSelectionAnchor());\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n     }\r\n@@ -628,7 +630,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify that it started on the first cell we clicked on, not the one we dragged to\");\r\n         til::point expectedAnchor{ 0, 0 };\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        til::point expectedEnd{ 2, 0 };\r\n+        til::point expectedEnd{ 3, 0 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         interactivity->PointerReleased(noMouseDown,\r\n@@ -798,8 +800,9 @@ namespace ControlUnitTests\n         // The viewport is on row (historySize + 5), so the selection will be on:\r\n         // {(5, (historySize+5))+(0, 21)} to {(5, (historySize+5))+(0, 21)}\r\n         til::point expectedAnchor{ 5, settings->HistorySize() + 5 };\r\n+        til::point expectedEnd{ 6, expectedAnchor.y }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Output a line of text\");\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n@@ -807,6 +810,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -815,7 +819,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 1, core->_terminal->GetScrollOffset());\r\n \r\n@@ -825,6 +829,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -833,7 +838,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 2, core->_terminal->GetScrollOffset());\r\n \r\n@@ -858,15 +863,17 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"anchor:({},{})\", anchor.x, anchor.y).c_str());\r\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n+            // Selection was updated, but we didn't highlight a full cell\r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n             VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n         }\r\n \r\n-        Log::Comment(L\"Output a line ant move the mouse a little to update the selection, all at once\");\r\n+        Log::Comment(L\"Output a line and move the mouse a little to update the selection, all at once\");\r\n         // Same as above. The viewport has moved, so the mouse is still over the\r\n         // same character, even though it's at a new offset.\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 3, core->_terminal->GetScrollOffset());\r\n         interactivity->PointerMoved(leftMouseDown,\r\n                                     WM_LBUTTONDOWN, //pointerUpdateKind\r\n@@ -883,7 +890,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n \r\n         // Output enough text for the selection to get pushed off the buffer\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\nindex 11f01c75297..1585fef905f 100644\n--- a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n@@ -126,20 +126,20 @@ namespace TerminalCoreUnitTests\n \r\n             // Test with no scrollback\r\n             Log::Comment(L\"Single click selection with NO scrollback value\");\r\n-            ValidateSingleClickSelection(0, { 9, 9 }, { 9, 9 });\r\n+            ValidateSingleClickSelection(0, { 10, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Double click selection with NO scrollback value\");\r\n-            ValidateDoubleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateDoubleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Triple click selection with NO scrollback value\");\r\n-            ValidateTripleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateTripleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n \r\n             // Test with max scrollback\r\n             const til::CoordType expected_row = SHRT_MAX - 1;\r\n             Log::Comment(L\"Single click selection with MAXIMUM scrollback value\");\r\n-            ValidateSingleClickSelection(SHRT_MAX, { 9, expected_row }, { 9, expected_row });\r\n+            ValidateSingleClickSelection(SHRT_MAX, { 10, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Double click selection with MAXIMUM scrollback value\");\r\n-            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Triple click selection with MAXIMUM scrollback value\");\r\n-            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n         }\r\n \r\n         TEST_METHOD(SelectFromOutofBounds)\r\n@@ -155,7 +155,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const auto leftBoundary = viewport.Left();\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n             const auto topBoundary = viewport.Top();\r\n             const auto bottomBoundary = viewport.BottomInclusive();\r\n \r\n@@ -163,7 +163,7 @@ namespace TerminalCoreUnitTests\n             // should clamp to right boundary\r\n             term.SetSelectionAnchor({ 20, 5 });\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n-            ValidateLinearSelection(term, { rightBoundary, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { rightExclusiveBoundary, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Simulate click past left (x,y) = (-20,5)\r\n             // should clamp to left boundary\r\n@@ -197,7 +197,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const til::CoordType leftBoundary = 0;\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n \r\n             // Simulate click at (x,y) = (5,5)\r\n             term.SetSelectionAnchor({ 5, 5 });\r\n@@ -205,7 +205,7 @@ namespace TerminalCoreUnitTests\n             // Case 1: Move out of right boundary\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n             term.SetSelectionEnd({ 20, 5 });\r\n-            ValidateLinearSelection(term, { 5, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { 5, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Move out of left boundary\r\n             Log::Comment(L\"Out of bounds: X-value negative\");\r\n@@ -312,7 +312,7 @@ namespace TerminalCoreUnitTests\n \r\n             // Validate selection area\r\n             // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 6, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyph_Leading)\r\n@@ -334,8 +334,8 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionAnchor(clickPos);\r\n \r\n             // Validate selection area\r\n-            // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            // Selection should clamp to the left side of the glyph and stay degenerate\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 4, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyphsInBoxSelection)\r\n@@ -356,12 +356,26 @@ namespace TerminalCoreUnitTests\n             GetTextBuffer(term).GetCursor().SetPosition({ 7, 11 });\r\n             term.Write(burrito);\r\n \r\n+            // Text buffer should look like this:\r\n+            // -------------\r\n+            // |     A      |\r\n+            // |            |\r\n+            // |    \ud83c\udf2f      |\r\n+            // |       \ud83c\udf2f   |\r\n+            // |        B   |\r\n+            // -------------\r\n+            // A: selection anchor\r\n+            // B: selection end\r\n+            // The boundaries of the selection should cut through\r\n+            //  the middle of the burritos, but the selection\r\n+            //  should expand to encompass each burrito entirely.\r\n+\r\n             // Simulate ALT + click at (x,y) = (5,8)\r\n             term.SetSelectionAnchor({ 5, 8 });\r\n             term.SetBlockSelection(true);\r\n \r\n-            // Simulate move to (x,y) = (7,12)\r\n-            term.SetSelectionEnd({ 7, 12 });\r\n+            // Simulate move to (x,y) = (8,12)\r\n+            term.SetSelectionEnd({ 8, 12 });\r\n \r\n             // Simulate renderer calling TriggerSelection and acquiring selection area\r\n             auto selectionSpans = term.GetSelectionSpans();\r\n@@ -376,18 +390,18 @@ namespace TerminalCoreUnitTests\n                 if (rowValue == 10)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 4, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n                 else if (rowValue == 11)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 9, rowValue }), sp.end);\r\n                 }\r\n                 else\r\n                 {\r\n                     // Verify all lines\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n \r\n                 rowValue++;\r\n@@ -414,7 +428,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size() - 1), 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size()), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_Delimiter)\r\n@@ -432,7 +446,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_DelimiterClass)\r\n@@ -457,10 +471,10 @@ namespace TerminalCoreUnitTests\n \r\n             // ---Validate selection area---\r\n             // \"Terminal\" is in class 2\r\n-            // \">\" is in class 1\r\n+            // \":\" and \">\" are in class 1\r\n             // the white space to the right of the \">\" is in class 0\r\n             // Double-clicking the \">\" should only highlight that cell\r\n-            ValidateLinearSelection(term, { 15, 10 }, { 15, 10 });\r\n+            ValidateLinearSelection(term, { 15, 10 }, { 16, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Right)\r\n@@ -489,7 +503,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 21, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Left)\r\n@@ -502,7 +516,7 @@ namespace TerminalCoreUnitTests\n             auto settings = winrt::make<MockTermSettings>(0, 100, 100);\r\n             term.UpdateSettings(settings);\r\n \r\n-            // Insert text at position (21,10)\r\n+            // Insert text at position (4,10)\r\n             const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n@@ -513,12 +527,12 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,10)\r\n             //\r\n             // buffer: doubleClickMe dragThroughHere\r\n-            //         ^                ^\r\n-            //       finish            start\r\n+            //          ^               ^\r\n+            //        finish           start\r\n             term.SetSelectionEnd({ 5, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClick_GeneralCase)\r\n@@ -532,7 +546,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Line);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Horizontal)\r\n@@ -549,7 +563,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 7, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Vertical)\r\n@@ -565,7 +579,7 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,11)\r\n             term.SetSelectionEnd({ 5, 11 });\r\n \r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 11 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 11 });\r\n         }\r\n \r\n         TEST_METHOD(ShiftClick)\r\n@@ -579,20 +593,20 @@ namespace TerminalCoreUnitTests\n             term.UpdateSettings(settings);\r\n \r\n             // Insert text at position (4,10)\r\n-            const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n+            const std::wstring_view text = L\"doubleClickMe dragThroughHere anotherWord\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n \r\n-            // Step 1: Create a selection on \"doubleClickMe\"\r\n+            Log::Comment(L\"Step 1 : Create a selection on \\\"doubleClickMe\\\"\");\r\n             {\r\n                 // Simulate double click at (x,y) = (5,10)\r\n                 term.MultiClickSelection({ 5, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 16, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 17, 10 });\r\n             }\r\n \r\n-            // Step 2: Shift+Click to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 2: Shift+Click to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+Click at (x,y) = (21,10)\r\n                 //\r\n@@ -602,10 +616,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area: \"doubleClickMe drag\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 21, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 22, 10 });\r\n             }\r\n \r\n-            // Step 3: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 3: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -615,10 +629,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Triple-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 4: Shift+Triple-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+TripleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -628,60 +642,62 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Line);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 100, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 5: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start            click      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^           ^\r\n+                //       start            click       finish\r\n+                // NOTE: end is exclusive, so finish should point to the spot AFTER \"dragThroughHere\"\r\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag past \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 6: Drag past \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (35,10)\r\n                 // Since we were preceded by a double-click, we're in \"word\" expansion mode\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere     |\r\n-                //         ^                                 ^\r\n-                //       start                             finish (boundary)\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                              ^\r\n+                //       start                          finish\r\n                 term.SetSelectionEnd({ 35, 10 });\r\n \r\n-                // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                // Validate selection area: \"doubleClickMe dragThroughHere anotherWord\" selected\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 45, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag back to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 7: Drag back to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (21,10)\r\n+                // Should still be in \"word\" expansion mode!\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start             drag      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^\r\n+                //       start            finish\r\n                 term.SetSelectionEnd({ 21, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 7: Drag within \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 8: Drag within \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (25,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                    ^      ^\r\n-                //       start                 drag  finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                    ^\r\n+                //       start                finish\r\n                 term.SetSelectionEnd({ 25, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" still selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n         }\r\n \r\n@@ -691,25 +707,27 @@ namespace TerminalCoreUnitTests\n             DummyRenderer renderer{ &term };\r\n             term.Create({ 100, 100 }, 0, renderer);\r\n \r\n-            // Step 1: Create a selection\r\n+            Log::Comment(L\"Step 1: Create a selection\");\r\n             {\r\n-                // (10,10) to (20, 10)\r\n+                // (10,10) to (20, 10) (inclusive)\r\n                 term.SelectNewRegion({ 10, 10 }, { 20, 10 });\r\n \r\n                 // Validate selection area\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n \r\n-            // Step 2: Drag to (5,10)\r\n+            Log::Comment(L\"Step 2: Drag to (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 });\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should be (10, 10)\r\n+                // NOTES:\r\n+                // - Pivot should be (10, 10)\r\n+                // - though end is generally exclusive, since we moved behind the pivot, end is actually inclusive\r\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 3: Drag back to (20,10)\r\n+            Log::Comment(L\"Step 3: Drag back to (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 });\r\n \r\n@@ -718,7 +736,7 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Click at (5,10)\r\n+            Log::Comment(L\"Step 4: Shift+Click at (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n@@ -727,13 +745,14 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Click back at (20,10)\r\n+            Log::Comment(L\"Step 5: Shift+Click back at (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should still be (10, 10)\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                //   Pivot should still be (10, 10)\r\n+                //   Shift+Click makes end inclusive (so add 1)\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n         }\r\n     };\r\ndiff --git a/src/host/selection.cpp b/src/host/selection.cpp\nindex 300068d9671..d7dcf21ebe2 100644\n--- a/src/host/selection.cpp\n+++ b/src/host/selection.cpp\n@@ -43,11 +43,32 @@ void Selection::_RegenerateSelectionSpans() const\n     endSelectionAnchor.x = (_d->coordSelectionAnchor.x == _d->srSelectionRect.left) ? _d->srSelectionRect.right : _d->srSelectionRect.left;\r\n     endSelectionAnchor.y = (_d->coordSelectionAnchor.y == _d->srSelectionRect.top) ? _d->srSelectionRect.bottom : _d->srSelectionRect.top;\r\n \r\n+    // GH #18106: Conhost and Terminal share most of the selection code.\r\n+    //    Both now store the selection data as a half-open range [start, end),\r\n+    //     where \"end\" is the bottom-right-most point.\r\n+    //    Note that Conhost defines start/end as \"start was set in time before end\",\r\n+    //     whereas above (and in Terminal) we're treating start/end as \"start is physically before end\".\r\n+    //    We want Conhost to still operate as an inclusive range.\r\n+    //    To make it \"feel\" inclusive, we need to adjust the \"end\" endpoint\r\n+    //     by incrementing it by one, so that the \"end\" endpoint is rendered\r\n+    //     and handled as selected.\r\n     const auto blockSelection = !IsLineSelection();\r\n-    _lastSelectionSpans = screenInfo.GetTextBuffer().GetTextSpans(_d->coordSelectionAnchor,\r\n-                                                                  endSelectionAnchor,\r\n-                                                                  blockSelection,\r\n-                                                                  false);\r\n+    const auto& buffer = screenInfo.GetTextBuffer();\r\n+    auto startSelectionAnchor = _d->coordSelectionAnchor;\r\n+    if (blockSelection)\r\n+    {\r\n+        // Compare x-values when we're in block selection!\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor.x <= endSelectionAnchor.x ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    else\r\n+    {\r\n+        // General comparison for line selection.\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor <= endSelectionAnchor ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    _lastSelectionSpans = buffer.GetTextSpans(startSelectionAnchor,\r\n+                                              endSelectionAnchor,\r\n+                                              blockSelection,\r\n+                                              false);\r\n     _lastSelectionGeneration = _d.generation();\r\n }\r\n \r\ndiff --git a/src/host/ut_host/ClipboardTests.cpp b/src/host/ut_host/ClipboardTests.cpp\nindex 21d4c7b13b8..24f2693c643 100644\n--- a/src/host/ut_host/ClipboardTests.cpp\n+++ b/src/host/ut_host/ClipboardTests.cpp\n@@ -84,7 +84,7 @@ class ClipboardTests\n         const auto& screenInfo = gci.GetActiveOutputBuffer();\r\n         const auto& buffer = screenInfo.GetTextBuffer();\r\n \r\n-        constexpr til::point_span selection = { { 0, 0 }, { 14, 3 } };\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 15, 3 } };\r\n         const auto req = TextBuffer::CopyRequest::FromConfig(buffer, selection.start, selection.end, false, !fLineSelection, false);\r\n         return buffer.GetPlainText(req);\r\n     }\r\ndiff --git a/src/host/ut_host/SearchTests.cpp b/src/host/ut_host/SearchTests.cpp\nindex 423273b3c38..d37c3556d40 100644\n--- a/src/host/ut_host/SearchTests.cpp\n+++ b/src/host/ut_host/SearchTests.cpp\n@@ -60,7 +60,7 @@ class SearchTests\n         const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n \r\n         auto coordEndExpected = coordStartExpected;\r\n-        coordEndExpected.x += 1;\r\n+        coordEndExpected.x += 2;\r\n \r\n         VERIFY_IS_TRUE(s.SelectCurrent());\r\n         VERIFY_ARE_EQUAL(coordStartExpected, gci.renderData.GetSelectionAnchor());\r\ndiff --git a/src/host/ut_host/SelectionTests.cpp b/src/host/ut_host/SelectionTests.cpp\nindex 62eac812053..f314e8dcc9e 100644\n--- a/src/host/ut_host/SelectionTests.cpp\n+++ b/src/host/ut_host/SelectionTests.cpp\n@@ -74,7 +74,7 @@ class SelectionTests\n                 VERIFY_ARE_EQUAL(span.end.y, sRectangleLineNumber);\r\n \r\n                 VERIFY_ARE_EQUAL(span.start.x, m_pSelection->_d->srSelectionRect.left);\r\n-                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right);\r\n+                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right + 1);\r\n             }\r\n         }\r\n     }\r\n@@ -141,15 +141,17 @@ class SelectionTests\n         }\r\n     }\r\n \r\n-    void VerifyGetSelectionSpans_LineMode(const til::point start, const til::point end)\r\n+    void VerifyGetSelectionSpans_LineMode(const til::point inclusiveStart, const til::point inclusiveEnd)\r\n     {\r\n         const auto selectionSpans = m_pSelection->GetSelectionSpans();\r\n \r\n         if (VERIFY_ARE_EQUAL(1u, selectionSpans.size()))\r\n         {\r\n             auto& span{ selectionSpans[0] };\r\n-            VERIFY_ARE_EQUAL(start, span.start, L\"start\");\r\n-            VERIFY_ARE_EQUAL(end, span.end, L\"end\");\r\n+            VERIFY_ARE_EQUAL(inclusiveStart, span.start, L\"start\");\r\n+\r\n+            const til::point exclusiveEnd{ inclusiveEnd.x + 1, inclusiveEnd.y };\r\n+            VERIFY_ARE_EQUAL(exclusiveEnd, span.end, L\"end\");\r\n         }\r\n     }\r\n \r\ndiff --git a/src/host/ut_host/TextBufferTests.cpp b/src/host/ut_host/TextBufferTests.cpp\nindex 2d6c1d1628e..4252609e30f 100644\n--- a/src/host/ut_host/TextBufferTests.cpp\n+++ b/src/host/ut_host/TextBufferTests.cpp\n@@ -2432,11 +2432,11 @@ void TextBufferTests::GetTextRects()\n     std::vector<til::inclusive_rect> expected{};\r\n     if (blockSelection)\r\n     {\r\n-        expected.push_back({ 1, 0, 7, 0 });\r\n-        expected.push_back({ 1, 1, 8, 1 }); // expand right\r\n-        expected.push_back({ 1, 2, 7, 2 });\r\n-        expected.push_back({ 0, 3, 7, 3 }); // expand left\r\n-        expected.push_back({ 1, 4, 7, 4 });\r\n+        expected.push_back({ 1, 0, 8, 0 });\r\n+        expected.push_back({ 1, 1, 9, 1 }); // expand right\r\n+        expected.push_back({ 1, 2, 8, 2 });\r\n+        expected.push_back({ 0, 3, 8, 3 }); // do not expand\r\n+        expected.push_back({ 1, 4, 8, 4 });\r\n     }\r\n     else\r\n     {\r\n@@ -2444,11 +2444,11 @@ void TextBufferTests::GetTextRects()\n         expected.push_back({ 0, 1, 19, 1 });\r\n         expected.push_back({ 0, 2, 19, 2 });\r\n         expected.push_back({ 0, 3, 19, 3 });\r\n-        expected.push_back({ 0, 4, 7, 4 });\r\n+        expected.push_back({ 0, 4, 8, 4 });\r\n     }\r\n \r\n     til::point start{ 1, 0 };\r\n-    til::point end{ 7, 4 };\r\n+    til::point end{ 8, 4 };\r\n     const auto result = _buffer->GetTextRects(start, end, blockSelection, false);\r\n     VERIFY_ARE_EQUAL(expected.size(), result.size());\r\n     for (size_t i = 0; i < expected.size(); ++i)\r\n@@ -2494,8 +2494,9 @@ void TextBufferTests::GetPlainText()\n                                                        L\"  3  \" };\r\n         WriteLinesToBuffer(bufferText, *_buffer);\r\n \r\n-        // simulate a selection from origin to {4,4}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 4 } };\r\n+        // simulate a selection from origin to {5,4}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 4 } };\r\n \r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, false };\r\n         const auto result = _buffer->GetPlainText(req);\r\n@@ -2589,8 +2590,9 @@ void TextBufferTests::GetPlainText()\n         // |     |\r\n         // |_____|\r\n \r\n-        // simulate a selection from origin to {4,5}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 5 } };\r\n+        // simulate a selection from origin to {5,5}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 5 } };\r\n \r\n         const auto formatWrappedRows = blockSelection;\r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, formatWrappedRows };\r\ndiff --git a/src/inc/til/point.h b/src/inc/til/point.h\nindex 17bc9d1c861..95eed691671 100644\n--- a/src/inc/til/point.h\n+++ b/src/inc/til/point.h\n@@ -322,6 +322,42 @@ namespace til // Terminal Implementation Library. Also: \"Today I Learned\"\n                 func(y, x1, x2);\r\n             }\r\n         }\r\n+\r\n+        // Similar to iterate_rows above, but the \"end\" point is exclusive\r\n+        // and RightExclusive (aka \"width\") is an allowable coordinate\r\n+        constexpr void iterate_rows_exclusive(til::CoordType width, auto&& func) const\r\n+        {\r\n+            // Copy the members so that the compiler knows it doesn't\r\n+            // need to re-read them on every loop iteration.\r\n+            const auto w = width;\r\n+            auto ax = std::clamp(start.x, 0, w);\r\n+            auto ay = start.y;\r\n+            auto bx = std::clamp(end.x, 0, w);\r\n+            auto by = end.y;\r\n+\r\n+            // if start is at RightExclusive,\r\n+            // treat it as (0, y+1) (left-most point on next line)\r\n+            if (ax == w)\r\n+            {\r\n+                ay++;\r\n+                ax = 0;\r\n+            }\r\n+\r\n+            // if end is on left boundary,\r\n+            // treat it as (w, y-1) (RightExclusive on previous line)\r\n+            if (bx == 0)\r\n+            {\r\n+                by--;\r\n+                bx = w;\r\n+            }\r\n+\r\n+            for (auto y = ay; y <= by; ++y)\r\n+            {\r\n+                const auto x1 = y != ay ? 0 : ax;\r\n+                const auto x2 = y != by ? w : bx;\r\n+                func(y, x1, x2);\r\n+            }\r\n+        }\r\n     };\r\n }\r\n \r\ndiff --git a/src/renderer/atlas/AtlasEngine.api.cpp b/src/renderer/atlas/AtlasEngine.api.cpp\nindex a80ae930ba9..10cf2e3a405 100644\n--- a/src/renderer/atlas/AtlasEngine.api.cpp\n+++ b/src/renderer/atlas/AtlasEngine.api.cpp\n@@ -89,11 +89,11 @@ void AtlasEngine::_invalidateSpans(std::span<const til::point_span> spans, const\n     const auto viewport = til::rect{ 0, 0, _api.s->viewportCellCount.x, _api.s->viewportCellCount.y };\r\n     for (auto&& sp : spans)\r\n     {\r\n-        sp.iterate_rows(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n+        sp.iterate_rows_exclusive(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n             const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n             beg <<= shift;\r\n             end <<= shift;\r\n-            til::rect rect{ beg, row, end + 1, row + 1 };\r\n+            til::rect rect{ beg, row, end, row + 1 };\r\n             rect = rect.to_origin(viewportOrigin);\r\n             rect &= viewport;\r\n             _api.invalidatedRows.start = gsl::narrow_cast<u16>(std::min<int>(_api.invalidatedRows.start, std::max<int>(0, rect.top)));\r\ndiff --git a/src/renderer/atlas/AtlasEngine.cpp b/src/renderer/atlas/AtlasEngine.cpp\nindex 0de92b62373..90b9083b5d3 100644\n--- a/src/renderer/atlas/AtlasEngine.cpp\n+++ b/src/renderer/atlas/AtlasEngine.cpp\n@@ -427,13 +427,13 @@ try\n     if (y > hiStart.y)\r\n     {\r\n         const auto isFinalRow = y == hiEnd.y;\r\n-        const auto end = isFinalRow ? std::min(hiEnd.x + 1, x2) : x2;\r\n+        const auto end = isFinalRow ? std::min(hiEnd.x, x2) : x2;\r\n         _fillColorBitmap(row, x1, end, fgColor, bgColor);\r\n \r\n         // Return early if we couldn't paint the whole region (either this was not the last row, or\r\n         // it was the last row but the highlight ends outside of our x range.)\r\n         // We will resume from here in the next call.\r\n-        if (!isFinalRow || hiEnd.x /*inclusive*/ >= x2 /*exclusive*/)\r\n+        if (!isFinalRow || hiEnd.x > x2)\r\n         {\r\n             return S_OK;\r\n         }\r\n@@ -448,10 +448,10 @@ try\n         hiEnd = it->end - offset;\r\n \r\n         const auto isStartInside = y == hiStart.y && hiStart.x < x2;\r\n-        const auto isEndInside = y == hiEnd.y && hiEnd.x < x2;\r\n+        const auto isEndInside = y == hiEnd.y && hiEnd.x <= x2;\r\n         if (isStartInside && isEndInside)\r\n         {\r\n-            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x) + 1, fgColor, bgColor);\r\n+            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x), fgColor, bgColor);\r\n             ++it;\r\n         }\r\n         else\r\ndiff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex c44216ac470..31ab5a410e3 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -342,9 +342,8 @@ try\n             const til::rect vp{ _viewport.ToExclusive() };\r\n             for (auto&& sp : spans)\r\n             {\r\n-                sp.iterate_rows(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n+                sp.iterate_rows_exclusive(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n                     const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n-                    max += 1; // Selection spans are inclusive (still)\r\n                     min <<= shift;\r\n                     max <<= shift;\r\n                     til::rect r{ min, row, max, row + 1 };\r\ndiff --git a/src/types/TermControlUiaProvider.cpp b/src/types/TermControlUiaProvider.cpp\nindex 34bd94f9404..3e4091bd963 100644\n--- a/src/types/TermControlUiaProvider.cpp\n+++ b/src/types/TermControlUiaProvider.cpp\n@@ -157,14 +157,8 @@ HRESULT TermControlUiaProvider::GetSelectionRange(_In_ IRawElementProviderSimple\n     RETURN_HR_IF_NULL(E_INVALIDARG, ppUtr);\r\n     *ppUtr = nullptr;\r\n \r\n-    const auto start = _pData->GetSelectionAnchor();\r\n-\r\n-    // we need to make end exclusive\r\n-    auto end = _pData->GetSelectionEnd();\r\n-    _pData->GetTextBuffer().GetSize().IncrementInBounds(end, true);\r\n-\r\n     TermControlUiaTextRange* result = nullptr;\r\n-    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, start, end, _pData->IsBlockSelection(), wordDelimiters));\r\n+    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, _pData->GetSelectionAnchor(), _pData->GetSelectionEnd(), _pData->IsBlockSelection(), wordDelimiters));\r\n     *ppUtr = result;\r\n     return S_OK;\r\n }\r\ndiff --git a/src/types/UiaTextRangeBase.cpp b/src/types/UiaTextRangeBase.cpp\nindex 0ce958e6985..9b3d7040a5e 100644\n--- a/src/types/UiaTextRangeBase.cpp\n+++ b/src/types/UiaTextRangeBase.cpp\n@@ -972,7 +972,7 @@ CATCH_RETURN();\n // Return Value:\r\n // - the text that the UiaTextRange encompasses\r\n #pragma warning(push)\r\n-#pragma warning(disable : 26447) // compiler isn't filtering throws inside the try/catch\r\n+#pragma warning(disable : 26440) // The function ... can be declared as noexcept.\r\n std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\r\n {\r\n     std::wstring textData{};\r\n@@ -987,13 +987,12 @@ std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\n \r\n         // TODO GH#5406: create a different UIA parent object for each TextBuffer\r\n         // nvaccess/nvda#11428: Ensure our endpoints are in bounds\r\n-        THROW_HR_IF(E_FAIL, !bufferSize.IsInBounds(_start, true) || !bufferSize.IsInBounds(_end, true));\r\n+        auto isValid = [&](const til::point& point) {\r\n+            return bufferSize.IsInExclusiveBounds(point) || point == bufferSize.EndExclusive();\r\n+        };\r\n+        THROW_HR_IF(E_FAIL, !isValid(_start) || !isValid(_end));\r\n \r\n-        // convert _end to be inclusive\r\n-        auto inclusiveEnd = _end;\r\n-        bufferSize.DecrementInBounds(inclusiveEnd, true);\r\n-\r\n-        const auto req = TextBuffer::CopyRequest{ buffer, _start, inclusiveEnd, _blockRange, true, false, false, true };\r\n+        const auto req = TextBuffer::CopyRequest{ buffer, _start, _end, _blockRange, true, false, false, true };\r\n         auto plainText = buffer.GetPlainText(req);\r\n \r\n         if (plainText.size() > maxLengthAsSize)\r\ndiff --git a/src/types/inc/viewport.hpp b/src/types/inc/viewport.hpp\nindex fd0d5b302f8..0f1ea0bdeb8 100644\n--- a/src/types/inc/viewport.hpp\n+++ b/src/types/inc/viewport.hpp\n@@ -41,20 +41,26 @@ namespace Microsoft::Console::Types\n         til::point Origin() const noexcept;\r\n         til::point BottomRightInclusive() const noexcept;\r\n         til::point BottomRightExclusive() const noexcept;\r\n+        til::point BottomInclusiveRightExclusive() const noexcept;\r\n         til::point EndExclusive() const noexcept;\r\n         til::size Dimensions() const noexcept;\r\n \r\n         bool IsInBounds(const Viewport& other) const noexcept;\r\n         bool IsInBounds(const til::point pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IsInExclusiveBounds(const til::point pos) const noexcept;\r\n \r\n         void Clamp(til::point& pos) const;\r\n         Viewport Clamp(const Viewport& other) const noexcept;\r\n \r\n         bool IncrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n         bool DecrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IncrementInExclusiveBounds(til::point& pos) const noexcept;\r\n+        bool DecrementInExclusiveBounds(til::point& pos) const noexcept;\r\n         int CompareInBounds(const til::point first, const til::point second, bool allowEndExclusive = false) const noexcept;\r\n+        int CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept;\r\n \r\n         bool WalkInBounds(til::point& pos, const til::CoordType delta, bool allowEndExclusive = false) const noexcept;\r\n+        bool WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept;\r\n         til::point GetWalkOrigin(const til::CoordType delta) const noexcept;\r\n         static til::CoordType DetermineWalkDirection(const Viewport& source, const Viewport& target) noexcept;\r\n \r\ndiff --git a/src/types/viewport.cpp b/src/types/viewport.cpp\nindex 30c5307dd14..ce4b38565eb 100644\n--- a/src/types/viewport.cpp\n+++ b/src/types/viewport.cpp\n@@ -118,6 +118,11 @@ til::point Viewport::BottomRightExclusive() const noexcept\n     return { RightExclusive(), BottomExclusive() };\r\n }\r\n \r\n+til::point Viewport::BottomInclusiveRightExclusive() const noexcept\r\n+{\r\n+    return { RightExclusive(), BottomInclusive() };\r\n+}\r\n+\r\n // Method Description:\r\n // - For Accessibility, get a til::point representing the end of this viewport in exclusive terms.\r\n // - This is needed to represent an exclusive endpoint in UiaTextRange that includes the last\r\n@@ -295,6 +300,61 @@ bool Viewport::WalkInBounds(til::point& pos, const til::CoordType delta, bool al\n     return off == offClamped;\r\n }\r\n \r\n+bool Viewport::IncrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, 1);\r\n+}\r\n+\r\n+bool Viewport::DecrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, -1);\r\n+}\r\n+\r\n+bool Viewport::IsInExclusiveBounds(const til::point pos) const noexcept\r\n+{\r\n+    return pos.x >= Left() && pos.x <= RightExclusive() &&\r\n+           pos.y >= Top() && pos.y <= BottomInclusive();\r\n+}\r\n+\r\n+int Viewport::CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept\r\n+{\r\n+    // Assert that our coordinates are within the expected boundaries\r\n+    assert(IsInExclusiveBounds(first));\r\n+    assert(IsInExclusiveBounds(second));\r\n+\r\n+    // First set the distance vertically\r\n+    //   If first is on row 4 and second is on row 6, first will be -2 rows behind second * an 80 character row would be -160.\r\n+    //   For the same row, it'll be 0 rows * 80 character width = 0 difference.\r\n+    auto retVal = (first.y - second.y) * Width();\r\n+\r\n+    // Now adjust for horizontal differences\r\n+    //   If first is in position 15 and second is in position 30, first is -15 left in relation to 30.\r\n+    retVal += (first.x - second.x);\r\n+\r\n+    // Further notes:\r\n+    //   If we already moved behind one row, this will help correct for when first is right of second.\r\n+    //     For example, with row 4, col 79 and row 5, col 0 as first and second respectively, the distance is -1.\r\n+    //     Assume the row width is 80.\r\n+    //     Step one will set the retVal as -80 as first is one row behind the second.\r\n+    //     Step two will then see that first is 79 - 0 = +79 right of second and add 79\r\n+    //     The total is -80 + 79 = -1.\r\n+    return retVal;\r\n+}\r\n+\r\n+bool Viewport::WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept\r\n+{\r\n+    const auto l = static_cast<ptrdiff_t>(_sr.left);\r\n+    const auto t = static_cast<ptrdiff_t>(_sr.top);\r\n+    const auto w = static_cast<ptrdiff_t>(std::max(0, _sr.right - _sr.left + 2));\r\n+    const auto h = static_cast<ptrdiff_t>(std::max(0, _sr.bottom - _sr.top + 1));\r\n+    const auto max = w * h;\r\n+    const auto off = w * (pos.y - t) + (pos.x - l) + delta;\r\n+    const auto offClamped = std::clamp(off, ptrdiff_t{ 0 }, max);\r\n+    pos.x = gsl::narrow_cast<til::CoordType>(offClamped % w + l);\r\n+    pos.y = gsl::narrow_cast<til::CoordType>(offClamped / w + t);\r\n+    return off == offClamped;\r\n+}\r\n+\r\n // Routine Description:\r\n // - If walking through a viewport, one might want to know the origin\r\n //   for the direction walking.\r\n", "test_patch": "", "problem_statement": "[Windows Terminal]: Screen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\n### Windows Terminal version\r\n\r\n1.22.2362.0\r\n\r\n### Windows build number\r\n\r\n27695.1000\r\n\r\n### Other Software\r\n\r\nTest Environment:\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\n\r\n### Steps to reproduce\r\n\r\n**Repro steps :**\r\n1.Open Windows Terminal.\r\n2.Navigate to the editor.\r\n3.Turn on Narrator by pressing 'Ctrl + Windows + Enter' keys.\r\n4.Now turn on mark mode by pressing 'Ctrl + Shift + M' keys.\r\n5. Now navigate among words using 'Ctrl + Left/Right' keys.\r\n6.Observe the screen reader narration here.\r\n\r\n**Observation using NVDA and JAWS screen reader:**\r\nSame issue repro with NVDA and JAWS screen reader also.\r\n\r\n**User Experience**\r\nUsers who rely on screen reader may not get the info properly while navigating in mark mode.\r\n \r\n **WCAG Reference Link:**\r\n https://www.w3.org/WAI/WCAG21/Understanding/info-and-relationships\r\n \r\n**Attachment :**\r\n[Screen reader is not announcing full word information while navigating via ctrl + left_right arrow keys.zip](https://github.com/user-attachments/files/16943981/Screen.reader.is.not.announcing.full.word.information.while.navigating.via.ctrl.%2B.left_right.arrow.keys.zip)\r\n\r\n\r\n### Expected Behavior\r\n\r\nScreen reader should narrate complete word information while navigating using ctrl + left/right arrow keys in mark mode.\r\n\r\n### Actual Behavior\r\n\r\nScreen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\r\nFor example:\r\nFor word \"Microsoft\", screen reader is just announcing as 'M selected' when we navigate using 'Ctrl + Left' arrow key and announces as 't selected' using 'Ctrl + Right' arrow.\n", "hints_text": "This is by design. Pressing Ctrl+Left/Right moves you to the previous/next word respectively. You're just moving the cursor around, which is why the resulting announcement by the screen reader is what is selected (in the case above, \"M\"). If you want to expand the selection instead of just moving the cursor, you'll need to hold the Shift key.\r\n\r\nClosing as by design.\nBut should we perhaps narrate an entire word when the cursor position moves by more than 1 cell? That's what seems to happen when using Word at least. I'm not entirely sure how to implement this though.\n@carlos-zamora,\r\nThis issue is logged from the feedback of Adam Samec. As mentioned in the mail we should be able to navigate among the words using 'Ctrl + Left/Right' arrow keys.\r\nScreen reader is just narrating as selected with single character information instead of narrating the complete word information.\nI see. Ok, reopening.\r\n\r\nRelated issues:\r\n- #13447 \r\n- #15787\r\n\r\nI suspect that fixing both of those issues may fix this one inadvertently. Totally based on a hunch, but I wonder if screen readers behave differently when the cursor moves as a degenerate range (like, maybe they automatically read out the current word since there's no selected text).\r\n\r\nTried looking at Word under accevent but all I got was TextSelectionChanged events, which means that the screen reader has special logic to handle that (pretty standard) then calls the UIA APIs off of the text provider.", "created_at": "2024-10-23 20:19:57", "merge_commit_sha": "64d4fbab17f181c19b502d3170f36f8e16c594b1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18095", "base_commit": "b2524f9db4f8664a70e0d8b2e963f21d7b3ced67", "patch": "diff --git a/policies/WindowsTerminal.admx b/policies/WindowsTerminal.admx\nindex 48c36aec7eb..ccda3e0ffd7 100644\n--- a/policies/WindowsTerminal.admx\n+++ b/policies/WindowsTerminal.admx\n@@ -9,6 +9,7 @@\n   <supportedOn>\r\n     <definitions>\r\n       <definition name=\"SUPPORTED_WindowsTerminal_1_21\" displayName=\"$(string.SUPPORTED_WindowsTerminal_1_21)\" />\r\n+      <definition name=\"SUPPORTED_WindowsTerminalCanary_1_23\" displayName=\"$(string.SUPPORTED_WindowsTerminalCanary_1_23)\" />\r\n     </definitions>\r\n   </supportedOn>\r\n   <categories>\r\n@@ -24,5 +25,12 @@\n         <multiText id=\"DisabledProfileSources\" valueName=\"DisabledProfileSources\" required=\"true\" />\r\n       </elements>\r\n     </policy>\r\n+    <policy name=\"EnabledLMProviders\" class=\"Both\" displayName=\"$(string.EnabledLMProviders)\" explainText=\"$(string.EnabledLMProvidersText)\" presentation=\"$(presentation.EnabledLMProviders)\" key=\"Software\\Policies\\Microsoft\\Windows Terminal\">\r\n+      <parentCategory ref=\"WindowsTerminal\" />\r\n+      <supportedOn ref=\"SUPPORTED_WindowsTerminalCanary_1_23\" />\r\n+      <elements>\r\n+        <multiText id=\"EnabledLMProviders\" valueName=\"EnabledLMProviders\" required=\"false\" />\r\n+      </elements>\r\n+    </policy>\r\n   </policies>\r\n </policyDefinitions>\r\ndiff --git a/policies/en-US/WindowsTerminal.adml b/policies/en-US/WindowsTerminal.adml\nindex 5516292e123..089b4bdd7e2 100644\n--- a/policies/en-US/WindowsTerminal.adml\n+++ b/policies/en-US/WindowsTerminal.adml\n@@ -7,6 +7,7 @@\n     <stringTable>\r\n       <string id=\"WindowsTerminal\">Windows Terminal</string>\r\n       <string id=\"SUPPORTED_WindowsTerminal_1_21\">At least Windows Terminal 1.21</string>\r\n+      <string id=\"SUPPORTED_WindowsTerminalCanary_1_23\">At least Windows Terminal Canary 1.23</string>\r\n       <string id=\"DisabledProfileSources\">Disabled Profile Sources</string>\r\n       <string id=\"DisabledProfileSourcesText\">Profiles will not be generated from any sources listed here. Source names can be arbitrary strings. Potential candidates can be found as the \"source\" property on profile definitions in Windows Terminal's settings.json file.\r\n \r\n@@ -18,11 +19,25 @@ Common sources are:\n For instance, setting this policy to Windows.Terminal.Wsl will disable the builtin WSL integration of Windows Terminal.\r\n \r\n Note: Existing profiles will disappear from Windows Terminal after adding their source to this policy.</string>\r\n+      <string id=\"EnabledLMProviders\">Enabled Language Model/AI Providers</string>\r\n+      <string id=\"EnabledLMProvidersText\">The listed Language Models/AI Providers will be available for use in Terminal Chat.\r\n+\r\n+Enabling the policy but leaving the list empty disallows all providers and therefore disables the Terminal Chat feature completely.\r\n+\r\n+Common providers are:\r\n+- AzureOpenAI\r\n+- OpenAI\r\n+- GitHubCopilot\r\n+\r\n+For instance, setting this policy to GitHubCopilot will allow the use of GitHubCopilot in Terminal Chat.</string>\r\n     </stringTable>\r\n     <presentationTable>\r\n       <presentation id=\"DisabledProfileSources\">\r\n         <multiTextBox refId=\"DisabledProfileSources\">List of disabled sources (one per line)</multiTextBox>\r\n       </presentation>\r\n+      <presentation id=\"EnabledLMProviders\">\r\n+        <multiTextBox refId=\"EnabledLMProviders\">List of enabled Language Model/AI Providers (one per line)</multiTextBox>\r\n+      </presentation>\r\n     </presentationTable>\r\n   </resources>\r\n </policyDefinitionResources>\r\ndiff --git a/src/cascadia/QueryExtension/ExtensionPalette.cpp b/src/cascadia/QueryExtension/ExtensionPalette.cpp\nindex 29fec0e9c0d..9606a96d1ea 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.cpp\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.cpp\n@@ -99,16 +99,16 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n         _lmProvider = lmProvider;\n         _clearAndInitializeMessages(nullptr, nullptr);\n \n-        const auto brandingData = _lmProvider.BrandingData();\n-        const auto headerIconPath = brandingData.HeaderIconPath().empty() ? terminalChatLogoPath : brandingData.HeaderIconPath();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n+        const auto headerIconPath = (!brandingData || brandingData.HeaderIconPath().empty()) ? terminalChatLogoPath : brandingData.HeaderIconPath();\n         Windows::Foundation::Uri headerImageSourceUri{ headerIconPath };\n         Media::Imaging::BitmapImage headerImageSource{ headerImageSourceUri };\n         HeaderIcon().Source(headerImageSource);\n \n-        const auto headerText = brandingData.HeaderText().empty() ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n+        const auto headerText = (!brandingData || brandingData.HeaderText().empty()) ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n         QueryIntro().Text(headerText);\n \n-        const auto subheaderText = brandingData.SubheaderText().empty() ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n+        const auto subheaderText = (!brandingData || brandingData.SubheaderText().empty()) ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n         TitleSubheader().Text(subheaderText);\n     }\n \n@@ -234,9 +234,9 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n             }\n         }\n \n-        const auto brandingData = _lmProvider.BrandingData();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n         const auto responseAttribution = response.ResponseAttribution().empty() ? _ProfileName : response.ResponseAttribution();\n-        const auto badgeUriPath = _lmProvider ? brandingData.BadgeIconPath() : winrt::hstring{};\n+        const auto badgeUriPath = brandingData ? brandingData.BadgeIconPath() : L\"\";\n         const auto responseGroupedMessages = winrt::make<GroupedChatMessages>(time, false, winrt::single_threaded_vector(std::move(messageParts)), responseAttribution, badgeUriPath);\n         _messages.Append(responseGroupedMessages);\n \ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 36a2b20b5bf..1aeb8cb013e 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -662,18 +662,23 @@ namespace winrt::TerminalApp::implementation\n     void TerminalPage::_HandleToggleAIChat(const IInspectable& /*sender*/,\r\n                                            const ActionEventArgs& args)\r\n     {\r\n-        if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n-        {\r\n-            _loadQueryExtension();\r\n-            ExtensionPresenter().Visibility(Visibility::Visible);\r\n-            _extensionPalette.Visibility(Visibility::Visible);\r\n-        }\r\n-        else\r\n+        args.Handled(false);\r\n+        // only handle this if the feature is allowed\r\n+        if (WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All))\r\n         {\r\n-            _extensionPalette.Visibility(Visibility::Collapsed);\r\n-            ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n+            {\r\n+                _loadQueryExtension();\r\n+                ExtensionPresenter().Visibility(Visibility::Visible);\r\n+                _extensionPalette.Visibility(Visibility::Visible);\r\n+            }\r\n+            else\r\n+            {\r\n+                _extensionPalette.Visibility(Visibility::Collapsed);\r\n+                ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            }\r\n+            args.Handled(true);\r\n         }\r\n-        args.Handled(true);\r\n     }\r\n \r\n     void TerminalPage::_HandleSetColorScheme(const IInspectable& /*sender*/,\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex f17d32cdea5..fbb1d62c829 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,58 +989,61 @@ namespace winrt::TerminalApp::implementation\n                 _SetAcceleratorForMenuItem(commandPaletteFlyout, commandPaletteKeyChord);\n             }\n \n-            // Create the AI chat button.\n-            auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n-            AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n-            const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n-\n-            WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n-            Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n-\n-            // BODGY\n-            // Manually load this icon from an SVG path; it is ironically much more humane this way.\n-            // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n-            // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n-            {\n-                static constexpr wil::zwstring_view pathSVG{\n-                    L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n-                    \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n-                    \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n-                    \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n-                    \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n-                    \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n-                    \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n-                    \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n-                    \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n-                    \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n-                    \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n-                    \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n-                    \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n-                    \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n-                    \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n-                    \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n-                    \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n-                    \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n-                    \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n-                };\n-                try\n+            // Create the AI chat button if AI features are allowed\n+            if (WI_IsAnyFlagSet(_settings.GlobalSettings().AIInfo().AllowedLMProviders(), EnabledLMProviders::All))\n+            {\n+                auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n+                AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n+                const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n+\n+                WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n+                Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n+\n+                // BODGY\n+                // Manually load this icon from an SVG path; it is ironically much more humane this way.\n+                // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n+                // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n                 {\n-                    hstring hsPathSVG{ pathSVG };\n-                    auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n-                    WUX::Controls::PathIcon pathIcon;\n-                    pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n-                    AIChatFlyout.Icon(pathIcon);\n+                    static constexpr wil::zwstring_view pathSVG{\n+                        L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n+                        \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n+                        \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n+                        \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n+                        \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n+                        \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n+                        \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n+                        \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n+                        \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n+                        \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n+                        \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n+                        \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n+                        \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n+                        \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n+                        \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n+                        \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n+                        \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n+                        \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n+                        \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n+                    };\n+                    try\n+                    {\n+                        hstring hsPathSVG{ pathSVG };\n+                        auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n+                        WUX::Controls::PathIcon pathIcon;\n+                        pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n+                        AIChatFlyout.Icon(pathIcon);\n+                    }\n+                    CATCH_LOG();\n                 }\n-                CATCH_LOG();\n-            }\n \n-            AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n-            newTabFlyout.Items().Append(AIChatFlyout);\n+                AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n+                newTabFlyout.Items().Append(AIChatFlyout);\n \n-            const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n-            if (AIChatKeyChord)\n-            {\n-                _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n+                if (AIChatKeyChord)\n+                {\n+                    _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                }\n             }\n \n             // Create the about button.\n@@ -5755,31 +5758,34 @@ namespace winrt::TerminalApp::implementation\n             }\n         }\n \n-        // we now have a provider of the correct type, update that\n-        winrt::hstring newAuthValues = authValuesString;\n-        if (newAuthValues.empty())\n+        if (_lmProvider)\n         {\n-            Windows::Data::Json::JsonObject authValuesJson;\n-            const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n-            switch (providerType)\n+            // we now have a provider of the correct type, update that\n+            winrt::hstring newAuthValues = authValuesString;\n+            if (newAuthValues.empty())\n             {\n-            case LLMProvider::AzureOpenAI:\n-                authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::OpenAI:\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::GithubCopilot:\n-                newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n-                break;\n-            default:\n-                break;\n+                Windows::Data::Json::JsonObject authValuesJson;\n+                const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n+                switch (providerType)\n+                {\n+                case LLMProvider::AzureOpenAI:\n+                    authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::OpenAI:\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::GithubCopilot:\n+                    newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n+                    break;\n+                default:\n+                    break;\n+                }\n             }\n+            _lmProvider.SetAuthentication(newAuthValues);\n         }\n-        _lmProvider.SetAuthentication(newAuthValues);\n \n         if (_extensionPalette)\n         {\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettings.xaml b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\nindex 676071a0930..c99020d6b97 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n@@ -40,8 +40,9 @@\n                            Style=\"{StaticResource TextBlockSubHeaderStyle}\" />\r\n                 <!--  GitHub Copilot  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_GithubCopilot\"\r\n-                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\"\r\n-                                        Visibility=\"{x:Bind ViewModel.GithubCopilotFeatureEnabled}\">\r\n+                                        CurrentValue=\"{x:Bind ViewModel.GithubCopilotStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.GithubCopilotAllowed}\"\r\n+                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreGithubCopilotTokensSet, Mode=OneWay}\">\r\n                             <Grid.ColumnDefinitions>\r\n@@ -137,6 +138,8 @@\n                 </local:SettingContainer>\r\n                 <!--  Azure OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_AzureOpenAIKeyAndEndpoint\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.AzureOpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.AzureOpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreAzureOpenAIKeyAndEndpointSet, Mode=OneWay}\">\r\n@@ -261,6 +264,8 @@\n                 </local:SettingContainer>\r\n                 <!--  OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_OpenAIKey\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.OpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.OpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.IsOpenAIKeySet, Mode=OneWay}\">\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\nindex 85ac83dc138..9a7df4b771c 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n@@ -17,6 +17,8 @@ using namespace winrt::Windows::UI::Xaml::Controls;\n using namespace winrt::Microsoft::Terminal::Settings::Model;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static constexpr std::wstring_view lockGlyph{ L\"\\uE72E\" };\r\n+\r\n namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\r\n {\r\n     AISettingsViewModel::AISettingsViewModel(Model::CascadiaSettings settings) :\r\n@@ -38,7 +40,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIEndpoint(winrt::hstring endpoint)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIEndpoint(endpoint);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n     }\r\n \r\n     winrt::hstring AISettingsViewModel::AzureOpenAIKey()\r\n@@ -49,7 +51,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIKey(key);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::AzureOpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::AzureOpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::AzureOpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::AzureOpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsOpenAIKeySet()\r\n@@ -65,7 +77,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::OpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().OpenAIKey(key);\r\n-        _NotifyChanges(L\"IsOpenAIKeySet\");\r\n+        _NotifyChanges(L\"IsOpenAIKeySet\", L\"OpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::OpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::OpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::OpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::OpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::AzureOpenAIActive()\r\n@@ -78,8 +100,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::AzureOpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::OpenAIActive()\r\n@@ -92,8 +118,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::OpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::AreGithubCopilotTokensSet()\r\n@@ -109,7 +139,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::GithubCopilotAuthValues(winrt::hstring authValues)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().GithubCopilotAuthValues(authValues);\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::GithubCopilotActive()\r\n@@ -122,13 +152,22 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::GithubCopilot);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n-    bool AISettingsViewModel::GithubCopilotFeatureEnabled()\r\n+    bool AISettingsViewModel::GithubCopilotAllowed() const noexcept\r\n     {\r\n-        return Feature_GithubCopilot::IsEnabled();\r\n+        return Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::GithubCopilot);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::GithubCopilotStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::GithubCopilot);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsTerminalPackaged()\r\n@@ -152,6 +191,55 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::_OnGithubAuthCompleted(const winrt::hstring& message)\r\n     {\r\n         _githubCopilotAuthMessage = message;\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\", L\"GithubCopilotStatus\");\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::_getStatusHelper(const Model::LLMProvider provider)\r\n+    {\r\n+        bool allowed;\r\n+        bool active;\r\n+        bool loggedIn;\r\n+        switch (provider)\r\n+        {\r\n+        case LLMProvider::AzureOpenAI:\r\n+            allowed = AzureOpenAIAllowed();\r\n+            active = AzureOpenAIActive();\r\n+            loggedIn = AreAzureOpenAIKeyAndEndpointSet();\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            allowed = OpenAIAllowed();\r\n+            active = OpenAIActive();\r\n+            loggedIn = IsOpenAIKeySet();\r\n+            break;\r\n+        case LLMProvider::GithubCopilot:\r\n+            allowed = GithubCopilotAllowed();\r\n+            active = GithubCopilotActive();\r\n+            loggedIn = AreGithubCopilotTokensSet();\r\n+            break;\r\n+        default:\r\n+            return L\"\";\r\n+        }\r\n+\r\n+        if (!allowed)\r\n+        {\r\n+            // not allowed, display the lock glyph\r\n+            return winrt::hstring{ lockGlyph } + L\" \" + RS_(L\"AISettings_ProviderNotAllowed\");\r\n+        }\r\n+        else if (active && loggedIn)\r\n+        {\r\n+            // active provider and logged in\r\n+            return RS_(L\"AISettings_ActiveLoggedIn\");\r\n+        }\r\n+        else if (active)\r\n+        {\r\n+            // active provider, not logged in\r\n+            return RS_(L\"AISettings_Active\");\r\n+        }\r\n+        else if (loggedIn)\r\n+        {\r\n+            // logged in, not active provider\r\n+            return RS_(L\"AISettings_LoggedIn\");\r\n+        }\r\n+        return L\"\";\r\n     }\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\nindex 41e8e7379b5..a0822dc65a3 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n@@ -24,27 +24,34 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         void AzureOpenAIKey(winrt::hstring key);\r\n         bool AzureOpenAIActive();\r\n         void AzureOpenAIActive(bool active);\r\n+        bool AzureOpenAIAllowed() const noexcept;\r\n+        winrt::hstring AzureOpenAIStatus();\r\n \r\n         bool IsOpenAIKeySet();\r\n         winrt::hstring OpenAIKey();\r\n         void OpenAIKey(winrt::hstring key);\r\n         bool OpenAIActive();\r\n         void OpenAIActive(bool active);\r\n+        bool OpenAIAllowed() const noexcept;\r\n+        winrt::hstring OpenAIStatus();\r\n \r\n         bool AreGithubCopilotTokensSet();\r\n         winrt::hstring GithubCopilotAuthMessage();\r\n         void GithubCopilotAuthValues(winrt::hstring authValues);\r\n         bool GithubCopilotActive();\r\n         void GithubCopilotActive(bool active);\r\n-        bool GithubCopilotFeatureEnabled();\r\n+        bool GithubCopilotAllowed() const noexcept;\r\n         bool IsTerminalPackaged();\r\n         void InitiateGithubAuth_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& e);\r\n         til::typed_event<Windows::Foundation::IInspectable, Windows::Foundation::IInspectable> GithubAuthRequested;\r\n+        winrt::hstring GithubCopilotStatus();\r\n \r\n     private:\r\n         Model::CascadiaSettings _Settings;\r\n         winrt::hstring _githubCopilotAuthMessage;\r\n \r\n+        winrt::hstring _getStatusHelper(const winrt::Microsoft::Terminal::Settings::Model::LLMProvider provider);\r\n+\r\n         winrt::Microsoft::Terminal::Settings::Editor::MainPage::GithubAuthCompleted_revoker _githubAuthCompleteRevoker;\r\n \r\n         void _OnGithubAuthCompleted(const winrt::hstring& message);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\nindex 6a31438ae84..3844b549800 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n@@ -15,16 +15,21 @@ namespace Microsoft.Terminal.Settings.Editor\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         Boolean AzureOpenAIActive;\r\n+        Boolean AzureOpenAIAllowed { get; };\r\n+        String AzureOpenAIStatus { get; };\r\n \r\n         Boolean IsOpenAIKeySet { get; };\r\n         String OpenAIKey;\r\n         Boolean OpenAIActive;\r\n+        Boolean OpenAIAllowed { get; };\r\n+        String OpenAIStatus { get; };\r\n \r\n         Boolean AreGithubCopilotTokensSet { get; };\r\n         String GithubCopilotAuthMessage { get; };\r\n         void GithubCopilotAuthValues(String authValues);\r\n         Boolean GithubCopilotActive;\r\n-        Boolean GithubCopilotFeatureEnabled { get; };\r\n+        Boolean GithubCopilotAllowed { get; };\r\n+        String GithubCopilotStatus { get; };\r\n         Boolean IsTerminalPackaged { get; };\r\n \r\n         void InitiateGithubAuth_Click(IInspectable sender, Windows.UI.Xaml.RoutedEventArgs args);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex 61c71d8a176..1eb01d86b1e 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -792,6 +792,22 @@\n     <value>Awaiting authentication completion from browser...</value>\r\n     <comment>Text displayed after the user clicks the button to initiate the GitHub authentication flow in their browser.</comment>\r\n   </data>\r\n+  <data name=\"AISettings_Active\" xml:space=\"preserve\">\r\n+    <value>Active</value>\r\n+    <comment>Text displayed when the service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_LoggedIn\" xml:space=\"preserve\">\r\n+    <value>Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ActiveLoggedIn\" xml:space=\"preserve\">\r\n+    <value>Active, Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider and that service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ProviderNotAllowed\" xml:space=\"preserve\">\r\n+    <value>Disabled by your administrator</value>\r\n+    <comment>Text displayed when the service provider has been disabled by the administrator.</comment>\r\n+  </data>\r\n   <data name=\"AISettings_PortableModeDisclaimer.Text\" xml:space=\"preserve\">\r\n     <value>Unable to authenticate to GitHub in unpackaged mode. Please launch Terminal as a packaged application to authenticate.</value>\r\n     <comment>Text displayed to the user when Terminal is un unpackaged mode.</comment>\r\n@@ -2109,4 +2125,4 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+</root>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.cpp b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\nindex 7af8678a3b4..562592b05d0 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n@@ -19,6 +19,45 @@ static constexpr wil::zwstring_view PasswordVaultAIEndpoint = L\"TerminalAIEndpoi\n static constexpr wil::zwstring_view PasswordVaultOpenAIKey = L\"TerminalOpenAIKey\";\r\n static constexpr wil::zwstring_view PasswordVaultGithubCopilotAuthValues = L\"TerminalGithubCopilotAuthValues\";\r\n \r\n+// When new LM providers are added here, make sure you also update the admx/adml!\r\n+static constexpr wil::zwstring_view AzureOpenAIPolicyKey = L\"AzureOpenAI\";\r\n+static constexpr wil::zwstring_view OpenAIPolicyKey = L\"OpenAI\";\r\n+static constexpr wil::zwstring_view GitHubCopilotPolicyKey = L\"GitHubCopilot\";\r\n+\r\n+winrt::Microsoft::Terminal::Settings::Model::EnabledLMProviders AIConfig::AllowedLMProviders() noexcept\r\n+{\r\n+    Model::EnabledLMProviders enabledLMProviders{ Model::EnabledLMProviders::All };\r\n+    // get our allowed list of LM providers from the registry\r\n+    for (const auto key : { HKEY_LOCAL_MACHINE, HKEY_CURRENT_USER })\r\n+    {\r\n+        wchar_t buffer[512]; // \"640K ought to be enough for anyone\"\r\n+        DWORD bufferSize = sizeof(buffer);\r\n+        if (RegGetValueW(key, LR\"(Software\\Policies\\Microsoft\\Windows Terminal)\", L\"EnabledLMProviders\", RRF_RT_REG_MULTI_SZ, nullptr, buffer, &bufferSize) == 0)\r\n+        {\r\n+            WI_ClearAllFlags(enabledLMProviders, Model::EnabledLMProviders::All);\r\n+            for (auto p = buffer; *p;)\r\n+            {\r\n+                const std::wstring_view value{ p };\r\n+                if (value == AzureOpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::AzureOpenAI);\r\n+                }\r\n+                else if (value == OpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::OpenAI);\r\n+                }\r\n+                else if (value == GitHubCopilotPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::GithubCopilot);\r\n+                }\r\n+                p += value.size() + 1;\r\n+            }\r\n+            break;\r\n+        }\r\n+    }\r\n+    return enabledLMProviders;\r\n+}\r\n+\r\n winrt::com_ptr<AIConfig> AIConfig::CopyAIConfig(const AIConfig* source)\r\n {\r\n     auto aiConfig{ winrt::make_self<AIConfig>() };\r\n@@ -108,16 +147,36 @@ winrt::hstring AIConfig::GithubCopilotAuthValues()\n \r\n winrt::Microsoft::Terminal::Settings::Model::LLMProvider AIConfig::ActiveProvider()\r\n {\r\n+    const auto allowedLMProviders = AllowedLMProviders();\r\n     const auto val{ _getActiveProviderImpl() };\r\n     if (val)\r\n     {\r\n-        // an active provider was explicitly set, return that\r\n-        // special case: only allow github copilot if the feature is enabled\r\n-        if (*val == LLMProvider::GithubCopilot && !Feature_GithubCopilot::IsEnabled())\r\n+        const auto setProvider = *val;\r\n+        // an active provider was explicitly set, return that as long as it is allowed\r\n+        switch (setProvider)\r\n         {\r\n-            return LLMProvider{};\r\n+        case LLMProvider::GithubCopilot:\r\n+            if (Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::GithubCopilot))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::AzureOpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::AzureOpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::OpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        default:\r\n+            break;\r\n         }\r\n-        return *val;\r\n+        return LLMProvider{};\r\n     }\r\n     else if (!AzureOpenAIEndpoint().empty() && !AzureOpenAIKey().empty())\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.h b/src/cascadia/TerminalSettingsModel/AIConfig.h\nindex 5bcf5868af4..5d1cf9e1767 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.h\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.h\n@@ -33,6 +33,8 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         Json::Value ToJson() const;\r\n         void LayerJson(const Json::Value& json);\r\n \r\n+        static Model::EnabledLMProviders AllowedLMProviders() noexcept;\r\n+\r\n         // Key and endpoint storage\r\n         // These are not written to the json, they are stored in the Windows Security Storage Vault\r\n         winrt::hstring AzureOpenAIEndpoint() noexcept;\r\n@@ -58,6 +60,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         _BASE_INHERITABLE_SETTING(Model::AIConfig, std::optional<LLMProvider>, ActiveProvider);\r\n \r\n     private:\r\n+        Model::EnabledLMProviders _enabledLMProviders{ Model::EnabledLMProviders::All };\r\n         winrt::hstring _RetrieveCredential(const wil::zwstring_view credential);\r\n         void _SetCredential(const wil::zwstring_view credential, const winrt::hstring& value);\r\n         std::unordered_map<std::wstring, std::wstring> _credentialCache;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.idl b/src/cascadia/TerminalSettingsModel/AIConfig.idl\nindex e3f15435591..f4ee727eece 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.idl\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.idl\n@@ -7,17 +7,28 @@ namespace Microsoft.Terminal.Settings.Model\n {\r\n     enum LLMProvider\r\n     {\r\n+        None,\r\n         AzureOpenAI,\n         OpenAI,\r\n         GithubCopilot\n     };\r\n \r\n+    [flags] enum EnabledLMProviders\r\n+    {\r\n+        AzureOpenAI = 0x1,\r\n+        OpenAI = 0x2,\r\n+        GithubCopilot = 0x4,\r\n+        All = 0xffffffff\r\n+    };\r\n+\r\n     delegate void AzureOpenAISettingChangedHandler();\r\n     delegate void OpenAISettingChangedHandler();\r\n \r\n     [default_interface] runtimeclass AIConfig {\r\n         INHERITABLE_SETTING(LLMProvider, ActiveProvider);\r\n \r\n+        static EnabledLMProviders AllowedLMProviders { get; };\r\n+\r\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         static event AzureOpenAISettingChangedHandler AzureOpenAISettingChanged;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.cpp b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\nindex bebe9ac76bd..4a212aa4edd 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n@@ -348,11 +348,18 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n     // - Actions of the parents are overridden by the children\r\n     void ActionMap::_PopulateCumulativeActionMap(std::unordered_map<hstring, Model::Command>& actionMap)\r\n     {\r\n+        // special case: don't add any ToggleAIChat actions if the feature has been disabled\r\n+        // note: we only refuse to add these actions to the cumulative action map, that way we don't remove them from the user's settings file\r\n+        // this means that these actions won't show up in the command palette, but any keybindings/modifications/etc to them will persist\r\n+        const auto terminalChatDisabled = !WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All);\r\n         for (const auto& [cmdID, cmd] : _ActionMap)\r\n         {\r\n             if (!actionMap.contains(cmdID))\r\n             {\r\n-                actionMap.emplace(cmdID, cmd);\r\n+                if (!terminalChatDisabled || cmd.ActionAndArgs().Action() != ShortcutAction::ToggleAIChat)\r\n+                {\r\n+                    actionMap.emplace(cmdID, cmd);\r\n+                }\r\n             }\r\n         }\r\n \r\n", "test_patch": "", "problem_statement": "[Terminal Chat AI] Allow company wide disabling this feature \n<!-- \n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\n\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\n\nAll good? Then proceed!\n-->\n\n# Description of the new feature/enhancement\n\nSome companies don't allow the usage of AI features or software that has AI feature for privacy reasons. \n\nPlease implement a way to centrally force disable this feature.\n\n# Proposed technical implementation details (optional)\n\nThis can be a policy or HKLM registry value/setting that admins can use to easily disabled this feature for all users.\n\nThis setting should work for portable, store and manually installed versions and on all chanels.\n\n", "hints_text": "Perfectly reasonable ask. I'll link it up to #15000, thanks!\r\n\r\nMy understanding of GPO is that it can be used to set a reg key, so we can easily query that regardless of what distribution method used. \n@zadjii-msft \nI suggest you to implement a common class where you do the registry reading and that return standardized values like we did in PowerToys (https://github.com/microsoft/PowerToys/blob/main/src/common/utils/gpo.h).\n\nEither you evaluate the Policy ones at application startup or every time the settings window and chat window gets opened.\n\nThe default expected behavior of policies is that computer scope has a higher priority than user scoope. And that you are able to set it either in user or in computer scope.\n\nI think the category in the ADMX file should be `Microsoft\\Windows Components\\Windows Terminal`. The Registry key can be `Software\\Policies\\Microsoft\\Windows Terminal` or `Software\\Policies\\Microsoft\\Windows\\Terminal`.\nGiven the current setup process requires custom azure resources, isn't that sufficient for an approval process at least short term?\n> Given the current setup process requires custom azure resources, isn't that sufficient for an approval process at least short term?\n\nI thought everyone is able to create such an required account including private persons. Is that wrong? Don't know about this.\n\nIf I require a special company account/license/configuration then it should be enough for short term.", "created_at": "2024-10-22 02:14:30", "merge_commit_sha": "438621fccb3e36a9b64858d8167ca7fd59a9cfbd", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18022", "base_commit": "4386bf07fd65f763693132ee5e4c43a2a571dc76", "patch": "diff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 30b8ec15b81..0eba4511a92 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -491,14 +491,14 @@ namespace winrt::TerminalApp::implementation\n                 // Because this will always return -1 in this scenario unfortunately.\r\n                 //\r\n                 // So, what we're going to try to do is move the focus to the tab\r\n-                // to the left, within the bounds of how many tabs we have.\r\n+                // to the right, within the bounds of how many tabs we have.\r\n                 //\r\n                 // EX: we have 4 tabs: [A, B, C, D]. If we close:\r\n                 // * A (tabIndex=0): We'll want to focus tab B (now in index 0)\r\n-                // * B (tabIndex=1): We'll want to focus tab A (now in index 0)\r\n-                // * C (tabIndex=2): We'll want to focus tab B (now in index 1)\r\n+                // * B (tabIndex=1): We'll want to focus tab C (now in index 1)\r\n+                // * C (tabIndex=2): We'll want to focus tab D (now in index 2)\r\n                 // * D (tabIndex=3): We'll want to focus tab C (now in index 2)\r\n-                const auto newSelectedIndex = std::clamp<int32_t>(tabIndex - 1, 0, _tabs.Size() - 1);\r\n+                const auto newSelectedIndex = std::clamp<int32_t>(tabIndex, 0, _tabs.Size() - 1);\r\n                 // _UpdatedSelectedTab will do the work of setting up the new tab as\r\n                 // the focused one, and unfocusing all the others.\r\n                 auto newSelectedTab{ _tabs.GetAt(newSelectedIndex) };\r\n", "test_patch": "", "problem_statement": "Focus should move to next tab when closing a tab\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\nWhen a tab is closed, focus should move to the tab to the right instead of to the left.\r\n\r\nIn Firefox and Chrome, when a tab is closed by clicking on \ud83d\uddd9, the cursor naturally lands on the following tab, and the browser shows the content of that tab, allowing the user to close multiple tabs by chain-clicking.\r\n\r\nIn Terminal, when a tab is closed by clicking on \ud83d\uddd9 (or by any other method), the previous tab is shown even though the cursor is on the following tab. The user must move their cursor from the \ud83d\uddd9, click elsewhere on the tab to preview its contents, and then decide whether to close it. An absentminded user may close important tabs because of this unexpected behavior, particularly because Terminal does not confirm tab closing #6549. Before the user moves their cursor, the tab does not show its usual hover effect, adding to the confusion.\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\r\n\n", "hints_text": "Hi I'm an AI powered bot that finds similar issues based off the issue title.\n\nPlease view the issues below to see if they solve your problem, and if the issue describes your problem please consider closing this one and thumbs upping the other issue to help us prioritize it. Thank you!\n\n\n### Closed similar issues:\n- [Close Tabs to the Right (#7633)](https://github.com/microsoft/terminal/issues/7633),  similarity score: 0.76\n\n> Note: You can give me feedback by thumbs upping or thumbs downing this comment.\nGiven that others might have had this problem, I have tried searching for similar (open and closed) issues here and on Google\u2014no luck at all. This issue is not about closing all tabs to the right #5524.", "created_at": "2024-10-10 03:47:45", "merge_commit_sha": "d0e94365d0eebda4f0faccd63b0ff238b6f67822", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17993", "base_commit": "489a0f082d16e0ed5fe40f31eaf08ea7aeaf0838", "patch": "diff --git a/src/cascadia/QueryExtension/ExtensionPalette.cpp b/src/cascadia/QueryExtension/ExtensionPalette.cpp\nindex 61657a7810a..bfae56125be 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.cpp\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.cpp\n@@ -382,6 +382,7 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n         const auto key = e.OriginalKey();\n         const auto coreWindow = CoreWindow::GetForCurrentThread();\n         const auto ctrlDown = WI_IsFlagSet(coreWindow.GetKeyState(winrt::Windows::System::VirtualKey::Control), CoreVirtualKeyStates::Down);\n+        const auto shiftDown = WI_IsFlagSet(coreWindow.GetKeyState(winrt::Windows::System::VirtualKey::Shift), CoreVirtualKeyStates::Down);\n \n         if (key == VirtualKey::Escape)\n         {\n@@ -393,7 +394,7 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n \n             e.Handled(true);\n         }\n-        else if (key == VirtualKey::Enter)\n+        else if (key == VirtualKey::Enter && !shiftDown)\n         {\n             if (const auto& textBox = e.OriginalSource().try_as<TextBox>())\n             {\ndiff --git a/src/cascadia/QueryExtension/ExtensionPalette.xaml b/src/cascadia/QueryExtension/ExtensionPalette.xaml\nindex 2f807a86e4a..f6f3dce09ff 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.xaml\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.xaml\n@@ -392,6 +392,7 @@\n                      Height=\"100\"\r\n                      Margin=\"16,0,16,4\"\r\n                      Padding=\"18,8,8,8\"\r\n+                     AcceptsReturn=\"True\"\r\n                      IsSpellCheckEnabled=\"False\"\r\n                      PlaceholderText=\"{x:Bind QueryBoxPlaceholderText}\"\r\n                      Text=\"\"\r\n", "test_patch": "", "problem_statement": "[Terminal Chat] Shift+Enter should add a newline in the textbox\nI pressed \"Shift+Enter\" expecting a newline and accidentally submitted my query.\r\n\r\nWith the text box being so large, it feels like \"Shift+Enter\" should be accepted to add newlines.\r\n\r\nI _think_ this is an easy fix. We might just have to use this property: https://learn.microsoft.com/en-us/uwp/api/windows.ui.xaml.controls.textbox.acceptsreturn?view=winrt-26100#windows-ui-xaml-controls-textbox-acceptsreturn\n", "hints_text": "", "created_at": "2024-10-03 21:08:14", "merge_commit_sha": "c989f86ad61d357deb43bb20983cec5c179880da", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17951", "base_commit": "a7e47b711a2adc7b9e80eddea8168089f7d3b11e", "patch": "diff --git a/src/terminal/adapter/SixelParser.cpp b/src/terminal/adapter/SixelParser.cpp\nindex f9dbdf6603a..979dd42371c 100644\n--- a/src/terminal/adapter/SixelParser.cpp\n+++ b/src/terminal/adapter/SixelParser.cpp\n@@ -715,8 +715,16 @@ void SixelParser::_eraseImageBufferRows(const int rowCount, const til::CoordType\n     const auto pixelCount = rowCount * _cellSize.height;\r\n     const auto bufferOffset = rowOffset * _cellSize.height * _imageMaxWidth;\r\n     const auto bufferOffsetEnd = bufferOffset + pixelCount * _imageMaxWidth;\r\n-    _imageBuffer.erase(_imageBuffer.begin() + bufferOffset, _imageBuffer.begin() + bufferOffsetEnd);\r\n-    _imageCursor.y -= pixelCount;\r\n+    if (static_cast<size_t>(bufferOffsetEnd) >= _imageBuffer.size()) [[unlikely]]\r\n+    {\r\n+        _imageBuffer.clear();\r\n+        _imageCursor.y = 0;\r\n+    }\r\n+    else\r\n+    {\r\n+        _imageBuffer.erase(_imageBuffer.begin() + bufferOffset, _imageBuffer.begin() + bufferOffsetEnd);\r\n+        _imageCursor.y -= pixelCount;\r\n+    }\r\n }\r\n \r\n void SixelParser::_maybeFlushImageBuffer(const bool endOfSequence)\r\n", "test_patch": "", "problem_statement": "Resizing the font while playing a sixel video can trigger a crash\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n10.0.19045.4894\n\n### Other Software\n\n[img2sixel](https://github.com/saitoha/libsixel)\n\n### Steps to reproduce\n\n1. Start a WSL shell in Windows Terminal.\r\n2. Get some content in the buffer so that resizing will force a reflow.\r\n3. View an animated gif with `img2sixel filename.gif` so you've got some sixel content being constantly refreshed.\r\n4. Resize the font with the mouse scroll wheel, so you're rapidly growing and shrinking the animation. Make sure the image sometimes grows larger than the viewport.\n\n### Expected Behavior\n\nThe animation should continue to play without any problems, aside from the fact that some partial frames will be pushed into the scrollback buffer when the image becomes too large to fit the height of the page.\n\n### Actual Behavior\n\nThe terminal eventually crashes.\r\n\r\nThis doesn't happen in OpenConsole, but that is assumedly because it resizes the window when you change the font size, so the text dimensions never change, and thus no reflow is required. Although now that I say that, I suspect you could possibly cause it to crash just by resizing the window in a way that triggers a reflow.\n", "hints_text": "", "created_at": "2024-09-22 17:21:40", "merge_commit_sha": "fc586e2662c1b490e4f1817c1b3ba8388442da14", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17945", "base_commit": "a7e47b711a2adc7b9e80eddea8168089f7d3b11e", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..94d2a938a81 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -140,8 +140,10 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetWindowTitle(const std::wstring_view title) override;\r\n     CursorType GetUserDefaultCursorStyle() const noexcept override;\r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n-    void SetConsoleOutputCP(const unsigned int codepage) noexcept override;\r\n-    unsigned int GetConsoleOutputCP() const noexcept override;\r\n+    void SetCodePage(const unsigned int codepage) noexcept override;\r\n+    void ResetCodePage() noexcept override;\r\n+    unsigned int GetOutputCodePage() const noexcept override;\r\n+    unsigned int GetInputCodePage() const noexcept override;\r\n     void CopyToClipboard(wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\n     void SetWorkingDirectory(std::wstring_view uri) override;\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 40ff599e115..e6edec3ee92 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -116,14 +116,25 @@ bool Terminal::ResizeWindow(const til::CoordType width, const til::CoordType hei\n     return false;\r\n }\r\n \r\n-void Terminal::SetConsoleOutputCP(const unsigned int /*codepage*/) noexcept\r\n+void Terminal::SetCodePage(const unsigned int /*codepage*/) noexcept\r\n {\r\n-    // TODO: This will be needed to support 8-bit charsets and DOCS sequences.\r\n+    // Code pages are dealt with in ConHost, so this isn't needed.\r\n }\r\n \r\n-unsigned int Terminal::GetConsoleOutputCP() const noexcept\r\n+void Terminal::ResetCodePage() noexcept\r\n {\r\n-    // TODO: See SetConsoleOutputCP above.\r\n+    // There is nothing to reset, since the code page never changes.\r\n+}\r\n+\r\n+unsigned int Terminal::GetOutputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n+    return CP_UTF8;\r\n+}\r\n+\r\n+unsigned int Terminal::GetInputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n     return CP_UTF8;\r\n }\r\n \r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex f199362f7af..b8109bca718 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -1140,7 +1140,6 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n     {\r\n         // Set new code page\r\n         gci.OutputCP = codepage;\r\n-\r\n         SetConsoleCPInfo(TRUE);\r\n     }\r\n \r\n@@ -1157,13 +1156,36 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n {\r\n     try\r\n     {\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-        return DoSrvSetConsoleOutputCodePage(codepage);\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultOutputCP = codepage;\r\n+        return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n }\r\n \r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage)\r\n+{\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+\r\n+    // Return if it's not known as a valid codepage ID.\r\n+    RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n+\r\n+    // Do nothing if no change.\r\n+    if (gci.CP != codepage)\r\n+    {\r\n+        // Set new code page\r\n+        gci.CP = codepage;\r\n+        SetConsoleCPInfo(FALSE);\r\n+    }\r\n+\r\n+    return S_OK;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Sets the codepage used for translating text when calling A versions of functions affecting the input buffer.\r\n // Arguments:\r\n@@ -1177,19 +1199,10 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n         auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-\r\n-        // Return if it's not known as a valid codepage ID.\r\n-        RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n-\r\n-        // Do nothing if no change.\r\n-        if (gci.CP != codepage)\r\n-        {\r\n-            // Set new code page\r\n-            gci.CP = codepage;\r\n-\r\n-            SetConsoleCPInfo(FALSE);\r\n-        }\r\n-\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultCP = codepage;\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\ndiff --git a/src/host/getset.h b/src/host/getset.h\nindex 4c042813c27..f3030eb6050 100644\n--- a/src/host/getset.h\n+++ b/src/host/getset.h\n@@ -19,3 +19,4 @@ Revision History:\n class SCREEN_INFORMATION;\r\n \r\n [[nodiscard]] HRESULT DoSrvSetConsoleOutputCodePage(const unsigned int codepage);\r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage);\r\ndiff --git a/src/host/output.cpp b/src/host/output.cpp\nindex e57412f5310..729821c841a 100644\n--- a/src/host/output.cpp\n+++ b/src/host/output.cpp\n@@ -35,6 +35,8 @@ using namespace Microsoft::Console::Interactivity;\n     // codepage by console.cpl or shell32. The default codepage is OEMCP.\r\n     gci.CP = gci.GetCodePage();\r\n     gci.OutputCP = gci.GetCodePage();\r\n+    gci.DefaultCP = gci.GetCodePage();\r\n+    gci.DefaultOutputCP = gci.GetCodePage();\r\n \r\n     gci.Flags |= CONSOLE_USE_PRIVATE_FLAGS;\r\n \r\ndiff --git a/src/host/outputStream.cpp b/src/host/outputStream.cpp\nindex d88be99ef33..3fbeb3cafaf 100644\n--- a/src/host/outputStream.cpp\n+++ b/src/host/outputStream.cpp\n@@ -221,27 +221,52 @@ void ConhostInternalGetSet::ShowWindow(bool showOrHide)\n }\r\n \r\n // Routine Description:\r\n-// - Connects the SetConsoleOutputCP API call directly into our Driver Message servicing call inside Conhost.exe\r\n+// - Set the code page used for translating text when calling A versions of I/O functions.\r\n // Arguments:\r\n-// - codepage - the new output codepage of the console.\r\n+// - codepage - the new code page of the console.\r\n // Return Value:\r\n // - <none>\r\n-void ConhostInternalGetSet::SetConsoleOutputCP(const unsigned int codepage)\r\n+void ConhostInternalGetSet::SetCodePage(const unsigned int codepage)\r\n {\r\n-    THROW_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n }\r\n \r\n // Routine Description:\r\n-// - Gets the codepage used for translating text when calling A versions of functions affecting the output buffer.\r\n+// - Reset the code pages to their default values.\r\n // Arguments:\r\n // - <none>\r\n // Return Value:\r\n-// - the outputCP of the console.\r\n-unsigned int ConhostInternalGetSet::GetConsoleOutputCP() const\r\n+// - <none>\r\n+void ConhostInternalGetSet::ResetCodePage()\r\n+{\r\n+    const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(gci.DefaultOutputCP));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(gci.DefaultCP));\r\n+}\r\n+\r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of output functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the output code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetOutputCodePage() const\r\n {\r\n     return ServiceLocator::LocateGlobals().getConsoleInformation().OutputCP;\r\n }\r\n \r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of input functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the input code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetInputCodePage() const\r\n+{\r\n+    return ServiceLocator::LocateGlobals().getConsoleInformation().CP;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Copies the given content to the clipboard.\r\n // Arguments:\r\ndiff --git a/src/host/outputStream.hpp b/src/host/outputStream.hpp\nindex 6b564abbf8d..7b76e5f3d0a 100644\n--- a/src/host/outputStream.hpp\n+++ b/src/host/outputStream.hpp\n@@ -53,8 +53,10 @@ class ConhostInternalGetSet final : public Microsoft::Console::VirtualTerminal::\n \r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override;\r\n-    unsigned int GetConsoleOutputCP() const override;\r\n+    void SetCodePage(const unsigned int codepage) override;\r\n+    void ResetCodePage() override;\r\n+    unsigned int GetOutputCodePage() const override;\r\n+    unsigned int GetInputCodePage() const override;\r\n \r\n     void CopyToClipboard(const wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\ndiff --git a/src/host/server.h b/src/host/server.h\nindex 1e14a94b731..0a0f905777b 100644\n--- a/src/host/server.h\n+++ b/src/host/server.h\n@@ -90,6 +90,9 @@ class CONSOLE_INFORMATION :\n     // the following fields are used for ansi-unicode translation\r\n     UINT CP = 0;\r\n     UINT OutputCP = 0;\r\n+    // the VT RIS sequence uses these default values to reset the code pages\r\n+    UINT DefaultCP = 0;\r\n+    UINT DefaultOutputCP = 0;\r\n \r\n     ULONG CtrlFlags = 0; // indicates outstanding ctrl requests\r\n     ULONG LimitingProcessId = 0;\r\ndiff --git a/src/terminal/adapter/ITermDispatch.hpp b/src/terminal/adapter/ITermDispatch.hpp\nindex 3df5ef30178..8ec9e33bdc0 100644\n--- a/src/terminal/adapter/ITermDispatch.hpp\n+++ b/src/terminal/adapter/ITermDispatch.hpp\n@@ -122,6 +122,7 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual void LockingShiftRight(const VTInt gsetNumber) = 0; // LS1R, LS2R, LS3R\r\n     virtual void SingleShift(const VTInt gsetNumber) = 0; // SS2, SS3\r\n     virtual void AcceptC1Controls(const bool enabled) = 0; // DECAC1\r\n+    virtual void SendC1Controls(const bool enabled) = 0; // S8C1T, S7C1T\r\n     virtual void AnnounceCodeStructure(const VTInt ansiLevel) = 0; // ACS\r\n \r\n     virtual void SoftReset() = 0; // DECSTR\r\ndiff --git a/src/terminal/adapter/ITerminalApi.hpp b/src/terminal/adapter/ITerminalApi.hpp\nindex b874bfb8cd4..532133f9a84 100644\n--- a/src/terminal/adapter/ITerminalApi.hpp\n+++ b/src/terminal/adapter/ITerminalApi.hpp\n@@ -72,8 +72,10 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         virtual void ShowWindow(bool showOrHide) = 0;\r\n \r\n-        virtual void SetConsoleOutputCP(const unsigned int codepage) = 0;\r\n-        virtual unsigned int GetConsoleOutputCP() const = 0;\r\n+        virtual void SetCodePage(const unsigned int codepage) = 0;\r\n+        virtual void ResetCodePage() = 0;\r\n+        virtual unsigned int GetOutputCodePage() const = 0;\r\n+        virtual unsigned int GetInputCodePage() const = 0;\r\n \r\n         virtual void CopyToClipboard(const wil::zwstring_view content) = 0;\r\n         virtual void SetTaskbarProgress(const DispatchTypes::TaskbarState state, const size_t progress) = 0;\r\ndiff --git a/src/terminal/adapter/InteractDispatch.cpp b/src/terminal/adapter/InteractDispatch.cpp\nindex fa1a0826047..a8fc483aee6 100644\n--- a/src/terminal/adapter/InteractDispatch.cpp\n+++ b/src/terminal/adapter/InteractDispatch.cpp\n@@ -62,7 +62,7 @@ void InteractDispatch::WriteString(const std::wstring_view string)\n {\r\n     if (!string.empty())\r\n     {\r\n-        const auto codepage = _api.GetConsoleOutputCP();\r\n+        const auto codepage = _api.GetOutputCodePage();\r\n         InputEventQueue keyEvents;\r\n \r\n         for (const auto& wch : string)\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 3899c7cd84d..9ee93ede8b8 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1243,7 +1243,7 @@ void AdaptDispatch::FillRectangularArea(const VTParameter ch, const VTInt top, c\n     const auto charValue = ch.value_or(0) == 0 ? 32 : ch.value();\n     const auto glChar = (charValue >= 32 && charValue <= 126);\n     const auto grChar = (charValue >= 160 && charValue <= 255);\n-    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetConsoleOutputCP() == CP_UTF8);\n+    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetOutputCodePage() == CP_UTF8);\n     if (glChar || grChar || unicodeChar)\n     {\n         const auto fillChar = _termOutput.TranslateKey(gsl::narrow_cast<wchar_t>(charValue));\n@@ -1377,8 +1377,7 @@ void AdaptDispatch::RequestChecksumRectangularArea(const VTInt id, const VTInt p\n             }\n         }\n     }\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", id, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", id, checksum));\n }\n \n // Routine Description:\n@@ -1484,7 +1483,7 @@ void AdaptDispatch::DeviceAttributes()\n     // 32 = Text macros\n     // 42 = ISO Latin-2 character set\n \n-    _api.ReturnResponse(L\"\\x1b[?61;4;6;7;14;21;22;23;24;28;32;42c\");\n+    _ReturnCsiResponse(L\"?61;4;6;7;14;21;22;23;24;28;32;42c\");\n }\n \n // Routine Description:\n@@ -1496,7 +1495,7 @@ void AdaptDispatch::DeviceAttributes()\n // - <none>\n void AdaptDispatch::SecondaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1b[>0;10;1c\");\n+    _ReturnCsiResponse(L\">0;10;1c\");\n }\n \n // Routine Description:\n@@ -1506,7 +1505,7 @@ void AdaptDispatch::SecondaryDeviceAttributes()\n // - <none>\n void AdaptDispatch::TertiaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1bP!|00000000\\x1b\\\\\");\n+    _ReturnDcsResponse(L\"!|00000000\");\n }\n \n // Routine Description:\n@@ -1544,10 +1543,10 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n     switch (permission)\n     {\n     case DispatchTypes::ReportingPermission::Unsolicited:\n-        _api.ReturnResponse(L\"\\x1b[2;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"2;1;1;128;128;1;0x\");\n         break;\n     case DispatchTypes::ReportingPermission::Solicited:\n-        _api.ReturnResponse(L\"\\x1b[3;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"3;1;1;128;128;1;0x\");\n         break;\n     default:\n         break;\n@@ -1562,7 +1561,7 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n // - <none>\n void AdaptDispatch::_DeviceStatusReport(const wchar_t* parameters) const\n {\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{}n\"), parameters));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}n\"), parameters));\n }\n \n // Routine Description:\n@@ -1598,14 +1597,12 @@ void AdaptDispatch::_CursorPositionReport(const bool extendedReport)\n     {\n         // An extended report also includes the page number.\n         const auto pageNumber = page.Number();\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber));\n     }\n     else\n     {\n         // The standard report only returns the cursor position.\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%d;%dR\", cursorPosition.y, cursorPosition.x);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%d;%dR\", cursorPosition.y, cursorPosition.x));\n     }\n }\n \n@@ -1619,8 +1616,7 @@ void AdaptDispatch::_MacroSpaceReport() const\n {\n     const auto spaceInBytes = _macroBuffer ? _macroBuffer->GetSpaceAvailable() : MacroBuffer::MAX_SPACE;\n     // The available space is measured in blocks of 16 bytes, so we need to divide by 16.\n-    const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%zu*{\", spaceInBytes / 16);\n-    _api.ReturnResponse(response);\n+    _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%zu*{\", spaceInBytes / 16));\n }\n \n // Routine Description:\n@@ -1633,8 +1629,7 @@ void AdaptDispatch::_MacroChecksumReport(const VTParameter id) const\n {\n     const auto requestId = id.value_or(0);\n     const auto checksum = _macroBuffer ? _macroBuffer->CalculateChecksum() : 0;\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", requestId, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", requestId, checksum));\n }\n \n // Routine Description:\n@@ -1732,7 +1727,7 @@ void AdaptDispatch::RequestDisplayedExtent()\n     const auto height = page.Viewport().height();\n     const auto left = page.XPanOffset() + 1;\n     const auto top = page.YPanOffset() + 1;\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n }\n \n // Routine Description:\n@@ -2068,7 +2063,7 @@ void AdaptDispatch::RequestMode(const DispatchTypes::ModeParams param)\n         prefix = L\"?\";\n     }\n \n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\x1b[{}{};{}$y\"), prefix, mode, state));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}{};{}$y\"), prefix, mode, state));\n }\n \n // - DECKPAM, DECKPNM - Sets the keypad input mode to either Application mode or Numeric mode (true, false respectively)\n@@ -2785,22 +2780,15 @@ void AdaptDispatch::_InitTabStopsForWidth(const VTInt width)\n // - codingSystem - The coding system that will be selected.\n void AdaptDispatch::DesignateCodingSystem(const VTID codingSystem)\n {\n-    // If we haven't previously saved the initial code page, do so now.\n-    // This will be used to restore the code page in response to a reset.\n-    if (!_initialCodePage.has_value())\n-    {\n-        _initialCodePage = _api.GetConsoleOutputCP();\n-    }\n-\n     switch (codingSystem)\n     {\n     case DispatchTypes::CodingSystem::ISO2022:\n-        _api.SetConsoleOutputCP(28591);\n+        _api.SetCodePage(28591);\n         AcceptC1Controls(true);\n         _termOutput.EnableGrTranslation(true);\n         break;\n     case DispatchTypes::CodingSystem::UTF8:\n-        _api.SetConsoleOutputCP(CP_UTF8);\n+        _api.SetCodePage(CP_UTF8);\n         AcceptC1Controls(false);\n         _termOutput.EnableGrTranslation(false);\n         break;\n@@ -2871,6 +2859,24 @@ void AdaptDispatch::AcceptC1Controls(const bool enabled)\n     _api.GetStateMachine().SetParserMode(StateMachine::Mode::AcceptC1, enabled);\n }\n \n+//Routine Description:\n+// S8C1T/S7C1T - Enable or disable the sending of C1 controls in key sequences\n+//   and query responses. When this is enabled, C1 controls are sent as a single\n+//   codepoint. When disabled, they're sent as a two character escape sequence.\n+//Arguments:\n+// - enabled - true to send C1 controls, false to send escape sequences.\n+void AdaptDispatch::SendC1Controls(const bool enabled)\n+{\n+    // If this is an attempt to enable C1 controls, the input code page must be\n+    // one of the DOCS choices (UTF-8 or ISO-8859-1), otherwise there's a risk\n+    // that those controls won't have a valid encoding.\n+    const auto codepage = _api.GetInputCodePage();\n+    if (enabled == false || codepage == CP_UTF8 || codepage == 28591)\n+    {\n+        _terminalInput.SetInputMode(TerminalInput::Mode::SendC1, enabled);\n+    }\n+}\n+\n //Routine Description:\n // ACS - Announces the ANSI conformance level for subsequent data exchange.\n //  This requires certain character sets to be mapped into the terminal's\n@@ -3003,13 +3009,11 @@ void AdaptDispatch::HardReset()\n \n     // Completely reset the TerminalOutput state.\n     _termOutput = {};\n-    if (_initialCodePage.has_value())\n-    {\n-        // Restore initial code page if previously changed by a DOCS sequence.\n-        _api.SetConsoleOutputCP(_initialCodePage.value());\n-    }\n-    // Disable parsing of C1 control codes.\n+    // Reset the code page to the default value.\n+    _api.ResetCodePage();\n+    // Disable parsing and sending of C1 control codes.\n     AcceptC1Controls(false);\n+    SendC1Controls(false);\n \n     // Sets the SGR state to normal - this must be done before EraseInDisplay\n     //      to ensure that it clears with the default background color.\n@@ -3276,7 +3280,7 @@ void AdaptDispatch::RequestColorTableEntry(const size_t tableIndex)\n     {\n         const til::color c{ color };\n         // Scale values up to match xterm's 16-bit color report format.\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]4;{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+        _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"4;{};rgb:{:04x}/{:04x}/{:04x}\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n     }\n }\n \n@@ -3321,7 +3325,7 @@ void AdaptDispatch::RequestXtermColorResource(const size_t resource)\n         {\n             const til::color c{ color };\n             // Scale values up to match xterm's 16-bit color report format.\n-            _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+            _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"{};rgb:{:04x}/{:04x}/{:04x}\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n         }\n     }\n }\n@@ -3377,7 +3381,7 @@ void AdaptDispatch::WindowManipulation(const DispatchTypes::WindowManipulationTy\n \n     const auto reportSize = [&](const auto size) {\n         const auto reportType = function - 10;\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{}t\"), reportType, size.height, size.width));\n+        _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{}t\"), reportType, size.height, size.width));\n     };\n \n     switch (function)\n@@ -3844,7 +3848,7 @@ void AdaptDispatch::RequestUserPreferenceCharset()\n {\n     const auto size = _termOutput.GetUserPreferenceCharsetSize();\n     const auto id = _termOutput.GetUserPreferenceCharsetId();\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P{}!u{}\\033\\\\\"), (size == 96 ? 1 : 0), id));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"{}!u{}\"), (size == 96 ? 1 : 0), id));\n }\n \n // Method Description:\n@@ -3976,9 +3980,9 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ s.\n+    // A valid response always starts with 2 $ s.\n     fmt::basic_memory_buffer<wchar_t, TextColor::TABLE_SIZE * 18> response;\n-    response.append(L\"\\033P2$s\"sv);\n+    response.append(L\"2$s\"sv);\n \n     const auto modelNumber = static_cast<int>(colorModel);\n     for (size_t colorNumber = 0; colorNumber < TextColor::TABLE_SIZE; colorNumber++)\n@@ -4003,9 +4007,7 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4108,7 +4110,7 @@ ITermDispatch::StringHandler AdaptDispatch::RequestSetting()\n                 _ReportDECACSetting(VTParameter{ parameter });\n                 break;\n             default:\n-                _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+                _ReturnDcsResponse(L\"0$r\");\n                 break;\n             }\n             return false;\n@@ -4147,10 +4149,10 @@ void AdaptDispatch::_ReportSGRSetting() const\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 1 $ r.\n+    // A valid response always starts with 1 $ r.\n     // Then the '0' parameter is to reset the SGR attributes to the defaults.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P1$r0\"sv);\n+    response.append(L\"1$r0\"sv);\n \n     const auto& attr = _pages.ActivePage().Attributes();\n     const auto ulStyle = attr.GetUnderlineStyle();\n@@ -4202,9 +4204,9 @@ void AdaptDispatch::_ReportSGRSetting() const\n     addColor(40, attr.GetBackground());\n     addColor(50, attr.GetUnderlineColor());\n \n-    // The 'm' indicates this is an SGR response, and ST ends the sequence.\n-    response.append(L\"m\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    // The 'm' indicates this is an SGR response.\n+    response.append(L\"m\"sv);\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4217,10 +4219,9 @@ void AdaptDispatch::_ReportDECSTBMSetting()\n {\n     const auto page = _pages.ActivePage();\n     const auto [marginTop, marginBottom] = _GetVerticalMargins(page, false);\n-    // A valid response always starts with DCS 1 $ r, the 'r' indicates this\n-    // is a DECSTBM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the final 'r' indicates this is a DECSTBM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}r\\033\\\\\"), marginTop + 1, marginBottom + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}r\"), marginTop + 1, marginBottom + 1));\n }\n \n // Method Description:\n@@ -4233,10 +4234,9 @@ void AdaptDispatch::_ReportDECSLRMSetting()\n {\n     const auto pageWidth = _pages.ActivePage().Width();\n     const auto [marginLeft, marginRight] = _GetHorizontalMargins(pageWidth);\n-    // A valid response always starts with DCS 1 $ r, the 's' indicates this\n-    // is a DECSLRM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the 's' indicates this is a DECSLRM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}s\\033\\\\\"), marginLeft + 1, marginRight + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}s\"), marginLeft + 1, marginRight + 1));\n }\n \n // Method Description:\n@@ -4249,26 +4249,26 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n {\n     const auto& cursor = _pages.ActivePage().Cursor();\n     const auto blinking = cursor.IsBlinkingAllowed();\n-    // A valid response always starts with DCS 1 $ r. This is followed by a\n+    // A valid response always starts with 1 $ r. This is followed by a\n     // number from 1 to 6 representing the cursor style. The ' q' indicates\n-    // this is a DECSCUSR response, and ST ends the sequence.\n+    // this is a DECSCUSR response.\n     switch (cursor.GetType())\n     {\n     case CursorType::FullBox:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r1 q\\033\\\\\" : L\"\\033P1$r2 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r1 q\" : L\"1$r2 q\");\n         break;\n     case CursorType::Underscore:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r3 q\\033\\\\\" : L\"\\033P1$r4 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r3 q\" : L\"1$r4 q\");\n         break;\n     case CursorType::VerticalBar:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r5 q\\033\\\\\" : L\"\\033P1$r6 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r5 q\" : L\"1$r6 q\");\n         break;\n     default:\n         // If we have a non-standard style, this is likely because it's the\n         // user's chosen default style, so we report a default value of 0.\n         // That way, if an application later tries to restore the cursor with\n         // the returned value, it should be reset to its original state.\n-        _api.ReturnResponse(L\"\\033P1$r0 q\\033\\\\\");\n+        _ReturnDcsResponse(L\"1$r0 q\");\n         break;\n     }\n }\n@@ -4282,10 +4282,10 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n void AdaptDispatch::_ReportDECSCASetting() const\n {\n     const auto isProtected = _pages.ActivePage().Attributes().IsProtected();\n-    // A valid response always starts with DCS 1 $ r. This is followed by '1' if\n-    // the protected attribute is set, or '0' if not. The '\"q' indicates this is\n-    // a DECSCA response, and ST ends the sequence.\n-    _api.ReturnResponse(isProtected ? L\"\\033P1$r1\\\"q\\033\\\\\" : L\"\\033P1$r0\\\"q\\033\\\\\");\n+    // A valid response always starts with 1 $ r. This is followed by '1' if the\n+    // protected attribute is set, or '0' if not. The '\"q' indicates this is a\n+    // DECSCA response.\n+    _ReturnDcsResponse(isProtected ? L\"1$r1\\\"q\" : L\"1$r0\\\"q\");\n }\n \n // Method Description:\n@@ -4297,10 +4297,10 @@ void AdaptDispatch::_ReportDECSCASetting() const\n void AdaptDispatch::_ReportDECSACESetting() const\n {\n     const auto rectangularExtent = _modes.test(Mode::RectangularChangeExtent);\n-    // A valid response always starts with DCS 1 $ r. This is followed by '2' if\n+    // A valid response always starts with 1 $ r. This is followed by '2' if\n     // the extent is rectangular, or '1' if it's a stream. The '*x' indicates\n-    // this is a DECSACE response, and ST ends the sequence.\n-    _api.ReturnResponse(rectangularExtent ? L\"\\033P1$r2*x\\033\\\\\" : L\"\\033P1$r1*x\\033\\\\\");\n+    // this is a DECSACE response.\n+    _ReturnDcsResponse(rectangularExtent ? L\"1$r2*x\" : L\"1$r1*x\");\n }\n \n // Method Description:\n@@ -4324,12 +4324,11 @@ void AdaptDispatch::_ReportDECACSetting(const VTInt itemNumber) const\n         bgIndex = _renderSettings.GetColorAliasIndex(ColorAlias::FrameBackground);\n         break;\n     default:\n-        _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+        _ReturnDcsResponse(L\"0$r\");\n         return;\n     }\n-    // A valid response always starts with DCS 1 $ r, the ',|' indicates this\n-    // is a DECAC response, and ST ends the sequence.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{};{},|\\033\\\\\"), itemNumber, fgIndex, bgIndex));\n+    // A valid response always starts with 1 $ r and the ',|' indicates this is a DECAC response.\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{};{},|\"), itemNumber, fgIndex, bgIndex));\n }\n \n // Routine Description:\n@@ -4442,9 +4441,9 @@ void AdaptDispatch::_ReportCursorInformation()\n     const auto charset2 = _termOutput.GetCharsetId(2);\n     const auto charset3 = _termOutput.GetCharsetId(3);\n \n-    // A valid response always starts with DCS 1 $ u and ends with ST.\n+    // A valid response always starts with 1 $ u.\n     const auto response = fmt::format(\n-        FMT_COMPILE(L\"\\033P1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\\033\\\\\"),\n+        FMT_COMPILE(L\"1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\"),\n         cursorPosition.y,\n         cursorPosition.x,\n         page.Number(),\n@@ -4458,7 +4457,7 @@ void AdaptDispatch::_ReportCursorInformation()\n         charset1,\n         charset2,\n         charset3);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4623,9 +4622,9 @@ void AdaptDispatch::_ReportTabStops()\n \n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ u.\n+    // A valid response always starts with 2 $ u.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P2$u\"sv);\n+    response.append(L\"2$u\"sv);\n \n     auto need_separator = false;\n     for (auto column = 0; column < width; column++)\n@@ -4638,9 +4637,7 @@ void AdaptDispatch::_ReportTabStops()\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4685,6 +4682,26 @@ ITermDispatch::StringHandler AdaptDispatch::_RestoreTabStops()\n     };\n }\n \n+void AdaptDispatch::_ReturnCsiResponse(const std::wstring_view response) const\n+{\n+    const auto csi = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9B\" : L\"\\x1B[\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}\"), csi, response));\n+}\n+\n+void AdaptDispatch::_ReturnDcsResponse(const std::wstring_view response) const\n+{\n+    const auto dcs = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x90\" : L\"\\x1BP\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), dcs, response, st));\n+}\n+\n+void AdaptDispatch::_ReturnOscResponse(const std::wstring_view response) const\n+{\n+    const auto osc = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9D\" : L\"\\x1B]\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), osc, response, st));\n+}\n+\n // Routine Description:\n // - DECPS - Plays a sequence of musical notes.\n // Arguments:\ndiff --git a/src/terminal/adapter/adaptDispatch.hpp b/src/terminal/adapter/adaptDispatch.hpp\nindex 4fc85ebc92a..161e21d358d 100644\n--- a/src/terminal/adapter/adaptDispatch.hpp\n+++ b/src/terminal/adapter/adaptDispatch.hpp\n@@ -121,6 +121,7 @@ namespace Microsoft::Console::VirtualTerminal\n         void LockingShiftRight(const VTInt gsetNumber) override; // LS1R, LS2R, LS3R\n         void SingleShift(const VTInt gsetNumber) noexcept override; // SS2, SS3\n         void AcceptC1Controls(const bool enabled) override; // DECAC1\n+        void SendC1Controls(const bool enabled) override; // S8C1T, S7C1T\n         void AnnounceCodeStructure(const VTInt ansiLevel) override; // ACS\n         void SoftReset() override; // DECSTR\n         void HardReset() override; // RIS\n@@ -289,6 +290,10 @@ namespace Microsoft::Console::VirtualTerminal\n         void _ReportTabStops();\n         StringHandler _RestoreTabStops();\n \n+        void _ReturnCsiResponse(const std::wstring_view response) const;\n+        void _ReturnDcsResponse(const std::wstring_view response) const;\n+        void _ReturnOscResponse(const std::wstring_view response) const;\n+\n         std::vector<uint8_t> _tabStopColumns;\n         bool _initDefaultTabStops = true;\n \n@@ -302,7 +307,6 @@ namespace Microsoft::Console::VirtualTerminal\n         std::shared_ptr<SixelParser> _sixelParser;\n         std::unique_ptr<FontBuffer> _fontBuffer;\n         std::shared_ptr<MacroBuffer> _macroBuffer;\n-        std::optional<unsigned int> _initialCodePage;\n \n         // We have two instances of the saved cursor state, because we need\n         // one for the main buffer (at index 0), and another for the alt buffer\ndiff --git a/src/terminal/adapter/termDispatch.hpp b/src/terminal/adapter/termDispatch.hpp\nindex bb12dc32880..bd91d38d7e9 100644\n--- a/src/terminal/adapter/termDispatch.hpp\n+++ b/src/terminal/adapter/termDispatch.hpp\n@@ -115,6 +115,7 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     void LockingShiftRight(const VTInt /*gsetNumber*/) override {} // LS1R, LS2R, LS3R\r\n     void SingleShift(const VTInt /*gsetNumber*/) override {} // SS2, SS3\r\n     void AcceptC1Controls(const bool /*enabled*/) override {} // DECAC1\r\n+    void SendC1Controls(const bool /*enabled*/) override {} // S8C1T, S7C1T\r\n     void AnnounceCodeStructure(const VTInt /*ansiLevel*/) override {} // ACS\r\n \r\n     void SoftReset() override {} // DECSTR\r\ndiff --git a/src/terminal/adapter/ut_adapter/adapterTest.cpp b/src/terminal/adapter/ut_adapter/adapterTest.cpp\nindex ab2e08d3b85..5fab90f3d39 100644\n--- a/src/terminal/adapter/ut_adapter/adapterTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/adapterTest.cpp\n@@ -158,17 +158,28 @@ class TestGetSet final : public ITerminalApi\n         return true;\r\n     }\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override\r\n+    void SetCodePage(const unsigned int codepage) override\r\n     {\r\n-        Log::Comment(L\"SetConsoleOutputCP MOCK called...\");\r\n-        THROW_HR_IF(E_FAIL, !_setConsoleOutputCPResult);\r\n-        VERIFY_ARE_EQUAL(_expectedOutputCP, codepage);\r\n+        Log::Comment(L\"SetCodePage MOCK called...\");\r\n+        THROW_HR_IF(E_FAIL, !_setCodePageResult);\r\n+        VERIFY_ARE_EQUAL(_expectedCodePage, codepage);\r\n     }\r\n \r\n-    unsigned int GetConsoleOutputCP() const override\r\n+    void ResetCodePage() override\r\n     {\r\n-        Log::Comment(L\"GetConsoleOutputCP MOCK called...\");\r\n-        return _expectedOutputCP;\r\n+        Log::Comment(L\"ResetCodePage MOCK called...\");\r\n+    }\r\n+\r\n+    unsigned int GetOutputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetOutputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n+    }\r\n+\r\n+    unsigned int GetInputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetInputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n     }\r\n \r\n     void CopyToClipboard(const wil::zwstring_view /*content*/)\r\n@@ -367,7 +378,7 @@ class TestGetSet final : public ITerminalApi\n     til::point _expectedCursorPos;\r\n \r\n     TextAttribute _expectedAttribute = {};\r\n-    unsigned int _expectedOutputCP = 0;\r\n+    unsigned int _expectedCodePage = 0;\r\n     bool _isPty = false;\r\n \r\n     bool _returnResponseResult = false;\r\n@@ -376,8 +387,7 @@ class TestGetSet final : public ITerminalApi\n \r\n     bool _setWindowTitleResult = false;\r\n     std::wstring_view _expectedWindowTitle{};\r\n-    bool _setConsoleOutputCPResult = false;\r\n-    bool _getConsoleOutputCPResult = false;\r\n+    bool _setCodePageResult = false;\r\n     bool _expectedShowWindow = false;\r\n \r\n     std::wstring _expectedMenuJson{};\r\n@@ -3529,15 +3539,15 @@ class AdapterTest\n \r\n         Log::Comment(L\"3. Designate ISO-2022 coding system\");\r\n         // Code page should be set to ISO-8859-1 and C1 parsing enabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = 28591;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = 28591;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::ISO2022);\r\n         VERIFY_IS_TRUE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n \r\n         Log::Comment(L\"4. Designate UTF-8 coding system\");\r\n         // Code page should be set to UTF-8 and C1 parsing disabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = CP_UTF8;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::UTF8);\r\n         VERIFY_IS_FALSE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n     }\r\n@@ -3962,6 +3972,39 @@ class AdapterTest\n         _pDispatch->PagePositionAbsolute(1);\r\n     }\r\n \r\n+    TEST_METHOD(SendC1ControlTest)\r\n+    {\r\n+        const auto S7C1T = L\"\\033 F\";\r\n+        const auto S8C1T = L\"\\033 G\";\r\n+\r\n+        _testGetSet->PrepData();\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n+\r\n+        Log::Comment(L\"Generating reports with C1 control sequences\");\r\n+        _stateMachine->ProcessString(S8C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9b>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x90!|00000000\\x9c\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9d\\x34;0;rgb:0c0c/0c0c/0c0c\\x9c\");\r\n+\r\n+        Log::Comment(L\"Generating reports with 7-bit escape sequence\");\r\n+        _stateMachine->ProcessString(S7C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b[>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1bP!|00000000\\x1b\\\\\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b]4;0;rgb:0c0c/0c0c/0c0c\\x1b\\\\\");\r\n+    }\r\n+\r\n private:\r\n     TerminalInput _terminalInput;\r\n     std::unique_ptr<TestGetSet> _testGetSet;\r\ndiff --git a/src/terminal/adapter/ut_adapter/inputTest.cpp b/src/terminal/adapter/ut_adapter/inputTest.cpp\nindex d3c4c3d0d06..ab893be7724 100644\n--- a/src/terminal/adapter/ut_adapter/inputTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/inputTest.cpp\n@@ -36,6 +36,7 @@ class Microsoft::Console::VirtualTerminal::InputTest\n     TEST_METHOD(CtrlNumTest);\r\n     TEST_METHOD(BackarrowKeyModeTest);\r\n     TEST_METHOD(AutoRepeatModeTest);\r\n+    TEST_METHOD(SendC1ControlTest);\r\n \r\n     wchar_t GetModifierChar(const bool fShift, const bool fAlt, const bool fCtrl)\r\n     {\r\n@@ -790,3 +791,20 @@ void InputTest::AutoRepeatModeTest()\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput(L\"A\"), input.HandleKey(down));\r\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput({}), input.HandleKey(up));\r\n }\r\n+\r\n+void InputTest::SendC1ControlTest()\r\n+{\r\n+    TerminalInput input;\r\n+\r\n+    Log::Comment(L\"Sending keys with C1 control sequences\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, true);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x9bH\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x8fP\"), input, 0, VK_F1);\r\n+\r\n+    Log::Comment(L\"Sending keys with 7-bit escape sequence\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, false);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1b[H\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1bOP\"), input, 0, VK_F1);\r\n+}\r\ndiff --git a/src/terminal/input/terminalInput.cpp b/src/terminal/input/terminalInput.cpp\nindex 7c09ef46155..ac0795bdc41 100644\n--- a/src/terminal/input/terminalInput.cpp\n+++ b/src/terminal/input/terminalInput.cpp\n@@ -53,7 +53,7 @@ void TerminalInput::SetInputMode(const Mode mode, const bool enabled) noexcept\n \r\n     // If we've changed one of the modes that alter the VT input sequences,\r\n     // we'll need to regenerate our keyboard map.\r\n-    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey };\r\n+    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey, Mode::SendC1 };\r\n     if (keyMapModes.test(mode))\r\n     {\r\n         _initKeyboardMap();\r\n@@ -353,6 +353,19 @@ try\n \r\n     _keyMap.clear();\r\n \r\n+    // The CSI and SS3 introducers are C1 control codes, which can either be\r\n+    // sent as a single codepoint, or as a two character escape sequence.\r\n+    if (_inputMode.test(Mode::SendC1))\r\n+    {\r\n+        _csi = L\"\\x9B\";\r\n+        _ss3 = L\"\\x8F\";\r\n+    }\r\n+    else\r\n+    {\r\n+        _csi = L\"\\x1B[\";\r\n+        _ss3 = L\"\\x1BO\";\r\n+    }\r\n+\r\n     // PAUSE doesn't have a VT mapping, but traditionally we've mapped it to ^Z,\r\n     // regardless of modifiers.\r\n     defineKeyWithUnusedModifiers(VK_PAUSE, L\"\\x1A\"s);\r\ndiff --git a/src/terminal/input/terminalInput.hpp b/src/terminal/input/terminalInput.hpp\nindex e8ae53267e2..40488269569 100644\n--- a/src/terminal/input/terminalInput.hpp\n+++ b/src/terminal/input/terminalInput.hpp\n@@ -33,6 +33,7 @@ namespace Microsoft::Console::VirtualTerminal\n             CursorKey,\r\n             BackarrowKey,\r\n             Win32,\r\n+            SendC1,\r\n \r\n             Utf8MouseEncoding,\r\n             SgrMouseEncoding,\r\n@@ -80,10 +81,8 @@ namespace Microsoft::Console::VirtualTerminal\n         til::enumset<Mode> _inputMode{ Mode::Ansi, Mode::AutoRepeat, Mode::AlternateScroll };\r\n         bool _forceDisableWin32InputMode{ false };\r\n \r\n-        // In the future, if we add support for \"8-bit\" input mode, these prefixes\r\n-        // will sometimes be replaced with equivalent C1 control characters.\r\n-        static constexpr auto _csi = L\"\\x1B[\";\r\n-        static constexpr auto _ss3 = L\"\\x1BO\";\r\n+        const wchar_t* _csi = L\"\\x1B[\";\r\n+        const wchar_t* _ss3 = L\"\\x1BO\";\r\n \r\n         void _initKeyboardMap() noexcept;\r\n         DWORD _trackControlKeyState(const KEY_EVENT_RECORD& key);\r\n@@ -108,9 +107,9 @@ namespace Microsoft::Console::VirtualTerminal\n #pragma endregion\r\n \r\n #pragma region MouseInput\r\n-        [[nodiscard]] static OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n \r\n         [[nodiscard]] OutputType _makeAlternateScrollOutput(short delta) const;\r\n \r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.cpp b/src/terminal/parser/OutputStateMachineEngine.cpp\nindex 5339c29bdf9..edb53e100d0 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.cpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.cpp\n@@ -256,6 +256,12 @@ bool OutputStateMachineEngine::ActionEscDispatch(const VTID id)\n     case EscActionCodes::DECAC1_AcceptC1Controls:\r\n         _dispatch->AcceptC1Controls(true);\r\n         break;\r\n+    case EscActionCodes::S7C1T_Send7bitC1Controls:\r\n+        _dispatch->SendC1Controls(false);\r\n+        break;\r\n+    case EscActionCodes::S8C1T_Send8bitC1Controls:\r\n+        _dispatch->SendC1Controls(true);\r\n+        break;\r\n     case EscActionCodes::ACS_AnsiLevel1:\r\n         _dispatch->AnnounceCodeStructure(1);\r\n         break;\r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.hpp b/src/terminal/parser/OutputStateMachineEngine.hpp\nindex ad594c269cd..ab41e066cfa 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.hpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.hpp\n@@ -77,6 +77,8 @@ namespace Microsoft::Console::VirtualTerminal\n             LS2R_LockingShift = VTID(\"}\"),\r\n             LS3R_LockingShift = VTID(\"|\"),\r\n             DECAC1_AcceptC1Controls = VTID(\" 7\"),\r\n+            S7C1T_Send7bitC1Controls = VTID(\" F\"),\r\n+            S8C1T_Send8bitC1Controls = VTID(\" G\"),\r\n             ACS_AnsiLevel1 = VTID(\" L\"),\r\n             ACS_AnsiLevel2 = VTID(\" M\"),\r\n             ACS_AnsiLevel3 = VTID(\" N\"),\r\ndiff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 65e7460e9b8..12954512bdb 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -25,6 +25,9 @@ StateMachine::StateMachine(std::unique_ptr<IStateMachineEngine> engine, const bo\n     _oscString{},\r\n     _cachedSequence{ std::nullopt }\r\n {\r\n+    // The state machine must always accept C1 controls for the input engine,\r\n+    // otherwise it won't work when the ConPTY terminal has S8C1T enabled.\r\n+    _parserMode.set(Mode::AcceptC1, _isEngineForInput);\r\n     _ActionClear();\r\n }\r\n \r\n", "test_patch": "", "problem_statement": "Add support for the S8C1T/S7C1T escape sequences\n# Description of the new feature/enhancement\r\n\r\nThe `S8C1T` and `S7C1T` commands enable an application to choose whether the terminal should use C1 controls when sending key sequences and query responses. For example, instead of encoding a `CSI` prefix as `ESC` `[`, the terminal would use a single `CSI` codepoint (i.e. `U+009B`).\r\n\r\nBack in the days of the 8-bit hardware terminals, this had the advantage of being slightly more efficient (your sequence introducers would take 1 byte rather than 2). And another bonus was that it made it easy to distinguish an <kbd>Esc</kbd> key (assuming your keyboard had one) from other key sequences that merely started with the `ESC` character.\r\n\r\nHowever, these days you're more likely to be using a UTF-8 encoding, in which case a C1 control character is still going to occupy two bytes, so there is no advantage in terms of sequence length. And the ability to distinguish an <kbd>Esc</kbd> key from other key sequences is somewhat diminished by the modern usage of `ESC` as a prefix for <kbd>Alt</kbd> key combinations.\r\n\r\nIn short, there's probably not much demand for this functionality outside of people wanting to connect to legacy systems, but it would be nice to have just for completeness sake (it's a requirement for VT level 2 conformance).\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nSome of the framework for the key sequence encoding was already added in PR #16511, so that just needs to be hooked up to a new input mode which can be toggled by the `S8C1T` and `S7C1T` escape sequences. We need to do something similar in `AdaptDispatch` for all the query responses, but that's also fairly straightforward.\r\n\r\nHowever, if we want to support 8-bit C1 sequences, as used in legacy systems, we also need a way to switch the input code page from UTF-8 to something that can cleanly pass through 8-bit bytes (like ISO-8859-1). Fortunately we already have a `DOCS` escape sequence which sets the *output* code page to ISO-8859-1, and I think it's reasonable to extend that to set the input code page at the same time.\r\n\r\nThe catch is that this won't work in a WSL shell, because WSL doesn't pay any attention to the input code page. And while it is potentially usable from a Windows shell, the typical use case will involve connecting to a remote system, which means you're going to ned a ssh or telnet client that is 8-bit capable (and I think that rules out the Windows inbox clients).\r\n\r\nThe bottom line is there are a few hoops you need to jump through to get this to work. Given these limitations, is it still worth adding?\n", "hints_text": "", "created_at": "2024-09-21 14:25:46", "merge_commit_sha": "aa256ad5c9656c8aac75b1cf40c0ecae869dd4c0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17912", "base_commit": "6196a3d0f754f7ec32ecccb46b97701c6ac6955b", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\nindex 0e12e7d3de7..72b254e4e41 100644\n--- a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n@@ -44,6 +44,9 @@\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n \r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorDark2\" />\r\n+\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"HighContrast\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -73,6 +76,9 @@\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight1\" />\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"Dark\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -106,6 +112,9 @@\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight2\" />\r\n         </ResourceDictionary>\r\n     </ResourceDictionary.ThemeDictionaries>\r\n \r\n@@ -136,7 +145,7 @@\n \r\n     <Style x:Key=\"SettingContainerFontIconStyle\"\r\n            TargetType=\"FontIcon\">\r\n-        <Setter Property=\"Foreground\" Value=\"{StaticResource SystemAccentColor}\" />\r\n+        <Setter Property=\"Foreground\" Value=\"{ThemeResource SettingContainerResetButtonIconForeground}\" />\r\n         <Setter Property=\"FontSize\" Value=\"11\" />\r\n         <Setter Property=\"FontFamily\" Value=\"{ThemeResource SymbolThemeFontFamily}\" />\r\n     </Style>\r\n", "test_patch": "", "problem_statement": "[Windows Terminal - Settings]: In dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Prerequisites:**\r\nSettings> Personalization> Colors> Choose your Mode> Dark Mode.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Apply dark mode by following the prerequisites.\r\n3. Now open 'Setting' and activate 'Startup' tab.\r\n4. Navigate to the 'Defaults' tab and activate it.\r\n5. Now navigate to the 'Appearance' button and activate it.\r\n6. Now navigate to any control like 'Line height' and change value.\r\n7. 'Reset to inherited value' button will appear.\r\n8. Open Accessibility Insights for windows and check contrast ratio of 'Reset to inherited value' icon. \r\n9. Observe the issue.\r\n\r\n**User experience:**\r\nLow vision users will find difficulty in tracking the control, if contrast ratio for the control's icon is less than '3:1' (Required).\r\n\r\n**WCAG Reference Link:**\r\n[[MAS 4.3.1 \u2013 No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)](https://www.w3.org/WAI/WCAG22/Understanding/non-text-contrast)\r\n\r\n**Attachment:**\r\n[MAS1.4.11 - In Dark mode, cca failed for 'Reset to inherited value' button..zip](https://github.com/user-attachments/files/16959865/MAS1.4.11.-.In.Dark.mode.cca.failed.for.Reset.to.inherited.value.button.zip)\n\n### Expected Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon should be greater than or equal to 3:1. \n\n### Actual Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\r\n\r\n**Note:**\r\nSame issue repro for all 'Reset to inherited value' button's icon throughout.\n", "hints_text": "@SaurabhNew is there an associated severity rating for this issue?", "created_at": "2024-09-11 23:12:16", "merge_commit_sha": "0bd19e9cfc31383f17e453e18df6649bdd6cf64a", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17886", "base_commit": "544452dad41d05b865f1fa1d665397befaa9ec2b", "patch": "diff --git a/src/cascadia/TerminalApp/Pane.cpp b/src/cascadia/TerminalApp/Pane.cpp\nindex a210b701528..dc235b06024 100644\n--- a/src/cascadia/TerminalApp/Pane.cpp\n+++ b/src/cascadia/TerminalApp/Pane.cpp\n@@ -2956,13 +2956,13 @@ bool Pane::ContainsReadOnly() const\n // - <none>\r\n void Pane::CollectTaskbarStates(std::vector<winrt::TerminalApp::TaskbarState>& states)\r\n {\r\n-    if (_IsLeaf())\r\n+    if (_content)\r\n     {\r\n         auto tbState{ winrt::make<winrt::TerminalApp::implementation::TaskbarState>(_content.TaskbarState(),\r\n                                                                                     _content.TaskbarProgress()) };\r\n         states.push_back(tbState);\r\n     }\r\n-    else\r\n+    else if (_firstChild && _secondChild)\r\n     {\r\n         _firstChild->CollectTaskbarStates(states);\r\n         _secondChild->CollectTaskbarStates(states);\r\n", "test_patch": "", "problem_statement": "Crash when choosing 'Close all other panes'\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n10.0.27699.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1.\tOpen Windows Terminal.\r\n2.\tSplit panes so there are at least two panes.\r\n3.\tCtrl+Shift+P and choose \u2018Close all other panes\u2019\r\n\n\n### Expected Behavior\n\nNo crash.\n\n### Actual Behavior\n\nTerminal crashes with an access violation:\r\n\r\n```\r\n(3c78.4aa0): Access violation - code c0000005 (first/second chance not available)\r\nFor analysis of this file, run !analyze -v\r\nTerminalApp!winrt::impl::consume_TerminalApp_IPaneContent<winrt::TerminalApp::IPaneContent>::TaskbarProgress+0x34 [inlined in TerminalApp!Pane::CollectTaskbarStates+0x82]:\r\n00007ffb`45483032 488b01          mov     rax,qword ptr [rcx] ds:00000000`00000000=????????????????\r\n```\r\n\r\nHere is the call stack:\r\n\r\n```\r\nTerminalApp!winrt::impl::consume_TerminalApp_IPaneContent<winrt::TerminalApp::IPaneContent>::TaskbarProgress\r\nTerminalApp!Pane::CollectTaskbarStates\r\nTerminalApp!Pane::CollectTaskbarStates\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalTab::GetCombinedTaskbarState\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalPage::TaskbarState\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalWindow::TaskbarState\r\nTerminalApp!winrt::impl::produce<winrt::TerminalApp::implementation::TerminalWindow,winrt::TerminalApp::ITerminalWindow>::get_TaskbarState\r\nWindowsTerminal\r\nWindowsTerminal\r\nTerminalApp!winrt::Windows::Foundation::TypedEventHandler<winrt::Windows::Foundation::IInspectable,winrt::Windows::Foundation::IInspectable>::operator()\r\nTerminalApp!wil::details::dispatcher_handler::operator()\r\nTerminalApp!winrt::impl::delegate<winrt::Windows::UI::Core::DispatchedHandler,wil::details::dispatcher_handler>::Invoke\r\nWindows_UI!Microsoft::WRL::Details::DelegateArgTraits<long (__cdecl Windows::System::IDispatcherQueueHandler::*)(void)>::DelegateInvokeHelper<Microsoft::WRL::Implements<Microsoft::WRL::RuntimeClassFlags<2>,Windows::System::IDispatcherQueueHandler,Microsoft::WRL::FtmBase>,<lambda_980f345bc6e4ac8a906323c24a5fe9b1>,-1>::Invoke\r\nCoreMessaging!Windows::System::DispatcherQueue::DeferInvokeCallback\r\nCoreMessaging!CFlat::SehSafe::Execute<<lambda_654db17c35df07198786f0867aa10de6> >\r\nCoreMessaging!Microsoft::CoreUI::ActionCallback::ImportAdapter$\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::DeferredCall::Callback_Dispatch\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::DeferredCallDispatcher::Callback_OnDispatch\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::Dispatcher::Callback_DispatchLoop\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::EventLoop::Callback_RunCoreLoop\r\nuser32!_fnDWORD\r\nntdll!KiUserCallbackDispatcherContinue\r\nwin32u!NtUserGetMessage\r\nuser32!GetMessageW\r\nWindowsTerminal\r\nWindowsTerminal\r\nWindowsTerminal\r\nucrtbase!thread_start<unsigned int (__cdecl*)(void *),1>\r\nKERNEL32!BaseThreadInitThunk\r\nntdll!RtlUserThreadStart\r\n```\n", "hints_text": "I suspect this is the same underlying bug as #17869. If I try and reproduce that one in the debugger I get a very similar stack trace to this crash.\nThis must've regressed in #17750. Since we never wrote down what made it originally crash, I guessed it happened by simply closing panes, but this shows it was via the \"Close all other panes\" action. Not 100% sure how to best fix it. There were two simple options and neither worked. The correct approach would be to not tie the model (binary tree of panes) to the animations but fixing that is not an option for a hotfix.", "created_at": "2024-09-09 17:04:28", "merge_commit_sha": "bc6f3e22757415e42e658597c60b40c003941289", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17885", "base_commit": "544452dad41d05b865f1fa1d665397befaa9ec2b", "patch": "diff --git a/src/buffer/out/search.cpp b/src/buffer/out/search.cpp\nindex 31c7081b2b9..75143f047ca 100644\n--- a/src/buffer/out/search.cpp\n+++ b/src/buffer/out/search.cpp\n@@ -16,7 +16,7 @@ bool Search::IsStale(const Microsoft::Console::Render::IRenderData& renderData,\n            _lastMutationId != renderData.GetTextBuffer().GetLastMutationId();\r\n }\r\n \r\n-bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n+void Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n {\r\n     const auto& textBuffer = renderData.GetTextBuffer();\r\n \r\n@@ -30,15 +30,15 @@ bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const st\n     _results = std::move(result).value_or(std::vector<til::point_span>{});\r\n     _index = reverse ? gsl::narrow_cast<ptrdiff_t>(_results.size()) - 1 : 0;\r\n     _step = reverse ? -1 : 1;\r\n-    return true;\r\n-}\r\n \r\n-void Search::MoveToCurrentSelection()\r\n-{\r\n     if (_renderData->IsSelectionActive())\r\n     {\r\n         MoveToPoint(_renderData->GetTextBuffer().ScreenToBufferPosition(_renderData->GetSelectionAnchor()));\r\n     }\r\n+    else if (const auto span = _renderData->GetSearchHighlightFocused())\r\n+    {\r\n+        MoveToPoint(_step > 0 ? span->start : span->end);\r\n+    }\r\n }\r\n \r\n void Search::MoveToPoint(const til::point anchor) noexcept\r\ndiff --git a/src/buffer/out/search.h b/src/buffer/out/search.h\nindex 763b5d40c73..304de1ab889 100644\n--- a/src/buffer/out/search.h\n+++ b/src/buffer/out/search.h\n@@ -36,9 +36,8 @@ class Search final\n     Search() = default;\r\n \r\n     bool IsStale(const Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags) const noexcept;\r\n-    bool Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n+    void Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n \r\n-    void MoveToCurrentSelection();\r\n     void MoveToPoint(til::point anchor) noexcept;\r\n     void MovePastPoint(til::point anchor) noexcept;\r\n     void FindNext(bool reverse) noexcept;\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex cd4f5f58b81..5d379ba6c5e 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1697,38 +1697,41 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     SearchResults ControlCore::Search(SearchRequest request)\r\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n+\r\n         SearchFlag flags{};\r\n         WI_SetFlagIf(flags, SearchFlag::CaseInsensitive, !request.CaseSensitive);\r\n         WI_SetFlagIf(flags, SearchFlag::RegularExpression, request.RegularExpression);\r\n         const auto searchInvalidated = _searcher.IsStale(*_terminal.get(), request.Text, flags);\r\n \r\n-        if (searchInvalidated || !request.Reset)\r\n+        if (searchInvalidated || !request.ResetOnly)\r\n         {\r\n             std::vector<til::point_span> oldResults;\r\n+            til::point_span oldFocused;\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused())\r\n+            {\r\n+                oldFocused = *focused;\r\n+            }\r\n \r\n             if (searchInvalidated)\r\n             {\r\n                 oldResults = _searcher.ExtractResults();\r\n                 _searcher.Reset(*_terminal.get(), request.Text, flags, !request.GoForward);\r\n-\r\n-                if (SnapSearchResultToSelection())\r\n-                {\r\n-                    _searcher.MoveToCurrentSelection();\r\n-                    SnapSearchResultToSelection(false);\r\n-                }\r\n-\r\n                 _terminal->SetSearchHighlights(_searcher.Results());\r\n             }\r\n-            else\r\n+\r\n+            if (!request.ResetOnly)\r\n             {\r\n                 _searcher.FindNext(!request.GoForward);\r\n             }\r\n \r\n-            if (const auto idx = _searcher.CurrentMatch(); idx >= 0)\r\n+            _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(std::max<ptrdiff_t>(0, _searcher.CurrentMatch())));\r\n+            _renderer->TriggerSearchHighlight(oldResults);\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused(); focused && *focused != oldFocused)\r\n             {\r\n-                _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(idx), request.ScrollOffset);\r\n+                _terminal->ScrollToSearchHighlight(request.ScrollOffset);\r\n             }\r\n-            _renderer->TriggerSearchHighlight(oldResults);\r\n         }\r\n \r\n         int32_t totalMatches = 0;\r\n@@ -1756,27 +1759,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n         _terminal->SetSearchHighlights({});\r\n-        _terminal->SetSearchHighlightFocused({}, 0);\r\n+        _terminal->SetSearchHighlightFocused(0);\r\n         _renderer->TriggerSearchHighlight(_searcher.Results());\r\n         _searcher = {};\r\n     }\r\n \r\n-    // Method Description:\r\n-    // - Tells ControlCore to snap the current search result index to currently\r\n-    //   selected text if the search was started using it.\r\n-    void ControlCore::SnapSearchResultToSelection(bool shouldSnap) noexcept\r\n-    {\r\n-        _snapSearchResultToSelection = shouldSnap;\r\n-    }\r\n-\r\n-    // Method Description:\r\n-    // - Returns true, if we should snap the current search result index to\r\n-    //   the currently selected text after a new search is started, else false.\r\n-    bool ControlCore::SnapSearchResultToSelection() const noexcept\r\n-    {\r\n-        return _snapSearchResultToSelection;\r\n-    }\r\n-\r\n     void ControlCore::Close()\r\n     {\r\n         if (!_IsClosing())\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 9ac8e5450c3..2e9f2490d9d 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -228,8 +228,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         SearchResults Search(SearchRequest request);\r\n         const std::vector<til::point_span>& SearchResultRows() const noexcept;\r\n         void ClearSearch();\r\n-        void SnapSearchResultToSelection(bool snap) noexcept;\r\n-        bool SnapSearchResultToSelection() const noexcept;\r\n \r\n         void LeftClickOnTerminal(const til::point terminalPosition,\r\n                                  const int numberOfClicks,\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.idl b/src/cascadia/TerminalControl/ControlCore.idl\nindex 3be52269a89..ee1a4787e22 100644\n--- a/src/cascadia/TerminalControl/ControlCore.idl\n+++ b/src/cascadia/TerminalControl/ControlCore.idl\n@@ -55,7 +55,7 @@ namespace Microsoft.Terminal.Control\n         Boolean GoForward;\r\n         Boolean CaseSensitive;\r\n         Boolean RegularExpression;\r\n-        Boolean Reset;\r\n+        Boolean ResetOnly;\r\n         Int32 ScrollOffset;\r\n     };\r\n \r\n@@ -148,7 +148,6 @@ namespace Microsoft.Terminal.Control\n \r\n         SearchResults Search(SearchRequest request);\r\n         void ClearSearch();\r\n-        Boolean SnapSearchResultToSelection;\r\n \r\n         Microsoft.Terminal.Core.Color ForegroundColor { get; };\r\n         Microsoft.Terminal.Core.Color BackgroundColor { get; };\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 565ea02ccf6..5f981f89e65 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -576,7 +576,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // but since code paths differ, extra work is required to ensure correctness.\r\n                     if (!_core.HasMultiLineSelection())\r\n                     {\r\n-                        _core.SnapSearchResultToSelection(true);\r\n                         const auto selectedLine{ _core.SelectedText(true) };\r\n                         _searchBox->PopulateTextbox(selectedLine);\r\n                     }\r\n@@ -3844,7 +3843,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         const auto goForward = _searchBox->GoForward();\r\n         const auto caseSensitive = _searchBox->CaseSensitive();\r\n         const auto regularExpression = _searchBox->RegularExpression();\r\n-        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _calculateSearchScrollOffset() };\r\n+        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _searchScrollOffset };\r\n         _handleSearchResults(_core.Search(request));\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c5876e1497c..df24a3e8917 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1259,15 +1259,17 @@ void Terminal::SetSearchHighlights(const std::vector<til::point_span>& highlight\n // Method Description:\r\n // - Stores the focused search highlighted region in the terminal\r\n // - If the region isn't empty, it will be brought into view\r\n-void Terminal::SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset)\r\n+void Terminal::SetSearchHighlightFocused(const size_t focusedIdx) noexcept\r\n {\r\n     _assertLocked();\r\n     _searchHighlightFocused = focusedIdx;\r\n+}\r\n \r\n-    // bring the focused region into the view if the index is in valid range\r\n-    if (focusedIdx < _searchHighlights.size())\r\n+void Terminal::ScrollToSearchHighlight(til::CoordType searchScrollOffset)\r\n+{\r\n+    if (_searchHighlightFocused < _searchHighlights.size())\r\n     {\r\n-        const auto focused = til::at(_searchHighlights, focusedIdx);\r\n+        const auto focused = til::at(_searchHighlights, _searchHighlightFocused);\r\n         const auto adjustedStart = til::point{ focused.start.x, std::max(0, focused.start.y - searchScrollOffset) };\r\n         const auto adjustedEnd = til::point{ focused.end.x, std::max(0, focused.end.y - searchScrollOffset) };\r\n         _ScrollToPoints(adjustedStart, adjustedEnd);\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..d62a76b3bc8 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -234,7 +234,8 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetClearQuickFixCallback(std::function<void()> pfn) noexcept;\r\n     void SetWindowSizeChangedCallback(std::function<void(int32_t, int32_t)> pfn) noexcept;\r\n     void SetSearchHighlights(const std::vector<til::point_span>& highlights) noexcept;\r\n-    void SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset);\r\n+    void SetSearchHighlightFocused(size_t focusedIdx) noexcept;\r\n+    void ScrollToSearchHighlight(til::CoordType searchScrollOffset);\r\n \r\n     void BlinkCursor() noexcept;\r\n     void SetCursorOn(const bool isOn) noexcept;\r\ndiff --git a/src/interactivity/win32/find.cpp b/src/interactivity/win32/find.cpp\nindex 033918e3ae5..07996c47767 100644\n--- a/src/interactivity/win32/find.cpp\n+++ b/src/interactivity/win32/find.cpp\n@@ -57,7 +57,6 @@ INT_PTR CALLBACK FindDialogProc(HWND hWnd, UINT Message, WPARAM wParam, LPARAM l\n             if (searcher.IsStale(gci.renderData, lastFindString, flags))\r\n             {\r\n                 searcher.Reset(gci.renderData, lastFindString, flags, reverse);\r\n-                searcher.MoveToCurrentSelection();\r\n             }\r\n             else\r\n             {\r\n", "test_patch": "", "problem_statement": "Search results steal focus and scroll when the buffer changes at all\n### Windows Terminal version\n\n1.21.1272.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n- Fill the buffer with enough text to make it scrollable (for example, using `Get-Random -Count 1000` in PowerShell),\r\n- search something in such a way that the last result is outside the view,\r\n- select a search result which is not the last (optinal),\r\n- type something in the prompt.\n\n### Expected Behavior\n\nWhile typing in the prompt nothing happen, the select result stays the same, and the view focus the prompt.\n\n### Actual Behavior\n\nWhen typing, the search appear to retrigger, and the focus goes to the last result, moving the prompt outside view.\n", "hints_text": "Hey, I've been hitting this too!\n\nMarking it up for 1.22 and as P1 - we should fix it and backport to 1.21 before 1.21 goes stable.", "created_at": "2024-09-09 17:00:06", "merge_commit_sha": "d9131c68893fe114a6091d262c23a5a26199d023", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17884", "base_commit": "544452dad41d05b865f1fa1d665397befaa9ec2b", "patch": "diff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex cd4f5f58b81..5c96b5c805c 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -2221,19 +2221,32 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - <none>\r\n     void ControlCore::ClearBuffer(Control::ClearBufferType clearType)\r\n     {\r\n-        if (clearType == Control::ClearBufferType::Scrollback || clearType == Control::ClearBufferType::All)\r\n+        std::wstring_view command;\r\n+        switch (clearType)\r\n+        {\r\n+        case ClearBufferType::Screen:\r\n+            command = L\"\\x1b[H\\x1b[2J\";\r\n+            break;\r\n+        case ClearBufferType::Scrollback:\r\n+            command = L\"\\x1b[3J\";\r\n+            break;\r\n+        case ClearBufferType::All:\r\n+            command = L\"\\x1b[H\\x1b[2J\\x1b[3J\";\r\n+            break;\r\n+        }\r\n+\r\n         {\r\n             const auto lock = _terminal->LockForWriting();\r\n-            _terminal->EraseScrollback();\r\n+            _terminal->Write(command);\r\n         }\r\n \r\n         if (clearType == Control::ClearBufferType::Screen || clearType == Control::ClearBufferType::All)\r\n         {\r\n-            // Send a signal to conpty to clear the buffer.\r\n             if (auto conpty{ _connection.try_as<TerminalConnection::ConptyConnection>() })\r\n             {\r\n-                // ConPTY will emit sequences to sync up our buffer with its new\r\n-                // contents.\r\n+                // Since the clearing of ConPTY occurs asynchronously, this call can result weird issues,\r\n+                // where a console application still sees contents that we've already deleted, etc.\r\n+                // The correct way would be for ConPTY to emit the appropriate CSI n J sequences.\r\n                 conpty.ClearBuffer();\r\n             }\r\n         }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c5876e1497c..4b855b02f6c 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -209,12 +209,6 @@ void Terminal::SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle)\n     engine.Dispatch().SetCursorStyle(cursorStyle);\r\n }\r\n \r\n-void Terminal::EraseScrollback()\r\n-{\r\n-    auto& engine = reinterpret_cast<OutputStateMachineEngine&>(_stateMachine->Engine());\r\n-    engine.Dispatch().EraseInDisplay(DispatchTypes::EraseType::Scrollback);\r\n-}\r\n-\r\n bool Terminal::IsXtermBracketedPasteModeEnabled() const noexcept\r\n {\r\n     return _systemMode.test(Mode::BracketedPaste);\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..ae7c2dbe168 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -94,7 +94,6 @@ class Microsoft::Terminal::Core::Terminal final :\n     void UpdateAppearance(const winrt::Microsoft::Terminal::Core::ICoreAppearance& appearance);\r\n     void SetFontInfo(const FontInfo& fontInfo);\r\n     void SetCursorStyle(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::CursorStyle cursorStyle);\r\n-    void EraseScrollback();\r\n     bool IsXtermBracketedPasteModeEnabled() const noexcept;\r\n     std::wstring_view GetWorkingDirectory() noexcept;\r\n \r\ndiff --git a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\nindex 4620afae09a..e018e1fd2ad 100644\n--- a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n@@ -304,9 +304,9 @@ namespace ControlUnitTests\n \r\n         Log::Comment(L\"Check the buffer after the clear\");\r\n         VERIFY_ARE_EQUAL(20, core->_terminal->GetViewport().Height());\r\n-        VERIFY_ARE_EQUAL(21, core->ScrollOffset());\r\n+        VERIFY_ARE_EQUAL(41, core->ScrollOffset());\r\n         VERIFY_ARE_EQUAL(20, core->ViewHeight());\r\n-        VERIFY_ARE_EQUAL(41, core->BufferHeight());\r\n+        VERIFY_ARE_EQUAL(61, core->BufferHeight());\r\n \r\n         // In this test, we can't actually check if we cleared the buffer\r\n         // contents. ConPTY will handle the actual clearing of the buffer\r\ndiff --git a/src/host/PtySignalInputThread.cpp b/src/host/PtySignalInputThread.cpp\nindex 45860f9c1a0..fa3893b4dd0 100644\n--- a/src/host/PtySignalInputThread.cpp\n+++ b/src/host/PtySignalInputThread.cpp\n@@ -7,6 +7,7 @@\n \r\n #include \"output.h\"\r\n #include \"handle.h\"\r\n+#include \"_stream.h\"\r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n \r\n using namespace Microsoft::Console;\r\n@@ -197,7 +198,9 @@ void PtySignalInputThread::_DoClearBuffer() const\n     }\r\n \r\n     auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-    THROW_IF_FAILED(gci.GetActiveOutputBuffer().ClearBuffer());\r\n+    auto& screenInfo = gci.GetActiveOutputBuffer();\r\n+    auto& stateMachine = screenInfo.GetStateMachine();\r\n+    stateMachine.ProcessString(L\"\\x1b[H\\x1b[2J\");\r\n }\r\n \r\n void PtySignalInputThread::_DoShowHide(const ShowHideData& data)\r\ndiff --git a/src/host/screenInfo.cpp b/src/host/screenInfo.cpp\nindex 8d5e9217246..3e1ae49d4b3 100644\n--- a/src/host/screenInfo.cpp\n+++ b/src/host/screenInfo.cpp\n@@ -2129,38 +2129,6 @@ void SCREEN_INFORMATION::SetViewport(const Viewport& newViewport,\n     Tracing::s_TraceWindowViewport(_viewport);\r\n }\r\n \r\n-// Method Description:\r\n-// - Clear the entire contents of the viewport, except for the cursor's row,\r\n-//   which is moved to the top line of the viewport.\r\n-// - This is used exclusively by ConPTY to support GH#1193, GH#1882. This allows\r\n-//   a terminal to clear the contents of the ConPTY buffer, which is important\r\n-//   if the user would like to be able to clear the terminal-side buffer.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT SCREEN_INFORMATION::ClearBuffer()\r\n-{\r\n-    // Rotate the buffer to bring the cursor row to the top of the viewport.\r\n-    const auto cursorPos = _textBuffer->GetCursor().GetPosition();\r\n-    for (auto i = 0; i < cursorPos.y; i++)\r\n-    {\r\n-        _textBuffer->IncrementCircularBuffer();\r\n-    }\r\n-\r\n-    // Erase everything below that point.\r\n-    RETURN_IF_FAILED(SetCursorPosition({ 0, 1 }, false));\r\n-    auto& engine = reinterpret_cast<OutputStateMachineEngine&>(_stateMachine->Engine());\r\n-    engine.Dispatch().EraseInDisplay(DispatchTypes::EraseType::ToEnd);\r\n-\r\n-    // Restore the original cursor x offset, but now on the first row.\r\n-    RETURN_IF_FAILED(SetCursorPosition({ cursorPos.x, 0 }, false));\r\n-\r\n-    _textBuffer->TriggerRedrawAll();\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n // Routine Description:\r\n // - Writes cells to the output buffer at the cursor position.\r\n // Arguments:\r\ndiff --git a/src/host/screenInfo.hpp b/src/host/screenInfo.hpp\nindex 4ecd1a4e3e9..c7685cb1c06 100644\n--- a/src/host/screenInfo.hpp\n+++ b/src/host/screenInfo.hpp\n@@ -203,8 +203,6 @@ class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console\n     void SetDefaultAttributes(const TextAttribute& attributes,\r\n                               const TextAttribute& popupAttributes);\r\n \r\n-    [[nodiscard]] HRESULT ClearBuffer();\r\n-\r\n     void UpdateBottom();\r\n \r\n     FontInfo& GetCurrentFont() noexcept;\r\n", "test_patch": "", "problem_statement": "Clear Buffer is broken in Windows Terminal Preview (1.22.2362.0)\n### Windows Terminal version\r\n\r\n1.22.2362.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.4037\r\n\r\n### Steps to reproduce\r\n\r\n* Settings -> Actions -> Add New -> Add \"Ctrl+l\" (lowercase L) for \"Clear Buffer\". Press Save.\r\n* Open tab with \"Command Prompt\".\r\n* Execute \"cd C:\\Windows\". Execute \"dir\" several times to fill the screen.\r\n* Press Ctrl+l (lowercase L).\r\n\r\n### Expected Behavior\r\n\r\nClear Buffer works fine in Windows Terminal v.1.20.11781.0.\r\n\r\n### Actual Behavior\r\n\r\nClear Buffer does not work in Windows Terminal Preview v.1.22.2362.0.\r\n\r\nThe same problem can be reproduced with \"Ubuntu 24.04 LTS\" tab (WSL2).\r\n\r\nI've just noticed that pressing Ctrl+Shift+L works differently from Ctrl+L (but still broken). And I didn't assign Ctrl+Shift+L to anything.\n", "hints_text": "@lhecker Didn't we fix this during the original #17510? I could have swore that I filed that, but I can't find it now\n@valiko-ua it's not the key binding. In `1.22.2362` the `Clear buffer` doesn't work. Fill the buffer with data and invoke the command  via `ctrl+shift+p`. It won't clear the buffer!\nI think the problem is explained by the comment here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/544452dad41d05b865f1fa1d665397befaa9ec2b/src/cascadia/TerminalControl/ControlCore.cpp#L2232-L2238\r\n\r\nIn the past when you asked conpty to clear its buffer, the vtengine would have pushed back an update that also cleared the buffer in the connected terminal, but that's not happening anymore. On the conhost side, the `ClearBuffer` signal is handled here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/544452dad41d05b865f1fa1d665397befaa9ec2b/src/host/PtySignalInputThread.cpp#L185-L201\r\n\r\nWhich just calls the `SCREEN_INFORMATION` class here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/544452dad41d05b865f1fa1d665397befaa9ec2b/src/host/screenInfo.cpp#L2142-L2162\r\n\r\nThat's just going to clear the conhost buffer. As far as I can see, there's nothing in that code that will emit sequences to sync it up with the terminal buffer.", "created_at": "2024-09-09 16:54:05", "merge_commit_sha": "4259ce535f35cc27d4442c3968221107d9c4e928", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17853", "base_commit": "17a55da0f9889aafd84df024299982e7b94f5482", "patch": "diff --git a/src/host/VtIo.cpp b/src/host/VtIo.cpp\nindex 026010b2f70..d64d142d210 100644\n--- a/src/host/VtIo.cpp\n+++ b/src/host/VtIo.cpp\n@@ -6,6 +6,7 @@\n \r\n #include <til/unicode.h>\r\n \r\n+#include \"directio.h\"\r\n #include \"handle.h\" // LockConsole\r\n #include \"output.h\" // CloseConsoleProcessState\r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n@@ -790,3 +791,51 @@ void VtIo::Writer::WriteInfos(til::point target, std::span<const CHAR_INFO> info\n         } while (--repeat);\r\n     }\r\n }\r\n+\r\n+void VtIo::Writer::WriteScreenInfo(SCREEN_INFORMATION& newContext, til::size oldSize) const\r\n+{\r\n+    const auto area = static_cast<size_t>(oldSize.width * oldSize.height);\r\n+\r\n+    auto& main = newContext.GetMainBuffer();\r\n+    auto& alt = newContext.GetActiveBuffer();\r\n+    const auto hasAltBuffer = &alt != &main;\r\n+\r\n+    // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n+    if (oldSize != main.GetBufferSize().Dimensions())\r\n+    {\r\n+        THROW_IF_NTSTATUS_FAILED(main.ResizeTraditional(oldSize));\r\n+        main.SetViewportSize(&oldSize);\r\n+    }\r\n+    if (hasAltBuffer && oldSize != alt.GetBufferSize().Dimensions())\r\n+    {\r\n+        THROW_IF_NTSTATUS_FAILED(alt.ResizeTraditional(oldSize));\r\n+        alt.SetViewportSize(&oldSize);\r\n+    }\r\n+\r\n+    const auto request = Viewport::FromDimensions({}, oldSize);\r\n+    Viewport read;\r\n+    til::small_vector<CHAR_INFO, 1024> infos;\r\n+    infos.resize(area, CHAR_INFO{ L' ', FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED });\r\n+\r\n+    const auto dumpScreenInfo = [&](SCREEN_INFORMATION& screenInfo) {\r\n+        THROW_IF_FAILED(ReadConsoleOutputWImplHelper(screenInfo, infos, request, read));\r\n+        for (til::CoordType i = 0; i < oldSize.height; i++)\r\n+        {\r\n+            WriteInfos({ 0, i }, { infos.begin() + i * oldSize.width, static_cast<size_t>(oldSize.width) });\r\n+        }\r\n+\r\n+        WriteCUP(screenInfo.GetTextBuffer().GetCursor().GetPosition());\r\n+        WriteAttributes(screenInfo.GetAttributes());\r\n+        WriteDECTCEM(screenInfo.GetTextBuffer().GetCursor().IsVisible());\r\n+        WriteDECAWM(WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n+    };\r\n+\r\n+    WriteASB(false);\r\n+    dumpScreenInfo(main);\r\n+\r\n+    if (hasAltBuffer)\r\n+    {\r\n+        WriteASB(true);\r\n+        dumpScreenInfo(alt);\r\n+    }\r\n+}\r\ndiff --git a/src/host/VtIo.hpp b/src/host/VtIo.hpp\nindex a5d13764261..4e9d250c4cf 100644\n--- a/src/host/VtIo.hpp\n+++ b/src/host/VtIo.hpp\n@@ -44,6 +44,7 @@ namespace Microsoft::Console::VirtualTerminal\n             void WriteWindowTitle(std::wstring_view title) const;\r\n             void WriteAttributes(const TextAttribute& attributes) const;\r\n             void WriteInfos(til::point target, std::span<const CHAR_INFO> infos) const;\r\n+            void WriteScreenInfo(SCREEN_INFORMATION& newContext, til::size oldSize) const;\r\n \r\n         private:\r\n             VtIo* _io = nullptr;\r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex cb3c80d7bbb..81701a9f874 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -487,49 +487,8 @@ void ApiRoutines::SetConsoleActiveScreenBufferImpl(SCREEN_INFORMATION& newContex\n \r\n         if (auto writer = gci.GetVtWriter())\r\n         {\r\n-            const auto viewport = gci.GetActiveOutputBuffer().GetBufferSize();\r\n-            const auto size = viewport.Dimensions();\r\n-            const auto area = static_cast<size_t>(viewport.Width() * viewport.Height());\r\n-\r\n-            auto& main = newContext.GetMainBuffer();\r\n-            auto& alt = newContext.GetActiveBuffer();\r\n-            const auto hasAltBuffer = &alt != &main;\r\n-\r\n-            // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n-            THROW_IF_NTSTATUS_FAILED(main.ResizeTraditional(size));\r\n-            main.SetViewportSize(&size);\r\n-            if (hasAltBuffer)\r\n-            {\r\n-                THROW_IF_NTSTATUS_FAILED(alt.ResizeTraditional(size));\r\n-                alt.SetViewportSize(&size);\r\n-            }\r\n-\r\n-            Viewport read;\r\n-            til::small_vector<CHAR_INFO, 1024> infos;\r\n-            infos.resize(area, CHAR_INFO{ L' ', FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED });\r\n-\r\n-            const auto dumpScreenInfo = [&](SCREEN_INFORMATION& screenInfo) {\r\n-                THROW_IF_FAILED(ReadConsoleOutputWImpl(screenInfo, infos, viewport, read));\r\n-                for (til::CoordType i = 0; i < size.height; i++)\r\n-                {\r\n-                    writer.WriteInfos({ 0, i }, { infos.begin() + i * size.width, static_cast<size_t>(size.width) });\r\n-                }\r\n-\r\n-                writer.WriteCUP(screenInfo.GetTextBuffer().GetCursor().GetPosition());\r\n-                writer.WriteAttributes(screenInfo.GetAttributes());\r\n-                writer.WriteDECTCEM(screenInfo.GetTextBuffer().GetCursor().IsVisible());\r\n-                writer.WriteDECAWM(WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n-            };\r\n-\r\n-            writer.WriteASB(false);\r\n-            dumpScreenInfo(main);\r\n-\r\n-            if (hasAltBuffer)\r\n-            {\r\n-                writer.WriteASB(true);\r\n-                dumpScreenInfo(alt);\r\n-            }\r\n-\r\n+            const auto oldSize = gci.GetActiveOutputBuffer().GetBufferSize().Dimensions();\r\n+            writer.WriteScreenInfo(newContext, oldSize);\r\n             writer.Submit();\r\n         }\r\n \r\ndiff --git a/src/server/ObjectHandle.cpp b/src/server/ObjectHandle.cpp\nindex 1fbf69976fc..64f2d51a4c5 100644\n--- a/src/server/ObjectHandle.cpp\n+++ b/src/server/ObjectHandle.cpp\n@@ -273,7 +273,18 @@ INPUT_READ_HANDLE_DATA* ConsoleHandleData::GetClientInput() const\n     LOG_IF_FAILED(pScreenInfo->FreeIoHandle(this));\r\n     if (!pScreenInfo->HasAnyOpenHandles())\r\n     {\r\n+        auto& gci = Microsoft::Console::Interactivity::ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        const auto oldSize = gci.GetActiveOutputBuffer().GetBufferSize().Dimensions();\r\n+        auto writer = gci.GetVtWriter();\r\n+\r\n         SCREEN_INFORMATION::s_RemoveScreenBuffer(pScreenInfo);\r\n+\r\n+        if (writer && gci.HasActiveOutputBuffer())\r\n+        {\r\n+            auto& newContext = gci.GetActiveOutputBuffer();\r\n+            writer.WriteScreenInfo(newContext, oldSize);\r\n+            writer.Submit();\r\n+        }\r\n     }\r\n \r\n     return S_OK;\r\n", "test_patch": "", "problem_statement": "Original console buffer is not restored when closing a secondary one\n### Windows Terminal version\r\n\r\n1.22.240823002-preview\r\n\r\n### Windows build number\r\n\r\n10.0.19045\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nReduced test code (by lhecker): \r\n```cpp\r\n#define WIN32_LEAN_AND_MEAN\r\n#include <Windows.h>\r\n\r\nint main() {\r\n    const auto buffer = CreateConsoleScreenBuffer(GENERIC_READ | GENERIC_WRITE, 0, nullptr, CONSOLE_TEXTMODE_BUFFER, nullptr);\r\n    SetConsoleActiveScreenBuffer(buffer);\r\n    CloseHandle(buffer);\r\n    return 0;\r\n}\r\n```\r\n\r\n---\r\n\r\nRun a program which creates and activates a new console screen buffer using `CreateConsoleScreenBuffer` and `SetConsoleActiveScreenBuffer`.\r\n\r\nThe following C program with argument value 0-4 does all combos:\r\n```\r\n// usage: *argv 0|1|2|3|4\r\n// create+activate new screen buffer, print a message to it, sleep 1s, then before exit:\r\n//   0: do nothing.\r\n//   1: CloseHandle(newbuf).\r\n//   2: SetConsoleActiveScreenBuffer(orig_con)\r\n//   3: CloseHandle(newbuf), SetConsoleActiveScreenBuffer(orig_con)\r\n//   4: SetConsoleActiveScreenBuffer(orig_con), CloseHandle(newbuf)\r\n```\r\n\r\n<details>\r\n<summary>newbuf.c</summary>\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <string.h>\r\n#include <stdlib.h>\r\n#include <windows.h>\r\n\r\n\r\n#define writecon(h, s) WriteConsole(h, (s), strlen(s), 0, 0)\r\n#define ERR_EXIT(...) (fprintf(stderr, __VA_ARGS__), exit(1), 0)\r\n\r\n// usage: *argv 0|1|2|3|4\r\n// create+activate new screen buffer, print a message to it, sleep 1s, then before exit:\r\n//   0: do nothing.\r\n//   1: CloseHandle(newbuf).\r\n//   2: SetConsoleActiveScreenBuffer(orig_con)\r\n//   3: CloseHandle(newbuf), SetConsoleActiveScreenBuffer(orig_con)\r\n//   4: SetConsoleActiveScreenBuffer(orig_con), CloseHandle(newbuf)\r\n\r\nint main(int argc, char **argv)\r\n{\r\n\tint mode = argc > 1 ? atoi(argv[1]) : 0;\r\n\r\n\tHANDLE hcon = GetStdHandle(STD_OUTPUT_HANDLE);\r\n\tif (hcon == INVALID_HANDLE_VALUE)\r\n\t\tERR_EXIT(\"can't get stdout handle\\n\");\r\n\r\n\tif (!writecon(hcon, \"orig screen buffer\\n\"))\r\n\t\tERR_EXIT(\"can't write to stdout console\\n\");\r\n\r\n\tHANDLE hnewbuf = CreateConsoleScreenBuffer(\r\n\t\tGENERIC_WRITE, FILE_SHARE_WRITE,\r\n\t\t0, CONSOLE_TEXTMODE_BUFFER, 0);\r\n\tif (hnewbuf == INVALID_HANDLE_VALUE)\r\n\t\tERR_EXIT(\"can't create new screen buf\\n\");\r\n\r\n\tif (!SetConsoleActiveScreenBuffer(hnewbuf))\r\n\t\tERR_EXIT(\"can't activete new screen buf\\n\");\r\n\r\n\tif (!writecon(hnewbuf, \"new screen buffer\\n\"))\r\n\t\tERR_EXIT(\"can't write to new screen buf\\n\");\r\n\r\n\tSleep(1000);\r\n\r\n\t// all combos of \"close new buf\" and \"restore orig buff\", + reverse order.\r\n\t//\r\n\t// expected result:\r\n\t// - all combos restore the original buf on exit (maybe implicitly)\r\n\t//\r\n\t// actual result:\r\n\t// - Working as expected in conhost.exe or OpenConsole.exe (including 1.22)\r\n\t//   or Windows Terminal (up to and including 1.21).\r\n\t//\r\n\t// - in Windows Terminal 1.22: only 2 and 4 work as expected\r\n\t//   (\"restore orig buf\" without or before \"close new buf\")\r\n\t//   - 0: no close and no manual restore: not restored.\r\n\t//   - 1: close only: not restored.\r\n\t//   - 3: close and restored manually: not restored.\r\n\r\n\tswitch (mode) {\r\n\t\tcase 0:\r\n\t\t\tbreak;\r\n\r\n\t\tcase 1:\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tbreak;\r\n\r\n\t\tcase 2:\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tbreak;\r\n\r\n\t\tcase 3:\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tbreak;\r\n\r\n\t\tcase 4:  // like 3 but in reverse order\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tbreak;\r\n\t}\r\n\r\n\treturn 0;\r\n}\r\n```\r\n\r\n</details>\r\n\r\n\r\n\r\n### Expected Behavior\r\n\r\nOriginal screen buffer is restored when the application exits (its content and original cursor position), regardless if the new screen buffer handle is closed or not, and regardless if the original screen buffer is re-activated before exit.\r\n\r\n### Actual Behavior\r\n\r\nNo issue in conhost.exe or OpenConsole.exe (even of 1.22), or Windows terminal up to and including 1.21.\r\n\r\nWith Windows terminal 1.22 (preview):\r\n- The original screen buffer is only restored if `SetConsoleActiveScreenBuffer(orig_con)` is invoked without or before `CloseHandle(h_newbuf)`.\r\n- Specifically, it's not restored if:\r\n  - Neither `CloseHandle` nor `SetConsoleActiveScreenBuffer(orig_con)` are used.\r\n  - Only `CloseHandle` is used.\r\n  - Both `CloseHandle` and `SetConsoleActiveScreenBuffer(orig_con)` are used in that order.\n", "hints_text": "> [zadjii-msft](https://github.com/zadjii-msft) added this to the [Terminal v1.23](https://github.com/microsoft/terminal/milestone/57) milestone\r\n\r\nWhile it's not mine to decide, and personally I can wait for a build with this fixed, I'd think it would be nice to fix it in 1.22, because it's still relatively early and only one preview build was released of 1.22, and it does affect the default behavior of existing applications, such as `less.exe`, and I'm guessing possibly more editors and pagers.\nThe milestone for us just indicates in what period we're working on it. Now that 1.22 was released we're in the 1.23 development period and so on. We usually spend the beginning of each period for fixing bugs in the just released versions. That will also be the case for this issue.\r\n\r\nIn short, I'm going to fix this soon. \ud83d\ude42\n> Now that 1.22 was released\r\n\r\nWas it?\r\n\r\nYesterday 1.21 had the first stable release: \"Terminal 1.21 is finally stable!...\". and 1.22 had the first preview build.\r\n\r\nDoesn't that mean that 1.21 is now ready for most users, but that there's still work to bugfix before 1.22 becomes stable and ready for public consumption? I.e. that \"stable\" is for most users, and that \"preview\" is for early adopters which can test it and report issues which would hopefully get fixed before 1.22 is considered \"Ready\" and distributed to the larger public?\r\n\r\nThe store page says about \"Windows Terminal Preview\":\r\n> This is the preview build of the Windows Terminal, which contains the latest features as they are developed.\r\n\r\nI.e. that there's still work to be done before the preview version is considered \"ready\"?\r\n\r\n> In short, I'm going to fix this soon. \ud83d\ude42\r\n\r\nThat's nice, though my main concern was/is that there would be a \"stable\" version which is distributed to a large number of people which has this issue...\r\n\r\nOr am I missing something with the \"stable\"/\"preview\" terminology and/or pipeline?\n> which contains the latest features as they are developed\r\n\r\nThis could be rephrased to something like \"contains the latest features that we think are ready, but may not be entirely stable yet\" (though there's a philosophical question about whether any software is ever truly \"stable\", as pretty much all software contains bugs \ud83d\ude04).\r\n\r\nBasically, both \"Windows Terminal\" (current version `1.21.x`) and \"Windows Terminal Preview\" (current version `1.22.x`) receive bugfixes, but new features are developed for the main branch. The Preview version can be used by anyone but is more likely to have issues, especially shortly after a release.\n> Basically, both \"Windows Terminal\" (current version `1.21.x`) and \"Windows Terminal Preview\" (current version `1.22.x`) receive bugfixes, but new features are developed for the main branch. The Preview version can be used by anyone but is more likely to have issues, especially shortly after a release.\r\n\r\nYeah, that's what I thought too.\r\n\r\nSo do you consider \"restore screen buffer correctly like it behaved in 1.21\" a new feature?\r\n\r\nTo me that's more like a bugfix in 1.22. Is it not?\r\n\r\n(that's not to say that it must be fixed in 1.22. I marely expressed hope that it could get fixed in 1.22 before it becomes stable).\nWell, I would certainly consider it a bugfix (though I'm not part of the team), but I think the point is that the milestone just indicates that the fix will be *developed* on the branch for 1.23. It would then presumably be cherry-picked or backported to 1.22 assuming the fix isn't riskier than the impact of the bug.\n> It would then presumably be cherry-picked or backported to 1.22 assuming the fix isn't riskier than the impact of the bug.\r\n\r\nRight. That was my missing link. That makes sense to me. Thanks.\nThat's all correct.\r\n\r\n* This regressed in 1.22\r\n* 1.22 was released to preview this week\r\n* Preview builds are \"mostly ready but likely with more bugs than stable\" (and is typically high enough quality to be a daily driver)\r\n* This bug is in the 1.23 milestone (which just tracks _when_ we will work on it)\r\n* This one is tagged up for servicing back to 1.22. \r\n  * The project board that shows servicing bugs isn't publicly visible, but we're also actively working on updating that to make it cleaner. So it doesn't really need to be public to see our WIP on that. \nI'm on 1.21 and I can't get the buffer to restore. Open windows from a previous session is set. Am I doing something wrong?\n> Open windows from a previous session is set.\r\n\r\nThis issue is not about restoring the content from a previous session when opening a new terminal window.\r\n\r\nIt's about restoring the screen content after an application (like an editor, or pager) creates and works in a new screen buffer, and then exits.\r\n\n@richardeid If you still have this issue, please open a discussion or open another issue. We'll then try to help you.\n@lhecker I think I misunderstood what this was. I was expecting my console history to restore. Thank you for following up", "created_at": "2024-09-03 16:31:47", "merge_commit_sha": "4eb06fee07910f95b034386849c535c26ebcb224", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17852", "base_commit": "17a55da0f9889aafd84df024299982e7b94f5482", "patch": "diff --git a/src/host/settings.cpp b/src/host/settings.cpp\nindex e2dd84b78e7..0df97dbd354 100644\n--- a/src/host/settings.cpp\n+++ b/src/host/settings.cpp\n@@ -36,7 +36,7 @@ Settings::Settings() :\n     _bAutoPosition(true),\r\n     _uHistoryBufferSize(DEFAULT_NUMBER_OF_COMMANDS),\r\n     _uNumberOfHistoryBuffers(DEFAULT_NUMBER_OF_BUFFERS),\r\n-    _bHistoryNoDup(false),\r\n+    _bHistoryNoDup(true),\r\n     // ColorTable initialized below\r\n     _uCodePage(ServiceLocator::LocateGlobals().uiOEMCP),\r\n     _uScrollScale(1),\r\n@@ -110,7 +110,7 @@ void Settings::ApplyDesktopSpecificDefaults()\n     _bQuickEdit = TRUE;\r\n     _uHistoryBufferSize = 50;\r\n     _uNumberOfHistoryBuffers = 4;\r\n-    _bHistoryNoDup = FALSE;\r\n+    _bHistoryNoDup = true;\r\n \r\n     _renderSettings.ResetColorTable();\r\n \r\ndiff --git a/src/propsheet/registry.cpp b/src/propsheet/registry.cpp\nindex 64d392aa76d..3a7283e080e 100644\n--- a/src/propsheet/registry.cpp\n+++ b/src/propsheet/registry.cpp\n@@ -79,7 +79,7 @@ VOID InitRegistryValues(\n     pStateInfo->CursorSize = 25;\r\n     pStateInfo->HistoryBufferSize = 25;\r\n     pStateInfo->NumberOfHistoryBuffers = 4;\r\n-    pStateInfo->HistoryNoDup = 0;\r\n+    pStateInfo->HistoryNoDup = 1;\r\n \r\n     // clang-format off\r\n     if (pStateInfo->fIsV2Console)\r\n", "test_patch": "", "problem_statement": "Command History (F7) is added to when selected command from the list\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.4037\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a clean command prompt - nothing in the list in F7.\r\n2. Type in a command, e.g. \"dir\"\r\n3. Type in a second different command, e.g. \"dir D*\"\r\n4. Press F7 to see the command list - it will contain two commands. Select the first one from the list.\r\n5. Press F7 to see the command list again, it will now contain three commands. This is unexpected. \n\n### Expected Behavior\n\nSelecting the command from the command list was previously (in Windows 10 command prompt) the way you issued it to ensure it didn't get added to the history, thus allowing you to maintain a nice tidy command list.\n\n### Actual Behavior\n\nInstead it was added to the history.\n", "hints_text": "", "created_at": "2024-09-03 15:33:21", "merge_commit_sha": "5fdfd51209fc681e66657d6697ce031bc4319619", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17802", "base_commit": "f93347ed4bbeea0d9e663f2069994d9e2d069f10", "patch": "diff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 9f51aadf00d..ffd9ec72af0 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -86,7 +86,7 @@ void Terminal::SetWindowTitle(const std::wstring_view title)\n     _assertLocked();\r\n     if (!_suppressApplicationTitle)\r\n     {\r\n-        _title.emplace(title);\r\n+        _title.emplace(title.empty() ? _startingTitle : title);\r\n         _pfnTitleChanged(_title.value());\r\n     }\r\n }\r\n", "test_patch": "", "problem_statement": "Reset title sequences have stopped working in Windows Termial\n### Windows Terminal version\n\nCommit f93347ed4bbeea0d9e663f2069994d9e2d069f10\n\n### Windows build number\n\n10.0.19045.4780\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a WSL bash shell in a recent build of Windows Terminal (I suspect it needs to be 450eec48de252a3a8d270bade847755ecbeb5a75 or later).\r\n2. Make sure your shell isn't configured to set the title itself.\r\n3. Set the title with an OSC 0 sequence: `printf \"\\e]0;Test\\e\\\\\"`\r\n4. Note that the title has changed.\r\n5. Reset the title with a blank OSC 0 sequence: `printf \"\\e]0\\e\\\\\"`\n\n### Expected Behavior\n\nThe title should be reset to its starting value. This works correctly in Terminal Preview and also in current builds of OpenConsole.\n\n### Actual Behavior\n\nThe title is just set to a blank value. The same problem occurs with the `DECSWT` title sequence too.\n", "hints_text": "We've found some similar issues:\n\n\n- #16784 , similarity score: 83%\n  \n\nIf any of the above are duplicates, please consider closing this issue out and adding additional context in the original issue.\n\n> Note: You can give me feedback by \ud83d\udc4d or \ud83d\udc4e this comment.\nNice find Mr Bot, but I fixed that issue, and now it's regressed again.", "created_at": "2024-08-26 10:19:58", "merge_commit_sha": "1f71568c2a60fa7ec3549e72bc1c8c47c7033b29", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17786", "base_commit": "6dd9c468ebc77e0025939b32fb927e85f3172b25", "patch": "diff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex d8d975f667c..357b43c1aa1 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -98,7 +98,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         Connection(connection);\r\n \r\n         _terminal->SetWriteInputCallback([this](std::wstring_view wstr) {\r\n-            _sendInputToConnection(wstr);\r\n+            _pendingResponses.append(wstr);\r\n         });\r\n \r\n         // GH#8969: pre-seed working directory to prevent potential races\r\n@@ -419,6 +419,17 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Return Value:\r\n     // - <none>\r\n     void ControlCore::_sendInputToConnection(std::wstring_view wstr)\r\n+    {\r\n+        _connection.WriteInput(winrt_wstring_to_array_view(wstr));\r\n+    }\r\n+\r\n+    // Method Description:\r\n+    // - Writes the given sequence as input to the active terminal connection,\r\n+    // Arguments:\r\n+    // - wstr: the string of characters to write to the terminal connection.\r\n+    // Return Value:\r\n+    // - <none>\r\n+    void ControlCore::SendInput(const std::wstring_view wstr)\r\n     {\r\n         if (wstr.empty())\r\n         {\r\n@@ -435,21 +446,10 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         else\r\n         {\r\n-            _connection.WriteInput(winrt_wstring_to_array_view(wstr));\r\n+            _sendInputToConnection(wstr);\r\n         }\r\n     }\r\n \r\n-    // Method Description:\r\n-    // - Writes the given sequence as input to the active terminal connection,\r\n-    // Arguments:\r\n-    // - wstr: the string of characters to write to the terminal connection.\r\n-    // Return Value:\r\n-    // - <none>\r\n-    void ControlCore::SendInput(const std::wstring_view wstr)\r\n-    {\r\n-        _sendInputToConnection(wstr);\r\n-    }\r\n-\r\n     bool ControlCore::SendCharEvent(const wchar_t ch,\r\n                                     const WORD scanCode,\r\n                                     const ::Microsoft::Terminal::Core::ControlKeyStates modifiers)\r\n@@ -485,7 +485,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -643,7 +643,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -662,7 +662,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -1412,7 +1412,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n \r\n         // It's important to not hold the terminal lock while calling this function as sending the data may take a long time.\r\n-        _sendInputToConnection(filtered);\r\n+        SendInput(filtered);\r\n \r\n         const auto lock = _terminal->LockForWriting();\r\n         _terminal->ClearSelection();\r\n@@ -2107,7 +2107,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // Sending input requires that we're unlocked, because\r\n                     // writing the input pipe may block indefinitely.\r\n                     const auto suspension = _terminal->SuspendLock();\r\n-                    _sendInputToConnection(buffer);\r\n+                    SendInput(buffer);\r\n                 }\r\n             }\r\n         }\r\n@@ -2164,6 +2164,12 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 _terminal->Write(hstr);\r\n             }\r\n \r\n+            if (!_pendingResponses.empty())\r\n+            {\r\n+                _sendInputToConnection(_pendingResponses);\r\n+                _pendingResponses.clear();\r\n+            }\r\n+\r\n             // Start the throttled update of where our hyperlinks are.\r\n             const auto shared = _shared.lock_shared();\r\n             if (shared->outputIdle)\r\n@@ -2480,9 +2486,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out && !out->empty())\r\n         {\r\n-            // _sendInputToConnection() asserts that we aren't in focus mode,\r\n-            // but window focus events are always fine to send.\r\n-            _connection.WriteInput(winrt_wstring_to_array_view(*out));\r\n+            _sendInputToConnection(*out);\r\n         }\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 938d048243b..57484c0b7b7 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -319,6 +319,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         winrt::com_ptr<ControlSettings> _settings{ nullptr };\r\n \r\n         std::shared_ptr<::Microsoft::Terminal::Core::Terminal> _terminal{ nullptr };\r\n+        std::wstring _pendingResponses;\r\n \r\n         // NOTE: _renderEngine must be ordered before _renderer.\r\n         //\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 26daf24e5d2..82e06b03d4a 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -24,7 +24,6 @@ void Terminal::ReturnResponse(const std::wstring_view response)\n {\r\n     if (_pfnWriteInput && !response.empty())\r\n     {\r\n-        const auto suspension = _readWriteLock.suspend();\r\n         _pfnWriteInput(response);\r\n     }\r\n }\r\n", "test_patch": "", "problem_statement": "Low reliability of VT replies\n### Windows Terminal version\r\n\r\nLatest source\r\n\r\n### Windows build number\r\n\r\n10.0.19045.4780\r\n\r\n### Other Software\r\n\r\nNo\r\n\r\n### Steps to reproduce\r\n\r\nI want to query some terminal state, in particular the latest and greatest palette (#17729).\r\nTo do so, I build a bunch of those `\"\\x1b]4;N;?\\x1b\\\\\"`, send them in one go and wait for the reply.\r\nSince I want to support not only the latest nightlies and do not want the older versions to deadlock on unknown queries, I prepend and append another query, the one that even prehistoric versions understand: `\"\\x1b[c\"`.\r\nIf there is something between those DA replies, it must be the one I need.\r\nIf there are only two DA replies, then it is probably not supported.\r\n\r\nThis approach works flawlessly in OpenConsole.\r\nIn WT, however, not so much: way, way too often random parts of the reply are simply missing.\r\n\r\n1. Compile the code:\r\n    \r\n<details>\r\n<summary>Code</summary>\r\n  \r\n```C++\r\n#ifndef _CRT_SECURE_NO_WARNINGS\r\n#define _CRT_SECURE_NO_WARNINGS\r\n#endif\r\n\r\n#ifndef _UNICODE\r\n#define _UNICODE\r\n#endif\r\n\r\n#ifndef UNICODE\r\n#define UNICODE\r\n#endif\r\n\r\n#include <algorithm>\r\n#include <format>\r\n#include <exception>\r\n#include <iostream>\r\n#include <optional>\r\n#include <ranges>\r\n#include <string>\r\n#include <string_view>\r\n\r\n#include <string.h>\r\n\r\n#include <windows.h>\r\n\r\nusing namespace std::literals;\r\n\r\nauto win32_error()\r\n{\r\n\treturn std::runtime_error(std::format(\"Error 0x{:08X}, look it up\"sv, GetLastError()));\r\n};\r\n\r\nauto invalid_response()\r\n{\r\n\treturn std::runtime_error(\"Invalid response\");\r\n}\r\n\r\nauto invalid_response(const size_t Index)\r\n{\r\n\treturn std::runtime_error(std::format(\"Invalid response at #{}\"sv, Index));\r\n}\r\n\r\nauto printable(const std::wstring_view Str)\r\n{\r\n\tstd::wstring Printable;\r\n\tstd::ranges::transform(Str, std::back_inserter(Printable), [](wchar_t Char){ return Char < L' ' ? Char + L'\\u2400' : Char; });\r\n\treturn Printable;\r\n}\r\n\r\nvoid write(const std::wstring_view Str)\r\n{\r\n\tDWORD Written;\r\n\tif (!WriteConsole(GetStdHandle(STD_OUTPUT_HANDLE), Str.data(), static_cast<DWORD>(Str.size()), &Written, {}))\r\n\t\tthrow win32_error();\r\n}\r\n\r\nvoid write(const std::string_view Str)\r\n{\r\n\twrite(std::wstring(Str.begin(), Str.end()));\r\n}\r\n\r\nstd::wstring query(const std::wstring& Command)\r\n{\r\n\tconst auto Dummy = L\"\\x1b[c\"s;\r\n\r\n\twrite(Dummy + Command + Dummy);\r\n\r\n\t// Sleep(1);\r\n\r\n\tstd::wstring Response;\r\n\r\n\tstd::optional<size_t>\r\n\t\tFirstTokenPrefixPos,\r\n\t\tFirstTokenSuffixPos,\r\n\t\tSecondTokenPrefixPos,\r\n\t\tSecondTokenSuffixPos;\r\n\r\n\tconst auto\r\n\t\tTokenPrefix = L\"\\x1b[?\"sv,\r\n\t\tTokenSuffix = L\"c\"sv;\r\n\r\n\twhile (!SecondTokenSuffixPos)\r\n\t{\r\n\t\twchar_t ResponseBuffer[8192];\r\n\t\tDWORD ResponseSize;\r\n\r\n\t\tif (!ReadConsole(GetStdHandle(STD_INPUT_HANDLE), ResponseBuffer, ARRAYSIZE(ResponseBuffer),  &ResponseSize, {}))\r\n\t\t\tthrow win32_error();\r\n\r\n\t\tResponse.append(ResponseBuffer, ResponseSize);\r\n\r\n\t\tif (!FirstTokenPrefixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenPrefix); Pos != Response.npos)\r\n\t\t\t\tFirstTokenPrefixPos = Pos;\r\n\r\n\t\tif (FirstTokenPrefixPos && !FirstTokenSuffixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenSuffix, *FirstTokenPrefixPos + TokenPrefix.size()); Pos != Response.npos)\r\n\t\t\t\tFirstTokenSuffixPos = Pos;\r\n\r\n\t\tif (FirstTokenSuffixPos && !SecondTokenPrefixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenPrefix, *FirstTokenSuffixPos + TokenSuffix.size()); Pos != Response.npos)\r\n\t\t\t\tSecondTokenPrefixPos = Pos;\r\n\r\n\t\tif (SecondTokenPrefixPos && !SecondTokenSuffixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenSuffix, *SecondTokenPrefixPos + TokenPrefix.size()); Pos != Response.npos)\r\n\t\t\t\tSecondTokenSuffixPos = Pos;\r\n\t}\r\n\r\n\tResponse.resize(*SecondTokenPrefixPos);\r\n\tResponse.erase(0, *FirstTokenSuffixPos + TokenSuffix.size());\r\n\r\n\tif (Response.empty())\r\n\t\tthrow std::runtime_error(\"Query is not supported\"s);\r\n\r\n\treturn Response;\r\n}\r\n\r\nvoid set_modes()\r\n{\r\n\tconst auto\r\n\t\tIn = GetStdHandle(STD_INPUT_HANDLE),\r\n\t\tOut = GetStdHandle(STD_OUTPUT_HANDLE);\r\n\r\n\tDWORD InMode;\r\n\tif (!GetConsoleMode(In, &InMode))\r\n\t\tthrow win32_error();\r\n\r\n\tif (!SetConsoleMode(In, (InMode & ~(ENABLE_LINE_INPUT | ENABLE_ECHO_INPUT | ENABLE_QUICK_EDIT_MODE)) | ENABLE_MOUSE_INPUT | ENABLE_EXTENDED_FLAGS | ENABLE_VIRTUAL_TERMINAL_INPUT))\r\n\t\tthrow win32_error();\r\n\r\n\tDWORD OutMode;\r\n\tif (!GetConsoleMode(Out, &OutMode))\r\n\t\tthrow win32_error();\r\n\r\n\tif (!SetConsoleMode(Out, OutMode | ENABLE_PROCESSED_OUTPUT | ENABLE_VIRTUAL_TERMINAL_PROCESSING))\r\n\t\tthrow win32_error();\r\n}\r\n\r\nint main()\r\n{\r\n\ttry\r\n\t{\r\n\t\tset_modes();\r\n\r\n\t\tstd::wstring Str;\r\n\r\n\t\tfor (size_t i = 0; i != 256; ++i)\r\n\t\t\tstd::format_to(std::back_inserter(Str), L\"\\x1b]4;{};?\\x1b\\\\\"sv, i);\r\n\r\n\t\tfor (;;)\r\n\t\t{\r\n\t\t\tconst auto ReplyData = query(Str);\r\n\r\n\t\t\tstd::wstring_view Reply(ReplyData);\r\n\r\n\t\t\tif (!Reply.ends_with(L\"\\\\\"sv))\r\n\t\t\t\tthrow invalid_response();\r\n\r\n\t\t\tReply.remove_suffix(1);\r\n\r\n\t\t\tsize_t Index = 0;\r\n\r\n\t\t\tfor (const auto& Part: std::views::split(Reply, L\"\\\\\"sv))\r\n\t\t\t{\r\n\t\t\t\tstd::wstring_view ColorStr(Part.begin(), Part.end());\r\n\r\n\t\t\t\ttry\r\n\t\t\t\t{\r\n\t\t\t\t\tif (!ColorStr.starts_with(L\"\\x1b]4;\"sv))\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(L\"\\x1b]4;\"sv.size());\r\n\r\n\t\t\t\t\twchar_t* Ptr;\r\n\t\t\t\t\tconst auto ReportedIndex = std::wcstol(ColorStr.data(), &Ptr, 10);\r\n\r\n\t\t\t\t\tif (Ptr == ColorStr.data())\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tif (ReportedIndex != Index)\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(Ptr - ColorStr.data());\r\n\r\n\t\t\t\t\tconst auto End = ColorStr.find(L\"\\x1b\"sv);\r\n\t\t\t\t\tif (End == ColorStr.npos)\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_suffix(ColorStr.size() - End);\r\n\r\n\t\t\t\t\tif (!ColorStr.starts_with(L\";rgb:\"sv))\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(L\";rgb:\"sv.size());\r\n\r\n\t\t\t\t\tif (ColorStr.size() != L\"ffff/ffff/ffff\"sv.size())\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\t\t\t\t}\r\n\t\t\t\tcatch (const std::runtime_error& e)\r\n\t\t\t\t{\r\n\t\t\t\t\tBeep(500, 200);\r\n\r\n\t\t\t\t\twrite(e.what());\r\n\t\t\t\t\twrite(L\": \"sv);\r\n\t\t\t\t\twrite(printable(ColorStr));\r\n\t\t\t\t\twrite(L\"\\n\"sv);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t++Index;\r\n\t\t\t}\r\n\r\n\t\t\tstd::wcout << L\"Everything is OK\"sv << std::endl;\r\n\r\n\t\t}\r\n\t}\r\n\tcatch (const std::exception& e)\r\n\t{\r\n\t\tstd::cerr << e.what() << std::endl;\r\n\t}\r\n}\r\n```\r\n</details>\r\n\r\n2. Run it in WT.\r\n \r\n\r\n\r\n### Expected Behavior\r\n\r\nThe program should print \"Everything is OK\" in a loop indefinitely and nothing else:\r\n```\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\n...and so on.\r\n```\r\n\r\n### Actual Behavior\r\n\r\nThe program prints \"Everything is OK\" a few times, then it detects errors due to missing bits in the reply, e.g.\r\n```\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nInvalid response at #234: c/1c1c\u241b\r\nEverything is OK\r\n```\r\n\r\nEventually it deadlocks in `ReadConsole`.\r\n\r\nAdding a delay between sending the query and reading the reply improves the situation dramatically, but still not to 100% and it does not feel like the right thing to do: fixing issues with `Sleep(N)` never works in the long term.\r\n\r\nSplitting it to smaller queries also helps, but again, it is guesswork.\r\nOverall it is about 2700 characters to send and about 7000 to receive. It does not look like something humongous by modern standards.\r\n\r\nMoving the mouse or pressing keyboard keys noticeably increases the error rate. Again, only in WT.\r\n\n", "hints_text": "I believe this is caused by #16224. Since the terminal lock isn't held anymore, any thread can write into the input pipe concurrently. In our case that's the VT parser thread sending VT responses and the UI thread sending cursor messages.", "created_at": "2024-08-23 14:14:56", "merge_commit_sha": "b07589e7a87e1d7a2f6144744a59c866c672a78e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17779", "base_commit": "cbb4a0a01cc4d66894e17b39c5b84fdfd0fec261", "patch": "diff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex 7b59babd2e5..f18851c2fbb 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -329,7 +329,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         _touchAnchor = contactPoint;\r\n     }\r\n \r\n-    void ControlInteractivity::PointerMoved(Control::MouseButtonState buttonState,\r\n+    bool ControlInteractivity::PointerMoved(Control::MouseButtonState buttonState,\r\n                                             const unsigned int pointerUpdateKind,\r\n                                             const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                             const bool focused,\r\n@@ -337,11 +337,14 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                             const bool pointerPressedInBounds)\r\n     {\r\n         const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        // Returning true from this function indicates that the caller should do no further processing of this movement.\r\n+        bool handledCompletely = false;\r\n \r\n         // Short-circuit isReadOnly check to avoid warning dialog\r\n         if (focused && !_core->IsInReadOnlyMode() && _canSendVTMouseInput(modifiers))\r\n         {\r\n             _sendMouseEventHelper(terminalPosition, pointerUpdateKind, modifiers, 0, buttonState);\r\n+            handledCompletely = true;\r\n         }\r\n         // GH#4603 - don't modify the selection if the pointer press didn't\r\n         // actually start _in_ the control bounds. Case in point - someone drags\r\n@@ -378,6 +381,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n \r\n         _core->SetHoveredCell(terminalPosition.to_core_point());\r\n+        return handledCompletely;\r\n     }\r\n \r\n     void ControlInteractivity::TouchMoved(const Core::Point newTouchPoint,\r\n@@ -682,13 +686,10 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                                      const SHORT wheelDelta,\r\n                                                      Control::MouseButtonState buttonState)\r\n     {\r\n-        const auto adjustment = _core->ScrollOffset() > 0 ? _core->BufferHeight() - _core->ScrollOffset() - _core->ViewHeight() : 0;\r\n-        // If the click happened outside the active region, just don't send any mouse event\r\n-        if (const auto adjustedY = terminalPosition.y - adjustment; adjustedY >= 0)\r\n-        {\r\n-            return _core->SendMouseEvent({ terminalPosition.x, adjustedY }, pointerUpdateKind, modifiers, wheelDelta, toInternalMouseState(buttonState));\r\n-        }\r\n-        return false;\r\n+        const auto adjustment = _core->BufferHeight() - _core->ScrollOffset() - _core->ViewHeight();\r\n+        // If the click happened outside the active region, core should get a chance to filter it out or clamp it.\r\n+        const auto adjustedY = terminalPosition.y - adjustment;\r\n+        return _core->SendMouseEvent({ terminalPosition.x, adjustedY }, pointerUpdateKind, modifiers, wheelDelta, toInternalMouseState(buttonState));\r\n     }\r\n \r\n     // Method Description:\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 38789827ec3..22eaa95c397 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -58,7 +58,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                             const Core::Point pixelPosition);\r\n         void TouchPressed(const Core::Point contactPoint);\r\n \r\n-        void PointerMoved(Control::MouseButtonState buttonState,\r\n+        bool PointerMoved(Control::MouseButtonState buttonState,\r\n                           const unsigned int pointerUpdateKind,\r\n                           const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                           const bool focused,\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.idl b/src/cascadia/TerminalControl/ControlInteractivity.idl\nindex d1ca9720dc6..926c1e3b0a9 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.idl\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.idl\n@@ -43,12 +43,12 @@ namespace Microsoft.Terminal.Control\n                             Microsoft.Terminal.Core.Point pixelPosition);\r\n         void TouchPressed(Microsoft.Terminal.Core.Point contactPoint);\r\n \r\n-        void PointerMoved(MouseButtonState buttonState,\r\n-                          UInt32 pointerUpdateKind,\r\n-                          Microsoft.Terminal.Core.ControlKeyStates modifiers,\r\n-                          Boolean focused,\r\n-                          Microsoft.Terminal.Core.Point pixelPosition,\r\n-                          Boolean pointerPressedInBounds);\r\n+        Boolean PointerMoved(MouseButtonState buttonState,\r\n+                             UInt32 pointerUpdateKind,\r\n+                             Microsoft.Terminal.Core.ControlKeyStates modifiers,\r\n+                             Boolean focused,\r\n+                             Microsoft.Terminal.Core.Point pixelPosition,\r\n+                             Boolean pointerPressedInBounds);\r\n \r\n         void TouchMoved(Microsoft.Terminal.Core.Point newTouchPoint,\r\n                         Boolean focused);\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..f6874c35e75 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -1910,18 +1910,18 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         if (type == Windows::Devices::Input::PointerDeviceType::Mouse ||\r\n             type == Windows::Devices::Input::PointerDeviceType::Pen)\r\n         {\r\n-            _interactivity.PointerMoved(TermControl::GetPressedMouseButtons(point),\r\n-                                        TermControl::GetPointerUpdateKind(point),\r\n-                                        ControlKeyStates(args.KeyModifiers()),\r\n-                                        _focused,\r\n-                                        pixelPosition.to_core_point(),\r\n-                                        _pointerPressedInBounds);\r\n+            auto suppressFurtherHandling = _interactivity.PointerMoved(TermControl::GetPressedMouseButtons(point),\r\n+                                                                       TermControl::GetPointerUpdateKind(point),\r\n+                                                                       ControlKeyStates(args.KeyModifiers()),\r\n+                                                                       _focused,\r\n+                                                                       pixelPosition.to_core_point(),\r\n+                                                                       _pointerPressedInBounds);\r\n \r\n             // GH#9109 - Only start an auto-scroll when the drag actually\r\n             // started within our bounds. Otherwise, someone could start a drag\r\n             // outside the terminal control, drag into the padding, and trick us\r\n             // into starting to scroll.\r\n-            if (_focused && _pointerPressedInBounds && point.Properties().IsLeftButtonPressed())\r\n+            if (!suppressFurtherHandling && _focused && _pointerPressedInBounds && point.Properties().IsLeftButtonPressed())\r\n             {\r\n                 // We want to find the distance relative to the bounds of the\r\n                 // SwapChainPanel, not the entire control. If they drag out of\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\nindex a5d443b915a..49fcd6d21eb 100644\n--- a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n@@ -998,16 +998,15 @@ namespace ControlUnitTests\n         VERIFY_IS_GREATER_THAN(core->ScrollOffset(), 0);\r\n \r\n         // Viewport is now above the mutable viewport, so the mouse event\r\n-        // straight up won't be sent to the terminal.\r\n+        // will be clamped to the top line.\r\n \r\n-        expectedOutput.push_back(L\"sentinel\"); // Clearly, it won't be this string\r\n+        expectedOutput.push_back(L\"\\x1b[M &!\"); // 5, 1\r\n         interactivity->PointerPressed(leftMouseDown,\r\n                                       WM_LBUTTONDOWN, //pointerUpdateKind\r\n                                       0, // timestamp\r\n                                       modifiers,\r\n                                       cursorPosition0.to_core_point());\r\n         // Flush it out.\r\n-        conn->WriteInput(winrt_wstring_to_array_view(L\"sentinel\"));\r\n         VERIFY_ARE_EQUAL(0u, expectedOutput.size(), L\"Validate we drained all the expected output\");\r\n \r\n         // This is the part as mentioned in GH#12719\r\n", "test_patch": "", "problem_statement": "Mouse events are not sent when the mouse is outside the top of the WT\n### Windows Terminal version\r\n\r\nVers\u00e3o: 1.20.11781.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.0\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nPlease clone this GitHub repository [MouseTests](https://github.com/BDisp/MouseTests.git) and run. Keep pressing the mouse inside the console and move around it, as the gif show.\r\n\r\n### Expected Behavior\r\n\r\nThe mouse events should be sent while the mouse button is pressed and moving inside or outside the console until it's released.\r\n\r\n### Actual Behavior\r\n\r\nThe mouse events are sent as expected except from outside of the console on top.\r\n\r\n![MouseTests](https://github.com/user-attachments/assets/aa84e08d-a96f-43e2-a1ee-8ae199ba74d3)\r\n\r\nWith the `conhost` the mouse events are always sent from anywhere while the mouse isn't released.\n", "hints_text": "Yep, that's super weird alright!\r\n\r\nOur theory is that we're getting into the mouse-select-drag-scroll state, and attempting to \"scroll\" the terminal, and suppressing the mouse event\nYep, I already noted that and that why I made my example writing always on the same line to avoiding scrolling. I noted that moving outside the console ws causing to scroll. This would be valid if I was pressed the scroll bar but that wasn't the case. Maybe acceptable only if the scroll bar is visible. Thanks.", "created_at": "2024-08-22 21:21:08", "merge_commit_sha": "d1a1f9836ebbcdffc76d2f13384ee2fb7c060c9d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17774", "base_commit": "cbb4a0a01cc4d66894e17b39c5b84fdfd0fec261", "patch": "diff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..e259d9ea05d 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -1539,11 +1539,24 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             auto encoding = s.encoding;\r\n             wchar_t buf[4]{};\r\n             size_t buf_len = 0;\r\n+            bool handled = true;\r\n \r\n             if (encoding == AltNumpadEncoding::Unicode)\r\n             {\r\n                 // UTF-32 -> UTF-16\r\n-                if (s.accumulator <= 0xffff)\r\n+                if (s.accumulator == 0)\r\n+                {\r\n+                    // If the user pressed Alt + VK_ADD, then released Alt, they probably didn't intend to insert a numpad character at all.\r\n+                    // Send any accumulated key events instead.\r\n+                    for (auto&& e : _altNumpadState.cachedKeyEvents)\r\n+                    {\r\n+                        handled = handled && _TrySendKeyEvent(e.vkey, e.scanCode, e.modifiers, e.keyDown);\r\n+                    }\r\n+                    // Send the alt keyup we are currently processing\r\n+                    handled = handled && _TrySendKeyEvent(vkey, scanCode, modifiers, keyDown);\r\n+                    // do not accumulate into the buffer\r\n+                }\r\n+                else if (s.accumulator <= 0xffff)\r\n                 {\r\n                     buf[buf_len++] = static_cast<uint16_t>(s.accumulator);\r\n                 }\r\n@@ -1587,7 +1600,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             }\r\n \r\n             s = {};\r\n-            return true;\r\n+            return handled;\r\n         }\r\n         // As a continuation of the above, this handles the key-down case.\r\n         if (modifiers.IsAltPressed())\r\n@@ -1601,46 +1614,49 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 SCROLLLOCK_ON |\r\n                 CAPSLOCK_ON;\r\n \r\n-            if (keyDown && (modifiers.Value() & ~permittedModifiers) == 0)\r\n+            if ((modifiers.Value() & ~permittedModifiers) == 0)\r\n             {\r\n                 auto& s = _altNumpadState;\r\n \r\n-                if (vkey == VK_ADD)\r\n-                {\r\n-                    // Alt '+' <number> is used to input Unicode code points.\r\n-                    // Every time you press + it resets the entire state\r\n-                    // in the original OS implementation as well.\r\n-                    s.encoding = AltNumpadEncoding::Unicode;\r\n-                    s.accumulator = 0;\r\n-                    s.active = true;\r\n-                }\r\n-                else if (vkey == VK_NUMPAD0 && s.encoding == AltNumpadEncoding::OEM && s.accumulator == 0)\r\n-                {\r\n-                    // Alt '0' <number> is used to input ANSI code points.\r\n-                    // Otherwise, they're OEM codepoints.\r\n-                    s.encoding = AltNumpadEncoding::ANSI;\r\n-                    s.active = true;\r\n-                }\r\n-                else\r\n+                if (keyDown)\r\n                 {\r\n-                    // Otherwise, append the pressed key to the accumulator.\r\n-                    const uint32_t base = s.encoding == AltNumpadEncoding::Unicode ? 16 : 10;\r\n-                    uint32_t add = 0xffffff;\r\n-\r\n-                    if (vkey >= VK_NUMPAD0 && vkey <= VK_NUMPAD9)\r\n+                    if (vkey == VK_ADD)\r\n                     {\r\n-                        add = vkey - VK_NUMPAD0;\r\n+                        // Alt '+' <number> is used to input Unicode code points.\r\n+                        // Every time you press + it resets the entire state\r\n+                        // in the original OS implementation as well.\r\n+                        s.encoding = AltNumpadEncoding::Unicode;\r\n+                        s.accumulator = 0;\r\n+                        s.active = true;\r\n                     }\r\n-                    else if (vkey >= 'A' && vkey <= 'F')\r\n+                    else if (vkey == VK_NUMPAD0 && s.encoding == AltNumpadEncoding::OEM && s.accumulator == 0)\r\n                     {\r\n-                        add = vkey - 'A' + 10;\r\n+                        // Alt '0' <number> is used to input ANSI code points.\r\n+                        // Otherwise, they're OEM codepoints.\r\n+                        s.encoding = AltNumpadEncoding::ANSI;\r\n+                        s.active = true;\r\n                     }\r\n-\r\n-                    // Pressing Alt + <not a number> should not activate the Alt+Numpad input, however.\r\n-                    if (add < base)\r\n+                    else\r\n                     {\r\n-                        s.accumulator = std::min(s.accumulator * base + add, 0x10FFFFu);\r\n-                        s.active = true;\r\n+                        // Otherwise, append the pressed key to the accumulator.\r\n+                        const uint32_t base = s.encoding == AltNumpadEncoding::Unicode ? 16 : 10;\r\n+                        uint32_t add = 0xffffff;\r\n+\r\n+                        if (vkey >= VK_NUMPAD0 && vkey <= VK_NUMPAD9)\r\n+                        {\r\n+                            add = vkey - VK_NUMPAD0;\r\n+                        }\r\n+                        else if (vkey >= 'A' && vkey <= 'F')\r\n+                        {\r\n+                            add = vkey - 'A' + 10;\r\n+                        }\r\n+\r\n+                        // Pressing Alt + <not a number> should not activate the Alt+Numpad input, however.\r\n+                        if (add < base)\r\n+                        {\r\n+                            s.accumulator = std::min(s.accumulator * base + add, 0x10FFFFu);\r\n+                            s.active = true;\r\n+                        }\r\n                     }\r\n                 }\r\n \r\n@@ -1648,6 +1664,8 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 // return and send the Alt key combination as per usual.\r\n                 if (s.active)\r\n                 {\r\n+                    // Cache it in case we have to emit it after alt is released\r\n+                    _altNumpadState.cachedKeyEvents.emplace_back(vkey, scanCode, modifiers, keyDown);\r\n                     return true;\r\n                 }\r\n \r\ndiff --git a/src/cascadia/TerminalControl/TermControl.h b/src/cascadia/TerminalControl/TermControl.h\nindex f60a72ea792..ab5b0a1ae78 100644\n--- a/src/cascadia/TerminalControl/TermControl.h\n+++ b/src/cascadia/TerminalControl/TermControl.h\n@@ -256,12 +256,20 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         };\r\n         struct AltNumpadState\r\n         {\r\n+            struct CachedKey\r\n+            {\r\n+                WORD vkey;\r\n+                WORD scanCode;\r\n+                ::Microsoft::Terminal::Core::ControlKeyStates modifiers;\r\n+                bool keyDown;\r\n+            };\r\n             AltNumpadEncoding encoding = AltNumpadEncoding::OEM;\r\n             uint32_t accumulator = 0;\r\n             // Checking for accumulator != 0 to see if we have an ongoing Alt+Numpad composition is insufficient.\r\n             // The state can be active, while the accumulator is 0, if the user pressed Alt+Numpad0 which enabled\r\n             // the OEM encoding mode (= active), and then pressed Numpad0 again (= accumulator is still 0).\r\n             bool active = false;\r\n+            til::small_vector<CachedKey, 4> cachedKeyEvents;\r\n         };\r\n         AltNumpadState _altNumpadState;\r\n \r\n", "test_patch": "", "problem_statement": "CANARY: ALT+NUMPAD ADD is Broken\n### Windows Terminal version\n\n1.22.2334.0\n\n### Windows build number\n\n10.0.19045.4780\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nAlt+NumpadAdd pressing combination is broken since Canary build terminal-1.22.2201.0\r\nterminal-1.22.2191.0 - latest good\r\nterminal-1.22.2201.0 - broken\r\n...\r\nterminal-1.22.2334.0 - broken\r\n\r\nrun utilities for getting codes DOWN/UP VK_CODES etc\r\npress Alt key after press NumpadAdd and release NumpadAdd, press NumpadAdd and release NumpadAdd, press NumpadAdd and release NumpadAdd\n\n### Expected Behavior\n\nterminal-1.22.2191.0 - latest good:\r\n21:42:56 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:42:56 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:42:57 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n\n\n### Actual Behavior\n\nsince terminal-1.22.2201.0  to latest canary build terminal-1.22.2334.0  is broken:\r\n\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n", "hints_text": "with another combination I no have problem, only 100% with Alt+NumPadAdd or RAlt+NumpadAdd\r\n\r\nif press and release only Alt/Ralt - no problem\r\nif press and release only NumPadAdd - no problem\r\n\r\nps. What I found problem : my macros for FAR MANAGER  for key=\"AltAdd\" is stop working...", "created_at": "2024-08-22 19:36:49", "merge_commit_sha": "e006f75f6c175542760ee4d338ee894b82acff5f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17770", "base_commit": "b3f41626b4d212da8ca7c08077b12c289f918c86", "patch": "diff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..8f8f9f0df66 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -717,11 +717,14 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         // terminal.\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _core.UpdateSettings(settings, unfocusedAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _core.UpdateSettings(settings, unfocusedAppearance);\r\n \r\n-        _UpdateSettingsFromUIThread();\r\n+            _UpdateSettingsFromUIThread();\r\n \r\n-        _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+            _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n@@ -730,10 +733,15 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - newAppearance: the new appearance to set\r\n     winrt::fire_and_forget TermControl::UpdateAppearance(IControlAppearance newAppearance)\r\n     {\r\n+        auto weakThis{ get_weak() };\r\n+\r\n         // Dispatch a call to the UI thread\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _UpdateAppearanceFromUIThread(newAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _UpdateAppearanceFromUIThread(newAppearance);\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n", "test_patch": "", "problem_statement": "'unfocusedAppearance' option with any value including empty dictionary causes Windows Terminal to crash all instances when closing just one\n### Windows Terminal version\n\n1.20.11781\n\n### Windows build number\n\n10.0.22631.2861\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nSo after quite a bit of troubleshooting (including re-installing my entire Windows 11 OS), I've narrowed down the bug and can consistently replicate it.\n\n\n1. Add the `unfocusedAppearance` option in the `defaults` section of your Windows Terminal config, e.g.\n\n```\n   \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        ...\n    },\n```\n\n2. OR alternative use this full config (minimal example):\n\n```md\n{\n    \"$help\": \"https://aka.ms/terminal-documentation\",\n    \"$schema\": \"https://aka.ms/terminal-profiles-schema\",\n    \"actions\": \n    [\n        {\n            \"command\": \n            {\n                \"action\": \"copy\",\n                \"singleLine\": false\n            },\n            \"keys\": \"ctrl+c\"\n        },\n        {\n            \"command\": \"paste\",\n            \"keys\": \"ctrl+v\"\n        },\n        {\n            \"command\": \"find\",\n            \"keys\": \"ctrl+shift+f\"\n        },\n        {\n            \"command\": \n            {\n                \"action\": \"splitPane\",\n                \"split\": \"auto\",\n                \"splitMode\": \"duplicate\"\n            },\n            \"keys\": \"alt+shift+d\"\n        }\n    ],\n    \"copyFormatting\": \"none\",\n    \"copyOnSelect\": false,\n    \"defaultProfile\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n    \"newTabMenu\": \n    [\n        {\n            \"type\": \"remainingProfiles\"\n        }\n    ],\n    \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"opacity\": 90,\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        \"list\": \n        [\n            {\n                \"guid\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n                \"hidden\": false,\n                \"name\": \"Windows PowerShell\"\n            },\n            {\n                \"guid\": \"{0caa0dad-35be-5f56-a8ff-afceeeaa6101}\",\n                \"hidden\": false,\n                \"name\": \"Command Prompt\"\n            }\n        ]\n    },\n    \"schemes\": \n    [\n        {\n            \"background\": \"#0C0C0C\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#012456\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell Powershell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#282C34\",\n            \"black\": \"#282C34\",\n            \"blue\": \"#61AFEF\",\n            \"brightBlack\": \"#5A6374\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B6C2\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C678DD\",\n            \"brightRed\": \"#E06C75\",\n            \"brightWhite\": \"#DCDFE4\",\n            \"brightYellow\": \"#E5C07B\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#56B6C2\",\n            \"foreground\": \"#DCDFE4\",\n            \"green\": \"#98C379\",\n            \"name\": \"One Half Dark\",\n            \"purple\": \"#C678DD\",\n            \"red\": \"#E06C75\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#DCDFE4\",\n            \"yellow\": \"#E5C07B\"\n        },\n        {\n            \"background\": \"#FAFAFA\",\n            \"black\": \"#383A42\",\n            \"blue\": \"#0184BC\",\n            \"brightBlack\": \"#4F525D\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B5C1\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C577DD\",\n            \"brightRed\": \"#DF6C75\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#E4C07A\",\n            \"cursorColor\": \"#4F525D\",\n            \"cyan\": \"#0997B3\",\n            \"foreground\": \"#383A42\",\n            \"green\": \"#50A14F\",\n            \"name\": \"One Half Light\",\n            \"purple\": \"#A626A4\",\n            \"red\": \"#E45649\",\n            \"selectionBackground\": \"#4F525D\",\n            \"white\": \"#FAFAFA\",\n            \"yellow\": \"#C18301\"\n        },\n        {\n            \"background\": \"#002B36\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#839496\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Dark\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#FDF6E3\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#002B36\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#657B83\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Light\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#073642\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#D3D7CF\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Dark\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#FFFFFF\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#000000\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#555753\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Light\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#555753\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#000080\",\n            \"brightBlack\": \"#808080\",\n            \"brightBlue\": \"#0000FF\",\n            \"brightCyan\": \"#00FFFF\",\n            \"brightGreen\": \"#00FF00\",\n            \"brightPurple\": \"#FF00FF\",\n            \"brightRed\": \"#FF0000\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#FFFF00\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#008080\",\n            \"foreground\": \"#C0C0C0\",\n            \"green\": \"#008000\",\n            \"name\": \"Vintage\",\n            \"purple\": \"#800080\",\n            \"red\": \"#800000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#C0C0C0\",\n            \"yellow\": \"#808000\"\n        }\n    ],\n    \"themes\": []\n}\n```\n\n3. Now launch two instances of Windows Terminal.\n4. Using your mouse, press the 'x' button on the top-right of the first instance.\n5. The first instance will freeze a bit, crash, and cause both instances to shut.\n6. If you view Event Viewer logs, under Application logs, you will see that the application has indeed crashed with an ERROR.\n\nOther things to know:\n- Removing the `unfocusedAppearance` option fixes the issue (but you lose that feature).\n- The `unfocusedAppearance` use to work for me on older builds (I don't know which ones but I use to use this feature a lot).\n- Adding any options in the `unfocusedAppearance` still causes the crash.\n- Shutting any of the Windows Terminal using 'CTRL+W' shortcut avoids this crashing behaviour.\n\n### Expected Behavior\n\nWhen I shut a single instance of Windows Terminal, it should only shut that instance and not shut all other instances. This likely happens because the parent process crashes, killing all spawned windows terminal children.\n\n### Actual Behavior\n\nPressing the 'x' button causes all windows terminal instances to shut.\n", "hints_text": "", "created_at": "2024-08-22 17:00:36", "merge_commit_sha": "eabebc4cb227293df4839f75bd195b04992ba506", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17748", "base_commit": "b439925acc1f6c51180b2fa33775395b595d1c60", "patch": "diff --git a/src/host/_stream.cpp b/src/host/_stream.cpp\nindex e434e413ebd..82dda40ef9b 100644\n--- a/src/host/_stream.cpp\n+++ b/src/host/_stream.cpp\n@@ -336,6 +336,9 @@ void WriteCharsVT(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str)\n {\r\n     auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n     auto& stateMachine = screenInfo.GetStateMachine();\r\n+    // If the given screenInfo is the alternate screen buffer, disabling the alternate screen buffer in this\r\n+    // VT payload will cause the pointer to be invalidated. We thus need to get all the information we need now.\r\n+    const auto disableNewlineTranslation = WI_IsFlagSet(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN);\r\n     // When switch between the main and alt-buffer SCREEN_INFORMATION::GetActiveBuffer()\r\n     // may change, so get the VtIo reference now, just in case.\r\n     auto writer = gci.GetVtWriterForBuffer(&screenInfo);\r\n@@ -350,7 +353,7 @@ void WriteCharsVT(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str)\n         // DISABLE_NEWLINE_AUTO_RETURN not being set is equivalent to a LF -> CRLF translation.\r\n         const auto write = [&](size_t beg, size_t end) {\r\n             const auto chunk = til::safe_slice_abs(str, beg, end);\r\n-            if (WI_IsFlagSet(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN))\r\n+            if (disableNewlineTranslation)\r\n             {\r\n                 writer.WriteUTF16(chunk);\r\n             }\r\n", "test_patch": "", "problem_statement": "Crash when switching back from the alt buffer\n### Windows Terminal version\n\nCommit edfa3ea0f0080eadf7f01b463ed0a8638de6ce04\n\n### Windows build number\n\n10.0.19045.4651\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nIt's not easy to reproduce, but I think all you really need to trigger the crash is to switch to the alt buffer with `printf \"\\e[?1049h\"`, and then switch back to the main buffer with `printf \"\\e[?1049l\"`.\r\n\r\nThis is in Windows Terminal using a build that includes the new VT passthrough (PR #17510).\n\n### Expected Behavior\n\nThe terminal should not crash.\n\n### Actual Behavior\n\nI got an access violation accessing the `screenInfo` parameter in the `WriteCharsVT` function here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/0199ca33ddb4a02ca3549627d772ce6b330ed1ce/src/host/_stream.cpp#L353\r\n\r\nWhat happens is that we first pass the `\\e[?1049l` sequence through to conhost in the `stateMachine.ProcessString` call a couple of lines above. That ends up calling `SCREEN_INFORMATION::UseMainScreenBuffer`, which calls `s_RemoveScreenBuffer(psiAlt)`, which deletes the active `screenInfo` instance here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/0199ca33ddb4a02ca3549627d772ce6b330ed1ce/src/host/screenInfo.cpp#L231\r\n\r\nThat's the same `screenInfo` instance that was passed to our `WriteCharsVT` function, so when we later try to reference that, we're referencing a deleted object. Sometimes we get lucky and nothing bad happens, but sometimes it will crash.\r\n\r\nI think maybe all we need to do to prevent the crash is to save the `screenInfo.OutputMode` at the start of the function, and then use that saved value instead of trying to look it up via the `screenInfo` object.\n", "hints_text": "", "created_at": "2024-08-20 14:20:16", "merge_commit_sha": "249fe2aca14f9bd59ae7b84b3a46d0550e5921ee", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17738", "base_commit": "9b21b78feea9ff0a0b9ff2c8fa4b4aa5602d3889", "patch": "diff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 07918e902bc..0eebe1308c9 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -2029,6 +2029,7 @@ void StateMachine::ProcessString(const std::wstring_view string)\n     if (_state != VTStates::Ground)\r\n     {\r\n         const auto run = _CurrentRun();\r\n+        auto cacheUnusedRun = true;\r\n \r\n         // One of the \"weird things\" in VT input is the case of something like\r\n         // <kbd>alt+[</kbd>. In VT, that's encoded as `\\x1b[`. However, that's\r\n@@ -2066,15 +2067,22 @@ void StateMachine::ProcessString(const std::wstring_view string)\n                     _ActionEscDispatch(run.back());\r\n                 }\r\n                 _EnterGround();\r\n+                // No need to cache the run, since we've dealt with it now.\r\n+                cacheUnusedRun = false;\r\n             }\r\n         }\r\n-        else if (_state != VTStates::SosPmApcString && _state != VTStates::DcsPassThrough && _state != VTStates::DcsIgnore)\r\n+        else if (_state == VTStates::SosPmApcString || _state == VTStates::DcsPassThrough || _state == VTStates::DcsIgnore)\r\n         {\r\n-            // If the engine doesn't require flushing at the end of the string, we\r\n-            // want to cache the partial sequence in case we have to flush the whole\r\n-            // thing to the terminal later. There is no need to do this if we've\r\n-            // reached one of the string processing states, though, since that data\r\n+            // There is no need to cache the run if we've reached one of the\r\n+            // string processing states in the output engine, since that data\r\n             // will be dealt with as soon as it is received.\r\n+            cacheUnusedRun = false;\r\n+        }\r\n+\r\n+        // If the run hasn't been dealt with in one of the cases above, we cache\r\n+        // the partial sequence in case we have to flush the whole thing later.\r\n+        if (cacheUnusedRun)\r\n+        {\r\n             if (!_cachedSequence)\r\n             {\r\n                 _cachedSequence.emplace(std::wstring{});\r\n", "test_patch": "", "problem_statement": "Pasting specific texts into vim (WSL) breaks some keys\n### Windows Terminal version\r\n\r\n1.20.10303.0 and 1.19.10302.0\r\n\r\n### Windows build number\r\n\r\n10.0.22621.0\r\n\r\n### Other Software\r\n\r\nvim 9.1.31 in WSL\r\nnvim v0.9.5 in WSL\r\n\r\n### Steps to reproduce\r\n\r\n1. Open vim in WSL using Terminal 1.20.10303.0 or 1.19.10302.0. **Version 1.18.10301.0 is unaffected.**\r\n2. Enter insert mode by pressing i.\r\n3. Paste in the following text with right click or shift+insert: https://gist.githubusercontent.com/csdivad/8c1069a35b52fb806ee8e4484b38f1f3/raw/37616af9daee626df6e7065059de5d5d87d8c9ec/test.txt\r\n\r\nThis input is a base64 encoded chunk of Lorem Ipsum.\r\nThe issue only happens with specific inputs. I encountered it first when pasting another base64 encoded text, but that had sensitive data in it.\r\nThen I played around with `dd if=lorem.txt bs=1 count=... | base64 -w 180` until I found a configuration that also triggered the issue.\r\n\r\n### Expected Behavior\r\n\r\nEscape, backspace and Function keys works properly after the paste.\r\nOnly the pasted text appears in the editor.\r\n\r\n### Actual Behavior\r\n\r\nYou are now stuck in editing mode. Esc, backspace and other keys are now sending weird escape sequences.\r\nAfter the last character a `1~` appears. Pressing esc inserts `^[`, pressing backspace inserts `^?`.\n", "hints_text": "Git bisect suggests that this broke in revision efbfb12145da959f74c368cdfc92f7892ce724d5. I'm not sure why though.\r\n\r\n@csdivad I think you should be able to escape from this state in vim by pressing <kbd>Ctrl</kbd>+<kbd>C</kbd>.\nI have a little more information now. It looks like the bracketed paste sequences are getting corrupted somehow. The paste starts with the opening sequence (`\\e[200~`), but only ends with part of the closing sequence (`1~`).\r\n\r\nAs a result, vim thinks you're still pasting content, so it won't process any command keys unless you manually terminate the paste. <kbd>Ctrl</kbd>+<kbd>C</kbd> is one way of doing that, but you could also enter the closing bracket sequence manually: <kbd>Esc</kbd> <kbd>[</kbd> <kbd>2</kbd> <kbd>0</kbd> <kbd>1</kbd> <kbd>~</kbd>.\r\n\r\nThe length of the paste seems to be a factor in the bug, because for every additional character I add to the pasted content, one more character is included in the closing bracket sequence, until it's sending the full sequence. At that point, additional content doesn't seem make any difference.\nI think I know why it's failing now. There's assumedly a 4096 byte buffer somewhere, and the pasted content along with the bracketed paste sequences adds up to just over 4096 bytes. As a result, the closing bracket sequence is cut off, and what we end up receiving in the initial packet is something like this:\r\n\r\n```\r\n\\e[200~ ... PASTED CONTENT ... \\e[20\r\n```\r\n\r\nWhen the parser gets to that last escape, we have [a heuristic](https://github.com/microsoft/terminal/blob/ef96e225da6b0df496390eed9fe31dc7e434a939/src/terminal/parser/stateMachine.cpp#L2155) that looks for a single escape, or a two byte Alt+key sequence, but this fits neither of those patterns, so it seems we just drop those characters!\r\n\r\nThen when the next packet arrives, we get the remaining characters for the closing bracket (`1~`), but since the start of the sequence has been lost, it's now just treated as plain text.\r\n\r\nThe more I think about, the more convinced I am that what we're doing here is completely wrong, but I don't know what the correct solution would be.\nhttps://github.com/microsoft/terminal/blob/ef96e225da6b0df496390eed9fe31dc7e434a939/src/terminal/parser/stateMachine.cpp#L2152-L2155\r\n\r\nI wonder if it's sufficient to *always* switch into a normal VT state machine mode once we've encountered a Win32 Input Mode sequence, e.g.:\r\n\r\n```\r\n        if (_isEngineForInput && !_engine->EncounteredWin32InputModeSequence())\r\n        {\r\n```\nCould we just amend the heuristic to also account for bracketed paste mode? Like, if we've started a bracketed paste, don't ever flush the state machine at the end of a write? Not sure how bad that would be.\nSorry, I think I've been misleading everyone. I've just been looking at this again, and I now realise that my initial understanding was wrong.\r\n\r\nWhen the first packet ends with half an escape sequence (the `\\e[20`), I thought it just dropped those characters, but that's not actually what's happening. They've already been parsed and are now \"preserved\" in the state machine, which is why it's not in the ground state. When the next packet arrives, it does actually continue parsing the sequence from where it left off, but that's the point when something goes wrong which I'm not sure I understand.\r\n\r\nIt gets to a point where it decides it should flush the content to the input queue. However, the only thing it can flush is what it has in the current buffer, which is the second half of the sequence. So I think that's how the first half ends up being dropped, and vim sees the second half of the sequence as additional pasted text.\r\n\r\nI think it's best I leave this to someone else to figure out, because I seem to be out of my depth here.\nAny update on this?\r\nThe issue is now present in the Store release (1.19.10573.0).\nI've just had this issue come up again in a different context (a VT query response that exceeded 4K), and I think I have a better understanding of what's going wrong now.\r\n\r\nAs I mentioned above:\r\n> It gets to a point where it decides it should flush the content to the input queue. However, the only thing it can flush is what it has in the current buffer, which is the second half of the sequence.\r\n\r\nBut the state machine already has a process for dealing with this. If you exit the state machine and you're not in the ground state, it can save the current run in the `_cachedSequence` field. Then if it needs to flush at a later point in time, it can combine the `_cachedSequence` with the latest run so you won't lose anything.\r\n\r\nThe problem is that this process is only applied to the output state machine. See here:\r\nhttps://github.com/microsoft/terminal/blob/0199ca33ddb4a02ca3549627d772ce6b330ed1ce/src/terminal/parser/stateMachine.cpp#L2073-L2084\r\n\r\nSo I think all we need to do is copy that chunk of code up a couple of lines into the `_isEngineForInput` branch and all will be good.\r\n\r\nI've done a basic test with this patch, and it seems to fix my problem as well as the vim pasting bug described in this issue. I don't know if there are any edge cases I'm missing though.", "created_at": "2024-08-18 21:52:55", "merge_commit_sha": "131728b17d50a81d0ecc0686589a2742b7742149", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17731", "base_commit": "4c018efd641dd71502e4019078bb6325c68b7f9a", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex a7530807d07..87236331fca 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1425,6 +1425,11 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n         LR\"(\\b(?:https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|$!:,.;]*[A-Za-z0-9+&@#/%=~_|$])\",\r\n     };\r\n \r\n+    if (!_detectURLs)\r\n+    {\r\n+        return {};\r\n+    }\r\n+\r\n     auto text = ICU::UTextFromTextBuffer(_activeBuffer(), beg, end + 1);\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     PointTree::interval_vector intervals;\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\nindex 827c4da85ce..ac9841369db 100644\n--- a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n@@ -607,6 +607,13 @@ void TerminalBufferTests::TestURLPatternDetection()\n     constexpr auto urlStartX = BeforeStr.size();\r\n     constexpr auto urlEndX = BeforeStr.size() + UrlStr.size() - 1;\r\n \r\n+    // This is off by default; turn it on for the test.\r\n+    auto originalDetectURLs = term->_detectURLs;\r\n+    auto restoreDetectUrls = wil::scope_exit([&]() {\r\n+        term->_detectURLs = originalDetectURLs;\r\n+    });\r\n+    term->_detectURLs = true;\r\n+\r\n     auto& termSm = *term->_stateMachine;\r\n     termSm.ProcessString(fmt::format(FMT_COMPILE(L\"{}{}{}\"), BeforeStr, UrlStr, AfterStr));\r\n     term->UpdatePatternsUnderLock();\r\n", "test_patch": "", "problem_statement": "Can't off feature \"Auto recognize URLs\"\n### Windows Terminal version\n\n1.22.2281.0\n\n### Windows build number\n\n10.0.19045.3448\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nbroken features:\r\n\"experimental.detectURLs\": false,\r\n\r\nwork fine:\r\nMicrosoft.WindowsTerminal_1.17.11461.0_x64.zip\r\nMicrosoft.WindowsTerminal_1.18.2681.0_x64.zip\r\n\r\n\r\nbroken:\r\nMicrosoft.WindowsTerminal_1.19.10302.0_x64.zip\r\n...\r\nMicrosoft.WindowsTerminal_1.20.11781.0_x64.zip\r\n\r\nlatest Canary terminal-1.22.2281.0 also broken\r\n\r\n\r\ntest URL:\r\nhttps://aka.ms/terminal-documentation\r\n\n\n### Expected Behavior\n\nrecognized URLs are not highlighted\n\n### Actual Behavior\n\nrecognized URLs is highlighted\r\nanyway\r\n\r\nwhen \r\n\"experimental.detectURLs\": false,\r\nor\r\n\"experimental.detectURLs\": true,\n", "hints_text": "This regressed in cd80f3c76496c7664ed710907d7d473f634191bc because this line got removed from the branch:\r\nhttps://github.com/microsoft/terminal/blob/5651f087702d97f8c5e48db6cd4199aed8a04479/src/cascadia/TerminalCore/Terminal.cpp#L1340-L1342\r\n\r\nThe fix is to add a `_detectURLs` check here:\r\nhttps://github.com/microsoft/terminal/blob/1ef497970f8409def5ac03e26ba54439d0aad4e0/src/cascadia/TerminalCore/Terminal.cpp#L1422-L1452", "created_at": "2024-08-16 22:55:27", "merge_commit_sha": "735ef2823ed72d80ce91df0176646979e4568831", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17729", "base_commit": "735ef2823ed72d80ce91df0176646979e4568831", "patch": "diff --git a/.github/actions/spelling/patterns/patterns.txt b/.github/actions/spelling/patterns/patterns.txt\nindex 0089073a434..39fadfec281 100644\n--- a/.github/actions/spelling/patterns/patterns.txt\n+++ b/.github/actions/spelling/patterns/patterns.txt\n@@ -22,6 +22,7 @@ vcvars\\w*\n ROY\\sG\\.\\sBIV\n !(?:(?i)ESC)!\\[\n !(?:(?i)CSI)!(?:\\d+(?:;\\d+|)m|[ABCDF])\n+(?i)rgb:[a-z0-9]{2,4}/[a-z0-9]{2,4}/[a-z0-9]{2,4}\n \n # SSE intrinsics like \"_mm_subs_epu16\"\n \\b_mm(?:|256|512)_\\w+\\b\ndiff --git a/src/terminal/adapter/ITermDispatch.hpp b/src/terminal/adapter/ITermDispatch.hpp\nindex bf4d2cc5bd5..514c8b0c4d9 100644\n--- a/src/terminal/adapter/ITermDispatch.hpp\n+++ b/src/terminal/adapter/ITermDispatch.hpp\n@@ -76,9 +76,10 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual bool BackwardsTab(const VTInt numTabs) = 0; // CBT\r\n     virtual bool TabClear(const DispatchTypes::TabClearType clearType) = 0; // TBC\r\n     virtual bool TabSet(const VTParameter setType) = 0; // DECST8C\r\n-    virtual bool SetColorTableEntry(const size_t tableIndex, const DWORD color) = 0; // OSCColorTable\r\n-    virtual bool SetDefaultForeground(const DWORD color) = 0; // OSCDefaultForeground\r\n-    virtual bool SetDefaultBackground(const DWORD color) = 0; // OSCDefaultBackground\r\n+    virtual bool SetColorTableEntry(const size_t tableIndex, const DWORD color) = 0; // OSCSetColorTable\r\n+    virtual bool RequestColorTableEntry(const size_t tableIndex) = 0; // OSCGetColorTable\r\n+    virtual bool SetXtermColorResource(const size_t resource, const DWORD color) = 0; // OSCSetDefaultForeground, OSCSetDefaultBackground, OSCSetCursorColor, OSCResetCursorColor\r\n+    virtual bool RequestXtermColorResource(const size_t resource) = 0; // OSCGetDefaultForeground, OSCGetDefaultBackground, OSCGetCursorColor\r\n     virtual bool AssignColor(const DispatchTypes::ColorItem item, const VTInt fgIndex, const VTInt bgIndex) = 0; // DECAC\r\n \r\n     virtual bool EraseInDisplay(const DispatchTypes::EraseType eraseType) = 0; // ED\r\n@@ -128,7 +129,6 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual bool ScreenAlignmentPattern() = 0; // DECALN\r\n \r\n     virtual bool SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle) = 0; // DECSCUSR\r\n-    virtual bool SetCursorColor(const COLORREF color) = 0; // OSCSetCursorColor, OSCResetCursorColor\r\n \r\n     virtual bool SetClipboard(wil::zwstring_view content) = 0; // OSCSetClipboard\r\n \r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 3aca2abfdf9..1c84e939ffb 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -18,6 +18,25 @@ using namespace Microsoft::Console::VirtualTerminal;\n \n static constexpr std::wstring_view whitespace{ L\" \" };\n \n+struct XtermResourceColorTableEntry\n+{\n+    int ColorTableIndex;\n+    int AliasIndex;\n+};\n+\n+static constexpr std::array<XtermResourceColorTableEntry, 10> XtermResourceColorTableMappings{ {\n+    /* 10 */ { TextColor::DEFAULT_FOREGROUND, static_cast<int>(ColorAlias::DefaultForeground) },\n+    /* 11 */ { TextColor::DEFAULT_BACKGROUND, static_cast<int>(ColorAlias::DefaultBackground) },\n+    /* 12 */ { TextColor::CURSOR_COLOR, -1 },\n+    /* 13 */ { -1, -1 },\n+    /* 14 */ { -1, -1 },\n+    /* 15 */ { -1, -1 },\n+    /* 16 */ { -1, -1 },\n+    /* 17 */ { -1, -1 },\n+    /* 18 */ { -1, -1 },\n+    /* 19 */ { -1, -1 },\n+} };\n+\n AdaptDispatch::AdaptDispatch(ITerminalApi& api, Renderer* renderer, RenderSettings& renderSettings, TerminalInput& terminalInput) noexcept :\n     _api{ api },\n     _renderer{ renderer },\n@@ -3439,18 +3458,6 @@ bool AdaptDispatch::SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle)\n     return true;\n }\n \n-// Method Description:\n-// - Sets a single entry of the colortable to a new value\n-// Arguments:\n-// - tableIndex: The VT color table index\n-// - dwColor: The new RGB color value to use.\n-// Return Value:\n-// True if handled successfully. False otherwise.\n-bool AdaptDispatch::SetCursorColor(const COLORREF cursorColor)\n-{\n-    return SetColorTableEntry(TextColor::CURSOR_COLOR, cursorColor);\n-}\n-\n // Routine Description:\n // - OSC Copy to Clipboard\n // Arguments:\n@@ -3491,28 +3498,69 @@ bool AdaptDispatch::SetColorTableEntry(const size_t tableIndex, const DWORD dwCo\n     return true;\n }\n \n+bool AdaptDispatch::RequestColorTableEntry(const size_t tableIndex)\n+{\n+    const auto color = _renderSettings.GetColorTableEntry(tableIndex);\n+    if (color != INVALID_COLOR)\n+    {\n+        const til::color c{ color };\n+        // Scale values up to match xterm's 16-bit color report format.\n+        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]4;{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+    }\n+\n+    return true;\n+}\n+\n // Method Description:\n-// - Sets the default foreground color to a new value\n-// Arguments:\n-// - dwColor: The new RGB color value to use, as a COLORREF, format 0x00BBGGRR.\n+// - Sets one Xterm Color Resource such as Default Foreground, Background, Cursor\n // Return Value:\n // True if handled successfully. False otherwise.\n-bool AdaptDispatch::SetDefaultForeground(const DWORD dwColor)\n+bool AdaptDispatch::SetXtermColorResource(const size_t resource, const DWORD color)\n {\n-    _renderSettings.SetColorAliasIndex(ColorAlias::DefaultForeground, TextColor::DEFAULT_FOREGROUND);\n-    return SetColorTableEntry(TextColor::DEFAULT_FOREGROUND, dwColor);\n+    assert(resource >= 10);\n+    const auto mappingIndex = resource - 10;\n+    const auto& oscMapping = XtermResourceColorTableMappings.at(mappingIndex);\n+    if (oscMapping.ColorTableIndex > 0)\n+    {\n+        if (oscMapping.AliasIndex >= 0) [[unlikely]]\n+        {\n+            // If this color change applies to an aliased color, point the alias at the new color\n+            _renderSettings.SetColorAliasIndex(static_cast<ColorAlias>(oscMapping.AliasIndex), oscMapping.ColorTableIndex);\n+        }\n+        return SetColorTableEntry(oscMapping.ColorTableIndex, color);\n+    }\n+\n+    return true;\n }\n \n // Method Description:\n-// - Sets the default background color to a new value\n-// Arguments:\n-// - dwColor: The new RGB color value to use, as a COLORREF, format 0x00BBGGRR.\n+// - Reports the value of one Xterm Color Resource, if it is set.\n // Return Value:\n // True if handled successfully. False otherwise.\n-bool AdaptDispatch::SetDefaultBackground(const DWORD dwColor)\n+bool AdaptDispatch::RequestXtermColorResource(const size_t resource)\n {\n-    _renderSettings.SetColorAliasIndex(ColorAlias::DefaultBackground, TextColor::DEFAULT_BACKGROUND);\n-    return SetColorTableEntry(TextColor::DEFAULT_BACKGROUND, dwColor);\n+    assert(resource >= 10);\n+    const auto mappingIndex = resource - 10;\n+    const auto& oscMapping = XtermResourceColorTableMappings.at(mappingIndex);\n+    if (oscMapping.ColorTableIndex > 0)\n+    {\n+        size_t finalColorIndex = oscMapping.ColorTableIndex;\n+\n+        if (oscMapping.AliasIndex >= 0) [[unlikely]]\n+        {\n+            finalColorIndex = _renderSettings.GetColorAliasIndex(static_cast<ColorAlias>(oscMapping.AliasIndex));\n+        }\n+\n+        const auto color = _renderSettings.GetColorTableEntry(finalColorIndex);\n+        if (color != INVALID_COLOR)\n+        {\n+            const til::color c{ color };\n+            // Scale values up to match xterm's 16-bit color report format.\n+            _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+        }\n+    }\n+\n+    return true;\n }\n \n // Method Description:\ndiff --git a/src/terminal/adapter/adaptDispatch.hpp b/src/terminal/adapter/adaptDispatch.hpp\nindex cba0273665d..ef5636be1e2 100644\n--- a/src/terminal/adapter/adaptDispatch.hpp\n+++ b/src/terminal/adapter/adaptDispatch.hpp\n@@ -126,14 +126,14 @@ namespace Microsoft::Console::VirtualTerminal\n         bool HardReset() override; // RIS\n         bool ScreenAlignmentPattern() override; // DECALN\n         bool SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle) override; // DECSCUSR\n-        bool SetCursorColor(const COLORREF cursorColor) override;\n \n         bool SetClipboard(const wil::zwstring_view content) override; // OSCSetClipboard\n \n         bool SetColorTableEntry(const size_t tableIndex,\n-                                const DWORD color) override; // OSCColorTable\n-        bool SetDefaultForeground(const DWORD color) override; // OSCDefaultForeground\n-        bool SetDefaultBackground(const DWORD color) override; // OSCDefaultBackground\n+                                const DWORD color) override; // OSCSetColorTable\n+        bool RequestColorTableEntry(const size_t tableIndex) override; // OSCGetColorTable\n+        bool SetXtermColorResource(const size_t resource, const DWORD color) override; // OSCSetDefaultForeground, OSCSetDefaultBackground, OSCSetCursorColor, OSCResetCursorColor\n+        bool RequestXtermColorResource(const size_t resource) override; // OSCGetDefaultForeground, OSCGetDefaultBackground, OSCGetCursorColor\n         bool AssignColor(const DispatchTypes::ColorItem item, const VTInt fgIndex, const VTInt bgIndex) override; // DECAC\n \n         bool WindowManipulation(const DispatchTypes::WindowManipulationType function,\ndiff --git a/src/terminal/adapter/termDispatch.hpp b/src/terminal/adapter/termDispatch.hpp\nindex 607089545bf..5d256928712 100644\n--- a/src/terminal/adapter/termDispatch.hpp\n+++ b/src/terminal/adapter/termDispatch.hpp\n@@ -69,9 +69,10 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     bool BackwardsTab(const VTInt /*numTabs*/) override { return false; } // CBT\r\n     bool TabClear(const DispatchTypes::TabClearType /*clearType*/) override { return false; } // TBC\r\n     bool TabSet(const VTParameter /*setType*/) override { return false; } // DECST8C\r\n-    bool SetColorTableEntry(const size_t /*tableIndex*/, const DWORD /*color*/) override { return false; } // OSCColorTable\r\n-    bool SetDefaultForeground(const DWORD /*color*/) override { return false; } // OSCDefaultForeground\r\n-    bool SetDefaultBackground(const DWORD /*color*/) override { return false; } // OSCDefaultBackground\r\n+    bool SetColorTableEntry(const size_t /*tableIndex*/, const DWORD /*color*/) override { return false; } // OSCSetColorTable\r\n+    bool RequestColorTableEntry(const size_t /*tableIndex*/) override { return false; } // OSCGetColorTable\r\n+    bool SetXtermColorResource(const size_t /*resource*/, const DWORD /*color*/) override { return false; } // OSCSetDefaultForeground, OSCSetDefaultBackground, OSCSetCursorColor, OSCResetCursorColor\r\n+    bool RequestXtermColorResource(const size_t /*resource*/) override { return false; } // OSCGetDefaultForeground, OSCGetDefaultBackground, OSCGetCursorColor\r\n     bool AssignColor(const DispatchTypes::ColorItem /*item*/, const VTInt /*fgIndex*/, const VTInt /*bgIndex*/) override { return false; } // DECAC\r\n \r\n     bool EraseInDisplay(const DispatchTypes::EraseType /* eraseType*/) override { return false; } // ED\r\n@@ -121,7 +122,6 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     bool ScreenAlignmentPattern() override { return false; } // DECALN\r\n \r\n     bool SetCursorStyle(const DispatchTypes::CursorStyle /*cursorStyle*/) override { return false; } // DECSCUSR\r\n-    bool SetCursorColor(const COLORREF /*color*/) override { return false; } // OSCSetCursorColor, OSCResetCursorColor\r\n \r\n     bool SetClipboard(wil::zwstring_view /*content*/) override { return false; } // OscSetClipboard\r\n \r\ndiff --git a/src/terminal/adapter/ut_adapter/adapterTest.cpp b/src/terminal/adapter/ut_adapter/adapterTest.cpp\nindex edd13ddab01..7d571086edd 100644\n--- a/src/terminal/adapter/ut_adapter/adapterTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/adapterTest.cpp\n@@ -2398,6 +2398,232 @@ class AdapterTest\n         _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n     }\r\n \r\n+    TEST_METHOD(Osc4ColorPaletteReportTests)\r\n+    {\r\n+        _testGetSet->PrepData();\r\n+\r\n+        // The colors below use the same VT525 colors as the other color table report tests.\r\n+        auto& renderSettings = _testGetSet->_renderer._renderSettings;\r\n+        renderSettings.SetColorTableEntry(0, RGB(0, 0, 0));\r\n+        renderSettings.SetColorTableEntry(1, RGB(204, 36, 36));\r\n+        renderSettings.SetColorTableEntry(2, RGB(51, 204, 51));\r\n+        renderSettings.SetColorTableEntry(3, RGB(204, 204, 51));\r\n+        renderSettings.SetColorTableEntry(4, RGB(51, 51, 204));\r\n+        renderSettings.SetColorTableEntry(5, RGB(204, 51, 204));\r\n+        renderSettings.SetColorTableEntry(6, RGB(51, 204, 204));\r\n+        renderSettings.SetColorTableEntry(7, RGB(120, 120, 120));\r\n+        renderSettings.SetColorTableEntry(8, RGB(69, 69, 69));\r\n+        renderSettings.SetColorTableEntry(9, RGB(255, 0, 0));\r\n+        renderSettings.SetColorTableEntry(10, RGB(0, 255, 0));\r\n+        renderSettings.SetColorTableEntry(11, RGB(255, 255, 0));\r\n+        renderSettings.SetColorTableEntry(12, RGB(0, 0, 255));\r\n+        renderSettings.SetColorTableEntry(13, RGB(255, 0, 255));\r\n+        renderSettings.SetColorTableEntry(14, RGB(0, 255, 255));\r\n+        renderSettings.SetColorTableEntry(15, RGB(255, 255, 255));\r\n+        for (size_t i = 16; i < TextColor::TABLE_SIZE; i++)\r\n+        {\r\n+            renderSettings.SetColorTableEntry(i, RGB(0, 0, 0));\r\n+        }\r\n+\r\n+        // Dynamic color reports begin with an OSC, parameter 4, another parameter for the index, and end with ST.\r\n+        const auto OSC = L\"\\033]\";\r\n+        const auto ST = L\"\\033\\\\\";\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        std::wstring expectedResponse = OSC;\r\n+        expectedResponse += L\"4;0;rgb:0000/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(1);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;1;rgb:cccc/2424/2424\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(2);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;2;rgb:3333/cccc/3333\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(3);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;3;rgb:cccc/cccc/3333\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(4);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;4;rgb:3333/3333/cccc\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(5);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;5;rgb:cccc/3333/cccc\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(6);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;6;rgb:3333/cccc/cccc\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(7);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;7;rgb:7878/7878/7878\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(8);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;8;rgb:4545/4545/4545\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(9);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;9;rgb:ffff/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(10);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;10;rgb:0000/ffff/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(11);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;11;rgb:ffff/ffff/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(12);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;12;rgb:0000/0000/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(13);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;13;rgb:ffff/0000/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(14);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;14;rgb:0000/ffff/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(15);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;15;rgb:ffff/ffff/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+    }\r\n+\r\n+    TEST_METHOD(XtermColorResourceReportTests)\r\n+    {\r\n+        _testGetSet->PrepData();\r\n+\r\n+        // The colors below use the same VT525 colors as the other color table report tests.\r\n+        auto& renderSettings = _testGetSet->_renderer._renderSettings;\r\n+        renderSettings.SetColorTableEntry(0, RGB(0, 0, 0));\r\n+        renderSettings.SetColorTableEntry(1, RGB(204, 36, 36));\r\n+        renderSettings.SetColorTableEntry(2, RGB(51, 204, 51));\r\n+        renderSettings.SetColorTableEntry(3, RGB(204, 204, 51));\r\n+        renderSettings.SetColorTableEntry(4, RGB(51, 51, 204));\r\n+        renderSettings.SetColorTableEntry(5, RGB(204, 51, 204));\r\n+        renderSettings.SetColorTableEntry(6, RGB(51, 204, 204));\r\n+        renderSettings.SetColorTableEntry(7, RGB(120, 120, 120));\r\n+        renderSettings.SetColorTableEntry(8, RGB(69, 69, 69));\r\n+        renderSettings.SetColorTableEntry(9, RGB(255, 0, 0));\r\n+        renderSettings.SetColorTableEntry(10, RGB(0, 255, 0));\r\n+        renderSettings.SetColorTableEntry(11, RGB(255, 255, 0));\r\n+        renderSettings.SetColorTableEntry(12, RGB(0, 0, 255));\r\n+        renderSettings.SetColorTableEntry(13, RGB(255, 0, 255));\r\n+        renderSettings.SetColorTableEntry(14, RGB(0, 255, 255));\r\n+        renderSettings.SetColorTableEntry(15, RGB(255, 255, 255));\r\n+\r\n+        renderSettings.SetColorTableEntry(TextColor::DEFAULT_FOREGROUND, RGB(190, 190, 190));\r\n+        renderSettings.SetColorTableEntry(TextColor::DEFAULT_BACKGROUND, RGB(12, 12, 12));\r\n+        renderSettings.SetColorTableEntry(TextColor::CURSOR_COLOR, RGB(255, 0, 0));\r\n+\r\n+        // Dynamic color reports begin with an OSC, a parameter matching the requested value, and end with ST.\r\n+        const auto OSC = L\"\\033]\";\r\n+        const auto ST = L\"\\033\\\\\";\r\n+\r\n+        // Foreground mapped to DARK_WHITE\r\n+        _pDispatch->RequestXtermColorResource(10);\r\n+        std::wstring expectedResponse = OSC;\r\n+        expectedResponse += L\"10;rgb:7878/7878/7878\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Foreground mapped to independent foreground color\r\n+        renderSettings.SetColorAliasIndex(ColorAlias::DefaultForeground, TextColor::DEFAULT_FOREGROUND);\r\n+        _pDispatch->RequestXtermColorResource(10);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"10;rgb:bebe/bebe/bebe\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Background mapped to DARK_BLACK\r\n+        _pDispatch->RequestXtermColorResource(11);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"11;rgb:0000/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Background mapped to independent background color\r\n+        renderSettings.SetColorAliasIndex(ColorAlias::DefaultBackground, TextColor::DEFAULT_BACKGROUND);\r\n+        _pDispatch->RequestXtermColorResource(11);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"11;rgb:0c0c/0c0c/0c0c\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Foreground and Background mapped to different indices (e.g. via DECAC)\r\n+        {\r\n+            _testGetSet->_response.clear(); // manually clear (since we aren't issuing a call that will empty it)\r\n+            auto retentionScope = _testGetSet->EnableInputRetentionInScope();\r\n+            renderSettings.SetColorAliasIndex(ColorAlias::DefaultForeground, TextColor::DARK_RED);\r\n+            renderSettings.SetColorAliasIndex(ColorAlias::DefaultBackground, TextColor::BRIGHT_GREEN);\r\n+            _pDispatch->RequestXtermColorResource(10);\r\n+            _pDispatch->RequestXtermColorResource(11);\r\n+            expectedResponse = OSC;\r\n+            expectedResponse += L\"10;rgb:cccc/2424/2424\";\r\n+            expectedResponse += ST;\r\n+            expectedResponse += OSC;\r\n+            expectedResponse += L\"11;rgb:0000/ffff/0000\";\r\n+            expectedResponse += ST;\r\n+            _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+        }\r\n+\r\n+        _pDispatch->RequestXtermColorResource(12);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"12;rgb:ffff/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Resource set to unrepresentable color\r\n+        _testGetSet->_response.clear(); // manually clear (since we aren't issuing a call that will empty it)\r\n+        renderSettings.SetColorTableEntry(TextColor::CURSOR_COLOR, INVALID_COLOR);\r\n+        _pDispatch->RequestXtermColorResource(12);\r\n+        expectedResponse = L\"\";\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Unsupported resource - no mapped color\r\n+        _testGetSet->_response.clear();\r\n+        _pDispatch->RequestXtermColorResource(13);\r\n+        expectedResponse = L\"\";\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+    }\r\n+\r\n     TEST_METHOD(TabulationStopReportTests)\r\n     {\r\n         _testGetSet->PrepData();\r\ndiff --git a/src/terminal/parser/InputStateMachineEngine.cpp b/src/terminal/parser/InputStateMachineEngine.cpp\nindex 645ff33a1dc..d98bfd98de2 100644\n--- a/src/terminal/parser/InputStateMachineEngine.cpp\n+++ b/src/terminal/parser/InputStateMachineEngine.cpp\n@@ -550,8 +550,19 @@ bool InputStateMachineEngine::ActionIgnore() noexcept\n // - string - OSC string we've collected. NOT null terminated.\r\n // Return Value:\r\n // - true if we handled the dispatch.\r\n-bool InputStateMachineEngine::ActionOscDispatch(const size_t /*parameter*/, const std::wstring_view /*string*/) noexcept\r\n+bool InputStateMachineEngine::ActionOscDispatch(const size_t /*parameter*/, const std::wstring_view /*string*/)\r\n {\r\n+    // Unlike ActionCsiDispatch, we are not checking whether the application has requested\r\n+    // VT input.\r\n+    // Our documentation states that VT reports generated by application requests will be\r\n+    // sent regardless of the state of `ENABLE_VIRTUAL_TERMINAL_INPUT`. We can't easily do\r\n+    // that for CSI reports because we may incidentally pass through non-response VT input;\r\n+    // however, there should be no OSC on the input stream *except* for responses.\r\n+    // It should be safe to pass all OSCs from the input stream through to the application.\r\n+    if (_pfnFlushToInputQueue)\r\n+    {\r\n+        return _pfnFlushToInputQueue();\r\n+    }\r\n     return false;\r\n }\r\n \r\ndiff --git a/src/terminal/parser/InputStateMachineEngine.hpp b/src/terminal/parser/InputStateMachineEngine.hpp\nindex 32159f6f947..a572ec41123 100644\n--- a/src/terminal/parser/InputStateMachineEngine.hpp\n+++ b/src/terminal/parser/InputStateMachineEngine.hpp\n@@ -157,7 +157,7 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         bool ActionIgnore() noexcept override;\r\n \r\n-        bool ActionOscDispatch(const size_t parameter, const std::wstring_view string) noexcept override;\r\n+        bool ActionOscDispatch(const size_t parameter, const std::wstring_view string) override;\r\n \r\n         bool ActionSs3Dispatch(const wchar_t wch, const VTParameters parameters) override;\r\n \r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.cpp b/src/terminal/parser/OutputStateMachineEngine.cpp\nindex 66c993ac06b..874f382642a 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.cpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.cpp\n@@ -14,6 +14,8 @@\n using namespace Microsoft::Console;\r\n using namespace Microsoft::Console::VirtualTerminal;\r\n \r\n+constexpr COLORREF COLOR_INQUIRY_COLOR = 0xfeffffff; // It's like INVALID_COLOR but special\r\n+\r\n // takes ownership of pDispatch\r\n OutputStateMachineEngine::OutputStateMachineEngine(std::unique_ptr<ITermDispatch> pDispatch) :\r\n     _dispatch(std::move(pDispatch)),\r\n@@ -788,7 +790,14 @@ bool OutputStateMachineEngine::ActionOscDispatch(const size_t parameter, const s\n         {\r\n             const auto tableIndex = til::at(tableIndexes, i);\r\n             const auto rgb = til::at(colors, i);\r\n-            success = success && _dispatch->SetColorTableEntry(tableIndex, rgb);\r\n+            if (rgb == COLOR_INQUIRY_COLOR)\r\n+            {\r\n+                success = success && _dispatch->RequestColorTableEntry(tableIndex);\r\n+            }\r\n+            else\r\n+            {\r\n+                success = success && _dispatch->SetColorTableEntry(tableIndex, rgb);\r\n+            }\r\n         }\r\n         break;\r\n     }\r\n@@ -800,40 +809,18 @@ bool OutputStateMachineEngine::ActionOscDispatch(const size_t parameter, const s\n         success = _GetOscSetColor(string, colors);\r\n         if (success)\r\n         {\r\n-            auto commandIndex = parameter;\r\n-            size_t colorIndex = 0;\r\n-\r\n-            if (commandIndex == OscActionCodes::SetForegroundColor && colors.size() > colorIndex)\r\n+            auto resource = parameter;\r\n+            for (auto&& color : colors)\r\n             {\r\n-                const auto color = til::at(colors, colorIndex);\r\n-                if (color != INVALID_COLOR)\r\n+                if (color == COLOR_INQUIRY_COLOR)\r\n                 {\r\n-                    success = success && _dispatch->SetDefaultForeground(color);\r\n+                    success = success && _dispatch->RequestXtermColorResource(resource);\r\n                 }\r\n-                commandIndex++;\r\n-                colorIndex++;\r\n-            }\r\n-\r\n-            if (commandIndex == OscActionCodes::SetBackgroundColor && colors.size() > colorIndex)\r\n-            {\r\n-                const auto color = til::at(colors, colorIndex);\r\n-                if (color != INVALID_COLOR)\r\n-                {\r\n-                    success = success && _dispatch->SetDefaultBackground(color);\r\n-                }\r\n-                commandIndex++;\r\n-                colorIndex++;\r\n-            }\r\n-\r\n-            if (commandIndex == OscActionCodes::SetCursorColor && colors.size() > colorIndex)\r\n-            {\r\n-                const auto color = til::at(colors, colorIndex);\r\n-                if (color != INVALID_COLOR)\r\n+                else if (color != INVALID_COLOR)\r\n                 {\r\n-                    success = success && _dispatch->SetCursorColor(color);\r\n+                    success = success && _dispatch->SetXtermColorResource(resource, color);\r\n                 }\r\n-                commandIndex++;\r\n-                colorIndex++;\r\n+                resource++;\r\n             }\r\n         }\r\n         break;\r\n@@ -851,7 +838,8 @@ bool OutputStateMachineEngine::ActionOscDispatch(const size_t parameter, const s\n     }\r\n     case OscActionCodes::ResetCursorColor:\r\n     {\r\n-        success = _dispatch->SetCursorColor(INVALID_COLOR);\r\n+        /* The reset codes for xterm dynamic resources are the set codes + 100 */\r\n+        success = _dispatch->SetXtermColorResource(parameter - 100u, INVALID_COLOR);\r\n         break;\r\n     }\r\n     case OscActionCodes::Hyperlink:\r\n@@ -938,6 +926,8 @@ bool OutputStateMachineEngine::_GetOscSetColorTable(const std::wstring_view stri\n                                                     std::vector<size_t>& tableIndexes,\r\n                                                     std::vector<DWORD>& rgbs) const\r\n {\r\n+    using namespace std::string_view_literals;\r\n+\r\n     const auto parts = Utils::SplitString(string, L';');\r\n     if (parts.size() < 2)\r\n     {\r\n@@ -949,13 +939,23 @@ bool OutputStateMachineEngine::_GetOscSetColorTable(const std::wstring_view stri\n \r\n     for (size_t i = 0, j = 1; j < parts.size(); i += 2, j += 2)\r\n     {\r\n+        auto&& index = til::at(parts, i);\r\n+        auto&& color = til::at(parts, j);\r\n         unsigned int tableIndex = 0;\r\n-        const auto indexSuccess = Utils::StringToUint(til::at(parts, i), tableIndex);\r\n-        const auto colorOptional = Utils::ColorFromXTermColor(til::at(parts, j));\r\n-        if (indexSuccess && colorOptional.has_value())\r\n+        const auto indexSuccess = Utils::StringToUint(index, tableIndex);\r\n+\r\n+        if (indexSuccess)\r\n         {\r\n-            newTableIndexes.push_back(tableIndex);\r\n-            newRgbs.push_back(colorOptional.value());\r\n+            if (color == L\"?\"sv) [[unlikely]]\r\n+            {\r\n+                newTableIndexes.push_back(tableIndex);\r\n+                newRgbs.push_back(COLOR_INQUIRY_COLOR);\r\n+            }\r\n+            else if (const auto colorOptional = Utils::ColorFromXTermColor(color))\r\n+            {\r\n+                newTableIndexes.push_back(tableIndex);\r\n+                newRgbs.push_back(colorOptional.value());\r\n+            }\r\n         }\r\n     }\r\n \r\n@@ -1032,6 +1032,8 @@ bool OutputStateMachineEngine::_ParseHyperlink(const std::wstring_view string,\n bool OutputStateMachineEngine::_GetOscSetColor(const std::wstring_view string,\r\n                                                std::vector<DWORD>& rgbs) const\r\n {\r\n+    using namespace std::string_view_literals;\r\n+\r\n     const auto parts = Utils::SplitString(string, L';');\r\n     if (parts.size() < 1)\r\n     {\r\n@@ -1039,10 +1041,14 @@ bool OutputStateMachineEngine::_GetOscSetColor(const std::wstring_view string,\n     }\r\n \r\n     std::vector<DWORD> newRgbs;\r\n-    for (size_t i = 0; i < parts.size(); i++)\r\n+    for (auto&& part : parts)\r\n     {\r\n-        const auto colorOptional = Utils::ColorFromXTermColor(til::at(parts, i));\r\n-        if (colorOptional.has_value())\r\n+        if (part == L\"?\"sv) [[unlikely]]\r\n+        {\r\n+            newRgbs.push_back(COLOR_INQUIRY_COLOR);\r\n+            continue;\r\n+        }\r\n+        else if (const auto colorOptional = Utils::ColorFromXTermColor(part))\r\n         {\r\n             newRgbs.push_back(colorOptional.value());\r\n         }\r\ndiff --git a/src/terminal/parser/ut_parser/OutputEngineTest.cpp b/src/terminal/parser/ut_parser/OutputEngineTest.cpp\nindex f19ad423fbc..8a5015e25cb 100644\n--- a/src/terminal/parser/ut_parser/OutputEngineTest.cpp\n+++ b/src/terminal/parser/ut_parser/OutputEngineTest.cpp\n@@ -1158,12 +1158,8 @@ class StatefulDispatch final : public TermDispatch\n         _numTabs{ 0 },\n         _tabClear{ false },\n         _tabClearTypes{},\n-        _setDefaultForeground(false),\n-        _defaultForegroundColor{ RGB(0, 0, 0) },\n-        _setDefaultBackground(false),\n-        _defaultBackgroundColor{ RGB(0, 0, 0) },\n-        _setDefaultCursorColor(false),\n-        _defaultCursorColor{ RGB(0, 0, 0) },\n+        _xtermResourcesChanged{},\n+        _xtermResourceValues{},\n         _hyperlinkMode{ false },\n         _options{ s_cMaxOptions, static_cast<DispatchTypes::GraphicsOptions>(s_uiGraphicsCleared) }, // fill with cleared option\n         _colorTable{},\n@@ -1432,24 +1428,22 @@ class StatefulDispatch final : public TermDispatch\n         return true;\n     }\n \n-    bool SetDefaultForeground(const DWORD color) noexcept override\n+    bool RequestColorTableEntry(const size_t tableIndex) noexcept override\n     {\n-        _setDefaultForeground = true;\n-        _defaultForegroundColor = color;\n+        _colorTableEntriesRequested.push_back(tableIndex);\n         return true;\n     }\n \n-    bool SetDefaultBackground(const DWORD color) noexcept override\n+    bool SetXtermColorResource(const size_t resource, const DWORD color) override\n     {\n-        _setDefaultBackground = true;\n-        _defaultBackgroundColor = color;\n+        _xtermResourcesChanged.push_back(resource);\n+        _xtermResourceValues.push_back(color);\n         return true;\n     }\n \n-    bool SetCursorColor(const DWORD color) noexcept override\n+    bool RequestXtermColorResource(const size_t resource) override\n     {\n-        _setDefaultCursorColor = true;\n-        _defaultCursorColor = color;\n+        _xtermResourcesRequested.push_back(resource);\n         return true;\n     }\n \n@@ -1529,13 +1523,11 @@ class StatefulDispatch final : public TermDispatch\n     size_t _numTabs;\n     bool _tabClear;\n     std::vector<DispatchTypes::TabClearType> _tabClearTypes;\n-    bool _setDefaultForeground;\n-    DWORD _defaultForegroundColor;\n-    bool _setDefaultBackground;\n-    DWORD _defaultBackgroundColor;\n-    bool _setDefaultCursorColor;\n-    DWORD _defaultCursorColor;\n+    std::vector<size_t> _xtermResourcesChanged;\n+    std::vector<DWORD> _xtermResourceValues;\n+    std::vector<size_t> _xtermResourcesRequested;\n     bool _setColorTableEntry;\n+    std::vector<size_t> _colorTableEntriesRequested;\n     bool _hyperlinkMode;\n     std::wstring _copyContent;\n     std::wstring _uri;\n@@ -2822,105 +2814,114 @@ class StateMachineExternalTest final\n \n         // Single param\n         mach.ProcessString(L\"\\033]10;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;rgb:12/34/56\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#123456\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Multiple params\n         mach.ProcessString(L\"\\033]10;#111;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;DarkOrange;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultBackgroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultCursorColor);\n-        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(3u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[2]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_xtermResourceValues[2]);\n \n         pDispatch->ClearState();\n \n         // Partially valid multi-param sequences.\n         mach.ProcessString(L\"\\033]10;#111;\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;rgb:\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;#2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#1;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Invalid sequences.\n         mach.ProcessString(L\"\\033]10;rgb:1/1/\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n     }\n@@ -2933,100 +2934,115 @@ class StateMachineExternalTest final\n         StateMachine mach(std::move(engine));\n \n         mach.ProcessString(L\"\\033]11;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Single param\n         mach.ProcessString(L\"\\033]11;rgb:12/34/56\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#123456\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Multiple params\n         mach.ProcessString(L\"\\033]11;#111;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n-        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;DarkOrange;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultCursorColor);\n-        // The third param is out of range.\n+        VERIFY_ARE_EQUAL(3u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(13u, pDispatch->_xtermResourcesChanged[2]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n+        // The third param is out of range, but it's technically still in compliance to set it\n \n         pDispatch->ClearState();\n \n         // Partially valid multi-param sequences.\n         mach.ProcessString(L\"\\033]11;#111;\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;rgb:\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;#2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultCursorColor);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#1;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultCursorColor);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Invalid sequences.\n         mach.ProcessString(L\"\\033]11;rgb:1/1/\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n     }\n@@ -3178,6 +3194,88 @@ class StateMachineExternalTest final\n         pDispatch->ClearState();\n     }\n \n+    TEST_METHOD(TestOscGetColorTableEntry)\n+    {\n+        auto dispatch = std::make_unique<StatefulDispatch>();\n+        auto pDispatch = dispatch.get();\n+        auto engine = std::make_unique<OutputStateMachineEngine>(std::move(dispatch));\n+        StateMachine mach(std::move(engine));\n+\n+        mach.ProcessString(L\"\\033]4;0;?;1;?;2;;3;?;4;?\\033\\\\\"); // Inquire about 0-4 skipping 2\n+        VERIFY_ARE_EQUAL((std::vector<size_t>{ 0u, 1u, 3u, 4u }), pDispatch->_colorTableEntriesRequested);\n+        pDispatch->ClearState();\n+\n+        mach.ProcessString(L\"\\033]4;0;rgb:00/00/00;1;rgb:00/00/01;2;?;3;rgb:00/00/03;4;rgb:00/00/04\\033\\\\\"); // Set 0-4, except 2 (inquire)\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 0), pDispatch->_colorTable.at(0));\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 1), pDispatch->_colorTable.at(1));\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 3), pDispatch->_colorTable.at(3));\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 4), pDispatch->_colorTable.at(4));\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_colorTableEntriesRequested.size()); // note: (1u, 2u) constructs a 1-length vector containing 2\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_colorTableEntriesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        pDispatch->_colorTable.at(3) = RGB(0xfe, 0xed, 0xfa);\n+        mach.ProcessString(L\"\\033]4;0;rgb:f0/00/00;1;?;3\\033\\\\\"); // Set 0, inquire 1, truncated 3\n+        VERIFY_ARE_EQUAL(RGB(0xf0, 0, 0), pDispatch->_colorTable.at(0));\n+        VERIFY_ARE_EQUAL(RGB(0xfe, 0xed, 0xfa), pDispatch->_colorTable.at(3)); // unchanged from before ProcessString\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_colorTableEntriesRequested.size()); // note: (1u, 2u) constructs a 1-length vector containing 2\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_colorTableEntriesRequested[0]);\n+        pDispatch->ClearState();\n+    }\n+\n+    TEST_METHOD(TestOscXtermResourceReport)\n+    {\n+        auto dispatch = std::make_unique<StatefulDispatch>();\n+        auto pDispatch = dispatch.get();\n+        auto engine = std::make_unique<OutputStateMachineEngine>(std::move(dispatch));\n+        StateMachine mach(std::move(engine));\n+\n+        mach.ProcessString(L\"\\033]10;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Two params, skip first\n+        mach.ProcessString(L\"\\033]10;;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Two params, set first\n+        mach.ProcessString(L\"\\033]10;rgb:11/22/33;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x22, 0x33), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Two params, set first, starting at 12\n+        mach.ProcessString(L\"\\033]12;rgb:11/22/33;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x22, 0x33), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(13u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Request all 10\n+        mach.ProcessString(L\"\\033]10;?;?;?;?;?;?;?;?;?;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        std::vector<size_t> expected{ 10u, 11u, 12u, 13u, 14u, 15u, 16u, 17u, 18u, 19u };\n+        VERIFY_ARE_EQUAL(expected, pDispatch->_xtermResourcesRequested);\n+        pDispatch->ClearState();\n+\n+        // Request out of range\n+        mach.ProcessString(L\"\\033]10;;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+    }\n+\n     TEST_METHOD(TestOscSetWindowTitle)\n     {\n         BEGIN_TEST_METHOD_PROPERTIES()\n", "test_patch": "", "problem_statement": "Support querying the colors via OSC\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\nOSC 4, 10, 11 and friends, with a `?` instead of a color, respond with the current value of that color in xterm, vte and quite a few other terminals, always using the `rgb:RRRR/GGGG/BBBB` notation, and the same terminator (ST vs. BEL) as in the query.\r\n\r\nExamples:\r\n\r\n    echo -ne '\\e]4;1;?\\e\\\\'; cat\r\n\r\n    echo -ne '\\e]11;?\\a'; cat\r\n\r\nThis allows apps (e.g. vim) to automatically pick a color scheme depending on whether the user has a dark-on-bright on bright-on-dark color scheme. I don't know if it's actually being used in practice, though :D\r\n\n", "hints_text": "I should probably raise a separate issue for this, but I just wanted to note that there are standard DEC sequences for querying the color table (and setting it for that matter) which we may want to support as well.\nNote that VTE responds with `rgb:RRRR/GGGG/BBBB` format. But iTerm2 responds with `rgb:RR/GG/BB` format. I don't have a daily Linux machine so I don't know what xterm is using. \nI just tested urxvt and it responded with `rgba:0000/0000/0000/f332` :)\nWell that's awkward. So I have to assume that XTerm has support for `rgba:` (and at the same time,`rgbi`, according to @egmontkob) ?\r\n\r\nPersonally I'd prefer `rgb:RR/GG/BB` since it's close to `#RRGGBB` which is everywhere on the web.\r\n\nFrom the [XParseColor docs](https://www.xfree86.org/4.8.0/XLookupColor.3.html#toc4) (via the [Xterm docs for OSC 4](http://www.xfree86.org/4.5.0/ctlseqs.html)), the RR vs RRR vs RRRR is about the bit-depth of the value. So `rgb:RR/GG/BB` is 24-bit colour (8/8/8/0), and anything longer is really Wide Colour Gamut, and should be scaled down. (Hence things like `#302351` being `rgba:3000/2300/5100/ee00` in [urxvt tips-and-tricks](https://wiki.archlinux.org/index.php/Rxvt-unicode/Tips_and_tricks), assuming a linear tone-mapping function.\r\n\r\nThat said, I guess we don't have native WCG support in Terminal right now, and I expect we'd return the 24-bit colours we are working with, not the tone-mapped resulting colours if we happen to be running on a WCG-based display.\r\n\r\nSo I also support `rgb:RR/GG/BB` as long as we're working from a 24-bit palette.\r\n\r\nI'm guessing `rgba:` is a common extension for alpha... It's not in the `XParseColor` docs, and I remember back in the day, the best reason to use rxvt over xterm was transparent backgrounds... Perhaps `rgba:` is (or was) an rxvt-specific extension?\r\n\r\nLooks like it was [rxvt-specific](https://github.com/exg/rxvt-unicode/blob/master/src/rxvttoolkit.C#L841-L860), and unlike `rgb:`, `rgba:` is [specified](https://linux.die.net/man/1/urxvt) to *always* have 16 bits _per channel_. Someone was very forward-thinking in the 90's... Or lazy when writing a string parser.\nI've tested the color table queries on 9 different terminal emulators - every one of them (including XTerm , Gnome Terminal, Konsole, and Rxvt) reported the colors as `rgb:rrrr/gggg/bbbb` (typically scaled up from the internal 24-bit representation). I see in the Rxvt source that there is a build option that will make it return `rgba`, but that didn't seem to be active on my test system - perhaps it's OS dependent? In any event, I'd think the `rgb:rrrr/gggg/bbbb` format is almost certainly the right choice if we want to be compatible with what most people are doing.\r\n\r\nRegarding the other color formats, XTerm does support rgbi and the various cie variants, but the report format is always rgb.\r\n\nOut of sheer curiosity, what is the reason that makes iTerm2 the weirdest kid in town?\r\n\r\nCC @gnachman \nI believe iTerm2 has an option to choose between reporting as `rgb:rrrr/gggg/bbbb` and `rgb:rr/gg/bb`. They got it wrong initially, and then were forced to add the option to support the correct format because it was breaking in vim.\nI used 8 bit codes originally for reasons I no longer recall. I was made aware of the issue in this post: https://groups.google.com/g/iterm2-discuss/c/xXzeBY2aRjo/m/zHBZreQWCQAJ\r\n\r\nCommit 5c5785f3632b8e90dd69f458411a8b8b17aa0599 changed the default to 16 bits. It is now enabled in 3.4.0 betas, which will exit beta when Big Sur is released.\nTo be clear, per the spec, _both_ `rgb:rr/gg/bb` and `rgb:rrrr/gggg/bbbb` are valid. So is `rgb:rrr/ggg/bbb`, and a few other options. The item2-discuss link from @gnachman shows that it was a bug in vim before 8.1, that it incorrectly implemented the `XParseColor`-compatible colour parser.\r\n\r\nThat said, the commonality of vim, particularly older vim, means it's probably worth being bug-compatible here from the start, even though it's being overly-precise.\r\n\r\nMy reading of the Xterm docs for OSC 4 is that if you call `OSC 4 XXXX`, then `OSC 4 ?` should be returning precisely that `XXXX`, but I can see how it can be read to allow returning some numerically-equivalent values, i.e. 48-bit RGB, even if the `XXX` was originally `CIELab:...`.\n> My reading of the Xterm docs for OSC 4 is that if you call `OSC 4 XXXX`, then `OSC 4 ?` should be returning precisely that `XXXX`\r\n\r\nYeah, it certainly does read like that. But in practice the spec is defined by the reference implementation, which in this case is XTerm. If you want to be \"spec compliant\" you need to match whatever XTerm does. And when you think about it, it makes sense for your terminal to be liberal in what it accepts (i.e. supporting as many formats as possible), but conservative in what it produces as a response (you can't reasonably expect every application that queries the palette to understand all the different formats).\nThat's fair. And given that (for an older version, I didn't check anything newer) xterm `OSC 4 n ?` produces [`XQueryColor` formatted as `rgb:%04x/%04x/%04x`](https://github.com/ThomasDickey/old-xterm/blob/master/misc.c#L1334-L1351), that seems a safe thing to do.\r\n\r\n> you can't reasonably expect every application that queries the palette to understand all the different formats\r\n\r\nI agree in general. In this case however, because it's not \"all the different formats\", it's a format defined by a specific API (`XParseColor`), I would absolutely expect *of myself* that a parser was prepared to handle those documented formats. Apps on X11 of course have it easy, because they can just _use_ `XParseColor`, but I'm unaware off-hand of anyone knocking together an X11-independent implementation of the API, which is a shame, but I guess the OSC colour codes are the only, highly-specific use-case for such a thing.\r\n\r\nIt may not be _kind_ to specify an API behaviour in terms of the API it's implemented with underneath, but that is what we have here. (Edit: If anyone's looking for the implementation side of `XParseColor`, the colour space parsing is farmed out to functions pointed to by the [`struct XcmsColorSpace` instances](https://github.com/freedesktop/xorg-libX11/blob/d127217f26df1bf7566c1f372d8b5329a06754ea/src/xcms/Cv.h#L16-L23), and [libXRender separately defines `rgba:`](https://github.com/freedesktop/xorg-libXrender/blob/bce0618839fc33f44edd8b5498b8e33d167806ff/src/Color.c#L33-L74) in `XRenderParseColor`).\r\n\r\nThat said, Microsoft Terminal [cannot _consume_ `rgb:rrrr/gggg/bbbb` for OSC 4 right now](https://github.com/microsoft/terminal/blob/88d1527985123aea66537447241e3fa989fbf755/src/terminal/parser/OutputStateMachineEngine.cpp#L1539-L1548), so we probably need to fix that, or we end up in the situation where we cannot roundtrip our `OSC 4 n ?` back to `OSC 4 x <string we saved earlier>`.\r\n\r\nOur [local implementation of `XParseColor`](https://github.com/microsoft/terminal/blob/88d1527985123aea66537447241e3fa989fbf755/src/terminal/parser/OutputStateMachineEngine.cpp#L1409-L1420) could do with some love too.\nI\u2019m working on it. See #7578 if you have time \ud83d\ude04 \nHello, I am also bumping into this issue. Vim calls [OSC 11;?](https://github.com/vim/vim/blob/master/src/term.c#L901) to fetch the terminal's background color when determining what color scheme to use; but because WT does not support fetching this OSC value (only setting it) vim defaults to a color scheme for light terminals.\r\n\r\nIs my understanding correct that the outlines of what needs to be done have been laid out but that this feature is not actively under development?\nYep, that's about the long and short of it. We've already got code elsewhere in the parser for replying to queries, so that can be done. We'd just need conpty to pass through the query through to the connected terminal, and have the terminal reply. Probably wouldn't be that hard, but it's just fairly low down on the backlog currently. We'd happily accept a community contribution though!\nAhh, ok, understood. Thank you for the summary! If I have some down time in the next few weeks I will start poking around and putting a PR together.\n@mboruta1  I was working on this area previously. The PRs related are #7578 and #8999. It might help you with the \u201cpoking around\u201d of the codebase \ud83d\ude03\nThank you @skyline75489 :)\nI, too, would love to see this.\r\n\r\nI'm cycling colors with a python script, and can't start the color cycle at the existing color without knowing what it is.\r\n\r\nRe-creating an old dos program called glow.exe, basically.", "created_at": "2024-08-16 20:54:03", "merge_commit_sha": "3b4ee83ed1edd9fada5750155fce988d082a2821", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17706", "base_commit": "0199ca33ddb4a02ca3549627d772ce6b330ed1ce", "patch": "diff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png\nnew file mode 100644\nindex 00000000000..9e712ad8d95\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png\nnew file mode 100644\nindex 00000000000..82aa697c74f\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png\nnew file mode 100644\nindex 00000000000..ea8c240656d\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png\nnew file mode 100644\nindex 00000000000..54a8c126ff7\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png\nnew file mode 100644\nindex 00000000000..66486474a59\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png\nnew file mode 100644\nindex 00000000000..68aa47b458f\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png\nnew file mode 100644\nindex 00000000000..1fa174e5ac7\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png\nnew file mode 100644\nindex 00000000000..57615ac57ee\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png\nnew file mode 100644\nindex 00000000000..d7f31d5d715\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png differ\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\nindex 3d576f60603..6febe041d67 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n@@ -20,9 +20,6 @@\n #include \"SshHostGenerator.h\"\r\n #endif\r\n \r\n-// userDefault.h is like the above, but with a default template for the user's settings.json.\r\n-#include <LegacyProfileGeneratorNamespaces.h>\r\n-\r\n #include \"ApplicationState.h\"\r\n #include \"DefaultTerminal.h\"\r\n #include \"FileUtils.h\"\r\n@@ -465,6 +462,11 @@ bool SettingsLoader::FixupUserSettings()\n         CommandlinePatch{ DEFAULT_WINDOWS_POWERSHELL_GUID, L\"powershell.exe\", L\"%SystemRoot%\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\" },\r\n     };\r\n \r\n+    static constexpr std::array iconsToClearFromVisualStudioProfiles{\r\n+        std::wstring_view{ L\"ms-appx:///ProfileIcons/{61c54bbd-c2c6-5271-96e7-009a87ff44bf}.png\" },\r\n+        std::wstring_view{ L\"ms-appx:///ProfileIcons/{0caa0dad-35be-5f56-a8ff-afceeeaa6101}.png\" },\r\n+    };\r\n+\r\n     auto fixedUp = userSettings.fixupsAppliedDuringLoad;\r\n     fixedUp = userSettings.globals->FixupsAppliedDuringLoad() || fixedUp;\r\n \r\n@@ -473,28 +475,39 @@ bool SettingsLoader::FixupUserSettings()\n     {\r\n         fixedUp = RemapColorSchemeForProfile(profile) || fixedUp;\r\n \r\n-        if (!profile->HasCommandline())\r\n+        if (profile->HasCommandline())\r\n         {\r\n-            continue;\r\n+            for (const auto& patch : commandlinePatches)\r\n+            {\r\n+                if (profile->Guid() == patch.guid && til::equals_insensitive_ascii(profile->Commandline(), patch.before))\r\n+                {\r\n+                    profile->ClearCommandline();\r\n+\r\n+                    // GH#12842:\r\n+                    // With the commandline field on the user profile gone, it's actually unknown what\r\n+                    // commandline it'll inherit, since a user profile can have multiple parents. We have to\r\n+                    // make sure we restore the correct commandline in case we don't inherit the expected one.\r\n+                    if (profile->Commandline() != patch.after)\r\n+                    {\r\n+                        profile->Commandline(winrt::hstring{ patch.after });\r\n+                    }\r\n+\r\n+                    fixedUp = true;\r\n+                    break;\r\n+                }\r\n+            }\r\n         }\r\n \r\n-        for (const auto& patch : commandlinePatches)\r\n+        if (profile->HasIcon() && profile->HasSource() && profile->Source() == VisualStudioGenerator::Namespace)\r\n         {\r\n-            if (profile->Guid() == patch.guid && til::equals_insensitive_ascii(profile->Commandline(), patch.before))\r\n+            for (auto&& icon : iconsToClearFromVisualStudioProfiles)\r\n             {\r\n-                profile->ClearCommandline();\r\n-\r\n-                // GH#12842:\r\n-                // With the commandline field on the user profile gone, it's actually unknown what\r\n-                // commandline it'll inherit, since a user profile can have multiple parents. We have to\r\n-                // make sure we restore the correct commandline in case we don't inherit the expected one.\r\n-                if (profile->Commandline() != patch.after)\r\n+                if (profile->Icon() == icon)\r\n                 {\r\n-                    profile->Commandline(winrt::hstring{ patch.after });\r\n+                    profile->ClearIcon();\r\n+                    fixedUp = true;\r\n+                    break;\r\n                 }\r\n-\r\n-                fixedUp = true;\r\n-                break;\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.cpp b/src/cascadia/TerminalSettingsModel/Profile.cpp\nindex 0f568b37e53..66382c857b1 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Profile.cpp\n@@ -329,7 +329,7 @@ Json::Value Profile::ToJson() const\n     // Recall: Icon isn't actually a setting in the MTSM_PROFILE_SETTINGS. We\r\n     // defined it manually in Profile, so make sure we only serialize the Icon\r\n     // if the user actually changed it here.\r\n-    JsonUtils::SetValueForKey(json, IconKey, (writeBasicSettings && HasIcon()) ? Icon() : _Icon);\r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n \r\n     // PermissiveStringConverter is unnecessary for serialization\r\n     JsonUtils::SetValueForKey(json, PaddingKey, _Padding);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\nindex 3fd3bca8a71..2fcfb1cc528 100644\n--- a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\n+++ b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\n@@ -9,9 +9,11 @@\n \r\n using namespace winrt::Microsoft::Terminal::Settings::Model;\r\n \r\n+std::wstring_view VisualStudioGenerator::Namespace{ L\"Windows.Terminal.VisualStudio\" };\r\n+\r\n std::wstring_view VisualStudioGenerator::GetNamespace() const noexcept\r\n {\r\n-    return std::wstring_view{ L\"Windows.Terminal.VisualStudio\" };\r\n+    return Namespace;\r\n }\r\n \r\n void VisualStudioGenerator::GenerateProfiles(std::vector<winrt::com_ptr<implementation::Profile>>& profiles) const\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\nindex 766d2cd7775..ef36284db74 100644\n--- a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\n@@ -26,6 +26,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n     class VisualStudioGenerator : public IDynamicProfileGenerator\r\n     {\r\n     public:\r\n+        static std::wstring_view Namespace;\r\n         std::wstring_view GetNamespace() const noexcept override;\r\n         void GenerateProfiles(std::vector<winrt::com_ptr<implementation::Profile>>& profiles) const override;\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h b/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\nindex dd5d42dba38..eab94e89546 100644\n--- a/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\n@@ -41,7 +41,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n \r\n         std::wstring GetProfileIconPath() const\r\n         {\r\n-            return L\"ms-appx:///ProfileIcons/{0caa0dad-35be-5f56-a8ff-afceeeaa6101}.png\";\r\n+            return L\"ms-appx:///ProfileIcons/vs-cmd.png\";\r\n         }\r\n \r\n         std::wstring GetProfileName(const VsSetupConfiguration::VsSetupInstance& instance) const;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h b/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\nindex b7d14e8b951..7557b503c0b 100644\n--- a/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\n@@ -38,7 +38,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n \r\n         std::wstring GetProfileIconPath() const\r\n         {\r\n-            return L\"ms-appx:///ProfileIcons/{61c54bbd-c2c6-5271-96e7-009a87ff44bf}.png\";\r\n+            return L\"ms-appx:///ProfileIcons/vs-powershell.png\";\r\n         }\r\n \r\n         std::wstring GetProfileName(const VsSetupConfiguration::VsSetupInstance& instance) const;\r\n", "test_patch": "", "problem_statement": "Better icons for Visual Studio Developer Command Prompt/Powershell profiles\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\nCustom icons for the `Developer PowerShell for VS 2022` and `Developer Command Prompt for VS 2022` profiles would be a nice touch.\r\n\r\n![5tXWrREqj0](https://github.com/user-attachments/assets/2456f899-1a19-4dfe-848c-e8543d339584)\r\n\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\n# Proposed technical implementation details (optional)\r\nInclude images in the app's `ProfileIcons/` directory and automatically use them for said profiles. I threw these together in GIMP. If they are satisfactory, feel free to use them.\r\n\r\n![cmd_vs](https://github.com/user-attachments/assets/1d3da7f9-1de7-40f1-9932-196fa10ec130)\r\n\r\n![powershell5_vs](https://github.com/user-attachments/assets/1cb5ab60-31b2-4825-8666-74eca7b243fa)\r\n\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\r\n\n", "hints_text": "", "created_at": "2024-08-12 23:49:12", "merge_commit_sha": "06c07ab50dd75af3e1a1afc51cb4c688190fda92", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17695", "base_commit": "0199ca33ddb4a02ca3549627d772ce6b330ed1ce", "patch": "diff --git a/src/interactivity/win32/uiaTextRange.cpp b/src/interactivity/win32/uiaTextRange.cpp\nindex eb78d090cfc..028e181b383 100644\n--- a/src/interactivity/win32/uiaTextRange.cpp\n+++ b/src/interactivity/win32/uiaTextRange.cpp\n@@ -69,14 +69,14 @@ IFACEMETHODIMP UiaTextRange::Clone(_Outptr_result_maybenull_ ITextRangeProvider*\n     return S_OK;\r\n }\r\n \r\n-void UiaTextRange::_TranslatePointToScreen(til::point* clientPoint) const\r\n+void UiaTextRange::_TranslatePointToScreen(til::point& clientPoint) const\r\n {\r\n-    ClientToScreen(_getWindowHandle(), clientPoint->as_win32_point());\r\n+    ClientToScreen(_getWindowHandle(), clientPoint.as_win32_point());\r\n }\r\n \r\n-void UiaTextRange::_TranslatePointFromScreen(til::point* screenPoint) const\r\n+void UiaTextRange::_TranslatePointFromScreen(til::point& screenPoint) const\r\n {\r\n-    ScreenToClient(_getWindowHandle(), screenPoint->as_win32_point());\r\n+    ScreenToClient(_getWindowHandle(), screenPoint.as_win32_point());\r\n }\r\n \r\n HWND UiaTextRange::_getWindowHandle() const\r\ndiff --git a/src/interactivity/win32/uiaTextRange.hpp b/src/interactivity/win32/uiaTextRange.hpp\nindex 7ea79364d5d..84f8b5a5392 100644\n--- a/src/interactivity/win32/uiaTextRange.hpp\n+++ b/src/interactivity/win32/uiaTextRange.hpp\n@@ -56,8 +56,8 @@ namespace Microsoft::Console::Interactivity::Win32\n         IFACEMETHODIMP Clone(_Outptr_result_maybenull_ ITextRangeProvider** ppRetVal) override;\r\n \r\n     protected:\r\n-        void _TranslatePointToScreen(til::point* clientPoint) const override;\r\n-        void _TranslatePointFromScreen(til::point* screenPoint) const override;\r\n+        void _TranslatePointToScreen(til::point& clientPoint) const override;\r\n+        void _TranslatePointFromScreen(til::point& screenPoint) const override;\r\n \r\n     private:\r\n         HWND _getWindowHandle() const;\r\ndiff --git a/src/types/TermControlUiaTextRange.cpp b/src/types/TermControlUiaTextRange.cpp\nindex 6f3c82e8180..5b26dd5189d 100644\n--- a/src/types/TermControlUiaTextRange.cpp\n+++ b/src/types/TermControlUiaTextRange.cpp\n@@ -73,7 +73,7 @@ IFACEMETHODIMP TermControlUiaTextRange::Clone(_Outptr_result_maybenull_ ITextRan\n //                (0,0) is the top-left of the app window\r\n // Return Value:\r\n // - <none>\r\n-void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) const\r\n+void TermControlUiaTextRange::_TranslatePointToScreen(til::point& clientPoint) const\r\n {\r\n     const gsl::not_null<TermControlUiaProvider*> provider = static_cast<TermControlUiaProvider*>(_pProvider);\r\n \r\n@@ -96,8 +96,8 @@ void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) c\n     // Get scale factor for display\r\n     const auto scaleFactor = provider->GetScaleFactor();\r\n \r\n-    clientPoint->x = includeOffsets(clientPoint->x, boundingRect.left, padding.left, scaleFactor);\r\n-    clientPoint->y = includeOffsets(clientPoint->y, boundingRect.top, padding.top, scaleFactor);\r\n+    clientPoint.x = includeOffsets(clientPoint.x, boundingRect.left, padding.left, scaleFactor);\r\n+    clientPoint.y = includeOffsets(clientPoint.y, boundingRect.top, padding.top, scaleFactor);\r\n }\r\n \r\n // Method Description:\r\n@@ -107,15 +107,13 @@ void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) c\n //                (0,0) is the top-left of the screen\r\n // Return Value:\r\n // - <none>\r\n-void TermControlUiaTextRange::_TranslatePointFromScreen(til::point* screenPoint) const\r\n+void TermControlUiaTextRange::_TranslatePointFromScreen(til::point& screenPoint) const\r\n {\r\n     const gsl::not_null<TermControlUiaProvider*> provider = static_cast<TermControlUiaProvider*>(_pProvider);\r\n \r\n     const auto includeOffsets = [](long screenPos, double termControlPos, double padding, double scaleFactor) {\r\n-        auto result = base::ClampedNumeric<double>(padding);\r\n-        // only the padding is in DIPs now\r\n-        result /= scaleFactor;\r\n-        result -= screenPos;\r\n+        auto result = base::ClampedNumeric<til::CoordType>(screenPos);\r\n+        result -= padding / scaleFactor;\r\n         result -= termControlPos;\r\n         return result;\r\n     };\r\n@@ -130,8 +128,8 @@ void TermControlUiaTextRange::_TranslatePointFromScreen(til::point* screenPoint)\n     // Get scale factor for display\r\n     const auto scaleFactor = provider->GetScaleFactor();\r\n \r\n-    screenPoint->x = includeOffsets(screenPoint->x, boundingRect.left, padding.left, scaleFactor);\r\n-    screenPoint->y = includeOffsets(screenPoint->y, boundingRect.top, padding.top, scaleFactor);\r\n+    screenPoint.x = includeOffsets(screenPoint.x, boundingRect.left, padding.left, scaleFactor);\r\n+    screenPoint.y = includeOffsets(screenPoint.y, boundingRect.top, padding.top, scaleFactor);\r\n }\r\n \r\n til::size TermControlUiaTextRange::_getScreenFontSize() const noexcept\r\ndiff --git a/src/types/TermControlUiaTextRange.hpp b/src/types/TermControlUiaTextRange.hpp\nindex 70ba9cac979..e619583a9e9 100644\n--- a/src/types/TermControlUiaTextRange.hpp\n+++ b/src/types/TermControlUiaTextRange.hpp\n@@ -56,8 +56,8 @@ namespace Microsoft::Terminal\n         IFACEMETHODIMP Clone(_Outptr_result_maybenull_ ITextRangeProvider** ppRetVal) override;\r\n \r\n     protected:\r\n-        void _TranslatePointToScreen(til::point* clientPoint) const override;\r\n-        void _TranslatePointFromScreen(til::point* screenPoint) const override;\r\n+        void _TranslatePointToScreen(til::point& clientPoint) const override;\r\n+        void _TranslatePointFromScreen(til::point& screenPoint) const override;\r\n         til::size _getScreenFontSize() const noexcept override;\r\n     };\r\n }\r\ndiff --git a/src/types/UiaTextRangeBase.cpp b/src/types/UiaTextRangeBase.cpp\nindex 8e83ef47aa0..0ce958e6985 100644\n--- a/src/types/UiaTextRangeBase.cpp\n+++ b/src/types/UiaTextRangeBase.cpp\n@@ -97,30 +97,24 @@ CATCH_RETURN();\n \r\n void UiaTextRangeBase::Initialize(_In_ const UiaPoint point)\r\n {\r\n-    til::point clientPoint;\r\n-    clientPoint.x = static_cast<LONG>(point.x);\r\n-    clientPoint.y = static_cast<LONG>(point.y);\r\n-    // get row that point resides in\r\n+    til::point clientPoint{ static_cast<til::CoordType>(point.x), static_cast<til::CoordType>(point.y) };\r\n+\r\n+    // clamp the point to be within the client area\r\n     const auto windowRect = _getTerminalRect();\r\n+    clientPoint.x = std::clamp(clientPoint.x, windowRect.left, windowRect.right);\r\n+    clientPoint.y = std::clamp(clientPoint.y, windowRect.top, windowRect.bottom);\r\n+\r\n+    // convert point to be relative to client area\r\n+    _TranslatePointFromScreen(clientPoint);\r\n+\r\n+    // convert the point to screen buffer coordinates\r\n+    _pData->LockConsole();\r\n+    const auto currentFontSize = _getScreenFontSize();\r\n     const auto viewport = _pData->GetViewport().ToInclusive();\r\n-    til::CoordType row = 0;\r\n-    if (clientPoint.y <= windowRect.top)\r\n-    {\r\n-        row = viewport.top;\r\n-    }\r\n-    else if (clientPoint.y >= windowRect.bottom)\r\n-    {\r\n-        row = viewport.bottom;\r\n-    }\r\n-    else\r\n-    {\r\n-        // change point coords to pixels relative to window\r\n-        _TranslatePointFromScreen(&clientPoint);\r\n+    _pData->UnlockConsole();\r\n \r\n-        const auto currentFontSize = _getScreenFontSize();\r\n-        row = clientPoint.y / currentFontSize.height + viewport.top;\r\n-    }\r\n-    _start = { 0, row };\r\n+    _start = { clientPoint.x / currentFontSize.width + viewport.left,\r\n+               clientPoint.y / currentFontSize.height + viewport.top };\r\n     _end = _start;\r\n }\r\n \r\n@@ -1381,8 +1375,8 @@ void UiaTextRangeBase::_getBoundingRect(const til::rect& textRect, _Inout_ std::\n \r\n     // convert the coords to be relative to the screen instead of\r\n     // the client window\r\n-    _TranslatePointToScreen(&topLeft);\r\n-    _TranslatePointToScreen(&bottomRight);\r\n+    _TranslatePointToScreen(topLeft);\r\n+    _TranslatePointToScreen(bottomRight);\r\n \r\n     const long width = bottomRight.x - topLeft.x;\r\n     const long height = bottomRight.y - topLeft.y;\r\ndiff --git a/src/types/UiaTextRangeBase.hpp b/src/types/UiaTextRangeBase.hpp\nindex eec30a3dcbd..2b36ccc0efa 100644\n--- a/src/types/UiaTextRangeBase.hpp\n+++ b/src/types/UiaTextRangeBase.hpp\n@@ -123,8 +123,8 @@ namespace Microsoft::Console::Types\n         std::wstring _wordDelimiters{};\r\n         ::Search _searcher;\r\n \r\n-        virtual void _TranslatePointToScreen(til::point* clientPoint) const = 0;\r\n-        virtual void _TranslatePointFromScreen(til::point* screenPoint) const = 0;\r\n+        virtual void _TranslatePointToScreen(til::point& clientPoint) const = 0;\r\n+        virtual void _TranslatePointFromScreen(til::point& screenPoint) const = 0;\r\n \r\n         void Initialize(_In_ const UiaPoint point);\r\n \r\n", "test_patch": "", "problem_statement": "RangeFromPoint and ExpandToEnclosingUnit freezes terminal\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\nhttps://github.com/yinkaisheng/Python-UIAutomation-for-Windows 2.0.19\n\n### Steps to reproduce\n\n```python\r\nimport uiautomation as auto\r\nimport time\r\nimport typing\r\ntime.sleep(5)\r\n[x,y] = auto.GetCursorPos()\r\nc = auto.ControlFromPoint(x,y)\r\nif text_pattern := typing.cast(auto.TextPattern | None, c.GetPattern(auto.PatternId.TextPattern)):\r\n    if r := text_pattern.RangeFromPoint(x,y):\r\n        r.ExpandToEnclosingUnit(auto.TextUnit.Word)\r\n        print(r.GetText())\r\n```\r\nPut the cursor over a terminal window\n\n### Expected Behavior\n\nI get the word under the cursor.\n\n### Actual Behavior\n\nWindows terminals freezes. This program works fine with other software so I don't think the bug is in UIAutomation.\n", "hints_text": "", "created_at": "2024-08-09 18:39:40", "merge_commit_sha": "7b39d24913ec9a6b9fd7026bfd47dc4c7363ccdf", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17333", "base_commit": "13de7c668577ae270ce9528d6a895fd169ece7cc", "patch": "diff --git a/src/cascadia/TerminalApp/Pane.cpp b/src/cascadia/TerminalApp/Pane.cpp\nindex fd195d8d42a..899e67e14ec 100644\n--- a/src/cascadia/TerminalApp/Pane.cpp\n+++ b/src/cascadia/TerminalApp/Pane.cpp\n@@ -467,7 +467,7 @@ std::shared_ptr<Pane> Pane::NextPane(const std::shared_ptr<Pane> targetPane)\n     std::shared_ptr<Pane> nextPane = nullptr;\r\n     auto foundTarget = false;\r\n \r\n-    auto foundNext = WalkTree([&](auto pane) {\r\n+    auto foundNext = WalkTree([&](const auto& pane) {\r\n         // If we are a parent pane we don't want to move to one of our children\r\n         if (foundTarget && targetPane->_HasChild(pane))\r\n         {\r\n@@ -985,6 +985,17 @@ void Pane::_ContentLostFocusHandler(const winrt::Windows::Foundation::IInspectab\n // - <none>\r\n void Pane::Close()\r\n {\r\n+    // Pane has two events, CloseRequested and Closed. CloseRequested is raised by the content asking to be closed,\r\n+    // but also by the window who owns the tab when it's closing. The event is then caught by the TerminalTab which\r\n+    // calls Close() which then raises the Closed event. Now, if this is the last pane in the window, this will result\r\n+    // in the window raising CloseRequested again which leads to infinite recursion, so we need to guard against that.\r\n+    // Ideally we would have just a single event in the future.\r\n+    if (_closed)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    _closed = true;\r\n     // Fire our Closed event to tell our parent that we should be removed.\r\n     Closed.raise(nullptr, nullptr);\r\n }\r\n@@ -1341,7 +1352,7 @@ std::shared_ptr<Pane> Pane::DetachPane(std::shared_ptr<Pane> pane)\n         detached->_ApplySplitDefinitions();\r\n \r\n         // Trigger the detached event on each child\r\n-        detached->WalkTree([](auto pane) {\r\n+        detached->WalkTree([](const auto& pane) {\r\n             pane->Detached.raise(pane);\r\n         });\r\n \r\n@@ -1542,7 +1553,7 @@ void Pane::_CloseChild(const bool closeFirst)\n         {\r\n             // update our path to our first remaining leaf\r\n             _parentChildPath = _firstChild;\r\n-            _firstChild->WalkTree([](auto p) {\r\n+            _firstChild->WalkTree([](const auto& p) {\r\n                 if (p->_IsLeaf())\r\n                 {\r\n                     return true;\r\n@@ -2398,7 +2409,7 @@ void Pane::Id(uint32_t id) noexcept\n bool Pane::FocusPane(const uint32_t id)\r\n {\r\n     // Always clear the parent child path if we are focusing a leaf\r\n-    return WalkTree([=](auto p) {\r\n+    return WalkTree([=](const auto& p) {\r\n         p->_parentChildPath.reset();\r\n         if (p->_id == id)\r\n         {\r\n@@ -2421,7 +2432,7 @@ bool Pane::FocusPane(const uint32_t id)\n // - true if focus was set\r\n bool Pane::FocusPane(const std::shared_ptr<Pane> pane)\r\n {\r\n-    return WalkTree([&](auto p) {\r\n+    return WalkTree([&](const auto& p) {\r\n         if (p == pane)\r\n         {\r\n             p->_Focus();\r\ndiff --git a/src/cascadia/TerminalApp/Pane.h b/src/cascadia/TerminalApp/Pane.h\nindex f25a7b0834a..86757ad36f9 100644\n--- a/src/cascadia/TerminalApp/Pane.h\n+++ b/src/cascadia/TerminalApp/Pane.h\n@@ -248,7 +248,7 @@ class Pane : public std::enable_shared_from_this<Pane>\n \r\n     std::optional<uint32_t> _id;\r\n     std::weak_ptr<Pane> _parentChildPath{};\r\n-\r\n+    bool _closed{ false };\r\n     bool _lastActive{ false };\r\n     winrt::event_token _firstClosedToken{ 0 };\r\n     winrt::event_token _secondClosedToken{ 0 };\r\ndiff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 3053d746df2..8ef5a36584e 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -739,7 +739,7 @@ namespace winrt::TerminalApp::implementation\n             }\r\n \r\n             // Clean read-only mode to prevent additional prompt if closing the pane triggers closing of a hosting tab\r\n-            pane->WalkTree([](auto p) {\r\n+            pane->WalkTree([](const auto& p) {\r\n                 if (const auto control{ p->GetTerminalControl() })\r\n                 {\r\n                     if (control.ReadOnly())\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex ca86bb80a37..54a3e4efe09 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -3810,7 +3810,7 @@ namespace winrt::TerminalApp::implementation\n             // recipe for disaster. We won't ever open up a tab in this window.\n             newTerminalArgs.Elevate(false);\n             const auto newPane = _MakePane(newTerminalArgs, nullptr, connection);\n-            newPane->WalkTree([](auto pane) {\n+            newPane->WalkTree([](const auto& pane) {\n                 pane->FinalizeConfigurationGivenDefault();\n             });\n             _CreateNewTabFromPane(newPane);\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.cpp b/src/cascadia/TerminalApp/TerminalTab.cpp\nindex d3e52d4037d..6e1be17e38b 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.cpp\n+++ b/src/cascadia/TerminalApp/TerminalTab.cpp\n@@ -41,7 +41,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         auto firstId = _nextPaneId;\r\n \r\n-        _rootPane->WalkTree([&](std::shared_ptr<Pane> pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             // update the IDs on each pane\r\n             if (pane->_IsLeaf())\r\n             {\r\n@@ -203,7 +203,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         ASSERT_UI_THREAD();\r\n \r\n-        _rootPane->WalkTree([&](std::shared_ptr<Pane> pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             // Attach event handlers to each new pane\r\n             _AttachEventHandlersToPane(pane);\r\n             if (auto content = pane->GetContent())\r\n@@ -275,7 +275,7 @@ namespace winrt::TerminalApp::implementation\n         _UpdateHeaderControlMaxWidth();\r\n \r\n         // Update the settings on all our panes.\r\n-        _rootPane->WalkTree([&](auto pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             pane->UpdateSettings(settings);\r\n             return false;\r\n         });\r\n@@ -534,7 +534,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         // Add the new event handlers to the new pane(s)\r\n         // and update their ids.\r\n-        pane->WalkTree([&](auto p) {\r\n+        pane->WalkTree([&](const auto& p) {\r\n             _AttachEventHandlersToPane(p);\r\n             if (p->_IsLeaf())\r\n             {\r\n@@ -624,7 +624,7 @@ namespace winrt::TerminalApp::implementation\n         // manually.\r\n         _rootPane->Closed(_rootClosedToken);\r\n         auto p = _rootPane;\r\n-        p->WalkTree([](auto pane) {\r\n+        p->WalkTree([](const auto& pane) {\r\n             pane->Detached.raise(pane);\r\n         });\r\n \r\n@@ -650,7 +650,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         // Add the new event handlers to the new pane(s)\r\n         // and update their ids.\r\n-        pane->WalkTree([&](auto p) {\r\n+        pane->WalkTree([&](const auto& p) {\r\n             _AttachEventHandlersToPane(p);\r\n             if (p->_IsLeaf())\r\n             {\r\n@@ -949,26 +949,20 @@ namespace winrt::TerminalApp::implementation\n \r\n         events.CloseRequested = content.CloseRequested(\r\n             winrt::auto_revoke,\r\n-            [dispatcher, weakThis](auto sender, auto&&) -> winrt::fire_and_forget {\r\n-                // Don't forget! this ^^^^^^^^ sender can't be a reference, this is a async callback.\r\n-\r\n-                // The lambda lives in the `std::function`-style container owned by `control`. That is, when the\r\n-                // `control` gets destroyed the lambda struct also gets destroyed. In other words, we need to\r\n-                // copy `weakThis` onto the stack, because that's the only thing that gets captured in coroutines.\r\n-                // See: https://devblogs.microsoft.com/oldnewthing/20211103-00/?p=105870\r\n-                const auto weakThisCopy = weakThis;\r\n-                co_await wil::resume_foreground(dispatcher);\r\n-                // Check if Tab's lifetime has expired\r\n-                if (auto tab{ weakThisCopy.get() })\r\n+            [this](auto&& sender, auto&&) {\r\n+                if (const auto content{ sender.try_as<TerminalApp::IPaneContent>() })\r\n                 {\r\n-                    if (const auto content{ sender.try_as<TerminalApp::IPaneContent>() })\r\n+                    // Calling Close() while walking the tree is not safe, because Close() mutates the tree.\r\n+                    const auto pane = _rootPane->_FindPane([&](const auto& p) -> std::shared_ptr<Pane> {\r\n+                        if (p->GetContent() == content)\r\n+                        {\r\n+                            return p;\r\n+                        }\r\n+                        return {};\r\n+                    });\r\n+                    if (pane)\r\n                     {\r\n-                        tab->_rootPane->WalkTree([content](std::shared_ptr<Pane> pane) {\r\n-                            if (pane->GetContent() == content)\r\n-                            {\r\n-                                pane->Close();\r\n-                            }\r\n-                        });\r\n+                        pane->Close();\r\n                     }\r\n                 }\r\n             });\r\n", "test_patch": "", "problem_statement": "Terminal crashes when closing any other pane than the last\n### Windows Terminal version\r\n\r\n1.21.1272.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.3593\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nopen terminal. split horizontally twice. change to middle pane. CTRL-D -- crash.\r\n\r\ni have mouse tracking turned on if relevant\r\n\r\n![term-crash](https://github.com/microsoft/terminal/assets/46322585/fbb48d78-ecf0-4ced-8d41-5995c179b7ce)\r\n\r\n\r\n### Expected Behavior\r\n\r\nobviously, no crash :)\r\n\r\n### Actual Behavior\r\n\r\nit crashes and takes \"a long time\" to start\n", "hints_text": "Hi I'm an AI powered bot that finds similar issues based off the issue title.\n\nPlease view the issues below to see if they solve your problem, and if the issue describes your problem please consider closing this one and thumbs upping the other issue to help us prioritize it. Thank you!\n\n\n### Closed similar issues:\n- [terminal crashes when closing a tab after opening a new tab (#1666)](https://github.com/microsoft/terminal/issues/1666),  similarity score: 0.77\n- [Ctrl+D Enter in powershell after closing wsl bash tab with Ctrl+D crashes the terminal. (#2981)](https://github.com/microsoft/terminal/issues/2981),  similarity score: 0.76\n\n> Note: You can give me feedback by thumbs upping or thumbs downing this comment.\nIt seems to be anything that's not the 'last' pane. I just tried it again and successfully closed the bottom (third) pane\r\n\r\n![term-crash2](https://github.com/microsoft/terminal/assets/46322585/26387ec3-212e-4f1a-aee6-7a4f79c68a32)\r\n\r\n\nHappens when using powershell too (not ubuntu). I actually LIKE the change to use the active (not default) profile but I need to be able to close the panes :D", "created_at": "2024-05-29 13:39:14", "merge_commit_sha": "baba406a074e792dd4486f4239ac4b3292f95a60", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17234", "base_commit": "44516ad7cffef1996cabc5bf7435937ee32ba51d", "patch": "diff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex 91e5772006e..c8ed8b28e7b 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -1178,8 +1178,8 @@ void Renderer::_invalidateCurrentCursor() const\n     const auto view = buffer.GetSize();\r\n     const auto coord = _currentCursorOptions.coordCursor;\r\n \r\n-    const auto lineRendition = buffer.GetLineRendition(coord.y);\r\n-    const auto cursorWidth = _pData->IsCursorDoubleWidth() ? 2 : 1;\r\n+    const auto lineRendition = _currentCursorOptions.lineRendition;\r\n+    const auto cursorWidth = _currentCursorOptions.fIsDoubleWidth ? 2 : 1;\r\n \r\n     til::rect rect{ coord.x, coord.y, coord.x + cursorWidth, coord.y + 1 };\r\n     rect = BufferToScreenLine(rect, lineRendition);\r\n", "test_patch": "", "problem_statement": "Cursor invalidation failing when line renditions are used\n### Windows Terminal version\n\n1.21.1272.0\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a WSL bash shell\r\n2. Execute the following statement:\r\n   ```\r\n   printf \"\\ec\\e[999B\\n\\e[H\\e#6\\n\\e[1 q\"; read\r\n   ```\r\n3. Type some text and note whether the cursor is blinking.\r\n4. Backspace to the start of the line and check the cursor again.\r\n\n\n### Expected Behavior\n\nThe final escape sequence in that `printf` is a `DECSCUSR` command, setting the cursor style to a blinking block, so it should be blinking the whole time (except maybe when it's actually moving).\n\n### Actual Behavior\n\nThe cursor blinks at the start of the line, but doesn't blink in any other column. The issue isn't specifically related to blinking, though. It can also manifest as almost constant cursor \"droppings\", but this test case was the easiest to reproduce.\r\n\r\nAnd note that it also fails on openconsole/conhost if you've configured it to use the Atlas engine, so it's not a conpty issue, but it appears to be Atlas only.\r\n\r\nLine rendition has got something to do with it - the first line is set to double-width in this test - but it's not only the double-width line that is affected. And I think the scroll offset is also a factor, which is why this test case forces a linefeed at the bottom of the page.\r\n\r\nAs far as I can tell from a git bisect, it first broke in commit 20b0bed46df71c596b4fb68edfb6bb4b4ebf1c89 (PR #15500).\r\n\n", "hints_text": "Hi I'm an AI powered bot that finds similar issues based off the issue title.\n\nPlease view the issues below to see if they solve your problem, and if the issue describes your problem please consider closing this one and thumbs upping the other issue to help us prioritize it. Thank you!\n\n### Open similar issues:\n\n- [Conpty cursor mispositioned when using double width lines (#15014)](https://github.com/microsoft/terminal/issues/15014),  similarity score: 0.77\n\n### Closed similar issues:\n- [Issues with cursor invalidation in GDI (#17150)](https://github.com/microsoft/terminal/issues/17150),  similarity score: 0.82\n- [Cursor droppings are back in conhost (#12739)](https://github.com/microsoft/terminal/issues/12739),  similarity score: 0.78\n- [Cursor droppings on wide chars in Windows Terminal (#14657)](https://github.com/microsoft/terminal/issues/14657),  similarity score: 0.77\n- [More cursor droppings (#8213)](https://github.com/microsoft/terminal/issues/8213),  similarity score: 0.76\n\n> Note: You can give me feedback by thumbs upping or thumbs downing this comment.\nIt looks to me like the problem is here:\r\nhttps://github.com/microsoft/terminal/blob/49e4eea60f737b46b8aeda505f4693df8a9d44a6/src/renderer/base/renderer.cpp#L1179-L1182\r\n\r\nThe `_currentCursorOptions.coordCursor` value is relative to the top of the screen, while the `GetLineRendition` call is expecting a buffer row offset. \r\n\r\nThat said, I don't think we need that call anyway, since the line renditions should already be cached in the `_currentCursorOptions` structure. Same goes for the `IsCursorDoubleWidth` call on the next line.\r\n\r\nSo unless I'm missing something, I'd suggest replacing those two lines with:\r\n```cpp\r\nconst auto lineRendition = _currentCursorOptions.lineRendition;\r\nconst auto cursorWidth = _currentCursorOptions.fIsDoubleWidth ? 2 : 1;\r\n```", "created_at": "2024-05-10 00:43:16", "merge_commit_sha": "b6f5cbe1ee6574cd365fe027eb703df460c578d1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17221", "base_commit": "49e4eea60f737b46b8aeda505f4693df8a9d44a6", "patch": "diff --git a/src/cascadia/TerminalSettingsModel/Command.cpp b/src/cascadia/TerminalSettingsModel/Command.cpp\nindex a32ed4efa79..70f63091a1f 100644\n--- a/src/cascadia/TerminalSettingsModel/Command.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Command.cpp\n@@ -690,7 +690,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         auto data = winrt::to_string(json);\r\n \r\n         std::string errs;\r\n-        static std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n+        std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n         Json::Value root;\r\n         if (!reader->parse(data.data(), data.data() + data.size(), &root, &errs))\r\n         {\r\n", "test_patch": "", "problem_statement": "Quickly invoking PowerShell menu completion multiple times crashes Terminal\n### Windows Terminal version\n\n49e4eea60f737b46b8aeda505f4693df8a9d44a6\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Enable experimental shell completion menu (`\"experimental.enableShellCompletionMenu\": true`)\r\n2. Quickly invoke shell completion multiple times, so that Terminal tries to parse JSON with completion data at the same time from multiple threads in one of the following ways:\r\n   - Terminal versions from 432dfcc4902d1a8393217a5f529d07e65182a3f8 to 6d0342f0bb31bf245843411c6781d6d5399ff651:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938 \r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times\r\n     4. Press any character key - because of #17204 this will send the completions generated in _c._ at the same time\r\n   - Terminal versions 0b76c51ba10c81ba4213ba98cf88f2abdf91b15e and newer or older than 432dfcc4902d1a8393217a5f529d07e65182a3f8:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938, but instead of\r\n        ```ps\r\n        $result += $completions.CompletionMatches | ConvertTo-Json -Compress\r\n        ```\r\n        append a large JSON string to `$result`. It doesn't have to be a valid shell completion data, but it should be a valid JSON. 7.6M characters is large enough to reproduce the bug on my computer and probably every other PC without trying to be fast.\r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times. Depending on your CPU and the JSON size it may or may not have to be done quickly.\n\n### Expected Behavior\n\nCompletion menu is shown or nothing happens\n\n### Actual Behavior\n\nTerminal crashes or throws an exception or some kind of invalid memory access error, because `JSON::CharReader` in `Command::ParsePowerShellMenuComplete` is `static` and shared between threads:\r\n\r\nhttps://github.com/microsoft/terminal/blob/49e4eea60f737b46b8aeda505f4693df8a9d44a6/src/cascadia/TerminalSettingsModel/Command.cpp#L693\r\n\r\nReproduction in one of the versions affected by #17204:\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/693c214e-dbb2-47af-bb73-3b2a3f3efac9\r\n\r\nReproduction in other Terminal versions and demonstration of a possible fix (no menu is shown, because of the huge JSON, but the Terminal doesn't crash):\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/72dc5cb2-dd77-4f1f-a4dc-722f419a53e5\r\n\r\n\n", "hints_text": "", "created_at": "2024-05-08 23:06:17", "merge_commit_sha": "44516ad7cffef1996cabc5bf7435937ee32ba51d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17211", "base_commit": "6d0342f0bb31bf245843411c6781d6d5399ff651", "patch": "diff --git a/src/cascadia/TerminalApp/TerminalWindow.cpp b/src/cascadia/TerminalApp/TerminalWindow.cpp\nindex 749fd2e842c..c04a34affc9 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.cpp\n+++ b/src/cascadia/TerminalApp/TerminalWindow.cpp\n@@ -263,7 +263,7 @@ namespace winrt::TerminalApp::implementation\n         AppLogic::Current()->NotifyRootInitialized();\r\n     }\r\n \r\n-    void TerminalWindow::Quit()\r\n+    void TerminalWindow::PersistState()\r\n     {\r\n         if (_root)\r\n         {\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.h b/src/cascadia/TerminalApp/TerminalWindow.h\nindex b10c29a8d72..40e94a39201 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.h\n+++ b/src/cascadia/TerminalApp/TerminalWindow.h\n@@ -73,7 +73,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         void Create();\r\n \r\n-        void Quit();\r\n+        void PersistState();\r\n \r\n         winrt::fire_and_forget UpdateSettings(winrt::TerminalApp::SettingsLoadEventArgs args);\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.idl b/src/cascadia/TerminalApp/TerminalWindow.idl\nindex 75c47fce8bf..2cf4b317298 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.idl\n+++ b/src/cascadia/TerminalApp/TerminalWindow.idl\n@@ -61,7 +61,7 @@ namespace TerminalApp\n         Boolean ShouldImmediatelyHandoffToElevated();\r\n         void HandoffToElevated();\r\n \r\n-        void Quit();\r\n+        void PersistState();\r\n \r\n         Windows.UI.Xaml.UIElement GetRoot();\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.cpp b/src/cascadia/WindowsTerminal/AppHost.cpp\nindex 94585f4391c..63d8de231d3 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.cpp\n+++ b/src/cascadia/WindowsTerminal/AppHost.cpp\n@@ -1184,13 +1184,16 @@ winrt::fire_and_forget AppHost::_QuitRequested(const winrt::Windows::Foundation:\n     co_await wil::resume_foreground(_windowLogic.GetRoot().Dispatcher());\r\n \r\n     const auto strongThis = weakThis.lock();\r\n-    // GH #16235: If we don't have a window logic, we're already refrigerating, and won't have our _window either.\r\n-    if (!strongThis || _windowLogic == nullptr)\r\n+    if (!strongThis)\r\n     {\r\n         co_return;\r\n     }\r\n \r\n-    _windowLogic.Quit();\r\n+    if (_appLogic && _windowLogic && _appLogic.ShouldUsePersistedLayout())\r\n+    {\r\n+        _windowLogic.PersistState();\r\n+    }\r\n+\r\n     PostQuitMessage(0);\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex a8f0961e420..1e78e721fd4 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -348,6 +348,14 @@ void WindowEmperor::_becomeMonarch()\n \r\n     _revokers.WindowCreated = _manager.WindowCreated(winrt::auto_revoke, { this, &WindowEmperor::_numberOfWindowsChanged });\r\n     _revokers.WindowClosed = _manager.WindowClosed(winrt::auto_revoke, { this, &WindowEmperor::_numberOfWindowsChanged });\r\n+\r\n+    // If a previous session of Windows Terminal stored buffer_*.txt files, then we need to clean all those up on exit\r\n+    // that aren't needed anymore, even if the user disabled the ShouldUsePersistedLayout() setting in the meantime.\r\n+    {\r\n+        const auto state = ApplicationState::SharedInstance();\r\n+        const auto layouts = state.PersistedWindowLayouts();\r\n+        _requiresPersistenceCleanupOnExit = layouts && layouts.Size() > 0;\r\n+    }\r\n }\r\n \r\n // sender and args are always nullptr\r\n@@ -486,7 +494,7 @@ void WindowEmperor::_finalizeSessionPersistence() const\n     // Ensure to write the state.json before we TerminateProcess()\r\n     state.Flush();\r\n \r\n-    if (!_app.Logic().ShouldUsePersistedLayout())\r\n+    if (!_requiresPersistenceCleanupOnExit)\r\n     {\r\n         return;\r\n     }\r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.h b/src/cascadia/WindowsTerminal/WindowEmperor.h\nindex a35032e6d5e..d4186cbbb06 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.h\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.h\n@@ -51,6 +51,7 @@ class WindowEmperor : public std::enable_shared_from_this<WindowEmperor>\n \r\n     std::unique_ptr<NotificationIcon> _notificationIcon;\r\n \r\n+    bool _requiresPersistenceCleanupOnExit = false;\r\n     bool _quitting{ false };\r\n \r\n     void _windowStartedHandlerPostXAML(const std::shared_ptr<WindowThread>& sender);\r\n", "test_patch": "", "problem_statement": "Window layout persisted in `state.json` even if window persistence not enabled\n### Windows Terminal version\n\n1.20.11215.0\n\n### Windows build number\n\n10.0.22631.3447\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Ensure window persistence is turned off\r\n2. Set windows terminal as your default terminal application\r\n3. Go to run and type `cmd /k echo hello world`\r\n4. Close the terminal\r\n5. Inspect `%LOCALAPPDATA%\\Packages\\Microsoft.WindowsTerminalPreview_8wekyb3d8bbwe\\LocalState\\state.json`\n\n### Expected Behavior\n\nThere is no history of the command that I ran in `state.json`.\n\n### Actual Behavior\n\n`state.json` has leaked my super secret command line invocation!\r\n\r\n```json\r\n{\r\n  \"persistedWindowLayouts\" : \r\n  [\r\n    {\r\n      \"initialPosition\" : \"234,234\",\r\n      \"initialSize\" : \r\n      {\r\n        \"height\" : 436.0,\r\n        \"width\" : 873.0\r\n      },\r\n      \"launchMode\" : \"default\",\r\n      \"tabLayout\" : \r\n      [\r\n        {\r\n          \"action\" : \"newTab\",\r\n          \"commandline\" : \"\\\"C:\\\\WINDOWS\\\\system32\\\\cmd.exe\\\" /k echo hello world\",\r\n          \"profile\" : \"Command Prompt\",\r\n          \"startingDirectory\" : \"C:\\\\Users\\\\Ian\",\r\n          \"suppressApplicationTitle\" : false,\r\n          \"tabTitle\" : \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe\"\r\n        }\r\n      ]\r\n    }\r\n  ],\r\n  \"settingsHash\" : \"190f05f1cd1315b4-01d98faa8aecd332\"\r\n}\r\n```\r\n\r\nThis is not reproducible on version 1.19.11213.0.\n", "hints_text": "Oh dear... But #17206 was created a little earlier than this issue, so lets close it in favor of the older one. \ud83d\ude42 /dup #17206\nHi! We've identified this issue as a duplicate of another one that already exists on this Issue Tracker. This specific instance is being closed in favor of tracking the concern over on the referenced thread. Thanks for your report!\n<!-- Policy app identification https://img.shields.io/static/v1?label=PullRequestIssueManagement. -->\nI figured they were related, but not quite the same, so opened a separate ticket - given that this pre-dates 1.21.", "created_at": "2024-05-08 13:48:09", "merge_commit_sha": "dbac3a1fa3755737be0d761e6e44e86b58e2865e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17194", "base_commit": "3996806503bd573aa59a27d1ee8e98bd1d135b8b", "patch": "diff --git a/src/renderer/vt/XtermEngine.cpp b/src/renderer/vt/XtermEngine.cpp\nindex 75fc3510fa6..b6d0c58a862 100644\n--- a/src/renderer/vt/XtermEngine.cpp\n+++ b/src/renderer/vt/XtermEngine.cpp\n@@ -37,7 +37,16 @@ XtermEngine::XtermEngine(_In_ wil::unique_hfile hPipe,\n //      the pipe.\r\n [[nodiscard]] HRESULT XtermEngine::StartPaint() noexcept\r\n {\r\n-    RETURN_IF_FAILED(VtEngine::StartPaint());\r\n+    const auto hr = VtEngine::StartPaint();\r\n+    if (hr != S_OK)\r\n+    {\r\n+        // If _noFlushOnEnd was set, and we didn't return early, it would usually\r\n+        // have been reset in the EndPaint call. But since that's not going to\r\n+        // happen now, we need to reset it here, otherwise we may mistakenly skip\r\n+        // the flush on the next frame.\r\n+        _noFlushOnEnd = false;\r\n+        return hr;\r\n+    }\r\n \r\n     _trace.TraceLastText(_lastText);\r\n \r\n@@ -83,15 +92,6 @@ XtermEngine::XtermEngine(_In_ wil::unique_hfile hPipe,\n         }\r\n     }\r\n \r\n-    if (!_quickReturn)\r\n-    {\r\n-        if (_WillWriteSingleChar())\r\n-        {\r\n-            // Don't re-enable the cursor.\r\n-            _quickReturn = true;\r\n-        }\r\n-    }\r\n-\r\n     return S_OK;\r\n }\r\n \r\ndiff --git a/src/renderer/vt/invalidate.cpp b/src/renderer/vt/invalidate.cpp\nindex 489a6b50bc1..942ba58df26 100644\n--- a/src/renderer/vt/invalidate.cpp\n+++ b/src/renderer/vt/invalidate.cpp\n@@ -75,7 +75,7 @@ CATCH_RETURN();\n     }\r\n     _skipCursor = false;\r\n \r\n-    _cursorMoved = true;\r\n+    _cursorMoved = psrRegion->origin() != _lastText;\r\n     return S_OK;\r\n }\r\n \r\ndiff --git a/src/renderer/vt/math.cpp b/src/renderer/vt/math.cpp\nindex d86e4644ca5..354ca0e9925 100644\n--- a/src/renderer/vt/math.cpp\n+++ b/src/renderer/vt/math.cpp\n@@ -52,38 +52,3 @@ void VtEngine::_OrRect(_Inout_ til::inclusive_rect* const pRectExisting, const t\n     pRectExisting->right = std::max(pRectExisting->right, pRectToOr->right);\r\n     pRectExisting->bottom = std::max(pRectExisting->bottom, pRectToOr->bottom);\r\n }\r\n-\r\n-// Method Description:\r\n-// - Returns true if the invalidated region indicates that we only need to\r\n-//      simply print text from the current cursor position. This will prevent us\r\n-//      from sending extra VT set-up/tear down sequences (?12h/l) when all we\r\n-//      need to do is print more text at the current cursor position.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - true iff only the next character is invalid\r\n-bool VtEngine::_WillWriteSingleChar() const\r\n-{\r\n-    // If there is no scroll delta, return false.\r\n-    if (til::point{ 0, 0 } != _scrollDelta)\r\n-    {\r\n-        return false;\r\n-    }\r\n-\r\n-    // If there is more than one invalid char, return false.\r\n-    if (!_invalidMap.one())\r\n-    {\r\n-        return false;\r\n-    }\r\n-\r\n-    // Get the single point at which things are invalid.\r\n-    const auto invalidPoint = _invalidMap.runs().front().origin();\r\n-\r\n-    // Either the next character to the right or the immediately previous\r\n-    //      character should follow this code path\r\n-    //      (The immediate previous character would suggest a backspace)\r\n-    auto invalidIsNext = invalidPoint == _lastText;\r\n-    auto invalidIsLast = invalidPoint == til::point{ _lastText.x - 1, _lastText.y };\r\n-\r\n-    return invalidIsNext || invalidIsLast;\r\n-}\r\ndiff --git a/src/renderer/vt/paint.cpp b/src/renderer/vt/paint.cpp\nindex af08cdd5b58..1fcb5335887 100644\n--- a/src/renderer/vt/paint.cpp\n+++ b/src/renderer/vt/paint.cpp\n@@ -20,30 +20,30 @@ using namespace Microsoft::Console::Types;\n //      HRESULT error code if painting didn't start successfully.\r\n [[nodiscard]] HRESULT VtEngine::StartPaint() noexcept\r\n {\r\n+    // When unit testing, there may be no pipe, but we still need to paint.\r\n     if (!_hFile)\r\n     {\r\n-        return S_FALSE;\r\n+        return S_OK;\r\n     }\r\n \r\n     // If we're using line renditions, and this is a full screen paint, we can\r\n     // potentially stop using them at the end of this frame.\r\n     _stopUsingLineRenditions = _usingLineRenditions && _AllIsInvalid();\r\n \r\n-    // If there's nothing to do, quick return\r\n+    // If there's nothing to do, we won't need to paint.\r\n     auto somethingToDo = _invalidMap.any() ||\r\n                          _scrollDelta != til::point{ 0, 0 } ||\r\n                          _cursorMoved ||\r\n                          _titleChanged;\r\n \r\n-    _quickReturn = !somethingToDo;\r\n-    _trace.TraceStartPaint(_quickReturn,\r\n+    _trace.TraceStartPaint(!somethingToDo,\r\n                            _invalidMap,\r\n                            _lastViewport.ToExclusive(),\r\n                            _scrollDelta,\r\n                            _cursorMoved,\r\n                            _wrappedRow);\r\n \r\n-    return _quickReturn ? S_FALSE : S_OK;\r\n+    return somethingToDo ? S_OK : S_FALSE;\r\n }\r\n \r\n // Routine Description:\r\n@@ -142,9 +142,9 @@ using namespace Microsoft::Console::Types;\n         _usingLineRenditions = true;\r\n     }\r\n     // One simple optimization is that we can skip sending the line attributes\r\n-    // when _quickReturn is true. That indicates that we're writing out a single\r\n-    // character, which should preclude there being a rendition switch.\r\n-    if (_usingLineRenditions && !_quickReturn)\r\n+    // when we're writing out a single character, which should preclude there\r\n+    // being a rendition switch.\r\n+    if (_usingLineRenditions && !_invalidMap.one())\r\n     {\r\n         RETURN_IF_FAILED(_MoveCursor({ _lastText.x, targetRow }));\r\n         switch (lineRendition)\r\ndiff --git a/src/renderer/vt/state.cpp b/src/renderer/vt/state.cpp\nindex 881fb0c2cce..f192536e3e6 100644\n--- a/src/renderer/vt/state.cpp\n+++ b/src/renderer/vt/state.cpp\n@@ -37,7 +37,6 @@ VtEngine::VtEngine(_In_ wil::unique_hfile pipe,\n     _pool(til::pmr::get_default_resource()),\r\n     _invalidMap(initialViewport.Dimensions(), false, &_pool),\r\n     _scrollDelta(0, 0),\r\n-    _quickReturn(false),\r\n     _clearedAllThisFrame(false),\r\n     _cursorMoved(false),\r\n     _resized(false),\r\ndiff --git a/src/renderer/vt/vtrenderer.hpp b/src/renderer/vt/vtrenderer.hpp\nindex 0125fe17369..b5c487fc1c0 100644\n--- a/src/renderer/vt/vtrenderer.hpp\n+++ b/src/renderer/vt/vtrenderer.hpp\n@@ -113,7 +113,6 @@ namespace Microsoft::Console::Render\n         til::point _lastText;\r\n         til::point _scrollDelta;\r\n \r\n-        bool _quickReturn;\r\n         bool _clearedAllThisFrame;\r\n         bool _cursorMoved;\r\n         bool _resized;\r\n@@ -214,8 +213,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT _RgbUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n         [[nodiscard]] HRESULT _16ColorUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n \r\n-        bool _WillWriteSingleChar() const;\r\n-\r\n         // buffer space for these two functions to build their lines\r\n         // so they don't have to alloc/free in a tight loop\r\n         std::wstring _bufferLine;\r\n", "test_patch": "", "problem_statement": "DCS sequences split across multiple \"packets\" can be corrupted by conpty\n### Windows Terminal version\n\n1.20.10822.0\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nRun the following python script:\r\n\r\n```py\r\nimport sys\r\nimport time\r\n\r\nsys.stdout.write('\\033[37;40m\\033[2J')\r\nsys.stdout.write('\\033P2$p0;2;50;0;0/')\r\nsys.stdout.flush()\r\ntime.sleep(0.1)\r\nsys.stdout.write('0;2;0;0;0\\033\\\\')\r\n```\r\n\n\n### Expected Behavior\n\nIt should clear the screen and briefly make the background color red. It works as expected in OpenConsole.\n\n### Actual Behavior\n\nIn Windows Terminal, the background is left permanently red, and you can see the second half of the DCS sequence output on the screen: `0;2;0;0;0`.\r\n\r\nLooking at the debug tap, it appears that conpty is inserting an SGR reset sequence in the middle of the DCS stream (where the script sleeps for a bit). This seems similar to issue #16079, but that test case is now working correctly on the main branch, while this is still broken.\r\n\r\nI haven't had a chance to git bisect it, so I'm not sure if it's a regression, but I wouldn't be surprised if it was always broken in some way (although possibly not obviously so). There may also be an element of timing involved, but I can reproduce the problem consistently with the script above. \n", "hints_text": "Hi I'm an AI powered bot that finds similar issues based off the issue title.\n\nPlease view the issues below to see if they solve your problem, and if the issue describes your problem please consider closing this one and thumbs upping the other issue to help us prioritize it. Thank you!\n\n### Open similar issues:\n\n- [DCS sequences are no longer passed through in real time (#17111)](https://github.com/microsoft/terminal/issues/17111),  similarity score: 0.86\n- [Conpty \"pass-through\" doesn't maintain order of operations (#8698)](https://github.com/microsoft/terminal/issues/8698),  similarity score: 0.81\n\n### Closed similar issues:\n- [Escape sequences behave strangely over conpty when VirtualTerminalLevel is set (#1965)](https://github.com/microsoft/terminal/issues/1965),  similarity score: 0.78\n- [ConPTY not emitting OSC sequences longer than 256 characters (Windows 10) (#15551)](https://github.com/microsoft/terminal/issues/15551),  similarity score: 0.75\n\n> Note: You can give me feedback by thumbs upping or thumbs downing this comment.\nBTW coincidentally I noticed something weird today and I'm not sure if it's related to the issues you've found (edit: it's quite unlikely though). Try running this in a new pwsh tab (or WSL with the `` ` `` replaced):\r\n```pwsh\r\n\"a`e[100m`r`nb`e[m`r`nc\"\r\n```\r\n\r\nThen continue executing this until the terminal starts scrolling. Once it does, entire rows are given the attribute at a time.\n> Once it does, entire rows are given the attribute at a time.\r\n\r\nThis is expected behavior. When the screen scrolls, the newly revealed line is meant to be filled with the active color attributes by default. You can control that behavior with `DECECM` (Erase Color Mode). For example, in pwsh you would need to do this first: ``\"`e[?117h\"``. \nI figured out the problem here. When performing a DCS sequence passthrough, the first thing we do is call `Renderer::TriggerFlush` to make sure any pending VT engine paints are output before starting the actual DCS sequence. However, if there is already a pending paint waiting on the console lock in the render thread, that's still going to be executed when the lock is next free, even if there's nothing left for it to do.\r\n\r\nSo what's happening in this case is the initial part of the DCS gets passed through, then the console lock is released and the VT render engine proceeds with its paint. At this point there's nothing left for it paint, but that doesn't stop it from resetting the attributes in the \"Prep Colors\" step of `_PaintFrameForEngine`. That `SGR` sequence then ends up in the middle of the ongoing DCS sequence, resulting in an early termination.\r\n\r\nAs a quick hack fix, I made the `Renderer::TriggerFlush` method toggle the console lock after calling `_PaintFrame`. That gives the render thread a chance to grab the lock and flush its pending paint, but this feels like a very flaky solution. I think it would probably be better if the VT render engine could just avoid sending an `SGR` reset when there is no real need for it. But I don't know the code well enough to know if that's a workable solution.\nAfter further investigation into why the VT render engine is sending that `SGR` reset, I've discovered that that is technically a bug.\r\n\r\nIn theory, the `VtEngine::StartPaint` method already has a check to see whether there's something to do. See here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/378b6594bd94cf3b27f4e309a11efe25d83de0d9/src/renderer/vt/paint.cpp#L32-L36\r\n\r\nIf not, that method returns `S_FALSE`, which should indicate to the renderer that we can skip this frame entirely. However, the derived `XtermEngine` class ignores the `S_FALSE` return value, so that information is lost. See here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/378b6594bd94cf3b27f4e309a11efe25d83de0d9/src/renderer/vt/XtermEngine.cpp#L38-L40\r\n\r\nThe other problem is that the `somethingToDo` calculation always evaluates to true, because the `_cursorMoved` flag is always set to true. This is the result of the PR #15500 changes described in issue #17150 - we're now calling `InvalidateCursor` on every paint, which makes the VT engine think the cursor is always moving.\r\n\r\nIn theory that could be fixed by checking whether the cursor position in the `InvalidateCursor` call is different from the current position, if it weren't for the fact that the `InvalidateCursor` call isn't actually passed the current position - it's passed the previous position. But that should be resolved by my suggested fix for #17150.\r\n\r\nIn short, I think we could fix this bug with the following:\r\n1. Issue #17150 would need to be fixed first.\r\n2. We would need to check for a change in position when setting the `_cursorMoved` flag in `VtEngine::InvalidateCursor`.\r\n3. The `XtermEngine::StartPaint` method would need to check for `S_FALSE` being returned from the parent class.\r\n\r\nThis way we wouldn't need to mess with the console lock, so it seems like a safer approach. There might be edge cases that I'm missing though.\nAfter trying this out, I found there's an extra step required. When the `XtermEngine::StartPaint` method returns `S_FALSE`, it also needs to reset the `_noFlushOnEnd` flag, otherwise the next frame may not flush when it is supposed to.", "created_at": "2024-05-05 00:47:12", "merge_commit_sha": "432dfcc4902d1a8393217a5f529d07e65182a3f8", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17059", "base_commit": "3a06826915d11ee2124de9b35e42300e1c3f68d5", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex ec903dc5b80..478c75129b4 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -879,6 +879,11 @@\n               \"default\": false,\n               \"description\": \"If true, the copied content will be copied as a single line (even if there are hard line breaks present in the text). If false, newlines persist from the selected text.\"\n             },\n+            \"withControlSequences\": {\n+              \"type\": \"boolean\",\n+              \"default\": false,\n+              \"description\": \"If true, copied content will contain ANSI escape code control sequences representing the styling of the content.\"\n+            },\n             \"dismissSelection\": {\n               \"type\": \"boolean\",\n               \"default\": true,\ndiff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex 802e48e7c3e..a920854b732 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -1917,6 +1917,41 @@ std::wstring TextBuffer::GetPlainText(const CopyRequest& req) const\n     return selectedText;\r\n }\r\n \r\n+// Retrieves the text data from the buffer *with* ANSI escape code control sequences and presents it in\r\n+//      a clipboard-ready format.\r\n+// Arguments:\r\n+// - req - the copy request having the bounds of the selected region and other related configuration flags.\r\n+// Return Value:\r\n+// - The text and control sequence data from the selected region of the text buffer. Empty if the copy request\r\n+//      is invalid.\r\n+std::wstring TextBuffer::GetWithControlSequences(const CopyRequest& req) const\r\n+{\r\n+    if (req.beg > req.end)\r\n+    {\r\n+        return {};\r\n+    }\r\n+\r\n+    std::wstring selectedText;\r\n+    std::optional<TextAttribute> previousTextAttr;\r\n+    bool delayedLineBreak = false;\r\n+\r\n+    const auto firstRow = req.beg.y;\r\n+    const auto lastRow = req.end.y;\r\n+\r\n+    for (til::CoordType currentRow = firstRow; currentRow <= lastRow; currentRow++)\r\n+    {\r\n+        const auto& row = GetRowByOffset(currentRow);\r\n+\r\n+        const auto [startX, endX, reqAddLineBreak] = _RowCopyHelper(req, currentRow, row);\r\n+        const bool isLastRow = currentRow == lastRow;\r\n+        const bool addLineBreak = reqAddLineBreak && !isLastRow;\r\n+\r\n+        _SerializeRow(row, startX, endX, addLineBreak, isLastRow, selectedText, previousTextAttr, delayedLineBreak);\r\n+    }\r\n+\r\n+    return selectedText;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Generates a CF_HTML compliant structure from the selected region of the buffer\r\n // Arguments:\r\n@@ -2348,7 +2383,7 @@ void TextBuffer::_AppendRTFText(std::string& contentBuilder, const std::wstring_\n     }\r\n }\r\n \r\n-void TextBuffer::Serialize(const wchar_t* destination) const\r\n+void TextBuffer::SerializeToPath(const wchar_t* destination) const\r\n {\r\n     const wil::unique_handle file{ CreateFileW(destination, GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_DELETE, nullptr, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, nullptr) };\r\n     THROW_LAST_ERROR_IF(!file);\r\n@@ -2358,279 +2393,318 @@ void TextBuffer::Serialize(const wchar_t* destination) const\n     buffer.reserve(writeThreshold + writeThreshold / 2);\r\n     buffer.push_back(L'\\uFEFF');\r\n \r\n-    const til::CoordType lastRowWithText = GetLastNonSpaceCharacter(nullptr).y;\r\n-    CharacterAttributes previousAttr = CharacterAttributes::Unused1;\r\n-    TextColor previousFg;\r\n-    TextColor previousBg;\r\n-    TextColor previousUl;\r\n-    uint16_t previousHyperlinkId = 0;\r\n+    std::optional<TextAttribute> previousTextAttr;\r\n     bool delayedLineBreak = false;\r\n \r\n+    const til::CoordType firstRow = 0;\r\n+    const til::CoordType lastRow = GetLastNonSpaceCharacter(nullptr).y;\r\n+\r\n     // This iterates through each row. The exit condition is at the end\r\n     // of the for() loop so that we can properly handle file flushing.\r\n-    for (til::CoordType currentRow = 0;; currentRow++)\r\n+    for (til::CoordType currentRow = firstRow;; currentRow++)\r\n     {\r\n         const auto& row = GetRowByOffset(currentRow);\r\n \r\n-        if (const auto lr = row.GetLineRendition(); lr != LineRendition::SingleWidth)\r\n+        const auto isLastRow = currentRow == lastRow;\r\n+        const auto startX = 0;\r\n+        const auto endX = row.GetReadableColumnCount();\r\n+        const bool addLineBreak = !row.WasWrapForced() || isLastRow;\r\n+\r\n+        _SerializeRow(row, startX, endX, addLineBreak, isLastRow, buffer, previousTextAttr, delayedLineBreak);\r\n+\r\n+        if (buffer.size() >= writeThreshold || isLastRow)\r\n         {\r\n-            static constexpr std::wstring_view mappings[] = {\r\n-                L\"\\x1b#6\", // LineRendition::DoubleWidth\r\n-                L\"\\x1b#3\", // LineRendition::DoubleHeightTop\r\n-                L\"\\x1b#4\", // LineRendition::DoubleHeightBottom\r\n-            };\r\n-            const auto idx = std::clamp(static_cast<int>(lr) - 1, 0, 2);\r\n-            buffer.append(til::at(mappings, idx));\r\n+            const auto fileSize = gsl::narrow<DWORD>(buffer.size() * sizeof(wchar_t));\r\n+            DWORD bytesWritten = 0;\r\n+            THROW_IF_WIN32_BOOL_FALSE(WriteFile(file.get(), buffer.data(), fileSize, &bytesWritten, nullptr));\r\n+            THROW_WIN32_IF_MSG(ERROR_WRITE_FAULT, bytesWritten != fileSize, \"failed to write\");\r\n+            buffer.clear();\r\n         }\r\n \r\n-        const auto& runs = row.Attributes().runs();\r\n-        const auto beg = runs.begin();\r\n-        const auto end = runs.end();\r\n-        auto it = beg;\r\n-        const auto last = end - 1;\r\n-        const auto lastCharX = row.MeasureRight();\r\n-        til::CoordType oldX = 0;\r\n-\r\n-        for (; it != end; ++it)\r\n+        if (isLastRow)\r\n         {\r\n-            const auto attr = it->value.GetCharacterAttributes();\r\n-            const auto hyperlinkId = it->value.GetHyperlinkId();\r\n-            const auto fg = it->value.GetForeground();\r\n-            const auto bg = it->value.GetBackground();\r\n-            const auto ul = it->value.GetUnderlineColor();\r\n+            break;\r\n+        }\r\n+    }\r\n+}\r\n \r\n-            if (previousAttr != attr)\r\n-            {\r\n-                auto attrDelta = attr ^ previousAttr;\r\n-\r\n-                // There's no escape sequence that only turns off either bold/intense or dim/faint. SGR 22 turns off both.\r\n-                // This results in two issues in our generic \"Mapping\" code below. Assuming, both Intense and Faint were on...\r\n-                // * ...and either turned off, it would emit SGR 22 which turns both attributes off = Wrong.\r\n-                // * ...and both are now off, it would emit SGR 22 twice.\r\n-                //\r\n-                // This extra branch takes care of both issues. If both attributes turned off it'll emit a single \\x1b[22m,\r\n-                // if faint turned off \\x1b[22;1m (intense is still on), and \\x1b[22;2m if intense turned off (vice versa).\r\n-                if (WI_AreAllFlagsSet(previousAttr, CharacterAttributes::Intense | CharacterAttributes::Faint) &&\r\n-                    WI_IsAnyFlagSet(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n-                {\r\n-                    wchar_t buf[8] = L\"\\x1b[22m\";\r\n-                    size_t len = 5;\r\n+// Serializes one row of the text buffer including ANSI escape code control sequences.\r\n+// Arguments:\r\n+// - row - A reference to the row being serialized.\r\n+// - startX - The first column (inclusive) to include in the serialized content.\r\n+// - endX - The last column (exclusive) to include in the serialized content.\r\n+// - addLineBreak - Whether to add a line break at the end of the serialized row.\r\n+// - isLastRow - Whether this is the final row to be serialized.\r\n+// - buffer - A string to write the serialized row into.\r\n+// - previousTextAttr - Used for tracking state across multiple calls to `_SerializeRow` for sequential rows.\r\n+//      The value will be mutated by the call. The initial call should contain `nullopt`, and subsequent calls\r\n+//      should pass the value that was written by the previous call.\r\n+// - delayedLineBreak - Similarly used for tracking state across multiple calls, and similarly will be mutated\r\n+//      by the call. The initial call should pass `false` and subsequent calls should pass the value that was\r\n+//      written by the previous call.\r\n+void TextBuffer::_SerializeRow(const ROW& row, const til::CoordType startX, const til::CoordType endX, const bool addLineBreak, const bool isLastRow, std::wstring& buffer, std::optional<TextAttribute>& previousTextAttr, bool& delayedLineBreak) const\r\n+{\r\n+    if (const auto lr = row.GetLineRendition(); lr != LineRendition::SingleWidth)\r\n+    {\r\n+        static constexpr std::wstring_view mappings[] = {\r\n+            L\"\\x1b#6\", // LineRendition::DoubleWidth\r\n+            L\"\\x1b#3\", // LineRendition::DoubleHeightTop\r\n+            L\"\\x1b#4\", // LineRendition::DoubleHeightBottom\r\n+        };\r\n+        const auto idx = std::clamp(static_cast<int>(lr) - 1, 0, 2);\r\n+        buffer.append(til::at(mappings, idx));\r\n+    }\r\n \r\n-                    if (WI_IsAnyFlagSet(attr, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n-                    {\r\n-                        buf[4] = L';';\r\n-                        buf[5] = WI_IsAnyFlagSet(attr, CharacterAttributes::Intense) ? L'1' : L'2';\r\n-                        buf[6] = L'm';\r\n-                        len = 7;\r\n-                    }\r\n+    const auto startXU16 = gsl::narrow_cast<uint16_t>(startX);\r\n+    const auto endXU16 = gsl::narrow_cast<uint16_t>(endX);\r\n+    const auto runs = row.Attributes().slice(startXU16, endXU16).runs();\r\n \r\n-                    buffer.append(&buf[0], len);\r\n-                    WI_ClearAllFlags(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint);\r\n-                }\r\n+    const auto beg = runs.begin();\r\n+    const auto end = runs.end();\r\n+    auto it = beg;\r\n+    // Don't try to get `end - 1` if it's an empty iterator; in this case we're going to ignore the `last`\r\n+    // value anyway so just use `end`.\r\n+    const auto last = it == end ? end : end - 1;\r\n+    const auto lastCharX = row.MeasureRight();\r\n+    til::CoordType oldX = startX;\r\n+\r\n+    for (; it != end; ++it)\r\n+    {\r\n+        const auto effectivePreviousTextAttr = previousTextAttr.value_or(TextAttribute{ CharacterAttributes::Unused1, TextColor{}, TextColor{}, 0, TextColor{} });\r\n+        const auto previousAttr = effectivePreviousTextAttr.GetCharacterAttributes();\r\n+        const auto previousHyperlinkId = effectivePreviousTextAttr.GetHyperlinkId();\r\n+        const auto previousFg = effectivePreviousTextAttr.GetForeground();\r\n+        const auto previousBg = effectivePreviousTextAttr.GetBackground();\r\n+        const auto previousUl = effectivePreviousTextAttr.GetUnderlineColor();\r\n+\r\n+        const auto attr = it->value.GetCharacterAttributes();\r\n+        const auto hyperlinkId = it->value.GetHyperlinkId();\r\n+        const auto fg = it->value.GetForeground();\r\n+        const auto bg = it->value.GetBackground();\r\n+        const auto ul = it->value.GetUnderlineColor();\r\n+\r\n+        if (previousAttr != attr)\r\n+        {\r\n+            auto attrDelta = attr ^ previousAttr;\r\n \r\n-                {\r\n-                    struct Mapping\r\n-                    {\r\n-                        CharacterAttributes attr;\r\n-                        uint8_t change[2]; // [0] = off, [1] = on\r\n-                    };\r\n-                    static constexpr Mapping mappings[] = {\r\n-                        { CharacterAttributes::Intense, { 22, 1 } },\r\n-                        { CharacterAttributes::Italics, { 23, 3 } },\r\n-                        { CharacterAttributes::Blinking, { 25, 5 } },\r\n-                        { CharacterAttributes::Invisible, { 28, 8 } },\r\n-                        { CharacterAttributes::CrossedOut, { 29, 9 } },\r\n-                        { CharacterAttributes::Faint, { 22, 2 } },\r\n-                        { CharacterAttributes::TopGridline, { 55, 53 } },\r\n-                        { CharacterAttributes::ReverseVideo, { 27, 7 } },\r\n-                    };\r\n-                    for (const auto& mapping : mappings)\r\n-                    {\r\n-                        if (WI_IsAnyFlagSet(attrDelta, mapping.attr))\r\n-                        {\r\n-                            const auto n = til::at(mapping.change, WI_IsAnyFlagSet(attr, mapping.attr));\r\n-                            fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), n);\r\n-                        }\r\n-                    }\r\n-                }\r\n+            // There's no escape sequence that only turns off either bold/intense or dim/faint. SGR 22 turns off both.\r\n+            // This results in two issues in our generic \"Mapping\" code below. Assuming, both Intense and Faint were on...\r\n+            // * ...and either turned off, it would emit SGR 22 which turns both attributes off = Wrong.\r\n+            // * ...and both are now off, it would emit SGR 22 twice.\r\n+            //\r\n+            // This extra branch takes care of both issues. If both attributes turned off it'll emit a single \\x1b[22m,\r\n+            // if faint turned off \\x1b[22;1m (intense is still on), and \\x1b[22;2m if intense turned off (vice versa).\r\n+            if (WI_AreAllFlagsSet(previousAttr, CharacterAttributes::Intense | CharacterAttributes::Faint) &&\r\n+                WI_IsAnyFlagSet(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n+            {\r\n+                wchar_t buf[8] = L\"\\x1b[22m\";\r\n+                size_t len = 5;\r\n \r\n-                if (WI_IsAnyFlagSet(attrDelta, CharacterAttributes::UnderlineStyle))\r\n+                if (WI_IsAnyFlagSet(attr, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n                 {\r\n-                    static constexpr std::wstring_view mappings[] = {\r\n-                        L\"\\x1b[24m\", // UnderlineStyle::NoUnderline\r\n-                        L\"\\x1b[4m\", // UnderlineStyle::SinglyUnderlined\r\n-                        L\"\\x1b[21m\", // UnderlineStyle::DoublyUnderlined\r\n-                        L\"\\x1b[4:3m\", // UnderlineStyle::CurlyUnderlined\r\n-                        L\"\\x1b[4:4m\", // UnderlineStyle::DottedUnderlined\r\n-                        L\"\\x1b[4:5m\", // UnderlineStyle::DashedUnderlined\r\n-                    };\r\n-\r\n-                    auto idx = WI_EnumValue(it->value.GetUnderlineStyle());\r\n-                    if (idx >= std::size(mappings))\r\n-                    {\r\n-                        idx = 1; // UnderlineStyle::SinglyUnderlined\r\n-                    }\r\n-\r\n-                    buffer.append(til::at(mappings, idx));\r\n+                    buf[4] = L';';\r\n+                    buf[5] = WI_IsAnyFlagSet(attr, CharacterAttributes::Intense) ? L'1' : L'2';\r\n+                    buf[6] = L'm';\r\n+                    len = 7;\r\n                 }\r\n \r\n-                previousAttr = attr;\r\n+                buffer.append(&buf[0], len);\r\n+                WI_ClearAllFlags(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint);\r\n             }\r\n \r\n-            if (previousFg != fg)\r\n             {\r\n-                switch (fg.GetType())\r\n+                struct Mapping\r\n                 {\r\n-                case ColorType::IsDefault:\r\n-                    buffer.append(L\"\\x1b[39m\");\r\n-                    break;\r\n-                case ColorType::IsIndex16:\r\n+                    CharacterAttributes attr;\r\n+                    uint8_t change[2]; // [0] = off, [1] = on\r\n+                };\r\n+                static constexpr Mapping mappings[] = {\r\n+                    { CharacterAttributes::Intense, { 22, 1 } },\r\n+                    { CharacterAttributes::Italics, { 23, 3 } },\r\n+                    { CharacterAttributes::Blinking, { 25, 5 } },\r\n+                    { CharacterAttributes::Invisible, { 28, 8 } },\r\n+                    { CharacterAttributes::CrossedOut, { 29, 9 } },\r\n+                    { CharacterAttributes::Faint, { 22, 2 } },\r\n+                    { CharacterAttributes::TopGridline, { 55, 53 } },\r\n+                    { CharacterAttributes::ReverseVideo, { 27, 7 } },\r\n+                };\r\n+                for (const auto& mapping : mappings)\r\n                 {\r\n-                    uint8_t index = WI_IsFlagSet(fg.GetIndex(), 8) ? 90 : 30;\r\n-                    index += fg.GetIndex() & 7;\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n-                    break;\r\n-                }\r\n-                case ColorType::IsIndex256:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;5;{}m\"), fg.GetIndex());\r\n-                    break;\r\n-                case ColorType::IsRgb:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;2;{};{};{}m\"), fg.GetR(), fg.GetG(), fg.GetB());\r\n-                    break;\r\n-                default:\r\n-                    break;\r\n+                    if (WI_IsAnyFlagSet(attrDelta, mapping.attr))\r\n+                    {\r\n+                        const auto n = til::at(mapping.change, WI_IsAnyFlagSet(attr, mapping.attr));\r\n+                        fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), n);\r\n+                    }\r\n                 }\r\n-                previousFg = fg;\r\n             }\r\n \r\n-            if (previousBg != bg)\r\n+            if (WI_IsAnyFlagSet(attrDelta, CharacterAttributes::UnderlineStyle))\r\n             {\r\n-                switch (bg.GetType())\r\n-                {\r\n-                case ColorType::IsDefault:\r\n-                    buffer.append(L\"\\x1b[49m\");\r\n-                    break;\r\n-                case ColorType::IsIndex16:\r\n+                static constexpr std::wstring_view mappings[] = {\r\n+                    L\"\\x1b[24m\", // UnderlineStyle::NoUnderline\r\n+                    L\"\\x1b[4m\", // UnderlineStyle::SinglyUnderlined\r\n+                    L\"\\x1b[21m\", // UnderlineStyle::DoublyUnderlined\r\n+                    L\"\\x1b[4:3m\", // UnderlineStyle::CurlyUnderlined\r\n+                    L\"\\x1b[4:4m\", // UnderlineStyle::DottedUnderlined\r\n+                    L\"\\x1b[4:5m\", // UnderlineStyle::DashedUnderlined\r\n+                };\r\n+\r\n+                auto idx = WI_EnumValue(it->value.GetUnderlineStyle());\r\n+                if (idx >= std::size(mappings))\r\n                 {\r\n-                    uint8_t index = WI_IsFlagSet(bg.GetIndex(), 8) ? 100 : 40;\r\n-                    index += bg.GetIndex() & 7;\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n-                    break;\r\n-                }\r\n-                case ColorType::IsIndex256:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;5;{}m\"), bg.GetIndex());\r\n-                    break;\r\n-                case ColorType::IsRgb:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;2;{};{};{}m\"), bg.GetR(), bg.GetG(), bg.GetB());\r\n-                    break;\r\n-                default:\r\n-                    break;\r\n+                    idx = 1; // UnderlineStyle::SinglyUnderlined\r\n                 }\r\n-                previousBg = bg;\r\n+\r\n+                buffer.append(til::at(mappings, idx));\r\n             }\r\n+        }\r\n \r\n-            if (previousUl != ul)\r\n+        if (previousFg != fg)\r\n+        {\r\n+            switch (fg.GetType())\r\n             {\r\n-                switch (fg.GetType())\r\n-                {\r\n-                case ColorType::IsDefault:\r\n-                    buffer.append(L\"\\x1b[59m\");\r\n-                    break;\r\n-                case ColorType::IsIndex256:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:5:{}m\"), ul.GetIndex());\r\n-                    break;\r\n-                case ColorType::IsRgb:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:2::{}:{}:{}m\"), ul.GetR(), ul.GetG(), ul.GetB());\r\n-                    break;\r\n-                default:\r\n-                    break;\r\n-                }\r\n-                previousUl = ul;\r\n+            case ColorType::IsDefault:\r\n+                buffer.append(L\"\\x1b[39m\");\r\n+                break;\r\n+            case ColorType::IsIndex16:\r\n+            {\r\n+                uint8_t index = WI_IsFlagSet(fg.GetIndex(), 8) ? 90 : 30;\r\n+                index += fg.GetIndex() & 7;\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n+                break;\r\n             }\r\n+            case ColorType::IsIndex256:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;5;{}m\"), fg.GetIndex());\r\n+                break;\r\n+            case ColorType::IsRgb:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;2;{};{};{}m\"), fg.GetR(), fg.GetG(), fg.GetB());\r\n+                break;\r\n+            default:\r\n+                break;\r\n+            }\r\n+        }\r\n \r\n-            if (previousHyperlinkId != hyperlinkId)\r\n+        if (previousBg != bg)\r\n+        {\r\n+            switch (bg.GetType())\r\n             {\r\n-                if (hyperlinkId)\r\n-                {\r\n-                    const auto uri = GetHyperlinkUriFromId(hyperlinkId);\r\n-                    if (!uri.empty())\r\n-                    {\r\n-                        buffer.append(L\"\\x1b]8;;\");\r\n-                        buffer.append(uri);\r\n-                        buffer.append(L\"\\x1b\\\\\");\r\n-                        previousHyperlinkId = hyperlinkId;\r\n-                    }\r\n-                }\r\n-                else\r\n-                {\r\n-                    buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n-                    previousHyperlinkId = 0;\r\n-                }\r\n+            case ColorType::IsDefault:\r\n+                buffer.append(L\"\\x1b[49m\");\r\n+                break;\r\n+            case ColorType::IsIndex16:\r\n+            {\r\n+                uint8_t index = WI_IsFlagSet(bg.GetIndex(), 8) ? 100 : 40;\r\n+                index += bg.GetIndex() & 7;\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n+                break;\r\n             }\r\n+            case ColorType::IsIndex256:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;5;{}m\"), bg.GetIndex());\r\n+                break;\r\n+            case ColorType::IsRgb:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;2;{};{};{}m\"), bg.GetR(), bg.GetG(), bg.GetB());\r\n+                break;\r\n+            default:\r\n+                break;\r\n+            }\r\n+        }\r\n \r\n-            // Initially, the buffer is initialized with the default attributes, but once it begins to scroll,\r\n-            // newly scrolled in rows are initialized with the current attributes. This means we need to set\r\n-            // the current attributes to those of the upcoming row before the row comes up. Or inversely:\r\n-            // We let the row come up, let it set its attributes and only then print the newline.\r\n-            if (delayedLineBreak)\r\n+        if (previousUl != ul)\r\n+        {\r\n+            switch (fg.GetType())\r\n             {\r\n-                buffer.append(L\"\\r\\n\");\r\n-                delayedLineBreak = false;\r\n+            case ColorType::IsDefault:\r\n+                buffer.append(L\"\\x1b[59m\");\r\n+                break;\r\n+            case ColorType::IsIndex256:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:5:{}m\"), ul.GetIndex());\r\n+                break;\r\n+            case ColorType::IsRgb:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:2::{}:{}:{}m\"), ul.GetR(), ul.GetG(), ul.GetB());\r\n+                break;\r\n+            default:\r\n+                break;\r\n             }\r\n+        }\r\n \r\n-            auto newX = oldX + it->length;\r\n-\r\n-            // Since our text buffer doesn't store the original input text, the information over the amount of trailing\r\n-            // whitespaces was lost. If we don't do anything here then a row that just says \"Hello\" would be serialized\r\n-            // to \"Hello                    ...\". If the user restores the buffer dump with a different window size,\r\n-            // this would result in some fairly ugly reflow. This code attempts to at least trim trailing whitespaces.\r\n-            //\r\n-            // As mentioned above for `delayedLineBreak`, rows are initialized with their first attribute, BUT\r\n-            // only if the viewport has begun to scroll. Otherwise, they're initialized with the default attributes.\r\n-            // In other words, we can only skip \\x1b[K = Erase in Line, if both the first/last attribute are the default attribute.\r\n-            static constexpr TextAttribute defaultAttr;\r\n-            const auto trimTrailingWhitespaces = it == last && lastCharX < newX;\r\n-            const auto clearToEndOfLine = trimTrailingWhitespaces && (beg->value != defaultAttr || last->value != defaultAttr);\r\n-\r\n-            if (trimTrailingWhitespaces)\r\n+        if (previousHyperlinkId != hyperlinkId)\r\n+        {\r\n+            if (hyperlinkId)\r\n             {\r\n-                newX = lastCharX;\r\n+                const auto uri = GetHyperlinkUriFromId(hyperlinkId);\r\n+                if (!uri.empty())\r\n+                {\r\n+                    buffer.append(L\"\\x1b]8;;\");\r\n+                    buffer.append(uri);\r\n+                    buffer.append(L\"\\x1b\\\\\");\r\n+                }\r\n             }\r\n-\r\n-            buffer.append(row.GetText(oldX, newX));\r\n-\r\n-            if (clearToEndOfLine)\r\n+            else\r\n             {\r\n-                buffer.append(L\"\\x1b[K\");\r\n+                buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n             }\r\n+        }\r\n \r\n-            oldX = newX;\r\n+        previousTextAttr = it->value;\r\n+\r\n+        // Initially, the buffer is initialized with the default attributes, but once it begins to scroll,\r\n+        // newly scrolled in rows are initialized with the current attributes. This means we need to set\r\n+        // the current attributes to those of the upcoming row before the row comes up. Or inversely:\r\n+        // We let the row come up, let it set its attributes and only then print the newline.\r\n+        if (delayedLineBreak)\r\n+        {\r\n+            buffer.append(L\"\\r\\n\");\r\n+            delayedLineBreak = false;\r\n         }\r\n \r\n-        const auto moreRowsRemaining = currentRow < lastRowWithText;\r\n-        delayedLineBreak = !row.WasWrapForced();\r\n+        auto newX = oldX + it->length;\r\n \r\n-        if (!moreRowsRemaining)\r\n+        // Since our text buffer doesn't store the original input text, the information over the amount of trailing\r\n+        // whitespaces was lost. If we don't do anything here then a row that just says \"Hello\" would be serialized\r\n+        // to \"Hello                    ...\". If the user restores the buffer dump with a different window size,\r\n+        // this would result in some fairly ugly reflow. This code attempts to at least trim trailing whitespaces.\r\n+        //\r\n+        // As mentioned above for `delayedLineBreak`, rows are initialized with their first attribute, BUT\r\n+        // only if the viewport has begun to scroll. Otherwise, they're initialized with the default attributes.\r\n+        // In other words, we can only skip \\x1b[K = Erase in Line, if both the first/last attribute are the default attribute.\r\n+        static constexpr TextAttribute defaultAttr;\r\n+        const auto trimTrailingWhitespaces = it == last && lastCharX < newX;\r\n+        const auto clearToEndOfLine = trimTrailingWhitespaces && (beg->value != defaultAttr || last->value != defaultAttr);\r\n+\r\n+        if (trimTrailingWhitespaces)\r\n         {\r\n-            if (previousHyperlinkId)\r\n-            {\r\n-                buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n-            }\r\n-            buffer.append(L\"\\x1b[m\\r\\n\");\r\n+            newX = lastCharX;\r\n         }\r\n \r\n-        if (buffer.size() >= writeThreshold || !moreRowsRemaining)\r\n+        buffer.append(row.GetText(oldX, newX));\r\n+\r\n+        if (clearToEndOfLine)\r\n         {\r\n-            const auto fileSize = gsl::narrow<DWORD>(buffer.size() * sizeof(wchar_t));\r\n-            DWORD bytesWritten = 0;\r\n-            THROW_IF_WIN32_BOOL_FALSE(WriteFile(file.get(), buffer.data(), fileSize, &bytesWritten, nullptr));\r\n-            THROW_WIN32_IF_MSG(ERROR_WRITE_FAULT, bytesWritten != fileSize, \"failed to write\");\r\n-            buffer.clear();\r\n+            buffer.append(L\"\\x1b[K\");\r\n         }\r\n \r\n-        if (!moreRowsRemaining)\r\n+        oldX = newX;\r\n+    }\r\n+\r\n+    // Handle empty rows (with no runs). See above for more details about `delayedLineBreak`.\r\n+    if (delayedLineBreak)\r\n+    {\r\n+        buffer.append(L\"\\r\\n\");\r\n+        delayedLineBreak = false;\r\n+    }\r\n+\r\n+    delayedLineBreak = !row.WasWrapForced() && addLineBreak;\r\n+\r\n+    if (isLastRow)\r\n+    {\r\n+        if (previousTextAttr.has_value() && previousTextAttr->GetHyperlinkId())\r\n         {\r\n-            break;\r\n+            buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n+        }\r\n+        buffer.append(L\"\\x1b[0m\");\r\n+        if (addLineBreak)\r\n+        {\r\n+            buffer.append(L\"\\r\\n\");\r\n         }\r\n     }\r\n }\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex a39ebd4db40..c97de9e7523 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -266,6 +266,8 @@ class TextBuffer final\n \r\n     std::wstring GetPlainText(const CopyRequest& req) const;\r\n \r\n+    std::wstring GetWithControlSequences(const CopyRequest& req) const;\r\n+\r\n     std::string GenHTML(const CopyRequest& req,\r\n                         const int fontHeightPoints,\r\n                         const std::wstring_view fontFaceName,\r\n@@ -280,7 +282,7 @@ class TextBuffer final\n                        const bool isIntenseBold,\r\n                        std::function<std::tuple<COLORREF, COLORREF, COLORREF>(const TextAttribute&)> GetAttributeColors) const noexcept;\r\n \r\n-    void Serialize(const wchar_t* destination) const;\r\n+    void SerializeToPath(const wchar_t* destination) const;\r\n \r\n     struct PositionInformation\r\n     {\r\n@@ -332,6 +334,8 @@ class TextBuffer final\n \r\n     std::tuple<til::CoordType, til::CoordType, bool> _RowCopyHelper(const CopyRequest& req, const til::CoordType iRow, const ROW& row) const;\r\n \r\n+    void _SerializeRow(const ROW& row, const til::CoordType startX, const til::CoordType endX, const bool addLineBreak, const bool isLastRow, std::wstring& buffer, std::optional<TextAttribute>& previousTextAttr, bool& delayedLineBreak) const;\r\n+\r\n     static void _AppendRTFText(std::string& contentBuilder, const std::wstring_view& text);\r\n \r\n     Microsoft::Console::Render::Renderer* _renderer = nullptr;\r\ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 8675fb98bac..0bfbcff8ad7 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -548,7 +548,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         if (const auto& realArgs = args.ActionArgs().try_as<CopyTextArgs>())\r\n         {\r\n-            const auto handled = _CopyText(realArgs.DismissSelection(), realArgs.SingleLine(), realArgs.CopyFormatting());\r\n+            const auto handled = _CopyText(realArgs.DismissSelection(), realArgs.SingleLine(), realArgs.WithControlSequences(), realArgs.CopyFormatting());\r\n             args.Handled(handled);\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex b3111e9b639..13391e44f42 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -2971,14 +2971,15 @@ namespace winrt::TerminalApp::implementation\n     // Arguments:\n     // - dismissSelection: if not enabled, copying text doesn't dismiss the selection\n     // - singleLine: if enabled, copy contents as a single line of text\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\n     // - formats: dictate which formats need to be copied\n     // Return Value:\n     // - true iff we we able to copy text (if a selection was active)\n-    bool TerminalPage::_CopyText(const bool dismissSelection, const bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats)\n+    bool TerminalPage::_CopyText(const bool dismissSelection, const bool singleLine, const bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats)\n     {\n         if (const auto& control{ _GetActiveControl() })\n         {\n-            return control.CopySelectionToClipboard(dismissSelection, singleLine, formats);\n+            return control.CopySelectionToClipboard(dismissSelection, singleLine, withControlSequences, formats);\n         }\n         return false;\n     }\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 9e5d3029c7f..28ccfd8ec8c 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -429,7 +429,7 @@ namespace winrt::TerminalApp::implementation\n         bool _IsUriSupported(const winrt::Windows::Foundation::Uri& parsedUri);\n \n         void _ShowCouldNotOpenDialog(winrt::hstring reason, winrt::hstring uri);\n-        bool _CopyText(const bool dismissSelection, const bool singleLine, const Windows::Foundation::IReference<Microsoft::Terminal::Control::CopyFormat>& formats);\n+        bool _CopyText(const bool dismissSelection, const bool singleLine, const bool withControlSequences, const Windows::Foundation::IReference<Microsoft::Terminal::Control::CopyFormat>& formats);\n \n         safe_void_coroutine _SetTaskbarProgressHandler(const IInspectable sender, const IInspectable eventArgs);\n \ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex 9cc7732f452..d7beb39a504 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -574,7 +574,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             else if (vkey == VK_RETURN && !mods.IsCtrlPressed() && !mods.IsAltPressed())\r\n             {\r\n                 // [Shift +] Enter --> copy text\r\n-                CopySelectionToClipboard(mods.IsShiftPressed(), nullptr);\r\n+                CopySelectionToClipboard(mods.IsShiftPressed(), false, nullptr);\r\n                 _terminal->ClearSelection();\r\n                 _updateSelectionUI();\r\n                 return true;\r\n@@ -1315,9 +1315,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     //     Windows Clipboard (CascadiaWin32:main.cpp).\r\n     // Arguments:\r\n     // - singleLine: collapse all of the text to one line\r\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n     // - formats: which formats to copy (defined by action's CopyFormatting arg). nullptr\r\n     //             if we should defer which formats are copied to the global setting\r\n     bool ControlCore::CopySelectionToClipboard(bool singleLine,\r\n+                                               bool withControlSequences,\r\n                                                const Windows::Foundation::IReference<CopyFormat>& formats)\r\n     {\r\n         ::Microsoft::Terminal::Core::Terminal::TextCopyData payload;\r\n@@ -1339,7 +1341,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n             // extract text from buffer\r\n             // RetrieveSelectedTextFromBuffer will lock while it's reading\r\n-            payload = _terminal->RetrieveSelectedTextFromBuffer(singleLine, copyHtml, copyRtf);\r\n+            payload = _terminal->RetrieveSelectedTextFromBuffer(singleLine, withControlSequences, copyHtml, copyRtf);\r\n         }\r\n \r\n         copyToClipboard(payload.plainText, payload.html, payload.rtf);\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 1719f34c880..609aed42834 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -123,7 +123,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         void SendInput(std::wstring_view wstr);\r\n         void PasteText(const winrt::hstring& hstr);\r\n-        bool CopySelectionToClipboard(bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n+        bool CopySelectionToClipboard(bool singleLine, bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n         void SelectAll();\r\n         void ClearSelection();\r\n         bool ToggleBlockSelection();\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex f18851c2fbb..c99d69ae6a4 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -194,9 +194,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     //     Windows Clipboard (CascadiaWin32:main.cpp).\r\n     // Arguments:\r\n     // - singleLine: collapse all of the text to one line\r\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n     // - formats: which formats to copy (defined by action's CopyFormatting arg). nullptr\r\n     //             if we should defer which formats are copied to the global setting\r\n     bool ControlInteractivity::CopySelectionToClipboard(bool singleLine,\r\n+                                                        bool withControlSequences,\r\n                                                         const Windows::Foundation::IReference<CopyFormat>& formats)\r\n     {\r\n         if (_core)\r\n@@ -213,7 +215,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             // Mark the current selection as copied\r\n             _selectionNeedsToBeCopied = false;\r\n \r\n-            return _core->CopySelectionToClipboard(singleLine, formats);\r\n+            return _core->CopySelectionToClipboard(singleLine, withControlSequences, formats);\r\n         }\r\n \r\n         return false;\r\n@@ -312,7 +314,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             else\r\n             {\r\n                 // Try to copy the text and clear the selection\r\n-                const auto successfulCopy = CopySelectionToClipboard(shiftEnabled, nullptr);\r\n+                const auto successfulCopy = CopySelectionToClipboard(shiftEnabled, false, nullptr);\r\n                 _core->ClearSelection();\r\n                 if (_core->CopyOnSelect() || !successfulCopy)\r\n                 {\r\n@@ -445,7 +447,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             // IMPORTANT!\r\n             // DO NOT clear the selection here!\r\n             // Otherwise, the selection will be cleared immediately after you make it.\r\n-            CopySelectionToClipboard(false, nullptr);\r\n+            CopySelectionToClipboard(false, false, nullptr);\r\n         }\r\n \r\n         _singleClickTouchdownPos = std::nullopt;\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 22eaa95c397..a1b3d7993cf 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -83,6 +83,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n #pragma endregion\r\n \r\n         bool CopySelectionToClipboard(bool singleLine,\r\n+                                      bool withControlSequences,\r\n                                       const Windows::Foundation::IReference<CopyFormat>& formats);\r\n         void RequestPasteTextFromClipboard();\r\n         void SetEndSelectionPoint(const Core::Point pixelPosition);\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.idl b/src/cascadia/TerminalControl/ControlInteractivity.idl\nindex 926c1e3b0a9..dcc2b793420 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.idl\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.idl\n@@ -32,7 +32,7 @@ namespace Microsoft.Terminal.Control\n \r\n         InteractivityAutomationPeer OnCreateAutomationPeer();\r\n \r\n-        Boolean CopySelectionToClipboard(Boolean singleLine, Windows.Foundation.IReference<CopyFormat> formats);\r\n+        Boolean CopySelectionToClipboard(Boolean singleLine, Boolean withControlSequences, Windows.Foundation.IReference<CopyFormat> formats);\r\n         void RequestPasteTextFromClipboard();\r\n         void SetEndSelectionPoint(Microsoft.Terminal.Core.Point point);\r\n \r\ndiff --git a/src/cascadia/TerminalControl/HwndTerminal.cpp b/src/cascadia/TerminalControl/HwndTerminal.cpp\nindex 905de2ce988..b3cc4edf688 100644\n--- a/src/cascadia/TerminalControl/HwndTerminal.cpp\n+++ b/src/cascadia/TerminalControl/HwndTerminal.cpp\n@@ -116,7 +116,7 @@ try\n                     const auto lock = publicTerminal->_terminal->LockForWriting();\r\n                     if (publicTerminal->_terminal->IsSelectionActive())\r\n                     {\r\n-                        const auto bufferData = publicTerminal->_terminal->RetrieveSelectedTextFromBuffer(false, true, true);\r\n+                        const auto bufferData = publicTerminal->_terminal->RetrieveSelectedTextFromBuffer(false, false, true, true);\r\n                         LOG_IF_FAILED(publicTerminal->_CopyTextToSystemClipboard(bufferData.plainText, bufferData.html, bufferData.rtf));\r\n                         publicTerminal->_ClearSelection();\r\n                         return 0;\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex f76c8c59403..88857713a1f 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -2543,16 +2543,17 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Arguments:\r\n     // - dismissSelection: dismiss the text selection after copy\r\n     // - singleLine: collapse all of the text to one line\r\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n     // - formats: which formats to copy (defined by action's CopyFormatting arg). nullptr\r\n     //             if we should defer which formats are copied to the global setting\r\n-    bool TermControl::CopySelectionToClipboard(bool dismissSelection, bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats)\r\n+    bool TermControl::CopySelectionToClipboard(bool dismissSelection, bool singleLine, bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats)\r\n     {\r\n         if (_IsClosing())\r\n         {\r\n             return false;\r\n         }\r\n \r\n-        const auto successfulCopy = _interactivity.CopySelectionToClipboard(singleLine, formats);\r\n+        const auto successfulCopy = _interactivity.CopySelectionToClipboard(singleLine, withControlSequences, formats);\r\n \r\n         if (dismissSelection)\r\n         {\r\n@@ -4189,7 +4190,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                           const IInspectable& /*args*/)\r\n     {\r\n         // formats = nullptr -> copy all formats\r\n-        _interactivity.CopySelectionToClipboard(false, nullptr);\r\n+        _interactivity.CopySelectionToClipboard(false, false, nullptr);\r\n         ContextMenu().Hide();\r\n         SelectionContextMenu().Hide();\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.h b/src/cascadia/TerminalControl/TermControl.h\nindex d8a44161dbf..7e35585aa59 100644\n--- a/src/cascadia/TerminalControl/TermControl.h\n+++ b/src/cascadia/TerminalControl/TermControl.h\n@@ -60,7 +60,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         hstring GetProfileName() const;\r\n \r\n-        bool CopySelectionToClipboard(bool dismissSelection, bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n+        bool CopySelectionToClipboard(bool dismissSelection, bool singleLine, bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n         void PasteTextFromClipboard();\r\n         void SelectAll();\r\n         bool ToggleBlockSelection();\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.idl b/src/cascadia/TerminalControl/TermControl.idl\nindex c60b5884540..8ff69f33c5e 100644\n--- a/src/cascadia/TerminalControl/TermControl.idl\n+++ b/src/cascadia/TerminalControl/TermControl.idl\n@@ -87,7 +87,7 @@ namespace Microsoft.Terminal.Control\n         event Windows.Foundation.TypedEventHandler<Object, Object> CloseTerminalRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> RestartTerminalRequested;\r\n \r\n-        Boolean CopySelectionToClipboard(Boolean dismissSelection, Boolean singleLine, Windows.Foundation.IReference<CopyFormat> formats);\r\n+        Boolean CopySelectionToClipboard(Boolean dismissSelection, Boolean singleLine, Boolean withControlSequences, Windows.Foundation.IReference<CopyFormat> formats);\r\n         void PasteTextFromClipboard();\r\n         void SelectAll();\r\n         Boolean ToggleBlockSelection();\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c61c339b79e..c77ab1ab764 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1570,7 +1570,7 @@ std::wstring Terminal::CurrentCommand() const\n \r\n void Terminal::SerializeMainBuffer(const wchar_t* destination) const\r\n {\r\n-    _mainBuffer->Serialize(destination);\r\n+    _mainBuffer->SerializeToPath(destination);\r\n }\r\n \r\n void Terminal::ColorSelection(const TextAttribute& attr, winrt::Microsoft::Terminal::Core::MatchMode matchMode)\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex 7fdf0995013..8ac499c97e2 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -320,7 +320,7 @@ class Microsoft::Terminal::Core::Terminal final :\n     til::point SelectionEndForRendering() const;\r\n     const SelectionEndpoint SelectionEndpointTarget() const noexcept;\r\n \r\n-    TextCopyData RetrieveSelectedTextFromBuffer(const bool singleLine, const bool html = false, const bool rtf = false) const;\r\n+    TextCopyData RetrieveSelectedTextFromBuffer(const bool singleLine, const bool withControlSequences = false, const bool html = false, const bool rtf = false) const;\r\n #pragma endregion\r\n \r\n #ifndef NDEBUG\r\ndiff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 2cb3ee08bfd..6a800f329dd 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -844,12 +844,13 @@ void Terminal::ClearSelection()\n // - Optionally, get the highlighted text in HTML and RTF formats\r\n // Arguments:\r\n // - singleLine: collapse all of the text to one line. (Turns off trailing whitespace trimming)\r\n+// - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n // - html: also get text in HTML format\r\n // - rtf: also get text in RTF format\r\n // Return Value:\r\n // - Plain and formatted selected text from buffer. Empty string represents no data for that format.\r\n // - If extended to multiple lines, each line is separated by \\r\\n\r\n-Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singleLine, const bool html, const bool rtf) const\r\n+Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singleLine, const bool withControlSequences, const bool html, const bool rtf) const\r\n {\r\n     TextCopyData data;\r\n \r\n@@ -867,7 +868,14 @@ Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singl\n     const auto& textBuffer = _activeBuffer();\r\n \r\n     const auto req = TextBuffer::CopyRequest::FromConfig(textBuffer, _selection->start, _selection->end, singleLine, _selection->blockSelection, _trimBlockSelection);\r\n-    data.plainText = textBuffer.GetPlainText(req);\r\n+    if (withControlSequences)\r\n+    {\r\n+        data.plainText = textBuffer.GetWithControlSequences(req);\r\n+    }\r\n+    else\r\n+    {\r\n+        data.plainText = textBuffer.GetPlainText(req);\r\n+    }\r\n \r\n     if (html || rtf)\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\nindex 8b3e58a11b5..98411fd9b98 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n@@ -207,6 +207,11 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n             str.append(RS_(L\"CopyTextCommandKey\"));\r\n         }\r\n \r\n+        if (WithControlSequences())\r\n+        {\r\n+            str.append(L\", withControlSequences: true\");\r\n+        }\r\n+\r\n         if (!DismissSelection())\r\n         {\r\n             str.append(L\", dismissSelection: false\");\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.h b/src/cascadia/TerminalSettingsModel/ActionArgs.h\nindex 84c23dd2d7d..cd854b19cf3 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.h\n@@ -103,9 +103,10 @@ protected:                                                                  \\\n // false, if we don't really care if the parameter is required or not.\r\n \r\n ////////////////////////////////////////////////////////////////////////////////\r\n-#define COPY_TEXT_ARGS(X)                                      \\\r\n-    X(bool, DismissSelection, \"dismissSelection\", false, true) \\\r\n-    X(bool, SingleLine, \"singleLine\", false, false)            \\\r\n+#define COPY_TEXT_ARGS(X)                                               \\\r\n+    X(bool, DismissSelection, \"dismissSelection\", false, true)          \\\r\n+    X(bool, SingleLine, \"singleLine\", false, false)                     \\\r\n+    X(bool, WithControlSequences, \"withControlSequences\", false, false) \\\r\n     X(Windows::Foundation::IReference<Control::CopyFormat>, CopyFormatting, \"copyFormatting\", false, nullptr)\r\n \r\n ////////////////////////////////////////////////////////////////////////////////\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.idl b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\nindex 02f0c4d0413..5f6bf22cd5f 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n@@ -180,6 +180,7 @@ namespace Microsoft.Terminal.Settings.Model\n         CopyTextArgs();\r\n         Boolean DismissSelection { get; };\r\n         Boolean SingleLine { get; };\r\n+        Boolean WithControlSequences { get; };\r\n         Windows.Foundation.IReference<Microsoft.Terminal.Control.CopyFormat> CopyFormatting { get; };\r\n     };\r\n \r\n", "test_patch": "", "problem_statement": "Copy with Control Sequences\n# Description of the new feature/enhancement\r\nOption to copy text from the terminal with ANSI sequences. Useful when you need to copy styled output to another file like a markdown codefence with ansi-support (ex. https://github.com/expressive-code/expressive-code/pull/29)\r\n\r\nSee similar option in [iTerm2](https://iterm2.com/documentation-menu-items.html): Edit > Copy with Control Sequences\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nA new \"Copy with Control Sequences\" command that includes escape sequences in the copied text. Either include original ANSI-sequences if possible or recreate (best-effort) like iTerm2.\n", "hints_text": "Hey there! I'm interested in helping out with this, and I've gotten a very basic proof-of-concept version working locally: https://github.com/microsoft/terminal/compare/main...FuegoFro:windows_terminal:copy_with_control_sequences?expand=1\r\n\r\nBut before I keep working on it I wanted to check in on a few things:\r\n- I see that this doesn't have the `Help Wanted` label, what does that mean regarding outside contributions?\r\n- In the `CONTRIBUTING.md` it mentions that the `Issue-Feature` label indicates it likely requires a spec; does that hold true here, or does this seem like the kind of thing that could be worked out on a PR directly?\r\n- Maybe this is just a different phrasing of the above, but what would be the best way to proceed here? Should I open an RFC/WIP PR for high-level feedback? Continue discussion here? Take a stab at a spec? Flesh out tests/docs/functionality on that branch?\r\n\r\nI appreciate any and all guidance here! \ud83d\ude4f\r\n\r\n(also as a side note, I just wanted to say how much I appreciate the docs and tooling here; I was able to go from \"I've never worked with Windows-specific tooling\" to \"I have this up and running and can see the changes I've made\" in a day, which is awesome \ud83c\udf89)\nOh man, this is so cool! Thanks so much for working on it!\r\n\r\nAbsolutely -- we usually mark things \"Help Wanted\" if we think they'll be _approachable_ for a community member. Getting down into the nitty-gritty of the text buffer _usually_ isn't approachable.\r\n\r\nIn the time since you started working on that (maybe? I could be wrong!) @lhecker added a somewhat generic or genericizable function to TextBuffer that does the same thing. It's currently used for session save/restore. I wonder if y'all can converge!\r\n\r\nI'm so glad you were able to get going[^1] and I'm looking forward to your eventual PR \ud83d\ude42 \r\n\r\n[^1]: (I am eternally afraid that our project is too terrifically complex to get started on, so thanks for hatcheting through the wilderness)\nAh amazing, thank you so much for the quick response!\r\n\r\nThat function is exactly what I wanted, so glad I can reuse it and not reimplement that all myself! \ud83d\ude05 Thanks for pointing me at it \ud83d\ude0a \r\n\r\nGiven there wasn't mention of a spec in the above response, I've gone ahead and opened https://github.com/microsoft/terminal/pull/17059 with an implementation that reuses the serialize function. Aside from a few questions I've left there, I think it should be ready for feedback!\nIf I may just offer some outside view on this.\r\nFirst, I think allowing copy/paste with VT control sequences is a great idea, definitely something that should be supported in some way.\r\nThe goal of the clipboard is to provide as many formats as possible to enable as many copy/paste scenarios as possible.\r\nThe question really is only in which way...\r\n\r\nVT being an in-band control in the text stream, copying it as `CF_UNICODETEXT` makes sense in several scenario, for example to copy formatted text to a script source file, or a code editor. We cannot expect all the editors to support a special clipboard format, so having the ability to copy them as `CF_UNICODETEXT` is required for those.\r\nThe problem is that there are also even more scenarios where we want to copy text without the control sequences, and the target application that doesn't know VT cannot provide a \"paste as plain text\" option since that precisely picks the `CF_UNICODETEXT` over a richer format. So copying with VT should be an option, not the default. We need `CF_UNICODETEXT` to contain plain text unless explicitly requested for all other apps to properly support \"paste as plain text\".\r\nI think the default copy (right-click) should be text only, a modifier key (Shift, Ctrl, Alt) could be used to explicitly copy with the control sequences. Another solution could be for the right-click to always show a popup menu, which could also provide more discoverable options for paste, and maybe someday to insert special characters not easily accessible on the keyboard, or use a special item in the tab's menu.\r\n\r\nNow on to the second solution, using a special ANSI/VT clipboard format. This would be a great solution for terminal-oriented apps that want to explicitly support these control sequences. I don't think this is an alternative to the `CF_UNICODETEXT`, the ANSI/VT format should *always* be copied. This means apps that can handle VT control sequences can always chose to process them regardless of how the text was copied from Terminal, and it also makes it explicit that that format contains VT, similarly to how RTF isn't an option but always copied alongside plain text.\r\nHaving that specific clipboard format always available when copying from Terminal would not make the \"copy with VT in `CF_UNICODETEXT`\" unnecessary, but would make it necessary only when the goal is to paste with the control sequences in a text editor or another app that isn't specifically terminal-oriented, making the extra operation to explicitly copy as \"text with VT\"  less of a hassle as it would be required less often.\r\n\r\nSo to summarize, my ideal solution would be:\r\n- Copying keeps plain-text (without VT) in `CF_UNICODETEXT`, alonside a \"CF_UNICODEVT\" format that contains the text+VT for apps explicitly requesting VT when available, just like it also copies as `CF_RTF`.\r\n- A special \"copy with VT\" option to store the text+VT in both `CF_UNICODETEXT` and \"CF_UNICODEVT\" to enable copying it when needed to apps not designed for VT.\r\n\r\nThis makes the VT always available to apps that expect it, and enables advanced users/devs to copy with VT to apps that are not designed for it.\r\n\r\nI would also add a `CF_BITMAP` version, containing a visual copy of the selection, making it much easier to do screenshot-like copy/paste in documentation about text-mode utilities. I'll be submitting an issue with that suggestion in more details.\r\n\r\nOn a related note, the `Export text` option should also allow the user to select plain text or VT text when saving the .txt file.\n> VT being an in-band control in the text stream, copying it as `CF_UNICODETEXT` makes sense in several scenario, for example to copy formatted text to a script source file, or a code editor.\r\n\r\nThe same can be said of HTML and RTF though. If we're going to support that for one format, we should support it for all of them.\n@j4james I agree, and browsers have the _Developer Tools_ to enable copy of HTML as `CF_UNICODETEXT` for advanced users, and always copy as a special HTML format for apps that look for it specifically because they can handle it. This makes the copy/paste experience between Edge and Word more advanced and convenient than plain text, and is exactly what I'm advocating for in Terminal.\r\n\r\nProviding exports to HTML, RTF, and Bitmap from Terminal would make a lot of sense to improve the copy/paste scenarios with apps that do not handle VT.\r\nAnd I don't think it would be very difficult to achieve, providing the font name, changing colors, and a few text attributes. It doesn't have to be perfect and map every single feature of VT, keeping the colors and some attributes would already be better than the plain text we currently have.\r\nHaving all those formats in the clipboard would make the life of users writing technical documents so much easier!", "created_at": "2024-04-13 21:44:18", "merge_commit_sha": "282670a092e3f60a0d9cf11b53d01a36a004edd5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-16513", "base_commit": "8009b5381936780ccc33d091a87222382ab0cf6e", "patch": "diff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 724f7dafb70..ac01af8cb3b 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -1264,6 +1264,113 @@ namespace winrt::TerminalApp::implementation\n         }\r\n     }\r\n \r\n+    void TerminalPage::_HandleSaveSnippet(const IInspectable& /*sender*/,\r\n+                                          const ActionEventArgs& args)\r\n+    {\r\n+        if constexpr (!Feature_SaveSnippet::IsEnabled())\r\n+        {\r\n+            return;\r\n+        }\r\n+\r\n+        if (args)\r\n+        {\r\n+            if (const auto& realArgs = args.ActionArgs().try_as<SaveSnippetArgs>())\r\n+            {\r\n+                auto commandLine = realArgs.Commandline();\r\n+                if (commandLine.empty())\r\n+                {\r\n+                    if (const auto termControl{ _GetActiveControl() })\r\n+                    {\r\n+                        if (termControl.HasSelection())\r\n+                        {\r\n+                            const auto selections{ termControl.SelectedText(true) };\r\n+                            const auto selection = std::accumulate(selections.begin(), selections.end(), std::wstring());\r\n+                            commandLine = selection;\r\n+                        }\r\n+                    }\r\n+                }\r\n+\r\n+                if (commandLine.empty())\r\n+                {\r\n+                    ActionSaveFailed(L\"CommandLine is Required\");\r\n+                    return;\r\n+                }\r\n+\r\n+                try\r\n+                {\r\n+                    KeyChord keyChord = nullptr;\r\n+                    if (!realArgs.KeyChord().empty())\r\n+                    {\r\n+                        keyChord = KeyChordSerialization::FromString(winrt::to_hstring(realArgs.KeyChord()));\r\n+                    }\r\n+                    _settings.GlobalSettings().ActionMap().AddSendInputAction(realArgs.Name(), commandLine, keyChord);\r\n+                    _settings.WriteSettingsToDisk();\r\n+                    ActionSaved(commandLine, realArgs.Name(), realArgs.KeyChord());\r\n+                }\r\n+                catch (const winrt::hresult_error& ex)\r\n+                {\r\n+                    auto code = ex.code();\r\n+                    auto message = ex.message();\r\n+                    ActionSaveFailed(message);\r\n+                    args.Handled(true);\r\n+                    return;\r\n+                }\r\n+\r\n+                args.Handled(true);\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    void TerminalPage::ActionSaved(winrt::hstring input, winrt::hstring name, winrt::hstring keyChord)\r\n+    {\r\n+        // If we haven't ever loaded the TeachingTip, then do so now and\r\n+        // create the toast for it.\r\n+        if (_actionSavedToast == nullptr)\r\n+        {\r\n+            if (auto tip{ FindName(L\"ActionSavedToast\").try_as<MUX::Controls::TeachingTip>() })\r\n+            {\r\n+                _actionSavedToast = std::make_shared<Toast>(tip);\r\n+                // Make sure to use the weak ref when setting up this\r\n+                // callback.\r\n+                tip.Closed({ get_weak(), &TerminalPage::_FocusActiveControl });\r\n+            }\r\n+        }\r\n+        _UpdateTeachingTipTheme(ActionSavedToast().try_as<winrt::Windows::UI::Xaml::FrameworkElement>());\r\n+\r\n+        SavedActionName(name);\r\n+        SavedActionKeyChord(keyChord);\r\n+        SavedActionCommandLine(input);\r\n+\r\n+        if (_actionSavedToast != nullptr)\r\n+        {\r\n+            _actionSavedToast->Open();\r\n+        }\r\n+    }\r\n+\r\n+    void TerminalPage::ActionSaveFailed(winrt::hstring message)\r\n+    {\r\n+        // If we haven't ever loaded the TeachingTip, then do so now and\r\n+        // create the toast for it.\r\n+        if (_actionSaveFailedToast == nullptr)\r\n+        {\r\n+            if (auto tip{ FindName(L\"ActionSaveFailedToast\").try_as<MUX::Controls::TeachingTip>() })\r\n+            {\r\n+                _actionSaveFailedToast = std::make_shared<Toast>(tip);\r\n+                // Make sure to use the weak ref when setting up this\r\n+                // callback.\r\n+                tip.Closed({ get_weak(), &TerminalPage::_FocusActiveControl });\r\n+            }\r\n+        }\r\n+        _UpdateTeachingTipTheme(ActionSaveFailedToast().try_as<winrt::Windows::UI::Xaml::FrameworkElement>());\r\n+\r\n+        ActionSaveFailedMessage().Text(message);\r\n+\r\n+        if (_actionSaveFailedToast != nullptr)\r\n+        {\r\n+            _actionSaveFailedToast->Open();\r\n+        }\r\n+    }\r\n+\r\n     void TerminalPage::_HandleSelectCommand(const IInspectable& /*sender*/,\r\n                                             const ActionEventArgs& args)\r\n     {\r\ndiff --git a/src/cascadia/TerminalApp/AppCommandlineArgs.cpp b/src/cascadia/TerminalApp/AppCommandlineArgs.cpp\nindex b7a6b581a05..c1154f56728 100644\n--- a/src/cascadia/TerminalApp/AppCommandlineArgs.cpp\n+++ b/src/cascadia/TerminalApp/AppCommandlineArgs.cpp\n@@ -209,6 +209,7 @@ void AppCommandlineArgs::_buildParser()\n     _buildMovePaneParser();\r\n     _buildSwapPaneParser();\r\n     _buildFocusPaneParser();\r\n+    _buildSaveSnippetParser();\r\n }\r\n \r\n // Method Description:\r\n@@ -537,6 +538,72 @@ void AppCommandlineArgs::_buildFocusPaneParser()\n     setupSubcommand(_focusPaneShort);\r\n }\r\n \r\n+void AppCommandlineArgs::_buildSaveSnippetParser()\r\n+{\r\n+    _saveCommand = _app.add_subcommand(\"x-save-snippet\", RS_A(L\"SaveSnippetDesc\"));\r\n+\r\n+    auto setupSubcommand = [this](auto* subcommand) {\r\n+        subcommand->add_option(\"--name,-n\", _saveInputName, RS_A(L\"SaveSnippetArgDesc\"));\r\n+        subcommand->add_option(\"--keychord,-k\", _keyChordOption, RS_A(L\"KeyChordArgDesc\"));\r\n+        subcommand->add_option(\"command,\", _commandline, RS_A(L\"CmdCommandArgDesc\"));\r\n+        subcommand->positionals_at_end(true);\r\n+\r\n+        // When ParseCommand is called, if this subcommand was provided, this\r\n+        // callback function will be triggered on the same thread. We can be sure\r\n+        // that `this` will still be safe - this function just lets us know this\r\n+        // command was parsed.\r\n+        subcommand->callback([&, this]() {\r\n+            // Build the action from the values we've parsed on the commandline.\r\n+            ActionAndArgs saveSnippet{};\r\n+            saveSnippet.Action(ShortcutAction::SaveSnippet);\r\n+            // First, parse out the commandline in the same way that\r\n+            // _getNewTerminalArgs does it\r\n+            SaveSnippetArgs args{};\r\n+\r\n+            if (!_commandline.empty())\r\n+            {\r\n+                std::ostringstream cmdlineBuffer;\r\n+\r\n+                for (const auto& arg : _commandline)\r\n+                {\r\n+                    if (cmdlineBuffer.tellp() != 0)\r\n+                    {\r\n+                        // If there's already something in here, prepend a space\r\n+                        cmdlineBuffer << ' ';\r\n+                    }\r\n+\r\n+                    if (arg.find(\" \") != std::string::npos)\r\n+                    {\r\n+                        cmdlineBuffer << '\"' << arg << '\"';\r\n+                    }\r\n+                    else\r\n+                    {\r\n+                        cmdlineBuffer << arg;\r\n+                    }\r\n+                }\r\n+\r\n+                args.Commandline(winrt::to_hstring(cmdlineBuffer.str()));\r\n+            }\r\n+\r\n+            if (!_keyChordOption.empty())\r\n+            {\r\n+                args.KeyChord(winrt::to_hstring(_keyChordOption));\r\n+            }\r\n+\r\n+            if (!_saveInputName.empty())\r\n+            {\r\n+                winrt::hstring hString = winrt::to_hstring(_saveInputName);\r\n+                args.Name(hString);\r\n+            }\r\n+\r\n+            saveSnippet.Args(args);\r\n+            _startupActions.push_back(saveSnippet);\r\n+        });\r\n+    };\r\n+\r\n+    setupSubcommand(_saveCommand);\r\n+}\r\n+\r\n // Method Description:\r\n // - Add the `NewTerminalArgs` parameters to the given subcommand. This enables\r\n //   that subcommand to support all the properties in a NewTerminalArgs.\r\n@@ -710,7 +777,8 @@ bool AppCommandlineArgs::_noCommandsProvided()\n              *_focusPaneCommand ||\r\n              *_focusPaneShort ||\r\n              *_newPaneShort.subcommand ||\r\n-             *_newPaneCommand.subcommand);\r\n+             *_newPaneCommand.subcommand ||\r\n+             *_saveCommand);\r\n }\r\n \r\n // Method Description:\r\ndiff --git a/src/cascadia/TerminalApp/AppCommandlineArgs.h b/src/cascadia/TerminalApp/AppCommandlineArgs.h\nindex 7eb5a34f93d..7eb2516bb38 100644\n--- a/src/cascadia/TerminalApp/AppCommandlineArgs.h\n+++ b/src/cascadia/TerminalApp/AppCommandlineArgs.h\n@@ -93,6 +93,7 @@ class TerminalApp::AppCommandlineArgs final\n     CLI::App* _swapPaneCommand;\r\n     CLI::App* _focusPaneCommand;\r\n     CLI::App* _focusPaneShort;\r\n+    CLI::App* _saveCommand;\r\n \r\n     // Are you adding a new sub-command? Make sure to update _noCommandsProvided!\r\n \r\n@@ -123,6 +124,8 @@ class TerminalApp::AppCommandlineArgs final\n     bool _focusPrevTab{ false };\r\n \r\n     int _focusPaneTarget{ -1 };\r\n+    std::string _saveInputName;\r\n+    std::string _keyChordOption;\r\n     // Are you adding more args here? Make sure to reset them in _resetStateToDefault\r\n \r\n     const Commandline* _currentCommandline{ nullptr };\r\n@@ -141,6 +144,7 @@ class TerminalApp::AppCommandlineArgs final\n     winrt::Microsoft::Terminal::Settings::Model::NewTerminalArgs _getNewTerminalArgs(NewTerminalSubcommand& subcommand);\r\n     void _addNewTerminalArgs(NewTerminalSubcommand& subcommand);\r\n     void _buildParser();\r\n+    void _buildSaveSnippetParser();\r\n     void _buildNewTabParser();\r\n     void _buildSplitPaneParser();\r\n     void _buildFocusTabParser();\r\ndiff --git a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\nindex 15b79c40ffc..efe3e1278e2 100644\n--- a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n@@ -288,6 +288,15 @@\n   <data name=\"CmdCommandArgDesc\" xml:space=\"preserve\">\r\n     <value>An optional command, with arguments, to be spawned in the new tab or pane</value>\r\n   </data>\r\n+  <data name=\"SaveSnippetDesc\" xml:space=\"preserve\">\r\n+    <value>Save command line as input action</value>\r\n+  </data>\r\n+  <data name=\"SaveSnippetArgDesc\" xml:space=\"preserve\">\r\n+    <value>An optional argument</value>\r\n+  </data>\r\n+  <data name=\"KeyChordArgDesc\" xml:space=\"preserve\">\r\n+    <value>An optional argument</value>\r\n+  </data>\r\n   <data name=\"CmdFocusTabDesc\" xml:space=\"preserve\">\r\n     <value>Move focus to another tab</value>\r\n   </data>\r\n@@ -898,4 +907,10 @@\n   <data name=\"RestartConnectionToolTip\" xml:space=\"preserve\">\r\n     <value>Restart the active pane connection</value>\r\n   </data>\r\n+  <data name=\"ActionSavedToast.Title\" xml:space=\"preserve\">\r\n+    <value>Action saved</value>\r\n+  </data>\r\n+  <data name=\"ActionSaveFailedToast.Title\" xml:space=\"preserve\">\r\n+    <value>Action save failed</value>\r\n+  </data>\r\n </root>\r\ndiff --git a/src/cascadia/TerminalApp/TerminalAppLib.vcxproj b/src/cascadia/TerminalApp/TerminalAppLib.vcxproj\nindex d0629da8036..238fecf9afc 100644\n--- a/src/cascadia/TerminalApp/TerminalAppLib.vcxproj\n+++ b/src/cascadia/TerminalApp/TerminalAppLib.vcxproj\n@@ -357,7 +357,9 @@\n   </ItemGroup>\r\n   <!-- ========================= Misc Files ======================== -->\r\n   <ItemGroup>\r\n-    <PRIResource Include=\"Resources\\en-US\\Resources.resw\" />\r\n+    <PRIResource Include=\"Resources\\en-US\\Resources.resw\">\r\n+      <SubType>Designer</SubType>\r\n+    </PRIResource>\r\n     <PRIResource Include=\"Resources\\en-US\\ContextMenu.resw\" />\r\n     <OCResourceDirectory Include=\"Resources\" />\r\n   </ItemGroup>\r\n@@ -466,10 +468,8 @@\n   </ItemDefinitionGroup>\r\n   <!-- ========================= Globals ======================== -->\r\n   <Import Project=\"$(OpenConsoleDir)src\\cppwinrt.build.post.props\" />\r\n-\r\n   <!-- This -must- go after cppwinrt.build.post.props because that includes many VS-provided props including appcontainer.common.props, which stomps on what cppwinrt.targets did. -->\r\n   <Import Project=\"$(OpenConsoleDir)src\\common.nugetversions.targets\" />\r\n-\r\n   <!--\r\n     By default, the PRI file will contain resource paths beginning with the\r\n     project name. Since we enabled XBF embedding, this *also* includes App.xbf.\r\n@@ -490,4 +490,4 @@\n     </ItemGroup>\r\n   </Target>\r\n   <Import Project=\"$(SolutionDir)build\\rules\\CollectWildcardResources.targets\" />\r\n-</Project>\r\n+</Project>\n\\ No newline at end of file\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 0a6f5d70957..07dbf173242 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -146,6 +146,8 @@ namespace winrt::TerminalApp::implementation\n         winrt::hstring KeyboardServiceDisabledText();\n \n         winrt::fire_and_forget IdentifyWindow();\n+        void ActionSaved(winrt::hstring input, winrt::hstring name, winrt::hstring keyChord);\n+        void ActionSaveFailed(winrt::hstring message);\n         winrt::fire_and_forget RenameFailed();\n         winrt::fire_and_forget ShowTerminalWorkingDirectory();\n \n@@ -199,6 +201,10 @@ namespace winrt::TerminalApp::implementation\n         WINRT_OBSERVABLE_PROPERTY(winrt::Windows::UI::Xaml::Media::Brush, TitlebarBrush, PropertyChanged.raise, nullptr);\n         WINRT_OBSERVABLE_PROPERTY(winrt::Windows::UI::Xaml::Media::Brush, FrameBrush, PropertyChanged.raise, nullptr);\n \n+        WINRT_OBSERVABLE_PROPERTY(winrt::hstring, SavedActionName, PropertyChanged.raise, L\"\");\n+        WINRT_OBSERVABLE_PROPERTY(winrt::hstring, SavedActionKeyChord, PropertyChanged.raise, L\"\");\n+        WINRT_OBSERVABLE_PROPERTY(winrt::hstring, SavedActionCommandLine, PropertyChanged.raise, L\"\");\n+\n     private:\n         friend struct TerminalPageT<TerminalPage>; // for Xaml to bind events\n         std::optional<HWND> _hostingHwnd;\n@@ -258,6 +264,8 @@ namespace winrt::TerminalApp::implementation\n         bool _isEmbeddingInboundListener{ false };\n \n         std::shared_ptr<Toast> _windowIdToast{ nullptr };\n+        std::shared_ptr<Toast> _actionSavedToast{ nullptr };\n+        std::shared_ptr<Toast> _actionSaveFailedToast{ nullptr };\n         std::shared_ptr<Toast> _windowRenameFailedToast{ nullptr };\n         std::shared_ptr<Toast> _windowCwdToast{ nullptr };\n \ndiff --git a/src/cascadia/TerminalApp/TerminalPage.idl b/src/cascadia/TerminalApp/TerminalPage.idl\nindex 667350056b8..9e272351406 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.idl\n+++ b/src/cascadia/TerminalApp/TerminalPage.idl\n@@ -72,6 +72,10 @@ namespace TerminalApp\n         void IdentifyWindow();\n         void RenameFailed();\n \n+        String SavedActionName { get; };\n+        String SavedActionKeyChord { get; };\n+        String SavedActionCommandLine { get; };\n+\n         // We cannot use the default XAML APIs because we want to make sure\n         // that there's only one application-global dialog visible at a time,\n         // and because of GH#5224.\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.xaml b/src/cascadia/TerminalApp/TerminalPage.xaml\nindex c8aa837bf82..ce6fc576071 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.xaml\n+++ b/src/cascadia/TerminalApp/TerminalPage.xaml\n@@ -8,6 +8,7 @@\n       xmlns:d=\"http://schemas.microsoft.com/expression/blend/2008\"\r\n       xmlns:local=\"using:TerminalApp\"\r\n       xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"\r\n+      xmlns:mtu=\"using:Microsoft.Terminal.UI\"\r\n       xmlns:mux=\"using:Microsoft.UI.Xaml.Controls\"\r\n       Background=\"Transparent\"\r\n       mc:Ignorable=\"d\">\r\n@@ -204,5 +205,43 @@\n                          Title=\"{x:Bind WindowProperties.VirtualWorkingDirectory, Mode=OneWay}\"\r\n                          x:Load=\"False\"\r\n                          IsLightDismissEnabled=\"True\" />\r\n+\r\n+        <mux:TeachingTip x:Name=\"ActionSavedToast\"\r\n+                         x:Uid=\"ActionSavedToast\"\r\n+                         Title=\"Action Saved\"\r\n+                         HorizontalAlignment=\"Stretch\"\r\n+                         x:Load=\"False\"\r\n+                         IsLightDismissEnabled=\"True\">\r\n+            <mux:TeachingTip.Content>\r\n+                <StackPanel HorizontalAlignment=\"Stretch\"\r\n+                            Orientation=\"Vertical\">\r\n+                    <TextBlock x:Name=\"ActionSavedNameText\"\r\n+                               Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(SavedActionName), Mode=OneWay}\">\r\n+                        <Run Text=\"Name: \" />\r\n+                        <Run Text=\"{x:Bind SavedActionName, Mode=OneWay}\" />\r\n+                    </TextBlock>\r\n+                    <TextBlock x:Name=\"ActionSavedKeyChordText\"\r\n+                               Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(SavedActionKeyChord), Mode=OneWay}\">\r\n+                        <Run Text=\"Key Chord: \" />\r\n+                        <Run Text=\"{x:Bind SavedActionKeyChord, Mode=OneWay}\" />\r\n+                    </TextBlock>\r\n+                    <TextBlock x:Name=\"ActionSavedCommandLineText\"\r\n+                               Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(SavedActionCommandLine), Mode=OneWay}\">\r\n+                        <Run Text=\"Input: \" />\r\n+                        <Run Text=\"{x:Bind SavedActionCommandLine, Mode=OneWay}\" />\r\n+                    </TextBlock>\r\n+                </StackPanel>\r\n+            </mux:TeachingTip.Content>\r\n+        </mux:TeachingTip>\r\n+        <mux:TeachingTip x:Name=\"ActionSaveFailedToast\"\r\n+                         x:Uid=\"ActionSaveFailedToast\"\r\n+                         Title=\"Action Save Failed\"\r\n+                         x:Load=\"False\"\r\n+                         IsLightDismissEnabled=\"True\">\r\n+            <mux:TeachingTip.Content>\r\n+                <TextBlock x:Name=\"ActionSaveFailedMessage\"\r\n+                           Text=\"\" />\r\n+            </mux:TeachingTip.Content>\r\n+        </mux:TeachingTip>\r\n     </Grid>\r\n </Page>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp b/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp\nindex 7bba13bc4cc..9b2ef821f58 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp\n@@ -52,6 +52,7 @@ static constexpr std::string_view SwitchToTabKey{ \"switchToTab\" };\n static constexpr std::string_view TabSearchKey{ \"tabSearch\" };\n static constexpr std::string_view ToggleAlwaysOnTopKey{ \"toggleAlwaysOnTop\" };\n static constexpr std::string_view ToggleCommandPaletteKey{ \"commandPalette\" };\n+static constexpr std::string_view SaveSnippetKey{ \"experimental.saveSnippet\" };\n static constexpr std::string_view SuggestionsKey{ \"showSuggestions\" };\n static constexpr std::string_view ToggleFocusModeKey{ \"toggleFocusMode\" };\n static constexpr std::string_view SetFocusModeKey{ \"setFocusMode\" };\n@@ -389,6 +390,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n                 { ShortcutAction::TabSearch, RS_(L\"TabSearchCommandKey\") },\n                 { ShortcutAction::ToggleAlwaysOnTop, RS_(L\"ToggleAlwaysOnTopCommandKey\") },\n                 { ShortcutAction::ToggleCommandPalette, MustGenerate },\n+                { ShortcutAction::SaveSnippet, MustGenerate },\n                 { ShortcutAction::Suggestions, MustGenerate },\n                 { ShortcutAction::ToggleFocusMode, RS_(L\"ToggleFocusModeCommandKey\") },\n                 { ShortcutAction::SetFocusMode, MustGenerate },\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\nindex 24f4e445953..d018b6019e4 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n@@ -33,6 +33,7 @@\n #include \"ScrollToMarkArgs.g.cpp\"\r\n #include \"AddMarkArgs.g.cpp\"\r\n #include \"FindMatchArgs.g.cpp\"\r\n+#include \"SaveSnippetArgs.g.cpp\"\r\n #include \"ToggleCommandPaletteArgs.g.cpp\"\r\n #include \"SuggestionsArgs.g.cpp\"\r\n #include \"NewWindowArgs.g.cpp\"\r\n@@ -947,6 +948,29 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         }\r\n     }\r\n \r\n+    winrt::hstring SaveSnippetArgs::GenerateName() const\r\n+    {\r\n+        if (Feature_SaveSnippet::IsEnabled())\r\n+        {\r\n+            std::wstringstream ss;\r\n+\r\n+            ss << RS_(L\"SaveSnippetNamePrefix\").c_str() << L\" commandline: \" << Commandline().c_str();\r\n+\r\n+            if (!Name().empty())\r\n+            {\r\n+                ss << L\", name: \" << Name().c_str();\r\n+            }\r\n+\r\n+            if (!KeyChord().empty())\r\n+            {\r\n+                ss << L\", keyChord \" << KeyChord().c_str();\r\n+            }\r\n+\r\n+            return winrt::hstring{ ss.str() };\r\n+        }\r\n+        return L\"\";\r\n+    }\r\n+\r\n     static winrt::hstring _FormatColorString(const Control::SelectionColor& selectionColor)\r\n     {\r\n         if (!selectionColor)\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.h b/src/cascadia/TerminalSettingsModel/ActionArgs.h\nindex ae3d7d50029..84c23dd2d7d 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.h\n@@ -34,6 +34,7 @@\n #include \"ScrollToMarkArgs.g.h\"\r\n #include \"AddMarkArgs.g.h\"\r\n #include \"MoveTabArgs.g.h\"\r\n+#include \"SaveSnippetArgs.g.h\"\r\n #include \"ToggleCommandPaletteArgs.g.h\"\r\n #include \"SuggestionsArgs.g.h\"\r\n #include \"FindMatchArgs.g.h\"\r\n@@ -215,6 +216,12 @@ protected:                                                                  \\\n #define TOGGLE_COMMAND_PALETTE_ARGS(X) \\\r\n     X(CommandPaletteLaunchMode, LaunchMode, \"launchMode\", false, CommandPaletteLaunchMode::Action)\r\n \r\n+////////////////////////////////////////////////////////////////////////////////\r\n+#define SAVE_TASK_ARGS(X)                                                           \\\r\n+    X(winrt::hstring, Name, \"name\", false, L\"\")                                     \\\r\n+    X(winrt::hstring, Commandline, \"commandline\", args->Commandline().empty(), L\"\") \\\r\n+    X(winrt::hstring, KeyChord, \"keyChord\", false, L\"\")\r\n+\r\n ////////////////////////////////////////////////////////////////////////////////\r\n #define SUGGESTIONS_ARGS(X)                                                 \\\r\n     X(SuggestionsSource, Source, \"source\", false, SuggestionsSource::Tasks) \\\r\n@@ -819,6 +826,8 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n \r\n     ACTION_ARGS_STRUCT(ToggleCommandPaletteArgs, TOGGLE_COMMAND_PALETTE_ARGS);\r\n \r\n+    ACTION_ARGS_STRUCT(SaveSnippetArgs, SAVE_TASK_ARGS);\r\n+\r\n     ACTION_ARGS_STRUCT(SuggestionsArgs, SUGGESTIONS_ARGS);\r\n \r\n     ACTION_ARGS_STRUCT(FindMatchArgs, FIND_MATCH_ARGS);\r\n@@ -941,6 +950,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::factory_implementation\n     BASIC_FACTORY(CloseTabArgs);\r\n     BASIC_FACTORY(MoveTabArgs);\r\n     BASIC_FACTORY(OpenSettingsArgs);\r\n+    BASIC_FACTORY(SaveSnippetArgs);\r\n     BASIC_FACTORY(FindMatchArgs);\r\n     BASIC_FACTORY(NewWindowArgs);\r\n     BASIC_FACTORY(FocusPaneArgs);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.idl b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\nindex 5992f2d5217..02f0c4d0413 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n@@ -357,6 +357,15 @@ namespace Microsoft.Terminal.Settings.Model\n         FindMatchDirection Direction { get; };\r\n     };\r\n \r\n+    [default_interface] runtimeclass SaveSnippetArgs : IActionArgs\r\n+    {\r\n+        SaveSnippetArgs();\r\n+        SaveSnippetArgs(String Name, String Commandline, String KeyChord);\r\n+        String Name;\r\n+        String Commandline;\r\n+        String KeyChord;\r\n+    };\r\n+\r\n     [default_interface] runtimeclass NewWindowArgs : IActionArgs\r\n     {\r\n         NewWindowArgs(INewContentArgs contentArgs);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.cpp b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\nindex 4468014c5a8..86a88c36858 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n@@ -882,6 +882,22 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         return results;\r\n     }\r\n \r\n+    void ActionMap::AddSendInputAction(winrt::hstring name, winrt::hstring input, const Control::KeyChord keys)\r\n+    {\r\n+        auto newAction = winrt::make<ActionAndArgs>();\r\n+        newAction.Action(ShortcutAction::SendInput);\r\n+        auto sendInputArgs = winrt::make<SendInputArgs>(input);\r\n+        newAction.Args(sendInputArgs);\r\n+        auto cmd{ make_self<Command>() };\r\n+        if (!name.empty())\r\n+        {\r\n+            cmd->Name(name);\r\n+        }\r\n+        cmd->ActionAndArgs(newAction);\r\n+        cmd->GenerateID();\r\n+        AddAction(*cmd, keys);\r\n+    }\r\n+\r\n     IVector<Model::Command> ActionMap::FilterToSendInput(\r\n         winrt::hstring currentCommandline)\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.h b/src/cascadia/TerminalSettingsModel/ActionMap.h\nindex 2b815214dcb..22428ee5eda 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.h\n@@ -78,6 +78,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         bool RebindKeys(const Control::KeyChord& oldKeys, const Control::KeyChord& newKeys);\r\n         void DeleteKeyBinding(const Control::KeyChord& keys);\r\n         void RegisterKeyBinding(Control::KeyChord keys, Model::ActionAndArgs action);\r\n+        void AddSendInputAction(winrt::hstring name, winrt::hstring input, const Control::KeyChord keys);\r\n \r\n         Windows::Foundation::Collections::IVector<Model::Command> ExpandedCommands();\r\n         void ExpandCommands(const Windows::Foundation::Collections::IVectorView<Model::Profile>& profiles,\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.idl b/src/cascadia/TerminalSettingsModel/ActionMap.idl\nindex 594872f6b70..1849e0680a4 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.idl\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.idl\n@@ -31,5 +31,6 @@ namespace Microsoft.Terminal.Settings.Model\n         void DeleteKeyBinding(Microsoft.Terminal.Control.KeyChord keys);\r\n \r\n         void RegisterKeyBinding(Microsoft.Terminal.Control.KeyChord keys, ActionAndArgs action);\r\n+        void AddSendInputAction(String name, String input, Microsoft.Terminal.Control.KeyChord keys);\r\n     }\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AllShortcutActions.h b/src/cascadia/TerminalSettingsModel/AllShortcutActions.h\nindex 28ba4281e69..86ff9d49c9b 100644\n--- a/src/cascadia/TerminalSettingsModel/AllShortcutActions.h\n+++ b/src/cascadia/TerminalSettingsModel/AllShortcutActions.h\n@@ -75,6 +75,7 @@\n     ON_ALL_ACTIONS(CloseTabsAfter)          \\\r\n     ON_ALL_ACTIONS(TabSearch)               \\\r\n     ON_ALL_ACTIONS(MoveTab)                 \\\r\n+    ON_ALL_ACTIONS(SaveSnippet)             \\\r\n     ON_ALL_ACTIONS(BreakIntoDebugger)       \\\r\n     ON_ALL_ACTIONS(TogglePaneReadOnly)      \\\r\n     ON_ALL_ACTIONS(EnablePaneReadOnly)      \\\r\n@@ -148,6 +149,7 @@\n     ON_ALL_ACTIONS_WITH_ARGS(SplitPane)            \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(SwitchToTab)          \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(ToggleCommandPalette) \\\r\n+    ON_ALL_ACTIONS_WITH_ARGS(SaveSnippet)          \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(FocusPane)            \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(ExportBuffer)         \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(ClearBuffer)          \\\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\nindex 6179099bdf5..b65b7eabcd4 100644\n--- a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n@@ -1,17 +1,17 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n <root>\r\n-  <!-- \r\n-    Microsoft ResX Schema \r\n-    \r\n+  <!--\r\n+    Microsoft ResX Schema\r\n+\r\n     Version 2.0\r\n-    \r\n-    The primary goals of this format is to allow a simple XML format \r\n-    that is mostly human readable. The generation and parsing of the \r\n-    various data types are done through the TypeConverter classes \r\n+\r\n+    The primary goals of this format is to allow a simple XML format\r\n+    that is mostly human readable. The generation and parsing of the\r\n+    various data types are done through the TypeConverter classes\r\n     associated with the data types.\r\n-    \r\n+\r\n     Example:\r\n-    \r\n+\r\n     ... ado.net/XML headers & schema ...\r\n     <resheader name=\"resmimetype\">text/microsoft-resx</resheader>\r\n     <resheader name=\"version\">2.0</resheader>\r\n@@ -26,36 +26,36 @@\n         <value>[base64 mime encoded string representing a byte array form of the .NET Framework object]</value>\r\n         <comment>This is a comment</comment>\r\n     </data>\r\n-                \r\n-    There are any number of \"resheader\" rows that contain simple \r\n+\r\n+    There are any number of \"resheader\" rows that contain simple\r\n     name/value pairs.\r\n-    \r\n-    Each data row contains a name, and value. The row also contains a \r\n-    type or mimetype. Type corresponds to a .NET class that support \r\n-    text/value conversion through the TypeConverter architecture. \r\n-    Classes that don't support this are serialized and stored with the \r\n+\r\n+    Each data row contains a name, and value. The row also contains a\r\n+    type or mimetype. Type corresponds to a .NET class that support\r\n+    text/value conversion through the TypeConverter architecture.\r\n+    Classes that don't support this are serialized and stored with the\r\n     mimetype set.\r\n-    \r\n-    The mimetype is used for serialized objects, and tells the \r\n-    ResXResourceReader how to depersist the object. This is currently not \r\n+\r\n+    The mimetype is used for serialized objects, and tells the\r\n+    ResXResourceReader how to depersist the object. This is currently not\r\n     extensible. For a given mimetype the value must be set accordingly:\r\n-    \r\n-    Note - application/x-microsoft.net.object.binary.base64 is the format \r\n-    that the ResXResourceWriter will generate, however the reader can \r\n+\r\n+    Note - application/x-microsoft.net.object.binary.base64 is the format\r\n+    that the ResXResourceWriter will generate, however the reader can\r\n     read any of the formats listed below.\r\n-    \r\n+\r\n     mimetype: application/x-microsoft.net.object.binary.base64\r\n-    value   : The object must be serialized with \r\n+    value   : The object must be serialized with\r\n             : System.Runtime.Serialization.Formatters.Binary.BinaryFormatter\r\n             : and then encoded with base64 encoding.\r\n-    \r\n+\r\n     mimetype: application/x-microsoft.net.object.soap.base64\r\n-    value   : The object must be serialized with \r\n+    value   : The object must be serialized with\r\n             : System.Runtime.Serialization.Formatters.Soap.SoapFormatter\r\n             : and then encoded with base64 encoding.\r\n \r\n     mimetype: application/x-microsoft.net.object.bytearray.base64\r\n-    value   : The object must be serialized into a byte array \r\n+    value   : The object must be serialized into a byte array\r\n             : using a System.ComponentModel.TypeConverter\r\n             : and then encoded with base64 encoding.\r\n     -->\r\n@@ -727,4 +727,7 @@\n     <value>Open about dialog</value>\r\n     <comment>This will open the \"about\" dialog, to display version info and other documentation</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+  <data name=\"SaveSnippetNamePrefix\" xml:space=\"preserve\">\r\n+    <value>Save Snippet</value>\r\n+  </data>\r\n+</root>\r\ndiff --git a/src/features.xml b/src/features.xml\nindex 47d86790f9d..b87e09bb7c4 100644\n--- a/src/features.xml\n+++ b/src/features.xml\n@@ -155,6 +155,17 @@\n         </alwaysEnabledBrandingTokens>\r\n     </feature>\r\n \r\n+    <feature>\r\n+        <name>Feature_SaveSnippet</name>\r\n+        <description>Save Snippet</description>\r\n+        <id>9971</id>\r\n+        <stage>AlwaysDisabled</stage>\r\n+        <alwaysEnabledBrandingTokens>\r\n+            <brandingToken>Dev</brandingToken>\r\n+            <brandingToken>Canary</brandingToken>\r\n+        </alwaysEnabledBrandingTokens>\r\n+    </feature>\r\n+\r\n     <feature>\r\n         <name>Feature_QuickFix</name>\r\n         <description>Enables the Quick Fix menu</description>\r\n", "test_patch": "", "problem_statement": "Ability to save selected text as a `sendInput` action\nI write some long command. I need to use this frequently (or infrequently), but I don't want to have to remember all the args. I want to be able to pull it up straight from the command palette. So I want to write the command once, select it, and {perform some action}[^1] that lets me save it as a `sendInput` action.\r\n\r\nThe action should\r\n* immediately save it.\r\n* provide a UI[^2] for immediately editing[^3] the name, contents of this action, because `Send \"git log --graph --abbrev-commit --decorate...\" to the Terminal` is not useful to anyone.\r\n\r\nJust doing the immediate save would be a good enough start on this, to the point I'd consider that an easy starter. The UI - that's **H**ard, for reasons listed below. \r\n\r\n\r\n> **Note**\r\n> ## Walkthrough\r\n\r\nAs an initial version of this, it's more than good enough to just save the selected text as an action without the UI. We can iterate on the UI in follow-ups. \r\n\r\n* Probably start with something like [`dev/migrie/fhl/save-command`](https://github.com/microsoft/terminal/compare/6f5b9fb...1cde67ac466e19394eea1eb3a41405513d160a6f)\r\n* We probably want to skip all the `AppCommandlineArgs` stuff for now. That's spicier.\r\n* in `TerminalPage::_HandleSaveTask`, we will want to try and save the current selection as a `sendInput` action, if there's no `commandline` specified. \r\n* AppActionHandlers.cpp has plenty of examples of getting the active control. Should be easy enough to get the selected text from it. \r\n* We'll probably want to generate the name of this action (without a commandline) as \"Save Task...\"\r\n* Over and above: It would be valuable to `Toast` the user with a message \"Saved selected text as a new action\".  `TerminalPage::IdentifyWindow` has an example of a `Toast`\r\n\r\n[^1]: Obviously, easiest way is via cmdpal or keybinding. Also consider a right-click context menu entry, #3337\r\n\r\n[^2]: This has it's own challenges. It can't be a `ContentDialog` (https://github.com/microsoft/microsoft-ui-xaml/issues/3804). It could be nested in a `Flyout`, maybe. Hopefully the dialog thing is limited just to ContentDialogs and not all Flyouts. It probably shouldn't be a `TeachingTip` (#12798). We _could_ roll our own ContentDialog for this of course (#11308).\r\n\r\n[^3]: Might be tricky - we'd have to hand on to an instance of the actual `Command` itself, so we can edit it... in place? and hopefully writing to the settings would then just refresh all the other name->command maps instantly.\n", "hints_text": "/assign\nCan I work on this? : )", "created_at": "2024-01-01 17:53:25", "merge_commit_sha": "d051f7047d2d9f5700f0d8be41fceb5ca78fd1b0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
