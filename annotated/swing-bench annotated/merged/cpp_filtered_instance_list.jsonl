{"repo": "leil-io/saunafs", "instance_id": "leil-io__saunafs-237", "base_commit": "dbef020887689eb381ac597006453f0d132abbfa", "patch": "diff --git a/src/chunkserver/chunkserver-common/plugin_manager.cc b/src/chunkserver/chunkserver-common/plugin_manager.cc\nindex 30fa071a6..69cf5568a 100644\n--- a/src/chunkserver/chunkserver-common/plugin_manager.cc\n+++ b/src/chunkserver/chunkserver-common/plugin_manager.cc\n@@ -19,19 +19,27 @@\n #include \"common/platform.h\"\n \n #include \"chunkserver-common/plugin_manager.h\"\n+#include <boost/filesystem/exception.hpp>\n \n #include \"chunkserver-common/disk_plugin.h\"\n #include \"slogger/slogger.h\"\n \n bool PluginManager::loadPlugins(const std::string &directory) {\n-\tif (!boost::filesystem::is_directory(directory) ||\n-\t    boost::filesystem::is_empty(directory)) {\n-\t\t// It is normal to not have any plugins in many scenarios\n-\t\tsafs_pretty_syslog(\n-\t\t    LOG_NOTICE,\n-\t\t    \"PluginManager: Directory %s does not exist or is empty\",\n-\t\t    directory.c_str());\n-\t\treturn false;\n+\ttry {\n+\t\tif (!boost::filesystem::is_directory(directory) ||\n+\t\t    boost::filesystem::is_empty(directory)) {\n+\t\t\t// It is normal to not have any plugins in many scenarios\n+\t\t\tsafs_pretty_syslog(\n+\t\t\t    LOG_NOTICE,\n+\t\t\t    \"PluginManager: Directory %s does not exist or is empty\",\n+\t\t\t    directory.c_str());\n+\t\t\treturn false;\n+\t\t}\n+\t} catch (boost::filesystem::filesystem_error &e) {\n+\t\t\tsafs::log_info(\n+\t\t\t    \"PluginManager: Directory {} cannot not be checked: {}\",\n+\t\t\t    directory.c_str(), e.what());\n+\t\t\treturn false;\n \t}\n \n \tboost::filesystem::path dir(directory);\n", "test_patch": "", "problem_statement": "Unhandled permission denied exception in plugin-manager.cc\nWhen the chunkserver plugin is not installed (as is the default in CMake right now), it will try to load the plugin from the build directory, which may not be available (could be either permissions or it could not exist, very common when transitioning from a build environment), this causes a exception which is handled by initialize, which then causes the program exits. This is undesired as chunkserver can work without a plugin.\r\n\r\nReproduce:\r\n\r\n1. Build and install from directory where `saunafs` (or whatever user is running chunkserver) cannot access the build files.\r\n2. Run chunkserver\r\n\r\nPotential fix:\r\n\r\n```diff\r\ndiff --git a/src/chunkserver/chunkserver-common/plugin_manager.cc b/src/chunkserver/chunkserver-common/plugin_manager.cc\r\nindex 30fa071a..69cf5568 100644\r\n--- a/src/chunkserver/chunkserver-common/plugin_manager.cc\r\n+++ b/src/chunkserver/chunkserver-common/plugin_manager.cc\r\n@@ -19,19 +19,27 @@\r\n #include \"common/platform.h\"\r\n \r\n #include \"chunkserver-common/plugin_manager.h\"\r\n+#include <boost/filesystem/exception.hpp>\r\n \r\n #include \"chunkserver-common/disk_plugin.h\"\r\n #include \"slogger/slogger.h\"\r\n \r\n bool PluginManager::loadPlugins(const std::string &directory) {\r\n-\tif (!boost::filesystem::is_directory(directory) ||\r\n-\t    boost::filesystem::is_empty(directory)) {\r\n-\t\t// It is normal to not have any plugins in many scenarios\r\n-\t\tsafs_pretty_syslog(\r\n-\t\t    LOG_NOTICE,\r\n-\t\t    \"PluginManager: Directory %s does not exist or is empty\",\r\n-\t\t    directory.c_str());\r\n-\t\treturn false;\r\n+\ttry {\r\n+\t\tif (!boost::filesystem::is_directory(directory) ||\r\n+\t\t    boost::filesystem::is_empty(directory)) {\r\n+\t\t\t// It is normal to not have any plugins in many scenarios\r\n+\t\t\tsafs_pretty_syslog(\r\n+\t\t\t    LOG_NOTICE,\r\n+\t\t\t    \"PluginManager: Directory %s does not exist or is empty\",\r\n+\t\t\t    directory.c_str());\r\n+\t\t\treturn false;\r\n+\t\t}\r\n+\t} catch (boost::filesystem::filesystem_error &e) {\r\n+\t\t\tsafs::log_info(\r\n+\t\t\t    \"PluginManager: Directory {} cannot not be checked: {}\",\r\n+\t\t\t    directory.c_str(), e.what());\r\n+\t\t\treturn false;\r\n \t}\r\n \r\n \tboost::filesystem::path dir(directory);\r\n```\r\n\r\nOther idea is to include the chunkserver plugin by default when installing\n", "hints_text": "Thoughts @lgsilva3087?", "created_at": "2024-11-04 13:27:55", "merge_commit_sha": "3350e64d8f66efbe60ab96201c6a9351f7db6b4e", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["Run-Unit-Tests-and-Ganesha", ".github/workflows/run-unit-and-ganesha-tests.yml"]]}
{"repo": "doctest/doctest", "instance_id": "doctest__doctest-881", "base_commit": "35a540d01395117c733125aa7d1781b37b40d077", "patch": "diff --git a/examples/all_features/CMakeLists.txt b/examples/all_features/CMakeLists.txt\nindex 19436c549..7b6277007 100644\n--- a/examples/all_features/CMakeLists.txt\n+++ b/examples/all_features/CMakeLists.txt\n@@ -9,6 +9,7 @@ set(files_with_output\n     alternative_macros.cpp\n     assertion_macros.cpp\n     stringification.cpp\n+    check_doctest_string.cpp\n     double_stringification.cpp\n     reporters_and_listeners.cpp\n     subcases.cpp\n", "test_patch": "diff --git a/doctest/doctest.h b/doctest/doctest.h\nindex 5c754cde0..7df38834d 100644\n--- a/doctest/doctest.h\n+++ b/doctest/doctest.h\n@@ -3751,7 +3751,7 @@ String::size_type String::capacity() const {\n }\n \n String String::substr(size_type pos, size_type cnt) && {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     char* cptr = c_str();\n     memmove(cptr, cptr + pos, cnt);\n     setSize(cnt);\n@@ -3759,7 +3759,7 @@ String String::substr(size_type pos, size_type cnt) && {\n }\n \n String String::substr(size_type pos, size_type cnt) const & {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     return String{ c_str() + pos, cnt };\n }\n \ndiff --git a/doctest/parts/doctest.cpp b/doctest/parts/doctest.cpp\nindex 5a2dd4599..19ba25a4f 100644\n--- a/doctest/parts/doctest.cpp\n+++ b/doctest/parts/doctest.cpp\n@@ -661,7 +661,7 @@ String::size_type String::capacity() const {\n }\n \n String String::substr(size_type pos, size_type cnt) && {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     char* cptr = c_str();\n     memmove(cptr, cptr + pos, cnt);\n     setSize(cnt);\n@@ -669,7 +669,7 @@ String String::substr(size_type pos, size_type cnt) && {\n }\n \n String String::substr(size_type pos, size_type cnt) const & {\n-    cnt = std::min(cnt, size() - 1 - pos);\n+    cnt = std::min(cnt, size() - pos);\n     return String{ c_str() + pos, cnt };\n }\n \ndiff --git a/examples/all_features/check_doctest_string.cpp b/examples/all_features/check_doctest_string.cpp\nnew file mode 100644\nindex 000000000..2fce03506\n--- /dev/null\n+++ b/examples/all_features/check_doctest_string.cpp\n@@ -0,0 +1,10 @@\n+#include <doctest/doctest.h>\n+\n+TEST_SUITE(\"doctest unit tests\") {\n+    TEST_CASE(\"doctest::String::substr()\") {\n+        const doctest::String abcde = \"abcde\";\n+        CHECK(abcde.substr(0, 3) == \"abc\");\n+        CHECK(abcde.substr(2, 3) == \"cde\");\n+        CHECK(abcde.substr(0, 5) == \"abcde\");\n+    }\n+}\n\\ No newline at end of file\ndiff --git a/examples/all_features/test_output/check_doctest_string.cpp.txt b/examples/all_features/test_output/check_doctest_string.cpp.txt\nnew file mode 100644\nindex 000000000..75be56a8f\n--- /dev/null\n+++ b/examples/all_features/test_output/check_doctest_string.cpp.txt\n@@ -0,0 +1,6 @@\n+[doctest] run with \"--help\" for options\n+===============================================================================\n+[doctest] test cases: 1 | 1 passed | 0 failed |\n+[doctest] assertions: 3 | 3 passed | 0 failed |\n+[doctest] Status: SUCCESS!\n+Program code.\ndiff --git a/examples/all_features/test_output/check_doctest_string.cpp_junit.txt b/examples/all_features/test_output/check_doctest_string.cpp_junit.txt\nnew file mode 100644\nindex 000000000..eb141a57b\n--- /dev/null\n+++ b/examples/all_features/test_output/check_doctest_string.cpp_junit.txt\n@@ -0,0 +1,7 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<testsuites>\n+  <testsuite name=\"all_features\" errors=\"0\" failures=\"0\" tests=\"3\">\n+    <testcase classname=\"check_doctest_string.cpp\" name=\"doctest::String::substr()\" status=\"run\"/>\n+  </testsuite>\n+</testsuites>\n+Program code.\ndiff --git a/examples/all_features/test_output/check_doctest_string.cpp_xml.txt b/examples/all_features/test_output/check_doctest_string.cpp_xml.txt\nnew file mode 100644\nindex 000000000..12c39533d\n--- /dev/null\n+++ b/examples/all_features/test_output/check_doctest_string.cpp_xml.txt\n@@ -0,0 +1,12 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<doctest binary=\"all_features\">\n+  <Options order_by=\"file\" rand_seed=\"324\" first=\"0\" last=\"4294967295\" abort_after=\"0\" subcase_filter_levels=\"2147483647\" case_sensitive=\"false\" no_throw=\"false\" no_skip=\"false\"/>\n+  <TestSuite name=\"doctest unit tests\">\n+    <TestCase name=\"doctest::String::substr()\" filename=\"check_doctest_string.cpp\" line=\"0\">\n+      <OverallResultsAsserts successes=\"3\" failures=\"0\" test_case_success=\"true\"/>\n+    </TestCase>\n+  </TestSuite>\n+  <OverallResultsAsserts successes=\"3\" failures=\"0\"/>\n+  <OverallResultsTestCases successes=\"1\" failures=\"0\"/>\n+</doctest>\n+Program code.\ndiff --git a/examples/all_features/test_output/filter_2.txt b/examples/all_features/test_output/filter_2.txt\nindex 7d43c001c..cc3557f98 100644\n--- a/examples/all_features/test_output/filter_2.txt\n+++ b/examples/all_features/test_output/filter_2.txt\n@@ -1,6 +1,6 @@\n [doctest] run with \"--help\" for options\n ===============================================================================\n-[doctest] test cases: 0 | 0 passed | 0 failed | 108 skipped\n+[doctest] test cases: 0 | 0 passed | 0 failed | 109 skipped\n [doctest] assertions: 0 | 0 passed | 0 failed |\n [doctest] Status: SUCCESS!\n Program code.\ndiff --git a/examples/all_features/test_output/filter_2_xml.txt b/examples/all_features/test_output/filter_2_xml.txt\nindex f1c124dac..7905baa89 100644\n--- a/examples/all_features/test_output/filter_2_xml.txt\n+++ b/examples/all_features/test_output/filter_2_xml.txt\n@@ -42,6 +42,9 @@\n     <TestCase name=\"default construction&lt;signed char>\" filename=\"templated_test_cases.cpp\" line=\"0\" skipped=\"true\"/>\n     <TestCase name=\"default construction&lt;unsigned char>\" filename=\"templated_test_cases.cpp\" line=\"0\" skipped=\"true\"/>\n   </TestSuite>\n+  <TestSuite name=\"doctest unit tests\">\n+    <TestCase name=\"doctest::String::substr()\" filename=\"check_doctest_string.cpp\" line=\"0\" skipped=\"true\"/>\n+  </TestSuite>\n   <TestSuite name=\"test suite with a description\">\n     <TestCase name=\"doesn't fail but it should have\" filename=\"test_cases_and_suites.cpp\" line=\"0\" description=\"regarding failures\" should_fail=\"true\" skipped=\"true\"/>\n     <TestCase name=\"doesn't fail which is fine\" filename=\"test_cases_and_suites.cpp\" line=\"0\" description=\"regarding failures\" may_fail=\"true\" skipped=\"true\"/>\n@@ -152,6 +155,6 @@\n     <TestCase name=\"without a funny name:\" filename=\"subcases.cpp\" line=\"0\" skipped=\"true\"/>\n   </TestSuite>\n   <OverallResultsAsserts successes=\"0\" failures=\"0\"/>\n-  <OverallResultsTestCases successes=\"0\" failures=\"0\" skipped=\"108\"/>\n+  <OverallResultsTestCases successes=\"0\" failures=\"0\" skipped=\"109\"/>\n </doctest>\n Program code.\ndiff --git a/examples/all_features/test_output/no_multi_lane_atomics.txt b/examples/all_features/test_output/no_multi_lane_atomics.txt\nindex 4469b9154..15c128634 100644\n--- a/examples/all_features/test_output/no_multi_lane_atomics.txt\n+++ b/examples/all_features/test_output/no_multi_lane_atomics.txt\n@@ -925,7 +925,7 @@ TEST CASE:  without a funny name:\n subcases.cpp(0): MESSAGE: Nooo\n \n ===============================================================================\n-[doctest] test cases:  86 |  35 passed |  51 failed |\n-[doctest] assertions: 235 | 115 passed | 120 failed |\n+[doctest] test cases:  87 |  36 passed |  51 failed |\n+[doctest] assertions: 238 | 118 passed | 120 failed |\n [doctest] Status: FAILURE!\n Program code.\ndiff --git a/examples/all_features/test_output/no_multithreading.txt b/examples/all_features/test_output/no_multithreading.txt\nindex 4469b9154..15c128634 100644\n--- a/examples/all_features/test_output/no_multithreading.txt\n+++ b/examples/all_features/test_output/no_multithreading.txt\n@@ -925,7 +925,7 @@ TEST CASE:  without a funny name:\n subcases.cpp(0): MESSAGE: Nooo\n \n ===============================================================================\n-[doctest] test cases:  86 |  35 passed |  51 failed |\n-[doctest] assertions: 235 | 115 passed | 120 failed |\n+[doctest] test cases:  87 |  36 passed |  51 failed |\n+[doctest] assertions: 238 | 118 passed | 120 failed |\n [doctest] Status: FAILURE!\n Program code.\ndiff --git a/examples/all_features/test_output/std_headers.txt b/examples/all_features/test_output/std_headers.txt\nindex 4469b9154..15c128634 100644\n--- a/examples/all_features/test_output/std_headers.txt\n+++ b/examples/all_features/test_output/std_headers.txt\n@@ -925,7 +925,7 @@ TEST CASE:  without a funny name:\n subcases.cpp(0): MESSAGE: Nooo\n \n ===============================================================================\n-[doctest] test cases:  86 |  35 passed |  51 failed |\n-[doctest] assertions: 235 | 115 passed | 120 failed |\n+[doctest] test cases:  87 |  36 passed |  51 failed |\n+[doctest] assertions: 238 | 118 passed | 120 failed |\n [doctest] Status: FAILURE!\n Program code.\n", "problem_statement": "bug: doctest::String::substr() off by one at the end\n## Description\r\n\r\n`doctest::String::substr()` cuts short the last character, when extracting from the end of the `String`.\r\n\r\n\r\n### Steps to reproduce\r\n\r\n```\r\n#include <doctest/doctest.h>\r\n\r\nTEST_SUITE(\"doctest unit tests\") {\r\n    TEST_CASE(\"doctest::String::substr()\") {\r\n        const doctest::String abcde = \"abcde\";\r\n        CHECK(abcde.substr(0, 3) == \"abc\");\r\n        CHECK(abcde.substr(2, 3) == \"cde\");\r\n        CHECK(abcde.substr(0, 5) == \"abcde\");\r\n    }\r\n}\r\n```\r\n\r\n```\r\n===============================================================================\r\ncheck_doctest_string.cpp(0):\r\nTEST SUITE: doctest unit tests\r\nTEST CASE:  doctest::String::substr()\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(2, 3) == \"cde\" ) is NOT correct!\r\n  values: CHECK( cd == cde )\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(0, 5) == \"abcde\" ) is NOT correct!\r\n  values: CHECK( abcd == abcde )\r\n\r\n===============================================================================\r\n```\r\n\r\n\r\n### Extra information\r\n\r\n* doctest version: **v2.4.9** ... v2.4.11\r\n* Operating System: **22.04.1-Ubuntu**\r\n* Compiler+version: **GCC 12.3.0 x86_64**\r\n\n", "hints_text": "", "created_at": "2024-11-27 11:51:15", "merge_commit_sha": "4a97a18d349053eeb706be3311abbb71343c1280", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["ci (ubuntu-latest, clang, 14)", ".github/workflows/main.yml"], ["sanitizers (integer)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 5.0)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Release)", ".github/workflows/main.yml"], ["ci (macOS-latest, gcc, 11)", ".github/workflows/main.yml"], ["ci-msvs (v143, Win32, Release)", ".github/workflows/main.yml"], ["sanitizers (thread)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 4.8)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, cl)", ".github/workflows/main.yml"], ["clang-tidy", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 12)", ".github/workflows/main.yml"], ["ci-msvs (v142, Win32, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 6.0)", ".github/workflows/main.yml"], ["sanitizers (address)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 9)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 8)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 11)", ".github/workflows/main.yml"], ["sanitizers (undefined)", ".github/workflows/main.yml"], ["ci-msvs (v141, x64, Release)", ".github/workflows/main.yml"], ["sanitizers (safe-stack)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-latest, gcc, 9)", ".github/workflows/main.yml"], ["ci-msvs (v140, Win32, Debug)", ".github/workflows/main.yml"], ["ci (macOS-latest, xcode, 13.2.1)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Release)", ".github/workflows/main.yml"], ["ci-msvs (v143, x64, Release)", ".github/workflows/main.yml"], ["ci-min-gw (Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 3.7)", ".github/workflows/main.yml"], ["sanitizers (implicit-conversion)", ".github/workflows/main.yml"], ["ci-msvs (v141, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 7)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, clang)", ".github/workflows/main.yml"]]}
{"repo": "doctest/doctest", "instance_id": "doctest__doctest-878", "base_commit": "35a540d01395117c733125aa7d1781b37b40d077", "patch": "diff --git a/examples/all_features/CMakeLists.txt b/examples/all_features/CMakeLists.txt\nindex 19436c549..47ee019b0 100644\n--- a/examples/all_features/CMakeLists.txt\n+++ b/examples/all_features/CMakeLists.txt\n@@ -63,7 +63,7 @@ if(NOT MINGW AND NOT DEFINED DOCTEST_THREAD_LOCAL)\n     doctest_add_test(NO_OUTPUT NAME concurrency.cpp ${common_args} -sf=*concurrency.cpp -d) # duration: there is no output anyway\n endif()\n \n-doctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp.cpp )\n+doctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp )\n doctest_add_test(NO_OUTPUT NAME bitfields.cpp ${common_args} -sf=*bitfields.cpp )\n doctest_add_test(NO_OUTPUT NAME namespace1.cpp ${common_args} -sf=*namespace1.cpp )\n doctest_add_test(NO_OUTPUT NAME namespace2.cpp ${common_args} -sf=*namespace2.cpp )\n", "test_patch": "", "problem_statement": "Typo in examples/all_features/CMakeLists.txt\n## Description\r\n\r\nThere is probably a copy&paste error in:\r\nhttps://github.com/doctest/doctest/blob/35a540d01395117c733125aa7d1781b37b40d077/examples/all_features/CMakeLists.txt#L66\r\n```\r\ndoctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp.cpp )\r\n                                                                                                         ^^^^\r\n```\r\nSee the double `.cpp`?\n", "hints_text": "", "created_at": "2024-11-27 10:41:45", "merge_commit_sha": "90f4e3144b25008b2942d612106900d6e1db57e1", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["ci (ubuntu-latest, clang, 14)", ".github/workflows/main.yml"], ["sanitizers (integer)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 5.0)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Release)", ".github/workflows/main.yml"], ["ci (macOS-latest, gcc, 11)", ".github/workflows/main.yml"], ["ci-msvs (v143, Win32, Release)", ".github/workflows/main.yml"], ["sanitizers (thread)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 4.8)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, cl)", ".github/workflows/main.yml"], ["clang-tidy", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 12)", ".github/workflows/main.yml"], ["ci-msvs (v142, Win32, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 6.0)", ".github/workflows/main.yml"], ["sanitizers (address)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 9)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 8)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 11)", ".github/workflows/main.yml"], ["sanitizers (undefined)", ".github/workflows/main.yml"], ["ci-msvs (v141, x64, Release)", ".github/workflows/main.yml"], ["sanitizers (safe-stack)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-latest, gcc, 9)", ".github/workflows/main.yml"], ["ci-msvs (v140, Win32, Debug)", ".github/workflows/main.yml"], ["ci (macOS-latest, xcode, 13.2.1)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Release)", ".github/workflows/main.yml"], ["ci-msvs (v143, x64, Release)", ".github/workflows/main.yml"], ["ci-min-gw (Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 3.7)", ".github/workflows/main.yml"], ["sanitizers (implicit-conversion)", ".github/workflows/main.yml"], ["ci-msvs (v141, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 7)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, clang)", ".github/workflows/main.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-882", "base_commit": "57123951b57eb38ab219eaa188ed73cc917f728f", "patch": "diff --git a/README.md b/README.md\nindex 9ea6ed923..985d14eff 100644\n--- a/README.md\n+++ b/README.md\n@@ -253,7 +253,7 @@ For optimal compression results, the values must be quantized to small integers.\n For single-precision floating-point data, it's recommended to use `meshopt_quantizeFloat` to remove entropy from the lower bits of the mantissa. Due to current limitations of the codec, the bit count needs to be 15 (23-8) for good results (7 can be used for more extreme compression).\n For normal or tangent vectors, using octahedral encoding is recommended over three components as it reduces redundancy. Similarly to other quantized values, consider using 10-12 bits per component instead of 16.\n \n-When data is bit packed, using v1 vertex codec (via `meshopt_encodeVertexVersion(1)`) and specifying compression level 3 (`meshopt_encodeVertexBufferLevel`) can improve the compression further by redistributing bits between components. Note that v1 vertex codec is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n+When data is bit packed, using v1 vertex codec and specifying compression level 3 (`meshopt_encodeVertexBufferLevel` with level 3 and version 1) can improve the compression further by redistributing bits between components. Note that v1 vertex codec (`meshopt_encodeVertexVersion(1)`) is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n \n To further leverage the inherent structure of some data, the preparation stage can use filters that encode and decode the data in a lossy manner. This is similar to quantization but can be used without having to change the shader code. After decoding, the filter transformation needs to be reversed. For native game engine pipelines, it is usually more optimal to carefully prequantize and pretransform the vertex data, but sometimes (for example when serializing data in glTF format) this is not a practical option and filters are more practical. This library provides three filters:\n \n@@ -618,7 +618,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_buildMeshletsFlex`\n - `meshopt_buildMeshletsSplit`\n - `meshopt_computeSphereBounds`*\n-- `meshopt_encodeVertexBufferLevel`*\n+- `meshopt_encodeVertexBufferLevel`\n - `meshopt_generateProvokingIndexBuffer`*\n - `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex a98c69461..a06a54f04 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -893,7 +893,7 @@ void encodeVertex(const Mesh& mesh, const char* pvn, int level = 2)\n \tdouble start = timestamp();\n \n \tstd::vector<unsigned char> vbuf(meshopt_encodeVertexBufferBound(mesh.vertices.size(), sizeof(PV)));\n-\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level));\n+\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level, -1));\n \n \tdouble middle = timestamp();\n \ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 84ba1a7ab..ef6c4a93f 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -304,8 +304,9 @@ MESHOPTIMIZER_API size_t meshopt_encodeVertexBufferBound(size_t vertex_count, si\n  * The default compression level implied by meshopt_encodeVertexBuffer is 2.\n  *\n  * level should be in the range [0, 3] with 0 being the fastest and 3 being the slowest and producing the best compression ratio.\n+ * version should be -1 to use the default version (specified via meshopt_encodeVertexVersion), or 0/1 to override the version; per above, level won't take effect if version is 0.\n  */\n-MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level);\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version);\n \n /**\n  * Set vertex encoder format version\ndiff --git a/src/vertexcodec.cpp b/src/vertexcodec.cpp\nindex 53cf9d753..847589b3d 100644\n--- a/src/vertexcodec.cpp\n+++ b/src/vertexcodec.cpp\n@@ -1643,13 +1643,16 @@ static unsigned int cpuid = getCpuFeatures();\n \n } // namespace meshopt\n \n-size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level)\n+size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version)\n {\n \tusing namespace meshopt;\n \n \tassert(vertex_size > 0 && vertex_size <= 256);\n \tassert(vertex_size % 4 == 0);\n \tassert(level >= 0 && level <= 9); // only a subset of this range is used right now\n+\tassert(version < 0 || unsigned(version) <= kDecodeVertexVersion);\n+\n+\tversion = version < 0 ? gEncodeVertexVersion : version;\n \n #if TRACE\n \tmemset(vertexstats, 0, sizeof(vertexstats));\n@@ -1663,8 +1666,6 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \tif (size_t(data_end - data) < 1)\n \t\treturn 0;\n \n-\tint version = gEncodeVertexVersion;\n-\n \t*data++ = (unsigned char)(kVertexHeader | version);\n \n \tunsigned char first_vertex[256] = {};\n@@ -1777,7 +1778,7 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \n size_t meshopt_encodeVertexBuffer(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size)\n {\n-\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel);\n+\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel, meshopt::gEncodeVertexVersion);\n }\n \n size_t meshopt_encodeVertexBufferBound(size_t vertex_count, size_t vertex_size)\ndiff --git a/tools/codecfuzz.cpp b/tools/codecfuzz.cpp\nindex 89bce2409..4992857e3 100644\n--- a/tools/codecfuzz.cpp\n+++ b/tools/codecfuzz.cpp\n@@ -26,12 +26,12 @@ void fuzzRoundtrip(const uint8_t* data, size_t size, size_t stride, int level)\n \tvoid* decoded = malloc(count * stride);\n \tassert(encoded && decoded);\n \n-\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level);\n+\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level, -1);\n \tassert(res > 0 && res <= bound);\n \n \t// encode again at the boundary to check for memory safety\n \t// this should produce the same output because encoder is deterministic\n-\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level);\n+\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level, -1);\n \tassert(rese == res);\n \n \tint rc = meshopt_decodeVertexBuffer(decoded, count, stride, static_cast<unsigned char*>(encoded) + bound - res, res);\n", "test_patch": "diff --git a/demo/tests.cpp b/demo/tests.cpp\nindex 1636756ca..8e9e4a9c1 100644\n--- a/demo/tests.cpp\n+++ b/demo/tests.cpp\n@@ -616,7 +616,7 @@ static void decodeVertexDeltas()\n \t}\n \n \tstd::vector<unsigned char> buffer(meshopt_encodeVertexBufferBound(16, 8));\n-\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 8, 2));\n+\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 8, 2, -1));\n \n \tunsigned short decoded[16 * 4];\n \tassert(meshopt_decodeVertexBuffer(decoded, 16, 8, &buffer[0], buffer.size()) == 0);\n@@ -637,7 +637,7 @@ static void decodeVertexBitXor()\n \t}\n \n \tstd::vector<unsigned char> buffer(meshopt_encodeVertexBufferBound(16, 16));\n-\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 16, 3));\n+\tbuffer.resize(meshopt_encodeVertexBufferLevel(&buffer[0], buffer.size(), data, 16, 16, 3, -1));\n \n \tunsigned int decoded[16 * 4];\n \tassert(meshopt_decodeVertexBuffer(decoded, 16, 16, &buffer[0], buffer.size()) == 0);\ndiff --git a/tools/codectest.cpp b/tools/codectest.cpp\nindex 28203ecd4..04ba873b1 100644\n--- a/tools/codectest.cpp\n+++ b/tools/codectest.cpp\n@@ -91,7 +91,7 @@ void testFile(FILE* file, size_t count, size_t stride, int level, Stats* stats =\n \n \tstd::vector<unsigned char> output(meshopt_encodeVertexBufferBound(count, stride));\n \tmeshopt_encodeVertexVersion(1);\n-\toutput.resize(meshopt_encodeVertexBufferLevel(output.data(), output.size(), decoded.data(), count, stride, level));\n+\toutput.resize(meshopt_encodeVertexBufferLevel(output.data(), output.size(), decoded.data(), count, stride, level, -1));\n \n \tprintf(\" raw %zu KB\\t\", decoded.size() / 1024);\n \tprintf(\" v0 %.3f\", double(input.size()) / double(decoded.size()));\n", "problem_statement": "Pass vertex and index versions as arguments instead of having them as globals.\nHaving gEncodeVertexVersion and gEncodeIndexVersion as globals makes the meshoptimizer library difficult to use correctly in a multithreaded program, when some threads may be want to write with different versions.\n", "hints_text": "Could you elaborate on why you need to encode multiple versions in different threads? The assumption so far has been that the versions are either never changed or changed at the start of the program.\n\n(as to \"why not just add this\", due to binary compatibility requirements this can't be added as an argument to the existing `encode*Buffer` functions. It may be possible to expand `encodeVertexBufferLevel` with an extra version argument as it's still experimental, and add `encodeIndexBufferLevel` counterpart, and/or rename them somehow, but I was hoping to not have to do that)\nHi,\nIt's for backwards compatibility - for older clients connecting to my metaverse server, they will not have the code to decode vertex version 1.  So meshes need to be encoded for them with version 0.   But for newer clients that support version 1, I want to be able to encode meshes with version 1.\nHow long is that window of compatibility? As in is there a point where you will know for sure that all clients support version 1 and would be able to use it unconditionally?\nAnd, just to confirm, this is specifically for the vertex decoder?\n\nI understand the use case but want to make sure it's solved with least amount of new APIs that would have to be kept long term...\nThere's no specific window, just long enough that no one is likely to be using the old client any more.  maybe a year or so.\nAnd yeah it's just for the vertex version, I think I introduced meshopt encoded meshes after the index version was 1.\n\nEDIT: unlike a lot of computer games, I don't force clients to update to a specific version.\nAlright, thanks. I think it would make the most sense to preserve the global versioning by default but provide a way to override that for vertex encoder (index encoder currently does not need it in practice, and similar functions could be added there in the future if there's ever a v2 index codec). The existing meshopt_encodeVertexBufferLevel function could be changed to something like\n\n```c++\nMESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(\n    unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size,\n    int level, int version);\n```\n\n... with `version = -1` used to select the currently active global version, but values 0/1 (and other values in the future if there's ever a vertex codec v2) used to override that. `meshopt_encodeVertexBufferLevel` name is a little less clear with that change, maybe it should be changed (`-Ex`?), not sure - I'll think about alternatives. All of this is currently ok to change because `meshopt_encodeVertexBufferLevel` is experimental (and as such is subject to change). So in your case you'd need to switch to this function to be able to simultaneously encode multiple streams at different versions from multiple threads.", "created_at": "2025-04-30 00:49:56", "merge_commit_sha": "650bf41c6da93238ba30b3c4293f0599d0943d2f", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"], ["gltfpack", ".github/workflows/build.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-862", "base_commit": "ecebbd86269e283a9d8c7da20a22d9009b36310c", "patch": "diff --git a/README.md b/README.md\nindex 7cd858e43..d9d0488a9 100644\n--- a/README.md\n+++ b/README.md\n@@ -56,7 +56,8 @@ First, generate a remap table from your existing vertex (and, optionally, index)\n size_t index_count = face_count * 3;\n size_t unindexed_vertex_count = face_count * 3;\n std::vector<unsigned int> remap(unindexed_vertex_count); // temporary remap table\n-size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count, &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n+size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n ```\n \n Note that in this case we only have an unindexed vertex buffer; when input mesh has an index buffer, it will need to be passed to `meshopt_generateVertexRemap` instead of `NULL`, along with the correct source vertex count. In either case, the remap table is generated based on binary equivalence of the input vertices, so the resulting mesh will render the same way. Binary equivalence considers all input bytes, including padding which should be zero-initialized if the vertex structure has gaps.\n@@ -70,7 +71,18 @@ meshopt_remapVertexBuffer(vertices, &unindexed_vertices[0], unindexed_vertex_cou\n \n You can then further optimize the resulting buffers by calling the other functions on them in-place.\n \n-`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\n+`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use `meshopt_generateVertexRemapCustom` algorithm that allows comparing individual attributes with tolerance by providing a custom comparison function:\n+\n+```c++\n+size_t vertex_count = meshopt_generateVertexRemapCustom(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0].px, unindexed_vertex_count, sizeof(Vertex),\n+    [&](unsigned int lhs, unsigned int rhs) -> bool {\n+        const Vertex& lv = unindexed_vertices[lhs];\n+        const Vertex& rv = unindexed_vertices[rhs];\n+\n+        return fabsf(lv.tx - rv.tx) < 1e-3f && fabsf(lv.ty - rv.ty) < 1e-3f;\n+    });\n+```\n \n ## Vertex cache optimization\n \n@@ -573,6 +585,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_computeSphereBounds`*\n - `meshopt_encodeVertexBufferLevel`*\n - `meshopt_generateProvokingIndexBuffer`*\n+- `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\n - `meshopt_simplifySloppy`\n - `meshopt_spatialSortTriangles`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex 1e3e9ea2e..012a8524d 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -1287,6 +1287,44 @@ void provoking(const Mesh& mesh)\n \t    int(mesh.indices.size() / 3), int(pcount), double(pcount) / double(bestv) * 100.0 - 100.0, (end - start) * 1000);\n }\n \n+static int reindexCompare(void* context, unsigned int lhs, unsigned int rhs)\n+{\n+\tconst Vertex* vertices = static_cast<Vertex*>(context);\n+\tconst Vertex& lv = vertices[lhs];\n+\tconst Vertex& rv = vertices[rhs];\n+\n+\tfloat ln = lv.nx * lv.nx + lv.ny * lv.ny + lv.nz * lv.nz;\n+\tfloat rn = rv.nx * rv.nx + rv.ny * rv.ny + rv.nz * rv.nz;\n+\n+\t// 1/1024px UV tolerance, 3 degree normal tolerance\n+\treturn fabsf(lv.tx - rv.tx) < 1e-3f &&\n+\t       fabsf(lv.ty - rv.ty) < 1e-3f &&\n+\t       (lv.nx * rv.nx + lv.ny * rv.ny + lv.nz * rv.nz >= 0.9986f * sqrtf(ln * rn));\n+}\n+\n+void reindexFuzzy(const Mesh& mesh)\n+{\n+\tstd::vector<PackedVertex> pv(mesh.vertices.size());\n+\tpackMesh(pv, mesh.vertices);\n+\n+\tstd::vector<unsigned int> remap(mesh.vertices.size());\n+\n+\tdouble start = timestamp();\n+\n+\tsize_t up = meshopt_generateVertexRemap(&remap[0], &mesh.indices[0], mesh.indices.size(), &pv[0], mesh.vertices.size(), sizeof(PackedVertex));\n+\n+\tdouble middle = timestamp();\n+\n+\tsize_t uf = meshopt_generateVertexRemapCustom(&remap[0], &mesh.indices[0], mesh.indices.size(), &mesh.vertices[0].px, mesh.vertices.size(), sizeof(Vertex), reindexCompare, const_cast<Vertex*>(&mesh.vertices[0]));\n+\n+\tdouble end = timestamp();\n+\n+\tprintf(\"ReindexQ : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(up), (middle - start) * 1000);\n+\tprintf(\"ReindexF : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(uf), (end - middle) * 1000);\n+}\n+\n void nanite(const std::vector<Vertex>& vertices, const std::vector<unsigned int>& indices); // nanite.cpp\n \n bool loadMesh(Mesh& mesh, const char* path)\n@@ -1468,6 +1506,8 @@ void process(const char* path)\n \tspatialSort(mesh);\n \tspatialSortTriangles(mesh);\n \n+\treindexFuzzy(mesh);\n+\n \tif (path)\n \t\tprocessDeinterleaved(path);\n }\ndiff --git a/gltf/mesh.cpp b/gltf/mesh.cpp\nindex d5c744a59..bf231e32a 100644\n--- a/gltf/mesh.cpp\n+++ b/gltf/mesh.cpp\n@@ -66,6 +66,15 @@ static void transformNormal(float* res, const float* ptr, const float* transform\n \tres[2] = z * s;\n }\n \n+static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n+{\n+\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n+\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n+\t\t\treturn &mesh.streams[i];\n+\n+\treturn NULL;\n+}\n+\n // assumes mesh & target are structurally identical\n static void transformMesh(Mesh& target, const Mesh& mesh, const cgltf_node* node)\n {\n@@ -722,15 +731,6 @@ static void filterTriangles(Mesh& mesh)\n \tmesh.indices.resize(write);\n }\n \n-static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n-{\n-\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n-\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n-\t\t\treturn &mesh.streams[i];\n-\n-\treturn NULL;\n-}\n-\n static void simplifyAttributes(std::vector<float>& attrs, float* attrw, size_t stride, Mesh& mesh)\n {\n \tassert(stride >= 6); // normal + color\ndiff --git a/src/indexgenerator.cpp b/src/indexgenerator.cpp\nindex 0d53020e3..5f36d2463 100644\n--- a/src/indexgenerator.cpp\n+++ b/src/indexgenerator.cpp\n@@ -5,6 +5,7 @@\n #include <string.h>\n \n // This work is based on:\n+// Matthias Teschner, Bruno Heidelberger, Matthias Mueller, Danat Pomeranets, Markus Gross. Optimized Spatial Hashing for Collision Detection of Deformable Objects. 2003\n // John McDonald, Mark Kilgard. Crack-Free Point-Normal Triangles using Adjacent Edge Normals. 2010\n // John Hable. Variable Rate Shading with Visibility Buffer Rendering. 2024\n namespace meshopt\n@@ -86,6 +87,46 @@ struct VertexStreamHasher\n \t}\n };\n \n+struct VertexCustomHasher\n+{\n+\tconst float* vertex_positions;\n+\tsize_t vertex_stride_float;\n+\n+\tint (*callback)(void*, unsigned int, unsigned int);\n+\tvoid* context;\n+\n+\tsize_t hash(unsigned int index) const\n+\t{\n+\t\tconst unsigned int* key = reinterpret_cast<const unsigned int*>(vertex_positions + index * vertex_stride_float);\n+\n+\t\tunsigned int x = key[0], y = key[1], z = key[2];\n+\n+\t\t// replace negative zero with zero\n+\t\tx = (x == 0x80000000) ? 0 : x;\n+\t\ty = (y == 0x80000000) ? 0 : y;\n+\t\tz = (z == 0x80000000) ? 0 : z;\n+\n+\t\t// scramble bits to make sure that integer coordinates have entropy in lower bits\n+\t\tx ^= x >> 17;\n+\t\ty ^= y >> 17;\n+\t\tz ^= z >> 17;\n+\n+\t\t// Optimized Spatial Hashing for Collision Detection of Deformable Objects\n+\t\treturn (x * 73856093) ^ (y * 19349663) ^ (z * 83492791);\n+\t}\n+\n+\tbool equal(unsigned int lhs, unsigned int rhs) const\n+\t{\n+\t\tconst float* lp = vertex_positions + lhs * vertex_stride_float;\n+\t\tconst float* rp = vertex_positions + rhs * vertex_stride_float;\n+\n+\t\tif (lp[0] != rp[0] || lp[1] != rp[1] || lp[2] != rp[2])\n+\t\t\treturn false;\n+\n+\t\treturn callback ? callback(context, lhs, rhs) : true;\n+\t}\n+};\n+\n struct EdgeHasher\n {\n \tconst unsigned int* remap;\n@@ -183,6 +224,43 @@ static void buildPositionRemap(unsigned int* remap, const float* vertex_position\n \tallocator.deallocate(vertex_table);\n }\n \n+template <typename Hash>\n+static size_t generateVertexRemap(unsigned int* remap, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n+{\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n+\n+\tsize_t table_size = hashBuckets(vertex_count);\n+\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n+\tmemset(table, -1, table_size * sizeof(unsigned int));\n+\n+\tunsigned int next_vertex = 0;\n+\n+\tfor (size_t i = 0; i < index_count; ++i)\n+\t{\n+\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tassert(index < vertex_count);\n+\n+\t\tif (remap[index] != ~0u)\n+\t\t\tcontinue;\n+\n+\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n+\n+\t\tif (*entry == ~0u)\n+\t\t{\n+\t\t\t*entry = index;\n+\t\t\tremap[index] = next_vertex++;\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tassert(remap[*entry] != ~0u);\n+\t\t\tremap[index] = remap[*entry];\n+\t\t}\n+\t}\n+\n+\tassert(next_vertex <= vertex_count);\n+\treturn next_vertex;\n+}\n+\n template <size_t BlockSize>\n static void remapVertices(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n {\n@@ -197,55 +275,49 @@ static void remapVertices(void* destination, const void* vertices, size_t vertex\n \t\t}\n }\n \n-} // namespace meshopt\n-\n-size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+template <typename Hash>\n+static void generateShadowBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n {\n-\tusing namespace meshopt;\n-\n-\tassert(indices || index_count == vertex_count);\n-\tassert(!indices || index_count % 3 == 0);\n-\tassert(vertex_size > 0 && vertex_size <= 256);\n-\n-\tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n-\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n \n \tsize_t table_size = hashBuckets(vertex_count);\n \tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n \tmemset(table, -1, table_size * sizeof(unsigned int));\n \n-\tunsigned int next_vertex = 0;\n-\n \tfor (size_t i = 0; i < index_count; ++i)\n \t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tunsigned int index = indices[i];\n \t\tassert(index < vertex_count);\n \n-\t\tif (destination[index] == ~0u)\n+\t\tif (remap[index] == ~0u)\n \t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n+\t\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n \n \t\t\tif (*entry == ~0u)\n-\t\t\t{\n \t\t\t\t*entry = index;\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n-\n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n+\t\t\tremap[index] = *entry;\n \t\t}\n+\n+\t\tdestination[i] = remap[index];\n \t}\n+}\n \n-\tassert(next_vertex <= vertex_count);\n+} // namespace meshopt\n \n-\treturn next_vertex;\n+size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+{\n+\tusing namespace meshopt;\n+\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_size > 0 && vertex_size <= 256);\n+\n+\tmeshopt_Allocator allocator;\n+\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -263,44 +335,24 @@ size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigne\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tunsigned int next_vertex = 0;\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (destination[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t{\n-\t\t\t\t*entry = index;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n+}\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n+size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context)\n+{\n+\tusing namespace meshopt;\n \n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n-\t\t}\n-\t}\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_positions_stride >= 12 && vertex_positions_stride <= 256);\n+\tassert(vertex_positions_stride % sizeof(float) == 0);\n \n-\tassert(next_vertex <= vertex_count);\n+\tmeshopt_Allocator allocator;\n+\tVertexCustomHasher hasher = {vertex_positions, vertex_positions_stride / sizeof(float), callback, context};\n \n-\treturn next_vertex;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_remapVertexBuffer(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n@@ -362,33 +414,9 @@ void meshopt_generateShadowIndexBuffer(unsigned int* destination, const unsigned\n \tassert(vertex_size <= vertex_stride);\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_stride};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -406,33 +434,9 @@ void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const uns\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateAdjacencyIndexBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride)\ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 295324c78..54320c178 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -74,6 +74,19 @@ MESHOPTIMIZER_API size_t meshopt_generateVertexRemap(unsigned int* destination,\n  */\n MESHOPTIMIZER_API size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count);\n \n+/**\n+ * Experimental: Generates a vertex remap table from the vertex buffer and an optional index buffer and returns number of unique vertices\n+ * As a result, all vertices that are equivalent map to the same (new) location, with no gaps in the resulting sequence.\n+ * Equivalence is checked in two steps: vertex positions are compared for equality, and then the user-specified equality function is called (if provided).\n+ * Resulting remap table maps old vertices to new vertices and can be used in meshopt_remapVertexBuffer/meshopt_remapIndexBuffer.\n+ *\n+ * destination must contain enough space for the resulting remap table (vertex_count elements)\n+ * indices can be NULL if the input is unindexed\n+ * vertex_positions should have float3 position in the first 12 bytes of each vertex\n+ * callback can be NULL if no additional equality check is needed; otherwise, it should return 1 if vertices with specified indices are equivalent and 0 if they are not\n+ */\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context);\n+\n /**\n  * Generates vertex buffer from the source vertex buffer and remap table generated by meshopt_generateVertexRemap\n  *\n@@ -722,6 +735,8 @@ template <typename T>\n inline size_t meshopt_generateVertexRemap(unsigned int* destination, const T* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size);\n template <typename T>\n inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const T* indices, size_t index_count, size_t vertex_count, const meshopt_Stream* streams, size_t stream_count);\n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback);\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap);\n template <typename T>\n@@ -930,6 +945,19 @@ inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const\n \treturn meshopt_generateVertexRemapMulti(destination, indices ? in.data : NULL, index_count, vertex_count, streams, stream_count);\n }\n \n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback)\n+{\n+\tstruct Call\n+\t{\n+\t\tstatic int compare(void* context, unsigned int lhs, unsigned int rhs) { return (*static_cast<F*>(context))(lhs, rhs) ? 1 : 0; }\n+\t};\n+\n+\tmeshopt_IndexAdapter<T> in(NULL, indices, indices ? index_count : 0);\n+\n+\treturn meshopt_generateVertexRemapCustom(destination, indices ? in.data : NULL, index_count, vertex_positions, vertex_count, vertex_positions_stride, &Call::compare, &callback);\n+}\n+\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap)\n {\n", "test_patch": "diff --git a/demo/tests.cpp b/demo/tests.cpp\nindex 85f6c146d..0d1ee3908 100644\n--- a/demo/tests.cpp\n+++ b/demo/tests.cpp\n@@ -1354,6 +1354,50 @@ static void partitionBasic()\n \tassert(part[0] == 0 && part[1] == 0 && part[2] == 0 && part[3] == 0);\n }\n \n+static int remapCustomFalse(void*, unsigned int, unsigned int)\n+{\n+\treturn 0;\n+}\n+\n+static int remapCustomTrue(void*, unsigned int, unsigned int)\n+{\n+\treturn 1;\n+}\n+\n+static void remapCustom()\n+{\n+\tconst float vb[] = {\n+\t    0, 0, 0,\n+\t    1, 0, 0,\n+\t    0, 1, 0,\n+\t    0, 0, 1,\n+\t    1, 0, 0,\n+\t    0, -0.f, 1, // clang-format\n+\t};\n+\n+\tunsigned int remap[6];\n+\tsize_t res;\n+\n+\tres = meshopt_generateVertexRemapCustom(remap, NULL, 6, vb, 6, sizeof(float) * 3, NULL, NULL);\n+\tassert(res == 4);\n+\tfor (int i = 0; i < 4; ++i)\n+\t\tassert(remap[i] == unsigned(i));\n+\tassert(remap[4] == 1);\n+\tassert(remap[5] == 3);\n+\n+\tres = meshopt_generateVertexRemapCustom(remap, NULL, 6, vb, 6, sizeof(float) * 3, remapCustomTrue, NULL);\n+\tassert(res == 4);\n+\tfor (int i = 0; i < 4; ++i)\n+\t\tassert(remap[i] == unsigned(i));\n+\tassert(remap[4] == 1);\n+\tassert(remap[5] == 3);\n+\n+\tres = meshopt_generateVertexRemapCustom(remap, NULL, 6, vb, 6, sizeof(float) * 3, remapCustomFalse, NULL);\n+\tassert(res == 6);\n+\tfor (int i = 0; i < 6; ++i)\n+\t\tassert(remap[i] == unsigned(i));\n+}\n+\n static size_t allocCount;\n static size_t freeCount;\n \n@@ -2424,6 +2468,8 @@ void runTests()\n \n \tpartitionBasic();\n \n+\tremapCustom();\n+\n \tcustomAllocator();\n \n \temptyMesh();\n", "problem_statement": "Vertex remapping/reindexing with approximate equality\nAs the README states,\r\n> meshopt_generateVertexRemap uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\r\n\r\nSince rolling a custom version of the algorithm for a single-line change also comes with a maintenance cost, would it be possible to provide a variant of the algorithm that allows the specification of custom distance functions?\r\n\r\nFor instance by extending the `meshopt_Stream` struct or by passing a function pointer to the signature, which then gets the stream and element?\n", "hints_text": "Yeah I plan to add support for tolerance based remapping eventually. It would be helpful to have a generic algorithm for this use case.\r\n\r\nThis is not a single-line change, and exposing a callback isn't quite enough; this requires a different algorithm, and perhaps an interface where the implementation has direct access to floating point values (or not; for normals it might be better to compare the dot product for example).", "created_at": "2025-03-26 01:57:49", "merge_commit_sha": "bcce37fb9a420aed3a8efe2f7e1d3c9d67848637", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"], ["gltfpack", ".github/workflows/build.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-807", "base_commit": "a64a212836d471756f86121aa5afc3547ff6196c", "patch": "diff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex a3ec5a60a..a61f057c9 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -409,6 +409,9 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t{\n \t\tconst Mesh& mesh = meshes[i];\n \n+\t\tif (mesh.type != cgltf_primitive_type_triangles)\n+\t\t\tcontinue;\n+\n \t\tif (settings.simplify_debug > 0)\n \t\t{\n \t\t\tMesh kinds = {};\ndiff --git a/gltf/mesh.cpp b/gltf/mesh.cpp\nindex ae44322f3..c691b48b7 100644\n--- a/gltf/mesh.cpp\n+++ b/gltf/mesh.cpp\n@@ -762,6 +762,78 @@ static void simplifyAttributes(std::vector<float>& attrs, float* attrw, size_t s\n \t}\n }\n \n+static void simplifyUvSplit(Mesh& mesh, std::vector<unsigned int>& remap)\n+{\n+\tassert(mesh.type == cgltf_primitive_type_triangles);\n+\tassert(!mesh.indices.empty());\n+\n+\tconst Stream* uv = getStream(mesh, cgltf_attribute_type_texcoord);\n+\tif (!uv)\n+\t\treturn;\n+\n+\tsize_t vertex_count = uv->data.size();\n+\n+\tstd::vector<unsigned char> uvsign(mesh.indices.size() / 3);\n+\tstd::vector<unsigned char> flipseam(vertex_count);\n+\n+\tfor (size_t i = 0; i < mesh.indices.size(); i += 3)\n+\t{\n+\t\tunsigned int a = mesh.indices[i + 0];\n+\t\tunsigned int b = mesh.indices[i + 1];\n+\t\tunsigned int c = mesh.indices[i + 2];\n+\n+\t\tconst Attr& va = uv->data[a];\n+\t\tconst Attr& vb = uv->data[b];\n+\t\tconst Attr& vc = uv->data[c];\n+\n+\t\tfloat uvarea = (vb.f[0] - va.f[0]) * (vc.f[1] - va.f[1]) - (vc.f[0] - va.f[0]) * (vb.f[1] - va.f[1]);\n+\t\tunsigned char flag = uvarea > 0 ? 1 : (uvarea < 0 ? 2 : 0);\n+\n+\t\tuvsign[i / 3] = flag;\n+\t\tflipseam[a] |= flag;\n+\t\tflipseam[b] |= flag;\n+\t\tflipseam[c] |= flag;\n+\t}\n+\n+\tstd::vector<unsigned int> split(vertex_count);\n+\tsize_t splits = 0;\n+\n+\tremap.resize(vertex_count);\n+\n+\tfor (size_t i = 0; i < vertex_count; ++i)\n+\t{\n+\t\tremap[i] = unsigned(i);\n+\n+\t\tif (flipseam[i] == 3)\n+\t\t{\n+\t\t\tassert(remap.size() == vertex_count + splits);\n+\t\t\tremap.push_back(unsigned(i));\n+\n+\t\t\tsplit[i] = unsigned(vertex_count + splits);\n+\t\t\tsplits++;\n+\n+\t\t\tfor (size_t k = 0; k < mesh.streams.size(); ++k)\n+\t\t\t\tmesh.streams[k].data.push_back(mesh.streams[k].data[i]);\n+\t\t}\n+\t}\n+\n+\tfor (size_t i = 0; i < mesh.indices.size(); i += 3)\n+\t{\n+\t\tunsigned int a = mesh.indices[i + 0];\n+\t\tunsigned int b = mesh.indices[i + 1];\n+\t\tunsigned int c = mesh.indices[i + 2];\n+\n+\t\tunsigned char sign = uvsign[i / 3];\n+\n+\t\tif (flipseam[a] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 0] = split[a];\n+\t\tif (flipseam[b] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 1] = split[b];\n+\t\tif (flipseam[c] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 2] = split[c];\n+\t}\n+}\n+\n static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attributes, bool aggressive, bool lock_borders, bool debug = false)\n {\n \tenum\n@@ -778,6 +850,10 @@ static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attribut\n \tif (!positions)\n \t\treturn;\n \n+\tstd::vector<unsigned int> uvremap;\n+\tif (attributes)\n+\t\tsimplifyUvSplit(mesh, uvremap);\n+\n \tsize_t vertex_count = mesh.streams[0].data.size();\n \n \tsize_t target_index_count = size_t(double(size_t(mesh.indices.size() / 3)) * threshold) * 3;\n@@ -819,6 +895,9 @@ static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attribut\n \t\tindices.resize(meshopt_simplifySloppy(&indices[0], &mesh.indices[0], mesh.indices.size(), positions->data[0].f, vertex_count, sizeof(Attr), target_index_count, target_error_aggressive));\n \t\tmesh.indices.swap(indices);\n \t}\n+\n+\tif (uvremap.size() && mesh.indices.size() && !debug)\n+\t\tmeshopt_remapIndexBuffer(&mesh.indices[0], &mesh.indices[0], mesh.indices.size(), &uvremap[0]);\n }\n \n static void optimizeMesh(Mesh& mesh, bool compressmore)\n@@ -1048,8 +1127,6 @@ void debugSimplify(const Mesh& source, Mesh& kinds, Mesh& loops, float ratio, fl\n \treindexMesh(mesh, quantize_tbn);\n \tfilterTriangles(mesh);\n \n-\tsize_t vertex_count = mesh.streams[0].data.size();\n-\n \tsimplifyMesh(mesh, ratio, error, attributes, /* aggressive= */ false, /* lock_borders= */ false, /* debug= */ true);\n \n \t// color palette for display\n@@ -1079,6 +1156,8 @@ void debugSimplify(const Mesh& source, Mesh& kinds, Mesh& loops, float ratio, fl\n \t\t}\n \t}\n \n+\tsize_t vertex_count = mesh.streams[0].data.size();\n+\n \t// transform kind/loop data into lines & points\n \tStream colors = {cgltf_attribute_type_color};\n \tcolors.data.resize(vertex_count, kPalette[0]);\n", "test_patch": "", "problem_statement": "Simplification should recognize and handle UV mirroring seams\nRare case but on some models, simplification lead to UV artefacts : UVs are getting fully streched (same value on both vertices) when many other triangles could have been optimized instead, I suggest to give a lower priority to simplify/remove vertices/faces of the mesh leading to these results.\r\n\r\nIt might also be a bug in the way the uvs get re-assigned.\r\n\r\nThe model used to illustrate this example : \r\nhttps://www.dropbox.com/scl/fi/po761ykdiqdmtbzd9fitf/rhino.glb?rlkey=s6jp06vtr4id0opnv76wwys1p&dl=0\r\n\r\nBefore simplify : \r\n<img width=\"527\" alt=\"Screenshot 2024-07-08 at 16 25 05\" src=\"https://github.com/zeux/meshoptimizer/assets/213351/080e3431-bef9-4f61-811d-c5dbe638cf40\">\r\n\r\nAfter simplify :\r\n<img width=\"536\" alt=\"Screenshot 2024-07-08 at 16 14 54\" src=\"https://github.com/zeux/meshoptimizer/assets/213351/2da68c85-190d-441b-a59b-3789170bed2b\">\n", "hints_text": "Are UVs mirrored here? If so then yeah it\u2019s a known issue atm, and will get addressed eventually.\nYeah I looked at the scene closer and it's indeed UV mirroring. This needs special handling in the simplifier, probably as a separate pre-process.\r\n\r\nRe-attaching the file so that this isn't lost in the future (I also regenerated the normals here because they were just broken in the input file):\r\n[rhino.zip](https://github.com/user-attachments/files/16131681/rhino.zip)\r\n[rhino-tbn.zip](https://github.com/user-attachments/files/16132753/rhino-tbn.zip)\r\n\r\nWorth noting is that if the GLB file gets re-exported with tangent data and a normal map (without a normal map gltfpack needs `-kv` flag), the simplifier will automatically recognize the mirroring seam and simplify correctly (of course, this ideally should work without tangent information present to begin with):\r\n![image](https://github.com/zeux/meshoptimizer/assets/1106629/eb73bcc6-f4df-42e0-8cb7-7c3385fc6e16)\r\n", "created_at": "2024-11-17 23:12:14", "merge_commit_sha": "441201765502c80dd7ed9dad92ea13e15103aef1", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-709", "base_commit": "b092eee9823cbc38ec8dd6107ff1dedcd3ac9bfa", "patch": "diff --git a/extern/cgltf.h b/extern/cgltf.h\nindex ac392aba4..36fd644e1 100644\n--- a/extern/cgltf.h\n+++ b/extern/cgltf.h\n@@ -395,6 +395,8 @@ typedef struct cgltf_texture\n \tcgltf_sampler* sampler;\n \tcgltf_bool has_basisu;\n \tcgltf_image* basisu_image;\n+\tcgltf_bool has_webp;\n+\tcgltf_image* webp_image;\n \tcgltf_extras extras;\n \tcgltf_size extensions_count;\n \tcgltf_extension* extensions;\n@@ -4551,6 +4553,34 @@ static int cgltf_parse_json_texture(cgltf_options* options, jsmntok_t const* tok\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\telse if (cgltf_json_strcmp(tokens + i, json_chunk, \"EXT_texture_webp\") == 0)\n+\t\t\t\t{\n+\t\t\t\t\tout_texture->has_webp = 1;\n+\t\t\t\t\t++i;\n+\t\t\t\t\tCGLTF_CHECK_TOKTYPE(tokens[i], JSMN_OBJECT);\n+\t\t\t\t\tint num_properties = tokens[i].size;\n+\t\t\t\t\t++i;\n+\n+\t\t\t\t\tfor (int t = 0; t < num_properties; ++t)\n+\t\t\t\t\t{\n+\t\t\t\t\t\tCGLTF_CHECK_KEY(tokens[i]);\n+\n+\t\t\t\t\t\tif (cgltf_json_strcmp(tokens + i, json_chunk, \"source\") == 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t\tout_texture->webp_image = CGLTF_PTRINDEX(cgltf_image, cgltf_json_to_int(tokens + i, json_chunk));\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\ti = cgltf_skip_json(tokens, i + 1);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tif (i < 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\treturn i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t\telse\n \t\t\t\t{\n \t\t\t\t\ti = cgltf_parse_json_unprocessed_extension(options, tokens, i, json_chunk, &(out_texture->extensions[out_texture->extensions_count++]));\n@@ -6561,6 +6591,7 @@ static int cgltf_fixup_pointers(cgltf_data* data)\n \t{\n \t\tCGLTF_PTRFIXUP(data->textures[i].image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].basisu_image, data->images, data->images_count);\n+\t\tCGLTF_PTRFIXUP(data->textures[i].webp_image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].sampler, data->samplers, data->samplers_count);\n \t}\n \ndiff --git a/gltf/README.md b/gltf/README.md\nindex ffe6d1e12..4b278676a 100644\n--- a/gltf/README.md\n+++ b/gltf/README.md\n@@ -85,6 +85,7 @@ gltfpack supports most Khronos extensions and some multi-vendor extensions in th\n - KHR_texture_transform\n - EXT_mesh_gpu_instancing\n - EXT_meshopt_compression\n+- EXT_texture_webp\n \n Even if the source file does not use extensions, gltfpack may use some extensions in the output file either by default or when certain options are used:\n \ndiff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex f3156d3e3..ee46fa6a7 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -454,6 +454,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \tbool ext_instancing = false;\n \tbool ext_texture_transform = false;\n \tbool ext_texture_basisu = false;\n+\tbool ext_texture_webp = false;\n \n \tsize_t accr_offset = 0;\n \tsize_t node_offset = 0;\n@@ -512,6 +513,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\tassert(textures[i].remap == int(texture_offset));\n \t\ttexture_offset++;\n \t\text_texture_basisu = ext_texture_basisu || texture.has_basisu;\n+\t\text_texture_webp = ext_texture_webp || texture.has_webp;\n \t}\n \n \tfor (size_t i = 0; i < data->materials_count; ++i)\n@@ -838,6 +840,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t    {\"KHR_materials_variants\", data->variants_count > 0, false},\n \t    {\"KHR_lights_punctual\", data->lights_count > 0, false},\n \t    {\"KHR_texture_basisu\", (!json_textures.empty() && settings.texture_ktx2) || ext_texture_basisu, true},\n+\t    {\"EXT_texture_webp\", ext_texture_webp, true},\n \t    {\"EXT_mesh_gpu_instancing\", ext_instancing, true},\n \t};\n \ndiff --git a/gltf/image.cpp b/gltf/image.cpp\nindex 129938a0e..972b4c441 100644\n--- a/gltf/image.cpp\n+++ b/gltf/image.cpp\n@@ -8,6 +8,7 @@ static const char* kMimeTypes[][2] = {\n     {\"image/jpeg\", \".jpeg\"},\n     {\"image/png\", \".png\"},\n     {\"image/ktx2\", \".ktx2\"},\n+    {\"image/webp\", \".webp\"},\n };\n \n static const char* inferMimeType(const char* path)\n@@ -128,6 +129,7 @@ static int readInt32LE(const std::string& data, size_t offset)\n \t       (unsigned((unsigned char)data[offset + 3]) << 24);\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool getDimensionsPng(const std::string& data, int& width, int& height)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -146,6 +148,7 @@ static bool getDimensionsPng(const std::string& data, int& width, int& height)\n \treturn true;\n }\n \n+// https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format#File_format_structure\n static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n {\n \tsize_t offset = 0;\n@@ -189,6 +192,7 @@ static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n \treturn false;\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool hasTransparencyPng(const std::string& data)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -224,6 +228,7 @@ static bool hasTransparencyPng(const std::string& data)\n \treturn false;\n }\n \n+// https://github.khronos.org/KTX-Specification/ktxspec.v2.html\n static bool hasTransparencyKtx2(const std::string& data)\n {\n \tif (data.size() < 12 + 17 * 4)\n@@ -261,12 +266,45 @@ static bool hasTransparencyKtx2(const std::string& data)\n \treturn false;\n }\n \n+// https://developers.google.com/speed/webp/docs/riff_container\n+static bool hasTransparencyWebP(const std::string& data)\n+{\n+\tif (data.size() < 12 + 4 + 12)\n+\t\treturn false;\n+\n+\tif (data.compare(0, 4, \"RIFF\") != 0)\n+\t\treturn false;\n+\tif (data.compare(8, 4, \"WEBP\") != 0)\n+\t\treturn false;\n+\n+\t// WebP data may use VP8L, VP8X or VP8 format, but VP8 does not support transparency\n+\tif (data.compare(12, 4, \"VP8L\") == 0)\n+\t{\n+\t\tif (unsigned(data[20]) != 0x2f)\n+\t\t\treturn false;\n+\n+\t\t// width (14) | height (14) | alpha_is_used (1) | version_number(3)\n+\t\tunsigned int header = readInt32LE(data, 21);\n+\t\treturn (header & (1 << 28)) != 0;\n+\t}\n+\telse if (data.compare(12, 4, \"VP8X\") == 0)\n+\t{\n+\t\t// zero (2) | icc (1) | alpha (1) | exif (1) | xmp (1) | animation (1) | zero (1)\n+\t\tunsigned char header = data[20];\n+\t\treturn (header & (1 << 4)) != 0;\n+\t}\n+\n+\treturn false;\n+}\n+\n bool hasAlpha(const std::string& data, const char* mime_type)\n {\n \tif (strcmp(mime_type, \"image/png\") == 0)\n \t\treturn hasTransparencyPng(data);\n \telse if (strcmp(mime_type, \"image/ktx2\") == 0)\n \t\treturn hasTransparencyKtx2(data);\n+\telse if (strcmp(mime_type, \"image/webp\") == 0)\n+\t\treturn hasTransparencyWebP(data);\n \telse\n \t\treturn false;\n }\ndiff --git a/gltf/material.cpp b/gltf/material.cpp\nindex 0931b2e05..68d5610c8 100644\n--- a/gltf/material.cpp\n+++ b/gltf/material.cpp\n@@ -11,10 +11,10 @@ static bool areTexturesEqual(const cgltf_texture& lhs, const cgltf_texture& rhs)\n \tif (lhs.sampler != rhs.sampler)\n \t\treturn false;\n \n-\tif (lhs.has_basisu != rhs.has_basisu)\n+\tif (lhs.basisu_image != rhs.basisu_image)\n \t\treturn false;\n \n-\tif (lhs.basisu_image != rhs.basisu_image)\n+\tif (lhs.webp_image != rhs.webp_image)\n \t\treturn false;\n \n \treturn true;\n@@ -446,9 +446,12 @@ static const cgltf_image* getTextureImage(const cgltf_texture* texture)\n \tif (texture && texture->image)\n \t\treturn texture->image;\n \n-\tif (texture && texture->has_basisu && texture->basisu_image)\n+\tif (texture && texture->basisu_image)\n \t\treturn texture->basisu_image;\n \n+\tif (texture && texture->webp_image)\n+\t\treturn texture->webp_image;\n+\n \treturn NULL;\n }\n \ndiff --git a/gltf/write.cpp b/gltf/write.cpp\nindex 13f2f3ad5..429d0c446 100644\n--- a/gltf/write.cpp\n+++ b/gltf/write.cpp\n@@ -975,13 +975,20 @@ void writeTexture(std::string& json, const cgltf_texture& texture, const ImageIn\n \t\t}\n \t}\n \n-\tif (texture.has_basisu && texture.basisu_image)\n+\tif (texture.basisu_image)\n \t{\n \t\tcomma(json);\n \t\tappend(json, \"\\\"extensions\\\":{\\\"KHR_texture_basisu\\\":{\\\"source\\\":\");\n \t\tappend(json, size_t(texture.basisu_image - data->images));\n \t\tappend(json, \"}}\");\n \t}\n+\telse if (texture.webp_image)\n+\t{\n+\t\tcomma(json);\n+\t\tappend(json, \"\\\"extensions\\\":{\\\"EXT_texture_webp\\\":{\\\"source\\\":\");\n+\t\tappend(json, size_t(texture.webp_image - data->images));\n+\t\tappend(json, \"}}\");\n+\t}\n }\n \n void writeMeshAttributes(std::string& json, std::vector<BufferView>& views, std::string& json_accessors, size_t& accr_offset, const Mesh& mesh, int target, const QuantizationPosition& qp, const QuantizationTexture& qt, const Settings& settings)\n", "test_patch": "", "problem_statement": "gltfpack: EXT_texture_webp support\nSpec [here](https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Vendor/EXT_texture_webp).\r\n\r\nModel before:\r\n[webp_demo.zip](https://github.com/zeux/meshoptimizer/files/10695236/webp_demo.zip)\r\n```json\r\n{\r\n\"textures\":[{\"sampler\":0,\"extensions\":{\"EXT_texture_webp\":{\"source\":0}}}],\r\n\"extensionsUsed\":[\"EXT_texture_webp\"],\"extensionsRequired\":[\"EXT_texture_webp\"]\r\n}\r\n```\r\nModel after:\r\n[webp_demo_gltfpack.zip](https://github.com/zeux/meshoptimizer/files/10695237/webp_demo_gltfpack.zip)\r\n```json\r\n{\r\n\"extensionsUsed\":[\"KHR_mesh_quantization\",\"KHR_texture_transform\"],\"extensionsRequired\":[\"KHR_mesh_quantization\"],\r\n\"textures\":[{}]\r\n}\r\n```\n", "hints_text": "A similar thing is the proposal of [EXT_texture_avif](https://github.com/KhronosGroup/glTF/pull/2235). Or maybe gltfpack can just keep all unknown extensions of texture for maximum compatibility.\nThis requires https://github.com/jkuhlmann/cgltf/issues/248; I'm not very interested in implementing this myself and gltfpack can't encode webp images without external dependencies anyway so the best it can do here is to preserve inputs as is, but if the linked issue gets implemented I can take a look at this.\r\n\r\nKeeping unknown extensions doesn't work because image files need to be parsed for material transparency optimization.", "created_at": "2024-06-22 23:34:01", "merge_commit_sha": "fbc9f5498c33d537fbc3d853d643dd9acadbcf94", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"]]}
{"repo": "zeux/meshoptimizer", "instance_id": "zeux__meshoptimizer-696", "base_commit": "97e57ad2628bf04adf8f0d0291f2387d4c08578a", "patch": "diff --git a/extern/cgltf.h b/extern/cgltf.h\nindex 17dc0ca5d..ac392aba4 100644\n--- a/extern/cgltf.h\n+++ b/extern/cgltf.h\n@@ -1697,7 +1697,20 @@ cgltf_result cgltf_validate(cgltf_data* data)\n \t{\n \t\tif (data->nodes[i].weights && data->nodes[i].mesh)\n \t\t{\n-\t\t\tCGLTF_ASSERT_IF (data->nodes[i].mesh->primitives_count && data->nodes[i].mesh->primitives[0].targets_count != data->nodes[i].weights_count, cgltf_result_invalid_gltf);\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh->primitives_count && data->nodes[i].mesh->primitives[0].targets_count != data->nodes[i].weights_count, cgltf_result_invalid_gltf);\n+\t\t}\n+\n+\t\tif (data->nodes[i].has_mesh_gpu_instancing)\n+\t\t{\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh == NULL, cgltf_result_invalid_gltf);\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh_gpu_instancing.attributes_count == 0, cgltf_result_invalid_gltf);\n+\n+\t\t\tcgltf_accessor* first = data->nodes[i].mesh_gpu_instancing.attributes[0].data;\n+\n+\t\t\tfor (cgltf_size k = 0; k < data->nodes[i].mesh_gpu_instancing.attributes_count; ++k)\n+\t\t\t{\n+\t\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh_gpu_instancing.attributes[k].data->count != first->count, cgltf_result_invalid_gltf);\n+\t\t\t}\n \t\t}\n \t}\n \ndiff --git a/gltf/README.md b/gltf/README.md\nindex a6be16405..ffe6d1e12 100644\n--- a/gltf/README.md\n+++ b/gltf/README.md\n@@ -83,6 +83,7 @@ gltfpack supports most Khronos extensions and some multi-vendor extensions in th\n - KHR_mesh_quantization\n - KHR_texture_basisu\n - KHR_texture_transform\n+- EXT_mesh_gpu_instancing\n - EXT_meshopt_compression\n \n Even if the source file does not use extensions, gltfpack may use some extensions in the output file either by default or when certain options are used:\ndiff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex 2db6eff77..dee7a930a 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -281,7 +281,10 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \tfor (size_t i = 0; i < meshes.size(); ++i)\n \t{\n \t\tMesh& mesh = meshes[i];\n-\t\tassert(mesh.instances.empty());\n+\n+\t\t// mesh is already instanced, skip\n+\t\tif (!mesh.instances.empty())\n+\t\t\tcontinue;\n \n \t\t// mesh is already world space, skip\n \t\tif (mesh.nodes.empty())\n@@ -664,9 +667,6 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \n \t\tappend(json_meshes, \"}\");\n \n-\t\tassert(mesh.nodes.empty() || mesh.instances.empty());\n-\t\text_instancing = ext_instancing || !mesh.instances.empty();\n-\n \t\tif (mesh.nodes.size())\n \t\t{\n \t\t\tfor (size_t j = 0; j < mesh.nodes.size(); ++j)\n@@ -691,7 +691,8 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-\t\telse if (mesh.instances.size())\n+\n+\t\tif (mesh.instances.size())\n \t\t{\n \t\t\tassert(mesh.scene >= 0);\n \t\t\tcomma(json_roots[mesh.scene]);\n@@ -704,7 +705,8 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \n \t\t\tnode_offset++;\n \t\t}\n-\t\telse\n+\n+\t\tif (mesh.nodes.empty() && mesh.instances.empty())\n \t\t{\n \t\t\tassert(mesh.scene >= 0);\n \t\t\tcomma(json_roots[mesh.scene]);\n@@ -716,6 +718,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\t}\n \n \t\tmesh_offset++;\n+\t\text_instancing = ext_instancing || !mesh.instances.empty();\n \n \t\t// skip all meshes that we've written in this iteration\n \t\tassert(pi > i);\ndiff --git a/gltf/parsegltf.cpp b/gltf/parsegltf.cpp\nindex 91f0c020f..f83356b70 100644\n--- a/gltf/parsegltf.cpp\n+++ b/gltf/parsegltf.cpp\n@@ -275,6 +275,54 @@ static void parseMeshesGltf(cgltf_data* data, std::vector<Mesh>& meshes, std::ve\n \t}\n }\n \n+static void parseMeshInstancesGltf(std::vector<Transform>& instances, cgltf_node* node)\n+{\n+\tcgltf_accessor* translation = NULL;\n+\tcgltf_accessor* rotation = NULL;\n+\tcgltf_accessor* scale = NULL;\n+\n+\tfor (size_t i = 0; i < node->mesh_gpu_instancing.attributes_count; ++i)\n+\t{\n+\t\tcgltf_attribute& attr = node->mesh_gpu_instancing.attributes[i];\n+\n+\t\tif (strcmp(attr.name, \"TRANSLATION\") == 0 && attr.data->type == cgltf_type_vec3)\n+\t\t\ttranslation = attr.data;\n+\t\telse if (strcmp(attr.name, \"ROTATION\") == 0 && attr.data->type == cgltf_type_vec4)\n+\t\t\trotation = attr.data;\n+\t\telse if (strcmp(attr.name, \"SCALE\") == 0 && attr.data->type == cgltf_type_vec3)\n+\t\t\tscale = attr.data;\n+\t}\n+\n+\tsize_t count = node->mesh_gpu_instancing.attributes[0].data->count;\n+\n+\tinstances.reserve(instances.size() + count);\n+\n+\tcgltf_node instance = {};\n+\tinstance.parent = node;\n+\tinstance.has_translation = translation != NULL;\n+\tinstance.has_rotation = rotation != NULL;\n+\tinstance.has_scale = scale != NULL;\n+\tinstance.rotation[3] = 1.f;\n+\tinstance.scale[0] = 1.f;\n+\tinstance.scale[1] = 1.f;\n+\tinstance.scale[2] = 1.f;\n+\n+\tfor (size_t i = 0; i < count; ++i)\n+\t{\n+\t\tif (translation)\n+\t\t\tcgltf_accessor_read_float(translation, i, instance.translation, sizeof(float));\n+\t\tif (rotation)\n+\t\t\tcgltf_accessor_read_float(rotation, i, instance.rotation, sizeof(float));\n+\t\tif (scale)\n+\t\t\tcgltf_accessor_read_float(scale, i, instance.scale, sizeof(float));\n+\n+\t\tTransform xf;\n+\t\tcgltf_node_transform_world(&instance, xf.data);\n+\n+\t\tinstances.push_back(xf);\n+\t}\n+}\n+\n static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, const std::vector<std::pair<size_t, size_t> >& mesh_remap)\n {\n \tfor (size_t i = 0; i < data->nodes_count; ++i)\n@@ -289,7 +337,7 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\t{\n \t\t\tMesh* mesh = &meshes[mi];\n \n-\t\t\tif (!mesh->nodes.empty() && mesh->skin != node.skin)\n+\t\t\tif (mesh->skin != node.skin && (!mesh->nodes.empty() || !mesh->instances.empty()))\n \t\t\t{\n \t\t\t\t// this should be extremely rare - if the same mesh is used with different skins, we need to duplicate it\n \t\t\t\t// in this case we don't spend any effort on keeping the number of duplicates to the minimum, because this\n@@ -298,8 +346,16 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\t\t\tmesh = &meshes.back();\n \t\t\t}\n \n-\t\t\tmesh->nodes.push_back(&node);\n-\t\t\tmesh->skin = node.skin;\n+\t\t\tif (node.has_mesh_gpu_instancing)\n+\t\t\t{\n+\t\t\t\tmesh->scene = 0; // we need to assign scene index since instances are attached to a scene; for now we assume 0\n+\t\t\t\tparseMeshInstancesGltf(mesh->instances, &node);\n+\t\t\t}\n+\t\t\telse\n+\t\t\t{\n+\t\t\t\tmesh->skin = node.skin;\n+\t\t\t\tmesh->nodes.push_back(&node);\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -308,7 +364,7 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\tMesh& mesh = meshes[i];\n \n \t\t// because the rest of gltfpack assumes that empty nodes array = world-space mesh, we need to filter unused meshes\n-\t\tif (mesh.nodes.empty())\n+\t\tif (mesh.nodes.empty() && mesh.instances.empty())\n \t\t{\n \t\t\tmesh.streams.clear();\n \t\t\tmesh.indices.clear();\n@@ -530,8 +586,6 @@ static cgltf_data* parseGltf(cgltf_data* data, cgltf_result result, std::vector<\n \t\t*error = getError(result, data);\n \telse if (requiresExtension(data, \"KHR_draco_mesh_compression\"))\n \t\t*error = \"file requires Draco mesh compression support\";\n-\telse if (requiresExtension(data, \"EXT_mesh_gpu_instancing\"))\n-\t\t*error = \"file requires mesh instancing support\";\n \telse if (needsDummyBuffers(data))\n \t\t*error = \"buffer has no data\";\n \n@@ -543,6 +597,8 @@ static cgltf_data* parseGltf(cgltf_data* data, cgltf_result result, std::vector<\n \n \tif (requiresExtension(data, \"KHR_mesh_quantization\"))\n \t\tfprintf(stderr, \"Warning: file uses quantized geometry; repacking may result in increased quantization error\\n\");\n+\tif (requiresExtension(data, \"EXT_mesh_gpu_instancing\") && data->scenes_count > 1)\n+\t\tfprintf(stderr, \"Warning: file uses instancing and has more than one scene; results may be incorrect\\n\");\n \n \tstd::vector<std::pair<size_t, size_t> > mesh_remap;\n \n", "test_patch": "", "problem_statement": "gltfpack: Keep `EXT_mesh_gpu_instancing`\n### Discussed in https://github.com/zeux/meshoptimizer/discussions/680\r\n\r\n<div type='discussions-op-text'>\r\n\r\n<sup>Originally posted by **BoyBaykiller** April 22, 2024</sup>\r\nI am running `gltfpack -v -mi -noq -tc -i .\\SimpleInstancing.gltf -o .\\Compressed\\Output.gltf` over [this](https://github.com/KhronosGroup/glTF-Sample-Models/tree/main/2.0/SimpleInstancing/glTF) gltf model.\r\nIt uses the EXT_mesh_gpu_instancing extension to define a bunch of instanced cubes. I can render it correctly as it, but after running it through the command the EXT_mesh_gpu_instancing extension is removed, resulting in only a single cube being rendered.</div>\n", "hints_text": "", "created_at": "2024-05-26 22:16:14", "merge_commit_sha": "a4f2b370fd07a0f642f7ef53f70222b612e89acc", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["macos-arm", ".github/workflows/build.yml"], ["windows (x64)", ".github/workflows/build.yml"], ["gltfpack-js", ".github/workflows/build.yml"], ["Fuzzing", ".github/workflows/cifuzz.yml"], ["windows (Win32)", ".github/workflows/build.yml"], ["gltfpack-coverage", ".github/workflows/build.yml"]]}
{"repo": "swig/swig", "instance_id": "swig__swig-3159", "base_commit": "4167b0275adc574f86914e42fb5ef9639b2b25a5", "patch": "diff --git a/.github/workflows/linux.yml b/.github/workflows/linux.yml\nindex 02aa3f0681..a7e8f84d96 100644\n--- a/.github/workflows/linux.yml\n+++ b/.github/workflows/linux.yml\n@@ -132,6 +132,9 @@ jobs:\n         - SWIGLANG: python\n           VER: '3.13t' # no-gil testing\n           CSTD: gnu99\n+        - SWIGLANG: python\n+          VER: '3.14'\n+          CSTD: gnu99\n         - SWIGLANG: python\n           PY2: 2\n           SWIG_FEATURES: -builtin\ndiff --git a/Doc/Manual/Python.html b/Doc/Manual/Python.html\nindex 23587e5dbc..01fc449a68 100644\n--- a/Doc/Manual/Python.html\n+++ b/Doc/Manual/Python.html\n@@ -6552,7 +6552,7 @@ <H4><a name=\"Python_package_search_both_package_modules\">33.11.6.1 Both modules\n \n <p>\n In this configuration, the pure Python module, foo.py, tries to load the C/C++ module, _foo, from the same package foo.py is\n-located in.  The package name is determined from the <tt>__package__</tt>\n+located in.  The package name is determined from the <tt>__spec__.parent</tt> (or <tt>__package__</tt> before Python 3.4)\n attribute if available, see <a href=\"https://www.python.org/dev/peps/pep-0366/\">PEP 366</a>. Otherwise it is derived from the <tt>__name__</tt>\n attribute given to foo.py by the Python loader that imported foo.py.\n The interface file for this configuration would contain:\n@@ -6675,7 +6675,7 @@ <H4><a name=\"Python_custom_module_import\">33.11.6.4 More on customizing the modu\n \n <div class=\"targetlang\">\n <pre>\n-if __package__ or '.' in __name__:\n+if getattr(__spec__, \"parent\", None) or '.' in __name__:\n     from . import _foo\n else:\n     import _foo\n@@ -6760,7 +6760,7 @@ <H4><a name=\"Python_custom_module_import\">33.11.6.4 More on customizing the modu\n \n <div class=\"targetlang\">\n <pre>\n-if __package__ or '.' in __name__:\n+if getattr(__spec__, \"parent\", None) or '.' in __name__:\n     from ._foo import *\n else:\n     from _foo import *\ndiff --git a/Source/Modules/python.cxx b/Source/Modules/python.cxx\nindex 86daf131c8..3070a94fac 100644\n--- a/Source/Modules/python.cxx\n+++ b/Source/Modules/python.cxx\n@@ -703,20 +703,22 @@ class PYTHON:public Language {\n \t * onwards (implicit relative imports raised a DeprecationWarning in 2.6,\n \t * and fail in 2.7 onwards).\n \t *\n-\t * First check for __package__ which is available from 2.6 onwards, see PEP366.\n+\t * First check for __spec__.parent which is available from 3.4 onwards,\n+\t * see https://docs.python.org/3/reference/import.html#spec. If not,\n+\t * check for __package__, which was set before 3.14.\n \t * Next try determine the shadow wrapper's package based on the __name__ it\n \t * was given by the importer that loaded it.\n \t * If the module is in a package, load the low-level C/C++ module from the\n \t * same package, otherwise load it as a global module.\n \t */\n         Printv(default_import_code, \"# Import the low-level C/C++ module\\n\", NULL);\n-        Printv(default_import_code, \"if __package__ or \\\".\\\" in __name__:\\n\", NULL);\n+        Printv(default_import_code, \"if getattr(globals().get(\\\"__spec__\\\"), \\\"parent\\\", None) or globals().get(\\\"__package__\\\") or \\\".\\\" in __name__:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from . import \", module, \"\\n\", NULL);\n         Printv(default_import_code, \"else:\\n\", NULL);\n         Printv(default_import_code, tab4, \"import \", module, \"\\n\", NULL);\n       } else {\n         Printv(default_import_code, \"# Pull in all the attributes from the low-level C/C++ module\\n\", NULL);\n-        Printv(default_import_code, \"if __package__ or \\\".\\\" in __name__:\\n\", NULL);\n+        Printv(default_import_code, \"if getattr(globals().get(\\\"__spec__\\\"), \\\"parent\\\", None) or globals().get(\\\"__package__\\\") or \\\".\\\" in __name__:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from .\", module, \" import *\\n\", NULL);\n         Printv(default_import_code, \"else:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from \", module, \" import *\\n\", NULL);\n@@ -4372,6 +4374,11 @@ class PYTHON:public Language {\n     Printv(f, \"#if PY_VERSION_HEX >= 0x030b0000\\n\", NIL);\n     printSlot(f, getSlot(n, \"feature:python:_ht_tpname\"), \"_ht_tpname\", \"char *\");\n \n+    // void *ht_token;\n+    Printv(f, \"#if PY_VERSION_HEX >= 0x030e0000\\n\", NIL);\n+    printSlot(f, getSlot(n, \"feature:python:ht_token\"), \"ht_token\", \"void *\");\n+    Printv(f, \"#endif\\n\", NIL);\n+\n     // struct _specialization_cache _spec_cache;\n     Printf(f, \"  {\\n\");\n     printSlot(f, getSlot(n, \"feature:python:getitem\"), \"getitem\", \"PyObject *\");\n", "test_patch": "diff --git a/Examples/test-suite/python/python_annotations_variable_c_runme.py b/Examples/test-suite/python/python_annotations_variable_c_runme.py\nindex 153852d05e..d1f359bbbd 100644\n--- a/Examples/test-suite/python/python_annotations_variable_c_runme.py\n+++ b/Examples/test-suite/python/python_annotations_variable_c_runme.py\n@@ -1,4 +1,17 @@\n import sys\n+import inspect\n+\n+\n+def get_annotations(cls):\n+    # Python >=3.14 removed the __annotations__ attribute\n+    # retrieve it via inspect (see also annotationlib)\n+    if hasattr(inspect, \"get_annotations\"):\n+        # Python >=3.10\n+        return inspect.get_annotations(cls)\n+    else:\n+        # Python <3.10\n+        return getattr(cls, \"__annotations__\", {})\n+\n \n # Variable annotations for properties is only supported in python-3.6 and later (PEP 526)\n if sys.version_info[0:2] >= (3, 6):\n@@ -8,17 +21,14 @@\n     annotations_supported = not(is_python_builtin() or is_python_fastproxy())\n \n     if annotations_supported:\n-        ts = TemplateShort()\n-        anno = ts.__annotations__\n+        anno = get_annotations(TemplateShort)\n         if anno != {'member_variable': 'int'}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n \n-        ts = StructWithVar()\n-        anno = ts.__annotations__\n+        anno = get_annotations(StructWithVar)\n         if anno != {'member_variable': 'int'}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n \n-        ts = StructWithVarNotAnnotated()\n-        if getattr(ts, \"__annotations__\", None) != None:\n-            anno = ts.__annotations__\n+        anno = get_annotations(StructWithVarNotAnnotated)\n+        if anno != {}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n", "problem_statement": "__package__ will cease being set/used  in Python 3.15\nThe files generated by SWIG depend on `__package__` being present, but Python 3.14 will removing this in favor of `__spec__.parent`. The 3.13 release notes https://docs.python.org/3.13/whatsnew/3.13.html#pending-removal-in-python-3-14 say:\r\n\r\n> [importlib](https://docs.python.org/3.13/library/importlib.html#module-importlib): `__package__` and `__cached__` will cease to be set or taken into consideration by the import system ([gh-97879](https://github.com/python/cpython/issues/97879)).\r\n\r\nBoth could be checked, or just `__spec__.parent` - I can verify that works back to 3.6, which is the oldest Python I had to check.\n", "hints_text": "Python 3.3 is the oldest SWIG currently supports and seems to lack `__spec__` entirely:\r\n\r\n```\r\nPython 3.3.5 (default, Mar 22 2014, 13:24:53) \r\n[GCC 4.8.2] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information. \r\n>>> dir(__spec__)\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\nNameError: name '__spec__' is not defined\r\n>>> \r\n```\nAdded in 3.4: https://docs.python.org/3/reference/import.html#spec__\nFWIW I think it would be fine to set 3.4 as the minimum required version, I think nobody uses anything less than 3.6 or maybe even later any more by now.\n3.3 is _really_ old, by the way, and never was well supported - throughout 3.3's support window, 2.x was dramatically more popular. 3.5 was the first version with heavy use. Personally, 3.6 is still a _really_ old version of Python and a fine minimum; 3.6 is the oldest version you can build for via manylinux, for example. 3.8 is the oldest officially supported version of Python these days.\nNo arguments from me, but you'll need to convince wsfulton...\nFWIW, I'd argue for the minimum Python3 version being 3.5 since that's the oldest we've actually been testing in CI since github dropped their ubuntu-18.04 image over a year ago.\r\n\r\nRequiring CI testing for a version of a target language aligns with our requirements for supporting a target language version at all, and both seem reasonable requirements since without automated testing we won't detect breakages, and expecting developers to test by hand seems like the burden falling in the wrong place.  If someone wants to keep support for an older version, they get to sort out CI coverage for that version (by using packages from a PPA or using a prebuilt version or running the job in a docker image or whatever).\nSupporting the latest version of python is more important than supporting older versions. It's easy enough to put in version specific code though. I agree with @ojwb though, that ideally we test the versions we state we support. I'm still using 3.6 though in places, and I doubt I am not the only one.\r\n\r\n> Both could be checked, or just `__spec__.parent` - I can verify that works back to 3.6, which is the oldest Python I had to check\r\n\r\nI don't see any `__spec__.parent` until python 3.13, eg for for 3.12:\r\n```\r\n$ python3.12\r\nPython 3.12.4 (main, Jun  8 2024, 18:29:57) [GCC 11.4.0] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> dir(__spec__)\r\n['__bool__', '__class__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__']\r\n>>> \r\n```\r\nNo parent, but there is in 3.13:\r\n```\r\n$ python3.13\r\nPython 3.13.0b3 (main, Jul  8 2024, 01:23:25) [GCC 11.4.0] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> dir(__spec__)\r\n['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__weakref__', '_cached', '_set_fileattr', '_uninitialized_submodules', 'cached', 'has_location', 'loader', 'loader_state', 'name', 'origin', 'parent', 'submodule_search_locations']\r\n>>> \r\n```\r\nHow did you determine it works all the way back to python-3.6?\r\n\r\nAdding @mromberg, who has done most of the advanced package support, for Python for comment.\nIt has to be in a file, the interpreter doesn\u2019t have a `__spec__` until 3.13 (and only the new Python-based REPL).\n> Supporting the latest version of python is more important than supporting older versions. It's easy enough to put in version specific code though. I agree with @ojwb though, that ideally we test the versions we state we support. I'm still using 3.6 though in places, and I doubt I am not the only one.\r\n\r\nWe still have CI testing for 3.6 (and 3.5) so enforcing a requirement for a version to be testable in CI wouldn't require dropping 3.6 at this point anyway.  It's only 3.3 and 3.4 that we claim to support without having any CI coverage to back that up (so unless anyone has been regularly manually testing with these older versions, really all we can say is that we haven't knowingly done anything that stops SWIG working Python 3.3 and 3.4, which to me isn't very reassuring either as a user or as a maintainer).\nLooks like 3.14 will likely be released in just over a year, so we should aim to fix this for SWIG 4.4.0.\nNote: it's important to support this at least by RC 1, since that's when CPython is ABI stable and packages are supposed to start shipping. The \".0\" release is when normal users are supposed to start using it, packages should already have been built for 3.14. It would be a very good idea to support it by beta 1, as that's when most packages start experimenting with support.\r\n\r\nAlphas are produced starting in October or so, and are available on GHA for _early_ testing. Anything can change, though.\r\nBeta phase starts in May. This is fairly stable (feature freeze), _small_ chance of ABI changes though.\r\nRC starts in August.\r\nFinal is October.\r\n\r\nI believe more people will be using 3.14.0a1 than 3.3 and 3.4 combined, if that's helpful. Yesterday, pip was downloaded 10 times for 3.3 and 495 times for 3.4. For comparison, for 3.14, pip was downloaded 260 times, and that's just people building CPython from source. For 3.13, it was downloaded 12,609 (0.12%) times, which is slightly higher than 3.5's 11,389 (0.11%) times. The most popular Python version, 3.11, downloaded pip 2,605,209 times (25.2%).\r\n\r\nSo removing 3.3 and 3.4 removes 0.00% of Python users (who download pip, since that's the package I chose for a metric).\r\n\r\nHere's the [download numbers](https://pypistats.org/packages/swig) for the pip `swig` package, by the way, which was downloaded 0 times for 3.3, 3.4, and 3.5:\r\n\r\n![Screenshot 2024-09-19 at 12 48 16\u202fAM](https://github.com/user-attachments/assets/65cd1757-ebb6-47e1-afae-7e9a9e2df90b)\r\n\r\nIf you scroll back a week or two, you can find one download for 3.5, on 9-9-2024.\r\n\r\n\nWe need an easy way to install python-3.14 with the `__package__` removal implemented to test in order to take this forward. Any news on 3.14 being ready for testing this would be good to know here. A patch with a proposed fix wouldn't go amiss either!\n@henryiii SWIG is a volunteer project - if you want something to happen (and especially if you want it to happen in a particular time scale) the best way to achieve that is to submit a clean patch.  If you're wanting to get a patch in 4.3.0, then you have about a week before it gets released (which is a timeline driven primarily by the Python 3.13 release date).\r\n\r\n(Even adding it to the 4.4 milestone doesn't guarantee it'll get done for 4.4.0, but it does at least ensure we don't forget about the issue completely.)\r\n\r\nI don't **think** there's much argument against hard dropping support for 3.3 and 3.4 at this point if keeping it is blocking 3.14 support, though I'm not 100% clear on @wsfulton's position on this.  If he's wanting to keep conditional version-specific code for 3.3 and 3.4 that may make the task significantly harder because we don't have CI testing to tell us such code actually works.\n> 3.3 is _really_ old, by the way, and never was well supported - throughout 3.3's support window, 2.x was dramatically more popular. 3.5 was the first version with heavy use. Personally, 3.6 is still a _really_ old version of Python and a fine minimum; 3.6 is the oldest version you can build for via manylinux, for example. 3.8 is the oldest officially supported version of Python these days.\r\n\r\n3.6 is still part of SUSE Linux Enterprise Server 15, and it will be part of it for a long time (unfortunately, I am the maintainer).\nOh, sorry, missed this. This would be a lot easier if something like 3.5+ or 3.6+ became the minimum supported version, which I assume you'd not want on a short timescale anyway. It seem like 4.4 or later would be fine, as long as it's in by the beta series of 3.14, which is next year, something like March IIRC.\r\n\r\n> 3.6 is still part of SUSE Linux Enterprise Server 15\r\n\r\nDo people expect the latest version of SWIG to work with 3.6, though? All the rest of the core libraries for Python require 3.7+ or 3.8+ (and 3.8 is now EoL, so soon it will be 3.9+). I think it's fine to expect to need old versions of software on old OSs. Though from what I remember above even 3.5+ would be just fine for this specific thing.\r\n\r\nFYI, you can't get older versions of Python (<3.8) via setup-python in GHA on macos-latest or ubuntu-latest. Apple Silicon support started in 3.8 and they didn't bother to build EoL Pythons for ubuntu-24.04.\nI wasn't submitting a patch since I didn't want to raise the min version of Python, that seem like a project consensus type of a thing. Should I make a patch that just doesn't support <3.5 for this, then?\nMaking the minimum supported version as 3.5 doesn't seem an unreasonable compromise in order to add support for 3.14. Please submit your patch to support 3.5 and later and I'll take a look.\nOn Wed Oct 30, 2024 at 7:30 PM CET, Henry Schreiner wrote:\r\n>> 3.6 is still part of SUSE Linux Enterprise Server 15\r\n>\r\n> Do people expect the latest version of SWIG to work with 3.6, though? All the rest of the core libraries for Python require 3.7+ or 3.8+ (and 3.8 is now EoL, so soon it will be 3.9+). I think it\u2019s fine to expect to need old versions of software on old OSs. Though from what I remember above even 3.5+ would be just fine for this specific thing.\r\n\r\nI didn\u2019t mean that. Certainly we discourage users of our enterprise systems to use recent versions of software packages we provide in the system, moreover using most recent swig on the ancient system is beyond recklessness. However, as I believe SLE\u2019s Python 3.6 is probably one of the oldest supported Pythons in the production use (I am not sure RHEL, but I think they don\u2019t carry anything that ancient any more), it could be just one milestone where to stop with increasing the version of Python you support.\r\n\nManylinux also still supports 3.6 for a bit longer also (and because of that, it's still pretty easy to test on 3.6).", "created_at": "2025-04-10 17:59:12", "merge_commit_sha": "c8bedcc66163513ca3cc204e7b9b3388a44d26c2", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["java 8 gcc", ".github/workflows/windows.yml"], ["python  3.13   gcc  gnu99", ".github/workflows/linux.yml"], ["csharp     gcc", ".github/workflows/linux.yml"], ["scilab  2024.1.0   gcc", ".github/workflows/linux.yml"], ["python  3.13t   gcc  gnu99", ".github/workflows/linux.yml"], ["guile     gcc c++14", ".github/workflows/linux.yml"], ["java 8 msvc", ".github/workflows/windows.yml"], ["ruby  3.1   gcc c++11", ".github/workflows/linux.yml"], ["none     gcc", ".github/workflows/linux.yml"], ["ruby  3.3   gcc c++11", ".github/workflows/linux.yml"], ["csharp  gcc windows-2019", ".github/workflows/windows.yml"], ["csharp     gcc c++14", ".github/workflows/linux.yml"], ["none     clang", ".github/workflows/linux.yml"], ["ruby 3.1.6 msvc  no-test", ".github/workflows/windows.yml"], ["octave     gcc13 c++17", ".github/workflows/linux.yml"], ["scilab  2023.1.0   gcc", ".github/workflows/linux.yml"], ["d  2.103.1   gcc c++17", ".github/workflows/linux.yml"], ["none     gcc10", ".github/workflows/linux.yml"], ["csharp  gcc", ".github/workflows/windows.yml"], ["scilab  5.5.2   gcc", ".github/workflows/linux.yml"], ["python    -builtin -O gcc", ".github/workflows/linux.yml"], ["php  8.1   gcc", ".github/workflows/linux.yml"], ["octave     gcc c++11", ".github/workflows/linux.yml"], ["perl5     gcc c++14", ".github/workflows/linux.yml"], ["go  1.24   gcc  gnu99", ".github/workflows/linux.yml"], ["ocaml     gcc13 c++17   (can fail)", ".github/workflows/linux.yml"], ["java     gcc13 c++17", ".github/workflows/linux.yml"], ["python  3.13  -builtin gcc", ".github/workflows/linux.yml"], ["none     gcc11", ".github/workflows/linux.yml"], ["d  gdmd   gcc c++11", ".github/workflows/linux.yml"], ["r     gcc c++14", ".github/workflows/linux.yml"], ["php     gcc13 c++17 gnu17", ".github/workflows/linux.yml"], ["php  8.3   gcc", ".github/workflows/linux.yml"], ["java     gcc c++11", ".github/workflows/linux.yml"], ["javascript v8 7.8   gcc c++14 c++14", ".github/workflows/linux.yml"], ["php     gcc c++14 gnu11", ".github/workflows/linux.yml"], ["ruby  2.1   gcc", ".github/workflows/linux.yml"], ["ruby  gcc  no-test", ".github/workflows/windows.yml"], ["python  3.14   gcc  gnu99", ".github/workflows/linux.yml"], ["none     gcc9 c++98 c99", ".github/workflows/linux.yml"], ["perl5     gcc c++11", ".github/workflows/linux.yml"], ["perl5     gcc13 c++17", ".github/workflows/linux.yml"], ["r     gcc c++11", ".github/workflows/linux.yml"], ["python     gcc13 c++17", ".github/workflows/linux.yml"], ["none     gcc12", ".github/workflows/linux.yml"], ["ruby     gcc c++11", ".github/workflows/linux.yml"], ["go  1.20   gcc c++14 gnu11", ".github/workflows/linux.yml"], ["none     gcc13", ".github/workflows/linux.yml"], ["guile     gcc13 c++17", ".github/workflows/linux.yml"], ["ruby  3.2   gcc c++11", ".github/workflows/linux.yml"], ["tcl     gcc c++14", ".github/workflows/linux.yml"], ["python  3.10   gcc", ".github/workflows/linux.yml"], ["c     gcc c++11", ".github/workflows/linux.yml"], ["ruby  2.3   gcc", ".github/workflows/linux.yml"], ["lua     gcc c++11", ".github/workflows/linux.yml"], ["ruby     gcc c++14", ".github/workflows/linux.yml"], ["javascript napi 20   gcc13 c++17", ".github/workflows/linux.yml"], ["python  3.9   gcc", ".github/workflows/linux.yml"], ["python     gcc13 c++20", ".github/workflows/linux.yml"], ["lua     gcc13 c++17", ".github/workflows/linux.yml"], ["java     gcc c++14", ".github/workflows/linux.yml"], ["csharp     gcc13 c++17", ".github/workflows/linux.yml"], ["CMake VS 17 2022", ".github/workflows/windows-cmake.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4859", "base_commit": "4f878a44cf7149757caaa89b7fa5964b3fb53153", "patch": "diff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex 41c21783f..38b2c954c 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -4048,7 +4048,7 @@ int MySQL_Session::get_pkts_from_client(bool& wrong_pass, PtrSize_t& pkt) {\n \t\t\t\t\t\t\t\t\tconst uint32_t recv_query_sz { pkt.size - 5 };\n \n \t\t\t\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_MYSQL_COM, 5, \"Processing received query\"\n-\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=%s query=%.*s\\n\",\n+\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=\\\"%s\\\" query=\\\"%.*s\\\"\\n\",\n \t\t\t\t\t\t\t\t\t\tthis, session_type, schemaname ? schemaname : \"\", recv_query_sz, recv_query\n \t\t\t\t\t\t\t\t\t);\n \t\t\t\t\t\t\t\t}\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex af6b7bb87..88890c456 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -1682,20 +1682,24 @@ bool ProxySQL_Admin::GenericRefreshStatistics(const char *query_no_space, unsign\n \t\t}\n \t\t//pthread_mutex_unlock(&admin_mutex);\n \t}\n-\tif (\n-\t\tstats_mysql_processlist || stats_mysql_connection_pool || stats_mysql_connection_pool_reset ||\n-\t\tstats_mysql_query_digest || stats_mysql_query_digest_reset || stats_mysql_errors ||\n-\t\tstats_mysql_errors_reset || stats_mysql_global || stats_memory_metrics || \n-\t\tstats_mysql_commands_counters || stats_mysql_query_rules || stats_mysql_users ||\n-\t\tstats_mysql_gtid_executed || stats_mysql_free_connections || \n-\t\tstats_pgsql_global || stats_pgsql_connection_pool || stats_pgsql_connection_pool_reset ||\n-\t\tstats_pgsql_free_connections || stats_pgsql_users || stats_pgsql_processlist ||\n-\t\tstats_pgsql_errors || stats_pgsql_errors_reset || stats_pgsql_query_rules || stats_pgsql_commands_counters ||\n-\t\tstats_pgsql_query_digest || stats_pgsql_query_digest_reset\n-\t) {\n-\t\tret = true;\n+\n+\tint freelist_count = statsdb->return_one_int(\"PRAGMA freelist_count\");\n+\tif (freelist_count < 1000) {\n+\t\tret = false;\n+\t} else {\n+\t\tint page_count  = statsdb->return_one_int(\"PRAGMA page_count\");\n+\t\tret = (freelist_count * 100 / page_count) > 20;\n+\n+#ifdef DEBUG\n+\t\tif (ret) {\n+\t\t\tproxy_debug(PROXY_DEBUG_ADMIN, 4,\n+\t\t\t\t\"VACUUM required for 'stats_db'   page_count=%d freelist_count=%d\\n\",\n+\t\t\t\tpage_count, freelist_count\n+\t\t\t);\n+\t\t}\n+#endif\n \t}\n-\t\n+\n \treturn ret;\n }\n \ndiff --git a/lib/ProxySQL_Admin_Stats.cpp b/lib/ProxySQL_Admin_Stats.cpp\nindex 6de28f52f..c6b477f93 100644\n--- a/lib/ProxySQL_Admin_Stats.cpp\n+++ b/lib/ProxySQL_Admin_Stats.cpp\n@@ -428,163 +428,170 @@ void ProxySQL_Admin::p_update_stmt_metrics() {\n \t}\n }\n \n+using row_bind_t = void (*)(int offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row);\n+\n+void sqlite3_bulk_step(\n+\tSQLite3DB* db,\n+\tsqlite3_stmt* row_stmt,\n+\tsqlite3_stmt* bulk_stmt,\n+\tSQLite3_result* resultset,\n+\trow_bind_t row_bind\n+) {\n+\tint max_bulk_row_idx = resultset->rows_count / 32;\n+\tmax_bulk_row_idx = max_bulk_row_idx * 32;\n+\n+\tint rc = 0;\n+\tint row_idx = 0;\n+\n+\tfor (SQLite3_row* row : resultset->rows) {\n+\t\tint e_idx = row_idx % 32;\n+\n+\t\tif (row_idx < max_bulk_row_idx) {\n+\t\t\trow_bind(e_idx, db, bulk_stmt, row);\n+\n+\t\t\tif (e_idx == 31) {\n+\t\t\t\tSAFE_SQLITE3_STEP2(bulk_stmt);\n+\t\t\t\trc = (*proxy_sqlite3_clear_bindings)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t\trc = (*proxy_sqlite3_reset)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t}\n+\t\t} else {\n+\t\t\trow_bind(0, db, row_stmt, row);\n+\n+\t\t\tSAFE_SQLITE3_STEP2(row_stmt);\n+\t\t\trc = (*proxy_sqlite3_clear_bindings)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\trc = (*proxy_sqlite3_reset)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t}\n+\n+\t\trow_idx += 1;\n+\t}\n+}\n+\n+void stats_mysql_global___bind_row(\n+\tint offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row\n+) {\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 1, row->fields[0], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 2, row->fields[1], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+}\n+\n+template <class...> constexpr std::false_type always_false {};\n+\n+template <typename T>\n+const void sqlite3_global_stats_row_step(\n+\tSQLite3DB* db, sqlite3_stmt* stmt, const char* name, T val\n+) {\n+\tchar buf[32] = { 0 };\n+\n+\tif constexpr (std::is_same_v<T, int32_t>)  {\n+\t\tsprintf(buf, \"%d\", val);\n+\t} else if constexpr (std::is_same_v<T, uint64_t>) {\n+\t\tsprintf(buf, \"%lu\", val);\n+\t} else if constexpr (std::is_same_v<T, unsigned long long>) {\n+\t\tsprintf(buf, \"%llu\", val);\n+\t} else if constexpr (std::is_same_v<T, bool>) {\n+\t\tsprintf(buf, \"%s\", val ? \"true\" : \"false\");\n+\t} else {\n+\t\tstatic_assert(always_false<T>, \"Non-exhaustive switch\");\n+\t}\n+\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, 1, name, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, 2, buf, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\n+\tSAFE_SQLITE3_STEP2(stmt);\n+\trc = (*proxy_sqlite3_clear_bindings)(stmt); ASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_reset)(stmt); ASSERT_SQLITE_OK(rc, db);\n+};\n+\n void ProxySQL_Admin::stats___mysql_global() {\n \tif (!GloMTH) return;\n \tSQLite3_result * resultset=GloMTH->SQL3_GlobalStatus(true);\n \tif (resultset==NULL) return;\n+\n \tstatsdb->execute(\"BEGIN\");\n \tstatsdb->execute(\"DELETE FROM stats_mysql_global\");\n-\tchar *a=(char *)\"INSERT INTO stats_mysql_global VALUES (\\\"%s\\\",\\\"%s\\\")\";\n-\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\tSQLite3_row *r=*it;\n-\t\tint arg_len=0;\n-\t\tfor (int i=0; i<2; i++) {\n-\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t}\n-\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n+\n+\tconst string q_row_insert { \"INSERT INTO stats_mysql_global VALUES (?1, ?2)\" };\n+\tconst string q_bulk_insert {\n+\t\t\"INSERT INTO stats_mysql_global VALUES \" + generate_multi_rows_query(32, 2)\n+\t};\n+\n+\tsqlite3_stmt* row_stmt = nullptr;\n+\tint rc = statsdb->prepare_v2(q_row_insert.c_str(), &row_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\tsqlite3_stmt* bulk_stmt = nullptr;\n+\trc = statsdb->prepare_v2(q_bulk_insert.c_str(), &bulk_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\n+\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n+\n \tdelete resultset;\n \tresultset=NULL;\n \n \tresultset=MyHGM->SQL3_Get_ConnPool_Stats();\n+\n \tif (resultset) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n-\tint highwater;\n-\tint current;\n-\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n-\tchar bu[32];\n-\tchar *vn=NULL;\n-\tchar *query=NULL;\n-\tvn=(char *)\"SQLite3_memory_bytes\";\n-\tsprintf(bu,\"%d\",current);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tint highwater, current = 0;\n+\t\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"SQLite3_memory_bytes\", current);\n+\t}\n \n-\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n-\tvn=(char *)\"ConnPool_memory_bytes\";\n-\tsprintf(bu,\"%llu\",connpool_mem);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"ConnPool_memory_bytes\", connpool_mem);\n+\t}\n \n \tif (GloMyStmt) {\n-\t\tuint64_t stmt_client_active_unique = 0;\n-\t\tuint64_t stmt_client_active_total = 0;\n-\t\tuint64_t stmt_max_stmt_id = 0;\n-\t\tuint64_t stmt_cached = 0;\n-\t\tuint64_t stmt_server_active_unique = 0;\n-\t\tuint64_t stmt_server_active_total = 0;\n-\t\tGloMyStmt->get_metrics(&stmt_client_active_unique,&stmt_client_active_total,&stmt_max_stmt_id,&stmt_cached,&stmt_server_active_unique,&stmt_server_active_total);\n-\t\tvn=(char *)\"Stmt_Client_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Client_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Max_Stmt_id\";\n-\t\tsprintf(bu,\"%lu\",stmt_max_stmt_id);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Cached\";\n-\t\tsprintf(bu,\"%lu\",stmt_cached);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tuint64_t client_active_unique = 0;\n+\t\tuint64_t client_active_total = 0;\n+\t\tuint64_t max_stmt_id = 0;\n+\t\tuint64_t cached = 0;\n+\t\tuint64_t server_active_unique = 0;\n+\t\tuint64_t server_active_total = 0;\n+\n+\t\tGloMyStmt->get_metrics(\n+\t\t\t&client_active_unique,\n+\t\t\t&client_active_total,\n+\t\t\t&max_stmt_id,\n+\t\t\t&cached,\n+\t\t\t&server_active_unique,\n+\t\t\t&server_active_total\n+\t\t);\n+\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Total\", client_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Unique\", client_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Total\", server_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Unique\", server_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Max_Stmt_id\", max_stmt_id);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Cached\", cached);\n \t}\n \n \tif (GloMyQC && (resultset= GloMyQC->SQL3_getStats())) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n \tif (GloMyLdapAuth) {\n \t\tresultset=GloMyLdapAuth->SQL3_getStats();\n-\t\tif (resultset) {\n-\t\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\t\tSQLite3_row *r=*it;\n-\t\t\t\tint arg_len=0;\n-\t\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t\t}\n-\t\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\t\tstatsdb->execute(query);\n-\t\t\t\tfree(query);\n-\t\t\t}\n-\t\t\tdelete resultset;\n-\t\t\tresultset=NULL;\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t}\n \n \tif (GloMyQPro) {\n \t\tunsigned long long mu = GloMyQPro->get_new_req_conns_count();\n-\t\tvn=(char *)\"new_req_conns_count\";\n-\t\tsprintf(bu,\"%llu\",mu);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n-\t{\n-\t\tvn=(char *)\"mysql_listener_paused\";\n-\t\tsprintf(bu, \"%s\", ( admin_proxysql_mysql_paused==true ? \"true\" : \"false\") );\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"new_req_conns_count\", mu);\n \t}\n+\n+\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"mysql_listener_paused\", admin_proxysql_mysql_paused);\n+\n \tstatsdb->execute(\"COMMIT\");\n }\n \n", "test_patch": "diff --git a/test/tap/tap/utils.cpp b/test/tap/tap/utils.cpp\nindex 5821da27e..e6f27fc0f 100644\n--- a/test/tap/tap/utils.cpp\n+++ b/test/tap/tap/utils.cpp\n@@ -1114,8 +1114,11 @@ int get_proxysql_cpu_usage(const CommandLine& cl, double& cpu_usage, uint32_t in\n \t\tsleep(1);\n \t}\n \n-\tMYSQL_QUERY(admin, \"SELECT * FROM system_cpu ORDER BY timestamp DESC LIMIT 2\");\n-\tMYSQL_RES* admin_res = mysql_store_result(admin);\n+\tMYSQL_QUERY(admin, \"SELECT * FROM system_cpu ORDER BY timestamp DESC LIMIT 5\");\n+\tMYSQL_RES* admin_res { mysql_store_result(admin) };\n+\tconst string sys_cpu_str { dump_as_table(admin_res) };\n+\tdiag(\"Dumping latest 5 entries from 'system_cpu':\\n%s\", sys_cpu_str.c_str());\n+\n \tMYSQL_ROW row = mysql_fetch_row(admin_res);\n \n \tdouble s_clk = (1000.0 / sysconf(_SC_CLK_TCK));\n", "problem_statement": "Prevent unnecessary `VACUUM` executions for SQLite3 `stats` database\n## Description\n\nWhile profiling several queries commonly received by Admin targeting `stats` database, like queries from other `ProxySQL` instances regarding `Cluster`, it was found that one of the biggest contributions to CPU utilization for serving those queries is a `VACUUM` that is performed after the query execution.\n\nMany times this `VACUUM` is performed after queries that are idempotent on tables that won't benefit at all of this subsequent operation. This is an extract of a `perf` report:\n\n- Query: `SELECT Variable_Name, Variable_Value FROM stats_mysql_global`\n- Report extract:\n  ```\n  -   88.56%     0.01%  Admin            proxysql              [.] void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n     - 88.55% void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n        + 45.64% ProxySQL_Admin::vacuum_stats(bool)\n        + 32.01% SQLite3DB::execute_statement(char const*, char**, int*, int*, SQLite3_result**)\n        + 9.94% ProxySQL_Admin::GenericRefreshStatistics(char const*, unsigned int, bool)\n        + 0.87% SQLite3_result::~SQLite3_result()\n  ```\n\nThese `VACUUM` operations should be more selective, or performed when the database is going to benefit of the operation.\n", "hints_text": "", "created_at": "2025-03-08 14:35:02", "merge_commit_sha": "a9bdf5462a20ef3d69a126ff94d5211cc3087f76", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["CI-builds / builds (ubuntu22,-tap-asan)", ".github/workflows/CI-trigger.yml"], ["CI-builds / builds (opensuse15,-clang)", ".github/workflows/CI-trigger.yml"], ["CI-builds / builds (debian12,)", ".github/workflows/CI-trigger.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4605", "base_commit": "01d1fc9828a5da09896acd2287be48335bbc1ada", "patch": "diff --git a/include/set_parser.h b/include/set_parser.h\nindex 5421868342..bd89bbab22 100644\n--- a/include/set_parser.h\n+++ b/include/set_parser.h\n@@ -42,6 +42,12 @@ class SetParser {\n \t// First implemenation of the parser for TRANSACTION ISOLATION LEVEL and TRANSACTION READ/WRITE\n \tstd::map<std::string, std::vector<std::string>> parse2();\n \tstd::string parse_character_set();\n+\tstd::string parse_USE_query();\n+\tstd::string remove_comments(const std::string& q);\n+#ifdef DEBUG\n+\t// built-in testing\n+\tvoid test_parse_USE_query();\n+#endif // DEBUG\n \t~SetParser();\n };\n \ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex b40d922539..42930c9b92 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -6138,30 +6138,27 @@ void MySQL_Session::handler___status_WAITING_CLIENT_DATA___STATE_SLEEP___MYSQL_C\n \tif (session_type == PROXYSQL_SESSION_MYSQL) {\n \t\t__sync_fetch_and_add(&MyHGM->status.frontend_use_db, 1);\n \t\tstring nq=string((char *)pkt->ptr+sizeof(mysql_hdr)+1,pkt->size-sizeof(mysql_hdr)-1);\n-\t\tRE2::GlobalReplace(&nq,(char *)\"(?U)/\\\\*.*\\\\*/\",(char *)\" \");\n-\t\tchar *sn_tmp = (char *)nq.c_str();\n-\t\twhile (sn_tmp < ( nq.c_str() + nq.length() - 4 ) && *sn_tmp == ' ')\n-\t\t\tsn_tmp++;\n-\t\t//char *schemaname=strdup(nq.c_str()+4);\n-\t\tchar *schemaname=strdup(sn_tmp+3);\n-\t\tchar *schemanameptr=trim_spaces_and_quotes_in_place(schemaname);\n-\t\t// handle cases like \"USE `schemaname`\n-\t\tif(schemanameptr[0]=='`' && schemanameptr[strlen(schemanameptr)-1]=='`') {\n-\t\t\tschemanameptr[strlen(schemanameptr)-1]='\\0';\n-\t\t\tschemanameptr++;\n-\t\t}\n-\t\tclient_myds->myconn->userinfo->set_schemaname(schemanameptr,strlen(schemanameptr));\n-\t\tfree(schemaname);\n-\t\tif (mirror==false) {\n+\t\tSetParser parser(nq);\n+\t\tstring schemaname = parser.parse_USE_query();\n+\t\tif (schemaname != \"\") {\n+\t\t\tclient_myds->myconn->userinfo->set_schemaname((char *)schemaname.c_str(),schemaname.length());\n+\t\t\tif (mirror==false) {\n+\t\t\t\tRequestEnd(NULL);\n+\t\t\t}\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tunsigned int nTrx=NumActiveTransactions();\n+\t\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n+\t\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n+\t\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n+\t\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n+\t\t} else {\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tstd::string msg = \"Unable to parse: \" + nq;\n+\t\t\tclient_myds->myprot.generate_pkt_ERR(true,NULL,NULL,client_myds->pkt_sid+1,1148,(char *)\"42000\", msg.c_str());\n \t\t\tRequestEnd(NULL);\n \t\t}\n-\t\tl_free(pkt->size,pkt->ptr);\n-\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n-\t\tunsigned int nTrx=NumActiveTransactions();\n-\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n-\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n-\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n-\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n \t\tclient_myds->DSS=STATE_SLEEP;\n \t} else {\n \t\tl_free(pkt->size,pkt->ptr);\ndiff --git a/lib/set_parser.cpp b/lib/set_parser.cpp\nindex 521808d642..7abef9adf1 100644\n--- a/lib/set_parser.cpp\n+++ b/lib/set_parser.cpp\n@@ -3,9 +3,11 @@\n #include <string>\n #include <vector>\n #include <map>\n-#ifdef PARSERDEBUG\n+#include <cassert>\n+#include <utility> // for std::pair\n+//#ifdef PARSERDEBUG\n #include <iostream>\n-#endif\n+//#endif\n \n using namespace std;\n \n@@ -506,3 +508,148 @@ std::string SetParser::parse_character_set() {\n \treturn value4;\n }\n \n+std::string SetParser::parse_USE_query() {\n+#ifdef DEBUG\n+\tproxy_debug(PROXY_DEBUG_MYSQL_QUERY_PROCESSOR, 4, \"Parsing query %s\\n\", query.c_str());\n+#endif // DEBUG\n+\n+\tre2::RE2::Options opt2(RE2::Quiet);\n+\topt2.set_case_sensitive(false);\n+\topt2.set_longest_match(false);\n+\n+\tstd::string dbname = remove_comments(query);\n+\tre2::RE2 re0(\"^\\\\s*\", opt2);\n+\tre2::RE2::Replace(&dbname, re0, \"\");\n+\tif (dbname.size() >= 4) {\n+\t\tif (\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE \",4) == 0\n+\t\t\t||\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE`\",4) == 0\n+\t\t) {\n+\t\t\tre2::RE2 re1(\"^USE\\\\s*\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re1, \"\");\n+\t\t\tre2::RE2 re2(\"\\\\s*$\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re2, \"\");\n+\t\t\tif (dbname[0] == '`') {\n+\t\t\t\tif (dbname.length() > 2) {\n+\t\t\t\t\tif (dbname[dbname.length()-1] == '`') {\n+\t\t\t\t\t\t// Remove the first character\n+\t\t\t\t\t\tdbname.erase(0, 1);\n+\t\t\t\t\t\t// Remove the last character\n+\t\t\t\t\t\tdbname.erase(dbname.length() - 1);\n+\t\t\t\t\t\treturn dbname;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\treturn dbname;\n+\t\t\t}\n+\t\t}\n+\t} else {\n+\t\treturn \"\";\n+\t}\n+\n+\treturn \"\";\n+}\n+\n+\n+std::string SetParser::remove_comments(const std::string& q) {\n+    std::string result = \"\";\n+    bool in_multiline_comment = false;\n+\n+    for (size_t i = 0; i < query.size(); ++i) {\n+        char current_char = query[i];\n+\n+        // Check for multiline comment start\n+        if (current_char == '/' && i + 1 < query.size() && query[i + 1] == '*') {\n+            in_multiline_comment = true;\n+            i++; // Skip the '*'\n+            continue;\n+        }   \n+\n+        // Check for multiline comment end\n+        if (in_multiline_comment && current_char == '*' && i + 1 < query.size() && query[i + 1] == '/') {\n+            in_multiline_comment = false;\n+            i++; // Skip the '/'\n+            continue;\n+        }   \n+\n+        // Skip characters inside multiline comment\n+        if (in_multiline_comment) {\n+            continue;\n+        }\n+\n+        // Check for single-line comments\n+        if (current_char == '#' || (current_char == '-' && i + 1 < query.size() && query[i + 1] == '-')) {\n+            // Skip until the end of the line\n+            while (i < query.size() && query[i] != '\\n') {\n+                i++;\n+            }\n+            continue;\n+        }\n+\n+        // Append the character to the result if it's not a comment\n+        result += current_char;\n+    }\n+\n+    return result;\n+}\n+\n+\n+#ifdef DEBUG\n+void SetParser::test_parse_USE_query() {\n+\n+\t// Define vector of pairs (query, expected dbname)\n+\tstd::vector<std::pair<std::string, std::string>> testCases = {\n+\t\t{\"USE my_database\",    \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database\",  \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database \", \"my_database\"},                   // Basic Case\n+\t\t{\"/* comment */USE dbname /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */   USE   dbname\",            \"dbname\"}, // With Comments\n+\t\t{\"USE    dbname           /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */USE `dbname` /* comment */\", \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE`dbname` /* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment */\", \"dbname\"}, // Multiline Comment\n+\t\t{\"/* comment */USE dbname # comment\",       \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname -- comment\",      \"dbname\"}, // Double Dash Comment\n+\t\t{\"/* comment */USE dbname   # comment\",     \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname    -- comment\",   \"dbname\"}, // Double Dash Comment\n+\t\t{\"USE dbname   # comment\",                  \"dbname\"}, // Hash Comment\n+\t\t{\"USE dbname    -- comment\",                \"dbname\"}, // Double Dash Comment\n+\t\t{\"SELECT * FROM my_table\", \"\"}, // No match\n+\t\t{\"/*+ placeholder_comment */ USE test_use_comment\", \"test_use_comment\"},\n+\n+\t\t{\"USE /*+ placeholder_comment */ `test_use_comment-a1`\",  \"test_use_comment-a1\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment_1`\", \"test_use_comment_1\"},\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment_2`\",    \"test_use_comment_2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment_3`\",    \"test_use_comment_3\"},\n+\t\t{\"USE /*+ placeholder_comment */   test_use_comment_4\",   \"test_use_comment_4\"},\n+\t\t{\"USE/*+ placeholder_comment */ test_use_comment_5\",      \"test_use_comment_5\"},\n+\t\t{\"USE /*+ placeholder_comment */test_use_comment_6\",      \"test_use_comment_6\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment-1`\", \"test_use_comment-1\"},\n+\t\t{\"use my_database\", \"my_database\"},\n+\t\t{\"/* comment */  use dbname -- comment\",        \"dbname\"},\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment\\nmultiline comment */\", \"dbname\"}, // Multiline Comment\n+\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment-2`\",      \"test_use_comment-2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment-3`\",      \"test_use_comment-3\"},\n+\t\t{\"/*+ placeholder_comment */USE      `test_use_comment-4`\", \"test_use_comment-4\"},\n+\t\t{\"USE/*+ placeholder_comment */`test_use_comment-5`\",       \"test_use_comment-5\"},\n+\t\t{\"/* comment */USE`test_use_comment-6`\",                    \"test_use_comment-6\"},\n+\t\t{\"USE`test_use_comment-7`\",                                 \"test_use_comment-7\"},\n+\t};\n+\n+\t// Run tests for each pair\n+\tfor (const auto& p : testCases) {\n+\t\tset_query(p.first);\n+\t\tstd::string dbname = parse_USE_query();\n+\t\tif (dbname != p.second) {\n+\t\t\t// we call parse_USE_query() again just to make it easier to create a breakpoint\n+\t\t\tstd::string s = parse_USE_query();\n+\t\t\tassert(s == p.second);\n+\t\t}\n+\t}\n+\n+}\n+#endif // DEBUG\ndiff --git a/src/main.cpp b/src/main.cpp\nindex c30a6bd999..d98743a604 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1976,6 +1976,13 @@ int main(int argc, const char * argv[]) {\n //\t\tstd::cerr << \"Main init phase0 completed in \";\n #endif\n \t}\n+#ifdef DEBUG\n+\t{\n+\t\t// Automated testing\n+\t\tSetParser parser(\"\");\n+\t\tparser.test_parse_USE_query();\n+\t}\n+#endif // DEBUG\n \t{\n \t\tcpu_timer t;\n \t\tProxySQL_Main_process_global_variables(argc, argv);\n", "test_patch": "", "problem_statement": "Not ignoring comments on \"use database\" statements\nI find that the following works as expected:\r\n\r\n    use db /* COMMENT */\r\n\r\nit will connect to the database `db`.\r\n\r\nHowever, if there is a newline in the comment:\r\n\r\n    use db /*\r\n       COMMENT */\r\n\r\nit will try to switch to the database `db /* COMMENT */`, which obviously not what should happen. \r\n\r\nThe other types of comment aren't ignored either:\r\n\r\n    use db -- COMMENT\r\n    use db # COMMENT\r\n\r\nresult in attempts to switch to database `db -- COMMENT` and `db # COMMENT`.\r\n\r\nI have not seen this issue with other statements than the `use` statement, but I haven't done an exhaustive search.\n", "hints_text": "Hi @Abigail,\r\n\r\nthe issue template is not a form to scrap and replace with free-writing. There are several details required to follow up on this, all of them missing, but that would be present if the template was filled. When opening an issue, please, at least make sure the points on the issue template are filled.\r\n\r\nThanks, Javier.\nSorry, I don't know all the details being asked.\r\n\r\nYou can just ignore my bug report, or, alternatively, investigate the regexp on line 6139 of `lib/MySQL_Session.cpp`. The regexp is:\r\n```\r\n     /\\\\*.*\\\\*/\r\n```\r\nwhich is problematic in three ways:\r\n1. `.` matches any character, but a newline.\r\n2. The regexp is too greedy, meaning that if you have two comments on the same line (like `SQL1 /* comment */ SQL2 /* comment */`) it replaces the code between the comments (replacing `/* comment */ SQL2 /* comment */` by a space).\r\n3. It doesn't match `-- ` or `#` style comments.\r\n\r\nMay I suggest something like\r\n```\r\n     (?:(?:#|--(?=\\s))[^\\n]*\\n|/\\*(?:(?>[^*]+)|\\*(?!/))*(?:;|\\*/))\r\n```\r\ninstead?\nHi @Abigail,\r\n\r\n> You can just ignore my bug report, or, alternatively, investigate the regexp on line 6139 of lib/MySQL_Session.cpp. The regexp is:\r\n\r\nWhat an interesting wording you used, I find myself at a crossroads, only two ways ahead! I understand this is your *not so nice* way of presenting your findings. Let me be clear, my request was not because there was the need of extra info for a regular contributor to find the **obvious** cause of the behavior, or to change a simple regex, into a **sightly** more complex one. A couple of `git blames` would tell you that the change was intentional, and that the behavior is well known, and was changed like this by design for the time being. Giving you more context, for several parsing related issues, we solve the most common and pressing cases, and (this has changed overtime) we might take a different approach for fixing these kind of parsing issues all together, or *maybe*, while waiting for this more ideal solution, we might use more complex regexes (like the one you provided).\r\n\r\nThe point of asking those details, as you can probably guess, is procedural. Those details are generic, and help with issue categorization, even without knowledge of the codebase, something that universal and common to all projects (even outside software). So please, just for the sake of curiosity, and maybe improving the template, which one of this highly technical details, was not possible to share?\r\n\r\n```\r\nIf you are submitting a reproducible bug report, please provide:\r\n- [ ] A clear description of the issue  // you already did this\r\n- [ ] ProxySQL version // ??\r\n- [ ] OS version // ??\r\n- [ ] The steps to reproduce the issue // ??\r\n- [ ] The **full** ProxySQL error log (default location: `/var/lib/proxysql/proxysql.log`) // copy paste?\r\n```\r\n\r\nRegards, Javier.", "created_at": "2024-08-12 20:26:45", "merge_commit_sha": "050907efa9e537dc9b9e6d3b3f777d384a589df8", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["builds (testreadonly)", ".github/workflows/CI-maketest.yml"], ["select (ubuntu22-tap, mysql57)", ".github/workflows/CI-taptests-groups.yml"], ["builds (testaurora)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (debian11)", ".github/workflows/CI-builds.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-laravel-framework.yml"], ["builds (testall)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-mysql-connector-j.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (testgalera)", ".github/workflows/CI-maketest.yml"], ["Analyze (ubuntu22-tap, python)", ".github/workflows/CI-codeql.yml"], ["builds (ubuntu16)", ".github/workflows/CI-builds.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-basictests.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-selftests.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-php-pdo-mysql.yml"], ["test (debian11, mariadb10)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (ubuntu22, -clang)", ".github/workflows/CI-builds.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-django-framework.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4588", "base_commit": "27e71d29729c67cbaf6beafcb3a3b4eeca7ab9b4", "patch": "diff --git a/include/MySQL_Variables.h b/include/MySQL_Variables.h\nindex 678d594a06..4d0aa5c8a9 100644\n--- a/include/MySQL_Variables.h\n+++ b/include/MySQL_Variables.h\n@@ -20,6 +20,7 @@ bool update_server_variable(MySQL_Session* session, int idx, int &_rc);\n bool verify_server_variable(MySQL_Session* session, int idx, uint32_t client_hash, uint32_t server_hash);\n bool verify_set_names(MySQL_Session* session);\n bool logbin_update_server_variable(MySQL_Session* session, int idx, int &_rc);\n+bool is_perm_track_err(int err, const char* varname);\n \n class MySQL_Variables {\n \tstatic verify_var verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/include/proxysql.h b/include/proxysql.h\nindex 90c881d414..8b6d1d4d50 100644\n--- a/include/proxysql.h\n+++ b/include/proxysql.h\n@@ -117,6 +117,10 @@ void proxy_info_(const char* msg, ...);\n #ifdef DEBUG\n void init_debug_struct();\n void init_debug_struct_from_cmdline();\n+/**\n+ * @brief Add a debug entry in the error log. To be used through 'proxy_debug' macro.\n+ * @details This function saves/restores the previous 'errno' value.\n+ */\n __attribute__((__format__ (__printf__, 7, 8)))\n void proxy_debug_func(enum debug_module, int, int, const char *, int, const char *, const char *, ...);\n void proxy_debug_get_filters(std::set<std::string>&);\ndiff --git a/include/proxysql_structs.h b/include/proxysql_structs.h\nindex f3d322305c..deac187de0 100644\n--- a/include/proxysql_structs.h\n+++ b/include/proxysql_structs.h\n@@ -277,6 +277,11 @@ typedef struct {\n \tchar * default_value;       // default value\n \tbool is_global_variable;\t// is it a global variable?\n } mysql_variable_st;\n+\n+typedef struct {\n+\tint err;\n+\tconst char* name;\n+} var_track_err_st;\n #endif\n \n enum mysql_data_stream_status {\n@@ -1218,10 +1223,9 @@ mysql_variable_st mysql_tracked_variables[] {\n \tsession_track_system_variables\n \tsession_track_transaction_info\n \t*/\n-\n-\n };\n #else\n extern mysql_variable_st mysql_tracked_variables[];\n+extern var_track_err_st perm_track_errs[];\n #endif // PROXYSQL_EXTERN\n #endif // MYSQL_TRACKED_VARIABLES\ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex ae306e36e4..b40d922539 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -2974,6 +2974,8 @@ bool MySQL_Session::handler_again___status_SETTING_GENERIC_VARIABLE(int *_rc, co\n \t\t\t\t\t(myerr == 1193) // variable is not found\n \t\t\t\t\t||\n \t\t\t\t\t(myerr == 1651) // Query cache is disabled\n+\t\t\t\t\t||\n+\t\t\t\t\t(is_perm_track_err(myerr, var_name)) // Special permitted tracking errors (~= '1193')\n \t\t\t\t) {\n \t\t\t\t\tint idx = SQL_NAME_LAST_HIGH_WM;\n \t\t\t\t\tfor (int i=0; i<SQL_NAME_LAST_HIGH_WM; i++) {\ndiff --git a/lib/MySQL_Variables.cpp b/lib/MySQL_Variables.cpp\nindex 6f5c1f0481..c0df467820 100644\n--- a/lib/MySQL_Variables.cpp\n+++ b/lib/MySQL_Variables.cpp\n@@ -9,6 +9,7 @@\n #endif\n \n #include <sstream>\n+#include \"mysqld_error.h\"\n \n \n static inline char is_digit(char c) {\n@@ -17,6 +18,23 @@ static inline char is_digit(char c) {\n \treturn 0;\n }\n \n+var_track_err_st perm_track_errs[] {\n+\t// ERROR 1210 (HY000): Variable not supported in combination with Galera:\n+\t// - Changed by MySQL, previously 'ER_UNKNOWN_SYSTEM_VARIABLE'\n+\t{ ER_WRONG_ARGUMENTS, \"sql_generate_invisible_primary_key\" }\n+};\n+\n+bool is_perm_track_err(int err, const char* varname) {\n+\tconst size_t count = sizeof(perm_track_errs) / sizeof(var_track_err_st);\n+\n+\tfor (size_t i = 0; i < count; i++) {\n+\t\tif (perm_track_errs[i].err == err && (strcasecmp(varname, perm_track_errs[i].name) == 0)) {\n+\t\t\treturn true;\n+\t\t}\n+\t}\n+\treturn false;\n+}\n+\n #include \"proxysql_find_charset.h\"\n \n verify_var MySQL_Variables::verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex a98d7669db..709ae3492b 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -153,7 +153,8 @@ static void BQE1(SQLite3DB *db, const vector<string>& tbs, const string& p1, con\n }\n \n \n-static int round_intv_to_time_interval(int& intv) {\n+static int round_intv_to_time_interval(const char* name, int _intv) {\n+\tint intv = _intv;\n \tif (intv > 300) {\n \t\tintv = 600;\n \t} else {\n@@ -181,6 +182,9 @@ static int round_intv_to_time_interval(int& intv) {\n \t\t\t}\n \t\t}\n \t}\n+\tif (intv != _intv) {\n+\t\tproxy_warning(\"Variable '%s' rounded to interval '%d'\\n\", name, intv);\n+\t}\n \treturn intv;\n }\n \n@@ -8686,7 +8690,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connection_pool\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connection_pool=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connection_pool=intv;\n \t\t\t\treturn true;\n@@ -8697,7 +8701,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connections\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connections=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connections=intv;\n \t\t\t\treturn true;\n@@ -8708,7 +8712,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_query_cache\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_query_cache=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_query_cache=intv;\n \t\t\t\treturn true;\n@@ -8729,7 +8733,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_cpu\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_cpu=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_cpu=intv;\n \t\t\t\treturn true;\n@@ -8741,7 +8745,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_memory\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_memory=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_memory=intv;\n \t\t\t\treturn true;\ndiff --git a/lib/debug.cpp b/lib/debug.cpp\nindex e4eda648f5..4f3755c9c0 100644\n--- a/lib/debug.cpp\n+++ b/lib/debug.cpp\n@@ -131,15 +131,22 @@ void proxy_debug_load_filters(std::set<std::string>& f) {\n \t//pthread_mutex_unlock(&debug_mutex);\n }\n \n+// REMINDER: This function should always save/restore 'errno', otherwise it could influence error handling.\n void proxy_debug_func(enum debug_module module, int verbosity, int thr, const char *__file, int __line, const char *__func, const char *fmt, ...) {\n+\tint saved_errno = errno;\n \tassert(module<PROXY_DEBUG_UNKNOWN);\n \tif (pretime == 0) { // never initialized\n \t\tpretime=realtime_time();\n \t}\n-\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity)\n+\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity) {\n+\t\terrno = saved_errno;\n \t\treturn;\n-\tif (filter_debug_entry(__file, __line, __func)) // check if the entry must be filtered\n+\t}\n+\t// check if the entry must be filtered\n+\tif (filter_debug_entry(__file, __line, __func)) {\n+\t\terrno = saved_errno;\n \t\treturn;\n+\t}\n \tchar origdebugbuff[DEBUG_MSG_MAXSIZE];\n \tchar debugbuff[DEBUG_MSG_MAXSIZE];\n \tchar longdebugbuff[DEBUG_MSG_MAXSIZE*8];\n@@ -243,6 +250,8 @@ void proxy_debug_func(enum debug_module module, int verbosity, int thr, const ch\n \tpthread_mutex_unlock(&debug_mutex);\n \tif (curtime != 0)\n \t\tpretime=curtime;\n+\n+\terrno = saved_errno;\n };\n #endif\n \ndiff --git a/lib/mysql_connection.cpp b/lib/mysql_connection.cpp\nindex 53b47cc7c4..8ae6a85f5c 100644\n--- a/lib/mysql_connection.cpp\n+++ b/lib/mysql_connection.cpp\n@@ -1252,6 +1252,14 @@ MDB_ASYNC_ST MySQL_Connection::handler(short event) {\n \t\t\t//if (parent->use_ssl) {\n \t\t\t{\n \t\t\t\t// mariadb client library disables NONBLOCK for SSL connections ... re-enable it!\n+\t\t\t\t// CONTEXT: This shouldn't be confused with the previous incompatibility that 'mariadbclient'\n+\t\t\t\t// had between the NONBLOCK flags and SSL connections, and that was reported and solved via\n+\t\t\t\t// CONC-320, our patch for this incompatibility was dropped on connector upgrade for v2.0.9.\n+\t\t\t\t// Setting the socket back to NONBLOCK is SAFE. This is because a connection can be used for\n+\t\t\t\t// BOTH blocking and not blocking calls, as described here:\n+\t\t\t\t// - https://mariadb.com/kb/en/using-the-non-blocking-library/#mixing-blocking-and-non-blocking-operation\n+\t\t\t\t// In case of SSL connections, it's still required to set the socket back to NONBLOCK prior to\n+\t\t\t\t// non-blockig calls.\n \t\t\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n \t\t\t\tint f=fcntl(mysql->net.fd, F_GETFL);\n #ifdef FD_CLOEXEC\ndiff --git a/lib/mysql_data_stream.cpp b/lib/mysql_data_stream.cpp\nindex 3ff6e5da44..a45e77dc93 100644\n--- a/lib/mysql_data_stream.cpp\n+++ b/lib/mysql_data_stream.cpp\n@@ -570,9 +570,7 @@ int MySQL_Data_Stream::read_from_net() {\n \n \tint r=0;\n \tint s=queue_available(queueIN);\n-\tif (encrypted) {\n-\t//\tproxy_info(\"Queue available of %d bytes\\n\", s);\n-\t}\n+\n \tif (encrypted == false) {\n \t\tif (pkts_recv) {\n \t\t\tr = recv(fd, queue_w_ptr(queueIN), s, 0);\n@@ -592,41 +590,24 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t}\n \t\t}\n \t} else { // encrypted == true\n-/*\n-\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\tint ret = SSL_do_handshake(ssl);\n-\t\t\tint ret2;\n-\t\t\tif (ret != 1) {\n-\t\t\t\t//ERR_print_errors_fp(stderr);\n-\t\t\t\tret2 = SSL_get_error(ssl, ret);\n-\t\t\t\tfprintf(stderr,\"%d\\n\",ret2);\n-\t\t\t}\n-\t\t\treturn 0;\n-\t\t} else {\n-\t\t\tr = SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t}\n-*/\n \t\tPROXY_TRACE();\n \t\tif (s < MY_SSL_BUFFER) {\n \t\t\treturn 0;\t// no enough space for reads\n \t\t}\n \t\tchar buf[MY_SSL_BUFFER];\n-\t\t//ssize_t n = read(fd, buf, sizeof(buf));\n-\t\tint n = recv(fd, buf, sizeof(buf), 0);\n-\t\t//proxy_info(\"SSL recv of %d bytes\\n\", n);\n-\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, n,  rbio_ssl->num_write , rbio_ssl->num_read);\n-\t\tif (n > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n-\t\t\t//on_read_cb(buf, (size_t)n);\n+\t\tint ssl_recv_bytes = recv(fd, buf, sizeof(buf), 0);\n+\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, ssl_recv_bytes,  rbio_ssl->num_write , rbio_ssl->num_read);\n \n+\t\tif (ssl_recv_bytes > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n \t\t\tchar buf2[MY_SSL_BUFFER];\n \t\t\tint n2;\n \t\t\tenum sslstatus status;\n \t\t\tchar *src = buf;\n-\t\t\tint len = n;\n+\t\t\tint len = ssl_recv_bytes;\n \t\t\twhile (len > 0) {\n \t\t\t\tn2 = BIO_write(rbio_ssl, src, len);\n \t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: write %d bytes into BIO %p, len=%d\\n\", sess, n2, rbio_ssl, len);\n-\t\t\t\t//proxy_info(\"BIO_write with len = %d and %d bytes\\n\", len , n2);\n+\n \t\t\t\tif (n2 <= 0) {\n \t\t\t\t\tshut_soft();\n \t\t\t\t\treturn -1;\n@@ -634,40 +615,29 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\tsrc += n2;\n \t\t\t\tlen -= n2;\n \t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished NOT completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\tif (do_ssl_handshake() == SSLSTATUS_FAIL) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished failed!!\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake failed   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\tshut_soft();\n \t\t\t\t\t\treturn -1;\n \t\t\t\t\t}\n \t\t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished yet NOT completed\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\treturn 0;\n \t\t\t\t\t}\n \t\t\t\t} else {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake finished   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t}\n \t\t\t}\n \t\t\tn2 = SSL_read (ssl, queue_w_ptr(queueIN), s);\n \t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from BIO %p into a buffer with %d bytes free\\n\", sess, n2, rbio_ssl, s);\n \t\t\tr = n2;\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n-\t\t\tif (n2 > 0) {\n-\t\t\t}\n-/*\n-\t\t\tdo {\n-\t\t\t\tn2 = SSL_read(ssl, buf2, sizeof(buf2));\n-\t\t\t\tif (n2 > 0) {\n-\t\t\t\t\t\n-\t\t\t\t}\n-\t\t\t} while (n > 0);\n-*/\n \t\t\tstatus = get_sslstatus(ssl, n2);\n-\t\t\t//proxy_info(\"SSL status = %d\\n\", status);\n+\n \t\t\tif (status == SSLSTATUS_WANT_IO) {\n \t\t\t\tdo {\n \t\t\t\t\tn2 = BIO_read(wbio_ssl, buf2, sizeof(buf2));\n-\t\t\t\t\t//proxy_info(\"BIO_read with %d bytes\\n\", n2);\n+\n \t\t\t\t\tif (n2 > 0) {\n           \t\t\t\tqueue_encrypted_bytes(buf2, n2);\n \t\t\t\t\t} else if (!BIO_should_retry(wbio_ssl)) {\n@@ -681,14 +651,18 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\treturn -1;\n \t\t\t}\n \t\t} else {\n-\t\t\tr = n;\n-\t\t\t//r += SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n+\t\t\t// Shutdown if we either received the EOF, or operation failed with non-retryable error.\n+\t\t\tif (ssl_recv_bytes==0 || (ssl_recv_bytes==-1 && errno != EINTR && errno != EAGAIN)) {\n+\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Received EOF, shutting down soft socket -- Session=%p, Datastream=%p\\n\", sess, this);\n+\t\t\t\tshut_soft();\n+\t\t\t\treturn -1;\n+\t\t\t}\n+\t\t\tr = ssl_recv_bytes;\n \t\t}\n \t}\n-//__exit_read_from_next:\n+\n \tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from fd %d into a buffer of %d bytes free\\n\", sess, r, fd, s);\n-\t//proxy_error(\"read %d bytes from fd %d into a buffer of %d bytes free\\n\", r, fd, s);\n+\n \tif (r < 1) {\n \t\tif (encrypted==false) {\n \t\t\tint myds_errno=errno;\n", "test_patch": "diff --git a/test/tap/tap/tap.cpp b/test/tap/tap/tap.cpp\nindex b067432a2d..5270516f87 100644\n--- a/test/tap/tap/tap.cpp\n+++ b/test/tap/tap/tap.cpp\n@@ -20,7 +20,6 @@\n \n #include \"tap.h\"\n \n-//#include \"my_global.h\"\n typedef char my_bool;\n \n #include <stdlib.h>\n@@ -28,8 +27,13 @@ typedef char my_bool;\n #include <stdio.h>\n #include <string.h>\n #include <signal.h>\n+#include <time.h>\n #include <unistd.h>\n \n+#include <sys/time.h>\n+\n+using std::size_t;\n+\n static ulong start_timer(void);\n static void end_timer(ulong start_time,char *buff);\n static void nice_time(double sec,char *buff,my_bool part_second);\n@@ -68,6 +72,34 @@ static TEST_DATA g_test = { NO_PLAN, 0, 0, \"\" };\n  */\n #define tapout stdout\n \n+/**\n+  @brief Writes current time (\"%Y-%m-%d %H:%M:%S\") in the supplied buffer.\n+\n+  @param tm_buf Buffer to be written.\n+  @param us True for enabling microseconds in log output.\n+  @param len Buffer len.\n+ */\n+size_t get_fmt_time(char* tm_buf, size_t len, bool us=false) {\n+  time_t __timer;\n+  time(&__timer);\n+  struct tm __tm_info {};\n+  localtime_r(&__timer, &__tm_info);\n+  size_t rc = strftime(tm_buf, len, \"%Y-%m-%d %H:%M:%S\", &__tm_info);\n+\n+  if (rc == 0) {\n+    return rc;\n+  } else if (us) {\n+    struct timeval tv;\n+    struct tm *tm_info;\n+\n+    gettimeofday(&tv, NULL);\n+    tm_info = localtime(&tv.tv_sec);\n+    rc = snprintf(tm_buf + rc, len - rc, \".%06ld\", tv.tv_usec);\n+  }\n+\n+  return rc;\n+}\n+\n /**\n   Emit the beginning of a test line, that is: \"(not) ok\", test number,\n   and description.\n@@ -85,9 +117,12 @@ static TEST_DATA g_test = { NO_PLAN, 0, 0, \"\" };\n static void\n vemit_tap(int pass, char const *fmt, va_list ap)\n {\n-  fprintf(tapout, \"%sok %d%s\",\n+  char tm_buf[28] = { 0 };\n+  get_fmt_time(tm_buf, sizeof(tm_buf), __sync_add_and_fetch(&tap_log_us, 0));\n+  fprintf(tapout, \"%sok %d - %s%s\",\n           pass ? \"\" : \"not \",\n           __sync_add_and_fetch(&g_test.last, 1),\n+          tm_buf,\n           (fmt && *fmt) ? \" - \" : \"\");\n   if (fmt && *fmt)\n     vfprintf(tapout, fmt, ap);\n@@ -156,7 +191,9 @@ diag(char const *fmt, ...)\n {\n   va_list ap;\n   va_start(ap, fmt);\n-  fprintf(tapout, \"# \");\n+  char tm_buf[28] = { 0 };\n+  get_fmt_time(tm_buf, sizeof(tm_buf), __sync_add_and_fetch(&tap_log_us, 0));\n+  fprintf(tapout, \"# %s  \", tm_buf);\n   vfprintf(tapout, fmt, ap);\n   emit_endl();\n   va_end(ap);\n@@ -192,6 +229,7 @@ static signal_entry install_signal[]= {\n };\n \n int skip_big_tests= 1;\n+volatile int tap_log_us = 1;\n ulong start_time= 0;\n \n void\ndiff --git a/test/tap/tap/tap.h b/test/tap/tap/tap.h\nindex 7678c1a390..f40dad0e9b 100644\n--- a/test/tap/tap/tap.h\n+++ b/test/tap/tap/tap.h\n@@ -78,6 +78,10 @@ extern \"C\" {\n    @see SKIP_BIG_TESTS\n */\n extern int skip_big_tests;\n+/**\n+ * @brief Specifies if time logging should include microseconds; either 1 or 0.\n+ */\n+extern volatile int tap_log_us;\n \n /**\n   @defgroup MyTAP_API MyTAP API\ndiff --git a/test/tap/tap/utils.cpp b/test/tap/tap/utils.cpp\nindex d55e3521c0..b192d9544f 100644\n--- a/test/tap/tap/utils.cpp\n+++ b/test/tap/tap/utils.cpp\n@@ -187,6 +187,45 @@ my_bool mysql_stmt_close_override(MYSQL_STMT* stmt, const char* file, int line)\n \n #endif\n \n+pair<int,vector<MYSQL*>> disable_core_nodes_scheduler(CommandLine& cl, MYSQL* admin) {\n+\tvector<MYSQL*> nodes_conns {};\n+\n+\tpair<int,vector<srv_addr_t>> nodes_fetch { fetch_cluster_nodes(admin, true) };\n+\tif (nodes_fetch.first) {\n+\t\tdiag(\"Failed to fetch cluster nodes. Aborting further testing\");\n+\t\treturn { EXIT_FAILURE, {} };\n+\t}\n+\n+\t// Ensure a more idle status for ProxySQL\n+\tfor (const srv_addr_t& node : nodes_fetch.second) {\n+\t\tconst char* user { cl.admin_username };\n+\t\tconst char* pass { cl.admin_password };\n+\n+\t\tMYSQL* myconn = mysql_init(NULL);\n+\n+\t\tif (!mysql_real_connect(myconn, node.host.c_str(), user, pass, NULL, node.port, NULL, 0)) {\n+\t\t\tdiag(\n+\t\t\t\t\"Failed to connect to Cluster node. Abort further testing\"\n+\t\t\t\t\"   host=%s port=%d errno=%d error='%s'\",\n+\t\t\t\tnode.host.c_str(), node.port, mysql_errno(myconn), mysql_error(myconn)\n+\t\t\t);\n+\t\t\treturn { EXIT_FAILURE, {} };\n+\t\t}\n+\n+\t\tconst vector<const char*> queries { \"DELETE FROM scheduler\", \"LOAD SCHEDULER TO RUNTIME\" };\n+\t\tfor (const char* q : queries) {\n+\t\t\tif (mysql_query_t(myconn, q)) {\n+\t\t\t\tdiag(\"Failed to execute query   query=%s error='%s'\", q, mysql_error(myconn));\n+\t\t\t\treturn { EXIT_FAILURE, {} };\n+\t\t\t}\n+\t\t}\n+\n+\t\tnodes_conns.push_back(myconn);\n+\t}\n+\n+\treturn { EXIT_SUCCESS, nodes_conns };\n+}\n+\n std::size_t count_matches(const string& str, const string& substr) {\n \tstd::size_t result = 0;\n \tstd::size_t pos = 0;\n@@ -199,8 +238,8 @@ std::size_t count_matches(const string& str, const string& substr) {\n \treturn result;\n }\n \n-int mysql_query_t(MYSQL* mysql, const char* query) {\n-\tdiag(\"%s: Issuing query '%s' to ('%s':%d)\", get_formatted_time().c_str(), query, mysql->host, mysql->port);\n+int mysql_query_t__(MYSQL* mysql, const char* query, const char* f, int ln, const char* fn) {\n+\tdiag(\"%s:%d:%s(): Issuing query '%s' to ('%s':%d)\", f, ln, fn, query, mysql->host, mysql->port);\n \treturn mysql_query(mysql, query);\n }\n \n@@ -946,20 +985,71 @@ string tap_curtime() {\n }\n \n int get_proxysql_cpu_usage(const CommandLine& cl, uint32_t intv, double& cpu_usage) {\n-\t// check if proxysql process is consuming higher cpu than it should\n+\t// Create Admin connection\n \tMYSQL* proxysql_admin = mysql_init(NULL);\n \tif (!mysql_real_connect(proxysql_admin, cl.host, cl.admin_username, cl.admin_password, NULL, cl.admin_port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxysql_admin));\n \t\treturn EXIT_FAILURE;\n \t}\n \n-\t// recover admin variables\n-\tstring set_stats_query { \"SET admin-stats_system_cpu=\" + std::to_string(intv) };\n+\t// Set new interval\n+\tconst string set_stats_query { \"SET admin-stats_system_cpu=\" + std::to_string(intv) };\n \tMYSQL_QUERY(proxysql_admin, set_stats_query.c_str());\n \tMYSQL_QUERY(proxysql_admin, \"LOAD ADMIN VARIABLES TO RUNTIME\");\n \n+\t// Wait until 'system_cpu' is filled with newer entries\n+\ttime_t curtime = time(NULL);\n+\tuint32_t entry_count { 0 };\n+\n+\tconst char runtime_stats[] {\n+\t\t\"SELECT variable_value FROM runtime_global_variables WHERE variable_name='admin-stats_system_cpu'\"\n+\t};\n+\text_val_t<int> ext_rintv { mysql_query_ext_val(proxysql_admin, runtime_stats, 10) };\n+\tif (ext_rintv.err != EXIT_SUCCESS) {\n+\t\tconst string err { get_ext_val_err(proxysql_admin, ext_rintv) };\n+\t\tdiag(\"Failed query   query:`%s`, err:`%s`\", runtime_stats, err.c_str());\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tif (ext_rintv.val != intv) {\n+\t\tdiag(\n+\t\t\t\"WARNING: Supplied interval not available, using rounded value   intv=%d rintv=%d\",\n+\t\t\tintv, ext_rintv.val\n+\t\t);\n+\t}\n+\n \t// sleep during the required interval + safe threshold\n-\tsleep(2 * intv + 2);\n+\tconst uint32_t init_wait = 2 * ext_rintv.val + 2;\n+\tdiag(\"Waiting for %d secs for new 'system_cpu' entries...   curtime=%ld\", init_wait, curtime);\n+\tsleep(init_wait);\n+\n+\tconst string count_query {\n+\t\t\"SELECT COUNT(*) FROM system_cpu WHERE timestamp > \" + std::to_string(curtime)\n+\t};\n+\text_val_t<int> ext_stats_count { mysql_query_ext_val(proxysql_admin, count_query, 10) };\n+\n+\tif (ext_stats_count.err != EXIT_SUCCESS) {\n+\t\tconst string err { get_ext_val_err(proxysql_admin, ext_stats_count) };\n+\t\tdiag(\"Failed query   query:`%s`, err:`%s`\", count_query.c_str(), err.c_str());\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tentry_count = ext_stats_count.val;\n+\tdiag(\"Finished initial wait for 'system_cpu'   entry_count=%d\", entry_count);\n+\n+\twhile (entry_count < 2) {\n+\t\tdiag(\"Waiting for more 'system_cpu' entries...   entry_count=%d\", entry_count);\n+\t\text_val_t<int> ext_stats_count { mysql_query_ext_val(proxysql_admin, count_query, 10) };\n+\n+\t\tif (ext_stats_count.err != EXIT_SUCCESS) {\n+\t\t\tconst string err { get_ext_val_err(proxysql_admin, ext_stats_count) };\n+\t\t\tdiag(\"Failed query   query:`%s`, err:`%s`\", count_query.c_str(), err.c_str());\n+\t\t\treturn EXIT_FAILURE;\n+\t\t}\n+\n+\t\tentry_count = ext_stats_count.val;\n+\t\tsleep(1);\n+\t}\n \n \tMYSQL_QUERY(proxysql_admin, \"SELECT * FROM system_cpu ORDER BY timestamp DESC LIMIT 2\");\n \tMYSQL_RES* admin_res = mysql_store_result(proxysql_admin);\n@@ -977,7 +1067,7 @@ int get_proxysql_cpu_usage(const CommandLine& cl, uint32_t intv, double& cpu_usa\n \tint init_stime_s = atoi(row[2]) * s_clk;\n \tint init_t_s = init_utime_s + init_stime_s;\n \n-\tcpu_usage = 100.0 * ((final_t_s - init_t_s) / (static_cast<double>(intv) * 1000));\n+\tcpu_usage = 100.0 * ((final_t_s - init_t_s) / (static_cast<double>(ext_rintv.val) * 1000));\n \n \t// free the result\n \tmysql_free_result(admin_res);\n@@ -1690,42 +1780,49 @@ pair<int,pool_state_t> fetch_conn_stats(MYSQL* admin, const vector<uint32_t> hgs\n \t}\n }\n \n-int wait_for_cond(MYSQL* mysql, const std::string& query, uint32_t timeout) {\n-\tint result = EXIT_FAILURE;\n+int check_cond(MYSQL* mysql, const string& q) {\n+\tdiag(\"Checking condition '%s' in ('%s':%d)\", q.c_str(), mysql->host, mysql->port);\n \n-\tauto start = std::chrono::system_clock::now();\n-\tstd::chrono::duration<double> elapsed {};\n+\tint rc = mysql_query(mysql, q.c_str());\n+\tint res = 1;\n \n-\twhile (elapsed.count() < timeout && result == EXIT_FAILURE) {\n-\t\tint rc = mysql_query(mysql, query.c_str());\n-\t\tfprintf(\n-\t\t\tstderr, \"# %s: Waiting for condition '%s' in ('%s':%d)\\n\",\n-\t\t\tget_formatted_time().c_str(), query.c_str(), mysql->host, mysql->port\n-\t\t);\n+\tif (rc == 0) {\n+\t\tMYSQL_RES* myres = mysql_store_result(mysql);\n \n-\t\tif (rc == EXIT_SUCCESS) {\n-\t\t\tMYSQL_RES* myres = mysql_store_result(mysql);\n-\t\t\tif (myres) {\n-\t\t\t\tuint32_t field_num = mysql_num_fields(myres);\n-\t\t\t\tuint32_t row_num = mysql_num_rows(myres);\n+\t\tif (myres) {\n+\t\t\tuint32_t field_num = mysql_num_fields(myres);\n+\t\t\tuint32_t row_num = mysql_num_rows(myres);\n \n-\t\t\t\tif (field_num == 1 && row_num == 1) {\n-\t\t\t\t\tMYSQL_ROW row = mysql_fetch_row(myres);\n+\t\t\tif (field_num == 1 && row_num == 1) {\n+\t\t\t\tMYSQL_ROW myrow = mysql_fetch_row(myres);\n \n-\t\t\t\t\tif (row && strcasecmp(\"TRUE\", row[0]) == 0) {\n-\t\t\t\t\t\tresult = EXIT_SUCCESS;\n-\t\t\t\t\t}\n+\t\t\t\tif (myrow && strcasecmp(\"TRUE\", myrow[0]) == 0) {\n+\t\t\t\t\tres = 0;\n+\t\t\t\t} else if (myrow && atoi(myrow[0]) >= 1) {\n+\t\t\t\t\tres = 0;\n \t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t} else {\n+\t\tdiag(\"Check failed with error '%s'\", mysql_error(mysql));\n+\t\tres = -1;\n+\t}\n \n-\t\t\t\tmysql_free_result(myres);\n+\treturn res;\n+}\n \n-\t\t\t\tif (result == EXIT_SUCCESS) {\n-\t\t\t\t\tbreak;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t} else {\n-\t\t\tdiag(\"Condition query failed with error: ('%d','%s')\", mysql_errno(mysql), mysql_error(mysql));\n-\t\t\tresult = EXIT_FAILURE;\n+int wait_for_cond(MYSQL* mysql, const string& q, uint32_t to) {\n+\tdiag(\"Waiting for condition '%s' in ('%s':%d)\", q.c_str(), mysql->host, mysql->port);\n+\n+\tint result = 1;\n+\tstd::chrono::duration<double> elapsed {};\n+\n+\tauto start = std::chrono::system_clock::now();\n+\n+\twhile (elapsed.count() < to && result == EXIT_FAILURE) {\n+\t\tresult = check_cond(mysql, q);\n+\n+\t\tif (result == 0 || result == -1) {\n \t\t\tbreak;\n \t\t}\n \n@@ -1738,6 +1835,74 @@ int wait_for_cond(MYSQL* mysql, const std::string& query, uint32_t timeout) {\n \treturn result;\n }\n \n+vector<check_res_t> wait_for_conds(MYSQL* mysql, const vector<string>& qs, uint32_t to) {\n+\tdiag(\"Waiting multiple conditions in ('%s':%d):\", mysql->host, mysql->port);\n+\tfor (const string& q : qs) {\n+\t\tdiag(\"  - cond: '%s'\", q.c_str());\n+\t}\n+\n+\tstd::chrono::duration<double> elapsed {};\n+\n+\tvector<check_res_t> res {};\n+\tstd::transform(qs.begin(), qs.end(), std::back_inserter(res),\n+\t\t[] (const string& q) {\n+\t\t\treturn check_res_t { 1, q };\n+\t\t}\n+\t);\n+\tauto start = std::chrono::system_clock::now();\n+\n+\twhile (elapsed.count() < to) {\n+\t\tint chk_res = 0;\n+\n+\t\tfor (std::size_t i = 0; i < qs.size(); i++) {\n+\t\t\tchk_res = check_cond(mysql, qs[i]);\n+\n+\t\t\tif (chk_res == -1) {\n+\t\t\t\tdiag(\"Error during query. Aborting further checks\");\n+\t\t\t\tres[i].first = -1;\n+\t\t\t\tbreak;\n+\t\t\t} else if (chk_res == 0) {\n+\t\t\t\tres[i].first = 0;\n+\t\t\t}\n+\t\t}\n+\n+\t\tint acc = std::accumulate(res.begin(), res.end(), size_t(0),\n+\t\t\t[] (size_t acc, const check_res_t& p) -> size_t {\n+\t\t\t\tif (p.first == 0) {\n+\t\t\t\t\treturn acc + 1;\n+\t\t\t\t} else {\n+\t\t\t\t\treturn acc;\n+\t\t\t\t}\n+\t\t\t});\n+\n+\t\tif (acc == qs.size() || chk_res == -1) {\n+\t\t\tbreak;\n+\t\t} else {\n+\t\t\tusleep(500 * 1000);\n+\t\t\tauto it_end = std::chrono::system_clock::now();\n+\t\t\telapsed = it_end - start;\n+\t\t}\n+\t}\n+\n+\treturn res;\n+}\n+\n+int proc_wait_checks(const vector<check_res_t>& chks) {\n+\tint res = 0;\n+\n+\tfor (const check_res_t& r : chks) {\n+\t\tif (r.first == -1) {\n+\t\t\tres = -1;\n+\t\t\tdiag(\"Waiting check FAILED to execute '%s'\", r.second.c_str());\n+\t\t} else if (r.first == 1)  {\n+\t\t\tres = res == 0 ? 1 : res;\n+\t\t\tdiag(\"Waiting check TIMEOUT '%s'\", r.second.c_str());\n+\t\t}\n+\t}\n+\n+\treturn res;\n+}\n+\n void check_conn_count(MYSQL* admin, const string& conn_type, uint32_t conn_num, int32_t hg) {\n \tconst string hg_s { to_string(hg) };\n \tconst string conn_num_s { to_string(conn_num) };\n@@ -1807,8 +1972,67 @@ void check_query_count(MYSQL* admin, vector<uint32_t> queries, uint32_t hg) {\n \t}\n };\n \n-const char* get_env_str(const char* envname, const char* envdefault) {\n+pair<int,vector<srv_addr_t>> fetch_cluster_nodes(MYSQL* admin, bool dump_fetch) {\n+\tint rc = mysql_query_t(admin, \"SELECT hostname,port FROM proxysql_servers\");\n+\tif (rc) { return { static_cast<int>(mysql_errno(admin)), {} }; }\n \n+\tMYSQL_RES* myres = mysql_store_result(admin);\n+\tif (myres == NULL) {\n+\t\tdiag(\"Storing resultset failed   error='%s'\", mysql_error(admin));\n+\t\treturn { static_cast<int>(mysql_errno(admin)), {} };\n+\t}\n+\n+\tif (dump_fetch) {\n+\t\tconst string res_table { dump_as_table(myres) };\n+\t\tdiag(\"Dumping fetched cluster nodes:\");\n+\n+\t\tprintf(\"%s\", res_table.c_str());\n+\t}\n+\n+\tvector<mysql_res_row> nodes_rows { extract_mysql_rows(myres) };\n+\tmysql_free_result(myres);\n+\n+\tvector<srv_addr_t> nodes {};\n+\tstd::transform(nodes_rows.begin(), nodes_rows.end(), std::back_inserter(nodes),\n+\t\t[] (const mysql_res_row& row) {\n+\t\t\treturn srv_addr_t { row[0], std::atoi(row[1].c_str()) };\n+\t\t}\n+\t);\n+\n+\treturn { 0, nodes };\n+}\n+\n+int check_nodes_sync(\n+\tconst CommandLine& cl, const vector<srv_addr_t>& nodes, const string& check, uint32_t to\n+) {\n+\tfor (const auto& node : nodes) {\n+\t\tMYSQL* admin = mysql_init(NULL);\n+\n+\t\tif (\n+\t\t\t!mysql_real_connect(\n+\t\t\t\tadmin, node.host.c_str(), cl.admin_username, cl.admin_password, NULL, node.port, NULL, 0\n+\t\t\t)\n+\t\t) {\n+\t\t\tdiag(\"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(admin));\n+\t\t\treturn EXIT_FAILURE;\n+\t\t}\n+\n+\t\tconst vector<check_res_t> wres { wait_for_conds(admin, { check }, to) };\n+\t\tint node_sync = proc_wait_checks(wres);\n+\n+\t\tif (node_sync != EXIT_SUCCESS) {\n+\t\t\tconst string err { \"Node '\" + node.host + \":\" + std::to_string(node.port) + \"' sync timed out\" };\n+\t\t\tdiag(\"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, err.c_str());\n+\t\t\treturn EXIT_FAILURE;\n+\t\t}\n+\n+\t\tmysql_close(admin);\n+\t}\n+\n+\treturn EXIT_SUCCESS;\n+}\n+\n+const char* get_env_str(const char* envname, const char* envdefault) {\n \tconst char* envval = std::getenv(envname);\n \n \tif (envval != NULL)\n@@ -1818,13 +2042,11 @@ const char* get_env_str(const char* envname, const char* envdefault) {\n };\n \n int get_env_int(const char* envname, int envdefault) {\n-\n \tconst char* envval = std::getenv(envname);\n \tint res = envdefault;\n \n \tif (envval != NULL)\n \t\tres = strtol(envval, NULL, 0);\n-//\tdiag(\"%s: %s='%s' >>> %d\", __FUNCTION__, envname, envval, res);\n \n \treturn res;\n };\n@@ -1852,7 +2074,5 @@ bool get_env_bool(const char* envname, bool envdefault) {\n \t\t}\n \t}\n \n-//\tdiag(\"%s: %s='%s' >>> %d\", __FUNCTION__, envname, envval, res);\n-\n \treturn (bool) res;\n };\ndiff --git a/test/tap/tap/utils.h b/test/tap/tap/utils.h\nindex 0b918b0d06..d88182442b 100644\n--- a/test/tap/tap/utils.h\n+++ b/test/tap/tap/utils.h\n@@ -56,6 +56,18 @@ my_bool mysql_stmt_close_override(MYSQL_STMT* stmt, const char* file, int line);\n \n #endif \n \n+/**\n+ * @brief Helper function to disable Core nodes scheduler from ProxySQL Cluster nodes.\n+ * @details In the CI environment, 'Scheduler' is used to induce extra load via Admin interface on\n+ *  all the cluster nodes. Disabling this allows for more accurate measurements on the primary.\n+ * @param cl CommandLine arguments supplied to the test.\n+ * @param admin Already opened Admin conn to the primary instance.\n+ * @return On success, the opened Admin connections to the Core nodes used to change their config,\n+ *  these conns should later be used to restore their original config. On failure, a pair of shape\n+ *  '{ EXIT_FAILURE, {} }'.\n+ */\n+std::pair<int,std::vector<MYSQL*>> disable_core_nodes_scheduler(CommandLine& cl, MYSQL* admin);\n+\n inline std::string get_formatted_time() {\n \ttime_t __timer;\n \tchar __buffer[30];\n@@ -68,7 +80,18 @@ inline std::string get_formatted_time() {\n \treturn std::string(__buffer);\n }\n \n-int mysql_query_t(MYSQL* mysql, const char* query);\n+/**\n+ * @brief Wrapper for 'mysql_query' with logging for convenience.\n+ * @details Should be used through 'mysql_query_t' macro.\n+ * @return Result of calling 'mysql_query'.\n+ */\n+int mysql_query_t__(MYSQL* mysql, const char* query, const char* f, int ln, const char* fn);\n+\n+/**\n+ * @brief Convenience macro with query logging.\n+ */\n+#define mysql_query_t(mysql, query)\\\n+\tmysql_query_t__(mysql, query, __FILE__, __LINE__, __func__)\n \n #define MYSQL_QUERY(mysql, query) \\\n \tdo { \\\n@@ -89,8 +112,7 @@ int mysql_query_t(MYSQL* mysql, const char* query);\n \n #define MYSQL_QUERY_T(mysql, query) \\\n \tdo { \\\n-\t\tconst std::string time { get_formatted_time() }; \\\n-\t\tfprintf(stderr, \"# %s: Issuing query '%s' to ('%s':%d)\\n\", time.c_str(), query, mysql->host, mysql->port); \\\n+\t\tdiag(\"Issuing query '%s' to ('%s':%d)\", query, mysql->host, mysql->port); \\\n \t\tif (mysql_query(mysql, query)) { \\\n \t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(mysql)); \\\n \t\t\treturn EXIT_FAILURE; \\\n@@ -220,7 +242,7 @@ std::string get_ext_val_err(MYSQL* mysql, const ext_val_t<T>& ext_val) {\n \t} else if (ext_val.err == -2) {\n \t\treturn \"Failed to parse response value '\" + ext_val.str + \"'\";\n \t} else {\n-\t\treturn \"Query failed with error '\" + std::string { mysql_error(mysql) } + \"'\";\n+\t\treturn std::string { mysql_error(mysql) };\n \t}\n }\n \n@@ -720,11 +742,56 @@ std::pair<int,pool_state_t> fetch_conn_stats(MYSQL* admin, const std::vector<uin\n  */\n int wait_for_cond(MYSQL* mysql, const std::string& query, uint32_t timeout);\n \n+using check_res_t = std::pair<int,std::string>;\n+\n+/**\n+ * @brief Waits for multiple conditions to take place before returning.\n+ * @param mysql Already oppened connection in which to execute the queries.\n+ * @param qs Conditions represented as queries; must pass 'check_cond' requirements.\n+ * @param to Timeout in which all the conditions should be accomplished.\n+ * @return Vector of pairs of shape '{err, check}'.\n+ */\n+std::vector<check_res_t> wait_for_conds(MYSQL* mysql, const std::vector<std::string>& qs, uint32_t to);\n+\n+/**\n+ * @brief Reduces a vector of 'check_res_t' to either success or failure.\n+ * @param chks Vector to be fold into single value.\n+ * @return -1 in case a check failed to execute, 1 if any check timedout, 0 for success.\n+ */\n+int proc_wait_checks(const std::vector<check_res_t>& chks);\n+\n+/**\n+ * @brief Encapsulates a server address.\n+ */\n+struct srv_addr_t {\n+\tconst std::string host;\n+\tconst int port;\n+};\n+\n // Helpers using 'wait_for_cond' on 'stats_mysql_connection'\n void check_conn_count(MYSQL* admin, const std::string& conn_type, uint32_t conn_num, int32_t hg=-1);\n void check_query_count(MYSQL* admin, uint32_t queries, uint32_t hg);\n void check_query_count(MYSQL* admin, std::vector<uint32_t> queries, uint32_t hg);\n \n+/**\n+ * @brief Fetches the ProxySQL nodes configured in the supplied instance.\n+ * @param cl Parameters for performing the connection to the instance.\n+ * @return Pair of shape '{err, {srv_addr}}'.\n+ */\n+std::pair<int,std::vector<srv_addr_t>> fetch_cluster_nodes(MYSQL* admin, bool dump_fetch=false);\n+\n+/**\n+ * @brief Helper function that waits for a check in all the supplied nodes.\n+ * @param cl Used for credentials to open conns to the nodes.\n+ * @param nodes The nodes addresses in which to perform the checks.\n+ * @param check The check itself to be performed in all the nodes. Must pass 'check_cond' requirements.\n+ * @param to Timeout for synchronization to take place.\n+ * @return 0 in case of success, 1 in case of timeout, and -1 in case of check failure.\n+ */\n+int check_nodes_sync(\n+\tconst CommandLine& cl, const std::vector<srv_addr_t>& nodes, const std::string& check, uint32_t to\n+);\n+\n /**\n  * @brief fetches and converts env var value to str/int/bool if possible otherwise uses default\n  * @details helper function for fetching str/int/bool from env\ndiff --git a/test/tap/tests/max_connections_ff-t.cpp b/test/tap/tests/max_connections_ff-t.cpp\nindex f85a66f330..211c939c51 100644\n--- a/test/tap/tests/max_connections_ff-t.cpp\n+++ b/test/tap/tests/max_connections_ff-t.cpp\n@@ -18,14 +18,12 @@\n \n #include <cstring>\n #include <chrono>\n-#include <iostream>\n #include <string>\n #include <stdio.h>\n #include <vector>\n #include <unistd.h>\n \n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"json.hpp\"\n \n@@ -66,10 +64,10 @@ int set_max_conns(MYSQL* proxy_admin, int max_conns, int hg_id) {\n \tstring max_conn_query {};\n \tstring_format(\"UPDATE mysql_servers SET max_connections=%d WHERE hostgroup_id=%d\", max_conn_query, max_conns, hg_id);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), max_conn_query.c_str());\n+\tdiag(\"Executing query `%s`...\", max_conn_query.c_str());\n \tMYSQL_QUERY(proxy_admin, max_conn_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL SERVERS TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL SERVERS TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL SERVERS TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -79,10 +77,10 @@ int set_srv_conn_to(MYSQL* proxy_admin, int connect_to) {\n \tstring srv_conn_to_query {};\n \tstring_format(\"SET mysql-connect_timeout_server_max=%d\", srv_conn_to_query, connect_to);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), srv_conn_to_query.c_str());\n+\tdiag(\"Executing query `%s`...\", srv_conn_to_query.c_str());\n \tMYSQL_QUERY(proxy_admin, srv_conn_to_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -93,10 +91,10 @@ int set_ff_for_user(MYSQL* proxy_admin, const string& user, bool ff) {\n \tstring upd_ff_query {};\n \tstring_format(\"UPDATE mysql_users SET fast_forward=%d WHERE username='%s'\", upd_ff_query, ff, user.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), upd_ff_query.c_str());\n+\tdiag(\"Executing query `%s`...\", upd_ff_query.c_str());\n \tMYSQL_QUERY(proxy_admin, upd_ff_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL USERS TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -264,9 +262,9 @@ int test_ff_sess_exceeds_max_conns(const CommandLine& cl, MYSQL* proxy_admin, lo\n \n \tstring reset_conn_to_srv {};\n \tstring_format(\"SET mysql-connect_timeout_server_max=%s\", reset_conn_to_srv, str_connect_timeout_server_max.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), reset_conn_to_srv.c_str());\n+\tdiag(\"Executing query `%s`...\", reset_conn_to_srv.c_str());\n \tMYSQL_QUERY(proxy_admin, reset_conn_to_srv.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \treturn EXIT_SUCCESS;\n@@ -313,7 +311,7 @@ int test_ff_only_one_free_conn(const CommandLine& cl, MYSQL* proxy_admin, int ma\n \n \t// Reset all the current stats for 'stats_mysql_connection_pool'\n \tmy_err = mysql_query(proxy_admin, reset_connpool_stats);\n-\tdiag(\"%s: Executing query `%s` in new 'fast_forward' conn...\", tap_curtime().c_str(), reset_connpool_stats);\n+\tdiag(\"Executing query `%s` in new 'fast_forward' conn...\", reset_connpool_stats);\n \tif (my_err) {\n \t\tdiag(\"Query '%s' failed\", reset_connpool_stats);\n \t\tres = EXIT_FAILURE;\n@@ -333,7 +331,7 @@ int test_ff_only_one_free_conn(const CommandLine& cl, MYSQL* proxy_admin, int ma\n \t\tMYSQL* trx_conn = trx_conns.back();\n \n \t\tdiag(\"Freeing ONE connection by committing the transaction...\");\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"COMMIT\");\n+\t\tdiag(\"Executing query `%s`...\", \"COMMIT\");\n \t\tmy_err = mysql_query(trx_conn, \"COMMIT\");\n \t\tif (my_err) {\n \t\t\tdiag(\n@@ -375,7 +373,7 @@ int test_ff_only_one_free_conn(const CommandLine& cl, MYSQL* proxy_admin, int ma\n \t\t}\n \n \t\t// 3.1 Issue a simple query into the new 'fast_forward' connection\n-\t\tdiag(\"%s: Executing query `%s` in new 'fast_forward' conn...\", tap_curtime().c_str(), \"DO 1\");\n+\t\tdiag(\"Executing query `%s` in new 'fast_forward' conn...\", \"DO 1\");\n \t\tint q_my_err = mysql_query(proxy_ff, \"DO 1\");\n \t\tif (q_my_err) {\n \t\t\tdiag(\ndiff --git a/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp b/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp\nindex bd6fa98ba5..86c3336d71 100644\n--- a/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp\n+++ b/test/tap/tests/reg_test_3223-restapi_return_codes-t.cpp\n@@ -172,7 +172,7 @@ int main(int argc, char** argv) {\n \t\t\tfor (const string& params : req.params) {\n \t\t\t\tconst string ept { join_path(base_address, req.ept_info.name) };\n \t\t\t\tdiag(\n-\t\t\t\t\t\"%s: Checking valid '%s' request - ept: '%s', params: '%s'\", tap_curtime().c_str(),\n+\t\t\t\t\t\"Checking valid '%s' request - ept: '%s', params: '%s'\",\n \t\t\t\t\treq.ept_info.method.c_str(), ept.c_str(), params.c_str()\n \t\t\t\t);\n \t\t\t\tstd::chrono::nanoseconds duration;\n@@ -308,7 +308,7 @@ int main(int argc, char** argv) {\n \n \t\t\tconst string ept { join_path(base_address, req.ept_info.name) };\n \t\t\tdiag(\n-\t\t\t\t\"%s: Checking valid '%s' request - ept: '%s', params: '%s'\", tap_curtime().c_str(),\n+\t\t\t\t\"Checking valid '%s' request - ept: '%s', params: '%s'\",\n \t\t\t\treq.ept_info.method.c_str(), ept.c_str(), ept_pl.params.c_str()\n \t\t\t);\n \ndiff --git a/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp b/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp\nindex 898c56f4ed..cdc48d14fa 100644\n--- a/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp\n+++ b/test/tap/tests/reg_test_3765_ssl_pollout-t.cpp\n@@ -13,16 +13,17 @@\n #include <string>\n #include <stdio.h>\n #include <unistd.h>\n+#include <utility>\n #include <poll.h>\n #include <sys/epoll.h>\n \n #include \"mysql.h\"\n-#include <thread>\n \n #include \"tap.h\"\n #include \"command_line.h\"\n #include \"utils.h\"\n \n+using std::pair;\n using std::string;\n using std::vector;\n \n@@ -59,13 +60,15 @@ int create_connections(const conn_opts_t& conn_opts, uint32_t cons_num, std::vec\n const uint32_t ADMIN_CONN_NUM = 100;\n const uint32_t MYSQL_CONN_NUM = 100;\n const uint32_t REPORT_INTV_SEC = 5;\n-double MAX_ALLOWED_CPU_USAGE = (double) get_env_int(\"TAP_MAX_ALLOWED_CPU_USAGE\", 13);\n \n-int get_idle_conns_cpu_usage(CommandLine& cl, uint64_t mode, double& idle_cpu_ms, double& final_cpu_ms) {\n+double MAX_IDLE_CPU_USAGE = (double) get_env_int(\"MAX_IDLE_CPU_USAGE\", 10);\n+double MAX_INCREASE_CPU_USAGE = (double) get_env_int(\"TAP_MAX_INCREASE_CPU_USAGE\", 2);\n+\n+int get_idle_conns_cpu_usage(CommandLine& cl, uint64_t mode, double& no_conns_cpu, double& idle_conns_cpu) {\n \t// get ProxySQL idle cpu usage\n-\tint idle_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, idle_cpu_ms);\n+\tint idle_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, no_conns_cpu);\n \tif (idle_err) {\n-\t    diag(\"File %s, line %d, Error: '%s'\", __FILE__, __LINE__, \"Unable to get 'idle_cpu' usage.\");\n+\t    diag(\"Unable to get 'no_conns_cpu' usage.\");\n \t\treturn idle_err;\n \t}\n \n@@ -87,9 +90,9 @@ int get_idle_conns_cpu_usage(CommandLine& cl, uint64_t mode, double& idle_cpu_ms\n \t\treturn EXIT_FAILURE;\n \t}\n \n-\tint final_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, final_cpu_ms);\n+\tint final_err = get_proxysql_cpu_usage(cl, REPORT_INTV_SEC, idle_conns_cpu);\n \tif (final_err) {\n-\t    diag(\"File %s, line %d, Error: '%s'\", __FILE__, __LINE__, \"Unable to get 'idle_cpu' usage.\");\n+\t    diag(\"Unable to get 'idle_conns_cpu' usage.\");\n \t\treturn idle_err;\n \t}\n \n@@ -111,11 +114,11 @@ int main(int argc, char** argv) {\n \n \t// For ASAN builds we don't care about correctness in this measurement.\n \tif (get_env_int(\"WITHASAN\", 0)) {\n-\t\tMAX_ALLOWED_CPU_USAGE = 80;\n+\t\tMAX_IDLE_CPU_USAGE = 80;\n \t}\n \n-\tdouble idle_cpu_ms = 0;\n-\tdouble final_cpu_ms = 0;\n+\tdouble no_conns_cpu = 0;\n+\tdouble idle_conns_cpu = 0;\n \n \tMYSQL* proxysql_admin = mysql_init(NULL);\n \tif (!mysql_real_connect(proxysql_admin, cl.host, cl.admin_username, cl.admin_password, NULL, cl.admin_port, NULL, 0)) {\n@@ -123,57 +126,71 @@ int main(int argc, char** argv) {\n \t\treturn EXIT_FAILURE;\n \t}\n \n+\tpair<int,vector<MYSQL*>> p_err_nodes_conns { disable_core_nodes_scheduler(cl, proxysql_admin) };\n+\tif (p_err_nodes_conns.first) { return EXIT_FAILURE; }\n+\tvector<MYSQL*>& nodes_conns { p_err_nodes_conns.second };\n+\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-have_ssl=1\");\n \tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tmysql_close(proxysql_admin);\n \n \tdiag(\"Testing regular connections...\");\n-\tint ret_cpu_usage = get_idle_conns_cpu_usage(cl, 0, idle_cpu_ms, final_cpu_ms);\n+\tint ret_cpu_usage = get_idle_conns_cpu_usage(cl, 0, no_conns_cpu, idle_conns_cpu);\n \tif (ret_cpu_usage != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tok(\n-\t\tidle_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'no clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, idle_cpu_ms\n+\t\tno_conns_cpu < MAX_IDLE_CPU_USAGE,\n+\t\t\"ProxySQL 'no clients' CPU usage should be below expected: (MAX_IDLE_CPU_USAGE: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE, no_conns_cpu\n \t);\n \n \tok(\n-\t\tfinal_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, final_cpu_ms\n+\t\tidle_conns_cpu < MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE,\n+\t\t\"ProxySQL 'with clients' CPU usage should be below expected:\"\n+\t\t\t\" (MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE, idle_conns_cpu\n \t);\n \n \tdiag(\"Testing SSL connections...\");\n-\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL, idle_cpu_ms, final_cpu_ms);\n+\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL, no_conns_cpu, idle_conns_cpu);\n \tif (ret_cpu_usage != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tok(\n-\t\tidle_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n+\t\tno_conns_cpu < MAX_IDLE_CPU_USAGE,\n \t\t\"ProxySQL 'no clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, idle_cpu_ms\n+\t\tMAX_IDLE_CPU_USAGE, no_conns_cpu\n \t);\n \n \tok(\n-\t\tfinal_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'SSL clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, final_cpu_ms\n+\t\tidle_conns_cpu < MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE,\n+\t\t\"ProxySQL 'with SSL clients' CPU usage should be below expected:\"\n+\t\t\t\" (MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE, idle_conns_cpu\n \t);\n \n \tdiag(\"Testing SSL and compressed connections...\");\n-\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL|CLIENT_COMPRESS, idle_cpu_ms, final_cpu_ms);\n+\tret_cpu_usage = get_idle_conns_cpu_usage(cl, CLIENT_SSL|CLIENT_COMPRESS, no_conns_cpu, idle_conns_cpu);\n \tif (ret_cpu_usage != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tok(\n-\t\tidle_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n+\t\tno_conns_cpu < MAX_IDLE_CPU_USAGE,\n \t\t\"ProxySQL 'no clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, idle_cpu_ms\n+\t\tMAX_IDLE_CPU_USAGE, no_conns_cpu\n \t);\n \n \tok(\n-\t\tfinal_cpu_ms < MAX_ALLOWED_CPU_USAGE,\n-\t\t\"ProxySQL 'SSL|COMPRESS clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n-\t\tMAX_ALLOWED_CPU_USAGE, final_cpu_ms\n+\t\tidle_conns_cpu < MAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE,\n+\t\t\"ProxySQL 'with SSL|COMPRESS clients' CPU usage should be below expected: (Exp: %%%lf, Act: %%%lf)\",\n+\t\tMAX_IDLE_CPU_USAGE + MAX_INCREASE_CPU_USAGE, idle_conns_cpu\n \t);\n \n+\t// Recover cluster scheduler\n+\tfor (MYSQL* myconn : nodes_conns) {\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER FROM DISK\");\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER TO RUNTIME\");\n+\n+\t\tmysql_close(myconn);\n+\t}\n+\n \treturn exit_status();\n }\ndiff --git a/test/tap/tests/reg_test_4402-mysql_fields-t.cpp b/test/tap/tests/reg_test_4402-mysql_fields-t.cpp\nindex bf1c0a1c16..ff0d3e5869 100644\n--- a/test/tap/tests/reg_test_4402-mysql_fields-t.cpp\n+++ b/test/tap/tests/reg_test_4402-mysql_fields-t.cpp\n@@ -83,7 +83,9 @@ int main(int argc, char** argv) {\n \n \t\t// to check column alias issue:\n \t\t{\n-\t\t\tconst std::string& query = \"SELECT testdb.echo_int(1) AS \" + generate_random_string(length);\n+\t\t\t// NOTE: The randomly generated string should be escaped \\`\\`, otherwise could collide\n+\t\t\t// with SQL reserved words, causing an invalid test failure.\n+\t\t\tconst std::string& query = \"SELECT testdb.echo_int(1) AS `\" + generate_random_string(length) + \"`\";\n \t\t\tMYSQL_QUERY__(proxysql, query.c_str());\n \n \t\t\tMYSQL_RES* res = mysql_use_result(proxysql);\ndiff --git a/test/tap/tests/reg_test__ssl_client_busy_wait-t.cpp b/test/tap/tests/reg_test__ssl_client_busy_wait-t.cpp\nnew file mode 100644\nindex 0000000000..0986898819\n--- /dev/null\n+++ b/test/tap/tests/reg_test__ssl_client_busy_wait-t.cpp\n@@ -0,0 +1,352 @@\n+/**\n+ * @file reg_test_3273_ssl_con-t.cpp\n+ * @brief Regression test for SSL busy/infinite loops for frontend connections.\n+ * @details When client disconnects unexpectedly closing the socket on a SSL connection, depending on the\n+ *   timing conditions, either an infinite loop or a busy loop could take place. These scenarios are:\n+ *   1. Closed socket while query running on backend (before data arrives), leads to busy loop.\n+ *   2. Closed socket after all the data has been written into the socket, since no more writing would take\n+ *      place in the socket an infinite loop would take place.\n+ */\n+\n+#include <cstring>\n+#include <string>\n+#include <stdio.h>\n+#include <unistd.h>\n+#include <utility>\n+#include <vector>\n+#include <poll.h>\n+#include <fcntl.h>\n+\n+#include <sys/epoll.h>\n+\n+\n+#include \"mysql.h\"\n+\n+#include \"tap.h\"\n+#include \"command_line.h\"\n+#include \"utils.h\"\n+\n+using std::string;\n+using std::pair;\n+using std::vector;\n+\n+/* Helper function to do the waiting for events on the socket. */\n+static int wait_for_mysql(MYSQL *mysql, int status) {\n+\tstruct pollfd pfd;\n+\tint timeout, res;\n+\n+\tpfd.fd = mysql_get_socket(mysql);\n+\tpfd.events =\n+\t\t(status & MYSQL_WAIT_READ ? POLLIN : 0) |\n+\t\t(status & MYSQL_WAIT_WRITE ? POLLOUT : 0) |\n+\t\t(status & MYSQL_WAIT_EXCEPT ? POLLPRI : 0);\n+\tif (status & MYSQL_WAIT_TIMEOUT)\n+\t\ttimeout = 1000*mysql_get_timeout_value(mysql);\n+\telse\n+\t\ttimeout = -1;\n+\tres = poll(&pfd, 1, timeout);\n+\tif (res == 0)\n+\t\treturn MYSQL_WAIT_TIMEOUT;\n+\telse if (res < 0)\n+\t\treturn MYSQL_WAIT_TIMEOUT;\n+\telse {\n+\t\tint status = 0;\n+\t\tif (pfd.revents & POLLIN) status |= MYSQL_WAIT_READ;\n+\t\tif (pfd.revents & POLLOUT) status |= MYSQL_WAIT_WRITE;\n+\t\tif (pfd.revents & POLLPRI) status |= MYSQL_WAIT_EXCEPT;\n+\t\treturn status;\n+\t}\n+}\n+\n+enum BUSY_LOOP_T {\n+\tBUSY_LOOP=0,\n+\tINF_LOOP=1\n+};\n+\n+struct th_args__in_t {\n+\t// Input\n+\tint argc { 0 };\n+\tchar** argv { nullptr };\n+\tint secs { 0 };\n+\tint busy_loop_type = BUSY_LOOP_T::BUSY_LOOP;\n+\tCommandLine& cl;\n+};\n+\n+struct th_args__out_t {\n+\t// Output\n+\tvolatile int* query_started { nullptr };\n+\tvolatile int* routine_rc { nullptr };\n+};\n+\n+struct th_args_t {\n+\tth_args__in_t in_args;\n+\tth_args__out_t out_args {};\n+};\n+\n+void* perform_async_query(void* arg) {\n+\tth_args_t* th_args = static_cast<th_args_t*>(arg);\n+\n+\tMYSQL* mysql = nullptr;\n+\n+\t{\n+\t\tCommandLine& cl = th_args->in_args.cl;\n+\t\tmysql = mysql_init(NULL);\n+\t\tMYSQL* ret = NULL;\n+\t\tint query_ret = 0;\n+\n+\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n+\t\tmysql_ssl_set(mysql, NULL, NULL, NULL, NULL, NULL);\n+\n+\t\tint status = 0;\n+\n+\t\tif (th_args->in_args.argc == 2 && (strcmp(th_args->in_args.argv[1], \"admin\") == 0)) {\n+\t\t\tstatus = mysql_real_connect_start(\n+\t\t\t\t&ret, mysql, cl.host, \"radmin\", \"radmin\", NULL, 6032, NULL, CLIENT_SSL\n+\t\t\t);\n+\t\t\tdiag(\"Creating 'Admin' connection   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t} else {\n+\t\t\tstatus = mysql_real_connect_start(\n+\t\t\t\t&ret, mysql, cl.host, cl.username, cl.password, NULL, cl.port, NULL, CLIENT_SSL\n+\t\t\t);\n+\n+\t\t\tdiag(\"Creating 'MySQL' connection   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t}\n+\t\tif (status == 0) {\n+\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(mysql));\n+\t\t\t__sync_fetch_and_add(th_args->out_args.routine_rc, 1);\n+\t\t\treturn NULL;\n+\t\t}\n+\n+\t\tdiag(\"Continue connection establishment   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\twhile (status) {\n+\t\t\tstatus = wait_for_mysql(mysql, status);\n+\t\t\tstatus = mysql_real_connect_cont(&ret, mysql, status);\n+\t\t\tdiag(\"'mysql_real_connect_cont'   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t}\n+\n+\t\t// NOTE: mariadbclient has an incompatibility between SSL and NONBLOCK flags. Flag needs to be reset\n+\t\t// after 'mysql_real_connect_cont', otherwise API would become blocking.\n+\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n+\t\tint f=fcntl(mysql->net.fd, F_GETFL);\n+\t\tfcntl(mysql->net.fd, F_SETFL, f|O_NONBLOCK);\n+\n+\t\tconst string sleep_query { \"SELECT SLEEP(\" + std::to_string(th_args->in_args.secs) + \")\" };\n+\t\tdiag(\"mysql_query_start   thread=%ld query=%s\", pthread_self(), sleep_query.c_str());\n+\n+\t\tstatus = mysql_real_query_start(&query_ret, mysql, sleep_query.c_str(), sleep_query.size());\n+\n+\t\tif (th_args->in_args.busy_loop_type == BUSY_LOOP_T::INF_LOOP) {\n+\t\t\t// NOTE: When signaling after 'mysql_query_start' has finished, ProxySQL wont attempt to write more\n+\t\t\t// to the closed pipe, this corresponds to 'busy_loop_type=2' and infinite loop.\n+\t\t\twhile (status) {\n+\t\t\t\tstatus = wait_for_mysql(mysql, status);\n+\t\t\t\tstatus = mysql_real_query_cont(&query_ret, mysql, status);\n+\t\t\t\tdiag(\"'mysql_real_connect_cont'   thread=%ld ret=%p status=%d\", pthread_self(), ret, status);\n+\t\t\t}\n+\t\t}\n+\n+\t\tdiag(\"Signaling query start   thread=%ld status=%d query_ret=%d\", pthread_self(), status, query_ret);\n+\t\t__sync_fetch_and_add(th_args->out_args.query_started, 1);\n+\n+\t\t// NOTE: Required for triggering the issue, thread exit isn't enough, either 'process exit' or\n+\t\t// 'close()'. They should be immediate to the previous action, otherwise timing could be invalid.\n+\t\tclose(mysql->net.fd);\n+\n+\t\twhile (true) {\n+\t\t\tdiag(\n+\t\t\t\t\"Sleeping after query started...   thread=%ld status=%d query_ret=%d\",\n+\t\t\t\tpthread_self(), status, query_ret\n+\t\t\t);\n+\t\t\tsleep(1);\n+\t\t}\n+\t}\n+\n+\treturn NULL;\n+}\n+\n+struct pthread_data_t {\n+\tpthread_t id { 0 };\n+\tint query_started { 0 };\n+\tint routine_rc { EXIT_SUCCESS };\n+};\n+\n+const int BUSY_THREADS = get_env_int(\"TAP_SSL_BUSY_WAIT__BUSY_THREADS\", 4);\n+const int MAX_IDLE_CPU = get_env_int(\"TAP_SSL_BUSY_WAIT__MAX_IDLE_CPU\", 20);\n+const int MAX_BUSY_CPU = get_env_int(\"TAP_SSL_BUSY_WAIT__MAX_BUSY_CPU\", 25);\n+\n+// NOTE: '10' is a nice value due to it's relationship with the 'system_cpu' interval\n+const int BUSY_WAIT_SECS = get_env_int(\"TAP_SSL_BUSY_WAIT__BUSY_WAIT_SECS\", 10);\n+// NOTE: '5' is the min value due to time interval rounding 'round_intv_to_time_interval'\n+const int SAMPLE_INTV_SECS = get_env_int(\"TAP_SSL_BUSY_WAIT__SAMPLE_INTV_SEC\", BUSY_WAIT_SECS / 2);\n+\n+void create_busy_loops(int argc, char** argv, CommandLine& cl, BUSY_LOOP_T loop_type) {\n+\tvector<pthread_data_t> ths_data {};\n+\tvector<std::unique_ptr<th_args_t>> ths_args {};\n+\n+\tths_data.resize(BUSY_THREADS);\n+\n+\tfor (size_t i = 0; i < BUSY_THREADS; i++) {\n+\t\tpthread_data_t& th_data = ths_data[i];\n+\t\tstd::unique_ptr<th_args_t> th_args {\n+\t\t\tnew th_args_t {\n+\t\t\t\tth_args__in_t {\n+\t\t\t\t\targc, argv, BUSY_WAIT_SECS, loop_type, cl\n+\t\t\t\t},\n+\t\t\t\tth_args__out_t {\n+\t\t\t\t\t&th_data.query_started,\n+\t\t\t\t\t&th_data.routine_rc\n+\t\t\t\t}\n+\t\t\t}\n+\t\t};\n+\n+\t\tpthread_create(&th_data.id, NULL, perform_async_query, th_args.get());\n+\t\tths_args.push_back(std::move(th_args));\n+\n+\t\tdiag(\"Thread created   thread=%ld\", th_data.id);\n+\t}\n+\n+\tbool missing_query = true;\n+\tbool query_failed = false;\n+\n+\twhile (missing_query && !query_failed) {\n+\t\tbool all_query_started = true;\n+\n+\t\tfor (pthread_data_t& th_data : ths_data) {\n+\t\t\tbool query_started = __sync_fetch_and_add(&th_data.query_started, 0);\n+\t\t\tdiag(\n+\t\t\t\t\"Thread data   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t);\n+\n+\t\t\tif (th_data.id == 0 && query_started == 1) {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Thread alreay cancelled   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tquery_failed = __sync_fetch_and_add(&th_data.routine_rc, 0);\n+\n+\t\t\tif (query_failed) {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Async query failed; aborting test   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\n+\t\t\tall_query_started &= query_started;\n+\n+\t\t\tif (query_started) {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Async query started, killing thread   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t\tpthread_cancel(th_data.id);\n+\t\t\t\tth_data.id = 0;\n+\t\t\t} else {\n+\t\t\t\tdiag(\n+\t\t\t\t\t\"Waiting for async query to start...   thread=%ld routine_rc=%d query_started=%d\",\n+\t\t\t\t\tth_data.id, th_data.routine_rc, query_started\n+\t\t\t\t);\n+\t\t\t}\n+\t\t}\n+\n+\t\tmissing_query = !all_query_started;\n+\t\tusleep(500 * 1000);\n+\t}\n+}\n+\n+int main(int argc, char** argv) {\n+\tCommandLine cl;\n+\n+\tif (cl.getEnv()) {\n+\t\tdiag(\"Failed to get the required environmental variables.\");\n+\t\treturn -1;\n+\t}\n+\n+\tplan(4);\n+\n+\tMYSQL* admin = mysql_init(NULL);\n+\tif (!mysql_real_connect(admin, cl.host, cl.admin_username, cl.admin_password, NULL, cl.admin_port, NULL, 0)) {\n+\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(admin));\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tpair<int,vector<MYSQL*>> p_err_nodes_conns { disable_core_nodes_scheduler(cl, admin) };\n+\tif (p_err_nodes_conns.first) { return EXIT_FAILURE; }\n+\tvector<MYSQL*>& nodes_conns { p_err_nodes_conns.second };\n+\n+\tdiag(\"Checking ProxySQL idle CPU usage\");\n+\tdouble idle_cpu = 0;\n+\tint ret_i_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, idle_cpu);\n+\tif (ret_i_cpu) {\n+\t\tdiag(\"Getting initial CPU usage failed with error - %d\", ret_i_cpu);\n+\t\tdiag(\"Aborting further testing\");\n+\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tok(\n+\t\tidle_cpu < MAX_IDLE_CPU, \"Idle CPU usage should be below expected - Exp:%d%%, Act: %lf%%\",\n+\t\tMAX_IDLE_CPU, idle_cpu\n+\t);\n+\n+\tdiag(\"Trigger BUSY_LOOP regression    BUSY_THREADS=%d BUSY_WAIT_SECS=%d\", BUSY_THREADS, BUSY_WAIT_SECS);\n+\tcreate_busy_loops(argc, argv, cl, BUSY_LOOP_T::BUSY_LOOP);\n+\n+\tdiag(\"Checking ProxySQL final CPU usage for 'BUSY_LOOP'\");\n+\tdouble final_cpu_usage = 0;\n+\tint ret_f_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, final_cpu_usage);\n+\n+\tok(\n+\t\tfinal_cpu_usage < MAX_BUSY_CPU,\n+\t\t\"ProxySQL CPU usage should be below expected - Exp: %d%%, Act: %lf%%\",\n+\t\tMAX_BUSY_CPU, final_cpu_usage\n+\t);\n+\n+\t// Extra wait to ensure cleanup of faulty client conns. See 'BUSY_WAIT_SECS' NOTE in def.\n+\tint BUSY_WAIT_CLEANUP = BUSY_WAIT_SECS < 5 ? 5 : BUSY_WAIT_SECS / 2;\n+\tdiag(\"Sleeping for %d secs for BUSY_LOOP client cleanup\", BUSY_WAIT_CLEANUP);\n+\tsleep(BUSY_WAIT_CLEANUP);\n+\n+\tdiag(\"Checking ProxySQL idle CPU usage\");\n+\tret_i_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, idle_cpu);\n+\tif (ret_i_cpu) {\n+\t\tdiag(\"Getting initial CPU usage failed with error - %d\", ret_i_cpu);\n+\t\tdiag(\"Aborting further testing\");\n+\n+\t\treturn EXIT_FAILURE;\n+\t}\n+\n+\tok(\n+\t\tidle_cpu < MAX_IDLE_CPU, \"Idle CPU usage should be below expected - Exp:%d%%, Act: %lf%%\",\n+\t\tMAX_IDLE_CPU, idle_cpu\n+\t);\n+\n+\tdiag(\"Trigger INF_LOOP regression    BUSY_THREADS=%d BUSY_WAIT_SECS=%d\", BUSY_THREADS, BUSY_WAIT_SECS);\n+\tcreate_busy_loops(argc, argv, cl, BUSY_LOOP_T::INF_LOOP);\n+\n+\tdiag(\"Checking ProxySQL final CPU usage for 'BUSY_LOOP'\");\n+\tfinal_cpu_usage = 0;\n+\tret_f_cpu = get_proxysql_cpu_usage(cl, SAMPLE_INTV_SECS, final_cpu_usage);\n+\n+\tok(\n+\t\tfinal_cpu_usage < MAX_BUSY_CPU,\n+\t\t\"ProxySQL CPU usage should be below expected - Exp: %d%%, Act: %lf%%\",\n+\t\tMAX_BUSY_CPU, final_cpu_usage\n+\t);\n+\n+\t// Recover cluster scheduler\n+\tfor (MYSQL* myconn : nodes_conns) {\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER FROM DISK\");\n+\t\tMYSQL_QUERY_T(myconn, \"LOAD SCHEDULER TO RUNTIME\");\n+\n+\t\tmysql_close(myconn);\n+\t}\n+\n+\tmysql_close(admin);\n+\n+\treturn exit_status();\n+}\ndiff --git a/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp b/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp\nindex 674a1f9b74..0a7200ef18 100644\n--- a/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp\n+++ b/test/tap/tests/reg_test_sql_calc_found_rows-t.cpp\n@@ -13,7 +13,6 @@\n #include <unistd.h>\n \n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"json.hpp\"\n \n@@ -74,7 +73,7 @@ int main(int argc, char** argv) {\n \t// 1. Prepare the 'SQL_CALC_FOUND_ROWS' stmt in a connection\n \tMYSQL* proxy_mysql = mysql_init(NULL);\n \n-\tdiag(\"%s: Openning initial connection...\", tap_curtime().c_str());\n+\tdiag(\"Openning initial connection...\");\n \tif (!mysql_real_connect(proxy_mysql, cl.host, cl.username, cl.password, NULL, cl.port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxy_mysql));\n \t\treturn EXIT_FAILURE;\n@@ -84,7 +83,7 @@ int main(int argc, char** argv) {\n \tMYSQL_STMT* stmt_2 = mysql_stmt_init(proxy_mysql);\n \tMYSQL_STMT* stmt_3 = nullptr;\n \n-\tdiag(\"%s: Issuing the prepare for `%s` in init conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_1);\n+\tdiag(\"Issuing the prepare for `%s` in init conn\", Q_CALC_FOUND_ROWS_1);\n \tint my_err = mysql_stmt_prepare(stmt_1, Q_CALC_FOUND_ROWS_1, strlen(Q_CALC_FOUND_ROWS_1));\n \tif (my_err) {\n \t\tdiag(\n@@ -94,7 +93,7 @@ int main(int argc, char** argv) {\n \t\tgoto cleanup;\n \t}\n \n-\tdiag(\"%s: Issuing the prepare for `%s` in init conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_2);\n+\tdiag(\"Issuing the prepare for `%s` in init conn\", Q_CALC_FOUND_ROWS_2);\n \tmy_err = mysql_stmt_prepare(stmt_2, Q_CALC_FOUND_ROWS_2, strlen(Q_CALC_FOUND_ROWS_2));\n \tif (my_err) {\n \t\tdiag(\n@@ -107,13 +106,13 @@ int main(int argc, char** argv) {\n \tmysql_stmt_close(stmt_1);\n \tmysql_stmt_close(stmt_2);\n \n-\tdiag(\"%s: Closing initial connection...\", tap_curtime().c_str());\n+\tdiag(\"Closing initial connection...\");\n \tmysql_close(proxy_mysql);\n \n \t// 2. Open a new connection and prepare the stmts it again in a new connection\n \tproxy_mysql = mysql_init(NULL);\n \n-\tdiag(\"%s: Openning new connection for testing 'Multiplex' disabling\", tap_curtime().c_str());\n+\tdiag(\"Openning new connection for testing 'Multiplex' disabling\");\n \tif (!mysql_real_connect(proxy_mysql, cl.host, cl.username, cl.password, NULL, cl.port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxy_mysql));\n \t\treturn EXIT_FAILURE;\n@@ -123,7 +122,7 @@ int main(int argc, char** argv) {\n \tstmt_2 = mysql_stmt_init(proxy_mysql);\n \tstmt_3 = mysql_stmt_init(proxy_mysql);\n \n-\tdiag(\"%s: Issuing the prepare for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_1);\n+\tdiag(\"Issuing the prepare for `%s` in new conn\", Q_CALC_FOUND_ROWS_1);\n \tmy_err = mysql_stmt_prepare(stmt_1, Q_CALC_FOUND_ROWS_1, strlen(Q_CALC_FOUND_ROWS_1));\n \tif (my_err) {\n \t\tdiag(\n@@ -134,7 +133,7 @@ int main(int argc, char** argv) {\n \t}\n \n \t{\n-\t\tdiag(\"%s: Issuing execute for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_1);\n+\t\tdiag(\"Issuing execute for `%s` in new conn\", Q_CALC_FOUND_ROWS_1);\n \t\tmy_err = mysql_stmt_execute(stmt_1);\n \t\tif (my_err) {\n \t\t\tdiag(\"'mysql_stmt_execute' at line %d failed: %s\", __LINE__, mysql_stmt_error(stmt_1));\n@@ -149,7 +148,7 @@ int main(int argc, char** argv) {\n \t\t}\n \t}\n \t{\n-\t\tdiag(\"%s: Issuing the prepare for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_2);\n+\t\tdiag(\"Issuing the prepare for `%s` in new conn\", Q_CALC_FOUND_ROWS_2);\n \t\tmy_err = mysql_stmt_prepare(stmt_2, Q_CALC_FOUND_ROWS_2, strlen(Q_CALC_FOUND_ROWS_2));\n \t\tif (my_err) {\n \t\t\tdiag(\n@@ -160,7 +159,7 @@ int main(int argc, char** argv) {\n \t\t}\n \n \t\t{\n-\t\t\tdiag(\"%s: Issuing execute for `%s` in new conn\", tap_curtime().c_str(), Q_CALC_FOUND_ROWS_2);\n+\t\t\tdiag(\"Issuing execute for `%s` in new conn\", Q_CALC_FOUND_ROWS_2);\n \t\t\tmy_err = mysql_stmt_execute(stmt_2);\n \t\t\tif (my_err) {\n \t\t\t\tdiag(\"'mysql_stmt_execute' at line %d failed: %s\", __LINE__, mysql_stmt_error(stmt_2));\n@@ -175,7 +174,7 @@ int main(int argc, char** argv) {\n \t\t\t}\n \t\t}\n \n-\t\tdiag(\"%s: Issuing the prepare for `%s` in new conn\", tap_curtime().c_str(), Q_FOUND_ROWS);\n+\t\tdiag(\"Issuing the prepare for `%s` in new conn\", Q_FOUND_ROWS);\n \t\tmy_err = mysql_stmt_prepare(stmt_3, Q_FOUND_ROWS, strlen(Q_FOUND_ROWS));\n \t\tif (my_err) {\n \t\t\tdiag(\ndiff --git a/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp b/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp\nindex ee50da7211..64f531da0e 100644\n--- a/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp\n+++ b/test/tap/tests/test_auto_increment_delay_multiplex-t.cpp\n@@ -25,11 +25,9 @@\n #include <vector>\n #include <string>\n #include <stdio.h>\n-#include <iostream>\n \n #include <unistd.h>\n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"json.hpp\"\n \n@@ -142,14 +140,14 @@ int check_auto_increment_timeout(\n \tconst string set_auto_inc_to_query {\n \t\t\"SET mysql-auto_increment_delay_multiplex_timeout_ms=\" + std::to_string(auto_inc_delay_to)\n \t};\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_to_query.c_str());\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_to_query.c_str());\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_to_query.c_str());\n \n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \n \t// Wait at least '500' milliseconds over the poll period\n \tusleep((poll_to + 500) * 1000);\n@@ -197,7 +195,7 @@ int check_auto_increment_timeout(\n \t}\n \n \tMYSQL_QUERY(proxy_mysql, \"DO 1\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"DO 1\");\n+\tdiag(\"Executing query `%s`...\", \"DO 1\");\n \n \tuint32_t old_auto_inc_delay_mult = cur_auto_inc_delay_mult;\n \tg_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_auto_inc_delay_mult);\n@@ -244,9 +242,9 @@ int check_variables_config(MYSQL* proxy_mysql, MYSQL* proxy_admin) {\n \n int check_auto_increment_delay_multiplex(MYSQL* proxy_mysql, MYSQL* proxy_admin) {\n \t// Disable the 'timeout' for the this check since it can be fixated now\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\");\n+\tdiag(\"Executing query `%s`...\", \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\");\n \tMYSQL_QUERY(proxy_admin, \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SET mysql-connection_delay_multiplex_ms=0\");\n+\tdiag(\"Executing query `%s`...\", \"SET mysql-connection_delay_multiplex_ms=0\");\n \tMYSQL_QUERY(proxy_admin, \"SET mysql-connection_delay_multiplex_ms=0\");\n \n \tint cur_auto_inc_delay_mult = 0;\n@@ -310,13 +308,13 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \tuint64_t poll_timeout = 0;\n \tint g_res = 0;\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_query.c_str());\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_query.c_str());\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_query.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SET mysql-connection_delay_multiplex_ms=0\");\n+\tdiag(\"Executing query `%s`...\", \"SET mysql-connection_delay_multiplex_ms=0\");\n \tMYSQL_QUERY(proxy_admin, \"SET mysql-connection_delay_multiplex_ms=0\");\n \n \tconst string q_poll_timeout { \"SELECT variable_value FROM global_variables WHERE variable_name='mysql-poll_timeout'\" };\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), q_poll_timeout.c_str());\n+\tdiag(\"Executing query `%s`...\", q_poll_timeout.c_str());\n \tg_res = get_query_result(proxy_admin, q_poll_timeout.c_str(), poll_timeout);\n \tif (g_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n@@ -357,14 +355,14 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \tif (g_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \tMYSQL_QUERY(proxy_admin, delay_query.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), delay_query.c_str());\n+\tdiag(\"Executing query `%s`...\", delay_query.c_str());\n \tMYSQL_QUERY(proxy_admin, timeout_query.c_str());\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), timeout_query.c_str());\n+\tdiag(\"Executing query `%s`...\", timeout_query.c_str());\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t{\n \t\t// Insert disabling multiplexing for the connection\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\t\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \t\tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \t\t// Perform queries in the same connection\n@@ -373,7 +371,7 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t\twhile (waited < timeout_ms * 3) {\n \t\t\tsleep(1);\n \n-\t\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"/* hostgroup=0 */ DO 1\");\n+\t\t\tdiag(\"Executing query `%s`...\", \"/* hostgroup=0 */ DO 1\");\n \t\t\tMYSQL_QUERY(proxy_mysql, \"/* hostgroup=0 */ DO 1\");\n \t\t\twaited += 1000;\n \t\t}\n@@ -397,7 +395,7 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t\twhile (waited < timeout_ms * 3) {\n \t\t\tsleep(1);\n \n-\t\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SELECT 1\");\n+\t\t\tdiag(\"Executing query `%s`...\", \"SELECT 1\");\n \t\t\tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n \t\t\tmysql_free_result(mysql_store_result(proxy_mysql));\n \n@@ -423,16 +421,16 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \n \t// Transactions connections should be preserved by 'auto_increment_delay_multiplex_timeout_ms'\n \t{\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"BEGIN\");\n+\t\tdiag(\"Executing query `%s`...\", \"BEGIN\");\n \t\tMYSQL_QUERY(proxy_mysql, \"BEGIN\");\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\t\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \t\tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \t\t// Wait for the timeout and check the value\n-\t\tdiag(\"%s: Waiting for timeout to expire...\", tap_curtime().c_str());\n+\t\tdiag(\"Waiting for timeout to expire...\");\n \t\tusleep(timeout_ms * 1000 + poll_timeout * 1000 + 500 * 1000 * 2);\n \n-\t\tdiag(\"%s: Extracting current auto inc delay...\", tap_curtime().c_str());\n+\t\tdiag(\"Extracting current auto inc delay...\");\n \t\tint cur_delay = 0;\n \t\tint g_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_delay);\n \t\tif (g_res != EXIT_SUCCESS) {\n@@ -445,13 +443,13 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t\t\tdelay, cur_delay\n \t\t);\n \n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"COMMIT\");\n+\t\tdiag(\"Executing query `%s`...\", \"COMMIT\");\n \t\tMYSQL_QUERY(proxy_mysql, \"COMMIT\");\n \n-\t\tdiag(\"%s: Waiting for timeout to expire...\", tap_curtime().c_str());\n+\t\tdiag(\"Waiting for timeout to expire...\");\n \t\tusleep(timeout_ms * 1000 + poll_timeout * 1000 + 500 * 1000 * 2);\n \n-\t\tdiag(\"%s: Extracting current auto inc delay...\", tap_curtime().c_str());\n+\t\tdiag(\"Extracting current auto inc delay...\");\n \t\tcur_delay = 0;\n \t\tg_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_delay);\n \t\tif (g_res != EXIT_SUCCESS) {\n@@ -468,16 +466,16 @@ int check_auto_increment_delay_multiplex_timeout(MYSQL* proxy_mysql, MYSQL* prox\n \t// Multiplex disabled by any action should take precedence over 'auto_increment_delay_multiplex_timeout_ms'\n \t{\n \t\tconst char* set_query { \"SET @local_var='foo'\" };\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_query);\n+\t\tdiag(\"Executing query `%s`...\", set_query);\n \t\tMYSQL_QUERY(proxy_mysql, set_query);\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\t\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \t\tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \t\t// Wait for the timeout and check the value\n-\t\tdiag(\"%s: Waiting for timeout to expire...\", tap_curtime().c_str());\n+\t\tdiag(\"Waiting for timeout to expire...\");\n \t\tusleep(timeout_ms * 1000 + poll_timeout * 1000 + 500 * 1000 * 2);\n \n-\t\tdiag(\"%s: Extracting current auto inc delay...\", tap_curtime().c_str());\n+\t\tdiag(\"Extracting current auto inc delay...\");\n \t\tint cur_delay = 0;\n \t\tint g_res = get_conn_auto_inc_delay_token(proxy_mysql, cur_delay);\n \t\tif (g_res != EXIT_SUCCESS) {\n@@ -533,9 +531,9 @@ void check_connection_retained(MYSQL* proxy_mysql, uint32_t exp_conns) {\n int check_transactions_and_multiplex_disable(\n \tMYSQL* proxy_mysql, const char* query, const uint32_t timeout, uint64_t poll_timeout=2\n ) {\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"BEGIN\");\n+\tdiag(\"Executing query `%s`...\", \"BEGIN\");\n \tMYSQL_QUERY(proxy_mysql, \"BEGIN\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), query);\n+\tdiag(\"Executing query `%s`...\", query);\n \tMYSQL_QUERY(proxy_mysql, query);\n \n \tdiag(\"Checking connection present before timeout...\");\n@@ -547,7 +545,7 @@ int check_transactions_and_multiplex_disable(\n \tdiag(\"Checking connection is still present after timeout due to transaction...\");\n \tcheck_connection_retained(proxy_mysql, 1);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"COMMIT\");\n+\tdiag(\"Executing query `%s`...\", \"COMMIT\");\n \tMYSQL_QUERY(proxy_mysql, \"COMMIT\");\n \n \tdiag(\"Sleeping for '%lf' seconds\", timeout / 2.0);\n@@ -565,7 +563,7 @@ int check_transactions_and_multiplex_disable(\n \tdiag(\"Checking multiplex disabled by any action take precedence over 'connection_delay_multiplex_ms'...\");\n \n \tconst char* set_query { \"SET @local_var='foo'\" };\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_query);\n+\tdiag(\"Executing query `%s`...\", set_query);\n \tMYSQL_QUERY(proxy_mysql, set_query);\n \n \tdiag(\"Sleeping for '%ld' seconds\", timeout + poll_timeout);\n@@ -587,13 +585,13 @@ int check_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy_admin)\n \tstring_format(\"SET mysql-connection_delay_multiplex_ms=%d\", set_delay_multiplex, timeout * 1000);\n \tconst char* set_auto_inc_delay { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex.c_str());\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex.c_str());\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_delay);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_delay);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_delay);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n@@ -632,13 +630,13 @@ int check_multiplex_disabled_connection_delay_multiplex_ms(MYSQL* proxy_mysql, M\n \tstring_format(\"SET mysql-connection_delay_multiplex_ms=%d\", set_delay_multiplex, timeout * 1000);\n \tconst char* set_auto_inc_delay { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex.c_str());\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex.c_str());\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_delay);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_delay);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_delay);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t// Check transactions behavior and multiplex disabling actions\n@@ -652,11 +650,11 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \tconst char* set_delay_multiplex_query { \"SET mysql-connection_delay_multiplex_ms=2000\" };\n \tconst char* set_auto_inc_timeout_query { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex_query);\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex_query);\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_timeout_query);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_timeout_query);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_timeout_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t// Retain connection in 'hg=0'\n@@ -664,7 +662,7 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \n \tuint32_t waited = 0;\n \twhile (waited < 2*timeout) {\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"DO 1\");\n+\t\tdiag(\"Executing query `%s`...\", \"DO 1\");\n \t\tMYSQL_QUERY(proxy_mysql, \"DO 1\");\n \n \t\tsleep(1);\n@@ -679,9 +677,9 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \n \tdiag(\"Check connection expiring when traffic issued to different hostgroup...\");\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"DO 1\");\n+\tdiag(\"Executing query `%s`...\", \"DO 1\");\n \tMYSQL_QUERY(proxy_mysql, \"DO 1\");\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SELECT 1\");\n+\tdiag(\"Executing query `%s`...\", \"SELECT 1\");\n \tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n \tmysql_free_result(mysql_store_result(proxy_mysql));\n \n@@ -719,7 +717,7 @@ int check_traffic_connection_delay_multiplex_ms(MYSQL* proxy_mysql, MYSQL* proxy\n \t// Check for connections retained in 'hg 0'\n \twaited = 0;\n \twhile (waited < timeout * 2) {\n-\t\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"SELECT 1\");\n+\t\tdiag(\"Executing query `%s`...\", \"SELECT 1\");\n \t\tMYSQL_QUERY(proxy_mysql, \"SELECT 1\");\n \t\tmysql_free_result(mysql_store_result(proxy_mysql));\n \n@@ -768,18 +766,18 @@ int check_auto_inc_delay_and_conn_delay_multiplex(MYSQL* proxy_mysql, MYSQL* pro\n \tconst char* set_delay_multiplex_query { \"SET mysql-connection_delay_multiplex_ms=2000\" };\n \tconst char* set_auto_inc_timeout_query { \"SET mysql-auto_increment_delay_multiplex_timeout_ms=0\" };\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex_query);\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex_query);\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_auto_inc_timeout_query);\n+\tdiag(\"Executing query `%s`...\", set_auto_inc_timeout_query);\n \tMYSQL_QUERY(proxy_admin, set_auto_inc_timeout_query);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t// Retain connection in 'hg=0'\n \tdiag(\"Checking connection not expiring due to 'auto_increment_delay_multiplex'.\");\n \n \tuint32_t waited = 0;\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \tdiag(\"* Check connection retained after executing the query\");\n@@ -797,13 +795,13 @@ int check_auto_inc_delay_and_conn_delay_multiplex(MYSQL* proxy_mysql, MYSQL* pro\n \t);\n \n \tstring_format(\"SET mysql-auto_increment_delay_multiplex_timeout_ms=%d\", auto_inc_timeout_query, timeout*2*1000);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), auto_inc_timeout_query.c_str());\n+\tdiag(\"Executing query `%s`...\", auto_inc_timeout_query.c_str());\n \tMYSQL_QUERY(proxy_admin, auto_inc_timeout_query.c_str());\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \tdiag(\"Sleeping for '%d' seconds\", timeout + 1);\n@@ -834,17 +832,17 @@ int check_auto_inc_delay_and_conn_delay_multiplex(MYSQL* proxy_mysql, MYSQL* pro\n \t);\n \n \tstring_format(\"SET mysql-auto_increment_delay_multiplex_timeout_ms=%d\", auto_inc_timeout_query, timeout*1000);\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), auto_inc_timeout_query.c_str());\n+\tdiag(\"Executing query `%s`...\", auto_inc_timeout_query.c_str());\n \tMYSQL_QUERY(proxy_admin, auto_inc_timeout_query.c_str());\n \n \tconst char* set_delay_multiplex_query_2 { \"SET mysql-connection_delay_multiplex_ms=4000\" };\n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), set_delay_multiplex_query_2);\n+\tdiag(\"Executing query `%s`...\", set_delay_multiplex_query_2);\n \tMYSQL_QUERY(proxy_admin, set_delay_multiplex_query_2);\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tdiag(\"Executing query `%s`...\", \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n-\tdiag(\"%s: Executing query `%s`...\", tap_curtime().c_str(), INSERT_QUERY);\n+\tdiag(\"Executing query `%s`...\", INSERT_QUERY);\n \tMYSQL_QUERY(proxy_mysql, INSERT_QUERY);\n \n \tdiag(\"Sleeping for '%d' seconds\", timeout + 1);\ndiff --git a/test/tap/tests/test_binlog_fast_forward-t.cpp b/test/tap/tests/test_binlog_fast_forward-t.cpp\nindex 6f9c98befb..c6569c7c45 100644\n--- a/test/tap/tests/test_binlog_fast_forward-t.cpp\n+++ b/test/tap/tests/test_binlog_fast_forward-t.cpp\n@@ -84,7 +84,7 @@ int pull_replication(MYSQL *mysql, int server_id) {\n \t\t\t}\n \t\t}\n \t\tif (print_diag == true)\n-\t\t\tdiag(\"%s: server_id %d , event: %d , received events: %d , received heartbeats: %d\", tap_curtime().c_str(), server_id, event->event_type, num_events, num_heartbeats);\n+\t\t\tdiag(\"server_id %d , event: %d , received events: %d , received heartbeats: %d\", server_id, event->event_type, num_events, num_heartbeats);\n \t}\n \t// we expects NHB heartbeats\n \tok(num_heartbeats == NHB , \"For server_id %d received %d heartbeats\", server_id, num_heartbeats);\ndiff --git a/test/tap/tests/test_cluster_sync-t.cpp b/test/tap/tests/test_cluster_sync-t.cpp\nindex d7f47989c3..7d1e715019 100644\n--- a/test/tap/tests/test_cluster_sync-t.cpp\n+++ b/test/tap/tests/test_cluster_sync-t.cpp\n@@ -29,8 +29,11 @@\n  *  - Check that checksum is detected and fetched by the peer node (only checksum itself).\n  *  - Check that once checksum is detected and fetched, it takes '%_diffs_before_sync' before the actual sync\n  *    is performed, error log is used to verify this.\n- *  - Finally check the config sync, the new checksum should match the previously detected.\n+ *  - Check the config sync, the new checksum should match the previously detected.\n  *    + Module 'admin_variables' may be the exception, since 'LOAD TO RUNTIME' generates a new checksum.\n+ *  - To avoid race conditions, and make the next check always start from a known state, we finally check that\n+ *    the primary has updated the monitoring checksums. This way we ensure that in the next check, a change in\n+ *    the checksum means the new computed checksum not a previous, yet not synced one.\n  *\n  *  Each sync DISABLE check consists in:\n  *\n@@ -59,11 +62,9 @@\n  */\n \n #include <unistd.h>\n-#include <signal.h>\n #include <pthread.h>\n #include <stdio.h>\n #include <time.h>\n-#include <errno.h>\n \n #include <atomic>\n #include <vector>\n@@ -72,7 +73,6 @@\n #include <iostream>\n #include <fstream>\n #include <functional>\n-#include <regex>\n #include <utility>\n \n #include \"libconfig.h\"\n@@ -100,58 +100,6 @@ using std::tuple;\n using std::fstream;\n using std::function;\n \n-/**\n- * @brief Helper function to verify that the sync of a table (or variable) have been performed.\n- *\n- * @param r_proxy_admin An already opened connection to ProxySQL.\n- * @param queries Queries to be executed that should return a **non-zero** value after the sync has taken place.\n- * @param sync_timeout Timeout for the sync to happen.\n- *\n- * @return EXIT_SUCCESS in case of success, otherwise:\n- *  - '-1' if a query against Admin fails to be performed (failure is logged).\n- *  - '-2' if timeout expired without sync being completed.\n- */\n-int sync_checker(MYSQL* r_proxy_admin, const vector<string>& queries, uint32_t sync_timeout) {\n-\tbool not_synced_query = false;\n-\tuint waited = 0;\n-\n-\twhile (waited < sync_timeout) {\n-\t\tnot_synced_query = false;\n-\n-\t\t// Check that all the entries have been synced\n-\t\tfor (const auto& query : queries) {\n-\t\t\tint q_res = mysql_query(r_proxy_admin, query.c_str());\n-\t\t\tif (q_res != EXIT_SUCCESS) {\n-\t\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(r_proxy_admin));\n-\t\t\t\treturn -1;\n-\t\t\t}\n-\n-\t\t\tMYSQL_RES* proxysql_servers_res = mysql_store_result(r_proxy_admin);\n-\t\t\tMYSQL_ROW row = mysql_fetch_row(proxysql_servers_res);\n-\t\t\tint row_value = atoi(row[0]);\n-\t\t\tmysql_free_result(proxysql_servers_res);\n-\n-\t\t\tif (row_value == 0) {\n-\t\t\t\tnot_synced_query = true;\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t}\n-\n-\t\tif (not_synced_query) {\n-\t\t\twaited += 1;\n-\t\t\tsleep(1);\n-\t\t} else {\n-\t\t\tbreak;\n-\t\t}\n-\t}\n-\n-\tif (not_synced_query) {\n-\t\treturn -2;\n-\t} else {\n-\t\treturn EXIT_SUCCESS;\n-\t}\n-}\n-\n // GLOBAL TEST PARAMETERS\n const uint32_t SYNC_TIMEOUT = 10;\n const uint32_t CONNECT_TIMEOUT = 10;\n@@ -244,30 +192,6 @@ int setup_config_file(const CommandLine& cl) {\n \treturn 0;\n }\n \n-int check_nodes_sync(\n-\tconst CommandLine& cl, const vector<mysql_res_row>& core_nodes, const string& check_query, uint32_t sync_timeout\n-) {\n-\tfor (const auto& node : core_nodes) {\n-\t\tconst string host { node[0] };\n-\t\tconst int port = std::stol(node[1]);\n-\n-\t\tMYSQL* c_node_admin = mysql_init(NULL);\n-\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(c_node_admin));\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\n-\t\tint not_synced = sync_checker(c_node_admin, { check_query }, sync_timeout);\n-\t\tif (not_synced != EXIT_SUCCESS) {\n-\t\t\tconst string err_msg { \"Node '\"  + host + \":\" + std::to_string(port) + \"' sync timed out\" };\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: `%s`\\n\", __FILE__, __LINE__, err_msg.c_str());\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\t}\n-\n-\treturn EXIT_SUCCESS;\n-}\n-\n const std::string t_debug_query = \"mysql -u%s -p%s -h %s -P%d -C -e \\\"%s\\\"\";\n \n using mysql_server_tuple = tuple<int,string,int,int,string,int,int,int,int,int,int,string>;\n@@ -942,6 +866,53 @@ int check_module_checksums_sync(\n \t\t}\n \t}\n \n+\t// Check that the primary has updated monitored checksums:\n+\t//  - It's own checksum (monitoring itself).\n+\t//  - The new checksum from replica after its sync.\n+\t// This is important to avoid race conditions. If this sync is not performed, the primary may detect the\n+\t// new checksum in the replica confusing this with the previous check.\n+\t{\n+\t\tconst char prim_repl_sync_t[] {\n+\t\t\t\"SELECT count(*) FROM stats_proxysql_servers_checksums WHERE \"\n+\t\t\t\t\"hostname='%s' AND port='%d' AND name='%s' AND checksum='%s'\"\n+\t\t};\n+\t\tcfmt_t wait_remote_chksm_syn {\n+\t\t\tcstr_format( prim_repl_sync_t,\n+\t\t\t\tconn_opts.host.c_str(),\n+\t\t\t\tconn_opts.port,\n+\t\t\t\tmodule.c_str(),\n+\t\t\t\text_checksum.str.c_str()\n+\t\t\t)\n+\t\t};\n+\t\tconst char prim_own_sync_t[] {\n+\t\t\t\"SELECT count(*) FROM stats_proxysql_servers_checksums WHERE \"\n+\t\t\t\t\"hostname='%s' AND port='%d' AND name='%s' AND checksum='%s'\"\n+\t\t};\n+\t\tcfmt_t wait_own_chksm_sync {\n+\t\t\tcstr_format(\n+\t\t\t\tprim_repl_sync_t,\n+\t\t\t\tconn_opts.host.c_str(),\n+\t\t\t\tconn_opts.port,\n+\t\t\t\tmodule.c_str(),\n+\t\t\t\text_checksum.str.c_str()\n+\t\t\t)\n+\t\t};\n+\n+\t\tint sync_res = wait_for_node_sync(admin, { wait_remote_chksm_syn.str }, CHECKSUM_SYNC_TIMEOUT);\n+\t\tok(\n+\t\t\tsync_res == 0,\n+\t\t\t\"Primary(%s:%d) has detected the new checksum '%s' in the replica(%s:%d)\",\n+\t\t\tadmin->host, admin->port, ext_checksum.str.c_str(), r_admin->host, r_admin->port\n+\t\t);\n+\n+\t\tsync_res = wait_for_node_sync(admin, { wait_remote_chksm_syn.str }, CHECKSUM_SYNC_TIMEOUT);\n+\t\tok(\n+\t\t\tsync_res == 0,\n+\t\t\t\"Primary(%s:%d) has detected its own new checksum '%s'\",\n+\t\t\tadmin->host, admin->port, ext_checksum.str.c_str()\n+\t\t);\n+\t}\n+\n \treturn EXIT_SUCCESS;\n }\n \n@@ -1139,17 +1110,31 @@ int main(int, char**) {\n \t\treturn EXIT_FAILURE;\n \t}\n \n-\tconst size_t num_pls = module_sync_payloads.size();\n+\tconst size_t dis_mod_checks = 7;\n+\tconst size_t ena_mod_checks = 5;\n+\tconst size_t sync_pls = module_sync_payloads.size();\n \n-\tconst size_t all_mod_sync_checks = ((5+(3*(num_pls-1)))*(num_pls-1))*2 + (5+(3*(num_pls-1)));\n-\tconst size_t mod_sync_checks = ((3*4*(num_pls-1)) + 3*2);\n-\tconst size_t init_mod_sync_checks = (3*2*num_pls);\n+\t// check_all_modules_sync: 'ENABLED' mods sync and 'DISABLED' doesn't - REMOTE / MAIN\n+\tconst size_t check_all_modules_sync__tests = dis_mod_checks + (ena_mod_checks * (sync_pls-1));\n+\n+\t// check_modules_checksums_sync:  All modules checksums tests\n+\tconst size_t check_modules_checksums_sync__tests =\n+\t\t// 1: All 'ENABLED' modules sync - REMOTE / MAIN\n+\t\tsync_pls * ena_mod_checks * 2 +\n+\t\t// 2: Check all mods sync but disabled one\n+\t\tcheck_all_modules_sync__tests * sync_pls +\n+\t\t// 3: Re-enable module and check sync both ways\n+\t\tena_mod_checks * 2 * sync_pls +\n+\t\t// 4: Disable module via checksums and check again\n+\t\tcheck_all_modules_sync__tests * (sync_pls - 1) +\n+\t\t// 5: Re-enable module and check sync both ways\n+\t\tena_mod_checks * 2 * (sync_pls - 1);\n \n \tplan(\n \t\t// Sync tests by values\n \t\t16 +\n-\t\t// Module with disabled sync checksum tests\n-\t\tinit_mod_sync_checks + all_mod_sync_checks + mod_sync_checks\n+\t\t// Module checkums tests; enabled and disabled checksums\n+\t\tcheck_modules_checksums_sync__tests\n \t);\n \n \tconst std::string fmt_config_file = std::string(cl.workdir) + \"test_cluster_sync_config/test_cluster_sync.cnf\";\n@@ -1188,10 +1173,9 @@ int main(int, char**) {\n \tMYSQL_QUERY(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==6032\");\n \tMYSQL_QUERY(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==16062\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n-\tMYSQL_QUERY(proxy_admin, \"SELECT hostname,port FROM proxysql_servers\");\n-\tMYSQL_RES* my_res = mysql_store_result(proxy_admin);\n-\tvector<mysql_res_row> core_nodes { extract_mysql_rows(my_res) };\n-\tmysql_free_result(my_res);\n+\n+\tpair<int,vector<srv_addr_t>> nodes_fetch { fetch_cluster_nodes(proxy_admin) };\n+\tif (nodes_fetch.first) { return EXIT_FAILURE; }\n \n \t// 3. Wait for all Core nodes to sync (confirm primary out of core nodes)\n \tstring check_no_primary_query {};\n@@ -1200,7 +1184,7 @@ int main(int, char**) {\n \t\tcheck_no_primary_query, cl.host, cl.admin_port\n \t);\n \n-\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\tint check_res = check_nodes_sync(cl, nodes_fetch.second, check_no_primary_query, SYNC_TIMEOUT);\n \tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t// 4. Remove all current servers from primary instance (only secondary sync matters)\n@@ -1967,12 +1951,14 @@ int main(int, char**) {\n \t\tstd::cout << \"MASTER TABLE BEFORE SYNC:\" << std::endl;\n \t\tsystem(print_master_proxysql_servers.c_str());\n \n-\t\tint check_res = sync_checker(r_proxy_admin, select_proxysql_servers_queries, SYNC_TIMEOUT);\n+\t\tint wait_res = proc_wait_checks(\n+\t\t\twait_for_conds(r_proxy_admin, select_proxysql_servers_queries, SYNC_TIMEOUT)\n+\t\t);\n \n \t\tstd::cout << \"REPLICA TABLE AFTER SYNC:\" << std::endl;\n \t\tsystem(print_replica_proxysql_servers.c_str());\n \n-\t\tok(check_res == EXIT_SUCCESS, \"'proxysql_servers' with should be synced: '%d'\", check_res);\n+\t\tok(wait_res == EXIT_SUCCESS, \"'proxysql_servers' with should be synced: '%d'\", wait_res);\n \n \t\t// TEARDOWN CONFIG\n \t\tMYSQL_QUERY__(proxy_admin, \"DELETE FROM proxysql_servers\");\n@@ -2009,10 +1995,13 @@ int main(int, char**) {\n \t\tsystem(print_master_proxysql_servers.c_str());\n \n \t\t// 3. Check that the servers have been synced in the replica\n-\t\tint check_res =\n-\t\t\tsync_checker(\n-\t\t\t\tr_proxy_admin, { \"SELECT CASE count(*) WHEN 0 THEN 1 ELSE 0 END from proxysql_servers\" }, SYNC_TIMEOUT\n-\t\t\t);\n+\t\tint wait_res = proc_wait_checks(\n+\t\t\twait_for_conds(\n+\t\t\t\tr_proxy_admin,\n+\t\t\t\t{ \"SELECT CASE count(*) WHEN 0 THEN 1 ELSE 0 END from proxysql_servers\" },\n+\t\t\t\tSYNC_TIMEOUT\n+\t\t\t)\n+\t\t);\n \n \t\tstd::cout << \"REPLICA TABLE AFTER SYNC:\" << std::endl;\n \t\tsystem(print_replica_proxysql_servers.c_str());\n@@ -2028,7 +2017,7 @@ int main(int, char**) {\n \t\tMYSQL_QUERY__(r_proxy_admin, \"DROP TABLE IF EXISTS proxysql_servers_backup\");\n \t\tMYSQL_QUERY__(r_proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n \n-\t\tok(check_res == EXIT_SUCCESS, \"Empty 'proxysql_servers' table ('0x00' checksum) should be synced: '%d'\", check_res);\n+\t\tok(wait_res == EXIT_SUCCESS, \"Empty 'proxysql_servers' table ('0x00' checksum) should be synced: '%d'\", wait_res);\n \t}\n \n \tsleep(2);\n@@ -2525,7 +2514,7 @@ int main(int, char**) {\n \t\t//\tstd::make_tuple(\"admin-cluster_username\"                           , \"\"                          ), Known issue, can't clear\n \t\t//\tstd::make_tuple(\"admin-cluster_password\"                           , \"\"                          ), Known issue, can't clear\n \t\t//\tstd::make_tuple(\"admin-debug\"                                      , \"false\"                     ), Should not be synced\n-//\t\t\tstd::make_tuple(\"admin-hash_passwords\"                             , \"true\"                      ), // deprecated variable\n+\t\t//\tstd::make_tuple(\"admin-hash_passwords\"                             , \"true\"                      ), // deprecated variable\n \t\t//\tstd::make_tuple(\"admin-mysql_ifaces\"                               , \"0.0.0.0:6032\"              ), // disabled because of cluster_sync_interfaces=false\n \t\t\tstd::make_tuple(\"admin-prometheus_memory_metrics_interval\"         , \"61\"                        ),\n \t\t\tstd::make_tuple(\"admin-read_only\"                                  , \"false\"                     ),\n@@ -2715,14 +2704,16 @@ int main(int, char**) {\n \t\t\tinsert_query, cl.host, cl.admin_port\n \t\t);\n \n-\t\tfor (const auto& row : core_nodes) {\n-\t\t\tconst string host { row[0] };\n-\t\t\tconst int port = std::stol(row[1]);\n+\t\tfor (const auto& node : nodes_fetch.second) {\n \t\t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n-\t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", host.c_str(), port);\n+\t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", node.host.c_str(), node.port);\n \n-\t\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n+\t\t\tif (\n+\t\t\t\t!mysql_real_connect(\n+\t\t\t\t\tc_node_admin, node.host.c_str(), cl.admin_username, cl.admin_password, NULL, node.port, NULL, 0\n+\t\t\t\t)\n+\t\t\t) {\n \t\t\t\tconst string err_msg {\n \t\t\t\t\t\"Connection to core node failed with '\" + string { mysql_error(c_node_admin) } + \"'. Retrying...\"\n \t\t\t\t};\n@@ -2751,7 +2742,7 @@ int main(int, char**) {\n \t\t);\n \n \t\t// Wait for the other nodes to sync ProxySQL servers to include Primary\n-\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\tint check_res = check_nodes_sync(cl, nodes_fetch.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t\t// Recover the old ProxySQL servers from backup in primary\ndiff --git a/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp b/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp\nindex 4a84270c2f..6b4c8f4f9d 100644\n--- a/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp\n+++ b/test/tap/tests/test_cluster_sync_mysql_servers-t.cpp\n@@ -24,20 +24,16 @@\n  */\n \n #include <unistd.h>\n-#include <signal.h>\n #include <pthread.h>\n #include <stdio.h>\n #include <time.h>\n-#include <errno.h>\n \n #include <atomic>\n #include <vector>\n #include <string>\n #include <thread>\n #include <iostream>\n-#include <fstream>\n #include <functional>\n-#include <regex>\n #include <utility>\n \n #include \"libconfig.h\"\n@@ -53,7 +49,9 @@\n #include \"command_line.h\"\n #include \"utils.h\"\n \n+using std::pair;\n using std::string;\n+using std::vector;\n \n #define MYSQL_QUERY__(mysql, query) \\\n \tdo { \\\n@@ -132,83 +130,6 @@ uint64_t mysql_servers_raw_checksum(MYSQL_RES* resultset) {\n \treturn res_hash;\n }\n \n-\n-/**\n- * @brief Helper function to verify that the sync of a table (or variable) have been performed.\n- *\n- * @param r_proxy_admin An already opened connection to ProxySQL.\n- * @param queries Queries to be executed that should return a **non-zero** value after the sync has taken place.\n- * @param sync_timeout Timeout for the sync to happen.\n- *\n- * @return EXIT_SUCCESS in case of success, otherwise:\n- *  - '-1' if a query against Admin fails to be performed (failure is logged).\n- *  - '-2' if timeout expired without sync being completed.\n- */\n-int sync_checker(MYSQL* r_proxy_admin, const std::vector<std::string>& queries, uint32_t sync_timeout) {\n-\tbool not_synced_query = false;\n-\tuint waited = 0;\n-\n-\twhile (waited < sync_timeout) {\n-\t\tnot_synced_query = false;\n-\n-\t\t// Check that all the entries have been synced\n-\t\tfor (const auto& query : queries) {\n-\t\t\tint q_res = mysql_query(r_proxy_admin, query.c_str());\n-\t\t\tif (q_res != EXIT_SUCCESS) {\n-\t\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(r_proxy_admin));\n-\t\t\t\treturn -1;\n-\t\t\t}\n-\n-\t\t\tMYSQL_RES* proxysql_servers_res = mysql_store_result(r_proxy_admin);\n-\t\t\tMYSQL_ROW row = mysql_fetch_row(proxysql_servers_res);\n-\t\t\tint row_value = atoi(row[0]);\n-\t\t\tmysql_free_result(proxysql_servers_res);\n-\n-\t\t\tif (row_value == 0) {\n-\t\t\t\tnot_synced_query = true;\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t}\n-\n-\t\tif (not_synced_query) {\n-\t\t\twaited += 1;\n-\t\t\tsleep(1);\n-\t\t} else {\n-\t\t\tbreak;\n-\t\t}\n-\t}\n-\n-\tif (not_synced_query) {\n-\t\treturn -2;\n-\t} else {\n-\t\treturn EXIT_SUCCESS;\n-\t}\n-}\n-\n-int check_nodes_sync(\n-\tconst CommandLine& cl, const std::vector<mysql_res_row>& core_nodes, const std::string& check_query, uint32_t sync_timeout\n-) {\n-\tfor (const auto& node : core_nodes) {\n-\t\tconst std::string host { node[0] };\n-\t\tconst int port = std::stol(node[1]);\n-\n-\t\tMYSQL* c_node_admin = mysql_init(NULL);\n-\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(c_node_admin));\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\n-\t\tint not_synced = sync_checker(c_node_admin, { check_query }, sync_timeout);\n-\t\tif (not_synced != EXIT_SUCCESS) {\n-\t\t\tconst std::string err_msg { \"Node '\"  + host + \":\" + std::to_string(port) + \"' sync timed out\" };\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: `%s`\\n\", __FILE__, __LINE__, err_msg.c_str());\n-\t\t\treturn EXIT_FAILURE;\n-\t\t}\n-\t}\n-\n-\treturn EXIT_SUCCESS;\n-}\n-\n int insert_mysql_servers_records(MYSQL* proxy_admin, const std::vector<mysql_server_tuple>& insert_mysql_servers_values, \n \tconst std::vector<replication_hostgroups_tuple>& insert_replication_hostgroups_values) {\n \n@@ -860,15 +781,15 @@ int main(int, char**) {\n \t// 2. Remove primary from Core nodes\n \tMYSQL_QUERY(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==6032\");\n \tMYSQL_QUERY(proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n-\tMYSQL_QUERY(proxy_admin, \"SELECT hostname,port FROM proxysql_servers\");\n-\tMYSQL_RES* my_res = mysql_store_result(proxy_admin);\n-\tstd::vector<mysql_res_row> core_nodes { extract_mysql_rows(my_res) };\n-\tmysql_free_result(my_res);\n+\n+\tpair<int,vector<srv_addr_t>> core_nodes { fetch_cluster_nodes(proxy_admin) };\n+\tif (core_nodes.first) { return EXIT_FAILURE; }\n \n \t// 2.1 If core nodes are not reachable, assume no cluster is running; make test gracefully exit\n-\tif (core_nodes.size()) {\n-\t\tconst string host { core_nodes[0][0] };\n-\t\tconst int port = std::stol(core_nodes[0][1]);\n+\tif (core_nodes.second.size()) {\n+\t\tconst string host { core_nodes.second[0].host };\n+\t\tconst int port { core_nodes.second[0].port };\n+\n \t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n \t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n@@ -894,7 +815,7 @@ int main(int, char**) {\n \t\tcheck_no_primary_query, cl.host, cl.admin_port\n \t);\n \n-\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t// 4. Remove all current servers from primary instance (only secondary sync matters)\n@@ -1048,9 +969,9 @@ int main(int, char**) {\n \t\t\tinsert_query, cl.host, cl.admin_port\n \t\t);\n \n-\t\tfor (const auto& row : core_nodes) {\n-\t\t\tconst std::string host { row[0] };\n-\t\t\tconst int port = std::stol(row[1]);\n+\t\tfor (const auto& node : core_nodes.second) {\n+\t\t\tconst std::string host { node.host };\n+\t\t\tconst int port = node.port;\n \t\t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n \t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", host.c_str(), port);\n@@ -1084,7 +1005,7 @@ int main(int, char**) {\n \t\t);\n \n \t\t// Wait for the other nodes to sync ProxySQL servers to include Primary\n-\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t\t// Recover the old ProxySQL servers from backup in primary\ndiff --git a/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp b/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp\nindex 90380e20f9..7ab4af208e 100644\n--- a/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp\n+++ b/test/tap/tests/test_read_only_actions_offline_hard_servers-t.cpp\n@@ -1,8 +1,8 @@\n-\n #include <unistd.h>\n-#include <atomic>\n #include <vector>\n #include <string>\n+#include <utility>\n+#include <vector>\n \n #include \"mysql.h\"\n #include \"tap.h\"\n@@ -15,6 +15,9 @@\n //#define BACKEND_SERVER_USER\t\"root\"\n //#define BACKEND_SERVER_PASS \"root\"\n \n+using std::vector;\n+using std::pair;\n+\n #define MYSQL_QUERY__(mysql, query) \\\n \tdo { \\\n \t\tif (mysql_query(mysql, query)) { \\\n@@ -49,87 +52,6 @@ MYSQL* create_new_connection(const char* host, const char* username, const char*\n \treturn mysql;\n }\n \n-/**\n- * @brief Helper function to verify that the sync of a table (or variable) have been performed.\n- *\n- * @param r_proxy_admin An already opened connection to ProxySQL.\n- * @param queries Queries to be executed that should return a **non-zero** value after the sync has taken place.\n- * @param sync_timeout Timeout for the sync to happen.\n- *\n- * @return EXIT_SUCCESS in case of success, otherwise:\n- *  - '-1' if a query against Admin fails to be performed (failure is logged).\n- *  - '-2' if timeout expired without sync being completed.\n- */\n-int sync_checker(MYSQL* r_proxy_admin, const std::vector<std::string>& queries, uint32_t sync_timeout) {\n-\tbool not_synced_query = false;\n-\tuint waited = 0;\n-\n-\twhile (waited < sync_timeout) {\n-\t\tnot_synced_query = false;\n-\n-\t\t// Check that all the entries have been synced\n-\t\tfor (const auto& query : queries) {\n-\t\t\tint q_res = mysql_query(r_proxy_admin, query.c_str());\n-\t\t\tif (q_res != EXIT_SUCCESS) {\n-\t\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(r_proxy_admin));\n-\t\t\t\treturn -1;\n-\t\t\t}\n-\n-\t\t\tMYSQL_RES* proxysql_servers_res = mysql_store_result(r_proxy_admin);\n-\t\t\tMYSQL_ROW row = mysql_fetch_row(proxysql_servers_res);\n-\t\t\tint row_value = atoi(row[0]);\n-\t\t\tmysql_free_result(proxysql_servers_res);\n-\n-\t\t\tif (row_value == 0) {\n-\t\t\t\tnot_synced_query = true;\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t}\n-\n-\t\tif (not_synced_query) {\n-\t\t\twaited += 1;\n-\t\t\tsleep(1);\n-\t\t} else {\n-\t\t\tbreak;\n-\t\t}\n-\t}\n-\n-\tif (not_synced_query) {\n-\t\treturn -2;\n-\t} else {\n-\t\treturn EXIT_SUCCESS;\n-\t}\n-}\n-\n-int check_nodes_sync(\n-\tconst CommandLine& cl, const std::vector<mysql_res_row>& core_nodes, const std::string& check_query, uint32_t sync_timeout\n-) {\n-\tint ret_status = EXIT_FAILURE;\n-\n-\tfor (const auto& node : core_nodes) {\n-\t\tconst std::string host { node[0] };\n-\t\tconst int port = std::stol(node[1]);\n-\n-\t\tMYSQL* c_node_admin = mysql_init(NULL);\n-\t\tif (!mysql_real_connect(c_node_admin, host.c_str(), cl.admin_username, cl.admin_password, NULL, port, NULL, 0)) {\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(c_node_admin));\n-\t\t\tgoto __exit;\n-\t\t}\n-\n-\t\tint not_synced = sync_checker(c_node_admin, { check_query }, sync_timeout);\n-\t\tif (not_synced != EXIT_SUCCESS) {\n-\t\t\tconst std::string err_msg { \"Node '\"  + host + \":\" + std::to_string(port) + \"' sync timed out\" };\n-\t\t\tfprintf(stderr, \"File %s, line %d, Error: `%s`\\n\", __FILE__, __LINE__, err_msg.c_str());\n-\t\t\tgoto __exit;\n-\t\t}\n-\t}\n-\n-\tret_status = EXIT_SUCCESS;\n-\n-__exit:\n-\treturn ret_status;\n-}\n-\n int insert_mysql_servers_records(MYSQL* proxy_admin, const std::vector<mysql_server_tuple>& insert_mysql_servers_values, \n \tconst std::vector<replication_hostgroups_tuple>& insert_replication_hostgroups_values) {\n \n@@ -535,7 +457,7 @@ int test_scenario_2(MYSQL* proxy_admin, const CommandLine& cl) {\n \n int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& cl, bool isolate_primary_node) {\n \n-\tstd::vector<mysql_res_row> core_nodes;\n+\tpair<int,vector<srv_addr_t>> core_nodes;\n \tstd::string check_no_primary_query;\n \n \tif (isolate_primary_node) {\n@@ -553,10 +475,9 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t// 2. Remove primary from Core nodes\n \t\tMYSQL_QUERY__(proxy_admin, \"DELETE FROM proxysql_servers WHERE hostname=='127.0.0.1' AND PORT==6032\");\n \t\tMYSQL_QUERY__(proxy_admin, \"LOAD PROXYSQL SERVERS TO RUNTIME\");\n-\t\tMYSQL_QUERY__(proxy_admin, \"SELECT hostname,port FROM proxysql_servers\");\n-\t\tMYSQL_RES* my_res = mysql_store_result(proxy_admin);\n-\t\tcore_nodes = { extract_mysql_rows(my_res) };\n-\t\tmysql_free_result(my_res);\n+\n+\t\tcore_nodes = fetch_cluster_nodes(proxy_admin);\n+\t\tif (core_nodes.first) { goto cleanup; }\n \n \t\t// 3. Wait for all Core nodes to sync (confirm primary out of core nodes)\n \t\tstring_format(\n@@ -564,7 +485,7 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t\tcheck_no_primary_query, cl.host, cl.admin_port\n \t\t);\n \n-\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\tif (check_res != EXIT_SUCCESS) {\n \t\t\tgoto cleanup;\n \t\t}\n@@ -601,9 +522,9 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t\t\tinsert_query, cl.host, cl.admin_port\n \t\t\t);\n \n-\t\t\tfor (const auto& row : core_nodes) {\n-\t\t\t\tconst std::string host{ row[0] };\n-\t\t\t\tconst int port = std::stol(row[1]);\n+\t\t\tfor (const auto& row : core_nodes.second) {\n+\t\t\t\tconst std::string host{ row.host };\n+\t\t\t\tconst int port = row.port;\n \t\t\t\tMYSQL* c_node_admin = mysql_init(NULL);\n \n \t\t\t\tdiag(\"RESTORING: Inserting into node '%s:%d'\", host.c_str(), port);\n@@ -637,7 +558,7 @@ int test_read_only_offline_hard_servers(MYSQL* proxy_admin, const CommandLine& c\n \t\t\t);\n \n \t\t\t// Wait for the other nodes to sync ProxySQL servers to include Primary\n-\t\t\tint check_res = check_nodes_sync(cl, core_nodes, check_no_primary_query, SYNC_TIMEOUT);\n+\t\t\tint check_res = check_nodes_sync(cl, core_nodes.second, check_no_primary_query, SYNC_TIMEOUT);\n \t\t\tif (check_res != EXIT_SUCCESS) { return EXIT_FAILURE; }\n \n \t\t\t// Recover the old ProxySQL servers from backup in primary\ndiff --git a/test/tap/tests/test_session_status_flags-t.cpp b/test/tap/tests/test_session_status_flags-t.cpp\nindex 181c2561b5..2849fa49e8 100644\n--- a/test/tap/tests/test_session_status_flags-t.cpp\n+++ b/test/tap/tests/test_session_status_flags-t.cpp\n@@ -172,7 +172,7 @@ int prepare_stmt_queries(const CommandLine& cl, const vector<query_t>& p_queries\n \t// 1. Prepare the stmt in a connection\n \tMYSQL* proxy_mysql = mysql_init(NULL);\n \n-\tdiag(\"%s: Openning INITIAL connection...\", tap_curtime().c_str());\n+\tdiag(\"Openning INITIAL connection...\");\n \tif (!mysql_real_connect(proxy_mysql, cl.root_host, cl.root_username, cl.root_password, NULL, cl.root_port, NULL, 0)) {\n \t\tfprintf(stderr, \"File %s, line %d, Error: %s\\n\", __FILE__, __LINE__, mysql_error(proxy_mysql));\n \t\treturn EXIT_FAILURE;\n@@ -216,7 +216,7 @@ int prepare_stmt_queries(const CommandLine& cl, const vector<query_t>& p_queries\n \t\t\treturn EXIT_FAILURE;\n \t\t}\n \n-\t\tdiag(\"%s: Issuing PREPARE for `%s` in INIT conn\", tap_curtime().c_str(), query.c_str());\n+\t\tdiag(\"Issuing PREPARE for `%s` in INIT conn\", query.c_str());\n \t\tint my_err = mysql_stmt_prepare(stmt, query.c_str(), strlen(query.c_str()));\n \t\tif (my_err) {\n \t\t\tdiag(\n@@ -229,7 +229,7 @@ int prepare_stmt_queries(const CommandLine& cl, const vector<query_t>& p_queries\n \t\tmysql_stmt_close(stmt);\n \t}\n \n-\tdiag(\"%s: Closing PREPARING connection...\", tap_curtime().c_str());\n+\tdiag(\"Closing PREPARING connection...\");\n \tmysql_close(proxy_mysql);\n \n \treturn EXIT_SUCCESS;\n@@ -326,7 +326,7 @@ int exec_stmt_queries(MYSQL* proxy_mysql, const vector<query_t>& test_queries) {\n \t\t} else {\n \t\t\tMYSQL_STMT* stmt = mysql_stmt_init(proxy_mysql);\n \n-\t\t\tdiag(\"%s: Issuing PREPARE for `%s` in new conn\", tap_curtime().c_str(), query.c_str());\n+\t\t\tdiag(\"Issuing PREPARE for `%s` in new conn\", query.c_str());\n \t\t\tint my_err = mysql_stmt_prepare(stmt, query.c_str(), strlen(query.c_str()));\n \t\t\tif (my_err) {\n \t\t\t\tdiag(\n@@ -339,7 +339,7 @@ int exec_stmt_queries(MYSQL* proxy_mysql, const vector<query_t>& test_queries) {\n \t\t\t// TODO: Remember to DOC requiring to execute\n \t\t\t{\n \t\t\t\tif (rep_check.first == 0 || rep_check.second == 0) {\n-\t\t\t\t\tdiag(\"%s: Issuing EXECUTE for `%s` in new conn\", tap_curtime().c_str(), query.c_str());\n+\t\t\t\t\tdiag(\"Issuing EXECUTE for `%s` in new conn\", query.c_str());\n \t\t\t\t\tmy_err = mysql_stmt_execute(stmt);\n \t\t\t\t\tif (my_err) {\n \t\t\t\t\t\tdiag(\"'mysql_stmt_execute' at line %d failed: %s\", __LINE__, mysql_stmt_error(stmt));\ndiff --git a/test/tap/tests/test_unshun_algorithm-t.cpp b/test/tap/tests/test_unshun_algorithm-t.cpp\nindex 4a5714eaaf..7b424a7fdd 100644\n--- a/test/tap/tests/test_unshun_algorithm-t.cpp\n+++ b/test/tap/tests/test_unshun_algorithm-t.cpp\n@@ -59,12 +59,12 @@\n \n #include <cstring>\n #include <unistd.h>\n-#include <vector>\n #include <string>\n #include <stdio.h>\n+#include <utility>\n+#include <vector>\n \n #include \"mysql.h\"\n-#include \"mysqld_error.h\"\n \n #include \"proxysql_utils.h\"\n #include \"tap.h\"\n@@ -74,14 +74,17 @@\n const uint32_t SHUN_RECOVERY_TIME = 1;\n const uint32_t VALID_RANGE = 1;\n const uint32_t SERVERS_COUNT = 10;\n+const uint32_t SYNC_TIMEOUT = 10;\n \n+using std::pair;\n using std::string;\n+using std::vector;\n \n int shunn_server(MYSQL* proxysql_admin, uint32_t i, uint32_t j) {\n \tstd::string t_simulator_error_query { \"PROXYSQL_SIMULATOR mysql_error %d 127.0.0.1:330%d 1234\" };\n \tstd::string simulator_error_q_i {};\n \tstring_format(t_simulator_error_query, simulator_error_q_i, i, j);\n-\tdiag(\"%s: running query: %s\", tap_curtime().c_str(), simulator_error_q_i.c_str());\n+\tdiag(\"running query: %s\", simulator_error_q_i.c_str());\n \tMYSQL_QUERY(proxysql_admin, simulator_error_q_i.c_str());\n \n \treturn EXIT_SUCCESS;\n@@ -113,7 +116,7 @@ int wakup_target_server(MYSQL* proxysql_mysql, uint32_t i) {\n \tstring_format(t_simple_do_query, simple_do_query, i);\n \n \tmysql_query(proxysql_mysql, simple_do_query.c_str());\n-\tdiag(\"%s: running query: %s\", tap_curtime().c_str(), simple_do_query.c_str());\n+\tdiag(\"running query: %s\", simple_do_query.c_str());\n \n \treturn EXIT_SUCCESS;\n }\n@@ -124,7 +127,7 @@ int server_status_checker(MYSQL* admin, const string& f_st, const string& n_st,\n \t};\n \tstd::string server_status_query {};\n \tstring_format(t_server_status_query, server_status_query, i);\n-\tdiag(\"%s: running query: %s\", tap_curtime().c_str(), server_status_query.c_str());\n+\tdiag(\"running query: %s\", server_status_query.c_str());\n \tMYSQL_QUERY(admin, server_status_query.c_str());\n \n \tMYSQL_RES* status_res = mysql_store_result(admin);\n@@ -190,9 +193,9 @@ int test_unshun_algorithm_variable(MYSQL* proxysql_admin) {\n \t};\n \n \tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES FROM DISK\");\n-\tdiag(\"%s: Line:%d running admin query to reload variables: LOAD MYSQL VARIABLES FROM DISK\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query to reload variables: LOAD MYSQL VARIABLES FROM DISK\", __LINE__);\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-hostgroup_manager_verbose=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", __LINE__);\n \tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \tint32_t def_unshun_value = get_current_unshun_algorithm_val(proxysql_admin);\n \tok(def_unshun_value == 0, \"Default 'mysql-unshun_algorithm' should be '0', actual: %d\", def_unshun_value);\n@@ -203,7 +206,7 @@ int test_unshun_algorithm_variable(MYSQL* proxysql_admin) {\n \t\tstd::string set_unshun {};\n \t\tstring_format(t_set_unshun, set_unshun, i);\n \t\tMYSQL_QUERY(proxysql_admin, set_unshun.c_str());\n-\t\tdiag(\"%s: Line:%d running admin query: %s\", tap_curtime().c_str(), __LINE__, set_unshun.c_str());\n+\t\tdiag(\"Line:%d running admin query: %s\", __LINE__, set_unshun.c_str());\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint32_t cur_unshun_val = get_current_unshun_algorithm_val(proxysql_admin);\n@@ -214,7 +217,7 @@ int test_unshun_algorithm_variable(MYSQL* proxysql_admin) {\n \t\tstd::string set_unshun {};\n \t\tstring_format(t_set_unshun, set_unshun, VALID_RANGE + 1);\n \t\tMYSQL_QUERY(proxysql_admin, set_unshun.c_str());\n-\t\tdiag(\"%s: Line:%d running admin query: %s\", tap_curtime().c_str(), __LINE__, set_unshun.c_str());\n+\t\tdiag(\"Line:%d running admin query: %s\", __LINE__, set_unshun.c_str());\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint32_t cur_unshun_val = get_current_unshun_algorithm_val(proxysql_admin);\n@@ -273,13 +276,13 @@ int test_proxysql_simulator_error(MYSQL* proxysql_admin) {\n  */\n int configure_mysql_shunning_variables(MYSQL* proxysql_admin) {\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-shun_on_failures=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-shun_on_failures=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-shun_on_failures=3\", __LINE__);\n \n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-connect_retries_on_failure=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-connect_retries_on_failure=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-connect_retries_on_failure=3\", __LINE__);\n \n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-connect_retries_delay=1000\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-connect_retries_delay=1000\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-connect_retries_delay=1000\", __LINE__);\n \n \treturn EXIT_SUCCESS;\n }\n@@ -287,11 +290,11 @@ int configure_mysql_shunning_variables(MYSQL* proxysql_admin) {\n int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin) {\n \t// Configure Admin variables with lower thresholds\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-shun_recovery_time_sec=1\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-shun_recovery_time_sec=1\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-shun_recovery_time_sec=1\", __LINE__);\n \n \t// Set verbosity up for extra information in ProxySQL log\n \tMYSQL_QUERY(proxysql_admin, \"SET mysql-hostgroup_manager_verbose=3\");\n-\tdiag(\"%s: Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", tap_curtime().c_str(), __LINE__);\n+\tdiag(\"Line:%d running admin query: SET mysql-hostgroup_manager_verbose=3\", __LINE__);\n \n \t// Configure the relevant variables for the desired UNSHUNNING behavior\n \tif (configure_mysql_shunning_variables(proxysql_admin)) {\n@@ -324,7 +327,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \n \t{\n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=0\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=0\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=0\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint shunn_err = shunn_all_servers(proxysql_admin);\n@@ -344,7 +347,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \n \t{\n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=1\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=1\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=1\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint shunn_err = shunn_all_servers(proxysql_admin);\n@@ -364,7 +367,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \n \t{\n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=0\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=0\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=0\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tint shunn_err = shunn_all_servers(proxysql_admin);\n@@ -376,7 +379,7 @@ int test_unshun_algorithm_behavior(MYSQL* proxysql_mysql, MYSQL* proxysql_admin)\n \t\tdiag(\" \"); // empty line\n \n \t\tMYSQL_QUERY(proxysql_admin, \"SET mysql-unshun_algorithm=1\");\n-\t\tdiag(\"%s: Line:%d running admin query: SET mysql-unshun_algorithm=1\", tap_curtime().c_str(), __LINE__);\n+\t\tdiag(\"Line:%d running admin query: SET mysql-unshun_algorithm=1\", __LINE__);\n \t\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n \n \t\tfor (uint32_t i = 0; i < SERVERS_COUNT; i++) {\n@@ -426,8 +429,43 @@ int main(int argc, char** argv) {\n \t}\n \n \t// Disable Monitor for the following tests\n-\tMYSQL_QUERY(proxysql_admin, \"SET mysql-monitor_enabled=0\");\n-\tMYSQL_QUERY(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\tMYSQL_QUERY_T(proxysql_admin, \"SET mysql-monitor_enabled=0\");\n+\tMYSQL_QUERY_T(proxysql_admin, \"LOAD MYSQL VARIABLES TO RUNTIME\");\n+\n+\t// We need to wait for synchronization in case 'admin-cluster_mysql_servers_sync_algorithm=1' to prevent\n+\t// circular fetches. If config is set to '2' we DO NOT wait, as circular fetches shouldn't be possible,\n+\t// this way a misbehavior **could** be detected by the test. We do not enforce failure either.\n+\t{\n+\t\tconst char sync_algo_query[] {\n+\t\t\t\"SELECT variable_value FROM global_variables\"\n+\t\t\t\t\" WHERE variable_name='admin-cluster_mysql_servers_sync_algorithm'\",\n+\t\t};\n+\t\text_val_t<int32_t> servers_sync_algo { mysql_query_ext_val(proxysql_admin, sync_algo_query, 1) };\n+\t\tif (servers_sync_algo.err != EXIT_SUCCESS) {\n+\t\t\tconst string err { get_ext_val_err(proxysql_admin, servers_sync_algo) };\n+\t\t\tdiag(\"Failed getting variable   query:`%s`, err:`%s`\", sync_algo_query, err.c_str());\n+\t\t\tgoto cleanup;\n+\t\t}\n+\n+\t\t// NOTE: '3' is a configuration thought for replicas, this test assumes it's connecting to a\n+\t\t// primary, so the same protection should be applied.\n+\t\tif (servers_sync_algo.val == 1 || servers_sync_algo.val == 3) {\n+\t\t\tconst pair<int,vector<srv_addr_t>> core_nodes { fetch_cluster_nodes(proxysql_admin) };\n+\t\t\tif (core_nodes.first) {\n+\t\t\t\tdiag(\"Cluster node fetching failed with mysql_errno=%d\", core_nodes.first);\n+\t\t\t\tgoto cleanup;\n+\t\t\t}\n+\n+\t\t\tconst char sync_query[] {\n+\t\t\t\t\"SELECT CASE WHEN \"\n+\t\t\t\t\t\"(SELECT variable_value FROM runtime_global_variables WHERE\"\n+\t\t\t\t\t\t\" variable_name='mysql-monitor_enabled')='false'\"\n+\t\t\t\t\t\" THEN 1 ELSE 0 END\"\n+\t\t\t};\n+\t\t\tint check_res = check_nodes_sync(cl, core_nodes.second, sync_query, SYNC_TIMEOUT);\n+\t\t\tif (check_res != EXIT_SUCCESS) { goto cleanup; }\n+\t\t}\n+\t}\n \n \t{\n \t\tint simulator_err = test_proxysql_simulator_error(proxysql_admin);\n", "problem_statement": "Handle nicely `SET` failure with `ER_WRONG_ARGUMENTS` for `sql_generate_invisible_primary_key`\n## Description\r\n\r\nIf you are submitting a reproducible bug report, please provide:\r\n\r\n- [x] A clear description of the issue\r\n\r\nMySQL has changed how the setting `sql_generate_invisible_primary_key` is reported for `Galera`. For version `8.0.28-26.10` error was still `ER_UNKNOWN_SYSTEM_VARIABLE`, yet in newer versions like `8.0.34-26.15` error has changed to `ER_WRONG_ARGUMENTS`:\r\n\r\n```\r\nAnd the error reported by MySQL is now ERROR 1210 (HY000): Variable not supported in combination with Galera\r\n```\r\n\r\nSince this error is equivalent to the one previously reported as `ER_UNKNOWN_SYSTEM_VARIABLE`, we should identify it and handle it the same way we previously did.\r\n\r\n- [x] ProxySQL version\r\n\r\nDevelopment branch `2.x`.\r\n\r\n- [x] The steps to reproduce the issue\r\n\r\nCreate a `mysql` session against ProxySQL using `MySQL Galera` with server version `8.0.34-26.15`. Change the value for `sql_generate_invisible_primary_key` and perform a query. ProxySQL reports the following in the error log:\r\n\r\n```\r\n2024-07-17 11:17:02 MySQL_Session.cpp:2970:handler_again___status_SETTING_GENERIC_VARIABLE(): [WARNING] Error while setting sql_generate_invisible_primary_key to \"ON\" on 127.0.0.1:15307 hg 101 :  1210, Variable not supported in combination with Galera\r\n```\r\n\r\n## Fix\r\n\r\nProposed fix is bundled in PR #4588. \r\n\n", "hints_text": "", "created_at": "2024-07-12 17:02:56", "merge_commit_sha": "01d1fc9828a5da09896acd2287be48335bbc1ada", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["builds (testreadonly)", ".github/workflows/CI-maketest.yml"], ["select (ubuntu22-tap, mysql57)", ".github/workflows/CI-taptests-groups.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (testaurora)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (debian11)", ".github/workflows/CI-builds.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-laravel-framework.yml"], ["builds (testall)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-mysql-connector-j.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (testgalera)", ".github/workflows/CI-maketest.yml"], ["Analyze (ubuntu22-tap, python)", ".github/workflows/CI-codeql.yml"], ["builds (ubuntu16)", ".github/workflows/CI-builds.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-basictests.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-selftests.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-php-pdo-mysql.yml"], ["test (debian11, mariadb10)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (ubuntu22, -clang)", ".github/workflows/CI-builds.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-django-framework.yml"]]}
{"repo": "sysown/proxysql", "instance_id": "sysown__proxysql-4518", "base_commit": "57bf59aefdc4d10e2905a46f4a4e8bad23efbba1", "patch": "diff --git a/include/proxysql_admin.h b/include/proxysql_admin.h\nindex 6906091cc7..d46933a331 100644\n--- a/include/proxysql_admin.h\n+++ b/include/proxysql_admin.h\n@@ -394,6 +394,8 @@ class ProxySQL_Admin {\n \tvoid public_add_active_users(enum cred_username_type usertype, char *user=NULL) {\n \t\t__add_active_users(usertype, user);\n \t}\n+\t// @brief True if all ProxySQL modules have been already started. End of 'phase3'.\n+\tbool all_modules_started;\n \tProxySQL_Admin();\n \t~ProxySQL_Admin();\n \tSQLite3DB *admindb;\t// in memory\n@@ -416,6 +418,18 @@ class ProxySQL_Admin {\n \t */\n \tbool init(const bootstrap_info_t& bootstrap_info);\n \tvoid init_ldap();\n+\t/** @brief Initializes the HTTP server. For safety should be called after 'phase3'. */\n+\tvoid init_http_server();\n+\t/**\n+\t * @brief Loads the HTTP server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_http_server();\n+\t/**\n+\t * @brief Loads the RESTAPI server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_restapi_server();\n \tbool get_read_only() { return variables.admin_read_only; }\n \tbool set_read_only(bool ro) { variables.admin_read_only=ro; return variables.admin_read_only; }\n \tbool has_variable(const char *name);\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex 17ac811b0c..ae9b3e4502 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -6115,6 +6115,12 @@ void ProxySQL_Admin::init_ldap() {\n \t}\n }\n \n+void ProxySQL_Admin::init_http_server() {\n+\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n+\tAdminHTTPServer->init();\n+\tAdminHTTPServer->print_version();\n+}\n+\n struct boot_srv_info_t {\n \tstring member_id;\n \tstring member_host;\n@@ -6381,10 +6387,6 @@ bool ProxySQL_Admin::init(const bootstrap_info_t& bootstrap_info) {\n \tcpu_timer cpt;\n \n \tAdmin_HTTP_Server = NULL;\n-\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n-\tAdminHTTPServer->init();\n-\tAdminHTTPServer->print_version();\n-\n \tAdminRestApiServer = NULL;\n /*\n \tAdminRestApiServer = new ProxySQL_RESTAPI_Server();\n@@ -7220,6 +7222,167 @@ void ProxySQL_Admin::load_or_update_global_settings(SQLite3DB *db) {\n \t}\n }\n \n+void ProxySQL_Admin::load_restapi_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n+\t\t[this](const httpserver::http_request& request) {\n+\t\t\tauto headers = request_headers(request);\n+\t\t\tauto serial_response = this->serial_exposer(headers);\n+\t\t\tauto http_response = make_response(serial_response);\n+\n+\t\t\treturn http_response;\n+\t\t}\n+\t};\n+\n+\tbool free_restapi_port = false;\n+\n+\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n+\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n+\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n+\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n+\n+\t\tif (restapi_port_free == false) {\n+\t\t\tif (e_port_check == -1) {\n+\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n+\t\t\t} else {\n+\t\t\t\tproxy_error(\n+\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n+\t\t\t\t\tvariables.restapi_port\n+\t\t\t\t);\n+\t\t\t}\n+\t\t}\n+\t};\n+\n+\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n+\t\tif (variables.restapi_enabled) {\n+\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t}\n+\n+\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t);\n+\t\t} else {\n+\t\t\tdelete AdminRestApiServer;\n+\t\t\tAdminRestApiServer = NULL;\n+\t\t}\n+\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n+\t} else {\n+\t\tif (variables.restapi_port != variables.restapi_port_old) {\n+\t\t\tif (AdminRestApiServer) {\n+\t\t\t\tdelete AdminRestApiServer;\n+\t\t\t\tAdminRestApiServer = NULL;\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled) {\n+\t\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t\t);\n+\t\t\t}\n+\t\t\tvariables.restapi_port_old = variables.restapi_port;\n+\t\t}\n+\t}\n+}\n+\n+void ProxySQL_Admin::load_http_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tif (variables.web_enabled != variables.web_enabled_old) {\n+\t\tif (variables.web_enabled) {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tchar *key_pem;\n+\t\t\t\tchar *cert_pem;\n+\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tint sfd = 0;\n+\t\t\t\t\tint reuseaddr = 1;\n+\t\t\t\t\tstruct sockaddr_in tmp_addr;\n+\n+\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n+\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n+\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n+\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n+\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n+\n+\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n+\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n+\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n+\t\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t\t);\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tGloWebInterface->stop();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tvariables.web_enabled_old = variables.web_enabled;\n+\t} else {\n+\t\tif (variables.web_port != variables.web_port_old) {\n+\t\t\tif (variables.web_enabled) {\n+\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t\t\tchar *key_pem;\n+\t\t\t\t\tchar *cert_pem;\n+\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t\t} else {\n+\t\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tvariables.web_port_old = variables.web_port;\n+\t\t}\n+\t}\n+}\n+\n void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \tSQLite3DB *db, bool replace, const string& checksum, const time_t epoch, bool lock\n ) {\n@@ -7308,157 +7471,8 @@ void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \t\t}\n \t\twrunlock();\n \t\t{\n-\t\t\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n-\t\t\t\t[this](const httpserver::http_request& request) {\n-\t\t\t\t\tauto headers = request_headers(request);\n-\t\t\t\t\tauto serial_response = this->serial_exposer(headers);\n-\t\t\t\t\tauto http_response = make_response(serial_response);\n-\n-\t\t\t\t\treturn http_response;\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tbool free_restapi_port = false;\n-\n-\t\t\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n-\t\t\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n-\t\t\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n-\t\t\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n-\n-\t\t\t\tif (restapi_port_free == false) {\n-\t\t\t\t\tif (e_port_check == -1) {\n-\t\t\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\tvariables.restapi_port\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n-\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t}\n-\n-\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t);\n-\t\t\t\t} else {\n-\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t}\n-\t\t\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.restapi_port != variables.restapi_port_old) {\n-\t\t\t\t\tif (AdminRestApiServer) {\n-\t\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.restapi_port_old = variables.restapi_port;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\tif (variables.web_enabled != variables.web_enabled_old) {\n-\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tint sfd = 0;\n-\t\t\t\t\t\t\tint reuseaddr = 1;\n-\t\t\t\t\t\t\tstruct sockaddr_in tmp_addr;\n-\n-\t\t\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n-\t\t\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n-\t\t\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n-\t\t\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n-\t\t\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n-\n-\t\t\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n-\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n-\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t} else {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tGloWebInterface->stop();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tvariables.web_enabled_old = variables.web_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.web_port != variables.web_port_old) {\n-\t\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.web_port_old = variables.web_port;\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\tload_http_server();\n+\t\t\tload_restapi_server();\n \t\t\t// Update the admin variable for 'web_verbosity'\n \t\t\tadmin___web_verbosity = variables.web_verbosity;\n \t\t}\ndiff --git a/lib/ProxySQL_HTTP_Server.cpp b/lib/ProxySQL_HTTP_Server.cpp\nindex ff38885582..d8affaf396 100644\n--- a/lib/ProxySQL_HTTP_Server.cpp\n+++ b/lib/ProxySQL_HTTP_Server.cpp\n@@ -586,7 +586,7 @@ int ProxySQL_HTTP_Server::handler(void *cls, struct MHD_Connection *connection,\n \t\t\tdelete cpu_sqlite;\n \t\t\t\n \t\t\ts.append(\"</body></html>\");\n-\t \t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_PERSISTENT); \n+\t\t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_MUST_COPY);\n   \t\t\tret = MHD_queue_response (connection, MHD_HTTP_OK, response);\n   \t\t\tMHD_destroy_response (response);\n \t\t\treturn ret;\ndiff --git a/src/main.cpp b/src/main.cpp\nindex aaac09822c..cfe5f4ff93 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1145,7 +1145,6 @@ void ProxySQL_Main_init_phase3___start_all() {\n \t\tGloAdmin->init_mysql_servers();\n \t\tGloAdmin->init_proxysql_servers();\n \t\tGloAdmin->load_scheduler_to_runtime();\n-\t\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n #ifdef DEBUG\n \t\tstd::cerr << \"Main phase3 : GloAdmin initialized in \";\n #endif\n@@ -1217,6 +1216,17 @@ void ProxySQL_Main_init_phase3___start_all() {\n \tif (GloMyLdapAuth) {\n \t\tGloAdmin->init_ldap_variables();\n \t}\n+\n+\t// HTTP Server should be initialized after other modules. See #4510\n+\tGloAdmin->init_http_server();\n+\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n+\n+\t// Signal ProxySQL_Admin that all modules have been started\n+\tGloAdmin->all_modules_started = true;\n+\n+\t// Load the config not previously loaded for these modules\n+\tGloAdmin->load_http_server();\n+\tGloAdmin->load_restapi_server();\n }\n \n \n", "test_patch": "", "problem_statement": "The HTTP server should starts at the end of ProxySQL Admin\nUp to version 2.6.2 , in `ProxySQL_Admin::init()` the HTTP server is started at the very beginning:\r\n\r\nhttps://github.com/sysown/proxysql/blob/v2.6.2/lib/ProxySQL_Admin.cpp#L6384\r\n\r\nIf the Prometheus exporter is immediately accessible, it can attempt to access objects yet not initialized, possibly leading to a crash if the exporter is accessed within a few milliseconds from ProxySQL start.\r\n\r\nWe should probably move the initialization of `AdminHTTPServer` outside of `ProxySQL_Admin::init()` , and only initialize after all the other modules are initialized (therefore should be initialized from `main()`.\n", "hints_text": "", "created_at": "2024-04-23 07:21:28", "merge_commit_sha": "8a525bf9f61e76c358c3ff2f06c1914b7189360c", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["builds (testreadonly)", ".github/workflows/CI-maketest.yml"], ["select (ubuntu22-tap, mysql57)", ".github/workflows/CI-taptests-groups.yml"], ["builds (testaurora)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql82)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (debian11)", ".github/workflows/CI-builds.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-laravel-framework.yml"], ["builds (testall)", ".github/workflows/CI-maketest.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-mysql-connector-j.yml"], ["test (debian11, mariadb11)", ".github/workflows/CI-3p-django-framework.yml"], ["builds (testgalera)", ".github/workflows/CI-maketest.yml"], ["Analyze (ubuntu22-tap, python)", ".github/workflows/CI-codeql.yml"], ["builds (ubuntu16)", ".github/workflows/CI-builds.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-basictests.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-mariadb-connector-c.yml"], ["tests (ubuntu22-tap, mysql57)", ".github/workflows/CI-selftests.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-php-pdo-mysql.yml"], ["test (debian11, mysql81)", ".github/workflows/CI-3p-laravel-framework.yml"], ["test (debian11, mysql57)", ".github/workflows/CI-3p-sqlalchemy.yml"], ["builds (ubuntu22, -clang)", ".github/workflows/CI-builds.yml"], ["test (debian11, mysql80)", ".github/workflows/CI-3p-laravel-framework.yml"]]}
{"repo": "OpenAtomFoundation/pikiwidb", "instance_id": "OpenAtomFoundation__pikiwidb-2638", "base_commit": "e38e255cf16b6ab2c50d32741458bfb38adcadeb", "patch": "diff --git a/conf/pika.conf b/conf/pika.conf\nindex 055208dae5..a99c30b30d 100644\n--- a/conf/pika.conf\n+++ b/conf/pika.conf\n@@ -34,10 +34,17 @@ slow-cmd-thread-pool-size : 1\n # Slow cmd list e.g. hgetall, mset\n slow-cmd-list :\n \n-# The number of sync-thread for data replication from master, those are the threads work on slave nodes\n-# and are used to execute commands sent from master node when replicating.\n+# The number of threads to write DB in slaveNode when replicating.\n+# It's preferable to set slave's sync-thread-num value close to master's thread-pool-size.\n sync-thread-num : 6\n \n+# The num of threads to write binlog in slaveNode when replicating,\n+# each DB cloud only bind to one sync-binlog-thread to write binlog in maximum\n+#[NOTICE] It's highly recommended to set sync-binlog-thread-num equal to conf item 'database'(then each DB cloud have a exclusive thread to write binlog),\n+# eg. if you use 8 DBs(databases_ is 8), sync-binlog-thread-num is preferable to be 8\n+# Valid range of sync-binlog-thread-num is [1, databases], the final value of it is Min(sync-binlog-thread-num, databases)\n+sync-binlog-thread-num : 1\n+\n # Directory to store log files of Pika, which contains multiple types of logs,\n # Including: INFO, WARNING, ERROR log, as well as binglog(write2fine) file which\n # is used for replication.\n@@ -101,6 +108,8 @@ instance-mode : classic\n # The default database id is DB 0. You can select a different one on\n # a per-connection by using SELECT. The db id range is [0, 'databases' value -1].\n # The value range of this parameter is [1, 8].\n+# [NOTICE] It's RECOMMENDED to set sync-binlog-thread-num equal to DB num(databases),\n+# if you've changed the value of databases, remember to check if the value of sync-binlog-thread-num is proper.\n databases : 1\n \n # The number of followers of a master. Only [0, 1, 2, 3, 4] is valid at present.\ndiff --git a/include/pika_conf.h b/include/pika_conf.h\nindex 2a5ed25212..e0cb81062d 100644\n--- a/include/pika_conf.h\n+++ b/include/pika_conf.h\n@@ -65,6 +65,10 @@ class PikaConf : public pstd::BaseConf {\n     std::shared_lock l(rwlock_);\n     return sync_thread_num_;\n   }\n+  int sync_binlog_thread_num() {\n+    std::shared_lock l(rwlock_);\n+    return sync_binlog_thread_num_;\n+  }\n   std::string log_path() {\n     std::shared_lock l(rwlock_);\n     return log_path_;\n@@ -793,6 +797,7 @@ class PikaConf : public pstd::BaseConf {\n   int slow_cmd_thread_pool_size_ = 0;\n   std::unordered_set<std::string> slow_cmd_set_;\n   int sync_thread_num_ = 0;\n+  int sync_binlog_thread_num_ = 0;\n   int expire_dump_days_ = 3;\n   int db_sync_speed_ = 0;\n   std::string slaveof_;\ndiff --git a/include/pika_define.h b/include/pika_define.h\nindex 4d6bf6a846..91ddffeb9f 100644\n--- a/include/pika_define.h\n+++ b/include/pika_define.h\n@@ -30,6 +30,8 @@\n #define PIKA_SERVER_ID_MAX 65535\n \n class PikaServer;\n+/* Global Const */\n+constexpr int MAX_DB_NUM = 8;\n \n /* Port shift */\n const int kPortShiftRSync = 1000;\ndiff --git a/include/pika_repl_client.h b/include/pika_repl_client.h\nindex aa20b83c78..49eb2c9b82 100644\n--- a/include/pika_repl_client.h\n+++ b/include/pika_repl_client.h\n@@ -65,6 +65,7 @@ class PikaReplClient {\n   pstd::Status Close(const std::string& ip, int port);\n \n   void Schedule(net::TaskFunc func, void* arg);\n+  void ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name);\n   void ScheduleWriteBinlogTask(const std::string& db_name, const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n@@ -80,13 +81,15 @@ class PikaReplClient {\n   pstd::Status SendRemoveSlaveNode(const std::string& ip, uint32_t port, const std::string& db_name, const std::string& local_ip);\n \n  private:\n-  size_t GetHashIndex(const std::string& key, bool upper_half);\n-  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(bg_workers_.size()); }\n+  size_t GetBinlogWorkerIndexByDBName(const std::string &db_name);\n+  size_t GetHashIndexByKey(const std::string& key);\n+  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(write_binlog_workers_.size()); }\n \n   std::unique_ptr<PikaReplClientThread> client_thread_;\n   int next_avail_ = 0;\n   std::hash<std::string> str_hash;\n-  std::vector<std::unique_ptr<PikaReplBgWorker>> bg_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_binlog_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_db_workers_;\n };\n \n #endif\ndiff --git a/include/pika_rm.h b/include/pika_rm.h\nindex 9cc0c5ef38..b3e310ddf4 100644\n--- a/include/pika_rm.h\n+++ b/include/pika_rm.h\n@@ -182,6 +182,7 @@ class PikaReplicaManager {\n                                const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n+  void ScheduleReplClientBGTaskByDBName(net::TaskFunc , void* arg, const std::string &db_name);\n   void ReplServerRemoveClientConn(int fd);\n   void ReplServerUpdateClientConnMap(const std::string& ip_port, int fd);\n \ndiff --git a/src/pika_admin.cc b/src/pika_admin.cc\nindex 6760ac247b..15d49cdbae 100644\n--- a/src/pika_admin.cc\n+++ b/src/pika_admin.cc\n@@ -942,6 +942,7 @@ void InfoCmd::InfoServer(std::string& info) {\n   tmp_stream << \"tcp_port:\" << g_pika_conf->port() << \"\\r\\n\";\n   tmp_stream << \"thread_num:\" << g_pika_conf->thread_num() << \"\\r\\n\";\n   tmp_stream << \"sync_thread_num:\" << g_pika_conf->sync_thread_num() << \"\\r\\n\";\n+  tmp_stream << \"sync_binlog_thread_num:\" << g_pika_conf->sync_binlog_thread_num() << \"\\r\\n\";\n   tmp_stream << \"uptime_in_seconds:\" << (current_time_s - g_pika_server->start_time_s()) << \"\\r\\n\";\n   tmp_stream << \"uptime_in_days:\" << (current_time_s / (24 * 3600) - g_pika_server->start_time_s() / (24 * 3600) + 1)\n              << \"\\r\\n\";\n@@ -1501,6 +1502,12 @@ void ConfigCmd::ConfigGet(std::string& ret) {\n     EncodeNumber(&config_body, g_pika_conf->sync_thread_num());\n   }\n \n+  if (pstd::stringmatch(pattern.data(), \"sync-binlog-thread-num\", 1) != 0) {\n+     elements += 2;\n+     EncodeString(&config_body, \"sync-binlog-thread-num\");\n+     EncodeNumber(&config_body, g_pika_conf->sync_binlog_thread_num());\n+    }\n+\n   if (pstd::stringmatch(pattern.data(), \"log-path\", 1) != 0) {\n     elements += 2;\n     EncodeString(&config_body, \"log-path\");\ndiff --git a/src/pika_conf.cc b/src/pika_conf.cc\nindex adc1b26d9f..e2e0d4f885 100644\n--- a/src/pika_conf.cc\n+++ b/src/pika_conf.cc\n@@ -176,7 +176,7 @@ int PikaConf::Load() {\n \n   if (classic_mode_.load()) {\n     GetConfInt(\"databases\", &databases_);\n-    if (databases_ < 1 || databases_ > 8) {\n+    if (databases_ < 1 || databases_ > MAX_DB_NUM) {\n       LOG(FATAL) << \"config databases error, limit [1 ~ 8], the actual is: \" << databases_;\n     }\n     for (int idx = 0; idx < databases_; ++idx) {\n@@ -185,6 +185,15 @@ int PikaConf::Load() {\n   }\n   default_db_ = db_structs_[0].db_name;\n \n+  // sync_binlog_thread_num_ must be set after the setting of databases_\n+  GetConfInt(\"sync-binlog-thread-num\", &sync_binlog_thread_num_);\n+  if (sync_binlog_thread_num_ <= 0) {\n+      sync_binlog_thread_num_ = databases_;\n+  } else {\n+      // final value is MIN(sync_binlog_thread_num, databases_)\n+      sync_binlog_thread_num_ = sync_binlog_thread_num_ > databases_ ?  databases_ : sync_binlog_thread_num_;\n+  }\n+\n   int tmp_replication_num = 0;\n   GetConfInt(\"replication-num\", &tmp_replication_num);\n   if (tmp_replication_num > 4 || tmp_replication_num < 0) {\ndiff --git a/src/pika_repl_client.cc b/src/pika_repl_client.cc\nindex 2754eb2f6e..352fbdf7e5 100644\n--- a/src/pika_repl_client.cc\n+++ b/src/pika_repl_client.cc\n@@ -27,8 +27,11 @@ extern std::unique_ptr<PikaReplicaManager> g_pika_rm;\n PikaReplClient::PikaReplClient(int cron_interval, int keepalive_timeout)  {\n   client_thread_ = std::make_unique<PikaReplClientThread>(cron_interval, keepalive_timeout);\n   client_thread_->set_thread_name(\"PikaReplClient\");\n-  for (int i = 0; i < 2 * g_pika_conf->sync_thread_num(); ++i) {\n-    bg_workers_.push_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  for (int i = 0; i < g_pika_conf->sync_binlog_thread_num(); i++) {\n+      write_binlog_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  }\n+  for (int i = 0; i < g_pika_conf->sync_thread_num(); ++i) {\n+    write_db_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n   }\n }\n \n@@ -43,49 +46,77 @@ int PikaReplClient::Start() {\n     LOG(FATAL) << \"Start ReplClient ClientThread Error: \" << res\n                << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n   }\n-  for (auto & bg_worker : bg_workers_) {\n-    res = bg_worker->StartThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    res = binlog_worker->StartThread();\n     if (res != net::kSuccess) {\n-      LOG(FATAL) << \"Start Pika Repl Worker Thread Error: \" << res\n+      LOG(FATAL) << \"Start Pika Repl Write Binlog Worker Thread Error: \" << res\n                  << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n     }\n   }\n+  for (auto & db_worker : write_db_workers_) {\n+        res = db_worker->StartThread();\n+        if (res != net::kSuccess) {\n+            LOG(FATAL) << \"Start Pika Repl Write DB Worker Thread Error: \" << res\n+                       << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n+        }\n+    }\n   return res;\n }\n \n int PikaReplClient::Stop() {\n   client_thread_->StopThread();\n-  for (auto & bg_worker : bg_workers_) {\n-    bg_worker->StopThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    binlog_worker->StopThread();\n+  }\n+  for (auto &db_worker: write_db_workers_) {\n+    db_worker->StopThread();\n   }\n   return 0;\n }\n \n void PikaReplClient::Schedule(net::TaskFunc func, void* arg) {\n-  bg_workers_[next_avail_]->Schedule(func, arg);\n+  write_binlog_workers_[next_avail_]->Schedule(func, arg);\n   UpdateNextAvail();\n }\n \n+void PikaReplClient::ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name) {\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  write_binlog_workers_[index]->Schedule(func, arg);\n+};\n+\n void PikaReplClient::ScheduleWriteBinlogTask(const std::string& db_name,\n                                              const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                              const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n-  size_t index = GetHashIndex(db_name, true);\n-  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, bg_workers_[index].get());\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, write_binlog_workers_[index].get());\n+  write_binlog_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n }\n \n void PikaReplClient::ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset,\n                                          const std::string& db_name) {\n   const PikaCmdArgsType& argv = cmd_ptr->argv();\n   std::string dispatch_key = argv.size() >= 2 ? argv[1] : argv[0];\n-  size_t index = GetHashIndex(dispatch_key, false);\n+  size_t index = GetHashIndexByKey(dispatch_key);\n   auto task_arg = new ReplClientWriteDBTaskArg(cmd_ptr, offset, db_name);\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+  write_db_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+}\n+\n+size_t PikaReplClient::GetBinlogWorkerIndexByDBName(const std::string &db_name) {\n+    char db_num_c = db_name.back();\n+    int32_t db_num = db_num_c - '0';\n+    //Valid range of db_num is [0, MAX_DB_NUM)\n+    if (db_num < 0 || db_num >= MAX_DB_NUM) {\n+        LOG(ERROR)\n+                << \"Corruption in consuming binlog: the last char of the db_name(extracted from binlog) is not a valid db num, the extracted db_num is \"\n+                << db_num_c << \" while write_binlog_workers.size() is \" << write_binlog_workers_.size();\n+        if (db_num < 0) { assert(false && \"db_num invalid, check if the db_name in the request is valid, also check the ERROR Log of Pika.\"); }\n+    }\n+    return db_num % write_binlog_workers_.size();\n }\n \n-size_t PikaReplClient::GetHashIndex(const std::string& key, bool upper_half) {\n-  size_t hash_base = bg_workers_.size() / 2;\n-  return (str_hash(key) % hash_base) + (upper_half ? 0 : hash_base);\n+size_t PikaReplClient::GetHashIndexByKey(const std::string& key) {\n+  size_t hash_base = write_db_workers_.size();\n+  return (str_hash(key) % hash_base);\n }\n \n Status PikaReplClient::Write(const std::string& ip, const int port, const std::string& msg) {\ndiff --git a/src/pika_repl_client_conn.cc b/src/pika_repl_client_conn.cc\nindex 672648d64d..6c8e001bf1 100644\n--- a/src/pika_repl_client_conn.cc\n+++ b/src/pika_repl_client_conn.cc\n@@ -63,9 +63,12 @@ int PikaReplClientConn::DealMessage() {\n       break;\n     }\n     case InnerMessage::kTrySync: {\n+      const std::string& db_name = response->try_sync().slot().db_name();\n+      //TrySync resp must contain db_name\n+      assert(!db_name.empty());\n       auto task_arg =\n           new ReplClientTaskArg(response, std::dynamic_pointer_cast<PikaReplClientConn>(shared_from_this()));\n-      g_pika_rm->ScheduleReplClientBGTask(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg));\n+      g_pika_rm->ScheduleReplClientBGTaskByDBName(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg), db_name);\n       break;\n     }\n     case InnerMessage::kBinlogSync: {\n@@ -193,7 +196,6 @@ void PikaReplClientConn::HandleTrySyncResponse(void* arg) {\n     LOG(WARNING) << \"TrySync Failed: \" << reply;\n     return;\n   }\n-\n   const InnerMessage::InnerResponse_TrySync& try_sync_response = response->try_sync();\n   const InnerMessage::Slot& db_response = try_sync_response.slot();\n   std::string db_name = db_response.db_name();\ndiff --git a/src/pika_rm.cc b/src/pika_rm.cc\nindex 3445e9fea6..a996463bc2 100644\n--- a/src/pika_rm.cc\n+++ b/src/pika_rm.cc\n@@ -659,6 +659,10 @@ void PikaReplicaManager::ScheduleReplClientBGTask(net::TaskFunc func, void* arg)\n   pika_repl_client_->Schedule(func, arg);\n }\n \n+void PikaReplicaManager::ScheduleReplClientBGTaskByDBName(net::TaskFunc func, void* arg, const std::string &db_name) {\n+  pika_repl_client_->ScheduleByDBName(func, arg, db_name);\n+}\n+\n void PikaReplicaManager::ScheduleWriteBinlogTask(const std::string& db,\n                                                  const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                                  const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n", "test_patch": "diff --git a/tests/integration/replication_test.go b/tests/integration/replication_test.go\nindex 51a8ad00bd..764e8bcca5 100644\n--- a/tests/integration/replication_test.go\n+++ b/tests/integration/replication_test.go\n@@ -558,6 +558,7 @@ var _ = Describe(\"should replication \", func() {\n \n \t\t\tlog.Println(\"randomSpopstore test start\")\n \t\t\texecute(&ctx, clientMaster, 4, randomSpopstroeThread)\n+\t\t\ttime.Sleep(10 * time.Second)\n \t\t\tmaster_spopstore_set := clientMaster.SMembers(ctx, \"set1\")\n \t\t\tExpect(master_spopstore_set.Err()).NotTo(HaveOccurred())\n \t\t\tslave_spopstore_set := clientSlave.SMembers(ctx, \"set1\")\n", "problem_statement": "If a binlog task blocks the slave for a long period, the master may resume the increment replication from an incorrect  start position after timeout reconnection\n### Is this a regression?\r\n\r\nNo\r\n\r\n### Description\r\n\r\n**\u5728\u589e\u91cf\u540c\u6b65\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u67d0\u6761BinlogTask\u963b\u585e\u4e86Slave\u5f88\u957f\u65f6\u95f4\uff08\u8d85\u8fc720s\u7684\u8d85\u65f6\u65f6\u95f4\uff09\uff0c\u4f1a\u9020\u6210\u4e3b\u4ece\u65ad\u8054\uff0c\u5f53\u4e3b\u4ece\u518d\u6b21\u8bd5\u56fe\u91cd\u5efa\u8fde\u63a5\u65f6\uff0cSlave\u53ef\u80fd\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u9519\u8bef\u7684Binlog Start Point\u7ed9Master\u6765\u8fdb\u884c\u7eed\u4f20**\u3002\r\n\r\n**\u9488\u5bf9\u8fd9\u4e00Case\u7684\u5c55\u5f00\u63cf\u8ff0**:\r\n**\u573a\u666f**\uff1a\u5047\u8bbeSlave\u5728\u589e\u91cf\u540c\u6b65\u9636\u6bb5\uff0c\u53d1\u751f\u8d85\u65f6\u8f6c\u4e3a\u4e86TryConnect\u72b6\u6001\uff0c\u5728\u53d1\u51faTrySync\u8bf7\u6c42\u65f6\uff0c\u5982\u679c\u76f8\u5e94\u7684BinlogWorker\u6b63\u597d\u8fd8\u5728\u6267\u884c\u4e00\u4e2a\u4e0a\u6b21\u8fde\u63a5\u671f\u95f4\u7684Binlog\u4efb\u52a1\uff08\u5c06\u8be5Binlog\u4efb\u52a1\u5b9a\u4e49\u4e3a\u4efb\u52a1A) \u3002 \u90a3\u4e48\uff0c\u56e0\u4e3a\u4efb\u52a1A\u7684\u5b58\u5728\uff0cSlave\u662f\u5426\u53ef\u80fd\u4f1a\u53d1\u9001\u4e86\u4e0d\u6b63\u786e\u7684\u7eed\u4f20\u8d77\u59cbOffset\u7ed9Master \uff1f \u6362\u53e5\u8bdd\u8bf4\uff1a\u867d\u7136\u6700\u7ec8\u4efb\u52a1A\u4f1a\u5728Slave\u843d\u76d8\uff0c\u4f46\u662fSlave\u662f\u5426\u53ef\u80fd\u544a\u77e5\u4e86Master\u4ece\u4efb\u52a1A\uff08\u6240\u5bf9\u5e94\u7684Binlog\uff09\u5f00\u59cb\u7684\u4f4d\u7f6e\u53d1\u9001Binlog\uff0c\u5bfc\u81f4Master\u4f1a\u5c06\u4efb\u52a1A\u5bf9\u5e94\u7684Binlog\u518d\u53d1\u4e00\u6b21\uff0c\u4e14Slave\u4f1a\u6d88\u8d39\u4e24\u6b21\u4efb\u52a1A\u6240\u5bf9\u5e94\u7684Binlog \uff1f  \u5148\u505a\u56de\u7b54: \u4f1a\u51fa\u73b0\u8fd9\u79cd\u95ee\u9898\u3002\u5177\u4f53\u68b3\u7406\u5728\u4e0b\u9762\uff1a\r\n\r\n**\u80cc\u666f\u8865\u5145\u548c\u5b9a\u4e49**\uff1aTrySync\u8bf7\u6c42\u643a\u5e26\u7684offset(\u5b9a\u4e49\u4e3aoffset A)\u4e3b\u8981\u4f5c\u7528\u662f\u7ed9Master\u5224\u65ad\u662f\u5426\u80fd\u505a\u589e\u91cf\u540c\u6b65\uff0c\u771f\u6b63\u51b3\u5b9aMaster\u521d\u59cb\u5316\u53d1\u9001\u7a97\u53e3\u8d77\u59cb\u4f4d\u7f6e\uff08\u7eed\u4f20Binlog\u7684\u8d77\u59cb\u4f4d\u7f6e\uff09\u7684\uff0c\u662fslave\u5728\u6536\u5230TrySync\u7684Resp\u540e\u53d1\u51fa\u7684\u4e00\u6761\u7279\u6b8aBinlogACK (is_first_send=true)\uff0c\u8be5ACK\u7684offst start\u7b49\u4e8eend(\u5b9a\u4e49\u4e3aOffset B)\uff0c\u4e14\u8be5Offset B\u5c31\u662fslave\u5728\u53d1\u51fa\u8fd9\u6761\u7279\u6b8aAck\u65f6\u7684\u6700\u65b0\u843d\u76d8\u70b9\u3002\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u5176\u5b9eOffset B\u5e94\u8be5\u4f1a\u548cOffset A\u76f8\u540c\uff0c\u4f46\u662f\u5728Edge Case 1\u4e2d\uff0c\u7531\u4e8e\u53d1\u51faTrySync\u65f6\u4efb\u52a1A\u6b63\u5728\u6267\u884c\u4e14\u6700\u7ec8\u4f1a\u6267\u884c\u5b8c\u6bd5\uff0cOffset B\u7684\u6b63\u786e\u9884\u671f\u5e94\u5f53\u662f  Offset A + BinlogSizeOf(\u4efb\u52a1A), \u6216\u8005\u8bf4Binlog\u7684\u8d77\u59cb\u7eed\u4f20\u4f4d\u7f6e\u5e94\u8be5\u5c31\u5728\u4efb\u52a1A\u5bf9\u5e94\u7684Binlogs\u7684\u540e\u9762\u3002\r\n\r\n**\u73b0\u6709\u4ee3\u7801\u903b\u8f91\u4e2d**\uff1aOffset B\u53ef\u80fd\u4e0d\u4f1a\u7b49\u4e8e\u6b63\u786e\u9884\u671f\uff0c\u5047\u5982BinlogWork\u6267\u884c\u4efb\u52a1A\u6267\u884c\u4e86\u6bd4\u8f83\u4e45\uff0c\u800c\u5728\u4efb\u52a1A\u7684\u6267\u884c\u671f\u95f4Slave\u5b8c\u6210\u4e86\uff1aTrySync Req\u53d1\u9001 ->TrySync Resp\u5904\u7406->\u5728TrySync Resp\u7684\u5904\u7406\u51fd\u6570\u672b\u5c3e\u4f1a\u83b7\u53d6Slave\u6700\u65b0\u7684Binlog\u843d\u76d8\u70b9\uff08Offset B\uff09\uff0c\u53d1\u51fa\u7279\u6b8aBinlogAck(is_first_send=true)\u6765\u544a\u77e5Master\u4ece\u54ea\u91cc\u5f00\u59cb\u91cd\u53d1Binlog\u3002 \u5982\u679c\u5728\u83b7\u53d6Offset B\u7684\u65f6\u5019\uff0c\u4efb\u52a1A\u8fd8\u6ca1\u843d\u76d8\uff0c\u6216\u8005\u843d\u76d8\u4e86\u4f46\u662f\u8fd8\u6ca1\u6709\u5c06\u6700\u65b0\u7684offset\u66f4\u65b0\u5230version_\u5bf9\u8c61\u4e2d(Offset B\u5c31\u662f\u4eceversion_\u5bf9\u8c61\u4e2d\u53d6)\uff0c\u5c31\u4f1a\u5bfc\u81f4\u83b7\u53d6\u7684OffsetB\u5c31\u7b49\u4e8eOffset A(\u4f46\u6b63\u786e\u7684\u5e94\u8be5Offset B\u5e94\u8be5\u662f Offset A + Offset A + BinlogSizeOf(\u4efb\u52a1A))\uff0c\u4e8e\u662fMaster\u4f1a\u628a\u4efb\u52a1A\u6240\u5bf9\u5e94\u7684\u90a3\u6279Binlog\u518d\u53d1\u4e00\u904d\u3002\r\n\r\n**\u540e\u679c**\uff1aMaster\u4f1a\u628a\u4efb\u52a1A\u5185\u90e8\u7684BInlog\u518d\u53d1\u4e00\u6b21\uff0cSlave\u7b49\u4e8e\u6d88\u8d39\u4e862\u6279\u540c\u6837\u7684Binlog\uff0c\u4e00\u6b21\u662f\u5728\u4e0a\u4e00\u6b21Session\u7684\u672b\u5c3e\uff08\u963b\u585e\u7684\u90a3\u4e2a\u4efb\u52a1A\uff09\uff0c\u4e00\u6b21\u662f\u5728\u65b0Session\u7684\u7b2c\u4e00\u4e2aBinlog\u4efb\u52a1\u4e2d\u3002\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u4e14\u5728\u540c\u6b65\u6ca1\u6709\u6ede\u540e/\u5b8c\u5168\u540c\u6b65\u7684\u60c5\u51b5\u4e0b\uff0cSlave\u7684Binlog\u6587\u4ef6\u4f1a\u6bd4Master\u7684\u5bf9\u5e94BInlog\u6587\u4ef6\u957f\u4e00\u70b9\uff0c\u5728Slave\u5207\u8d70\u8fd9\u4e2aBinlog\u6587\u4ef6\u4e4b\u524d\u5982\u679c\u53d1\u751f\u4e86\u65ad\u70b9\u91cd\u8fde\uff0c\u4e3b\u4ece\u5efa\u8054\u53ef\u80fd\u4f1a\u62a5\u9519 binlog offset is not a start point of master, \u4f46\u662f\u5982\u679cslave\u5728\u5904\u4e8e\u8be5Binlog\u6587\u4ef6\u671f\u95f4\u5b8c\u5168\u6ca1\u6709\u65ad\u5f00\u8fc7\uff0c\u53ef\u80fd\u6d88\u8d39\u5230\u4e86\u7a97\u53e3\u672b\u5c3e\u65f6Master\u7aef\u4f1a\u62a5\u51fa\u5947\u602a\u7684SyncWin Corruption\u3002(\u53e6\u5916\uff0c\u5728\u7ebf\u4e0a\u5b9e\u4f8b\u7684\u4e3b\u4ece\u8d85\u65f6\u6545\u969c\u4e2d\uff0c\u786e\u5b9e\u4e5f\u51fa\u73b0\u8fc7binlog offset is not a start point of master)\r\n\r\n\r\n**During incremental synchronization, if a BinlogTask blocks the Slave for a long time (exceeding the 20-second timeout), when the Master and Slave attempt to reconnect, the Slave may provide an incorrect Binlog Start Point to the Master for resuming the process.**\r\n\r\n**Expanded description of this case**:\r\n**Scenario**: Suppose during the incremental synchronization phase, the Slave times out and switches to TryConnect state. When sending a TrySync request, if the corresponding BinlogWorker happens to still be executing a Binlog task from the previous connection period (let's define this Binlog task as Task A), then due to the existence of Task A, could the Slave possibly send an incorrect resumption starting Offset to the Master? In other words, even though Task A will eventually be written to the Slave\u2019s disk, could the Slave inform the Master to send the Binlog from the starting point of Task A, causing the Master to resend the Binlog corresponding to Task A and resulting in the Slave consuming the Binlog for Task A twice? The preliminary answer is: yes, this issue can occur. The detailed explanation is below:\r\n\r\n**Background and definition**: The offset carried by the TrySync request (defined as Offset A) primarily serves for the Master to determine whether incremental synchronization can be performed. The actual determination of the starting position of the Master\u2019s initial sending window (the starting position for resuming the Binlog) is done by a special BinlogACK (with is_first_send=true) sent by the Slave after receiving the TrySync response. The start of this ACK\u2019s offset is equal to the end (defined as Offset B), and this Offset B is the latest disk write point of the Slave when sending this special Ack. In most cases, Offset B should be the same as Offset A, but in Edge Case 1, since Task A is executing when the TrySync is sent and will eventually complete, the correct expectation for Offset B should be Offset A + BinlogSizeOf(Task A), or in other words, the starting position for resuming the Binlog should be right after the Binlogs corresponding to Task A.\r\n\r\n**In the current code logic**: Offset B may not equal the correct expectation. If the BinlogWork executing Task A takes a long time, and during the execution of Task A, the Slave completes: sending TrySync Req -> processing TrySync Resp -> obtaining the latest Binlog write point (Offset B) at the end of the TrySync Resp processing function, and sending a special BinlogAck (is_first_send=true) to inform the Master where to start resending the Binlog. If Task A has not been written to disk or the latest offset has not been updated to the version_ object (Offset B is taken from the version_ object) when obtaining Offset B, then the obtained Offset B will equal Offset A (but the correct Offset B should be Offset A + BinlogSizeOf(Task A)), thus causing the Master to resend the batch of Binlogs corresponding to Task A.\r\n\r\n**Consequence**: The Master will resend the Binlogs within Task A, causing the Slave to consume two batches of the same Binlog, once at the end of the last session (the blocking Task A) and once in the first Binlog task of the new session. This can lead to data inconsistency between the Master and Slave. Additionally, if there is no lag in synchronization or if synchronization is complete, the Slave\u2019s Binlog file may be slightly longer than the corresponding Binlog file on the Master. If a breakpoint reconnection occurs before the Slave switches from this Binlog file, the Master-Slave connection might report an error: binlog offset is not a start point of master. However, if the Slave never disconnects during this Binlog file, a strange SyncWin Corruption error might be reported on the Master side when the window reaches the end. (Furthermore, in the actual Master-Slave timeout failures in online instances, the binlog offset is not a start point of master error has indeed occurred.)\r\n\r\n\r\n### Please provide a link to a minimal reproduction of the bug\r\n\r\n_No response_\r\n\r\n### Screenshots or videos\r\n\r\n\r\n### Please provide the version you discovered this bug in (check about page for version information)\r\n\r\n_No response_\r\n\r\n### Anything else?\r\n\r\n_No response_\n", "hints_text": "", "created_at": "2024-05-07 15:29:53", "merge_commit_sha": "32c423a2ae23b0b9a94a2480d1031cc3526562e9", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["cleanup", ".github/workflows/clean-cache.yml"], ["Build Pika Docker image", ".github/workflows/pika.yml"], ["build", ".github/workflows/codis.yml"], ["Build Codis Docker image", ".github/workflows/codis.yml"], ["Analyze (go)", ".github/workflows/codeql.yml"], ["update_release_draft", ".github/workflows/release-drafter.yml"]]}
{"repo": "PowerGridModel/power-grid-model", "instance_id": "PowerGridModel__power-grid-model-718", "base_commit": "2d74e82f971d4c9df56e7076ddcc2c9c639f3662", "patch": "diff --git a/power_grid_model_c/power_grid_model_c/src/buffer.cpp b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\nindex aeb6374bc..d4d268674 100644\n--- a/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n+++ b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n@@ -20,10 +20,15 @@ using meta_data::RawDataPtr;\n \n // buffer control\n RawDataPtr PGM_create_buffer(PGM_Handle* /* handle */, PGM_MetaComponent const* component, PGM_Idx size) {\n+    // alignment should be maximum of alignment of the component and alignment of void*\n+    size_t const alignment = std::max(component->alignment, sizeof(void*));\n+    // total bytes should be multiple of alignment\n+    size_t const requested_bytes = component->size * size;\n+    size_t const rounded_bytes = ((requested_bytes + alignment - 1) / alignment) * alignment;\n #ifdef _WIN32\n-    return _aligned_malloc(component->size * size, component->alignment);\n+    return _aligned_malloc(rounded_bytes, alignment);\n #else\n-    return std::aligned_alloc(component->alignment, component->size * size);\n+    return std::aligned_alloc(alignment, rounded_bytes);\n #endif\n }\n void PGM_destroy_buffer(RawDataPtr ptr) {\n", "test_patch": "diff --git a/tests/cpp_validation_tests/CMakeLists.txt b/tests/cpp_validation_tests/CMakeLists.txt\nindex f6d2560c4..0ad90903c 100644\n--- a/tests/cpp_validation_tests/CMakeLists.txt\n+++ b/tests/cpp_validation_tests/CMakeLists.txt\n@@ -11,7 +11,7 @@ add_executable(power_grid_model_validation_tests ${PROJECT_SOURCES})\n \n target_link_libraries(power_grid_model_validation_tests\n     PRIVATE\n-        power_grid_model\n+        power_grid_model_cpp\n         doctest::doctest\n         nlohmann_json nlohmann_json::nlohmann_json\n )\ndiff --git a/tests/cpp_validation_tests/test_validation.cpp b/tests/cpp_validation_tests/test_validation.cpp\nindex a4fe5d0bd..c3b6d7a6e 100644\n--- a/tests/cpp_validation_tests/test_validation.cpp\n+++ b/tests/cpp_validation_tests/test_validation.cpp\n@@ -2,27 +2,82 @@\n //\n // SPDX-License-Identifier: MPL-2.0\n \n-#include <power_grid_model/auxiliary/dataset.hpp>\n-#include <power_grid_model/auxiliary/meta_data_gen.hpp>\n-#include <power_grid_model/auxiliary/serialization/deserializer.hpp>\n-#include <power_grid_model/container.hpp>\n-#include <power_grid_model/main_model.hpp>\n+#define PGM_ENABLE_EXPERIMENTAL\n+\n+#include \"power_grid_model_cpp.hpp\"\n \n #include <doctest/doctest.h>\n #include <nlohmann/json.hpp>\n \n+#include <complex>\n #include <concepts>\n #include <cstdlib>\n #include <cstring>\n #include <filesystem>\n #include <fstream>\n #include <iostream>\n+#include <limits>\n+#include <numeric>\n #include <optional>\n #include <regex>\n+#include <stdexcept>\n+#include <type_traits>\n \n-namespace power_grid_model::meta_data {\n-\n+namespace power_grid_model_cpp {\n namespace {\n+class UnsupportedValidationCase : public PowerGridError {\n+  public:\n+    UnsupportedValidationCase(std::string const& calculation_type, bool sym)\n+        : PowerGridError{[&]() {\n+              using namespace std::string_literals;\n+              auto const sym_str = sym ? \"sym\"s : \"asym\"s;\n+              return \"Unsupported validation case: \"s + sym_str + \" \"s + calculation_type;\n+          }()} {}\n+};\n+\n+class UnsupportedPGM_CType : public PowerGridError {\n+  public:\n+    UnsupportedPGM_CType()\n+        : PowerGridError{[&]() {\n+              using namespace std::string_literals;\n+              return \"Unsupported PGM_Ctype\"s;\n+          }()} {}\n+};\n+\n+class OptionalNotInitialized : public PowerGridError {\n+  public:\n+    OptionalNotInitialized(std::string const& object)\n+        : PowerGridError{[&]() {\n+              using namespace std::string_literals;\n+              return \"Optional \"s + object + \" object not initialized\"s;\n+          }()} {}\n+};\n+\n+inline bool is_nan(std::floating_point auto x) { return std::isnan(x); }\n+template <std::floating_point T> inline bool is_nan(std::complex<T> const& x) {\n+    return is_nan(x.real()) || is_nan(x.imag());\n+}\n+inline bool is_nan(int32_t x) { return x == std::numeric_limits<int32_t>::min(); }\n+inline bool is_nan(int8_t x) { return x == std::numeric_limits<int8_t>::min(); }\n+template <typename T, std::size_t N> inline bool is_nan(std::array<T, N> const& array) {\n+    return std::ranges::any_of(array, [](T const& element) { return is_nan(element); });\n+}\n+\n+template <class Functor, class... Args>\n+decltype(auto) pgm_type_func_selector(enum PGM_CType type, Functor&& f, Args&&... args) {\n+    switch (type) {\n+    case PGM_int32:\n+        return std::forward<Functor>(f).template operator()<int32_t>(std::forward<Args>(args)...);\n+    case PGM_int8:\n+        return std::forward<Functor>(f).template operator()<int8_t>(std::forward<Args>(args)...);\n+    case PGM_double:\n+        return std::forward<Functor>(f).template operator()<double>(std::forward<Args>(args)...);\n+    case PGM_double3:\n+        return std::forward<Functor>(f).template operator()<std::array<double, 3>>(std::forward<Args>(args)...);\n+    default:\n+        throw UnsupportedPGM_CType();\n+    }\n+}\n \n using nlohmann::json;\n \n@@ -40,201 +95,247 @@ auto read_json(std::filesystem::path const& path) {\n     return j;\n }\n \n-class UnsupportedValidationCase : public PowerGridError {\n-  public:\n-    UnsupportedValidationCase(std::string const& calculation_type, bool sym) {\n-        using namespace std::string_literals;\n-\n-        auto const sym_str = sym ? \"sym\"s : \"asym\"s;\n-        append_msg(\"Unsupported validation case: \"s + sym_str + \" \"s + calculation_type);\n-    };\n-};\n-\n-// memory buffer\n-using BufferPtr = std::unique_ptr<void, std::add_pointer_t<void(RawDataConstPtr)>>; // custom deleter at runtime\n-struct Buffer {\n-    BufferPtr ptr{nullptr, [](void const*) {}};\n-    IdxVector indptr;\n+struct OwningMemory {\n+    std::vector<Buffer> buffers;\n+    std::vector<std::vector<Idx>> indptrs;\n };\n \n struct OwningDataset {\n-    MutableDataset dataset;\n-    ConstDataset const_dataset;\n-    std::vector<Buffer> buffers{};\n-    std::vector<ConstDataset> batch_scenarios{};\n+    std::optional<DatasetMutable> dataset;\n+    std::optional<DatasetConst> const_dataset;\n+    OwningMemory storage{};\n };\n \n-auto create_owning_dataset(WritableDataset& info) {\n+OwningDataset create_owning_dataset(DatasetWritable& writable_dataset) {\n+    auto const& info = writable_dataset.get_info();\n+    Idx const is_batch = info.is_batch();\n     Idx const batch_size = info.batch_size();\n-    std::vector<Buffer> buffers;\n+    auto const& dataset_name = info.name();\n+    OwningDataset owning_dataset{.dataset{DatasetMutable{dataset_name, is_batch, batch_size}},\n+                                 .const_dataset = std::nullopt};\n \n     for (Idx component_idx{}; component_idx < info.n_components(); ++component_idx) {\n-        auto const& component_info = info.get_component_info(component_idx);\n-        auto const& component_meta = component_info.component;\n-\n-        Buffer buffer{};\n-        buffer.ptr =\n-            BufferPtr{component_meta->create_buffer(component_info.total_elements), component_meta->destroy_buffer};\n-        buffer.indptr = IdxVector(component_info.elements_per_scenario < 0 ? batch_size + 1 : 0);\n-        Idx* indptr_data = buffer.indptr.empty() ? nullptr : buffer.indptr.data();\n-\n-        info.set_buffer(component_info.component->name, indptr_data, buffer.ptr.get());\n-        buffers.push_back(std::move(buffer));\n+        auto const& component_name = info.component_name(component_idx);\n+        auto const& component_meta = MetaData::get_component_by_name(dataset_name, component_name);\n+        Idx const component_elements_per_scenario = info.component_elements_per_scenario(component_idx);\n+        Idx const component_size = info.component_total_elements(component_idx);\n+\n+        auto& current_indptr = owning_dataset.storage.indptrs.emplace_back(\n+            info.component_elements_per_scenario(component_idx) < 0 ? batch_size + 1 : 0);\n+        if (!current_indptr.empty()) {\n+            current_indptr.at(0) = 0;\n+            current_indptr.at(batch_size) = component_size;\n+        }\n+        Idx* const indptr = current_indptr.empty() ? nullptr : current_indptr.data();\n+        auto const& current_buffer = owning_dataset.storage.buffers.emplace_back(component_meta, component_size);\n+        writable_dataset.set_buffer(component_name, indptr, current_buffer);\n+        owning_dataset.dataset.value().add_buffer(component_name, component_elements_per_scenario, component_size,\n+                                                  indptr, current_buffer);\n     }\n-    return OwningDataset{\n-        .dataset = info,\n-        .const_dataset = info,\n-        .buffers = std::move(buffers),\n-    };\n+    owning_dataset.const_dataset = writable_dataset;\n+    return owning_dataset;\n }\n \n-auto construct_individual_scenarios(OwningDataset& owning_dataset) {\n-    for (Idx scenario_idx{}; scenario_idx < owning_dataset.dataset.batch_size(); ++scenario_idx) {\n-        owning_dataset.batch_scenarios.push_back(owning_dataset.const_dataset.get_individual_scenario(scenario_idx));\n+OwningDataset create_result_dataset(OwningDataset const& input, std::string const& dataset_name, Idx is_batch = 0,\n+                                    Idx batch_size = 1) {\n+    OwningDataset owning_dataset{.dataset{DatasetMutable{dataset_name, is_batch, batch_size}},\n+                                 .const_dataset = std::nullopt};\n+\n+    if (!input.const_dataset.has_value()) {\n+        throw OptionalNotInitialized(\"DatasetConst\");\n+    }\n+    DatasetInfo const& input_info = input.const_dataset.value().get_info();\n+\n+    for (Idx component_idx{}; component_idx != input_info.n_components(); ++component_idx) {\n+        auto const& component_name = input_info.component_name(component_idx);\n+        auto const& component_meta = MetaData::get_component_by_name(dataset_name, component_name);\n+        Idx const component_elements_per_scenario = input_info.component_elements_per_scenario(component_idx);\n+        Idx const component_size = input_info.component_total_elements(component_idx);\n+\n+        auto& current_indptr = owning_dataset.storage.indptrs.emplace_back(\n+            input_info.component_elements_per_scenario(component_idx) < 0 ? batch_size + 1 : 0);\n+        Idx const* const indptr = current_indptr.empty() ? nullptr : current_indptr.data();\n+        auto const& current_buffer = owning_dataset.storage.buffers.emplace_back(component_meta, component_size);\n+        owning_dataset.dataset.value().add_buffer(component_name, component_elements_per_scenario, component_size,\n+                                                  indptr, current_buffer);\n     }\n+    owning_dataset.const_dataset = owning_dataset.dataset.value();\n+    return owning_dataset;\n }\n \n OwningDataset load_dataset(std::filesystem::path const& path) {\n // Issue in msgpack, reported in https://github.com/msgpack/msgpack-c/issues/1098\n // May be a Clang Analyzer bug\n #ifndef __clang_analyzer__ // TODO(mgovers): re-enable this when issue in msgpack is fixed\n-    auto deserializer = Deserializer{power_grid_model::meta_data::from_json, read_file(path), meta_data_gen::meta_data};\n-    auto& info = deserializer.get_dataset_info();\n-    auto dataset = create_owning_dataset(info);\n-    deserializer.parse();\n-    construct_individual_scenarios(dataset);\n+    Deserializer deserializer{read_file(path), Idx{0}};\n+    auto& writable_dataset = deserializer.get_dataset();\n+    auto dataset = create_owning_dataset(writable_dataset);\n+    deserializer.parse_to_buffer();\n     return dataset;\n #else  // __clang_analyzer__ // issue in msgpack\n     (void)path;\n     // fallback for https://github.com/msgpack/msgpack-c/issues/1098\n-    return OwningDataset{.dataset = {false, 0, \"\", meta_data_gen::meta_data},\n-                         .const_dataset = {false, 0, \"\", meta_data_gen::meta_data}};\n+    return OwningDataset{};\n #endif // __clang_analyzer__ // issue in msgpack\n }\n \n-// create single result set\n-OwningDataset create_result_dataset(OwningDataset const& input, std::string const& data_type, bool is_batch = false,\n-                                    Idx batch_size = 1) {\n-    MetaDataset const& meta = meta_data_gen::meta_data.get_dataset(data_type);\n-    WritableDataset handler{is_batch, batch_size, meta.name, meta_data_gen::meta_data};\n-    assert(input.const_dataset.batch_size() == 1);\n-\n-    for (Idx i{}; i != input.const_dataset.n_components(); ++i) {\n-        auto const& component_info = input.const_dataset.get_component_info(i);\n-        handler.add_component_info(component_info.component->name, component_info.elements_per_scenario,\n-                                   component_info.elements_per_scenario * batch_size);\n+template <typename T> std::string get_as_string(T const& attribute_value) {\n+    std::stringstream sstr;\n+    sstr << std::setprecision(16);\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        sstr << \"(\" << attribute_value[0] << \", \" << attribute_value[1] << \", \" << attribute_value[2] << \")\";\n+    } else if constexpr (std::is_same_v<std::decay_t<T>, int8_t>) {\n+        sstr << std::to_string(attribute_value);\n+    } else {\n+        sstr << attribute_value;\n     }\n-    auto owning_dataset = create_owning_dataset(handler);\n-    construct_individual_scenarios(owning_dataset);\n-    return owning_dataset;\n+    return sstr.str();\n }\n \n template <typename T>\n-std::string get_as_string(RawDataConstPtr const& raw_data_ptr, MetaAttribute const& attr, Idx obj) {\n-    // ensure that we don't read outside owned memory\n-    REQUIRE(attr.ctype == ctype_v<T>);\n-    REQUIRE(attr.size == sizeof(T));\n-\n-    T value{};\n-    attr.get_value(raw_data_ptr, reinterpret_cast<RawDataPtr>(&value), obj);\n+bool check_angle_and_magnitude(T const& ref_angle, T const& angle, T const& ref_magnitude, T const& magnitude,\n+                               double atol, double rtol) {\n+    auto to_complex = [](double r, double theta) { return std::polar(r, theta); };\n+    auto is_within_tolerance = [atol, rtol](std::complex<double> element, std::complex<double> ref_element) {\n+        return std::abs(element - ref_element) < std::abs(ref_element) * rtol + atol;\n+    };\n \n-    std::stringstream sstr;\n-    sstr << std::setprecision(16);\n-    if constexpr (std::same_as<T, RealValue<asymmetric_t>>) {\n-        sstr << \"(\" << value(0) << \", \" << value(1) << \", \" << value(2) << \")\";\n-    } else if constexpr (std::same_as<T, int8_t>) {\n-        sstr << std::to_string(value);\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        std::array<std::complex<double>, 3> result;\n+        std::array<std::complex<double>, 3> ref_result;\n+        std::ranges::transform(magnitude, angle, result.begin(), to_complex);\n+        std::ranges::transform(ref_magnitude, ref_angle, ref_result.begin(), to_complex);\n+        return std::ranges::equal(result, ref_result, is_within_tolerance);\n+    }\n+    if constexpr (std::is_same_v<std::decay_t<T>, double>) {\n+        std::complex<double> const result = to_complex(magnitude, angle);\n+        std::complex<double> const ref_result = to_complex(ref_magnitude, ref_angle);\n+        return is_within_tolerance(result, ref_result);\n     } else {\n-        sstr << value;\n+        return ref_angle == angle && ref_magnitude == magnitude;\n     }\n-    return sstr.str();\n }\n \n-std::string get_as_string(RawDataConstPtr const& raw_data_ptr, MetaAttribute const& attr, Idx obj) {\n-    using enum CType;\n-    using namespace std::string_literals;\n+template <typename T>\n+bool compare_value(T const& ref_attribute_value, T const& attribute_value, double atol, double rtol) {\n+    auto is_within_tolerance = [atol, rtol](std::complex<double> element, std::complex<double> ref_element) {\n+        return std::abs(element - ref_element) < std::abs(ref_element) * rtol + atol;\n+    };\n \n-    switch (attr.ctype) {\n-    case c_int32:\n-        return get_as_string<int32_t>(raw_data_ptr, attr, obj);\n-    case c_int8:\n-        return get_as_string<int8_t>(raw_data_ptr, attr, obj);\n-    case c_double:\n-        return get_as_string<double>(raw_data_ptr, attr, obj);\n-    case c_double3:\n-        return get_as_string<RealValue<asymmetric_t>>(raw_data_ptr, attr, obj);\n-    default:\n-        return \"<unknown value type>\"s;\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        return std::ranges::equal(attribute_value, ref_attribute_value, is_within_tolerance);\n+    } else if constexpr (std::is_same_v<std::decay_t<T>, double>) {\n+        return is_within_tolerance(attribute_value, ref_attribute_value);\n+    } else {\n+        return ref_attribute_value == attribute_value;\n     }\n }\n \n-template <symmetry_tag sym>\n-bool check_angle_and_magnitude(RawDataConstPtr reference_result_ptr, RawDataConstPtr result_ptr,\n-                               MetaAttribute const& angle_attr, MetaAttribute const& mag_attr, double atol, double rtol,\n-                               Idx obj) {\n-    RealValue<sym> mag{};\n-    RealValue<sym> mag_ref{};\n-    RealValue<sym> angle{};\n-    RealValue<sym> angle_ref{};\n-    mag_attr.get_value(result_ptr, &mag, obj);\n-    mag_attr.get_value(reference_result_ptr, &mag_ref, obj);\n-    angle_attr.get_value(result_ptr, &angle, obj);\n-    angle_attr.get_value(reference_result_ptr, &angle_ref, obj);\n-    ComplexValue<sym> const result = mag * exp(1.0i * angle);\n-    ComplexValue<sym> const result_ref = mag_ref * exp(1.0i * angle_ref);\n-    if constexpr (is_symmetric_v<sym>) {\n-        return cabs(result - result_ref) < (cabs(result_ref) * rtol + atol);\n-    } else {\n-        return (cabs(result - result_ref) < (cabs(result_ref) * rtol + atol)).all();\n+template <typename T>\n+void check_results(T const& ref_attribute_value, T const& attribute_value, T const& ref_possible_attribute_value,\n+                   T const& possible_attribute_value, bool const& is_angle, Idx scenario_idx, Idx obj,\n+                   std::string const& component_name, std::string const& attribute_name, double const& dynamic_atol,\n+                   double const& rtol) {\n+    bool const match =\n+        is_angle\n+            ? check_angle_and_magnitude<decltype(ref_attribute_value)>(ref_attribute_value, attribute_value,\n+                                                                       ref_possible_attribute_value,\n+                                                                       possible_attribute_value, dynamic_atol, rtol)\n+            : compare_value<decltype(ref_attribute_value)>(ref_attribute_value, attribute_value, dynamic_atol, rtol);\n+    if (!match) {\n+        std::stringstream case_sstr;\n+        case_sstr << \"dataset scenario: #\" << scenario_idx << \", Component: \" << component_name << \" #\" << obj\n+                  << \", attribute: \" << attribute_name\n+                  << \": actual = \" << get_as_string<decltype(attribute_value)>(attribute_value) + \" vs. expected = \"\n+                  << get_as_string<decltype(ref_attribute_value)>(ref_attribute_value);\n+        CHECK_MESSAGE(match, case_sstr.str());\n     }\n }\n \n-bool check_angle_and_magnitude(RawDataConstPtr reference_result_ptr, RawDataConstPtr result_ptr,\n-                               MetaAttribute const& angle_attr, MetaAttribute const& mag_attr, double atol, double rtol,\n-                               Idx obj) {\n-    if (angle_attr.ctype == CType::c_double) {\n-        assert(mag_attr.ctype == CType::c_double);\n-        return check_angle_and_magnitude<symmetric_t>(reference_result_ptr, result_ptr, angle_attr, mag_attr, atol,\n-                                                      rtol, obj);\n+template <typename T>\n+bool skip_check(T const& ref_attribute_value, bool const is_angle, T const& ref_possible_attribute_value) {\n+    // check attributes. For angle attribute, also check magnitude available\n+    return is_nan(ref_attribute_value) || (is_angle && is_nan(ref_possible_attribute_value));\n+}\n+\n+template <typename T>\n+void check_individual_attribute(Buffer const& buffer, Buffer const& ref_buffer,\n+                                MetaAttribute const* const attribute_meta,\n+                                MetaAttribute const* const possible_attr_meta, bool const& is_angle,\n+                                Idx elements_per_scenario, Idx scenario_idx, Idx obj, std::string const& component_name,\n+                                std::string const& attribute_name, double const& dynamic_atol, double const& rtol) {\n+    Idx idx = (elements_per_scenario * scenario_idx) + obj;\n+    // get attribute values to check\n+    T ref_attribute_value{};\n+    T attribute_value{};\n+    T ref_possible_attribute_value{};\n+    T possible_attribute_value{};\n+    auto get_values = [&ref_buffer, &buffer, &attribute_meta, &possible_attr_meta,\n+                       idx]<typename U>(U* ref_value, U* value, U* ref_possible_value, U* possible_value) {\n+        ref_buffer.get_value(attribute_meta, ref_value, idx, 0);\n+        buffer.get_value(attribute_meta, value, idx, 0);\n+        ref_buffer.get_value(possible_attr_meta, ref_possible_value, idx, 0);\n+        buffer.get_value(possible_attr_meta, possible_value, idx, 0);\n+    };\n+    if constexpr (std::is_same_v<std::decay_t<T>, std::array<double, 3>>) {\n+        get_values(ref_attribute_value.data(), attribute_value.data(), ref_possible_attribute_value.data(),\n+                   possible_attribute_value.data());\n+    } else {\n+        get_values(&ref_attribute_value, &attribute_value, &ref_possible_attribute_value, &possible_attribute_value);\n+    }\n+\n+    if (!skip_check(ref_attribute_value, is_angle, ref_possible_attribute_value)) {\n+        check_results(ref_attribute_value, attribute_value, ref_possible_attribute_value, possible_attribute_value,\n+                      is_angle, scenario_idx, obj, component_name, attribute_name, dynamic_atol, rtol);\n     }\n-    assert(angle_attr.ctype == CType::c_double3);\n-    assert(mag_attr.ctype == CType::c_double3);\n-    return check_angle_and_magnitude<asymmetric_t>(reference_result_ptr, result_ptr, angle_attr, mag_attr, atol, rtol,\n-                                                   obj);\n }\n \n-// assert single result\n-void assert_result(ConstDataset const& result, ConstDataset const& reference_result,\n+void assert_result(OwningDataset const& owning_result, OwningDataset const& owning_reference_result,\n                    std::map<std::string, double, std::less<>> atol, double rtol) {\n     using namespace std::string_literals;\n-    MetaDataset const& meta = result.dataset();\n-    Idx const batch_size = result.batch_size();\n-    std::string const type_name = meta.name;\n-    // loop all scenario\n-    for (Idx scenario = 0; scenario != batch_size; ++scenario) {\n-        // loop all component type name\n-        for (Idx i{}; i != reference_result.n_components(); ++i) {\n-            auto const& component_info = reference_result.get_component_info(i);\n-            MetaComponent const& component_meta = *component_info.component;\n-            auto const& ref_buffer = reference_result.get_buffer(i);\n-            auto const& buffer = result.get_buffer(component_meta.name);\n-            Idx const elements_per_scenario = component_info.elements_per_scenario;\n-            assert(elements_per_scenario >= 0);\n-            // offset scenario\n-            RawDataConstPtr const result_ptr =\n-                reinterpret_cast<char const*>(buffer.data) + elements_per_scenario * scenario * component_meta.size;\n-            RawDataConstPtr const reference_result_ptr =\n-                reinterpret_cast<char const*>(ref_buffer.data) + elements_per_scenario * scenario * component_meta.size;\n-            // loop all attribute\n-            for (MetaAttribute const& attr : component_meta.attributes) {\n-                // TODO skip u angle, need a way for common angle\n-                if (attr.name == \"u_angle\"s) {\n+\n+    if (!owning_result.const_dataset.has_value()) {\n+        throw OptionalNotInitialized(\"DatasetConst\");\n+    }\n+    DatasetConst const& result = owning_result.const_dataset.value();\n+    auto const& result_info = result.get_info();\n+    auto const& result_name = result_info.name();\n+    Idx const result_batch_size = result_info.batch_size();\n+    auto const& storage = owning_result.storage;\n+\n+    if (!owning_reference_result.const_dataset.has_value()) {\n+        throw OptionalNotInitialized(\"DatasetConst\");\n+    }\n+    DatasetConst const& reference_result = owning_reference_result.const_dataset.value();\n+    auto const& reference_result_info = reference_result.get_info();\n+    auto const& reference_result_name = reference_result_info.name();\n+    auto const& reference_storage = owning_reference_result.storage;\n+    CHECK(storage.buffers.size() == reference_storage.buffers.size());\n+\n+    // loop through all scenarios\n+    for (Idx scenario_idx{}; scenario_idx < result_batch_size; ++scenario_idx) {\n+        // loop through all components\n+        for (Idx component_idx{}; component_idx < reference_result_info.n_components(); ++component_idx) {\n+            auto const& component_name = reference_result_info.component_name(component_idx);\n+            auto const* const component_meta = MetaData::get_component_by_name(reference_result_name, component_name);\n+\n+            auto const& ref_buffer = reference_storage.buffers.at(component_idx);\n+            auto const& buffer = storage.buffers.at(component_idx);\n+            Idx const elements_per_scenario = reference_result_info.component_elements_per_scenario(component_idx);\n+            CHECK(elements_per_scenario >= 0);\n+            // loop through all attributes\n+            for (Idx attribute_idx{}; attribute_idx < MetaData::n_attributes(component_meta); ++attribute_idx) {\n+                auto const* const attribute_meta = MetaData::get_attribute_by_idx(component_meta, attribute_idx);\n+                auto attribute_type = MetaData::attribute_ctype(attribute_meta);\n+                auto const& attribute_name = MetaData::attribute_name(attribute_meta);\n+                // TODO need a way for common angle: u angle skipped for now\n+                if (attribute_name == \"u_angle\"s) {\n                     continue;\n                 }\n                 // get absolute tolerance\n                 double dynamic_atol = atol.at(\"default\");\n                 for (auto const& [reg, value] : atol) {\n-                    if (std::regex_match(attr.name, std::regex{reg})) {\n+                    if (std::regex_match(attribute_name, std::regex{reg})) {\n                         dynamic_atol = value;\n                         break;\n                     }\n@@ -242,36 +343,22 @@ void assert_result(ConstDataset const& result, ConstDataset const& reference_res\n                 // for other _angle attribute, we need to find the magnitue and compare together\n                 std::regex const angle_regex(\"(.*)(_angle)\");\n                 std::smatch angle_match;\n-                std::string const attr_name = attr.name;\n-                bool const is_angle = std::regex_match(attr_name, angle_match, angle_regex);\n+                bool const is_angle = std::regex_match(attribute_name, angle_match, angle_regex);\n                 std::string const magnitude_name = angle_match[1];\n-                MetaAttribute const& possible_attr_magnitude =\n-                    is_angle ? component_meta.get_attribute(magnitude_name) : attr;\n-\n-                // loop all object\n-                for (Idx obj = 0; obj != elements_per_scenario; ++obj) {\n-                    // only check if reference result is not nan\n-                    if (attr.check_nan(reference_result_ptr, obj)) {\n-                        continue;\n-                    }\n-                    // for angle attribute, also check the magnitude available\n-                    if (is_angle && possible_attr_magnitude.check_nan(reference_result_ptr, obj)) {\n-                        continue;\n-                    }\n-                    bool const match =\n-                        is_angle ? check_angle_and_magnitude(reference_result_ptr, result_ptr, attr,\n-                                                             possible_attr_magnitude, dynamic_atol, rtol, obj)\n-                                 : attr.compare_value(reference_result_ptr, result_ptr, dynamic_atol, rtol, obj);\n-                    if (match) {\n-                        CHECK(match);\n-                    } else {\n-                        std::stringstream case_sstr;\n-                        case_sstr << \"dataset scenario: #\" << scenario << \", Component: \" << component_meta.name << \" #\"\n-                                  << obj << \", attribute: \" << attr.name\n-                                  << \": actual = \" << get_as_string(result_ptr, attr, obj) + \" vs. expected = \"\n-                                  << get_as_string(reference_result_ptr, attr, obj);\n-                        CHECK_MESSAGE(match, case_sstr.str());\n-                    }\n+                auto const& possible_attr_meta =\n+                    is_angle ? MetaData::get_attribute_by_name(reference_result_name, component_name, magnitude_name)\n+                             : attribute_meta;\n+                // loop through all objects\n+                for (Idx obj{}; obj < elements_per_scenario; ++obj) {\n+                    auto callable_wrapper = [&buffer, &ref_buffer, &attribute_meta, &possible_attr_meta, is_angle,\n+                                             elements_per_scenario, scenario_idx, obj, &component_name, &attribute_name,\n+                                             dynamic_atol, rtol]<typename T>() {\n+                        check_individual_attribute<T>(buffer, ref_buffer, attribute_meta, possible_attr_meta, is_angle,\n+                                                      elements_per_scenario, scenario_idx, obj, component_name,\n+                                                      attribute_name, dynamic_atol, rtol);\n+                    };\n+\n+                    pgm_type_func_selector(static_cast<PGM_CType>(attribute_type), callable_wrapper);\n                 }\n             }\n         }\n@@ -288,30 +375,22 @@ std::filesystem::path const data_dir = std::filesystem::path{__FILE__}.parent_pa\n #endif\n \n // method map\n-std::map<std::string, CalculationType, std::less<>> const calculation_type_mapping = {\n-    {\"power_flow\", CalculationType::power_flow},\n-    {\"state_estimation\", CalculationType::state_estimation},\n-    {\"short_circuit\", CalculationType::short_circuit}};\n-std::map<std::string, CalculationMethod, std::less<>> const calculation_method_mapping = {\n-    {\"newton_raphson\", CalculationMethod::newton_raphson},\n-    {\"linear\", CalculationMethod::linear},\n-    {\"iterative_current\", CalculationMethod::iterative_current},\n-    {\"iterative_linear\", CalculationMethod::iterative_linear},\n-    {\"linear_current\", CalculationMethod::linear_current},\n-    {\"iec60909\", CalculationMethod::iec60909}};\n-std::map<std::string, ShortCircuitVoltageScaling, std::less<>> const sc_voltage_scaling_mapping = {\n-    {\"\", ShortCircuitVoltageScaling::maximum}, // not provided returns default value\n-    {\"minimum\", ShortCircuitVoltageScaling::minimum},\n-    {\"maximum\", ShortCircuitVoltageScaling::maximum}};\n-using CalculationFunc =\n-    std::function<BatchParameter(MainModel&, CalculationMethod, MutableDataset const&, ConstDataset const&, Idx)>;\n-\n-std::map<std::string, OptimizerStrategy, std::less<>> const optimizer_strategy_mapping = {\n-    {\"disabled\", OptimizerStrategy::any},\n-    {\"any_valid_tap\", OptimizerStrategy::any},\n-    {\"min_voltage_tap\", OptimizerStrategy::global_minimum},\n-    {\"max_voltage_tap\", OptimizerStrategy::global_maximum},\n-    {\"fast_any_tap\", OptimizerStrategy::fast_any}};\n+std::map<std::string, PGM_CalculationType, std::less<>> const calculation_type_mapping = {\n+    {\"power_flow\", PGM_power_flow}, {\"state_estimation\", PGM_state_estimation}, {\"short_circuit\", PGM_short_circuit}};\n+std::map<std::string, PGM_CalculationMethod, std::less<>> const calculation_method_mapping = {\n+    {\"newton_raphson\", PGM_newton_raphson},       {\"linear\", PGM_linear},\n+    {\"iterative_current\", PGM_iterative_current}, {\"iterative_linear\", PGM_iterative_linear},\n+    {\"linear_current\", PGM_linear_current},       {\"iec60909\", PGM_iec60909}};\n+std::map<std::string, PGM_ShortCircuitVoltageScaling, std::less<>> const sc_voltage_scaling_mapping = {\n+    {\"\", PGM_short_circuit_voltage_scaling_maximum}, // not provided returns default value\n+    {\"minimum\", PGM_short_circuit_voltage_scaling_minimum},\n+    {\"maximum\", PGM_short_circuit_voltage_scaling_maximum}};\n+std::map<std::string, PGM_TapChangingStrategy, std::less<>> const optimizer_strategy_mapping = {\n+    {\"disabled\", PGM_tap_changing_strategy_disabled},\n+    {\"any_valid_tap\", PGM_tap_changing_strategy_any_valid_tap},\n+    {\"min_voltage_tap\", PGM_tap_changing_strategy_min_voltage_tap},\n+    {\"max_voltage_tap\", PGM_tap_changing_strategy_max_voltage_tap},\n+    {\"fast_any_tap\", PGM_tap_changing_strategy_fast_any_tap}};\n \n // case parameters\n struct CaseParam {\n@@ -321,11 +400,12 @@ struct CaseParam {\n     std::string calculation_method;\n     std::string short_circuit_voltage_scaling;\n     std::string tap_changing_strategy;\n+    double err_tol = 1e-8;\n+    Idx max_iter = 20;\n     bool sym{};\n     bool is_batch{};\n     double rtol{};\n     bool fail{};\n-    [[no_unique_address]] BatchParameter batch_parameter{};\n     std::map<std::string, double, std::less<>> atol;\n \n     static std::string replace_backslash(std::string const& str) {\n@@ -335,29 +415,17 @@ struct CaseParam {\n     }\n };\n \n-CalculationFunc calculation_func(CaseParam const& param) {\n-    auto const get_options = [&param](CalculationMethod calculation_method, Idx threading) {\n-        return MainModel::Options{\n-            .calculation_type = calculation_type_mapping.at(param.calculation_type),\n-            .calculation_symmetry = param.sym ? CalculationSymmetry::symmetric : CalculationSymmetry::asymmetric,\n-            .calculation_method = calculation_method,\n-            .optimizer_type = param.tap_changing_strategy == \"disabled\" ? OptimizerType::no_optimization\n-                                                                        : OptimizerType::automatic_tap_adjustment,\n-            .optimizer_strategy = optimizer_strategy_mapping.at(param.tap_changing_strategy),\n-            .err_tol = 1e-8,\n-            .max_iter = 20,\n-            .threading = threading,\n-            .short_circuit_voltage_scaling = sc_voltage_scaling_mapping.at(param.short_circuit_voltage_scaling)};\n-    };\n-\n-    return [get_options](MainModel& model, CalculationMethod calculation_method, MutableDataset const& dataset,\n-                         ConstDataset const& update_dataset, Idx threading) {\n-        auto options = get_options(calculation_method, threading);\n-        if (options.optimizer_type != OptimizerType::no_optimization) {\n-            REQUIRE(options.calculation_type == CalculationType::power_flow);\n-        }\n-        return model.calculate(options, dataset, update_dataset);\n-    };\n+Options get_options(CaseParam const& param, Idx threading = -1) {\n+    Options options{};\n+    options.set_calculation_type(calculation_type_mapping.at(param.calculation_type));\n+    options.set_calculation_method(calculation_method_mapping.at(param.calculation_method));\n+    options.set_symmetric(param.sym ? 1 : 0);\n+    options.set_err_tol(param.err_tol);\n+    options.set_max_iter(param.max_iter);\n+    options.set_threading(threading);\n+    options.set_short_circuit_voltage_scaling(sc_voltage_scaling_mapping.at(param.short_circuit_voltage_scaling));\n+    options.set_tap_changing_strategy(optimizer_strategy_mapping.at(param.tap_changing_strategy));\n+    return options;\n }\n \n std::string get_output_type(std::string const& calculation_type, bool sym) {\n@@ -458,16 +526,18 @@ void add_cases(std::filesystem::path const& case_dir, std::string const& calcula\n struct ValidationCase {\n     CaseParam param;\n     OwningDataset input;\n-    std::optional<OwningDataset> output{};\n-    std::optional<OwningDataset> update_batch{};\n-    std::optional<OwningDataset> output_batch{};\n+    std::optional<OwningDataset> output;\n+    std::optional<OwningDataset> update_batch;\n+    std::optional<OwningDataset> output_batch;\n };\n \n-ValidationCase create_validation_case(CaseParam const& param) {\n-    auto const output_type = get_output_type(param.calculation_type, param.sym);\n-\n+ValidationCase create_validation_case(CaseParam const& param, std::string const& output_type) {\n     // input\n-    ValidationCase validation_case{.param = param, .input = load_dataset(param.case_dir / \"input.json\")};\n+    ValidationCase validation_case{.param = param,\n+                                   .input = load_dataset(param.case_dir / \"input.json\"),\n+                                   .output = std::nullopt,\n+                                   .update_batch = std::nullopt,\n+                                   .output_batch = std::nullopt};\n \n     // output and update\n     if (!param.is_batch) {\n@@ -524,69 +594,51 @@ void execute_test(CaseParam const& param, T&& func) {\n     std::cout << \"Validation test: \" << param.case_name;\n \n     if (should_skip_test(param)) {\n-        std::cout << \" [skipped]\" << std::endl;\n+        std::cout << \" [skipped]\" << '\\n';\n     } else {\n-        std::cout << std::endl;\n-        func();\n+        std::cout << '\\n';\n+        std::forward<T>(func)();\n     }\n }\n \n void validate_single_case(CaseParam const& param) {\n     execute_test(param, [&]() {\n-        auto const validation_case = create_validation_case(param);\n         auto const output_prefix = get_output_type(param.calculation_type, param.sym);\n-        auto const result = create_result_dataset(validation_case.input, output_prefix);\n+        auto const validation_case = create_validation_case(param, output_prefix);\n+        auto const result = create_result_dataset(validation_case.output.value(), output_prefix);\n \n-        // create model and run\n-        MainModel model{50.0, validation_case.input.const_dataset, 0};\n-        CalculationFunc const func = calculation_func(param);\n+        // create and run model\n+        auto const& options = get_options(param);\n+        Model const model{50.0, validation_case.input.const_dataset.value()};\n+        model.calculate(options, result.dataset.value());\n \n-        ConstDataset const empty{false, 1, \"update\", meta_data_gen::meta_data};\n-        func(model, calculation_method_mapping.at(param.calculation_method), result.dataset, empty, -1);\n-        assert_result(result.const_dataset, validation_case.output.value().const_dataset, param.atol, param.rtol);\n+        // check results\n+        assert_result(result, validation_case.output.value(), param.atol, param.rtol);\n     });\n }\n \n void validate_batch_case(CaseParam const& param) {\n     execute_test(param, [&]() {\n-        auto const validation_case = create_validation_case(param);\n         auto const output_prefix = get_output_type(param.calculation_type, param.sym);\n-        auto const result = create_result_dataset(validation_case.input, output_prefix);\n+        auto const validation_case = create_validation_case(param, output_prefix);\n+        auto const& info = validation_case.update_batch.value().const_dataset.value().get_info();\n+        Idx const batch_size = info.batch_size();\n+        auto const batch_result =\n+            create_result_dataset(validation_case.output_batch.value(), output_prefix, Idx{1}, batch_size);\n \n         // create model\n-        // TODO (mgovers): fix false positive of misc-const-correctness\n-        // NOLINTNEXTLINE(misc-const-correctness)\n-        MainModel model{50.0, validation_case.input.const_dataset, 0};\n-        auto const n_scenario = static_cast<Idx>(validation_case.update_batch.value().batch_scenarios.size());\n-        CalculationFunc const func = calculation_func(param);\n-\n-        // run in loops\n-        for (Idx scenario = 0; scenario != n_scenario; ++scenario) {\n-            CAPTURE(scenario);\n-\n-            MainModel model_copy{model};\n-\n-            // update and run\n-            model_copy.update_component<permanent_update_t>(\n-                validation_case.update_batch.value().batch_scenarios[scenario]);\n-            ConstDataset const empty{false, 1, \"update\", meta_data_gen::meta_data};\n-            func(model_copy, calculation_method_mapping.at(param.calculation_method), result.dataset, empty, -1);\n-\n-            // check\n-            assert_result(result.const_dataset, validation_case.output_batch.value().batch_scenarios[scenario],\n-                          param.atol, param.rtol);\n-        }\n+        Model const model{50.0, validation_case.input.const_dataset.value()};\n \n-        // run in one-go, with different threading possibility\n-        auto const batch_result = create_result_dataset(validation_case.input, output_prefix, true, n_scenario);\n+        // check results after whole update is finished\n         for (Idx const threading : {-1, 0, 1, 2}) {\n             CAPTURE(threading);\n+            // set options and run\n+            auto const& options = get_options(param, threading);\n+            model.calculate(options, batch_result.dataset.value(),\n+                            validation_case.update_batch.value().const_dataset.value());\n \n-            func(model, calculation_method_mapping.at(param.calculation_method), batch_result.dataset,\n-                 validation_case.update_batch.value().const_dataset, threading);\n-\n-            assert_result(batch_result.const_dataset, validation_case.output_batch.value().const_dataset, param.atol,\n-                          param.rtol);\n+            // check results\n+            assert_result(batch_result, validation_case.output_batch.value(), param.atol, param.rtol);\n         }\n     });\n }\n@@ -626,4 +678,4 @@ TEST_CASE(\"Validation test batch\") {\n     }\n }\n \n-} // namespace power_grid_model::meta_data\n+} // namespace power_grid_model_cpp\n", "problem_statement": "[FEATURE] Optimize compilation speed by reorganize headers\n# Introduction\r\n\r\nThe calculation core is a header-only library in C++. In each build target of unit test, C API, validation test, etc, we have multiple translation units (`.cpp` files). The compilation speed is slow in both CI and local development machine. This is frustrating and slows down the development.\r\n\r\n# Proposal\r\n\r\nWe would like to re-organize the headers in the header only library to reduce the dependencies between the headers. Hopefully we can increase the compilation speed. Possible ways of improvement can be:\r\n\r\n1. Remove most of the standard library include in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp). Only keep the absolute common standard libraries (like `cstddef`). Include the needed standard library in individual header files where it is needed.\r\n2. Forward declare classes in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp), so that other headers can use the opaque type if the full type is not needed. This reduces the dependencies between the headers.\r\n3. Use separate header file with `type_traits` types to specify the `input`, `update`, .. types of each component. In this way, when compiling meta-data (like serializer), we do not need to include all the component types, only the traiter types.\r\n4. Make the `MathSolver` a generic template class with supported solvers, just like how the `MainModelImpl` is templated with the components\r\n5. Move generic template class `using` declarations like [`using MainModel = MainModelImpl<...>;`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/main_model.hpp#L1225-L1228) to separate header files, e.g. `main_model.hpp` and `main_model_impl.hpp`. The tester of dispatch functionality of the `MainModel` could then use a component-less instance.\r\n\n", "hints_text": "I also think that the fact that we do not use builder patterns increases this issue. that's why e.g. test_math_solver.cpp needs **all** solvers, even though not all solvers are needed for all tests\r\n\r\nWe can do something with the math solvers in the same way as we do for the `AllComponents` in the `MainModelImpl`.\r\n\r\nI also would recommend putting the `using` declaration in a separate header file, such that the tests that do not care about e.g. the iterative linear solver does not need to know about that solver.\r\n\r\nMaking smaller test files should also help, because `doctest` spends a lot of compilation time just on uncollapsing e.g. nested subcases\nirrelevant for CI but relevant for local development: i also think that we can split up the build target of the unit tests into multiple smaller ones to prevent the need of compiling all tests even though you're only looking into the deepest one\n@mgovers please modify the main content with your suggested header reorganization.\r\n\n> irrelevant for CI but relevant for local development: i also think that we can split up the build target of the unit tests into multiple smaller ones to prevent the need of compiling all tests even though you're only looking into the deepest one\r\n\r\nThis could be the next step if the compilation speed is still not satisfying after optimizing the header structure. My guess is that the target compilation speed should be improved (with incremental build) when the headers are decoupled a bit.\nThis might be very novice input, but aren't we making heavy use of templates? I think normally that is also not the easiest thing when it comes to compiling.\n> This might be very novice input, but aren't we making heavy use of templates? I think normally that is also not the easiest thing when it comes to compiling.\r\n\r\nyes but its also the thing that makes our code fast, so that's part of the trade-off. making heavier use of `concepts` should solve this partially, because it first does a check on the constraints before trying to compile everything. this takes up some time but not as much as trying to compile an implementation until compilation fails and then try the next implementation (as is the case for regular templates).", "created_at": "2024-09-11 15:20:06", "merge_commit_sha": "dd0d1b07d17dc37d99bb73db74a511df7faad769", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["build-cpp-test-windows (release, msvc)", ".github/workflows/main.yml"], ["build-cpp-test-linux (debug, clang)", ".github/workflows/main.yml"], ["Build and test in Conda (windows)", ".github/workflows/main.yml"], ["publish-wheels", ".github/workflows/main.yml"], ["build-cpp-test-macos (release)", ".github/workflows/main.yml"], ["SonarCloud", ".github/workflows/sonar.yml"], ["build-cpp-test-linux (debug, gcc)", ".github/workflows/main.yml"], ["clang-tidy (debug)", ".github/workflows/clang-tidy.yml"], ["build-and-test-python (linux-aarch64)", ".github/workflows/main.yml"], ["check-code-quality", ".github/workflows/check-code-quality.yml"], ["build-cpp-test-macos (debug)", ".github/workflows/main.yml"], ["build-and-test-python (macos)", ".github/workflows/main.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-14667", "base_commit": "5003be4b4a8e63bf1815d2e4663e6aba480afe3a", "patch": "diff --git a/FirebaseFunctions/CHANGELOG.md b/FirebaseFunctions/CHANGELOG.md\nindex f244f3f58e8..3c5253793be 100644\n--- a/FirebaseFunctions/CHANGELOG.md\n+++ b/FirebaseFunctions/CHANGELOG.md\n@@ -1,3 +1,7 @@\n+# Unreleased\n+- [fixed] Fix regression from 11.6.0 where `HTTPSCallable` did not invoke\n+  completion block on main thread (#14653).\n+\n # 11.10.0\n - [added] Streaming callable functions are now supported.\n \ndiff --git a/FirebaseFunctions/Sources/HTTPSCallable.swift b/FirebaseFunctions/Sources/HTTPSCallable.swift\nindex b423ac4195a..671a7b67dce 100644\n--- a/FirebaseFunctions/Sources/HTTPSCallable.swift\n+++ b/FirebaseFunctions/Sources/HTTPSCallable.swift\n@@ -76,15 +76,15 @@ open class HTTPSCallable: NSObject {\n   ///   - data: Parameters to pass to the trigger.\n   ///   - completion: The block to call when the HTTPS request has completed.\n   @objc(callWithObject:completion:) open func call(_ data: Any? = nil,\n-                                                   completion: @escaping (HTTPSCallableResult?,\n+                                                   completion: @escaping @MainActor (HTTPSCallableResult?,\n                                                                           Error?) -> Void) {\n     if #available(iOS 13, macCatalyst 13, macOS 10.15, tvOS 13, watchOS 7, *) {\n       Task {\n         do {\n           let result = try await call(data)\n-          completion(result, nil)\n+          await completion(result, nil)\n         } catch {\n-          completion(nil, error)\n+          await completion(nil, error)\n         }\n       }\n     } else {\n@@ -98,9 +98,13 @@ open class HTTPSCallable: NSObject {\n       ) { result in\n         switch result {\n         case let .success(callableResult):\n-          completion(callableResult, nil)\n+          DispatchQueue.main.async {\n+            completion(callableResult, nil)\n+          }\n         case let .failure(error):\n-          completion(nil, error)\n+          DispatchQueue.main.async {\n+            completion(nil, error)\n+          }\n         }\n       }\n     }\ndiff --git a/FirebaseFunctions/Tests/Integration/IntegrationTests.swift b/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\nindex 878cec1c9a0..0fa9c21e862 100644\n--- a/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\n+++ b/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\n@@ -867,6 +867,38 @@ class IntegrationTests: XCTestCase {\n       XCTAssertEqual(response, expected)\n     }\n   }\n+\n+  func testFunctionsReturnsOnMainThread() {\n+    let expectation = expectation(description: #function)\n+    functions.httpsCallable(\n+      \"scalarTest\",\n+      requestAs: Int16.self,\n+      responseAs: Int.self\n+    ).call(17) { result in\n+      guard case .success = result else {\n+        return XCTFail(\"Unexpected failure.\")\n+      }\n+      XCTAssert(Thread.isMainThread)\n+      expectation.fulfill()\n+    }\n+    waitForExpectations(timeout: 5)\n+  }\n+\n+  func testFunctionsThrowsOnMainThread() {\n+    let expectation = expectation(description: #function)\n+    functions.httpsCallable(\n+      \"httpErrorTest\",\n+      requestAs: [Int].self,\n+      responseAs: Int.self\n+    ).call([]) { result in\n+      guard case .failure = result else {\n+        return XCTFail(\"Unexpected failure.\")\n+      }\n+      XCTAssert(Thread.isMainThread)\n+      expectation.fulfill()\n+    }\n+    waitForExpectations(timeout: 5)\n+  }\n }\n \n // MARK: - Streaming\ndiff --git a/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m b/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\nindex 124f2eb9044..1d3f88981ee 100644\n--- a/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\n+++ b/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\n@@ -290,4 +290,28 @@ - (void)testTimeout {\n   [self waitForExpectations:@[ expectation ] timeout:10];\n }\n \n+- (void)testFunctionsReturnsOnMainThread {\n+  XCTestExpectation *expectation = [[XCTestExpectation alloc] init];\n+  FIRHTTPSCallable *function = [_functions HTTPSCallableWithName:@\"scalarTest\"];\n+  [function callWithObject:@17\n+                completion:^(FIRHTTPSCallableResult *_Nullable result, NSError *_Nullable error) {\n+                  XCTAssert(NSThread.isMainThread);\n+                  XCTAssertNotNil(result);\n+                  [expectation fulfill];\n+                }];\n+  [self waitForExpectations:@[ expectation ] timeout:10];\n+}\n+\n+- (void)testFunctionErrorsOnMainThread {\n+  XCTestExpectation *expectation = [[XCTestExpectation alloc] init];\n+  FIRHTTPSCallable *function = [_functions HTTPSCallableWithName:@\"httpErrorTest\"];\n+  [function callWithObject:@{}\n+                completion:^(FIRHTTPSCallableResult *_Nullable result, NSError *_Nullable error) {\n+                  XCTAssert(NSThread.isMainThread);\n+                  XCTAssertNotNil(error);\n+                  [expectation fulfill];\n+                }];\n+  [self waitForExpectations:@[ expectation ] timeout:10];\n+}\n+\n @end\ndiff --git a/FirebaseFunctions/Tests/Unit/FunctionsTests.swift b/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\nindex 476fe116853..255b2785451 100644\n--- a/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\n+++ b/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\n@@ -290,7 +290,7 @@ class FunctionsTests: XCTestCase {\n         }\n \n         XCTAssertEqual(error as NSError, networkError)\n-\n+        XCTAssert(Thread.isMainThread)\n         completionExpectation.fulfill()\n       }\n \n", "test_patch": "", "problem_statement": "HTTPSCallable does not invoke completion blocks on the main thread\n### Description\n\nIssue: `HTTPSCallable`'s `callWithObject:completion` does not invoke the completion block on the main thread.\n\nRegression: This appears to be a regression from #14085.\n\n### Reproducing the issue\n\n1. Create an HTTPSCallable function.\n2. Invoke it with `callWithObject:completion`\n\nExpected results: observe that the completion block is called on the main thread.\nActual results: the completion block is called on a background thread.\n\n### Firebase SDK Version\n\n11.11.1\n\n### Xcode Version\n\n16.2\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nFunctions\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\n\n```\n\n### If using Swift Package Manager, the project's Package.resolved\n\n_No response_\n\n### If using CocoaPods, the project's Podfile.lock\n\n_No response_\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.\ncc @ncooke3 @yakovmanshin \nSeems like an unintended consequence of that old change.\n\nOn the other hand, as I was refactoring some Functions components last year, it never occurred to me that calling completion handlers on the main thread was even as little as an *informal* convention\u2014more like a fortunate coincidence. In practice, I wouldn\u2019t rely on this behavior in client code; though, of course, some sort of harmonization would be welcome (so far there\u2019s only [one method](https://github.com/firebase/firebase-ios-sdk/blob/main/FirebaseFunctions/Sources/Functions.swift#L462-L502) in the entire module that explicitly schedules completions on the main thread).\n@bdaz, as a workaround until a fix is released, you could use the previous release or wrap the contents of your callback in `DispatchQueue.main.async {}`", "created_at": "2025-04-07 16:19:10", "merge_commit_sha": "5113cfd4f952fe29a28414b0b25bdae92a076dbd", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-integration (macos-14, Xcode_15.4)", ".github/workflows/functions.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos, macos-15, Xcode_16.2)", ".github/workflows/functions.yml"], ["spm-unit (macos-13, Xcode_15.2, iOS)", ".github/workflows/functions.yml"], ["cmake-prod-db", ".github/workflows/firestore.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm-unit (macos-15, Xcode_16.2, tvOS)", ".github/workflows/functions.yml"], ["spm-unit (macos-15, Xcode_16.2, watchOS)", ".github/workflows/functions.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["pod-lib-lint (tvos, macos-15, Xcode_16.2)", ".github/workflows/functions.yml"], ["spm-unit (macos-15, Xcode_16.2, visionOS)", ".github/workflows/functions.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13966", "base_commit": "36da449b15619d301302faeba639c7893d576220", "patch": "diff --git a/Crashlytics/run b/Crashlytics/run\nindex 93a6f11e7ae..bb1d43d8f0f 100755\n--- a/Crashlytics/run\n+++ b/Crashlytics/run\n@@ -46,8 +46,8 @@ for i in \"$@\"; do\n   ARGUMENTS=\"$ARGUMENTS \\\"$i\\\"\"\n done\n \n-VALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\n-UPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\n+VALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\n+UPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS \"\n \n # Quote the path to handle folders with special characters\n COMMAND_PATH=\"\\\"$DIR/upload-symbols\\\" \"\n", "test_patch": "", "problem_statement": "run script doesn't upload dsym files when <paths> parameter passed\n### Description\n\nWhen I try to upload multiple dsym files with <paths> parameter using run, it doesn't start uploading at all. I see this output in the build logs:\r\n\r\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"my.dSYM\", \"myother.dSYM\", \"--build-phase \", \"--validate\"]\r\n\r\nWhen I change these lines in the run script:\r\n```\r\nVALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\r\nUPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\r\n```\r\nto\r\n```\r\nVALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\r\nUPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS\"\r\n```\r\nit works, since the <paths> parameter should be the last parameter.\n\n### Reproducing the issue\n\nCall the run scirpt with a paths parameter to point another dSYM file.\n\n### Firebase SDK Version\n\n11.4\n\n### Xcode Version\n\n16\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChat-Debug.app.dSYM\", \"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChatShared.framework.dSYM\", \"--build-phase\", \"--validate\"]\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nPODS:\r\n  - FirebaseAnalytics (11.4.0):\r\n    - FirebaseAnalytics/AdIdSupport (= 11.4.0)\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseAnalytics/AdIdSupport (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleAppMeasurement (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseCore (11.4.2):\r\n    - FirebaseCoreInternal (< 12.0, >= 11.4.2)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/Logger (~> 8.0)\r\n  - FirebaseCoreExtension (11.4.1):\r\n    - FirebaseCore (~> 11.0)\r\n  - FirebaseCoreInternal (11.4.2):\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n  - FirebaseCrashlytics (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - FirebaseRemoteConfigInterop (~> 11.0)\r\n    - FirebaseSessions (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseInstallations (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseRemoteConfigInterop (11.4.0)\r\n  - FirebaseSessions (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseCoreExtension (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesSwift (~> 2.1)\r\n  - GoogleAppMeasurement (11.4.0):\r\n    - GoogleAppMeasurement/AdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/AdIdSupport (11.4.0):\r\n    - GoogleAppMeasurement/WithoutAdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/WithoutAdIdSupport (11.4.0):\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleDataTransport (10.1.0):\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - GoogleUtilities/AppDelegateSwizzler (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Network\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Environment (8.0.2):\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Logger (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/MethodSwizzler (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Network (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - \"GoogleUtilities/NSData+zlib\"\r\n    - GoogleUtilities/Privacy\r\n    - GoogleUtilities/Reachability\r\n  - \"GoogleUtilities/NSData+zlib (8.0.2)\":\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Privacy (8.0.2)\r\n  - GoogleUtilities/Reachability (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/UserDefaults (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - KMPNativeCoroutinesAsync (1.0.0-ALPHA-34):\r\n    - KMPNativeCoroutinesCore (= 1.0.0-ALPHA-34)\r\n  - KMPNativeCoroutinesCore (1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelCore (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCoreObjC (= 1.0.0-BETA-4)\r\n  - KMPObservableViewModelCoreObjC (1.0.0-BETA-4)\r\n  - KMPObservableViewModelSwiftUI (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCore (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (5.3.92)\r\n  - lottie-ios (4.5.0)\r\n  - MijickPopupView (2.7.1)\r\n  - nanopb (3.30910.0):\r\n    - nanopb/decode (= 3.30910.0)\r\n    - nanopb/encode (= 3.30910.0)\r\n  - nanopb/decode (3.30910.0)\r\n  - nanopb/encode (3.30910.0)\r\n  - OneSignalXCFramework (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalExtension (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalOutcomes (= 3.12.10)\r\n  - OneSignalXCFramework/OneSignalCore (3.12.10)\r\n  - OneSignalXCFramework/OneSignalExtension (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n    - OneSignalXCFramework/OneSignalOutcomes\r\n  - OneSignalXCFramework/OneSignalOutcomes (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n  - PromisesObjC (2.4.0)\r\n  - PromisesSwift (2.4.0):\r\n    - PromisesObjC (= 2.4.0)\r\n\r\nDEPENDENCIES:\r\n  - FirebaseAnalytics\r\n  - FirebaseCrashlytics\r\n  - KMPNativeCoroutinesAsync (= 1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelSwiftUI (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (~> 5.3.90)\r\n  - lottie-ios\r\n  - MijickPopupView\r\n  - OneSignalXCFramework (~> 3.12.9)\r\n\r\nSPEC REPOS:\r\n  https://github.com/CocoaPods/Specs.git:\r\n    - FirebaseAnalytics\r\n    - FirebaseCore\r\n    - FirebaseCoreExtension\r\n    - FirebaseCoreInternal\r\n    - FirebaseCrashlytics\r\n    - FirebaseInstallations\r\n    - FirebaseRemoteConfigInterop\r\n    - FirebaseSessions\r\n    - GoogleAppMeasurement\r\n    - GoogleDataTransport\r\n    - GoogleUtilities\r\n    - KMPNativeCoroutinesAsync\r\n    - KMPNativeCoroutinesCore\r\n    - KMPObservableViewModelCore\r\n    - KMPObservableViewModelCoreObjC\r\n    - KMPObservableViewModelSwiftUI\r\n    - lottie-ios\r\n    - MijickPopupView\r\n    - nanopb\r\n    - OneSignalXCFramework\r\n    - PromisesObjC\r\n    - PromisesSwift\r\n  https://gitlab.linphone.org/BC/public/podspec.git:\r\n    - linphone-sdk-novideo\r\n\r\nSPEC CHECKSUMS:\r\n  FirebaseAnalytics: 3feef9ae8733c567866342a1000691baaa7cad49\r\n  FirebaseCore: 6b32c57269bd999aab34354c3923d92a6e5f3f84\r\n  FirebaseCoreExtension: f1bc67a4702931a7caa097d8e4ac0a1b0d16720e\r\n  FirebaseCoreInternal: 35731192cab10797b88411be84940d2beb33a238\r\n  FirebaseCrashlytics: 41bbdd2b514a8523cede0c217aee6ef7ecf38401\r\n  FirebaseInstallations: 6ef4a1c7eb2a61ee1f74727d7f6ce2e72acf1414\r\n  FirebaseRemoteConfigInterop: e76f46ffa4d6a65e273d4dfebb6a79e588cec136\r\n  FirebaseSessions: 3f56f177d9e53a85021d16b31f9a111849d1dd8b\r\n  GoogleAppMeasurement: 987769c4ca6b968f2479fbcc9fe3ce34af454b8e\r\n  GoogleDataTransport: aae35b7ea0c09004c3797d53c8c41f66f219d6a7\r\n  GoogleUtilities: 26a3abef001b6533cf678d3eb38fd3f614b7872d\r\n  KMPNativeCoroutinesAsync: 709d922d3c8db3b83c5f0ce4035123dd7e6187b1\r\n  KMPNativeCoroutinesCore: 7e18aa574381ab40ea6a5b90ec2dffd362c0082b\r\n  KMPObservableViewModelCore: ded4abdfcc3566844c8dd18e23accd5cacd89a91\r\n  KMPObservableViewModelCoreObjC: d74dbf0c84cb8f66d6c706e89add1df9b8f653f4\r\n  KMPObservableViewModelSwiftUI: c3f740105ba32cd964cab1794d631b759d76a1d0\r\n  linphone-sdk-novideo: 50b8bcad0511613eca167586e75858f03cbaeb03\r\n  lottie-ios: a881093fab623c467d3bce374367755c272bdd59\r\n  MijickPopupView: 54863e093a18d6435cd5068850414570f9c1ba07\r\n  nanopb: fad817b59e0457d11a5dfbde799381cd727c1275\r\n  OneSignalXCFramework: e458f7a374192598a1d66418e1b61481c3cdf0e9\r\n  PromisesObjC: f5707f49cb48b9636751c5b2e7d227e43fba9f47\r\n  PromisesSwift: 9d77319bbe72ebf6d872900551f7eeba9bce2851\r\n\r\nPODFILE CHECKSUM: 4a3c4d0cf9b5f244d507d3ec13bca26d8124fa8b\r\n\r\nCOCOAPODS: 1.15.2\r\n\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.", "created_at": "2024-10-24 20:23:26", "merge_commit_sha": "c73f83a6a3e34c9fbe8517e53bc578efe5f5796c", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["spm (macos-15, Xcode_16, catalyst)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["pod-lib-lint (macos, macos-14, --use-modular-headers --skip-tests, Xcode_16)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (macos, macos-14, Xcode_15.2)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (macos, macos-14, Xcode_16)", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (ios, macos-14, Xcode_15.2)", ".github/workflows/crashlytics.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["spm (macos-14, Xcode_15.4, iOS)", ".github/workflows/crashlytics.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm (macos-15, Xcode_16, iOS)", ".github/workflows/crashlytics.yml"], ["quickstart-ftl-cron-only", ".github/workflows/crashlytics.yml"], ["spm (macos-15, Xcode_16, macOS)", ".github/workflows/crashlytics.yml"], ["spm (macos-13, Xcode_15.2, iOS)", ".github/workflows/crashlytics.yml"], ["catalyst", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (ios, macos-14, Xcode_16)", ".github/workflows/crashlytics.yml"], ["spm (macos-15, Xcode_16, tvOS)", ".github/workflows/crashlytics.yml"], ["check", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos --skip-tests, macos-14, Xcode_16)", ".github/workflows/crashlytics.yml"], ["crashlytics-cron-only", ".github/workflows/crashlytics.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13580", "base_commit": "71d8e92d168333f79ee29a555d32fee086e66ca5", "patch": "diff --git a/Firebase.podspec b/Firebase.podspec\nindex 78a0093eef2..75dd6212b16 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -122,7 +122,7 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.2.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '13.0'\n+    ss.ios.deployment_target = '12.0'\n     ss.osx.deployment_target = '10.15'\n     ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n", "test_patch": "", "problem_statement": "FirebaseCrashlytics deployment target inconsistency iOS 12 or 13\n### Description\n\nOur iOS application has iOS 12 as minimum deployment target (platform :ios, '12.0' in Podfile).\r\n\r\nIn our Podfile we have:\r\n\r\n`pod 'Firebase/Crashlytics', '~> 11.0'`\r\n\r\nIt fails as in Firebase.podspec Crashlytics subspec has iOS 13\r\n```\r\n  s.subspec 'Crashlytics' do |ss|\r\n    ss.ios.deployment_target = '13.0'\r\n  end\r\n```\r\n\r\nBut if we add to Podfile\r\n`pod 'FirebaseCrashlytics', '~> 11.0'`\r\n\r\nIt works, because in FirebaseCrashlytics.podspec iOS 12 is specified\r\n`ios_deployment_target = '12.0'`\r\n\r\nProbably iOS 12 can be specified in both places?\r\n\r\nThanks\r\n\n\n### Reproducing the issue\n\n_No response_\n\n### Firebase SDK Version\n\n11.1\n\n### Xcode Version\n\n15.4\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\n[!] CocoaPods could not find compatible versions for pod \"Firebase/Crashlytics\":\r\n  In Podfile:\r\n    Firebase/Crashlytics (~> 11.0)\r\n\r\nSpecs satisfying the `Firebase/Crashlytics (~> 11.0)` dependency were found, but they required a higher minimum deployment target.\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n_No response_\n\n### If using CocoaPods, the project's Podfile.lock\n\n_No response_\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.", "created_at": "2024-09-04 14:09:46", "merge_commit_sha": "b0dbeb8d37869f48b052170633510bb4c2753d33", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["client-app-cocoapods (ClientApp-CocoaPods-iOS13)", ".github/workflows/client_app.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["changes", ".github/workflows/firestore.yml"], ["client-app-cocoapods (ClientApp-CocoaPods)", ".github/workflows/client_app.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13176", "base_commit": "04f04917927da92f8f09e51df89328271def076c", "patch": "diff --git a/FirebaseMessaging/CHANGELOG.md b/FirebaseMessaging/CHANGELOG.md\nindex 29aa94a6057..d04f3da27c2 100644\n--- a/FirebaseMessaging/CHANGELOG.md\n+++ b/FirebaseMessaging/CHANGELOG.md\n@@ -1,3 +1,6 @@\n+# Unreleased\n+- [fixed] Fixed the APS Environment key on visionOS. (#13173)\n+\n # 10.29.0\n - [fixed] Renamed \"initWithFileName\" internal method that was causing submission issues for some\n   users. (#13134).\ndiff --git a/FirebaseMessaging/Sources/FIRMessagingUtilities.m b/FirebaseMessaging/Sources/FIRMessagingUtilities.m\nindex 2d9bddb5187..212cdf7208d 100644\n--- a/FirebaseMessaging/Sources/FIRMessagingUtilities.m\n+++ b/FirebaseMessaging/Sources/FIRMessagingUtilities.m\n@@ -28,12 +28,16 @@\n \n static NSString *const kFIRMessagingWatchKitExtensionPoint = @\"com.apple.watchkit\";\n \n-#if TARGET_OS_IOS || TARGET_OS_TV || TARGET_OS_WATCH\n-static NSString *const kEntitlementsAPSEnvironmentKey = @\"Entitlements.aps-environment\";\n-#else\n+#if TARGET_OS_OSX\n+// macOS uses a different entitlement key than the rest of Apple's platforms:\n+// https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_developer_aps-environment\n static NSString *const kEntitlementsAPSEnvironmentKey =\n     @\"Entitlements.com.apple.developer.aps-environment\";\n-#endif\n+#else\n+// Entitlement key for all non-macOS platforms:\n+// https://developer.apple.com/documentation/bundleresources/entitlements/aps-environment\n+static NSString *const kEntitlementsAPSEnvironmentKey = @\"Entitlements.aps-environment\";\n+#endif  // TARGET_OS_OSX\n static NSString *const kAPSEnvironmentDevelopmentValue = @\"development\";\n \n #pragma mark - URL Helpers\n", "test_patch": "", "problem_statement": "Firebase Cloud Messaging not working with visionOS\n### Description\n\nI have configured remote notifications for my cross-platform SwiftUI app, everything functions correctly and I'm receiving notifications on iOS devices but receive apns errors when launching on visionOS. \r\n\r\nERROR:\r\n10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\r\n\r\nI do successfully received the device token from fcm. These errors do not occur on iOS. I have also tested this on a clean project and had the same results.\n\n### Reproducing the issue\n\nUsing standing setup for a SwiftUI app will produce the errors when targeting visionOS\r\n\r\n`import SwiftUI\r\nimport FirebaseCore\r\nimport FirebaseMessaging\r\n\r\nclass AppDelegate: NSObject, UIApplicationDelegate, MessagingDelegate, UNUserNotificationCenterDelegate {\r\n    \r\n    func application(_ application: UIApplication,\r\n                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil) -> Bool {\r\n        application.registerForRemoteNotifications()\r\n        registerForPushNotifications(application: application)\r\n        \r\n        FirebaseApp.configure()\r\n        Messaging.messaging().delegate = self\r\n        return true\r\n    }\r\n    \r\n    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {\r\n        let tokenParts = deviceToken.map { data in String(format: \"%02.2hhx\", data) }\r\n        let token = tokenParts.joined()\r\n        print(\"Device Token: \\(token)\")\r\n        Messaging.messaging().apnsToken = deviceToken\r\n    }\r\n    \r\n    func registerForPushNotifications(application: UIApplication) {\r\n        UNUserNotificationCenter.current().delegate = self\r\n        let authOptions: UNAuthorizationOptions = [.alert, .badge, .sound]\r\n      \r\n        UNUserNotificationCenter.current().requestAuthorization(options: authOptions) { granted, error in\r\n            if let error = error {\r\n                print(\"Failed to request authorization: \\(error.localizedDescription)\")\r\n                return\r\n            }\r\n            guard granted else { return }\r\n            DispatchQueue.main.async {\r\n                application.registerForRemoteNotifications()\r\n            }\r\n        }\r\n    }\r\n    \r\n    func userNotificationCenter(_ center: UNUserNotificationCenter,\r\n                                willPresent notification: UNNotification,\r\n                                withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {\r\n   \r\n        completionHandler([.banner, .badge, .sound])\r\n    }\r\n    \r\n    func userNotificationCenter(_ center: UNUserNotificationCenter,\r\n                                didReceive response: UNNotificationResponse,\r\n                                withCompletionHandler completionHandler: @escaping () -> Void) {\r\n        let userInfo = response.notification.request.content.userInfo\r\n        completionHandler()\r\n    }\r\n    \r\n    func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {\r\n        print(\"Token: \\(fcmToken)\")\r\n    }\r\n}\r\n\r\n@main\r\nstruct NotificationsApp: App {\r\n    \r\n    @UIApplicationDelegateAdaptor(AppDelegate.self) var delegate\r\n    var body: some Scene {\r\n        WindowGroup {\r\n            ContentView()\r\n        }\r\n\r\n        ImmersiveSpace(id: \"ImmersiveSpace\") {\r\n            ImmersiveView()\r\n        }\r\n    }\r\n}`\n\n### Firebase SDK Version\n\n10.28.0\n\n### Xcode Version\n\n15.2\n\n### Installation Method\n\nSwift Package Manager\n\n### Firebase Product(s)\n\nMessaging\n\n### Targeted Platforms\n\niOS, visionOS\n\n### Relevant Log Output\n\n```shell\n10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\r\n\r\n<Error>: 10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.", "created_at": "2024-06-24 20:30:36", "merge_commit_sha": "5ef8265cfa3c262dd3f65cf12639fe8b3ecf50f5", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["messaging-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint-abtesting", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-dynamiclinks (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["messaging-watchos-standalone-sample-build-test", ".github/workflows/messaging.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-storage", ".github/workflows/health-metrics-presubmit.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-firestore", ".github/workflows/health-metrics-presubmit.yml"], ["spm (tvOS, macos-13)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-remoteconfig", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-remoteconfig (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["sanitizers-ubuntu", ".github/workflows/firestore.yml"], ["spm (iOS, macos-13)", ".github/workflows/messaging.yml"], ["quickstart-ftl-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint-database (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["quickstart (macos-13, Xcode_15.2)", ".github/workflows/messaging.yml"], ["catalyst", ".github/workflows/messaging.yml"], ["messaging_quickstart", ".github/workflows/prerelease.yml"], ["auth_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint-database", ".github/workflows/health-metrics-presubmit.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["spm (tvOS, macos-14)", ".github/workflows/messaging.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-inappmessaging", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["changes", ".github/workflows/firestore.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["messaging-integration-tests", ".github/workflows/messaging.yml"], ["performance_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-firestore (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["check", ".github/workflows/check.yml"], ["Check changed files", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-storage (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"], ["buildup_SpecsTesting_repo_FirebaseCore", ".github/workflows/prerelease.yml"], ["check-firestore-internal-public-headers", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13114", "base_commit": "3af2f80aeeb81c58867265569939b1818e2f544d", "patch": "diff --git a/FirebaseStorage/CHANGELOG.md b/FirebaseStorage/CHANGELOG.md\nindex 1baafc4bbdb..1703f2ae829 100644\n--- a/FirebaseStorage/CHANGELOG.md\n+++ b/FirebaseStorage/CHANGELOG.md\n@@ -1,3 +1,9 @@\n+# 11.0.0\n+- [fixed] Updated error handling to support both Swift error enum handling and NSError error\n+  handling. Some of the Swift enums have additional parameters which may be a **breaking** change.\n+  There are additional NSError's for completeness, but nothing related to NSError handling is\n+  breaking. (#13071, #10889, #13114)\n+\n # 10.24.0\n - [fixed] `putFile` and `putFileAsync` now work in app extensions. A background session\n    configuration is not used when uploading from an app extension (#12579).\ndiff --git a/FirebaseStorage/Sources/AsyncAwait.swift b/FirebaseStorage/Sources/AsyncAwait.swift\nindex 8fffded0e18..e38a2525711 100644\n--- a/FirebaseStorage/Sources/AsyncAwait.swift\n+++ b/FirebaseStorage/Sources/AsyncAwait.swift\n@@ -66,7 +66,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putDataAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putDataAsync\")\n         ))\n       }\n     }\n@@ -103,7 +104,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putFileAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putFileAsync\")\n         ))\n       }\n     }\n@@ -137,7 +139,8 @@ public extension StorageReference {\n       }\n       downloadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in writeAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in writeAsync\")\n         ))\n       }\n     }\ndiff --git a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\nindex 2cca8acdca2..5fb5ca61ae1 100644\n--- a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n@@ -74,10 +74,10 @@ class StorageGetDownloadURLTask: StorageTask, StorageTaskManagement {\n              .jsonObject(with: data) as? [String: Any] {\n             downloadURL = self.downloadURLFromMetadataDictionary(responseDictionary)\n             if downloadURL == nil {\n-              self.error = NSError(domain: StorageErrorDomain,\n-                                   code: StorageErrorCode.unknown.rawValue,\n-                                   userInfo: [NSLocalizedDescriptionKey:\n-                                     \"Failed to retrieve a download URL.\"])\n+              self.error = StorageError.unknown(\n+                message: \"Failed to retrieve a download URL.\",\n+                serverError: [:]\n+              ) as NSError\n             }\n           } else {\n             self.error = StorageErrorCode.error(withInvalidRequest: data)\ndiff --git a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\nindex 217f8775116..bb195656cae 100644\n--- a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n@@ -45,12 +45,7 @@ class StorageTokenAuthorizer: NSObject, GTMSessionFetcherAuthorizer {\n           var errorDictionary = error.userInfo\n           errorDictionary[\"ResponseErrorDomain\"] = error.domain\n           errorDictionary[\"ResponseErrorCode\"] = error.code\n-          errorDictionary[NSLocalizedDescriptionKey] =\n-            \"User is not authenticated, please authenticate\" +\n-            \" using Firebase Authentication and try again.\"\n-          tokenError = NSError(domain: \"FIRStorageErrorDomain\",\n-                               code: StorageErrorCode.unauthenticated.rawValue,\n-                               userInfo: errorDictionary)\n+          tokenError = StorageError.unauthenticated(serverError: errorDictionary) as NSError\n         } else if let token {\n           let firebaseToken = \"Firebase \\(token)\"\n           request?.setValue(firebaseToken, forHTTPHeaderField: \"Authorization\")\ndiff --git a/FirebaseStorage/Sources/Result.swift b/FirebaseStorage/Sources/Result.swift\nindex 931794cbfb1..3a73da64f97 100644\n--- a/FirebaseStorage/Sources/Result.swift\n+++ b/FirebaseStorage/Sources/Result.swift\n@@ -29,9 +29,11 @@ private func getResultCallback<T>(completion: @escaping (Result<T, Error>) -> Vo\n     if let value {\n       completion(.success(value))\n     } else if let error {\n-      completion(.failure(StorageError.swiftConvert(objcError: error as NSError)))\n+      completion(.failure(error))\n     } else {\n-      completion(.failure(StorageError.internalError(\"Internal failure in getResultCallback\")))\n+      completion(.failure(StorageError.internalError(\n+        message: \"Internal failure in getResultCallback\"\n+      )))\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/Storage.swift b/FirebaseStorage/Sources/Storage.swift\nindex 3d547e28da3..09f211d3341 100644\n--- a/FirebaseStorage/Sources/Storage.swift\n+++ b/FirebaseStorage/Sources/Storage.swift\n@@ -193,9 +193,9 @@ import FirebaseCore\n     do {\n       path = try StoragePath.path(string: url.absoluteString)\n     } catch let StoragePathError.storagePathError(message) {\n-      throw StorageError.pathError(message)\n+      throw StorageError.pathError(message: message)\n     } catch {\n-      throw StorageError.pathError(\"Internal error finding StoragePath: \\(error)\")\n+      throw StorageError.pathError(message: \"Internal error finding StoragePath: \\(error)\")\n     }\n \n     // If no default bucket exists (empty string), accept anything.\n@@ -205,7 +205,7 @@ import FirebaseCore\n     // If there exists a default bucket, throw if provided a different bucket.\n     if path.bucket != storageBucket {\n       throw StorageError\n-        .bucketMismatch(\"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n+        .bucketMismatch(message: \"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n           \"bucket of the current instance: `\\(storageBucket)`\")\n     }\n     return StorageReference(storage: self, path: path)\ndiff --git a/FirebaseStorage/Sources/StorageDownloadTask.swift b/FirebaseStorage/Sources/StorageDownloadTask.swift\nindex 8f9f0332393..91629bd632b 100644\n--- a/FirebaseStorage/Sources/StorageDownloadTask.swift\n+++ b/FirebaseStorage/Sources/StorageDownloadTask.swift\n@@ -67,8 +67,7 @@ open class StorageDownloadTask: StorageObservableTask, StorageTaskManagement {\n    * Cancels a task.\n    */\n   @objc open func cancel() {\n-    let error = StorageErrorCode.error(withCode: .cancelled)\n-    cancel(withError: error)\n+    cancel(withError: StorageError.cancelled as NSError)\n   }\n \n   /**\ndiff --git a/FirebaseStorage/Sources/StorageError.swift b/FirebaseStorage/Sources/StorageError.swift\nindex d9e80dd31bd..f3e02340a2d 100644\n--- a/FirebaseStorage/Sources/StorageError.swift\n+++ b/FirebaseStorage/Sources/StorageError.swift\n@@ -36,24 +36,17 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n   case downloadSizeExceeded = -13032\n   case cancelled = -13040\n   case invalidArgument = -13050\n+  case bucketMismatch = -13051\n+  case internalError = -13052\n+  case pathError = -13053\n \n   /**\n-   * Creates a Firebase Storage error from a specific GCS error and FIRIMPLStorageReference.\n+   * Creates a Firebase Storage error from a specific GCS error and StorageReference.\n    * @param serverError Server error to wrap and return as a Firebase Storage error.\n    * @param ref StorageReference which provides context about the request being made.\n    * @return Returns a Firebase Storage error.\n    */\n   static func error(withServerError serverError: NSError, ref: StorageReference) -> NSError {\n-    var errorCode: StorageErrorCode\n-    switch serverError.code {\n-    case 400: errorCode = .unknown\n-    case 401: errorCode = .unauthenticated\n-    case 402: errorCode = .quotaExceeded\n-    case 403: errorCode = .unauthorized\n-    case 404: errorCode = .objectNotFound\n-    default: errorCode = .unknown\n-    }\n-\n     var errorDictionary = serverError.userInfo\n     errorDictionary[\"ResponseErrorDomain\"] = serverError.domain\n     errorDictionary[\"ResponseErrorCode\"] = serverError.code\n@@ -66,7 +59,29 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     if let data = (errorDictionary[\"data\"] as? Data) {\n       errorDictionary[\"ResponseBody\"] = String(data: data, encoding: .utf8)\n     }\n-    return error(withCode: errorCode, infoDictionary: errorDictionary)\n+    let storageError = switch serverError.code {\n+    case 400: StorageError.unknown(\n+        message: \"Unknown 400 error from backend\",\n+        serverError: errorDictionary\n+      )\n+    case 401: StorageError.unauthenticated(serverError: errorDictionary)\n+    case 402: StorageError.quotaExceeded(\n+        bucket: ref.path.bucket,\n+        serverError: errorDictionary\n+      )\n+    case 403: StorageError.unauthorized(\n+        bucket: ref.path.bucket,\n+        object: ref.path.object ?? \"<object-entity-internal-error>\",\n+        serverError: errorDictionary\n+      )\n+    case 404: StorageError.objectNotFound(\n+        object: ref.path.object ?? \"<object-entity-internal-error>\", serverError: errorDictionary\n+      )\n+    default: StorageError.unknown(\n+        message: \"Unexpected \\(serverError.code) code from backend\", serverError: errorDictionary\n+      )\n+    }\n+    return storageError as NSError\n   }\n \n   /** Creates a Firebase Storage error from an invalid request.\n@@ -81,143 +96,123 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     } else {\n       requestString = \"<nil request returned from server>\"\n     }\n-    let invalidDataString = \"Invalid data returned from the server:\\(requestString)\"\n-    return error(\n-      withCode: .unknown,\n-      infoDictionary: [NSLocalizedFailureErrorKey: invalidDataString]\n-    )\n+    let invalidDataString = \"Invalid data returned from the server: \\(requestString)\"\n+    return StorageError.unknown(message: invalidDataString, serverError: [:]) as NSError\n   }\n+}\n \n-  /**\n-   * Creates a Firebase Storage error from a specific FIRStorageErrorCode while adding\n-   * custom info from an optionally provided info dictionary.\n-   */\n-  static func error(withCode code: StorageErrorCode,\n-                    infoDictionary: [String: Any]? = nil) -> NSError {\n-    var dictionary = infoDictionary ?? [:]\n-    var errorMessage: String\n-    switch code {\n+/// Firebase Storage errors\n+public enum StorageError: Error, CustomNSError {\n+  case unknown(message: String, serverError: [String: Any])\n+  case objectNotFound(object: String, serverError: [String: Any])\n+  case bucketNotFound(bucket: String)\n+  case projectNotFound(project: String)\n+  case quotaExceeded(bucket: String, serverError: [String: Any])\n+  case unauthenticated(serverError: [String: Any])\n+  case unauthorized(bucket: String, object: String, serverError: [String: Any])\n+  case retryLimitExceeded\n+  case nonMatchingChecksum\n+  case downloadSizeExceeded(total: Int64, maxSize: Int64)\n+  case cancelled\n+  case invalidArgument(message: String)\n+  case internalError(message: String)\n+  case bucketMismatch(message: String)\n+  case pathError(message: String)\n+\n+  // MARK: - CustomNSError\n+\n+  /// Default domain of the error.\n+  public static var errorDomain: String { return StorageErrorDomain }\n+\n+  /// The error code within the given domain.\n+  public var errorCode: Int {\n+    switch self {\n+    case .unknown:\n+      return StorageErrorCode.unknown.rawValue\n     case .objectNotFound:\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"Object \\(object) does not exist.\"\n+      return StorageErrorCode.objectNotFound.rawValue\n     case .bucketNotFound:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage = \"Bucket \\(bucket) does not exist.\"\n+      return StorageErrorCode.bucketNotFound.rawValue\n     case .projectNotFound:\n-      let project = dictionary[\"project\"] ?? \"<project-entity-internal-error>\"\n-      errorMessage = \"Project \\(project) does not exist.\"\n+      return StorageErrorCode.projectNotFound.rawValue\n     case .quotaExceeded:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage =\n-        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n-    case .downloadSizeExceeded:\n-      let total = \"\\(dictionary[\"totalSize\"] ?? \"unknown\")\"\n-      let size = \"\\(dictionary[\"maxAllowedSize\"] ?? \"unknown\")\"\n-      errorMessage = \"Attempted to download object with size of \\(total) bytes, \" +\n-        \"which exceeds the maximum size of \\(size) bytes. \" +\n-        \"Consider raising the maximum download size, or using StorageReference.write\"\n+      return StorageErrorCode.quotaExceeded.rawValue\n     case .unauthenticated:\n-      errorMessage = \"User is not authenticated, please authenticate using Firebase \" +\n-        \"Authentication and try again.\"\n+      return StorageErrorCode.unauthenticated.rawValue\n     case .unauthorized:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return StorageErrorCode.unauthorized.rawValue\n     case .retryLimitExceeded:\n-      errorMessage = \"Max retry time for operation exceeded, please try again.\"\n+      return StorageErrorCode.retryLimitExceeded.rawValue\n     case .nonMatchingChecksum:\n-      // TODO: replace with actual checksum strings when we choose to implement.\n-      errorMessage = \"Uploaded/downloaded object TODO has checksum: TODO \" +\n-        \"which does not match server checksum: TODO. Please retry the upload/download.\"\n+      return StorageErrorCode.nonMatchingChecksum.rawValue\n+    case .downloadSizeExceeded:\n+      return StorageErrorCode.downloadSizeExceeded.rawValue\n     case .cancelled:\n-      errorMessage = \"User cancelled the upload/download.\"\n-    case .unknown, .invalidArgument: // invalidArgument fell through in the old Objective-C code.\n-      errorMessage = \"An unknown error occurred, please check the server response.\"\n+      return StorageErrorCode.cancelled.rawValue\n+    case .invalidArgument:\n+      return StorageErrorCode.invalidArgument.rawValue\n+    case .internalError:\n+      return StorageErrorCode.internalError.rawValue\n+    case .bucketMismatch:\n+      return StorageErrorCode.bucketMismatch.rawValue\n+    case .pathError:\n+      return StorageErrorCode.pathError.rawValue\n     }\n-    dictionary[NSLocalizedDescriptionKey] = errorMessage\n-    return NSError(domain: StorageErrorDomain, code: code.rawValue, userInfo: dictionary)\n   }\n-}\n-\n-public enum StorageError: Error {\n-  case unknown(String)\n-  case objectNotFound(String)\n-  case bucketNotFound(String)\n-  case projectNotFound(String)\n-  case quotaExceeded(String)\n-  case unauthenticated\n-  case unauthorized(String, String)\n-  case retryLimitExceeded\n-  case nonMatchingChecksum\n-  case downloadSizeExceeded(Int64, Int64)\n-  case cancelled\n-  case invalidArgument(String)\n-  case internalError(String)\n-  case bucketMismatch(String)\n-  case pathError(String)\n \n-  static func swiftConvert(objcError: NSError) -> StorageError {\n-    let userInfo = objcError.userInfo\n-\n-    switch objcError.code {\n-    case StorageErrorCode.unknown.rawValue:\n-      return StorageError.unknown(objcError.localizedDescription)\n-    case StorageErrorCode.objectNotFound.rawValue:\n-      guard let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode object not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.objectNotFound(object)\n-    case StorageErrorCode.bucketNotFound.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode bucket not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.bucketNotFound(bucket)\n-    case StorageErrorCode.projectNotFound.rawValue:\n-      guard let project = userInfo[\"project\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode project not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.projectNotFound(project)\n-    case StorageErrorCode.quotaExceeded.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\"Failed to decode quota exceeded error: \\(objcError.localizedDescription)\")\n-      }\n-      return StorageError.quotaExceeded(bucket)\n-    case StorageErrorCode.unauthenticated.rawValue: return StorageError.unauthenticated\n-    case StorageErrorCode.unauthorized.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String,\n-            let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode unauthorized error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.unauthorized(bucket, object)\n-    case StorageErrorCode.retryLimitExceeded.rawValue: return StorageError.retryLimitExceeded\n-    case StorageErrorCode.nonMatchingChecksum.rawValue: return StorageError\n-      .nonMatchingChecksum\n-    case StorageErrorCode.downloadSizeExceeded.rawValue:\n-      guard let total = userInfo[\"totalSize\"] as? Int64,\n-            let maxSize = userInfo[\"maxAllowedSize\"] as? Int64 else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode downloadSizeExceeded error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.downloadSizeExceeded(total, maxSize)\n-    case StorageErrorCode.cancelled.rawValue: return StorageError.cancelled\n-    case StorageErrorCode.invalidArgument.rawValue: return StorageError\n-      .invalidArgument(objcError.localizedDescription)\n-    default: return StorageError.internalError(\"Internal error converting ObjC Error to Swift\")\n+  /// The default user-info dictionary.\n+  public var errorUserInfo: [String: Any] {\n+    switch self {\n+    case let .unknown(message, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = message\n+      return dictionary\n+    case let .objectNotFound(object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"Object \\(object) does not exist.\"\n+      return dictionary\n+    case let .bucketNotFound(bucket):\n+      return [NSLocalizedDescriptionKey: \"Bucket \\(bucket) does not exist.\"]\n+    case let .projectNotFound(project):\n+      return [NSLocalizedDescriptionKey: \"Project \\(project) does not exist.\"]\n+    case let .quotaExceeded(bucket, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n+      return dictionary\n+    case let .unauthenticated(serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"User is not authenticated, please \" +\n+        \"authenticate using Firebase Authentication and try again.\"\n+      return dictionary\n+    case let .unauthorized(bucket, object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return dictionary\n+    case .retryLimitExceeded:\n+      return [NSLocalizedDescriptionKey: \"Max retry time for operation exceeded, please try again.\"]\n+    case .nonMatchingChecksum:\n+      // TODO: replace with actual checksum strings when we choose to implement.\n+      return [NSLocalizedDescriptionKey: \"Uploaded/downloaded object TODO has checksum: TODO \" +\n+        \"which does not match server checksum: TODO. Please retry the upload/download.\"]\n+    case let .downloadSizeExceeded(total, maxSize):\n+      var dictionary: [String: Any] = [\"totalSize\": total, \"maxAllowedSize\": maxSize]\n+      dictionary[NSLocalizedDescriptionKey] = \"Attempted to download object with size of \" +\n+        \"\\(total) bytes, \" +\n+        \"which exceeds the maximum size of \\(maxSize) bytes. \" +\n+        \"Consider raising the maximum download maxSize, or using StorageReference.write\"\n+      return dictionary\n+    case .cancelled:\n+      return [NSLocalizedDescriptionKey: \"User cancelled the upload/download.\"]\n+    case let .invalidArgument(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .internalError(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .bucketMismatch(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .pathError(message):\n+      return [NSLocalizedDescriptionKey: message]\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/StorageReference.swift b/FirebaseStorage/Sources/StorageReference.swift\nindex 92a547b3f14..9e4f0c29c41 100644\n--- a/FirebaseStorage/Sources/StorageReference.swift\n+++ b/FirebaseStorage/Sources/StorageReference.swift\n@@ -399,11 +399,9 @@ import Foundation\n   open func list(maxResults: Int64,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -437,11 +435,9 @@ import Foundation\n                  pageToken: String,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -584,11 +580,10 @@ import Foundation\n   /// For maxSize API, return an error if the size is exceeded.\n   private func checkSizeOverflow(task: StorageTask, maxSize: Int64) -> NSError? {\n     if task.progress.totalUnitCount > maxSize || task.progress.completedUnitCount > maxSize {\n-      return StorageErrorCode.error(withCode: .downloadSizeExceeded,\n-                                    infoDictionary: [\n-                                      \"totalSize\": task.progress.totalUnitCount,\n-                                      \"maxAllowedSize\": maxSize,\n-                                    ])\n+      return StorageError.downloadSizeExceeded(\n+        total: task.progress.totalUnitCount,\n+        maxSize: maxSize\n+      ) as NSError\n     }\n     return nil\n   }\ndiff --git a/FirebaseStorage/Sources/StorageTaskSnapshot.swift b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\nindex 3c909d67855..d7b291b06a8 100644\n--- a/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n+++ b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n@@ -68,7 +68,7 @@ import Foundation\n        reference: StorageReference,\n        progress: Progress,\n        metadata: StorageMetadata? = nil,\n-       error: NSError? = nil) {\n+       error: Error? = nil) {\n     self.task = task\n     self.reference = reference\n     self.progress = progress\ndiff --git a/FirebaseStorage/Sources/StorageUploadTask.swift b/FirebaseStorage/Sources/StorageUploadTask.swift\nindex 8c99e8c4a28..5878b03fb04 100644\n--- a/FirebaseStorage/Sources/StorageUploadTask.swift\n+++ b/FirebaseStorage/Sources/StorageUploadTask.swift\n@@ -237,14 +237,10 @@ import Foundation\n        isFile == true {\n       return nil\n     }\n-    let userInfo = [NSLocalizedDescriptionKey:\n-      \"File at URL: \\(fileURL?.absoluteString ?? \"\") is not reachable.\"\n-      + \" Ensure file URL is not a directory, symbolic link, or invalid url.\"]\n-    return NSError(\n-      domain: StorageErrorDomain,\n-      code: StorageErrorCode.unknown.rawValue,\n-      userInfo: userInfo\n-    )\n+    return StorageError.unknown(message: \"File at URL: \\(fileURL?.absoluteString ?? \"\") is \" +\n+      \"not reachable. Ensure file URL is not \" +\n+      \"a directory, symbolic link, or invalid url.\",\n+      serverError: [:]) as NSError\n   }\n \n   func finishTaskWithStatus(status: StorageTaskStatus, snapshot: StorageTaskSnapshot) {\ndiff --git a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\nindex f8729a5b675..fa780f24a6c 100644\n--- a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n@@ -118,11 +118,29 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putDataAsync(data)\n       XCTFail(\"Unexpected success from unauthorized putData\")\n-    } catch let StorageError.unauthorized(bucket, object) {\n+    } catch let StorageError.unauthorized(bucket, object, _) {\n       XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n       XCTAssertEqual(object, objectLocation)\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unauthorized\")\n+      XCTFail(\"error failed to convert to StorageError.unauthorized  \\(error)\")\n+    }\n+  }\n+\n+  func testSimplePutDataUnauthorizedWithNSError() async throws {\n+    let objectLocation = \"ios/private/secretfile.txt\"\n+    let ref = storage.reference(withPath: objectLocation)\n+    let data = try XCTUnwrap(\"Hello Swift World\".data(using: .utf8), \"Data construction failed\")\n+    do {\n+      _ = try await ref.putDataAsync(data)\n+      XCTFail(\"Unexpected success from unauthorized putData\")\n+    } catch {\n+      let e = error as NSError\n+      XCTAssertEqual(e.domain, StorageErrorDomain)\n+      XCTAssertEqual(e.code, StorageErrorCode.unauthorized.rawValue)\n+      XCTAssertEqual(e.localizedDescription, \"User does not have permission to access\" +\n+        \" gs://ios-opensource-samples.appspot.com/ios/private/secretfile.txt.\")\n+      XCTAssertEqual(e.userInfo[\"ResponseErrorCode\"] as? Int, 403)\n+      print(e)\n     }\n   }\n \n@@ -136,13 +154,13 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putFileAsync(from: fileURL)\n       XCTFail(\"Unexpected success from putFile of a directory\")\n-    } catch let StorageError.unknown(reason) {\n+    } catch let StorageError.unknown(reason, _) {\n       XCTAssertTrue(reason.starts(with: \"File at URL:\"))\n       XCTAssertTrue(reason.hasSuffix(\n         \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n       ))\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unknown\")\n+      XCTFail(\"error failed to convert to StorageError.unknown \\(error)\")\n     }\n   }\n \ndiff --git a/FirebaseStorage/Tests/Integration/StorageIntegration.swift b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\nindex 2f407dc7427..7e93e84e7fe 100644\n--- a/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n@@ -201,7 +201,7 @@ class StorageResultTests: StorageIntegrationCommon {\n         XCTFail(\"Unexpected success from unauthorized putData\")\n       case let .failure(error as StorageError):\n         switch error {\n-        case let .unauthorized(bucket, object):\n+        case let .unauthorized(bucket, object, serverError):\n           XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n           XCTAssertEqual(object, file)\n           expectation.fulfill()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageAPITests.swift b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\nindex 02d6b06e557..0244d22f7be 100644\n--- a/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n@@ -158,6 +158,9 @@ final class StorageAPITests: XCTestCase {\n     case .downloadSizeExceeded: return code\n     case .cancelled: return code\n     case .invalidArgument: return code\n+    case .bucketMismatch: return code\n+    case .internalError: return code\n+    case .pathError: return code\n     @unknown default:\n       fatalError()\n     }\ndiff --git a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\nindex 52592be27c2..a711125d8c1 100644\n--- a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n@@ -181,7 +181,9 @@ class StorageGetMetadataTests: StorageTestHelpers {\n       fetcherService: fetcherService!.self,\n       queue: dispatchQueue!.self\n     ) { metadata, error in\n-      XCTAssertEqual((error as? NSError)!.code, StorageErrorCode.unknown.rawValue)\n+      XCTAssertNil(metadata)\n+      let nsError = try! XCTUnwrap(error as? NSError)\n+      XCTAssertEqual(nsError.code, StorageErrorCode.unknown.rawValue)\n       expectation.fulfill()\n     }\n     task.enqueue()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\nindex 56efb5cabf9..7854bedcf15 100644\n--- a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n@@ -72,7 +72,7 @@ class StorageReferenceTests: XCTestCase {\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bcket` does not match the Storage \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bcket` does not match the Storage \" +\n           \"bucket of the current instance: `bucket`\\\")\"\n       )\n     }\n@@ -95,8 +95,9 @@ class StorageReferenceTests: XCTestCase {\n   func testBadBucketScheme2() throws {\n     let url = try XCTUnwrap(URL(string: \"htttp://bucket/\"))\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n-      XCTAssertEqual(\"\\(error)\", \"pathError(\\\"Internal error: URL scheme must be one of gs://, \" +\n-        \"http://, or https://\\\")\")\n+      XCTAssertEqual(\"\\(error)\",\n+                     \"pathError(message: \\\"Internal error: URL scheme must be one of gs://, \" +\n+                       \"http://, or https://\\\")\")\n     }\n   }\n \n@@ -219,7 +220,7 @@ class StorageReferenceTests: XCTestCase {\n         XCTFail(\"Unexpected success.\", file: #file, line: #line)\n       case let .failure(error):\n         switch error {\n-        case let StorageError.unknown(message):\n+        case let StorageError.unknown(message, serverError):\n           let expectedDescription = \"File at URL: \\(dummyFileURL.absoluteString) \" +\n             \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n           XCTAssertEqual(expectedDescription, message)\ndiff --git a/FirebaseStorage/Tests/Unit/StorageTests.swift b/FirebaseStorage/Tests/Unit/StorageTests.swift\nindex ff605798ef8..bbc19194c62 100644\n--- a/FirebaseStorage/Tests/Unit/StorageTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageTests.swift\n@@ -45,7 +45,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n           \"Storage bucket of the current instance: `benwu-test1.storage.firebase.com`\\\")\"\n       )\n     }\n@@ -126,7 +126,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bucket` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bucket` does not match the \" +\n           \"Storage bucket of the current instance: `notMyBucket`\\\")\"\n       )\n     }\n", "test_patch": "", "problem_statement": "FirebaseStorage.StorageError provides limited information\n### Description\r\n\r\nOne of my TestFlight users consistently gets an error when using the FirebaseStorage API:\r\n`StorageReference.writeAsync()`\r\n\r\nLogging this error provides little insights since the localizedDescription is\r\n`The operation couldn\u2019t be completed. (FirebaseStorage.StorageError error 0.)`\r\n\r\nUnpacking the error case and logging the `.unknown(String)` produces\r\n`An unknown error occurred, please check the server response.`\r\n\r\nThe server response isn't on the error however since its lost when the Objective-C `NSError` is converted the Swift enum via `swiftConvert(objcError:)`.\r\n\r\nWould it be possible to instead make `StorageError` conform to [`CustomNSError`](https://developer.apple.com/documentation/foundation/customnserror) and expose the `userInfo` in Swift? Would love to debug this without rewriting a significant portion of my code in Objective-C.\r\n\r\n### Reproducing the issue\r\n\r\nTrying to figure this out myself.\r\n\r\n### Firebase SDK Version\r\n\r\n10.5.0\r\n\r\n### Xcode Version\r\n\r\n14.2\r\n\r\n### Installation Method\r\n\r\nSwift Package Manager\r\n\r\n### Firebase Product(s)\r\n\r\nStorage\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n```json\r\n{\r\n  \"pins\" : [\r\n    {\r\n      \"identity\" : \"abseil-cpp-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/abseil-cpp-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"583de9bd60f66b40e78d08599cc92036c2e7e4e1\",\r\n        \"version\" : \"0.20220203.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"boringssl-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/boringssl-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"dd3eda2b05a3f459fc3073695ad1b28659066eab\",\r\n        \"version\" : \"0.9.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"firebase-ios-sdk\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/firebase-ios-sdk\",\r\n      \"state\" : {\r\n        \"revision\" : \"f567ed9a2b30e29159df258049a9c662c517688e\",\r\n        \"version\" : \"10.5.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleappmeasurement\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleAppMeasurement.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"9a09ece724128e8d1e14c5133b87c0e236844ac0\",\r\n        \"version\" : \"10.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googledatatransport\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleDataTransport.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"f6b558e3f801f2cac336b04f615ce111fa9ddaa0\",\r\n        \"version\" : \"9.2.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleutilities\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleUtilities.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0543562f85620b5b7c510c6bcbef75b562a5127b\",\r\n        \"version\" : \"7.11.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"grpc-ios\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/grpc/grpc-ios.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"8440b914756e0d26d4f4d054a1c1581daedfc5b6\",\r\n        \"version\" : \"1.44.3-grpc\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"gtm-session-fetcher\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/gtm-session-fetcher.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"5ccda3981422a84186387dbb763ba739178b529c\",\r\n        \"version\" : \"2.3.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"leveldb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/leveldb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0706abcc6b0bd9cedfbb015ba840e4a780b5159b\",\r\n        \"version\" : \"1.22.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"mixpanel-swift\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/mixpanel/mixpanel-swift\",\r\n      \"state\" : {\r\n        \"branch\" : \"master\",\r\n        \"revision\" : \"dfc52c9155f2e42fb69f98a2370647d28d7eebe1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"nanopb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/nanopb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"819d0a2173aff699fb8c364b6fb906f7cdb1a692\",\r\n        \"version\" : \"2.30909.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"promises\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/promises.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"ec957ccddbcc710ccc64c9dcbd4c7006fcf8b73a\",\r\n        \"version\" : \"2.2.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"swift-protobuf\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/apple/swift-protobuf.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0af9125c4eae12a4973fb66574c53a54962a9e1e\",\r\n        \"version\" : \"1.21.0\"\r\n      }\r\n    }\r\n  ],\r\n  \"version\" : 2\r\n}\r\n```\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.\nThanks for the report. We'll take a look in the next few weeks. In the meantime, let us know if you find anything more - and we'd be interested in a PR.\nErrors from the server should actually be wrapped by `func error(withServerError serverError: NSError, ref: StorageReference)`.  if the error is not a server error, all the context should be in the Swift error. More examples and context in #10913.  If you're still blocked, we may need a reproducible example.\nSorry for the delayed response and thanks for adding a PR!\r\n\r\nSo the `Error` that is created via `error(withServerError:..` is actually great - it has all the info needed since it copies over the `userInfo` dictionary from the server `Error`. #10913 might actually not be necessary as all the info is carried over.\r\n\r\nThe loss in information comes when the wrapped `Error` is converted to the new `StorageError` in the `getResultCallback` method. I think a fix here would be to just not call `.swiftConvert(objcError:`. The case where there is no error in the callback can potentially leverage the new `StorageError` error type introduced.\r\n\r\nI was actually able to work around this quite easily (staying in an async Swift context) by just using the sync APIs and wrapping them with `withCheckedThrowingContinuation` myself. This threw the wrapped `error(withServerError` error as opposed to the `StorageError` and had all the info needed in my logging to debug.\r\n\r\nTL'DR\r\nServer Error -> Wrapped Error -> StorageError. \r\nThe first two are great - the third is missing info.\nThanks @jurgowski. I like the ideas of using `CustomNSError` and/or dropping `swiftConvert`. However, I'm not sure that can be done without breaking the ability to catch individual `StorageErrors` so it would be a breaking change. As a result, I've marked this for our next breaking change release.\r\n\r\nI agree that the `underlyingError` change isn't absolutely necessary but it should be non-breaking and provide the underlying server Error in a more standard way.\nI guess the main use case for `CustomNSError` is to make Swift errors easy to deal with in Obj-C code without custom bridging. It seems like in this case, the errors are coming from Obj-C and `StorageError` is a newly introduced error type (I didn't realize this when I first opened the issue). \r\n\r\nI agree that I don't think there is a way to make a change here that doesn't alter current behavior since `StorageError` is an enum.. However, I would expect that anyone catching `StorageError` is probably catching all errors generically. It may be possible to use the error directly in the failure case of the `Result` in `getResultCallback` (without converting it to `StorageError` via `swiftConvert`). As long as `StorageError` isn't deleted, things would still compile. \nSome WIP at https://github.com/firebase/firebase-ios-sdk/commit/3fae8e7ebc364985642a1000e89b2f663b5fc8ae", "created_at": "2024-06-11 22:45:42", "merge_commit_sha": "337d1efd54db7bc38c5ae9cbb034a5361a2d5221", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/storage.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm (iOS, macos-14)", ".github/workflows/storage.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["spm (tvOS, macos-14)", ".github/workflows/storage.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/storage.yml"], ["storage-integration-tests (ObjC)", ".github/workflows/storage.yml"], ["storage-cron-only", ".github/workflows/storage.yml"], ["spm (macOS, macos-14)", ".github/workflows/storage.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm (watchOS, macos-14)", ".github/workflows/storage.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/storage.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/storage.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm (macOS, macos-13)", ".github/workflows/storage.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13066", "base_commit": "594abb825043e6371f7336625d6ff5931b2a80b9", "patch": "diff --git a/CoreOnly/Tests/FirebasePodTest/Podfile b/CoreOnly/Tests/FirebasePodTest/Podfile\nindex d5c3822537b..5724b18b03a 100644\n--- a/CoreOnly/Tests/FirebasePodTest/Podfile\n+++ b/CoreOnly/Tests/FirebasePodTest/Podfile\n@@ -18,7 +18,6 @@ target 'FirebasePodTest' do\n   pod 'FirebaseDatabase', :path => '../../../'\n   pod 'FirebaseDynamicLinks', :path => '../../../'\n   pod 'FirebaseFirestore', :path => '../../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../../'\n   pod 'FirebaseFunctions', :path => '../../../'\n   pod 'FirebaseInAppMessaging', :path => '../../../'\n   pod 'FirebaseInstallations', :path => '../../../'\ndiff --git a/Firebase.podspec b/Firebase.podspec\nindex bb29fb049db..d464a2205ea 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -22,20 +22,20 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     \"CoreOnly/README.md\"\n   ]\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.cocoapods_version = '>= 1.12.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.default_subspec = 'Core'\n \n   s.subspec 'Core' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.ios.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.osx.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.tvos.dependency 'FirebaseAnalytics', '~> 11.0.0'\n@@ -55,30 +55,30 @@ Simplify your app development, grow your user base, and monetize more effectivel\n         'HEADER_SEARCH_PATHS' => \"$(inherited) ${PODS_ROOT}/Firebase/CoreOnly/Sources\"\n       }\n     end\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Analytics' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithoutAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'FirebaseAnalytics/WithoutAdIdSupport', '~> 11.0.0'\n     ss.dependency 'Firebase/CoreOnly'\n   end\n@@ -87,87 +87,87 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseABTesting', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'AppDistribution' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseAppDistribution', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'AppCheck' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAppCheck', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Auth' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAuth', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Crashlytics' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Database' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseDatabase', '~> 11.0.0'\n     # Standard platforms PLUS watchOS 7.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'DynamicLinks' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseDynamicLinks', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'Firestore' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFirestore', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Functions' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFunctions', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'InAppMessaging' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n     ss.tvos.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Installations' do |ss|\n@@ -179,48 +179,48 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMessaging', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'MLModelDownloader' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMLModelDownloader', '~> 11.0.0-beta'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Performance' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebasePerformance', '~> 11.0.0'\n     ss.tvos.dependency 'FirebasePerformance', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'RemoteConfig' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseRemoteConfig', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Storage' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseStorage', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n end\ndiff --git a/FirebaseABTesting.podspec b/FirebaseABTesting.podspec\nindex e8fe7414e45..6392dae0dc7 100644\n--- a/FirebaseABTesting.podspec\n+++ b/FirebaseABTesting.podspec\n@@ -22,10 +22,10 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -35,7 +35,7 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   base_dir = \"FirebaseABTesting/Sources/\"\n   s.source_files = [\ndiff --git a/FirebaseAnalytics.podspec b/FirebaseAnalytics.podspec\nindex 6467a9ef914..822a18a3b5a 100644\n--- a/FirebaseAnalytics.podspec\n+++ b/FirebaseAnalytics.podspec\n@@ -17,11 +17,11 @@ Pod::Spec.new do |s|\n     }\n \n     s.cocoapods_version = '>= 1.12.0'\n-    s.swift_version     = '5.3'\n+    s.swift_version     = '5.9'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/FirebaseAnalyticsOnDeviceConversion.podspec b/FirebaseAnalyticsOnDeviceConversion.podspec\nindex 2decdc2cac8..c8ccfe444c1 100644\n--- a/FirebaseAnalyticsOnDeviceConversion.podspec\n+++ b/FirebaseAnalyticsOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.static_framework = true\n \n-    s.ios.deployment_target = '10.0'\n+    s.ios.deployment_target = '12.0'\n \n     s.source_files = 'FirebaseAnalyticsOnDeviceConversionWrapper/*'\n end\ndiff --git a/FirebaseAppCheck.podspec b/FirebaseAppCheck.podspec\nindex b698de23452..e04fdfd976b 100644\n--- a/FirebaseAppCheck.podspec\n+++ b/FirebaseAppCheck.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAppCheckInterop.podspec b/FirebaseAppCheckInterop.podspec\nindex d8d372b4206..318feae1b1f 100644\n--- a/FirebaseAppCheckInterop.podspec\n+++ b/FirebaseAppCheckInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAppCheck/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAppCheck/Interop/Public/FirebaseAppCheckInterop/*.h'\ndiff --git a/FirebaseAppDistribution.podspec b/FirebaseAppDistribution.podspec\nindex 50135707816..fdfbd788c3c 100644\n--- a/FirebaseAppDistribution.podspec\n+++ b/FirebaseAppDistribution.podspec\n@@ -15,9 +15,9 @@ iOS SDK for App Distribution for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\nindex 2dc8abf4945..43b93570106 100644\n--- a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n+++ b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n@@ -23,12 +23,8 @@\n \n @implementation FIRAppDistributionUIService\n \n-API_AVAILABLE(ios(12.0))\n ASWebAuthenticationSession *_webAuthenticationVC;\n \n-// TODO: Remove this when the deployment target becomes iOS 12+\n-SFAuthenticationSession *_safariAuthenticationVC;\n-\n - (instancetype)init {\n   self = [super init];\n \n@@ -66,15 +62,8 @@ + (NSError *_Nullable)mapErrorToAppDistributionError:(NSError *_Nullable)error {\n   if (!error) {\n     return nil;\n   }\n-\n-  if (@available(iOS 12.0, *)) {\n-    if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n-  } else {\n-    if ([error code] == SFAuthenticationErrorCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n+  if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n+    return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n   }\n \n   return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationFailure];\n@@ -88,39 +77,24 @@ - (void)appDistributionRegistrationFlow:(NSURL *)URL\n   FIRFADInfoLog(@\"Registration URL: %@\", URL);\n   FIRFADInfoLog(@\"Callback URL: %@\", callbackURL);\n \n-  if (@available(iOS 12.0, *)) {\n-    ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    if (@available(iOS 13.0, *)) {\n-      authenticationVC.presentationContextProvider = self;\n-    }\n-\n-    _webAuthenticationVC = authenticationVC;\n+  ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n+            initWithURL:URL\n+      callbackURLScheme:callbackURL\n+      completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n+        [self resetUIState];\n+        [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n+        NSError *_Nullable appDistributionError =\n+            [[self class] mapErrorToAppDistributionError:error];\n+        completion(appDistributionError);\n+      }];\n \n-    [authenticationVC start];\n-  } else {\n-    _safariAuthenticationVC = [[SFAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[SFAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    [_safariAuthenticationVC start];\n+  if (@available(iOS 13.0, *)) {\n+    authenticationVC.presentationContextProvider = self;\n   }\n+\n+  _webAuthenticationVC = authenticationVC;\n+\n+  [authenticationVC start];\n }\n \n - (void)showUIAlert:(UIAlertController *)alertController {\n@@ -234,13 +208,7 @@ - (void)resetUIState {\n \n   self.registrationFlowCompletion = nil;\n \n-  if (@available(iOS 12.0, *)) {\n-    _webAuthenticationVC = nil;\n-  }\n-  // TODO: Remove this when the deployment target becomes iOS 12+\n-  // `_safariAuthenticationVC` is cleared unconditionally just in case;\n-  // It\u2019s supposed to be assigned only when run on iOS 11.\n-  _safariAuthenticationVC = nil;\n+  _webAuthenticationVC = nil;\n }\n \n - (void)safariViewControllerDidFinish:(SFSafariViewController *)controller {\ndiff --git a/FirebaseAuth.podspec b/FirebaseAuth.podspec\nindex 773fa9e5a21..2ce91b86c03 100644\n--- a/FirebaseAuth.podspec\n+++ b/FirebaseAuth.podspec\n@@ -24,7 +24,7 @@ supports email and password accounts, as well as several 3rd party authenticatio\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAuthInterop.podspec b/FirebaseAuthInterop.podspec\nindex f60eb9aa0be..2765250ac45 100644\n--- a/FirebaseAuthInterop.podspec\n+++ b/FirebaseAuthInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAuth/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAuth/Interop/Public/FirebaseAuthInterop/*.h'\ndiff --git a/FirebaseAuthTestingSupport.podspec b/FirebaseAuthTestingSupport.podspec\nindex f581d15d40e..3cf9b5128b5 100644\n--- a/FirebaseAuthTestingSupport.podspec\n+++ b/FirebaseAuthTestingSupport.podspec\n@@ -18,11 +18,11 @@ Pod::Spec.new do |s|\n   }\n \n   ios_deployment_target = '13.0'\n-  osx_deployment_target = '10.13'\n+  osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -39,7 +39,7 @@ Pod::Spec.new do |s|\n     base_dir + 'Sources/**/*.swift',\n   ]\n \n-  s.dependency 'FirebaseAuth', '~> 10.22'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n \n   s.test_spec 'unit' do |unit_tests|\n     unit_tests.scheme = { :code_coverage => true }\ndiff --git a/FirebaseCombineSwift.podspec b/FirebaseCombineSwift.podspec\nindex 6f5ad6bcfc9..1670e68b9d4 100644\n--- a/FirebaseCombineSwift.podspec\n+++ b/FirebaseCombineSwift.podspec\n@@ -1,6 +1,6 @@\n Pod::Spec.new do |s|\n   s.name             = 'FirebaseCombineSwift'\n-  s.version          = '10.0.0'\n+  s.version          = '11.0.0'\n   s.summary          = 'Swift extensions with Combine support for Firebase'\n \n   s.description      = <<-DESC\n@@ -19,12 +19,12 @@ for internal testing only. It should not be published.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  s.swift_version         = '5.3'\n+  s.swift_version       = '5.9'\n \n   ios_deployment_target = '13.0'\n   osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n-  watchos_deployment_target = '6.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -51,11 +51,11 @@ for internal testing only. It should not be published.\n   s.osx.framework = 'AppKit'\n   s.tvos.framework = 'UIKit'\n \n-  s.dependency 'FirebaseCore', '~> 10.0'\n-  s.dependency 'FirebaseAuth', '~> 10.0'\n-  s.dependency 'FirebaseFunctions', '~> 10.0'\n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n-  s.dependency 'FirebaseStorage', '~> 10.0'\n+  s.dependency 'FirebaseCore', '~> 11.0'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n+  s.dependency 'FirebaseFunctions', '~> 11.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n+  s.dependency 'FirebaseStorage', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'HEADER_SEARCH_PATHS' => '\"${PODS_TARGET_SRCROOT}\"',\n@@ -104,6 +104,6 @@ for internal testing only. It should not be published.\n     int_tests.resources = 'FirebaseStorage/Tests/Integration/Resources/1mb.dat',\n                           'FirebaseStorage/Tests/Integration/Resources/GoogleService-Info.plist',\n                           'FirebaseStorage/Tests/Integration/Resources/HomeImprovement.numbers'\n-    int_tests.dependency 'FirebaseAuth', '~> 10.0'\n+    int_tests.dependency 'FirebaseAuth', '~> 11.0'\n   end\n end\ndiff --git a/FirebaseCore.podspec b/FirebaseCore.podspec\nindex 9364d54bc8d..c740a159fa9 100644\n--- a/FirebaseCore.podspec\n+++ b/FirebaseCore.podspec\n@@ -18,10 +18,10 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -40,7 +40,7 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.public_header_files = 'FirebaseCore/Sources/Public/FirebaseCore/*.h'\n \ndiff --git a/FirebaseCore/CHANGELOG.md b/FirebaseCore/CHANGELOG.md\nindex 33f31986a49..be7014d50b1 100644\n--- a/FirebaseCore/CHANGELOG.md\n+++ b/FirebaseCore/CHANGELOG.md\n@@ -1,3 +1,14 @@\n+# Firebase 11.0.0\n+- [changed] **Breaking change**: Firebase's minimum supported versions have\n+  updated for the following platforms:\n+    - | Platform  | Firebase 11 |\n+      | ------------- | ------------- |\n+      | iOS  | **13.0**  |\n+      | tvOS  | **13.0**  |\n+      | macOS  | **10.15**  |\n+      | watchOS  | 7.0  |\n+  - FirebaseAnalytics and FirebaseCrashlytics also continue to support iOS 12.0.\n+\n # Firebase 10.25.0\n - [changed] Firebase now requires at least Xcode 15.2. See\n   https://developer.apple.com/news/?id=fxu2qp7b for more info.\ndiff --git a/FirebaseCoreExtension.podspec b/FirebaseCoreExtension.podspec\nindex 833ef4e5522..dfeecc3b2b4 100644\n--- a/FirebaseCoreExtension.podspec\n+++ b/FirebaseCoreExtension.podspec\n@@ -20,12 +20,12 @@ Pod::Spec.new do |s|\n     }\n     s.social_media_url = 'https://twitter.com/Firebase'\n \n-    s.swift_version = '5.3'\n+    s.swift_version = '5.9'\n \n-    s.ios.deployment_target = '10.0'\n-    s.osx.deployment_target = '10.13'\n-    s.tvos.deployment_target = '12.0'\n-    s.watchos.deployment_target = '6.0'\n+    s.ios.deployment_target = '12.0'\n+    s.osx.deployment_target = '10.15'\n+    s.tvos.deployment_target = '13.0'\n+    s.watchos.deployment_target = '7.0'\n \n     s.source_files = 'FirebaseCore/Extension/*.[hm]'\n     s.public_header_files = 'FirebaseCore/Extension/*.h'\ndiff --git a/FirebaseCoreInternal.podspec b/FirebaseCoreInternal.podspec\nindex a2dd33a0458..bd2ce688b2d 100644\n--- a/FirebaseCoreInternal.podspec\n+++ b/FirebaseCoreInternal.podspec\n@@ -18,10 +18,10 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -36,7 +36,7 @@ Pod::Spec.new do |s|\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Internal/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.dependency 'GoogleUtilities/NSData+zlib', '~> 8.0'\n \ndiff --git a/FirebaseCrashlytics.podspec b/FirebaseCrashlytics.podspec\nindex 365376a02ee..be080d77522 100644\n--- a/FirebaseCrashlytics.podspec\n+++ b/FirebaseCrashlytics.podspec\n@@ -11,12 +11,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabase.podspec b/FirebaseDatabase.podspec\nindex 71360409d13..6884a7a5539 100644\n--- a/FirebaseDatabase.podspec\n+++ b/FirebaseDatabase.podspec\n@@ -17,12 +17,12 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabaseSwift.podspec b/FirebaseDatabaseSwift.podspec\nindex 3e066ab7a0f..1701905ec67 100644\n--- a/FirebaseDatabaseSwift.podspec\n+++ b/FirebaseDatabaseSwift.podspec\n@@ -16,10 +16,10 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseDynamicLinks.podspec b/FirebaseDynamicLinks.podspec\nindex 08d3bcb940d..ad9606e0b76 100644\n--- a/FirebaseDynamicLinks.podspec\n+++ b/FirebaseDynamicLinks.podspec\n@@ -16,9 +16,9 @@ Firebase Dynamic Links are deep links that enhance user experience and increase\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestore.podspec b/FirebaseFirestore.podspec\nindex bd33677cd4a..8334d81e7e7 100644\n--- a/FirebaseFirestore.podspec\n+++ b/FirebaseFirestore.podspec\n@@ -13,11 +13,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.weak_framework = 'FirebaseFirestoreInternal'\n \ndiff --git a/FirebaseFirestoreInternal.podspec b/FirebaseFirestoreInternal.podspec\nindex bd3694dfda3..5e9288ad6c9 100644\n--- a/FirebaseFirestoreInternal.podspec\n+++ b/FirebaseFirestoreInternal.podspec\n@@ -16,11 +16,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestoreSwift.podspec b/FirebaseFirestoreSwift.podspec\nindex 4582f9f240f..511c8d1bff3 100644\n--- a/FirebaseFirestoreSwift.podspec\n+++ b/FirebaseFirestoreSwift.podspec\n@@ -21,10 +21,10 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseFirestoreTestingSupport.podspec b/FirebaseFirestoreTestingSupport.podspec\nindex c2c13ccb23e..a28ab450c3f 100644\n--- a/FirebaseFirestoreTestingSupport.podspec\n+++ b/FirebaseFirestoreTestingSupport.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -42,7 +42,7 @@ Pod::Spec.new do |s|\n \n   s.public_header_files = base_dir + '**/*.h'\n \n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'GCC_C_LANGUAGE_STANDARD' => 'c99',\ndiff --git a/FirebaseFunctions.podspec b/FirebaseFunctions.podspec\nindex 4383ae29317..2d069da346b 100644\n--- a/FirebaseFunctions.podspec\n+++ b/FirebaseFunctions.podspec\n@@ -16,12 +16,12 @@ Cloud Functions for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version    = '5.3'\n+  s.swift_version    = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -31,8 +31,6 @@ Cloud Functions for Firebase.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n-\n   s.source_files = [\n     'FirebaseFunctions/Sources/**/*.swift',\n   ]\ndiff --git a/FirebaseInAppMessaging.podspec b/FirebaseInAppMessaging.podspec\nindex 557b84d94ca..42eaf9ecb84 100644\n--- a/FirebaseInAppMessaging.podspec\n+++ b/FirebaseInAppMessaging.podspec\n@@ -17,10 +17,10 @@ See more product details at https://firebase.google.com/products/in-app-messagin\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\nindex ad7a95252aa..0e5b1ca8483 100644\n--- a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n+++ b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n@@ -160,15 +160,13 @@ - (void)viewDidLoad {\n   self.view.layer.shadowOpacity = 0.4;\n \n   // Calculate status bar height.\n-  CGFloat statusBarHeight = 0;\n-  if (@available(iOS 13.0, tvOS 13.0, *)) {\n-    UIStatusBarManager *manager =\n-        [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n-\n-    statusBarHeight = manager.statusBarFrame.size.height;\n-  } else {\n-    statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height;\n-  }\n+  // TODO(#13068) : Fix keyWindow deprecation.\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n+  UIStatusBarManager *manager =\n+      [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n+#pragma clang diagnostic pop\n+  CGFloat statusBarHeight = manager.statusBarFrame.size.height;\n \n   // Pin title label below status bar with cushion.\n   [[self.titleLabel.topAnchor constraintEqualToAnchor:self.view.topAnchor\ndiff --git a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\nindex ff1c70c111b..d7eac8d3b1e 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'FiamDisplaySwiftExample' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n end\n \ndiff --git a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\nindex 7597b44e9fc..50db2923845 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'InAppMessaging_Example_iOS' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n \n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n   pod 'FirebaseDynamicLinks',  :path => '../../../..'\ndiff --git a/FirebaseInstallations.podspec b/FirebaseInstallations.podspec\nindex 458e1654936..990dd505411 100644\n--- a/FirebaseInstallations.podspec\n+++ b/FirebaseInstallations.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader.podspec b/FirebaseMLModelDownloader.podspec\nindex 1118c479d1c..a45f5b93216 100644\n--- a/FirebaseMLModelDownloader.podspec\n+++ b/FirebaseMLModelDownloader.podspec\n@@ -16,12 +16,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader/Apps/Sample/Podfile b/FirebaseMLModelDownloader/Apps/Sample/Podfile\nindex 24d21a9d4de..cb632e9d85f 100644\n--- a/FirebaseMLModelDownloader/Apps/Sample/Podfile\n+++ b/FirebaseMLModelDownloader/Apps/Sample/Podfile\n@@ -1,4 +1,4 @@\n-platform :ios, '11.0'\n+platform :ios, '13.0'\n use_frameworks!\n \n source 'https://github.com/firebase/SpecsDev.git'\ndiff --git a/FirebaseMessaging.podspec b/FirebaseMessaging.podspec\nindex bbabbcdc201..0e056c8a17a 100644\n--- a/FirebaseMessaging.podspec\n+++ b/FirebaseMessaging.podspec\n@@ -20,12 +20,12 @@ device, and it is completely free.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMessagingInterop.podspec b/FirebaseMessagingInterop.podspec\nindex 31d03220e3c..3e7e1b6d8cb 100644\n--- a/FirebaseMessagingInterop.podspec\n+++ b/FirebaseMessagingInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseMessaging/Interop/*.[hm]'\n   s.public_header_files = 'FirebaseMessaging/Interop/*.h'\ndiff --git a/FirebasePerformance.podspec b/FirebasePerformance.podspec\nindex 9a0f48d3acf..6bcf58249df 100644\n--- a/FirebasePerformance.podspec\n+++ b/FirebasePerformance.podspec\n@@ -17,10 +17,10 @@ Firebase Performance library to measure performance of Mobile and Web Apps.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  tvos_deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.tvos.deployment_target = tvos_deployment_target\ndiff --git a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\nindex c5e04efc947..147b53c516a 100644\n--- a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n+++ b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n@@ -69,9 +69,12 @@ void InstrumentViewDidAppear(FPRUIViewControllerInstrument *instrument,\n \n     // This has to be called on the main thread and so it's done here instead of in\n     // FPRScreenTraceTracker.\n-    // TODO: Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n+    // TODO(#13067): Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n #if !defined(TARGET_OS_VISION) || !TARGET_OS_VISION\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     if ([((UIViewController *)_self).view isDescendantOfView:FPRSharedApplication().keyWindow]) {\n+#pragma clang diagnostic pop\n       [[FPRScreenTraceTracker sharedInstance] viewControllerDidAppear:_self];\n     }\n #endif\ndiff --git a/FirebaseRemoteConfig.podspec b/FirebaseRemoteConfig.podspec\nindex 6c81684decb..a69cdbed484 100644\n--- a/FirebaseRemoteConfig.podspec\n+++ b/FirebaseRemoteConfig.podspec\n@@ -18,12 +18,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseRemoteConfig/Tests/Sample/Podfile b/FirebaseRemoteConfig/Tests/Sample/Podfile\nindex bfff53e6fea..bdce061ec49 100644\n--- a/FirebaseRemoteConfig/Tests/Sample/Podfile\n+++ b/FirebaseRemoteConfig/Tests/Sample/Podfile\n@@ -1,5 +1,4 @@\n-# Uncomment the next line to define a global platform for your project\n-# platform :ios, '9.0'\n+platform :ios, '13.0'\n \n source 'https://github.com/firebase/SpecsDev.git'\n source 'https://github.com/firebase/SpecsStaging.git'\ndiff --git a/FirebaseRemoteConfigInterop.podspec b/FirebaseRemoteConfigInterop.podspec\nindex c9d9a9c30d8..6f9ea69cba2 100644\n--- a/FirebaseRemoteConfigInterop.podspec\n+++ b/FirebaseRemoteConfigInterop.podspec\n@@ -20,15 +20,17 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+\n+  # The ios deployment target must support Crashlytics.\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseRemoteConfig/Interop/*.swift'\n end\ndiff --git a/FirebaseRemoteConfigSwift.podspec b/FirebaseRemoteConfigSwift.podspec\nindex 3f0b3b3174e..7474d09616f 100644\n--- a/FirebaseRemoteConfigSwift.podspec\n+++ b/FirebaseRemoteConfigSwift.podspec\n@@ -19,12 +19,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSessions.podspec b/FirebaseSessions.podspec\nindex 6c282296e9a..8685d6c61af 100644\n--- a/FirebaseSessions.podspec\n+++ b/FirebaseSessions.podspec\n@@ -18,12 +18,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSharedSwift.podspec b/FirebaseSharedSwift.podspec\nindex 0b2ab17a71d..e0e8f4fec9c 100644\n--- a/FirebaseSharedSwift.podspec\n+++ b/FirebaseSharedSwift.podspec\n@@ -18,12 +18,12 @@ Firebase products. FirebaseSharedSwift is not supported for non-Firebase usage.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseStorage.podspec b/FirebaseStorage.podspec\nindex 5322597a81c..17729ae3d28 100644\n--- a/FirebaseStorage.podspec\n+++ b/FirebaseStorage.podspec\n@@ -27,7 +27,7 @@ Firebase Storage provides robust, secure file uploads and downloads from Firebas\n   s.tvos.deployment_target = tvos_deployment_target\n   s.watchos.deployment_target = watchos_deployment_target\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseVertexAI-Docs.not_podspec b/FirebaseVertexAI-Docs.not_podspec\nindex 7967cc616c4..4c447335f65 100644\n--- a/FirebaseVertexAI-Docs.not_podspec\n+++ b/FirebaseVertexAI-Docs.not_podspec\n@@ -34,7 +34,7 @@ Pod::Spec.new do |s|\n     'FirebaseVertexAI/Sources/**/*.swift',\n   ]\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.framework = 'Foundation'\n   s.ios.framework = 'UIKit'\ndiff --git a/Firestore/Example/GoogleBenchmark.podspec b/Firestore/Example/GoogleBenchmark.podspec\nindex ae7fc81cd98..c0024acced3 100644\n--- a/Firestore/Example/GoogleBenchmark.podspec\n+++ b/Firestore/Example/GoogleBenchmark.podspec\n@@ -33,9 +33,9 @@ Google's C++ benchmark framework.\n       :tag => 'v' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/GoogleTest.podspec b/Firestore/Example/GoogleTest.podspec\nindex 87788e99d8b..f7dd32cde06 100644\n--- a/Firestore/Example/GoogleTest.podspec\n+++ b/Firestore/Example/GoogleTest.podspec\n@@ -33,9 +33,9 @@ Google's C++ test framework.\n     :commit => 'bf66935e07825318ae519675d73d0f3e313b3ec6'\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/LibFuzzer.podspec b/Firestore/Example/LibFuzzer.podspec\nindex ea654f48fcc..c4b7b5f34a8 100644\n--- a/Firestore/Example/LibFuzzer.podspec\n+++ b/Firestore/Example/LibFuzzer.podspec\n@@ -28,9 +28,9 @@ Pod::Spec.new do |s|\n   s.license             = { :type => 'BSD-Like' }\n   s.authors             = 'LLVM Team'\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source              = {\n     :git => 'https://github.com/llvm/llvm-project.git'\ndiff --git a/Firestore/Example/Podfile b/Firestore/Example/Podfile\nindex 99bb2815390..c5417d9068d 100644\n--- a/Firestore/Example/Podfile\n+++ b/Firestore/Example/Podfile\n@@ -95,7 +95,7 @@ end\n \n if is_platform(:ios)\n   target 'Firestore_Example_iOS' do\n-    platform :ios, '11.0'\n+    platform :ios, '13.0'\n \n     configure_local_pods()\n \n@@ -120,7 +120,6 @@ if is_platform(:ios)\n     target 'Firestore_IntegrationTests_iOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -130,7 +129,7 @@ if is_platform(:ios)\n \n     target 'Firestore_FuzzTests_iOS' do\n       inherit! :search_paths\n-      platform :ios, '11.0'\n+      platform :ios, '13.0'\n \n       pod 'LibFuzzer', :podspec => 'LibFuzzer.podspec', :inhibit_warnings => true\n     end\n@@ -139,7 +138,7 @@ end\n \n if is_platform(:osx)\n   target 'Firestore_Example_macOS' do\n-    platform :osx, '10.13'\n+    platform :osx, '10.15'\n \n     configure_local_pods()\n \n@@ -158,7 +157,6 @@ if is_platform(:osx)\n     target 'Firestore_IntegrationTests_macOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -170,7 +168,7 @@ end\n \n if is_platform(:tvos)\n   target 'Firestore_Example_tvOS' do\n-    platform :tvos, '12.0'\n+    platform :tvos, '13.0'\n \n     configure_local_pods()\n \n@@ -189,7 +187,6 @@ if is_platform(:tvos)\n     target 'Firestore_IntegrationTests_tvOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\ndiff --git a/Firestore/Example/ProtobufCpp.podspec b/Firestore/Example/ProtobufCpp.podspec\nindex 956f9d3186c..7012de8d076 100644\n--- a/Firestore/Example/ProtobufCpp.podspec\n+++ b/Firestore/Example/ProtobufCpp.podspec\n@@ -29,9 +29,9 @@ Pod::Spec.new do |s|\n     :tag => \"v#{s.version}\"\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source_files = 'src/**/*.{h,cc,inc}',\n                    # utf8_range is needed too, to avoid build errors.\ndiff --git a/GoogleAppMeasurement.podspec b/GoogleAppMeasurement.podspec\nindex f893a310310..b69681f1520 100644\n--- a/GoogleAppMeasurement.podspec\n+++ b/GoogleAppMeasurement.podspec\n@@ -21,9 +21,9 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/GoogleAppMeasurementOnDeviceConversion.podspec b/GoogleAppMeasurementOnDeviceConversion.podspec\nindex a1810fb012c..0c816c4f9c4 100644\n--- a/GoogleAppMeasurementOnDeviceConversion.podspec\n+++ b/GoogleAppMeasurementOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n+    s.ios.deployment_target  = '12.0'\n \n     s.libraries  = 'c++'\n \ndiff --git a/IntegrationTesting/ClientApp/Podfile b/IntegrationTesting/ClientApp/Podfile\nindex e2abd6876dd..29810fab6ad 100644\n--- a/IntegrationTesting/ClientApp/Podfile\n+++ b/IntegrationTesting/ClientApp/Podfile\n@@ -3,7 +3,7 @@ source 'https://github.com/firebase/SpecsStaging.git'\n source 'https://cdn.cocoapods.org/'\n \n target 'ClientApp-CocoaPods' do\n-  platform :ios, '12.0'\n+  platform :ios, '13.0'\n \n   use_frameworks!\n \n@@ -24,7 +24,6 @@ target 'ClientApp-CocoaPods' do\n   pod 'FirebaseDatabaseSwift', :path => '../../'\n   pod 'FirebaseDynamicLinks', :path => '../../'\n   pod 'FirebaseFirestore', :path => '../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../'\n   pod 'FirebaseFunctions', :path => '../../'\n   pod 'FirebaseInAppMessaging', :path => '../../'\n   pod 'FirebaseMessaging', :path => '../../'\ndiff --git a/Package.swift b/Package.swift\nindex 3da098725da..87174d0fb70 100644\n--- a/Package.swift\n+++ b/Package.swift\n@@ -23,7 +23,7 @@ let firebaseVersion = \"11.0.0\"\n \n let package = Package(\n   name: \"Firebase\",\n-  platforms: [.iOS(.v12), .macCatalyst(.v13), .macOS(.v10_13), .tvOS(.v12), .watchOS(.v7)],\n+  platforms: [.iOS(.v12), .macCatalyst(.v15), .macOS(.v10_15), .tvOS(.v13), .watchOS(.v7)],\n   products: [\n     .library(\n       name: \"FirebaseAnalytics\",\n", "test_patch": "", "problem_statement": "Firebase 11 Minimum Supported version updates\n### Description\r\n\r\nIn order to address Xcode warnings for no longer supported build targets and increase the ability of Firebase to use modern Swift features, update most of Firebase to a minimum iOS version of 13 and comparable versions for other platforms.\r\n\r\nExceptions to consider:\r\n- Analytics and Crashlytics have historically needed to support older versions longer - proposing bumping to iOS 12, etc.\r\n- AppCheck may have a GoogleSignIn dependency in the future - proposing bumping to iOS 12, etc.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\n11.0\r\n\r\n### Xcode Version\r\n\r\n15.2+\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAll\r\n\r\n### Targeted Platforms\r\n\r\nAll\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "", "created_at": "2024-06-04 23:11:02", "merge_commit_sha": "7d7cbad7bda83297e51002577e7c5590b44accd7", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["messaging-cron-only", ".github/workflows/messaging.yml"], ["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/storage.yml"], ["spm (watchOS, macos-13)", ".github/workflows/abtesting.yml"], ["spm (iOS, macos-13)", ".github/workflows/auth.yml"], ["spm-unit (catalyst, macos-14)", ".github/workflows/functions.yml"], ["spm (catalyst, macos-13)", ".github/workflows/core.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/analytics.yml"], ["catalyst", ".github/workflows/auth.yml"], ["spm (macOS, macos-13)", ".github/workflows/storage.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, ios, macos-13)", ".github/workflows/firebase_app_check.yml"], ["sanitizers-mac (macos-14, tsan)", ".github/workflows/firestore.yml"], ["quickstart", ".github/workflows/database.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/performance.yml"], ["pod-lib-lint (FirebaseAuth.podspec, watchos, macos-14)", ".github/workflows/auth.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/core_internal.yml"], ["spm (macOS, macos-13)", ".github/workflows/shared-swift.yml"], ["quickstart", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-13)", ".github/workflows/storage.yml"], ["spm (macOS, macos-14)", ".github/workflows/installations.yml"], ["spm (iOS, macos-14)", ".github/workflows/core_internal.yml"], ["spm (watchOS, macos-13)", ".github/workflows/shared-swift.yml"], ["remoteconfig (iOS)", ".github/workflows/remoteconfig.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, tvos, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/installations.yml"], ["sample (build)", ".github/workflows/vertexai.yml"], ["quickstart", ".github/workflows/dynamiclinks.yml"], ["platforms (catalyst, macos-13)", ".github/workflows/spm.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["sample-build-test", ".github/workflows/remoteconfig.yml"], ["mlmodeldownloader-sample-build-test", ".github/workflows/mlmodeldownloader.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/performance.yml"], ["spm (watchOS, macos-13)", ".github/workflows/crashlytics.yml"], ["spm (macos-14, visionOS, Xcode_15.3, spm)", ".github/workflows/auth.yml"], ["spm (watchOS, macos-13)", ".github/workflows/sessions.yml"], ["spm-unit (macos-14, visionOS, Xcode_15.3)", ".github/workflows/functions.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/installations.yml"], ["swift-build-run (macos-14)", ".github/workflows/spm.yml"], ["spm (iOS, macos-13)", ".github/workflows/core_internal.yml"], ["messaging-integration-tests", ".github/workflows/messaging.yml"], ["spm (macos-14)", ".github/workflows/dynamiclinks.yml"], ["catalyst", ".github/workflows/core_internal.yml"], ["quickstart-ftl-cron-only", ".github/workflows/storage.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, macos --skip-tests, macos-13)", ".github/workflows/auth.yml"], ["spm (iOS, macos-14)", ".github/workflows/installations.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"], ["check-firestore-internal-public-headers", ".github/workflows/firestore.yml"], ["spm (catalyst, macos-14)", ".github/workflows/shared-swift.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/performance.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, ios, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"], ["spm (watchOS, macos-14)", ".github/workflows/installations.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/abtesting.yml"], ["spm (macOS, macos-14)", ".github/workflows/mlmodeldownloader.yml"], ["xcodebuild (iOS)", ".github/workflows/firestore.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos --skip-tests, macos-14)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (FirebaseAuth.podspec, watchos, macos-13)", ".github/workflows/auth.yml"], ["catalyst", ".github/workflows/installations.yml"], ["xcodebuild (tvOS)", ".github/workflows/firestore.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/core_extension.yml"], ["spm (macOS, macos-14)", ".github/workflows/core.yml"], ["auth-cron-only", ".github/workflows/auth.yml"], ["tests (iOS)", ".github/workflows/inappmessaging.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/mlmodeldownloader.yml"], ["spm (macos-13)", ".github/workflows/dynamiclinks.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, ios, macos-14)", ".github/workflows/auth.yml"], ["catalyst", ".github/workflows/appdistribution.yml"], ["remoteconfig-cron-only", ".github/workflows/remoteconfig.yml"], ["spm (tvOS, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/database.yml"], ["spm (iOS, macos-14)", ".github/workflows/mlmodeldownloader.yml"], ["platforms (tvOS, macos-14)", ".github/workflows/spm.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/functions.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/core.yml"], ["spm (macOS, macos-14)", ".github/workflows/storage.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/sessions.yml"], ["spm (macOS, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (macos --skip-tests, macos-13)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["spm-source (iOS, macos-13)", ".github/workflows/firestore.yml"], ["spm-source (tvOS, macos-13)", ".github/workflows/firestore.yml"], ["spm (iOS, macos-14)", ".github/workflows/core.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/abtesting.yml"], ["spm (macOS, macos-14)", ".github/workflows/shared-swift.yml"], ["client-app-spm-source-firestore (iOS, ClientApp-iOS13)", ".github/workflows/client_app.yml"], ["spm (tvOS, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/shared-swift.yml"], ["catalyst", ".github/workflows/mlmodeldownloader.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/abtesting.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/storage.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/database.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-13)", ".github/workflows/messaging.yml"], ["diff_report", ".github/workflows/api_diff_report.yml"], ["spm-unit (iOS, macos-13)", ".github/workflows/functions.yml"], ["pod-lib-lint-cron", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos, FirebaseRemoteConfig.podspec, macos-13)", ".github/workflows/remoteconfig.yml"], ["quickstart-ftl-cron-only", ".github/workflows/performance.yml"], ["spm (macOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/crashlytics.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/analytics.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/sessions.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm (iOS, macos-14)", ".github/workflows/storage.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/shared-swift.yml"], ["catalyst", ".github/workflows/core.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/abtesting.yml"], ["storage-integration-tests (ObjC)", ".github/workflows/storage.yml"], ["cmake (macos-14)", ".github/workflows/firestore.yml"], ["pod-lib-lint (ios, macos-14, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["spm-unit (iOS, macos-14)", ".github/workflows/functions.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/database.yml"], ["spm (catalyst, macos-13)", ".github/workflows/remoteconfig.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/functions.yml"], ["iOS-Device (macos-13)", ".github/workflows/spm.yml"], ["spm (catalyst, macos-14)", ".github/workflows/messaging.yml"], ["spm-integration (macos-14)", ".github/workflows/functions.yml"], ["spm (tvOS, macos-14)", ".github/workflows/database.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/crashlytics.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, macos --skip-tests, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/database.yml"], ["spm (watchOS, macos-14)", ".github/workflows/shared-swift.yml"], ["spm (iOS, macos-13)", ".github/workflows/storage.yml"], ["quickstart-ftl-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/sessions.yml"], ["pod-lib-lint (watchos --skip-tests, macos-13)", ".github/workflows/crashlytics.yml"], ["performance-cron-only", ".github/workflows/performance.yml"], ["spm (macOS, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/sessions.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/functions.yml"], ["spm (macOS, macos-13)", ".github/workflows/abtesting.yml"], ["platforms (macOS, macos-14)", ".github/workflows/spm.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/database.yml"], ["spm (tvOS, macos-13)", ".github/workflows/auth.yml"], ["pod-lib-lint (watchos --skip-tests, macos-13, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-14)", ".github/workflows/remoteconfig.yml"], ["spm (watchOS, macos-13)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/crashlytics.yml"], ["changes", ".github/workflows/firestore.yml"], ["performance (iOS, proddev)", ".github/workflows/performance.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/sessions.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (macos, macos-14)", ".github/workflows/shared-swift.yml"], ["integration", ".github/workflows/database.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["spm (catalyst, macos-13)", ".github/workflows/abtesting.yml"], ["spm-source (iOS, macos-14)", ".github/workflows/firestore.yml"], ["spm-unit (macOS, macos-14)", ".github/workflows/functions.yml"], ["crashlytics-cron-only", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/performance.yml"], ["spm (tvOS, macos-14)", ".github/workflows/auth.yml"], ["remoteconfig (macOS)", ".github/workflows/remoteconfig.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, watchos, macos-13)", ".github/workflows/auth.yml"], ["spm (macOS, macos-13)", ".github/workflows/database.yml"], ["pod_lib_lint (FirebaseAppCheck.podspec, watchos, macos-14)", ".github/workflows/firebase_app_check.yml"], ["spm (macOS, macos-13)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-14)", ".github/workflows/firebase_app_check.yml"], ["spm (watchOS, macos-13)", ".github/workflows/database.yml"], ["spm (macOS, macos-13)", ".github/workflows/sessions.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["spm (catalyst, macos-14)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/installations.yml"], ["spm (macOS, macos-14)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-13)", ".github/workflows/shared-swift.yml"], ["quickstart-ftl-cron-only", ".github/workflows/abtesting.yml"], ["spm (macOS, macos-13)", ".github/workflows/vertexai.yml"], ["spm (tvOS, macos-13)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (tvos, macos-14, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["spm (catalyst, macos-13)", ".github/workflows/crashlytics.yml"], ["spm-source (macos-14, visionOS, Xcode_15.3)", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos --skip-tests, macos-14)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-13)", ".github/workflows/sessions.yml"], ["core-cron-only", ".github/workflows/core.yml"], ["pod-lib-lint (FirebaseAuth.podspec, macos --skip-tests, macos-14)", ".github/workflows/auth.yml"], ["pod-lib-lint (ios, macos-13, --use-modular-headers)", ".github/workflows/crashlytics.yml"], ["database-cron-only", ".github/workflows/database.yml"], ["quickstart", ".github/workflows/auth.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/core_internal.yml"], ["spm (catalyst, macos-13)", ".github/workflows/vertexai.yml"], ["spm (macos-14, visionOS, Xcode_15.3)", ".github/workflows/messaging.yml"], ["spm (macOS, macos-14)", ".github/workflows/remoteconfig.yml"], ["spm (tvOS, macos-14)", ".github/workflows/core_internal.yml"], ["pod-lib-lint (watchos, macos-13)", ".github/workflows/core_internal.yml"], ["messaging-swiftui-sample-build-test", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-14)", ".github/workflows/database.yml"], ["danger", ".github/workflows/danger.yml"], ["spm (iOS, macos-14)", ".github/workflows/messaging.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["spm (tvOS, macos-13)", ".github/workflows/installations.yml"], ["pod-lib-lint (FirebaseAuth.podspec, macos --skip-tests, macos-13)", ".github/workflows/auth.yml"], ["dynamiclinks-cron-only", ".github/workflows/dynamiclinks.yml"], ["spm (watchOS, macos-13)", ".github/workflows/auth.yml"], ["spm (catalyst, macos-14)", ".github/workflows/crashlytics.yml"], ["spm (catalyst, macos-14)", ".github/workflows/sessions.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/core_extension.yml"], ["spm (watchOS, macos-14)", ".github/workflows/messaging.yml"], ["spm (iOS, macos-13)", ".github/workflows/installations.yml"], ["quickstart-ftl-cron-only", ".github/workflows/crashlytics.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-14)", ".github/workflows/messaging.yml"], ["spm (iOS)", ".github/workflows/performance.yml"], ["pod-lib-lint (tvos, macos-14)", ".github/workflows/core_internal.yml"], ["platforms (catalyst, macos-14)", ".github/workflows/spm.yml"], ["quickstart", ".github/workflows/inappmessaging.yml"], ["xcodebuild (macOS)", ".github/workflows/firestore.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/mlmodeldownloader.yml"], ["pod-lib-lint (tvos, macos-13)", ".github/workflows/installations.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/appdistribution.yml"], ["quickstart-ftl-cron-only", ".github/workflows/dynamiclinks.yml"], ["installation-test", ".github/workflows/firebasepod.yml"], ["appdistribution-cron-only", ".github/workflows/appdistribution.yml"], ["spm (iOS, macos-14)", ".github/workflows/remoteconfig.yml"], ["spm (macOS, macos-14)", ".github/workflows/firebase_app_check.yml"], ["spm (tvOS, macos-14)", ".github/workflows/installations.yml"], ["functions-cron-only", ".github/workflows/functions.yml"], ["platforms (tvOS, macos-13)", ".github/workflows/spm.yml"], ["spm (macOS, macos-14)", ".github/workflows/abtesting.yml"], ["pod_lib_lint (FirebaseAppCheckInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/firebase_app_check.yml"], ["pod-lib-lint (FirebaseAuthInterop.podspec, watchos, macos-14)", ".github/workflows/auth.yml"], ["pod-lib-lint (macos, macos-13)", ".github/workflows/mlmodeldownloader.yml"], ["spm (watchOS, macos-14)", ".github/workflows/remoteconfig.yml"], ["quickstart (swift, macos-14, Xcode_15.3)", ".github/workflows/storage.yml"], ["pod-lib-lint (ios, macos-14)", ".github/workflows/abtesting.yml"], ["pod-lib-lint (watchos, macos-14)", ".github/workflows/core.yml"], ["pod-lib-lint (FirebaseFirestoreInternal.podspec)", ".github/workflows/firestore.yml"], ["spm (tvOS)", ".github/workflows/performance.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (ios, macos-13)", ".github/workflows/core_extension.yml"], ["spm (catalyst, macos-14)", ".github/workflows/auth.yml"], ["pod_lib_lint (FirebaseInAppMessaging.podspec, macos-14)", ".github/workflows/inappmessaging.yml"], ["cmake-prod-db (macos-14, test-db)", ".github/workflows/firestore.yml"], ["spm (macOS, macos-13)", ".github/workflows/core_internal.yml"], ["client-app-cocoapods (ClientApp-CocoaPods-iOS13)", ".github/workflows/client_app.yml"], ["pod-lib-lint (macos --skip-tests, macos-14)", ".github/workflows/database.yml"], ["pod-lib-lint (FirebaseAuth.podspec, tvos, macos-14)", ".github/workflows/auth.yml"], ["spm (watchOS, macos-13)", ".github/workflows/core_internal.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13065", "base_commit": "594abb825043e6371f7336625d6ff5931b2a80b9", "patch": "diff --git a/FirebaseRemoteConfig/CHANGELOG.md b/FirebaseRemoteConfig/CHANGELOG.md\nindex 2a3024918c8..ff8a8a72050 100644\n--- a/FirebaseRemoteConfig/CHANGELOG.md\n+++ b/FirebaseRemoteConfig/CHANGELOG.md\n@@ -1,4 +1,7 @@\n-# 10.25.0\n+# 11.0.0\n+- [fixed] RemoteConfigValue stringValue is now `nonnull`. This may break some builds. (#10870)\n+\n+  # 10.25.0\n - [fixed] Fixed bug preventing Remote Config from working with a custom sqlite3\n   dependency (#10884).\n \ndiff --git a/FirebaseRemoteConfig/Sources/FIRConfigValue.m b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\nindex 8ab2d30d77a..e68d9c1312d 100644\n--- a/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n+++ b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n@@ -41,8 +41,8 @@ - (instancetype)init {\n }\n \n /// The string is a UTF-8 representation of NSData.\n-- (NSString *)stringValue {\n-  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding];\n+- (nonnull NSString *)stringValue {\n+  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding] ?: @\"\";\n }\n \n /// Number representation of a UTF-8 string.\ndiff --git a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\nindex 29cd12a5143..0a45617545f 100644\n--- a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n+++ b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n@@ -138,7 +138,7 @@ typedef void (^FIRRemoteConfigFetchAndActivateCompletion)(\n NS_SWIFT_NAME(RemoteConfigValue)\n @interface FIRRemoteConfigValue : NSObject <NSCopying>\n /// Gets the value as a string.\n-@property(nonatomic, readonly, nullable) NSString *stringValue;\n+@property(nonatomic, readonly, nonnull) NSString *stringValue;\n /// Gets the value as a number value.\n @property(nonatomic, readonly, nonnull) NSNumber *numberValue;\n /// Gets the value as a NSData object.\ndiff --git a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\nindex d0cea378995..f2d56542760 100644\n--- a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n+++ b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n@@ -35,7 +35,7 @@ struct FirebaseRemoteConfigValueDecoderHelper: FirebaseRemoteConfigValueDecoding\n   }\n \n   func stringValue() -> String {\n-    return value.stringValue ?? \"\"\n+    return value.stringValue\n   }\n \n   func dataValue() -> Data {\ndiff --git a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\nindex 7bf81c97a37..6665dd91258 100644\n--- a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n+++ b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n@@ -188,12 +188,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n@@ -204,13 +199,7 @@ class APITests: APITestBase {\n     let expectation2 = self.expectation(description: #function + \"2\")\n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.yoda)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n-\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.yoda)\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -239,13 +228,10 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.sith).stringValue {\n-        XCTAssertEqual(configValue, Constants.darthSidious)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.sith)\")\n-      }\n-\n+      XCTAssertEqual(\n+        self.config.configValue(forKey: Constants.sith).stringValue,\n+        Constants.darthSidious\n+      )\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -258,12 +244,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n", "test_patch": "", "problem_statement": "FIRRemoteConfigValue.stringValue is not nullable\n### Description\r\n\r\nFIRRemoteConfigValue.stringValue is marked `nullable` in the header file but will never return `null` as the implement.\r\nhttps://github.com/firebase/firebase-ios-sdk/blob/60f9a33e7084482df67b48e16f315f4f7a6f5da9/FirebaseRemoteConfig/Sources/FIRConfigValue.m#L43-L46\r\nIt would be thankful to implement it as `nullable`, before that marking it `nonnull` would be enough.\r\n\r\n### Firebase SDK Version\r\n\r\n9.6.0\r\n\r\n### Xcode Version\r\n\r\n14.1\r\n\r\n### Installation Method\r\n\r\nCocoaPods\r\n\r\n### Firebase Product(s)\r\n\r\nRemote Config\r\n\r\n### Targeted Platforms\r\n\r\niOS\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.\nHi @myihsan,\r\n\r\nThanks for opening an issue. Just so I understand the issue correctly, is the issue that the implementation's return type does not have the `nullable` attribute?\r\n\r\nSo something like the below diff would resolve things:\r\n```diff\r\n- - (NSString *)stringValue { \r\n+ - (nullable NSString *)stringValue { \r\n```\nHi @ncooke3,\r\n\r\nThanks for the confirmation.\r\nIf I understand the implementation correctly, adding the `nullable` attribute will not solve the issue since it's already `nullable` in the header file.\r\nhttps://github.com/firebase/firebase-ios-sdk/blob/60f9a33e7084482df67b48e16f315f4f7a6f5da9/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h#L110\r\n\r\n\r\nI expected it to be solved like the below:\r\n```objc\r\n- (NSString *)stringValue {\r\n  // if `_data` is nil or empty return nil.\r\n  if (!_data) {\r\n    return nil;\r\n  }\r\n  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding];\r\n}\r\n```\r\n\r\nBut it will affect `numberValue` and `boolValue`, so it may need some discussion before changing them to`nullable`.\r\n\r\nBefore that, marking `stringValue` `nonnull` would be enough for me.\r\n\r\n```diff\r\n- @property(nonatomic, readonly, nullable) NSString *stringValue;\r\n+ @property(nonatomic, readonly, nonnull) NSString *stringValue;\r\n```\nI think what is going on here is that Apple's documentation is misleading. Based on [this discussion section](https://developer.apple.com/documentation/foundation/nsstring/1416374-initwithdata#:~:text=Returns%20nil%20if%20the%20initialization%20fails%20for%20some%20reason%20(for%20example%20if%20data%20does%20not%20represent%20valid%20data%20for%20encoding).) and that [Swift equivalent returns `String?`](https://developer.apple.com/documentation/foundation/nsstring/1416374-init), I think `- [NSString initWithData:encoding:]` returns a nullable string, despite it's interface saying it doesn't. \n>  I think - [NSString initWithData:encoding:] returns a nullable string\r\n\r\nYou are right and [the return value section](https://developer.apple.com/documentation/foundation/nsstring/1416374-initwithdata#return_value) mentioned that.\r\n\r\n> Returns nil if the initialization fails for some reason (for example if data does not represent valid data for encoding).\r\n\r\nHowever, it will not return nil in the cases below:\r\n- `[[NSString alloc] initWithData:[[NSData alloc] init] encoding:NSUTF8StringEncoding]`\r\n- `[[NSString alloc] initWithData:nil encoding:NSUTF8StringEncoding]`\r\n\r\nYou can verify this behavior by:\r\n\r\n```objc\r\nNSLog(@\"%@\", [[NSString alloc] initWithData:[[NSData alloc] init] encoding:NSUTF8StringEncoding] == nil ? @\"True\" : @\"False\");\r\nNSLog(@\"%@\", [[NSString alloc] initWithData:nil encoding:NSUTF8StringEncoding] == nil ? @\"True\" : @\"False\");\r\n```\nThanks @myihsan, that's interesting. Sorry, so what exactly is the issue with the current behavior? Is it that you expected `- [FIRRemoteConfigValue stringValue]` to return `nil` when `_data` is `nil`?\nYes or no since I am unsure when `_data` became `nil`.\r\nI expected `- [FIRRemoteConfigValue stringValue]` to return `nil` when no related config is set.\r\n\r\nI want to distinguish the situations below:\r\n- nil (there is no related config set)\r\n- empty (there is a related config, but the value is empty)\n@ncooke3 \r\nI tried to solve this issue [here](https://github.com/firebase/firebase-ios-sdk/compare/master...myihsan:fix/FIRRemoteConfigValue-stringValue-nullable), but I realised that this will at least make dataValue `nullable` and this is an API change.\r\nShould I open another issue focusing on distinguishing the config is set as empty or not set at all.\nWhile we may progress earlier, I'll mark this as Firebase 11 to make sure we consider before our next breaking change release.", "created_at": "2024-06-04 22:04:01", "merge_commit_sha": "059b9211229c2e4c422bebb457f9421ae1a5c98a", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["watchos-sample-build-test", ".github/workflows/watchos-sample.yml"], ["pod-lib-lint (tvos, FirebaseRemoteConfig.podspec, macos-14)", ".github/workflows/remoteconfig.yml"], ["remoteconfig-cron-only", ".github/workflows/remoteconfig.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["spm (tvOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["sample-build-test", ".github/workflows/remoteconfig.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["spm (catalyst, macos-14)", ".github/workflows/remoteconfig.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["spm (watchOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["spm (macos-14, visionOS, Xcode_15.3, spm)", ".github/workflows/remoteconfig.yml"], ["spm (iOS, macos-13)", ".github/workflows/remoteconfig.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["changes", ".github/workflows/firestore.yml"], ["catalyst", ".github/workflows/remoteconfig.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos --skip-tests, FirebaseRemoteConfig.podspec, macos-13)", ".github/workflows/remoteconfig.yml"], ["spm (catalyst, macos-13)", ".github/workflows/remoteconfig.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13064", "base_commit": "8136158f103c1584e0e0bcf482926d5cac63ba65", "patch": "diff --git a/FirebaseMessaging/Sources/FIRMessaging.m b/FirebaseMessaging/Sources/FIRMessaging.m\nindex 9511d34a29e..9a688b034be 100644\n--- a/FirebaseMessaging/Sources/FIRMessaging.m\n+++ b/FirebaseMessaging/Sources/FIRMessaging.m\n@@ -437,9 +437,7 @@ - (void)handleIncomingLinkIfNeededFromMessage:(NSDictionary *)message {\n     // Similarly, |application:openURL:sourceApplication:annotation:| will also always be called,\n     // due to the default swizzling done by FIRAAppDelegateProxy in Firebase Analytics\n   } else if ([appDelegate respondsToSelector:openURLWithSourceApplicationSelector]) {\n-// TODO(Xcode 15): When Xcode 15 is the minimum supported Xcode version, it will be unnecessary to\n-// check if `TARGET_OS_VISION` is defined.\n-#if TARGET_OS_IOS && (!defined(TARGET_OS_VISION) || !TARGET_OS_VISION)\n+#if TARGET_OS_IOS\n #pragma clang diagnostic push\n #pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     [appDelegate application:application\ndiff --git a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\nindex 52c5ff0f82d..5cd5d8b16a2 100644\n--- a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n+++ b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n@@ -384,13 +384,6 @@ id FIRMessagingPropertyNameFromObject(id object, NSString *propertyName, Class k\n }\n \n #pragma mark - GULApplicationDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  [[FIRMessaging messaging] appDidReceiveMessage:userInfo];\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\nindex 6bf33f9b5d6..ea061e8a284 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n@@ -75,10 +75,12 @@ + (BOOL)supportsSecureCoding {\n }\n \n - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n-  id deviceToken = [aDecoder decodeObjectForKey:kFIRInstanceIDAPNSInfoTokenKey];\n-  if (![deviceToken isKindOfClass:[NSData class]]) {\n+  NSData *deviceToken = [aDecoder decodeObjectOfClass:[NSData class]\n+                                               forKey:kFIRInstanceIDAPNSInfoTokenKey];\n+  if (!deviceToken) {\n     return nil;\n   }\n+\n   BOOL isSandbox = [aDecoder decodeBoolForKey:kFIRInstanceIDAPNSInfoSandboxKey];\n   return [self initWithDeviceToken:(NSData *)deviceToken isSandbox:isSandbox];\n }\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\nindex 90420d1e72e..2852f0cad69 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n@@ -143,32 +143,29 @@ - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n   BOOL needsMigration = NO;\n   // These value cannot be nil\n \n-  id authorizedEntity = [aDecoder decodeObjectForKey:kFIRInstanceIDAuthorizedEntityKey];\n-  if (![authorizedEntity isKindOfClass:[NSString class]]) {\n+  NSString *authorizedEntity = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                      forKey:kFIRInstanceIDAuthorizedEntityKey];\n+  if (!authorizedEntity) {\n     return nil;\n   }\n \n-  id scope = [aDecoder decodeObjectForKey:kFIRInstanceIDScopeKey];\n-  if (![scope isKindOfClass:[NSString class]]) {\n+  NSString *scope = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDScopeKey];\n+  if (!scope) {\n     return nil;\n   }\n \n-  id token = [aDecoder decodeObjectForKey:kFIRInstanceIDTokenKey];\n-  if (![token isKindOfClass:[NSString class]]) {\n+  NSString *token = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDTokenKey];\n+  if (!token) {\n     return nil;\n   }\n \n-  // These values are nullable, so only fail the decode if the type does not match\n+  // These values are nullable, so don't fail on nil.\n \n-  id appVersion = [aDecoder decodeObjectForKey:kFIRInstanceIDAppVersionKey];\n-  if (appVersion && ![appVersion isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n+  NSString *appVersion = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                forKey:kFIRInstanceIDAppVersionKey];\n+  NSString *firebaseAppID = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                   forKey:kFIRInstanceIDFirebaseAppIDKey];\n \n-  id firebaseAppID = [aDecoder decodeObjectForKey:kFIRInstanceIDFirebaseAppIDKey];\n-  if (firebaseAppID && ![firebaseAppID isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n   NSSet *classes = [[NSSet alloc] initWithArray:@[ FIRMessagingAPNSInfo.class ]];\n   FIRMessagingAPNSInfo *rawAPNSInfo = [aDecoder decodeObjectOfClasses:classes\n                                                                forKey:kFIRInstanceIDAPNSInfoKey];\ndiff --git a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\nindex d3bbdc3ead3..16f7086f1d3 100644\n--- a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n+++ b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n@@ -64,19 +64,13 @@ @interface FakeAppDelegate : NSObject <GULApplicationDelegate>\n @property(nonatomic, strong) NSError *registerForRemoteNotificationsError;\n @end\n @implementation FakeAppDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  self.remoteNotificationMethodWasCalled = YES;\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\n     didReceiveRemoteNotification:(NSDictionary *)userInfo\n           fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler {\n   self.remoteNotificationWithFetchHandlerWasCalled = YES;\n+  completionHandler(UIBackgroundFetchResultNewData);\n }\n #endif\n \n@@ -192,6 +186,7 @@ - (void)testSwizzlingNonAppDelegate {\n #if !SWIFT_PACKAGE\n // The next 3 tests depend on a sharedApplication which is not available in the Swift PM test env.\n - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n+  XCTestExpectation *expectation = [self expectationWithDescription:@\"completion\"];\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n   [self.proxy swizzleMethodsIfPossible];\n@@ -199,15 +194,18 @@ - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n   NSDictionary *notification = @{@\"test\" : @\"\"};\n   OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n \n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n   [incompleteAppDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-        didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n+        didReceiveRemoteNotification:notification\n+              fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+                [expectation fulfill];\n+              }];\n \n   [self.mockMessaging verify];\n+  [self waitForExpectationsWithTimeout:0.5 handler:nil];\n }\n \n+// This test demonstrates the difference between Firebase 10 and 11. In 10 and earlier the\n+// swizzler inserts the old `didReceiveRemoteNotification` method. In 11, the new.\n - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n@@ -216,11 +214,11 @@ - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n #if TARGET_OS_IOS || TARGET_OS_TV\n   SEL remoteNotificationWithFetchHandler = @selector(application:\n                                     didReceiveRemoteNotification:fetchCompletionHandler:);\n-  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n+  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n #endif\n \n   SEL remoteNotification = @selector(application:didReceiveRemoteNotification:);\n-  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotification]);\n+  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotification]);\n }\n \n - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n@@ -230,21 +228,6 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   NSDictionary *notification = @{@\"test\" : @\"\"};\n \n-  // Test application:didReceiveRemoteNotification:\n-\n-  // Verify our swizzled method was called\n-  OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n-\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-  [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-      didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n-\n-  // Verify our original method was called\n-  XCTAssertTrue(appDelegate.remoteNotificationMethodWasCalled);\n-  [self.mockMessaging verify];\n-\n   // Test application:didReceiveRemoteNotification:fetchCompletionHandler:\n #if TARGET_OS_IOS || TARGET_OS_TV\n   // Verify our swizzled method was called\n@@ -252,7 +235,8 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n       didReceiveRemoteNotification:notification\n-            fetchCompletionHandler:^(UIBackgroundFetchResult result){\n+            fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+              XCTAssertEqual(result, UIBackgroundFetchResultNewData);\n             }];\n \n   // Verify our original method was called\n", "test_patch": "", "problem_statement": "Cleanup deprecated notification API usages in Firebase\n### Description\r\n\r\nFirebase has multiple usages of the deprecated ` (void)application:(UIApplication *)application\r\n\u00a0 \u00a0 didReceiveRemoteNotification:(NSDictionary *)userInfo\u00a0` API. \r\n\r\nIt's usages should be removed across Firebase and GoogleUtilities.\r\n\r\nIn addition, GoogleUtilities should stop conditionalizing the swizzling of the replacement API: https://github.com/google/GoogleUtilities/blame/main/GoogleUtilities/AppDelegateSwizzler/GULAppDelegateSwizzler.m#L520\r\n\r\nAuth part of this is done in #13003 \r\nGoogleUtilities in https://github.com/google/GoogleUtilities/pull/162\r\nFirebaseMessging and CocoaPods updates still need to be done.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\nAll\r\n\r\n### Xcode Version\r\n\r\n14.3\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAuthentication\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "", "created_at": "2024-06-04 21:10:26", "merge_commit_sha": "594abb825043e6371f7336625d6ff5931b2a80b9", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["messaging-cron-only", ".github/workflows/messaging.yml"], ["spm-source", ".github/workflows/firestore.yml"], ["messaging-swiftui-sample-build-test", ".github/workflows/messaging.yml"], ["danger", ".github/workflows/danger.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm (iOS, macos-14)", ".github/workflows/messaging.yml"], ["spm (tvOS, macos-14)", ".github/workflows/messaging.yml"], ["messaging-watchos-standalone-sample-build-test", ".github/workflows/messaging.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["spm (macOS, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, macos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm (watchOS, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-14)", ".github/workflows/messaging.yml"], ["spm (macOS, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-13)", ".github/workflows/messaging.yml"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-46733", "base_commit": "686ae476963ed138135bc5f2934addcd1cc1e4ac", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex ea1637c990309..45fafbdb52eb5 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -125,6 +125,7 @@ filenames = {\n     \"shell/browser/animation_util.h\",\n     \"shell/browser/animation_util_mac.mm\",\n     \"shell/browser/api/electron_api_app_mac.mm\",\n+    \"shell/browser/api/electron_api_base_window_mac.mm\",\n     \"shell/browser/api/electron_api_menu_mac.h\",\n     \"shell/browser/api/electron_api_menu_mac.mm\",\n     \"shell/browser/api/electron_api_native_theme_mac.mm\",\ndiff --git a/shell/browser/api/electron_api_base_window.cc b/shell/browser/api/electron_api_base_window.cc\nindex 848cc6cc2c9f8..a7983dd39c8bc 100644\n--- a/shell/browser/api/electron_api_base_window.cc\n+++ b/shell/browser/api/electron_api_base_window.cc\n@@ -70,6 +70,7 @@ namespace electron::api {\n \n namespace {\n \n+#if !BUILDFLAG(IS_MAC)\n // Converts binary data to Buffer.\n v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n@@ -78,6 +79,7 @@ v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n [[nodiscard]] constexpr std::array<int, 2U> ToArray(const gfx::Size size) {\n   return {size.width(), size.height()};\n@@ -778,6 +780,7 @@ std::string BaseWindow::GetMediaSourceId() const {\n   return window_->GetDesktopMediaID().ToString();\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   // TODO(MarshallOfSound): Replace once\n   // https://chromium-review.googlesource.com/c/chromium/src/+/1253094/ has\n@@ -785,6 +788,7 @@ v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   NativeWindowHandle handle = window_->GetNativeWindowHandle();\n   return ToBuffer(isolate(), &handle, sizeof(handle));\n }\n+#endif\n \n void BaseWindow::SetProgressBar(double progress, gin_helper::Arguments* args) {\n   gin_helper::Dictionary options;\ndiff --git a/shell/browser/api/electron_api_base_window_mac.mm b/shell/browser/api/electron_api_base_window_mac.mm\nnew file mode 100644\nindex 0000000000000..148ec216283f7\n--- /dev/null\n+++ b/shell/browser/api/electron_api_base_window_mac.mm\n@@ -0,0 +1,32 @@\n+// Copyright (c) 2025 Microsoft, Inc.\n+// Use of this source code is governed by the MIT license that can be\n+// found in the LICENSE file.\n+\n+#include \"shell/browser/api/electron_api_base_window.h\"\n+\n+#include \"electron/buildflags/buildflags.h\"\n+#include \"shell/browser/api/electron_api_view.h\"\n+#include \"shell/browser/native_window.h\"\n+#include \"shell/common/node_includes.h\"\n+\n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+namespace electron::api {\n+\n+v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n+  NSView* handle = window_->GetNativeWindowHandle().GetNativeNSView();\n+  return ToBuffer(isolate(), &handle, sizeof(handle));\n+}\n+\n+}  // namespace electron::api\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex 0779c4919b29a..bf5f6ec4b44b2 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -3743,15 +3743,17 @@ void WebContents::SetDevToolsWebContents(const WebContents* devtools) {\n     inspectable_web_contents_->SetDevToolsWebContents(devtools->web_contents());\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n   gfx::NativeView ptr = web_contents()->GetNativeView();\n-  auto buffer = node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr),\n-                                   sizeof(gfx::NativeView));\n+  auto buffer =\n+      node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr), sizeof(ptr));\n   if (buffer.IsEmpty())\n     return v8::Null(isolate);\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n v8::Local<v8::Value> WebContents::DevToolsWebContents(v8::Isolate* isolate) {\n   if (devtools_web_contents_.IsEmpty())\ndiff --git a/shell/browser/api/electron_api_web_contents_mac.mm b/shell/browser/api/electron_api_web_contents_mac.mm\nindex 52c4362839610..1358b3dde95da 100644\n--- a/shell/browser/api/electron_api_web_contents_mac.mm\n+++ b/shell/browser/api/electron_api_web_contents_mac.mm\n@@ -6,6 +6,7 @@\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n+#include \"shell/common/node_includes.h\"\n #include \"ui/base/cocoa/command_dispatcher.h\"\n #include \"ui/base/cocoa/nsmenu_additions.h\"\n #include \"ui/base/cocoa/nsmenuitem_additions.h\"\n@@ -92,4 +93,22 @@ - (void)redispatchKeyEvent:(NSEvent*)event;\n   return false;\n }\n \n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n+  NSView* handle = web_contents()->GetNativeView().GetNativeNSView();\n+  return ToBuffer(isolate, &handle, sizeof(handle));\n+}\n+\n }  // namespace electron::api\ndiff --git a/shell/browser/native_window.h b/shell/browser/native_window.h\nindex cc4d150ca72b1..831cf8947aa85 100644\n--- a/shell/browser/native_window.h\n+++ b/shell/browser/native_window.h\n@@ -58,9 +58,9 @@ class BrowserView;\n }\n \n #if BUILDFLAG(IS_MAC)\n-typedef gfx::NativeView NativeWindowHandle;\n+using NativeWindowHandle = gfx::NativeView;\n #else\n-typedef gfx::AcceleratedWidget NativeWindowHandle;\n+using NativeWindowHandle = gfx::AcceleratedWidget;\n #endif\n \n class NativeWindow : public base::SupportsUserData,\n", "test_patch": "", "problem_statement": "Regression: `win.getNativeWindowHandle()` is broken on macOS\n### Confirmation\n\n- [x] I am a [maintainer](https://github.com/orgs/electron/people) of the Electron project. (If not, please create a [different issue type](https://github.com/electron/electron/issues/new/).)\n\n### Description\n\n## Summary\n\nFor [about a month now](https://chromium-review.googlesource.com/c/chromium/src/+/6361987), `getNativeWindowHandle()` is no longer returning a `NSView*` on macOS.\n\nI found this bug today when [this new buffer safety PR](https://github.com/electron/electron/pull/46724) surfaced it. So I guess that PR is doing its job! \ud83d\ude06\n\nWe also have a [spec](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/spec/api-browser-window-spec.ts#L6281) that should detect this, but it seems to be [disabled in CI](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/.github/workflows/pipeline-segment-electron-test.yml#L195).\n\n## Storytime\n\n`BaseWindow::GetNativeWindowHandle()` works by doing a bytewise copy of NativeWindowHandle, which on macOS is a typedef for the Chromium type `gfx::NativeView`.\n\nIn the very early days of Electron, `gfx::NativeView` was, in fact, a `NSView*` and so the code worked as expected.\n\nThis changed in October 2018 with the [upstream change](https://chromium-review.googlesource.com/c/1270343) \"Make gfx::NativeView and gfx::NativeWindow not be NSView and NSWindow\".  Happily, the new type was a wrapper class whose only field was the `NSView` pointer, so a bytewise copy worked anyway. The code still worked as expected... by accident. \n\nThe type changed again [in March 2025](https://chromium-review.googlesource.com/c/chromium/src/+/6361987). It's now a subclass of [base::apple::WeakNSView](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#59) which [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#78) a `std::unique_ptr`. If that was a pointer to a NSView, in theory a bytewise copy would _still_ work as before due to the same lucky accident. Unfortunately, it's a pointer to [an opaque data type](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#13) that in turn [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#14) a NSView*. So instead of returning a `NSView*`, the bytewise copy is now returning a `NSView**`. \ud83d\ude35\n\n**BUT!** To add insult to injury, it's a little worse than that. Since the new wrapper class [also has another field](https://chromium-review.googlesource.com/c/chromium/src/+/6361987/10/ui/gfx/native_widget_types.h), we're also writing another `sizeof(uintptr_t)` bytes at the end of that `NSView**`. \n\n", "hints_text": "", "created_at": "2025-04-22 23:01:41", "merge_commit_sha": "c7b0bdab7e699aeeb58137a06e16d0432834e21a", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['Lint', '.github/workflows/build.yml']"], ["['test (linux, 1)', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['test (win, 1)', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-46648", "base_commit": "32fea719b393c2757c4737386564c910d49b529e", "patch": "diff --git a/shell/browser/native_window_mac.h b/shell/browser/native_window_mac.h\nindex 590ac6d8bb7cd..5420e14aecd7d 100644\n--- a/shell/browser/native_window_mac.h\n+++ b/shell/browser/native_window_mac.h\n@@ -225,6 +225,7 @@ class NativeWindowMac : public NativeWindow,\n   bool CanMaximize() const override;\n   std::unique_ptr<views::NonClientFrameView> CreateNonClientFrameView(\n       views::Widget* widget) override;\n+  void OnWidgetInitialized() override;\n \n   // ui::NativeThemeObserver:\n   void OnNativeThemeUpdated(ui::NativeTheme* observed_theme) override;\ndiff --git a/shell/browser/native_window_mac.mm b/shell/browser/native_window_mac.mm\nindex 8bb7d5b51fa43..a895f26446213 100644\n--- a/shell/browser/native_window_mac.mm\n+++ b/shell/browser/native_window_mac.mm\n@@ -1861,6 +1861,28 @@ int NonClientHitTest(const gfx::Point& point) override {\n   return std::nullopt;\n }\n \n+void NativeWindowMac::OnWidgetInitialized() {\n+  // |window_| is not yet assigned when this function is called, so we need to\n+  // get the window from the widget.\n+  NSWindow* window = widget()->GetNativeWindow().GetNativeNSWindow();\n+\n+  // In |NativeWidgetNSWindowBridge::InitCompositorView| in Chromium,\n+  // translucent windows are assigned a clear background color. This causes\n+  // undesirable side effects, such as a window with vibrancy losing its natural\n+  // system border highlight. We undo that behavior here.\n+  //\n+  // Ref:\n+  // https://source.chromium.org/chromium/chromium/src/+/main:components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm;l=1341-1342;drc=e7c8be576285195257b0813326b3bab154dc7e73\n+  if (!transparent()) {\n+    if ([[window backgroundColor] isEqual:NSColor.clearColor]) {\n+      [window setBackgroundColor:NSColor.windowBackgroundColor];\n+    }\n+    if (![window isOpaque]) {\n+      [window setOpaque:YES];\n+    }\n+  }\n+}\n+\n // static\n std::unique_ptr<NativeWindow> NativeWindow::Create(\n     const gin_helper::Dictionary& options,\n", "test_patch": "", "problem_statement": "Setting vibrancy removes window border style\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n35.1.4\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS 15.2\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n34.0.0\n\n### Expected Behavior\n\nIn previous version (34.0.0), when I had vibrancy set to `\"sidebar\"` and frame to `false`, window did look like this:\n\n(it has macOS style border frame)\n\n![Image](https://github.com/user-attachments/assets/755227cf-30dc-473d-a220-bca0535477bb)\n\n### Actual Behavior\n\nNow, with exactly the same settings, the window looks like this (vibrancy set to `\"sidebar\"` and frame to `false`):\n\nmacOS style border of the window disappears\n\n![Image](https://github.com/user-attachments/assets/4071ee03-cfd1-4ad4-830a-ac66ed654ae3)\n\nEven if I enable `frame` to `true` (which I dont want to do as it enables traffic lights), it doesnt help:\n\n![Image](https://github.com/user-attachments/assets/f1abc4fd-9968-45b2-b583-0fd4a444e453)\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\n_No response_\n", "hints_text": "<!-- blocked/need-repro -->\n\nHello @pie6k. Thanks for reporting this and helping to make Electron better!\n\nWould it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n\nStand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n\nNow adding the https://github.com/electron/electron/labels/blocked%2Fneed-repro label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\n@clavin tracked this to https://github.com/electron/electron/pull/46392 - could you take a look?\nThx for the ping. Tracked it down to [this line in Chromium](https://source.chromium.org/chromium/chromium/src/+/main:components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm;l=1321;drc=3b2367f544f1fbf07f2790c81b02546f73f47467) now getting triggered. Working on a fix.", "created_at": "2025-04-16 03:39:32", "merge_commit_sha": "51dbe69e456a5fb6166b990470eabb481d11d24e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['Lint', '.github/workflows/build.yml']"], ["['test (linux, 1)', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['test (win, 1)', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45981", "base_commit": "cd56b965442d254ff8801446303343f36ea8acef", "patch": "diff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex 53a24ac6f5943..c01e3c5fda2aa 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -2057,6 +2057,17 @@ void WebContents::DidFinishNavigation(\n       if (is_main_frame) {\n         Emit(\"did-navigate\", url, http_response_code, http_status_text);\n       }\n+\n+      content::NavigationEntry* entry = navigation_handle->GetNavigationEntry();\n+\n+      // This check is needed due to an issue in Chromium\n+      // Upstream is open to patching:\n+      // https://bugs.chromium.org/p/chromium/issues/detail?id=1178663\n+      // If a history entry has been made and the forward/back call has been\n+      // made, proceed with setting the new title\n+      if (entry &&\n+          (entry->GetTransitionType() & ui::PAGE_TRANSITION_FORWARD_BACK))\n+        WebContents::TitleWasSet(entry);\n     }\n     if (is_guest())\n       Emit(\"load-commit\", url, is_main_frame);\n@@ -2077,15 +2088,6 @@ void WebContents::DidFinishNavigation(\n            frame_process_id, frame_routing_id);\n     }\n   }\n-  content::NavigationEntry* entry = navigation_handle->GetNavigationEntry();\n-\n-  // This check is needed due to an issue in Chromium\n-  // Check the Chromium issue to keep updated:\n-  // https://bugs.chromium.org/p/chromium/issues/detail?id=1178663\n-  // If a history entry has been made and the forward/back call has been made,\n-  // proceed with setting the new title\n-  if (entry && (entry->GetTransitionType() & ui::PAGE_TRANSITION_FORWARD_BACK))\n-    WebContents::TitleWasSet(entry);\n }\n \n void WebContents::TitleWasSet(content::NavigationEntry* entry) {\ndiff --git a/spec/api-web-contents-spec.ts b/spec/api-web-contents-spec.ts\nindex aa2c7d5297453..3f529c118d2e3 100644\n--- a/spec/api-web-contents-spec.ts\n+++ b/spec/api-web-contents-spec.ts\n@@ -631,6 +631,17 @@ describe('webContents module', () => {\n         w.webContents.navigationHistory.goBack();\n         expect(w.webContents.navigationHistory.getActiveIndex()).to.equal(0);\n       });\n+\n+      it('should have the same window title if navigating back within the page', async () => {\n+        const title = 'Test';\n+        w.webContents.on('did-finish-load', () => {\n+          w.setTitle(title);\n+          w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html#next`);\n+        });\n+        await w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html`);\n+        w.webContents.navigationHistory.goBack();\n+        expect(w.getTitle()).to.equal(title);\n+      });\n     });\n \n     describe('navigationHistory.canGoForward and navigationHistory.goForward API', () => {\n@@ -653,6 +664,16 @@ describe('webContents module', () => {\n         w.webContents.navigationHistory.goForward();\n         expect(w.webContents.navigationHistory.getActiveIndex()).to.equal(1);\n       });\n+\n+      it('should have the same window title if navigating forward within the page', async () => {\n+        const title = 'Test';\n+        w.webContents.on('did-finish-load', () => {\n+          w.setTitle(title);\n+          w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html#next`);\n+        });\n+        await w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html`);\n+        expect(w.getTitle()).to.equal(title);\n+      });\n     });\n \n     describe('navigationHistory.canGoToOffset(index) and navigationHistory.goToOffset(index) API', () => {\ndiff --git a/spec/fixtures/pages/navigation-history-anchor-in-page.html b/spec/fixtures/pages/navigation-history-anchor-in-page.html\nnew file mode 100644\nindex 0000000000000..03406b81f2a39\n--- /dev/null\n+++ b/spec/fixtures/pages/navigation-history-anchor-in-page.html\n@@ -0,0 +1,5 @@\n+<html>\n+<body>\n+  <span id=\"next\">This is content.</span>\n+</body>\n+</html>\n", "test_patch": "", "problem_statement": "[Bug]: When `window.webContents.navigationHistory.goBack()` is called, the title set by the HTML's `<title>` tag will override the title set by `window.setTitle()`.\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.0.1\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11\t23H2\t22631.4169\tWindows Feature Experience Pack 1000.22700.1034.0\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\n```\nconst window = new BrowserWindow();\nwindow.setTitle('myTitle');\n// After a route change in my HTML file, execute:\nwindow.webContents.navigationHistory.goBack();\n// => The title of the window should not be overridden by the HTML's title when `goBack()` is called.\n```\n\n### Actual Behavior\n\n```\nconst window = new BrowserWindow();\nwindow.setTitle('myTitle');\n// After a route change in my HTML file, execute:\nwindow.webContents.navigationHistory.goBack();\n// => At this point, the title of the window is no longer 'myTitle', but the content of the title tag in the HTML file.\n```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nThe front-end uses Vue.js + Vue-Router\n", "hints_text": "<!-- blocked/need-repro -->\n\nHello @an78mK89fy. Thanks for reporting this and helping to make Electron better!\n\nWould it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n\nStand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n\nNow adding the https://github.com/electron/electron/labels/blocked%2Fneed-repro label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\nPlease provide a title for your issue.\n> Hello [@an78mK89fy](https://github.com/an78mK89fy). Thanks for reporting this and helping to make Electron better!\n> \n> Would it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n> \n> Stand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n> \n> Now adding the [ blocked/need-repro](https://github.com/electron/electron/labels/blocked%2Fneed-repro) Needs a test case to reproduce the bug label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\n\n\n\n> Hello [@an78mK89fy](https://github.com/an78mK89fy). Thanks for reporting this and helping to make Electron better!\n> \n> Would it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n> \n> Stand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n> \n> Now adding the [ blocked/need-repro](https://github.com/electron/electron/labels/blocked%2Fneed-repro) Needs a test case to reproduce the bug label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\n\nexample:\nhttps://github.com/an78mK89fy/electron-nhgoBackTitleBug.git\n\n@an78mK89fy this repro still includes Vite - we need a repro that demonstrates this is an issue with Electron, which is made more difficult when the app is rife with third-party dependencies.\n> [@an78mK89fy](https://github.com/an78mK89fy) this repro still includes Vite - we need a repro that demonstrates this is an issue with Electron, which is made more difficult when the app is rife with third-party dependencies.\n\nhttps://github.com/an78mK89fy/electron-nhgoBackTitleBug.git\nis update\nConfirmed on v33.0.1 using this Fiddle gist: https://gist.github.com/f356a50a0dad57d13f13a48919b05709", "created_at": "2025-03-11 20:04:29", "merge_commit_sha": "4812b4e6c249a6ff346d435fcc21d8e03bfe5073", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45712", "base_commit": "340fdaf511de6e60e42db280c32c1fdd108cf737", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex fec7148a7ec5a..cea4da74f5f7f 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -140,3 +140,4 @@ revert_code_health_clean_up_stale_macwebcontentsocclusion.patch\n ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\n feat_add_signals_when_embedder_cleanup_callbacks_run_for.patch\n feat_separate_content_settings_callback_for_sync_and_async_clipboard.patch\n+fix_win32_synchronous_spellcheck.patch\ndiff --git a/patches/chromium/fix_win32_synchronous_spellcheck.patch b/patches/chromium/fix_win32_synchronous_spellcheck.patch\nnew file mode 100644\nindex 0000000000000..355c8f8e9a6ae\n--- /dev/null\n+++ b/patches/chromium/fix_win32_synchronous_spellcheck.patch\n@@ -0,0 +1,29 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Keeley Hammond <khammond@slack-corp.com>\n+Date: Wed, 19 Feb 2025 11:18:44 -0800\n+Subject: fix: re-enable synchronous spellcheck on Windows\n+\n+This fix partially reverts 6109477: Code Health:\n+Clean up stale base::Feature \"WinRetrieveSuggestionsOnlyOnDemand\"\n+https://chromium-review.googlesource.com/c/chromium/src/+/6109477\n+by re-adding a synchronous call to FillSuggestionList.\n+\n+This patch can be removed when an asynchronous spellcheck API\n+option is added to Electron.\n+\n+diff --git a/components/spellcheck/browser/windows_spell_checker.cc b/components/spellcheck/browser/windows_spell_checker.cc\n+index f5a7411037758427eddc088b5426554b4a500d33..04b3edd4d8c58d38e260cc54beb0dab86368fc25 100644\n+--- a/components/spellcheck/browser/windows_spell_checker.cc\n++++ b/components/spellcheck/browser/windows_spell_checker.cc\n+@@ -239,6 +239,11 @@ std::vector<SpellCheckResult> BackgroundHelper::RequestTextCheckForAllLanguages(\n+             (action == CORRECTIVE_ACTION_GET_SUGGESTIONS ||\n+              action == CORRECTIVE_ACTION_REPLACE)) {\n+           std::vector<std::u16string> suggestions;\n++          // TODO (vertedinde): Perform the synchronous operation of retrieving\n++          // suggestions for all misspelled words while performing a text check.\n++          FillSuggestionList(it->first,\n++            text.substr(start_index, error_length),\n++            &suggestions);\n+           result_map[std::tuple<ULONG, ULONG>(start_index, error_length)]\n+               .push_back(suggestions);\n+         }\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex f6265505f8803..a18f580f92bba 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -194,14 +194,6 @@\n #include \"content/public/browser/plugin_service.h\"\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"chrome/browser/spellchecker/spellcheck_factory.h\"\n-#include \"chrome/browser/spellchecker/spellcheck_service.h\"\n-#include \"components/spellcheck/browser/spellcheck_platform.h\"\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#include \"components/spellcheck/common/spellcheck_features.h\"\n-#endif\n-\n #if !IS_MAS_BUILD()\n #include \"chrome/browser/hang_monitor/hang_crash_dump.h\"  // nogncheck\n #endif\n@@ -1521,44 +1513,11 @@ void WebContents::RendererResponsive(\n \n bool WebContents::HandleContextMenu(content::RenderFrameHost& render_frame_host,\n                                     const content::ContextMenuParams& params) {\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (!params.misspelled_word.empty() && spellcheck::UseBrowserSpellChecker()) {\n-    SpellcheckService* spellcheck_service =\n-        SpellcheckServiceFactory::GetForContext(\n-            render_frame_host.GetBrowserContext());\n-    if (spellcheck_service) {\n-      spellcheck_platform::GetPerLanguageSuggestions(\n-          spellcheck_service->platform_spell_checker(), params.misspelled_word,\n-          base::BindOnce(&WebContents::OnGetPlatformSuggestionsComplete,\n-                         GetWeakPtr(), std::ref(render_frame_host), params));\n-    }\n-  } else {\n-#endif\n-    Emit(\"context-menu\",\n-         std::make_tuple(params, &render_frame_host,\n-                         std::optional<std::vector<std::u16string>>{}));\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  }\n-#endif\n+  Emit(\"context-menu\", std::make_pair(params, &render_frame_host));\n \n   return true;\n }\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-void WebContents::OnGetPlatformSuggestionsComplete(\n-    content::RenderFrameHost& render_frame_host,\n-    const content::ContextMenuParams& params,\n-    const spellcheck::PerLanguageSuggestions&\n-        platform_per_language_suggestions) {\n-  std::vector<std::u16string> combined_suggestions;\n-  spellcheck::FillSuggestions(platform_per_language_suggestions,\n-                              &combined_suggestions);\n-  Emit(\"context-menu\",\n-       std::make_tuple(params, &render_frame_host,\n-                       std::make_optional(combined_suggestions)));\n-}\n-#endif\n-\n void WebContents::FindReply(content::WebContents* web_contents,\n                             int request_id,\n                             int number_of_matches,\ndiff --git a/shell/browser/api/electron_api_web_contents.h b/shell/browser/api/electron_api_web_contents.h\nindex 58a6de68d24e5..40a0502b66924 100644\n--- a/shell/browser/api/electron_api_web_contents.h\n+++ b/shell/browser/api/electron_api_web_contents.h\n@@ -57,10 +57,6 @@ class ScriptExecutor;\n }\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#endif\n-\n namespace blink {\n struct DeviceEmulationParams;\n // enum class PermissionType;\n@@ -761,14 +757,6 @@ class WebContents final : public ExclusiveAccessContext,\n   // Update the html fullscreen flag in both browser and renderer.\n   void UpdateHtmlApiFullscreen(bool fullscreen);\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  void OnGetPlatformSuggestionsComplete(\n-      content::RenderFrameHost& render_frame_host,\n-      const content::ContextMenuParams& params,\n-      const spellcheck::PerLanguageSuggestions&\n-          platform_per_language_suggestions);\n-#endif\n-\n   v8::Global<v8::Value> session_;\n   v8::Global<v8::Value> devtools_web_contents_;\n   v8::Global<v8::Value> debugger_;\ndiff --git a/shell/common/gin_converters/content_converter.cc b/shell/common/gin_converters/content_converter.cc\nindex 7e593c324a0dd..d5a257b8f24ac 100644\n--- a/shell/common/gin_converters/content_converter.cc\n+++ b/shell/common/gin_converters/content_converter.cc\n@@ -88,7 +88,8 @@ v8::Local<v8::Value> Converter<blink::mojom::MenuItem::Type>::ToV8(\n v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n     v8::Isolate* isolate,\n     const ContextMenuParamsWithRenderFrameHost& val) {\n-  auto [params, render_frame_host, optional_suggestions] = val;\n+  const auto& params = val.first;\n+  content::RenderFrameHost* render_frame_host = val.second;\n   auto dict = gin_helper::Dictionary::CreateEmpty(isolate);\n   dict.SetGetter(\"frame\", render_frame_host, v8::DontEnum);\n   dict.Set(\"x\", params.x);\n@@ -113,11 +114,7 @@ v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n   dict.Set(\"misspelledWord\", params.misspelled_word);\n   dict.Set(\"selectionRect\", params.selection_rect);\n #if BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (optional_suggestions) {\n-    dict.Set(\"dictionarySuggestions\", optional_suggestions.value());\n-  } else {\n-    dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n-  }\n+  dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n   dict.Set(\"spellcheckEnabled\", params.spellcheck_enabled);\n #else\n   dict.Set(\"spellcheckEnabled\", false);\ndiff --git a/shell/common/gin_converters/content_converter.h b/shell/common/gin_converters/content_converter.h\nindex 1e1f26012f874..2fa5f7f118df9 100644\n--- a/shell/common/gin_converters/content_converter.h\n+++ b/shell/common/gin_converters/content_converter.h\n@@ -26,9 +26,7 @@ struct NativeWebKeyboardEvent;\n }\n \n using ContextMenuParamsWithRenderFrameHost =\n-    std::tuple<content::ContextMenuParams,\n-               content::RenderFrameHost*,\n-               std::optional<std::vector<std::u16string>>>;\n+    std::pair<content::ContextMenuParams, content::RenderFrameHost*>;\n \n namespace gin {\n \n", "test_patch": "", "problem_statement": "Empty dictionarySuggestions on Windows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\nv35.0.0-nightly.20250113\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\nv35.0.0-nightly.20250109\n\n### Expected Behavior\n\nContext menu contains `dictionarySuggestions`\n\n### Actual Behavior\n\nContext menu contains `dictionarySuggestions` without any suggestions\n\n### Testcase Gist URL\n\nhttps://gist.github.com/samuelmaddock/e66dde2361de95f3c48f443a8abdd099\n\n### Additional Information\n\nRegressed by https://chromium-review.googlesource.com/c/chromium/src/+/6109477 in https://github.com/electron/electron/pull/45055\n\nRelated:\n* https://github.com/electron/electron/pull/29690\n* https://github.com/electron/electron/issues/29685\n", "hints_text": "", "created_at": "2025-02-19 19:25:01", "merge_commit_sha": "6248c2436a2fd4c503feeee7183fe0afc44df2c6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45527", "base_commit": "9199d5c610c399d612dd938c87e2a92de56ec68c", "patch": "diff --git a/docs/api/in-app-purchase.md b/docs/api/in-app-purchase.md\nindex 38078ecf29dd7..0fed7b8c2c1b6 100644\n--- a/docs/api/in-app-purchase.md\n+++ b/docs/api/in-app-purchase.md\n@@ -10,13 +10,13 @@ The `inAppPurchase` module emits the following events:\n \n ### Event: 'transactions-updated'\n \n-Emitted when one or more transactions have been updated.\n-\n Returns:\n \n * `event` Event\n * `transactions` Transaction[] - Array of [`Transaction`](structures/transaction.md) objects.\n \n+Emitted when one or more transactions have been updated.\n+\n ## Methods\n \n The `inAppPurchase` module has the following methods:\n", "test_patch": "", "problem_statement": "Invalid TypeScript type for event 'transactions-updated'\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.2.8\n\n### What operating system(s) are you using?\n\nOther (specify below)\n\n### Operating System Version\n\n...\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nExpected type:\n```ts\non(event: 'transactions-updated', listener: (event: Event, transactions: Transaction[]) => void): this;\n```\n\n### Actual Behavior\n\nActual type:\n```ts\non(event: 'transactions-updated', listener: () => void): this;\n```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nDocs: https://www.electronjs.org/docs/latest/api/in-app-purchase#event-transactions-updated\n", "hints_text": "", "created_at": "2025-02-07 20:49:31", "merge_commit_sha": "4085185e2dd56cd691ba3c8ece36f63c969563b0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['macos-gn-check', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['macos-x64', '.github/workflows/build.yml']", "['Validate PR Title', '.github/workflows/semantic.yml']"], ["['Lint', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['checkout-windows', '.github/workflows/build.yml']", "['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']"], ["['linux-arm', '.github/workflows/build.yml']", "['windows-x64', '.github/workflows/build.yml']"], ["['windows-gn-check', '.github/workflows/build.yml']", "['windows-arm64', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45238", "base_commit": "97fa059e1fd2afae683830ec1d5d6f0f20f6792c", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex 99c80b915a02d..9a950d0e1955c 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -159,12 +159,8 @@ filenames = {\n     \"shell/browser/osr/osr_web_contents_view_mac.mm\",\n     \"shell/browser/relauncher_mac.cc\",\n     \"shell/browser/ui/certificate_trust_mac.mm\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.h\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.mm\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.h\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.mm\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.h\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.mm\",\n     \"shell/browser/ui/cocoa/electron_native_widget_mac.h\",\n@@ -191,8 +187,6 @@ filenames = {\n     \"shell/browser/ui/cocoa/window_buttons_proxy.mm\",\n     \"shell/browser/ui/drag_util_mac.mm\",\n     \"shell/browser/ui/file_dialog_mac.mm\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.h\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.mm\",\n     \"shell/browser/ui/message_box_mac.mm\",\n     \"shell/browser/ui/tray_icon_cocoa.h\",\n     \"shell/browser/ui/tray_icon_cocoa.mm\",\n@@ -224,8 +218,6 @@ filenames = {\n     \"shell/browser/ui/views/electron_views_delegate.h\",\n     \"shell/browser/ui/views/frameless_view.cc\",\n     \"shell/browser/ui/views/frameless_view.h\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.cc\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.h\",\n     \"shell/browser/ui/views/menu_bar.cc\",\n     \"shell/browser/ui/views/menu_bar.h\",\n     \"shell/browser/ui/views/menu_delegate.cc\",\ndiff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex dc05787535848..939c67537716a 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -133,6 +133,8 @@ osr_shared_texture_remove_keyed_mutex_on_win_dxgi.patch\n feat_allow_usage_of_sccontentsharingpicker_on_supported_platforms.patch\n chore_partial_revert_of.patch\n fix_software_compositing_infinite_loop.patch\n+fix_add_method_which_disables_headless_mode_on_native_widget.patch\n+fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n refactor_unfilter_unresponsive_events.patch\n build_disable_thin_lto_mac.patch\n build_add_public_config_simdutf_config.patch\ndiff --git a/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\nnew file mode 100644\nindex 0000000000000..95d22359148d2\n--- /dev/null\n+++ b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\n@@ -0,0 +1,26 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Cezary Kulakowski <cezary@openfin.co>\n+Date: Mon, 22 Jul 2024 16:23:13 +0200\n+Subject: fix: add method which disables headless mode on native widget\n+\n+We need this method as we create window in headless mode and we\n+switch it back to normal mode only after inital paint is done in\n+order to get some events like WebContents.beginFrameSubscription.\n+If we don't set `is_headless_` to false then some child windows\n+e.g. autofill popups will be created in headless mode leading to\n+ui problems (like dissapearing popup during typing in html's\n+input list.\n+\n+diff --git a/ui/views/widget/widget.h b/ui/views/widget/widget.h\n+index 30d0ea6633cb0f7f9aab37951a38be9b0482a12a..734e91e6d50c8d3afd20b39167c6254e934e7c1e 100644\n+--- a/ui/views/widget/widget.h\n++++ b/ui/views/widget/widget.h\n+@@ -1144,6 +1144,8 @@ class VIEWS_EXPORT Widget : public internal::NativeWidgetDelegate,\n+   // True if widget was created in headless mode.\n+   bool is_headless() const { return is_headless_; }\n+ \n++  void DisableHeadlessMode() { is_headless_ = false; }\n++\n+   // True if the window size will follow the content preferred size.\n+   bool is_autosized() const { return is_autosized_; }\n+ \ndiff --git a/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\nnew file mode 100644\nindex 0000000000000..d7e0977944197\n--- /dev/null\n+++ b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: =?UTF-8?q?Micha=C5=82=20Pichli=C5=84ski?=\n+ <michal.pichlinski@openfin.co>\n+Date: Tue, 29 Oct 2024 21:16:29 +0100\n+Subject: fix: Put NSVisualEffectView before ViewsCompositorSuperview\n+\n+Upstreamed at https://chromium-review.googlesource.com/c/chromium/src/+/6030552\n+\n+Otherwise when using `vibrancy` in `BrowserWindow` NSVisualEffectView\n+will hide content displayed by the compositor.\n+\n+diff --git a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+index 07c3997e6565cf77362ee73959c4d21da4fefe96..3353a7847df90b58eec34ea4d6ff8fb19617f5cc 100644\n+--- a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n++++ b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+@@ -223,8 +223,19 @@ NSComparisonResult SubviewSorter(__kindof NSView* lhs,\n+                                  void* rank_as_void) {\n+   DCHECK_NE(lhs, rhs);\n+ \n+-  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]])\n++\n++  // Put NSVisualEffectView before ViewsCompositorSuperview otherwise when using\n++  // `vibrancy` in `BrowserWindow` NSVisualEffectView will hide content\n++  // displayed by the compositor.\n++  if ([lhs isKindOfClass:[NSVisualEffectView class]]) {\n+     return NSOrderedAscending;\n++  }\n++  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]]) {\n++    if ([rhs isKindOfClass:[NSVisualEffectView class]]) {\n++      return NSOrderedDescending;\n++    }\n++    return NSOrderedAscending;\n++  }\n+ \n+   const RankMap* rank = static_cast<const RankMap*>(rank_as_void);\n+   auto left_rank = rank->find(lhs);\ndiff --git a/shell/browser/api/electron_api_web_contents_view.cc b/shell/browser/api/electron_api_web_contents_view.cc\nindex 644ea373a7287..f76209fbdf5be 100644\n--- a/shell/browser/api/electron_api_web_contents_view.cc\n+++ b/shell/browser/api/electron_api_web_contents_view.cc\n@@ -27,29 +27,14 @@\n #include \"ui/views/view_class_properties.h\"\n #include \"ui/views/widget/widget.h\"\n \n-#if BUILDFLAG(IS_MAC)\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#endif\n-\n namespace electron::api {\n \n WebContentsView::WebContentsView(v8::Isolate* isolate,\n                                  gin::Handle<WebContents> web_contents)\n-#if BUILDFLAG(IS_MAC)\n-    : View(new DelayedNativeViewHost(web_contents->inspectable_web_contents()\n-                                         ->GetView()\n-                                         ->GetNativeView())),\n-#else\n-    : View(web_contents->inspectable_web_contents()->GetView()->GetView()),\n-#endif\n+    : View(web_contents->inspectable_web_contents()->GetView()),\n       web_contents_(isolate, web_contents.ToV8()),\n       api_web_contents_(web_contents.get()) {\n-#if !BUILDFLAG(IS_MAC)\n-  // On macOS the View is a newly-created |DelayedNativeViewHost| and it is our\n-  // responsibility to delete it. On other platforms the View is created and\n-  // managed by InspectableWebContents.\n   set_delete_view(false);\n-#endif\n   view()->SetProperty(\n       views::kFlexBehaviorKey,\n       views::FlexSpecification(views::MinimumFlexSizeRule::kScaleToMinimum,\ndiff --git a/shell/browser/native_window_mac.h b/shell/browser/native_window_mac.h\nindex d153dec7f87d5..c49cdc9635932 100644\n--- a/shell/browser/native_window_mac.h\n+++ b/shell/browser/native_window_mac.h\n@@ -169,9 +169,6 @@ class NativeWindowMac : public NativeWindow,\n   void NotifyWindowDidFailToEnterFullScreen();\n   void NotifyWindowWillLeaveFullScreen();\n \n-  // views::WidgetDelegate:\n-  views::View* GetContentsView() override;\n-\n   // Cleanup observers when window is getting closed. Note that the destructor\n   // can be called much later after window gets closed, so we should not do\n   // cleanup in destructor.\n@@ -223,6 +220,7 @@ class NativeWindowMac : public NativeWindow,\n \n  protected:\n   // views::WidgetDelegate:\n+  views::View* GetContentsView() override;\n   bool CanMaximize() const override;\n   std::unique_ptr<views::NonClientFrameView> CreateNonClientFrameView(\n       views::Widget* widget) override;\ndiff --git a/shell/browser/native_window_mac.mm b/shell/browser/native_window_mac.mm\nindex dc483ee3fd3aa..2acea04280688 100644\n--- a/shell/browser/native_window_mac.mm\n+++ b/shell/browser/native_window_mac.mm\n@@ -194,6 +194,8 @@ static bool FromV8(v8::Isolate* isolate,\n   params.bounds = bounds;\n   params.delegate = this;\n   params.type = views::Widget::InitParams::TYPE_WINDOW;\n+  // Allow painting before shown, to be later disabled in ElectronNSWindow.\n+  params.headless_mode = true;\n   params.native_widget =\n       new ElectronNativeWidgetMac(this, windowType, styleMask, widget());\n   widget()->Init(std::move(params));\n@@ -1674,6 +1676,7 @@ static bool FromV8(v8::Isolate* isolate,\n   DCHECK(!IsClosed());\n   ui::NativeTheme::GetInstanceForNativeUi()->RemoveObserver(this);\n   display::Screen::GetScreen()->RemoveObserver(this);\n+  [window_ cleanup];\n }\n \n class NativeAppWindowFrameViewMac : public views::NativeFrameViewMac {\ndiff --git a/shell/browser/native_window_views.cc b/shell/browser/native_window_views.cc\nindex 1f6c3957c45ec..d5118ec346a8f 100644\n--- a/shell/browser/native_window_views.cc\n+++ b/shell/browser/native_window_views.cc\n@@ -27,6 +27,7 @@\n #include \"content/public/browser/desktop_media_id.h\"\n #include \"content/public/common/color_parser.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/views/root_view.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n #include \"shell/browser/web_view_manager.h\"\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.h b/shell/browser/ui/cocoa/delayed_native_view_host.h\ndeleted file mode 100644\nindex e7020dba60715..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.h\n+++ /dev/null\n@@ -1,33 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-\n-#include \"ui/views/controls/native/native_view_host.h\"\n-\n-namespace electron {\n-\n-// Automatically attach the native view after the NativeViewHost is attached to\n-// a widget. (Attaching it directly would cause crash.)\n-class DelayedNativeViewHost : public views::NativeViewHost {\n- public:\n-  explicit DelayedNativeViewHost(gfx::NativeView native_view);\n-  ~DelayedNativeViewHost() override;\n-\n-  // disable copy\n-  DelayedNativeViewHost(const DelayedNativeViewHost&) = delete;\n-  DelayedNativeViewHost& operator=(const DelayedNativeViewHost&) = delete;\n-\n-  // views::View:\n-  void ViewHierarchyChanged(\n-      const views::ViewHierarchyChangedDetails& details) override;\n-\n- private:\n-  gfx::NativeView native_view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.mm b/shell/browser/ui/cocoa/delayed_native_view_host.mm\ndeleted file mode 100644\nindex 38b0796555e1f..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.mm\n+++ /dev/null\n@@ -1,23 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-\n-namespace electron {\n-\n-DelayedNativeViewHost::DelayedNativeViewHost(gfx::NativeView native_view)\n-    : native_view_(native_view) {}\n-\n-DelayedNativeViewHost::~DelayedNativeViewHost() = default;\n-\n-void DelayedNativeViewHost::ViewHierarchyChanged(\n-    const views::ViewHierarchyChangedDetails& details) {\n-  if (!details.is_add && native_view())\n-    Detach();\n-  NativeViewHost::ViewHierarchyChanged(details);\n-  if (details.is_add && GetWidget() && !native_view())\n-    Attach(native_view_);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\ndeleted file mode 100644\nindex 4286312573aab..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-\n-#import <AppKit/AppKit.h>\n-\n-#include \"base/apple/owned_objc.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-\n-namespace electron {\n-class InspectableWebContentsViewMac;\n-}\n-\n-using electron::InspectableWebContentsViewMac;\n-\n-@interface NSView (WebContentsView)\n-- (void)setMouseDownCanMoveWindow:(BOOL)can_move;\n-@end\n-\n-@interface ElectronInspectableWebContentsView : BaseView <NSWindowDelegate> {\n- @private\n-  raw_ptr<electron::InspectableWebContentsViewMac> inspectableWebContentsView_;\n-\n-  NSView* __strong fake_view_;\n-  NSWindow* __strong devtools_window_;\n-  BOOL devtools_visible_;\n-  BOOL devtools_docked_;\n-  BOOL devtools_is_first_responder_;\n-  BOOL attached_to_window_;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-}\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view;\n-- (void)notifyDevToolsFocused;\n-- (void)setCornerRadii:(CGFloat)cornerRadius;\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate;\n-- (BOOL)isDevToolsVisible;\n-- (BOOL)isDevToolsFocused;\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate;\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy;\n-- (void)setTitle:(NSString*)title;\n-- (NSString*)getTitle;\n-\n-@end\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\ndeleted file mode 100644\nindex d719fc164e476..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\n+++ /dev/null\n@@ -1,337 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-\n-#include \"content/public/browser/render_widget_host_view.h\"\n-#include \"shell/browser/api/electron_api_web_contents.h\"\n-#include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-#include \"ui/gfx/mac/scoped_cocoa_disable_screen_updates.h\"\n-\n-@implementation ElectronInspectableWebContentsView\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view {\n-  self = [super init];\n-  if (!self)\n-    return nil;\n-\n-  inspectableWebContentsView_ = view;\n-  devtools_visible_ = NO;\n-  devtools_docked_ = NO;\n-  devtools_is_first_responder_ = NO;\n-  attached_to_window_ = NO;\n-\n-  if (inspectableWebContentsView_->inspectable_web_contents()->is_guest()) {\n-    fake_view_ = [[NSView alloc] init];\n-    [fake_view_ setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:fake_view_];\n-  } else {\n-    auto* contents = inspectableWebContentsView_->inspectable_web_contents()\n-                         ->GetWebContents();\n-    auto* contentsView = contents->GetNativeView().GetNativeNSView();\n-    [contentsView setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:contentsView];\n-  }\n-\n-  // See https://code.google.com/p/chromium/issues/detail?id=348490.\n-  [self setWantsLayer:YES];\n-\n-  return self;\n-}\n-\n-- (void)dealloc {\n-  [[NSNotificationCenter defaultCenter] removeObserver:self];\n-}\n-\n-- (void)resizeSubviewsWithOldSize:(NSSize)oldBoundsSize {\n-  [self adjustSubviews];\n-}\n-\n-- (void)viewDidMoveToWindow {\n-  if (attached_to_window_ && !self.window) {\n-    attached_to_window_ = NO;\n-    [[NSNotificationCenter defaultCenter] removeObserver:self];\n-  } else if (!attached_to_window_ && self.window) {\n-    attached_to_window_ = YES;\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(viewDidBecomeFirstResponder:)\n-               name:kViewDidBecomeFirstResponder\n-             object:nil];\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(parentWindowBecameMain:)\n-               name:NSWindowDidBecomeMainNotification\n-             object:nil];\n-  }\n-}\n-\n-- (IBAction)showDevTools:(id)sender {\n-  inspectableWebContentsView_->inspectable_web_contents()->ShowDevTools(true);\n-}\n-\n-- (void)notifyDevToolsFocused {\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsFocused();\n-}\n-\n-- (void)setCornerRadii:(CGFloat)cornerRadius {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-  webContentsView.wantsLayer = YES;\n-  webContentsView.layer.cornerRadius = cornerRadius;\n-}\n-\n-- (void)notifyDevToolsResized {\n-  // When devtools is opened, resizing devtools would not trigger\n-  // UpdateDraggableRegions for WebContents, so we have to notify the window\n-  // to do an update of draggable regions.\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsResized();\n-}\n-\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate {\n-  if (visible == devtools_visible_)\n-    return;\n-\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto* devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  devtools_visible_ = visible;\n-  if (devtools_docked_) {\n-    if (visible) {\n-      // Place the devToolsView under contentsView, notice that we didn't set\n-      // sizes for them until the setContentsResizingStrategy message.\n-      [self addSubview:devToolsView positioned:NSWindowBelow relativeTo:nil];\n-      [self adjustSubviews];\n-\n-      // Focus on web view.\n-      devToolsWebContents->RestoreFocus();\n-    } else {\n-      gfx::ScopedCocoaDisableScreenUpdates disabler;\n-      [devToolsView removeFromSuperview];\n-      [self adjustSubviews];\n-      [self notifyDevToolsResized];\n-    }\n-  } else {\n-    if (visible) {\n-      if (activate) {\n-        [devtools_window_ makeKeyAndOrderFront:nil];\n-      } else {\n-        [devtools_window_ orderBack:nil];\n-      }\n-    } else {\n-      [devtools_window_ setDelegate:nil];\n-      [devtools_window_ close];\n-      devtools_window_ = nil;\n-    }\n-  }\n-}\n-\n-- (BOOL)isDevToolsVisible {\n-  return devtools_visible_;\n-}\n-\n-- (BOOL)isDevToolsFocused {\n-  if (devtools_docked_) {\n-    return [[self window] isKeyWindow] && devtools_is_first_responder_;\n-  } else {\n-    return [devtools_window_ isKeyWindow];\n-  }\n-}\n-\n-// TODO: remove NSWindowStyleMaskTexturedBackground.\n-// https://github.com/electron/electron/issues/43125\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate {\n-  // Revert to no-devtools state.\n-  [self setDevToolsVisible:NO activate:NO];\n-\n-  // Switch to new state.\n-  devtools_docked_ = docked;\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-  if (!docked) {\n-    auto styleMask = NSWindowStyleMaskTitled | NSWindowStyleMaskClosable |\n-                     NSWindowStyleMaskMiniaturizable |\n-                     NSWindowStyleMaskResizable |\n-                     NSWindowStyleMaskTexturedBackground |\n-                     NSWindowStyleMaskUnifiedTitleAndToolbar;\n-    devtools_window_ = [[EventDispatchingWindow alloc]\n-        initWithContentRect:NSMakeRect(0, 0, 800, 600)\n-                  styleMask:styleMask\n-                    backing:NSBackingStoreBuffered\n-                      defer:YES];\n-    [devtools_window_ setDelegate:self];\n-    [devtools_window_ setFrameAutosaveName:@\"electron.devtools\"];\n-    [devtools_window_ setTitle:@\"Developer Tools\"];\n-    [devtools_window_ setReleasedWhenClosed:NO];\n-    [devtools_window_ setAutorecalculatesContentBorderThickness:NO\n-                                                        forEdge:NSMaxYEdge];\n-    [devtools_window_ setContentBorderThickness:24 forEdge:NSMaxYEdge];\n-\n-    NSView* contentView = [devtools_window_ contentView];\n-    devToolsView.frame = contentView.bounds;\n-    devToolsView.autoresizingMask = NSViewWidthSizable | NSViewHeightSizable;\n-\n-    [contentView addSubview:devToolsView];\n-    [devToolsView setMouseDownCanMoveWindow:NO];\n-  } else {\n-    [devToolsView setMouseDownCanMoveWindow:YES];\n-  }\n-  [self setDevToolsVisible:YES activate:activate];\n-}\n-\n-// -Wdeprecated-declarations\n-#pragma clang diagnostic pop\n-\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy {\n-  strategy_.CopyFrom(strategy);\n-  [self adjustSubviews];\n-}\n-\n-- (void)adjustSubviews {\n-  if (![[self subviews] count])\n-    return;\n-\n-  if (![self isDevToolsVisible] || devtools_window_) {\n-    DCHECK_EQ(1u, [[self subviews] count]);\n-    NSView* contents = [[self subviews] objectAtIndex:0];\n-    [contents setFrame:[self bounds]];\n-    return;\n-  }\n-\n-  NSView* devToolsView = [[self subviews] objectAtIndex:0];\n-  NSView* contentsView = [[self subviews] objectAtIndex:1];\n-\n-  DCHECK_EQ(2u, [[self subviews] count]);\n-\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, gfx::Size(NSSizeToCGSize([self bounds].size)),\n-      &new_devtools_bounds, &new_contents_bounds);\n-  [devToolsView setFrame:[self flipRectToNSRect:new_devtools_bounds]];\n-  [contentsView setFrame:[self flipRectToNSRect:new_contents_bounds]];\n-\n-  // Move mask to the devtools area to exclude it from dragging.\n-  NSRect cf = contentsView.frame;\n-  NSRect sb = [self bounds];\n-  NSRect devtools_frame;\n-  if (cf.size.height < sb.size.height) {  // bottom docked\n-    devtools_frame.origin.x = 0;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width;\n-    devtools_frame.size.height = sb.size.height - cf.size.height;\n-  } else {                // left or right docked\n-    if (cf.origin.x > 0)  // left docked\n-      devtools_frame.origin.x = 0;\n-    else  // right docked.\n-      devtools_frame.origin.x = cf.size.width;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width - cf.size.width;\n-    devtools_frame.size.height = sb.size.height;\n-  }\n-\n-  [self notifyDevToolsResized];\n-}\n-\n-- (void)setTitle:(NSString*)title {\n-  [devtools_window_ setTitle:title];\n-}\n-\n-- (NSString*)getTitle {\n-  return [devtools_window_ title];\n-}\n-\n-- (void)viewDidBecomeFirstResponder:(NSNotification*)notification {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-\n-  NSView* view = [notification object];\n-  if ([[webContentsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = NO;\n-    return;\n-  }\n-\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  if (!devToolsWebContents)\n-    return;\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  if ([[devToolsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = YES;\n-    [self notifyDevToolsFocused];\n-  }\n-}\n-\n-- (void)parentWindowBecameMain:(NSNotification*)notification {\n-  NSWindow* parentWindow = [notification object];\n-  if ([self window] == parentWindow && devtools_docked_ &&\n-      devtools_is_first_responder_)\n-    [self notifyDevToolsFocused];\n-}\n-\n-#pragma mark - NSWindowDelegate\n-\n-- (void)windowWillClose:(NSNotification*)notification {\n-  inspectableWebContentsView_->inspectable_web_contents()->CloseDevTools();\n-}\n-\n-- (void)windowDidBecomeMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->RestoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(true);\n-\n-  [self notifyDevToolsFocused];\n-}\n-\n-- (void)windowDidResignMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->StoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(false);\n-}\n-\n-@end\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.h b/shell/browser/ui/cocoa/electron_ns_window.h\nindex 502592313c15d..63ea5355467d4 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.h\n+++ b/shell/browser/ui/cocoa/electron_ns_window.h\n@@ -29,6 +29,8 @@ class ScopedDisableResize {\n \n }  // namespace electron\n \n+class ElectronNativeWindowObserver;\n+\n @interface ElectronNSWindow : NativeWidgetMacNSWindow {\n  @private\n   raw_ptr<electron::NativeWindowMac> shell_;\n@@ -41,6 +43,7 @@ class ScopedDisableResize {\n @property(nonatomic, retain) NSImage* cornerMask;\n - (id)initWithShell:(electron::NativeWindowMac*)shell\n           styleMask:(NSUInteger)styleMask;\n+- (void)cleanup;\n - (electron::NativeWindowMac*)shell;\n - (id)accessibilityFocusedUIElement;\n - (NSRect)originalContentRectForFrameRect:(NSRect)frameRect;\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.mm b/shell/browser/ui/cocoa/electron_ns_window.mm\nindex 5c5f1512f4a3e..30780277d3a5c 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window.mm\n@@ -8,8 +8,6 @@\n #include \"electron/mas.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/native_window_mac.h\"\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/cocoa/electron_preview_item.h\"\n #include \"shell/browser/ui/cocoa/electron_touch_bar.h\"\n #include \"shell/browser/ui/cocoa/root_view_mac.h\"\n@@ -113,6 +111,7 @@ void SwizzleSwipeWithEvent(NSView* view, SEL swiz_selector) {\n                            method_getImplementation(new_swipe_with_event));\n }\n #endif\n+\n }  // namespace\n \n @implementation ElectronNSWindow\n@@ -168,6 +167,10 @@ - (id)initWithShell:(electron::NativeWindowMac*)shell\n   return self;\n }\n \n+- (void)cleanup {\n+  shell_ = nullptr;\n+}\n+\n - (electron::NativeWindowMac*)shell {\n   return shell_;\n }\n@@ -255,6 +258,17 @@ - (void)setFrame:(NSRect)windowFrame display:(BOOL)displayViews {\n     [super setFrame:windowFrame display:displayViews];\n }\n \n+- (void)orderWindow:(NSWindowOrderingMode)place relativeTo:(NSInteger)otherWin {\n+  if (shell_) {\n+    // We initialize the window in headless mode to allow painting before it is\n+    // shown, but we don't want the headless behavior of allowing the window to\n+    // be placed unconstrained.\n+    self.isHeadless = false;\n+    shell_->widget()->DisableHeadlessMode();\n+  }\n+  [super orderWindow:place relativeTo:otherWin];\n+}\n+\n - (id)accessibilityAttributeValue:(NSString*)attribute {\n   if ([attribute isEqual:NSAccessibilityEnabledAttribute])\n     return [NSNumber numberWithBool:YES];\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\nindex d6af0ac6d9bb8..3f7c689bfc8b0 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n@@ -365,6 +365,19 @@ - (void)windowWillClose:(NSNotification*)notification {\n       shell_->GetNativeWindow());\n   auto* bridged_view = bridge_host->GetInProcessNSWindowBridge();\n   bridged_view->OnWindowWillClose();\n+\n+  // Native widget and its compositor have been destroyed upon close. We need\n+  // to detach contents view in order to prevent reusing its layer without\n+  // compositor in the `WebContentsViewMac::CreateViewForWidget`, leading to\n+  // `DCHECK` failure in `BrowserCompositorMac::SetParentUiLayer`.\n+  auto* contents_view =\n+      static_cast<views::WidgetDelegate*>(shell_)->GetContentsView();\n+  if (contents_view) {\n+    auto* parent = contents_view->parent();\n+    if (parent) {\n+      parent->RemoveChildView(contents_view);\n+    }\n+  }\n }\n \n - (BOOL)windowShouldClose:(id)window {\ndiff --git a/shell/browser/ui/inspectable_web_contents.cc b/shell/browser/ui/inspectable_web_contents.cc\nindex ea02168ef5596..75ebdd6441429 100644\n--- a/shell/browser/ui/inspectable_web_contents.cc\n+++ b/shell/browser/ui/inspectable_web_contents.cc\n@@ -297,11 +297,6 @@ class InspectableWebContents::NetworkResourceLoader\n   base::TimeDelta retry_delay_;\n };\n \n-// Implemented separately on each platform.\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents);\n-\n-// static\n // static\n void InspectableWebContents::RegisterPrefs(PrefRegistrySimple* registry) {\n   registry->RegisterDictionaryPref(kDevToolsBoundsPref,\n@@ -317,7 +312,7 @@ InspectableWebContents::InspectableWebContents(\n     : pref_service_(pref_service),\n       web_contents_(std::move(web_contents)),\n       is_guest_(is_guest),\n-      view_(CreateInspectableContentsView(this)) {\n+      view_(new InspectableWebContentsView(this)) {\n   const base::Value* bounds_dict =\n       &pref_service_->GetValue(kDevToolsBoundsPref);\n   if (bounds_dict->is_dict()) {\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.cc b/shell/browser/ui/inspectable_web_contents_view.cc\nindex 946b5071bcc87..e61f008414df4 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.cc\n+++ b/shell/browser/ui/inspectable_web_contents_view.cc\n@@ -5,12 +5,250 @@\n \n #include \"shell/browser/ui/inspectable_web_contents_view.h\"\n \n+#include <memory>\n+#include <utility>\n+\n+#include \"base/memory/raw_ptr.h\"\n+#include \"base/strings/utf_string_conversions.h\"\n+#include \"shell/browser/ui/drag_util.h\"\n+#include \"shell/browser/ui/inspectable_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n+#include \"ui/base/models/image_model.h\"\n+#include \"ui/views/controls/label.h\"\n+#include \"ui/views/controls/webview/webview.h\"\n+#include \"ui/views/widget/widget.h\"\n+#include \"ui/views/widget/widget_delegate.h\"\n+#include \"ui/views/window/client_view.h\"\n+\n namespace electron {\n \n+namespace {\n+\n+class DevToolsWindowDelegate : public views::ClientView,\n+                               public views::WidgetDelegate {\n+ public:\n+  DevToolsWindowDelegate(InspectableWebContentsView* shell,\n+                         views::View* view,\n+                         views::Widget* widget)\n+      : views::ClientView(widget, view),\n+        shell_(shell),\n+        view_(view),\n+        widget_(widget) {\n+    SetOwnedByWidget(true);\n+    set_owned_by_client();\n+\n+    if (shell->GetDelegate())\n+      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n+  }\n+  ~DevToolsWindowDelegate() override = default;\n+\n+  // disable copy\n+  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n+  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n+\n+  // views::WidgetDelegate:\n+  views::View* GetInitiallyFocusedView() override { return view_; }\n+  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n+  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n+  ui::ImageModel GetWindowIcon() override { return icon_; }\n+  views::Widget* GetWidget() override { return widget_; }\n+  const views::Widget* GetWidget() const override { return widget_; }\n+  views::View* GetContentsView() override { return view_; }\n+  views::ClientView* CreateClientView(views::Widget* widget) override {\n+    return this;\n+  }\n+\n+  // views::ClientView:\n+  views::CloseRequestResult OnWindowCloseRequested() override {\n+    shell_->inspectable_web_contents()->CloseDevTools();\n+    return views::CloseRequestResult::kCannotClose;\n+  }\n+\n+ private:\n+  raw_ptr<InspectableWebContentsView> shell_;\n+  raw_ptr<views::View> view_;\n+  raw_ptr<views::Widget> widget_;\n+  ui::ImageModel icon_;\n+};\n+\n+}  // namespace\n+\n InspectableWebContentsView::InspectableWebContentsView(\n     InspectableWebContents* inspectable_web_contents)\n-    : inspectable_web_contents_(inspectable_web_contents) {}\n+    : inspectable_web_contents_(inspectable_web_contents),\n+      devtools_web_view_(new views::WebView(nullptr)),\n+      title_(u\"Developer Tools\") {\n+  if (!inspectable_web_contents_->is_guest() &&\n+      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n+    auto* contents_web_view = new views::WebView(nullptr);\n+    contents_web_view->SetWebContents(\n+        inspectable_web_contents_->GetWebContents());\n+    contents_web_view_ = contents_web_view;\n+  } else {\n+    no_contents_view_ = new views::Label(u\"No content under offscreen mode\");\n+  }\n+\n+  devtools_web_view_->SetVisible(false);\n+  AddChildView(devtools_web_view_.get());\n+  AddChildView(GetContentsView());\n+}\n+\n+InspectableWebContentsView::~InspectableWebContentsView() {\n+  if (devtools_window_)\n+    inspectable_web_contents()->SaveDevToolsBounds(\n+        devtools_window_->GetWindowBoundsInScreen());\n+}\n+\n+void InspectableWebContentsView::SetCornerRadii(\n+    const gfx::RoundedCornersF& corner_radii) {\n+  // WebView won't exist for offscreen rendering.\n+  if (contents_web_view_) {\n+    contents_web_view_->holder()->SetCornerRadii(corner_radii);\n+  }\n+}\n+\n+void InspectableWebContentsView::ShowDevTools(bool activate) {\n+  if (devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = true;\n+  if (devtools_window_) {\n+    devtools_window_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n+    if (activate) {\n+      devtools_window_->Show();\n+    } else {\n+      devtools_window_->ShowInactive();\n+    }\n+\n+    // Update draggable regions to account for the new dock position.\n+    if (GetDelegate())\n+      GetDelegate()->DevToolsResized();\n+  } else {\n+    devtools_web_view_->SetVisible(true);\n+    devtools_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_web_view_->RequestFocus();\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+void InspectableWebContentsView::CloseDevTools() {\n+  if (!devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = false;\n+  if (devtools_window_) {\n+    auto save_bounds = devtools_window_->IsMinimized()\n+                           ? devtools_window_->GetRestoredBounds()\n+                           : devtools_window_->GetWindowBoundsInScreen();\n+    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n+\n+    devtools_window_.reset();\n+    devtools_window_web_view_ = nullptr;\n+    devtools_window_delegate_ = nullptr;\n+  } else {\n+    devtools_web_view_->SetVisible(false);\n+    devtools_web_view_->SetWebContents(nullptr);\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewShowing() {\n+  return devtools_visible_;\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewFocused() {\n+  if (devtools_window_web_view_)\n+    return devtools_window_web_view_->HasFocus();\n+  else if (devtools_web_view_)\n+    return devtools_web_view_->HasFocus();\n+  else\n+    return false;\n+}\n+\n+void InspectableWebContentsView::SetIsDocked(bool docked, bool activate) {\n+  CloseDevTools();\n+\n+  if (!docked) {\n+    devtools_window_ = std::make_unique<views::Widget>();\n+    devtools_window_web_view_ = new views::WebView(nullptr);\n+    devtools_window_delegate_ = new DevToolsWindowDelegate(\n+        this, devtools_window_web_view_, devtools_window_.get());\n+\n+    views::Widget::InitParams params(\n+        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET,\n+        views::Widget::InitParams::TYPE_WINDOW);\n+    params.delegate = devtools_window_delegate_;\n+    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n+\n+#if BUILDFLAG(IS_LINUX)\n+    params.wm_role_name = \"devtools\";\n+    if (GetDelegate())\n+      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n+                                              &params.wm_class_class);\n+#endif\n+\n+    devtools_window_->Init(std::move(params));\n+    devtools_window_->UpdateWindowIcon();\n+    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n+  }\n+\n+  ShowDevTools(activate);\n+}\n+\n+void InspectableWebContentsView::SetContentsResizingStrategy(\n+    const DevToolsContentsResizingStrategy& strategy) {\n+  strategy_.CopyFrom(strategy);\n+  DeprecatedLayoutImmediately();\n+}\n+\n+void InspectableWebContentsView::SetTitle(const std::u16string& title) {\n+  if (devtools_window_) {\n+    title_ = title;\n+    devtools_window_->UpdateWindowTitle();\n+  }\n+}\n+\n+const std::u16string InspectableWebContentsView::GetTitle() {\n+  return title_;\n+}\n+\n+void InspectableWebContentsView::Layout(PassKey) {\n+  if (!devtools_web_view_->GetVisible()) {\n+    GetContentsView()->SetBoundsRect(GetContentsBounds());\n+    // Propagate layout call to all children, for example browser views.\n+    LayoutSuperclass<View>(this);\n+    return;\n+  }\n+\n+  gfx::Size container_size(width(), height());\n+  gfx::Rect new_devtools_bounds;\n+  gfx::Rect new_contents_bounds;\n+  ApplyDevToolsContentsResizingStrategy(\n+      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n+\n+  // DevTools cares about the specific position, so we have to compensate RTL\n+  // layout here.\n+  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n+  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n+\n+  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n+  GetContentsView()->SetBoundsRect(new_contents_bounds);\n+\n+  // Propagate layout call to all children, for example browser views.\n+  LayoutSuperclass<View>(this);\n+\n+  if (GetDelegate())\n+    GetDelegate()->DevToolsResized();\n+}\n+\n+views::View* InspectableWebContentsView::GetContentsView() const {\n+  DCHECK(contents_web_view_ || no_contents_view_);\n \n-InspectableWebContentsView::~InspectableWebContentsView() = default;\n+  return contents_web_view_ ? contents_web_view_ : no_contents_view_;\n+}\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.h b/shell/browser/ui/inspectable_web_contents_view.h\nindex a9c95d477e00d..282d3bf805a97 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.h\n+++ b/shell/browser/ui/inspectable_web_contents_view.h\n@@ -9,13 +9,9 @@\n #include <string>\n \n #include \"base/memory/raw_ptr.h\"\n-#include \"build/build_config.h\"\n-\n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-#include \"ui/views/view.h\"\n-#else\n+#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n #include \"ui/gfx/native_widget_types.h\"\n-#endif\n+#include \"ui/views/view.h\"\n \n class DevToolsContentsResizingStrategy;\n \n@@ -23,23 +19,22 @@ namespace gfx {\n class RoundedCornersF;\n }  // namespace gfx\n \n-#if defined(TOOLKIT_VIEWS)\n namespace views {\n-class View;\n class WebView;\n+class Widget;\n+class WidgetDelegate;\n }  // namespace views\n-#endif\n \n namespace electron {\n \n class InspectableWebContents;\n class InspectableWebContentsViewDelegate;\n \n-class InspectableWebContentsView {\n+class InspectableWebContentsView : public views::View {\n  public:\n   explicit InspectableWebContentsView(\n       InspectableWebContents* inspectable_web_contents);\n-  virtual ~InspectableWebContentsView();\n+  ~InspectableWebContentsView() override;\n \n   InspectableWebContents* inspectable_web_contents() {\n     return inspectable_web_contents_;\n@@ -51,32 +46,40 @@ class InspectableWebContentsView {\n   }\n   InspectableWebContentsViewDelegate* GetDelegate() const { return delegate_; }\n \n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-  // Returns the container control, which has devtools view attached.\n-  virtual views::View* GetView() = 0;\n-#else\n-  virtual gfx::NativeView GetNativeView() const = 0;\n-#endif\n-\n-  virtual void ShowDevTools(bool activate) = 0;\n-  virtual void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) = 0;\n-  // Hide the DevTools view.\n-  virtual void CloseDevTools() = 0;\n-  virtual bool IsDevToolsViewShowing() = 0;\n-  virtual bool IsDevToolsViewFocused() = 0;\n-  virtual void SetIsDocked(bool docked, bool activate) = 0;\n-  virtual void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) = 0;\n-  virtual void SetTitle(const std::u16string& title) = 0;\n-  virtual const std::u16string GetTitle() = 0;\n-\n- protected:\n+  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii);\n+\n+  void ShowDevTools(bool activate);\n+  void CloseDevTools();\n+  bool IsDevToolsViewShowing();\n+  bool IsDevToolsViewFocused();\n+  void SetIsDocked(bool docked, bool activate);\n+  void SetContentsResizingStrategy(\n+      const DevToolsContentsResizingStrategy& strategy);\n+  void SetTitle(const std::u16string& title);\n+  const std::u16string GetTitle();\n+\n+  // views::View:\n+  void Layout(PassKey) override;\n+\n+ private:\n+  views::View* GetContentsView() const;\n+\n   // Owns us.\n   raw_ptr<InspectableWebContents> inspectable_web_contents_;\n \n- private:\n   raw_ptr<InspectableWebContentsViewDelegate> delegate_ =\n       nullptr;  // weak references.\n+\n+  std::unique_ptr<views::Widget> devtools_window_;\n+  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n+  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n+  raw_ptr<views::View> no_contents_view_ = nullptr;\n+  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n+\n+  DevToolsContentsResizingStrategy strategy_;\n+  bool devtools_visible_ = false;\n+  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n+  std::u16string title_;\n };\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.h b/shell/browser/ui/inspectable_web_contents_view_mac.h\ndeleted file mode 100644\nindex 88b4078614f42..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.h\n+++ /dev/null\n@@ -1,42 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-#define ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-\n-@class ElectronInspectableWebContentsView;\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewMac : public InspectableWebContentsView {\n- public:\n-  explicit InspectableWebContentsViewMac(\n-      InspectableWebContents* inspectable_web_contents);\n-  InspectableWebContentsViewMac(const InspectableWebContentsViewMac&) = delete;\n-  InspectableWebContentsViewMac& operator=(\n-      const InspectableWebContentsViewMac&) = delete;\n-  ~InspectableWebContentsViewMac() override;\n-\n-  gfx::NativeView GetNativeView() const override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void ShowDevTools(bool activate) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n- private:\n-  ElectronInspectableWebContentsView* __strong view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.mm b/shell/browser/ui/inspectable_web_contents_view_mac.mm\ndeleted file mode 100644\nindex a3789e09a8fb3..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.mm\n+++ /dev/null\n@@ -1,75 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-\n-#include \"base/strings/sys_string_conversions.h\"\n-#import \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-\n-namespace electron {\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewMac(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewMac::InspectableWebContentsViewMac(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      view_([[ElectronInspectableWebContentsView alloc]\n-          initWithInspectableWebContentsViewMac:this]) {}\n-\n-InspectableWebContentsViewMac::~InspectableWebContentsViewMac() {\n-  [[NSNotificationCenter defaultCenter] removeObserver:view_];\n-  CloseDevTools();\n-}\n-\n-gfx::NativeView InspectableWebContentsViewMac::GetNativeView() const {\n-  return view_;\n-}\n-\n-void InspectableWebContentsViewMac::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // We can assume all four values are identical.\n-  [view_ setCornerRadii:corner_radii.upper_left()];\n-}\n-\n-void InspectableWebContentsViewMac::ShowDevTools(bool activate) {\n-  [view_ setDevToolsVisible:YES activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::CloseDevTools() {\n-  [view_ setDevToolsVisible:NO activate:NO];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewShowing() {\n-  return [view_ isDevToolsVisible];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewFocused() {\n-  return [view_ isDevToolsFocused];\n-}\n-\n-void InspectableWebContentsViewMac::SetIsDocked(bool docked, bool activate) {\n-  [view_ setIsDocked:docked activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  [view_ setContentsResizingStrategy:strategy];\n-}\n-\n-void InspectableWebContentsViewMac::SetTitle(const std::u16string& title) {\n-  [view_ setTitle:base::SysUTF16ToNSString(title)];\n-}\n-\n-const std::u16string InspectableWebContentsViewMac::GetTitle() {\n-  return base::SysNSStringToUTF16([view_ getTitle]);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/frameless_view.cc b/shell/browser/ui/views/frameless_view.cc\nindex c963d1731093a..dcfed5ef695f0 100644\n--- a/shell/browser/ui/views/frameless_view.cc\n+++ b/shell/browser/ui/views/frameless_view.cc\n@@ -5,6 +5,8 @@\n #include \"shell/browser/ui/views/frameless_view.h\"\n \n #include \"shell/browser/native_window_views.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n+#include \"ui/aura/window.h\"\n #include \"ui/base/hit_test.h\"\n #include \"ui/base/metadata/metadata_impl_macros.h\"\n #include \"ui/views/widget/widget.h\"\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.cc b/shell/browser/ui/views/inspectable_web_contents_view_views.cc\ndeleted file mode 100644\nindex 61a5b013ecb12..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.cc\n+++ /dev/null\n@@ -1,257 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/views/inspectable_web_contents_view_views.h\"\n-\n-#include <memory>\n-#include <utility>\n-\n-#include \"base/memory/raw_ptr.h\"\n-#include \"shell/browser/ui/drag_util.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/base/models/image_model.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-#include \"ui/views/controls/label.h\"\n-#include \"ui/views/controls/webview/webview.h\"\n-#include \"ui/views/widget/widget.h\"\n-#include \"ui/views/widget/widget_delegate.h\"\n-#include \"ui/views/window/client_view.h\"\n-\n-namespace electron {\n-\n-namespace {\n-\n-class DevToolsWindowDelegate : public views::ClientView,\n-                               public views::WidgetDelegate {\n- public:\n-  DevToolsWindowDelegate(InspectableWebContentsViewViews* shell,\n-                         views::View* view,\n-                         views::Widget* widget)\n-      : views::ClientView(widget, view),\n-        shell_(shell),\n-        view_(view),\n-        widget_(widget) {\n-    SetOwnedByWidget(true);\n-    set_owned_by_client();\n-\n-    if (shell->GetDelegate())\n-      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n-  }\n-  ~DevToolsWindowDelegate() override = default;\n-\n-  // disable copy\n-  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n-  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n-\n-  // views::WidgetDelegate:\n-  views::View* GetInitiallyFocusedView() override { return view_; }\n-  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n-  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n-  ui::ImageModel GetWindowIcon() override { return icon_; }\n-  views::Widget* GetWidget() override { return widget_; }\n-  const views::Widget* GetWidget() const override { return widget_; }\n-  views::View* GetContentsView() override { return view_; }\n-  views::ClientView* CreateClientView(views::Widget* widget) override {\n-    return this;\n-  }\n-\n-  // views::ClientView:\n-  views::CloseRequestResult OnWindowCloseRequested() override {\n-    shell_->inspectable_web_contents()->CloseDevTools();\n-    return views::CloseRequestResult::kCannotClose;\n-  }\n-\n- private:\n-  raw_ptr<InspectableWebContentsViewViews> shell_;\n-  raw_ptr<views::View> view_;\n-  raw_ptr<views::Widget> widget_;\n-  ui::ImageModel icon_;\n-};\n-\n-}  // namespace\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewViews(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewViews::InspectableWebContentsViewViews(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      devtools_web_view_(new views::WebView(nullptr)),\n-      title_(u\"Developer Tools\") {\n-  if (!inspectable_web_contents_->is_guest() &&\n-      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n-    auto* contents_web_view = new views::WebView(nullptr);\n-    contents_web_view->SetWebContents(\n-        inspectable_web_contents_->GetWebContents());\n-    contents_view_ = contents_web_view_ = contents_web_view;\n-  } else {\n-    contents_view_ = new views::Label(u\"No content under offscreen mode\");\n-  }\n-\n-  devtools_web_view_->SetVisible(false);\n-  AddChildView(devtools_web_view_.get());\n-  AddChildView(contents_view_.get());\n-}\n-\n-InspectableWebContentsViewViews::~InspectableWebContentsViewViews() {\n-  if (devtools_window_)\n-    inspectable_web_contents()->SaveDevToolsBounds(\n-        devtools_window_->GetWindowBoundsInScreen());\n-}\n-\n-views::View* InspectableWebContentsViewViews::GetView() {\n-  return this;\n-}\n-\n-void InspectableWebContentsViewViews::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // WebView won't exist for offscreen rendering.\n-  if (contents_web_view_) {\n-    contents_web_view_->holder()->SetCornerRadii(\n-        gfx::RoundedCornersF(corner_radii));\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::ShowDevTools(bool activate) {\n-  if (devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = true;\n-  if (devtools_window_) {\n-    devtools_window_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n-    if (activate) {\n-      devtools_window_->Show();\n-    } else {\n-      devtools_window_->ShowInactive();\n-    }\n-\n-    // Update draggable regions to account for the new dock position.\n-    if (GetDelegate())\n-      GetDelegate()->DevToolsResized();\n-  } else {\n-    devtools_web_view_->SetVisible(true);\n-    devtools_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_web_view_->RequestFocus();\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::CloseDevTools() {\n-  if (!devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = false;\n-  if (devtools_window_) {\n-    auto save_bounds = devtools_window_->IsMinimized()\n-                           ? devtools_window_->GetRestoredBounds()\n-                           : devtools_window_->GetWindowBoundsInScreen();\n-    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n-\n-    devtools_window_.reset();\n-    devtools_window_web_view_ = nullptr;\n-    devtools_window_delegate_ = nullptr;\n-  } else {\n-    devtools_web_view_->SetVisible(false);\n-    devtools_web_view_->SetWebContents(nullptr);\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewShowing() {\n-  return devtools_visible_;\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewFocused() {\n-  if (devtools_window_web_view_)\n-    return devtools_window_web_view_->HasFocus();\n-  else if (devtools_web_view_)\n-    return devtools_web_view_->HasFocus();\n-  else\n-    return false;\n-}\n-\n-void InspectableWebContentsViewViews::SetIsDocked(bool docked, bool activate) {\n-  CloseDevTools();\n-\n-  if (!docked) {\n-    devtools_window_ = std::make_unique<views::Widget>();\n-    devtools_window_web_view_ = new views::WebView(nullptr);\n-    devtools_window_delegate_ = new DevToolsWindowDelegate(\n-        this, devtools_window_web_view_, devtools_window_.get());\n-\n-    views::Widget::InitParams params{\n-        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET};\n-    params.ownership = views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;\n-    params.delegate = devtools_window_delegate_;\n-    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n-\n-#if BUILDFLAG(IS_LINUX)\n-    params.wm_role_name = \"devtools\";\n-    if (GetDelegate())\n-      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n-                                              &params.wm_class_class);\n-#endif\n-\n-    devtools_window_->Init(std::move(params));\n-    devtools_window_->UpdateWindowIcon();\n-    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n-  }\n-\n-  ShowDevTools(activate);\n-}\n-\n-void InspectableWebContentsViewViews::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  strategy_.CopyFrom(strategy);\n-  DeprecatedLayoutImmediately();\n-}\n-\n-void InspectableWebContentsViewViews::SetTitle(const std::u16string& title) {\n-  if (devtools_window_) {\n-    title_ = title;\n-    devtools_window_->UpdateWindowTitle();\n-  }\n-}\n-\n-const std::u16string InspectableWebContentsViewViews::GetTitle() {\n-  return title_;\n-}\n-\n-void InspectableWebContentsViewViews::Layout(PassKey) {\n-  if (!devtools_web_view_->GetVisible()) {\n-    contents_view_->SetBoundsRect(GetContentsBounds());\n-    // Propagate layout call to all children, for example browser views.\n-    LayoutSuperclass<View>(this);\n-    return;\n-  }\n-\n-  gfx::Size container_size(width(), height());\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n-\n-  // DevTools cares about the specific position, so we have to compensate RTL\n-  // layout here.\n-  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n-  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n-\n-  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n-  contents_view_->SetBoundsRect(new_contents_bounds);\n-\n-  // Propagate layout call to all children, for example browser views.\n-  LayoutSuperclass<View>(this);\n-\n-  if (GetDelegate())\n-    GetDelegate()->DevToolsResized();\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.h b/shell/browser/ui/views/inspectable_web_contents_view_views.h\ndeleted file mode 100644\nindex 36554a497d6f2..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.h\n+++ /dev/null\n@@ -1,63 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-#define ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-\n-#include <memory>\n-\n-#include \"base/compiler_specific.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-#include \"third_party/skia/include/core/SkRegion.h\"\n-#include \"ui/views/view.h\"\n-\n-namespace views {\n-class WebView;\n-class Widget;\n-class WidgetDelegate;\n-}  // namespace views\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewViews : public InspectableWebContentsView,\n-                                        public views::View {\n- public:\n-  explicit InspectableWebContentsViewViews(\n-      InspectableWebContents* inspectable_web_contents);\n-  ~InspectableWebContentsViewViews() override;\n-\n-  // InspectableWebContentsView:\n-  views::View* GetView() override;\n-  void ShowDevTools(bool activate) override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n-  // views::View:\n-  void Layout(PassKey) override;\n-\n- private:\n-  std::unique_ptr<views::Widget> devtools_window_;\n-  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n-  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n-  raw_ptr<views::View> contents_view_ = nullptr;\n-  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-  bool devtools_visible_ = false;\n-  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n-  std::u16string title_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n", "test_patch": "", "problem_statement": "[Bug]: EXCEPTION_ACCESS_VIOLATION crash on `BrowserWindow.destroy()`\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n \\>=v31.0.0 (tested v31.0.0, v31.2.1, v32.0.0-aplha.10)\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nWindows 10 22H2\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nv30.3.0 (and everything below it)\r\n\r\n### Expected Behavior\r\n\r\n```js\r\nchildWindow.once('close', () => {\r\n    // do some cleanup etc\r\n    childWindow.destroy();;\r\n});\r\n```\r\n\r\nshouldn't crash Electron\r\n\r\n\r\n### Actual Behavior\r\n\r\n```js\r\nfunction cleanup() {\r\n\t// do some cleanup etc\r\n    childWindow.destroy();;\r\n}\r\nipcMain.once(`done`, cleanup);\r\nchildWindow.once('close', cleanup);\r\n```\r\nif `done` ipc event is not called and the window is manually closed, the window is destroyed and a few moments later The main Electron process crash with the following trace:\r\n\r\n<details><summary>Stacktrace Windows</summary>\r\n<p>\r\n\r\n```\r\nReceived fatal exception EXCEPTION_ACCESS_VIOLATION\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03CB9E08+3764424]\r\nv8::HeapStatistics::external_memory [0x00A48A12+8338]\r\ncppgc::internal::SameThreadEnabledCheckingPolicyBase::SameThreadEnabledCheckingPolicyBase [0x00B0DE72+28834]\r\nuv_req_get_data [0x022485EE+4269966]\r\nuv_req_get_data [0x02248AAA+4271178]\r\nuv_stream_get_write_queue_size [0x0277DBD5+2462421]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nsqlite3_dbdata_init [0x068DC9A7+2609367]\r\nuv_stream_get_write_queue_size [0x0277E07F+2463615]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nuv_stream_get_write_queue_size [0x0277D3B9+2460345]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nDispatchMessageW [0x76976901+1265]\r\nDispatchMessageW [0x76976420+16]\r\nuv_os_getpid [0x01D81F00+6592]\r\nuv_os_getpid [0x01D81B5B+5659]\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03C980DB+3625883]\r\nuv_os_getpid [0x01D817FB+4795]\r\nGetHandleVerifier [0x0232C67C+61788]\r\nuv_os_getpid [0x01DA8F14+166356]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169DD19+2893273]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169F5FE+2899646]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169B4AF+2882927]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DF37+3175]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EFF0+7456]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EEB7+7143]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9D88E+1470]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DA11+1857]\r\nv8::SourceLocation::SourceLocation [0x00960B7D+46669]\r\nv8::SourceLocation::SourceLocation [0x00960721+45553]\r\nGetNumaHighestNodeNumber [0x77682911+161]\r\nGetNumaHighestNodeNumber [0x776828C6+86]\r\nRtlUserFiberStart [0x77EC2DC7+23]\r\n\r\nElectron exited with code 3221226525.\r\n```\r\n\r\n</p>\r\n</details> \r\n\r\n### Testcase Gist URL\r\n\r\n> To reproduce, click the menu item then manually close the window that appears\r\n\r\nNo dependencies:\r\n\r\nhttps://gist.github.com/Araxeus/4e80b05c8bce61a5fe709eec1e969f2b\r\n\r\nOriginal issue:\r\n\r\nhttps://gist.github.com/Araxeus/6548ef4f3438d35d1713d5fd69c3b494\r\n\r\n### Additional Information\r\n\r\n* test repo: https://github.com/Aetherinox/electron-prompts\r\n* related issue: https://github.com/Araxeus/custom-electron-prompt/issues/26\n", "hints_text": "<details><summary>Stacktrace on macOS</summary>\r\n<p>\r\n\r\n```\r\n[80356:0722/110229.619327:FATAL:lock_impl_posix.cc(46)] Check failed: rv == 0 || rv == EBUSY. . Invalid argument. Hint: This is often related to a use-after-free.\r\n0   Electron Framework                  0x000000011b902974 base::debug::CollectStackTrace(void const**, unsigned long) + 28\r\n1   Electron Framework                  0x000000011b8f225c base::debug::StackTrace::StackTrace() + 80\r\n2   Electron Framework                  0x000000011b821800 logging::LogMessage::Flush() + 152\r\n3   Electron Framework                  0x000000011b8216f4 logging::LogMessage::~LogMessage() + 36\r\n4   Electron Framework                  0x000000011b80a568 logging::(anonymous namespace)::DCheckLogMessage::~DCheckLogMessage() + 124\r\n5   Electron Framework                  0x000000011b80a5b8 logging::(anonymous namespace)::DCheckLogMessage::~DCheckLogMessage() + 12\r\n6   Electron Framework                  0x000000011b80a034 logging::CheckError::~CheckError() + 44\r\n7   Electron Framework                  0x000000011b80a09c logging::CheckError::~CheckError() + 12\r\n8   Electron Framework                  0x000000011b8f0594 base::internal::dcheck_trylock_result(int) + 176\r\n9   Electron Framework                  0x000000011b8720c4 base::Lock::Acquire(base::subtle::LockTracking) + 44\r\n10  Electron Framework                  0x000000011b85c204 base::SequenceCheckerImpl::CalledOnValidSequence(std::__Cr::unique_ptr<base::debug::StackTrace, std::__Cr::default_delete<base::debug::StackTrace>>*) const + 44\r\n11  Electron Framework                  0x000000011b85be80 base::ScopedValidateSequenceChecker::ScopedValidateSequenceChecker(base::SequenceCheckerImpl const&) + 40\r\n12  Electron Framework                  0x000000011661bdc0 electron::NativeWindow::NotifyWindowCloseButtonClicked() + 624\r\n13  Electron Framework                  0x000000011672c2fc -[ElectronNSWindowDelegate windowShouldClose:] + 208\r\n14  AppKit                              0x0000000194831d9c __19-[NSWindow __close]_block_invoke + 160\r\n15  AppKit                              0x0000000194831ccc -[NSWindow __close] + 400\r\n16  AppKit                              0x00000001947120e8 -[NSApplication(NSResponder) sendAction:to:from:] + 460\r\n17  AppKit                              0x0000000194711eec -[NSControl sendAction:to:] + 72\r\n18  AppKit                              0x0000000194711e30 __26-[NSCell _sendActionFrom:]_block_invoke + 100\r\n19  AppKit                              0x0000000194711d58 -[NSCell _sendActionFrom:] + 204\r\n20  AppKit                              0x0000000194711c7c -[NSButtonCell _sendActionFrom:] + 88\r\n21  AppKit                              0x000000019470f268 NSControlTrackMouse + 1480\r\n22  AppKit                              0x000000019470ec74 -[NSCell trackMouse:inRect:ofView:untilMouseUp:] + 144\r\n23  AppKit                              0x000000019470eb2c -[NSButtonCell trackMouse:inRect:ofView:untilMouseUp:] + 488\r\n24  AppKit                              0x000000019470e000 -[NSControl mouseDown:] + 448\r\n25  AppKit                              0x000000019470cdcc -[NSWindow(NSEventRouting) _handleMouseDownEvent:isDelayedEvent:] + 3472\r\n26  AppKit                              0x000000019469840c -[NSWindow(NSEventRouting) _reallySendEvent:isDelayedEvent:] + 288\r\n27  AppKit                              0x0000000194698118 -[NSWindow(NSEventRouting) sendEvent:] + 284\r\n28  Electron Framework                  0x000000011d53614c -[NativeWidgetMacNSWindow sendEvent:] + 604\r\n29  AppKit                              0x0000000194d60828 -[NSApplication(NSEventRouting) sendEvent:] + 1604\r\n30  Electron Framework                  0x000000011670bc6c -[AtomApplication sendEvent:] + 128\r\n31  AppKit                              0x00000001949ae89c -[NSApplication _handleEvent:] + 60\r\n32  AppKit                              0x000000019455f0c0 -[NSApplication run] + 512\r\n33  Electron Framework                  0x000000011b910b9c base::MessagePumpNSApplication::DoRun(base::MessagePump::Delegate*) + 396\r\n34  Electron Framework                  0x000000011b90eabc base::MessagePumpCFRunLoopBase::Run(base::MessagePump::Delegate*) + 112\r\n35  Electron Framework                  0x000000011b8a8210 base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) + 692\r\n36  Electron Framework                  0x000000011b856af8 base::RunLoop::Run(base::Location const&) + 952\r\n37  Electron Framework                  0x000000011a31f818 content::BrowserMainLoop::RunMainMessageLoop() + 180\r\n38  Electron Framework                  0x000000011a321740 content::BrowserMainRunnerImpl::Run() + 48\r\n39  Electron Framework                  0x000000011a31c278 content::BrowserMain(content::MainFunctionParams) + 164\r\n40  Electron Framework                  0x00000001168c6e0c content::RunBrowserProcessMain(content::MainFunctionParams, content::ContentMainDelegate*) + 176\r\n41  Electron Framework                  0x00000001168c93c0 content::ContentMainRunnerImpl::RunBrowser(content::MainFunctionParams, bool) + 1824\r\n42  Electron Framework                  0x00000001168c8b78 content::ContentMainRunnerImpl::Run() + 952\r\n43  Electron Framework                  0x00000001168c64a8 content::RunContentProcess(content::ContentMainParams, content::ContentMainRunner*) + 1200\r\n44  Electron Framework                  0x00000001168c66f0 content::ContentMain(content::ContentMainParams) + 112\r\n45  Electron Framework                  0x00000001164b2c98 ElectronMain + 320\r\n46  dyld                                0x00000001908a60e0 start + 2360\r\nCrash keys:\r\n  \"ever_had_universal_access_exemption\" = \"true\"\r\n  \"amfi-status\" = \"rv=0 status=0x0 allow_everything=0\"\r\n  \"platform\" = \"darwin\"\r\n  \"process_type\" = \"browser\"\r\n\r\nElectron exited with signal SIGTRAP.\r\n```\r\n\r\n</p>\r\n</details> \r\n\r\nTracked to https://github.com/electron/electron/commit/e67ab9a93dadccecff30de50ab4555191c30b6c4\nClosed by https://github.com/electron/electron/pull/43033\n> Closed by https://github.com/electron/electron/pull/43033\n\nIt says the PR is for MacOS but this issue was reported on Windows?", "created_at": "2025-01-17 15:21:25", "merge_commit_sha": "91bb748eaa575cb45dafcf243f761e51900ae2e5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45187", "base_commit": "19ee4464c211a0cef3bc5070fbd7b8bd0d5c3c7d", "patch": "diff --git a/shell/browser/api/electron_api_session.cc b/shell/browser/api/electron_api_session.cc\nindex e72a309caa9e5..ae705c4fa5e67 100644\n--- a/shell/browser/api/electron_api_session.cc\n+++ b/shell/browser/api/electron_api_session.cc\n@@ -160,7 +160,8 @@ uint32_t GetQuotaMask(const std::vector<std::string>& quota_types) {\n   return quota_mask;\n }\n \n-constexpr BrowsingDataRemover::DataType kClearDataTypeAll = ~0ULL;\n+constexpr BrowsingDataRemover::DataType kClearDataTypeAll =\n+    ~0ULL & ~BrowsingDataRemover::DATA_TYPE_AVOID_CLOSING_CONNECTIONS;\n constexpr BrowsingDataRemover::OriginType kClearOriginTypeAll =\n     BrowsingDataRemover::ORIGIN_TYPE_UNPROTECTED_WEB |\n     BrowsingDataRemover::ORIGIN_TYPE_PROTECTED_WEB;\n", "test_patch": "", "problem_statement": "`avoidClosingConnections` option on `session.clearData()` doesn't work without `dataTypes`\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n34.0.0-beta.6\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS Sequoia 15.1.1\n\n### What arch are you using?\n\narm64 (including Apple Silicon)\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\n`avoidClosingConnections` is `false` by default (as the [docs](https://www.electronjs.org/docs/latest/api/session#sescleardataoptions) say), even when `dataTypes` is not set.\n\n### Actual Behavior\n\n`avoidClosingConnections` only takes effect when `dataTypes` is set.\n\nIf `dataTypes` is not set, `session.clearData()` behaves as if `avoidClosingConnections` was set to `true` (no matter what its actual value is).\n\n**Code:**\n\nThe data type mask is set to `~0ULL` here (i.e. `111111...`): https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1312\n\n`avoidClosingConnections` will try to set a bit in the data type mask to 1 here: https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1325-L1330\n\nThis only takes effect if `dataTypes` is set here: https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1320-L1323\n\nOtherwise, that bit is already 1.\n\n**Changes necessary:**\n\n* Either fix the default behavior (preferred).\n* Or update the docs.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/9fcc98d6a6a69f935d365df7ea741276\n\n### Additional Information\n\nI do not use this function in my code without specifying `dataTypes`, so I do not care much if this is fixed. I just noticed it while reading the code. If it doesn't get fixed, we should update the docs though.\n", "hints_text": "", "created_at": "2025-01-13 20:21:30", "merge_commit_sha": "6f7999ad0d09c7076f1878ba6e327b354425735e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-44599", "base_commit": "f9a04012b91539813b937b66c8998b4b068815f7", "patch": "diff --git a/shell/browser/api/electron_api_view.cc b/shell/browser/api/electron_api_view.cc\nindex b01a08be88cb7..c65f80b164fec 100644\n--- a/shell/browser/api/electron_api_view.cc\n+++ b/shell/browser/api/electron_api_view.cc\n@@ -124,6 +124,15 @@ struct Converter<views::FlexAllocationOrder> {\n   }\n };\n \n+template <>\n+struct Converter<electron::api::View> {\n+  static bool FromV8(v8::Isolate* isolate,\n+                     v8::Local<v8::Value> val,\n+                     electron::api::View* out) {\n+    return gin::ConvertFromV8(isolate, val, &out);\n+  }\n+};\n+\n template <>\n struct Converter<views::SizeBound> {\n   static v8::Local<v8::Value> ToV8(v8::Isolate* isolate,\n@@ -257,11 +266,13 @@ void View::RemoveChildView(gin::Handle<View> child) {\n #if BUILDFLAG(IS_MAC)\n     ScopedCAActionDisabler disable_animations;\n #endif\n+    // Remove from child_views first so that OnChildViewRemoved doesn't try to\n+    // remove it again\n+    child_views_.erase(it);\n     // It's possible for the child's view to be invalid here\n     // if the child's webContents was closed or destroyed.\n     if (child->view())\n       view_->RemoveChildView(child->view());\n-    child_views_.erase(it);\n   }\n }\n \n@@ -388,6 +399,19 @@ void View::OnViewIsDeleting(views::View* observed_view) {\n   view_ = nullptr;\n }\n \n+void View::OnChildViewRemoved(views::View* observed_view, views::View* child) {\n+  v8::Isolate* isolate = JavascriptEnvironment::GetIsolate();\n+  auto it = std::ranges::find_if(\n+      child_views_, [&](const v8::Global<v8::Object>& child_view) {\n+        View current_view;\n+        gin::ConvertFromV8(isolate, child_view.Get(isolate), &current_view);\n+        return current_view.view()->GetID() == child->GetID();\n+      });\n+  if (it != child_views_.end()) {\n+    child_views_.erase(it);\n+  }\n+}\n+\n // static\n gin_helper::WrappableBase* View::New(gin::Arguments* args) {\n   View* view = new View();\ndiff --git a/shell/browser/api/electron_api_view.h b/shell/browser/api/electron_api_view.h\nindex 6eeb16521906f..1b0a3f815a6f9 100644\n--- a/shell/browser/api/electron_api_view.h\n+++ b/shell/browser/api/electron_api_view.h\n@@ -47,6 +47,8 @@ class View : public gin_helper::EventEmitter<View>,\n   // views::ViewObserver\n   void OnViewBoundsChanged(views::View* observed_view) override;\n   void OnViewIsDeleting(views::View* observed_view) override;\n+  void OnChildViewRemoved(views::View* observed_view,\n+                          views::View* child) override;\n \n   views::View* view() const { return view_; }\n   std::optional<int> border_radius() const { return border_radius_; }\ndiff --git a/spec/fixtures/crash-cases/webview-move-between-windows/index.js b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\nnew file mode 100644\nindex 0000000000000..de9053ec65ca9\n--- /dev/null\n+++ b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\n@@ -0,0 +1,31 @@\n+const { app, BrowserWindow, WebContentsView } = require('electron');\n+\n+function createWindow () {\n+  // Create the browser window.\n+  const mainWindow = new BrowserWindow();\n+  const secondaryWindow = new BrowserWindow();\n+\n+  const contentsView = new WebContentsView();\n+  mainWindow.contentView.addChildView(contentsView);\n+  mainWindow.webContents.setDevToolsWebContents(contentsView.webContents);\n+  mainWindow.openDevTools();\n+\n+  contentsView.setBounds({\n+    x: 400,\n+    y: 0,\n+    width: 400,\n+    height: 600\n+  });\n+\n+  setTimeout(() => {\n+    secondaryWindow.contentView.addChildView(contentsView);\n+    setTimeout(() => {\n+      mainWindow.contentView.addChildView(contentsView);\n+      app.quit();\n+    }, 1000);\n+  }, 1000);\n+}\n+\n+app.whenReady().then(() => {\n+  createWindow();\n+});\n", "test_patch": "", "problem_statement": "segfault when moving WebContentsView between BrowserWindows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33, 34\n\n### What operating system(s) are you using?\n\nUbuntu\n\n### Operating System Version\n\n23.04\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nWhen moving WebContentsViews between different browser windows, the app doesn't crash\n\n### Actual Behavior\n\nWhen moving WebContentsViews from BrowserWindow A to BrowserWindow B and back to BrowserWindow A, the app crashes. Going just from A BrowserWindow A to BrowserWindow B works, but then back to A segfaults.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/Kilian/8014d47a193a8f66b05f490def934166\n\n### Additional Information\n\n_No response_\n", "hints_text": "@Kilian is there a last known version?\n\nedit: this seems to have been broken since at least e30\n.\ne29 fails on this line:\n\n```\nconst contentsView = new WebContentsView();\n```\nwith\n```sh\n(node:2038244) UnhandledPromiseRejectionWarning: TypeError: Insufficient number of arguments.\n    at createWindow (/tmp/electron-fiddle-2030700-MSoL9sQJYrOk/main.js:21:24)\n    at /tmp/electron-fiddle-2030700-MSoL9sQJYrOk/main.js:43:3\n```\nI can't find the webcontentsview docs in the 29 branch, so I don't know if there were any required arguments at that point.\n\nIt first started crashing in 30.0.0-beta.8, though in 30.0.0-beta.7 and earlier there is no webcontentsview visible but there is also no error visible like above.\n\nWebContentsView was [reverted in v29](https://github.com/electron/electron/pull/41361), so that is why you cannot find any docs in that branch. If it started crashing in a v30, then it has basically been crashing from the start from the looks of things. \nI hit the same issue and the solution was to remove the view from its current parent and then add it to the new parent.\nIt complicated our code a bit, but solved the problem.\n@estoykov do you have a code example?\n\nI have an different fiddle here that first removes the webcontentsview but it still crashes: https://gist.github.com/Kilian/8f0365a3c962b4d5927f2c21284fb1e6\nWell, may be I miss leaded you as our structure is a bit more complex - we need to have more than one view in our containers, so the flow is something like this:\n- create BrowserWindow\n- create rootView = new View()\n- browserWindow.setContentView(rootView)\n- create multiple \"hosts\" which are simply Views, i.e.\n- host1 has rootView = new View()\n- host2 has rootView = new View()\n- put host1 and host2 rootVews in the BrowerWindow content rootView \n- and then we move some other view from host1 and host2 rootView - it crashed before when added to host1, then host2 and then back to host1 - removing from the current host root view before adding to the new one solved the problem\n\nChanging BrowserWindow content view comes with an additional processing - you need to track this content view (View in my case) bounds change and re-pos/re-size the real content (WebContentsView) if any, ditto for the hosts and their content...\n", "created_at": "2024-11-08 19:42:56", "merge_commit_sha": "777e54792244b92565eb6bf32fed166217f46de7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['Lint', '.github/workflows/build.yml']"], ["['test (linux, 1)', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-44296", "base_commit": "6e3a5daf62314d4de541d64a1098b0bb3a37168c", "patch": "diff --git a/shell/browser/ui/file_dialog_win.cc b/shell/browser/ui/file_dialog_win.cc\nindex cfc8c6068c648..e142477ad0820 100644\n--- a/shell/browser/ui/file_dialog_win.cc\n+++ b/shell/browser/ui/file_dialog_win.cc\n@@ -144,10 +144,14 @@ static void ApplySettings(IFileDialog* dialog, const DialogSettings& settings) {\n   // We set file extension to the first none-wildcard extension to make\n   // sure the dialog will update file extension automatically.\n   for (size_t i = 0; i < filterspec.size(); ++i) {\n-    if (std::wstring(filterspec[i].pszSpec) != L\"*.*\") {\n+    std::wstring spec(filterspec[i].pszSpec);\n+    if (spec != L\"*.*\") {\n       // SetFileTypeIndex is regarded as one-based index.\n       dialog->SetFileTypeIndex(i + 1);\n-      dialog->SetDefaultExtension(filterspec[i].pszSpec);\n+      // \"*.jpg;*.png\" => \"*.jpg\"\n+      std::wstring first_spec = spec.substr(0, spec.find(L';'));\n+      // \"*.jpg\" => \"jpg\"\n+      dialog->SetDefaultExtension(first_spec.substr(2).c_str());\n       break;\n     }\n   }\n", "test_patch": "", "problem_statement": "[Bug]: Windows showSaveDialog invalid filename bug\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.0.0\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11 22H2 22621.4317\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\nNone\n\n### Expected Behavior\n\n1. Open the save dialog using dialog.showSaveDialog.\n2. Enter a file name containing illegal characters (e.g., 111*222).\n- Expected: The dialog correctly shows a warning that the file name is invalid due to the presence of illegal characters*.\n3. Remove the illegal characters* (e.g., change 111*222 to 111222).\n4. Attempt to save the file without adding an extension.\n- Expected: The dialog should now allow saving the file since all illegal characters have been removed, even if no file extension is added.\n\n### Actual Behavior\n\n1. Open the save dialog using dialog.showSaveDialog.\n2. Enter a file name containing illegal characters* (e.g., 111*222).\n- Actual: The dialog provides no error message or feedback.\n3. Remove the illegal characters* (e.g., change 111*222 to 111222).\n4. Attempt to save the file without adding an extension.\n- Actual: The dialog shows the file name as invalid, even though all illegal characters have been removed.\n5. Now, modify the file name to include a valid extension (e.g., 111222.xml).\n- Actual: The file saves successfully when an extension is added, indicating that the dialog behaves inconsistently by requiring an extension even for valid file names.\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nBelow is a minimal code example to reproduce the issue:\n\nSample Code:\n```\nconst fs = require('fs');\nconst { dialog } = require('electron');\n\nconst saveFileDialog = dialog.showSaveDialog({\n  title: '\u4fdd\u5b58 XML \u6587\u4ef6',\n  filters: [\n    { name: 'XML \u6587\u4ef6', extensions: ['xml'] }\n  ]\n});\n\nsaveFileDialog.then(result => {\n  if (!result.canceled) {\n    const filePath = result.filePath;\n    console.log(`\u6587\u4ef6\u5c06\u4fdd\u5b58\u5230: ${filePath}`);\n\n    // \u4f60\u8981\u4fdd\u5b58\u7684 XML \u5185\u5bb9\n    const xmlContent = `\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<root>\n  <item>\n    <name>\u793a\u4f8b\u6570\u636e</name>\n    <value>123</value>\n  </item>\n</root>`;\n\n    // \u5c06 XML \u5185\u5bb9\u5199\u5165\u6587\u4ef6\n    fs.writeFile(filePath, xmlContent, (err) => {\n      if (err) {\n        console.error('\u4fdd\u5b58\u6587\u4ef6\u65f6\u51fa\u9519:', err);\n      } else {\n        console.log('\u6587\u4ef6\u4fdd\u5b58\u6210\u529f!');\n      }\n    });\n  } else {\n    console.log('\u7528\u6237\u53d6\u6d88\u4e86\u4fdd\u5b58\u64cd\u4f5c');\n  }\n});\n\n```\nThis behavior only occurs in Electron applications, including those built using Electron, such as Visual Studio Code, QQ,WeChat PC (version 4.0) and other apps.\nHowever, Windows built-in applications like Notepad or third-party editors such as Notepad++ do not exhibit this behavior. In these apps, once illegal characters are removed from the file name, the modified name is accepted without requiring a file extension.\n\nThis inconsistency suggests that the showSaveDialog function in Electron has stricter handling or some kind of caching issue when validating file names, leading to unexpected behavior. This issue affects the user experience, as users are required to manually add file extensions even when they expect the file to save without one.\n\nThis issue seems to be related to or may have similarities with the following issue reported previously:\n[#25615 - SaveDialog doesn\u2019t allow saving a file with some extensions on Windows](https://github.com/electron/electron/issues/25615).\n\nBoth issues may indicate an underlying problem in how the dialog.showSaveDialog function interacts with Windows file system rules.\n\n![Image](https://github.com/user-attachments/assets/3f6bd0c9-5eeb-4642-9a97-1fb488ab573f)\n![Image](https://github.com/user-attachments/assets/297e7f88-d86e-430d-9267-8a41676952d2)\n![Image](https://github.com/user-attachments/assets/7ff1b07d-75a0-44fa-9920-728e4afbd125)\n![Image](https://github.com/user-attachments/assets/ef1b6db9-1ea7-4bd5-8737-9e589b3ee840)\n\n\n\n\n", "hints_text": "@dfvips does this happen in Chrome itself?\n> [@dfvips](https://github.com/dfvips) does this happen in Chrome itself?\n\nI just tested it in Chrome, and everything worked fine. This issue does not occur in Chrome itself, it only happens in Electron applications. But if Chrome doesn't specify an extension, it will be saved successfully without a file extension. \n![Image](https://github.com/user-attachments/assets/302b6ea0-6754-4e9e-bbe0-0004f6107ffb)\n![Image](https://github.com/user-attachments/assets/039adef6-2af4-4709-9275-19b0cf37d1d1)\n\n<video src=\"https://github.com/user-attachments/assets/a4d23bcd-0296-4151-9b95-45db70689303\" autoplay muted controls></video>\n<video src=\"https://github.com/user-attachments/assets/e2e9aacd-aed0-4211-b6af-fc4ff40f4714\" autoplay muted controls></video>\n", "created_at": "2024-10-17 08:50:44", "merge_commit_sha": "0ea64850afb070b4c4280f263d0054b9e0787139", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['Lint', '.github/workflows/build.yml']"], ["['test (linux, 1)', '.github/workflows/build.yml']", "['setup', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-43150", "base_commit": "45e5ccc55e8b13a45899bacff5cb98c9994446f2", "patch": "diff --git a/shell/browser/net/system_network_context_manager.cc b/shell/browser/net/system_network_context_manager.cc\nindex be839e174243c..8b8beac393cfb 100644\n--- a/shell/browser/net/system_network_context_manager.cc\n+++ b/shell/browser/net/system_network_context_manager.cc\n@@ -195,6 +195,8 @@ SystemNetworkContextManager::CreateDefaultNetworkContextParams() {\n void SystemNetworkContextManager::ConfigureDefaultNetworkContextParams(\n     network::mojom::NetworkContextParams* network_context_params) {\n   network_context_params->enable_brotli = true;\n+  network_context_params->enable_zstd =\n+      base::FeatureList::IsEnabled(net::features::kZstdContentEncoding);\n \n   network_context_params->enable_referrers = true;\n \n", "test_patch": "", "problem_statement": "[Bug]: zstd is not enabled in accept-encoding\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n31.3.1\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nany\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n_No response_\r\n\r\n### Expected Behavior\r\n\r\nzstd is a supported content encoding method, and the accept-encoding should be \"gzip, deflate, br, zstd\"\r\n\r\n<img width=\"920\" alt=\"\u622a\u5c4f2024-07-31 06 43 43\" src=\"https://github.com/user-attachments/assets/11d536fd-f7bd-4a31-93cb-36960de0dfea\">\r\n\r\n\r\n### Actual Behavior\r\n\r\nit's not enabled even it's forcely enabled it in network conditions panel, the accept-encoding header is still \"gzip, deflate, br\".\r\n<img width=\"812\" alt=\"\u622a\u5c4f2024-07-31 06 40 16\" src=\"https://github.com/user-attachments/assets/c47a5f8a-9393-40a2-a1fb-ef81695a9be5\">\r\n\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nJust start the default electron fiddle, open the dev tools and set location.href to any site for example 'https://www.google.com/' then check the request headers in network panel.\n", "hints_text": "", "created_at": "2024-08-01 04:27:45", "merge_commit_sha": "bba31189a06f59d5b828e25defe14571cb502157", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test', '.github/workflows/build.yml']", "['test (mas, 1)', '.github/workflows/build.yml']"], ["['build', '.github/workflows/build.yml']", "['Validate PR Title', '.github/workflows/semantic.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-42275", "base_commit": "3ffa35dc8d1cfe54a3343c51958c6e9f3d70ace3", "patch": "diff --git a/docs/api/structures/web-preferences.md b/docs/api/structures/web-preferences.md\nindex 9c6a3ecc8fc8c..044cd2b2270b1 100644\n--- a/docs/api/structures/web-preferences.md\n+++ b/docs/api/structures/web-preferences.md\n@@ -143,6 +143,7 @@\n   contain the layout of the document\u2014without requiring scrolling. Enabling\n   this will cause the `preferred-size-changed` event to be emitted on the\n   `WebContents` when the preferred size changes. Default is `false`.\n+* `transparent` boolean (optional) - Whether to enable background transparency for the guest page. Default is `true`. **Note:** The guest page's text and background colors are derived from the [color scheme](https://developer.mozilla.org/en-US/docs/Web/CSS/color-scheme) of its root element. When transparency is enabled, the text color will still change accordingly but the background will remain transparent.\n \n [chrome-content-scripts]: https://developer.chrome.com/extensions/content_scripts#execution-environment\n [runtime-enabled-features]: https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/platform/runtime_enabled_features.json5\ndiff --git a/docs/api/webview-tag.md b/docs/api/webview-tag.md\nindex 99e740eb39a9c..14103680f7f4e 100644\n--- a/docs/api/webview-tag.md\n+++ b/docs/api/webview-tag.md\n@@ -221,9 +221,7 @@ windows. Popups are disabled by default.\n ```\n \n A `string` which is a comma separated list of strings which specifies the web preferences to be set on the webview.\n-The full list of supported preference strings can be found in [BrowserWindow](browser-window.md#new-browserwindowoptions). In addition, webview supports the following preferences:\n-\n-* `transparent` boolean (optional) - Whether to enable background transparency for the guest page. Default is `true`. **Note:** The guest page's text and background colors are derived from the [color scheme](https://developer.mozilla.org/en-US/docs/Web/CSS/color-scheme) of its root element. When transparency is enabled, the text color will still change accordingly but the background will remain transparent.\n+The full list of supported preference strings can be found in [BrowserWindow](browser-window.md#new-browserwindowoptions).\n \n The string follows the same format as the features string in `window.open`.\n A name by itself is given a `true` boolean value.\n", "test_patch": "", "problem_statement": "[Bug]: `WebviewTag.webpreferences` has wrong type\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n30.0.6\r\n\r\n### What operating system are you using?\r\n\r\nmacOS\r\n\r\n### Operating System Version\r\n\r\nSonoma 14.4.1\r\n\r\n### What arch are you using?\r\n\r\narm64 (including Apple Silicon)\r\n\r\n### Last Known Working Electron version\r\n\r\n29.4.0\r\n\r\n### Expected Behavior\r\n\r\nCan assign `\"contextIsolation=false, nodeintegration=true\"` and other valid strings to `WebviewTag.webpreferences`. The type of `WebviewTag.webpreferences` should be `string`.\r\n\r\n### Actual Behavior\r\n\r\n```\r\nerror TS2322: Type '\"contextIsolation=false\"' is not assignable to type '\"transparent\"'\r\n```\r\n\r\n`WebviewTag.webpreferences` has type `'transparent'`.\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\n* Broken in #40301\n", "hints_text": "", "created_at": "2024-05-25 04:19:17", "merge_commit_sha": "6423968dc56ce40259ed4a90744dbb9368dffd4e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-42126", "base_commit": "9b0409f7c91b1dd8e1554f8428972c1b0f171766", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex cd97a83b93a3b..8ab128530c726 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -129,3 +129,4 @@ fix_add_support_for_skipping_first_2_no-op_refreshes_in_thumb_cap.patch\n refactor_expose_file_system_access_blocklist.patch\n revert_power_update_trace_counter_in_power_monitor.patch\n feat_add_support_for_missing_dialog_features_to_shell_dialogs.patch\n+fix_partially_revert_invalidate_focusring.patch\ndiff --git a/patches/chromium/fix_partially_revert_invalidate_focusring.patch b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\nnew file mode 100644\nindex 0000000000000..614f42b4acd3d\n--- /dev/null\n+++ b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\n@@ -0,0 +1,58 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: VerteDinde <keeleymhammond@gmail.com>\n+Date: Mon, 6 May 2024 11:03:08 -0700\n+Subject: fix: partially revert views invalidate FocusRing when its host is\n+ invalidated\n+\n+This reverts commit f425c438dfb11fb714655c999ba8c74b58393425. This\n+commit seems to be causing a sporadic crash on Ubuntu and other Linux\n+distros. This patch can be reverted when the issue is fixed upstream, or\n+when the crash is addressed.\n+\n+diff --git a/ui/views/view.cc b/ui/views/view.cc\n+index 94b026cda4738e489f1d7201c996f6db70d018ed..32ec794f4683be5ded78dcf310d3623b8748c236 100644\n+--- a/ui/views/view.cc\n++++ b/ui/views/view.cc\n+@@ -911,16 +911,6 @@ void View::Layout(PassKey) {\n+ }\n+ \n+ void View::InvalidateLayout() {\n+-  if (invalidating_) {\n+-    return;\n+-  }\n+-\n+-  // There is no need to `InvalidateLayout()` when `Widget::IsClosed()`.\n+-  if (Widget* widget = GetWidget(); widget && widget->IsClosed()) {\n+-    return;\n+-  }\n+-\n+-  base::AutoReset<bool> invalidating(&invalidating_, true);\n+   // We should never need to invalidate during a layout call; this tracks\n+   // how many times that is happening.\n+   ++invalidates_during_layout_;\n+@@ -928,11 +918,6 @@ void View::InvalidateLayout() {\n+   // Always invalidate up. This is needed to handle the case of us already being\n+   // valid, but not our parent.\n+   needs_layout_ = true;\n+-\n+-  for (ViewObserver& observer : observers_) {\n+-    observer.OnViewLayoutInvalidated(this);\n+-  }\n+-\n+   if (HasLayoutManager()) {\n+     GetLayoutManager()->InvalidateLayout();\n+   }\n+diff --git a/ui/views/view.h b/ui/views/view.h\n+index ea7d5441dbbfb713a6ffb57bcc07fb55fa574016..54b4c0a2871f214a4806fd863f32b8d010c09058 100644\n+--- a/ui/views/view.h\n++++ b/ui/views/view.h\n+@@ -2343,9 +2343,6 @@ class VIEWS_EXPORT View : public ui::LayerDelegate,\n+   // it is happening.\n+   int invalidates_during_layout_ = 0;\n+ \n+-  // Whether this view is in the middle of InvalidateLayout().\n+-  bool invalidating_ = false;\n+-\n+   // The View's LayoutManager defines the sizing heuristics applied to child\n+   // Views. The default is absolute positioning according to bounds_.\n+   std::unique_ptr<LayoutManager> layout_manager_;\n", "test_patch": "", "problem_statement": "[Bug]: SIGSEGV crash when maximizing window\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n30.0.0-alpha7\r\n\r\n### What operating system are you using?\r\n\r\nUbuntu\r\n\r\n### Operating System Version\r\n\r\n20.04, running on x11\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n30.0.0-alpha6\r\n\r\n### Expected Behavior\r\n\r\nMaximizing/fullscreening the app does not sigfault.\r\n\r\n### Actual Behavior\r\n\r\nMaximizing/fullscreening the window crashes the app.\r\n\r\n### Testcase Gist URL\r\n\r\nThis is visible in the default Fiddle template that opens with the app\r\n\r\n### Additional Information\r\n\r\nThere is no `render-process-gone` or `child-process-gone` event called when it crashes.\r\n\n", "hints_text": "I'm not able to repro this on either `v30.0.0-alpha.7` or `v30.0.0-beta.7`\r\n\r\nTested on Ubuntu 23.10 w/`XDG_SESSION_TYPE=x11`:\r\n\r\n- checked out electron-quick-start\r\n- changed the electron version in package.json\r\n- ran npm install\r\n- confirmed from the command line that `./node_modules/electron/dist/electron --version` yielded the expected version\r\n-  ran npm start\r\n- and hit F11 a few times to toggle back & forth between fullscreen.\r\n\r\nNo crash\r\n\r\n@Kilian I am wondering if I'm testing this wrong since your description sounds straightforward. Any idea what I should change from the above so that I can trigger the crash?\nquick follow-up to previous comment: @Kilian in the video you made for @VerteDinde, it looks like you are clicking the titlebar instead of pressing f11, so I tried again with that to see if it made any difference. FWIW I still am not seeing a crash\nF11 works for me, its the double clicking on the titlebar that causes the crash. So probably WM (I use Mate/Compiz) related.\nTested same setup with ubuntu-mate-desktop 1.291 and compiz 0.9.14.2+22.10.20220822-0ubuntu4, still no crash here.\r\n\r\nMaybe this depends on hw config? I do not have accelerated graphics configured.\nPerhaps a crash dump would be illuminating?\r\n\r\n```js\r\nconst { app, crashReporter } = require('electron')\r\n\r\nconsole.log(app.getPath('crashDumps'))\r\ncrashReporter.start({ submitURL: '', uploadToServer: false })\r\n```\njust checked with 30.0.0, same result. ubuntu-mate-desktop 1.290 (from the ubuntu repo, older than yours) and compiz 0.9.14.2+22.10.20220822-0ubuntu4 (from ubuntu repo too, same as yours)\r\n\r\nWith crashreporter this is the terminal output (dmp file sent to @ckerr)\r\n```\r\n/home/kilian/.config/coherent-help-sigh-y5rzn/Crashpad\r\n[0416/140340.230066:ERROR:elf_dynamic_array_reader.h(64)] tag not found\r\n[0416/140340.230471:ERROR:elf_dynamic_array_reader.h(64)] tag not found\r\n[0416/140340.230807:ERROR:elf_dynamic_array_reader.h(64)] tag not found\r\n\r\nElectron exited with signal SIGSEGV.\r\n```\r\n\r\nSomething that points to it _not_ being WM related is that `mainWindow.maximize();` also causes the same SIGSEGV.\r\n\n<details>\r\n  <summary>Dump</summary>\r\n\r\n```\r\nOperating system: Linux\r\n                  6.2.0 -39-generic #40-Ubuntu SMP PREEMPT_DYNAMIC Tue Nov 14 14:18:00 UTC 2023 x86_64\r\nCPU: amd64\r\n     family 6 model 186 stepping 2\r\n     16 CPUs\r\n\r\nGPU: UNKNOWN\r\n\r\nCrash reason:  SIGSEGV /SEGV_MAPERR\r\nCrash address: 0x120\r\nProcess uptime: 10 seconds\r\n\r\nThread 0 (crashed)\r\n 0  electron!views::View::UpdateChildLayerBounds(views::View::LayerOffsetData const&) [raw_ptr.h : 615 + 0x0]\r\n    rax = 0x0000000000000000   rdx = 0x0000000000000000\r\n    rcx = 0x0000000000000000   rbx = 0x00007fffffa3a5a0\r\n    rsi = 0x00007fffffa3a320   rdi = 0x0000054c001030c0\r\n    rbp = 0x00007fffffa3a580   rsp = 0x00007fffffa3a510\r\n     r8 = 0x00000000000009d8    r9 = 0xffffffff80000dfc\r\n    r10 = 0x0000054c00101aa8   r11 = 0x000000000000056c\r\n    r12 = 0x0000054c006881a8   r13 = 0x0000000000000000\r\n    r14 = 0x00007fffffa3a520   r15 = 0x0000054c01010101\r\n    rip = 0x0000564ed89500ce\r\n    Found by: given as instruction pointer in context\r\n 1  electron!views::View::UpdateChildLayerBounds(views::View::LayerOffsetData const&) [view.cc : 2578 + 0xb]\r\n    rbx = 0x00007fffffa3a6a0   rbp = 0x00007fffffa3a600\r\n    rsp = 0x00007fffffa3a590   r12 = 0x0000054c00e6f390\r\n    r13 = 0x0000054c002dff00   r14 = 0x00007fffffa3a5a0\r\n    r15 = 0x00007fffffa3a5c0   rip = 0x0000564ed89501b7\r\n    Found by: call frame info\r\n 2  electron!views::View::SetBoundsRect(gfx::Rect const&) [view.cc : 449 + 0xb]\r\n    rbx = 0x0000054c000d8700   rbp = 0x00007fffffa3a700\r\n    rsp = 0x00007fffffa3a610   r12 = 0x0000054c000d8850\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a6a0\r\n    r15 = 0x0000054c00101dfe   rip = 0x0000564ed894ef5f\r\n    Found by: call frame info\r\n 3  electron!views::View::SetSize(gfx::Size const&) [view.cc : 401 + 0x5]\r\n    rbx = 0x00007fffffa3a810   rbp = 0x00007fffffa3a720\r\n    rsp = 0x00007fffffa3a710   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016c100\r\n    r15 = 0x0000054c00101d40   rip = 0x0000564ed895042c\r\n    Found by: call frame info\r\n 4  electron!views::Widget::OnNativeWidgetSizeChanged(gfx::Size const&) [widget.cc : 1681 + 0x8]\r\n    rbx = 0x00007fffffa3a810   rbp = 0x00007fffffa3a7f0\r\n    rsp = 0x00007fffffa3a730   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016c100\r\n    r15 = 0x0000054c00101d40   rip = 0x0000564ed896d43e\r\n    Found by: call frame info\r\n 5  electron!non-virtual thunk to views::DesktopNativeWidgetAura::OnHostResized(aura::WindowTreeHost*) [desktop_native_widget_aura.cc : 1476 + 0x9]\r\n    rbx = 0x0000054c001438b0   rbp = 0x00007fffffa3a830\r\n    rsp = 0x00007fffffa3a800   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c001438f8\r\n    r15 = 0x0000054c00101d40   rip = 0x0000564ed89997b7\r\n    Found by: call frame info\r\n 6  electron!aura::WindowTreeHost::OnHostResizedInPixels(gfx::Size const&) [window_tree_host.cc : 605 + 0x8]\r\n    rbx = 0x0000054c00101d40   rbp = 0x00007fffffa3a950\r\n    rsp = 0x00007fffffa3a840   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a8d0\r\n    r15 = 0xaaaaaaaaaaaaaaaa   rip = 0x0000564ed87e8d86\r\n    Found by: call frame info\r\n 7  electron!aura::WindowTreeHostPlatform::OnBoundsChanged(ui::PlatformWindowDelegate::BoundsChange const&) [window_tree_host_platform.cc : 255 + 0x8]\r\n    rbx = 0x0000054c00101d40   rbp = 0x00007fffffa3aa00\r\n    rsp = 0x00007fffffa3a960   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3aa3c\r\n    r15 = 0x00007fffffa3a900   rip = 0x0000564ed87eaaed\r\n    Found by: call frame info\r\n 8  electron!electron::ElectronDesktopWindowTreeHostLinux::OnBoundsChanged(ui::PlatformWindowDelegate::BoundsChange const&) [electron_desktop_window_tree_host_linux.cc : 50 + 0x5]\r\n    rbx = 0x0000054c00101d40   rbp = 0x00007fffffa3aa20\r\n    rsp = 0x00007fffffa3aa10   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016bc00\r\n    r15 = 0x0000054c0016be00   rip = 0x0000564ed36e8e9e\r\n    Found by: call frame info\r\n 9  electron!ui::X11Window::DelayedResize(bool) [x11_window.cc : 2670 + 0x6]\r\n    rbx = 0x0000000000000001   rbp = 0x00007fffffa3aa60\r\n    rsp = 0x00007fffffa3aa30   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x0000054c0016bc00\r\n    r15 = 0x0000054c0016be00   rip = 0x0000564ed412cdf3\r\n    Found by: call frame info\r\n10  electron!void base::internal::CancelableCallbackImpl<base::OnceCallback<void ()>>::ForwardOnce<>() [callback.h : 156 + 0x3]\r\n    rbx = 0x0000054c0016be00   rbp = 0x00007fffffa3aa90\r\n    rsp = 0x00007fffffa3aa70   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3aa78\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed38d7950\r\n    Found by: call frame info\r\n11  electron!base::TaskAnnotator::RunTaskImpl(base::PendingTask&) [callback.h : 156 + 0x3]\r\n    rbx = 0x0000054c01044000   rbp = 0x00007fffffa3ab20\r\n    rsp = 0x00007fffffa3aaa0   r12 = 0x00007fb2a1f12e28\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3aae8\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed6dffb4f\r\n    Found by: call frame info\r\n12  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl(base::LazyNow*) [task_annotator.h : 90 + 0x8]\r\n    rbx = 0xaaaaaaaaaaaaaaaa   rbp = 0x00007fffffa3adb0\r\n    rsp = 0x00007fffffa3ab30   r12 = 0x0000054c01044000\r\n    r13 = 0x00002ee400308280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edba62e70   rip = 0x0000564ed6e1c39d\r\n    Found by: call frame info\r\n13  electron!non-virtual thunk to base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork() [thread_controller_with_message_pump_impl.cc : 338 + 0xb]\r\n    rbx = 0x00007fffffa3ae40   rbp = 0x00007fffffa3ae30\r\n    rsp = 0x00007fffffa3adc0   r12 = 0x00002ee400308280\r\n    r13 = 0x00007fffffa3adc0   r14 = 0x00002ee400308368\r\n    r15 = 0x00002ee400308448   rip = 0x0000564ed6e1c98c\r\n    Found by: call frame info\r\n14  electron!base::MessagePumpGlib::Run(base::MessagePump::Delegate*) [message_pump_glib.cc : 694 + 0x8]\r\n    rbx = 0x00002ee40022f2c0   rbp = 0x00007fffffa3aef0\r\n    rsp = 0x00007fffffa3ae40   r12 = 0x00007fffffa3ae60\r\n    r13 = 0x0000000000000001   r14 = 0x0000000000000001\r\n    r15 = 0x00007fffffa3ae40   rip = 0x0000564ed6e7efd1\r\n    Found by: call frame info\r\n15  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee400308280   rbp = 0x00007fffffa3af40\r\n    rsp = 0x00007fffffa3af00   r12 = 0x00002ee400308298\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee4003084a8   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n16  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x0000054c01018870   rbp = 0x00007fffffa3b020\r\n    rsp = 0x00007fffffa3af50   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b270   r14 = 0x00007fffffa3afa0\r\n    r15 = 0x00007fffffa3b038   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n17  electron!content::BrowserMainLoop::RunMainMessageLoop() [browser_main_loop.cc : 1104 + 0x2a]\r\n    rbx = 0x00007fffffa3b038   rbp = 0x00007fffffa3b070\r\n    rsp = 0x00007fffffa3b030   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x0000054c01018870\r\n    r15 = 0x00007fffffa3b0a0   rip = 0x0000564ed5df70ff\r\n    Found by: call frame info\r\n18  electron!content::BrowserMainRunnerImpl::Run() [browser_main_runner_impl.cc : 159 + 0x5]\r\n    rbx = 0x0000054c00010330   rbp = 0x00007fffffa3b090\r\n    rsp = 0x00007fffffa3b080   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x0000054c00010330\r\n    r15 = 0x00007fffffa3b0a0   rip = 0x0000564ed5df8f52\r\n    Found by: call frame info\r\n19  electron!content::BrowserMain(content::MainFunctionParams) [browser_main.cc : 34 + 0x5]\r\n    rbx = 0x00000000ffffffff   rbp = 0x00007fffffa3b100\r\n    rsp = 0x00007fffffa3b0a0   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x0000054c00010330\r\n    r15 = 0x00007fffffa3b0a0   rip = 0x0000564ed5df45a9\r\n    Found by: call frame info\r\n20  electron!content::RunBrowserProcessMain(content::MainFunctionParams, content::ContentMainDelegate*) [content_main_runner_impl.cc : 712 + 0x8]\r\n    rbx = 0x00007fffffa3b720   rbp = 0x00007fffffa3b200\r\n    rsp = 0x00007fffffa3b110   r12 = 0x00007fffffa3b110\r\n    r13 = 0x00007fffffa3b270   r14 = 0x00007fffffa3b148\r\n    r15 = 0x00007fffffa3b180   rip = 0x0000564ed384c274\r\n    Found by: call frame info\r\n21  electron!content::ContentMainRunnerImpl::RunBrowser(content::MainFunctionParams, bool) [content_main_runner_impl.cc : 1303 + 0x8]\r\n    rbx = 0x00002ee4002a38e0   rbp = 0x00007fffffa3b2f0\r\n    rsp = 0x00007fffffa3b210   r12 = 0x00000000ffffffff\r\n    r13 = 0x00007fffffa3b270   r14 = 0x00007fffffa3b300\r\n    r15 = 0x00007fffffa3b218   rip = 0x0000564ed384da6e\r\n    Found by: call frame info\r\n22  electron!content::ContentMainRunnerImpl::Run() [content_main_runner_impl.cc : 1148 + 0xf]\r\n    rbx = 0x00002ee4002a38e0   rbp = 0x00007fffffa3b410\r\n    rsp = 0x00007fffffa3b300   r12 = 0x00007fffffa3b3d0\r\n    r13 = 0xaaaaaaaaaaaaaaaa   r14 = 0x00007fffffa3b300\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed384d886\r\n    Found by: call frame info\r\n23  electron!content::RunContentProcess(content::ContentMainParams, content::ContentMainRunner*) [content_main.cc : 331 + 0x8]\r\n    rbx = 0x00002ee4002a38e0   rbp = 0x00007fffffa3b670\r\n    rsp = 0x00007fffffa3b420   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b610   r14 = 0x0000000000000000\r\n    r15 = 0x00007fffffa3b4a1   rip = 0x0000564ed384b24b\r\n    Found by: call frame info\r\n24  electron!content::ContentMain(content::ContentMainParams) [content_main.cc : 344 + 0x8]\r\n    rbx = 0x00007fffffa3b6f0   rbp = 0x00007fffffa3b6e0\r\n    rsp = 0x00007fffffa3b680   r12 = 0x00007fffffa3b6a8\r\n    r13 = 0x00007fffffa3b900   r14 = 0x00007fffffa3b6a0\r\n    r15 = 0x00007fffffa3b688   rip = 0x0000564ed384b350\r\n    Found by: call frame info\r\n25  electron!main [electron_main_linux.cc : 45 + 0x8]\r\n    rbx = 0x00007fffffa3b8d8   rbp = 0x00007fffffa3b7c0\r\n    rsp = 0x00007fffffa3b6f0   r12 = 0x00007fffffa3b770\r\n    r13 = 0x00007fffffa3b900   r14 = 0x00007fffffa3b770\r\n    r15 = 0x00007fffffa3b6f0   rip = 0x0000564ed3531928\r\n    Found by: call frame info\r\n26  libc.so.6!__libc_start_call_main [libc_start_call_main.h : 58 + 0x1a]\r\n    rbx = 0x00007fffffa3b8d8   rbp = 0x0000000000000004\r\n    rsp = 0x00007fffffa3b7d0   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b900   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb2a5135000   rip = 0x00007fb2a3223a90\r\n    Found by: call frame info\r\n27  libc.so.6!__libc_start_main_alias_2 [libc-start.c : 360 + 0xe]\r\n    rbx = 0x00007fffffa3b8d8   rbp = 0x0000000000000004\r\n    rsp = 0x00007fffffa3b870   r12 = 0x0000000000000000\r\n    r13 = 0x00007fffffa3b900   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb2a5135000   rip = 0x00007fb2a3223b49\r\n    Found by: call frame info\r\n28  electron!_start + 0x2a\r\n    rbx = 0x0000000000000000   rbp = 0x0000000000000000\r\n    rsp = 0x00007fffffa3b8c0   r12 = 0x0000564ed3126000\r\n    r13 = 0x00007fffffa3b8d0   r14 = 0x0000000000000000\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed312602a\r\n    Found by: call frame info\r\n29  0x7fffffa3b8c8\r\n    rbx = 0x0000000000000000   rbp = 0x0000000000000000\r\n    rsp = 0x00007fffffa3b8c8   r12 = 0x0000564ed3126000\r\n    r13 = 0x00007fffffa3b8d0   r14 = 0x0000000000000000\r\n    r15 = 0x0000000000000000   rip = 0x00007fffffa3b8c8\r\n    Found by: call frame info\r\n\r\nThread 1\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x00002ee400234770\r\n    rsi = 0x0000000000000002   rdi = 0x00007fb2a09fe4d0\r\n    rbp = 0x00007fb2a09fe510   rsp = 0x00007fb2a09fe360\r\n     r8 = 0x0000000000000000    r9 = 0x0000564edbb0fe00\r\n    r10 = 0x0000000000000010   r11 = 0x0000000000000293\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb2a09fe398\r\n    r14 = 0x00007fb2a09fe4d0   r15 = 0x0000564ed1fcebbc\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  electron!content::SandboxIPCHandler::Run() [sandbox_ipc_linux.cc : 46 + 0x12]\r\n    rbx = 0x00002ee400234770   rbp = 0x00007fb2a09fe510\r\n    rsp = 0x00007fb2a09fe390   r12 = 0x0000000000000000\r\n    r13 = 0x00007fb2a09fe398   r14 = 0x00007fb2a09fe4d0\r\n    r15 = 0x0000564ed1fcebbc   rip = 0x0000564ed64862f0\r\n    Found by: call frame info\r\n 2  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb2a09ff6c0   rbp = 0x00007fb2a09fe550\r\n    rsp = 0x00007fb2a09fe520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a09ff258   r14 = 0x00002ee4002224c0\r\n    r15 = 0x00007fb2a09ff6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 3  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a09ffcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a09fe560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3adb0\r\n    r15 = 0x00007fb2a01ff000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 4  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a09fe600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3adb0\r\n    r15 = 0x00007fb2a01ff000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 2\r\n 0  libc.so.6!__GI___wait4 [wait4.c : 30 + 0x26]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a32e1a57   rbx = 0x00007fb2a01fd4b8\r\n    rsi = 0x00007fb2a01fd4b8   rdi = 0x00000000001b49b8\r\n    rbp = 0x00007fb2a01fd4f0   rsp = 0x00007fb2a01fd450\r\n     r8 = 0x0000000000000000    r9 = 0x0ccccccccccccccc\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000293\r\n    r12 = 0x0000000000000000   r13 = 0x8000000000000001\r\n    r14 = 0x7fffffffffffffff   r15 = 0x00000000001b49b8\r\n    rip = 0x00007fb2a32e1a57\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::Process::WaitForExitWithTimeout(base::TimeDelta, int*) const [process_posix.cc : 64 + 0xd]\r\n    rbx = 0x00007fb2a01fd4b8   rbp = 0x00007fb2a01fd4f0\r\n    rsp = 0x00007fb2a01fd480   r12 = 0x0000000000000000\r\n    r13 = 0x8000000000000001   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000001b49b8   rip = 0x0000564ed6e6ec00\r\n    Found by: call frame info\r\n 2  electron!base::(anonymous namespace)::BackgroundReaper::ThreadMain() [kill_posix.cc : 139 + 0x7]\r\n    rbx = 0x00002ee4002a4960   rbp = 0x00007fb2a01fd510\r\n    rsp = 0x00007fb2a01fd500   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a01fe258   r14 = 0x00002ee4002a4960\r\n    r15 = 0x00007fb2a01fe6c0   rip = 0x0000564ed6e70620\r\n    Found by: call frame info\r\n 3  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb2a01fe6c0   rbp = 0x00007fb2a01fd550\r\n    rsp = 0x00007fb2a01fd520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a01fe258   r14 = 0x00002ee4002a4960\r\n    r15 = 0x00007fb2a01fe6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a01fecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a01fd560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3aa00\r\n    r15 = 0x00007fb29f9fe000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a01fd600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3aa00\r\n    r15 = 0x00007fb29f9fe000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 3\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb29f9fc0d0   rdi = 0x0000000000000019\r\n    rbp = 0x00007fb29f9fc2a0   rsp = 0x00007fb29f9fc060\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000000\r\n    r10 = 0x0000000000005c04   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb29f9fc2b0   r13 = 0x0000000001676d87\r\n    r14 = 0x00002ee400222c40   r15 = 0x00007fb29f9fc0d0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29f9fc2a0\r\n    rsp = 0x00007fb29f9fc090   r12 = 0x00007fb29f9fc2b0\r\n    r13 = 0x0000000001676d87   r14 = 0x00002ee400222c40\r\n    r15 = 0x00007fb29f9fc0d0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29f9fc320\r\n    rsp = 0x00007fb29f9fc2b0   r12 = 0x00007fb29f9fc2b0\r\n    r13 = 0x0000000001676d87   r14 = 0x00002ee40030c468\r\n    r15 = 0x00002ee400222c40   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee40030c380   rbp = 0x00007fb29f9fc370\r\n    rsp = 0x00007fb29f9fc330   r12 = 0x00002ee40030c398\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee40030c5a8   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb29f9fc4c0   rbp = 0x00007fb29f9fc450\r\n    rsp = 0x00007fb29f9fc380   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29f9fc3d0\r\n    r15 = 0x00007fb29f9fc460   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb29f9fc4c0   rbp = 0x00007fb29f9fc490\r\n    rsp = 0x00007fb29f9fc460   r12 = 0x00007fb29f9fc4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29f9fc460\r\n    r15 = 0x00002ee4002fc050   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!base::internal::ServiceThread::Run(base::RunLoop*) [service_thread.cc : 15 + 0x5]\r\n    rbx = 0x00002ee4002fc040   rbp = 0x00007fb29f9fc4b0\r\n    rsp = 0x00007fb29f9fc4a0   r12 = 0x00007fb29f9fc4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00002ee4002a51a0\r\n    r15 = 0x00002ee4002fc050   rip = 0x0000564ed6e2a89d\r\n    Found by: call frame info\r\n 7  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x00002ee4002fc040   rbp = 0x00007fb29f9fc510\r\n    rsp = 0x00007fb29f9fc4c0   r12 = 0x00007fb29f9fc4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00002ee4002a51a0\r\n    r15 = 0x00002ee4002fc050   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 8  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29f9fd6c0   rbp = 0x00007fb29f9fc550\r\n    rsp = 0x00007fb29f9fc520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f9fd258   r14 = 0x00002ee4002fc040\r\n    r15 = 0x00007fb29f9fd6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 9  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29f9fdcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f9fc560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac20\r\n    r15 = 0x00007fb29f1fd000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n10  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f9fc600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac20\r\n    r15 = 0x00007fb29f1fd000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 4\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29f1fb2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29f1fb2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29f1fb0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29f1fb1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29f1fb2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29f1fb2a8   rbp = 0x00007fb29f1fb2cc\r\n    rsp = 0x00007fb29f1fb0e0   r12 = 0x00007fb29f1fb280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29f1fb2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29f1fb2a8   rbp = 0x00007fb29f1fb250\r\n    rsp = 0x00007fb29f1fb1b0   r12 = 0x00007fb29f1fb1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137c6\r\n    r15 = 0x0000000000000de9   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee400222b08   rbp = 0x00007fb29f1fb320\r\n    rsp = 0x00007fb29f1fb260   r12 = 0x00007fb29f1fb268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x000000129548fd83\r\n    r15 = 0x000000000394f000   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee400222b08   rbp = 0x00007fb29f1fb3b0\r\n    rsp = 0x00007fb29f1fb330   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x000000000394f045\r\n    r15 = 0x000000000394f045   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee400222af8   rbp = 0x00007fb29f1fb3c0\r\n    rsp = 0x00007fb29f1fb3c0   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x000000000394f045   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee400222af8   rbp = 0x00007fb29f1fb3f0\r\n    rsp = 0x00007fb29f1fb3d0   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x000000000394f045   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b480   rbp = 0x00007fb29f1fb4c0\r\n    rsp = 0x00007fb29f1fb400   r12 = 0x00007fb29f1fb420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb29f1fb410\r\n    r15 = 0x00007fb29f1fb450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x00002ee40026b480   rbp = 0x00007fb29f1fb4e0\r\n    rsp = 0x00007fb29f1fb4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f1fc258   r14 = 0x00002ee40026b480\r\n    r15 = 0x00007fb29f1fc6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x00002ee40026b480   rbp = 0x00007fb29f1fb510\r\n    rsp = 0x00007fb29f1fb4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f1fc258   r14 = 0x00002ee40026b480\r\n    r15 = 0x00007fb29f1fc6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29f1fc6c0   rbp = 0x00007fb29f1fb550\r\n    rsp = 0x00007fb29f1fb520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29f1fc258   r14 = 0x00002ee40026b480\r\n    r15 = 0x00007fb29f1fc6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29f1fccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f1fb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ab10\r\n    r15 = 0x00007fb29e9fc000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29f1fb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ab10\r\n    r15 = 0x00007fb29e9fc000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 5\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29e9fa2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29e9fa2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29e9fa0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29e9fa1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29e9fa2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29e9fa2a8   rbp = 0x00007fb29e9fa2cc\r\n    rsp = 0x00007fb29e9fa0e0   r12 = 0x00007fb29e9fa280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29e9fa2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29e9fa2a8   rbp = 0x00007fb29e9fa250\r\n    rsp = 0x00007fb29e9fa1b0   r12 = 0x00007fb29e9fa1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x000000000000033f   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee40029c8d0   rbp = 0x00007fb29e9fa320\r\n    rsp = 0x00007fb29e9fa260   r12 = 0x00007fb29e9fa268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19a00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee40029c8d0   rbp = 0x00007fb29e9fa3b0\r\n    rsp = 0x00007fb29e9fa330   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a19a51\r\n    r15 = 0x0000000003a19a51   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee40029c8c0   rbp = 0x00007fb29e9fa3c0\r\n    rsp = 0x00007fb29e9fa3c0   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19a51   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee40029c8c0   rbp = 0x00007fb29e9fa3f0\r\n    rsp = 0x00007fb29e9fa3d0   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19a51   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b520   rbp = 0x00007fb29e9fa4c0\r\n    rsp = 0x00007fb29e9fa400   r12 = 0x00007fb29e9fa420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb29e9fa410\r\n    r15 = 0x00007fb29e9fa450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunSharedWorker() [worker_thread.cc : 332 + 0x5]\r\n    rbx = 0x00002ee40026b520   rbp = 0x00007fb29e9fa4e0\r\n    rsp = 0x00007fb29e9fa4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e9fb258   r14 = 0x00002ee40026b520\r\n    r15 = 0x00007fb29e9fb6c0   rip = 0x0000564ed6e3a28d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 305 + 0x8]\r\n    rbx = 0x00002ee40026b520   rbp = 0x00007fb29e9fa510\r\n    rsp = 0x00007fb29e9fa4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e9fb258   r14 = 0x00002ee40026b520\r\n    r15 = 0x00007fb29e9fb6c0   rip = 0x0000564ed6e3a181\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29e9fb6c0   rbp = 0x00007fb29e9fa550\r\n    rsp = 0x00007fb29e9fa520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e9fb258   r14 = 0x00002ee40026b520\r\n    r15 = 0x00007fb29e9fb6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29e9fbcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e9fa560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3abf0\r\n    r15 = 0x00007fb29e1fb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e9fa600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3abf0\r\n    r15 = 0x00007fb29e1fb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 6\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29e1f92a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29e1f92d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29e1f90a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29e1f91c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29e1f92d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29e1f92a8   rbp = 0x00007fb29e1f92cc\r\n    rsp = 0x00007fb29e1f90e0   r12 = 0x00007fb29e1f9280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29e1f92d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29e1f92a8   rbp = 0x00007fb29e1f9250\r\n    rsp = 0x00007fb29e1f91b0   r12 = 0x00007fb29e1f91b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x0000000000000342   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee400222bc8   rbp = 0x00007fb29e1f9320\r\n    rsp = 0x00007fb29e1f9260   r12 = 0x00007fb29e1f9268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a15a00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee400222bc8   rbp = 0x00007fb29e1f93b0\r\n    rsp = 0x00007fb29e1f9330   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a15af5\r\n    r15 = 0x0000000003a15af5   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee400222bb8   rbp = 0x00007fb29e1f93c0\r\n    rsp = 0x00007fb29e1f93c0   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a15af5   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee400222bb8   rbp = 0x00007fb29e1f93f0\r\n    rsp = 0x00007fb29e1f93d0   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a15af5   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b5c0   rbp = 0x00007fb29e1f94c0\r\n    rsp = 0x00007fb29e1f9400   r12 = 0x00007fb29e1f9420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb29e1f9410\r\n    r15 = 0x00007fb29e1f9450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x00002ee40026b5c0   rbp = 0x00007fb29e1f94e0\r\n    rsp = 0x00007fb29e1f94d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e1fa258   r14 = 0x00002ee40026b5c0\r\n    r15 = 0x00007fb29e1fa6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x00002ee40026b5c0   rbp = 0x00007fb29e1f9510\r\n    rsp = 0x00007fb29e1f94f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e1fa258   r14 = 0x00002ee40026b5c0\r\n    r15 = 0x00007fb29e1fa6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29e1fa6c0   rbp = 0x00007fb29e1f9550\r\n    rsp = 0x00007fb29e1f9520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29e1fa258   r14 = 0x00002ee40026b5c0\r\n    r15 = 0x00007fb29e1fa6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29e1facdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e1f9560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb29d9fa000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29e1f9600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb29d9fa000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 7\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29d1f72a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb29d1f72d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29d1f70a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb29d1f71c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb29d1f72d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb29d1f72a8   rbp = 0x00007fb29d1f72cc\r\n    rsp = 0x00007fb29d1f70e0   r12 = 0x00007fb29d1f7280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb29d1f72d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb29d1f72a8   rbp = 0x00007fb29d1f7250\r\n    rsp = 0x00007fb29d1f71b0   r12 = 0x00007fb29d1f71b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x0000000000000414   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x00002ee400222b68   rbp = 0x00007fb29d1f7320\r\n    rsp = 0x00007fb29d1f7260   r12 = 0x00007fb29d1f7268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19e00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x00002ee400222b68   rbp = 0x00007fb29d1f73b0\r\n    rsp = 0x00007fb29d1f7330   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a19e57\r\n    r15 = 0x0000000003a19e57   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x00002ee400222b58   rbp = 0x00007fb29d1f73c0\r\n    rsp = 0x00007fb29d1f73c0   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19e57   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x00002ee400222b58   rbp = 0x00007fb29d1f73f0\r\n    rsp = 0x00007fb29d1f73d0   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a19e57   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x00002ee40026b8e0   rbp = 0x00007fb29d1f74c0\r\n    rsp = 0x00007fb29d1f7400   r12 = 0x00007fb29d1f7420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000000000003\r\n    r15 = 0x00007fb29d1f7450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x00002ee40026b8e0   rbp = 0x00007fb29d1f74e0\r\n    rsp = 0x00007fb29d1f74d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d1f8258   r14 = 0x00002ee40026b8e0\r\n    r15 = 0x00007fb29d1f86c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x00002ee40026b8e0   rbp = 0x00007fb29d1f7510\r\n    rsp = 0x00007fb29d1f74f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d1f8258   r14 = 0x00002ee40026b8e0\r\n    r15 = 0x00007fb29d1f86c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29d1f86c0   rbp = 0x00007fb29d1f7550\r\n    rsp = 0x00007fb29d1f7520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d1f8258   r14 = 0x00002ee40026b8e0\r\n    r15 = 0x00007fb29d1f86c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29d1f8cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d1f7560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fadc0\r\n    r15 = 0x00007fb29c9f8000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d1f7600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fadc0\r\n    r15 = 0x00007fb29c9f8000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 8\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb29d9f80b0   rdi = 0x0000000000000021\r\n    rbp = 0x00007fb29d9f8280   rsp = 0x00007fb29d9f8040\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000000\r\n    r10 = 0x00000000ffffffff   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb29d9f8290   r13 = 0x7fffffffffffffff\r\n    r14 = 0x0000054c00070700   r15 = 0x00007fb29d9f80b0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29d9f8280\r\n    rsp = 0x00007fb29d9f8070   r12 = 0x00007fb29d9f8290\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c00070700\r\n    r15 = 0x00007fb29d9f80b0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb29d9f8300\r\n    rsp = 0x00007fb29d9f8290   r12 = 0x00007fb29d9f8290\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00002ee40030a3e8\r\n    r15 = 0x0000054c00070700   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee40030a300   rbp = 0x00007fb29d9f8350\r\n    rsp = 0x00007fb29d9f8310   r12 = 0x00002ee40030a318\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee40030a528   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb29d9f84c0   rbp = 0x00007fb29d9f8430\r\n    rsp = 0x00007fb29d9f8360   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29d9f83b0\r\n    r15 = 0x00007fb29d9f8440   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb29d9f84c0   rbp = 0x00007fb29d9f8470\r\n    rsp = 0x00007fb29d9f8440   r12 = 0x00007fb29d9f84c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29d9f8440\r\n    r15 = 0x00002ee40029cd30   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!content::BrowserProcessIOThread::IOThreadRun(base::RunLoop*) [browser_process_io_thread.cc : 118 + 0xb]\r\n    rbx = 0x00007fb29d9f84c0   rbp = 0x00007fb29d9f84b0\r\n    rsp = 0x00007fb29d9f8480   r12 = 0x00007fb29d9f84c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00002ee40029cd20\r\n    r15 = 0x00002ee40029cd30   rip = 0x0000564ed5df9bff\r\n    Found by: call frame info\r\n 7  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x00002ee40029cd20   rbp = 0x00007fb29d9f8510\r\n    rsp = 0x00007fb29d9f84c0   r12 = 0x00007fb29d9f84c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000054c00020820\r\n    r15 = 0x00002ee40029cd30   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 8  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29d9f96c0   rbp = 0x00007fb29d9f8550\r\n    rsp = 0x00007fb29d9f8520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29d9f9258   r14 = 0x00002ee40029cd20\r\n    r15 = 0x00007fb29d9f96c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 9  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29d9f9cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d9f8560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac30\r\n    r15 = 0x00007fb29d1f9000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n10  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29d9f8600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac30\r\n    r15 = 0x00007fb29d1f9000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 9\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb29c9f61d8\r\n    rsi = 0x0000000000000189   rdi = 0x00007fb29c9f6200\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29c9f5ff0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb29c9f61b0\r\n    r14 = 0x0000000000000000   r15 = 0x00007fb29c9f6200\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x00007fb29c9f61d8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c9f6030   r12 = 0x00007fb29c9f61fc\r\n    r13 = 0x00007fb29c9f61b0   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb29c9f6200   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::Wait() [condition_variable_posix.cc : 106 + 0x8]\r\n    rbx = 0x00007fb29c9f61d8   rbp = 0x00007fb29c9f6180\r\n    rsp = 0x00007fb29c9f6100   r12 = 0x00007fb29c9f6198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e536e5\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 194 + 0x5]\r\n    rbx = 0x0000054c00010940   rbp = 0x00007fb29c9f6250\r\n    rsp = 0x00007fb29c9f6190   r12 = 0x00007fb29c9f6198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e7b74f\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::Wait() [waitable_event.cc : 39 + 0x8]\r\n    rbx = 0x0000054c00010940   rbp = 0x00007fb29c9f62e0\r\n    rsp = 0x00007fb29c9f6260   r12 = 0x00007fb29c9f62f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00002ee40030cbe8\r\n    r15 = 0x0000054c00010940   rip = 0x0000564ed6dfcd5c\r\n    Found by: call frame info\r\n 8  electron!base::MessagePumpDefault::Run(base::MessagePump::Delegate*) [message_pump_default.cc : 56 + 0x8]\r\n    rbx = 0x0000054c00010930   rbp = 0x00007fb29c9f6340\r\n    rsp = 0x00007fb29c9f62f0   r12 = 0x00007fb29c9f62f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00002ee40030cbe8\r\n    r15 = 0x0000054c00010940   rip = 0x0000564ed6dbbd94\r\n    Found by: call frame info\r\n 9  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x00002ee40030cb00   rbp = 0x00007fb29c9f6390\r\n    rsp = 0x00007fb29c9f6350   r12 = 0x00002ee40030cb18\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x00002ee40030cd28   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n10  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb29c9f64c0   rbp = 0x00007fb29c9f6470\r\n    rsp = 0x00007fb29c9f63a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29c9f63f0\r\n    r15 = 0x00007fb29c9f6480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n11  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb29c9f64c0   rbp = 0x00007fb29c9f64b0\r\n    rsp = 0x00007fb29c9f6480   r12 = 0x00007fb29c9f64c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb29c9f6480\r\n    r15 = 0x00002ee400241210   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n12  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x00002ee400241200   rbp = 0x00007fb29c9f6510\r\n    rsp = 0x00007fb29c9f64c0   r12 = 0x00007fb29c9f64c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000000000000000\r\n    r15 = 0x00002ee400241210   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb29c9f76c0   rbp = 0x00007fb29c9f6550\r\n    rsp = 0x00007fb29c9f6520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb29c9f7258   r14 = 0x00002ee400241200\r\n    r15 = 0x00007fb29c9f76c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29c9f7cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c9f6560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac10\r\n    r15 = 0x00007fb29c1f7000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c9f6600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa3ac10\r\n    r15 = 0x00007fb29c1f7000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 10\r\n 0  libc.so.6!__GI_epoll_pwait [epoll_pwait.c : 40 + 0x2f]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000400\r\n    rcx = 0x00007fb2a331e3c6   rbx = 0x0000000000000030\r\n    rsi = 0x00007fb29c1f1720   rdi = 0x0000000000000030\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29c1f16e0\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000008\r\n    r10 = 0x0000000000003a92   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00099000   r13 = 0x0000054c000990c8\r\n    r14 = 0x00007fb29c1f4720   r15 = 0x0000000000000030\r\n    rip = 0x00007fb2a331e3c6\r\n    Found by: given as instruction pointer in context\r\n 1  electron!uv__io_poll [linux.c : 1368 + 0x1a]\r\n    rbx = 0x0000000000000030   rbp = 0x00007fb29c1f5490\r\n    rsp = 0x00007fb29c1f1710   r12 = 0x0000054c00099000\r\n    r13 = 0x0000054c000990c8   r14 = 0x00007fb29c1f4720\r\n    r15 = 0x0000000000000030   rip = 0x0000564ed352ed99\r\n    Found by: call frame info\r\n 2  electron!uv_run [core.c : 447 + 0x8]\r\n    rbx = 0x0000054c000dc5e8   rbp = 0x00007fb29c1f5500\r\n    rsp = 0x00007fb29c1f54a0   r12 = 0x0000000000000000\r\n    r13 = 0x0000054c000dc630   r14 = 0x00007fb29c1f54c0\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed351e725\r\n    Found by: call frame info\r\n 3  electron!node::WorkerThreadsTaskRunner::DelayedTaskScheduler::Run() [node_platform.cc : 95 + 0xa]\r\n    rbx = 0x0000054c000dc500   rbp = 0x00007fb29c1f5550\r\n    rsp = 0x00007fb29c1f5510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x0000054c000dc5e8\r\n    r15 = 0x00007fb29b9f6000   rip = 0x0000564edb1328ec\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29c1f6cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c1f5560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b9f6000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29c1f5600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b9f6000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 11\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c000c0040\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c000c006c\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29b9f43d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c000c0018\r\n    r14 = 0x0000000000000004   r15 = 0x0000054c000c006c\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c000c0040   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b9f4410   r12 = 0x0000054c000c0064\r\n    r13 = 0x0000054c000c0018   r14 = 0x0000000000000004\r\n    r15 = 0x0000054c000c006c   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000054c00010ea0   rbp = 0x00007fb29b9f44e0\r\n    rsp = 0x00007fb29b9f44e0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c0064d4c0   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!node::(anonymous namespace)::PlatformWorkerThread(void*) [node_mutex.h : 175 + 0xb]\r\n    rbx = 0x0000054c00010ea0   rbp = 0x00007fb29b9f4550\r\n    rsp = 0x00007fb29b9f44f0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c0064d4c0   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564edb13074c\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29b9f5cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b9f4560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b1f5000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b9f4600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29b1f5000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 12\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c000c0040\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c000c006c\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29b1f33d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c000c0018\r\n    r14 = 0x0000000000000004   r15 = 0x0000054c000c006c\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c000c0040   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b1f3410   r12 = 0x0000054c000c0064\r\n    r13 = 0x0000054c000c0018   r14 = 0x0000000000000004\r\n    r15 = 0x0000054c000c006c   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000054c00010e70   rbp = 0x00007fb29b1f34e0\r\n    rsp = 0x00007fb29b1f34e0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e1f120   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!node::(anonymous namespace)::PlatformWorkerThread(void*) [node_mutex.h : 175 + 0xb]\r\n    rbx = 0x0000054c00010e70   rbp = 0x00007fb29b1f3550\r\n    rsp = 0x00007fb29b1f34f0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e1f120   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564edb13074c\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29b1f4cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b1f3560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a9f4000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29b1f3600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a9f4000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 13\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c000c0040\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c000c0068\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb29a9f23d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c000c0018\r\n    r14 = 0x0000000000000000   r15 = 0x0000054c000c0068\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c000c0040   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29a9f2410   r12 = 0x0000054c000c0064\r\n    r13 = 0x0000054c000c0018   r14 = 0x0000000000000000\r\n    r15 = 0x0000054c000c0068   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000054c00010e10   rbp = 0x00007fb29a9f24e0\r\n    rsp = 0x00007fb29a9f24e0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e2bd80   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!node::(anonymous namespace)::PlatformWorkerThread(void*) [node_mutex.h : 175 + 0xb]\r\n    rbx = 0x0000054c00010e10   rbp = 0x00007fb29a9f2550\r\n    rsp = 0x00007fb29a9f24f0   r12 = 0x0000054c000c00a8\r\n    r13 = 0x0000054c00e2bd80   r14 = 0x0000054c000c0018\r\n    r15 = 0x0000054c000c0040   rip = 0x0000564edb13074c\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb29a9f3cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29a9f2560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a1f3000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb29a9f2600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000d   r14 = 0x00007fffffa3aa70\r\n    r15 = 0x00007fb29a1f3000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 14\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbbf1558\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbbf1558\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2a50f5490\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000019\r\n    r14 = 0x0000564edbbf14a8   r15 = 0x00007fb2a50ee000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__new_sem_wait_slow64 [sem_waitcommon.c : 183 + 0x8]\r\n    rbx = 0x0000564edbbf1558   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a50f54d0   r12 = 0x00007fb2a50f54d0\r\n    r13 = 0x0000000000000019   r14 = 0x0000564edbbf14a8\r\n    r15 = 0x00007fb2a50ee000   rip = 0x00007fb2a32976d0\r\n    Found by: call frame info\r\n 4  electron!uv_sem_wait [thread.c : 639 + 0x8]\r\n    rbx = 0x0000564edbbf1558   rbp = 0x00007fb2a50f5530\r\n    rsp = 0x00007fb2a50f5520   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x0000564edbbf14a8\r\n    r15 = 0x00007fb2a50ee000   rip = 0x0000564ed352a276\r\n    Found by: call frame info\r\n 5  electron!node::inspector::(anonymous namespace)::StartIoThreadMain(void*) [inspector_agent.cc : 85 + 0x8]\r\n    rbx = 0x0000564edbbf1558   rbp = 0x00007fb2a50f5550\r\n    rsp = 0x00007fb2a50f5540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x0000564edbbf14a8\r\n    r15 = 0x00007fb2a50ee000   rip = 0x0000564edb1e8fac\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a50f6cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a50f5560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x00007fffffa3a6d0\r\n    r15 = 0x00007fb2a50ee000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a50f5600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000019   r14 = 0x00007fffffa3a6d0\r\n    r15 = 0x00007fb2a50ee000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 15\r\n 0  libc.so.6!__GI_epoll_pwait [epoll_pwait.c : 40 + 0x2f]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000400\r\n    rcx = 0x00007fb2a331e3c6   rbx = 0x0000000000000038\r\n    rsi = 0x00007fb2151ea1c0   rdi = 0x0000000000000038\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2151ea180\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000008\r\n    r10 = 0x00000000ffffffff   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00099800   r13 = 0x0000054c000998c8\r\n    r14 = 0x00007fb2151ed1c0   r15 = 0x0000000000000038\r\n    rip = 0x00007fb2a331e3c6\r\n    Found by: given as instruction pointer in context\r\n 1  electron!uv__io_poll [linux.c : 1368 + 0x1a]\r\n    rbx = 0x0000000000000038   rbp = 0x00007fb2151edf30\r\n    rsp = 0x00007fb2151ea1b0   r12 = 0x0000054c00099800\r\n    r13 = 0x0000054c000998c8   r14 = 0x00007fb2151ed1c0\r\n    r15 = 0x0000000000000038   rip = 0x0000564ed352ed99\r\n    Found by: call frame info\r\n 2  electron!uv_run [core.c : 447 + 0x8]\r\n    rbx = 0x00007fb2151edfc0   rbp = 0x00007fb2151edfa0\r\n    rsp = 0x00007fb2151edf40   r12 = 0x0000054c00070f00\r\n    r13 = 0x00007fb2151ee008   r14 = 0x00007fb2151edf60\r\n    r15 = 0x0000000000000000   rip = 0x0000564ed351e725\r\n    Found by: call frame info\r\n 3  electron!node::inspector::InspectorIo::ThreadMain() [inspector_io.cc : 318 + 0xa]\r\n    rbx = 0x00007fb2151edfc0   rbp = 0x00007fb2151ee550\r\n    rsp = 0x00007fb2151edfb0   r12 = 0x0000054c00070fd8\r\n    r13 = 0x0000054c00070fd8   r14 = 0x0000054c00015ff0\r\n    r15 = 0x0000054c00070fc0   rip = 0x0000564edb1eced8\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2151efcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2151ee560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a3e0\r\n    r15 = 0x00007fb2149ef000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2151ee600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa3a3e0\r\n    r15 = 0x00007fb2149ef000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 16\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d4\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2149ed400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000004   r15 = 0x0000564edbac02d4\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2149ed440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000004\r\n    r15 = 0x0000564edbac02d4   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2149ed510\r\n    rsp = 0x00007fb2149ed510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2149ed550\r\n    rsp = 0x00007fb2149ed520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2149eecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2149ed560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2141ee000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2149ed600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2141ee000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 17\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2141ec400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000000   r15 = 0x0000564edbac02d0\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2141ec440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edbac02d0   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2141ec510\r\n    rsp = 0x00007fb2141ec510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2141ec550\r\n    rsp = 0x00007fb2141ec520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2141edcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2141ec560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2139ed000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2141ec600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2139ed000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 18\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2139eb400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000000   r15 = 0x0000564edbac02d0\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2139eb440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edbac02d0   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2139eb510\r\n    rsp = 0x00007fb2139eb510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2139eb550\r\n    rsp = 0x00007fb2139eb520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2139eccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2139eb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2131ec000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2139eb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2131ec000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 19\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000564edbac02a8\r\n    rsi = 0x0000000000000189   rdi = 0x0000564edbac02d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb2131ea400\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000564edbac0280\r\n    r14 = 0x0000000000000000   r15 = 0x0000564edbac02d0\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000564edbac02a8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2131ea440   r12 = 0x0000564edbac02cc\r\n    r13 = 0x0000564edbac0280   r14 = 0x0000000000000000\r\n    r15 = 0x0000564edbac02d0   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!uv_cond_wait [thread.c : 793 + 0x5]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2131ea510\r\n    rsp = 0x00007fb2131ea510   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed352a449\r\n    Found by: call frame info\r\n 6  electron!worker [threadpool.c : 76 + 0xb]\r\n    rbx = 0x0000564edbac0280   rbp = 0x00007fb2131ea550\r\n    rsp = 0x00007fb2131ea520   r12 = 0x0000564edbac0300\r\n    r13 = 0x0000000000000000   r14 = 0x0000564edbac02a8\r\n    r15 = 0x0000564edbac0300   rip = 0x0000564ed351acc3\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2131ebcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2131ea560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2129eb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2131ea600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39680\r\n    r15 = 0x00007fb2129eb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 20\r\n 0  libc.so.6!syscall [syscall.S : 38 + 0x0]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000002\r\n    rcx = 0x00007fb2a3315ded   rbx = 0x0000054c002345a0\r\n    rsi = 0x0000000000000080   rdi = 0x0000054c002345b0\r\n    rbp = 0x00007fb2103ff1c8   rsp = 0x00007fb2103fe468\r\n     r8 = 0x00007fb2103fe3f0    r9 = 0x0000054c002345a0\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000002   r13 = 0x0000054c002345b0\r\n    r14 = 0x0000000000000000   r15 = 0x00007fb2a478290c\r\n    rip = 0x00007fb2a3315ded\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_cond_wait [gthread-posix.c : 1475 + 0x25]\r\n    rbx = 0x0000054c002345a0   rbp = 0x00007fb2103ff1c8\r\n    rsp = 0x00007fb2103fe470   r12 = 0x0000000000000002\r\n    r13 = 0x0000054c002345b0   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb2a478290c   rip = 0x00007fb2a4768a74\r\n    Found by: call frame info\r\n 2  libglib-2.0.so.0!g_async_queue_pop_intern_unlocked [gasyncqueue.c : 425 + 0xb]\r\n    rbx = 0x0000054c002345a0   rbp = 0xffffffffffffffff\r\n    rsp = 0x00007fb2103fe4a0   r12 = 0x0000054c002345b8\r\n    r13 = 0x0000000000000001   r14 = 0x0000054c002345a8\r\n    r15 = 0x00007fb2a478290c   rip = 0x00007fb2a46dfb2b\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_thread_pool_spawn_thread [gthreadpool.c : 311 + 0xc]\r\n    rbx = 0x00007fffffa39690   rbp = 0x00007fb2103fe4e0\r\n    rsp = 0x00007fb2103fe4d0   r12 = 0x00007fb2a47fef40\r\n    r13 = 0x00007fb2a4745400   r14 = 0x00007fb2103fe4d8\r\n    r15 = 0x00007fb2a478290c   rip = 0x00007fb2a4744baa\r\n    Found by: call frame info\r\n 4  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00700c60   rbp = 0x0000054c00709fe0\r\n    rsp = 0x00007fb2103fe540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39bd0\r\n    r15 = 0x00007fb20fbff000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 5  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2103ffcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2103fe560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39bd0\r\n    r15 = 0x00007fb20fbff000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 6  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2103fe600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39bd0\r\n    r15 = 0x00007fb20fbff000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 21\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x0000000000000001\r\n    rsi = 0x0000000000000001   rdi = 0x0000054c00632c80\r\n    rbp = 0x0000054c0004ac40   rsp = 0x00007fb20fbfd480\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000001\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00632c80   r13 = 0x00007fb2a47211c0\r\n    r14 = 0x00000000ffffffff   r15 = 0x0000000000000001\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_main_context_poll [gmain.c : 4584 + 0xa]\r\n \r\n    Found by: inline record\r\n 2  libglib-2.0.so.0!g_main_context_iterate [gmain.c : 4271 + 0xb]\r\n    rbx = 0x0000000000000001   rbp = 0x0000054c0004ac40\r\n    rsp = 0x00007fb20fbfd4b0   r12 = 0x0000054c00632c80\r\n    r13 = 0x00007fb2a47211c0   r14 = 0x00000000ffffffff\r\n    r15 = 0x0000000000000001   rip = 0x00007fb2a476f26e\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_main_context_iteration [gmain.c : 4343 + 0x14]\r\n    rbx = 0x0000054c0004ac40   rbp = 0x0000000000000001\r\n    rsp = 0x00007fb20fbfd510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a4713220\r\n    Found by: call frame info\r\n 4  libglib-2.0.so.0!glib_worker_main [gmain.c : 6455 + 0x11]\r\n    rbx = 0x00007fb2a47feb48   rbp = 0x0000054c00632c80\r\n    rsp = 0x00007fb20fbfd530   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a4713271\r\n    Found by: call frame info\r\n 5  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00701800   rbp = 0x0000054c00632c80\r\n    rsp = 0x00007fb20fbfd540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20fbfecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20fbfd560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20fbfd600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20f3fe000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 22\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x0000000000000002\r\n    rsi = 0x0000000000000002   rdi = 0x0000054c0070bfa0\r\n    rbp = 0x0000054c0004b540   rsp = 0x00007fb20f3fc480\r\n     r8 = 0x0000000000000000    r9 = 0x00007fb2a47fe380\r\n    r10 = 0x0000000000000010   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c0070bfa0   r13 = 0x00007fb2a47211c0\r\n    r14 = 0x00000000ffffffff   r15 = 0x0000000000000002\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_main_context_poll [gmain.c : 4584 + 0xa]\r\n \r\n    Found by: inline record\r\n 2  libglib-2.0.so.0!g_main_context_iterate [gmain.c : 4271 + 0xb]\r\n    rbx = 0x0000000000000002   rbp = 0x0000054c0004b540\r\n    rsp = 0x00007fb20f3fc4b0   r12 = 0x0000054c0070bfa0\r\n    r13 = 0x00007fb2a47211c0   r14 = 0x00000000ffffffff\r\n    r15 = 0x0000000000000002   rip = 0x00007fb2a476f26e\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_main_loop_run [gmain.c : 4479 + 0xf]\r\n    rbx = 0x0000054c0070bd80   rbp = 0x0000054c0070bd88\r\n    rsp = 0x00007fb20f3fc510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a4713c4f\r\n    Found by: call frame info\r\n 4  libgio-2.0.so.0!gdbus_shared_thread_func [gdbusprivate.c : 284 + 0x9]\r\n    rbx = 0x0000054c007116b0   rbp = 0x0000054c00632e30\r\n    rsp = 0x00007fb20f3fc530   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a45f70ba\r\n    Found by: call frame info\r\n 5  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00702040   rbp = 0x0000054c00632e30\r\n    rsp = 0x00007fb20f3fc540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20f3fdcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20f3fc560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20f3fc600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa39c50\r\n    r15 = 0x00007fb20ebfd000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 23\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x0000000000000001\r\n    rsi = 0x0000000000000001   rdi = 0x0000054c00633de0\r\n    rbp = 0x0000054c0004b240   rsp = 0x00007fb20ebfb480\r\n     r8 = 0x0000000000000000    r9 = 0x00007fb2a47fe380\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000293\r\n    r12 = 0x0000054c00633de0   r13 = 0x00007fb2a47211c0\r\n    r14 = 0x00000000ffffffff   r15 = 0x0000000000000001\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_main_context_poll [gmain.c : 4584 + 0xa]\r\n \r\n    Found by: inline record\r\n 2  libglib-2.0.so.0!g_main_context_iterate [gmain.c : 4271 + 0xb]\r\n    rbx = 0x0000000000000001   rbp = 0x0000054c0004b240\r\n    rsp = 0x00007fb20ebfb4b0   r12 = 0x0000054c00633de0\r\n    r13 = 0x00007fb2a47211c0   r14 = 0x00000000ffffffff\r\n    r15 = 0x0000000000000001   rip = 0x00007fb2a476f26e\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_main_context_iteration [gmain.c : 4343 + 0x14]\r\n    rbx = 0x0000054c0004b240   rbp = 0x0000000000000001\r\n    rsp = 0x00007fb20ebfb510   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a4713220\r\n    Found by: call frame info\r\n 4  libdconfsettings.so!dconf_gdbus_worker_thread [dconf-gdbus-thread.c : 82 + 0xd]\r\n    rbx = 0x0000054c0004b240   rbp = 0x0000054c00722ca0\r\n    rsp = 0x00007fb20ebfb530   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a150f20d\r\n    Found by: call frame info\r\n 5  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c00703b40   rbp = 0x0000054c00722ca0\r\n    rsp = 0x00007fb20ebfb540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 6  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20ebfccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20ebfb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 7  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20ebfb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000011   r14 = 0x00007fffffa39b10\r\n    r15 = 0x00007fb20e3fc000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 24\r\n 0  libc.so.6!syscall [syscall.S : 38 + 0x0]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a3315ded   rbx = 0x0000000000000001\r\n    rsi = 0x0000000000000080   rdi = 0x0000054c00234d80\r\n    rbp = 0x0000054c00234d70   rsp = 0x00007fb20e3fa458\r\n     r8 = 0x0000000000000000    r9 = 0x000000000000000e\r\n    r10 = 0x00007fb20e3fa480   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000001\r\n    r14 = 0x0000054c00234d78   r15 = 0x00007fb20dbfb000\r\n    rip = 0x00007fb2a3315ded\r\n    Found by: given as instruction pointer in context\r\n 1  libglib-2.0.so.0!g_cond_wait_until [gthread-posix.c : 1600 + 0x5]\r\n    rbx = 0x0000000000000001   rbp = 0x0000054c00234d70\r\n    rsp = 0x00007fb20e3fa460   r12 = 0x0000000000000000\r\n    r13 = 0x0000000000000001   r14 = 0x0000054c00234d78\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a4769040\r\n    Found by: call frame info\r\n 2  libglib-2.0.so.0!g_async_queue_pop_intern_unlocked [gasyncqueue.c : 428 + 0xe]\r\n    rbx = 0x0000054c00234d70   rbp = 0x0000001292081ba1\r\n    rsp = 0x00007fb20e3fa4c0   r12 = 0x0000054c00234d88\r\n    r13 = 0x0000000000000001   r14 = 0x0000054c00234d78\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a46dfb01\r\n    Found by: call frame info\r\n 3  libglib-2.0.so.0!g_async_queue_timeout_pop [gasyncqueue.c : 551 + 0x10]\r\n    rbx = 0x0000054c00234d70   rbp = 0x0000001292081ba1\r\n    rsp = 0x00007fb20e3fa4f0   r12 = 0x0000000000000000\r\n    r13 = 0x0000000000000000   r14 = 0x0000000000000002\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a46dfc95\r\n    Found by: call frame info\r\n 4  libglib-2.0.so.0!g_thread_pool_wait_for_new_pool [gthreadpool.c : 181 + 0x7]\r\n \r\n    Found by: inline record\r\n 5  libglib-2.0.so.0!g_thread_pool_thread_proxy [gthreadpool.c : 408 + 0x8]\r\n    rbx = 0x0000054c00700cc0   rbp = 0x0000000000003a98\r\n    rsp = 0x00007fb20e3fa510   r12 = 0x0000000000000000\r\n    r13 = 0x0000000000000000   r14 = 0x0000000000000002\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a4745435\r\n    Found by: call frame info\r\n 6  libglib-2.0.so.0!g_thread_proxy [gthread.c : 831 + 0x6]\r\n    rbx = 0x0000054c0081dfe0   rbp = 0x0000054c0092e620\r\n    rsp = 0x00007fb20e3fa540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb2103fe260\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a47403d1\r\n    Found by: call frame info\r\n 7  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20e3fbcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20e3fa560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb2103fe260\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 8  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20e3fa600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb2103fe260\r\n    r15 = 0x00007fb20dbfb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 25\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb20dbf90f0   rdi = 0x0000000000000074\r\n    rbp = 0x00007fb20dbf92c0   rsp = 0x00007fb20dbf9080\r\n     r8 = 0x0000000000000000    r9 = 0x0000054c00e38000\r\n    r10 = 0x00000000ffffffff   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb20dbf92d0   r13 = 0x7fffffffffffffff\r\n    r14 = 0x0000054c00773870   r15 = 0x00007fb20dbf90f0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb20dbf92c0\r\n    rsp = 0x00007fb20dbf90b0   r12 = 0x00007fb20dbf92d0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c00773870\r\n    r15 = 0x00007fb20dbf90f0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb20dbf9340\r\n    rsp = 0x00007fb20dbf92d0   r12 = 0x00007fb20dbf92d0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c0016b2e8\r\n    r15 = 0x0000054c00773870   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x0000054c0016b200   rbp = 0x00007fb20dbf9390\r\n    rsp = 0x00007fb20dbf9350   r12 = 0x0000054c0016b218\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x0000054c0016b428   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb20dbf94c0   rbp = 0x00007fb20dbf9470\r\n    rsp = 0x00007fb20dbf93a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20dbf93f0\r\n    r15 = 0x00007fb20dbf9480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb20dbf94c0   rbp = 0x00007fb20dbf94b0\r\n    rsp = 0x00007fb20dbf9480   r12 = 0x00007fb20dbf94c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20dbf9480\r\n    r15 = 0x0000054c0001eab0   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x0000054c0001eaa0   rbp = 0x00007fb20dbf9510\r\n    rsp = 0x00007fb20dbf94c0   r12 = 0x00007fb20dbf94c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000054c0091cc00\r\n    r15 = 0x0000054c0001eab0   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 7  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20dbfa6c0   rbp = 0x00007fb20dbf9550\r\n    rsp = 0x00007fb20dbf9520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20dbfa258   r14 = 0x0000054c0001eaa0\r\n    r15 = 0x00007fb20dbfa6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 8  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20dbfacdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20dbf9560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a9e0\r\n    r15 = 0x00007fb20d3fa000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 9  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20dbf9600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a9e0\r\n    r15 = 0x00007fb20d3fa000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 26\r\n 0  libc.so.6!__GI___libc_read [read.c : 26 + 0x1a]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!read [read.c : 24 + 0x1a]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000004\r\n    rcx = 0x00007fb2a330becc   rbx = 0x0000054c00e256b0\r\n    rsi = 0x00007fb2a14434ec   rdi = 0x000000000000005c\r\n    rbp = 0x00007fb2a1443510   rsp = 0x00007fb2a1443380\r\n     r8 = 0x0000000000000000    r9 = 0x0000564edbb0fe00\r\n    r10 = 0x00007fb2a32e391b   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb2a1444258\r\n    r14 = 0x00007fb2a14434ec   r15 = 0x0000000000000004\r\n    rip = 0x00007fb2a330becc\r\n    Found by: given as instruction pointer in context\r\n 2  electron!electron::(anonymous namespace)::ShutdownDetector::ThreadMain() [electron_browser_main_parts_posix.cc : 138 + 0xe]\r\n    rbx = 0x0000054c00e256b0   rbp = 0x00007fb2a1443510\r\n    rsp = 0x00007fb2a14433b0   r12 = 0x0000000000000000\r\n    r13 = 0x00007fb2a1444258   r14 = 0x00007fb2a14434ec\r\n    r15 = 0x0000000000000004   rip = 0x0000564ed36e323b\r\n    Found by: call frame info\r\n 3  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb2a14446c0   rbp = 0x00007fb2a1443550\r\n    rsp = 0x00007fb2a1443520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb2a1444258   r14 = 0x0000054c00e256b0\r\n    r15 = 0x00007fb2a14446c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 4  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb2a1444cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a1443560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a990\r\n    r15 = 0x00007fb2a143c000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 5  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb2a1443600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa3a990\r\n    r15 = 0x00007fb2a143c000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 27\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20cdfe2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20cdfe2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20cdfe0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20cdfe1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20cdfe2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20cdfe2a8   rbp = 0x00007fb20cdfe2cc\r\n    rsp = 0x00007fb20cdfe0e0   r12 = 0x00007fb20cdfe280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20cdfe2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20cdfe2a8   rbp = 0x00007fb20cdfe250\r\n    rsp = 0x00007fb20cdfe1b0   r12 = 0x00007fb20cdfe1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bc\r\n    r15 = 0x0000000000000412   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c0081c1c8   rbp = 0x00007fb20cdfe320\r\n    rsp = 0x00007fb20cdfe260   r12 = 0x00007fb20cdfe268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294b06700\r\n    r15 = 0x0000000003945b00   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c0081c1c8   rbp = 0x00007fb20cdfe3b0\r\n    rsp = 0x00007fb20cdfe330   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003945b49\r\n    r15 = 0x0000000003945b49   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c0081c1b8   rbp = 0x00007fb20cdfe3c0\r\n    rsp = 0x00007fb20cdfe3c0   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003945b49   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c0081c1b8   rbp = 0x00007fb20cdfe3f0\r\n    rsp = 0x00007fb20cdfe3d0   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003945b49   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c0078b180   rbp = 0x00007fb20cdfe4c0\r\n    rsp = 0x00007fb20cdfe400   r12 = 0x00007fb20cdfe420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb20cdfe410\r\n    r15 = 0x00007fb20cdfe450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x0000054c0078b180   rbp = 0x00007fb20cdfe4e0\r\n    rsp = 0x00007fb20cdfe4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20cdff258   r14 = 0x0000054c0078b180\r\n    r15 = 0x00007fb20cdff6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x0000054c0078b180   rbp = 0x00007fb20cdfe510\r\n    rsp = 0x00007fb20cdfe4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20cdff258   r14 = 0x0000054c0078b180\r\n    r15 = 0x00007fb20cdff6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20cdff6c0   rbp = 0x00007fb20cdfe550\r\n    rsp = 0x00007fb20cdfe520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20cdff258   r14 = 0x0000054c0078b180\r\n    r15 = 0x00007fb20cdff6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20cdffcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20cdfe560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb20c5ff000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20cdfe600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29f1fae30\r\n    r15 = 0x00007fb20c5ff000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 28\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20c5fd2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20c5fd2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20c5fd0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20c5fd1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20c5fd2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20c5fd2a8   rbp = 0x00007fb20c5fd2cc\r\n    rsp = 0x00007fb20c5fd0e0   r12 = 0x00007fb20c5fd280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20c5fd2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20c5fd2a8   rbp = 0x00007fb20c5fd250\r\n    rsp = 0x00007fb20c5fd1b0   r12 = 0x00007fb20c5fd1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bc\r\n    r15 = 0x00000000000004a6   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c0074b3a8   rbp = 0x00007fb20c5fd320\r\n    rsp = 0x00007fb20c5fd260   r12 = 0x00007fb20c5fd268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294b06701\r\n    r15 = 0x0000000003951300   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c0074b3a8   rbp = 0x00007fb20c5fd3b0\r\n    rsp = 0x00007fb20c5fd330   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00000000039513ff\r\n    r15 = 0x00000000039513ff   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c0074b398   rbp = 0x00007fb20c5fd3c0\r\n    rsp = 0x00007fb20c5fd3c0   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513ff   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c0074b398   rbp = 0x00007fb20c5fd3f0\r\n    rsp = 0x00007fb20c5fd3d0   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513ff   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c0078b700   rbp = 0x00007fb20c5fd4c0\r\n    rsp = 0x00007fb20c5fd400   r12 = 0x00007fb20c5fd420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000000000003\r\n    r15 = 0x00007fb20c5fd450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x0000054c0078b700   rbp = 0x00007fb20c5fd4e0\r\n    rsp = 0x00007fb20c5fd4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20c5fe258   r14 = 0x0000054c0078b700\r\n    r15 = 0x00007fb20c5fe6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x0000054c0078b700   rbp = 0x00007fb20c5fd510\r\n    rsp = 0x00007fb20c5fd4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20c5fe258   r14 = 0x0000054c0078b700\r\n    r15 = 0x00007fb20c5fe6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20c5fe6c0   rbp = 0x00007fb20c5fd550\r\n    rsp = 0x00007fb20c5fd520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20c5fe258   r14 = 0x0000054c0078b700\r\n    r15 = 0x00007fb20c5fe6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20c5fecdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20c5fd560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20cdfde30\r\n    r15 = 0x00007fb20bdfe000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20c5fd600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20cdfde30\r\n    r15 = 0x00007fb20bdfe000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 29\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20bdfc2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20bdfc2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20bdfc0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20bdfc1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20bdfc2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20bdfc2a8   rbp = 0x00007fb20bdfc2cc\r\n    rsp = 0x00007fb20bdfc0e0   r12 = 0x00007fb20bdfc280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20bdfc2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20bdfc2a8   rbp = 0x00007fb20bdfc250\r\n    rsp = 0x00007fb20bdfc1b0   r12 = 0x00007fb20bdfc1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x000000000000032f   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c007ee230   rbp = 0x00007fb20bdfc320\r\n    rsp = 0x00007fb20bdfc260   r12 = 0x00007fb20bdfc268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19200   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c007ee230   rbp = 0x00007fb20bdfc3b0\r\n    rsp = 0x00007fb20bdfc330   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a192b9\r\n    r15 = 0x0000000003a192b9   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c007ee220   rbp = 0x00007fb20bdfc3c0\r\n    rsp = 0x00007fb20bdfc3c0   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a192b9   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c007ee220   rbp = 0x00007fb20bdfc3f0\r\n    rsp = 0x00007fb20bdfc3d0   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a192b9   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c0078a1b0   rbp = 0x00007fb20bdfc4c0\r\n    rsp = 0x00007fb20bdfc400   r12 = 0x00007fb20bdfc420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb20bdfc410\r\n    r15 = 0x00007fb20bdfc450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunDedicatedWorker() [worker_thread.cc : 342 + 0x5]\r\n    rbx = 0x0000054c0078a1b0   rbp = 0x00007fb20bdfc4e0\r\n    rsp = 0x00007fb20bdfc4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20bdfd258   r14 = 0x0000054c0078a1b0\r\n    r15 = 0x00007fb20bdfd6c0   rip = 0x0000564ed6e3a2bd\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 308 + 0x8]\r\n    rbx = 0x0000054c0078a1b0   rbp = 0x00007fb20bdfc510\r\n    rsp = 0x00007fb20bdfc4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20bdfd258   r14 = 0x0000054c0078a1b0\r\n    r15 = 0x00007fb20bdfd6c0   rip = 0x0000564ed6e3a177\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20bdfd6c0   rbp = 0x00007fb20bdfc550\r\n    rsp = 0x00007fb20bdfc520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20bdfd258   r14 = 0x0000054c0078a1b0\r\n    r15 = 0x00007fb20bdfd6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20bdfdcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20bdfc560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa39d40\r\n    r15 = 0x00007fb20b5fd000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20bdfc600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa39d40\r\n    r15 = 0x00007fb20b5fd000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 30\r\n 0  libc.so.6!__poll [poll.c : 29 + 0x1d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x00000000ffffffff\r\n    rcx = 0x00007fb2a33102cf   rbx = 0x00007fb20b5fb440\r\n    rsi = 0x0000000000000001   rdi = 0x00007fb20b5fb440\r\n    rbp = 0x00007fb20b5fb510   rsp = 0x00007fb20b5fb400\r\n     r8 = 0x0000000000000000    r9 = 0x0000564edbb0fe00\r\n    r10 = 0x00007fb2a32e391b   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb20b5fb448   r13 = 0x00007fb20b5fc258\r\n    r14 = 0x0000564edbb0b6f0   r15 = 0x00007fb20b5fb4e0\r\n    rip = 0x00007fb2a33102cf\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::(anonymous namespace)::InotifyReaderThreadDelegate::ThreadMain() [file_path_watcher_inotify.cc : 299 + 0x12]\r\n    rbx = 0x00007fb20b5fb440   rbp = 0x00007fb20b5fb510\r\n    rsp = 0x00007fb20b5fb430   r12 = 0x00007fb20b5fb448\r\n    r13 = 0x00007fb20b5fc258   r14 = 0x0000564edbb0b6f0\r\n    r15 = 0x00007fb20b5fb4e0   rip = 0x0000564ed6e56dce\r\n    Found by: call frame info\r\n 2  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20b5fc6c0   rbp = 0x00007fb20b5fb550\r\n    rsp = 0x00007fb20b5fb520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20b5fc258   r14 = 0x0000564edbb0b6f0\r\n    r15 = 0x00007fb20b5fc6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 3  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20b5fccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20b5fb560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29e1f8560\r\n    r15 = 0x00007fb20adfc000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 4  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20b5fb600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb29e1f8560\r\n    r15 = 0x00007fb20adfc000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 31\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x0000054c0003ad80\r\n    rsi = 0x0000000000000189   rdi = 0x0000054c0003adac\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20adfa240\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000054c0003ad18\r\n    r14 = 0x0000000000000004   r15 = 0x0000054c0003adac\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x0000054c0003ad80   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20adfa280   r12 = 0x0000054c0003ada4\r\n    r13 = 0x0000054c0003ad18   r14 = 0x0000000000000004\r\n    r15 = 0x0000054c0003adac   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::Wait() [condition_variable_posix.cc : 106 + 0x8]\r\n    rbx = 0x0000054c0003ad80   rbp = 0x00007fb20adfa3d0\r\n    rsp = 0x00007fb20adfa350   r12 = 0x00007fb20adfa460\r\n    r13 = 0xaaaaaaaaaaaaaaaa   r14 = 0x0000054c0003ad00\r\n    r15 = 0x0000054c0003ad68   rip = 0x0000564ed6e536e5\r\n    Found by: call frame info\r\n 6  electron!cc::SingleThreadTaskGraphRunner::Run() [single_thread_task_graph_runner.cc : 132 + 0x5]\r\n    rbx = 0x0000054c0003ad18   rbp = 0x00007fb20adfa510\r\n    rsp = 0x00007fb20adfa3e0   r12 = 0x00007fb20adfa460\r\n    r13 = 0xaaaaaaaaaaaaaaaa   r14 = 0x0000054c0003ad00\r\n    r15 = 0x0000054c0003ad68   rip = 0x0000564ed810325a\r\n    Found by: call frame info\r\n 7  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20adfb6c0   rbp = 0x00007fb20adfa550\r\n    rsp = 0x00007fb20adfa520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20adfb258   r14 = 0x0000054c0074b660\r\n    r15 = 0x00007fb20adfb6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 8  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20adfbcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20adfa560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3aa20\r\n    r15 = 0x00007fb20a5fb000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 9  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20adfa600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3aa20\r\n    r15 = 0x00007fb20a5fb000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 32\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffe00   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20a58b1d8\r\n    rsi = 0x0000000000000189   rdi = 0x00007fb20a58b200\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20a58aff0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000000000   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x00007fb20a58b1b0\r\n    r14 = 0x0000000000000000   r15 = 0x00007fb20a58b200\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x10]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!pthread_cond_wait@@GLIBC_2.3.2 [pthread_cond_wait.c : 627 + 0x11]\r\n    rbx = 0x00007fb20a58b1d8   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20a58b030   r12 = 0x00007fb20a58b1fc\r\n    r13 = 0x00007fb20a58b1b0   r14 = 0x0000000000000000\r\n    r15 = 0x00007fb20a58b200   rip = 0x00007fb2a328e5f8\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::Wait() [condition_variable_posix.cc : 106 + 0x8]\r\n    rbx = 0x00007fb20a58b1d8   rbp = 0x00007fb20a58b180\r\n    rsp = 0x00007fb20a58b100   r12 = 0x00007fb20a58b198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e536e5\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 194 + 0x5]\r\n    rbx = 0x0000054c00e1ce20   rbp = 0x00007fb20a58b250\r\n    rsp = 0x00007fb20a58b190   r12 = 0x00007fb20a58b198\r\n    r13 = 0x7fffffffffffffff   r14 = 0x7fffffffffffffff\r\n    r15 = 0x7fffffffffffff00   rip = 0x0000564ed6e7b74f\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::Wait() [waitable_event.cc : 39 + 0x8]\r\n    rbx = 0x0000054c00e1ce20   rbp = 0x00007fb20a58b2e0\r\n    rsp = 0x00007fb20a58b260   r12 = 0x00007fb20a58b2f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c0016ba68\r\n    r15 = 0x0000054c00e1ce20   rip = 0x0000564ed6dfcd5c\r\n    Found by: call frame info\r\n 8  electron!base::MessagePumpDefault::Run(base::MessagePump::Delegate*) [message_pump_default.cc : 56 + 0x8]\r\n    rbx = 0x0000054c00e1ce10   rbp = 0x00007fb20a58b340\r\n    rsp = 0x00007fb20a58b2f0   r12 = 0x00007fb20a58b2f0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000054c0016ba68\r\n    r15 = 0x0000054c00e1ce20   rip = 0x0000564ed6dbbd94\r\n    Found by: call frame info\r\n 9  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x0000054c0016b980   rbp = 0x00007fb20a58b390\r\n    rsp = 0x00007fb20a58b350   r12 = 0x0000054c0016b998\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x0000054c0016bba8   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n10  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb20a58b4c0   rbp = 0x00007fb20a58b470\r\n    rsp = 0x00007fb20a58b3a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20a58b3f0\r\n    r15 = 0x00007fb20a58b480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n11  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb20a58b4c0   rbp = 0x00007fb20a58b4b0\r\n    rsp = 0x00007fb20a58b480   r12 = 0x00007fb20a58b4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb20a58b480\r\n    r15 = 0x0000054c00d3bac8   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n12  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x0000054c00d3bab8   rbp = 0x00007fb20a58b510\r\n    rsp = 0x00007fb20a58b4c0   r12 = 0x00007fb20a58b4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000000000000000\r\n    r15 = 0x0000054c00d3bac8   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20a58c6c0   rbp = 0x00007fb20a58b550\r\n    rsp = 0x00007fb20a58b520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20a58c258   r14 = 0x0000054c00d3bab8\r\n    r15 = 0x00007fb20a58c6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20a58ccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20a58b560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3a820\r\n    r15 = 0x00007fb209d8c000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20a58b600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3a820\r\n    r15 = 0x00007fb209d8c000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 33\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000001\r\n    rcx = 0x00007fb2a331e546   rbx = 0x0000054c00094000\r\n    rsi = 0x00007fb209497504   rdi = 0x0000000000000029\r\n    rbp = 0x00007fb209497530   rsp = 0x00007fb2094974d0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x0000000000004dc6   r11 = 0x0000000000000293\r\n    r12 = 0xaaaaaaaaaaaaaaaa   r13 = 0x0000000000000002\r\n    r14 = 0x0000000000004dc6   r15 = 0x00007fb209497504\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!electron::NodeBindingsLinux::PollEvents() [node_bindings_linux.cc : 31 + 0x10]\r\n    rbx = 0x0000054c00094000   rbp = 0x00007fb209497530\r\n    rsp = 0x00007fb209497500   r12 = 0xaaaaaaaaaaaaaaaa\r\n    r13 = 0x0000000000000002   r14 = 0x0000000000004dc6\r\n    r15 = 0x00007fb209497504   rip = 0x0000564ed36f3b70\r\n    Found by: call frame info\r\n 2  electron!electron::NodeBindings::EmbedThreadRunner(void*) [node_bindings.cc : 929 + 0x8]\r\n    rbx = 0x0000054c00094000   rbp = 0x00007fb209497550\r\n    rsp = 0x00007fb209497540   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x0000054c00094388\r\n    r15 = 0x00007fb208c98000   rip = 0x0000564ed36bb754\r\n    Found by: call frame info\r\n 3  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb209498cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb209497560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3ab90\r\n    r15 = 0x00007fb208c98000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 4  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb209497600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fffffa3ab90\r\n    r15 = 0x00007fb208c98000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 34\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb207bae2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb207bae2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb207bae0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb207bae1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb207bae2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb207bae2a8   rbp = 0x00007fb207bae2cc\r\n    rsp = 0x00007fb207bae0e0   r12 = 0x00007fb207bae280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb207bae2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb207bae2a8   rbp = 0x00007fb207bae250\r\n    rsp = 0x00007fb207bae1b0   r12 = 0x00007fb207bae1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bd\r\n    r15 = 0x00000000000000b3   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c007edcf0   rbp = 0x00007fb207bae320\r\n    rsp = 0x00007fb207bae260   r12 = 0x00007fb207bae268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294bfa940\r\n    r15 = 0x0000000003a19700   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c007edcf0   rbp = 0x00007fb207bae3b0\r\n    rsp = 0x00007fb207bae330   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000000003a1978b\r\n    r15 = 0x0000000003a1978b   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c007edce0   rbp = 0x00007fb207bae3c0\r\n    rsp = 0x00007fb207bae3c0   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a1978b   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c007edce0   rbp = 0x00007fb207bae3f0\r\n    rsp = 0x00007fb207bae3d0   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x0000000003a1978b   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c00e465d0   rbp = 0x00007fb207bae4c0\r\n    rsp = 0x00007fb207bae400   r12 = 0x00007fb207bae420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00007fb207bae410\r\n    r15 = 0x00007fb207bae450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunSharedWorker() [worker_thread.cc : 332 + 0x5]\r\n    rbx = 0x0000054c00e465d0   rbp = 0x00007fb207bae4e0\r\n    rsp = 0x00007fb207bae4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb207baf258   r14 = 0x0000054c00e465d0\r\n    r15 = 0x00007fb207baf6c0   rip = 0x0000564ed6e3a28d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 305 + 0x8]\r\n    rbx = 0x0000054c00e465d0   rbp = 0x00007fb207bae510\r\n    rsp = 0x00007fb207bae4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb207baf258   r14 = 0x0000054c00e465d0\r\n    r15 = 0x00007fb207baf6c0   rip = 0x0000564ed6e3a181\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb207baf6c0   rbp = 0x00007fb207bae550\r\n    rsp = 0x00007fb207bae520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb207baf258   r14 = 0x0000054c00e465d0\r\n    r15 = 0x00007fb207baf6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb207bafcdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb207bae560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa38d50\r\n    r15 = 0x00007fb2073af000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb207bae600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000016   r14 = 0x00007fffffa38d50\r\n    r15 = 0x00007fb2073af000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 35\r\n 0  libc.so.6!__futex_abstimed_wait_common64 [futex-internal.c : 57 + 0x2d]\r\n \r\n    Found by: inline record\r\n 1  libc.so.6!__futex_abstimed_wait_common [futex-internal.c : 87 + 0x2d]\r\n \r\n    Found by: inline record\r\n 2  libc.so.6!__GI___futex_abstimed_wait_cancelable64 [futex-internal.c : 139 + 0x2d]\r\n    rax = 0xfffffffffffffdfc   rdx = 0x0000000000000000\r\n    rcx = 0x00007fb2a328bca6   rbx = 0x00007fb20738b2a8\r\n    rsi = 0x0000000000000089   rdi = 0x00007fb20738b2d0\r\n    rbp = 0x0000000000000000   rsp = 0x00007fb20738b0a0\r\n     r8 = 0x0000000000000000    r9 = 0x00000000ffffffff\r\n    r10 = 0x00007fb20738b1c0   r11 = 0x0000000000000246\r\n    r12 = 0x0000000000000000   r13 = 0x0000000000000000\r\n    r14 = 0x00007fb20738b2d0   r15 = 0x0000000000000000\r\n    rip = 0x00007fb2a328bca6\r\n    Found by: given as instruction pointer in context\r\n 3  libc.so.6!__pthread_cond_wait_common [pthread_cond_wait.c : 503 + 0x17]\r\n \r\n    Found by: inline record\r\n 4  libc.so.6!___pthread_cond_timedwait [pthread_cond_wait.c : 652 + 0x18]\r\n    rbx = 0x00007fb20738b2a8   rbp = 0x00007fb20738b2cc\r\n    rsp = 0x00007fb20738b0e0   r12 = 0x00007fb20738b280\r\n    r13 = 0x0000000000000000   r14 = 0x00007fb20738b2d0\r\n    r15 = 0x0000000000000000   rip = 0x00007fb2a328ea6a\r\n    Found by: call frame info\r\n 5  electron!base::ConditionVariable::TimedWait(base::TimeDelta const&) [condition_variable_posix.cc : 159 + 0xb]\r\n    rbx = 0x00007fb20738b2a8   rbp = 0x00007fb20738b250\r\n    rsp = 0x00007fb20738b1b0   r12 = 0x00007fb20738b1b0\r\n    r13 = 0x7fffffffffffffff   r14 = 0x00000000000137bc\r\n    r15 = 0x00000000000004e7   rip = 0x0000564ed6e537fd\r\n    Found by: call frame info\r\n 6  electron!base::WaitableEvent::TimedWaitImpl(base::TimeDelta) [waitable_event_posix.cc : 196 + 0x9]\r\n    rbx = 0x0000054c00781548   rbp = 0x00007fb20738b320\r\n    rsp = 0x00007fb20738b260   r12 = 0x00007fb20738b268\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000001294b06701\r\n    r15 = 0x0000000003951300   rip = 0x0000564ed6e7b77d\r\n    Found by: call frame info\r\n 7  electron!base::WaitableEvent::TimedWait(base::TimeDelta) [waitable_event.cc : 39 + 0xb]\r\n    rbx = 0x0000054c00781548   rbp = 0x00007fb20738b3b0\r\n    rsp = 0x00007fb20738b330   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x00000000039513eb\r\n    r15 = 0x00000000039513eb   rip = 0x0000564ed6dfce83\r\n    Found by: call frame info\r\n 8  electron!base::internal::WorkerThreadWaitableEvent::Delegate::TimedWait(base::TimeDelta) [worker_thread_waitable_event.cc : 26 + 0x5]\r\n    rbx = 0x0000054c00781538   rbp = 0x00007fb20738b3c0\r\n    rsp = 0x00007fb20738b3c0   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513eb   rip = 0x0000564ed6e3afed\r\n    Found by: call frame info\r\n 9  electron!base::internal::WorkerThread::Delegate::WaitForWork() [worker_thread.cc : 74 + 0x9]\r\n    rbx = 0x0000054c00781538   rbp = 0x00007fb20738b3f0\r\n    rsp = 0x00007fb20738b3d0   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x7fffffffffffffff\r\n    r15 = 0x00000000039513eb   rip = 0x0000564ed6e39abc\r\n    Found by: call frame info\r\n10  electron!base::internal::WorkerThread::RunWorker() [worker_thread.cc : 407 + 0x8]\r\n    rbx = 0x0000054c00e44a50   rbp = 0x00007fb20738b4c0\r\n    rsp = 0x00007fb20738b400   r12 = 0x00007fb20738b420\r\n    r13 = 0x0000564edba62e70   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738b450   rip = 0x0000564ed6e3a5ce\r\n    Found by: call frame info\r\n11  electron!base::internal::WorkerThread::RunPooledWorker() [worker_thread.cc : 322 + 0x5]\r\n    rbx = 0x0000054c00e44a50   rbp = 0x00007fb20738b4e0\r\n    rsp = 0x00007fb20738b4d0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20738c258   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738c6c0   rip = 0x0000564ed6e3a25d\r\n    Found by: call frame info\r\n12  electron!base::internal::WorkerThread::ThreadMain() [worker_thread.cc : 302 + 0x8]\r\n    rbx = 0x0000054c00e44a50   rbp = 0x00007fb20738b510\r\n    rsp = 0x00007fb20738b4f0   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20738c258   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738c6c0   rip = 0x0000564ed6e3a16d\r\n    Found by: call frame info\r\n13  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb20738c6c0   rbp = 0x00007fb20738b550\r\n    rsp = 0x00007fb20738b520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb20738c258   r14 = 0x0000054c00e44a50\r\n    r15 = 0x00007fb20738c6c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n14  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb20738ccdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20738b560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20c5fce30\r\n    r15 = 0x00007fb206b8c000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n15  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb20738b600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x0000000000000002   r14 = 0x00007fb20c5fce30\r\n    r15 = 0x00007fb206b8c000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nThread 36\r\n 0  libc.so.6!epoll_wait [epoll_wait.c : 30 + 0x25]\r\n    rax = 0xfffffffffffffffc   rdx = 0x0000000000000010\r\n    rcx = 0x00007fb2a331e546   rbx = 0xfffffffc00000000\r\n    rsi = 0x00007fb206aff0f0   rdi = 0x000000000000008e\r\n    rbp = 0x00007fb206aff2c0   rsp = 0x00007fb206aff080\r\n     r8 = 0x0000000000000000    r9 = 0x0000000000000000\r\n    r10 = 0x0000000000007483   r11 = 0x0000000000000293\r\n    r12 = 0x00007fb206aff2d0   r13 = 0x0000000001c71be8\r\n    r14 = 0x0000054c00f83c60   r15 = 0x00007fb206aff0f0\r\n    rip = 0x00007fb2a331e546\r\n    Found by: given as instruction pointer in context\r\n 1  electron!base::MessagePumpEpoll::WaitForEpollEvents(base::TimeDelta) [message_pump_epoll.cc : 238 + 0xd]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb206aff2c0\r\n    rsp = 0x00007fb206aff0b0   r12 = 0x00007fb206aff2d0\r\n    r13 = 0x0000000001c71be8   r14 = 0x0000054c00f83c60\r\n    r15 = 0x00007fb206aff0f0   rip = 0x0000564ed6e789e0\r\n    Found by: call frame info\r\n 2  electron!base::MessagePumpEpoll::Run(base::MessagePump::Delegate*) [message_pump_epoll.cc : 132 + 0xb]\r\n    rbx = 0xfffffffc00000000   rbp = 0x00007fb206aff340\r\n    rsp = 0x00007fb206aff2d0   r12 = 0x00007fb206aff2d0\r\n    r13 = 0x0000000001c71be8   r14 = 0x0000054c0016cbe8\r\n    r15 = 0x0000054c00f83c60   rip = 0x0000564ed6e78877\r\n    Found by: call frame info\r\n 3  electron!base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) [thread_controller_with_message_pump_impl.cc : 641 + 0x6]\r\n    rbx = 0x0000054c0016cb00   rbp = 0x00007fb206aff390\r\n    rsp = 0x00007fb206aff350   r12 = 0x0000054c0016cb18\r\n    r13 = 0x7fffffffffffffff   r14 = 0x0000000000000001\r\n    r15 = 0x0000054c0016cd28   rip = 0x0000564ed6e1d0dd\r\n    Found by: call frame info\r\n 4  electron!base::RunLoop::Run(base::Location const&) [run_loop.cc : 134 + 0x12]\r\n    rbx = 0x00007fb206aff4c0   rbp = 0x00007fb206aff470\r\n    rsp = 0x00007fb206aff3a0   r12 = 0x0000000000000000\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb206aff3f0\r\n    r15 = 0x00007fb206aff480   rip = 0x0000564ed6de27dd\r\n    Found by: call frame info\r\n 5  electron!base::Thread::Run(base::RunLoop*) [thread.cc : 338 + 0x2a]\r\n    rbx = 0x00007fb206aff4c0   rbp = 0x00007fb206aff4b0\r\n    rsp = 0x00007fb206aff480   r12 = 0x00007fb206aff4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x00007fb206aff480\r\n    r15 = 0x0000564edbb1d7e8   rip = 0x0000564ed6e411f8\r\n    Found by: call frame info\r\n 6  electron!base::Thread::ThreadMain() [thread.cc : 410 + 0xc]\r\n    rbx = 0x0000564edbb1d7d8   rbp = 0x00007fb206aff510\r\n    rsp = 0x00007fb206aff4c0   r12 = 0x00007fb206aff4c0\r\n    r13 = 0xfffffffc00000000   r14 = 0x0000054c00d2b700\r\n    r15 = 0x0000564edbb1d7e8   rip = 0x0000564ed6e41402\r\n    Found by: call frame info\r\n 7  electron!base::(anonymous namespace)::ThreadFunc(void*) [platform_thread_posix.cc : 103 + 0x8]\r\n    rbx = 0x00007fb206b006c0   rbp = 0x00007fb206aff550\r\n    rsp = 0x00007fb206aff520   r12 = 0x00002ee40026af80\r\n    r13 = 0x00007fb206b00258   r14 = 0x0000564edbb1d7d8\r\n    r15 = 0x00007fb206b006c0   rip = 0x0000564ed6e53f45\r\n    Found by: call frame info\r\n 8  libc.so.6!start_thread [pthread_create.c : 444 + 0x12]\r\n    rbx = 0x00007fb206b00cdc   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb206aff560   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa38b10\r\n    r15 = 0x00007fb206300000   rip = 0x00007fb2a328f6ba\r\n    Found by: call frame info\r\n 9  libc.so.6!clone3 [clone3.S : 81 + 0x2]\r\n    rbx = 0x00007fb2a328f3d0   rbp = 0x0000000000000000\r\n    rsp = 0x00007fb206aff600   r12 = 0xfffffffffffffb08\r\n    r13 = 0x000000000000000b   r14 = 0x00007fffffa38b10\r\n    r15 = 0x00007fb206300000   rip = 0x00007fb2a331e120\r\n    Found by: call frame info\r\n\r\nLoaded modules:\r\n0x564ed10de000 - 0x564edbbf3b52  electron  0.0.0.0  (main)\r\n0x7fb205cf1000 - 0x7fb205d79907  libnssckbi.so  0.0.0.0\r\n0x7fb205d7a000 - 0x7fb205e333df  libfreeblpriv3.so  0.0.0.0\r\n0x7fb205e34000 - 0x7fb205f85ef7  libsqlite3.so.0  0.0.0.0\r\n0x7fb205fa7000 - 0x7fb205ffc077  libsoftokn3.so  0.0.0.0\r\n0x7fb206b01000 - 0x7fb206b2079f  libdbusmenu-glib.so.4  0.0.0.0\r\n0x7fb20a58d000 - 0x7fb20a5ba917  libudev.so.1  0.0.0.0\r\n0x7fb210400000 - 0x7fb21066b1bf  libstdc++.so.6  0.0.0.0\r\n0x7fb2107c1000 - 0x7fb2107ff2b7  libgvfscommon.so  0.0.0.0\r\n0x7fb210800000 - 0x7fb2125d100f  libicudata.so.72  0.0.0.0\r\n0x7fb212602000 - 0x7fb2128002bf  libicuuc.so.72  0.0.0.0\r\n0x7fb212801000 - 0x7fb2129eadd7  libxml2.so.2  0.0.0.0\r\n0x7fb2a1445000 - 0x7fb2a14782ef  libgvfsdbus.so  0.0.0.0\r\n0x7fb2a1479000 - 0x7fb2a148200f  libogg.so.0  0.0.0.0\r\n0x7fb2a1483000 - 0x7fb2a14af00f  libvorbis.so.0  0.0.0.0\r\n0x7fb2a14b0000 - 0x7fb2a14ba18f  libltdl.so.7  0.0.0.0\r\n0x7fb2a14bb000 - 0x7fb2a14d104f  libtdb.so.1  0.0.0.0\r\n0x7fb2a14d2000 - 0x7fb2a14dc00f  libvorbisfile.so.3  0.0.0.0\r\n0x7fb2a14dd000 - 0x7fb2a14ef03f  libcanberra.so.0  0.0.0.0\r\n0x7fb2a14f0000 - 0x7fb2a14f600f  libcanberra-gtk3.so.0  0.0.0.0\r\n0x7fb2a1508000 - 0x7fb2a15170df  libdconfsettings.so  0.0.0.0\r\n0x7fb2a1518000 - 0x7fb2a151f0a7  libcanberra-gtk3-module.so  0.0.0.0\r\n0x7fb2a1520000 - 0x7fb2a1548c5f  libxkbfile.so.1  0.0.0.0\r\n0x7fb2a1549000 - 0x7fb2a1565a6f  libxklavier.so.16  0.0.0.0\r\n0x7fb2a1566000 - 0x7fb2a157f147  libgnomekbdui.so.8  0.0.0.0\r\n0x7fb2a1e06000 - 0x7fb2a1e0f0ef  libgnomekbd.so.8  0.0.0.0\r\n0x7fb2a1e10000 - 0x7fb2a1e4f3af  libxapp.so.1  0.0.0.0\r\n0x7fb2a1e53000 - 0x7fb2a1e650f7  libappmenu-gtk3-parser.so.0  0.0.0.0\r\n0x7fb2a1e66000 - 0x7fb2a1e70097  libappmenu-gtk-module.so  0.0.0.0\r\n0x7fb2a1f1d000 - 0x7fb2a1f290e7  libmd.so.0  0.0.0.0\r\n0x7fb2a1f2a000 - 0x7fb2a1f4c01f  libbrotlicommon.so.1  0.0.0.0\r\n0x7fb2a1f4f000 - 0x7fb2a1f61a27  libresolv.so.2  0.0.0.0\r\n0x7fb2a1f62000 - 0x7fb2a1f6800f  libkeyutils.so.1  0.0.0.0\r\n0x7fb2a1f69000 - 0x7fb2a1f8e1a7  libgpg-error.so.0  0.0.0.0\r\n0x7fb2a1f8f000 - 0x7fb2a1fa30df  libbsd.so.0  0.0.0.0\r\n0x7fb2a1fa6000 - 0x7fb2a1fb204f  libbrotlidec.so.1  0.0.0.0\r\n0x7fb2a1fb3000 - 0x7fb2a1fbb00f  libdatrie.so.1  0.0.0.0\r\n0x7fb2a1fbc000 - 0x7fb2a203e00f  libjpeg.so.8  0.0.0.0\r\n0x7fb2a203f000 - 0x7fb2a20650af  libgraphite2.so.3  0.0.0.0\r\n0x7fb2a2068000 - 0x7fb2a206c127  libXinerama.so.1  0.0.0.0\r\n0x7fb2a206d000 - 0x7fb2a20781c7  libXcursor.so.1  0.0.0.0\r\n0x7fb2a2079000 - 0x7fb2a207d01f  libwayland-egl.so.1  0.0.0.0\r\n0x7fb2a207e000 - 0x7fb2a20871e7  libwayland-cursor.so.0  0.0.0.0\r\n0x7fb2a2088000 - 0x7fb2a2098487  libwayland-client.so.0  0.0.0.0\r\n0x7fb2a2099000 - 0x7fb2a211b1ef  libgmp.so.10  0.0.0.0\r\n0x7fb2a211e000 - 0x7fb2a216500f  libhogweed.so.6  0.0.0.0\r\n0x7fb2a2166000 - 0x7fb2a21b507f  libnettle.so.8  0.0.0.0\r\n0x7fb2a21b6000 - 0x7fb2a21cc227  libtasn1.so.6  0.0.0.0\r\n0x7fb2a21cd000 - 0x7fb2a23808e7  libunistring.so.2  0.0.0.0\r\n0x7fb2a2381000 - 0x7fb2a23a100f  libidn2.so.0  0.0.0.0\r\n0x7fb2a23a2000 - 0x7fb2a24def47  libp11-kit.so.0  0.0.0.0\r\n0x7fb2a24e1000 - 0x7fb2a24ed3af  libkrb5support.so.0  0.0.0.0\r\n0x7fb2a24ee000 - 0x7fb2a24f3047  libcom_err.so.2  0.0.0.0\r\n0x7fb2a24f4000 - 0x7fb2a251f0f7  libk5crypto.so.3  0.0.0.0\r\n0x7fb2a2520000 - 0x7fb2a25e8aef  libkrb5.so.3  0.0.0.0\r\n0x7fb2a25e9000 - 0x7fb2a260b057  liblz4.so.1  0.0.0.0\r\n0x7fb2a260e000 - 0x7fb2a26c1037  libzstd.so.1  0.0.0.0\r\n0x7fb2a26c2000 - 0x7fb2a26f3017  liblzma.so.5  0.0.0.0\r\n0x7fb2a26f4000 - 0x7fb2a283b2cf  libgcrypt.so.20  0.0.0.0\r\n0x7fb2a283c000 - 0x7fb2a2847047  libcap.so.2  0.0.0.0\r\n0x7fb2a2848000 - 0x7fb2a287e3b7  libblkid.so.1  0.0.0.0\r\n0x7fb2a2881000 - 0x7fb2a288807f  libXdmcp.so.6  0.0.0.0\r\n0x7fb2a2889000 - 0x7fb2a288e107  libXau.so.6  0.0.0.0\r\n0x7fb2a288f000 - 0x7fb2a28a0047  libxcb-randr.so.0  0.0.0.0\r\n0x7fb2a28a1000 - 0x7fb2a28b661f  libwayland-server.so.0  0.0.0.0\r\n0x7fb2a28b7000 - 0x7fb2a28c326f  libXrender.so.1  0.0.0.0\r\n0x7fb2a28c6000 - 0x7fb2a28d3067  libxcb-render.so.0  0.0.0.0\r\n0x7fb2a28d4000 - 0x7fb2a28d8057  libxcb-shm.so.0  0.0.0.0\r\n0x7fb2a28d9000 - 0x7fb2a291000f  libpng16.so.16  0.0.0.0\r\n0x7fb2a2911000 - 0x7fb2a29da00f  libfreetype.so.6  0.0.0.0\r\n0x7fb2a29db000 - 0x7fb2a2a86157  libpixman-1.so.0  0.0.0.0\r\n0x7fb2a2a87000 - 0x7fb2a2a9188f  libthai.so.0  0.0.0.0\r\n0x7fb2a2a94000 - 0x7fb2a2aa71a7  libXi.so.6  0.0.0.0\r\n0x7fb2a2aa8000 - 0x7fb2a2bdcf87  libepoxy.so.0  0.0.0.0\r\n0x7fb2a2bdd000 - 0x7fb2a2c0b1df  libgdk_pixbuf-2.0.so.0  0.0.0.0\r\n0x7fb2a2c0c000 - 0x7fb2a2c16117  libcairo-gobject.so.2  0.0.0.0\r\n0x7fb2a2c17000 - 0x7fb2a2c330b7  libfribidi.so.0  0.0.0.0\r\n0x7fb2a2c36000 - 0x7fb2a2c8361f  libfontconfig.so.1  0.0.0.0\r\n0x7fb2a2c84000 - 0x7fb2a2c9d187  libpangoft2-1.0.so.0  0.0.0.0\r\n0x7fb2a2c9e000 - 0x7fb2a2d858df  libharfbuzz.so.0  0.0.0.0\r\n0x7fb2a2d86000 - 0x7fb2a2d960b7  libpangocairo-1.0.so.0  0.0.0.0\r\n0x7fb2a2d97000 - 0x7fb2a2e92d37  libgdk-3.so.0  0.0.0.0\r\n0x7fb2a2e93000 - 0x7fb2a308dd3f  libgnutls.so.30  0.0.0.0\r\n0x7fb2a308e000 - 0x7fb2a30a0117  libavahi-client.so.3  0.0.0.0\r\n0x7fb2a30a1000 - 0x7fb2a30ae24f  libavahi-common.so.3  0.0.0.0\r\n0x7fb2a30af000 - 0x7fb2a3102417  libgssapi_krb5.so.2  0.0.0.0\r\n0x7fb2a3103000 - 0x7fb2a31d254f  libsystemd.so.0  0.0.0.0\r\n0x7fb2a31d3000 - 0x7fb2a31ff6a7  libselinux.so.1  0.0.0.0\r\n0x7fb2a3200000 - 0x7fb2a3404f6f  libc.so.6  0.0.0.0\r\n0x7fb2a3407000 - 0x7fb2a340b09f  libplds4.so  0.0.0.0\r\n0x7fb2a340e000 - 0x7fb2a3451237  libmount.so.1  0.0.0.0\r\n0x7fb2a3452000 - 0x7fb2a346f09f  libz.so.1  0.0.0.0\r\n0x7fb2a3470000 - 0x7fb2a350930f  libpcre2-8.so.0  0.0.0.0\r\n0x7fb2a350a000 - 0x7fb2a352d367  libgcc_s.so.1  0.0.0.0\r\n0x7fb2a352e000 - 0x7fb2a36160f7  libm.so.6  0.0.0.0\r\n0x7fb2a3617000 - 0x7fb2a364f4a7  libatspi.so.0  0.0.0.0\r\n0x7fb2a3650000 - 0x7fb2a375450f  libasound.so.2  0.0.0.0\r\n0x7fb2a3755000 - 0x7fb2a379a157  libxkbcommon.so.0  0.0.0.0\r\n0x7fb2a379b000 - 0x7fb2a38d8d27  libX11.so.6  0.0.0.0\r\n0x7fb2a38d9000 - 0x7fb2a39ffe6f  libcairo.so.2  0.0.0.0\r\n0x7fb2a3a00000 - 0x7fb2a41d0dcf  libgtk-3.so.0  0.0.0.0\r\n0x7fb2a41d1000 - 0x7fb2a41d708f  libplc4.so  0.0.0.0\r\n0x7fb2a41d8000 - 0x7fb2a41de087  libgmodule-2.0.so.0  0.0.0.0\r\n0x7fb2a41e1000 - 0x7fb2a41eb60f  libffi.so.8  0.0.0.0\r\n0x7fb2a41ee000 - 0x7fb2a4217267  libxcb.so.1  0.0.0.0\r\n0x7fb2a4218000 - 0x7fb2a424207f  libexpat.so.1  0.0.0.0\r\n0x7fb2a4243000 - 0x7fb2a4253467  libgbm.so.1  0.0.0.0\r\n0x7fb2a4254000 - 0x7fb2a4260187  libXrandr.so.2  0.0.0.0\r\n0x7fb2a4261000 - 0x7fb2a42680e7  libXfixes.so.3  0.0.0.0\r\n0x7fb2a4269000 - 0x7fb2a427d8df  libXext.so.6  0.0.0.0\r\n0x7fb2a427e000 - 0x7fb2a42e79ff  libpango-1.0.so.0  0.0.0.0\r\n0x7fb2a42e8000 - 0x7fb2a42febd7  libdrm.so.2  0.0.0.0\r\n0x7fb2a42ff000 - 0x7fb2a439b22f  libcups.so.2  0.0.0.0\r\n0x7fb2a439c000 - 0x7fb2a43d7437  libatk-bridge-2.0.so.0  0.0.0.0\r\n0x7fb2a43d8000 - 0x7fb2a43ff4d7  libatk-1.0.so.0  0.0.0.0\r\n0x7fb2a4400000 - 0x7fb2a444d2e7  libdbus-1.so.3  0.0.0.0\r\n0x7fb2a444e000 - 0x7fb2a448d38f  libnspr4.so  0.0.0.0\r\n0x7fb2a448e000 - 0x7fb2a44b50af  libsmime3.so  0.0.0.0\r\n0x7fb2a44b6000 - 0x7fb2a44e670f  libnssutil3.so  0.0.0.0\r\n0x7fb2a44e7000 - 0x7fb2a46b8377  libgio-2.0.so.0  0.0.0.0\r\n0x7fb2a46b9000 - 0x7fb2a47ff1f7  libglib-2.0.so.0  0.0.0.0\r\n0x7fb2a4800000 - 0x7fb2a4f26d87  libffmpeg.so  0.0.0.0\r\n0x7fb2a4f2a000 - 0x7fb2a4f2e087  libXdamage.so.1  0.0.0.0\r\n0x7fb2a4f2f000 - 0x7fb2a4f33087  libXcomposite.so.1  0.0.0.0\r\n0x7fb2a4f38000 - 0x7fb2a50652df  libnss3.so  0.0.0.0\r\n0x7fb2a5068000 - 0x7fb2a50c8c47  libgobject-2.0.so.0  0.0.0.0\r\n0x7fb2a50c9000 - 0x7fb2a50cd00f  libpthread.so.0  0.0.0.0\r\n0x7fb2a50ce000 - 0x7fb2a50d200f  libdl.so.2  0.0.0.0\r\n0x7fb2a50d3000 - 0x7fb2a50dc4af  libgtk3-nocsd.so.0  0.0.0.0\r\n0x7fb2a50de000 - 0x7fb2a50e202f  libxapp-gtk3-module.so  0.0.0.0\r\n0x7fb2a50e4000 - 0x7fb2a50e800f  libX11-xcb.so.1  0.0.0.0\r\n0x7fb2a5100000 - 0x7fb2a51362b7  ld-linux-x86-64.so.2  0.0.0.0\r\n0x7fffffb8f000 - 0x7fffffb8fe3c  linux-vdso.so.1  0.0.0.0\r\n```\r\n\r\n</details>\ntemporary workaround for anyone experiencing this:\r\nlaunch vesktop with\r\n```\r\nelectron29 /usr/lib/vesktop/app.asar\r\n```\r\n(note: requires, obviously, electron29 to be installed)\nThe issue persists in 30.0.1 as well as 31.0.0-alpha.1 and 31.0.0-alpha.2.\nSame issue in our application; we have reverted to version 29 in https://github.com/neanes/neanes/pull/648.\nI could not reproduce this only by maximizing/setting Electron to fullscreen. But could reliably produce a crash by creating at least 3 browser windows and then attempting to maximize any of them.\r\n\r\nHere's a gist: https://gist.github.com/rvcalisto/a8e35699d18189d1d74cada4965ee779\r\n\r\nElectron terminated with SIGSEGV on both of my Manjaro and Kubuntu Linux VMs (X11).\nsame problem. resolve pls\nSame problem on Linux Mint.\n![3679-747f-8397-0524~3](https://github.com/electron/electron/assets/77581683/94d08c3e-131c-401c-a4cb-2f3e848d528b)\r\nThe same problem on Ubuntu\nI see that no one's attached any logs yet, so I've attached the coredump that shows up in my journalctl when it crashes. \r\n\r\n**Electron version**: 30.0.1\r\n**OS**: Arch Linux\r\n**WM**: Wayfire\r\n\r\nNote that the app doesn't need to be fullscreen - simply tiling the app using my WM's keybindings causes it to crash. On the other hand, resizing the window manually seems to be fine. \r\n\r\n- [coredump.log](https://github.com/electron/electron/files/15124979/coredump.log)\nThreema Desktop is also affected by this when launching under Electron 30.0.1 or 30.0.0-beta.7 (Wayland, Sway WM). There is no fullscreen involved, it immediately segfaults on launch. Launching in floating mode (as opposed to tiled mode) doesn't seem to help either.\r\n\r\nI can also confirm that 30.0.0-alpha.6 does not segfault, both in tiling and in floating mode, both with and without `--ozone-platform-hint=auto --enable-features=WaylandWindowDecorations` startup options.\r\n\r\nThe stack trace (created using `minidump-stackwalk`) shows this function call at the top:\r\n\r\n```\r\nCrash reason:  SIGSEGV / SEGV_MAPERR\r\nCrash address: 0x0000000000000000\r\nProcess uptime: 0 seconds\r\n\r\nThread 0 electron (crashed)\r\n 0  electron!views::View::UpdateChildLayerBounds(views::View::LayerOffsetData const&) [raw_ptr.h : 938 + 0x0]\r\n     rax = 0x0000000000000000    rdx = 0x0000000000000000\r\n     rcx = 0x0000000000000000    rbx = 0x00007ffed5afad40\r\n     rsi = 0x00007ffed5afad40    rdi = 0x0000331400105780\r\n     rbp = 0x00007ffed5afad20    rsp = 0x00007ffed5afacb0\r\n      r8 = 0x00000000000009e8     r9 = 0xffffffff800009fe\r\n     r10 = 0x000033140014c828    r11 = 0x00000000000001be\r\n     r12 = 0x0000000000000000    r13 = 0x0000331400105780\r\n     r14 = 0x00007ffed5afad40    r15 = 0x0000000001010101\r\n     rip = 0x0000602fdd92fd5a\r\n    Found by: given as instruction pointer in context\r\n```\r\n\r\nPotentially related to #39449 ?\nperhaps related to https://github.com/electron/electron/issues/41970\r\ncould it be that all these cases that were crashing were apps handling some protocol and calling maximize()?\nmy app has protocol handling, but the issue is also reproducible from the default Fiddle boilerplate, which doesn't.\nThe changes on the `30-x-y` branch between `v30.0.0-alpha.6` and `v30.0.0-alpha.7` are the following (newest to oldest):\r\n\r\n```\r\nb713e34947 - (tag: v30.0.0-alpha.7) chore: bump chromium to 124.0.6355.1 (30-x-y) (#41490) (7 weeks ago electron-roller[bot])\r\nb39f36496d - fix: improve caption button appearance on Windows 11 (#41586) (7 weeks ago trop[bot])\r\nd16f1d52e8 - docs: `nativeImage` api cleanup (#41570) (7 weeks ago trop[bot])\r\nd3b182f8b9 - fix: `chrome://process-internals` failing to load (#41540) (7 weeks ago trop[bot])\r\n35099d9289 - docs: Update code signing documentation (#41553) (7 weeks ago trop[bot])\r\n```\r\n\r\n(Crashes happen on Alpha 7, but not on Alpha 6.)\r\n\r\nI'm fairly sure that from that list only the Chromium bump commit is relevant (from 124.0.6331.0 to 124.0.6355.1).\r\n\r\nSo the change that introduced the crashes in Electron is probably commit b713e349478ab034b15ddd220a5872d0751035b8, and possibly a change in Chromium between 124.0.6331.0 and 124.0.6355.1). Additionally, the function that crashes (`views::View::UpdateChildLayerBounds`) is part of Chromium, not Electron.\nTo avoid confusion and better help devs find this issue, I'm editing the title & original post to be about maximizing rather than fullscreen\nI'm able to reproduce the crash with the gist that @rvcalisto posted in https://github.com/electron/electron/issues/41839#issuecomment-2075278091. Thanks!\r\n\r\nHere's a gdb backtrace from that gist with electron v30.0.2 running on Ubuntu 24.04. Oddly, it _doesn't_ have `UpdateChildLayerBounds()` in the call stack :thinking: but it seems likely that both traces have the same root cause.\r\n\r\n```\r\nThread 1 \"electron\" received signal SIGSEGV, Segmentation fault.\r\n0x0000555561057b72 in operator() () at ../../third_party/libc++/src/include/__functional/operations.h:358\r\n358\t    return __x < __y;\r\n(gdb) bt\r\n#0  0x0000555561057b72 in operator() () at ../../third_party/libc++/src/include/__functional/operations.h:358\r\n#1  operator() () at ../../third_party/libc++/src/include/map:640\r\n#2  __lower_bound<void const*> () at ../../third_party/libc++/src/include/__tree:2143\r\n#3  find<void const*> () at ../../third_party/libc++/src/include/__tree:2086\r\n#4  find () at ../../third_party/libc++/src/include/map:1367\r\n#5  TriggerChangedCallback () at ../../ui/base/metadata/metadata_types.cc:60\r\n#6  0x000055556125069e in OnPropertyChanged () at ../../ui/views/view.cc:2909\r\n#7  SetBoundsRect () at ../../ui/views/view.cc:487\r\n#8  0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#9  0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#10 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#11 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#12 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#13 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#14 0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#15 0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#16 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#17 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#18 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#19 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#20 0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#21 0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#22 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#23 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#24 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#25 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#26 0x0000555561297768 in Layout () at ../../ui/views/window/non_client_view.cc:125\r\n#27 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#28 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#29 0x0000555561298919 in Layout () at ../../ui/views/window/non_client_view.cc:272\r\n#30 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#31 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#32 0x00005555612440ad in ApplyLayout () at ../../ui/views/layout/layout_manager_base.cc:214\r\n#33 0x0000555561243dd2 in LayoutImpl () at ../../ui/views/layout/layout_manager_base.cc:186\r\n#34 0x0000555561243645 in Layout () at ../../ui/views/layout/layout_manager_base.cc:103\r\n#35 0x00005555612534cb in Layout () at ../../ui/views/view.cc:911\r\n#36 0x0000555561250ab4 in LayoutImmediately () at ../../ui/views/view.cc:3646\r\n#37 0x00005555612504f1 in SetBoundsRect () at ../../ui/views/view.cc:459\r\n#38 0x0000555561251217 in SetBounds () at ../../ui/views/view.cc:401\r\n--Type <RET> for more, q to quit, c to continue without paging--\r\n#39 SetSize () at ../../ui/views/view.cc:495\r\n#40 0x0000555561277840 in OnNativeWidgetSizeChanged () at ../../ui/views/widget/widget.cc:1681\r\n#41 0x00005555612c48b4 in OnHostResized () at ../../ui/views/widget/desktop_aura/desktop_native_widget_aura.cc:1476\r\n#42 0x0000555561050fbc in OnHostResizedInPixels () at ../../ui/aura/window_tree_host.cc:605\r\n#43 0x0000555561053006 in OnBoundsChanged () at ../../ui/aura/window_tree_host_platform.cc:255\r\n#44 0x00005555595961a9 in non-virtual thunk to electron::ElectronDesktopWindowTreeHostLinux::OnBoundsChanged(ui::PlatformWindowDelegate::BoundsChange const&) ()\r\n    at ../../electron/shell/browser/ui/electron_desktop_window_tree_host_linux.cc:50\r\n#45 0x000055555a2f91d8 in NotifyBoundsChanged () at ../../ui/ozone/platform/x11/x11_window.cc:2670\r\n#46 0x000055555a2fa159 in DelayedResize () at ../../ui/ozone/platform/x11/x11_window.cc:2603\r\n#47 0x00005555593432a0 in Run () at ../../base/functional/callback.h:156\r\n#48 0x000055555982fe18 in ForwardOnce<>(void) () at ../../base/cancelable_callback.h:134\r\n#49 0x000055555937e11b in Invoke<void (electron::api::BrowserWindow::*)(), base::WeakPtr<electron::api::BrowserWindow> const&> ()\r\n    at ../../base/functional/bind_internal.h:738\r\n#50 MakeItSo<void (electron::api::BrowserWindow::* const&)(), std::__Cr::tuple<base::WeakPtr<electron::api::BrowserWindow> > const&> ()\r\n    at ../../base/functional/bind_internal.h:954\r\n#51 RunImpl<void (electron::api::BrowserWindow::* const&)(), std::__Cr::tuple<base::WeakPtr<electron::api::BrowserWindow> > const&, 0ul> ()\r\n    at ../../base/functional/bind_internal.h:1067\r\n#52 Run () at ../../base/functional/bind_internal.h:987\r\n#53 0x00005555593432a0 in Run () at ../../base/functional/callback.h:156\r\n#54 0x000055555ec713ad in RunTaskImpl () at ../../base/task/common/task_annotator.cc:203\r\n#55 0x000055555eca6e83 in RunTask<(lambda at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:475:11)> ()\r\n    at ../../base/task/common/task_annotator.h:90\r\n#56 DoWorkImpl () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:473\r\n#57 0x000055555eca63ab in DoWork () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:338\r\n#58 0x000055555eca7825 in non-virtual thunk to base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork() ()\r\n#59 0x000055555ed37123 in Run () at ../../base/message_loop/message_pump_glib.cc:694\r\n#60 0x000055555eca8040 in Run () at ../../base/task/sequence_manager/thread_controller_with_message_pump_impl.cc:641\r\n#61 0x000055555ec5015e in Run () at ../../base/run_loop.cc:134\r\n#62 0x000055555d5db2c7 in RunMainMessageLoop () at ../../content/browser/browser_main_loop.cc:1104\r\n#63 0x000055555d5dd825 in Run () at ../../content/browser/browser_main_runner_impl.cc:159\r\n#64 0x000055555d5d726a in BrowserMain () at ../../content/browser/browser_main.cc:34\r\n#65 0x000055555975b176 in RunBrowserProcessMain () at ../../content/app/content_main_runner_impl.cc:712\r\n#66 0x000055555975deb1 in RunBrowser () at ../../content/app/content_main_runner_impl.cc:1303\r\n#67 0x000055555975d489 in Run () at ../../content/app/content_main_runner_impl.cc:1148\r\n#68 0x0000555559759947 in RunContentProcess () at ../../content/app/content_main.cc:331\r\n#69 0x0000555559759c60 in ContentMain () at ../../content/app/content_main.cc:344\r\n#70 0x000055555933b539 in main () at ../../electron/shell/app/electron_main_linux.cc:45\r\n```\nHmm. It smells like a memory error to me, so I tried the same gist with an asan build of v30.0.2 and am not seeing a crash there.\r\n\r\nMaybe it's a timing issue instead & asan is changing the timing just enough to not tickle the crash :thinking: \nCrashing here (Ubuntu) as well since I upgraded to version 30.0.1 from ~29. I see the same SIGSEGV issue.\nI can confirm that 30.0.2 also exhibits this issue. We have multiple users complaining about segfaults on launch across various distributions (Arch, Fedora, Debian). Some report that they have a window tiling manager that will also crash on a few older versions of Electron. I personally just tested this out with Manjaro and Plasma, and I can observe that the main window is being drawn properly, but not maximized. However, the app will call maximize immediately after window creation. But the window never actually maximizes, indicating that it is indeed the maximizing step that causes the core dump. Possibly also an interaction with tiling managers, so I think there may be a wider issue that in general relates to how window operations are handled.\r\n\r\nEDIT: The bug seems to not appear on the current 29er line Electron version (29.3.2) and that one runs fine for all users who reported segfaults before.", "created_at": "2024-05-10 22:42:08", "merge_commit_sha": "c56e1dffb0adc6140b8b112678885cbccfc3d6f6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-42111", "base_commit": "e2acdffe58ad9b622ca1fd983348bf4ce26f9379", "patch": "diff --git a/docs/api/protocol.md b/docs/api/protocol.md\nindex 6d2de18751de4..3f4ce799a1370 100644\n--- a/docs/api/protocol.md\n+++ b/docs/api/protocol.md\n@@ -9,10 +9,14 @@ An example of implementing a protocol that has the same effect as the\n \n ```js\n const { app, protocol, net } = require('electron')\n+const path = require('node:path')\n+const url = require('node:url')\n \n app.whenReady().then(() => {\n-  protocol.handle('atom', (request) =>\n-    net.fetch('file://' + request.url.slice('atom://'.length)))\n+  protocol.handle('atom', (request) => {\n+    const filePath = request.url.slice('atom://'.length)\n+    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+  })\n })\n ```\n \n@@ -42,7 +46,7 @@ app.whenReady().then(() => {\n \n   ses.protocol.handle('atom', (request) => {\n     const filePath = request.url.slice('atom://'.length)\n-    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+    return net.fetch(url.pathToFileURL(path.resolve(__dirname, filePath)).toString())\n   })\n \n   const mainWindow = new BrowserWindow({ webPreferences: { partition } })\n", "test_patch": "", "problem_statement": "[Bug]: protocol.handle fails when filename contains '#'\n### Preflight Checklist\n\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n30.0.2\n\n### What operating system are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 10 version 22H2\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nThe image should display as normal.\n\n### Actual Behavior\n\nWhen you're handling a file:// protocol request, it's being treated like a regular URL. However, the file:// protocol is different from HTTP or HTTPS URLs in how it handles characters like #. In a file:// URL, the # character is typically part of the file or directory name and is not treated as a fragment identifier like in HTTP URLs.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/KBriscoe/550df36cd29a4d27a7672f1404a9e990\n\n### Additional Information\n\nIf using the gist, the filepaths need to be updated in the renderer.js to actual images. The issue is when the image contains '#' in my case and I looked through the protocol.handle and saw it was treating it like a web request I believe where # usually means to truncate off the rest of the request. So it ends up trying to get an incorrect path item.\n", "hints_text": "", "created_at": "2024-05-10 00:27:52", "merge_commit_sha": "88f28a302ff2ba6fd3698e1cb1cfb6497d178f32", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41875", "base_commit": "c670e38b4b14d0286e0ae04cb7f63987beb5e044", "patch": "diff --git a/shell/common/api/electron_api_native_image_mac.mm b/shell/common/api/electron_api_native_image_mac.mm\nindex cf9c6cdcfa37f..e45eaae9a9387 100644\n--- a/shell/common/api/electron_api_native_image_mac.mm\n+++ b/shell/common/api/electron_api_native_image_mac.mm\n@@ -14,6 +14,7 @@\n \n #include \"base/apple/foundation_util.h\"\n #include \"base/strings/sys_string_conversions.h\"\n+#include \"base/task/bind_post_task.h\"\n #include \"gin/arguments.h\"\n #include \"shell/common/gin_converters/image_converter.h\"\n #include \"shell/common/gin_helper/promise.h\"\n@@ -38,6 +39,23 @@\n   return def;\n }\n \n+void ReceivedThumbnailResult(CGSize size,\n+                             gin_helper::Promise<gfx::Image> p,\n+                             QLThumbnailRepresentation* thumbnail,\n+                             NSError* error) {\n+  if (error || !thumbnail) {\n+    std::string err_msg([error.localizedDescription UTF8String]);\n+    p.RejectWithErrorMessage(\"unable to retrieve thumbnail preview \"\n+                             \"image for the given path: \" +\n+                             err_msg);\n+  } else {\n+    NSImage* result = [[NSImage alloc] initWithCGImage:[thumbnail CGImage]\n+                                                  size:size];\n+    gfx::Image image(result);\n+    p.Resolve(image);\n+  }\n+}\n+\n // static\n v8::Local<v8::Promise> NativeImage::CreateThumbnailFromPath(\n     v8::Isolate* isolate,\n@@ -70,31 +88,15 @@\n                      size:cg_size\n                     scale:[screen backingScaleFactor]\n       representationTypes:QLThumbnailGenerationRequestRepresentationTypeAll]);\n-  __block gin_helper::Promise<gfx::Image> p = std::move(promise);\n+  __block auto block_callback = base::BindPostTaskToCurrentDefault(\n+      base::BindOnce(&ReceivedThumbnailResult, cg_size, std::move(promise)));\n+  auto completionHandler =\n+      ^(QLThumbnailRepresentation* thumbnail, NSError* error) {\n+        std::move(block_callback).Run(thumbnail, error);\n+      };\n   [[QLThumbnailGenerator sharedGenerator]\n       generateBestRepresentationForRequest:request\n-                         completionHandler:^(\n-                             QLThumbnailRepresentation* thumbnail,\n-                             NSError* error) {\n-                           if (error || !thumbnail) {\n-                             std::string err_msg(\n-                                 [error.localizedDescription UTF8String]);\n-                             dispatch_async(dispatch_get_main_queue(), ^{\n-                               p.RejectWithErrorMessage(\n-                                   \"unable to retrieve thumbnail preview \"\n-                                   \"image for the given path: \" +\n-                                   err_msg);\n-                             });\n-                           } else {\n-                             NSImage* result = [[NSImage alloc]\n-                                 initWithCGImage:[thumbnail CGImage]\n-                                            size:cg_size];\n-                             gfx::Image image(result);\n-                             dispatch_async(dispatch_get_main_queue(), ^{\n-                               p.Resolve(image);\n-                             });\n-                           }\n-                         }];\n+                         completionHandler:completionHandler];\n \n   return handle;\n }\ndiff --git a/shell/common/platform_util_mac.mm b/shell/common/platform_util_mac.mm\nindex 60419c7b28daa..32972a5dfe44f 100644\n--- a/shell/common/platform_util_mac.mm\n+++ b/shell/common/platform_util_mac.mm\n@@ -15,11 +15,15 @@\n #include \"base/apple/osstatus_logging.h\"\n #include \"base/files/file_path.h\"\n #include \"base/files/file_util.h\"\n+#include \"base/functional/bind.h\"\n #include \"base/functional/callback.h\"\n #include \"base/logging.h\"\n #include \"base/mac/scoped_aedesc.h\"\n #include \"base/strings/stringprintf.h\"\n #include \"base/strings/sys_string_conversions.h\"\n+#include \"base/task/thread_pool.h\"\n+#include \"content/public/browser/browser_task_traits.h\"\n+#include \"content/public/browser/browser_thread.h\"\n #include \"net/base/apple/url_conversions.h\"\n #include \"ui/views/widget/widget.h\"\n #include \"url/gurl.h\"\n@@ -183,15 +187,12 @@ void OpenExternal(const GURL& url,\n     return;\n   }\n \n-  bool activate = options.activate;\n-  __block OpenCallback c = std::move(callback);\n-  dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0),\n-                 ^{\n-                   __block std::string error = OpenURL(ns_url, activate);\n-                   dispatch_async(dispatch_get_main_queue(), ^{\n-                     std::move(c).Run(error);\n-                   });\n-                 });\n+  base::ThreadPool::PostTaskAndReplyWithResult(\n+      FROM_HERE,\n+      {base::MayBlock(), base::WithBaseSyncPrimitives(),\n+       base::TaskPriority::USER_BLOCKING,\n+       base::TaskShutdownBehavior::SKIP_ON_SHUTDOWN},\n+      base::BindOnce(&OpenURL, ns_url, options.activate), std::move(callback));\n }\n \n bool MoveItemToTrashWithError(const base::FilePath& full_path,\ndiff --git a/spec/api-native-image-spec.ts b/spec/api-native-image-spec.ts\nindex 7e055dd6a169f..d498214942af9 100644\n--- a/spec/api-native-image-spec.ts\n+++ b/spec/api-native-image-spec.ts\n@@ -1,6 +1,6 @@\n import { expect } from 'chai';\n import { nativeImage } from 'electron/common';\n-import { ifdescribe, ifit } from './lib/spec-helpers';\n+import { ifdescribe, ifit, itremote, useRemoteContext } from './lib/spec-helpers';\n import * as path from 'node:path';\n \n describe('nativeImage module', () => {\n@@ -426,6 +426,8 @@ describe('nativeImage module', () => {\n   });\n \n   ifdescribe(process.platform !== 'linux')('createThumbnailFromPath(path, size)', () => {\n+    useRemoteContext({ webPreferences: { contextIsolation: false, nodeIntegration: true } });\n+\n     it('throws when invalid size is passed', async () => {\n       const badSize = { width: -1, height: -1 };\n \n@@ -473,6 +475,13 @@ describe('nativeImage module', () => {\n       const result = await nativeImage.createThumbnailFromPath(imgPath, maxSize);\n       expect(result.getSize()).to.deep.equal(maxSize);\n     });\n+\n+    itremote('works in the renderer', async (path: string) => {\n+      const { nativeImage } = require('electron');\n+      const goodSize = { width: 100, height: 100 };\n+      const result = await nativeImage.createThumbnailFromPath(path, goodSize);\n+      expect(result.isEmpty()).to.equal(false);\n+    }, [path.join(fixturesPath, 'assets', 'logo.png')]);\n   });\n \n   describe('addRepresentation()', () => {\ndiff --git a/spec/api-shell-spec.ts b/spec/api-shell-spec.ts\nindex 749677311bd57..a2e9cef96ff8c 100644\n--- a/spec/api-shell-spec.ts\n+++ b/spec/api-shell-spec.ts\n@@ -31,7 +31,7 @@ describe('shell module', () => {\n     });\n     afterEach(closeAllWindows);\n \n-    it('opens an external link', async () => {\n+    async function urlOpened () {\n       let url = 'http://127.0.0.1';\n       let requestReceived: Promise<any>;\n       if (process.platform === 'linux') {\n@@ -53,12 +53,26 @@ describe('shell module', () => {\n         url = (await listen(server)).url;\n         requestReceived = new Promise<void>(resolve => server.on('connection', () => resolve()));\n       }\n+      return { url, requestReceived };\n+    }\n \n+    it('opens an external link', async () => {\n+      const { url, requestReceived } = await urlOpened();\n       await Promise.all<void>([\n         shell.openExternal(url),\n         requestReceived\n       ]);\n     });\n+\n+    it('opens an external link in the renderer', async () => {\n+      const { url, requestReceived } = await urlOpened();\n+      const w = new BrowserWindow({ show: false, webPreferences: { sandbox: false, contextIsolation: false, nodeIntegration: true } });\n+      await w.loadURL('about:blank');\n+      await Promise.all<void>([\n+        w.webContents.executeJavaScript(`require(\"electron\").shell.openExternal(${JSON.stringify(url)})`),\n+        requestReceived\n+      ]);\n+    });\n   });\n \n   describe('shell.trashItem()', () => {\n", "test_patch": "", "problem_statement": "[Bug]: nativeImage.createThumbnailFromPath fails to resolve in renderer process from version 25.0.0\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n29.2.0\r\n\r\n### What operating system are you using?\r\n\r\nmacOS\r\n\r\n### Operating System Version\r\n\r\n13.6 (22G116)\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n24.8.8\r\n\r\n### Expected Behavior\r\n\r\nThe function should resolve as it did in version 24.8.8, returning a thumbnail image or throwing an error if the operation fails.\r\n\r\n### Actual Behavior\r\n\r\nThe function call does not resolve or throw errors, leaving the operation in an unresolved state.\r\n\r\n### Testcase Gist URL\r\n\r\nhttps://gist.github.com/gaodeng/05a4fefb9cde972336a1285821953df6\r\n\r\n### Additional Information\r\n\r\n_No response_\n", "hints_text": "<!-- blocked/need-repro -->\n\nHello @gaodeng. Thanks for reporting this and helping to make Electron better!\n\nWould it be possible for you to make a standalone testcase with only the code necessary to reproduce the issue? For example, [Electron Fiddle](https://www.electronjs.org/fiddle) is a great tool for making small test cases and makes it easy to publish your test case to a [gist](https://gist.github.com) that Electron maintainers can use.\n\nStand-alone test cases make fixing issues go more smoothly: it ensure everyone's looking at the same issue, it removes all unnecessary variables from the equation, and it can also provide the basis for automated regression tests.\n\nNow adding the https://github.com/electron/electron/labels/blocked%2Fneed-repro label for this reason. After you make a test case, please link to it in a followup comment. This issue will be closed in 10 days if the above is not addressed.\nhttps://gist.github.com/gaodeng/05a4fefb9cde972336a1285821953df6\nBisected to https://github.com/electron/electron/compare/v25.0.0-nightly.20230330...v25.0.0-nightly.20230331, likely caused by https://github.com/electron/electron/pull/37701. Haven't narrowed down the specific cause yet but that's where it broke.", "created_at": "2024-04-16 19:11:05", "merge_commit_sha": "ed9fec7da413533788d57a48c97e36dedfc6003c", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41709", "base_commit": "76172fd27ea30bbd50906b5f9bf5c9ee64553b99", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex 0dcfad8aa6dd5..62c5480edf965 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "test_patch": "", "problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "hints_text": "libnotify 0.8.x, **before 0.8.3** is affected by another bug: https://gitlab.gnome.org/GNOME/libnotify/-/issues/34.\r\n\r\nBut libnotify 0.8.3 has fixed its own bug, as I guess it's time for Electron to fix this unexpected `LibnotifyNotification::OnNotificationClosed()` call inside `LibnotifyNotification::Dismiss()`.\r\n\r\nWorkaround for app dev: Don't use `notification.close()` to avoid crash.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nI'm sure this bug still exists in electron 28.2.1 and 29.0.0-beta.6.\njust tested it in 28.2.3, there it is still an issue\nYou can also work around this crash by forcing libnotify to use dbus instead of the portal with the env var `NOTIFY_IGNORE_PORTAL=1`.\r\n\r\nYou need to add this to your flatpak build file:\r\n```yaml\r\nfinish-args:\r\n   - --talk-name=org.freedesktop.Notifications\r\n   - --env=NOTIFY_IGNORE_PORTAL=1\r\n```\r\n\r\nexample from my project: https://github.com/flathub/chat.delta.desktop/pull/125/commits/cf25cd0fa8c12a14cd52ee4c1600114b5b12f35e", "created_at": "2024-03-27 09:54:34", "merge_commit_sha": "f4b7aa540145278459f8ab92319e2d0074687afb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['Validate PR Title', '.github/workflows/semantic.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41707", "base_commit": "3b025ec0c7b3442ebe3a2040b059bc2da5a80bc5", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex 0dcfad8aa6dd5..62c5480edf965 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "test_patch": "", "problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "hints_text": "libnotify 0.8.x, **before 0.8.3** is affected by another bug: https://gitlab.gnome.org/GNOME/libnotify/-/issues/34.\r\n\r\nBut libnotify 0.8.3 has fixed its own bug, as I guess it's time for Electron to fix this unexpected `LibnotifyNotification::OnNotificationClosed()` call inside `LibnotifyNotification::Dismiss()`.\r\n\r\nWorkaround for app dev: Don't use `notification.close()` to avoid crash.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nI'm sure this bug still exists in electron 28.2.1 and 29.0.0-beta.6.\njust tested it in 28.2.3, there it is still an issue\nYou can also work around this crash by forcing libnotify to use dbus instead of the portal with the env var `NOTIFY_IGNORE_PORTAL=1`.\r\n\r\nYou need to add this to your flatpak build file:\r\n```yaml\r\nfinish-args:\r\n   - --talk-name=org.freedesktop.Notifications\r\n   - --env=NOTIFY_IGNORE_PORTAL=1\r\n```\r\n\r\nexample from my project: https://github.com/flathub/chat.delta.desktop/pull/125/commits/cf25cd0fa8c12a14cd52ee4c1600114b5b12f35e", "created_at": "2024-03-27 09:54:28", "merge_commit_sha": "3698f892052f8d63ef5668b1064b39bc646c4ea3", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-41691", "base_commit": "b9c4b27781495224e309eb75554a6cec21981982", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex e039b382e3e24..4c8452fad1a8d 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "test_patch": "", "problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "hints_text": "libnotify 0.8.x, **before 0.8.3** is affected by another bug: https://gitlab.gnome.org/GNOME/libnotify/-/issues/34.\r\n\r\nBut libnotify 0.8.3 has fixed its own bug, as I guess it's time for Electron to fix this unexpected `LibnotifyNotification::OnNotificationClosed()` call inside `LibnotifyNotification::Dismiss()`.\r\n\r\nWorkaround for app dev: Don't use `notification.close()` to avoid crash.\nThis issue has been automatically marked as stale. **If this issue is still affecting you, please leave any comment** (for example, \"bump\"), and we'll keep it open. If you have any new additional information\u2014in particular, if this is still reproducible in the [latest version of Electron](https://www.electronjs.org/releases/stable) or in the [beta](https://www.electronjs.org/releases/beta)\u2014please include it with your comment!\nI'm sure this bug still exists in electron 28.2.1 and 29.0.0-beta.6.\njust tested it in 28.2.3, there it is still an issue\nYou can also work around this crash by forcing libnotify to use dbus instead of the portal with the env var `NOTIFY_IGNORE_PORTAL=1`.\r\n\r\nYou need to add this to your flatpak build file:\r\n```yaml\r\nfinish-args:\r\n   - --talk-name=org.freedesktop.Notifications\r\n   - --env=NOTIFY_IGNORE_PORTAL=1\r\n```\r\n\r\nexample from my project: https://github.com/flathub/chat.delta.desktop/pull/125/commits/cf25cd0fa8c12a14cd52ee4c1600114b5b12f35e", "created_at": "2024-03-25 21:04:41", "merge_commit_sha": "4f76fff97879ee8f9b2d0dcfd43e686ff8757c69", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-105352", "base_commit": "215acd52e82f4c575abb715e25e54558deeef998", "patch": "diff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\nindex f201b7c8d8dd..4caf51dc5a01 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\n@@ -22,7 +22,7 @@ partial class ExportedFields\n         values.Add(PropertyName.@_fieldInt16, global::Godot.Variant.From<short>(___fieldInt16_default_value));\n         int ___fieldInt32_default_value = 10;\n         values.Add(PropertyName.@_fieldInt32, global::Godot.Variant.From<int>(___fieldInt32_default_value));\n-        long ___fieldInt64_default_value = 10;\n+        long ___fieldInt64_default_value = -10_000;\n         values.Add(PropertyName.@_fieldInt64, global::Godot.Variant.From<long>(___fieldInt64_default_value));\n         byte ___fieldByte_default_value = 10;\n         values.Add(PropertyName.@_fieldByte, global::Godot.Variant.From<byte>(___fieldByte_default_value));\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\nindex ce154cad8e88..0bf0b0845a45 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\n@@ -36,7 +36,7 @@ partial class ExportedProperties\n         values.Add(PropertyName.@PropertyInt16, global::Godot.Variant.From<short>(__PropertyInt16_default_value));\n         int __PropertyInt32_default_value = 10;\n         values.Add(PropertyName.@PropertyInt32, global::Godot.Variant.From<int>(__PropertyInt32_default_value));\n-        long __PropertyInt64_default_value = 10;\n+        long __PropertyInt64_default_value = -10_000;\n         values.Add(PropertyName.@PropertyInt64, global::Godot.Variant.From<long>(__PropertyInt64_default_value));\n         byte __PropertyByte_default_value = 10;\n         values.Add(PropertyName.@PropertyByte, global::Godot.Variant.From<byte>(__PropertyByte_default_value));\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\nindex 0938d10afe58..07ae5cb68427 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\n@@ -9,7 +9,7 @@ public partial class ExportedFields : GodotObject\n     [Export] private SByte _fieldSByte = 10;\n     [Export] private Int16 _fieldInt16 = 10;\n     [Export] private Int32 _fieldInt32 = 10;\n-    [Export] private Int64 _fieldInt64 = 10;\n+    [Export] private Int64 _fieldInt64 = -10_000;\n     [Export] private Byte _fieldByte = 10;\n     [Export] private UInt16 _fieldUInt16 = 10;\n     [Export] private UInt32 _fieldUInt32 = 10;\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\nindex 9ae23066fc4b..d7fcdc6b1b58 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\n@@ -97,7 +97,7 @@ public String LamdaPropertyString\n     [Export] private SByte PropertySByte { get; set; } = 10;\n     [Export] private Int16 PropertyInt16 { get; set; } = 10;\n     [Export] private Int32 PropertyInt32 { get; set; } = 10;\n-    [Export] private Int64 PropertyInt64 { get; set; } = 10;\n+    [Export] private Int64 PropertyInt64 { get; set; } = -10_000;\n     [Export] private Byte PropertyByte { get; set; } = 10;\n     [Export] private UInt16 PropertyUInt16 { get; set; } = 10;\n     [Export] private UInt32 PropertyUInt32 { get; set; } = 10;\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\nindex fff32a108004..6c3824711f8c 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\n@@ -430,6 +430,13 @@ private static bool IsStaticallyResolvable(ExpressionSyntax expression, Semantic\n                 return true;\n             }\n \n+            // Handle negative literals (e.g., `-10`)\n+            if (expression is PrefixUnaryExpressionSyntax { Operand: LiteralExpressionSyntax } &&\n+                expression.Kind() == SyntaxKind.UnaryMinusExpression)\n+            {\n+                return true;\n+            }\n+\n             // Handle identifiers (e.g., variable names)\n             if (expression is IdentifierNameSyntax identifier)\n             {\n", "test_patch": "", "problem_statement": "Default export values are ignored if negative\n### Tested versions\n\n- Reproducible in 4.5.dev [215acd52e82f4c575abb715e25e54558deeef998]\n- Not reproducible in 4.4.1 and earlier\n\n### System information\n\nGodot v4.5.dev.mono (215acd52e) - Linux Mint 22.1 (Xia) on X11 - X11 display driver, Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (nvidia; 550.120) - 13th Gen Intel(R) Core(TM) i5-13600KF (20 threads)\n\n### Issue description\n\nWhen setting a default value to an export property, if the value is negative, the editor does not recognize the value as the default. Setting the value to `0` will not be saved to the `.tscn` since the editor still thinks it's the default value for the type.\n\n![Image](https://github.com/user-attachments/assets/66e7fecb-c086-44b8-89a9-176bad5edd4f)\n\n![Image](https://github.com/user-attachments/assets/a64167a0-7273-4884-8b16-4d789572ad57)\n\n![Image](https://github.com/user-attachments/assets/f90f40fc-615c-4057-9b29-5713cf95ca07)\n\n### Steps to reproduce\n\nCreate a Node with a script.\nAdd an export property of type `int` and set the default value to a negative number.\nAdd the node to scene.\nSave and reopen the scene.\n\n### Minimal reproduction project (MRP)\n\n[ExportTest.zip](https://github.com/user-attachments/files/19725812/ExportTest.zip)\n", "hints_text": "", "created_at": "2025-04-13 16:05:07", "merge_commit_sha": "9f2a78aa8acdd319df3963df1fb3ba693d61bf03", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-105114", "base_commit": "a210fe6dbd27cc01bffacb0ce2816e0cf303af5e", "patch": "diff --git a/drivers/unix/os_unix.cpp b/drivers/unix/os_unix.cpp\nindex d3e4ca92defb..10f8b0ba38a3 100644\n--- a/drivers/unix/os_unix.cpp\n+++ b/drivers/unix/os_unix.cpp\n@@ -805,6 +805,57 @@ Dictionary OS_Unix::execute_with_pipe(const String &p_path, const List<String> &\n #endif\n }\n \n+int OS_Unix::_wait_for_pid_completion(const pid_t p_pid, int *r_status, int p_options) {\n+\twhile (true) {\n+\t\tif (waitpid(p_pid, r_status, p_options) != -1) {\n+\t\t\t// Thread exited normally.\n+\t\t\treturn 0;\n+\t\t}\n+\t\tconst int error = errno;\n+\t\tif (error == EINTR) {\n+\t\t\t// We're in a debugger, should call waitpid again.\n+\t\t\t// See https://stackoverflow.com/a/45472920/730797.\n+\t\t\tcontinue;\n+\t\t}\n+\t\treturn error;\n+\t}\n+}\n+\n+bool OS_Unix::_check_pid_is_running(const pid_t p_pid, int *r_status) const {\n+\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n+\n+\tif (pi && !pi->is_running) {\n+\t\t// Can return cached value.\n+\t\tif (r_status) {\n+\t\t\t*r_status = pi->exit_code;\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n+\tint status = 0;\n+\tconst int result = _wait_for_pid_completion(p_pid, &status, WNOHANG);\n+\tif (result == 0) {\n+\t\t// Thread is still running.\n+\t\treturn true;\n+\t}\n+\n+\tERR_FAIL_COND_V_MSG(result == -1, false, vformat(\"Thread %d exited with errno: %d\", (int)p_pid, errno));\n+\t// Thread exited normally.\n+\n+\tstatus = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n+\n+\tif (pi) {\n+\t\tpi->is_running = false;\n+\t\tpi->exit_code = status;\n+\t}\n+\n+\tif (r_status) {\n+\t\t*r_status = status;\n+\t}\n+\n+\treturn false;\n+}\n+\n Error OS_Unix::execute(const String &p_path, const List<String> &p_arguments, String *r_pipe, int *r_exitcode, bool read_stderr, Mutex *p_pipe_mutex, bool p_open_console) {\n #ifdef __EMSCRIPTEN__\n \t// Don't compile this code at all to avoid undefined references.\n@@ -870,12 +921,12 @@ Error OS_Unix::execute(const String &p_path, const List<String> &p_arguments, St\n \t\traise(SIGKILL);\n \t}\n \n-\tint status;\n-\twaitpid(pid, &status, 0);\n+\tint status = 0;\n+\tconst int result = _wait_for_pid_completion(pid, &status, 0);\n \tif (r_exitcode) {\n \t\t*r_exitcode = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n \t}\n-\treturn OK;\n+\treturn result ? FAILED : OK;\n #endif\n }\n \n@@ -929,7 +980,7 @@ Error OS_Unix::kill(const ProcessID &p_pid) {\n \tif (!ret) {\n \t\t//avoid zombie process\n \t\tint st;\n-\t\t::waitpid(p_pid, &st, 0);\n+\t\t_wait_for_pid_completion(p_pid, &st, 0);\n \t}\n \treturn ret ? ERR_INVALID_PARAMETER : OK;\n }\n@@ -940,42 +991,19 @@ int OS_Unix::get_process_id() const {\n \n bool OS_Unix::is_process_running(const ProcessID &p_pid) const {\n \tMutexLock lock(process_map_mutex);\n-\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n-\n-\tif (pi && !pi->is_running) {\n-\t\treturn false;\n-\t}\n-\n-\tint status = 0;\n-\tif (waitpid(p_pid, &status, WNOHANG) != 0) {\n-\t\tif (pi) {\n-\t\t\tpi->is_running = false;\n-\t\t\tpi->exit_code = status;\n-\t\t}\n-\t\treturn false;\n-\t}\n-\n-\treturn true;\n+\treturn _check_pid_is_running(p_pid, nullptr);\n }\n \n int OS_Unix::get_process_exit_code(const ProcessID &p_pid) const {\n \tMutexLock lock(process_map_mutex);\n-\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n \n-\tif (pi && !pi->is_running) {\n-\t\treturn pi->exit_code;\n+\tint exit_code = 0;\n+\tif (_check_pid_is_running(p_pid, &exit_code)) {\n+\t\t// Thread is still running\n+\t\treturn -1;\n \t}\n \n-\tint status = 0;\n-\tif (waitpid(p_pid, &status, WNOHANG) != 0) {\n-\t\tstatus = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n-\t\tif (pi) {\n-\t\t\tpi->is_running = false;\n-\t\t\tpi->exit_code = status;\n-\t\t}\n-\t\treturn status;\n-\t}\n-\treturn -1;\n+\treturn exit_code;\n }\n \n String OS_Unix::get_locale() const {\ndiff --git a/drivers/unix/os_unix.h b/drivers/unix/os_unix.h\nindex 8fde52b5ff00..febc7c79cd89 100644\n--- a/drivers/unix/os_unix.h\n+++ b/drivers/unix/os_unix.h\n@@ -71,6 +71,9 @@ class OS_Unix : public OS {\n \tvoid _load_iconv();\n #endif\n \n+\tstatic int _wait_for_pid_completion(const pid_t p_pid, int *r_status, int p_options);\n+\tbool _check_pid_is_running(const pid_t p_pid, int *r_status) const;\n+\n protected:\n \t// UNIX only handles the core functions.\n \t// inheriting platforms under unix (eg. X11) should handle the rest\n", "test_patch": "", "problem_statement": "Unit tests fail under `lldb` supervision\n### Tested versions\n\na210fe6dbd27cc01bffacb0ce2816e0cf303af5e / 4.0+\n\n### System information\n\nGodot v4.4.1.stable - macOS Sequoia (15.3.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M1 Max (Apple7) - Apple M1 Max (10 threads)\n\n### Issue description\n\nWhen using `lldb`, `test_os.h` fails `[OS] Execute`.\nThis is a regression from https://github.com/godotengine/godot/pull/42069 (4.0), cc @Calinou.\n\n### Steps to reproduce\n\n1. Be on macOS (may fail on linux too)\n2. run  `\u276f lldb bin/godot.macos.editor.arm64 -- --test`\n3. run `run`\n4. Observe the error:\n\n```\n./tests/core/os/test_os.h:199: ERROR: CHECK( exit_code == 0 ) is NOT correct!\n  values: CHECK( 230 == 0 )\n  logged: Running the command `sh -c \"ls > /dev/null\"` returns a zero (successful) exit code.\n\nProcess 42405 stopped\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BREAKPOINT (code=1, subcode=0x1005063b0)\n    frame #0: 0x00000001005063b0 godot.macos.editor.arm64.master`TestOS::DOCTEST_ANON_FUNC_4825() at test_os.h:197:2 [opt]\n   194          CHECK_MESSAGE(\n   195                          err == OK,\n   196                          \"(Running the command `sh -c \\\"ls > /dev/null\\\"` returns the expected Godot error code (OK).\");\n-> 197          CHECK_MESSAGE(\n   198                          exit_code == 0,\n   199                          \"Running the command `sh -c \\\"ls > /dev/null\\\"` returns a zero (successful) exit code.\");\n   200  #endif\nTarget 0: (godot.macos.editor.arm64.master) stopped.\nwarning: godot.macos.editor.arm64.master was compiled with optimization - stepping may behave oddly; variables may not be available.\n```\n\nThe rest of the unit tests run through, so deleting the test is a temporary fix.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "I don't really know how this works, but I've tested this on a WSL Environment and this is what I got:\n```\nProcess 38477 launched: '/home/seif-eldin/repos/godot/bin/godot.linuxbsd.editor.dev.x86_64.llvm' (x86_64)\nProcess 38477 stopped and restarted: thread 1 received signal: SIGCHLD\n[doctest] doctest version is \"2.4.11\"\n[doctest] run with \"--help\" for options\ntERROR: Unrecognized binary resource file: 'res://gltf_placed_in_dot_godot_imported.scn'.\n   at: open (./core/io/resource_format_binary.cpp:1002)\nERROR: EditorNode doesn't exist.\n   at: make_scene_preview (./editor/editor_interface.cpp:236)\nERROR: Unrecognized binary resource file: 'res://gltf_pointing_to_texture_outside_of_res_folder.scn'.\n   at: open (./core/io/resource_format_binary.cpp:1002)\nERROR: EditorNode doesn't exist.\n   at: make_scene_preview (./editor/editor_interface.cpp:236)\nERROR: Unrecognized binary resource file: 'res://embedded_texture.scn'.\n   at: open (./core/io/resource_format_binary.cpp:1002)\nERROR: EditorNode doesn't exist.\n   at: make_scene_preview (./editor/editor_interface.cpp:236)\nProcess 38477 stopped and restarted: thread 1 received signal: SIGCHLD\n===============================================================================\n[doctest] test cases:    1216 |    1216 passed | 0 failed | 3 skipped\n[doctest] assertions: 2441777 | 2441777 passed | 0 failed |\n[doctest] Status: SUCCESS!\nProcess 38477 exited with status = 0 (0x00000000) \n```\nSo probably MacOS only\nI can reproduce it, but not sure what's the reason, seems like `fork` fail under LLDB.", "created_at": "2025-04-07 11:14:45", "merge_commit_sha": "d9a367649ee3d83f9ac875f9419cbdab476a80c6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-105039", "base_commit": "a210fe6dbd27cc01bffacb0ce2816e0cf303af5e", "patch": "diff --git a/editor/gui/editor_spin_slider.cpp b/editor/gui/editor_spin_slider.cpp\nindex e68e3dcc9f42..99acf4e171dd 100644\n--- a/editor/gui/editor_spin_slider.cpp\n+++ b/editor/gui/editor_spin_slider.cpp\n@@ -435,10 +435,8 @@ void EditorSpinSlider::_draw_spin_slider() {\n \t\t\t\t\tgrabber->set_texture(grabber_tex);\n \t\t\t\t}\n \n-\t\t\t\tVector2 scale = get_global_transform_with_canvas().get_scale();\n-\t\t\t\tgrabber->set_scale(scale);\n \t\t\t\tgrabber->reset_size();\n-\t\t\t\tgrabber->set_position((grabber_rect.get_center() - grabber->get_size() * 0.5) * scale);\n+\t\t\t\tgrabber->set_position(grabber_rect.get_center() - grabber->get_size() * 0.5);\n \n \t\t\t\tif (mousewheel_over_grabber) {\n \t\t\t\t\tInput::get_singleton()->warp_mouse(grabber->get_position() + grabber_rect.size);\n", "test_patch": "", "problem_statement": "Animation Node Blend Tree Slider drag handle not aligning when zoomed\n### Tested versions\n\nReproducible in: \nv4.4.1.stable.mono.official [49a5bc7b6]\nv4.4.stable.mono.official [4c311cbee] \n\nWorking correctly in:\nv4.3.stable.mono.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable.mono - Windows 10.0.19045 - GLES3 (Compatibility) - NVIDIA GeForce RTX 2070 (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (16 Threads)\n\n### Issue description\n\nWhen using an AnimationNodeBlendTree and zooming in on sliders like the blend slider, the handle for grabbing is offset from the view when it should remain on the line \n\n4.3 Working correctly:\n![Image](https://github.com/user-attachments/assets/e1fb6ded-e1e6-458e-8797-c552f6d2c23a)\n\n4.4.1 being offset:\n![Image](https://github.com/user-attachments/assets/4eec11e9-6e98-4e7d-9685-58f7a04d6cbc)\n\n### Steps to reproduce\n\n* Open a new project\n* Add an AnimationTree node\n* Add an AnimationNodeBlendTree to it\n* In the AnimationTree window right click and add a blend2 \n* Hover the blend slider and zoom in to see that the offset of the handle is not on the slider\n\n\n### Minimal reproduction project (MRP)\n\nTo ensure it was not my theme settings I reset all my theme settings in both 4.4 and 4.4.1\n\nI then downloaded 4.3 and set up the project again and it was not the case. \n\nHere's my a copy of a project with a scene set up in 4.4.1, but it's pretty easy to set up\n\n[BlendTreeIssue_4.4.1.zip](https://github.com/user-attachments/files/19600739/BlendTreeIssue_4.4.1.zip)\n\n", "hints_text": "", "created_at": "2025-04-05 00:31:08", "merge_commit_sha": "d025e99a46c305489d6b3ee31ce480d8a22649dc", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-105007", "base_commit": "af2c713971499953373380b9ae8673f64423bd59", "patch": "diff --git a/scene/gui/code_edit.cpp b/scene/gui/code_edit.cpp\nindex 9722b5e2eefa..870c5bbf842d 100644\n--- a/scene/gui/code_edit.cpp\n+++ b/scene/gui/code_edit.cpp\n@@ -1645,12 +1645,12 @@ bool CodeEdit::can_fold_line(int p_line) const {\n \t\tif (delimiter_end_line == p_line) {\n \t\t\t/* Check we are the start of the block. */\n \t\t\tif (p_line - 1 >= 0) {\n-\t\t\t\tif ((in_string != -1 && is_in_string(p_line - 1) != -1) || (in_comment != -1 && is_in_comment(p_line - 1) != -1)) {\n+\t\t\t\tif ((in_string != -1 && is_in_string(p_line - 1) != -1) || (in_comment != -1 && is_in_comment(p_line - 1) != -1 && !is_line_code_region_start(p_line - 1) && !is_line_code_region_end(p_line - 1))) {\n \t\t\t\t\treturn false;\n \t\t\t\t}\n \t\t\t}\n \t\t\t/* Check it continues for at least one line. */\n-\t\t\treturn ((in_string != -1 && is_in_string(p_line + 1) != -1) || (in_comment != -1 && is_in_comment(p_line + 1) != -1));\n+\t\t\treturn ((in_string != -1 && is_in_string(p_line + 1) != -1) || (in_comment != -1 && is_in_comment(p_line + 1) != -1 && !is_line_code_region_start(p_line + 1) && !is_line_code_region_end(p_line + 1)));\n \t\t}\n \t\treturn ((in_string != -1 && is_in_string(delimiter_end_line) != -1) || (in_comment != -1 && is_in_comment(delimiter_end_line) != -1));\n \t}\n@@ -1705,6 +1705,10 @@ void CodeEdit::fold_line(int p_line) {\n \t\t\t\t\tif ((in_string != -1 && is_in_string(i) == -1) || (in_comment != -1 && is_in_comment(i) == -1)) {\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n+\t\t\t\t\tif (in_comment != -1 && (is_line_code_region_start(i) || is_line_code_region_end(i))) {\n+\t\t\t\t\t\t// A code region tag should split a comment block, ending it early.\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t\tend_line = i;\n \t\t\t\t}\n \t\t\t}\n", "test_patch": "diff --git a/tests/scene/test_code_edit.h b/tests/scene/test_code_edit.h\nindex 6938b16bc7db..223365425656 100644\n--- a/tests/scene/test_code_edit.h\n+++ b/tests/scene/test_code_edit.h\n@@ -3269,6 +3269,47 @@ TEST_CASE(\"[SceneTree][CodeEdit] folding\") {\n \t\tCHECK(code_edit->get_next_visible_line_offset_from(1, 1) == 4);\n \t}\n \n+\tSUBCASE(\"[CodeEdit] folding comments including and/or adjacent to code regions\") {\n+\t\tcode_edit->add_comment_delimiter(\"#\", \"\", true);\n+\n+\t\t// Single line comment directly above a code region tag is not foldable.\n+\t\tcode_edit->set_text(\"#line0\\n#region a\\nnothing\\n#line3\\n#endregion\");\n+\t\tCHECK_FALSE(code_edit->can_fold_line(0));\n+\t\tCHECK_FALSE(code_edit->can_fold_line(3));\n+\n+\t\t// Comment blocks.\n+\t\t// Foldable even when directly below a code region start tag.\n+\t\tcode_edit->set_text(\"#line0\\n#line1\\n#region a\\n#line3\\n#line4\\nnothing\\n#endregion\");\n+\t\tCHECK(code_edit->can_fold_line(3));\n+\n+\t\t// Doesn't fold beyond region start tag.\n+\t\tcode_edit->fold_line(0);\n+\t\tCHECK(code_edit->is_line_folded(0));\n+\t\tCHECK_EQ(code_edit->get_visible_line_count_in_range(0, 1), 1);\n+\t\tCHECK_EQ(code_edit->get_visible_line_count_in_range(2, 2), 1);\n+\n+\t\t// Foldable even when directly below a code region end tag.\n+\t\tcode_edit->set_text(\"#region a\\nnothing\\n#line2\\n#line3\\n#endregion\\n#line5\\n#line6\");\n+\t\tCHECK(code_edit->can_fold_line(5));\n+\n+\t\t// Doesn't fold beyond region end tag.\n+\t\tcode_edit->fold_line(2);\n+\t\tCHECK(code_edit->is_line_folded(2));\n+\t\tCHECK_EQ(code_edit->get_visible_line_count_in_range(2, 3), 1);\n+\t\tCHECK_EQ(code_edit->get_visible_line_count_in_range(4, 4), 1);\n+\n+\t\tcode_edit->add_comment_delimiter(\"/*\", \"*/\", false);\n+\n+\t\t// Multiline comments.\n+\t\t// Folds a region tag inside it.\n+\t\tcode_edit->set_text(\"/*\\nnothing\\n#region a\\n*/\\n#endregion\");\n+\t\tCHECK(code_edit->can_fold_line(0));\n+\t\tcode_edit->fold_line(0);\n+\t\tCHECK(code_edit->is_line_folded(0));\n+\t\tCHECK_EQ(code_edit->get_visible_line_count_in_range(0, 3), 1);\n+\t\tCHECK_EQ(code_edit->get_visible_line_count_in_range(4, 4), 1);\n+\t}\n+\n \tSUBCASE(\"[CodeEdit] folding carets\") {\n \t\t// Folding a line moves all carets that would be hidden.\n \t\tcode_edit->set_text(\"test\\n\\tline1\\n\\t\\tline 2\\n\");\n", "problem_statement": "Hashtag comments after \"#region\" command won't fold the multiline comment unless there is space.\n### Tested versions\n\nV4.3\n\n### System information\n\nWin11\n\n### Issue description\n\nWhen putting \"#region\" command, the hashtag comments after it won't fold unless there is a space between. Happens with both a single hashtag and double hashtag comments. But it won't happen with triple quotes -comment.\n\n### Steps to reproduce\n\nAfter command \"#region\" add \"#\" or \"##\" comment next line without any space.\n\n### Minimal reproduction project (MRP)\n\n![Image](https://github.com/user-attachments/assets/40e5627f-2a48-4c93-a8e2-b9fce6acbd5c)\n", "hints_text": "", "created_at": "2025-04-04 08:01:29", "merge_commit_sha": "6fce829fce83f0f9f3cb8dcda121a15ae9cc0cf1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104962", "base_commit": "6392241742796dc50ce2c5102cf5147033eba63a", "patch": "diff --git a/scene/resources/portable_compressed_texture.cpp b/scene/resources/portable_compressed_texture.cpp\nindex 99317af5a113..32c7a0965e6a 100644\n--- a/scene/resources/portable_compressed_texture.cpp\n+++ b/scene/resources/portable_compressed_texture.cpp\n@@ -171,6 +171,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t}\n \t\t} break;\n \t\tcase COMPRESSION_MODE_BASIS_UNIVERSAL: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_BASIS_UNIVERSAL, buffer.ptrw() + 2);\n \t\t\tImage::UsedChannels uc = p_image->detect_used_channels(p_normal_map ? Image::COMPRESS_SOURCE_NORMAL : Image::COMPRESS_SOURCE_GENERIC);\n \t\t\tVector<uint8_t> budata = Image::basis_universal_packer(p_image, uc);\n@@ -180,6 +181,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\tcase COMPRESSION_MODE_S3TC:\n \t\tcase COMPRESSION_MODE_ETC2:\n \t\tcase COMPRESSION_MODE_BPTC: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_IMAGE, buffer.ptrw() + 2);\n \t\t\tRef<Image> copy = p_image->duplicate();\n \t\t\tswitch (p_compression_mode) {\n@@ -195,7 +197,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t\tdefault: {\n \t\t\t\t};\n \t\t\t}\n-\n+\t\t\tencode_uint32(copy->get_format(), buffer.ptrw() + 4);\n \t\t\tbuffer.append_array(copy->get_data());\n \n \t\t} break;\n", "test_patch": "", "problem_statement": "Unexpected image buffer size when creating PortableCompressedTexture2D from Image\n### Tested versions\n\n- Reproducible in v4.5.dev [1f56d96cf], 4.4.1.stable [96579d139]\n\n### System information\n\nWindows 11 Vulkan (Forward+)\n\n### Issue description\n\nWhen trying to create a PortableCompressedTexture2D from an Image, the following error shows when using compressed formats.\n```\n  ERROR: Expected Image data size of 512x512x3 (RGB8 without mipmaps) = 786432 bytes, got 131072 bytes instead.\n  ERROR: Width must be equal or greater than 1 for all textures\n```\nIf `COMPRESSION_MODE_LOSSLESS `is used, there's no error displayed. Most probably, what's happening is that the Image data buffer is compressed here:\nhttps://github.com/godotengine/godot/blob/1f56d96cf2c768c3844c68ccb504dfeee841ae15/scene/resources/portable_compressed_texture.cpp#L182-L204\nSo the buffer is no longer of the expected size, since it is compressed.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Open the script `test.gd`\n- Then run the script with File > Run\n\n### Minimal reproduction project (MRP)\n\n[test.zip](https://github.com/user-attachments/files/19578958/test.zip)\n", "hints_text": "", "created_at": "2025-04-03 10:41:56", "merge_commit_sha": "cb8cb95bdda52aff2a167d912ab1d6c11df54b5c", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104744", "base_commit": "7598b08ec2ccf6c5bbc2c2020f583fc625e3238b", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 31a8d07fea80..789909b22351 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -148,7 +148,9 @@ def detect_build_env_arch():\n \n \n def get_tools(env: \"SConsEnvironment\"):\n-    if os.name != \"nt\" or env.get(\"use_mingw\"):\n+    from SCons.Tool.MSCommon import msvc_exists\n+\n+    if os.name != \"nt\" or env.get(\"use_mingw\") or not msvc_exists():\n         return [\"mingw\"]\n     else:\n         msvc_arch_aliases = {\"x86_32\": \"x86\", \"arm32\": \"arm\"}\n", "test_patch": "", "problem_statement": "[Windows] Scons isn't detecting MinGW and fails when building\n### Tested versions\n\n- Reproducible in master (4.5.dev) - commit [6b5b84c0c50135e88691e035d3e00c68a2ae5aa4]\n- **Not** reproducible in 4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7735HS with Radeon Graphics (16 threads)\n\n### Issue description\n\nScons fails to detect MinGW (I'm using [LLVM-MinGW](https://github.com/mstorsjo/llvm-mingw/releases/)) which is included in my PATH, then complains it can't find MSVC and errors out. Scons works perfectly fine for me in 4.4 stable.\n\nThis is what I get when trying to build on master:\n\n```\n> scons\nscons: Reading SConscript files ...\nAutomatically detected platform: windows\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink', 'mslib']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\nBuilding for platform \"windows\", architecture \"x86_64\", target \"template_release\".\nKeyError: 'VSWHERE':\n  File \"D:\\Godot Dev\\godot\\SConstruct\", line 623:\n    cc_version = methods.get_compiler_version(env)\n  File \"D:\\Godot Dev\\godot\\methods.py\", line 698:\n    env[\"VSWHERE\"],\n  File \"C:\\Users\\ahmou\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python311\\site-packages\\SCons\\Environment.py\", line 603:\n    return self._dict[key]\n```\n\n### Steps to reproduce\n\nTry building on Windows with MinGW, without MSVC installed\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "What commit specifically are you building from to get an idea of where this is occuring\nUpdated the post to include the commit SHA, it's `6b5b84c0c50135e88691e035d3e00c68a2ae5aa4`\nTo build with MinGW on Windows, you need to specific `mingw=yes` explicitly, otherwise it defaults to MSVC.\n\nI'm surprised it would work differently in 4.4.stable.\n\nCC @Repiteo in case there were recent changes.\n> To build with MinGW on Windows, you need to specific mingw=yes explicitly, otherwise it defaults to MSVC.\r\n\r\nI never had to specify it specifically before. For what it's worth I think falling back to mingw if you don't have MSVC should be the intended behavior.\r\n\r\n~~Also, it turns out compiling with `mingw=yes` doesn't work either. Same error.~~ Nevermind, The command is `use_mingw=yes` and that works fine. My bad!\r\n\r\n<details>\r\n<summary> output </summary>\r\n<pre><code>> scons mingw=yes\r\nscons: Reading SConscript files ...\r\nAutomatically detected platform: windows\r\n\r\nscons: warning: No versions of the MSVC compiler were found.\r\n  Visual Studio C/C++ compilers may not be set correctly.\r\n  Requested tool(s) are: ['msvc']\r\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\r\n\r\nscons: warning: No versions of the MSVC compiler were found.\r\n  Visual Studio C/C++ compilers may not be set correctly.\r\n  Requested tool(s) are: ['msvc', 'mslink']\r\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\r\n\r\nscons: warning: No versions of the MSVC compiler were found.\r\n  Visual Studio C/C++ compilers may not be set correctly.\r\n  Requested tool(s) are: ['msvc', 'mslink', 'mslib']\r\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\r\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\r\nBuilding for platform \"windows\", architecture \"x86_64\", target \"editor\".\r\nKeyError: 'VSWHERE':\r\n  File \"D:\\Godot Dev\\godot\\SConstruct\", line 623:\r\n    cc_version = methods.get_compiler_version(env)\r\n  File \"D:\\Godot Dev\\godot\\methods.py\", line 698:\r\n    env[\"VSWHERE\"],\r\n  File \"C:\\Users\\ahmou\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python311\\site-packages\\SCons\\Environment.py\", line 603:\r\n    return self._dict[key]</code></pre>\r\n</details>\nI haven't tested, but I suspect it may be a regression from #103864.\nI use `scons use_mingw=yes use_llvm=yes` with [LLVM-MinGW](https://github.com/mstorsjo/llvm-mingw/releases/), it works fine for me.\nMinGW should absolutely be the fallback option if MSVC isn't available, but that'll be tricky to test with on a PC that already has that environment integrated. I'll run some tests on a virtual machine & see what I can find.\n\n> Also, it turns out compiling with `mingw=yes` doesn't work either. Same error.\n\nOop, that's the wrong name. You'll want `use_mingw=yes` instead. I'll make `mingw` an alias in the fix PR.\n> MinGW should absolutely be the fallback option if MSVC isn't available, but that'll be tricky to test with on a PC that already has that environment integrated. I'll run some tests on a virtual machine & see what I can find.\n\nThis is supposed to happen already (since 4.0 if not earlier), but it's not working for some reason.", "created_at": "2025-03-28 21:57:24", "merge_commit_sha": "08615299b7aaadee88cdd05662e88d2b337c2719", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104669", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex 42cd8632941d..6e76f06a3095 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -933,15 +933,16 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n+\t\t\t\tconst String file_path = ia.dir->get_file_path(idx);\n+\t\t\t\tconst String class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n+\t\t\t\t\t_queue_update_script_class(file_path, ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n-\t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n+\t\t\t\t\t_queue_update_scene_groups(file_path);\n \t\t\t\t}\n \n-\t\t\t\t_delete_internal_files(ia.dir->files[idx]->file);\n+\t\t\t\t_delete_internal_files(file_path);\n \t\t\t\tmemdelete(ia.dir->files[idx]);\n \t\t\t\tia.dir->files.remove_at(idx);\n \n", "test_patch": "", "problem_statement": ".import / .uid file is not removed when original file is not in root directory and gets removed outside editor\n### Tested versions\n\n4.4 dev4\nLikely earlier too.\n\n### System information\n\nWindows 10.0.19045 - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1060 (NVIDIA; 32.0.15.6603) - Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz (8 threads)\n\n### Issue description\n\nWhen you delete a file outside editor, Godot tries to delete corresponding .import/.uid file. However this only happens if the file is in the project's root directory. If it's in any subdirectory, the other file just stays there and you have to delete it manually.\n\n### Steps to reproduce\n\n1. Open project's root directory in OS' file manager\n2. Delete icon.svg\n3. Focus the editor\n4. The engine will process FileSystem and automatically delete icon.svg.import.\n5. Try again with icon.svg in a subfolder\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "I am confused by a related question: \nIs it safe to copy one project's addons which contain some .uid files to another project? What if the uids are already exist in the target project?\nOr do we need to add .uid into `.gitignore` file if we use a version control tool? Do we need to delete .uid files after we copy scripts from an old project into a new project?\nEach generated .uid file is unique, so if you copy them between projects they will work as expected.\nThanks, I checked the code:\nhttps://github.com/godotengine/godot/blob/cf038deb1033007167a05a4518a0e8b2dae5e93e/core/io/resource_uid.cpp#L88-L100\n\nI can understand the newly generated uid won't be the same as existing uids in a project, but there are some chances that two projects generate the same uid, aren't there?\n\nImagine this situation:\nProject A: `a.gd.uid` which content is `uid://4pmd34mck18a`, \nProject B: `b.gd.uid` which content is also `uid://4pmd34mck18a` ,\nWhen copying `a.gd` and `a.gd.uid` into Project B, some error will occur.\n\nIn fact, for a long time, I have the same concern about copying files like `.tscn` from one project to another project because I fear that the resource ids in `.tscn` will accidentally be same as those in the target project. The newly introduced `.uid` file raised my concern again. \n\nI can't do much to `.tscn`, `.tres` files but I can add .uid into `.gitignore` especially for addons if I want to share them with others but I don't know if this is even necessary or a good idea. Do you have any suggestions?\n> there are some chances that two projects generate the same uid, aren't there?\n\nThere are, but very very low. I think the editor can already deal with duplicate UIDs to some extent, but we can improve it. It's unlikely to be a problem though.\n\n> I can add .uid into .gitignore especially for addons if I want to share them with others but I don't know if this is even necessary or a good idea.\n\nIt's not necessary, but it would work. Note however that scenes automatically refer to files by both path and UID, so if you don't provide script's UID and that script is referenced in a scene, you will get an error while loading. The editor is able to fix UID by checking the path, but the error (warning) is still being printed.", "created_at": "2025-03-26 20:21:52", "merge_commit_sha": "2377309c094f64507e98bc7ff446ccb24d443bfe", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104662", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex 19d59e53c99f..d3648c9faf02 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -685,6 +685,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t} else {\n \t\t\tp_table->total_width += p_table->columns[i].width;\n \t\t}\n+\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t}\n \n \t// Resize to max_width if needed and distribute the remaining space.\n@@ -702,6 +703,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\tp_table->columns[i].width = p_table->columns[i].max_width;\n \t\t\t\tp_table->total_width -= dif;\n \t\t\t\ttotal_ratio -= p_table->columns[i].expand_ratio;\n+\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t}\n \t\t}\n \t\t// Grow.\n@@ -715,6 +717,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\t\t\tint incr = MIN(dif, slice);\n \t\t\t\t\t\tp_table->columns[i].width += incr;\n \t\t\t\t\t\tp_table->total_width += incr;\n+\t\t\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n@@ -745,6 +748,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \n \t\t\tframe->lines[i].text_buf->set_width(p_table->columns[column].width);\n \t\t\tp_table->columns[column].width = MAX(p_table->columns[column].width, ceil(frame->lines[i].text_buf->get_size().x));\n+\t\t\tp_table->columns[column].width_with_padding = MAX(p_table->columns[column].width_with_padding, ceil(frame->lines[i].text_buf->get_size().x + frame->padding.position.x + frame->padding.size.x));\n \n \t\t\tframe->lines[i].offset.y = prev_h;\n \n@@ -780,6 +784,12 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t}\n \t\tidx++;\n \t}\n+\n+\t// Recalculate total width.\n+\tp_table->total_width = 0;\n+\tfor (int i = 0; i < col_count; i++) {\n+\t\tp_table->total_width += p_table->columns[i].width_with_padding + theme_cache.table_h_separation;\n+\t}\n }\n \n int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_ofs, int p_width, float p_vsep, const Color &p_base_color, int p_outline_size, const Color &p_outline_color, const Color &p_font_shadow_color, int p_shadow_outline_size, const Point2 &p_shadow_ofs, int &r_processed_glyphs) {\ndiff --git a/scene/gui/rich_text_label.h b/scene/gui/rich_text_label.h\nindex 013ee15c03fe..dd1cedcd8bb5 100644\n--- a/scene/gui/rich_text_label.h\n+++ b/scene/gui/rich_text_label.h\n@@ -347,6 +347,7 @@ class RichTextLabel : public Control {\n \t\t\tint min_width = 0;\n \t\t\tint max_width = 0;\n \t\t\tint width = 0;\n+\t\t\tint width_with_padding = 0;\n \t\t};\n \n \t\tLocalVector<Column> columns;\n", "test_patch": "", "problem_statement": "RichTextLabel table with padding and BBCode enabled cause misalignment\n### Tested versions\n\nv4.5.dev.custom_build.6b4fda04c\n\n### System information\n\nGodot v4.5.dev (6b4fda04c) - Ubuntu 22.04.5 LTS 22.04 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - D3D12 (AMD Radeon(TM) Graphics) - AMD Ryzen 5 5600H with Radeon Graphics (12 threads)\n\n### Issue description\n\nWhen using a RichTextLabel with BBCode enabled, tables with padding display incorrect horizontal and vertical alignment. This issue only occurs when BBCode is enabled.\nI would like to fix this bug as my first contribution to Godot. I'm already investigating the offset calculation in the relevant functions and would appreciate any guidance from the maintainers on the correct approach.\n\nhttps://github.com/user-attachments/assets/b1a6895c-f446-4fa2-b885-6757e4ca36d9\n\n### Steps to reproduce\n\n1.Create a RichTextLabel node\n2.Enable BBCode (set bbcode_enabled = true)\n3.Set text content with a table that includes padding, for example:\n```\n[table=1]\n[cell bg=black padding=20,20,20,20]Lorem ipsum dolor sit amet, consectetur adipiscing elit.[/cell]\n[/table]\n```\n\n\n### Minimal reproduction project (MRP)\n\n[padding-misalignment.zip](https://github.com/user-attachments/files/19135134/padding-misalignment.zip)\n", "hints_text": "", "created_at": "2025-03-26 18:51:57", "merge_commit_sha": "ca1f4454035804af0a18973e7b86bce87abc9ac4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104614", "base_commit": "1ba856565d726d32e07f86610668966e9904115d", "patch": "diff --git a/scene/gui/control.cpp b/scene/gui/control.cpp\nindex a64de8fb3c5d..57bc748bfe90 100644\n--- a/scene/gui/control.cpp\n+++ b/scene/gui/control.cpp\n@@ -481,9 +481,9 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t}\n \n \t// Validate which positioning properties should be displayed depending on the parent and the layout mode.\n-\tNode *parent_node = get_parent_control();\n-\tif (!parent_node) {\n-\t\t// If there is no parent, display both anchor and container options.\n+\tControl *parent_control = get_parent_control();\n+\tif (!parent_control) {\n+\t\t// If there is no parent control, display both anchor and container options.\n \n \t\t// Set the layout mode to be disabled with the proper value.\n \t\tif (p_property.name == \"layout_mode\") {\n@@ -496,7 +496,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\tif (!use_custom_anchors && (p_property.name.begins_with(\"anchor_\") || p_property.name.begins_with(\"offset_\") || p_property.name.begins_with(\"grow_\"))) {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_EDITOR;\n \t\t}\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\t// If the parent is a container, display only container-related properties.\n \t\tif (p_property.name.begins_with(\"anchor_\") || p_property.name.begins_with(\"offset_\") || p_property.name.begins_with(\"grow_\") || p_property.name == \"anchors_preset\") {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_DEFAULT;\n@@ -508,7 +508,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\t\tp_property.usage |= PROPERTY_USAGE_READ_ONLY;\n \t\t} else if (p_property.name == \"size_flags_horizontal\" || p_property.name == \"size_flags_vertical\") {\n \t\t\t// Filter allowed size flags based on the parent container configuration.\n-\t\t\tContainer *parent_container = Object::cast_to<Container>(parent_node);\n+\t\t\tContainer *parent_container = Object::cast_to<Container>(parent_control);\n \t\t\tVector<int> size_flags;\n \t\t\tif (p_property.name == \"size_flags_horizontal\") {\n \t\t\t\tsize_flags = parent_container->get_allowed_size_flags_horizontal();\n@@ -548,7 +548,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\t\t}\n \t\t}\n \t} else {\n-\t\t// If the parent is NOT a container or not a control at all, display only anchoring-related properties.\n+\t\t// If the parent is a non-container control, display only anchoring-related properties.\n \t\tif (p_property.name.begins_with(\"size_flags_\")) {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_EDITOR;\n \n@@ -570,7 +570,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t}\n \n \t// Disable the property if it's managed by the parent container.\n-\tif (!Object::cast_to<Container>(parent_node)) {\n+\tif (!Object::cast_to<Container>(parent_control)) {\n \t\treturn;\n \t}\n \tbool property_is_managed_by_container = false;\n@@ -905,11 +905,11 @@ void Control::_update_layout_mode() {\n }\n \n Control::LayoutMode Control::_get_layout_mode() const {\n-\tNode *parent_node = get_parent_control();\n+\tControl *parent_control = get_parent_control();\n \t// In these modes the property is read-only.\n-\tif (!parent_node) {\n+\tif (!parent_control) {\n \t\treturn LayoutMode::LAYOUT_MODE_UNCONTROLLED;\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\treturn LayoutMode::LAYOUT_MODE_CONTAINER;\n \t}\n \n@@ -918,20 +918,25 @@ Control::LayoutMode Control::_get_layout_mode() const {\n \t\treturn LayoutMode::LAYOUT_MODE_ANCHORS;\n \t}\n \n-\t// Otherwise fallback on what's stored.\n-\treturn data.stored_layout_mode;\n+\t// Only position/anchors modes are valid for non-container control parent.\n+\tif (data.stored_layout_mode == LayoutMode::LAYOUT_MODE_POSITION || data.stored_layout_mode == LayoutMode::LAYOUT_MODE_ANCHORS) {\n+\t\treturn data.stored_layout_mode;\n+\t}\n+\n+\t// Otherwise fallback to position mode.\n+\treturn LayoutMode::LAYOUT_MODE_POSITION;\n }\n \n Control::LayoutMode Control::_get_default_layout_mode() const {\n-\tNode *parent_node = get_parent_control();\n+\tControl *parent_control = get_parent_control();\n \t// In these modes the property is read-only.\n-\tif (!parent_node) {\n+\tif (!parent_control) {\n \t\treturn LayoutMode::LAYOUT_MODE_UNCONTROLLED;\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\treturn LayoutMode::LAYOUT_MODE_CONTAINER;\n \t}\n \n-\t// Otherwise fallback on the position mode.\n+\t// Otherwise fallback to the position mode.\n \treturn LayoutMode::LAYOUT_MODE_POSITION;\n }\n \n", "test_patch": "", "problem_statement": "Layout Mode becomes `2` when parent type is changed\n### Tested versions\n\n4.5 dev1\nProbably earlier too\n\n### System information\n\nW10\n\n### Issue description\n\nWhen a Control node is under a Container and the Container is changed to Control, the child's Layout Mode changes to `2` (which is Container, but without name?)\n\nhttps://github.com/user-attachments/assets/f0bb6975-4a6a-4516-92b1-93e795917629\n\n### Steps to reproduce\n\n1. Add a Container node\n2. Add a Control as its child\n3. Change Type of the Container to Control\n4. Check the Layout Mode of its child\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Could confirm, saw it before in 4.4 stable.\nIt showing `2` is directly caused by #102743 as it made the actual value be shown in case it doesn't match any value from the `hint_string`.\n\nControl changes `hint_string` for the `layout_mode` in `validate_property` depending on the setup:\nhttps://github.com/godotengine/godot/blob/6b5b84c0c50135e88691e035d3e00c68a2ae5aa4/scene/gui/control.cpp#L489-L490\nhttps://github.com/godotengine/godot/blob/6b5b84c0c50135e88691e035d3e00c68a2ae5aa4/scene/gui/control.cpp#L505-L507\nhttps://github.com/godotengine/godot/blob/6b5b84c0c50135e88691e035d3e00c68a2ae5aa4/scene/gui/control.cpp#L555-L557\n\nSo the actual problem seems to be that it doesn't automatically reset to a valid `layout_mode` according to the current setup? \ud83e\udd14", "created_at": "2025-03-25 16:21:30", "merge_commit_sha": "b7c452a36de2fdd32e96a964ef347df2f08421d1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104599", "base_commit": "6b5b84c0c50135e88691e035d3e00c68a2ae5aa4", "patch": "diff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex ba904f0e9192..02fcbbc7e6a7 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -787,7 +787,6 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tr_info->normal = to_godot(-hit.mPenetrationAxis.Normalized());\n \tr_info->rid = object->get_rid();\n \tr_info->collider_id = object->get_instance_id();\n-\tr_info->shape = 0;\n \tr_info->linear_velocity = object->get_velocity_at_position(hit_point);\n \n \treturn true;\n", "test_patch": "", "problem_statement": "Built-in Jolt Physics colliding shape index is always 0\n### Tested versions\n\n- Reproducible in: v4.4.stable.official [4c311cbee] with built-in Jolt Physics\n- Not reproducible in: v4.3.stable.official [77dcf97d8] with Godot Jolt 0.15.0 Extension from AssetLib\n\n### System information\n\nGodot v4.3.stable - Garuda Linux #1 ZEN SMP PREEMPT_DYNAMIC Fri, 07 Mar 2025 20:18:44 +0000 - X11 - GLES3 (Compatibility) - Mesa Intel(R) HD Graphics 630 (KBL GT2) - Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz (8 Threads)\n\n### Issue description\n\nIssue: When using Godot 4.4 with built-in Jolt Physics, `shape` value in the `get_rest_info()` output dictionary (obtained as ShapeCast3D's `collision_result`) is 0 regardless of the actual shape with which ShapeCast3D collided. \n\nExpected: different shapes have different shape indexes.\n\nThis issue does not occur when using DEFAULT physics on Godot 4.4, and it also doesnt occur when using  Godot Jolt extension or DEFAULT physics on Godot 4.3 version.\n\n### Steps to reproduce\n\n- Open MRP\n- Set project's physics engine to Jolt\n- Launch the game, note the output in the terminal being all 0 (three collision shapes report three different shapes of the same rigid body have index 0)\n- Change project's physics engine to DEFAULT\n- Launch the game, the output in the terminal should read 0 1 2 (three different shapes have different indexes)\n\nIdentical setup in a 4.3 project using the Godot Jolt Extension produces 0 1 2 as expected.\n\n### Minimal reproduction project (MRP)\n\n[ShapeTest4.4.zip](https://github.com/user-attachments/files/19436320/ShapeTest4.4.zip)\n", "hints_text": "Update:\nOn 4.4, downloading the Jolt extension from the AssetLib and using it instead of the built-in Jolt solves the issue presented in the MRP.", "created_at": "2025-03-25 11:38:49", "merge_commit_sha": "b699508b07c40beab8ab332399ec588cb2239240", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104444", "base_commit": "7598b08ec2ccf6c5bbc2c2020f583fc625e3238b", "patch": "diff --git a/scene/gui/control.cpp b/scene/gui/control.cpp\nindex a64de8fb3c5d..8d34746529e7 100644\n--- a/scene/gui/control.cpp\n+++ b/scene/gui/control.cpp\n@@ -1880,16 +1880,20 @@ void Control::set_mouse_recursive_behavior(RecursiveBehavior p_recursive_mouse_b\n \tif (data.mouse_recursive_behavior == p_recursive_mouse_behavior) {\n \t\treturn;\n \t}\n+\t_set_mouse_recursive_behavior_ignore_cache(p_recursive_mouse_behavior);\n+}\n+\n+void Control::_set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior) {\n \tdata.mouse_recursive_behavior = p_recursive_mouse_behavior;\n \tif (p_recursive_mouse_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n+\t\t\t_propagate_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n+\t\t_propagate_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n \t}\n \n \tif (get_viewport()) {\n@@ -2064,16 +2068,20 @@ void Control::set_focus_recursive_behavior(RecursiveBehavior p_recursive_focus_b\n \tif (data.focus_recursive_behavior == p_recursive_focus_behavior) {\n \t\treturn;\n \t}\n+\t_set_focus_recursive_behavior_ignore_cache(p_recursive_focus_behavior);\n+}\n+\n+void Control::_set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_focus_behavior) {\n \tdata.focus_recursive_behavior = p_recursive_focus_behavior;\n \tif (p_recursive_focus_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n+\t\t\t_propagate_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_focus_behavior_recursively(p_recursive_focus_behavior, false);\n+\t\t_propagate_focus_behavior_recursively(p_recursive_focus_behavior, false);\n \t}\n }\n \n@@ -2449,7 +2457,7 @@ bool Control::_is_focus_disabled_recursively() const {\n \treturn false;\n }\n \n-void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n \tif (is_inside_tree() && (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED || (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_INHERITED && p_focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED)) && has_focus()) {\n \t\trelease_focus();\n \t}\n@@ -2463,7 +2471,7 @@ void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_focus_behavior_recursively(p_focus_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_focus_behavior_recursively(p_focus_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -2480,7 +2488,7 @@ bool Control::_is_parent_mouse_disabled() const {\n \treturn false;\n }\n \n-void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n \tif (p_skip_non_inherited && data.mouse_recursive_behavior != RECURSIVE_BEHAVIOR_INHERITED) {\n \t\treturn;\n \t}\n@@ -2490,7 +2498,7 @@ void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -3450,8 +3458,8 @@ void Control::_notification(int p_notification) {\n \n \t\t\t_update_layout_mode();\n \n-\t\t\tset_focus_recursive_behavior(data.focus_recursive_behavior);\n-\t\t\tset_mouse_recursive_behavior(data.mouse_recursive_behavior);\n+\t\t\t_set_focus_recursive_behavior_ignore_cache(data.focus_recursive_behavior);\n+\t\t\t_set_mouse_recursive_behavior_ignore_cache(data.mouse_recursive_behavior);\n \t\t} break;\n \n \t\tcase NOTIFICATION_UNPARENTED: {\ndiff --git a/scene/gui/control.h b/scene/gui/control.h\nindex 8188b3ba31d0..b2001fdd259f 100644\n--- a/scene/gui/control.h\n+++ b/scene/gui/control.h\n@@ -330,8 +330,10 @@ class Control : public CanvasItem {\n \tvoid _window_find_focus_neighbor(const Vector2 &p_dir, Node *p_at, const Rect2 &p_rect, const Rect2 &p_clamp, real_t p_min, real_t &r_closest_dist_squared, Control **r_closest);\n \tControl *_get_focus_neighbor(Side p_side, int p_count = 0);\n \tbool _is_focus_disabled_recursively() const;\n-\tvoid _apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n-\tvoid _apply_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n+\tvoid _set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n \n \t// Theming.\n \n", "test_patch": "", "problem_statement": "[GUI] Setting a control's recursive mode to disabled does not work on start\n### Tested versions\n\nlatest main branch [2303ce843a362cf5497ca3336451de23793eb711]\n\n### System information\n\nGodot v4.5.dev (2303ce843) - Windows 10 (build 19044) - Multi-window, 4 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4060 Ti (NVIDIA; 32.0.15.7260) - AMD Ryzen 9 5900X 12-Core Processor (24 threads)\n\n### Issue description\n\n#97495 introduces properties for managing children's controls' focus mode and mouse filters. However, this won't work if you set the recursive behavior to `Disable` in the editor.\n\n### Steps to reproduce\n\nhttps://github.com/user-attachments/assets/c498932f-8874-4a14-a693-fe0e09b74443\n\n\n### Minimal reproduction project (MRP)\n\n[MrpRecursiveGuiDisable.zip](https://github.com/user-attachments/files/19391423/MrpRecursiveGuiDisable.zip)\n", "hints_text": "", "created_at": "2025-03-21 14:45:21", "merge_commit_sha": "ba3482926daa6450d21b030cfe029689525c0e51", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104384", "base_commit": "97241ffea6df579347653a8ce0c75db44e28f0c8", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 520666faa839..0614aa55bd85 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -6457,6 +6457,18 @@ void EditorNode::reload_instances_with_path_in_edited_scenes() {\n \n \t\t\tget_scene_editor_data_for_node(owner, original_node, scene_editor_data_table);\n \n+\t\t\t// The current node being reloaded may also be an additional node for another node\n+\t\t\t// that is in the process of being reloaded.\n+\t\t\t// Replacing the additional node with the new one prevents a crash where nodes\n+\t\t\t// in 'addition_list' are removed from the scene tree and queued for deletion.\n+\t\t\tfor (InstanceModificationsEntry &im : scene_modifications->instance_list) {\n+\t\t\t\tfor (AdditiveNodeEntry &additive_node_entry : im.addition_list) {\n+\t\t\t\t\tif (additive_node_entry.node == original_node) {\n+\t\t\t\t\t\tadditive_node_entry.node = instantiated_node;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\n \t\t\tbool original_node_scene_instance_load_placeholder = original_node->get_scene_instance_load_placeholder();\n \n \t\t\t// Delete all the remaining node children.\n", "test_patch": "", "problem_statement": "Editor crash when trying to reimport gltf scenes that are nested in godot\n### Tested versions\n\nv4.4.1.rc1.official [daa4b058e]\n\n### System information\n\nGodot v4.4.1.rc1 - macOS Sequoia (15.1.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M1 Max (Apple7) - Apple M1 Max (10 threads)\n\n### Issue description\n\nGodot crashes when trying to reimport two scenes where one scene is a child of another scene\n\nhttps://github.com/user-attachments/assets/95828c6e-d05f-4bb7-bbf8-ae44be9f130b\n\n### Steps to reproduce\n\nOpen the MRP, select both gltf files in the filesystem dock, right click and reimport\n\n### Minimal reproduction project (MRP)\n\n[mrp_nested_gltf_crash.zip](https://github.com/user-attachments/files/19266573/mrp_nested_gltf_crash.zip)\n", "hints_text": "Can reproduce on Windows 10 on 4.4 stable. When selecting `Outer.gltf` first, then `Inner.gltf`, and then reimport, no crash occurs.\nBacktrace investigation:\nCrash in \"reload_instances_with_path_in_edited_scenes\" around some code that was added to increase performance of reloading scenes when re-importing them.\n\n<details>\n<summary>Full Backtrace main/4.5 (ef1153b)</summary>\n\n~~~\nPS C:\\repos\\godot\\bin> .\\godot.windows.editor.dev.x86_64.console.exe \"C:\\Users\\b\\Downloads\\mrp_nested_gltf_crash\\new-game-project\\project.godot\"\nGodot Engine v4.5.dev.custom_build.ef1153baf (2025-03-19 13:54:01 UTC) - https://godotengine.org\nVulkan 1.4.303 - Forward+ - Using Device #0: NVIDIA - NVIDIA GeForce GTX 1080\n\n\n================================================================\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.5.dev.custom_build (ef1153baf3343470b65258421a163c92455d32b3)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] Node::remove_child (C:\\repos\\godot\\scene\\main\\node.cpp:1681)\n[1] EditorNode::reload_instances_with_path_in_edited_scenes (C:\\repos\\godot\\editor\\editor_node.cpp:6434)\n[2] EditorNode::_resources_reimported (C:\\repos\\godot\\editor\\editor_node.cpp:1170)\n[3] call_with_variant_args_helper<EditorNode,Vector<String> const &,0> (C:\\repos\\godot\\core\\variant\\binder_common.h:314)\n[4] call_with_variant_args<EditorNode,Vector<String> const &> (C:\\repos\\godot\\core\\variant\\binder_common.h:429)\n[5] CallableCustomMethodPointer<EditorNode,void,Vector<String> const &>::call (C:\\repos\\godot\\core\\object\\callable_method_pointer.h:108)\n[6] Callable::callp (C:\\repos\\godot\\core\\variant\\callable.cpp:58)\n[7] Object::emit_signalp (C:\\repos\\godot\\core\\object\\object.cpp:1246)\n[8] Node::emit_signalp (C:\\repos\\godot\\scene\\main\\node.cpp:4017)\n[9] Object::emit_signal<Vector<String> > (C:\\repos\\godot\\core\\object\\object.h:923)\n[10] EditorFileSystem::reimport_files (C:\\repos\\godot\\editor\\editor_file_system.cpp:3299)\n[11] ImportDock::_reimport (C:\\repos\\godot\\editor\\import_dock.cpp:689)\n[12] ImportDock::_reimport_attempt (C:\\repos\\godot\\editor\\import_dock.cpp:579)\n[13] ImportDock::reimport_resources (C:\\repos\\godot\\editor\\import_dock.cpp:372)\n[14] FileSystemDock::_file_option (C:\\repos\\godot\\editor\\filesystem_dock.cpp:2502)\n[15] FileSystemDock::_tree_rmb_option (C:\\repos\\godot\\editor\\filesystem_dock.cpp:2111)\n[16] call_with_variant_args_helper<FileSystemDock,int,0> (C:\\repos\\godot\\core\\variant\\binder_common.h:319)\n[17] call_with_variant_args<FileSystemDock,int> (C:\\repos\\godot\\core\\variant\\binder_common.h:429)\n[18] CallableCustomMethodPointer<FileSystemDock,void,int>::call (C:\\repos\\godot\\core\\object\\callable_method_pointer.h:108)\n[19] Callable::callp (C:\\repos\\godot\\core\\variant\\callable.cpp:58)\n[20] Object::emit_signalp (C:\\repos\\godot\\core\\object\\object.cpp:1246)\n[21] Node::emit_signalp (C:\\repos\\godot\\scene\\main\\node.cpp:4017)\n[22] Object::emit_signal<int> (C:\\repos\\godot\\core\\object\\object.h:923)\n[23] PopupMenu::activate_item (C:\\repos\\godot\\scene\\gui\\popup_menu.cpp:2589)\n[24] PopupMenu::_input_from_window_internal (C:\\repos\\godot\\scene\\gui\\popup_menu.cpp:684)\n[25] PopupMenu::_input_from_window (C:\\repos\\godot\\scene\\gui\\popup_menu.cpp:474)\n[26] Window::_window_input (C:\\repos\\godot\\scene\\main\\window.cpp:1698)\n[27] call_with_variant_args_helper<Window,Ref<InputEvent> const &,0> (C:\\repos\\godot\\core\\variant\\binder_common.h:314)\n[28] call_with_variant_args<Window,Ref<InputEvent> const &> (C:\\repos\\godot\\core\\variant\\binder_common.h:429)\n[29] CallableCustomMethodPointer<Window,void,Ref<InputEvent> const &>::call (C:\\repos\\godot\\core\\object\\callable_method_pointer.h:108)\n[30] Callable::callp (C:\\repos\\godot\\core\\variant\\callable.cpp:58)\n[31] Callable::call<Ref<InputEvent> > (C:\\repos\\godot\\core\\variant\\variant.h:955)\n[32] DisplayServerWindows::_dispatch_input_event (C:\\repos\\godot\\platform\\windows\\display_server_windows.cpp:4310)\n[33] DisplayServerWindows::_dispatch_input_events (C:\\repos\\godot\\platform\\windows\\display_server_windows.cpp:4281)\n[34] Input::_parse_input_event_impl (C:\\repos\\godot\\core\\input\\input.cpp:905)\n[35] Input::flush_buffered_events (C:\\repos\\godot\\core\\input\\input.cpp:1186)\n[36] DisplayServerWindows::process_events (C:\\repos\\godot\\platform\\windows\\display_server_windows.cpp:3694)\n[37] OS_Windows::run (C:\\repos\\godot\\platform\\windows\\os_windows.cpp:2075)\n[38] widechar_main (C:\\repos\\godot\\platform\\windows\\godot_windows.cpp:97)\n[39] _main (C:\\repos\\godot\\platform\\windows\\godot_windows.cpp:122)\n[40] main (C:\\repos\\godot\\platform\\windows\\godot_windows.cpp:136)\n[41] WinMain (C:\\repos\\godot\\platform\\windows\\godot_windows.cpp:150)\n[42] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[43] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n================================================================\n~~~\n</details>\n\nFunction involved in the crash:\n~~~\neditor\\editor_node.cpp:6253\nvoid EditorNode::reload_instances_with_path_in_edited_scenes() {\n   ...\n\t// Remove all nodes which were added as additional elements (they will be restored later).\n\tfor (AdditiveNodeEntry additive_node_entry : instance_modifications.addition_list) {\n\t\tNode *addition_node = additive_node_entry.node;\n\t\taddition_node->get_parent()->remove_child(addition_node); // <--- remove_child() call causes crash. \"addition_node->get_parent()\" is null.\n\t}\n   ...\n}\n~~~\n\n<details>\n<summary>Partial solution/deep dive</summary>\n\nTaking a first pass at a fix, adding a check to make sure the parent isn't null in the for loop above fixes the crash, but it leads to some funky behavior. Everything re-imports, but in the scene tree, the \"inner\"/child node asset is removed from the viewport/editor scene tree. It's still in the node asset stored file, so all you have to do is re-open the asset and everything works as expected.\n\nHowever, a user could reimport a set of nested gltf files, then save the parent node scene without verifying everything is correct and lose data, which is probably worse than a crash, so I'm going to leave the crash fix code here and not make a PR (anyone who reads this is free to tackle the rest of it).\n\nPartial Solution:\n~~~\nvoid EditorNode::reload_instances_with_path_in_edited_scenes() {\n        ...\n        // Remove all nodes which were added as additional elements (they will be restored later).\n\tfor (AdditiveNodeEntry additive_node_entry : instance_modifications.addition_list) {\n\t\tNode *addition_node = additive_node_entry.node;\n\t\tif (addition_node->get_parent()) {\n\t\t\taddition_node->get_parent()->remove_child(addition_node);\n\t\t}\n\t}\n        ...\n}\n~~~\n\nFurther down in \"reload_instances_with_path_in_edited_scenes()\" is a section that re-adds these \"addition_node\" nodes that are removed in the above for loop (editor\\editor_node.cpp:6508). This is the \"// ... (they will be restored later)\" bit referenced in the above function.\n\nSingle stepping through this with a debugger didn't show anything useful. The \"inner\" node was properly in the for loop and it hit every normal case below as expected.\n\nI'm guessing something in this area is what needs to be changed as well, but can't seem to find it.\n~~~\neditor\\editor_node.cpp:6508\nvoid EditorNode::reload_instances_with_path_in_edited_scenes() {\n        ...\n        // Attempt to re-add all the additional nodes.\n\tfor (AdditiveNodeEntry additive_node_entry : instance_modifications.addition_list) {\n\t\tNode *parent_node = instantiated_node->get_node_or_null(additive_node_entry.parent);\n\n\t\tif (!parent_node) {\n\t\t\tparent_node = current_edited_scene;\n\t\t}\n\n\t\tparent_node->add_child(additive_node_entry.node);\n\t\tparent_node->move_child(additive_node_entry.node, additive_node_entry.index);\n\t\t// If the additive node's owner was the node which got replaced, update it.\n\t\tif (additive_node_entry.owner == original_node) {\n\t\t\tadditive_node_entry.owner = instantiated_node;\n\t\t}\n\n\t\tadditive_node_entry.node->set_owner(additive_node_entry.owner);\n\n\t\t// If the parent node was lost, attempt to restore the original global transform.\n\t\t{\n\t\t\tNode2D *node_2d = Object::cast_to<Node2D>(additive_node_entry.node);\n\t\t\tif (node_2d) {\n\t\t\t\tnode_2d->set_transform(additive_node_entry.transform_2d);\n\t\t\t}\n\n\t\t\tNode3D *node_3d = Object::cast_to<Node3D>(additive_node_entry.node);\n\t\t\tif (node_3d) {\n\t\t\t\tnode_3d->set_transform(additive_node_entry.transform_3d);\n\t\t\t}\n\t\t}\n\t}\n        ...\n}\n~~~\nA work around if we can't get this \"in place\" reload to work might be to first force save the scene, then detect when this smart reload fails (return false or -1 from \"reload_instances_with_path_in_edited_scenes\") and fall back to a dumb/slow method like just reloading the scene from the file.\n</details>\n\n@Hilderin do you mind taking a peek at this and seeing if anything sticks out to you regarding nested re-importing and the \"reload_instances_with_path_in_edited_scenes\" code around \"// Attempt to re-add all the additional nodes.\"?\nI can reproduce the crash in 4.4.stable and 4.3.stable, but not 4.2.stable.\n\nBetween 4.2 and 4.3, it seems like the crash starts with 4.3.rc3, the last RC before stable. This indeed points at #95225 as @brennennen identified.\n\nIn 4.3.rc2 and earlier, it doesn't crash, but prints this error:\n```\nERROR: Basis [X: (0, 0, 0), Y: (0, 0, 0), Z: (0, 0, 0)] must be normalized in order to be casted to a Quaternion. Use get_rotation_quaternion() or call orthonormalized() if the Basis contains linearly independent vectors.\n   at: get_quaternion (core/math/basis.cpp:725)\n```\nand occasionally the meshes disappear on reimport.\n\nIn both 4.3 and 4.2, the main scene fails loading at first with:\n![Image](https://github.com/user-attachments/assets/164c3b10-b07a-4e2a-b3be-673b83e3d8b7)\n\nBut then double clicking it works fine.", "created_at": "2025-03-19 23:20:46", "merge_commit_sha": "03359c873578b3b14b8615b68db18a52427b8d86", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104346", "base_commit": "594d64ec244b6b99321e2096987d4d69de4c8845", "patch": "diff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex 163501dd37c2..41efb74db0bc 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -4764,6 +4764,7 @@ SceneTreeDock::SceneTreeDock(Node *p_scene_root, EditorSelection *p_editor_selec\n \tscene_tree->connect(\"files_dropped\", callable_mp(this, &SceneTreeDock::_files_dropped));\n \tscene_tree->connect(\"script_dropped\", callable_mp(this, &SceneTreeDock::_script_dropped));\n \tscene_tree->connect(\"nodes_dragged\", callable_mp(this, &SceneTreeDock::_nodes_drag_begin));\n+\tscene_tree->get_scene_tree()->get_vscroll_bar()->connect(\"value_changed\", callable_mp(this, &SceneTreeDock::_reset_hovering_timer).unbind(1));\n \n \tscene_tree->get_scene_tree()->connect(SceneStringName(gui_input), callable_mp(this, &SceneTreeDock::_scene_tree_gui_input));\n \tscene_tree->get_scene_tree()->connect(\"item_icon_double_clicked\", callable_mp(this, &SceneTreeDock::_focus_node));\n", "test_patch": "", "problem_statement": "Editor SceneTree inspects nodes while scrolling with drag & drop\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nThere are 2 overlapping actions. If you drag & drop hover over a node in the SceneTree dock, it will inspect the node. Also, if you drag & drop hover near the top / bottom edge of the tree, it will scroll up and down. But currently they conflict, so dragging near the edge will still trigger the \"inspect node\" action, causing stutter during the scroll\n\nRelated to https://github.com/godotengine/godot/pull/103943#issuecomment-2734859037. I have the same fix ready, but just documenting it here\n\n### Steps to reproduce\n\n- Add a bunch of nodes to the scene tree, enough so that there is plenty to scroll.\n- Click and drag a node from the top / bottom, to the other edge to trigger a scroll, and keep cursor in place while it scrolls.\n- After about half a second, some random node in between will be inspected during the scroll.\n\nhttps://github.com/user-attachments/assets/a49f12e1-6362-42b9-a3bc-67354dc54b41\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-03-19 03:04:18", "merge_commit_sha": "5e8c80ab93b73efaf60814da586b22507e8a25ec", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104317", "base_commit": "215acd52e82f4c575abb715e25e54558deeef998", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 0fbb74939ccd..54a25c62438f 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -4956,12 +4956,6 @@ void EditorInspector::_clear_current_favorites() {\n \tupdate_tree();\n }\n \n-void EditorInspector::_update_theme() {\n-\tupdating_theme = true;\n-\tadd_theme_style_override(SceneStringName(panel), get_theme_stylebox(SceneStringName(panel), SNAME(\"Tree\")));\n-\tupdating_theme = false;\n-}\n-\n void EditorInspector::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_TRANSLATION_CHANGED: {\n@@ -4989,17 +4983,11 @@ void EditorInspector::_notification(int p_what) {\n \t\t\tERR_FAIL_NULL(EditorFeatureProfileManager::get_singleton());\n \t\t\tEditorFeatureProfileManager::get_singleton()->connect(\"current_feature_profile_changed\", callable_mp(this, &EditorInspector::_feature_profile_changed));\n \t\t\tset_process(is_visible_in_tree());\n-\t\t\tget_parent()->connect(SceneStringName(theme_changed), callable_mp(this, &EditorInspector::_update_theme));\n-\t\t\t_update_theme();\n \t\t\tif (!is_sub_inspector()) {\n \t\t\t\tget_tree()->connect(\"node_removed\", callable_mp(this, &EditorInspector::_node_removed));\n \t\t\t}\n \t\t} break;\n \n-\t\tcase NOTIFICATION_EXIT_TREE: {\n-\t\t\tget_parent()->disconnect(SceneStringName(theme_changed), callable_mp(this, &EditorInspector::_update_theme));\n-\t\t} break;\n-\n \t\tcase NOTIFICATION_PREDELETE: {\n \t\t\tif (!is_sub_inspector() && is_inside_tree()) {\n \t\t\t\tget_tree()->disconnect(\"node_removed\", callable_mp(this, &EditorInspector::_node_removed));\n@@ -5059,10 +5047,6 @@ void EditorInspector::_notification(int p_what) {\n \t\t} break;\n \n \t\tcase EditorSettings::NOTIFICATION_EDITOR_SETTINGS_CHANGED: {\n-\t\t\tif (!is_sub_inspector() && EditorThemeManager::is_generated_theme_outdated()) {\n-\t\t\t\t_update_theme();\n-\t\t\t}\n-\n \t\t\tif (use_settings_name_style && EditorSettings::get_singleton()->check_changed_settings_in_group(\"interface/editor/localize_settings\")) {\n \t\t\t\tEditorPropertyNameProcessor::Style style = EditorPropertyNameProcessor::get_settings_style();\n \t\t\t\tif (property_name_style != style) {\ndiff --git a/editor/editor_inspector.h b/editor/editor_inspector.h\nindex 14e2d816f12c..6049d6dce1c5 100644\n--- a/editor/editor_inspector.h\n+++ b/editor/editor_inspector.h\n@@ -638,8 +638,6 @@ class EditorInspector : public ScrollContainer {\n \tvoid _set_property_favorited(const String &p_path, bool p_favorited);\n \tvoid _clear_current_favorites();\n \n-\tvoid _update_theme();\n-\n \tvoid _node_removed(Node *p_node);\n \n \tHashMap<StringName, int> per_array_page;\ndiff --git a/editor/themes/editor_theme_manager.cpp b/editor/themes/editor_theme_manager.cpp\nindex 986a0469e740..d2e8d300d8e1 100644\n--- a/editor/themes/editor_theme_manager.cpp\n+++ b/editor/themes/editor_theme_manager.cpp\n@@ -1888,8 +1888,6 @@ void EditorThemeManager::_populate_editor_styles(const Ref<EditorTheme> &p_theme\n \t\tp_theme->set_stylebox(\"FocusViewport\", EditorStringName(EditorStyles), style_widget_focus_viewport);\n \n \t\tRef<StyleBoxFlat> style_widget_scroll_container = p_config.button_style_focus->duplicate();\n-\t\t// Make the focus outline appear to be flush with the buttons it's focusing, so not draw on top of the content.\n-\t\tstyle_widget_scroll_container->set_expand_margin_all(4);\n \t\tp_theme->set_stylebox(\"focus\", \"ScrollContainer\", style_widget_scroll_container);\n \n \t\t// This stylebox is used in 3d and 2d viewports (no borders).\n@@ -2236,6 +2234,12 @@ void EditorThemeManager::_populate_editor_styles(const Ref<EditorTheme> &p_theme\n \n \t// Editor inspector.\n \t{\n+\t\t// Panel.\n+\t\tRef<StyleBoxFlat> editor_inspector_panel = p_config.tree_panel_style->duplicate();\n+\t\teditor_inspector_panel->set_border_width_all(0);\n+\t\teditor_inspector_panel->set_content_margin_all(0);\n+\t\tp_theme->set_stylebox(SceneStringName(panel), \"EditorInspector\", editor_inspector_panel);\n+\n \t\t// Vertical separation between inspector categories and sections.\n \t\tp_theme->set_constant(\"v_separation\", \"EditorInspector\", 0);\n \ndiff --git a/scene/gui/scroll_container.cpp b/scene/gui/scroll_container.cpp\nindex 00a2e8e01fd8..02652547a83f 100644\n--- a/scene/gui/scroll_container.cpp\n+++ b/scene/gui/scroll_container.cpp\n@@ -31,6 +31,7 @@\n #include \"scroll_container.h\"\n \n #include \"core/config/project_settings.h\"\n+#include \"scene/gui/panel_container.h\"\n #include \"scene/main/window.h\"\n #include \"scene/theme/theme_db.h\"\n \n@@ -44,7 +45,7 @@ Size2 ScrollContainer::get_minimum_size() const {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \n@@ -72,7 +73,16 @@ Size2 ScrollContainer::get_minimum_size() const {\n \t\t}\n \t}\n \n-\tmin_size += theme_cache.panel_style->get_minimum_size();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tmin_size += panel_size;\n+\tif (draw_focus_border) {\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\t// Only update the minimum size if the focus style's minimum size doesn't fit into the panel style's minimum size.\n+\t\tif (focus_size > panel_size) {\n+\t\t\tmin_size += focus_size - panel_size;\n+\t\t}\n+\t}\n+\n \treturn min_size;\n }\n \n@@ -258,21 +268,45 @@ void ScrollContainer::_update_scrollbar_position() {\n \t\treturn;\n \t}\n \n+\tfloat right_margin = theme_cache.panel_style->get_margin(SIDE_RIGHT);\n+\tfloat left_margin = theme_cache.panel_style->get_margin(SIDE_LEFT);\n+\tfloat top_margin = theme_cache.panel_style->get_margin(SIDE_TOP);\n+\tfloat bottom_margin = theme_cache.panel_style->get_margin(SIDE_BOTTOM);\n+\tif (draw_focus_border) {\n+\t\t// Only update margins if the focus style's margins don't fit into the panel style's margins.\n+\t\tfloat focus_margin = theme_cache.focus_style->get_margin(SIDE_RIGHT);\n+\t\tif (focus_margin > right_margin) {\n+\t\t\tright_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_LEFT);\n+\t\tif (focus_margin > left_margin) {\n+\t\t\tleft_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_TOP);\n+\t\tif (focus_margin > top_margin) {\n+\t\t\ttop_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_BOTTOM);\n+\t\tif (focus_margin > bottom_margin) {\n+\t\t\tbottom_margin += focus_margin;\n+\t\t}\n+\t}\n+\n \tSize2 hmin = h_scroll->is_visible() ? h_scroll->get_combined_minimum_size() : Size2();\n \tSize2 vmin = v_scroll->is_visible() ? v_scroll->get_combined_minimum_size() : Size2();\n \n-\tint lmar = is_layout_rtl() ? theme_cache.panel_style->get_margin(SIDE_RIGHT) : theme_cache.panel_style->get_margin(SIDE_LEFT);\n-\tint rmar = is_layout_rtl() ? theme_cache.panel_style->get_margin(SIDE_LEFT) : theme_cache.panel_style->get_margin(SIDE_RIGHT);\n+\tint lmar = is_layout_rtl() ? right_margin : left_margin;\n+\tint rmar = is_layout_rtl() ? left_margin : right_margin;\n \n \th_scroll->set_anchor_and_offset(SIDE_LEFT, ANCHOR_BEGIN, lmar);\n \th_scroll->set_anchor_and_offset(SIDE_RIGHT, ANCHOR_END, -rmar - vmin.width);\n-\th_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_END, -hmin.height - theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n-\th_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n+\th_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_END, -hmin.height - bottom_margin);\n+\th_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -bottom_margin);\n \n \tv_scroll->set_anchor_and_offset(SIDE_LEFT, ANCHOR_END, -vmin.width - rmar);\n \tv_scroll->set_anchor_and_offset(SIDE_RIGHT, ANCHOR_END, -rmar);\n-\tv_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_BEGIN, theme_cache.panel_style->get_margin(SIDE_TOP));\n-\tv_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -hmin.height - theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n+\tv_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_BEGIN, top_margin);\n+\tv_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -hmin.height - bottom_margin);\n \n \t_updating_scrollbars = false;\n }\n@@ -313,8 +347,22 @@ void ScrollContainer::_reposition_children() {\n \tSize2 size = get_size();\n \tPoint2 ofs;\n \n-\tsize -= theme_cache.panel_style->get_minimum_size();\n-\tofs += theme_cache.panel_style->get_offset();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tPoint2 panel_offset = theme_cache.panel_style->get_offset();\n+\tsize -= panel_size;\n+\tofs += panel_offset;\n+\tif (draw_focus_border) {\n+\t\t// Only update the size and offset if focus style's doesn't fit into the panel style's.\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\tif (focus_size > panel_size) {\n+\t\t\tsize -= focus_size - panel_size;\n+\t\t}\n+\t\tPoint2 focus_offset = theme_cache.focus_style->get_offset();\n+\t\tif (focus_offset > panel_offset) {\n+\t\t\tofs += focus_offset - panel_offset;\n+\t\t}\n+\t}\n+\n \tbool rtl = is_layout_rtl();\n \n \tif (_is_h_scroll_visible() || horizontal_scroll_mode == SCROLL_MODE_RESERVE) {\n@@ -330,7 +378,7 @@ void ScrollContainer::_reposition_children() {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \t\tSize2 minsize = c->get_combined_minimum_size();\n@@ -350,6 +398,9 @@ void ScrollContainer::_reposition_children() {\n \t\tfit_child_in_rect(c, r);\n \t}\n \n+\tif (draw_focus_border) {\n+\t\tfocus_panel->set_size(get_size());\n+\t}\n \tqueue_redraw();\n }\n \n@@ -399,6 +450,7 @@ void ScrollContainer::_notification(int p_what) {\n \t\t\tif (p_what == NOTIFICATION_THEME_CHANGED) {\n \t\t\t\tscroll_border = get_theme_constant(SNAME(\"scroll_border\"), SNAME(\"Tree\"));\n \t\t\t\tscroll_speed = get_theme_constant(SNAME(\"scroll_speed\"), SNAME(\"Tree\"));\n+\t\t\t\tfocus_panel->add_theme_style_override(\"panel\", theme_cache.focus_style);\n \t\t\t}\n \t\t} break;\n \n@@ -415,15 +467,8 @@ void ScrollContainer::_notification(int p_what) {\n \n \t\tcase NOTIFICATION_DRAW: {\n \t\t\tdraw_style_box(theme_cache.panel_style, Rect2(Vector2(), get_size()));\n-\t\t\tif (draw_focus_border && (has_focus() || child_has_focus())) {\n-\t\t\t\tRID ci = get_canvas_item();\n-\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_clip_ignore(ci, true);\n-\t\t\t\tdraw_style_box(theme_cache.focus_style, Rect2(Point2(), get_size()));\n-\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_clip_ignore(ci, false);\n-\t\t\t\tfocus_border_is_drawn = true;\n-\t\t\t} else {\n-\t\t\t\tfocus_border_is_drawn = false;\n-\t\t\t}\n+\t\t\tfocus_border_is_drawn = draw_focus_border && (has_focus() || child_has_focus());\n+\t\t\tfocus_panel->set_visible(focus_border_is_drawn);\n \t\t} break;\n \n \t\tcase NOTIFICATION_DRAG_BEGIN: {\n@@ -535,7 +580,15 @@ void ScrollContainer::_notification(int p_what) {\n \n void ScrollContainer::update_scrollbars() {\n \tSize2 size = get_size();\n-\tsize -= theme_cache.panel_style->get_minimum_size();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tsize -= panel_size;\n+\tif (draw_focus_border) {\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\t// Only update the size if the focus style's minimum size doesn't fit into the panel style's minimum size.\n+\t\tif (focus_size > panel_size) {\n+\t\t\tsize -= focus_size - panel_size;\n+\t\t}\n+\t}\n \n \tSize2 hmin = h_scroll->get_combined_minimum_size();\n \tSize2 vmin = v_scroll->get_combined_minimum_size();\n@@ -646,7 +699,7 @@ PackedStringArray ScrollContainer::get_configuration_warnings() const {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \n@@ -736,7 +789,9 @@ void ScrollContainer::set_draw_focus_border(bool p_draw) {\n \t\treturn;\n \t}\n \tdraw_focus_border = p_draw;\n-\tqueue_redraw();\n+\tif (is_ready()) {\n+\t\t_reposition_children();\n+\t}\n }\n \n bool ScrollContainer::get_draw_focus_border() {\n@@ -759,6 +814,17 @@ ScrollContainer::ScrollContainer() {\n \tadd_child(v_scroll, false, INTERNAL_MODE_BACK);\n \tv_scroll->connect(SceneStringName(value_changed), callable_mp(this, &ScrollContainer::_scroll_moved));\n \n+\t// We need to use a PanelContainer for the focus style instead of just drawing it directly with RenderingService\n+\t// due to a clippling issues. The Control that is being scrolled will be over the focus border because both will be\n+\t// drawn on the same CanvasItem. If we decide to ignore clipping, the focus border will be drawn even over other\n+\t// CanvasItems.\n+\tfocus_panel = memnew(PanelContainer);\n+\tfocus_panel->set_name(\"_focus\");\n+\tfocus_panel->set_mouse_filter(MOUSE_FILTER_IGNORE);\n+\tfocus_panel->set_focus_mode(FOCUS_NONE);\n+\tfocus_panel->set_visible(draw_focus_border);\n+\tadd_child(focus_panel, false, INTERNAL_MODE_BACK);\n+\n \tdeadzone = GLOBAL_GET(\"gui/common/default_scroll_deadzone\");\n \n \tset_clip_contents(true);\ndiff --git a/scene/gui/scroll_container.h b/scene/gui/scroll_container.h\nindex 7f2352704114..1970ed403fc1 100644\n--- a/scene/gui/scroll_container.h\n+++ b/scene/gui/scroll_container.h\n@@ -34,6 +34,8 @@\n \n #include \"scroll_bar.h\"\n \n+class PanelContainer;\n+\n class ScrollContainer : public Container {\n \tGDCLASS(ScrollContainer, Container);\n \n@@ -49,6 +51,7 @@ class ScrollContainer : public Container {\n private:\n \tHScrollBar *h_scroll = nullptr;\n \tVScrollBar *v_scroll = nullptr;\n+\tPanelContainer *focus_panel = nullptr;\n \n \tmutable Size2 largest_child_min_size; // The largest one among the min sizes of all available child controls.\n \n", "test_patch": "", "problem_statement": "ScrollContainer focus StyleBox is not clipped by parent\n### Tested versions\n\nv4.4.dev6.official [1f47e4c4e]\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\n![Image](https://github.com/user-attachments/assets/14590874-4426-4de5-919b-caab8b9a6239)\n\nPR https://github.com/godotengine/godot/pull/97521 added a focus style for ScrollContainer this has the same problem as following issues:\n\nTree:\nhttps://github.com/godotengine/godot/issues/100063\nhttps://github.com/godotengine/godot/issues/88749\nhttps://github.com/godotengine/godot/issues/74670\n\n\n\nItemList:\nhttps://github.com/godotengine/godot/issues/77919\n\n\n### Steps to reproduce\n\nA ScrollContainer inside another ScrollContainer\nAdd some content to both\nEnable draw_focus_border for second ScrollContainer\nSelect something in the second ScrollContainer so it gets focus\nScroll the first ScrollContainer\n\n### Minimal reproduction project (MRP)\n\n[scrollfocus.zip](https://github.com/user-attachments/files/18052689/scrollfocus.zip)\n\n", "hints_text": "\u0421\u0421 @pafuent \nI'll try to take a look at it, but finding free time around EoY is really hard for me.\nJust a small clarification, all the bugs referenced are not related to the change that I implemented. All of them where already present on 4.3\nOf course that is not the case for this bug.\n> Just a small clarification, all the bugs referenced are not related to the change that I implemented. All of them where already present on 4.3 Of course that is not the case for this bug.\n\nIndeed, this problem exists since 4.0.", "created_at": "2025-03-18 13:55:30", "merge_commit_sha": "039d9ffd30aac92d29359405424e4c52f979e61e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104208", "base_commit": "0028fd625e2c5b202e204bc12828cbca043213d3", "patch": "diff --git a/platform/windows/SCsub b/platform/windows/SCsub\nindex 1ddefb9c331f..284b43d55de7 100644\n--- a/platform/windows/SCsub\n+++ b/platform/windows/SCsub\n@@ -124,7 +124,7 @@ if env[\"d3d12\"]:\n             Copy(\"$TARGET\", \"$SOURCE\"),\n         )\n \n-if not os.getenv(\"VCINSTALLDIR\"):\n+if not env.msvc:\n     if env[\"debug_symbols\"]:\n         env.AddPostAction(prog, env.Run(platform_windows_builders.make_debug_mingw))\n         if env[\"windows_subsystem\"] == \"gui\":\n", "test_patch": "", "problem_statement": "[Buildsystem] Builds fail with MSVC with separate build symbols\n### Tested versions\n\n- Reproducible in master [0028fd625e2c5b202e204bc12828cbca043213d3]\n- Not reproducible in master [b5bdb88062a31a982c8f3bf4b820188edd53c6c5]\n- Bisected down to #103864 [45053520216b70d5669587b55e6b3d98df201c3d]\n\n### System information\n\nGodot v4.4.stable - Windows 10.0.26100 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2080 (NVIDIA; 32.0.15.7247) - AMD Ryzen 7 3800XT 8-Core Processor (16 Threads)\n\n### Issue description\n\nWhen attempting to build Godot, I'm getting the following error when generating the executable:\n```\nStarting build...\ncmd /c chcp 65001>nul && scons dev_build=yes separate_debug_symbols=yes tests=yes compiledb=yes d3d12=yes\nscons: Reading SConscript files ...\nAutomatically detected platform: windows\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\nBuilding for platform \"windows\", architecture \"x86_64\", target \"editor\".\nINFO: Developer build, with debug optimization level and debug symbols (unless overridden).\nChecking for C header file mntent.h... (cached) no\nscons: done reading SConscript files.\nscons: Building targets ...\nLinking Program bin\\godot.windows.editor.dev.x86_64.exe ...\nGenerating compile_commands.json ...\nGenerating bin\\godot.windows.editor.dev.x86_64.exe ...\nscons: *** [bin\\godot.windows.editor.dev.x86_64.exe] KeyError : 'OBJCOPY'\nTraceback (most recent call last):\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 2677, in __getitem__\n    return self.__dict__['overrides'][key]\nKeyError: 'OBJCOPY'\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Action.py\", line 1434, in execute\n    result = self.execfunction(target=target, source=rsources, env=env)\n  File \"C:\\Users\\kilau\\Development\\godot_dev\\godot4\\platform\\windows\\platform_windows_builders.py\", line 10, in make_debug_mingw\n    os.system(\"{0} --only-keep-debug {1} {1}.debugsymbols\".format(env[\"OBJCOPY\"], dst))\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 2681, in __getitem__\n    return self.__dict__['__subject'].__getitem__(key)\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 603, in __getitem__\n    return self._dict[key]\nKeyError: 'OBJCOPY'\nscons: building terminated because of errors.\nINFO: Time elapsed: 00:00:20.14 \n```\n\n### Steps to reproduce\n\nRun `scons dev_build=yes separate_debug_symbols=yes tests=yes compiledb=yes` on a system with MSVC.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Ran a bisect and narrowed down the regression to #103864 \nThis issue can be worked around by running SCons within the `x64 Native Tools Command Prompt for VS 2022` console.\n\nFor VSCode, this can be setup by adding to your `tasks.json` file:\n``` json\n\"windows\": {\n        \"options\": {\n            \"shell\": {\n                \"executable\": \"cmd.exe\",\n                \"args\": [\n                    \"/C\",\n                    \"\\\"C:\\\\Program Files\\\\Microsoft Visual Studio\\\\2022\\\\Community\\\\VC\\\\Auxiliary\\\\Build\\\\vcvars64.bat\\\"\",\n                    \"&&\"\n                ]\n            }\n        }\n    }\n```\n\nThen, change any build actions to type `shell`.\n\nProcess is documented here: https://code.visualstudio.com/docs/cpp/config-msvc#_run-vs-code-outside-the-developer-command-prompt", "created_at": "2025-03-15 23:17:51", "merge_commit_sha": "2dc6da6336c3c38871730d1eded5190ebbfa51c4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104169", "base_commit": "0028fd625e2c5b202e204bc12828cbca043213d3", "patch": "diff --git a/editor/code_editor.cpp b/editor/code_editor.cpp\nindex bc678b5ba1be..1b77ae749e40 100644\n--- a/editor/code_editor.cpp\n+++ b/editor/code_editor.cpp\n@@ -1668,9 +1668,9 @@ void CodeTextEditor::set_error_count(int p_error_count) {\n \terror_button->set_text(itos(p_error_count));\n \terror_button->set_visible(p_error_count > 0);\n \tif (p_error_count > 0) {\n-\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time_with_errors); // Parsing should happen sooner.\n \t} else {\n+\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time);\n \t}\n }\n", "test_patch": "", "problem_statement": "Script Editor - Error Panel stays open after error fixed\n### Tested versions\n\n4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1650 (NVIDIA; 32.0.15.7260) - AMD Ryzen 3 3100 4-Core Processor (8 threads)\n\n### Issue description\n\nScript Editor - Error Panel stays open after error fixed\nin order to close the panel, need to cause an error to have the expand collapse button, this fresh first error after fix also collapses the panel.\n\n### Steps to reproduce\n\ncreate a script.\nmake an error,\nexpand the error panel\nfix the error in script\n> now you have the panel open with no errors but also no way to hide this Error Panel\n\n### Minimal reproduction project (MRP)\n\nAny simple project would do.\n", "hints_text": "It seems like the behaviour is whenever the number of errors changes, the panel is closed, unless the number of errors changes to 0. The logic for deciding if the error button is shown is in `CodeTextEditor::set_error_count`, which hides the error panel if `p_error_count > 0`, and doesn't change the error panel's visibility otherwise. \n\nhttps://github.com/godotengine/godot/blob/0028fd625e2c5b202e204bc12828cbca043213d3/editor/code_editor.cpp#L1667-L1676\n\nThis seems like the opposite of what you might expect, where you want to hide the error panel if there are no errors left, but leave it in its current state otherwise. This expected behaviour is actually how the warning panel behaves.\n\nhttps://github.com/godotengine/godot/blob/0028fd625e2c5b202e204bc12828cbca043213d3/editor/code_editor.cpp#L1678-L1684\n\nThe change in behaviour seems to have been introduced in https://github.com/godotengine/godot/commit/02cc187 where the call to `_set_show_errors_panel` was put in the wrong place", "created_at": "2025-03-15 09:11:45", "merge_commit_sha": "a26c05d7e5831e27b28f6135ec04f664ac4e105d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104154", "base_commit": "28102e6682c7c733a23de461e30d5ae2d33fe755", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex 441ba3141ef4..032d367bc18b 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -2517,24 +2517,38 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \tOS::get_singleton()->_allow_layered = GLOBAL_DEF_RST(\"display/window/per_pixel_transparency/allowed\", false);\n \n #ifdef TOOLS_ENABLED\n-\tif (editor || project_manager) {\n-\t\t// The editor and project manager always detect and use hiDPI if needed.\n-\t\tOS::get_singleton()->_allow_hidpi = true;\n-\t\t// Disable Vulkan overlays in editor, they cause various issues.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_MANGOHUD\", \"1\"); // GH-57403.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_RTSS_LAYER\", \"1\"); // GH-57937.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VKBASALT\", \"1\");\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_reshade_1\", \"1\"); // GH-70849.\n-\t\tOS::get_singleton()->set_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\", \"1\"); // GH-101480.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\", \"1\"); // GH-101480.\n-\t} else {\n-\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_MANGOHUD\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_RTSS_LAYER\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VKBASALT\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_reshade_1\");\n-\t\tOS::get_singleton()->unset_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\");\n+\t{\n+\t\t// Synced with https://github.com/baldurk/renderdoc/blob/2b01465c7/renderdoc/driver/vulkan/vk_layer.cpp#L118-L165\n+\t\tLocalVector<String> layers_to_disable = {\n+\t\t\t\"DISABLE_RTSS_LAYER\", // GH-57937.\n+\t\t\t\"DISABLE_VULKAN_OBS_CAPTURE\", // GH-103800.\n+\t\t\t\"DISABLE_VULKAN_OW_OBS_CAPTURE\", // GH-104154.\n+\t\t\t\"DISABLE_SAMPLE_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_GAMEPP_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_VK_LAYER_TENCENT_wegame_cross_overlay_1\", // GH-104154.\n+\t\t\t\"NODEVICE_SELECT\", // GH-104154.\n+\t\t\t\"VK_LAYER_bandicam_helper_DEBUG_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_bandicam_helper_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_reshade_1\", // GH-70849.\n+\t\t\t\"DISABLE_VK_LAYER_GPUOpen_GRS\", // GH-104154.\n+\t\t\t\"DISABLE_LAYER\", // GH-104154 (fpsmon).\n+\t\t\t\"DISABLE_MANGOHUD\", // GH-57403.\n+\t\t\t\"DISABLE_VKBASALT\",\n+\t\t};\n+\n+\t\tif (editor || project_manager) {\n+\t\t\t// The editor and project manager always detect and use hiDPI if needed.\n+\t\t\tOS::get_singleton()->_allow_hidpi = true;\n+\t\t\t// Disable Vulkan overlays in editor, they cause various issues.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->set_environment(layer_disable, \"1\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->unset_environment(layer_disable);\n+\t\t\t}\n+\t\t}\n \t}\n #endif\n \n", "test_patch": "", "problem_statement": "Godot 4.4 silently closes when using OBS advanced scene switcher (detects active window). GameCapture Mode\n### Tested versions\n\n4.4 issue\n4.3 works fine\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2070 (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (16 threads)\n\n### Issue description\n\n4.4 Godot Crashes when tabbing into other windows using OBS Scene Switcher Plugin(which detects the current window and changes scene)\n\nI will temporarily go back to 4.3 which does not do this.\n\n I'm not sure what options in the editor have changed or if there are some options I can tick to help with this. I've tried many different options. I know the detection of windows isn't youre problem, but why did it work flawlessly in 4.3?\n\nIt only happens if im using GameCapture for Godot 4.4. I just dont want to stream my whole display monitor. I use the advanced scene switcher plugin to make devlogs. Switching scenes between my notes, editor, ect.\n\n\nNo errors. Just my Godot disappears and closes when I tab into other windows. It works fine if Godot isn't Game Capture. \n\nDid anything change in 4.4 for window detection and compatibility with OBS? Ive even tried setting godot 4.4 to single window mode.\n\n### Steps to reproduce\n\nOpen Godot 4.4,\n\nHave scene setup in game capture mode for Godot 4.4.\n\nUse Window Detection with another application ( OBS Automatic Scene Switcher)\n\nScenes automatically switch based on the active window.\n\nGodot crashes when tabbing into other windows.\n\nOpen Godot 4.3\n\nRepeat steps.\n\nGodot does not close/crash\n\n\n### Minimal reproduction project (MRP)\n\nHappens with any 4.4 project. Even brand new ones.\n\nUnable to replicate in 4.3\n", "hints_text": "To clarify. It closes godot when I tab out of godot and then back into Godot. No errors or crash.\n\nOnly thing in the project file is a vulkan cache, no crash logs or anythin.\nConfirmed issue is something with Forward+ mode in 4.4 and windows based window detection.\n\nGodot does not seem to crash using these method on Compatibility mode. YAY!! I can work now!\nCould you test the versions between 4.3 stable and 4.4 stable to find when this problem started? You can download them here: https://godotengine.org/download/archive/ \nFrom further testing, my previous comments about 4.3 working was only due to compatibility render mode. If I use forward+ it still happens in 4.3 stable. Let me try to use a different computer perhaps and do further testing. It will be a few days before I can setup my other computer. Please leave this open if you deem necessary. \nCan you reproduce this after switching back to Forward+/Mobile, then changing `rendering_driver.windows` to `d3d12` in the Project Settings and restarting the editor?\n\nThis is almost certainly caused by a negative interaction between the OBS Vulkan layer and Godot. This layer should probably be blocked from Godot to avoid crashes, but it's not listed here:\n\nhttps://github.com/godotengine/godot/blob/30bb49ec1ff3b3fc463074b8d28bc97d4db50b9f/main/main.cpp#L2515-L2535\nThank you. Confirming in 4.3 and 4.4 stables that switching to d3d12 forward+ allows my OBS scene switching plugin to flawlessly detect the windows. The vulkan seems to be culprit.\n\nWith vulkan = crash when switching windows\nwith d3d12 = perfect\nTo clarify, when in vulkan forward plus. I can tab into Godot fine, but as soon as I tab out, it closes. \n\nIf this is a problem related to the plugin of obs, fair enough. THe plugin that detects windows is\n\nhttps://obsproject.com/forum/resources/advanced-scene-switcher.395/\n\nspecifically the Automatic Scene Switcher tool\nYou linked `Advanced Scene Switcher`. OBS has `Automatic Scene Switcher` built in. I assume this is about the one you linked?\nI can replicate this without any scene switchers. Only affects OBS's `Game Capture` source and Vulkan drivers in Godot. Nothing in the verbose logs. Doesn't even require switching scenes. Hiding and unhiding the source a few times does the trick too.\n\n```\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6094) - 12th Gen Intel(R) Core(TM) i5-12400F (12 threads)\n```\n\nhttps://github.com/user-attachments/assets/d37412ff-da98-4b98-bb99-b4e364924775", "created_at": "2025-03-14 21:37:47", "merge_commit_sha": "14c3ef9a6cbe4971df97a037b9d3fcb7553f7307", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104083", "base_commit": "701505eb4ff698434cba540381dbccdd48de8bb0", "patch": "diff --git a/doc/classes/Node.xml b/doc/classes/Node.xml\nindex 15852097fb5b..fd0a2594c293 100644\n--- a/doc/classes/Node.xml\n+++ b/doc/classes/Node.xml\n@@ -1226,6 +1226,9 @@\n \t\t<constant name=\"NOTIFICATION_VP_MOUSE_EXIT\" value=\"1011\">\n \t\t\tNotification received when the mouse cursor leaves the [Viewport]'s visible area, that is not occluded behind other [Control]s or [Window]s, provided its [member Viewport.gui_disable_input] is [code]false[/code] and regardless if it's currently focused or not.\n \t\t</constant>\n+\t\t<constant name=\"NOTIFICATION_WM_POSITION_CHANGED\" value=\"1012\">\n+\t\t\tNotification received when the window is moved.\n+\t\t</constant>\n \t\t<constant name=\"NOTIFICATION_OS_MEMORY_WARNING\" value=\"2009\">\n \t\t\tNotification received from the OS when the application is exceeding its allocated memory.\n \t\t\tImplemented only on iOS.\ndiff --git a/scene/main/node.cpp b/scene/main/node.cpp\nindex 0978aa9ddfb9..ed0add6f43cd 100644\n--- a/scene/main/node.cpp\n+++ b/scene/main/node.cpp\n@@ -3811,6 +3811,7 @@ void Node::_bind_methods() {\n \tBIND_CONSTANT(NOTIFICATION_WM_DPI_CHANGE);\n \tBIND_CONSTANT(NOTIFICATION_VP_MOUSE_ENTER);\n \tBIND_CONSTANT(NOTIFICATION_VP_MOUSE_EXIT);\n+\tBIND_CONSTANT(NOTIFICATION_WM_POSITION_CHANGED);\n \tBIND_CONSTANT(NOTIFICATION_OS_MEMORY_WARNING);\n \tBIND_CONSTANT(NOTIFICATION_TRANSLATION_CHANGED);\n \tBIND_CONSTANT(NOTIFICATION_WM_ABOUT);\n", "test_patch": "", "problem_statement": "`NOTIFICATION_WM_POSITION_CHANGED` is not exposed in GDExtension\n### Tested versions\n\n4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i7-6700K CPU @ 4.00GHz (8 threads)\n\n### Issue description\n\nOriginally reported here https://github.com/godotengine/godot-cpp/issues/1732\n\nThen I realized it better fits here.\nBasically, `extension_api.json` generated by Godot does not expose `NOTIFICATION_WM_POSITION_CHANGED`. Thus, it is not available in godot-cpp.\n\n### Steps to reproduce\n\nCall `godot --dump-extension-api` to generate api file. Observe that `NOTIFICATION_WM_POSITION_CHANGED` is not present.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "This is not exposed at all, it was introduced in:\n* https://github.com/godotengine/godot/pull/99010\n\nBut not exposed\n\nCC @Hilderin \nCan you describe what's your use case for `NOTIFICATION_WM_POSITION_CHANGED`?\nI have a window manager that preserves window positions upon restart. Simple as that.\nWithout this callback you can't reliably save the last position.\n\nAnyway, the callback is not the problem. Because this notification does propagate into my nodes. But there is no `NOTIFICATION_WM_POSITION_CHANGED` define, that I can use to compare to `what` in the `_notification()`. Currently I define it myself in a header `inline static constexpr int NOTIFICATION_WM_POSITION_CHANGED = 1012;`\nAgain, to make it clear, what is actually missing is the actual define in node.hpp.\nThe thing that is missing is a `BIND_ENUM_CONSTANT(NOTIFICATION_WM_POSITION_CHANGED)` if this is indeed required\nYes, this. I fail to understand why it wouldn't be required if it comes to a user, user should be able to match this notification to some value.", "created_at": "2025-03-13 20:13:27", "merge_commit_sha": "08e41090bcecf10dfeea4f42471a2116d8e67b53", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104019", "base_commit": "30b0aadab65fcafb9a160dba2c9abfd005bb62a5", "patch": "diff --git a/.github/actions/godot-cpp-build/action.yml b/.github/actions/godot-cpp-build/action.yml\nindex 7667527246ed..1046f09470e9 100644\n--- a/.github/actions/godot-cpp-build/action.yml\n+++ b/.github/actions/godot-cpp-build/action.yml\n@@ -1,9 +1,6 @@\n name: Build godot-cpp\n description: Build godot-cpp with the provided options.\n \n-env:\n-  GODOT_CPP_BRANCH: 4.4\n-\n inputs:\n   bin:\n     description: Path to the Godot binary.\n@@ -16,6 +13,10 @@ inputs:\n     description: The SCons cache path.\n     default: ${{ github.workspace }}/.scons_cache/\n     type: string\n+  godot-cpp-branch:\n+    description: The godot-cpp branch.\n+    default: master\n+    type: string\n \n runs:\n   using: composite\n@@ -25,7 +26,7 @@ runs:\n       with:\n         submodules: recursive\n         repository: godotengine/godot-cpp\n-        ref: ${{ env.GODOT_CPP_BRANCH }}\n+        ref: ${{ inputs.godot-cpp-branch }}\n         path: godot-cpp\n \n     - name: Extract API\ndiff --git a/.github/workflows/android_builds.yml b/.github/workflows/android_builds.yml\nindex f1c721fb6382..865f826bc0f3 100644\n--- a/.github/workflows/android_builds.yml\n+++ b/.github/workflows/android_builds.yml\n@@ -62,8 +62,8 @@ jobs:\n       - name: Download pre-built Android Swappy Frame Pacing Library\n         uses: dsaltares/fetch-gh-release-asset@1.1.2\n         with:\n-          repo: darksylinc/godot-swappy\n-          version: tags/v2023.3.0.0\n+          repo: godotengine/godot-swappy\n+          version: tags/from-source-2025-01-31\n           file: godot-swappy.7z\n           target: swappy/godot-swappy.7z\n \ndiff --git a/.github/workflows/linux_builds.yml b/.github/workflows/linux_builds.yml\nindex 44aefc77a73b..1cb9637cee50 100644\n--- a/.github/workflows/linux_builds.yml\n+++ b/.github/workflows/linux_builds.yml\n@@ -6,6 +6,7 @@ on:\n env:\n   # Used for the cache key. Add version suffix to force clean build.\n   GODOT_BASE_BRANCH: 4.4\n+  GODOT_CPP_BRANCH: 4.4\n   SCONSFLAGS: verbose=yes warnings=extra werror=yes module_text_server_fb_enabled=yes strict_checks=yes\n   DOTNET_NOLOGO: true\n   DOTNET_CLI_TELEMETRY_OPTOUT: true\n@@ -174,6 +175,7 @@ jobs:\n         with:\n           bin: ${{ matrix.bin }}\n           scons-flags: target=template_debug dev_build=yes verbose=yes\n+          godot-cpp-branch: ${{ env.GODOT_CPP_BRANCH }}\n \n       - name: Save Godot build cache\n         uses: ./.github/actions/godot-cache-save\ndiff --git a/.gitignore b/.gitignore\nindex 2c3bf742ba2e..8adc7b786c63 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -263,6 +263,11 @@ bld/\n !thirdparty/**/arm/\n !thirdparty/**/arm64/\n \n+thirdparty/swappy-frame-pacing/arm64-v8a/abi.json\n+thirdparty/swappy-frame-pacing/armeabi-v7a/abi.json\n+thirdparty/swappy-frame-pacing/x86/abi.json\n+thirdparty/swappy-frame-pacing/x86_64/abi.json\n+\n # Visual Studio 2015/2017 cache/options directory\n .vs/\n \ndiff --git a/core/object/worker_thread_pool.cpp b/core/object/worker_thread_pool.cpp\nindex 08903d61964d..d9ff30576794 100644\n--- a/core/object/worker_thread_pool.cpp\n+++ b/core/object/worker_thread_pool.cpp\n@@ -37,6 +37,8 @@\n \n WorkerThreadPool::Task *const WorkerThreadPool::ThreadData::YIELDING = (Task *)1;\n \n+HashMap<StringName, WorkerThreadPool *> WorkerThreadPool::named_pools;\n+\n void WorkerThreadPool::Task::free_template_userdata() {\n \tERR_FAIL_NULL(template_userdata);\n \tERR_FAIL_NULL(native_func_userdata);\n@@ -184,25 +186,25 @@ void WorkerThreadPool::_thread_function(void *p_user) {\n \twhile (true) {\n \t\tTask *task_to_process = nullptr;\n \t\t{\n-\t\t\tMutexLock lock(singleton->task_mutex);\n+\t\t\tMutexLock lock(thread_data->pool->task_mutex);\n \n-\t\t\tbool exit = singleton->_handle_runlevel(thread_data, lock);\n+\t\t\tbool exit = thread_data->pool->_handle_runlevel(thread_data, lock);\n \t\t\tif (unlikely(exit)) {\n \t\t\t\tbreak;\n \t\t\t}\n \n \t\t\tthread_data->signaled = false;\n \n-\t\t\tif (singleton->task_queue.first()) {\n-\t\t\t\ttask_to_process = singleton->task_queue.first()->self();\n-\t\t\t\tsingleton->task_queue.remove(singleton->task_queue.first());\n+\t\t\tif (thread_data->pool->task_queue.first()) {\n+\t\t\t\ttask_to_process = thread_data->pool->task_queue.first()->self();\n+\t\t\t\tthread_data->pool->task_queue.remove(thread_data->pool->task_queue.first());\n \t\t\t} else {\n \t\t\t\tthread_data->cond_var.wait(lock);\n \t\t\t}\n \t\t}\n \n \t\tif (task_to_process) {\n-\t\t\tsingleton->_process_task(task_to_process);\n+\t\t\tthread_data->pool->_process_task(task_to_process);\n \t\t}\n \t}\n }\n@@ -497,7 +499,7 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (singleton->task_queue.first()) {\n+\t\t\tif (p_caller_pool_thread->pool->task_queue.first()) {\n \t\t\t\ttask_to_process = task_queue.first()->self();\n \t\t\t\ttask_queue.remove(task_queue.first());\n \t\t\t}\n@@ -505,7 +507,9 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\tif (!task_to_process) {\n \t\t\t\tp_caller_pool_thread->awaited_task = p_task;\n \n-\t\t\t\t_unlock_unlockable_mutexes();\n+\t\t\t\tif (this == singleton) {\n+\t\t\t\t\t_unlock_unlockable_mutexes();\n+\t\t\t\t}\n \t\t\t\trelock_unlockables = true;\n \n \t\t\t\tp_caller_pool_thread->cond_var.wait(lock);\n@@ -514,7 +518,7 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\t}\n \t\t}\n \n-\t\tif (relock_unlockables) {\n+\t\tif (relock_unlockables && this == singleton) {\n \t\t\t_lock_unlockable_mutexes();\n \t\t}\n \n@@ -690,9 +694,13 @@ void WorkerThreadPool::wait_for_group_task_completion(GroupID p_group) {\n \t{\n \t\tGroup *group = *groupp;\n \n-\t\t_unlock_unlockable_mutexes();\n+\t\tif (this == singleton) {\n+\t\t\t_unlock_unlockable_mutexes();\n+\t\t}\n \t\tgroup->done_semaphore.wait();\n-\t\t_lock_unlockable_mutexes();\n+\t\tif (this == singleton) {\n+\t\t\t_lock_unlockable_mutexes();\n+\t\t}\n \n \t\tuint32_t max_users = group->tasks_used + 1; // Add 1 because the thread waiting for it is also user. Read before to avoid another thread freeing task after increment.\n \t\tuint32_t finished_users = group->finished.increment(); // fetch happens before inc, so increment later.\n@@ -709,15 +717,15 @@ void WorkerThreadPool::wait_for_group_task_completion(GroupID p_group) {\n #endif\n }\n \n-int WorkerThreadPool::get_thread_index() {\n+int WorkerThreadPool::get_thread_index() const {\n \tThread::ID tid = Thread::get_caller_id();\n-\treturn singleton->thread_ids.has(tid) ? singleton->thread_ids[tid] : -1;\n+\treturn thread_ids.has(tid) ? thread_ids[tid] : -1;\n }\n \n-WorkerThreadPool::TaskID WorkerThreadPool::get_caller_task_id() {\n+WorkerThreadPool::TaskID WorkerThreadPool::get_caller_task_id() const {\n \tint th_index = get_thread_index();\n-\tif (th_index != -1 && singleton->threads[th_index].current_task) {\n-\t\treturn singleton->threads[th_index].current_task->self;\n+\tif (th_index != -1 && threads[th_index].current_task) {\n+\t\treturn threads[th_index].current_task->self;\n \t} else {\n \t\treturn INVALID_TASK_ID;\n \t}\n@@ -766,6 +774,7 @@ void WorkerThreadPool::init(int p_thread_count, float p_low_priority_task_ratio)\n \n \tfor (uint32_t i = 0; i < threads.size(); i++) {\n \t\tthreads[i].index = i;\n+\t\tthreads[i].pool = this;\n \t\tthreads[i].thread.start(&WorkerThreadPool::_thread_function, &threads[i]);\n \t\tthread_ids.insert(threads[i].thread.get_id(), i);\n \t}\n@@ -832,10 +841,33 @@ void WorkerThreadPool::_bind_methods() {\n \tClassDB::bind_method(D_METHOD(\"wait_for_group_task_completion\", \"group_id\"), &WorkerThreadPool::wait_for_group_task_completion);\n }\n \n-WorkerThreadPool::WorkerThreadPool() {\n-\tsingleton = this;\n+WorkerThreadPool *WorkerThreadPool::get_named_pool(const StringName &p_name) {\n+\tWorkerThreadPool **pool_ptr = named_pools.getptr(p_name);\n+\tif (pool_ptr) {\n+\t\treturn *pool_ptr;\n+\t} else {\n+\t\tWorkerThreadPool *pool = memnew(WorkerThreadPool(false));\n+\t\tpool->init();\n+\t\tnamed_pools[p_name] = pool;\n+\t\treturn pool;\n+\t}\n+}\n+\n+WorkerThreadPool::WorkerThreadPool(bool p_singleton) {\n+\tif (p_singleton) {\n+\t\tsingleton = this;\n+\t}\n }\n \n WorkerThreadPool::~WorkerThreadPool() {\n \tfinish();\n+\n+\tif (this == singleton) {\n+\t\tsingleton = nullptr;\n+\t\tfor (KeyValue<StringName, WorkerThreadPool *> &E : named_pools) {\n+\t\t\tE.value->finish();\n+\t\t\tmemdelete(E.value);\n+\t\t}\n+\t\tnamed_pools.clear();\n+\t}\n }\ndiff --git a/core/object/worker_thread_pool.h b/core/object/worker_thread_pool.h\nindex 58e86e3e48eb..76332ec8a3d3 100644\n--- a/core/object/worker_thread_pool.h\n+++ b/core/object/worker_thread_pool.h\n@@ -119,6 +119,7 @@ class WorkerThreadPool : public Object {\n \t\tTask *current_task = nullptr;\n \t\tTask *awaited_task = nullptr; // Null if not awaiting the condition variable, or special value (YIELDING).\n \t\tConditionVariable cond_var;\n+\t\tWorkerThreadPool *pool = nullptr;\n \n \t\tThreadData() :\n \t\t\t\tsignaled(false),\n@@ -166,6 +167,8 @@ class WorkerThreadPool : public Object {\n \n \tuint64_t last_task = 1;\n \n+\tstatic HashMap<StringName, WorkerThreadPool *> named_pools;\n+\n \tstatic void _thread_function(void *p_user);\n \n \tvoid _process_task(Task *task);\n@@ -266,9 +269,12 @@ class WorkerThreadPool : public Object {\n #endif\n \t}\n \n+\t// Note: Do not use this unless you know what you are doing, and it is absolutely necessary. Main thread pool (`get_singleton()`) should be preferred instead.\n+\tstatic WorkerThreadPool *get_named_pool(const StringName &p_name);\n+\n \tstatic WorkerThreadPool *get_singleton() { return singleton; }\n-\tstatic int get_thread_index();\n-\tstatic TaskID get_caller_task_id();\n+\tint get_thread_index() const;\n+\tTaskID get_caller_task_id() const;\n \n #ifdef THREADS_ENABLED\n \t_ALWAYS_INLINE_ static uint32_t thread_enter_unlock_allowance_zone(const MutexLock<BinaryMutex> &p_lock) { return _thread_enter_unlock_allowance_zone(p_lock._get_lock()); }\n@@ -285,7 +291,7 @@ class WorkerThreadPool : public Object {\n \tvoid init(int p_thread_count = -1, float p_low_priority_task_ratio = 0.3);\n \tvoid exit_languages_threads();\n \tvoid finish();\n-\tWorkerThreadPool();\n+\tWorkerThreadPool(bool p_singleton = true);\n \t~WorkerThreadPool();\n };\n \ndiff --git a/core/os/os.h b/core/os/os.h\nindex e0ec320e32ba..c8ac5c8eac7a 100644\n--- a/core/os/os.h\n+++ b/core/os/os.h\n@@ -362,9 +362,9 @@ class OS {\n \t// This is invoked by the GDExtensionManager after loading GDExtensions specified by the project.\n \tvirtual void load_platform_gdextensions() const {}\n \n-\t// Windows only. Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n-\tvirtual bool _test_create_rendering_device_and_gl() const { return true; }\n-\tvirtual bool _test_create_rendering_device() const { return true; }\n+\t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const { return true; }\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const { return true; }\n \n \tOS();\n \tvirtual ~OS();\ndiff --git a/core/variant/callable.cpp b/core/variant/callable.cpp\nindex 402dc6823c0a..0603ea273253 100644\n--- a/core/variant/callable.cpp\n+++ b/core/variant/callable.cpp\n@@ -188,7 +188,7 @@ int Callable::get_argument_count(bool *r_is_valid) const {\n \tif (is_custom()) {\n \t\tbool valid = false;\n \t\treturn custom->get_argument_count(r_is_valid ? *r_is_valid : valid);\n-\t} else if (!is_null()) {\n+\t} else if (is_valid()) {\n \t\treturn get_object()->get_method_argument_count(method, r_is_valid);\n \t} else {\n \t\tif (r_is_valid) {\ndiff --git a/doc/classes/LineEdit.xml b/doc/classes/LineEdit.xml\nindex c6cdacb6ec25..879b179dbfef 100644\n--- a/doc/classes/LineEdit.xml\n+++ b/doc/classes/LineEdit.xml\n@@ -252,7 +252,7 @@\n \t\t\tThe caret's column position inside the [LineEdit]. When set, the text may scroll to accommodate it.\n \t\t</member>\n \t\t<member name=\"caret_force_displayed\" type=\"bool\" setter=\"set_caret_force_displayed\" getter=\"is_caret_force_displayed\" default=\"false\">\n-\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if focus is lost.\n+\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if not editing or focus is lost.\n \t\t</member>\n \t\t<member name=\"caret_mid_grapheme\" type=\"bool\" setter=\"set_caret_mid_grapheme_enabled\" getter=\"is_caret_mid_grapheme_enabled\" default=\"false\">\n \t\t\tAllow moving caret, selecting and removing the individual composite character components.\ndiff --git a/doc/classes/NativeMenu.xml b/doc/classes/NativeMenu.xml\nindex 6081d7afc51e..5eaec56e7ec9 100644\n--- a/doc/classes/NativeMenu.xml\n+++ b/doc/classes/NativeMenu.xml\n@@ -374,7 +374,7 @@\n \t\t\t<param index=\"0\" name=\"rid\" type=\"RID\" />\n \t\t\t<description>\n \t\t\t\tReturns global menu open callback.\n-\t\t\t\tb]Note:[/b] This method is implemented only on macOS.\n+\t\t\t\t[b]Note:[/b] This method is implemented only on macOS.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"get_size\" qualifiers=\"const\">\ndiff --git a/doc/classes/RDTextureView.xml b/doc/classes/RDTextureView.xml\nindex bd8102d5531d..2e03ee44aab4 100644\n--- a/doc/classes/RDTextureView.xml\n+++ b/doc/classes/RDTextureView.xml\n@@ -9,7 +9,7 @@\n \t<tutorials>\n \t</tutorials>\n \t<members>\n-\t\t<member name=\"format_override\" type=\"int\" setter=\"set_format_override\" getter=\"get_format_override\" enum=\"RenderingDevice.DataFormat\" default=\"218\">\n+\t\t<member name=\"format_override\" type=\"int\" setter=\"set_format_override\" getter=\"get_format_override\" enum=\"RenderingDevice.DataFormat\" default=\"232\">\n \t\t\tOptional override for the data format to return sampled values in. The corresponding [RDTextureFormat] must have had this added as a shareable format. The default value of [constant RenderingDevice.DATA_FORMAT_MAX] does not override the format.\n \t\t</member>\n \t\t<member name=\"swizzle_a\" type=\"int\" setter=\"set_swizzle_a\" getter=\"get_swizzle_a\" enum=\"RenderingDevice.TextureSwizzle\" default=\"6\">\ndiff --git a/doc/classes/RDVertexAttribute.xml b/doc/classes/RDVertexAttribute.xml\nindex 364b82526b6c..04e4bb53a045 100644\n--- a/doc/classes/RDVertexAttribute.xml\n+++ b/doc/classes/RDVertexAttribute.xml\n@@ -9,7 +9,7 @@\n \t<tutorials>\n \t</tutorials>\n \t<members>\n-\t\t<member name=\"format\" type=\"int\" setter=\"set_format\" getter=\"get_format\" enum=\"RenderingDevice.DataFormat\" default=\"218\">\n+\t\t<member name=\"format\" type=\"int\" setter=\"set_format\" getter=\"get_format\" enum=\"RenderingDevice.DataFormat\" default=\"232\">\n \t\t\tThe way that this attribute's data is interpreted when sent to a shader.\n \t\t</member>\n \t\t<member name=\"frequency\" type=\"int\" setter=\"set_frequency\" getter=\"get_frequency\" enum=\"RenderingDevice.VertexFrequency\" default=\"0\">\ndiff --git a/doc/classes/RenderingDevice.xml b/doc/classes/RenderingDevice.xml\nindex 8db0272c75bf..2fc0e485447c 100644\n--- a/doc/classes/RenderingDevice.xml\n+++ b/doc/classes/RenderingDevice.xml\n@@ -1871,7 +1871,35 @@\n \t\t<constant name=\"DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM\" value=\"217\" enum=\"DataFormat\">\n \t\t\t16-bit-per-channel unsigned floating-point green/blue/red channel data with normalized value, plus 6 unused bits after each channel. Stored across 3 separate planes (green + blue + red). Values are in the [code][0.0, 1.0][/code] range.\n \t\t</constant>\n-\t\t<constant name=\"DATA_FORMAT_MAX\" value=\"218\" enum=\"DataFormat\">\n+\t\t<constant name=\"DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK\" value=\"218\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK\" value=\"219\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK\" value=\"220\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK\" value=\"221\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK\" value=\"222\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK\" value=\"223\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK\" value=\"224\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK\" value=\"225\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK\" value=\"226\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK\" value=\"227\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK\" value=\"228\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK\" value=\"229\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK\" value=\"230\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK\" value=\"231\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_MAX\" value=\"232\" enum=\"DataFormat\">\n \t\t\tRepresents the size of the [enum DataFormat] enum.\n \t\t</constant>\n \t\t<constant name=\"BARRIER_MASK_VERTEX\" value=\"1\" enum=\"BarrierMask\" is_bitfield=\"true\">\ndiff --git a/drivers/apple/joypad_apple.h b/drivers/apple/joypad_apple.h\nindex 909648e253dd..d89707c03d75 100644\n--- a/drivers/apple/joypad_apple.h\n+++ b/drivers/apple/joypad_apple.h\n@@ -43,6 +43,7 @@ struct GameController {\n \tRumbleContext *rumble_context API_AVAILABLE(macos(11.0), ios(14.0), tvos(14.0)) = nil;\n \tNSInteger ff_effect_timestamp = 0;\n \tbool force_feedback = false;\n+\tbool nintendo_button_layout = false;\n \n \tGameController(int p_joy_id, GCController *p_controller);\n \t~GameController();\ndiff --git a/drivers/apple/joypad_apple.mm b/drivers/apple/joypad_apple.mm\nindex 148ec4cb2718..e14fc96a2841 100644\n--- a/drivers/apple/joypad_apple.mm\n+++ b/drivers/apple/joypad_apple.mm\n@@ -144,6 +144,12 @@ void play_strong_pattern(CHHapticPattern *p_pattern) {\n \t\t}\n \t}\n \n+\tif (@available(macOS 10.15, iOS 13.0, tvOS 13.0, *)) {\n+\t\tif ([controller.productCategory isEqualToString:@\"Switch Pro Controller\"] || [controller.productCategory isEqualToString:@\"Nintendo Switch Joy-Con (L/R)\"]) {\n+\t\t\tnintendo_button_layout = true;\n+\t\t}\n+\t}\n+\n \tint l_joy_id = joy_id;\n \n \tauto BUTTON = [l_joy_id](JoyButton p_button) {\n@@ -155,10 +161,18 @@ void play_strong_pattern(CHHapticPattern *p_pattern) {\n \tif (controller.extendedGamepad != nil) {\n \t\tGCExtendedGamepad *gamepad = controller.extendedGamepad;\n \n-\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::A);\n-\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::B);\n-\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::X);\n-\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\tif (nintendo_button_layout) {\n+\t\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::B);\n+\t\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::A);\n+\t\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::X);\n+\t\t} else {\n+\t\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::A);\n+\t\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::B);\n+\t\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::X);\n+\t\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\t}\n+\n \t\tgamepad.leftShoulder.pressedChangedHandler = BUTTON(JoyButton::LEFT_SHOULDER);\n \t\tgamepad.rightShoulder.pressedChangedHandler = BUTTON(JoyButton::RIGHT_SHOULDER);\n \t\tgamepad.dpad.up.pressedChangedHandler = BUTTON(JoyButton::DPAD_UP);\ndiff --git a/drivers/d3d12/rendering_device_driver_d3d12.cpp b/drivers/d3d12/rendering_device_driver_d3d12.cpp\nindex 29b36f140551..f5772f2e3024 100644\n--- a/drivers/d3d12/rendering_device_driver_d3d12.cpp\n+++ b/drivers/d3d12/rendering_device_driver_d3d12.cpp\n@@ -332,6 +332,20 @@ const RenderingDeviceDriverD3D12::D3D12Format RenderingDeviceDriverD3D12::RD_TO_\n \t/* DATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM */ {},\n \t/* DATA_FORMAT_G16_B16R16_2PLANE_422_UNORM */ {},\n \t/* DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM */ {},\n+\t/* DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK*/ {},\n+\t/* DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK */ {},\n };\n \n Error RenderingDeviceDriverD3D12::DescriptorsHeap::allocate(ID3D12Device *p_device, D3D12_DESCRIPTOR_HEAP_TYPE p_type, uint32_t p_descriptor_count, bool p_for_gpu) {\ndiff --git a/drivers/gles3/effects/copy_effects.cpp b/drivers/gles3/effects/copy_effects.cpp\nindex 47ca832bd7ab..4d74a4996b9f 100644\n--- a/drivers/gles3/effects/copy_effects.cpp\n+++ b/drivers/gles3/effects/copy_effects.cpp\n@@ -243,7 +243,7 @@ void CopyEffects::gaussian_blur(GLuint p_source_texture, int p_mipmap_count, con\n \n \t\tglBindTexture(GL_TEXTURE_2D, p_source_texture);\n \t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_BASE_LEVEL, i - 1);\n-\t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAX_LEVEL, i - 1);\n+\t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAX_LEVEL, i);\n \t\tglFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, p_source_texture, i);\n #ifdef DEV_ENABLED\n \t\tGLenum status = glCheckFramebufferStatus(GL_FRAMEBUFFER);\ndiff --git a/drivers/gles3/rasterizer_canvas_gles3.cpp b/drivers/gles3/rasterizer_canvas_gles3.cpp\nindex 0ca013abd1a0..441636cd26db 100644\n--- a/drivers/gles3/rasterizer_canvas_gles3.cpp\n+++ b/drivers/gles3/rasterizer_canvas_gles3.cpp\n@@ -1152,6 +1152,12 @@ void RasterizerCanvasGLES3::_record_item_commands(const Item *p_item, RID p_rend\n \t\t\t\t\t// Reset base data.\n \t\t\t\t\t_update_transform_2d_to_mat2x3(base_transform * draw_transform, state.instance_data_array[r_index].world);\n \t\t\t\t\t_prepare_canvas_texture(state.canvas_instance_batches[state.current_batch_index].tex, state.canvas_instance_batches[state.current_batch_index].filter, state.canvas_instance_batches[state.current_batch_index].repeat, r_index, texpixel_size);\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[0] = lights[0];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[1] = lights[1];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[2] = lights[2];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[3] = lights[3];\n+\t\t\t\t\tstate.instance_data_array[r_index].flags = base_flags;\n+\t\t\t\t\tstate.instance_data_array[r_index].instance_uniforms_ofs = p_item->instance_allocated_shader_uniforms_offset;\n \n \t\t\t\t\tfor (uint32_t j = 0; j < 3; j++) {\n \t\t\t\t\t\tint offset = j == 0 ? 0 : 1;\ndiff --git a/drivers/gles3/storage/particles_storage.cpp b/drivers/gles3/storage/particles_storage.cpp\nindex 73d7e340d2a8..599412c5b2de 100644\n--- a/drivers/gles3/storage/particles_storage.cpp\n+++ b/drivers/gles3/storage/particles_storage.cpp\n@@ -513,7 +513,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tGLES3::TextureStorage *texture_storage = GLES3::TextureStorage::get_singleton();\n \tGLES3::MaterialStorage *material_storage = GLES3::MaterialStorage::get_singleton();\n \n-\tdouble new_phase = Math::fmod(p_particles->phase + (p_delta / p_particles->lifetime) * p_particles->speed_scale, 1.0);\n+\tdouble new_phase = Math::fmod(p_particles->phase + (p_delta / p_particles->lifetime), 1.0);\n \n \t//update current frame\n \tParticlesFrameParams frame_params;\n@@ -534,7 +534,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tp_particles->phase = new_phase;\n \n \tframe_params.time = RSG::rasterizer->get_total_time();\n-\tframe_params.delta = p_delta * p_particles->speed_scale;\n+\tframe_params.delta = p_delta;\n \tframe_params.random_seed = p_particles->random_seed;\n \tframe_params.explosiveness = p_particles->explosiveness;\n \tframe_params.randomness = p_particles->randomness;\n@@ -1097,8 +1097,6 @@ void ParticlesStorage::update_particles() {\n \t\t\tfixed_fps = particles->fixed_fps;\n \t\t}\n \n-\t\tbool zero_time_scale = Engine::get_singleton()->get_time_scale() <= 0.0;\n-\n \t\tif (particles->clear && particles->pre_process_time > 0.0) {\n \t\t\tdouble frame_time;\n \t\t\tif (fixed_fps > 0) {\n@@ -1115,37 +1113,27 @@ void ParticlesStorage::update_particles() {\n \t\t\t}\n \t\t}\n \n+\t\tdouble time_scale = MAX(particles->speed_scale, 0.0);\n+\n \t\tif (fixed_fps > 0) {\n-\t\t\tdouble frame_time;\n-\t\t\tdouble decr;\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\tframe_time = 0.0;\n-\t\t\t\tdecr = 1.0 / fixed_fps;\n-\t\t\t} else {\n-\t\t\t\tframe_time = 1.0 / fixed_fps;\n-\t\t\t\tdecr = frame_time;\n-\t\t\t}\n+\t\t\tdouble frame_time = 1.0 / fixed_fps;\n \t\t\tdouble delta = RSG::rasterizer->get_frame_delta_time();\n \t\t\tif (delta > 0.1) { //avoid recursive stalls if fps goes below 10\n \t\t\t\tdelta = 0.1;\n \t\t\t} else if (delta <= 0.0) { //unlikely but..\n \t\t\t\tdelta = 0.001;\n \t\t\t}\n-\t\t\tdouble todo = particles->frame_remainder + delta;\n+\t\t\tdouble todo = particles->frame_remainder + delta * time_scale;\n \n \t\t\twhile (todo >= frame_time) {\n \t\t\t\t_particles_process(particles, frame_time);\n-\t\t\t\ttodo -= decr;\n+\t\t\t\ttodo -= frame_time;\n \t\t\t}\n \n \t\t\tparticles->frame_remainder = todo;\n \n \t\t} else {\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\t_particles_process(particles, 0.0);\n-\t\t\t} else {\n-\t\t\t\t_particles_process(particles, RSG::rasterizer->get_frame_delta_time());\n-\t\t\t}\n+\t\t\t_particles_process(particles, RSG::rasterizer->get_frame_delta_time() * time_scale);\n \t\t}\n \n \t\tif (particles->request_process_time > 0.0) {\ndiff --git a/drivers/metal/pixel_formats.mm b/drivers/metal/pixel_formats.mm\nindex c9226590b169..c784faa8397b 100644\n--- a/drivers/metal/pixel_formats.mm\n+++ b/drivers/metal/pixel_formats.mm\n@@ -493,32 +493,46 @@ void clear(T *p_val, size_t p_count = 1) {\n \taddDataFormatDesc(EAC_R11G11_SNORM_BLOCK, EAC_RG11Snorm, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \n \taddDataFormatDesc(ASTC_4x4_UNORM_BLOCK, ASTC_4x4_LDR, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n+\taddDataFormatDesc(ASTC_4x4_SFLOAT_BLOCK, ASTC_4x4_HDR, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_4x4_SRGB_BLOCK, ASTC_4x4_sRGB, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x4_UNORM_BLOCK, ASTC_5x4_LDR, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n+\taddDataFormatDesc(ASTC_5x4_SFLOAT_BLOCK, ASTC_5x4_HDR, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x4_SRGB_BLOCK, ASTC_5x4_sRGB, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x5_UNORM_BLOCK, ASTC_5x5_LDR, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_5x5_SFLOAT_BLOCK, ASTC_5x5_HDR, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x5_SRGB_BLOCK, ASTC_5x5_sRGB, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x5_UNORM_BLOCK, ASTC_6x5_LDR, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_6x5_SFLOAT_BLOCK, ASTC_6x5_HDR, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x5_SRGB_BLOCK, ASTC_6x5_sRGB, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x6_UNORM_BLOCK, ASTC_6x6_LDR, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_6x6_SFLOAT_BLOCK, ASTC_6x6_HDR, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x6_SRGB_BLOCK, ASTC_6x6_sRGB, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x5_UNORM_BLOCK, ASTC_8x5_LDR, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x5_SFLOAT_BLOCK, ASTC_8x5_HDR, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x5_SRGB_BLOCK, ASTC_8x5_sRGB, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x6_UNORM_BLOCK, ASTC_8x6_LDR, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x6_SFLOAT_BLOCK, ASTC_8x6_HDR, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x6_SRGB_BLOCK, ASTC_8x6_sRGB, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x8_UNORM_BLOCK, ASTC_8x8_LDR, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x8_SFLOAT_BLOCK, ASTC_8x8_HDR, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x8_SRGB_BLOCK, ASTC_8x8_sRGB, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x5_UNORM_BLOCK, ASTC_10x5_LDR, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x5_SFLOAT_BLOCK, ASTC_10x5_HDR, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x5_SRGB_BLOCK, ASTC_10x5_sRGB, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x6_UNORM_BLOCK, ASTC_10x6_LDR, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x6_SFLOAT_BLOCK, ASTC_10x6_HDR, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x6_SRGB_BLOCK, ASTC_10x6_sRGB, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x8_UNORM_BLOCK, ASTC_10x8_LDR, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x8_SFLOAT_BLOCK, ASTC_10x8_HDR, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x8_SRGB_BLOCK, ASTC_10x8_sRGB, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x10_UNORM_BLOCK, ASTC_10x10_LDR, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x10_SFLOAT_BLOCK, ASTC_10x10_HDR, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x10_SRGB_BLOCK, ASTC_10x10_sRGB, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x10_UNORM_BLOCK, ASTC_12x10_LDR, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n+\taddDataFormatDesc(ASTC_12x10_SFLOAT_BLOCK, ASTC_12x10_HDR, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x10_SRGB_BLOCK, ASTC_12x10_sRGB, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x12_UNORM_BLOCK, ASTC_12x12_LDR, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n+\taddDataFormatDesc(ASTC_12x12_SFLOAT_BLOCK, ASTC_12x12_HDR, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x12_SRGB_BLOCK, ASTC_12x12_sRGB, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n \n \taddDfFormatDescChromaSubsampling(G8B8G8R8_422_UNORM, GBGR422, 1, 8, 2, 1, 4);\ndiff --git a/drivers/vulkan/rendering_device_driver_vulkan.cpp b/drivers/vulkan/rendering_device_driver_vulkan.cpp\nindex ae15191dd429..9c50c845a70b 100644\n--- a/drivers/vulkan/rendering_device_driver_vulkan.cpp\n+++ b/drivers/vulkan/rendering_device_driver_vulkan.cpp\n@@ -276,6 +276,20 @@ static const VkFormat RD_TO_VK_FORMAT[RDD::DATA_FORMAT_MAX] = {\n \tVK_FORMAT_G16_B16_R16_3PLANE_422_UNORM,\n \tVK_FORMAT_G16_B16R16_2PLANE_422_UNORM,\n \tVK_FORMAT_G16_B16_R16_3PLANE_444_UNORM,\n+\tVK_FORMAT_ASTC_4x4_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_5x4_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_5x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_6x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_6x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x8_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x8_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x10_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_12x10_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_12x12_SFLOAT_BLOCK,\n };\n \n static VkImageLayout RD_TO_VK_LAYOUT[RDD::TEXTURE_LAYOUT_MAX] = {\n@@ -514,6 +528,7 @@ Error RenderingDeviceDriverVulkan::_initialize_device_extensions() {\n \t_register_requested_device_extension(VK_EXT_SUBGROUP_SIZE_CONTROL_EXTENSION_NAME, false);\n \t_register_requested_device_extension(VK_EXT_ASTC_DECODE_MODE_EXTENSION_NAME, false);\n \t_register_requested_device_extension(VK_KHR_BUFFER_DEVICE_ADDRESS_EXTENSION_NAME, false);\n+\t_register_requested_device_extension(VK_EXT_TEXTURE_COMPRESSION_ASTC_HDR_EXTENSION_NAME, false);\n \n \tif (Engine::get_singleton()->is_generate_spirv_debug_info_enabled()) {\n \t\t_register_requested_device_extension(VK_KHR_SHADER_NON_SEMANTIC_INFO_EXTENSION_NAME, true);\n@@ -1547,6 +1562,10 @@ RDD::BufferID RenderingDeviceDriverVulkan::buffer_create(uint64_t p_size, BitFie\n \t\t} break;\n \t\tcase MEMORY_ALLOCATION_TYPE_GPU: {\n \t\t\tvma_usage = VMA_MEMORY_USAGE_AUTO_PREFER_DEVICE;\n+\t\t\tif (!Engine::get_singleton()->is_extra_gpu_memory_tracking_enabled()) {\n+\t\t\t\t// We must set it right now or else vmaFindMemoryTypeIndexForBufferInfo will use wrong parameters.\n+\t\t\t\talloc_create_info.usage = vma_usage;\n+\t\t\t}\n \t\t\talloc_create_info.preferredFlags = VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT;\n \t\t\tif (p_size <= SMALL_ALLOCATION_MAX_SIZE) {\n \t\t\t\tuint32_t mem_type_index = 0;\n@@ -2140,6 +2159,10 @@ void RenderingDeviceDriverVulkan::texture_unmap(TextureID p_texture) {\n }\n \n BitField<RDD::TextureUsageBits> RenderingDeviceDriverVulkan::texture_get_usages_supported_by_format(DataFormat p_format, bool p_cpu_readable) {\n+\tif (p_format >= DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK && p_format <= DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK && !enabled_device_extension_names.has(VK_EXT_TEXTURE_COMPRESSION_ASTC_HDR_EXTENSION_NAME)) {\n+\t\t// Formats that were introduced later with extensions must not reach vkGetPhysicalDeviceFormatProperties if the extension isn't available. This means it's not supported.\n+\t\treturn 0;\n+\t}\n \tVkFormatProperties properties = {};\n \tvkGetPhysicalDeviceFormatProperties(physical_device, RD_TO_VK_FORMAT[p_format], &properties);\n \ndiff --git a/drivers/windows/file_access_windows.cpp b/drivers/windows/file_access_windows.cpp\nindex a8e2a6859bc3..6835b510df73 100644\n--- a/drivers/windows/file_access_windows.cpp\n+++ b/drivers/windows/file_access_windows.cpp\n@@ -418,7 +418,7 @@ uint64_t FileAccessWindows::_get_modified_time(const String &p_file) {\n \t\tfile = file.substr(0, file.length() - 1);\n \t}\n \n-\tHANDLE handle = CreateFileW((LPCWSTR)(file.utf16().get_data()), GENERIC_READ, FILE_SHARE_READ, nullptr, OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS, nullptr);\n+\tHANDLE handle = CreateFileW((LPCWSTR)(file.utf16().get_data()), FILE_READ_ATTRIBUTES, FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE, nullptr, OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS, nullptr);\n \n \tif (handle != INVALID_HANDLE_VALUE) {\n \t\tFILETIME ft_create, ft_write;\ndiff --git a/editor/animation_track_editor.cpp b/editor/animation_track_editor.cpp\nindex dbb23d6f17a6..bb51c16f37b5 100644\n--- a/editor/animation_track_editor.cpp\n+++ b/editor/animation_track_editor.cpp\n@@ -5088,7 +5088,7 @@ void AnimationTrackEditor::_update_nearest_fps_label() {\n \t\tnearest_fps_label->hide();\n \t} else {\n \t\tnearest_fps_label->show();\n-\t\tnearest_fps_label->set_text(\"Nearest FPS: \" + itos(nearest_fps));\n+\t\tnearest_fps_label->set_text(vformat(TTR(\"Nearest FPS: %d\"), nearest_fps));\n \t}\n }\n \n@@ -7688,6 +7688,7 @@ AnimationTrackEditor::AnimationTrackEditor() {\n \tfps_compat->connect(SceneStringName(toggled), callable_mp(this, &AnimationTrackEditor::_update_fps_compat_mode));\n \n \tnearest_fps_label = memnew(Label);\n+\tnearest_fps_label->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \tbottom_hf->add_child(nearest_fps_label);\n \n \tstep = memnew(EditorSpinSlider);\ndiff --git a/editor/connections_dialog.cpp b/editor/connections_dialog.cpp\nindex dca43411e10b..5081be0d2d94 100644\n--- a/editor/connections_dialog.cpp\n+++ b/editor/connections_dialog.cpp\n@@ -453,7 +453,13 @@ void ConnectDialog::_update_ok_enabled() {\n }\n \n void ConnectDialog::_update_warning_label() {\n-\tRef<Script> scr = source->get_node(dst_path)->get_script();\n+\tNode *dst = source->get_node(dst_path);\n+\tif (dst == nullptr) {\n+\t\twarning_label->set_visible(false);\n+\t\treturn;\n+\t}\n+\n+\tRef<Script> scr = dst->get_script();\n \tif (scr.is_null()) {\n \t\twarning_label->set_visible(false);\n \t\treturn;\n@@ -865,9 +871,8 @@ ConnectDialog::ConnectDialog() {\n \thbc_method->add_child(dst_method);\n \tregister_text_enter(dst_method);\n \n-\topen_method_tree = memnew(Button);\n+\topen_method_tree = memnew(Button(TTRC(\"Pick\")));\n \thbc_method->add_child(open_method_tree);\n-\topen_method_tree->set_text(\"Pick\");\n \topen_method_tree->connect(SceneStringName(pressed), callable_mp(this, &ConnectDialog::_open_method_popup));\n \n \tadvanced = memnew(CheckButton(TTR(\"Advanced\")));\ndiff --git a/editor/debugger/debug_adapter/debug_adapter_protocol.cpp b/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\nindex ba4c078d7ed5..00ae9dca7ebb 100644\n--- a/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\n+++ b/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\n@@ -1032,6 +1032,7 @@ void DebugAdapterProtocol::on_debug_paused() {\n void DebugAdapterProtocol::on_debug_stopped() {\n \tnotify_exited();\n \tnotify_terminated();\n+\treset_ids();\n }\n \n void DebugAdapterProtocol::on_debug_output(const String &p_message, int p_type) {\ndiff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 58b02ed2b8a1..87a7433e8cb9 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -3440,6 +3440,8 @@ void EditorInspector::update_tree() {\n \t\t// Recreate the category vbox if it was reset.\n \t\tif (category_vbox == nullptr) {\n \t\t\tcategory_vbox = memnew(VBoxContainer);\n+\t\t\tint separation = get_theme_constant(SNAME(\"v_separation\"), SNAME(\"EditorInspector\"));\n+\t\t\tcategory_vbox->add_theme_constant_override(SNAME(\"separation\"), separation);\n \t\t\tcategory_vbox->hide();\n \t\t\tmain_vbox->add_child(category_vbox);\n \t\t}\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 6b725240f9e2..2261b14acbe3 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -1207,7 +1207,7 @@ void EditorNode::_sources_changed(bool p_exist) {\n \t\t}\n \n \t\t// Start preview thread now that it's safe.\n-\t\tif (!singleton->cmdline_export_mode) {\n+\t\tif (!singleton->cmdline_mode) {\n \t\t\tEditorResourcePreview::get_singleton()->start();\n \t\t}\n \n@@ -1807,7 +1807,7 @@ void EditorNode::_save_scene_with_preview(String p_file, int p_idx) {\n \tsave_scene_progress->step(TTR(\"Saving Scene\"), 4);\n \t_save_scene(p_file, p_idx);\n \n-\tif (!singleton->cmdline_export_mode) {\n+\tif (!singleton->cmdline_mode) {\n \t\tEditorResourcePreview::get_singleton()->check_for_invalidation(p_file);\n \t}\n \n@@ -1867,6 +1867,7 @@ int EditorNode::_save_external_resources(bool p_also_save_external_data) {\n \t\tres->set_edited(false);\n \t}\n \n+\tbool script_was_saved = false;\n \tfor (const String &E : edited_resources) {\n \t\tRef<Resource> res = ResourceCache::get_ref(E);\n \t\tif (res.is_null()) {\n@@ -1876,10 +1877,18 @@ int EditorNode::_save_external_resources(bool p_also_save_external_data) {\n \t\tif (ps.is_valid()) {\n \t\t\tcontinue; // Do not save PackedScenes, this will mess up the editor.\n \t\t}\n+\t\tif (!script_was_saved) {\n+\t\t\tRef<Script> scr = res;\n+\t\t\tscript_was_saved = scr.is_valid();\n+\t\t}\n \t\tResourceSaver::save(res, res->get_path(), flg);\n \t\tsaved++;\n \t}\n \n+\tif (script_was_saved) {\n+\t\tScriptEditor::get_singleton()->update_script_times();\n+\t}\n+\n \tif (p_also_save_external_data) {\n \t\tfor (int i = 0; i < editor_data.get_editor_plugin_count(); i++) {\n \t\t\tEditorPlugin *plugin = editor_data.get_editor_plugin(i);\n@@ -4944,7 +4953,7 @@ bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringNa\n void EditorNode::progress_add_task(const String &p_task, const String &p_label, int p_steps, bool p_can_cancel) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": begin: \" + p_label + \" steps: \" + itos(p_steps));\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->add_task(p_task, p_label, p_steps, p_can_cancel);\n@@ -4954,7 +4963,7 @@ void EditorNode::progress_add_task(const String &p_task, const String &p_label,\n bool EditorNode::progress_task_step(const String &p_task, const String &p_state, int p_step, bool p_force_refresh) {\n \tif (!singleton) {\n \t\treturn false;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(\"\\t\" + p_task + \": step \" + itos(p_step) + \": \" + p_state);\n \t\treturn false;\n \t} else if (singleton->progress_dialog) {\n@@ -4967,7 +4976,7 @@ bool EditorNode::progress_task_step(const String &p_task, const String &p_state,\n void EditorNode::progress_end_task(const String &p_task) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": end\");\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->end_task(p_task);\n@@ -5220,7 +5229,7 @@ Error EditorNode::export_preset(const String &p_preset, const String &p_path, bo\n \texport_defer.android_build_template = p_android_build_template;\n \texport_defer.patch = p_patch;\n \texport_defer.patches = p_patches;\n-\tcmdline_export_mode = true;\n+\tcmdline_mode = true;\n \treturn OK;\n }\n \n@@ -6848,7 +6857,10 @@ EditorNode::EditorNode() {\n \tDEV_ASSERT(!singleton);\n \tsingleton = this;\n \n-\tset_translation_domain(\"godot.editor\");\n+\t// Detecting headless mode, that means the editor is running in command line.\n+\tif (!DisplayServer::get_singleton()->window_can_draw()) {\n+\t\tcmdline_mode = true;\n+\t}\n \n \tResource::_get_local_scene_func = _resource_get_edited_scene;\n \ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex de3af997473a..63788e645f30 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -419,7 +419,7 @@ class EditorNode : public Node {\n \tbool script_distraction_free = false;\n \n \tbool changing_scene = false;\n-\tbool cmdline_export_mode = false;\n+\tbool cmdline_mode = false;\n \tbool convert_old = false;\n \tbool immediate_dialog_confirmed = false;\n \tbool opening_prev = false;\ndiff --git a/editor/export/project_export.cpp b/editor/export/project_export.cpp\nindex 5b93a1a17ec7..0982520acd58 100644\n--- a/editor/export/project_export.cpp\n+++ b/editor/export/project_export.cpp\n@@ -1746,11 +1746,13 @@ ProjectExportDialog::ProjectExportDialog() {\n \texport_error = memnew(Label);\n \tmain_vb->add_child(export_error);\n \texport_error->hide();\n+\texport_error->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_error->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"error_color\"), EditorStringName(Editor)));\n \n \texport_warning = memnew(Label);\n \tmain_vb->add_child(export_warning);\n \texport_warning->hide();\n+\texport_warning->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_warning->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"warning_color\"), EditorStringName(Editor)));\n \n \texport_templates_error = memnew(HBoxContainer);\n@@ -1759,6 +1761,7 @@ ProjectExportDialog::ProjectExportDialog() {\n \n \tLabel *export_error2 = memnew(Label);\n \texport_templates_error->add_child(export_error2);\n+\texport_error2->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_error2->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"error_color\"), EditorStringName(Editor)));\n \texport_error2->set_text(String::utf8(\"\u2022  \") + TTR(\"Export templates for this platform are missing:\") + \" \");\n \ndiff --git a/editor/plugins/polygon_3d_editor_plugin.cpp b/editor/plugins/polygon_3d_editor_plugin.cpp\nindex 9d7567f2528a..f07ce22127c3 100644\n--- a/editor/plugins/polygon_3d_editor_plugin.cpp\n+++ b/editor/plugins/polygon_3d_editor_plugin.cpp\n@@ -560,6 +560,7 @@ Polygon3DEditor::Polygon3DEditor() {\n \tline_material->set_flag(StandardMaterial3D::FLAG_ALBEDO_FROM_VERTEX_COLOR, true);\n \tline_material->set_flag(StandardMaterial3D::FLAG_SRGB_VERTEX_COLOR, true);\n \tline_material->set_flag(StandardMaterial3D::FLAG_DISABLE_FOG, true);\n+\tline_material->set_flag(StandardMaterial3D::FLAG_DISABLE_DEPTH_TEST, true);\n \tline_material->set_albedo(Color(1, 1, 1));\n \n \thandle_material.instantiate();\n@@ -569,6 +570,7 @@ Polygon3DEditor::Polygon3DEditor() {\n \thandle_material->set_flag(StandardMaterial3D::FLAG_ALBEDO_FROM_VERTEX_COLOR, true);\n \thandle_material->set_flag(StandardMaterial3D::FLAG_SRGB_VERTEX_COLOR, true);\n \thandle_material->set_flag(StandardMaterial3D::FLAG_DISABLE_FOG, true);\n+\thandle_material->set_flag(StandardMaterial3D::FLAG_DISABLE_DEPTH_TEST, true);\n \tRef<Texture2D> handle = EditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"Editor3DHandle\"), EditorStringName(EditorIcons));\n \thandle_material->set_point_size(handle->get_width());\n \thandle_material->set_texture(StandardMaterial3D::TEXTURE_ALBEDO, handle);\ndiff --git a/editor/plugins/script_editor_plugin.cpp b/editor/plugins/script_editor_plugin.cpp\nindex af7812abe806..45b921fad613 100644\n--- a/editor/plugins/script_editor_plugin.cpp\n+++ b/editor/plugins/script_editor_plugin.cpp\n@@ -2817,6 +2817,15 @@ void ScriptEditor::save_all_scripts() {\n \t_update_script_names();\n }\n \n+void ScriptEditor::update_script_times() {\n+\tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n+\t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n+\t\tif (se) {\n+\t\t\tse->edited_file_data.last_modified_time = FileAccess::get_modified_time(se->edited_file_data.path);\n+\t\t}\n+\t}\n+}\n+\n void ScriptEditor::apply_scripts() const {\n \tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n \t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n@@ -4205,6 +4214,7 @@ ScriptEditor::ScriptEditor(WindowWrapper *p_wrapper) {\n \toverview_vbox->add_child(buttons_hbox);\n \n \tfilename = memnew(Label);\n+\tfilename->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \tfilename->set_clip_text(true);\n \tfilename->set_h_size_flags(SIZE_EXPAND_FILL);\n \tfilename->set_vertical_alignment(VERTICAL_ALIGNMENT_CENTER);\ndiff --git a/editor/plugins/script_editor_plugin.h b/editor/plugins/script_editor_plugin.h\nindex 02e0529a7cf6..30198f1cb1c6 100644\n--- a/editor/plugins/script_editor_plugin.h\n+++ b/editor/plugins/script_editor_plugin.h\n@@ -569,6 +569,7 @@ class ScriptEditor : public PanelContainer {\n \tPackedStringArray get_unsaved_scripts() const;\n \tvoid save_current_script();\n \tvoid save_all_scripts();\n+\tvoid update_script_times();\n \n \tvoid set_window_layout(Ref<ConfigFile> p_layout);\n \tvoid get_window_layout(Ref<ConfigFile> p_layout);\ndiff --git a/editor/plugins/visual_shader_editor_plugin.cpp b/editor/plugins/visual_shader_editor_plugin.cpp\nindex b8af4603e80f..516ef516154c 100644\n--- a/editor/plugins/visual_shader_editor_plugin.cpp\n+++ b/editor/plugins/visual_shader_editor_plugin.cpp\n@@ -7623,12 +7623,15 @@ class VisualShaderNodePluginInputEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_input_select_item\"), input, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_input_select_item\"), input, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeInput> &p_input) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tinput = p_input;\n+\n \t\tRef<Texture2D> type_icon[] = {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"float\"), EditorStringName(EditorIcons)),\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"int\"), EditorStringName(EditorIcons)),\n@@ -7641,13 +7644,16 @@ class VisualShaderNodePluginInputEditor : public OptionButton {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"ImageTexture\"), EditorStringName(EditorIcons)),\n \t\t};\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n+\n \t\tint to_select = -1;\n \t\tfor (int i = 0; i < input->get_input_index_count(); i++) {\n \t\t\tif (input->get_input_name() == input->get_input_index_name(i)) {\n \t\t\t\tto_select = i + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[input->get_input_index_type(i)], input->get_input_index_name(i));\n+\t\t\tset_item_metadata(-1, input->get_input_index_name(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -7672,10 +7678,12 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_varying_select_item\"), varying, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_varying_select_item\"), varying, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeVarying> &p_varying, VisualShader::Type p_type) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tvarying = p_varying;\n \n@@ -7692,7 +7700,8 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \n \t\tbool is_getter = Ref<VisualShaderNodeVaryingGetter>(p_varying.ptr()).is_valid();\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n \n \t\tint to_select = -1;\n \t\tfor (int i = 0, j = 0; i < varying->get_varyings_count(); i++) {\n@@ -7726,6 +7735,7 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \t\t\t\tto_select = i - j + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[varying->get_varying_type_by_index(i)], varying->get_varying_name_by_index(i));\n+\t\t\tset_item_metadata(-1, varying->get_varying_name_by_index(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -7752,10 +7762,12 @@ class VisualShaderNodePluginParameterRefEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_parameter_ref_select_item\"), parameter_ref, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_parameter_ref_select_item\"), parameter_ref, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeParameterRef> &p_parameter_ref) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tparameter_ref = p_parameter_ref;\n \n@@ -7772,13 +7784,16 @@ class VisualShaderNodePluginParameterRefEditor : public OptionButton {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"ImageTexture\"), EditorStringName(EditorIcons)),\n \t\t};\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n+\n \t\tint to_select = -1;\n \t\tfor (int i = 0; i < p_parameter_ref->get_parameters_count(); i++) {\n \t\t\tif (p_parameter_ref->get_parameter_name() == p_parameter_ref->get_parameter_name_by_index(i)) {\n \t\t\t\tto_select = i + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[p_parameter_ref->get_parameter_type_by_index(i)], p_parameter_ref->get_parameter_name_by_index(i));\n+\t\t\tset_item_metadata(-1, p_parameter_ref->get_parameter_name_by_index(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -8126,6 +8141,7 @@ void EditorPropertyVisualShaderMode::set_option_button_clip(bool p_enable) {\n \n EditorPropertyVisualShaderMode::EditorPropertyVisualShaderMode() {\n \toptions = memnew(OptionButton);\n+\toptions->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \toptions->set_clip_text(true);\n \tadd_child(options);\n \tadd_focusable(options);\ndiff --git a/editor/project_manager.cpp b/editor/project_manager.cpp\nindex c3bd3acf775f..19bcfe8bc516 100644\n--- a/editor/project_manager.cpp\n+++ b/editor/project_manager.cpp\n@@ -1162,8 +1162,6 @@ void ProjectManager::_titlebar_resized() {\n ProjectManager::ProjectManager(bool p_custom_res) {\n \tsingleton = this;\n \n-\tset_translation_domain(\"godot.editor\");\n-\n \t// Turn off some servers we aren't going to be using in the Project Manager.\n \tNavigationServer3D::get_singleton()->set_active(false);\n \tPhysicsServer3D::get_singleton()->set_active(false);\ndiff --git a/editor/project_manager/project_list.cpp b/editor/project_manager/project_list.cpp\nindex b96e40b0b73e..7eeb2f8460a2 100644\n--- a/editor/project_manager/project_list.cpp\n+++ b/editor/project_manager/project_list.cpp\n@@ -68,10 +68,13 @@ void ProjectListItemControl::_notification(int p_what) {\n \t\t\tproject_unsupported_features->set_texture(get_editor_theme_icon(SNAME(\"NodeWarning\")));\n \n \t\t\tfavorite_button->set_texture_normal(get_editor_theme_icon(SNAME(\"Favorites\")));\n+\n \t\t\tif (project_is_missing) {\n \t\t\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"FileBroken\")));\n+#if !defined(ANDROID_ENABLED) && !defined(WEB_ENABLED)\n \t\t\t} else {\n \t\t\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n+#endif\n \t\t\t}\n \t\t} break;\n \n@@ -190,9 +193,6 @@ void ProjectListItemControl::set_is_favorite(bool p_favorite) {\n }\n \n void ProjectListItemControl::set_is_missing(bool p_missing) {\n-\tif (project_is_missing == p_missing) {\n-\t\treturn;\n-\t}\n \tproject_is_missing = p_missing;\n \n \tif (project_is_missing) {\n@@ -201,10 +201,8 @@ void ProjectListItemControl::set_is_missing(bool p_missing) {\n \t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"FileBroken\")));\n \t\texplore_button->set_tooltip_text(TTR(\"Error: Project is missing on the filesystem.\"));\n \t} else {\n-\t\tproject_icon->set_modulate(Color(1, 1, 1, 1.0));\n-\n-\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n #if !defined(ANDROID_ENABLED) && !defined(WEB_ENABLED)\n+\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n \t\texplore_button->set_tooltip_text(TTR(\"Show in File Manager\"));\n #else\n \t\t// Opening the system file manager is not supported on the Android and web editors.\ndiff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex 267d35f99458..1390d8256e08 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -4268,7 +4268,7 @@ List<Node *> SceneTreeDock::paste_nodes(bool p_paste_as_sibling) {\n \t\t\t// and added to the node_clipboard_edited_scene_owned list.\n \t\t\tif (d != dup && E2.key->get_owner() == nullptr) {\n \t\t\t\tif (node_clipboard_edited_scene_owned.find(const_cast<Node *>(E2.key))) {\n-\t\t\t\t\tur->add_do_method(d, \"set_owner\", edited_scene);\n+\t\t\t\t\tur->add_do_method(d, \"set_owner\", owner);\n \t\t\t\t}\n \t\t\t}\n \t\t}\ndiff --git a/main/main.cpp b/main/main.cpp\nindex 10064b350376..9a1ab8771245 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -979,7 +979,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \tString project_path = \".\";\n \tbool upwards = false;\n \tString debug_uri = \"\";\n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \tbool test_rd_creation = false;\n \tbool test_rd_support = false;\n #endif\n@@ -1671,7 +1671,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \t\t} else if (arg == \"--debug-stringnames\") {\n \t\t\tStringName::set_debug_stringnames(true);\n #endif\n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \t\t} else if (arg == \"--test-rd-support\") {\n \t\t\ttest_rd_support = true;\n \t\t} else if (arg == \"--test-rd-creation\") {\n@@ -1880,12 +1880,12 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n #endif\n \t}\n \n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \tif (test_rd_support) {\n \t\t// Test Rendering Device creation and exit.\n \n \t\tOS::get_singleton()->set_crash_handler_silent();\n-\t\tif (OS::get_singleton()->_test_create_rendering_device()) {\n+\t\tif (OS::get_singleton()->_test_create_rendering_device(display_driver)) {\n \t\t\texit_err = ERR_HELP;\n \t\t} else {\n \t\t\texit_err = ERR_UNAVAILABLE;\n@@ -1895,7 +1895,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \t\t// Test OpenGL context and Rendering Device simultaneous creation and exit.\n \n \t\tOS::get_singleton()->set_crash_handler_silent();\n-\t\tif (OS::get_singleton()->_test_create_rendering_device_and_gl()) {\n+\t\tif (OS::get_singleton()->_test_create_rendering_device_and_gl(display_driver)) {\n \t\t\texit_err = ERR_HELP;\n \t\t} else {\n \t\t\texit_err = ERR_UNAVAILABLE;\n@@ -4115,6 +4115,7 @@ int Main::start() {\n \t\tif (editor) {\n \t\t\tOS::get_singleton()->benchmark_begin_measure(\"Startup\", \"Editor\");\n \n+\t\t\tsml->get_root()->set_translation_domain(\"godot.editor\");\n \t\t\tif (editor_pseudolocalization) {\n \t\t\t\ttranslation_server->get_editor_domain()->set_pseudolocalization_enabled(true);\n \t\t\t}\n@@ -4312,6 +4313,7 @@ int Main::start() {\n \t\t\tOS::get_singleton()->benchmark_begin_measure(\"Startup\", \"Project Manager\");\n \t\t\tEngine::get_singleton()->set_editor_hint(true);\n \n+\t\t\tsml->get_root()->set_translation_domain(\"godot.editor\");\n \t\t\tif (editor_pseudolocalization) {\n \t\t\t\ttranslation_server->get_editor_domain()->set_pseudolocalization_enabled(true);\n \t\t\t}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.cpp b/modules/jolt_physics/misc/jolt_math_funcs.cpp\nnew file mode 100644\nindex 000000000000..b0ef5f45747d\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.cpp\n@@ -0,0 +1,70 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.cpp                                                   */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+/*\n+Adapted to Godot from the Jolt Physics library.\n+*/\n+\n+/*\n+Copyright 2021 Jorrit Rouwe\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in\n+the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\n+the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR\n+A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n+ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n+*/\n+\n+#include \"jolt_math_funcs.h\"\n+\n+void JoltMath::decompose(Basis &p_basis, Vector3 &r_scale) {\n+\tVector3 x = p_basis.get_column(Vector3::AXIS_X);\n+\tVector3 y = p_basis.get_column(Vector3::AXIS_Y);\n+\tVector3 z = p_basis.get_column(Vector3::AXIS_Z);\n+\n+\tconst real_t x_dot_x = x.dot(x);\n+\ty -= x * (y.dot(x) / x_dot_x);\n+\tz -= x * (z.dot(x) / x_dot_x);\n+\tconst real_t y_dot_y = y.dot(y);\n+\tz -= y * (z.dot(y) / y_dot_y);\n+\tconst real_t z_dot_z = z.dot(z);\n+\n+\tconst real_t det = x.cross(y).dot(z);\n+\n+\tr_scale = SIGN(det) * Vector3(Math::sqrt(x_dot_x), Math::sqrt(y_dot_y), Math::sqrt(z_dot_z));\n+\n+\tp_basis.set_column(Vector3::AXIS_X, x / r_scale.x);\n+\tp_basis.set_column(Vector3::AXIS_Y, y / r_scale.y);\n+\tp_basis.set_column(Vector3::AXIS_Z, z / r_scale.z);\n+}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.h b/modules/jolt_physics/misc/jolt_math_funcs.h\nnew file mode 100644\nindex 000000000000..ba2d290ac77c\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.h\n@@ -0,0 +1,59 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.h                                                     */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef JOLT_MATH_FUNCS_H\n+#define JOLT_MATH_FUNCS_H\n+\n+#include \"core/math/transform_3d.h\"\n+\n+class JoltMath {\n+public:\n+\t// Note that `p_basis` is mutated to be right-handed orthonormal.\n+\tstatic void decompose(Basis &p_basis, Vector3 &r_scale);\n+\n+\t// Note that `p_transform` is mutated to be right-handed orthonormal.\n+\tstatic _FORCE_INLINE_ void decompose(Transform3D &p_transform, Vector3 &r_scale) {\n+\t\tdecompose(p_transform.basis, r_scale);\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Basis &p_basis, Basis &r_new_basis, Vector3 &r_scale) {\n+\t\tBasis new_basis = p_basis;\n+\t\tdecompose(new_basis, r_scale);\n+\t\tr_new_basis = new_basis;\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Transform3D &p_transform, Transform3D &r_new_transform, Vector3 &r_scale) {\n+\t\tTransform3D new_transform;\n+\t\tdecompose(new_transform, r_scale);\n+\t\tr_new_transform = new_transform;\n+\t}\n+};\n+\n+#endif // JOLT_MATH_FUNCS_H\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex b0a9ffd62225..0a2693ddb634 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -31,6 +31,7 @@\n #include \"jolt_area_3d.h\"\n \n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -370,7 +371,8 @@ void JoltArea3D::set_default_area(bool p_value) {\n void JoltArea3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to area '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -378,8 +380,6 @@ void JoltArea3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex ac2b37470ef1..5bc3aee1bce7 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../joints/jolt_joint_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -543,7 +544,8 @@ JoltBody3D::~JoltBody3D() {\n void JoltBody3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to physics body '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -551,8 +553,6 @@ void JoltBody3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex bfe77e008d59..f32ddad0d469 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_shaped_object_3d.h\"\n \n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_custom_double_sided_shape.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n@@ -347,7 +348,10 @@ void JoltShapedObject3D::commit_shapes(bool p_optimize_compound) {\n void JoltShapedObject3D::add_shape(JoltShape3D *p_shape, Transform3D p_transform, bool p_disabled) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed when adding shape at index %d to physics body '%s'.\", shapes.size(), to_string()));\n \n-\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform.orthonormalized(), p_transform.basis.get_scale(), p_disabled));\n+\tVector3 shape_scale;\n+\tJoltMath::decompose(p_transform, shape_scale);\n+\n+\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform, shape_scale, p_disabled));\n \n \t_shapes_changed();\n }\n@@ -430,8 +434,8 @@ void JoltShapedObject3D::set_shape_transform(int p_index, Transform3D p_transfor\n \tERR_FAIL_INDEX(p_index, (int)shapes.size());\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, \"Failed to correctly set transform for shape at index %d in body '%s'.\");\n \n-\tVector3 new_scale = p_transform.basis.get_scale();\n-\tp_transform.basis.orthonormalize();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \tJoltShapeInstance3D &shape = shapes[p_index];\n \ndiff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex 3852e42d51f2..d7a4afec57ba 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../objects/jolt_area_3d.h\"\n #include \"../objects/jolt_body_3d.h\"\n@@ -288,11 +289,10 @@ bool JoltPhysicsDirectSpaceState3D::_body_motion_cast(const JoltBody3D &p_body,\n \t\tconst Transform3D transform_com_local = transform_local.translated_local(com_scaled);\n \t\tTransform3D transform_com = body_transform * transform_com_local;\n \n-\t\tVector3 scale = transform_com.basis.get_scale();\n+\t\tVector3 scale;\n+\t\tJoltMath::decompose(transform_com, scale);\n \t\tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"body_test_motion was passed an invalid transform along with body '%s'. This results in invalid scaling for shape at index %d.\");\n \n-\t\ttransform_com.basis.orthonormalize();\n-\n \t\treal_t shape_safe_fraction = 1.0;\n \t\treal_t shape_unsafe_fraction = 1.0;\n \n@@ -590,11 +590,10 @@ int JoltPhysicsDirectSpaceState3D::intersect_shape(const ShapeParameters &p_para\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"intersect_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"intersect_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -647,11 +646,10 @@ bool JoltPhysicsDirectSpaceState3D::cast_motion(const ShapeParameters &p_paramet\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tTransform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -684,11 +682,10 @@ bool JoltPhysicsDirectSpaceState3D::collide_shape(const ShapeParameters &p_param\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"collide_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"collide_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -754,11 +751,10 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -890,8 +886,8 @@ bool JoltPhysicsDirectSpaceState3D::body_test_motion(const JoltBody3D &p_body, c\n \tTransform3D transform = p_parameters.from;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, vformat(\"body_test_motion (maybe from move_and_slide?) was passed an invalid transform along with body '%s'.\", p_body.to_string()));\n \n-\tVector3 scale = transform.basis.get_scale();\n-\ttransform.basis.orthonormalize();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \n \tspace->try_optimize();\n \ndiff --git a/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs b/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\nindex 7a07e0a97539..22420e2b63ca 100644\n--- a/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\n+++ b/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\n@@ -191,6 +191,13 @@ private static void EnsureTargetFrameworkMatchesMinimumRequirement(MSBuildProjec\n                 // Otherwise, it can be removed.\n                 if (mainTfmVersion > minTfmVersion)\n                 {\n+                    var propertyTfmVersion = NuGetFramework.Parse(property.Value).Version;\n+                    if (propertyTfmVersion == minTfmVersion)\n+                    {\n+                        // The 'TargetFramework' property already matches the minimum version.\n+                        continue;\n+                    }\n+\n                     property.Value = minTfmValue;\n                 }\n                 else\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\nindex dda776fee5f5..cb180f9a8b3f 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\n@@ -455,6 +455,12 @@ public readonly IntPtr Object\n             get => _data._m_obj_data.obj;\n         }\n \n+        public readonly ulong ObjectId\n+        {\n+            [MethodImpl(MethodImplOptions.AggressiveInlining)]\n+            get => _data._m_obj_data.id;\n+        }\n+\n         public void Dispose()\n         {\n             switch (Type)\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\nindex a48e60a30f60..9e5df0fa5c31 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\n@@ -485,7 +485,14 @@ public static Rid ConvertToRid(in godot_variant p_var)\n                 NativeFuncs.godotsharp_variant_as_rid(p_var);\n \n         public static IntPtr ConvertToGodotObjectPtr(in godot_variant p_var)\n-            => p_var.Type == Variant.Type.Object ? p_var.Object : IntPtr.Zero;\n+        {\n+            if (p_var.Type != Variant.Type.Object || p_var.ObjectId == 0)\n+            {\n+                return IntPtr.Zero;\n+            }\n+\n+            return NativeFuncs.godotsharp_instance_from_id(p_var.ObjectId);\n+        }\n \n         [MethodImpl(MethodImplOptions.AggressiveInlining)]\n         public static GodotObject ConvertToGodotObject(in godot_variant p_var)\ndiff --git a/modules/multiplayer/editor/editor_network_profiler.cpp b/modules/multiplayer/editor/editor_network_profiler.cpp\nindex 1f9444ed72b7..5a2611added9 100644\n--- a/modules/multiplayer/editor/editor_network_profiler.cpp\n+++ b/modules/multiplayer/editor/editor_network_profiler.cpp\n@@ -35,6 +35,7 @@\n #include \"editor/gui/editor_run_bar.h\"\n #include \"editor/themes/editor_scale.h\"\n #include \"scene/gui/check_box.h\"\n+#include \"scene/gui/flow_container.h\"\n \n void EditorNetworkProfiler::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"enable_profiling\", PropertyInfo(Variant::BOOL, \"enable\")));\n@@ -297,30 +298,37 @@ bool EditorNetworkProfiler::is_profiling() {\n }\n \n EditorNetworkProfiler::EditorNetworkProfiler() {\n-\tHBoxContainer *hb = memnew(HBoxContainer);\n-\thb->add_theme_constant_override(\"separation\", 8 * EDSCALE);\n-\tadd_child(hb);\n+\tFlowContainer *container = memnew(FlowContainer);\n+\tcontainer->add_theme_constant_override(SNAME(\"h_separation\"), 8 * EDSCALE);\n+\tcontainer->add_theme_constant_override(SNAME(\"v_separation\"), 2 * EDSCALE);\n+\tadd_child(container);\n \n \tactivate = memnew(Button);\n \tactivate->set_toggle_mode(true);\n \tactivate->set_text(TTR(\"Start\"));\n \tactivate->set_disabled(true);\n \tactivate->connect(SceneStringName(pressed), callable_mp(this, &EditorNetworkProfiler::_activate_pressed));\n-\thb->add_child(activate);\n+\tcontainer->add_child(activate);\n \n \tclear_button = memnew(Button);\n \tclear_button->set_text(TTR(\"Clear\"));\n \tclear_button->set_disabled(true);\n \tclear_button->connect(SceneStringName(pressed), callable_mp(this, &EditorNetworkProfiler::_clear_pressed));\n-\thb->add_child(clear_button);\n+\tcontainer->add_child(clear_button);\n \n \tCheckBox *autostart_checkbox = memnew(CheckBox);\n \tautostart_checkbox->set_text(TTR(\"Autostart\"));\n \tautostart_checkbox->set_pressed(EditorSettings::get_singleton()->get_project_metadata(\"debug_options\", \"autostart_network_profiler\", false));\n \tautostart_checkbox->connect(SceneStringName(toggled), callable_mp(this, &EditorNetworkProfiler::_autostart_toggled));\n-\thb->add_child(autostart_checkbox);\n+\tcontainer->add_child(autostart_checkbox);\n+\n+\tControl *c = memnew(Control);\n+\tc->set_h_size_flags(SIZE_EXPAND_FILL);\n+\tcontainer->add_child(c);\n \n-\thb->add_spacer();\n+\tHBoxContainer *hb = memnew(HBoxContainer);\n+\thb->add_theme_constant_override(SNAME(\"separation\"), 8 * EDSCALE);\n+\tcontainer->add_child(hb);\n \n \tLabel *lb = memnew(Label);\n \t// TRANSLATORS: This is the label for the network profiler's incoming bandwidth.\n@@ -359,7 +367,7 @@ EditorNetworkProfiler::EditorNetworkProfiler() {\n \n \t// RPC\n \tcounters_display = memnew(Tree);\n-\tcounters_display->set_custom_minimum_size(Size2(320, 0) * EDSCALE);\n+\tcounters_display->set_custom_minimum_size(Size2(280, 0) * EDSCALE);\n \tcounters_display->set_v_size_flags(SIZE_EXPAND_FILL);\n \tcounters_display->set_h_size_flags(SIZE_EXPAND_FILL);\n \tcounters_display->set_hide_folding(true);\n@@ -382,7 +390,7 @@ EditorNetworkProfiler::EditorNetworkProfiler() {\n \n \t// Replication\n \treplication_display = memnew(Tree);\n-\treplication_display->set_custom_minimum_size(Size2(320, 0) * EDSCALE);\n+\treplication_display->set_custom_minimum_size(Size2(280, 0) * EDSCALE);\n \treplication_display->set_v_size_flags(SIZE_EXPAND_FILL);\n \treplication_display->set_h_size_flags(SIZE_EXPAND_FILL);\n \treplication_display->set_hide_folding(true);\ndiff --git a/modules/openxr/extensions/platform/openxr_opengl_extension.cpp b/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\nindex c4a05220115b..08b3afb0192e 100644\n--- a/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\n+++ b/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\n@@ -141,7 +141,12 @@ XrGraphicsBindingEGLMNDX OpenXROpenGLExtension::graphics_binding_egl;\n #endif\n \n void *OpenXROpenGLExtension::set_session_create_and_get_next_pointer(void *p_next_pointer) {\n-\tXrVersion desired_version = XR_MAKE_VERSION(3, 3, 0);\n+\tGLint gl_version_major = 0;\n+\tGLint gl_version_minor = 0;\n+\tglGetIntegerv(GL_MAJOR_VERSION, &gl_version_major);\n+\tglGetIntegerv(GL_MINOR_VERSION, &gl_version_minor);\n+\n+\tXrVersion desired_version = XR_MAKE_VERSION(gl_version_major, gl_version_minor, 0);\n \n \tif (!check_graphics_api_support(desired_version)) {\n \t\tprint_line(\"OpenXR: Trying to initialize with OpenGL anyway...\");\ndiff --git a/modules/openxr/register_types.cpp b/modules/openxr/register_types.cpp\nindex 69c119d069e3..785de3d6210b 100644\n--- a/modules/openxr/register_types.cpp\n+++ b/modules/openxr/register_types.cpp\n@@ -225,10 +225,16 @@ void initialize_openxr_module(ModuleInitializationLevel p_level) {\n \t\t}\n \n #ifdef TOOLS_ENABLED\n+\t\t// Register as \"editor\", not \"core\".\n+\t\tClassDB::APIType prev_api = ClassDB::get_current_api();\n+\t\tClassDB::set_current_api(ClassDB::API_EDITOR);\n+\n \t\tGDREGISTER_ABSTRACT_CLASS(OpenXRInteractionProfileEditorBase);\n \t\tGDREGISTER_CLASS(OpenXRInteractionProfileEditor);\n \t\tGDREGISTER_CLASS(OpenXRBindingModifierEditor);\n \n+\t\tClassDB::set_current_api(prev_api);\n+\n \t\tEditorNode::add_init_callback(_editor_init);\n #endif\n \t}\ndiff --git a/modules/text_server_adv/text_server_adv.cpp b/modules/text_server_adv/text_server_adv.cpp\nindex 52a61cd92446..71bded1ff1d5 100644\n--- a/modules/text_server_adv/text_server_adv.cpp\n+++ b/modules/text_server_adv/text_server_adv.cpp\n@@ -1318,11 +1318,12 @@ _FORCE_INLINE_ bool TextServerAdvanced::_ensure_glyph(FontAdvanced *p_font_data,\n \t\t\t} break;\n \t\t}\n \n+\t\tFT_GlyphSlot slot = fd->face->glyph;\n+\t\tbool from_svg = (slot->format == FT_GLYPH_FORMAT_SVG); // Need to check before FT_Render_Glyph as it will change format to bitmap.\n \t\tif (!outline) {\n \t\t\tif (!p_font_data->msdf) {\n-\t\t\t\terror = FT_Render_Glyph(fd->face->glyph, aa_mode);\n+\t\t\t\terror = FT_Render_Glyph(slot, aa_mode);\n \t\t\t}\n-\t\t\tFT_GlyphSlot slot = fd->face->glyph;\n \t\t\tif (!error) {\n \t\t\t\tif (p_font_data->msdf) {\n #ifdef MODULE_MSDFGEN_ENABLED\n@@ -1363,6 +1364,7 @@ _FORCE_INLINE_ bool TextServerAdvanced::_ensure_glyph(FontAdvanced *p_font_data,\n \t\tcleanup_stroker:\n \t\t\tFT_Stroker_Done(stroker);\n \t\t}\n+\t\tgl.from_svg = from_svg;\n \t\tE = fd->glyph_map.insert(p_glyph, gl);\n \t\tr_glyph = E->value;\n \t\treturn gl.found;\n@@ -3312,6 +3314,10 @@ RID TextServerAdvanced::_font_get_glyph_texture_rid(const RID &p_font_rid, const\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -3360,6 +3366,10 @@ Size2 TextServerAdvanced::_font_get_glyph_texture_size(const RID &p_font_rid, co\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -3798,7 +3808,7 @@ void TextServerAdvanced::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\tif (fgl.texture_idx != -1) {\n \t\t\tColor modulate = p_color;\n #ifdef MODULE_FREETYPE_ENABLED\n-\t\t\tif (ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n+\t\t\tif (!fgl.from_svg && ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n \t\t\t\tmodulate.r = modulate.g = modulate.b = 1.0;\n \t\t\t}\n #endif\n@@ -3806,6 +3816,10 @@ void TextServerAdvanced::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t\t}\n \t\t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\t\timg->generate_mipmaps();\ndiff --git a/modules/text_server_adv/text_server_adv.h b/modules/text_server_adv/text_server_adv.h\nindex 6561667e80e6..981cb277f70d 100644\n--- a/modules/text_server_adv/text_server_adv.h\n+++ b/modules/text_server_adv/text_server_adv.h\n@@ -272,6 +272,7 @@ class TextServerAdvanced : public TextServerExtension {\n \t\tRect2 rect;\n \t\tRect2 uv_rect;\n \t\tVector2 advance;\n+\t\tbool from_svg = false;\n \t};\n \n \tstruct FontForSizeAdvanced {\ndiff --git a/modules/text_server_fb/text_server_fb.cpp b/modules/text_server_fb/text_server_fb.cpp\nindex 8ca81368436f..c70f5e00d113 100644\n--- a/modules/text_server_fb/text_server_fb.cpp\n+++ b/modules/text_server_fb/text_server_fb.cpp\n@@ -741,11 +741,12 @@ _FORCE_INLINE_ bool TextServerFallback::_ensure_glyph(FontFallback *p_font_data,\n \t\t\t} break;\n \t\t}\n \n+\t\tFT_GlyphSlot slot = fd->face->glyph;\n+\t\tbool from_svg = (slot->format == FT_GLYPH_FORMAT_SVG); // Need to check before FT_Render_Glyph as it will change format to bitmap.\n \t\tif (!outline) {\n \t\t\tif (!p_font_data->msdf) {\n-\t\t\t\terror = FT_Render_Glyph(fd->face->glyph, aa_mode);\n+\t\t\t\terror = FT_Render_Glyph(slot, aa_mode);\n \t\t\t}\n-\t\t\tFT_GlyphSlot slot = fd->face->glyph;\n \t\t\tif (!error) {\n \t\t\t\tif (p_font_data->msdf) {\n #ifdef MODULE_MSDFGEN_ENABLED\n@@ -786,6 +787,7 @@ _FORCE_INLINE_ bool TextServerFallback::_ensure_glyph(FontFallback *p_font_data,\n \t\tcleanup_stroker:\n \t\t\tFT_Stroker_Done(stroker);\n \t\t}\n+\t\tgl.from_svg = from_svg;\n \t\tE = fd->glyph_map.insert(p_glyph, gl);\n \t\tr_glyph = E->value;\n \t\treturn gl.found;\n@@ -2290,6 +2292,10 @@ RID TextServerFallback::_font_get_glyph_texture_rid(const RID &p_font_rid, const\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -2338,6 +2344,10 @@ Size2 TextServerFallback::_font_get_glyph_texture_size(const RID &p_font_rid, co\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -2729,7 +2739,7 @@ void TextServerFallback::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\tif (fgl.texture_idx != -1) {\n \t\t\tColor modulate = p_color;\n #ifdef MODULE_FREETYPE_ENABLED\n-\t\t\tif (ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n+\t\t\tif (!fgl.from_svg && ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n \t\t\t\tmodulate.r = modulate.g = modulate.b = 1.0;\n \t\t\t}\n #endif\n@@ -2737,6 +2747,10 @@ void TextServerFallback::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t\t}\n \t\t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\t\timg->generate_mipmaps();\ndiff --git a/modules/text_server_fb/text_server_fb.h b/modules/text_server_fb/text_server_fb.h\nindex b66f7189bee0..3338a8a62b1b 100644\n--- a/modules/text_server_fb/text_server_fb.h\n+++ b/modules/text_server_fb/text_server_fb.h\n@@ -219,6 +219,7 @@ class TextServerFallback : public TextServerExtension {\n \t\tRect2 rect;\n \t\tRect2 uv_rect;\n \t\tVector2 advance;\n+\t\tbool from_svg = false;\n \t};\n \n \tstruct FontForSizeFallback {\ndiff --git a/platform/android/README.md b/platform/android/README.md\nindex 01eb9c03a664..4a08bb524180 100644\n--- a/platform/android/README.md\n+++ b/platform/android/README.md\n@@ -12,7 +12,7 @@ using [Gradle](https://gradle.org/) as a build system.\n \n ## Artwork license\n \n-[`logo.png`](logo.png) and [`run_icon.png`](run_icon.png) are licensed under\n+[`logo.svg`](export/logo.svg) and [`run_icon.svg`](export/run_icon.svg) are licensed under\n [Creative Commons Attribution 3.0 Unported](https://developer.android.com/distribute/marketing-tools/brand-guidelines#android_robot)\n per the Android logo usage guidelines:\n \ndiff --git a/platform/android/android_input_handler.cpp b/platform/android/android_input_handler.cpp\nindex 9a5af7a349dd..859f4c3c1b3e 100644\n--- a/platform/android/android_input_handler.cpp\n+++ b/platform/android/android_input_handler.cpp\n@@ -337,7 +337,7 @@ void AndroidInputHandler::process_mouse_event(int p_event_action, int p_event_an\n \t\t} break;\n \n \t\tcase AMOTION_EVENT_ACTION_MOVE: {\n-\t\t\tif (!mouse_event_info.valid) {\n+\t\t\tif (!p_source_mouse_relative && !mouse_event_info.valid) {\n \t\t\t\treturn;\n \t\t\t}\n \ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 571cfd9819c0..cac7c3f48d4e 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -187,7 +187,7 @@ def configure(env: \"SConsEnvironment\"):\n     has_swappy = detect_swappy()\n     if not has_swappy:\n         print_warning(\n-            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/darksylinc/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n+            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/godotengine/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n             + \" thirdparty/swappy-frame-pacing/arm64-v8a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/armeabi-v7a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/x86/libswappy_static.a\\n\"\ndiff --git a/platform/android/java/app/AndroidManifest.xml b/platform/android/java/app/AndroidManifest.xml\nindex 60ce75fd16e2..1d59d15d560f 100644\n--- a/platform/android/java/app/AndroidManifest.xml\n+++ b/platform/android/java/app/AndroidManifest.xml\n@@ -46,7 +46,7 @@\n             android:excludeFromRecents=\"false\"\n             android:exported=\"true\"\n             android:screenOrientation=\"landscape\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:resizeableActivity=\"false\"\n             tools:ignore=\"UnusedAttribute\" >\n \ndiff --git a/platform/android/java/editor/src/main/AndroidManifest.xml b/platform/android/java/editor/src/main/AndroidManifest.xml\nindex a1971554bf7d..b136e348b2c7 100644\n--- a/platform/android/java/editor/src/main/AndroidManifest.xml\n+++ b/platform/android/java/editor/src/main/AndroidManifest.xml\n@@ -41,7 +41,7 @@\n \n         <activity\n             android:name=\".GodotEditor\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"true\"\n             android:icon=\"@mipmap/themed_icon\"\n             android:launchMode=\"singleTask\"\n@@ -59,7 +59,7 @@\n         </activity>\n         <activity\n             android:name=\".GodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -74,7 +74,7 @@\n         </activity>\n         <activity\n             android:name=\".embed.EmbeddedGodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -87,7 +87,7 @@\n             android:screenOrientation=\"userLandscape\" />\n         <activity\n             android:name=\".GodotXRGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:process=\":GodotXRGame\"\n             android:launchMode=\"singleTask\"\n             android:icon=\"@mipmap/ic_play_window\"\ndiff --git a/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java b/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\nindex 6f036c15a32a..d9d1cedc6a0f 100644\n--- a/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\n+++ b/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\n@@ -59,6 +59,7 @@\n import java.util.Collections;\n import java.util.HashSet;\n import java.util.Set;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /**\n  * Handles input related events for the {@link GodotRenderView} view.\n@@ -83,7 +84,7 @@ public class GodotInputHandler implements InputManager.InputDeviceListener, Sens\n \t/**\n \t * Used to decide whether mouse capture can be enabled.\n \t */\n-\tprivate int lastSeenToolType = MotionEvent.TOOL_TYPE_UNKNOWN;\n+\tprivate AtomicInteger lastSeenToolType = new AtomicInteger(MotionEvent.TOOL_TYPE_UNKNOWN);\n \n \tprivate int rotaryInputAxis = ROTARY_INPUT_VERTICAL_AXIS;\n \n@@ -149,7 +150,8 @@ private boolean isKeyEventGameDevice(int source) {\n \t}\n \n \tpublic boolean canCapturePointer() {\n-\t\treturn lastSeenToolType == MotionEvent.TOOL_TYPE_MOUSE;\n+\t\treturn lastSeenToolType.get() == MotionEvent.TOOL_TYPE_MOUSE ||\n+\t\t\t\tlastSeenToolType.get() == MotionEvent.TOOL_TYPE_UNKNOWN;\n \t}\n \n \tpublic void onPointerCaptureChange(boolean hasCapture) {\n@@ -210,7 +212,7 @@ public boolean onKeyDown(final int keyCode, KeyEvent event) {\n \t}\n \n \tpublic boolean onTouchEvent(final MotionEvent event) {\n-\t\tlastSeenToolType = getEventToolType(event);\n+\t\tlastSeenToolType.set(getEventToolType(event));\n \n \t\tthis.scaleGestureDetector.onTouchEvent(event);\n \t\tif (this.gestureDetector.onTouchEvent(event)) {\n@@ -236,7 +238,7 @@ public boolean onTouchEvent(final MotionEvent event) {\n \t}\n \n \tpublic boolean onGenericMotionEvent(MotionEvent event) {\n-\t\tlastSeenToolType = getEventToolType(event);\n+\t\tlastSeenToolType.set(getEventToolType(event));\n \n \t\tif (event.isFromSource(InputDevice.SOURCE_JOYSTICK) && event.getActionMasked() == MotionEvent.ACTION_MOVE) {\n \t\t\t// Check if the device exists\ndiff --git a/platform/android/java_class_wrapper.cpp b/platform/android/java_class_wrapper.cpp\nindex c19196ae8713..4980258d9898 100644\n--- a/platform/android/java_class_wrapper.cpp\n+++ b/platform/android/java_class_wrapper.cpp\n@@ -108,18 +108,21 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\t\t}\n \t\t\t\t} break;\n \t\t\t\tcase ARG_TYPE_CLASS: {\n-\t\t\t\t\tif (p_args[i]->get_type() != Variant::OBJECT && p_args[i]->get_type() != Variant::NIL) {\n+\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n+\t\t\t\t\tif (cn.begins_with(\"L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\t\tcn = cn.substr(1, cn.length() - 2);\n+\t\t\t\t\t}\n+\t\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\") {\n+\t\t\t\t\t\tif (p_args[i]->get_type() != Variant::DICTIONARY) {\n+\t\t\t\t\t\t\targ_expected = Variant::DICTIONARY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::OBJECT && p_args[i]->get_type() != Variant::NIL) {\n \t\t\t\t\t\targ_expected = Variant::OBJECT;\n \t\t\t\t\t} else {\n \t\t\t\t\t\tRef<RefCounted> ref = *p_args[i];\n \t\t\t\t\t\tif (ref.is_valid()) {\n \t\t\t\t\t\t\tif (Object::cast_to<JavaObject>(ref.ptr())) {\n \t\t\t\t\t\t\t\tRef<JavaObject> jo = ref;\n-\t\t\t\t\t\t\t\t//could be faster\n-\t\t\t\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n-\t\t\t\t\t\t\t\tif (cn.begins_with(\"L\") && cn.ends_with(\";\")) {\n-\t\t\t\t\t\t\t\t\tcn = cn.substr(1, cn.length() - 2);\n-\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n \t\t\t\t\t\t\t\tif (!c || !env->IsInstanceOf(jo->instance, c)) {\n \t\t\t\t\t\t\t\t\targ_expected = Variant::OBJECT;\n@@ -132,6 +135,116 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BOOLEAN: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::BOOL) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n+\t\t\t\t\tif (p_args[i]->get_type() != Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::PACKED_BYTE_ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::INT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::INT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_INT64_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::FLOAT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_FLOAT32_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::FLOAT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_FLOAT64_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::STRING) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_STRING_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CALLABLE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::CALLABLE) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::OBJECT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n+\t\t\t\t\t\t\tif (cn.begins_with(\"[L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\t\t\t\tcn = cn.substr(2, cn.length() - 3);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n+\t\t\t\t\t\t\tif (c) {\n+\t\t\t\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\t\t\t\tRef<JavaObject> jo = arr[j];\n+\t\t\t\t\t\t\t\t\tif (jo.is_valid()) {\n+\t\t\t\t\t\t\t\t\t\tif (!env->IsInstanceOf(jo->instance, c)) {\n+\t\t\t\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n \t\t\t\tdefault: {\n \t\t\t\t\tif (p_args[i]->get_type() != Variant::ARRAY) {\n \t\t\t\t\t\targ_expected = Variant::ARRAY;\n@@ -287,13 +400,16 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\tto_free.push_back(jcallable);\n \t\t\t} break;\n \t\t\tcase ARG_TYPE_CLASS: {\n-\t\t\t\tRef<JavaObject> jo = *p_args[i];\n-\t\t\t\tif (jo.is_valid()) {\n-\t\t\t\t\targv[i].l = jo->instance;\n+\t\t\t\tif (p_args[i]->get_type() == Variant::DICTIONARY) {\n+\t\t\t\t\targv[i].l = _variant_to_jvalue(env, Variant::DICTIONARY, p_args[i]).obj;\n \t\t\t\t} else {\n-\t\t\t\t\targv[i].l = nullptr; //I hope this works\n+\t\t\t\t\tRef<JavaObject> jo = *p_args[i];\n+\t\t\t\t\tif (jo.is_valid()) {\n+\t\t\t\t\t\targv[i].l = jo->instance;\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targv[i].l = nullptr; //I hope this works\n+\t\t\t\t\t}\n \t\t\t\t}\n-\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BOOLEAN: {\n \t\t\t\tArray arr = *p_args[i];\n@@ -307,90 +423,171 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjbyteArray a = env->NewByteArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjbyte val = arr[j];\n-\t\t\t\t\tenv->SetByteArrayRegion(a, j, 1, &val);\n+\t\t\t\tjbyteArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewByteArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjbyte val = arr[j];\n+\t\t\t\t\t\tenv->SetByteArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\tPackedByteArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewByteArray(arr.size());\n+\t\t\t\t\tenv->SetByteArrayRegion(a, 0, arr.size(), (const jbyte *)arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjcharArray a = env->NewCharArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjchar val = arr[j];\n-\t\t\t\t\tenv->SetCharArrayRegion(a, j, 1, &val);\n+\t\t\t\tjcharArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewCharArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjchar val = arr[j];\n+\t\t\t\t\t\tenv->SetCharArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\tPackedByteArray arr = *p_args[i];\n+\t\t\t\t\t// The data is expected to be UTF-16 encoded, so the length is half the size of the byte array.\n+\t\t\t\t\tint size = arr.size() / 2;\n+\t\t\t\t\ta = env->NewCharArray(size);\n+\t\t\t\t\tenv->SetCharArrayRegion(a, 0, size, (const jchar *)arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjshortArray a = env->NewShortArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjshort val = arr[j];\n-\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\tjshortArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewShortArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjshort val = arr[j];\n+\t\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\tPackedInt32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewShortArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjshort val = arr[j];\n+\t\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjintArray a = env->NewIntArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjint val = arr[j];\n-\t\t\t\t\tenv->SetIntArrayRegion(a, j, 1, &val);\n+\t\t\t\tjintArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewIntArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjint val = arr[j];\n+\t\t\t\t\t\tenv->SetIntArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\tPackedInt32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewIntArray(arr.size());\n+\t\t\t\t\tenv->SetIntArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjlongArray a = env->NewLongArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjlong val = (int64_t)arr[j];\n-\t\t\t\t\tenv->SetLongArrayRegion(a, j, 1, &val);\n+\t\t\t\tjlongArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewLongArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjlong val = (int64_t)arr[j];\n+\t\t\t\t\t\tenv->SetLongArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT64_ARRAY) {\n+\t\t\t\t\tPackedInt64Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewLongArray(arr.size());\n+\t\t\t\t\tenv->SetLongArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjfloatArray a = env->NewFloatArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjfloat val = arr[j];\n-\t\t\t\t\tenv->SetFloatArrayRegion(a, j, 1, &val);\n+\t\t\t\tjfloatArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewFloatArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjfloat val = arr[j];\n+\t\t\t\t\t\tenv->SetFloatArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_FLOAT32_ARRAY) {\n+\t\t\t\t\tPackedFloat32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewFloatArray(arr.size());\n+\t\t\t\t\tenv->SetFloatArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjdoubleArray a = env->NewDoubleArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjdouble val = arr[j];\n-\t\t\t\t\tenv->SetDoubleArrayRegion(a, j, 1, &val);\n+\t\t\t\tjdoubleArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewDoubleArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjdouble val = arr[j];\n+\t\t\t\t\t\tenv->SetDoubleArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_FLOAT64_ARRAY) {\n+\t\t\t\t\tPackedFloat64Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewDoubleArray(arr.size());\n+\t\t\t\t\tenv->SetDoubleArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING:\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjobjectArray a = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tString s = arr[j];\n-\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n-\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n-\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\tjobjectArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tString s = arr[j];\n+\t\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n+\t\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n+\t\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_STRING_ARRAY) {\n+\t\t\t\t\tPackedStringArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tString s = arr[j];\n+\t\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n+\t\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n+\t\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\targv[i].l = a;\n@@ -410,7 +607,22 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\tto_free.push_back(jarr);\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n-\t\t\t\targv[i].l = nullptr;\n+\t\t\t\tString cn = method->param_sigs[i].operator String();\n+\t\t\t\tif (cn.begins_with(\"[L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\tcn = cn.substr(2, cn.length() - 3);\n+\t\t\t\t}\n+\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n+\t\t\t\tif (c) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\tjobjectArray jarr = env->NewObjectArray(arr.size(), c, nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tRef<JavaObject> jo = arr[j];\n+\t\t\t\t\t\tenv->SetObjectArrayElement(jarr, j, jo->instance);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\targv[i].l = jarr;\n+\t\t\t\t\tto_free.push_back(jarr);\n+\t\t\t\t}\n \t\t\t} break;\n \t\t}\n \t}\n@@ -865,8 +1077,13 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tenv->DeleteLocalRef(java_class);\n \n \t\t\tif (java_class_wrapped.is_valid()) {\n-\t\t\t\tRef<JavaObject> ret = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n-\t\t\t\tvar = ret;\n+\t\t\t\tString cn = java_class_wrapped->get_java_class_name();\n+\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\" || cn == \"java.util.HashMap\") {\n+\t\t\t\t\tvar = _jobject_to_variant(env, obj);\n+\t\t\t\t} else {\n+\t\t\t\t\tRef<JavaObject> ret = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n+\t\t\t\t\tvar = ret;\n+\t\t\t\t}\n \t\t\t\treturn true;\n \t\t\t}\n \n@@ -881,11 +1098,12 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjboolean val;\n-\t\t\t\tenv->GetBooleanArrayRegion((jbooleanArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n+\t\t\t\tenv->GetBooleanArrayRegion((jbooleanArray)arr, i, 1, &val);\n+\t\t\t\tret[i] = (bool)val;\n \t\t\t}\n \n \t\t\tvar = ret;\n@@ -893,106 +1111,85 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjbyte val;\n-\t\t\t\tenv->GetByteArrayRegion((jbyteArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetByteArrayRegion((jbyteArray)arr, 0, count, (int8_t *)ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjchar val;\n-\t\t\t\tenv->GetCharArrayRegion((jcharArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\t// Char arrays are UTF-16 encoded, so it's double the length.\n+\t\t\tret.resize(count * 2);\n+\t\t\tenv->GetCharArrayRegion((jcharArray)arr, 0, count, (jchar *)ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjshort val;\n-\t\t\t\tenv->GetShortArrayRegion((jshortArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n+\t\t\t\tenv->GetShortArrayRegion((jshortArray)arr, i, 1, &val);\n+\t\t\t\tptr[i] = val;\n \t\t\t}\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjint val;\n-\t\t\t\tenv->GetIntArrayRegion((jintArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetIntArrayRegion((jintArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjlong val;\n-\t\t\t\tenv->GetLongArrayRegion((jlongArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back((int64_t)val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetLongArrayRegion((jlongArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjfloat val;\n-\t\t\t\tenv->GetFloatArrayRegion((jfloatArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetFloatArrayRegion((jfloatArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjdouble val;\n-\t\t\t\tenv->GetDoubleArrayRegion((jdoubleArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetDoubleArrayRegion((jdoubleArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n@@ -1002,14 +1199,13 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tbool val = env->CallBooleanMethod(o, JavaClassWrapper::singleton->Boolean_booleanValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tret[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1019,18 +1215,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tuint8_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallByteMethod(o, JavaClassWrapper::singleton->Byte_byteValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = (uint8_t)val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1039,18 +1237,22 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\t// Char arrays are UTF-16 encoded, so it's double the length.\n+\t\t\tret.resize(count * 2);\n \n+\t\t\tjchar *ptr = (jchar *)ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tcount = i;\n+\t\t\t\t\tbreak;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallCharMethod(o, JavaClassWrapper::singleton->Character_characterValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = (jchar)val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1059,18 +1261,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallShortMethod(o, JavaClassWrapper::singleton->Short_shortValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1079,18 +1283,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallIntMethod(o, JavaClassWrapper::singleton->Integer_integerValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1099,18 +1305,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint64_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint64_t val = env->CallLongMethod(o, JavaClassWrapper::singleton->Long_longValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1119,18 +1327,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tfloat *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0.0;\n \t\t\t\t} else {\n \t\t\t\t\tfloat val = env->CallFloatMethod(o, JavaClassWrapper::singleton->Float_floatValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1139,18 +1349,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tdouble *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0.0;\n \t\t\t\t} else {\n \t\t\t\t\tdouble val = env->CallDoubleMethod(o, JavaClassWrapper::singleton->Double_doubleValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1160,18 +1372,18 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t} break;\n \n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING: {\n-\t\t\tArray ret;\n+\t\t\tPackedStringArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tString *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tString val = jstring_to_string((jstring)o, env);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1180,18 +1392,18 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n-\t\t\tArray ret;\n+\t\t\tPackedStringArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tString *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tString val = charsequence_to_string(env, o);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1203,13 +1415,12 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tArray ret;\n \t\t\tjobjectArray jarr = (jobjectArray)obj;\n \t\t\tint count = env->GetArrayLength(jarr);\n+\t\t\tret.resize(count);\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(jarr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tCallable callable = jcallable_to_callable(env, o);\n-\t\t\t\t\tret.push_back(callable);\n+\t\t\t\t\tret[i] = callable;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1218,6 +1429,32 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n+\t\t\tArray ret;\n+\t\t\tjobjectArray jarr = (jobjectArray)obj;\n+\t\t\tint count = env->GetArrayLength(jarr);\n+\t\t\tret.resize(count);\n+\t\t\tfor (int i = 0; i < count; i++) {\n+\t\t\t\tjobject obj = env->GetObjectArrayElement(jarr, i);\n+\t\t\t\tif (obj) {\n+\t\t\t\t\tjclass java_class = env->GetObjectClass(obj);\n+\t\t\t\t\tRef<JavaClass> java_class_wrapped = JavaClassWrapper::singleton->wrap_jclass(java_class);\n+\t\t\t\t\tenv->DeleteLocalRef(java_class);\n+\n+\t\t\t\t\tif (java_class_wrapped.is_valid()) {\n+\t\t\t\t\t\tString cn = java_class_wrapped->get_java_class_name();\n+\t\t\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\" || cn == \"java.util.HashMap\") {\n+\t\t\t\t\t\t\tret[i] = _jobject_to_variant(env, obj);\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tRef<JavaObject> java_obj_wrapped = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n+\t\t\t\t\t\t\tret[i] = java_obj_wrapped;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tenv->DeleteLocalRef(obj);\n+\t\t\t}\n+\n+\t\t\tvar = ret;\n+\t\t\treturn true;\n \t\t} break;\n \t}\n \ndiff --git a/platform/android/java_godot_lib_jni.cpp b/platform/android/java_godot_lib_jni.cpp\nindex 054c809c6e3f..0bb78bb9d974 100644\n--- a/platform/android/java_godot_lib_jni.cpp\n+++ b/platform/android/java_godot_lib_jni.cpp\n@@ -49,6 +49,7 @@\n #include \"core/config/project_settings.h\"\n #include \"core/input/input.h\"\n #include \"main/main.h\"\n+#include \"servers/rendering_server.h\"\n \n #ifndef _3D_DISABLED\n #include \"servers/xr_server.h\"\ndiff --git a/platform/ios/export/export_plugin.cpp b/platform/ios/export/export_plugin.cpp\nindex 84bf722d14f4..7ca7dc1ac675 100644\n--- a/platform/ios/export/export_plugin.cpp\n+++ b/platform/ios/export/export_plugin.cpp\n@@ -2735,6 +2735,42 @@ void EditorExportPlatformIOS::_check_for_changes_poll_thread(void *ud) {\n \t\t\t}\n \t\t}\n \n+\t\t// Enum devices (via Xcode).\n+\t\tif (ea->has_runnable_preset.is_set() && _check_xcode_install() && (FileAccess::exists(\"/usr/bin/xcrun\") || FileAccess::exists(\"/bin/xcrun\"))) {\n+\t\t\tString devices;\n+\t\t\tList<String> args;\n+\t\t\targs.push_back(\"devicectl\");\n+\t\t\targs.push_back(\"list\");\n+\t\t\targs.push_back(\"devices\");\n+\t\t\targs.push_back(\"-j\");\n+\t\t\targs.push_back(\"-\");\n+\t\t\targs.push_back(\"-q\");\n+\t\t\tint ec = 0;\n+\t\t\tError err = OS::get_singleton()->execute(\"xcrun\", args, &devices, &ec, true);\n+\t\t\tif (err == OK && ec == 0) {\n+\t\t\t\tRef<JSON> json;\n+\t\t\t\tjson.instantiate();\n+\t\t\t\terr = json->parse(devices);\n+\t\t\t\tif (err == OK) {\n+\t\t\t\t\tconst Dictionary &data = json->get_data();\n+\t\t\t\t\tconst Dictionary &result = data[\"result\"];\n+\t\t\t\t\tconst Array &devices = result[\"devices\"];\n+\t\t\t\t\tfor (int i = 0; i < devices.size(); i++) {\n+\t\t\t\t\t\tconst Dictionary &device_info = devices[i];\n+\t\t\t\t\t\tconst Dictionary &conn_props = device_info[\"connectionProperties\"];\n+\t\t\t\t\t\tconst Dictionary &dev_props = device_info[\"deviceProperties\"];\n+\t\t\t\t\t\tif (conn_props[\"pairingState\"] == \"paired\" && dev_props[\"developerModeStatus\"] == \"enabled\") {\n+\t\t\t\t\t\t\tDevice nd;\n+\t\t\t\t\t\t\tnd.id = device_info[\"identifier\"];\n+\t\t\t\t\t\t\tnd.name = dev_props[\"name\"].operator String() + \" (devicectl, \" + ((conn_props[\"transportType\"] == \"localNetwork\") ? \"network\" : \"wired\") + \")\";\n+\t\t\t\t\t\t\tnd.wifi = conn_props[\"transportType\"] == \"localNetwork\";\n+\t\t\t\t\t\t\tldevices.push_back(nd);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n \t\t// Update device list.\n \t\t{\n \t\t\tMutexLock lock(ea->device_lock);\n@@ -2922,7 +2958,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\t}\n \t\t}\n \t} else {\n-\t\t// Deploy and run on real device.\n+\t\t// Deploy and run on real device (via Xcode).\n \t\tif (ep.step(\"Installing to device...\", 3)) {\n \t\t\tCLEANUP_AND_RETURN(ERR_SKIP);\n \t\t} else {\ndiff --git a/platform/linuxbsd/README.md b/platform/linuxbsd/README.md\nindex c4f287cc6c8c..e1a95324ad50 100644\n--- a/platform/linuxbsd/README.md\n+++ b/platform/linuxbsd/README.md\n@@ -14,7 +14,7 @@ used by this platform.\n \n ## Artwork license\n \n-[`logo.png`](logo.png) is derived from the [Linux logo](https://isc.tamu.edu/~lewing/linux/):\n+[`logo.svg`](export/logo.svg) is derived from the [Linux logo](https://isc.tamu.edu/~lewing/linux/):\n \n > Permission to use and/or modify this image is granted provided you acknowledge me\n > <lewing@isc.tamu.edu> and [The GIMP](https://isc.tamu.edu/~lewing/gimp/)\ndiff --git a/platform/linuxbsd/os_linuxbsd.cpp b/platform/linuxbsd/os_linuxbsd.cpp\nindex 9fba97d552a0..466841d747f9 100644\n--- a/platform/linuxbsd/os_linuxbsd.cpp\n+++ b/platform/linuxbsd/os_linuxbsd.cpp\n@@ -37,10 +37,12 @@\n #include \"servers/rendering_server.h\"\n \n #ifdef X11_ENABLED\n+#include \"x11/detect_prime_x11.h\"\n #include \"x11/display_server_x11.h\"\n #endif\n \n #ifdef WAYLAND_ENABLED\n+#include \"wayland/detect_prime_egl.h\"\n #include \"wayland/display_server_wayland.h\"\n #endif\n \n@@ -49,6 +51,22 @@\n #include \"modules/regex/regex.h\"\n #endif\n \n+#if defined(RD_ENABLED)\n+#include \"servers/rendering/rendering_device.h\"\n+#endif\n+\n+#if defined(VULKAN_ENABLED)\n+#ifdef X11_ENABLED\n+#include \"x11/rendering_context_driver_vulkan_x11.h\"\n+#endif\n+#ifdef WAYLAND_ENABLED\n+#include \"wayland/rendering_context_driver_vulkan_wayland.h\"\n+#endif\n+#endif\n+#if defined(GLES3_ENABLED)\n+#include \"drivers/gles3/rasterizer_gles3.h\"\n+#endif\n+\n #include <dlfcn.h>\n #include <stdio.h>\n #include <stdlib.h>\n@@ -1180,6 +1198,73 @@ String OS_LinuxBSD::get_system_ca_certificates() {\n \treturn f->get_as_text();\n }\n \n+bool OS_LinuxBSD::_test_create_rendering_device(const String &p_display_driver) const {\n+\t// Tests Rendering Device creation.\n+\n+\tbool ok = false;\n+#if defined(RD_ENABLED)\n+\tError err;\n+\tRenderingContextDriver *rcd = nullptr;\n+\n+#if defined(VULKAN_ENABLED)\n+#ifdef X11_ENABLED\n+\tif (p_display_driver == \"x11\" || p_display_driver.is_empty()) {\n+\t\trcd = memnew(RenderingContextDriverVulkanX11);\n+\t}\n+#endif\n+#ifdef WAYLAND_ENABLED\n+\tif (p_display_driver == \"wayland\") {\n+\t\trcd = memnew(RenderingContextDriverVulkanWayland);\n+\t}\n+#endif\n+#endif\n+\tif (rcd != nullptr) {\n+\t\terr = rcd->initialize();\n+\t\tif (err == OK) {\n+\t\t\tRenderingDevice *rd = memnew(RenderingDevice);\n+\t\t\terr = rd->initialize(rcd);\n+\t\t\tmemdelete(rd);\n+\t\t\trd = nullptr;\n+\t\t\tif (err == OK) {\n+\t\t\t\tok = true;\n+\t\t\t}\n+\t\t}\n+\t\tmemdelete(rcd);\n+\t\trcd = nullptr;\n+\t}\n+#endif\n+\treturn ok;\n+}\n+\n+bool OS_LinuxBSD::_test_create_rendering_device_and_gl(const String &p_display_driver) const {\n+\t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some drivers.\n+\n+#ifdef GLES3_ENABLED\n+#ifdef X11_ENABLED\n+\tif (p_display_driver == \"x11\" || p_display_driver.is_empty()) {\n+#ifdef SOWRAP_ENABLED\n+\t\tif (initialize_xlib(0) != 0) {\n+\t\t\treturn false;\n+\t\t}\n+#endif\n+\t\tDetectPrimeX11::create_context();\n+\t}\n+#endif\n+#ifdef WAYLAND_ENABLED\n+\tif (p_display_driver == \"wayland\") {\n+#ifdef SOWRAP_ENABLED\n+\t\tif (initialize_wayland_egl(0) != 0) {\n+\t\t\treturn false;\n+\t\t}\n+#endif\n+\t\tDetectPrimeEGL::create_context(EGL_PLATFORM_WAYLAND_KHR);\n+\t}\n+#endif\n+\tRasterizerGLES3::make_current(true);\n+#endif\n+\treturn _test_create_rendering_device(p_display_driver);\n+}\n+\n OS_LinuxBSD::OS_LinuxBSD() {\n \tmain_loop = nullptr;\n \ndiff --git a/platform/linuxbsd/os_linuxbsd.h b/platform/linuxbsd/os_linuxbsd.h\nindex 9084061eb96c..92e57304f3c3 100644\n--- a/platform/linuxbsd/os_linuxbsd.h\n+++ b/platform/linuxbsd/os_linuxbsd.h\n@@ -138,6 +138,9 @@ class OS_LinuxBSD : public OS_Unix {\n \n \tvirtual String get_system_ca_certificates() override;\n \n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const override;\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const override;\n+\n \tOS_LinuxBSD();\n \t~OS_LinuxBSD();\n };\ndiff --git a/platform/linuxbsd/wayland/detect_prime_egl.h b/platform/linuxbsd/wayland/detect_prime_egl.h\nindex 3391e020d8b2..eff5d8a2918d 100644\n--- a/platform/linuxbsd/wayland/detect_prime_egl.h\n+++ b/platform/linuxbsd/wayland/detect_prime_egl.h\n@@ -77,9 +77,9 @@ class DetectPrimeEGL {\n \t\t{ nullptr, 0 }\n \t};\n \n+public:\n \tstatic void create_context(EGLenum p_platform_enum);\n \n-public:\n \tstatic int detect_prime(EGLenum p_platform_enum);\n };\n \ndiff --git a/platform/linuxbsd/x11/detect_prime_x11.cpp b/platform/linuxbsd/x11/detect_prime_x11.cpp\nindex c2cb02b93781..5ec5a53b989c 100644\n--- a/platform/linuxbsd/x11/detect_prime_x11.cpp\n+++ b/platform/linuxbsd/x11/detect_prime_x11.cpp\n@@ -60,25 +60,23 @@ typedef GLXContext (*GLXCREATECONTEXTATTRIBSARBPROC)(Display *, GLXFBConfig, GLX\n // To prevent shadowing warnings\n #undef glGetString\n \n-struct vendor {\n-\tconst char *glxvendor = nullptr;\n-\tint priority = 0;\n-};\n-\n-vendor vendormap[] = {\n-\t{ \"Advanced Micro Devices, Inc.\", 30 },\n-\t{ \"AMD\", 30 },\n-\t{ \"NVIDIA Corporation\", 30 },\n-\t{ \"X.Org\", 30 },\n-\t{ \"Intel Open Source Technology Center\", 20 },\n-\t{ \"Intel\", 20 },\n-\t{ \"nouveau\", 10 },\n-\t{ \"Mesa Project\", 0 },\n-\t{ nullptr, 0 }\n-};\n+int silent_error_handler(Display *display, XErrorEvent *error) {\n+\tstatic char message[1024];\n+\tXGetErrorText(display, error->error_code, message, sizeof(message));\n+\tprint_verbose(vformat(\"XServer error: %s\"\n+\t\t\t\t\t\t  \"\\n   Major opcode of failed request: %d\"\n+\t\t\t\t\t\t  \"\\n   Serial number of failed request: %d\"\n+\t\t\t\t\t\t  \"\\n   Current serial number in output stream: %d\",\n+\t\t\tString::utf8(message), (uint64_t)error->request_code, (uint64_t)error->minor_code, (uint64_t)error->serial));\n+\n+\tquick_exit(1);\n+\treturn 0;\n+}\n \n // Runs inside a child. Exiting will not quit the engine.\n-void create_context() {\n+void DetectPrimeX11::create_context() {\n+\tXSetErrorHandler(&silent_error_handler);\n+\n \tDisplay *x11_display = XOpenDisplay(nullptr);\n \tWindow x11_window;\n \tGLXContext glx_context;\n@@ -137,20 +135,7 @@ void create_context() {\n \tXFree(vi);\n }\n \n-int silent_error_handler(Display *display, XErrorEvent *error) {\n-\tstatic char message[1024];\n-\tXGetErrorText(display, error->error_code, message, sizeof(message));\n-\tprint_verbose(vformat(\"XServer error: %s\"\n-\t\t\t\t\t\t  \"\\n   Major opcode of failed request: %d\"\n-\t\t\t\t\t\t  \"\\n   Serial number of failed request: %d\"\n-\t\t\t\t\t\t  \"\\n   Current serial number in output stream: %d\",\n-\t\t\tString::utf8(message), (uint64_t)error->request_code, (uint64_t)error->minor_code, (uint64_t)error->serial));\n-\n-\tquick_exit(1);\n-\treturn 0;\n-}\n-\n-int detect_prime() {\n+int DetectPrimeX11::detect_prime() {\n \tpid_t p;\n \tint priorities[2] = {};\n \tString vendors[2];\n@@ -202,7 +187,6 @@ int detect_prime() {\n \t\t\t// cleaning up these processes, and fork() makes a copy\n \t\t\t// of all globals.\n \t\t\tCoreGlobals::leak_reporting_enabled = false;\n-\t\t\tXSetErrorHandler(&silent_error_handler);\n \n \t\t\tchar string[201];\n \n@@ -253,7 +237,7 @@ int detect_prime() {\n \t}\n \n \tfor (int i = 1; i >= 0; --i) {\n-\t\tvendor *v = vendormap;\n+\t\tconst Vendor *v = vendor_map;\n \t\twhile (v->glxvendor) {\n \t\t\tif (v->glxvendor == vendors[i]) {\n \t\t\t\tpriorities[i] = v->priority;\ndiff --git a/platform/linuxbsd/x11/detect_prime_x11.h b/platform/linuxbsd/x11/detect_prime_x11.h\nindex 62fe42602678..c8da79bf9221 100644\n--- a/platform/linuxbsd/x11/detect_prime_x11.h\n+++ b/platform/linuxbsd/x11/detect_prime_x11.h\n@@ -33,7 +33,30 @@\n \n #if defined(X11_ENABLED) && defined(GLES3_ENABLED)\n \n-int detect_prime();\n+class DetectPrimeX11 {\n+private:\n+\tstruct Vendor {\n+\t\tconst char *glxvendor = nullptr;\n+\t\tint priority = 0;\n+\t};\n+\n+\tstatic constexpr Vendor vendor_map[] = {\n+\t\t{ \"Advanced Micro Devices, Inc.\", 30 },\n+\t\t{ \"AMD\", 30 },\n+\t\t{ \"NVIDIA Corporation\", 30 },\n+\t\t{ \"X.Org\", 30 },\n+\t\t{ \"Intel Open Source Technology Center\", 20 },\n+\t\t{ \"Intel\", 20 },\n+\t\t{ \"nouveau\", 10 },\n+\t\t{ \"Mesa Project\", 0 },\n+\t\t{ nullptr, 0 }\n+\t};\n+\n+public:\n+\tstatic void create_context();\n+\n+\tstatic int detect_prime();\n+};\n \n #endif // X11_ENABLED && GLES3_ENABLED\n \ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex 26c94bf25cf1..56277d85c960 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -2563,7 +2563,8 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\tAtom *atoms = (Atom *)data;\n \t\tAtom wm_act_max_horz;\n \t\tAtom wm_act_max_vert;\n-\t\tif (strcmp(p_atom_name, \"_NET_WM_STATE\") == 0) {\n+\t\tbool checking_state = strcmp(p_atom_name, \"_NET_WM_STATE\") == 0;\n+\t\tif (checking_state) {\n \t\t\twm_act_max_horz = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_HORZ\", False);\n \t\t\twm_act_max_vert = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_VERT\", False);\n \t\t} else {\n@@ -2581,9 +2582,16 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\t\t\tfound_wm_act_max_vert = true;\n \t\t\t}\n \n-\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n-\t\t\t\tretval = true;\n-\t\t\t\tbreak;\n+\t\t\tif (checking_state) {\n+\t\t\t\tif (found_wm_act_max_horz && found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \n@@ -6844,7 +6852,7 @@ DisplayServerX11::DisplayServerX11(const String &p_rendering_driver, WindowMode\n \n \t\t\tif (use_prime == -1) {\n \t\t\t\tprint_verbose(\"Detecting GPUs, set DRI_PRIME in the environment to override GPU detection logic.\");\n-\t\t\t\tuse_prime = detect_prime();\n+\t\t\t\tuse_prime = DetectPrimeX11::detect_prime();\n \t\t\t}\n \n \t\t\tif (use_prime) {\ndiff --git a/platform/web/README.md b/platform/web/README.md\nindex 906eb508fecd..eac2c7fe8e17 100644\n--- a/platform/web/README.md\n+++ b/platform/web/README.md\n@@ -17,6 +17,6 @@ this platform such as the html shell (web page).\n \n ## Artwork license\n \n-[`logo.png`](logo.png) and [`run_icon.png`](run_icon.png) are licensed under\n+[`logo.svg`](export/logo.svg) and [`run_icon.svg`](export/run_icon.svg) are licensed under\n [Creative Commons Attribution 3.0 Unported](https://www.w3.org/html/logo/faq.html#how-licenced)\n per the HTML5 logo usage guidelines.\ndiff --git a/platform/windows/os_windows.cpp b/platform/windows/os_windows.cpp\nindex 7ef3de2dd79c..b0ec6852af2e 100644\n--- a/platform/windows/os_windows.cpp\n+++ b/platform/windows/os_windows.cpp\n@@ -2340,18 +2340,26 @@ void OS_Windows::add_frame_delay(bool p_can_draw) {\n \t\ttarget_ticks += dynamic_delay;\n \t\tuint64_t current_ticks = get_ticks_usec();\n \n-\t\tif (target_ticks > current_ticks + delay_resolution) {\n-\t\t\tuint64_t delay_time = target_ticks - current_ticks - delay_resolution;\n-\t\t\t// Make sure we always sleep for a multiple of delay_resolution to avoid overshooting.\n-\t\t\t// Refer to: https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep#remarks\n-\t\t\tdelay_time = (delay_time / delay_resolution) * delay_resolution;\n-\t\t\tif (delay_time > 0) {\n-\t\t\t\tdelay_usec(delay_time);\n+\t\tif (!is_in_low_processor_usage_mode()) {\n+\t\t\tif (target_ticks > current_ticks + delay_resolution) {\n+\t\t\t\tuint64_t delay_time = target_ticks - current_ticks - delay_resolution;\n+\t\t\t\t// Make sure we always sleep for a multiple of delay_resolution to avoid overshooting.\n+\t\t\t\t// Refer to: https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep#remarks\n+\t\t\t\tdelay_time = (delay_time / delay_resolution) * delay_resolution;\n+\t\t\t\tif (delay_time > 0) {\n+\t\t\t\t\tdelay_usec(delay_time);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t// Busy wait for the remainder of time.\n+\t\t\twhile (get_ticks_usec() < target_ticks) {\n+\t\t\t\tYieldProcessor();\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Use a more relaxed approach for low processor usage mode.\n+\t\t\t// This has worse frame pacing but is more power efficient.\n+\t\t\tif (current_ticks < target_ticks) {\n+\t\t\t\tdelay_usec(target_ticks - current_ticks);\n \t\t\t}\n-\t\t}\n-\t\t// Busy wait for the remainder of time.\n-\t\twhile (get_ticks_usec() < target_ticks) {\n-\t\t\tYieldProcessor();\n \t\t}\n \n \t\tcurrent_ticks = get_ticks_usec();\n@@ -2359,7 +2367,7 @@ void OS_Windows::add_frame_delay(bool p_can_draw) {\n \t}\n }\n \n-bool OS_Windows::_test_create_rendering_device() const {\n+bool OS_Windows::_test_create_rendering_device(const String &p_display_driver) const {\n \t// Tests Rendering Device creation.\n \n \tbool ok = false;\n@@ -2394,7 +2402,7 @@ bool OS_Windows::_test_create_rendering_device() const {\n \treturn ok;\n }\n \n-bool OS_Windows::_test_create_rendering_device_and_gl() const {\n+bool OS_Windows::_test_create_rendering_device_and_gl(const String &p_display_driver) const {\n \t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n \n \tWNDCLASSEXW wc_probe;\n@@ -2438,7 +2446,7 @@ bool OS_Windows::_test_create_rendering_device_and_gl() const {\n \t}\n \n \tif (ok) {\n-\t\tok = _test_create_rendering_device();\n+\t\tok = _test_create_rendering_device(p_display_driver);\n \t}\n \n #ifdef GLES3_ENABLED\ndiff --git a/platform/windows/os_windows.h b/platform/windows/os_windows.h\nindex c46d86a650ef..d9b8233e511e 100644\n--- a/platform/windows/os_windows.h\n+++ b/platform/windows/os_windows.h\n@@ -252,8 +252,8 @@ class OS_Windows : public OS {\n \n \tvoid set_main_window(HWND p_main_window) { main_window = p_main_window; }\n \n-\tvirtual bool _test_create_rendering_device_and_gl() const override;\n-\tvirtual bool _test_create_rendering_device() const override;\n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const override;\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const override;\n \n \tHINSTANCE get_hinstance() { return hInstance; }\n \tOS_Windows(HINSTANCE _hInstance);\ndiff --git a/scene/2d/cpu_particles_2d.cpp b/scene/2d/cpu_particles_2d.cpp\nindex 279bb8ff3d95..b77003509786 100644\n--- a/scene/2d/cpu_particles_2d.cpp\n+++ b/scene/2d/cpu_particles_2d.cpp\n@@ -1194,8 +1194,6 @@ void CPUParticles2D::_notification(int p_what) {\n \n \t\t\t_refresh_interpolation_state();\n \n-\t\t\tset_physics_process_internal(emitting && _interpolation_data.interpolated_follow);\n-\n \t\t\t// If we are interpolated following, then reset physics interpolation\n \t\t\t// when first appearing. This won't be called by canvas item, as in the\n \t\t\t// following mode, is_physics_interpolated() is actually FALSE.\ndiff --git a/scene/3d/navigation_link_3d.cpp b/scene/3d/navigation_link_3d.cpp\nindex 8f9b7a60b513..dc518ee45256 100644\n--- a/scene/3d/navigation_link_3d.cpp\n+++ b/scene/3d/navigation_link_3d.cpp\n@@ -262,6 +262,12 @@ void NavigationLink3D::_notification(int p_what) {\n \t\tcase NOTIFICATION_EXIT_TREE: {\n \t\t\t_link_exit_navigation_map();\n \t\t} break;\n+\n+#ifdef DEBUG_ENABLED\n+\t\tcase NOTIFICATION_VISIBILITY_CHANGED: {\n+\t\t\t_update_debug_mesh();\n+\t\t} break;\n+#endif // DEBUG_ENABLED\n \t}\n }\n \ndiff --git a/scene/3d/voxelizer.cpp b/scene/3d/voxelizer.cpp\nindex 711b265bb641..a4c36deabdec 100644\n--- a/scene/3d/voxelizer.cpp\n+++ b/scene/3d/voxelizer.cpp\n@@ -399,6 +399,9 @@ int Voxelizer::get_bake_steps(Ref<Mesh> &p_mesh) const {\n Voxelizer::BakeResult Voxelizer::plot_mesh(const Transform3D &p_xform, Ref<Mesh> &p_mesh, const Vector<Ref<Material>> &p_materials, const Ref<Material> &p_override_material, BakeStepFunc p_bake_step_func) {\n \tERR_FAIL_COND_V_MSG(!p_xform.is_finite(), BAKE_RESULT_INVALID_PARAMETER, \"Invalid mesh bake transform.\");\n \n+\t// Precalculate for transforming vertex normals\n+\tBasis normal_xform = p_xform.basis.inverse().transposed();\n+\n \tint bake_total = get_bake_steps(p_mesh), bake_current = 0;\n \n \tfor (int i = 0; i < p_mesh->get_surface_count(); i++) {\n@@ -463,7 +466,7 @@ Voxelizer::BakeResult Voxelizer::plot_mesh(const Transform3D &p_xform, Ref<Mesh>\n \n \t\t\t\tif (nr) {\n \t\t\t\t\tfor (int k = 0; k < 3; k++) {\n-\t\t\t\t\t\tnormal[k] = nr[ir[j * 3 + k]];\n+\t\t\t\t\t\tnormal[k] = normal_xform.xform(nr[ir[j * 3 + k]]).normalized();\n \t\t\t\t\t}\n \t\t\t\t}\n \ndiff --git a/scene/animation/animation_blend_space_1d.cpp b/scene/animation/animation_blend_space_1d.cpp\nindex 4716a8fcec3d..acbc892d478f 100644\n--- a/scene/animation/animation_blend_space_1d.cpp\n+++ b/scene/animation/animation_blend_space_1d.cpp\n@@ -380,7 +380,13 @@ AnimationNode::NodeTimeInfo AnimationNodeBlendSpace1D::_process(const AnimationM\n \t\t\t\tRef<AnimationNodeAnimation> na_c = static_cast<Ref<AnimationNodeAnimation>>(blend_points[cur_closest].node);\n \t\t\t\tRef<AnimationNodeAnimation> na_n = static_cast<Ref<AnimationNodeAnimation>>(blend_points[new_closest].node);\n \t\t\t\tif (na_c.is_valid() && na_n.is_valid()) {\n+\t\t\t\t\tna_n->process_state = process_state;\n+\t\t\t\t\tna_c->process_state = process_state;\n+\n \t\t\t\t\tna_n->set_backward(na_c->is_backward());\n+\n+\t\t\t\t\tna_n = nullptr;\n+\t\t\t\t\tna_c = nullptr;\n \t\t\t\t}\n \t\t\t\t// See how much animation remains.\n \t\t\t\tpi.seeked = false;\ndiff --git a/scene/animation/animation_blend_space_2d.cpp b/scene/animation/animation_blend_space_2d.cpp\nindex 7399fea31719..ee1d4121d595 100644\n--- a/scene/animation/animation_blend_space_2d.cpp\n+++ b/scene/animation/animation_blend_space_2d.cpp\n@@ -557,7 +557,13 @@ AnimationNode::NodeTimeInfo AnimationNodeBlendSpace2D::_process(const AnimationM\n \t\t\t\tRef<AnimationNodeAnimation> na_c = static_cast<Ref<AnimationNodeAnimation>>(blend_points[cur_closest].node);\n \t\t\t\tRef<AnimationNodeAnimation> na_n = static_cast<Ref<AnimationNodeAnimation>>(blend_points[new_closest].node);\n \t\t\t\tif (na_c.is_valid() && na_n.is_valid()) {\n+\t\t\t\t\tna_n->process_state = process_state;\n+\t\t\t\t\tna_c->process_state = process_state;\n+\n \t\t\t\t\tna_n->set_backward(na_c->is_backward());\n+\n+\t\t\t\t\tna_n = nullptr;\n+\t\t\t\t\tna_c = nullptr;\n \t\t\t\t}\n \t\t\t\t// See how much animation remains.\n \t\t\t\tpi.seeked = false;\ndiff --git a/scene/debugger/scene_debugger.cpp b/scene/debugger/scene_debugger.cpp\nindex c620c5fd5c80..6b4a00f61719 100644\n--- a/scene/debugger/scene_debugger.cpp\n+++ b/scene/debugger/scene_debugger.cpp\n@@ -1362,7 +1362,7 @@ void RuntimeNodeSelect::_root_window_input(const Ref<InputEvent> &p_event) {\n \n \tif (camera_override) {\n \t\tif (node_select_type == NODE_TYPE_2D) {\n-\t\t\tif (panner->gui_input(p_event, Rect2(Vector2(), root->get_size()))) {\n+\t\t\tif (panner->gui_input(p_event, Rect2(Vector2(), root->get_visible_rect().get_size()))) {\n \t\t\t\treturn;\n \t\t\t}\n \t\t} else if (node_select_type == NODE_TYPE_3D) {\n@@ -1821,8 +1821,9 @@ void RuntimeNodeSelect::_find_canvas_items_at_pos(const Point2 &p_pos, Node *p_n\n }\n \n void RuntimeNodeSelect::_pan_callback(Vector2 p_scroll_vec, Ref<InputEvent> p_event) {\n-\tview_2d_offset.x -= p_scroll_vec.x / view_2d_zoom;\n-\tview_2d_offset.y -= p_scroll_vec.y / view_2d_zoom;\n+\tVector2 scroll = SceneTree::get_singleton()->get_root()->get_screen_transform().affine_inverse().xform(p_scroll_vec);\n+\tview_2d_offset.x -= scroll.x / view_2d_zoom;\n+\tview_2d_offset.y -= scroll.y / view_2d_zoom;\n \n \t_update_view_2d();\n }\ndiff --git a/scene/gui/color_picker.cpp b/scene/gui/color_picker.cpp\nindex aab7c37bbb5e..a5348ad3b290 100644\n--- a/scene/gui/color_picker.cpp\n+++ b/scene/gui/color_picker.cpp\n@@ -2374,7 +2374,7 @@ ColorPicker::ColorPicker() {\n \tswatches_vbc->add_child(palette_box);\n \n \tbtn_preset = memnew(Button);\n-\tbtn_preset->set_text(\"Swatches\");\n+\tbtn_preset->set_text(ETR(\"Swatches\"));\n \tbtn_preset->set_flat(true);\n \tbtn_preset->set_toggle_mode(true);\n \tbtn_preset->set_focus_mode(FOCUS_NONE);\ndiff --git a/scene/gui/line_edit.cpp b/scene/gui/line_edit.cpp\nindex 969e2fd3a35c..f4d66d5a281d 100644\n--- a/scene/gui/line_edit.cpp\n+++ b/scene/gui/line_edit.cpp\n@@ -1733,7 +1733,7 @@ void LineEdit::_validate_caret_can_draw() {\n \t\tdraw_caret = true;\n \t\tcaret_blink_timer = 0.0;\n \t}\n-\tcaret_can_draw = editing && (window_has_focus || (menu && menu->has_focus())) && (has_focus() || caret_force_displayed);\n+\tcaret_can_draw = (caret_force_displayed && !is_part_of_edited_scene()) || (editing && (window_has_focus || (menu && menu->has_focus())) && has_focus());\n }\n \n void LineEdit::delete_char() {\ndiff --git a/scene/gui/spin_box.cpp b/scene/gui/spin_box.cpp\nindex e2e6f076781a..c77fda1ac805 100644\n--- a/scene/gui/spin_box.cpp\n+++ b/scene/gui/spin_box.cpp\n@@ -63,20 +63,39 @@ void SpinBox::_update_text(bool p_only_update_if_value_changed) {\n \t\t\tvalue += \" \" + suffix;\n \t\t}\n \t}\n+\n+\tif (!accepted && update_on_text_changed && !line_edit->get_text().replace(\",\", \".\").contains_char('.')) {\n+\t\tvalue = String::num(get_value(), 0);\n+\t}\n+\n \tline_edit->set_text_with_selection(value);\n }\n \n void SpinBox::_text_submitted(const String &p_string) {\n \tif (p_string.is_empty()) {\n-\t\t_update_text();\n \t\treturn;\n \t}\n \n+\tString text = p_string;\n+\n+\tif (update_on_text_changed) {\n+\t\t// Convert commas ',' to dots '.' for French/German etc. keyboard layouts.\n+\t\ttext = p_string.replace(\",\", \".\");\n+\n+\t\tif (!text.begins_with(\".\") && p_string.ends_with(\".\")) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tif (text.begins_with(\".\")) {\n+\t\t\tline_edit->set_text(\"0.\");\n+\t\t\tline_edit->set_caret_column(line_edit->get_text().length());\n+\t\t\treturn;\n+\t\t}\n+\t}\n+\n \tRef<Expression> expr;\n \texpr.instantiate();\n \n-\t// Convert commas ',' to dots '.' for French/German etc. keyboard layouts.\n-\tString text = p_string.replace(\",\", \".\");\n \ttext = text.replace(\";\", \",\");\n \ttext = TS->parse_number(text);\n \t// Ignore the prefix and suffix in the expression.\n@@ -107,12 +126,17 @@ void SpinBox::_text_submitted(const String &p_string) {\n }\n \n void SpinBox::_text_changed(const String &p_string) {\n+\taccepted = false;\n \tint cursor_pos = line_edit->get_caret_column();\n \n \t_text_submitted(p_string);\n \n+\tString text = p_string.replace(\",\", \".\");\n+\n \t// Line edit 'set_text' method resets the cursor position so we need to undo that.\n-\tline_edit->set_caret_column(cursor_pos);\n+\tif (update_on_text_changed && !text.begins_with(\".\")) {\n+\t\tline_edit->set_caret_column(cursor_pos);\n+\t}\n }\n \n LineEdit *SpinBox::get_line_edit() {\n@@ -192,6 +216,7 @@ void SpinBox::gui_input(const Ref<InputEvent> &p_event) {\n \tif (mb.is_valid() && mb->is_pressed()) {\n \t\tswitch (mb->get_button_index()) {\n \t\t\tcase MouseButton::LEFT: {\n+\t\t\t\taccepted = true;\n \t\t\t\tline_edit->grab_focus();\n \n \t\t\t\tif (mouse_on_up_button || mouse_on_down_button) {\n@@ -291,9 +316,12 @@ void SpinBox::_line_edit_editing_toggled(bool p_toggled_on) {\n \t\t\tline_edit->select_all();\n \t\t}\n \t} else {\n+\t\taccepted = true;\n+\n \t\tif (Input::get_singleton()->is_action_pressed(\"ui_cancel\") || line_edit->get_text().is_empty()) {\n \t\t\t_update_text(); // Revert text if editing was canceled.\n \t\t} else {\n+\t\t\tline_edit->set_text(line_edit->get_text().trim_suffix(\".\").trim_suffix(\",\"));\n \t\t\t_update_text(true); // Update text in case value was changed this frame (e.g. on `focus_exited`).\n \t\t\t_text_submitted(line_edit->get_text());\n \t\t}\ndiff --git a/scene/gui/spin_box.h b/scene/gui/spin_box.h\nindex 79076d3f4692..dcc1f73eb9a2 100644\n--- a/scene/gui/spin_box.h\n+++ b/scene/gui/spin_box.h\n@@ -40,6 +40,7 @@ class SpinBox : public Range {\n \n \tLineEdit *line_edit = nullptr;\n \tbool update_on_text_changed = false;\n+\tbool accepted = true;\n \n \tstruct SizingCache {\n \t\tint buttons_block_width = 0;\ndiff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex ad2202315008..887d4eaf00f1 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -6081,7 +6081,7 @@ void TextEdit::adjust_viewport_to_caret(int p_caret) {\n \t\tset_line_as_last_visible(cur_line, cur_wrap);\n \t}\n \n-\t_adjust_viewport_to_caret_horizontally(p_caret);\n+\t_adjust_viewport_to_caret_horizontally(p_caret, false);\n }\n \n void TextEdit::center_viewport_to_caret(int p_caret) {\n@@ -8186,7 +8186,7 @@ void TextEdit::_scroll_lines_down() {\n \tmerge_overlapping_carets();\n }\n \n-void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret) {\n+void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret, bool p_maximize_selection) {\n \tif (get_line_wrapping_mode() != LineWrappingMode::LINE_WRAPPING_NONE) {\n \t\tfirst_visible_col = 0;\n \t\th_scroll->set_value(first_visible_col);\n@@ -8220,7 +8220,7 @@ void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret) {\n \t\tint ime_end_column = get_caret_column(p_caret) + (ime_selection.y > 0 ? ime_selection.x + ime_selection.y : ime_text.length());\n \t\tcaret_end_pos = _get_column_x_offset_for_line(ime_end_column, get_caret_line(p_caret), ime_end_column);\n \t\tprioritize_end = false;\n-\t} else if (has_selection(p_caret) && get_selection_from_line(p_caret) == get_selection_to_line(p_caret)) {\n+\t} else if (p_maximize_selection && has_selection(p_caret) && get_selection_from_line(p_caret) == get_selection_to_line(p_caret)) {\n \t\t// Use selection if it is on one line.\n \t\tcaret_start_pos = _get_column_x_offset_for_line(get_selection_from_column(p_caret), get_caret_line(p_caret), get_selection_from_column(p_caret));\n \t\tcaret_end_pos = _get_column_x_offset_for_line(get_selection_to_column(p_caret), get_caret_line(p_caret), get_selection_to_column(p_caret));\ndiff --git a/scene/gui/text_edit.h b/scene/gui/text_edit.h\nindex 21c8781e2648..b8d78283403d 100644\n--- a/scene/gui/text_edit.h\n+++ b/scene/gui/text_edit.h\n@@ -539,7 +539,7 @@ class TextEdit : public Control {\n \tvoid _scroll_lines_up();\n \tvoid _scroll_lines_down();\n \n-\tvoid _adjust_viewport_to_caret_horizontally(int p_caret = 0);\n+\tvoid _adjust_viewport_to_caret_horizontally(int p_caret = 0, bool p_maximize_selection = true);\n \n \t// Minimap.\n \tbool draw_minimap = false;\ndiff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex cd6c51de4b2d..dc14294ea05b 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -3506,7 +3506,7 @@ void Tree::gui_input(const Ref<InputEvent> &p_event) {\n \tRef<InputEventKey> k = p_event;\n \n \tbool is_command = k.is_valid() && k->is_command_or_control_pressed();\n-\tif (p_event->is_action(\"ui_right\") && p_event->is_pressed()) {\n+\tif (p_event->is_action(cache.rtl ? \"ui_left\" : \"ui_right\") && p_event->is_pressed()) {\n \t\tif (!cursor_can_exit_tree) {\n \t\t\taccept_event();\n \t\t}\n@@ -3524,7 +3524,7 @@ void Tree::gui_input(const Ref<InputEvent> &p_event) {\n \t\t} else {\n \t\t\t_go_down();\n \t\t}\n-\t} else if (p_event->is_action(\"ui_left\") && p_event->is_pressed()) {\n+\t} else if (p_event->is_action(cache.rtl ? \"ui_right\" : \"ui_left\") && p_event->is_pressed()) {\n \t\tif (!cursor_can_exit_tree) {\n \t\t\taccept_event();\n \t\t}\n@@ -4107,13 +4107,18 @@ bool Tree::edit_selected(bool p_force_edit) {\n \t\t// \"floor()\" centers vertically.\n \t\tVector2 ofs(0, Math::floor((MAX(line_editor->get_minimum_size().height, rect.size.height - value_editor_height) - rect.size.height) / 2));\n \n-\t\tpopup_rect.position = get_screen_position() + rect.position - ofs;\n-\t\tpopup_rect.size = rect.size;\n-\n \t\t// Account for icon.\n \t\tSize2 icon_size = _get_cell_icon_size(c) * popup_scale;\n-\t\tpopup_rect.position.x += icon_size.x;\n-\t\tpopup_rect.size.x -= icon_size.x;\n+\n+\t\tpopup_rect.size = rect.size;\n+\t\tpopup_rect.size.x -= icon_size.x + theme_cache.h_separation;\n+\n+\t\tpopup_rect.position = rect.position - ofs;\n+\t\tpopup_rect.position.x += icon_size.x + theme_cache.h_separation;\n+\t\tif (cache.rtl) {\n+\t\t\tpopup_rect.position.x = get_size().width - popup_rect.position.x - popup_rect.size.x;\n+\t\t}\n+\t\tpopup_rect.position += get_screen_position();\n \n \t\tline_editor->clear();\n \t\tline_editor->set_text(c.mode == TreeItem::CELL_MODE_STRING ? c.text : String::num(c.val, Math::range_step_decimals(c.step)));\ndiff --git a/scene/gui/video_stream_player.cpp b/scene/gui/video_stream_player.cpp\nindex fa965179a4d4..eb6aff27dc92 100644\n--- a/scene/gui/video_stream_player.cpp\n+++ b/scene/gui/video_stream_player.cpp\n@@ -136,6 +136,7 @@ void VideoStreamPlayer::_notification(int p_notification) {\n \t\t} break;\n \n \t\tcase NOTIFICATION_EXIT_TREE: {\n+\t\t\tstop();\n \t\t\tAudioServer::get_singleton()->remove_mix_callback(_mix_audios, this);\n \t\t} break;\n \ndiff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex d0054baeff25..f7fd1a2c5a7e 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -1509,6 +1509,7 @@ void Viewport::_gui_show_tooltip() {\n \t// This way, the custom tooltip from `ConnectionsDockTree` can create\n \t// its own tooltip without conflicting with the default one, even an empty tooltip.\n \tif (base_tooltip && !base_tooltip->is_visible()) {\n+\t\tmemdelete(base_tooltip);\n \t\treturn;\n \t}\n \n@@ -1546,6 +1547,8 @@ void Viewport::_gui_show_tooltip() {\n \tpanel->set_flag(Window::FLAG_POPUP, false);\n \tpanel->set_flag(Window::FLAG_MOUSE_PASSTHROUGH, true);\n \tpanel->set_wrap_controls(true);\n+\tpanel->set_default_canvas_item_texture_filter(get_default_canvas_item_texture_filter());\n+\tpanel->set_default_canvas_item_texture_repeat(get_default_canvas_item_texture_repeat());\n \tpanel->add_child(base_tooltip);\n \tpanel->gui_parent = this;\n \ndiff --git a/scene/resources/curve.cpp b/scene/resources/curve.cpp\nindex e982e4d13575..de68737b8c93 100644\n--- a/scene/resources/curve.cpp\n+++ b/scene/resources/curve.cpp\n@@ -56,7 +56,7 @@ void Curve::set_point_count(int p_count) {\n \tnotify_property_list_changed();\n }\n \n-int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_tangent, TangentMode p_left_mode, TangentMode p_right_mode) {\n+int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_tangent, TangentMode p_left_mode, TangentMode p_right_mode, bool p_mark_dirty) {\n \t// Add a point and preserve order.\n \n \t// Points must remain within the given value and domain ranges.\n@@ -99,7 +99,9 @@ int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_\n \n \tupdate_auto_tangents(ret);\n \n-\tmark_dirty();\n+\tif (p_mark_dirty) {\n+\t\tmark_dirty();\n+\t}\n \n \treturn ret;\n }\n@@ -221,10 +223,12 @@ Curve::TangentMode Curve::get_point_right_mode(int p_index) const {\n \treturn _points[p_index].right_mode;\n }\n \n-void Curve::_remove_point(int p_index) {\n+void Curve::_remove_point(int p_index, bool p_mark_dirty) {\n \tERR_FAIL_UNSIGNED_INDEX((uint32_t)p_index, _points.size());\n \t_points.remove_at(p_index);\n-\tmark_dirty();\n+\tif (p_mark_dirty) {\n+\t\tmark_dirty();\n+\t}\n }\n \n void Curve::remove_point(int p_index) {\n@@ -252,16 +256,13 @@ void Curve::set_point_value(int p_index, real_t p_position) {\n int Curve::set_point_offset(int p_index, real_t p_offset) {\n \tERR_FAIL_UNSIGNED_INDEX_V((uint32_t)p_index, _points.size(), -1);\n \tPoint p = _points[p_index];\n-\t_remove_point(p_index);\n-\tint i = _add_point(Vector2(p_offset, p.position.y));\n-\t_points[i].left_tangent = p.left_tangent;\n-\t_points[i].right_tangent = p.right_tangent;\n-\t_points[i].left_mode = p.left_mode;\n-\t_points[i].right_mode = p.right_mode;\n+\t_remove_point(p_index, false);\n+\tint i = _add_point(Vector2(p_offset, p.position.y), p.left_tangent, p.right_tangent, p.left_mode, p.right_mode, false);\n \tif (p_index != i) {\n \t\tupdate_auto_tangents(p_index);\n \t}\n \tupdate_auto_tangents(i);\n+\tmark_dirty();\n \treturn i;\n }\n \ndiff --git a/scene/resources/curve.h b/scene/resources/curve.h\nindex fb774e879dff..16ce75198455 100644\n--- a/scene/resources/curve.h\n+++ b/scene/resources/curve.h\n@@ -77,15 +77,15 @@ class Curve : public Resource {\n \tvoid set_point_count(int p_count);\n \n \tint add_point(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE);\n \tint add_point_no_update(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE);\n \tvoid remove_point(int p_index);\n \tvoid clear_points();\n \n@@ -127,10 +127,10 @@ class Curve : public Resource {\n \tTangentMode get_point_left_mode(int p_index) const;\n \tTangentMode get_point_right_mode(int p_index) const;\n \n-\tvoid update_auto_tangents(int i);\n+\tvoid update_auto_tangents(int p_index);\n \n \tArray get_data() const;\n-\tvoid set_data(Array input);\n+\tvoid set_data(Array p_input);\n \n \tvoid bake();\n \tvoid _bake() const;\n@@ -150,11 +150,12 @@ class Curve : public Resource {\n private:\n \tvoid mark_dirty();\n \tint _add_point(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n-\tvoid _remove_point(int p_index);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE,\n+\t\t\tbool p_mark_dirty = true);\n+\tvoid _remove_point(int p_index, bool p_mark_dirty = true);\n \n \tLocalVector<Point> _points;\n \tmutable bool _baked_cache_dirty = false;\ndiff --git a/scene/resources/packed_scene.cpp b/scene/resources/packed_scene.cpp\nindex 7f170e0085ec..e550a5beff90 100644\n--- a/scene/resources/packed_scene.cpp\n+++ b/scene/resources/packed_scene.cpp\n@@ -328,7 +328,7 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \n \t\t\t\t\t\tDeferredNodePathProperties dnp;\n \t\t\t\t\t\tdnp.value = props[nprops[j].value];\n-\t\t\t\t\t\tdnp.base = node;\n+\t\t\t\t\t\tdnp.base = node->get_instance_id();\n \t\t\t\t\t\tdnp.property = snames[name_idx];\n \t\t\t\t\t\tdeferred_node_paths.push_back(dnp);\n \t\t\t\t\t\tcontinue;\n@@ -521,25 +521,27 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \n \tfor (const DeferredNodePathProperties &dnp : deferred_node_paths) {\n \t\t// Replace properties stored as NodePaths with actual Nodes.\n+\t\tNode *base = Object::cast_to<Node>(ObjectDB::get_instance(dnp.base));\n+\t\tERR_CONTINUE_EDMSG(!base, vformat(\"Failed to set deferred property '%s' as the base node disappeared.\", dnp.property));\n \t\tif (dnp.value.get_type() == Variant::ARRAY) {\n \t\t\tArray paths = dnp.value;\n \n \t\t\tbool valid;\n-\t\t\tArray array = dnp.base->get(dnp.property, &valid);\n-\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, dnp.base->get_name()));\n+\t\t\tArray array = base->get(dnp.property, &valid);\n+\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, base->get_name()));\n \t\t\tarray = array.duplicate();\n \n \t\t\tarray.resize(paths.size());\n \t\t\tfor (int i = 0; i < array.size(); i++) {\n-\t\t\t\tarray.set(i, dnp.base->get_node_or_null(paths[i]));\n+\t\t\t\tarray.set(i, base->get_node_or_null(paths[i]));\n \t\t\t}\n-\t\t\tdnp.base->set(dnp.property, array);\n+\t\t\tbase->set(dnp.property, array);\n \t\t} else if (dnp.value.get_type() == Variant::DICTIONARY) {\n \t\t\tDictionary paths = dnp.value;\n \n \t\t\tbool valid;\n-\t\t\tDictionary dict = dnp.base->get(dnp.property, &valid);\n-\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, dnp.base->get_name()));\n+\t\t\tDictionary dict = base->get(dnp.property, &valid);\n+\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, base->get_name()));\n \t\t\tdict = dict.duplicate();\n \t\t\tbool convert_key = dict.get_typed_key_builtin() == Variant::OBJECT &&\n \t\t\t\t\tClassDB::is_parent_class(dict.get_typed_key_class_name(), \"Node\");\n@@ -549,17 +551,17 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \t\t\tfor (int i = 0; i < paths.size(); i++) {\n \t\t\t\tVariant key = paths.get_key_at_index(i);\n \t\t\t\tif (convert_key) {\n-\t\t\t\t\tkey = dnp.base->get_node_or_null(key);\n+\t\t\t\t\tkey = base->get_node_or_null(key);\n \t\t\t\t}\n \t\t\t\tVariant value = paths.get_value_at_index(i);\n \t\t\t\tif (convert_value) {\n-\t\t\t\t\tvalue = dnp.base->get_node_or_null(value);\n+\t\t\t\t\tvalue = base->get_node_or_null(value);\n \t\t\t\t}\n \t\t\t\tdict[key] = value;\n \t\t\t}\n-\t\t\tdnp.base->set(dnp.property, dict);\n+\t\t\tbase->set(dnp.property, dict);\n \t\t} else {\n-\t\t\tdnp.base->set(dnp.property, dnp.base->get_node_or_null(dnp.value));\n+\t\t\tbase->set(dnp.property, base->get_node_or_null(dnp.value));\n \t\t}\n \t}\n \ndiff --git a/scene/resources/packed_scene.h b/scene/resources/packed_scene.h\nindex 9f8088910f18..ee2bba2f2088 100644\n--- a/scene/resources/packed_scene.h\n+++ b/scene/resources/packed_scene.h\n@@ -70,7 +70,7 @@ class SceneState : public RefCounted {\n \t};\n \n \tstruct DeferredNodePathProperties {\n-\t\tNode *base = nullptr;\n+\t\tObjectID base;\n \t\tStringName property;\n \t\tVariant value;\n \t};\ndiff --git a/scene/resources/particle_process_material.cpp b/scene/resources/particle_process_material.cpp\nindex 2c54564ff7b3..dd6e659e0612 100644\n--- a/scene/resources/particle_process_material.cpp\n+++ b/scene/resources/particle_process_material.cpp\n@@ -1034,7 +1034,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t\t\tcode += \"\t{\\n\";\n \t\t}\n \t\tcode += \"\t\tfloat vel_mag = length(VELOCITY);\\n\";\n-\t\tcode += \"\t\tfloat vel_infl = clamp(dynamic_params.turb_influence * turbulence_influence, 0.0, 1.0);\\n\";\n+\t\tcode += \"\t\tfloat vel_infl = clamp(dynamic_params.turb_influence * turbulence_influence, 0.0, 1.0) * (DELTA <= 0.0 ? 0.0 : 1.0);\\n\";\n \t\tcode += \"\t\tVELOCITY = mix(VELOCITY, normalize(noise_direction) * vel_mag * (1.0 + (1.0 - vel_infl) * 0.2), vel_infl);\\n\";\n \t\tcode += \"\t\tvel_mag = length(controlled_displacement);\\n\";\n \t\tcode += \"\t\tcontrolled_displacement = mix(controlled_displacement, normalize(noise_direction) * vel_mag * (1.0 + (1.0 - vel_infl) * 0.2), vel_infl);\\n\";\n@@ -1121,9 +1121,16 @@ void ParticleProcessMaterial::_update_shader() {\n \t\tcode += \"\t\tparams.scale *= texture(scale_over_velocity_curve, vec2(0.0)).rgb;\\n\";\n \t\tcode += \"\t}\\n\";\n \t}\n-\tcode += \"\tTRANSFORM[0].xyz *= sign(params.scale.x) * max(abs(params.scale.x), 0.001);\\n\";\n-\tcode += \"\tTRANSFORM[1].xyz *= sign(params.scale.y) * max(abs(params.scale.y), 0.001);\\n\";\n-\tcode += \"\tTRANSFORM[2].xyz *= sign(params.scale.z) * max(abs(params.scale.z), 0.001);\\n\";\n+\t// A scale of 0 results in no emission at some emission amounts (including 3 and 6).\n+\t// `sign(scale)` is unsuitable, because sign(0) returns 0, nullifying the minimum value.\n+\t// The following evaluates to 1 when scale is 0, falling back to a positive minimum value.\n+\tcode += \"\tfloat scale_sign_x = params.scale.x < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_sign_y = params.scale.y < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_sign_z = params.scale.z < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_minimum = 0.001;\\n\";\n+\tcode += \"\tTRANSFORM[0].xyz *= scale_sign_x * max(abs(params.scale.x), scale_minimum);\\n\";\n+\tcode += \"\tTRANSFORM[1].xyz *= scale_sign_y * max(abs(params.scale.y), scale_minimum);\\n\";\n+\tcode += \"\tTRANSFORM[2].xyz *= scale_sign_z * max(abs(params.scale.z), scale_minimum);\\n\";\n \tcode += \"\\n\";\n \tcode += \"\tCUSTOM.z = params.animation_offset + lifetime_percent * params.animation_speed;\\n\\n\";\n \ndiff --git a/scene/theme/default_theme.cpp b/scene/theme/default_theme.cpp\nindex 5ae1e9baa37d..06fe298668f3 100644\n--- a/scene/theme/default_theme.cpp\n+++ b/scene/theme/default_theme.cpp\n@@ -91,6 +91,8 @@ static Ref<ImageTexture> generate_icon(int p_index) {\n \n \tError err = ImageLoaderSVG::create_image_from_string(img, default_theme_icons_sources[p_index], scale, upsample, HashMap<Color, Color>());\n \tERR_FAIL_COND_V_MSG(err != OK, Ref<ImageTexture>(), \"Failed generating icon, unsupported or invalid SVG data in default theme.\");\n+\n+\timg->fix_alpha_edges();\n #else\n \t// If the SVG module is disabled, we can't really display the UI well, but at least we won't crash.\n \t// 16 pixels is used as it's the most common base size for Godot icons.\ndiff --git a/servers/display_server.cpp b/servers/display_server.cpp\nindex c9399d9c65f8..87300bd8b6a2 100644\n--- a/servers/display_server.cpp\n+++ b/servers/display_server.cpp\n@@ -1331,10 +1331,14 @@ bool DisplayServer::is_rendering_device_supported() {\n \n \tError err;\n \n-#ifdef WINDOWS_ENABLED\n-\t// On some NVIDIA drivers combining OpenGL and RenderingDevice can result in crash, offload the check to the subprocess.\n+#if defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED)\n+\t// On some drivers combining OpenGL and RenderingDevice can result in crash, offload the check to the subprocess.\n \tList<String> arguments;\n \targuments.push_back(\"--test-rd-support\");\n+\tif (get_singleton()) {\n+\t\targuments.push_back(\"--display-driver\");\n+\t\targuments.push_back(get_singleton()->get_name().to_lower());\n+\t}\n \n \tString pipe;\n \tint exitcode = 0;\ndiff --git a/servers/rendering/renderer_rd/effects/luminance.cpp b/servers/rendering/renderer_rd/effects/luminance.cpp\nindex 4727e8fd9a9c..ab3ddb67b33b 100644\n--- a/servers/rendering/renderer_rd/effects/luminance.cpp\n+++ b/servers/rendering/renderer_rd/effects/luminance.cpp\n@@ -102,9 +102,10 @@ void Luminance::LuminanceBuffers::configure(RenderSceneBuffersRD *p_render_buffe\n \t\t\ttf.usage_bits = RD::TEXTURE_USAGE_COLOR_ATTACHMENT_BIT | RD::TEXTURE_USAGE_SAMPLING_BIT;\n \t\t} else {\n \t\t\ttf.usage_bits = RD::TEXTURE_USAGE_STORAGE_BIT;\n-\t\t\tif (final) {\n-\t\t\t\ttf.usage_bits |= RD::TEXTURE_USAGE_SAMPLING_BIT;\n-\t\t\t}\n+\t\t}\n+\n+\t\tif (final) {\n+\t\t\ttf.usage_bits |= RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_COPY_TO_BIT;\n \t\t}\n \n \t\tRID texture = RD::get_singleton()->texture_create(tf, RD::TextureView());\n@@ -112,6 +113,7 @@ void Luminance::LuminanceBuffers::configure(RenderSceneBuffersRD *p_render_buffe\n \n \t\tif (final) {\n \t\t\tcurrent = RD::get_singleton()->texture_create(tf, RD::TextureView());\n+\t\t\tRD::get_singleton()->texture_clear(current, Color(0.0, 0.0, 0.0), 0u, 1u, 0u, 1u);\n \t\t\tbreak;\n \t\t}\n \t}\ndiff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 5cea736eeb15..eebc6358ff62 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -1837,7 +1837,7 @@ RendererCanvasRenderRD::RendererCanvasRenderRD() {\n \t\tactions.base_varying_index = 5;\n \n \t\tactions.global_buffer_array_variable = \"global_shader_uniforms.data\";\n-\t\tactions.instance_uniform_index_variable = \"draw_data.instance_uniforms_ofs\";\n+\t\tactions.instance_uniform_index_variable = \"instances.data[instance_index].instance_uniforms_ofs\";\n \n \t\tshader.compiler.initialize(actions);\n \t}\ndiff --git a/servers/rendering/renderer_rd/shader_rd.cpp b/servers/rendering/renderer_rd/shader_rd.cpp\nindex cbdbe151c82f..ed9428a6a351 100644\n--- a/servers/rendering/renderer_rd/shader_rd.cpp\n+++ b/servers/rendering/renderer_rd/shader_rd.cpp\n@@ -555,7 +555,7 @@ void ShaderRD::_compile_version_start(Version *p_version, int p_group) {\n \tcompile_data.version = p_version;\n \tcompile_data.group = p_group;\n \n-\tWorkerThreadPool::GroupID group_task = WorkerThreadPool::get_singleton()->add_template_group_task(this, &ShaderRD::_compile_variant, compile_data, group_to_variant_map[p_group].size(), -1, true, SNAME(\"ShaderCompilation\"));\n+\tWorkerThreadPool::GroupID group_task = WorkerThreadPool::get_named_pool(SNAME(\"ShaderCompilationPool\"))->add_template_group_task(this, &ShaderRD::_compile_variant, compile_data, group_to_variant_map[p_group].size(), -1, true, SNAME(\"ShaderCompilation\"));\n \tp_version->group_compilation_tasks.write[p_group] = group_task;\n }\n \n@@ -563,9 +563,8 @@ void ShaderRD::_compile_version_end(Version *p_version, int p_group) {\n \tif (p_version->group_compilation_tasks.size() <= p_group || p_version->group_compilation_tasks[p_group] == 0) {\n \t\treturn;\n \t}\n-\n \tWorkerThreadPool::GroupID group_task = p_version->group_compilation_tasks[p_group];\n-\tWorkerThreadPool::get_singleton()->wait_for_group_task_completion(group_task);\n+\tWorkerThreadPool::get_named_pool(SNAME(\"ShaderCompilationPool\"))->wait_for_group_task_completion(group_task);\n \tp_version->group_compilation_tasks.write[p_group] = 0;\n \n \tbool all_valid = true;\ndiff --git a/servers/rendering/renderer_rd/shaders/canvas.glsl b/servers/rendering/renderer_rd/shaders/canvas.glsl\nindex c1510a11ca08..e2d9086a5de5 100644\n--- a/servers/rendering/renderer_rd/shaders/canvas.glsl\n+++ b/servers/rendering/renderer_rd/shaders/canvas.glsl\n@@ -48,6 +48,8 @@ layout(set = 1, binding = 0, std140) uniform MaterialUniforms {\n /* clang-format on */\n #endif\n \n+uint instance_index;\n+\n #GLOBALS\n \n #ifdef USE_ATTRIBUTES\n@@ -66,9 +68,9 @@ void main() {\n #endif\n \n #ifdef USE_ATTRIBUTES\n-\tuint instance_index = params.base_instance_index;\n+\tinstance_index = params.base_instance_index;\n #else\n-\tuint instance_index = gl_InstanceIndex + params.base_instance_index;\n+\tinstance_index = gl_InstanceIndex + params.base_instance_index;\n \tinstance_index_interp = instance_index;\n #endif // USE_ATTRIBUTES\n \tconst InstanceData draw_data = instances.data[instance_index];\n@@ -240,7 +242,7 @@ void main() {\n #include \"canvas_uniforms_inc.glsl\"\n \n #ifndef USE_ATTRIBUTES\n-layout(location = 4) in flat uint instance_index;\n+layout(location = 4) in flat uint instance_index_interp;\n #endif // USE_ATTRIBUTES\n \n layout(location = 0) in vec2 uv_interp;\n@@ -287,6 +289,8 @@ vec2 sdf_to_screen_uv(vec2 p_sdf) {\n \treturn p_sdf * canvas_data.sdf_to_screen;\n }\n \n+uint instance_index;\n+\n #GLOBALS\n \n #ifdef LIGHT_CODE_USED\n@@ -302,6 +306,7 @@ vec4 light_compute(\n \t\tvec2 screen_uv,\n \t\tvec2 uv,\n \t\tvec4 color, bool is_directional) {\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \tvec4 light = vec4(0.0);\n \tvec3 light_direction = vec3(0.0);\n \n@@ -461,10 +466,11 @@ void main() {\n \tvec2 vertex = vertex_interp;\n \n #ifdef USE_ATTRIBUTES\n-\tconst InstanceData draw_data = instances.data[params.base_instance_index];\n+\tinstance_index = params.base_instance_index;\n #else\n-\tconst InstanceData draw_data = instances.data[instance_index];\n+\tinstance_index = instance_index_interp;\n #endif // USE_ATTRIBUTES\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \n #if !defined(USE_ATTRIBUTES) && !defined(USE_PRIMITIVE)\n \ndiff --git a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\nindex d82ffed646a0..6924f11e346c 100644\n--- a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n@@ -814,7 +814,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \t\tp_particles->particles_material_uniform_set = RD::get_singleton()->uniform_set_create(uniforms, particles_shader.default_shader_rd, 1);\n \t}\n \n-\tdouble new_phase = Math::fmod((double)p_particles->phase + (p_delta / p_particles->lifetime) * p_particles->speed_scale, 1.0);\n+\tdouble new_phase = Math::fmod((double)p_particles->phase + (p_delta / p_particles->lifetime), 1.0);\n \n \t//move back history (if there is any)\n \tfor (uint32_t i = p_particles->frame_history.size() - 1; i > 0; i--) {\n@@ -839,7 +839,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tp_particles->phase = new_phase;\n \n \tframe_params.time = RendererCompositorRD::get_singleton()->get_total_time();\n-\tframe_params.delta = p_delta * p_particles->speed_scale;\n+\tframe_params.delta = p_delta;\n \tframe_params.random_seed = p_particles->random_seed;\n \tframe_params.explosiveness = p_particles->explosiveness;\n \tframe_params.randomness = p_particles->randomness;\n@@ -1158,6 +1158,10 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \t\t//fill the trail params\n \t\tfor (uint32_t i = 0; i < p_particles->trail_params.size(); i++) {\n \t\t\tuint32_t src_idx = i * p_particles->frame_history.size() / p_particles->trail_params.size();\n+\t\t\tif (p_particles->speed_scale <= 0.0) {\n+\t\t\t\t// Stop trails.\n+\t\t\t\tsrc_idx = 0;\n+\t\t\t}\n \t\t\tp_particles->trail_params[i] = p_particles->frame_history[src_idx];\n \t\t}\n \t} else {\n@@ -1529,7 +1533,6 @@ void ParticlesStorage::update_particles() {\n \t\t\t}\n \t\t}\n \n-\t\tbool zero_time_scale = Engine::get_singleton()->get_time_scale() <= 0.0;\n \t\tdouble todo = particles->request_process_time;\n \t\tif (particles->clear) {\n \t\t\ttodo += particles->pre_process_time;\n@@ -1554,37 +1557,26 @@ void ParticlesStorage::update_particles() {\n \t\t\tparticles->speed_scale = tmp_scale;\n \t\t}\n \n+\t\tdouble time_scale = MAX(particles->speed_scale, 0.0);\n+\n \t\tif (fixed_fps > 0) {\n-\t\t\tdouble frame_time;\n-\t\t\tdouble decr;\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\tframe_time = 0.0;\n-\t\t\t\tdecr = 1.0 / fixed_fps;\n-\t\t\t} else {\n-\t\t\t\tframe_time = 1.0 / fixed_fps;\n-\t\t\t\tdecr = frame_time;\n-\t\t\t}\n+\t\t\tdouble frame_time = 1.0 / fixed_fps;\n \t\t\tdouble delta = RendererCompositorRD::get_singleton()->get_frame_delta_time();\n \t\t\tif (delta > 0.1) { //avoid recursive stalls if fps goes below 10\n \t\t\t\tdelta = 0.1;\n \t\t\t} else if (delta <= 0.0) { //unlikely but..\n \t\t\t\tdelta = 0.001;\n \t\t\t}\n-\t\t\ttodo = particles->frame_remainder + delta;\n+\t\t\ttodo = particles->frame_remainder + delta * time_scale;\n \n \t\t\twhile (todo >= frame_time || particles->clear) {\n \t\t\t\t_particles_process(particles, frame_time);\n-\t\t\t\ttodo -= decr;\n+\t\t\t\ttodo -= frame_time;\n \t\t\t}\n \n \t\t\tparticles->frame_remainder = todo;\n-\n \t\t} else {\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\t_particles_process(particles, 0.0);\n-\t\t\t} else {\n-\t\t\t\t_particles_process(particles, RendererCompositorRD::get_singleton()->get_frame_delta_time());\n-\t\t\t}\n+\t\t\t_particles_process(particles, RendererCompositorRD::get_singleton()->get_frame_delta_time() * time_scale);\n \t\t}\n \n \t\t// Ensure that memory is initialized (the code above should ensure that _particles_process is always called at least once upon clearing).\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\nindex 02b28473951e..6808ebb06376 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n@@ -1275,15 +1275,21 @@ RID TextureStorage::texture_create_from_native_handle(RS::TextureType p_type, Im\n \t\t\tbreak;\n \n \t\tcase Image::FORMAT_ASTC_4x4:\n-\t\tcase Image::FORMAT_ASTC_4x4_HDR:\n \t\t\tformat = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n \t\t\tbreak;\n \n+\t\tcase Image::FORMAT_ASTC_4x4_HDR:\n+\t\t\tformat = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\tbreak;\n+\n \t\tcase Image::FORMAT_ASTC_8x8:\n-\t\tcase Image::FORMAT_ASTC_8x8_HDR:\n \t\t\tformat = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n \t\t\tbreak;\n \n+\t\tcase Image::FORMAT_ASTC_8x8_HDR:\n+\t\t\tformat = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\tbreak;\n+\n \t\tdefault:\n \t\t\t// Arbitrary fallback.\n \t\t\tformat = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n@@ -2197,24 +2203,16 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_ZERO;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_ONE;\n \t\t} break;\n-\t\tcase Image::FORMAT_ASTC_4x4:\n-\t\tcase Image::FORMAT_ASTC_4x4_HDR: {\n+\t\tcase Image::FORMAT_ASTC_4x4: {\n \t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n \t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_4x4) {\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n-\t\t\t\t}\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n \t\t\t} else {\n \t\t\t\t//not supported, reconvert\n \t\t\t\timage->decompress();\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_4x4) {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n-\t\t\t\t} else {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n-\t\t\t\t}\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n+\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n \t\t\t}\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n@@ -2222,24 +2220,31 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n \t\t} break; // astc 4x4\n-\t\tcase Image::FORMAT_ASTC_8x8:\n-\t\tcase Image::FORMAT_ASTC_8x8_HDR: {\n+\t\tcase Image::FORMAT_ASTC_4x4_HDR: {\n+\t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\t} else {\n+\t\t\t\t//not supported, reconvert\n+\t\t\t\timage->decompress();\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n+\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n+\t\t\t}\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n+\n+\t\t} break; // astc 4x4 HDR\n+\t\tcase Image::FORMAT_ASTC_8x8: {\n \t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n \t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_8x8) {\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n-\t\t\t\t}\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n \t\t\t} else {\n \t\t\t\t//not supported, reconvert\n \t\t\t\timage->decompress();\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_8x8) {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n-\t\t\t\t} else {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n-\t\t\t\t}\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n+\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n \t\t\t}\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n@@ -2247,6 +2252,21 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n \t\t} break; // astc 8x8\n+\t\tcase Image::FORMAT_ASTC_8x8_HDR: {\n+\t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\t} else {\n+\t\t\t\t//not supported, reconvert\n+\t\t\t\timage->decompress();\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n+\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n+\t\t\t}\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n+\n+\t\t} break; // astc 8x8 HDR\n \n \t\tdefault: {\n \t\t}\n@@ -2589,7 +2609,7 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break;\n \t\tcase RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK: {\n-\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4_HDR;\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4;\n \t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n \t\t\tr_format.rd_format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n@@ -2597,6 +2617,14 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n+\t\t} break;\n+\t\tcase RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK: {\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4_HDR;\n+\t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break; // astc 4x4\n \t\tcase RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK: {\n \t\t\t// Q: Do we do as we do below, just create the sRGB variant?\n@@ -2608,14 +2636,21 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break;\n \t\tcase RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK: {\n-\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8_HDR;\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8;\n \t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n \t\t\tr_format.rd_format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n-\n+\t\t} break;\n+\t\tcase RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8_HDR;\n+\t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break; // astc 8x8\n \n \t\tdefault: {\ndiff --git a/servers/rendering/renderer_viewport.cpp b/servers/rendering/renderer_viewport.cpp\nindex b816ca7a8ab2..3bbc05b62545 100644\n--- a/servers/rendering/renderer_viewport.cpp\n+++ b/servers/rendering/renderer_viewport.cpp\n@@ -141,12 +141,22 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_OFF;\n \t\t\t}\n \n-\t\t\t// Verify MetalFX upscaling support.\n-\t\t\tif (\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) ||\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL))) {\n-\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported in the current renderer. Falling back to bilinear 3D resolution scaling.\");\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) {\n+\t\t\t\tif (RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\t\t// Prefer MetalFX spatial if it is supported, which will be much more efficient than FSR2,\n+\t\t\t\t\t// as the hardware already will struggle with FSR2.\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling is not supported by the current renderer or hardware. Falling back to MetalFX Spatial scaling.\");\n+\t\t\t\t} else {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported by the current renderer or hardware. Falling back to FSR 2 scaling.\");\n+\t\t\t\t}\n+\t\t\t\tscaling_type = RS::scaling_3d_mode_type(scaling_3d_mode);\n+\t\t\t}\n+\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR;\n+\t\t\t\tWARN_PRINT_ONCE(\"MetalFX spatial upscaling is not supported by the current renderer or hardware. Falling back to FSR scaling.\");\n \t\t\t}\n \n \t\t\tRS::ViewportMSAA msaa_3d = p_viewport->msaa_3d;\n@@ -156,11 +166,9 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tdouble min_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MIN_SCALE) / 1000'000.0;\n \t\t\t\tdouble max_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MAX_SCALE) / 1000'000.0;\n \t\t\t\tif ((double)scaling_3d_scale < min_scale || (double)scaling_3d_scale > max_scale) {\n-\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to bilinear 3D resolution scaling.\", min_scale, max_scale));\n-\t\t\t\t}\n-\n-\t\t\t\tif (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to FSR 2 3D resolution scaling.\", min_scale, max_scale));\n+\t\t\t\t} else if (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n \t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling does not support 3D MSAA. Disabling 3D MSAA internally.\");\n \t\t\t\t\tmsaa_3d = RS::VIEWPORT_MSAA_DISABLED;\n \t\t\t\t}\n@@ -170,7 +178,7 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\tbool use_taa = p_viewport->use_taa;\n \n \t\t\tif (scaling_3d_is_not_bilinear && (scaling_3d_scale >= (1.0 + EPSILON))) {\n-\t\t\t\t// FSR is not designed for downsampling.\n+\t\t\t\t// FSR and MetalFX is not designed for downsampling.\n \t\t\t\t// Fall back to bilinear scaling.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 3D resolution scaling is not designed for downsampling. Falling back to bilinear 3D resolution scaling.\");\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n@@ -184,8 +192,8 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t}\n \n \t\t\tif (use_taa && (scaling_type == RS::VIEWPORT_SCALING_3D_TYPE_TEMPORAL)) {\n-\t\t\t\t// FSR2 can't be used with TAA.\n-\t\t\t\t// Turn it off and prefer using FSR2.\n+\t\t\t\t// Temporal upscalers can't be used with TAA.\n+\t\t\t\t// Turn it off and prefer using the temporal upscaler.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 2 or MetalFX Temporal is not compatible with TAA. Disabling TAA internally.\");\n \t\t\t\tuse_taa = false;\n \t\t\t}\ndiff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9a3e4fd9d7fa..cf6cbf187132 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -7680,6 +7680,20 @@ void RenderingDevice::_bind_methods() {\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16R16_2PLANE_422_UNORM);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_MAX);\n \n #ifndef DISABLE_DEPRECATED\ndiff --git a/servers/rendering/rendering_device_commons.cpp b/servers/rendering/rendering_device_commons.cpp\nindex 03fad5493a01..a11ffe57dd15 100644\n--- a/servers/rendering/rendering_device_commons.cpp\n+++ b/servers/rendering/rendering_device_commons.cpp\n@@ -253,6 +253,20 @@ const char *const RenderingDeviceCommons::FORMAT_NAMES[DATA_FORMAT_MAX] = {\n \t\"G16_B16_R16_3Plane_422_Unorm\",\n \t\"G16_B16R16_2Plane_422_Unorm\",\n \t\"G16_B16_R16_3Plane_444_Unorm\",\n+\t\"Astc_4X4_Sfloat_Block\",\n+\t\"Astc_5X4_Sfloat_Block\",\n+\t\"Astc_5X5_Sfloat_Block\",\n+\t\"Astc_6X5_Sfloat_Block\",\n+\t\"Astc_6X6_Sfloat_Block\",\n+\t\"Astc_8X5_Sfloat_Block\",\n+\t\"Astc_8X6_Sfloat_Block\",\n+\t\"Astc_8X8_Sfloat_Block\",\n+\t\"Astc_10X5_Sfloat_Block\",\n+\t\"Astc_10X6_Sfloat_Block\",\n+\t\"Astc_10X8_Sfloat_Block\",\n+\t\"Astc_10X10_Sfloat_Block\",\n+\t\"Astc_12X10_Sfloat_Block\",\n+\t\"Astc_12X12_Sfloat_Block\",\n };\n \n /*****************/\n@@ -477,6 +491,20 @@ uint32_t RenderingDeviceCommons::get_image_format_pixel_size(DataFormat p_format\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\treturn 1;\n \t\tcase DATA_FORMAT_G8B8G8R8_422_UNORM:\n \t\tcase DATA_FORMAT_B8G8R8G8_422_UNORM:\n@@ -554,42 +582,56 @@ void RenderingDeviceCommons::get_compressed_image_format_block_dimensions(DataFo\n \t\tcase DATA_FORMAT_EAC_R11G11_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_EAC_R11G11_SNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_4x4_UNORM_BLOCK: // Again, not sure about astc.\n-\t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK: {\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_5x4_UNORM_BLOCK: // Unsupported\n \t\tcase DATA_FORMAT_ASTC_5x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_UNORM_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK: {\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n \t\t\tr_w = 8;\n \t\t\tr_h = 8;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_10x5_UNORM_BLOCK: // Unsupported\n \t\tcase DATA_FORMAT_ASTC_10x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t\treturn;\n@@ -642,32 +684,46 @@ uint32_t RenderingDeviceCommons::get_compressed_image_format_block_byte_size(Dat\n \t\t\treturn 16;\n \t\tcase DATA_FORMAT_ASTC_4x4_UNORM_BLOCK: // Again, not sure about astc.\n \t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x4_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\treturn 16;\n \t\tdefault: {\n \t\t}\n@@ -691,7 +747,8 @@ uint32_t RenderingDeviceCommons::get_compressed_image_format_pixel_rshift(DataFo\n \t\tcase DATA_FORMAT_EAC_R11_SNORM_BLOCK:\n \t\t\treturn 1;\n \t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n \t\t\treturn 2;\n \t\t}\n \t\tdefault: {\ndiff --git a/servers/rendering/rendering_device_commons.h b/servers/rendering/rendering_device_commons.h\nindex aa8beed35785..796e3c2b66c6 100644\n--- a/servers/rendering/rendering_device_commons.h\n+++ b/servers/rendering/rendering_device_commons.h\n@@ -270,6 +270,20 @@ class RenderingDeviceCommons : public Object {\n \t\tDATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM,\n \t\tDATA_FORMAT_G16_B16R16_2PLANE_422_UNORM,\n \t\tDATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM,\n+\t\tDATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK, // HDR variant.\n \t\tDATA_FORMAT_MAX,\n \t};\n \ndiff --git a/servers/rendering/shader_language.cpp b/servers/rendering/shader_language.cpp\nindex 59adb53b7866..66a43684a52a 100644\n--- a/servers/rendering/shader_language.cpp\n+++ b/servers/rendering/shader_language.cpp\n@@ -1342,7 +1342,7 @@ void ShaderLanguage::_parse_used_identifier(const StringName &p_identifier, Iden\n \t\t\tbreak;\n \t\tcase IdentifierType::IDENTIFIER_VARYING:\n \t\t\tif (HAS_WARNING(ShaderWarning::UNUSED_VARYING_FLAG) && used_varyings.has(p_identifier)) {\n-\t\t\t\tif (shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_VERTEX && shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_FRAGMENT) {\n+\t\t\t\tif (shader->varyings[p_identifier].stage == ShaderNode::Varying::STAGE_UNKNOWN) {\n \t\t\t\t\tused_varyings[p_identifier].used = true;\n \t\t\t\t}\n \t\t\t}\n@@ -6510,6 +6510,27 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t_set_error(RTR(\"Expected constant expression.\"));\n \t\t\t\t\t\treturn nullptr;\n \t\t\t\t\t}\n+\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n+\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n+\t\t\t\t\t\treturn nullptr;\n+\t\t\t\t\t}\n+#ifdef DEBUG_ENABLED\n+\t\t\t\t\tif (check_warnings) {\n+\t\t\t\t\t\tStringName func_name;\n+\t\t\t\t\t\tBlockNode *b = p_block;\n+\n+\t\t\t\t\t\twhile (b) {\n+\t\t\t\t\t\t\tif (b->parent_function) {\n+\t\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n+\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tb = b->parent_block;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n+\t\t\t\t\t}\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (ident_type == IDENTIFIER_VARYING) {\n \t\t\t\t\t\tTkPos prev_pos = _get_tkpos();\n \t\t\t\t\t\tToken next_token = _get_token();\n@@ -6542,11 +6563,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-\n-\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n-\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n-\t\t\t\t\t\treturn nullptr;\n-\t\t\t\t\t}\n #ifdef DEBUG_ENABLED\n \t\t\t\t\tif (check_position_write && ident_type == IDENTIFIER_BUILTIN_VAR) {\n \t\t\t\t\t\tif (String(identifier) == \"POSITION\") {\n@@ -6564,7 +6580,7 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t_set_tkpos(prev_pos);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-#endif\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (is_const) {\n \t\t\t\t\t\tlast_type = IDENTIFIER_CONSTANT;\n \t\t\t\t\t} else {\n@@ -6656,23 +6672,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\tvarname->is_local = is_local;\n \t\t\t\t\texpr = varname;\n \t\t\t\t}\n-#ifdef DEBUG_ENABLED\n-\t\t\t\tif (check_warnings) {\n-\t\t\t\t\tStringName func_name;\n-\t\t\t\t\tBlockNode *b = p_block;\n-\n-\t\t\t\t\twhile (b) {\n-\t\t\t\t\t\tif (b->parent_function) {\n-\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tb = b->parent_block;\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\n-\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n-\t\t\t\t}\n-#endif // DEBUG_ENABLED\n \t\t\t}\n \t\t} else if (tk.type == TK_OP_ADD) {\n \t\t\tcontinue; //this one does nothing\ndiff --git a/thirdparty/misc/yuv2rgb.h b/thirdparty/misc/yuv2rgb.h\nindex d8f7fd6de2d0..e8ccd427d027 100644\n--- a/thirdparty/misc/yuv2rgb.h\n+++ b/thirdparty/misc/yuv2rgb.h\n@@ -30,6 +30,7 @@ ship it.\n  * 2. At some point or another the code relied on the byte order of a uint32_t, this has been fixed\n  * 3. Output has been reordered to struct { uint8_t r, g, b, a; } precisely in accordance with the function names\n  * 4. Removing unused 'dither' parameter\n+ * 5. Fix last line not being converted (and therefore was transparent)\n  */\n \n #ifndef YUV2RGB_H\n@@ -848,7 +849,6 @@ static void yuv422_2_rgb8888(uint8_t  *dst_ptr,\n \t\t      int32_t   uv_span,\n \t\t      int32_t   dst_span)\n {\n-    height -= 1;\n     while (height > 0)\n     {\n \theight -= width<<16;\n@@ -1020,7 +1020,6 @@ static void yuv444_2_rgb8888(uint8_t  *dst_ptr,\n \t\t      int32_t   uv_span,\n \t\t      int32_t   dst_span)\n {\n-    height -= 1;\n     while (height > 0)\n     {\n \theight -= width<<16;\ndiff --git a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\nindex d29ac01af384..25ce813968f7 100644\n--- a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n+++ b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n@@ -31,11 +31,12 @@\n \n // There are separate versions for each GameSDK component that use this format:\n #define ANDROID_GAMESDK_PACKED_VERSION(MAJOR, MINOR, BUGFIX) \\\n-    ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n+  ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n // Accessors\n #define ANDROID_GAMESDK_MAJOR_VERSION(PACKED) ((PACKED) >> 16)\n #define ANDROID_GAMESDK_MINOR_VERSION(PACKED) (((PACKED) >> 8) & 0xff)\n #define ANDROID_GAMESDK_BUGFIX_VERSION(PACKED) ((PACKED) & 0xff)\n \n-#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX, GIT) \\\n-#MAJOR \".\" #MINOR \".\" #BUGFIX \".\" #GIT\n+#define AGDK_STRINGIFY(NUMBER) #NUMBER\n+#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX) \\\n+  AGDK_STRINGIFY(MAJOR) \".\" AGDK_STRINGIFY(MINOR) \".\" AGDK_STRINGIFY(BUGFIX)\ndiff --git a/thirdparty/swappy-frame-pacing/swappyVk.h b/thirdparty/swappy-frame-pacing/swappyVk.h\nindex 020683cbc43c..654fcbf4a4a7 100644\n--- a/thirdparty/swappy-frame-pacing/swappyVk.h\n+++ b/thirdparty/swappy-frame-pacing/swappyVk.h\n@@ -281,30 +281,30 @@ void SwappyVk_uninjectTracer(const SwappyTracer* tracer);\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyVkFunctionProvider {\n-    /**\n-     * @brief Callback to initialize the function provider.\n-     *\n-     * This function is called by Swappy before any functions are requested.\n-     * E.g. so you can call dlopen on the Vulkan library.\n-     */\n-    bool (*init)();\n-\n-    /**\n-     * @brief Callback to get the address of a function.\n-     *\n-     * This function is called by Swappy to get the address of a Vulkan\n-     * function.\n-     * @param name The null-terminated name of the function.\n-     */\n-    void* (*getProcAddr)(const char* name);\n-\n-    /**\n-     * @brief Callback to close any resources owned by the function provider.\n-     *\n-     * This function is called by Swappy when no more functions will be\n-     * requested, e.g. so you can call dlclose on the Vulkan library.\n-     */\n-    void (*close)();\n+  /**\n+   * @brief Callback to initialize the function provider.\n+   *\n+   * This function is called by Swappy before any functions are requested.\n+   * E.g. so you can call dlopen on the Vulkan library.\n+   */\n+  bool (*init)();\n+\n+  /**\n+   * @brief Callback to get the address of a function.\n+   *\n+   * This function is called by Swappy to get the address of a Vulkan\n+   * function.\n+   * @param name The null-terminated name of the function.\n+   */\n+  void* (*getProcAddr)(const char* name);\n+\n+  /**\n+   * @brief Callback to close any resources owned by the function provider.\n+   *\n+   * This function is called by Swappy when no more functions will be\n+   * requested, e.g. so you can call dlclose on the Vulkan library.\n+   */\n+  void (*close)();\n } SwappyVkFunctionProvider;\n \n /**\n@@ -384,7 +384,8 @@ void SwappyVk_enableStats(VkSwapchainKHR swapchain, bool enabled);\n \n  * @see SwappyVk_enableStats.\n  */\n-void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t image);\n+void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain,\n+                               uint32_t image);\n \n /**\n  * @brief Returns the stats collected, if statistics collection was toggled on.\n@@ -396,11 +397,11 @@ void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t\n  * conditions.\n  *\n  * @param[in]  swapchain   - The swapchain for which stats are being queried.\n- * @param      swappyStats - Pointer to a SwappyStats that will be populated with\n- *                             the collected stats. Cannot be NULL.\n+ * @param      swappyStats - Pointer to a SwappyStats that will be populated\n+ * with the collected stats. Cannot be NULL.\n  * @see SwappyStats\n  */\n-void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n+void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats* swappyStats);\n \n /**\n  * @brief Clears the frame statistics collected so far.\n@@ -413,6 +414,58 @@ void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n  */\n void SwappyVk_clearStats(VkSwapchainKHR swapchain);\n \n+/**\n+ * @brief Reset the swappy pacing mechanism\n+ *\n+ * In cases where the frame timing history is irrelevant (for example during\n+ * scene/level transitions or after loading screens), calling this would\n+ * remove all the history for frame pacing. Calling this entry point\n+ * would reset the frame rate to the initial state at the end of the current\n+ * frame. Then swappy would just pace as normal with fresh state from next\n+ * frame. There are no error conditions associated with this call.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which frame pacing is reset.\n+ */\n+void SwappyVk_resetFramePacing(VkSwapchainKHR swapchain);\n+\n+/**\n+ * @brief Enable/Disable the swappy pacing mechanism\n+ *\n+ * By default frame pacing is enabled when swappy is used, however it can be\n+ * disabled at runtime by calling `SwappyVk_enableFramePacing(swapchain,\n+ * false)`. When the frame pacing is disabled, ::SwappyVk_enableBlockingWait\n+ * will control whether\n+ * ::SwappyVk_queuePresent will return immediately, or will block until the\n+ * previous frame's GPU work is completed. All enabling/disabling effects take\n+ * place from next frame. Once disabled, `SwappyVk_enableFramePacing(swapchain,\n+ * true)` will enable frame pacing again with a fresh frame time state -\n+ * equivalent of calling ::SwappyVk_resetFramePacing().\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, enables frame pacing otherwise disables it\n+ */\n+void SwappyVk_enableFramePacing(VkSwapchainKHR swapchain, bool enable);\n+\n+/**\n+ * @brief Enable/Disable blocking wait when frame-pacing is disabled\n+ *\n+ * By default ::SwappyVk_queuePresent will do a blocking wait until previous\n+ * frame's GPU work is completed. However when frame pacing is disabled, calling\n+ * `SwappyVk_enableBlockingWait(swapchain, false)` will ensure that\n+ * ::SwappyVk_queuePresent returns without waiting for previous frame's GPU\n+ * work. This behaviour impacts the GPU time returned in the\n+ * ::SwappyPostWaitCallback callback. If the last frame's GPU work is done by\n+ * the time ::SwappyVk_queuePresent for this frame is called, then the previous\n+ * frame's GPU time will be returned otherwise `-1` will be delivered in the\n+ * callback for the frame. This setting has no impact when frame pacing is\n+ * enabled.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, ::SwappyVk_queuePresent will block until\n+ * the previous frame's GPU work is complete.\n+ */\n+void SwappyVk_enableBlockingWait(VkSwapchainKHR swapchain, bool enable);\n+\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\ndiff --git a/thirdparty/swappy-frame-pacing/swappy_common.h b/thirdparty/swappy-frame-pacing/swappy_common.h\nindex b711ca910fb3..acceb4243df6 100644\n--- a/thirdparty/swappy-frame-pacing/swappy_common.h\n+++ b/thirdparty/swappy-frame-pacing/swappy_common.h\n@@ -48,22 +48,22 @@\n \n // Internal macros to track Swappy version, do not use directly.\n #define SWAPPY_MAJOR_VERSION 2\n-#define SWAPPY_MINOR_VERSION 0\n+#define SWAPPY_MINOR_VERSION 2\n #define SWAPPY_BUGFIX_VERSION 0\n-#define SWAPPY_PACKED_VERSION                                                  \\\n-    ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n-                                   SWAPPY_BUGFIX_VERSION)\n+#define SWAPPY_PACKED_VERSION                                                \\\n+  ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n+                                 SWAPPY_BUGFIX_VERSION)\n \n // Internal macros to generate a symbol to track Swappy version, do not use\n // directly.\n #define SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n+  PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n #define SWAPPY_VERSION_CONCAT(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n-#define SWAPPY_VERSION_SYMBOL                                          \\\n-    SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n-                          SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n-                          AGDK_GIT_COMMIT)\n+  SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n+#define SWAPPY_VERSION_SYMBOL                                        \\\n+  SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n+                        SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n+                        AGDK_GIT_COMMIT)\n \n // Define this to 1 to enable all logging from Swappy, by default it is\n // disabled in a release build and enabled in a debug build.\n@@ -83,29 +83,29 @@ typedef uint64_t SwappyThreadId;\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyThreadFunctions {\n-    /** @brief Thread start callback.\n-     *\n-     * This function is called by Swappy to start thread_func on a new thread.\n-     * @param user_data A value to be passed the thread function.\n-     * If the thread was started, this function should set the thread_id and\n-     * return 0. If the thread was not started, this function should return a\n-     * non-zero value.\n-     */\n-    int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n-                 void* user_data);\n-\n-    /** @brief Thread join callback.\n-     *\n-     * This function is called by Swappy to join the thread with given id.\n-     */\n-    void (*join)(SwappyThreadId thread_id);\n-\n-    /** @brief Thread joinable callback.\n-     *\n-     * This function is called by Swappy to discover whether the thread with the\n-     * given id is joinable.\n-     */\n-    bool (*joinable)(SwappyThreadId thread_id);\n+  /** @brief Thread start callback.\n+   *\n+   * This function is called by Swappy to start thread_func on a new thread.\n+   * @param user_data A value to be passed the thread function.\n+   * If the thread was started, this function should set the thread_id and\n+   * return 0. If the thread was not started, this function should return a\n+   * non-zero value.\n+   */\n+  int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n+               void* user_data);\n+\n+  /** @brief Thread join callback.\n+   *\n+   * This function is called by Swappy to join the thread with given id.\n+   */\n+  void (*join)(SwappyThreadId thread_id);\n+\n+  /** @brief Thread joinable callback.\n+   *\n+   * This function is called by Swappy to discover whether the thread with the\n+   * given id is joinable.\n+   */\n+  bool (*joinable)(SwappyThreadId thread_id);\n } SwappyThreadFunctions;\n \n #ifdef __cplusplus\n@@ -138,47 +138,46 @@ const char* Swappy_versionString();\n  * ::SwappyGL_enableStats or ::SwappyVk_enableStats.\n  */\n typedef struct SwappyStats {\n-    /** @brief Total frames swapped by swappy */\n-    uint64_t totalFrames;\n-\n-    /** @brief Histogram of the number of screen refreshes a frame waited in the\n-     * compositor queue after rendering was completed.\n-     *\n-     * For example:\n-     *     if a frame waited 2 refresh periods in the compositor queue after\n-     * rendering was done, the frame will be counted in idleFrames[2]\n-     */\n-    uint64_t idleFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * requested presentation time and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the requested\n-     * timestamp swappy set, the frame will be counted in lateFrames[2]\n-     */\n-    uint64_t lateFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between two\n-     * consecutive frames\n-     *\n-     * For example:\n-     *     if frame N was presented 2 refresh periods after frame N-1\n-     *     frame N will be counted in offsetFromPreviousFrame[2]\n-     */\n-    uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * call to Swappy_recordFrameStart and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the call to\n-     * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n-     */\n-    uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n+  /** @brief Total frames swapped by swappy */\n+  uint64_t totalFrames;\n+\n+  /** @brief Histogram of the number of screen refreshes a frame waited in the\n+   * compositor queue after rendering was completed.\n+   *\n+   * For example:\n+   *     if a frame waited 2 refresh periods in the compositor queue after\n+   * rendering was done, the frame will be counted in idleFrames[2]\n+   */\n+  uint64_t idleFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * requested presentation time and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the requested\n+   * timestamp swappy set, the frame will be counted in lateFrames[2]\n+   */\n+  uint64_t lateFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between two\n+   * consecutive frames\n+   *\n+   * For example:\n+   *     if frame N was presented 2 refresh periods after frame N-1\n+   *     frame N will be counted in offsetFromPreviousFrame[2]\n+   */\n+  uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * call to Swappy_recordFrameStart and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the call to\n+   * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n+   */\n+  uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n } SwappyStats;\n \n-\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\n@@ -236,43 +235,43 @@ typedef void (*SwappySwapIntervalChangedCallback)(void*);\n  * Injection of these is optional.\n  */\n typedef struct SwappyTracer {\n-    /**\n-     * Callback called before waiting to queue the frame to the composer.\n-     */\n-    SwappyPreWaitCallback preWait;\n-\n-    /**\n-     * Callback called after wait to queue the frame to the composer is done.\n-     */\n-    SwappyPostWaitCallback postWait;\n-\n-    /**\n-     * Callback called before calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPreSwapBuffersCallback preSwapBuffers;\n-\n-    /**\n-     * Callback called after calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPostSwapBuffersCallback postSwapBuffers;\n-\n-    /**\n-     * Callback called at the start of a frame.\n-     */\n-    SwappyStartFrameCallback startFrame;\n-\n-    /**\n-     * Pointer to some arbitrary data that will be passed as the first argument\n-     * of callbacks.\n-     */\n-    void* userData;\n-\n-    /**\n-     * Callback called when the swap interval was changed.\n-     */\n-    SwappySwapIntervalChangedCallback swapIntervalChanged;\n+  /**\n+   * Callback called before waiting to queue the frame to the composer.\n+   */\n+  SwappyPreWaitCallback preWait;\n+\n+  /**\n+   * Callback called after wait to queue the frame to the composer is done.\n+   */\n+  SwappyPostWaitCallback postWait;\n+\n+  /**\n+   * Callback called before calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPreSwapBuffersCallback preSwapBuffers;\n+\n+  /**\n+   * Callback called after calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPostSwapBuffersCallback postSwapBuffers;\n+\n+  /**\n+   * Callback called at the start of a frame.\n+   */\n+  SwappyStartFrameCallback startFrame;\n+\n+  /**\n+   * Pointer to some arbitrary data that will be passed as the first argument\n+   * of callbacks.\n+   */\n+  void* userData;\n+\n+  /**\n+   * Callback called when the swap interval was changed.\n+   */\n+  SwappySwapIntervalChangedCallback swapIntervalChanged;\n } SwappyTracer;\n \n /** @} */\n", "test_patch": "diff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\nindex abeadbe5eedd..6b4f1b6e8350 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim := $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\nindex d11f81e98537..4b8b001528e9 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim: AnimationPlayer = $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\nindex 4ddfd21ac60f..fb3fe915fd41 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim = $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd b/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\nindex dc7cc9955410..5586317938ee 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\n@@ -1,5 +1,5 @@\n extends Node\n \n func a():\n-    %AnimationPlayer.\u27a1\n+    $UniqueAnimationPlayer.\u27a1\n     pass\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd b/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\nindex 5586317938ee..dc7cc9955410 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\n@@ -1,5 +1,5 @@\n extends Node\n \n func a():\n-    $UniqueAnimationPlayer.\u27a1\n+    %AnimationPlayer.\u27a1\n     pass\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\nsimilarity index 66%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\nindex 402fd1d275de..877ac442a91f 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test := $A\n+@onready var test := $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\nsimilarity index 55%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\nindex 97b288334ed4..0b511e4c72c9 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test := $AnimationPlayer\n+@onready var test := $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\nindex 6188a6e843c0..0dad242872f0 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test = $A\n+@onready var test = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\nindex 80b49439532c..43e6c3bc78f0 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test = $AnimationPlayer\n+@onready var test = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\nindex 7f2cb4e8cc73..f4a0c6d7cec9 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: AnimationPlayer = $AnimationPlayer\n+@onready var test: AnimationPlayer = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\nindex aac450be9f2b..5df4c0ec4c9d 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Node = $A\n+@onready var test: Node = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\nindex 9eb10e49339f..991449d728a5 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Node = $AnimationPlayer\n+@onready var test: Node = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\nindex ff8214c46329..a3cdece9561a 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Area2D = $A\n+@onready var test: Area2D = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\nindex 30cd7d6a21a3..b0c99d4e16a6 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Area2D = $AnimationPlayer\n+@onready var test: Area2D = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/types/local/infered.cfg b/modules/gdscript/tests/scripts/completion/types/local/inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/local/infered.cfg\nrename to modules/gdscript/tests/scripts/completion/types/local/inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/types/local/infered.gd b/modules/gdscript/tests/scripts/completion/types/local/inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/local/infered.gd\nrename to modules/gdscript/tests/scripts/completion/types/local/inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/types/member/infered.cfg b/modules/gdscript/tests/scripts/completion/types/member/inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/member/infered.cfg\nrename to modules/gdscript/tests/scripts/completion/types/member/inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/types/member/infered.gd b/modules/gdscript/tests/scripts/completion/types/member/inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/member/infered.gd\nrename to modules/gdscript/tests/scripts/completion/types/member/inferred.gd\ndiff --git a/modules/gdscript/tests/test_completion.h b/modules/gdscript/tests/test_completion.h\nindex 844c2675e3ea..95201190131d 100644\n--- a/modules/gdscript/tests/test_completion.h\n+++ b/modules/gdscript/tests/test_completion.h\n@@ -161,6 +161,8 @@ static void test_directory(const String &p_dir) {\n \t\t\t\towner = scene->get_node(conf.get_value(\"input\", \"node_path\", \".\"));\n \t\t\t}\n \n+\t\t\t// The only requirement is for the script to be parsable, warnings and errors from the analyzer might happen and completion should still work.\n+\t\t\tERR_PRINT_OFF;\n \t\t\tif (owner != nullptr) {\n \t\t\t\t// Remove the line which contains the sentinel char, to get a valid script.\n \t\t\t\tRef<GDScript> scr;\n@@ -184,6 +186,8 @@ static void test_directory(const String &p_dir) {\n \t\t\t}\n \n \t\t\tGDScriptLanguage::get_singleton()->complete_code(code, res_path, owner, &options, forced, call_hint);\n+\t\t\tERR_PRINT_ON;\n+\n \t\t\tString contains_excluded;\n \t\t\tfor (ScriptLanguage::CodeCompletionOption &option : options) {\n \t\t\t\tfor (const Dictionary &E : exclude) {\ndiff --git a/tests/core/templates/test_a_hash_map.h b/tests/core/templates/test_a_hash_map.h\nindex 4fa6d3bca41c..6e60addc6046 100644\n--- a/tests/core/templates/test_a_hash_map.h\n+++ b/tests/core/templates/test_a_hash_map.h\n@@ -235,9 +235,13 @@ TEST_CASE(\"[AHashMap] Insert, iterate and remove many elements\") {\n TEST_CASE(\"[AHashMap] Insert, iterate and remove many strings\") {\n \tconst int elem_max = 432;\n \tAHashMap<String, String> map;\n+\n+\t// To not print WARNING: Excessive collision count (NN), is the right hash function being used?\n+\tERR_PRINT_OFF;\n \tfor (int i = 0; i < elem_max; i++) {\n \t\tmap.insert(itos(i), itos(i));\n \t}\n+\tERR_PRINT_ON;\n \n \t//insert order should have been kept\n \tint idx = 0;\ndiff --git a/tests/scene/test_code_edit.h b/tests/scene/test_code_edit.h\nindex 1c85d3e41c36..de55fc709603 100644\n--- a/tests/scene/test_code_edit.h\n+++ b/tests/scene/test_code_edit.h\n@@ -4492,7 +4492,8 @@ TEST_CASE(\"[SceneTree][CodeEdit] symbol lookup\") {\n \n \t\tPoint2 caret_pos = code_edit->get_caret_draw_pos();\n \t\tcaret_pos.x += 60;\n-\t\tSEND_GUI_MOUSE_BUTTON_EVENT(caret_pos, MouseButton::NONE, 0, Key::NONE);\n+\n+\t\tSEND_GUI_MOUSE_MOTION_EVENT(caret_pos, MouseButtonMask::NONE, Key::NONE);\n \t\tCHECK(code_edit->get_text_for_symbol_lookup() == \"this is s\" + String::chr(0xFFFF) + \"ome text\");\n \n \t\tSIGNAL_WATCH(code_edit, \"symbol_validate\");\ndiff --git a/tests/scene/test_text_edit.h b/tests/scene/test_text_edit.h\nindex d7192def6212..aa7a9bb23c40 100644\n--- a/tests/scene/test_text_edit.h\n+++ b/tests/scene/test_text_edit.h\n@@ -8014,6 +8014,8 @@ TEST_CASE(\"[SceneTree][TextEdit] gutters\") {\n \tSIGNAL_WATCH(text_edit, \"gutter_removed\");\n \n \tSUBCASE(\"[TextEdit] gutter add and remove\") {\n+\t\ttext_edit->set_text(\"test1\\ntest2\\ntest3\\ntest4\");\n+\n \t\ttext_edit->add_gutter();\n \t\tCHECK(text_edit->get_gutter_count() == 1);\n \t\tCHECK(text_edit->get_gutter_width(0) == 24);\ndiff --git a/tests/test_main.cpp b/tests/test_main.cpp\nindex c12e92708177..2d8f2c769155 100644\n--- a/tests/test_main.cpp\n+++ b/tests/test_main.cpp\n@@ -306,7 +306,7 @@ struct GodotTestCaseListener : public doctest::IReporter {\n \t\t\t// So we have to do this for each test case. Also make sure there is\n \t\t\t// no residual theme from something else.\n \t\t\tThemeDB::get_singleton()->finalize_theme();\n-\t\t\tThemeDB::get_singleton()->initialize_theme_noproject();\n+\t\t\tThemeDB::get_singleton()->initialize_theme();\n \n #ifndef _3D_DISABLED\n \t\t\tphysics_server_3d = PhysicsServer3DManager::get_singleton()->new_default_server();\n", "problem_statement": "Gray line at the bottom of scaled VideoStreamPlayer\n### Tested versions\n\nGodot Engine v4.2.1.stable.official.b09f793f5 - https://godotengine.org\r\n\r\n\n\n### System information\n\nLinux; Vulkan API 1.3.255 - Forward+ - Using Vulkan Device #0: AMD - AMD Radeon RX 5600 XT (RADV NAVI10)  \n\n### Issue description\n\nWhen have a VideoStreamPlayer that's scaled down (in my case, to 50%), when the video plays, it shows a gray line at the bottom.  The gray line is not visible when I play the video at 1:1 scale.\r\n\r\nI don't think this is the same as #62752 -- first, I think my video doesn't have any overscan since its resolution is a multiple of 16, and second, it doesn't manifest as duplication but as a grey line.\r\n\r\n![gray-line](https://github.com/godotengine/godot/assets/77003/13a89274-61ea-4d83-a44f-52dc807e4e7f)\r\n\r\nWeirdly, it seems to depend on some tiny details of the video file.  I have one video file which experiences it, and one that doesn't even though both are the same resolution, frame rate, etc.  The one with the line is made by:\r\n`ffmpeg -r 30  -pattern_type sequence -i out/cat-%06d.png    -map 0:v  -y  cat.ogv`\r\nThe one without is made by:\r\n`theora_png2theora -k 30 -f 30 out/cat-%06d.png -o cat2.ogv`\r\n\r\nUnfortunately, as you can see, the second one produces a video with the wrong color (and I have to run it through ffmpeg anyway to get the audio added; to save you from having to hear my awful voice acting looping over and over, I didn't add the audio to either of the clips in the repro project).  \n\n### Steps to reproduce\n\nThe attached sample code reproduces this issue.  I have a VideoStreamPlayer which is scaled (in this case, the root node is scaled, because that pretty closely matches my actual project).   There are actually two players, to demonstrate that the effect depends on some weird detail of the actual video; the one on the left is the one with the problem (the color mismatch on the right is Theora's fault not Godot's).\n\n### Minimal reproduction project (MRP)\n\n[white-line.zip](https://github.com/godotengine/godot/files/14086142/white-line.zip)\r\n\nMetalFX Temporal upscaling fallback on non-supported rendering drivers does not disable TAA jitter (or fallback to FSR2)\n### Tested versions\n\n- Reproducible in: 4.4.stable\n- MetalFX is not available before 4.4.\n\n### System information\n\nGodot v4.4.stable (4c311cbee) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4090 (nvidia; 570.86.16) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nWhen attempting to use MetalFX Temporal upscaling on an unsupported rendering driver, the TAA jitter is still active despite not being needed with bilinear scaling. MetalFX Spatial upscaling doesn't have this issue, as it doesn't engage TAA jitter in the first place due to its purely spatial nature.\n\nAlternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\ncc @stuartcarnie \n\nhttps://github.com/user-attachments/assets/bde8cd82-63ba-4f82-ba59-0be8e46ea63c\n\n### Steps to reproduce\n\n- Create a project using the Forward+ rendering method.\n- Set the root viewport's 3D scaling mode to MetalFX Temporal using a script on a platform/renderer that doesn't support MetalFX upscaling (Windows, Linux, or macOS when using MoltenVK):\n```gdscript\nfunc _ready() -> void:\n    get_window().scaling_3d_mode = Viewport.SCALING_3D_MODE_METALFX_TEMPORAL\n```\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/godotengine/tps-demo/pull/196\n*Change the check in the demo's code from `== \"metal\"` to `!= \"metal` to test this on unsupported drivers. I suggest using the Ultra Performance scaling mode so the issue is more noticeable.*\n", "hints_text": "I've fixed #62752 and this still happens so I don't think they're related at all.\nIt only happens when texture filter is set to linear. Setting the filter to nearest removes the gray line.\n\nIt's weird that it happens only in one of the videos but the background color is different so that might be the reason.\nVideo on the left with the gray line:\n\n```\n\u276f ffprobe cat.ogv                                                                                  \nInput #0, ogg, from 'cat.ogv':\n  Duration: 00:00:05.73, start: 0.000000, bitrate: 216 kb/s\n  Stream #0:0: Video: theora, yuv444p, 256x256 [SAR 1:1 DAR 1:1], 30 tbr, 30 tbn\n      Metadata:\n        encoder         : Lavc60.31.102 libtheora\n```\n\nVideo on the right (which renders correctly in Godot):\n\n```\n\u276f ffprobe cat2.ogv\n[ogg @ 0x559083ead180] Broken file, keyframe not correctly marked.\nInput #0, ogg, from 'cat2.ogv':\n  Duration: 00:00:05.77, start: 0.000000, bitrate: 65 kb/s\n  Stream #0:0: Video: theora, yuv420p, 256x256, 30 tbr, 30 tbn\n```\n", "created_at": "2025-03-12 12:00:24", "merge_commit_sha": "cc77c02d4756e9cf52637450dec6173c25a391c2", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103999", "base_commit": "7893202fba0e8ec69375fd0c376203cb7544e8f7", "patch": "diff --git a/core/variant/array.cpp b/core/variant/array.cpp\nindex d91612b420ca..2357e3f907ab 100644\n--- a/core/variant/array.cpp\n+++ b/core/variant/array.cpp\n@@ -88,11 +88,11 @@ Array::Iterator Array::end() {\n }\n \n Array::ConstIterator Array::begin() const {\n-\treturn ConstIterator(_p->array.ptr(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr());\n }\n \n Array::ConstIterator Array::end() const {\n-\treturn ConstIterator(_p->array.ptr() + _p->array.size(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr() + _p->array.size());\n }\n \n Variant &Array::operator[](int p_idx) {\n@@ -104,10 +104,6 @@ Variant &Array::operator[](int p_idx) {\n }\n \n const Variant &Array::operator[](int p_idx) const {\n-\tif (unlikely(_p->read_only)) {\n-\t\t*_p->read_only = _p->array[p_idx];\n-\t\treturn *_p->read_only;\n-\t}\n \treturn _p->array[p_idx];\n }\n \ndiff --git a/core/variant/array.h b/core/variant/array.h\nindex 841b6ff8eaa4..a796a2581171 100644\n--- a/core/variant/array.h\n+++ b/core/variant/array.h\n@@ -56,21 +56,19 @@ class Array {\n \t\t_FORCE_INLINE_ bool operator==(const ConstIterator &p_other) const { return element_ptr == p_other.element_ptr; }\n \t\t_FORCE_INLINE_ bool operator!=(const ConstIterator &p_other) const { return element_ptr != p_other.element_ptr; }\n \n-\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr, Variant *p_read_only = nullptr) :\n-\t\t\t\telement_ptr(p_element_ptr), read_only(p_read_only) {}\n+\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr) :\n+\t\t\t\telement_ptr(p_element_ptr) {}\n \t\t_FORCE_INLINE_ ConstIterator() {}\n \t\t_FORCE_INLINE_ ConstIterator(const ConstIterator &p_other) :\n-\t\t\t\telement_ptr(p_other.element_ptr), read_only(p_other.read_only) {}\n+\t\t\t\telement_ptr(p_other.element_ptr) {}\n \n \t\t_FORCE_INLINE_ ConstIterator &operator=(const ConstIterator &p_other) {\n \t\t\telement_ptr = p_other.element_ptr;\n-\t\t\tread_only = p_other.read_only;\n \t\t\treturn *this;\n \t\t}\n \n \tprivate:\n \t\tconst Variant *element_ptr = nullptr;\n-\t\tVariant *read_only = nullptr;\n \t};\n \n \tstruct Iterator {\n@@ -96,7 +94,7 @@ class Array {\n \t\t}\n \n \t\toperator ConstIterator() const {\n-\t\t\treturn ConstIterator(element_ptr, read_only);\n+\t\t\treturn ConstIterator(element_ptr);\n \t\t}\n \n \tprivate:\ndiff --git a/core/variant/variant.h b/core/variant/variant.h\nindex e38f7c9b0bae..f0bd7ec6824e 100644\n--- a/core/variant/variant.h\n+++ b/core/variant/variant.h\n@@ -997,18 +997,10 @@ Array::Iterator &Array::Iterator::operator--() {\n }\n \n const Variant &Array::ConstIterator::operator*() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn *read_only;\n-\t}\n \treturn *element_ptr;\n }\n \n const Variant *Array::ConstIterator::operator->() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn read_only;\n-\t}\n \treturn element_ptr;\n }\n \n", "test_patch": "", "problem_statement": "Callable.callv() will make call with wrong arguments if a const Array is passed\n### Tested versions\r\n\r\n- Reproducible in 4.3.beta2.official [b75f0485b]\r\n\r\n### System information\r\n\r\nWindows 10 - Godot 4.3.beta2.official [b75f0485b]\r\n\r\n### Issue description\r\n\r\nUsing Callable().callv() will result in a call using the wrong arguments, if the Array being passed is a const.\r\nThe bug does not occur if the Array being passed is a var.\r\nThe bug does not occur if we use Callable().bindv().call() instead.\r\n\r\n### Steps to reproduce\r\n\r\nThe following code can demonstrate the bug. The debugger does not show any errors or warnings.\r\n```extends Node2D\r\n\r\nconst arr_const = ['one','two','three','four']\r\nvar arr_var = ['one','two','three','four']\r\n\r\nfunc _ready() -> void:\r\n\t# non-const works\r\n\tsomefunc.callv(arr_var)\r\n\t# const fails\r\n\tsomefunc.callv(arr_const)\r\n\t# temporary workaround\r\n\tsomefunc.bindv(arr_const).call()\r\n\t\r\nfunc somefunc(v1,v2,v3,v4):\r\n\tprint('%s,%s,%s,%s'% [v1,v2,v3,v4])\r\n```\r\nwill print:\r\n```\r\none,two,three,four\r\nfour,four,four,four\r\none,two,three,four\r\n```\r\nThe first and third calls work as expected, with the four arguments in the arrays.\r\nOnly the second call, which used a const Array and .callv(), made a call with all arguments replaced by the last argument.\r\n\r\nIn this example, I use a function directly, but this can be reproduced with any Callable().\r\n\r\nThis seems like a similar issue as #69237, with a similar workaround, but in this case the correct number of arguments was passed.\r\n\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[callablecheck.zip](https://github.com/user-attachments/files/15974691/callablecheck.zip)\r\n\n", "hints_text": "Can confirm that this is still happening in `v4.3.stable.mono.official [77dcf97d8]`.\n\nThank you for the tip about `bindv(const_arr).call()`, I was very confused for a hot second after I realized I could make my actions array const only to have movement stop working \ud83e\udd23", "created_at": "2025-03-11 23:28:28", "merge_commit_sha": "7f6a9380a08557a3e4d91f8767edd299bf696d76", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103805", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex e65f894c549f..5a3a651fcd9d 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -4662,6 +4662,12 @@ void Main::cleanup(bool p_force) {\n \tResourceSaver::remove_custom_savers();\n \tPropertyListHelper::clear_base_helpers();\n \n+\t// Remove the lock file if the engine exits successfully. Some automated processes such as\n+\t// --export/--import can bypass and/or finish faster than the existing check to remove the lock file.\n+\tif (OS::get_singleton()->get_exit_code() == EXIT_SUCCESS) {\n+\t\tOS::get_singleton()->remove_lock_file();\n+\t}\n+\n \t// Flush before uninitializing the scene, but delete the MessageQueue as late as possible.\n \tmessage_queue->flush();\n \n", "test_patch": "", "problem_statement": "Running with the `--headless` flag does not result in removing the project's recovery mode lock if present\n### Tested versions\n\n4.4.rc1\n\n### System information\n\nGodot v4.4.rc (d91f2cd77) - Windows 11 (build 22631) - Multi-window, 3 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 7900 XT (Advanced Micro Devices, Inc.; 32.0.11037.4004) - AMD Ryzen Threadripper 7970X 32-Cores (64 threads)\n\n### Issue description\n\nRunning with the `--headless flag` does not result in a call to `_remove_lock_file`\n\n### Steps to reproduce\n\nrun any command on a project with the `--headless` flag.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Could you explain what the actual problem is? I assume there's a fault in the code but you don't link to the code you're referring to, and as an issue triager I'm not immediately intimate with what `_remove_lock_file` is, what it's supposed to do and why the absence of calling it would be a problem.\n\nSure, I could spend some time researching it but this is the information a bug report should convey so that contributors can understand a problem (what was expected, what was found, what is the consequence of it) and fix it.\nThe problem is that the lock file is left in place, which leads to a prompt the next time you open the editor. This shouldn't happen.\n[This](https://github.com/godotengine/godot/blame/9f68a816599412c56a4626dd6c47244ebc65ed1f/editor/editor_node.cpp#L1219) is the code I'm referring to.\n`_remove_lock_file` removes the lock file at (on windows) `%appdata%\\Godot\\app_userdata\\PROJECT_NAME\\.recovery_mode_lock`\nIt is used to determine if you should launch in recovery mode.\nThe absence of calling is a problem, because it's indicative of needing to launch in recovery mode.\n\nWhat was expected:\n`_remove_lock_file` is called\nWhat was found:\n`_remove_lock_file` was not called\nConsequence\nThe lock file is not removed, causing an erroneous popup on the next run.\nCC @rsubtil \nAfter staring at this long enough, I wonder if the other timers in this file are even successful. They aren't causing any issues for me presently, but perhaps this is indicative of a bigger issue? In general I wish these timers had more context as to why they're needed and why they have the values they have.\nNote that removing the lock file should only be done when running the editor, not when running the project directly from the command line or project manager.\n\nThis means `--headless` alone should not remove the lock file, but `--headless --editor`, `--headless --import` or `--headless --export` should (`--import` and `--export` both imply `--editor`).\nI've just retested it, and the behavior looks \"mostly\" correct to me on `--headless` mode.\n\nWhen running simply with `--headless` mode, no lock file is created nor removed. This is intended, because this behavior can only occur on editor mode, as @Calinou said. And whenever I do so (`--editor/--import/--export`), the lock file is created, and then eventually deleted. I can't replicate your situation where the timer apparently fails to trigger. I tested this on Linux, so could this be a OS specific bug? Can you provide exact commands of how you're finding this issue?\n\nHowever, when using `--import/--export`, it can happen that each process is finished before the timer is triggered, and the lock file persists after the engine finishes. I can replicate this quite easily on an empty project (since it doesn't have much content to import), so I'll have to account for this scenario too then \ud83d\udc4d.\n\nLastly, to answer your question as to why a timer was used an not a `call_deferred`, it has to do with the order some of these components run. `@tool` scripts run on the next frame, so the first solution used a `call_deferred`. But this fails to catch some scenarios such as `queue_free`ing a editor node, which is delayed another frame. I then added a 2 frame delay, but the issue with this is that the problem just keeps going. Scripts can always be crafted in a way to cause reliable crashes that recovery mode cannot detect, so in the end I chose to instead use a time frame of 1 second instead of engine frames, which starts after the initial import process. It's not a perfect solution, and is essentially a compromise I reached.\nIt seems https://github.com/godotengine/godot/issues/103564 is also related to this, and also happening on Windows, so I'll need to investigate it in there. I can only get a Windows machine on a couple of days though, but once I can test it I'll share my findings.\nThat other issue sounds exactly like my story. I put debug prints in the engine and every time the timer is created, but the method it's supposed to call is not. I run with both `--import` and `--export` and see the same result in both cases. The lock file is created each run, but not removed. When importing I have `godot --import --headless --verbose --quit` I can try running `--import` when I get back to work without `--quit` to see if that makes a difference.\n`--quit` quits after the first process iteration, so that might be why. Try using a larger number of iterations to wait before quitting with `--quit-after N` where N is the number of iterations to wait (start with `2`). Eventually, you should find a large enough value that allows the lock file to be removed.", "created_at": "2025-03-08 11:02:03", "merge_commit_sha": "807ce83f00c14e59dd83d865edf721d90ac9faed", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103792", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/servers/rendering/renderer_viewport.cpp b/servers/rendering/renderer_viewport.cpp\nindex 3a8f445c4be1..45a4ebe1b8a8 100644\n--- a/servers/rendering/renderer_viewport.cpp\n+++ b/servers/rendering/renderer_viewport.cpp\n@@ -145,12 +145,22 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_OFF;\n \t\t\t}\n \n-\t\t\t// Verify MetalFX upscaling support.\n-\t\t\tif (\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) ||\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL))) {\n-\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported in the current renderer. Falling back to bilinear 3D resolution scaling.\");\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) {\n+\t\t\t\tif (RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\t\t// Prefer MetalFX spatial if it is supported, which will be much more efficient than FSR2,\n+\t\t\t\t\t// as the hardware already will struggle with FSR2.\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling is not supported by the current renderer or hardware. Falling back to MetalFX Spatial scaling.\");\n+\t\t\t\t} else {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported by the current renderer or hardware. Falling back to FSR 2 scaling.\");\n+\t\t\t\t}\n+\t\t\t\tscaling_type = RS::scaling_3d_mode_type(scaling_3d_mode);\n+\t\t\t}\n+\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR;\n+\t\t\t\tWARN_PRINT_ONCE(\"MetalFX spatial upscaling is not supported by the current renderer or hardware. Falling back to FSR scaling.\");\n \t\t\t}\n \n \t\t\tRS::ViewportMSAA msaa_3d = p_viewport->msaa_3d;\n@@ -160,11 +170,9 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tdouble min_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MIN_SCALE) / 1000'000.0;\n \t\t\t\tdouble max_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MAX_SCALE) / 1000'000.0;\n \t\t\t\tif ((double)scaling_3d_scale < min_scale || (double)scaling_3d_scale > max_scale) {\n-\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to bilinear 3D resolution scaling.\", min_scale, max_scale));\n-\t\t\t\t}\n-\n-\t\t\t\tif (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to FSR 2 3D resolution scaling.\", min_scale, max_scale));\n+\t\t\t\t} else if (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n \t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling does not support 3D MSAA. Disabling 3D MSAA internally.\");\n \t\t\t\t\tmsaa_3d = RS::VIEWPORT_MSAA_DISABLED;\n \t\t\t\t}\n@@ -174,7 +182,7 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\tbool use_taa = p_viewport->use_taa;\n \n \t\t\tif (scaling_3d_is_not_bilinear && (scaling_3d_scale >= (1.0 + EPSILON))) {\n-\t\t\t\t// FSR is not designed for downsampling.\n+\t\t\t\t// FSR and MetalFX is not designed for downsampling.\n \t\t\t\t// Fall back to bilinear scaling.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 3D resolution scaling is not designed for downsampling. Falling back to bilinear 3D resolution scaling.\");\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n@@ -188,8 +196,8 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t}\n \n \t\t\tif (use_taa && (scaling_type == RS::VIEWPORT_SCALING_3D_TYPE_TEMPORAL)) {\n-\t\t\t\t// FSR2 can't be used with TAA.\n-\t\t\t\t// Turn it off and prefer using FSR2.\n+\t\t\t\t// Temporal upscalers can't be used with TAA.\n+\t\t\t\t// Turn it off and prefer using the temporal upscaler.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 2 or MetalFX Temporal is not compatible with TAA. Disabling TAA internally.\");\n \t\t\t\tuse_taa = false;\n \t\t\t}\n", "test_patch": "", "problem_statement": "MetalFX Temporal upscaling fallback on non-supported rendering drivers does not disable TAA jitter (or fallback to FSR2)\n### Tested versions\n\n- Reproducible in: 4.4.stable\n- MetalFX is not available before 4.4.\n\n### System information\n\nGodot v4.4.stable (4c311cbee) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4090 (nvidia; 570.86.16) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nWhen attempting to use MetalFX Temporal upscaling on an unsupported rendering driver, the TAA jitter is still active despite not being needed with bilinear scaling. MetalFX Spatial upscaling doesn't have this issue, as it doesn't engage TAA jitter in the first place due to its purely spatial nature.\n\nAlternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\ncc @stuartcarnie \n\nhttps://github.com/user-attachments/assets/bde8cd82-63ba-4f82-ba59-0be8e46ea63c\n\n### Steps to reproduce\n\n- Create a project using the Forward+ rendering method.\n- Set the root viewport's 3D scaling mode to MetalFX Temporal using a script on a platform/renderer that doesn't support MetalFX upscaling (Windows, Linux, or macOS when using MoltenVK):\n```gdscript\nfunc _ready() -> void:\n    get_window().scaling_3d_mode = Viewport.SCALING_3D_MODE_METALFX_TEMPORAL\n```\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/godotengine/tps-demo/pull/196\n*Change the check in the demo's code from `== \"metal\"` to `!= \"metal` to test this on unsupported drivers. I suggest using the Ultra Performance scaling mode so the issue is more noticeable.*\n", "hints_text": "> Alternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\nI like this too \u2013 I'll implement that solution.", "created_at": "2025-03-08 04:39:12", "merge_commit_sha": "3b66cb5f8dee1ff3af432388671629a13a481309", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103788", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/platform/macos/godot_content_view.mm b/platform/macos/godot_content_view.mm\nindex eff33208db4b..4e7fc2180cb9 100644\n--- a/platform/macos/godot_content_view.mm\n+++ b/platform/macos/godot_content_view.mm\n@@ -622,7 +622,7 @@ - (void)updateTrackingAreas {\n \t\t[self removeTrackingArea:tracking_area];\n \t}\n \n-\tNSTrackingAreaOptions options = NSTrackingMouseEnteredAndExited | NSTrackingActiveInKeyWindow | NSTrackingCursorUpdate | NSTrackingInVisibleRect;\n+\tNSTrackingAreaOptions options = NSTrackingMouseEnteredAndExited | NSTrackingActiveWhenFirstResponder | NSTrackingCursorUpdate | NSTrackingInVisibleRect;\n \ttracking_area = [[NSTrackingArea alloc] initWithRect:[self bounds] options:options owner:self userInfo:nil];\n \n \t[self addTrackingArea:tracking_area];\n", "test_patch": "", "problem_statement": "Documentation tooltip disappears when you move the mouse - 4.4 dev7\n### Tested versions\n\nGodot 4.4 Dev 7 (MACOS mono build)\n\n### System information\n\nMacOS Sequoia 15.2 running on an M1 Pro\n\n### Issue description\n\nSeveral issues:\n\n1) Tooltip disappears when you move your mouse over it. It should persist instead, and only fade out after like 0.5ms or a second when the mouse is no longer over the tooltip.\n2) Cannot click on any hyperlinks within the tooltip, for example in the video I cannot click on the Color Cheatsheet web link on the bottom\n3) Cannot scroll down\n4) It would be nice to be able to click on documentation links within the tooltip, for example hovering over @export_range, we should be able to also click on the PROPERTY_HINT_RANGE link that comes under \"See also\" in the documentation.\n\nI'm running on an M1 Pro with macOS Sequoia 15.2. Single window mode was off when the issues occurred. With this mode on I still have the same issues.\n\n### Steps to reproduce\n\nJust hover over a keyword and you will notice all the mentioned issues.\n\nhttps://github.com/user-attachments/assets/689e6cf7-392e-4dae-a2e0-9f9a811bbc90\n\n\n### Minimal reproduction project (MRP)\n\nNA\n", "hints_text": "I would like to add to it and say that the Vertical scroll bar Documentation Tooltip doesn't seem to work.\nPlease write what operating system and display manager (X11 and Wayland for Linux) you are using, this may be a platform-specific bug. And whether you are using single window mode (editor setting `interface/editor/single_window_mode`).\n> Please write what operating system and display manager (X11 and Wayland for Linux) you are using, this may be a platform-specific bug. And whether you are using single window mode (editor setting `interface/editor/single_window_mode`).\n\nI'm running on an M1 Pro with macOS Sequoia 15.2. Single window mode was off when the issues occurred. With this mode on I still have the same issues.\n\nOh yeah, what's the difference between the two modes anyway?\nI don't have this bugs on windows 10, maybe OS related.\n\nhttps://github.com/user-attachments/assets/93a1ce4e-d252-4616-ae04-d37b2a3e5a2d\n\nGodot v4.4.dev7 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated AMD Radeon RX 580 2048SP (Advanced Micro Devices, Inc.; 31.0.21921.1000) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n> Please write what operating system and display manager (X11 and Wayland for Linux) you are using, this may be a platform-specific bug. And whether you are using single window mode (editor setting `interface/editor/single_window_mode`).\n\nHere you go, my system info. And yes, since I'm on a laptop, `Single Window Mode` is what I have always enabled.\n\n```\nSystem:\n  Kernel: 6.8.0-51-generic arch: x86_64 bits: 64 compiler: gcc v: 13.3.0 clocksource: tsc\n  Desktop: Cinnamon v: 6.2.9 tk: GTK v: 3.24.41 wm: Muffin v: 6.2.0 vt: 7 dm: LightDM v: 1.30.0\n    Distro: Linux Mint 22 Wilma base: Ubuntu 24.04 noble\nMachine:\n  Type: Laptop System: LENOVO product: 80SL v: Lenovo ideapad 310-14ISK\n    serial: <superuser required> Chassis: type: 10 v: Lenovo ideapad 310-14ISK\n    serial: <superuser required>\n  Mobo: LENOVO model: Toronto 4A2 v: SDK0J40688 WIN serial: <superuser required>\n    part-nu: LENOVO_MT_80SL_BU_idea_FM_Lenovo ideapad 310-14ISK uuid: <superuser required>\n    UEFI: LENOVO v: 0XCN20WW date: 02/19/2016\nBattery:\n  ID-1: BAT0 charge: 24.1 Wh (94.5%) condition: 25.5/30.0 Wh (84.9%) power: 4.1 W volts: 8.3\n    min: 7.4 model: SMP L15M2PB2 type: Li-poly serial: <filter> status: charging\nCPU:\n  Info: dual core model: Intel Core i7-6500U bits: 64 type: MT MCP smt: enabled arch: Skylake\n    rev: 3 cache: L1: 128 KiB L2: 512 KiB L3: 4 MiB\n  Speed (MHz): avg: 2787 min/max: 400/3100 cores: 1: 2787 2: 2787 3: 2787 4: 2787 bogomips: 20799\n  Flags: avx avx2 ht lm nx pae sse sse2 sse3 sse4_1 sse4_2 ssse3 vmx\nGraphics:\n  Device-1: Intel Skylake GT2 [HD Graphics 520] vendor: Lenovo driver: i915 v: kernel arch: Gen-9\n    ports: active: eDP-1 empty: DP-1,HDMI-A-1,HDMI-A-2 bus-ID: 00:02.0 chip-ID: 8086:1916\n    class-ID: 0300\n  Device-2: NVIDIA GM108M [GeForce 920MX] vendor: Lenovo driver: nvidia v: 550.120 arch: Maxwell\n    pcie: speed: 2.5 GT/s lanes: 4 bus-ID: 03:00.0 chip-ID: 10de:134f class-ID: 0302\n  Device-3: Chicony EasyCamera driver: uvcvideo type: USB rev: 2.0 speed: 480 Mb/s lanes: 1\n    bus-ID: 1-4:2 chip-ID: 04f2:b57d class-ID: 0e02 serial: <filter>\n  Display: x11 server: X.Org v: 21.1.11 with: Xwayland v: 23.2.6 driver: X:\n    loaded: modesetting,nvidia unloaded: fbdev,nouveau,vesa dri: iris gpu: i915 display-ID: :0\n    screens: 1\n  Screen-1: 0 s-res: 1366x768 s-dpi: 98 s-size: 355x199mm (13.98x7.83\") s-diag: 407mm (16.02\")\n  Monitor-1: eDP-1 model: BOE Display 0x0698 res: 1366x768 hz: 60 dpi: 112\n    size: 309x173mm (12.17x6.81\") diag: 354mm (13.9\") modes: 1366x768\n  API: EGL v: 1.5 hw: drv: intel iris drv: nvidia platforms: device: 0 drv: nvidia device: 1\n    drv: iris device: 3 drv: swrast surfaceless: drv: nvidia x11: drv: iris\n    inactive: gbm,wayland,device-2\n  API: OpenGL v: 4.6.0 compat-v: 4.5 vendor: intel mesa v: 24.0.9-0ubuntu0.3 glx-v: 1.4\n    direct-render: yes renderer: Mesa Intel HD Graphics 520 (SKL GT2) device-ID: 8086:1916\nAudio:\n  Device-1: Intel Sunrise Point-LP HD Audio vendor: Lenovo driver: snd_hda_intel v: kernel\n    bus-ID: 00:1f.3 chip-ID: 8086:9d70 class-ID: 0403\n  API: ALSA v: k6.8.0-51-generic status: kernel-api\n  Server-1: PipeWire v: 1.0.5 status: active with: 1: pipewire-pulse status: active\n    2: wireplumber status: active 3: pipewire-alsa type: plugin\nNetwork:\n  Device-1: Realtek RTL8111/8168/8211/8411 PCI Express Gigabit Ethernet\n    vendor: Lenovo RTL8111/8168/8411 driver: r8169 v: kernel pcie: speed: 2.5 GT/s lanes: 1\n    port: 4000 bus-ID: 01:00.0 chip-ID: 10ec:8168 class-ID: 0200\n  IF: enp1s0 state: down mac: <filter>\n  Device-2: Intel Dual Band Wireless-AC 3165 Plus Bluetooth driver: iwlwifi v: kernel pcie:\n    speed: 2.5 GT/s lanes: 1 bus-ID: 02:00.0 chip-ID: 8086:3166 class-ID: 0280\n  IF: wlp2s0 state: up mac: <filter>\nBluetooth:\n  Device-1: Intel Bluetooth wireless interface driver: btusb v: 0.8 type: USB rev: 2.0\n    speed: 12 Mb/s lanes: 1 bus-ID: 1-7:4 chip-ID: 8087:0a2a class-ID: e001\n  Report: hciconfig ID: hci0 rfk-id: 2 state: down bt-service: enabled,running rfk-block:\n    hardware: no software: yes address: <filter>\nDrives:\n  Local Storage: total: 931.51 GiB used: 25.72 GiB (2.8%)\n  ID-1: /dev/sda vendor: Western Digital model: WD10JPCX-24UE4T0 size: 931.51 GiB speed: 6.0 Gb/s\n    tech: HDD rpm: 5400 serial: <filter> fw-rev: 1A01 scheme: GPT\nPartition:\n  ID-1: / size: 460.31 GiB used: 25.67 GiB (5.6%) fs: ext4 dev: /dev/sda8\n  ID-2: /boot/efi size: 256 MiB used: 58.5 MiB (22.9%) fs: vfat dev: /dev/sda1\nSwap:\n  ID-1: swap-1 type: partition size: 977 MiB used: 0 KiB (0.0%) priority: -2 dev: /dev/sda4\nUSB:\n  Hub-1: 1-0:1 info: hi-speed hub with single TT ports: 12 rev: 2.0 speed: 480 Mb/s lanes: 1\n    chip-ID: 1d6b:0002 class-ID: 0900\n  Device-1: 1-3:5 info: USB OPTICAL MOUSE type: mouse driver: hid-generic,usbhid interfaces: 1\n    rev: 1.1 speed: 1.5 Mb/s lanes: 1 power: 100mA chip-ID: 0000:3825 class-ID: 0301\n  Device-2: 1-4:2 info: Chicony EasyCamera type: video driver: uvcvideo interfaces: 2 rev: 2.0\n    speed: 480 Mb/s lanes: 1 power: 500mA chip-ID: 04f2:b57d class-ID: 0e02 serial: <filter>\n  Device-3: 1-5:3 info: Realtek RTS5129 Card Reader Controller type: <vendor specific>\n    driver: rtsx_usb,rtsx_usb_ms,rtsx_usb_sdmmc interfaces: 1 rev: 2.0 speed: 480 Mb/s lanes: 1\n    power: 500mA chip-ID: 0bda:0129 class-ID: ff00 serial: <filter>\n  Device-4: 1-7:4 info: Intel Bluetooth wireless interface type: bluetooth driver: btusb\n    interfaces: 2 rev: 2.0 speed: 12 Mb/s lanes: 1 power: 100mA chip-ID: 8087:0a2a class-ID: e001\n  Hub-2: 2-0:1 info: super-speed hub ports: 6 rev: 3.0 speed: 5 Gb/s lanes: 1 chip-ID: 1d6b:0003\n    class-ID: 0900\nSensors:\n  System Temperatures: cpu: 46.0 C pch: 40.5 C mobo: N/A\n  Fan Speeds (rpm): N/A\nRepos:\n  Packages: pm: dpkg pkgs: 2087\n  No active apt repos in: /etc/apt/sources.list\n  Active apt repos in: /etc/apt/sources.list.d/official-package-repositories.list\n    1: deb http: //packages.linuxmint.com wilma main upstream import backport\n    2: deb http: //archive.ubuntu.com/ubuntu noble main restricted universe multiverse\n    3: deb http: //archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse\n    4: deb http: //archive.ubuntu.com/ubuntu noble-backports main restricted universe multiverse\n    5: deb http: //security.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse\n  Active apt repos in: /etc/apt/sources.list.d/vscode.list\n    1: deb [arch=amd64,arm64,armhf] https: //packages.microsoft.com/repos/code stable main\nInfo:\n  Memory: total: 8 GiB available: 7.66 GiB used: 2.52 GiB (32.9%)\n  Processes: 242 Power: uptime: 33m states: freeze,mem,disk suspend: deep wakeups: 0\n    hibernate: platform Init: systemd v: 255 target: graphical (5) default: graphical\n  Compilers: gcc: 13.3.0 Client: Cinnamon v: 6.2.9 inxi: 3.3\n```\n> I would like to add to it and say that the Vertical scroll bar Documentation Tooltip doesn't seem to work.\n\nThis doesn't work for the macOS version as well, tried both mono and standard builds.\nAnd yes I think this is OS related as my Windows 11 setup running in a VM doesn't have any issues, just the mac build.", "created_at": "2025-03-08 03:14:42", "merge_commit_sha": "6e5ec1920ae1a48dad3a6172f35900af1ae57339", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103784", "base_commit": "b5bdb88062a31a982c8f3bf4b820188edd53c6c5", "patch": "diff --git a/scene/2d/navigation_region_2d.cpp b/scene/2d/navigation_region_2d.cpp\nindex 365d5ba4f68e..ef83027fa0c4 100644\n--- a/scene/2d/navigation_region_2d.cpp\n+++ b/scene/2d/navigation_region_2d.cpp\n@@ -181,7 +181,7 @@ void NavigationRegion2D::_notification(int p_what) {\n \n \t\tcase NOTIFICATION_DRAW: {\n #ifdef DEBUG_ENABLED\n-\t\t\tif (is_inside_tree() && (Engine::get_singleton()->is_editor_hint() || NavigationServer2D::get_singleton()->get_debug_enabled()) && navigation_polygon.is_valid()) {\n+\t\t\tif (is_inside_tree() && (Engine::get_singleton()->is_editor_hint() || (NavigationServer2D::get_singleton()->get_debug_enabled() && NavigationServer2D::get_singleton()->get_debug_navigation_enabled())) && navigation_polygon.is_valid()) {\n \t\t\t\t_update_debug_mesh();\n \t\t\t\t_update_debug_edge_connections_mesh();\n \t\t\t\t_update_debug_baking_rect();\n", "test_patch": "", "problem_statement": "NavigationRegion2D visible even though not enabled in Debug\n### Tested versions\n\nv4.4.stable.steam.4c311cbee\n\n### System information\n\nWindows 11 - Godot Engine v4.4.stable.steam.4c311cbee\n\n### Issue description\n\nIf you enable the option Debug > Visible Avoidance, the navigation mesh will also become visible (regardless of whether Visible Navigation is enabled). This was not the case in previous versions.\n\n### Steps to reproduce\n\nCheck Debug > Visible Avoidance\n\n### Minimal reproduction project (MRP)\n\n[new-game.zip](https://github.com/user-attachments/files/19086046/new-game.zip)\n", "hints_text": "This is likely because the \"Visible Avoidance\" option enables the general debug on the NavigationServer in addition to just the visible avoidance debug (which it needs to do to have any debug render).\n\nThe avoidance debug was added far later so most older navigation related Node types likely still have debug code that just looks at the general debug enabled and needs to be updated to also check for the more specific debug enabled.\n\nThere are 3 debug related functions on the NavigationServer.\n`get_debug_enabled()` for the general debug for both navmesh and avoidance.\n`get_debug_navigation_enabled()` which is just the debug for anything navmesh or path related.\n`get_debug_avoidance_enabled()` which is the debug for anything avoidance related.\n\nFor this issue it is likely enough to just add an additional check for the get_debug_navigation_enabled() in the draw function for the NavigationRegion2D but I expect other node types might also need an update.\n\nEDIT:\nNot a regression, the code on the NavigationRegion2D or debug for this is all older. It is more likely that the fixes to visibility now just show the bug more clearly, or user is on an older version without the debug enabled patch that was rolled out for 4.3 as well.", "created_at": "2025-03-08 01:32:28", "merge_commit_sha": "ba5edb2a77dba794a1adb314a4d4df5a7d392ee8", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103758", "base_commit": "f2cc3f12750adae431384d7bac2f75d1c7e506be", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex bc3b4ceeb2b7..fa9dd87bc491 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -65,7 +65,18 @@ void GameViewDebugger::_session_started(Ref<EditorDebuggerSession> p_session) {\n \tsettings[\"editors/panning/warped_mouse_panning\"] = EDITOR_GET(\"editors/panning/warped_mouse_panning\");\n \tsettings[\"editors/panning/2d_editor_pan_speed\"] = EDITOR_GET(\"editors/panning/2d_editor_pan_speed\");\n \tsettings[\"canvas_item_editor/pan_view\"] = DebuggerMarshalls::serialize_key_shortcut(ED_GET_SHORTCUT(\"canvas_item_editor/pan_view\"));\n+#ifndef _3D_DISABLED\n+\tsettings[\"editors/3d/default_fov\"] = EDITOR_GET(\"editors/3d/default_fov\");\n+\tsettings[\"editors/3d/default_z_near\"] = EDITOR_GET(\"editors/3d/default_z_near\");\n+\tsettings[\"editors/3d/default_z_far\"] = EDITOR_GET(\"editors/3d/default_z_far\");\n+\tsettings[\"editors/3d/navigation/invert_x_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_x_axis\");\n+\tsettings[\"editors/3d/navigation/invert_y_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_y_axis\");\n+\tsettings[\"editors/3d/navigation/warped_mouse_panning\"] = EDITOR_GET(\"editors/3d/navigation/warped_mouse_panning\");\n \tsettings[\"editors/3d/freelook/freelook_base_speed\"] = EDITOR_GET(\"editors/3d/freelook/freelook_base_speed\");\n+\tsettings[\"editors/3d/freelook/freelook_sensitivity\"] = EDITOR_GET(\"editors/3d/freelook/freelook_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/orbit_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/orbit_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/translation_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/translation_sensitivity\");\n+#endif // _3D_DISABLED\n \tsetup_data.append(settings);\n \tp_session->send_message(\"scene:runtime_node_select_setup\", setup_data);\n \ndiff --git a/scene/debugger/scene_debugger.cpp b/scene/debugger/scene_debugger.cpp\nindex c620c5fd5c80..5661268f04c3 100644\n--- a/scene/debugger/scene_debugger.cpp\n+++ b/scene/debugger/scene_debugger.cpp\n@@ -1261,7 +1261,18 @@ void RuntimeNodeSelect::_setup(const Dictionary &p_settings) {\n #ifndef _3D_DISABLED\n \tcursor = Cursor();\n \n-\tfreelook_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", FREELOOK_BASE_SPEED);\n+\tcamera_fov = p_settings.get(\"editors/3d/default_fov\", 70);\n+\tcamera_znear = p_settings.get(\"editors/3d/default_z_near\", 0.05);\n+\tcamera_zfar = p_settings.get(\"editors/3d/default_z_far\", 4'000);\n+\n+\tinvert_x_axis = p_settings.get(\"editors/3d/navigation/invert_x_axis\", false);\n+\tinvert_y_axis = p_settings.get(\"editors/3d/navigation/invert_y_axis\", false);\n+\twarped_mouse_panning_3d = p_settings.get(\"editors/3d/navigation/warped_mouse_panning\", true);\n+\n+\tfreelook_base_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", 5);\n+\tfreelook_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/freelook/freelook_sensitivity\", 0.25));\n+\torbit_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/navigation_feel/orbit_sensitivity\", 0.004));\n+\ttranslation_sensitivity = p_settings.get(\"editors/3d/navigation_feel/translation_sensitivity\", 1);\n \n \t/// 3D Selection Box Generation\n \t// Copied from the Node3DEditor implementation.\n@@ -1342,7 +1353,7 @@ void RuntimeNodeSelect::_set_camera_override_enabled(bool p_enabled) {\n \t\t_update_view_2d();\n \n \t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \t}\n #endif // _3D_DISABLED\n }\n@@ -1445,7 +1456,7 @@ void RuntimeNodeSelect::_process_frame() {\n \t\t\tdirection -= up;\n \t\t}\n \n-\t\treal_t speed = freelook_speed;\n+\t\treal_t speed = freelook_base_speed;\n \t\tif (input->is_physical_key_pressed(Key::SHIFT)) {\n \t\t\tspeed *= 3.0;\n \t\t}\n@@ -2011,19 +2022,19 @@ bool RuntimeNodeSelect::_handle_3d_input(const Ref<InputEvent> &p_event) {\n \t\t\tswitch (k->get_physical_keycode()) {\n \t\t\t\tcase Key::EQUAL: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale - 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::MINUS: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale + 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::KEY_0: {\n \t\t\t\t\tcursor.fov_scale = 1;\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n@@ -2063,33 +2074,37 @@ void RuntimeNodeSelect::_set_camera_freelook_enabled(bool p_enabled) {\n }\n \n void RuntimeNodeSelect::_cursor_scale_distance(real_t p_scale) {\n-\treal_t min_distance = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_distance = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_distance = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_distance = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tcursor.distance = CLAMP(cursor.distance * p_scale, min_distance, max_distance);\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n void RuntimeNodeSelect::_scale_freelook_speed(real_t p_scale) {\n-\treal_t min_speed = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_speed = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_speed = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_speed = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tif (unlikely(min_speed > max_speed)) {\n-\t\tfreelook_speed = (min_speed + max_speed) / 2;\n+\t\tfreelook_base_speed = (min_speed + max_speed) / 2;\n \t} else {\n-\t\tfreelook_speed = CLAMP(freelook_speed * p_scale, min_speed, max_speed);\n+\t\tfreelook_base_speed = CLAMP(freelook_base_speed * p_scale, min_speed, max_speed);\n \t}\n }\n \n void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n \tconst Transform3D prev_camera_transform = _get_cursor_transform();\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * freelook_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * freelook_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tcursor.y_rot += relative.x * freelook_sensitivity;\n \n \t// Look is like the opposite of Orbit: the focus point rotates around the camera.\n \tTransform3D camera_transform = _get_cursor_transform();\n@@ -2104,8 +2119,8 @@ void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n-\tconst real_t pan_speed = 1 / 150.0;\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst real_t pan_speed = translation_sensitivity / 150.0;\n \n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2123,17 +2138,35 @@ void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_orbit(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * orbit_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tif (invert_x_axis) {\n+\t\tcursor.y_rot -= relative.x * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.y_rot += relative.x * orbit_sensitivity;\n+\t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n+Point2 RuntimeNodeSelect::_get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_area) const {\n+\tERR_FAIL_COND_V(p_event.is_null(), Point2());\n+\n+\tif (warped_mouse_panning_3d) {\n+\t\treturn Input::get_singleton()->warp_mouse_motion(p_event, p_area);\n+\t}\n+\n+\treturn p_event->get_relative();\n+}\n+\n Transform3D RuntimeNodeSelect::_get_cursor_transform() {\n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2158,13 +2191,13 @@ void RuntimeNodeSelect::_reset_camera_3d() {\n \t\tcursor.x_rot = -camera->get_global_rotation().x;\n \t\tcursor.y_rot = -camera->get_global_rotation().y;\n \n-\t\tcursor.fov_scale = CLAMP(camera->get_fov() / CAMERA_BASE_FOV, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n+\t\tcursor.fov_scale = CLAMP(camera->get_fov() / camera_fov, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n \t} else {\n \t\tcursor.fov_scale = 1.0;\n \t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n }\n #endif // _3D_DISABLED\n #endif\ndiff --git a/scene/debugger/scene_debugger.h b/scene/debugger/scene_debugger.h\nindex 5a56ea9d99b7..b0a365fddfcb 100644\n--- a/scene/debugger/scene_debugger.h\n+++ b/scene/debugger/scene_debugger.h\n@@ -242,20 +242,26 @@ class RuntimeNodeSelect : public Object {\n \tconst double VIEW_3D_MAX_ZOOM = 1'000'000'000'000;\n #else\n \tconst float VIEW_3D_MAX_ZOOM = 10'000;\n-#endif\n-\tconst float CAMERA_ZNEAR = 0.05;\n-\tconst float CAMERA_ZFAR = 4'000;\n+#endif // REAL_T_IS_DOUBLE\n \n-\tconst float CAMERA_BASE_FOV = 75;\n \tconst float CAMERA_MIN_FOV_SCALE = 0.1;\n \tconst float CAMERA_MAX_FOV_SCALE = 2.5;\n \n-\tconst float FREELOOK_BASE_SPEED = 4;\n-\tconst float RADS_PER_PIXEL = 0.004;\n-\n \tbool camera_first_override = true;\n \tbool camera_freelook = false;\n-\treal_t freelook_speed = FREELOOK_BASE_SPEED;\n+\n+\treal_t camera_fov = 0;\n+\treal_t camera_znear = 0;\n+\treal_t camera_zfar = 0;\n+\n+\tbool invert_x_axis = false;\n+\tbool invert_y_axis = false;\n+\tbool warped_mouse_panning_3d = false;\n+\n+\treal_t freelook_base_speed = 0;\n+\treal_t freelook_sensitivity = 0;\n+\treal_t orbit_sensitivity = 0;\n+\treal_t translation_sensitivity = 0;\n \n \tVector2 previous_mouse_position;\n \n@@ -267,7 +273,7 @@ class RuntimeNodeSelect : public Object {\n \tRID sbox_3d_instance_xray_ofs;\n \tTransform3D sbox_3d_xform;\n \tAABB sbox_3d_bounds;\n-#endif\n+#endif // _3D_DISABLED\n \n \tPoint2 selection_position = Point2(INFINITY, INFINITY);\n \tbool list_shortcut_pressed = false;\n@@ -314,6 +320,7 @@ class RuntimeNodeSelect : public Object {\n \tvoid _cursor_look(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_pan(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_orbit(Ref<InputEventWithModifiers> p_event);\n+\tPoint2 _get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_border) const;\n \tTransform3D _get_cursor_transform();\n \tvoid _reset_camera_3d();\n #endif\n", "test_patch": "", "problem_statement": "Sensitivity settings don't work in embedded game window\n### Tested versions\n\nv4.4.stable.official [4c311cbee]\n\n### System information\n\nGodot v4.4.stable - Linux Mint 22.1 (Xia) on X11 - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 960 (nvidia; 550.120) - AMD FX(tm)-6300 Six-Core Processor (6 threads)\n\n### Issue description\n\nThe embedded game window doesn't listen to the sensitivity settings in Editor Settings > Editors > 3D. I think it just uses the default value for every option.\n\nhttps://github.com/user-attachments/assets/b76f5570-d0c7-45b1-8d50-14649f853cf1\n\n### Steps to reproduce\n\n1. Change one of the sensitivity settings in Editor Settings > Editors > 3D such as \"Orbit Sensitivity\" or \"Freelook Sensitivity\".\n2. Play the game, in embedded game window click the camera icon and 3D. The sensitivity hasn't changed.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "cc @YeldhamDev ", "created_at": "2025-03-07 12:52:12", "merge_commit_sha": "f1597b3023ba74b1ef174c3f9c4daf3f3c19a951", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103685", "base_commit": "766b02c9cda06e4d522cfa2e937e898fb0272353", "patch": "diff --git a/core/local_vector.h b/core/local_vector.h\nindex fe14dbb494ef..5dfe273c40c7 100644\n--- a/core/local_vector.h\n+++ b/core/local_vector.h\n@@ -104,6 +104,15 @@ class LocalVector {\n \t\t}\n \t}\n \n+\tbool erase_unordered(const T &p_val) {\n+\t\tint64_t idx = find(p_val);\n+\t\tif (idx >= 0) {\n+\t\t\tremove_unordered(idx);\n+\t\t\treturn true;\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n \tU erase_multiple_unordered(const T &p_val) {\n \t\tU from = 0;\n \t\tU count = 0;\ndiff --git a/doc/classes/BoneAttachment.xml b/doc/classes/BoneAttachment.xml\nindex 8d427fbf8eb3..703a231b22d9 100644\n--- a/doc/classes/BoneAttachment.xml\n+++ b/doc/classes/BoneAttachment.xml\n@@ -14,6 +14,7 @@\n \t\t<member name=\"bone_name\" type=\"String\" setter=\"set_bone_name\" getter=\"get_bone_name\" default=\"&quot;&quot;\">\n \t\t\tThe name of the attached bone.\n \t\t</member>\n+\t\t<member name=\"physics_interpolation_mode\" type=\"int\" setter=\"set_physics_interpolation_mode\" getter=\"get_physics_interpolation_mode\" overrides=\"Node\" enum=\"Node.PhysicsInterpolationMode\" default=\"1\" />\n \t</members>\n \t<constants>\n \t</constants>\ndiff --git a/doc/classes/VehicleWheel.xml b/doc/classes/VehicleWheel.xml\nindex c51542abe72c..67a80e0bf832 100644\n--- a/doc/classes/VehicleWheel.xml\n+++ b/doc/classes/VehicleWheel.xml\n@@ -52,6 +52,7 @@\n \t\t\t[b]Note:[/b] The simulation does not take the effect of gears into account, you will need to add logic for this if you wish to simulate gears.\n \t\t\tA negative value will result in the wheel reversing.\n \t\t</member>\n+\t\t<member name=\"physics_interpolation_mode\" type=\"int\" setter=\"set_physics_interpolation_mode\" getter=\"get_physics_interpolation_mode\" overrides=\"Node\" enum=\"Node.PhysicsInterpolationMode\" default=\"1\" />\n \t\t<member name=\"steering\" type=\"float\" setter=\"set_steering\" getter=\"get_steering\" default=\"0.0\">\n \t\t\tThe steering angle for the wheel. Setting this to a non-zero value will result in the vehicle turning when it's moving.\n \t\t</member>\ndiff --git a/doc/classes/VisualServer.xml b/doc/classes/VisualServer.xml\nindex 027a4a1c2413..042fe81ba650 100644\n--- a/doc/classes/VisualServer.xml\n+++ b/doc/classes/VisualServer.xml\n@@ -1488,14 +1488,6 @@\n \t\t\t\tSets a material that will override the material for all surfaces on the mesh associated with this instance. Equivalent to [member GeometryInstance.material_override].\n \t\t\t</description>\n \t\t</method>\n-\t\t<method name=\"instance_reset_physics_interpolation\">\n-\t\t\t<return type=\"void\" />\n-\t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n-\t\t\t<description>\n-\t\t\t\tPrevents physics interpolation for the current physics tick.\n-\t\t\t\tThis is useful when moving an instance to a new location, to give an instantaneous change rather than interpolation from the previous location.\n-\t\t\t</description>\n-\t\t</method>\n \t\t<method name=\"instance_set_base\">\n \t\t\t<return type=\"void\" />\n \t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n@@ -1537,14 +1529,6 @@\n \t\t\t\tSets a margin to increase the size of the AABB when culling objects from the view frustum. This allows you to avoid culling objects that fall outside the view frustum. Equivalent to [member GeometryInstance.extra_cull_margin].\n \t\t\t</description>\n \t\t</method>\n-\t\t<method name=\"instance_set_interpolated\">\n-\t\t\t<return type=\"void\" />\n-\t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n-\t\t\t<argument index=\"1\" name=\"interpolated\" type=\"bool\" />\n-\t\t\t<description>\n-\t\t\t\tTurns on and off physics interpolation for the instance.\n-\t\t\t</description>\n-\t\t</method>\n \t\t<method name=\"instance_set_layer_mask\">\n \t\t\t<return type=\"void\" />\n \t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\ndiff --git a/scene/3d/arvr_nodes.cpp b/scene/3d/arvr_nodes.cpp\nindex 7b5e96759bf6..a68360fb6d8e 100644\n--- a/scene/3d/arvr_nodes.cpp\n+++ b/scene/3d/arvr_nodes.cpp\n@@ -613,7 +613,7 @@ void ARVROrigin::_notification(int p_what) {\n \t\t}; break;\n \t\tcase NOTIFICATION_INTERNAL_PROCESS: {\n \t\t\t// set our world origin to our node transform\n-\t\t\tarvr_server->set_world_origin(get_global_transform());\n+\t\t\tarvr_server->set_world_origin(get_global_transform_interpolated());\n \n \t\t\t// check if we have a primary interface\n \t\t\tRef<ARVRInterface> arvr_interface = arvr_server->get_primary_interface();\ndiff --git a/scene/3d/bone_attachment.cpp b/scene/3d/bone_attachment.cpp\nindex fc9f67abd526..5b2f4cd25492 100644\n--- a/scene/3d/bone_attachment.cpp\n+++ b/scene/3d/bone_attachment.cpp\n@@ -105,6 +105,7 @@ void BoneAttachment::_notification(int p_what) {\n }\n \n BoneAttachment::BoneAttachment() {\n+\tset_physics_interpolation_mode(PHYSICS_INTERPOLATION_MODE_OFF);\n \tbound = false;\n }\n \ndiff --git a/scene/3d/camera.cpp b/scene/3d/camera.cpp\nindex 8645e8567ee4..5b59a6785139 100644\n--- a/scene/3d/camera.cpp\n+++ b/scene/3d/camera.cpp\n@@ -45,6 +45,13 @@ void Camera::_request_camera_update() {\n \t_update_camera();\n }\n \n+void Camera::fti_update_servers() {\n+\tif (camera.is_valid()) {\n+\t\tTransform tr = _get_adjusted_camera_transform(_get_cached_global_transform_interpolated());\n+\t\tVisualServer::get_singleton()->camera_set_transform(camera, tr);\n+\t}\n+}\n+\n void Camera::_update_camera_mode() {\n \tforce_change = true;\n \tswitch (mode) {\n@@ -85,12 +92,8 @@ void Camera::_update_camera() {\n \tif (!is_physics_interpolated_and_enabled()) {\n \t\tVisualServer::get_singleton()->camera_set_transform(camera, get_camera_transform());\n \t} else {\n-\t\t// Ideally we shouldn't be moving a physics interpolated camera within a frame,\n-\t\t// because it will break smooth interpolation, but it may occur on e.g. level load.\n-\t\tif (!Engine::get_singleton()->is_in_physics_frame() && camera.is_valid()) {\n-\t\t\t_physics_interpolation_ensure_transform_calculated(true);\n-\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t}\n+\t\t// Force a refresh next frame.\n+\t\tfti_notify_node_changed();\n \t}\n \n \t// here goes listener stuff\n@@ -114,40 +117,6 @@ void Camera::_physics_interpolated_changed() {\n \t_update_process_mode();\n }\n \n-void Camera::_physics_interpolation_ensure_data_flipped() {\n-\t// The curr -> previous update can either occur\n-\t// on the INTERNAL_PHYSICS_PROCESS OR\n-\t// on NOTIFICATION_TRANSFORM_CHANGED,\n-\t// if NOTIFICATION_TRANSFORM_CHANGED takes place\n-\t// earlier than INTERNAL_PHYSICS_PROCESS on a tick.\n-\t// This is to ensure that the data keeps flowing, but the new data\n-\t// doesn't overwrite before prev has been set.\n-\n-\t// Keep the data flowing.\n-\tuint64_t tick = Engine::get_singleton()->get_physics_frames();\n-\tif (_interpolation_data.last_update_physics_tick != tick) {\n-\t\t_interpolation_data.xform_prev = _interpolation_data.xform_curr;\n-\t\t_interpolation_data.last_update_physics_tick = tick;\n-\t\tphysics_interpolation_flip_data();\n-\t}\n-}\n-\n-void Camera::_physics_interpolation_ensure_transform_calculated(bool p_force) const {\n-\tDEV_CHECK_ONCE(!Engine::get_singleton()->is_in_physics_frame());\n-\n-\tInterpolationData &id = _interpolation_data;\n-\tuint64_t frame = Engine::get_singleton()->get_frames_drawn();\n-\n-\tif (id.last_update_frame != frame || p_force) {\n-\t\tid.last_update_frame = frame;\n-\n-\t\tTransformInterpolator::interpolate_transform(id.xform_prev, id.xform_curr, id.xform_interpolated, Engine::get_singleton()->get_physics_interpolation_fraction());\n-\n-\t\tTransform &tr = id.camera_xform_interpolated;\n-\t\ttr = _get_adjusted_camera_transform(id.xform_interpolated);\n-\t}\n-}\n-\n void Camera::set_desired_process_modes(bool p_process_internal, bool p_physics_process_internal) {\n \t_desired_process_internal = p_process_internal;\n \t_desired_physics_process_internal = p_physics_process_internal;\n@@ -155,17 +124,8 @@ void Camera::set_desired_process_modes(bool p_process_internal, bool p_physics_p\n }\n \n void Camera::_update_process_mode() {\n-\tbool process = _desired_process_internal;\n-\tbool physics_process = _desired_physics_process_internal;\n-\n-\tif (is_physics_interpolated_and_enabled()) {\n-\t\tif (is_current()) {\n-\t\t\tprocess = true;\n-\t\t\tphysics_process = true;\n-\t\t}\n-\t}\n-\tset_process_internal(process);\n-\tset_physics_process_internal(physics_process);\n+\tset_process_internal(_desired_process_internal);\n+\tset_physics_process_internal(_desired_physics_process_internal);\n }\n \n void Camera::_notification(int p_what) {\n@@ -182,56 +142,21 @@ void Camera::_notification(int p_what) {\n \t\t\t\tviewport->_camera_set(this);\n \t\t\t}\n \t\t} break;\n-\t\tcase NOTIFICATION_INTERNAL_PROCESS: {\n-\t\t\tif (is_physics_interpolated_and_enabled() && camera.is_valid()) {\n-\t\t\t\t_physics_interpolation_ensure_transform_calculated();\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\t\t\tprint_line(\"\\t\\tinterpolated Camera: \" + rtos(_interpolation_data.xform_interpolated.origin.x) + \"\\t( prev \" + rtos(_interpolation_data.xform_prev.origin.x) + \", curr \" + rtos(_interpolation_data.xform_curr.origin.x) + \" ) on tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-#endif\n-\n-\t\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t\t}\n-\t\t} break;\n-\t\tcase NOTIFICATION_INTERNAL_PHYSICS_PROCESS: {\n-\t\t\tif (is_physics_interpolated_and_enabled()) {\n-\t\t\t\t_physics_interpolation_ensure_data_flipped();\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n-\t\t\t}\n-\t\t} break;\n \t\tcase NOTIFICATION_TRANSFORM_CHANGED: {\n-\t\t\tif (is_physics_interpolated_and_enabled()) {\n-\t\t\t\t_physics_interpolation_ensure_data_flipped();\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n #if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n \t\t\t\tif (!Engine::get_singleton()->is_in_physics_frame()) {\n \t\t\t\t\tPHYSICS_INTERPOLATION_NODE_WARNING(get_instance_id(), \"Interpolated Camera triggered from outside physics process\");\n \t\t\t\t}\n-#endif\n \t\t\t}\n+#endif\n \t\t\t_request_camera_update();\n \t\t\tif (doppler_tracking != DOPPLER_TRACKING_DISABLED) {\n \t\t\t\tvelocity_tracker->update_position(get_global_transform().origin);\n \t\t\t}\n-\t\t\t// Allow auto-reset when first adding to the tree, as a convenience.\n-\t\t\tif (_is_physics_interpolation_reset_requested() && is_inside_tree()) {\n-\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n-\t\t\t\t_set_physics_interpolation_reset_requested(false);\n-\t\t\t}\n-\n \t\t} break;\n \t\tcase NOTIFICATION_RESET_PHYSICS_INTERPOLATION: {\n-\t\t\tif (is_inside_tree()) {\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n-\t\t\t\t_interpolation_data.xform_prev = _interpolation_data.xform_curr;\n-\t\t\t\t_update_process_mode();\n-\t\t\t}\n-\t\t} break;\n-\t\tcase NOTIFICATION_PAUSED: {\n-\t\t\tif (is_physics_interpolated_and_enabled() && is_inside_tree() && is_visible_in_tree()) {\n-\t\t\t\t_physics_interpolation_ensure_transform_calculated(true);\n-\t\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t\t}\n+\t\t\t_update_process_mode();\n \t\t} break;\n \t\tcase NOTIFICATION_EXIT_WORLD: {\n \t\t\tif (!get_tree()->is_node_being_edited(this)) {\n@@ -274,8 +199,7 @@ Transform Camera::_get_adjusted_camera_transform(const Transform &p_xform) const\n \n Transform Camera::get_camera_transform() const {\n \tif (is_physics_interpolated_and_enabled() && !Engine::get_singleton()->is_in_physics_frame()) {\n-\t\t_physics_interpolation_ensure_transform_calculated();\n-\t\treturn _interpolation_data.camera_xform_interpolated;\n+\t\treturn _get_adjusted_camera_transform(_get_cached_global_transform_interpolated());\n \t}\n \n \treturn _get_adjusted_camera_transform(get_global_transform());\n@@ -865,9 +789,16 @@ float ClippedCamera::get_margin() const {\n \treturn margin;\n }\n void ClippedCamera::set_process_mode(ProcessMode p_mode) {\n-\tif (is_physics_interpolated_and_enabled() && p_mode == CLIP_PROCESS_IDLE) {\n-\t\tp_mode = CLIP_PROCESS_PHYSICS;\n-\t\tWARN_PRINT_ONCE(\"[Physics interpolation] Forcing ClippedCamera to PROCESS_PHYSICS mode.\");\n+\tif (is_physics_interpolated_and_enabled()) {\n+\t\tif (p_mode == CLIP_PROCESS_IDLE) {\n+\t\t\tp_mode = CLIP_PROCESS_PHYSICS;\n+\t\t\tWARN_PRINT_ONCE(\"[Physics interpolation] Forcing ClippedCamera to PROCESS_PHYSICS mode.\");\n+\t\t}\n+\n+\t\tprocess_mode = p_mode;\n+\n+\t\tset_desired_process_modes(false, true);\n+\t\treturn;\n \t}\n \n \tif (process_mode == p_mode) {\n@@ -881,8 +812,11 @@ ClippedCamera::ProcessMode ClippedCamera::get_process_mode() const {\n \treturn process_mode;\n }\n \n-void ClippedCamera::physics_interpolation_flip_data() {\n+void ClippedCamera::fti_pump() {\n \t_interpolation_data.clip_offset_prev = _interpolation_data.clip_offset_curr;\n+\n+\t// Must call the base class.\n+\tSpatial::fti_pump();\n }\n \n void ClippedCamera::_physics_interpolated_changed() {\n@@ -899,6 +833,11 @@ Transform ClippedCamera::_get_adjusted_camera_transform(const Transform &p_xform\n \treturn t;\n }\n \n+void ClippedCamera::fti_update_servers() {\n+\tclip_offset = ((_interpolation_data.clip_offset_curr - _interpolation_data.clip_offset_prev) * Engine::get_singleton()->get_physics_interpolation_fraction()) + _interpolation_data.clip_offset_prev;\n+\tCamera::fti_update_servers();\n+}\n+\n void ClippedCamera::_notification(int p_what) {\n \tif (p_what == NOTIFICATION_ENTER_TREE) {\n \t\t// Switch process mode to physics if we are turning on interpolation.\n@@ -966,10 +905,6 @@ void ClippedCamera::_notification(int p_what) {\n \t\t_update_camera();\n \t}\n \n-\tif (is_physics_interpolated_and_enabled() && (p_what == NOTIFICATION_INTERNAL_PROCESS)) {\n-\t\tclip_offset = ((_interpolation_data.clip_offset_curr - _interpolation_data.clip_offset_prev) * Engine::get_singleton()->get_physics_interpolation_fraction()) + _interpolation_data.clip_offset_prev;\n-\t}\n-\n \tif (p_what == NOTIFICATION_LOCAL_TRANSFORM_CHANGED) {\n \t\tupdate_gizmo();\n \t}\ndiff --git a/scene/3d/camera.h b/scene/3d/camera.h\nindex afa95b046bbe..72fdb2641d05 100644\n--- a/scene/3d/camera.h\n+++ b/scene/3d/camera.h\n@@ -91,26 +91,10 @@ class Camera : public Spatial {\n \tRef<SpatialVelocityTracker> velocity_tracker;\n \tbool affect_lod = true;\n \n-\t///////////////////////////////////////////////////////\n-\t// INTERPOLATION FUNCTIONS\n-\tvoid _physics_interpolation_ensure_transform_calculated(bool p_force = false) const;\n-\tvoid _physics_interpolation_ensure_data_flipped();\n-\n-\t// These can be set by derived Cameras,\n-\t// if they wish to do processing (while still\n-\t// allowing physics interpolation to function).\n+\t// These can be set by derived Cameras.\n \tbool _desired_process_internal = false;\n \tbool _desired_physics_process_internal = false;\n \n-\tmutable struct InterpolationData {\n-\t\tTransform xform_curr;\n-\t\tTransform xform_prev;\n-\t\tTransform xform_interpolated;\n-\t\tTransform camera_xform_interpolated; // After modification according to camera type.\n-\t\tuint32_t last_update_physics_tick = 0;\n-\t\tuint32_t last_update_frame = UINT32_MAX;\n-\t} _interpolation_data;\n-\n \tvoid _update_process_mode();\n \n protected:\n@@ -118,9 +102,6 @@ class Camera : public Spatial {\n \t// This is because physics interpolation may need to request process modes additionally.\n \tvoid set_desired_process_modes(bool p_process_internal, bool p_physics_process_internal);\n \n-\t// Opportunity for derived classes to interpolate extra attributes.\n-\tvirtual void physics_interpolation_flip_data() {}\n-\n \tvirtual void _physics_interpolated_changed();\n \tvirtual Transform _get_adjusted_camera_transform(const Transform &p_xform) const;\n \t///////////////////////////////////////////////////////\n@@ -128,6 +109,7 @@ class Camera : public Spatial {\n \tvoid _update_camera();\n \tvirtual void _request_camera_update();\n \tvoid _update_camera_mode();\n+\tvirtual void fti_update_servers();\n \n \tvoid _notification(int p_what);\n \tvirtual void _validate_property(PropertyInfo &p_property) const;\n@@ -248,8 +230,9 @@ class ClippedCamera : public Camera {\n \n protected:\n \tvirtual Transform _get_adjusted_camera_transform(const Transform &p_xform) const;\n-\tvirtual void physics_interpolation_flip_data();\n+\tvirtual void fti_pump();\n \tvirtual void _physics_interpolated_changed();\n+\tvirtual void fti_update_servers();\n \t///////////////////////////////////////////////////////\n \n \tvoid _notification(int p_what);\ndiff --git a/scene/3d/spatial.cpp b/scene/3d/spatial.cpp\nindex cac9673bfa06..394f334adc48 100644\n--- a/scene/3d/spatial.cpp\n+++ b/scene/3d/spatial.cpp\n@@ -118,7 +118,7 @@ void Spatial::_propagate_transform_changed(Spatial *p_origin) {\n #endif\n \t\tget_tree()->xform_change_list.add(&xform_change);\n \t}\n-\tdata.dirty |= DIRTY_GLOBAL;\n+\tdata.dirty |= DIRTY_GLOBAL | DIRTY_GLOBAL_INTERPOLATED;\n \n \tdata.children_lock--;\n }\n@@ -174,13 +174,27 @@ void Spatial::_notification(int p_what) {\n \t\t\t\t_propagate_merging_allowed(merging_allowed);\n \t\t\t}\n \n-\t\t\tdata.dirty |= DIRTY_GLOBAL; //global is always dirty upon entering a scene\n+\t\t\tdata.dirty |= DIRTY_GLOBAL | DIRTY_GLOBAL_INTERPOLATED; //global is always dirty upon entering a scene\n \t\t\t_notify_dirty();\n \n \t\t\tnotification(NOTIFICATION_ENTER_WORLD);\n \n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n+\t\t\t\t// Always reset FTI when entering tree.\n+\t\t\t\tfti_pump();\n+\n+\t\t\t\t// No need to interpolate as we are doing a reset.\n+\t\t\t\tdata.global_transform_interpolated = get_global_transform();\n+\n+\t\t\t\t// Make sure servers are up to date.\n+\t\t\t\tfti_update_servers();\n+\t\t\t}\n \t\t} break;\n \t\tcase NOTIFICATION_EXIT_TREE: {\n+\t\t\tif (is_inside_tree()) {\n+\t\t\t\tget_tree()->get_scene_tree_fti().spatial_notify_delete(this);\n+\t\t\t}\n+\n \t\t\tnotification(NOTIFICATION_EXIT_WORLD, true);\n \t\t\tif (xform_change.in_list()) {\n \t\t\t\tget_tree()->xform_change_list.remove(&xform_change);\n@@ -252,6 +266,13 @@ void Spatial::_notification(int p_what) {\n \t\t\tif (data.client_physics_interpolation_data) {\n \t\t\t\tdata.client_physics_interpolation_data->global_xform_prev = data.client_physics_interpolation_data->global_xform_curr;\n \t\t\t}\n+\t\t\tdata.local_transform_prev = data.local_transform;\n+\t\t} break;\n+\n+\t\tcase NOTIFICATION_PAUSED: {\n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n+\t\t\t\tdata.local_transform_prev = data.local_transform;\n+\t\t\t}\n \t\t} break;\n \n \t\tdefault: {\n@@ -281,7 +302,22 @@ void Spatial::set_global_rotation(const Vector3 &p_euler_rad) {\n \tset_global_transform(transform);\n }\n \n+void Spatial::fti_pump() {\n+\tif (data.dirty & DIRTY_LOCAL) {\n+\t\t_update_local_transform();\n+\t}\n+\n+\tdata.local_transform_prev = data.local_transform;\n+}\n+\n+void Spatial::fti_notify_node_changed() {\n+\tif (is_inside_tree()) {\n+\t\tget_tree()->get_scene_tree_fti().spatial_notify_set_transform(*this);\n+\t}\n+}\n+\n void Spatial::set_transform(const Transform &p_transform) {\n+\tfti_notify_node_changed();\n \tdata.local_transform = p_transform;\n \tdata.dirty |= DIRTY_VECTORS;\n \tdata.dirty &= ~DIRTY_LOCAL;\n@@ -404,14 +440,19 @@ Transform Spatial::_get_global_transform_interpolated(real_t p_interpolation_fra\n }\n \n Transform Spatial::get_global_transform_interpolated() {\n+#if 1\n \t// Pass through if physics interpolation is switched off.\n \t// This is a convenience, as it allows you to easy turn off interpolation\n \t// without changing any code.\n-\tif (!is_physics_interpolated_and_enabled()) {\n-\t\treturn get_global_transform();\n+\tif (data.fti_global_xform_interp_set && is_physics_interpolated_and_enabled() && !Engine::get_singleton()->is_in_physics_frame() && is_visible_in_tree()) {\n+\t\treturn data.global_transform_interpolated;\n \t}\n \n-\t// If we are in the physics frame, the interpolated global transform is meaningless.\n+\treturn get_global_transform();\n+#else\n+\t// OLD METHOD - deprecated since moving to SceneTreeFTI,\n+\t// but leaving for reference and comparison for debugging.\n+\n \t// However, there is an exception, we may want to use this as a means of starting off the client\n \t// interpolation pump if not already started (when _is_physics_interpolated_client_side() is false).\n \tif (Engine::get_singleton()->is_in_physics_frame() && _is_physics_interpolated_client_side()) {\n@@ -419,6 +460,7 @@ Transform Spatial::get_global_transform_interpolated() {\n \t}\n \n \treturn _get_global_transform_interpolated(Engine::get_singleton()->get_physics_interpolation_fraction());\n+#endif\n }\n \n Transform Spatial::get_global_transform() const {\n@@ -484,6 +526,7 @@ Transform Spatial::get_relative_transform(const Node *p_parent) const {\n }\n \n void Spatial::set_translation(const Vector3 &p_translation) {\n+\tfti_notify_node_changed();\n \tdata.local_transform.origin = p_translation;\n \t_change_notify(\"transform\");\n \t_propagate_transform_changed(this);\n@@ -493,6 +536,7 @@ void Spatial::set_translation(const Vector3 &p_translation) {\n }\n \n void Spatial::set_rotation(const Vector3 &p_euler_rad) {\n+\tfti_notify_node_changed();\n \tif (data.dirty & DIRTY_VECTORS) {\n \t\tdata.scale = data.local_transform.basis.get_scale();\n \t\tdata.dirty &= ~DIRTY_VECTORS;\n@@ -512,6 +556,7 @@ void Spatial::set_rotation_degrees(const Vector3 &p_euler_deg) {\n }\n \n void Spatial::set_scale(const Vector3 &p_scale) {\n+\tfti_notify_node_changed();\n \tif (data.dirty & DIRTY_VECTORS) {\n \t\tdata.rotation = data.local_transform.basis.get_rotation();\n \t\tdata.dirty &= ~DIRTY_VECTORS;\n@@ -1061,6 +1106,11 @@ Spatial::Spatial() :\n \tdata.disable_scale = false;\n \tdata.vi_visible = true;\n \tdata.merging_allowed = true;\n+\n+\tdata.fti_on_frame_list = false;\n+\tdata.fti_on_tick_list = false;\n+\tdata.fti_global_xform_interp_set = false;\n+\n \tdata.merging_mode = MERGING_MODE_INHERIT;\n \n \tdata.client_physics_interpolation_data = nullptr;\n@@ -1077,4 +1127,8 @@ Spatial::Spatial() :\n \n Spatial::~Spatial() {\n \t_disable_client_physics_interpolation();\n+\n+\tif (is_inside_tree()) {\n+\t\tget_tree()->get_scene_tree_fti().spatial_notify_delete(this);\n+\t}\n }\ndiff --git a/scene/3d/spatial.h b/scene/3d/spatial.h\nindex 9c80044919eb..53c595ee3f3a 100644\n--- a/scene/3d/spatial.h\n+++ b/scene/3d/spatial.h\n@@ -52,6 +52,8 @@ class Spatial : public Node {\n \tGDCLASS(Spatial, Node);\n \tOBJ_CATEGORY(\"3D\");\n \n+\tfriend class SceneTreeFTI;\n+\n public:\n \tenum MergingMode : unsigned int {\n \t\tMERGING_MODE_INHERIT,\n@@ -74,15 +76,27 @@ class Spatial : public Node {\n \t\tDIRTY_NONE = 0,\n \t\tDIRTY_VECTORS = 1,\n \t\tDIRTY_LOCAL = 2,\n-\t\tDIRTY_GLOBAL = 4\n+\t\tDIRTY_GLOBAL = 4,\n+\t\tDIRTY_GLOBAL_INTERPOLATED = 8,\n \t};\n \n \tmutable SelfList<Node> xform_change;\n \tSelfList<Spatial> _client_physics_interpolation_spatials_list;\n \n \tstruct Data {\n+\t\t// Interpolated global transform - correct on the frame only.\n+\t\t// Only used with FTI.\n+\t\tTransform global_transform_interpolated;\n+\n+\t\t// Current xforms are either\n+\t\t// * Used for everything (when not using FTI)\n+\t\t// * Correct on the physics tick (when using FTI)\n \t\tmutable Transform global_transform;\n \t\tmutable Transform local_transform;\n+\n+\t\t// Only used with FTI.\n+\t\tTransform local_transform_prev;\n+\n \t\tmutable Vector3 rotation;\n \t\tmutable Vector3 scale;\n \n@@ -108,6 +122,11 @@ class Spatial : public Node {\n \t\tbool visible : 1;\n \t\tbool disable_scale : 1;\n \n+\t\t// Scene tree interpolation\n+\t\tbool fti_on_frame_list : 1;\n+\t\tbool fti_on_tick_list : 1;\n+\t\tbool fti_global_xform_interp_set : 1;\n+\n \t\tbool merging_allowed : 1;\n \n \t\tint children_lock;\n@@ -139,9 +158,27 @@ class Spatial : public Node {\n \n \tvoid _set_vi_visible(bool p_visible);\n \tbool _is_vi_visible() const { return data.vi_visible; }\n+\n \tTransform _get_global_transform_interpolated(real_t p_interpolation_fraction);\n+\tconst Transform &_get_cached_global_transform_interpolated() const { return data.global_transform_interpolated; }\n \tvoid _disable_client_physics_interpolation();\n \n+\t// Calling this announces to the FTI system that a node has been moved,\n+\t// or requires an update in terms of interpolation\n+\t// (e.g. changing Camera zoom even if position hasn't changed).\n+\tvoid fti_notify_node_changed();\n+\n+\t// Opportunity after FTI to update the servers\n+\t// with global_transform_interpolated,\n+\t// and any custom interpolated data in derived classes.\n+\t// Make sure to call the parent class fti_update_servers(),\n+\t// so all data is updated to the servers.\n+\tvirtual void fti_update_servers() {}\n+\n+\t// Pump the FTI data, also gives a chance for inherited classes\n+\t// to pump custom data, but they *must* call the base class here too.\n+\tvirtual void fti_pump();\n+\n \tvoid _notification(int p_what);\n \tstatic void _bind_methods();\n \ndiff --git a/scene/3d/vehicle_body.cpp b/scene/3d/vehicle_body.cpp\nindex 8231e4a6daf8..724867a0bcc1 100644\n--- a/scene/3d/vehicle_body.cpp\n+++ b/scene/3d/vehicle_body.cpp\n@@ -44,7 +44,7 @@ class btVehicleJacobianEntry {\n \n \treal_t getDiagonal() const { return m_Adiag; }\n \n-\tbtVehicleJacobianEntry(){};\n+\tbtVehicleJacobianEntry() {}\n \t//constraint between two different rigidbodies\n \tbtVehicleJacobianEntry(\n \t\t\tconst Basis &world2A,\n@@ -366,6 +366,8 @@ VehicleWheel::VehicleWheel() {\n \tm_raycastInfo.m_suspensionLength = 0.0;\n \n \tbody = nullptr;\n+\n+\tset_physics_interpolation_mode(PHYSICS_INTERPOLATION_MODE_OFF);\n }\n \n void VehicleBody::_update_wheel_transform(VehicleWheel &wheel, PhysicsDirectBodyState *s) {\ndiff --git a/scene/3d/visual_instance.cpp b/scene/3d/visual_instance.cpp\nindex cf80a6742dd7..05d7414b9698 100644\n--- a/scene/3d/visual_instance.cpp\n+++ b/scene/3d/visual_instance.cpp\n@@ -82,6 +82,12 @@ void VisualInstance::set_instance_use_identity_transform(bool p_enable) {\n \t}\n }\n \n+void VisualInstance::fti_update_servers() {\n+\tif (!_is_using_identity_transform()) {\n+\t\tVisualServer::get_singleton()->instance_set_transform(get_instance(), _get_cached_global_transform_interpolated());\n+\t}\n+}\n+\n void VisualInstance::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_ENTER_WORLD: {\n@@ -97,33 +103,26 @@ void VisualInstance::_notification(int p_what) {\n \n \t\t} break;\n \t\tcase NOTIFICATION_TRANSFORM_CHANGED: {\n-\t\t\tif (_is_vi_visible() || is_physics_interpolated_and_enabled()) {\n+\t\t\tif (_is_vi_visible()) {\n \t\t\t\tif (!_is_using_identity_transform()) {\n-\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n-\n-\t\t\t\t\t// For instance when first adding to the tree, when the previous transform is\n-\t\t\t\t\t// unset, to prevent streaking from the origin.\n-\t\t\t\t\tif (_is_physics_interpolation_reset_requested() && is_physics_interpolated_and_enabled() && is_inside_tree()) {\n-\t\t\t\t\t\tif (_is_vi_visible()) {\n-\t\t\t\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n+\t\t\t\t\t// Physics interpolated VIs don't need to send their transform immediately after setting,\n+\t\t\t\t\t// indeed it is counterproductive, because the interpolated transform will be sent\n+\t\t\t\t\t// to the VisualServer immediately prior to rendering.\n+\t\t\t\t\tif (!is_physics_interpolated_and_enabled()) {\n+\t\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\t// For instance when first adding to the tree, when the previous transform is\n+\t\t\t\t\t\t// unset, to prevent streaking from the origin.\n+\t\t\t\t\t\tif (_is_physics_interpolation_reset_requested() && is_inside_tree()) {\n+\t\t\t\t\t\t\tif (_is_vi_visible()) {\n+\t\t\t\t\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t_set_physics_interpolation_reset_requested(false);\n \t\t\t\t\t\t}\n-\t\t\t\t\t\t_set_physics_interpolation_reset_requested(false);\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n \t\t} break;\n-\t\tcase NOTIFICATION_RESET_PHYSICS_INTERPOLATION: {\n-\t\t\tif (_is_vi_visible() && is_physics_interpolated() && is_inside_tree()) {\n-\t\t\t\t// We must ensure the VisualServer transform is up to date before resetting.\n-\t\t\t\t// This is because NOTIFICATION_TRANSFORM_CHANGED is deferred,\n-\t\t\t\t// and cannot be relied to be called in order before NOTIFICATION_RESET_PHYSICS_INTERPOLATION.\n-\t\t\t\tif (!_is_using_identity_transform()) {\n-\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n-\t\t\t\t}\n-\n-\t\t\t\tVisualServer::get_singleton()->instance_reset_physics_interpolation(instance);\n-\t\t\t}\n-\t\t} break;\n \t\tcase NOTIFICATION_EXIT_WORLD: {\n \t\t\tVisualServer::get_singleton()->instance_set_scenario(instance, RID());\n \t\t\tVisualServer::get_singleton()->instance_attach_skeleton(instance, RID());\n@@ -140,10 +139,6 @@ void VisualInstance::_notification(int p_what) {\n \t}\n }\n \n-void VisualInstance::_physics_interpolated_changed() {\n-\tVisualServer::get_singleton()->instance_set_interpolated(instance, is_physics_interpolated());\n-}\n-\n RID VisualInstance::get_instance() const {\n \treturn instance;\n }\ndiff --git a/scene/3d/visual_instance.h b/scene/3d/visual_instance.h\nindex 0b605ed15c72..ce8164bff25b 100644\n--- a/scene/3d/visual_instance.h\n+++ b/scene/3d/visual_instance.h\n@@ -51,8 +51,8 @@ class VisualInstance : public CullInstance {\n protected:\n \tvoid _update_visibility();\n \tvirtual void _refresh_portal_mode();\n-\tvirtual void _physics_interpolated_changed();\n \tvoid set_instance_use_identity_transform(bool p_enable);\n+\tvirtual void fti_update_servers();\n \n \tvoid _notification(int p_what);\n \tstatic void _bind_methods();\ndiff --git a/scene/animation/skeleton_ik.cpp b/scene/animation/skeleton_ik.cpp\nindex 22561d1d7be8..8fed9677ae51 100644\n--- a/scene/animation/skeleton_ik.cpp\n+++ b/scene/animation/skeleton_ik.cpp\n@@ -276,7 +276,7 @@ void FabrikInverseKinematic::solve(Task *p_task, real_t blending_delta, bool ove\n \tp_task->skeleton->set_bone_global_pose_override(p_task->chain.chain_root.bone, Transform(), 0.0, false);\n \tVector3 origin_pos = p_task->skeleton->get_bone_global_pose(p_task->chain.chain_root.bone).origin;\n \n-\tmake_goal(p_task, p_task->skeleton->get_global_transform().affine_inverse(), blending_delta);\n+\tmake_goal(p_task, p_task->skeleton->get_global_transform_interpolated().affine_inverse(), blending_delta);\n \n \tif (p_use_magnet && p_task->chain.middle_chain_item) {\n \t\tp_task->chain.magnet_position = p_task->chain.middle_chain_item->initial_transform.origin.linear_interpolate(p_magnet_position, blending_delta);\ndiff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 6a7f4b4eb55c..33a828e41757 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -538,6 +538,8 @@ void SceneTree::set_physics_interpolation_enabled(bool p_enabled) {\n \t_physics_interpolation_enabled = p_enabled;\n \tVisualServer::get_singleton()->set_physics_interpolation_enabled(p_enabled);\n \n+\tget_scene_tree_fti().set_enabled(get_root(), p_enabled);\n+\n \t// Perform an auto reset on the root node for convenience for the user.\n \tif (root) {\n \t\troot->reset_physics_interpolation();\n@@ -563,6 +565,7 @@ void SceneTree::iteration_prepare() {\n \t\t// Make sure any pending transforms from the last tick / frame\n \t\t// are flushed before pumping the interpolation prev and currents.\n \t\tflush_transform_notifications();\n+\t\tget_scene_tree_fti().tick_update();\n \t\tVisualServer::get_singleton()->tick();\n \t}\n }\n@@ -628,6 +631,17 @@ bool SceneTree::idle(float p_time) {\n \t//print_line(\"node count: \"+itos(get_node_count()));\n \t//print_line(\"TEXTURE RAM: \"+itos(VS::get_singleton()->get_render_info(VS::INFO_TEXTURE_MEM_USED)));\n \n+\t// First pass of scene tree fixed timestep interpolation.\n+\tif (get_scene_tree_fti().is_enabled()) {\n+\t\t// Special, we need to ensure RenderingServer is up to date\n+\t\t// with *all* the pending xforms *before* updating it during\n+\t\t// the FTI update.\n+\t\t// If this is not done, we can end up with a deferred `set_transform()`\n+\t\t// overwriting the interpolated xform in the server.\n+\t\tflush_transform_notifications();\n+\t\tget_scene_tree_fti().frame_update(get_root(), true);\n+\t}\n+\n \troot_lock++;\n \n \tif (MainLoop::idle(p_time)) {\n@@ -733,6 +747,11 @@ bool SceneTree::idle(float p_time) {\n \n #endif\n \n+\t// Second pass of scene tree fixed timestep interpolation.\n+\t// ToDo: Possibly needs another flush_transform_notifications here\n+\t// depending on whether there are side effects to _call_idle_callbacks().\n+\tget_scene_tree_fti().frame_update(get_root(), false);\n+\n \tVisualServer::get_singleton()->pre_draw(true);\n \n \treturn _quit;\ndiff --git a/scene/main/scene_tree.h b/scene/main/scene_tree.h\nindex 292cdf23ec28..b8ab1ed4b3fc 100644\n--- a/scene/main/scene_tree.h\n+++ b/scene/main/scene_tree.h\n@@ -35,6 +35,7 @@\n #include \"core/os/main_loop.h\"\n #include \"core/os/thread_safe.h\"\n #include \"core/self_list.h\"\n+#include \"scene/main/scene_tree_fti.h\"\n #include \"scene/resources/mesh.h\"\n #include \"scene/resources/world.h\"\n #include \"scene/resources/world_2d.h\"\n@@ -160,6 +161,7 @@ class SceneTree : public MainLoop {\n \tStretchAspect stretch_aspect;\n \tSize2i stretch_min;\n \treal_t stretch_scale;\n+\tSceneTreeFTI scene_tree_fti;\n \n \tvoid _update_font_oversampling(float p_ratio);\n \tvoid _update_root_rect();\n@@ -438,6 +440,8 @@ class SceneTree : public MainLoop {\n \tvoid client_physics_interpolation_add_spatial(SelfList<Spatial> *p_elem);\n \tvoid client_physics_interpolation_remove_spatial(SelfList<Spatial> *p_elem);\n \n+\tSceneTreeFTI &get_scene_tree_fti() { return scene_tree_fti; }\n+\n \tstatic void add_idle_callback(IdleCallback p_callback);\n \tSceneTree();\n \t~SceneTree();\ndiff --git a/scene/main/scene_tree_fti.cpp b/scene/main/scene_tree_fti.cpp\nnew file mode 100644\nindex 000000000000..f9e3ef26fbd1\n--- /dev/null\n+++ b/scene/main/scene_tree_fti.cpp\n@@ -0,0 +1,288 @@\n+/**************************************************************************/\n+/*  scene_tree_fti.cpp                                                    */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef _3D_DISABLED\n+\n+#include \"scene_tree_fti.h\"\n+#include \"core/engine.h\"\n+#include \"core/error_macros.h\"\n+#include \"core/math/transform_interpolator.h\"\n+#include \"core/os/os.h\"\n+#include \"scene/3d/spatial.h\"\n+#include \"scene/3d/visual_instance.h\"\n+\n+void SceneTreeFTI::_reset_flags(Node *p_node) {\n+\tSpatial *s = Object::cast_to<Spatial>(p_node);\n+\n+\tif (s) {\n+\t\ts->data.fti_on_frame_list = false;\n+\t\ts->data.fti_on_tick_list = false;\n+\n+\t\t// In most cases the later  NOTIFICATION_RESET_PHYSICS_INTERPOLATION\n+\t\t// will reset this, but this should help cover hidden nodes.\n+\t\ts->data.local_transform_prev = s->data.local_transform;\n+\t}\n+\n+\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t_reset_flags(p_node->get_child(n));\n+\t}\n+}\n+\n+void SceneTreeFTI::set_enabled(Node *p_root, bool p_enabled) {\n+\tif (data.enabled == p_enabled) {\n+\t\treturn;\n+\t}\n+\n+\tdata.spatial_tick_list[0].clear();\n+\tdata.spatial_tick_list[1].clear();\n+\n+\t// Spatial flags must be reset.\n+\tif (p_root) {\n+\t\t_reset_flags(p_root);\n+\t}\n+\n+\tdata.enabled = p_enabled;\n+}\n+\n+void SceneTreeFTI::tick_update() {\n+\tif (!data.enabled) {\n+\t\treturn;\n+\t}\n+\n+\tuint32_t curr_mirror = data.mirror;\n+\tuint32_t prev_mirror = curr_mirror ? 0 : 1;\n+\n+\tLocalVector<Spatial *> &curr = data.spatial_tick_list[curr_mirror];\n+\tLocalVector<Spatial *> &prev = data.spatial_tick_list[prev_mirror];\n+\n+\t// First detect on the previous list but not on this tick list.\n+\tfor (uint32_t n = 0; n < prev.size(); n++) {\n+\t\tSpatial *s = prev[n];\n+\t\tif (!s->data.fti_on_tick_list) {\n+\t\t\t// Needs a reset so jittering will stop.\n+\t\t\ts->fti_pump();\n+\n+\t\t\t// This may not get updated so set it to the same as global xform.\n+\t\t\t// TODO: double check this is the best value.\n+\t\t\ts->data.global_transform_interpolated = s->get_global_transform();\n+\n+\t\t\t// Remove from interpolation list.\n+\t\t\tif (s->data.fti_on_frame_list) {\n+\t\t\t\ts->data.fti_on_frame_list = false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t// Now pump all on the current list.\n+\tfor (uint32_t n = 0; n < curr.size(); n++) {\n+\t\tSpatial *s = curr[n];\n+\n+\t\t// Reset, needs to be marked each tick.\n+\t\ts->data.fti_on_tick_list = false;\n+\n+\t\t// Pump.\n+\t\ts->fti_pump();\n+\t}\n+\n+\t// Clear previous list and flip.\n+\tprev.clear();\n+\tdata.mirror = prev_mirror;\n+}\n+\n+void SceneTreeFTI::_spatial_notify_set_transform(Spatial &r_spatial) {\n+\t// This may be checked by the calling routine already,\n+\t// but needs to be double checked for custom SceneTrees.\n+\tif (!data.enabled || !r_spatial.is_physics_interpolated()) {\n+\t\treturn;\n+\t}\n+\n+\tif (!r_spatial.data.fti_on_tick_list) {\n+\t\tr_spatial.data.fti_on_tick_list = true;\n+\t\tdata.spatial_tick_list[data.mirror].push_back(&r_spatial);\n+\t}\n+\n+\tif (!r_spatial.data.fti_on_frame_list) {\n+\t\tr_spatial.data.fti_on_frame_list = true;\n+\t}\n+}\n+\n+void SceneTreeFTI::spatial_notify_delete(Spatial *p_spatial) {\n+\tif (!data.enabled) {\n+\t\treturn;\n+\t}\n+\n+\tif (p_spatial->data.fti_on_frame_list) {\n+\t\tp_spatial->data.fti_on_frame_list = false;\n+\t}\n+\n+\t// This can potentially be optimized for large scenes with large churn,\n+\t// as it will be doing a linear search through the lists.\n+\tdata.spatial_tick_list[0].erase_unordered(p_spatial);\n+\tdata.spatial_tick_list[1].erase_unordered(p_spatial);\n+}\n+\n+void SceneTreeFTI::_update_dirty_spatials(Node *p_node, uint32_t p_current_frame, float p_interpolation_fraction, bool p_active, const Transform *p_parent_global_xform, int p_depth) {\n+\tSpatial *s = Object::cast_to<Spatial>(p_node);\n+\n+\t// Don't recurse into hidden branches.\n+\tif (s && !s->is_visible()) {\n+\t\t// NOTE : If we change from recursing entire tree, we should do an is_visible_in_tree()\n+\t\t// check for the first of the branch.\n+\t\treturn;\n+\t}\n+\n+\t// Not a Spatial.\n+\t// Could be e.g. a viewport or something\n+\t// so we should still recurse to children.\n+\tif (!s) {\n+\t\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t\t_update_dirty_spatials(p_node->get_child(n), p_current_frame, p_interpolation_fraction, p_active, nullptr, p_depth + 1);\n+\t\t}\n+\t\treturn;\n+\t}\n+\n+\t// Start the active interpolation chain from here onwards\n+\t// as we recurse further into the SceneTree.\n+\t// Once we hit an active (interpolated) node, we have to fully\n+\t// process all ancestors because their xform will also change.\n+\t// Anything not moving (inactive) higher in the tree need not be processed.\n+\tif (!p_active) {\n+\t\tif (data.frame_start) {\n+\t\t\t// On the frame start, activate whenever we hit something that requests interpolation.\n+\t\t\tif (s->data.fti_on_frame_list) {\n+\t\t\t\tp_active = true;\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// On the frame end, we want to re-interpolate *anything* that has moved\n+\t\t\t// since the frame start.\n+\t\t\tif (s->data.dirty & Spatial::DIRTY_GLOBAL_INTERPOLATED) {\n+\t\t\t\tp_active = true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (data.frame_start) {\n+\t\t// Mark on the Spatial whether we have set global_transform_interp.\n+\t\t// This can later be used when calling `get_global_transform_interpolated()`\n+\t\t// to know which xform to return.\n+\t\ts->data.fti_global_xform_interp_set = p_active;\n+\t}\n+\n+\tif (p_active) {\n+#if 0\n+\t\tbool dirty = s->data.dirty & Spatial::DIRTY_GLOBAL_INTERP;\n+\n+\t\tif (data.debug) {\n+\t\t\tString sz;\n+\t\t\tfor (int n = 0; n < p_depth; n++) {\n+\t\t\t\tsz += \"\\t\";\n+\t\t\t}\n+\t\t\tprint_line(sz + p_node->get_name() + (dirty ? \" DIRTY\" : \"\"));\n+\t\t}\n+#endif\n+\n+\t\t// First calculate our local xform.\n+\t\t// This will either use interpolation, or just use the current local if not interpolated.\n+\t\tTransform local_interp;\n+\t\tif (s->is_physics_interpolated()) {\n+\t\t\tTransformInterpolator::interpolate_transform(s->data.local_transform_prev, s->data.local_transform, local_interp, p_interpolation_fraction);\n+\t\t} else {\n+\t\t\tlocal_interp = s->data.local_transform;\n+\t\t}\n+\n+\t\t// Concatenate parent xform.\n+\t\tif (!s->is_set_as_toplevel()) {\n+\t\t\tif (p_parent_global_xform) {\n+\t\t\t\ts->data.global_transform_interpolated = (*p_parent_global_xform) * local_interp;\n+\t\t\t} else {\n+\t\t\t\tconst Spatial *parent = s->get_parent_spatial();\n+\n+\t\t\t\tif (parent) {\n+\t\t\t\t\tconst Transform &parent_glob = parent->data.fti_global_xform_interp_set ? parent->data.global_transform_interpolated : parent->data.global_transform;\n+\t\t\t\t\ts->data.global_transform_interpolated = parent_glob * local_interp;\n+\t\t\t\t} else {\n+\t\t\t\t\ts->data.global_transform_interpolated = local_interp;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\ts->data.global_transform_interpolated = local_interp;\n+\t\t}\n+\n+\t\t// Upload to VisualServer the interpolated global xform.\n+\t\ts->fti_update_servers();\n+\n+\t} // if active.\n+\n+\t// Remove the dirty interp flag from EVERYTHING as we go.\n+\ts->data.dirty &= ~Spatial::DIRTY_GLOBAL_INTERPOLATED;\n+\n+\t// Recurse to children.\n+\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t_update_dirty_spatials(p_node->get_child(n), p_current_frame, p_interpolation_fraction, p_active, s->data.fti_global_xform_interp_set ? &s->data.global_transform_interpolated : &s->data.global_transform, p_depth + 1);\n+\t}\n+}\n+\n+void SceneTreeFTI::frame_update(Node *p_root, bool p_frame_start) {\n+\tif (!data.enabled || !p_root) {\n+\t\treturn;\n+\t}\n+\n+\tdata.frame_start = p_frame_start;\n+\n+\tfloat f = Engine::get_singleton()->get_physics_interpolation_fraction();\n+\tuint32_t frame = Engine::get_singleton()->get_frames_drawn();\n+\n+// #define SCENE_TREE_FTI_TAKE_TIMINGS\n+#ifdef SCENE_TREE_FTI_TAKE_TIMINGS\n+\tuint64_t before = OS::get_singleton()->get_ticks_usec();\n+#endif\n+\n+\tif (data.debug) {\n+\t\tprint_line(String(\"\\nScene: \") + (data.frame_start ? \"start\" : \"end\") + \"\\n\");\n+\t}\n+\n+\t// Probably not the most optimal approach as we traverse the entire SceneTree\n+\t// but simple and foolproof.\n+\t// Can be optimized later.\n+\t_update_dirty_spatials(p_root, frame, f, false);\n+\n+\tif (!p_frame_start && data.debug) {\n+\t\tdata.debug = false;\n+\t}\n+\n+#ifdef SCENE_TREE_FTI_TAKE_TIMINGS\n+\tuint64_t after = OS::get_singleton()->get_ticks_usec();\n+\tif ((Engine::get_singleton()->get_frames_drawn() % 60) == 0) {\n+\t\tprint_line(\"Took \" + itos(after - before) + \" usec \" + (data.frame_start ? \"start\" : \"end\"));\n+\t}\n+#endif\n+}\n+\n+#endif // ndef _3D_DISABLED\ndiff --git a/scene/main/scene_tree_fti.h b/scene/main/scene_tree_fti.h\nnew file mode 100644\nindex 000000000000..5e76d30c7b10\n--- /dev/null\n+++ b/scene/main/scene_tree_fti.h\n@@ -0,0 +1,112 @@\n+/**************************************************************************/\n+/*  scene_tree_fti.h                                                      */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef SCENE_TREE_FTI_H\n+#define SCENE_TREE_FTI_H\n+\n+#include <core/local_vector.h>\n+#include <core/os/mutex.h>\n+\n+class Spatial;\n+class Node;\n+class Transform;\n+\n+#ifdef _3D_DISABLED\n+// Stubs\n+class SceneTreeFTI {\n+public:\n+\tvoid frame_update(Node *p_root, bool p_frame_start) {}\n+\tvoid tick_update() {}\n+\tvoid set_enabled(Node *p_root, bool p_enabled) {}\n+\tbool is_enabled() const { return false; }\n+\n+\tvoid spatial_notify_set_transform(Spatial &r_spatial) {}\n+\tvoid spatial_notify_delete(Spatial *p_spatial) {}\n+};\n+#else\n+\n+// Important.\n+// This class uses raw pointers, so it is essential that on deletion, this class is notified\n+// so that any references can be cleared up to prevent dangling pointer access.\n+\n+// This class can be used from a custom SceneTree.\n+\n+// Note we could potentially make SceneTreeFTI static / global to avoid the lookup through scene tree,\n+// but this covers the custom case of multiple scene trees.\n+\n+// This class is not thread safe, but can be made thread safe easily with a mutex as in the 4.x version.\n+\n+class SceneTreeFTI {\n+\tstruct Data {\n+\t\t// Prev / Curr lists of spatials having local xforms pumped.\n+\t\tLocalVector<Spatial *> spatial_tick_list[2];\n+\t\tuint32_t mirror = 0;\n+\n+\t\tbool enabled = false;\n+\n+\t\t// Whether we are in physics ticks, or in a frame.\n+\t\tbool in_frame = false;\n+\n+\t\t// Updating at the start of the frame, or the end on second pass.\n+\t\tbool frame_start = true;\n+\n+\t\tbool debug = false;\n+\t} data;\n+\n+\tvoid _update_dirty_spatials(Node *p_node, uint32_t p_current_frame, float p_interpolation_fraction, bool p_active, const Transform *p_parent_global_xform = nullptr, int p_depth = 0);\n+\tvoid _reset_flags(Node *p_node);\n+\tvoid _spatial_notify_set_transform(Spatial &r_spatial);\n+\n+public:\n+\t// Hottest function, allow inlining the data.enabled check.\n+\tvoid spatial_notify_set_transform(Spatial &r_spatial) {\n+\t\tif (!data.enabled) {\n+\t\t\treturn;\n+\t\t}\n+\t\t_spatial_notify_set_transform(r_spatial);\n+\t}\n+\n+\tvoid spatial_notify_delete(Spatial *p_spatial);\n+\n+\t// Calculate interpolated xforms, send to visual server.\n+\tvoid frame_update(Node *p_root, bool p_frame_start);\n+\n+\t// Update local xform pumps.\n+\tvoid tick_update();\n+\n+\tvoid set_enabled(Node *p_root, bool p_enabled);\n+\tbool is_enabled() const { return data.enabled; }\n+\n+\tvoid set_debug_next_frame() { data.debug = true; }\n+};\n+\n+#endif // ndef _3D_DISABLED\n+\n+#endif // SCENE_TREE_FTI_H\ndiff --git a/servers/visual/rasterizer.h b/servers/visual/rasterizer.h\nindex 2b2259cc17f0..e99b16da6c4c 100644\n--- a/servers/visual/rasterizer.h\n+++ b/servers/visual/rasterizer.h\n@@ -92,16 +92,8 @@ class RasterizerScene {\n \t\tRID material_override;\n \t\tRID material_overlay;\n \n-\t\t// This is the main transform to be drawn with ..\n-\t\t// This will either be the interpolated transform (when using fixed timestep interpolation)\n-\t\t// or the ONLY transform (when not using FTI).\n \t\tTransform transform;\n \n-\t\t// for interpolation we store the current transform (this physics tick)\n-\t\t// and the transform in the previous tick\n-\t\tTransform transform_curr;\n-\t\tTransform transform_prev;\n-\n \t\tint depth_layer;\n \t\tuint32_t layer_mask;\n \n@@ -123,16 +115,6 @@ class RasterizerScene {\n \t\tbool baked_light : 1; //this flag is only to know if it actually did use baked light\n \t\tbool redraw_if_visible : 1;\n \n-\t\tbool on_interpolate_list : 1;\n-\t\tbool on_interpolate_transform_list : 1;\n-\t\tbool interpolated : 1;\n-\t\tTransformInterpolator::Method interpolation_method : 3;\n-\n-\t\t// For fixed timestep interpolation.\n-\t\t// Note 32 bits is plenty for checksum, no need for real_t\n-\t\tfloat transform_checksum_curr;\n-\t\tfloat transform_checksum_prev;\n-\n \t\tfloat depth; //used for sorting\n \n \t\tSelfList<InstanceBase> dependency_item;\n@@ -158,12 +140,6 @@ class RasterizerScene {\n \t\t\tlightmap_capture = nullptr;\n \t\t\tlightmap_slice = -1;\n \t\t\tlightmap_uv_rect = Rect2(0, 0, 1, 1);\n-\t\t\ton_interpolate_list = false;\n-\t\t\ton_interpolate_transform_list = false;\n-\t\t\tinterpolated = true;\n-\t\t\tinterpolation_method = TransformInterpolator::INTERP_LERP;\n-\t\t\ttransform_checksum_curr = 0.0;\n-\t\t\ttransform_checksum_prev = 0.0;\n \t\t}\n \t};\n \ndiff --git a/servers/visual/visual_server_raster.h b/servers/visual/visual_server_raster.h\nindex 6d088c09c3ec..297e3693096a 100644\n--- a/servers/visual/visual_server_raster.h\n+++ b/servers/visual/visual_server_raster.h\n@@ -573,8 +573,6 @@ class VisualServerRaster : public VisualServer {\n \tBIND2(instance_set_layer_mask, RID, uint32_t)\n \tBIND3(instance_set_pivot_data, RID, float, bool)\n \tBIND2(instance_set_transform, RID, const Transform &)\n-\tBIND2(instance_set_interpolated, RID, bool)\n-\tBIND1(instance_reset_physics_interpolation, RID)\n \tBIND2(instance_attach_object_instance_id, RID, ObjectID)\n \tBIND3(instance_set_blend_shape_weight, RID, int, float)\n \tBIND3(instance_set_surface_material, RID, int, RID)\ndiff --git a/servers/visual/visual_server_scene.cpp b/servers/visual/visual_server_scene.cpp\nindex bdea223d5cee..1552469abb6a 100644\n--- a/servers/visual/visual_server_scene.cpp\n+++ b/servers/visual/visual_server_scene.cpp\n@@ -673,9 +673,6 @@ void VisualServerScene::instance_set_scenario(RID p_instance, RID p_scenario) {\n \t\t\t_instance_destroy_occlusion_rep(instance);\n \t\t}\n \n-\t\t// remove any interpolation data associated with the instance in this scenario\n-\t\t_interpolation_data.notify_free_instance(p_instance, *instance);\n-\n \t\tswitch (instance->base_type) {\n \t\t\tcase VS::INSTANCE_LIGHT: {\n \t\t\t\tInstanceLightData *light = static_cast<InstanceLightData *>(instance->base_data);\n@@ -765,27 +762,6 @@ void VisualServerScene::instance_set_pivot_data(RID p_instance, float p_sorting_\n \tinstance->use_aabb_center = p_use_aabb_center;\n }\n \n-void VisualServerScene::instance_reset_physics_interpolation(RID p_instance) {\n-\tInstance *instance = instance_owner.get(p_instance);\n-\tERR_FAIL_COND(!instance);\n-\n-\tif (_interpolation_data.interpolation_enabled && instance->interpolated) {\n-\t\tinstance->transform_prev = instance->transform_curr;\n-\t\tinstance->transform_checksum_prev = instance->transform_checksum_curr;\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\tprint_line(\"instance_reset_physics_interpolation .. tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-\t\tprint_line(\"\\tprev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x));\n-#endif\n-\t}\n-}\n-\n-void VisualServerScene::instance_set_interpolated(RID p_instance, bool p_interpolated) {\n-\tInstance *instance = instance_owner.get(p_instance);\n-\tERR_FAIL_COND(!instance);\n-\tinstance->interpolated = p_interpolated;\n-}\n-\n void VisualServerScene::instance_set_transform(RID p_instance, const Transform &p_transform) {\n \tInstance *instance = instance_owner.get(p_instance);\n \tERR_FAIL_COND(!instance);\n@@ -794,47 +770,8 @@ void VisualServerScene::instance_set_transform(RID p_instance, const Transform &\n \tprint_line(\"instance_set_transform \" + rtos(p_transform.origin.x) + \" .. tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n #endif\n \n-\tif (!(_interpolation_data.interpolation_enabled && instance->interpolated) || !instance->scenario) {\n-\t\tif (instance->transform == p_transform) {\n-\t\t\treturn; //must be checked to avoid worst evil\n-\t\t}\n-\n-#ifdef DEBUG_ENABLED\n-\n-\t\tfor (int i = 0; i < 4; i++) {\n-\t\t\tconst Vector3 &v = i < 3 ? p_transform.basis.elements[i] : p_transform.origin;\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.x));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.x));\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.y));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.y));\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.z));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.z));\n-\t\t}\n-\n-#endif\n-\t\tinstance->transform = p_transform;\n-\t\t_instance_queue_update(instance, true);\n-\n-#if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n-\t\tif ((_interpolation_data.interpolation_enabled && !instance->interpolated) && (Engine::get_singleton()->is_in_physics_frame())) {\n-\t\t\tPHYSICS_INTERPOLATION_NODE_WARNING(instance->object_id, \"Non-interpolated triggered from physics process\");\n-\t\t}\n-#endif\n-\n-\t\treturn;\n-\t}\n-\n-\tfloat new_checksum = TransformInterpolator::checksum_transform(p_transform);\n-\tbool checksums_match = (instance->transform_checksum_curr == new_checksum) && (instance->transform_checksum_prev == new_checksum);\n-\n-\t// we can't entirely reject no changes because we need the interpolation\n-\t// system to keep on stewing\n-\n-\t// Optimized check. First checks the checksums. If they pass it does the slow check at the end.\n-\t// Alternatively we can do this non-optimized and ignore the checksum...\n-\t// if no change\n-\tif (checksums_match && (instance->transform_curr == p_transform) && (instance->transform_prev == p_transform)) {\n-\t\treturn;\n+\tif (instance->transform == p_transform) {\n+\t\treturn; //must be checked to avoid worst evil\n \t}\n \n #ifdef DEBUG_ENABLED\n@@ -850,62 +787,8 @@ void VisualServerScene::instance_set_transform(RID p_instance, const Transform &\n \t}\n \n #endif\n-\n-\tinstance->transform_curr = p_transform;\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\tprint_line(\"\\tprev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x));\n-#endif\n-\n-\t// keep checksums up to date\n-\tinstance->transform_checksum_curr = new_checksum;\n-\n-\tif (!instance->on_interpolate_transform_list) {\n-\t\t_interpolation_data.instance_transform_update_list_curr->push_back(p_instance);\n-\t\tinstance->on_interpolate_transform_list = true;\n-\t} else {\n-\t\tDEV_ASSERT(_interpolation_data.instance_transform_update_list_curr->size());\n-\t}\n-\n-\t// If the instance is invisible, then we are simply updating the data flow, there is no need to calculate the interpolated\n-\t// transform or anything else.\n-\t// Ideally we would not even call the VisualServer::set_transform() when invisible but that would entail having logic\n-\t// to keep track of the previous transform on the SceneTree side. The \"early out\" below is less efficient but a lot cleaner codewise.\n-\tif (!instance->visible) {\n-\t\treturn;\n-\t}\n-\n-\t// decide on the interpolation method .. slerp if possible\n-\tinstance->interpolation_method = TransformInterpolator::find_method(instance->transform_prev.basis, instance->transform_curr.basis);\n-\n-\tif (!instance->on_interpolate_list) {\n-\t\t_interpolation_data.instance_interpolate_update_list.push_back(p_instance);\n-\t\tinstance->on_interpolate_list = true;\n-\t} else {\n-\t\tDEV_ASSERT(_interpolation_data.instance_interpolate_update_list.size());\n-\t}\n-\n+\tinstance->transform = p_transform;\n \t_instance_queue_update(instance, true);\n-\n-#if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n-\tif (!Engine::get_singleton()->is_in_physics_frame()) {\n-\t\tPHYSICS_INTERPOLATION_NODE_WARNING(instance->object_id, \"Interpolated triggered from outside physics process\");\n-\t}\n-#endif\n-}\n-\n-void VisualServerScene::InterpolationData::notify_free_instance(RID p_rid, Instance &r_instance) {\n-\tr_instance.on_interpolate_list = false;\n-\tr_instance.on_interpolate_transform_list = false;\n-\n-\tif (!interpolation_enabled) {\n-\t\treturn;\n-\t}\n-\n-\t// if the instance was on any of the lists, remove\n-\tinstance_interpolate_update_list.erase_multiple_unordered(p_rid);\n-\tinstance_transform_update_list_curr->erase_multiple_unordered(p_rid);\n-\tinstance_transform_update_list_prev->erase_multiple_unordered(p_rid);\n }\n \n void VisualServerScene::update_interpolation_tick(bool p_process) {\n@@ -915,84 +798,11 @@ void VisualServerScene::update_interpolation_tick(bool p_process) {\n \n \t// update interpolation in storage\n \tVSG::storage->update_interpolation_tick(p_process);\n-\n-\t// detect any that were on the previous transform list that are no longer active,\n-\t// we should remove them from the interpolate list\n-\n-\tfor (unsigned int n = 0; n < _interpolation_data.instance_transform_update_list_prev->size(); n++) {\n-\t\tconst RID &rid = (*_interpolation_data.instance_transform_update_list_prev)[n];\n-\t\tInstance *instance = instance_owner.getornull(rid);\n-\n-\t\tbool active = true;\n-\n-\t\t// no longer active? (either the instance deleted or no longer being transformed)\n-\t\tif (instance && !instance->on_interpolate_transform_list) {\n-\t\t\tactive = false;\n-\t\t\tinstance->on_interpolate_list = false;\n-\n-\t\t\t// make sure the most recent transform is set\n-\t\t\tinstance->transform = instance->transform_curr;\n-\n-\t\t\t// and that both prev and current are the same, just in case of any interpolations\n-\t\t\tinstance->transform_prev = instance->transform_curr;\n-\n-\t\t\t// make sure are updated one more time to ensure the AABBs are correct\n-\t\t\t_instance_queue_update(instance, true);\n-\t\t}\n-\n-\t\tif (!instance) {\n-\t\t\tactive = false;\n-\t\t}\n-\n-\t\tif (!active) {\n-\t\t\t_interpolation_data.instance_interpolate_update_list.erase(rid);\n-\t\t}\n-\t}\n-\n-\t// and now for any in the transform list (being actively interpolated), keep the previous transform\n-\t// value up to date ready for the next tick\n-\tif (p_process) {\n-\t\tfor (unsigned int n = 0; n < _interpolation_data.instance_transform_update_list_curr->size(); n++) {\n-\t\t\tconst RID &rid = (*_interpolation_data.instance_transform_update_list_curr)[n];\n-\t\t\tInstance *instance = instance_owner.getornull(rid);\n-\t\t\tif (instance) {\n-\t\t\t\tinstance->transform_prev = instance->transform_curr;\n-\t\t\t\tinstance->transform_checksum_prev = instance->transform_checksum_curr;\n-\t\t\t\tinstance->on_interpolate_transform_list = false;\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-\t// we maintain a mirror list for the transform updates, so we can detect when an instance\n-\t// is no longer being transformed, and remove it from the interpolate list\n-\tSWAP(_interpolation_data.instance_transform_update_list_curr, _interpolation_data.instance_transform_update_list_prev);\n-\n-\t// prepare for the next iteration\n-\t_interpolation_data.instance_transform_update_list_curr->clear();\n }\n \n void VisualServerScene::update_interpolation_frame(bool p_process) {\n \t// update interpolation in storage\n \tVSG::storage->update_interpolation_frame(p_process);\n-\n-\tif (p_process) {\n-\t\treal_t f = Engine::get_singleton()->get_physics_interpolation_fraction();\n-\n-\t\tfor (unsigned int i = 0; i < _interpolation_data.instance_interpolate_update_list.size(); i++) {\n-\t\t\tconst RID &rid = _interpolation_data.instance_interpolate_update_list[i];\n-\t\t\tInstance *instance = instance_owner.getornull(rid);\n-\t\t\tif (instance) {\n-\t\t\t\tTransformInterpolator::interpolate_transform_via_method(instance->transform_prev, instance->transform_curr, instance->transform, f, instance->interpolation_method);\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\t\t\tprint_line(\"\\t\\tinterpolated: \" + rtos(instance->transform.origin.x) + \"\\t( prev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x) + \" ) on tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-#endif\n-\n-\t\t\t\t// make sure AABBs are constantly up to date through the interpolation\n-\t\t\t\t_instance_queue_update(instance, true);\n-\t\t\t}\n-\t\t} // for n\n-\t}\n }\n \n void VisualServerScene::instance_attach_object_instance_id(RID p_instance, ObjectID p_id) {\n@@ -1046,25 +856,6 @@ void VisualServerScene::instance_set_visible(RID p_instance, bool p_visible) {\n \n \tinstance->visible = p_visible;\n \n-\t// Special case for physics interpolation, we want to ensure the interpolated data is up to date\n-\tif (_interpolation_data.interpolation_enabled && p_visible && instance->interpolated && instance->scenario && !instance->on_interpolate_list) {\n-\t\t// Do all the extra work we normally do on instance_set_transform(), because this is optimized out for hidden instances.\n-\t\t// This prevents a glitch of stale interpolation transform data when unhiding before the next physics tick.\n-\t\tinstance->interpolation_method = TransformInterpolator::find_method(instance->transform_prev.basis, instance->transform_curr.basis);\n-\t\t_interpolation_data.instance_interpolate_update_list.push_back(p_instance);\n-\t\tinstance->on_interpolate_list = true;\n-\t\t_instance_queue_update(instance, true);\n-\n-\t\t// We must also place on the transform update list for a tick, so the system\n-\t\t// can auto-detect if the instance is no longer moving, and remove from the interpolate lists again.\n-\t\t// If this step is ignored, an unmoving instance could remain on the interpolate lists indefinitely\n-\t\t// (or rather until the object is deleted) and cause unnecessary updates and drawcalls.\n-\t\tif (!instance->on_interpolate_transform_list) {\n-\t\t\t_interpolation_data.instance_transform_update_list_curr->push_back(p_instance);\n-\t\t\tinstance->on_interpolate_transform_list = true;\n-\t\t}\n-\t}\n-\n \t// give the opportunity for the spatial partitioning scene to use a special implementation of visibility\n \t// for efficiency (supported in BVH but not octree)\n \n@@ -4496,7 +4287,6 @@ bool VisualServerScene::free(RID p_rid) {\n \t\tupdate_dirty_instances();\n \n \t\tInstance *instance = instance_owner.get(p_rid);\n-\t\t_interpolation_data.notify_free_instance(p_rid, *instance);\n \n \t\tinstance_set_use_lightmap(p_rid, RID(), RID(), -1, Rect2(0, 0, 1, 1));\n \t\tinstance_set_scenario(p_rid, RID());\ndiff --git a/servers/visual/visual_server_scene.h b/servers/visual/visual_server_scene.h\nindex 56b6ceb5b60b..76b890765796 100644\n--- a/servers/visual/visual_server_scene.h\n+++ b/servers/visual/visual_server_scene.h\n@@ -397,12 +397,6 @@ class VisualServerScene {\n \tvirtual void set_physics_interpolation_enabled(bool p_enabled);\n \n \tstruct InterpolationData {\n-\t\tvoid notify_free_instance(RID p_rid, Instance &r_instance);\n-\t\tLocalVector<RID> instance_interpolate_update_list;\n-\t\tLocalVector<RID> instance_transform_update_lists[2];\n-\t\tLocalVector<RID> *instance_transform_update_list_curr = &instance_transform_update_lists[0];\n-\t\tLocalVector<RID> *instance_transform_update_list_prev = &instance_transform_update_lists[1];\n-\n \t\tbool interpolation_enabled = false;\n \t} _interpolation_data;\n \n@@ -662,8 +656,6 @@ class VisualServerScene {\n \tvirtual void instance_set_layer_mask(RID p_instance, uint32_t p_mask);\n \tvirtual void instance_set_pivot_data(RID p_instance, float p_sorting_offset, bool p_use_aabb_center);\n \tvirtual void instance_set_transform(RID p_instance, const Transform &p_transform);\n-\tvirtual void instance_set_interpolated(RID p_instance, bool p_interpolated);\n-\tvirtual void instance_reset_physics_interpolation(RID p_instance);\n \tvirtual void instance_attach_object_instance_id(RID p_instance, ObjectID p_id);\n \tvirtual void instance_set_blend_shape_weight(RID p_instance, int p_shape, float p_weight);\n \tvirtual void instance_set_surface_material(RID p_instance, int p_surface, RID p_material);\ndiff --git a/servers/visual/visual_server_wrap_mt.h b/servers/visual/visual_server_wrap_mt.h\nindex 6ba16fb7786f..a422de5f6401 100644\n--- a/servers/visual/visual_server_wrap_mt.h\n+++ b/servers/visual/visual_server_wrap_mt.h\n@@ -481,8 +481,6 @@ class VisualServerWrapMT : public VisualServer {\n \tFUNC2(instance_set_layer_mask, RID, uint32_t)\n \tFUNC3(instance_set_pivot_data, RID, float, bool)\n \tFUNC2(instance_set_transform, RID, const Transform &)\n-\tFUNC2(instance_set_interpolated, RID, bool)\n-\tFUNC1(instance_reset_physics_interpolation, RID)\n \tFUNC2(instance_attach_object_instance_id, RID, ObjectID)\n \tFUNC3(instance_set_blend_shape_weight, RID, int, float)\n \tFUNC3(instance_set_surface_material, RID, int, RID)\ndiff --git a/servers/visual_server.cpp b/servers/visual_server.cpp\nindex f13470cf11de..93ca55c52437 100644\n--- a/servers/visual_server.cpp\n+++ b/servers/visual_server.cpp\n@@ -2172,8 +2172,6 @@ void VisualServer::_bind_methods() {\n \tClassDB::bind_method(D_METHOD(\"instance_set_scenario\", \"instance\", \"scenario\"), &VisualServer::instance_set_scenario);\n \tClassDB::bind_method(D_METHOD(\"instance_set_layer_mask\", \"instance\", \"mask\"), &VisualServer::instance_set_layer_mask);\n \tClassDB::bind_method(D_METHOD(\"instance_set_transform\", \"instance\", \"transform\"), &VisualServer::instance_set_transform);\n-\tClassDB::bind_method(D_METHOD(\"instance_set_interpolated\", \"instance\", \"interpolated\"), &VisualServer::instance_set_interpolated);\n-\tClassDB::bind_method(D_METHOD(\"instance_reset_physics_interpolation\", \"instance\"), &VisualServer::instance_reset_physics_interpolation);\n \tClassDB::bind_method(D_METHOD(\"instance_attach_object_instance_id\", \"instance\", \"id\"), &VisualServer::instance_attach_object_instance_id);\n \tClassDB::bind_method(D_METHOD(\"instance_set_blend_shape_weight\", \"instance\", \"shape\", \"weight\"), &VisualServer::instance_set_blend_shape_weight);\n \tClassDB::bind_method(D_METHOD(\"instance_set_surface_material\", \"instance\", \"surface\", \"material\"), &VisualServer::instance_set_surface_material);\ndiff --git a/servers/visual_server.h b/servers/visual_server.h\nindex 9668be06c56f..7ea42a4ebf34 100644\n--- a/servers/visual_server.h\n+++ b/servers/visual_server.h\n@@ -878,8 +878,6 @@ class VisualServer : public Object {\n \tvirtual void instance_set_layer_mask(RID p_instance, uint32_t p_mask) = 0;\n \tvirtual void instance_set_pivot_data(RID p_instance, float p_sorting_offset, bool p_use_aabb_center) = 0;\n \tvirtual void instance_set_transform(RID p_instance, const Transform &p_transform) = 0;\n-\tvirtual void instance_set_interpolated(RID p_instance, bool p_interpolated) = 0;\n-\tvirtual void instance_reset_physics_interpolation(RID p_instance) = 0;\n \tvirtual void instance_attach_object_instance_id(RID p_instance, ObjectID p_id) = 0;\n \tvirtual void instance_set_blend_shape_weight(RID p_instance, int p_shape, float p_weight) = 0;\n \tvirtual void instance_set_surface_material(RID p_instance, int p_surface, RID p_material) = 0;\n", "test_patch": "", "problem_statement": "Skeleton's deferred update process should be performed after physics interpolation\n### Tested versions\n\n- Reproduced in v4.4.beta4.official [93d270693]\n\n### System information\n\nGodot v4.4.beta4 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Ti (NVIDIA; 32.0.15.6636) - 12th Gen Intel(R) Core(TM) i9-12900K (24 threads)\n\n### Issue description\n\nEnabling physics interpolation in project settings and following procedures to manually implement interpolation for camera movement ([trying to follow this](https://docs.godotengine.org/en/3.6/tutorials/physics/interpolation/advanced_physics_interpolation.html#mouse-look)) results in the SkeletonIK3D failing to have physics interpolation while moving and looking around, while everything else is smooth:\n\nhttps://github.com/user-attachments/assets/0645a0ac-7f8b-48fe-a912-1e8695df23ec\n\n\nIt is noteworthy that disabling physics interpolation globally but keeping the manual implementation on the camera results in smooth ik movement when looking around but NOT while walking:\n\nhttps://github.com/user-attachments/assets/bf066442-43d8-4549-9d8b-55cc49cd6035\n\nIt's entirely possible I am implementing this incorrectly, in which case, better documentation/information would be really helpful, as currently it seems unclear how to properly implement first person camera mouse movement with physics interpolation on high refresh monitors and inverse kinematics.\n\n### Steps to reproduce\n\n1. Enable physics interpolation globally and turn down the physics tick rate to 10 (so the effect is more clear)\n2. Create a first person player with a camera child that is top level and has it's interpolation turned off, and manually implemented (see camera_3d.gd)\n3. Using a rigged model (provided in the MRP) attach a skeletonIK3D node and put its target to a Marker3D node that is a child of the camera\n4. Play the project and walk/look around\n\n\n### Minimal reproduction project (MRP)\n\n[firstpersontest.zip](https://github.com/user-attachments/files/18858802/firstpersontest.zip)\n", "hints_text": "To synchronize with Node using the Physics process, the Modifier update process in Skeleton should be Physics as well.\n\n![Image](https://github.com/user-attachments/assets/ccdbe6ff-f271-4bde-bb05-c382aac2dbed)\nThanks for the response @TokageItLab Enabling that results in this behavior when at a low physics rate:\n\nhttps://github.com/user-attachments/assets/86507b5d-1f65-4267-be9a-a1b4aed2b761\n\nAnd at 60 physics ticks, the IK is still very jittery:\n\nhttps://github.com/user-attachments/assets/eab403c8-ea99-4ee7-b4e7-86a22ea49161\nI see, so there are two out-of-sync behaviors in the video in the description.\n\n- \"Idle\" vs \"Physics\" Process\n- \"Interpolated\" vs \"Non-interpolated\" Physics result\n\nRegarding the former, as I commented above, the synchronization gap between Physics Process and Idle Process can be solved by setting the Modifier's CallbackModeProcess to Physics. When the FPS is low, it seems to be reduced, but actually, the latter synchronization gap is still left.\n\nThe current process order looks like this:\n\n1. Skeleton3D's _physics_process to make a flag to deferred update \n2. iterate SkeletonModifiers in skeleton deferred update process\n3. PhysicalServer's physics interpolation\n\nHowever, ideally, the process should be done in the following order:\n\n1. Skeleton3D's _physics_process to make a flag to deferred update \n2. PhysicalServer's physics interpolation\n3. iterate SkeletonModifiers in skeleton deferred update process\n\nAny good ideas on how to resolve this @lawnjelly ?\n\nI don't know the details of how Physics Interpolation is implemented. However, if the Physics Interpolation is done in conjunction with the RenderingServer, I would think we could do something within the RenderingServer. If not so, I guess it might require some additional processing for the Skeleton's Physics Process to wait for Physics Interpolation to be processed.\nJust taking a look.\n\nFirst thing (which isn't really related to the behaviour your are seeing) is that for your `Camera` script, you are pointing to the correct documentation, but you don't need to do all that stuff yourself (storing previous and current xforms of the target, and interpolating), it can be done automatically for you by calling the helper function `get_global_transform_interpolated()`.\n\nSo you just need a one-liner:\n```\nfunc _process(_delta):\n\tglobal_position = target.get_global_transform_interpolated().origin\n```\nThat's literally it, providing you have turned interpolation off (`set_physics_interpolation_mode(Node.PHYSICS_INTERPOLATION_MODE_OFF)` or in the inspector).\n\nIndeed your method for updating prev and curr xforms looks to have bugs (I don't think it will work if two physics ticks occur before a frame), which is why using the in-built method is advised, aside from being less verbose etc.\nOk I have a workaround for now, add this script to `Skeleton3D` (and keep it in idle mode):\n\n```\nextends Skeleton3D\n\nfunc _ready() -> void:\n\tset_as_top_level(true)\n\tphysics_interpolation_mode = Node.PHYSICS_INTERPOLATION_MODE_OFF\n\t\nfunc _process(delta: float) -> void:\n\tglobal_transform = get_parent().get_global_transform_interpolated()\n```\nThis is presumably also a problem in 3.x, I only tested the IK with the Godot IK demo which had a non-moving root node.\n\nI figured out IK works most sensibly when kept in idle mode, with physics interpolation OFF for the skeleton, the only difference is that the target should be client interpolated, so in the c++ code it calls `get_global_transform_interpolated()` for the target. And it works great when the root node of the skeleton is not moving.\n\nWhen moving, the problem is that the skeleton root will jump on each physics tick if physics interpolation is off. So we actually want the `Skeleton3D` itself to be interpolated, but the bones to be non-interpolated. There's no easy shortcut for this in the inspector, which is why I've done it in a script above (turned off interpolation in the `Skeleton3D` and hence all its bone children, and manually interpolated the `Skeleton3D` itself).\n\nI'll look at a PR to do this automagically - I'll probably look at this after the weekend as there are some deeper considerations as `Skeleton3D` is shared for a number of different areas - including animation, IK and ragdoll .. so needs to work well with all (and modifications for one can cause regressions in another).\n\n_As an aside, it is also possible theoretically to run the IK totally on the physics tick, but because interpolation is approximate, that means on the in betweener frames the IK will not line up exactly with the target, and it will appear as subtle jitter, which is why I thought it better to standardize on running the IK on the frame. Particle systems are also a similar exception, where it is often better to run them without physics interpolation._ \nHere's the end result:\n\nhttps://github.com/user-attachments/assets/9e193205-7a80-46de-ab52-c4dce5b71f5f\nThank you for this!\nBtw, I have a similar problem with a Skeleton2D. Unfortunately, there is no `get_global_transform_interpolated()` in 2D, so the trick above doesn't apply.\n> Btw, I have a similar problem with a Skeleton2D. Unfortunately, there is no `get_global_transform_interpolated()` in 2D, so the trick above doesn't apply.\n\n2D will need its own issue .. it's related, but physics interpolation works very differently in 2D, transform traversal is done server side in 2D, in 3D it is done client side in the scene tree and only global xforms are uploaded to the server.", "created_at": "2025-03-06 10:21:11", "merge_commit_sha": "5155fe5a4f138dc6a4f83b383d02a20b5be37b6c", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Linux Headless w/ Mono (target=release_debug, tools=yes)', '.github/workflows/runner.yml']", "['Static Checks (clang-format, black format, file format, documentation checks)', '.github/workflows/runner.yml']"], ["['Linux Server w/ Mono (target=release, tools=no)', '.github/workflows/runner.yml']", "['Editor (target=release_debug, tools=yes)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103607", "base_commit": "0028fd625e2c5b202e204bc12828cbca043213d3", "patch": "diff --git a/scene/resources/style_box_flat.cpp b/scene/resources/style_box_flat.cpp\nindex e4dd48d1635e..4e2e5823effd 100644\n--- a/scene/resources/style_box_flat.cpp\n+++ b/scene/resources/style_box_flat.cpp\n@@ -234,6 +234,79 @@ inline void set_inner_corner_radius(const Rect2 style_rect, const Rect2 inner_re\n \tinner_corner_radius[3] = MAX(corner_radius[3] - MIN(border_bottom, border_left), 0); // Bottom left.\n }\n \n+inline void set_corner_scale(const Rect2 &style_rect, const Rect2 &inner_rect, const real_t corner_radius[4], Point2 *inner_scale) {\n+\treal_t border_left = inner_rect.position.x - style_rect.position.x;\n+\treal_t border_top = inner_rect.position.y - style_rect.position.y;\n+\treal_t border_right = style_rect.size.width - inner_rect.size.width - border_left;\n+\treal_t border_bottom = style_rect.size.height - inner_rect.size.height - border_top;\n+\n+\t// Amount of overflow along an edge.\n+\t// Ex. SIDE_LEFT edge is the overflow between top_left and bottom_left corners.\n+\t// MIN(0,) is to ignore underflow, and negating is to make values positive.\n+\treal_t edge_overflow[4] = {\n+\t\t-MIN(0, inner_rect.size.y - corner_radius[CORNER_TOP_LEFT] - corner_radius[CORNER_BOTTOM_LEFT]),\n+\t\t-MIN(0, inner_rect.size.x - corner_radius[CORNER_TOP_LEFT] - corner_radius[CORNER_TOP_RIGHT]),\n+\t\t-MIN(0, inner_rect.size.y - corner_radius[CORNER_TOP_RIGHT] - corner_radius[CORNER_BOTTOM_RIGHT]),\n+\t\t-MIN(0, inner_rect.size.x - corner_radius[CORNER_BOTTOM_LEFT] - corner_radius[CORNER_BOTTOM_RIGHT])\n+\t};\n+\n+\t// Sums of borders.\n+\treal_t hb_sum = border_left + border_right;\n+\treal_t vb_sum = border_top + border_bottom;\n+\n+\t// Ratio of each side to the sum of itself and opposite side.\n+\t// Since overflow only happens with opposite borders, you only need to get the ratio of each border relative to the sum of involved borders.\n+\treal_t ratios[4] = {\n+\t\t// Prevent divide by 0 errors.\n+\t\thb_sum > 0 ? (border_left / hb_sum) : 0,\n+\t\tvb_sum > 0 ? (border_top / vb_sum) : 0,\n+\t\thb_sum > 0 ? (border_right / hb_sum) : 0,\n+\t\tvb_sum > 0 ? (border_bottom / vb_sum) : 0\n+\t};\n+\n+\t// Raw amount each corner should shrink.\n+\tPoint2 corner_reduction[4] = {\n+\t\tPoint2(edge_overflow[SIDE_TOP] * ratios[SIDE_LEFT], edge_overflow[SIDE_LEFT] * ratios[SIDE_TOP]),\n+\t\tPoint2(edge_overflow[SIDE_TOP] * ratios[SIDE_RIGHT], edge_overflow[SIDE_RIGHT] * ratios[SIDE_TOP]),\n+\t\tPoint2(edge_overflow[SIDE_BOTTOM] * ratios[SIDE_RIGHT], edge_overflow[SIDE_RIGHT] * ratios[SIDE_BOTTOM]),\n+\t\tPoint2(edge_overflow[SIDE_BOTTOM] * ratios[SIDE_LEFT], edge_overflow[SIDE_LEFT] * ratios[SIDE_BOTTOM]),\n+\t};\n+\n+\t// Corner Radii as Point2s.\n+\tPoint2 pcr[4] = {\n+\t\tPoint2(corner_radius[0], corner_radius[0]),\n+\t\tPoint2(corner_radius[1], corner_radius[1]),\n+\t\tPoint2(corner_radius[2], corner_radius[2]),\n+\t\tPoint2(corner_radius[3], corner_radius[3]),\n+\t};\n+\n+\t// If corner radii are too small, they won't shrink the full amount.\n+\t// Adjacent corners will have to shrink the leftovers if they can.\n+\t// Minf(0) is to ignore non-leftovers, and negating is to make values positive.\n+\tPoint2 leftovers[4] = {\n+\t\t-((pcr[0] - corner_reduction[0]).minf(0)),\n+\t\t-((pcr[1] - corner_reduction[1]).minf(0)),\n+\t\t-((pcr[2] - corner_reduction[2]).minf(0)),\n+\t\t-((pcr[3] - corner_reduction[3]).minf(0)),\n+\t};\n+\n+\t// New shrunken radii after distributing the leftovers.\n+\tPoint2 distributed[4] = {\n+\t\t((pcr[0] - corner_reduction[0] - leftovers[3] - leftovers[1]).maxf(0)),\n+\t\t((pcr[1] - corner_reduction[1] - leftovers[0] - leftovers[2]).maxf(0)),\n+\t\t((pcr[2] - corner_reduction[2] - leftovers[1] - leftovers[3]).maxf(0)),\n+\t\t((pcr[3] - corner_reduction[3] - leftovers[2] - leftovers[0]).maxf(0)),\n+\t};\n+\n+\t// How much the curve should scale to achieve the shrunken radii.\n+\tfor (int i = 0; i < 4; i++) {\n+\t\t// Unshrinkable is how much is still left over, even after distributing leftovers.\n+\t\t// Exclude it from the final scale.\n+\t\tPoint2 unshrinkable = (leftovers[(i + 1) % 4] + leftovers[(i + 4 - 1) % 4] - distributed[i]).maxf(0);\n+\t\tinner_scale[i] = distributed[i] / (pcr[i] - unshrinkable).maxf(FLT_EPSILON);\n+\t}\n+}\n+\n inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices, Vector<Color> &colors, const Rect2 &style_rect, const real_t corner_radius[4],\n \t\tconst Rect2 &ring_rect, const Rect2 &inner_rect, const Color &inner_color, const Color &outer_color, const int corner_detail, const Vector2 &skew, bool is_filled = false) {\n \tint vert_offset = verts.size();\n@@ -244,23 +317,30 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \treal_t ring_corner_radius[4];\n \tset_inner_corner_radius(style_rect, ring_rect, corner_radius, ring_corner_radius);\n \n+\tPoint2 ring_scale[4];\n+\tset_corner_scale(style_rect, ring_rect, ring_corner_radius, ring_scale);\n+\n \t// Corner radius center points.\n \tVector<Point2> outer_points = {\n-\t\tring_rect.position + Vector2(ring_corner_radius[0], ring_corner_radius[0]), //tl\n-\t\tPoint2(ring_rect.position.x + ring_rect.size.x - ring_corner_radius[1], ring_rect.position.y + ring_corner_radius[1]), //tr\n-\t\tring_rect.position + ring_rect.size - Vector2(ring_corner_radius[2], ring_corner_radius[2]), //br\n-\t\tPoint2(ring_rect.position.x + ring_corner_radius[3], ring_rect.position.y + ring_rect.size.y - ring_corner_radius[3]) //bl\n+\t\tring_rect.position + Vector2(ring_corner_radius[0], ring_corner_radius[0]) * ring_scale[0], //tl\n+\t\tPoint2(ring_rect.position.x + ring_rect.size.x - ring_corner_radius[1] * ring_scale[1].x, ring_rect.position.y + ring_corner_radius[1] * ring_scale[1].y), //tr\n+\t\tring_rect.position + ring_rect.size - Vector2(ring_corner_radius[2], ring_corner_radius[2]) * ring_scale[2], //br\n+\t\tPoint2(ring_rect.position.x + ring_corner_radius[3] * ring_scale[3].x, ring_rect.position.y + ring_rect.size.y - ring_corner_radius[3] * ring_scale[3].y) //bl\n \t};\n \n \treal_t inner_corner_radius[4];\n \tset_inner_corner_radius(style_rect, inner_rect, corner_radius, inner_corner_radius);\n \n+\tPoint2 inner_scale[4];\n+\tset_corner_scale(style_rect, inner_rect, inner_corner_radius, inner_scale);\n+\n \tVector<Point2> inner_points = {\n-\t\tinner_rect.position + Vector2(inner_corner_radius[0], inner_corner_radius[0]), //tl\n-\t\tPoint2(inner_rect.position.x + inner_rect.size.x - inner_corner_radius[1], inner_rect.position.y + inner_corner_radius[1]), //tr\n-\t\tinner_rect.position + inner_rect.size - Vector2(inner_corner_radius[2], inner_corner_radius[2]), //br\n-\t\tPoint2(inner_rect.position.x + inner_corner_radius[3], inner_rect.position.y + inner_rect.size.y - inner_corner_radius[3]) //bl\n+\t\tinner_rect.position + Vector2(inner_corner_radius[0], inner_corner_radius[0]) * inner_scale[0], //tl\n+\t\tPoint2(inner_rect.position.x + inner_rect.size.x - inner_corner_radius[1] * inner_scale[1].x, inner_rect.position.y + inner_corner_radius[1] * inner_scale[1].y), //tr\n+\t\tinner_rect.position + inner_rect.size - Vector2(inner_corner_radius[2], inner_corner_radius[2]) * inner_scale[2], //br\n+\t\tPoint2(inner_rect.position.x + inner_corner_radius[3] * inner_scale[3].x, inner_rect.position.y + inner_rect.size.y - inner_corner_radius[3] * inner_scale[3].y) //bl\n \t};\n+\n \t// Calculate the vertices.\n \n \t// If the center is filled, we do not draw the border and directly use the inner ring as reference. Because all calls to this\n@@ -289,8 +369,8 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \t\t\tconst real_t angle_sine = Math::sin(pt_angle);\n \n \t\t\t{\n-\t\t\t\tconst real_t x = inner_corner_radius[corner_idx] * angle_cosine + inner_points[corner_idx].x;\n-\t\t\t\tconst real_t y = inner_corner_radius[corner_idx] * angle_sine + inner_points[corner_idx].y;\n+\t\t\t\tconst real_t x = inner_corner_radius[corner_idx] * angle_cosine * inner_scale[corner_idx].x + inner_points[corner_idx].x;\n+\t\t\t\tconst real_t y = inner_corner_radius[corner_idx] * angle_sine * inner_scale[corner_idx].y + inner_points[corner_idx].y;\n \t\t\t\tconst float x_skew = -skew.x * (y - style_rect_center.y);\n \t\t\t\tconst float y_skew = -skew.y * (x - style_rect_center.x);\n \t\t\t\tverts_ptr[verts_size + idx_ofs] = Vector2(x + x_skew, y + y_skew);\n@@ -298,8 +378,8 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \t\t\t}\n \n \t\t\tif (draw_border) {\n-\t\t\t\tconst real_t x = ring_corner_radius[corner_idx] * angle_cosine + outer_points[corner_idx].x;\n-\t\t\t\tconst real_t y = ring_corner_radius[corner_idx] * angle_sine + outer_points[corner_idx].y;\n+\t\t\t\tconst real_t x = ring_corner_radius[corner_idx] * angle_cosine * ring_scale[corner_idx].x + outer_points[corner_idx].x;\n+\t\t\t\tconst real_t y = ring_corner_radius[corner_idx] * angle_sine * ring_scale[corner_idx].y + outer_points[corner_idx].y;\n \t\t\t\tconst float x_skew = -skew.x * (y - style_rect_center.y);\n \t\t\t\tconst float y_skew = -skew.y * (x - style_rect_center.x);\n \t\t\t\tverts_ptr[verts_size + idx_ofs + 1] = Vector2(x + x_skew, y + y_skew);\n", "test_patch": "", "problem_statement": "Panel - StyleBoxFlat with rounded borders LEFT and RIGHT creates a line of lighter color in the middle of the panel\n### Tested versions\n\nGodot Engine v4.3.stable.official.77dcf97d8\n\n\n### System information\n\nWin11 - OpenGL API 3.3.0 NVIDIA 572.16 - Compatibility - Using Device: NVIDIA - NVIDIA GeForce RTX 2060 SUPER\n\n### Issue description\n\nLeft and Right border (light line is present):\n![Image](https://github.com/user-attachments/assets/f94e6e4b-8173-464b-9ed6-d0e5d7af2fb0)\n\nTop and Bottom (no light line):\n![Image](https://github.com/user-attachments/assets/b4c36057-f442-4d78-9baf-213999381178)\n\nAt runtime:\n![Image](https://github.com/user-attachments/assets/cedfed74-36c6-4791-8e9a-1a9f33552e63)\n\nBut if I change the size (to a greater value on X axis) - the line disappears:\n![Image](https://github.com/user-attachments/assets/8b8005c4-d0db-47b3-8bc8-99ff73fa65b9)\n\n### Steps to reproduce\n\n1. Create a Panel\n2. Change the size to 128x128\n3. Add StyleBoxFlat in Theme Override - Styles\n4. Set all Corner Radiuses to 70 (to create the circle)\n5. Change the BG color to a darker one with some opacity\n6. In Border Width for the StyleBox start adding to LEFT or RIGHT (or both)\n\n### Minimal reproduction project (MRP)\n\nNot needed\n", "hints_text": "", "created_at": "2025-03-05 03:22:58", "merge_commit_sha": "53749174a311cf22c76c6bf6d4538c0da7d6bff1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103526", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex 26c94bf25cf1..ead01551939f 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -2563,7 +2563,8 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\tAtom *atoms = (Atom *)data;\n \t\tAtom wm_act_max_horz;\n \t\tAtom wm_act_max_vert;\n-\t\tif (strcmp(p_atom_name, \"_NET_WM_STATE\") == 0) {\n+\t\tbool checking_state = strcmp(p_atom_name, \"_NET_WM_STATE\") == 0;\n+\t\tif (checking_state) {\n \t\t\twm_act_max_horz = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_HORZ\", False);\n \t\t\twm_act_max_vert = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_VERT\", False);\n \t\t} else {\n@@ -2581,9 +2582,16 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\t\t\tfound_wm_act_max_vert = true;\n \t\t\t}\n \n-\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n-\t\t\t\tretval = true;\n-\t\t\t\tbreak;\n+\t\t\tif (checking_state) {\n+\t\t\t\tif (found_wm_act_max_horz && found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \n", "test_patch": "", "problem_statement": "Persistent window state does not work for linux X11 gnome-shell 'tiled/docked/snapped' editor windows\n### Tested versions\n\n- Reproducible on Godot 4.4-stable\n\n### System information\n\nGodot v4.4.stable - Ubuntu 22.04.5 LTS 22.04 on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3050 Laptop GPU - 12th Gen Intel(R) Core(TM) i7-12700H (14 threads)\n\n### Issue description\n\n[Persistent window state](https://godotengine.org/releases/4.4/#persistent-window-state) doesn't work if your window is 'tiled' in X11 gnome.\n\nTested on X11 GNOME Shell 42.9  Xorg: 1:7.7+23ubuntu2\n\n\nIt looks like `_NET_WM_STATE` is `..._MAXIMIZED_VERT` which isn't the same as maximized..\n\nThe window geometry is `0,65+2558x1375`\n\nBut when I re-open it becomes `..._MAXIMIZED_VERT | ..._MAXIMIZED_HORIZ`\nand the window geometry is  `0,64+5120x1376`\n\nBEFORE closing\n```\n_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 89\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 65\n                program specified size: 2558 by 1375\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4045156\n```\n\nAFTER re-opening\n```_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_HORZ, _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 85\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 64\n                program specified size: 5120 by 1376\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4048202\n```\n\n### Steps to reproduce\n\nRe-open the window in gnome window manager after snapping to the left or right\n\n### Minimal reproduction project (MRP)\n\nno MRP possible?\n", "hints_text": "", "created_at": "2025-03-03 22:09:23", "merge_commit_sha": "1f2d135444f68a6a60372e48431d210e7943c6f0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103523", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/platform/android/java_godot_lib_jni.cpp b/platform/android/java_godot_lib_jni.cpp\nindex 054c809c6e3f..0bb78bb9d974 100644\n--- a/platform/android/java_godot_lib_jni.cpp\n+++ b/platform/android/java_godot_lib_jni.cpp\n@@ -49,6 +49,7 @@\n #include \"core/config/project_settings.h\"\n #include \"core/input/input.h\"\n #include \"main/main.h\"\n+#include \"servers/rendering_server.h\"\n \n #ifndef _3D_DISABLED\n #include \"servers/xr_server.h\"\n", "test_patch": "", "problem_statement": "Build error when building for Android with `disable_3d=yes`\n### Tested versions\n\n- Reproducible in: 4.4-stable\n- Not reproducible in 4.3-stable and lower\n\n### System information\n\nArch Linux x86_64 6.13.5-arch1-1\n\n### Issue description\n\nGodot doesn't compile when using the `disable_3d=yes` option in scons\n\n```\nplatform/android/java_godot_lib_jni.cpp:478:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:478:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\n```\n\nTested in Arch Linux and Ubuntu 20.04. No difference.\nThis didn't happen on 4.3 version\nAfter some research it seems like this is connected to this commit: [28d1dcc](https://github.com/godotengine/godot/commit/28d1dccf6370a1754c9bd49b9e5ec3f15db1e535)\n\n### Steps to reproduce\n\n1. Download Godot source code and required build tools\n2. Compile the engine with command `scons platform=android arch=x86_64 disable_3d=yes`\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "hints_text": "", "created_at": "2025-03-03 21:19:38", "merge_commit_sha": "1753893c60ac309c21a77201725fa2820caf7f1e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103508", "base_commit": "4c311cbee68c0b66ff8ebb8b0defdd9979dd2a41", "patch": "diff --git a/doc/classes/LineEdit.xml b/doc/classes/LineEdit.xml\nindex c6cdacb6ec25..879b179dbfef 100644\n--- a/doc/classes/LineEdit.xml\n+++ b/doc/classes/LineEdit.xml\n@@ -252,7 +252,7 @@\n \t\t\tThe caret's column position inside the [LineEdit]. When set, the text may scroll to accommodate it.\n \t\t</member>\n \t\t<member name=\"caret_force_displayed\" type=\"bool\" setter=\"set_caret_force_displayed\" getter=\"is_caret_force_displayed\" default=\"false\">\n-\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if focus is lost.\n+\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if not editing or focus is lost.\n \t\t</member>\n \t\t<member name=\"caret_mid_grapheme\" type=\"bool\" setter=\"set_caret_mid_grapheme_enabled\" getter=\"is_caret_mid_grapheme_enabled\" default=\"false\">\n \t\t\tAllow moving caret, selecting and removing the individual composite character components.\ndiff --git a/scene/gui/line_edit.cpp b/scene/gui/line_edit.cpp\nindex 969e2fd3a35c..f4d66d5a281d 100644\n--- a/scene/gui/line_edit.cpp\n+++ b/scene/gui/line_edit.cpp\n@@ -1733,7 +1733,7 @@ void LineEdit::_validate_caret_can_draw() {\n \t\tdraw_caret = true;\n \t\tcaret_blink_timer = 0.0;\n \t}\n-\tcaret_can_draw = editing && (window_has_focus || (menu && menu->has_focus())) && (has_focus() || caret_force_displayed);\n+\tcaret_can_draw = (caret_force_displayed && !is_part_of_edited_scene()) || (editing && (window_has_focus || (menu && menu->has_focus())) && has_focus());\n }\n \n void LineEdit::delete_char() {\n", "test_patch": "", "problem_statement": "LineEdit - Caret hides when focus is lost, even though Caret Force Displayed option is checked (Regression)\n### Tested versions\n\nReproducible in v4.4.rc3.official\n\n**Update:**\nI've tested this on versions from 4.3stable on and the version where this stops working is in 4.4 dev3.  In 4.4 dev2 backwards, it works as intended.\n\n### System information\n\nGodot v4.4.rc3 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2060 (NVIDIA; 32.0.15.7242) - Intel(R) Core(TM) i7-8700K CPU @ 3.70GHz (12 threads)\n\n### Issue description\n\nI'm using line input to edit text, and I'm moving away from the line with my controller to interact with other UI elements.  \nI expect the blinking caret in the line Input to remain, since I have the caret_force_displayed property checked.\n\nBut it doesn't seem like this makes a different, and the caret goes away.\n\n### Steps to reproduce\n\nOpen attached project and play it.\n\n1) Type some text in the LineEdit node.\n2) Click away or move away from the text with an attached controller.\n3) Notce the caret goes away even though the caret_force_displayed property is checked.\n\n### Minimal reproduction project (MRP)\n\n[line_edit_caret_issue.zip](https://github.com/user-attachments/files/19038896/line_edit_caret_issue.zip)\n", "hints_text": "Does it stop working after 4.4.dev2?\ncorrect.  from 4.4 dev3 on it no longer works.  \nI believe this might be an intended consequence of this behavior change: #87674.\n\nYou can restore the previous behavior by enabling `keep_editing_on_text_submit`.\n> You can restore the previous behavior by enabling `keep_editing_on_text_submit`.\n\nNo, it doesn't seem to always display the caret even with that option set. \n> No, it doesn't seem to always display the caret even with that option set.\n\nCorrect.  Even when `keep_editing_on_text_submit` is checked, the caret disappears when Focus is lost.  Basically the caret_forced_displayed property no longer works\n\n![Image](https://github.com/user-attachments/assets/e9e920f7-09f5-4285-820c-261ea8048481)\n\n.\nDoes input still work though (with that option enabled) even though the caret is invisible?\nI can refocus the line_edit node with my controller using `ui_up`, `ui_down`, `ui_left` and `ui_right`.  And I can focus / unfocus the line_edit using the same commands on the controller. But in order for me to actually make the caret reappear, I need to click into the line_edit with my mouse. \nCC @KoBeWi \n> But in order for me to actually make the caret reappear, I need to click into the line_edit with my mouse.\n\nYou can also edit by pressing Enter. Which I think makes sense, because you can't input text with controller anyway.\nLineEdit only accepts `ui_text_submit` from keyboard, this should be easy to fix. You can also connect `focus_entered` to `edit`, to edit the LineEdit immediately.\nIn my use case, there is no keyboard to press Enter on.  I'm trying to edit a line of text remotely by using a controller only.  This requires that I leave the focus of the line edit and interact with other UI elements (Buttons, primarily) to feed in specific string combinations to LineEdit.  \n\nThe functionality of `carat_force_displayed` becomes essential in this situation.  When it was working, I could see where the letters would appear on the LineEdit node without having to refocus on the LineEdit to see the caret.", "created_at": "2025-03-03 15:03:59", "merge_commit_sha": "dc03cf9fc03ebcbfd42dad76b808a260c0373d7e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103480", "base_commit": "dc128dddb603699712ee7633bb635b3d6c661706", "patch": "diff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9a3e4fd9d7fa..638b529676a0 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -3850,6 +3850,9 @@ RID RenderingDevice::render_pipeline_create(RID p_shader, FramebufferFormatID p_\n \tERR_FAIL_NULL_V(shader, RID());\n \tERR_FAIL_COND_V_MSG(shader->is_compute, RID(), \"Compute shaders can't be used in render pipelines\");\n \n+\t// Validate pre-raster shader. One of stages must be vertex shader or mesh shader (not implemented yet).\n+\tERR_FAIL_COND_V_MSG(!shader->stage_bits.has_flag(RDD::PIPELINE_STAGE_VERTEX_SHADER_BIT), RID(), \"Pre-raster shader (vertex shader) is not provided for pipeline creation.\");\n+\n \tFramebufferFormat fb_format;\n \t{\n \t\t_THREAD_SAFE_METHOD_\n", "test_patch": "", "problem_statement": "Creating render pipeline for a `RDShaderFile` that doesn't have vertex shader causes crash\n### Tested versions\n\n4.4.rc3\n\n### System information\n\nGodot v4.4.rc.mono - EndeavourOS  SMP PREEMPT_DYNAMIC Sat, 22 Feb 2025 00:37:05 +0000 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Mobile) - integrated AMD Radeon Graphics (RADV RENOIR) - AMD Ryzen 7 4800U with Radeon Graphics (16 threads)\n\n### Issue description\n\nIf a glsl file only has `#[fragment]` but no `#[vertex]`, it can be successfully compiled and loaded in script. And if it is used in `RenderingDevice.render_pipeline_create`, the game will crash (if it's a tool script, the whole editor will crash).\n\n### Steps to reproduce\n\nRun the MRP, then the game crashes:\n```\nStop reason: signal SIGSEGV: address not mapped to object (fault address: 0x0)\nStop reason: signal SIGSEGV: invalid permissions for mapped object (fault address: 0x7fffa7e21fd0)\n```\nCall stack:\n```\n___lldb_unnamed_symbol2415 (@___lldb_unnamed_symbol2415:686)\n___lldb_unnamed_symbol2417 (@___lldb_unnamed_symbol2417:62)\n___lldb_unnamed_symbol2420 (@___lldb_unnamed_symbol2420:108)\nRenderingDeviceDriverVulkan::render_pipeline_create(RenderingDeviceDriver::ShaderID, RenderingDeviceDriver::VertexFormatID, RenderingDeviceCommons::RenderPrimitive, RenderingDeviceCommons::PipelineRasterizationState, RenderingDeviceCommons::PipelineMultisampleState, RenderingDeviceCommons::PipelineDepthStencilState, RenderingDeviceCommons::PipelineColorBlendState, VectorView<int>, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, RenderingDeviceDriver::RenderPassID, unsigned int, VectorView<RenderingDeviceCommons::PipelineSpecializationConstant>) (/home/luo/godot/drivers/vulkan/rendering_device_driver_vulkan.cpp:5246)\nRenderingDevice::render_pipeline_create(RID, long, long, RenderingDeviceCommons::RenderPrimitive, RenderingDeviceCommons::PipelineRasterizationState const&, RenderingDeviceCommons::PipelineMultisampleState const&, RenderingDeviceCommons::PipelineDepthStencilState const&, RenderingDeviceCommons::PipelineColorBlendState const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, Vector<RenderingDeviceCommons::PipelineSpecializationConstant> const&) (/home/luo/godot/servers/rendering/rendering_device.cpp:3957)\nRenderingDevice::_render_pipeline_create(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&) (/home/luo/godot/servers/rendering/rendering_device.cpp:8269)\nvoid call_with_variant_args_ret_helper<__UnexistingClass, RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&, 0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul>(__UnexistingClass*, RID (__UnexistingClass::*)(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&), Variant const**, Variant&, Callable::CallError&, IndexSequence<0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul>) (/home/luo/godot/core/variant/binder_common.h:767)\nvoid call_with_variant_args_ret_dv<__UnexistingClass, RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&>(__UnexistingClass*, RID (__UnexistingClass::*)(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&), Variant const**, int, Variant&, Callable::CallError&, Vector<Variant> const&) (/home/luo/godot/core/variant/binder_common.h:546)\nMethodBindTR<RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&>::call(Object*, Variant const**, int, Callable::CallError&) const (/home/luo/godot/core/object/method_bind.h:524)\nGDScriptFunction::call(GDScriptInstance*, Variant const**, int, Callable::CallError&, GDScriptFunction::CallState*) (/home/luo/godot/modules/gdscript/gdscript_vm.cpp:2013)\nGDScriptInstance::callp(StringName const&, Variant const**, int, Callable::CallError&) (/home/luo/godot/modules/gdscript/gdscript.cpp:2053)\nNode::_gdvirtual__ready_call() (/home/luo/godot/scene/main/node.h:391)\nNode::_notification(int) (/home/luo/godot/scene/main/node.cpp:227)\nNode::_notificationv(int, bool) (/home/luo/godot/scene/main/node.h:49)\nCanvasItem::_notificationv(int, bool) (/home/luo/godot/scene/main/canvas_item.h:44)\nNode2D::_notificationv(int, bool) (/home/luo/godot/scene/2d/node_2d.h:37)\nObject::notification(int, bool) (/home/luo/godot/core/object/object.cpp:911)\nNode::_propagate_ready() (/home/luo/godot/scene/main/node.cpp:282)\nNode::_propagate_ready() (/home/luo/godot/scene/main/node.cpp:273)\nNode::_set_tree(SceneTree*) (/home/luo/godot/scene/main/node.cpp:3289)\n```\n\n### Minimal reproduction project (MRP)\n\n[RDShaderFileCrash.zip](https://github.com/user-attachments/files/19043836/RDShaderFileCrash.zip)\n", "hints_text": "Can't confirm on Windows 11, so might be platform specific\n\nCan you test previous versions like 4.3 to check if this occurs there as well or if it is specific to 4.4?\nThe same with 4.3. \nMoreover, if there is only a vertex shader but no fragment shader, it reports errors at runtime, but not crash.", "created_at": "2025-03-02 20:48:10", "merge_commit_sha": "6536f5f2df6f7a272c8c1a1598c97cb9dce2baf9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103424", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex cd6c51de4b2d..9a2c24473381 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -2177,7 +2177,7 @@ int Tree::draw_item(const Point2i &p_pos, const Point2 &p_draw_ofs, const Size2\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (!rtl && p_item->cells[i].buttons.size()) {\n+\t\t\tif (!p_item->cells[i].buttons.is_empty()) {\n \t\t\t\tint buttons_width = 0;\n \t\t\t\tfor (int j = p_item->cells[i].buttons.size() - 1; j >= 0; j--) {\n \t\t\t\t\tRef<Texture2D> button_texture = p_item->cells[i].buttons[j].texture;\n", "test_patch": "", "problem_statement": "Tree buttons don't behave the same in Right to Left\n### Tested versions\n\nGodot v4.4.beta1\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nIf tree i set to Right to Left layout direction the buttons in a column doesn't behave the same as in Left to Right direction when scrolling horizontally.\n\nScene tree in editor in LtR:\n\nhttps://github.com/user-attachments/assets/f6c079ad-a05b-4ad0-baeb-ef7c52e05ad6\n\nButtons doesn't move (just a little bit, https://github.com/godotengine/godot/issues/100645) when tree is scrolled. \n\nUsing RtL:\n\nhttps://github.com/user-attachments/assets/eae1bcb4-db75-4500-850c-81e74967ebe5\n\nSee how the buttons doesn't stay visible.\n\n### Steps to reproduce\n\nChange editor to a language with RtL language.\nOpen a scene with nodes in the scene tree\nChange the horizontal scroll position\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-03-01 07:27:42", "merge_commit_sha": "1ef52d80773d29be0279f13bc60e33c577972e1f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103419", "base_commit": "15ff450680a40391aabbffde0a57ead2cd84db56", "patch": "diff --git a/platform/android/java/app/AndroidManifest.xml b/platform/android/java/app/AndroidManifest.xml\nindex 60ce75fd16e2..1d59d15d560f 100644\n--- a/platform/android/java/app/AndroidManifest.xml\n+++ b/platform/android/java/app/AndroidManifest.xml\n@@ -46,7 +46,7 @@\n             android:excludeFromRecents=\"false\"\n             android:exported=\"true\"\n             android:screenOrientation=\"landscape\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:resizeableActivity=\"false\"\n             tools:ignore=\"UnusedAttribute\" >\n \ndiff --git a/platform/android/java/editor/src/main/AndroidManifest.xml b/platform/android/java/editor/src/main/AndroidManifest.xml\nindex a1971554bf7d..b136e348b2c7 100644\n--- a/platform/android/java/editor/src/main/AndroidManifest.xml\n+++ b/platform/android/java/editor/src/main/AndroidManifest.xml\n@@ -41,7 +41,7 @@\n \n         <activity\n             android:name=\".GodotEditor\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"true\"\n             android:icon=\"@mipmap/themed_icon\"\n             android:launchMode=\"singleTask\"\n@@ -59,7 +59,7 @@\n         </activity>\n         <activity\n             android:name=\".GodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -74,7 +74,7 @@\n         </activity>\n         <activity\n             android:name=\".embed.EmbeddedGodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -87,7 +87,7 @@\n             android:screenOrientation=\"userLandscape\" />\n         <activity\n             android:name=\".GodotXRGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:process=\":GodotXRGame\"\n             android:launchMode=\"singleTask\"\n             android:icon=\"@mipmap/ic_play_window\"\n", "test_patch": "", "problem_statement": "Android editor: Game crash after changing device language\n### Tested versions\n\nGodot Engine v4.3.stable.official [77dcf97d8]\n\n### System information\n\nXiaomi Redmi A2+, Android 13, compatible rendering\n\n### Issue description\n\nAfter changing device language, opening the game will hang for a few seconds then exit.\r\nThis issue occur the same way on Android emulator x86\n\n### Steps to reproduce\n\n1. Open the game\r\n2. Leave the game run in background and go to device system settings\r\n3. Change device display language\r\n4. Re-enter the game (the game will hang for a few seconds then exit)\n\n### Minimal reproduction project (MRP)\n\n[demo.zip](https://github.com/user-attachments/files/16936623/demo.zip)\r\n\n", "hints_text": "happening for me to i think the app crashes as a whole leaving a blank screen \nBisecting points to #94661 as the culprit, @m4gr3d\r\n\r\n![Captura 2024-09-25 20-18-16-312603](https://github.com/user-attachments/assets/7a04c88c-228b-4c19-9b4a-bd1706e9f3e4)\r\n\r\n<br>\r\n\r\n<details><summary>Errors + backtrace</summary>\r\n\r\n```\r\n09-25 18:18:36.786 19116 19116 E godot   : USER ERROR: Couldn't load file '/project.binary', error code 12.\r\n09-25 18:18:36.786 19116 19116 E godot   :    at: _load_settings_text_or_binary (core\\config\\project_settings.cpp:803)\r\n09-25 18:18:37.119 19116 19223 I godot   : Godot Engine v4.3.rc.custom_build.4d0da7401 (2024-07-24 17:17:46 UTC) - https://godotengine.org\r\n09-25 18:18:37.701 19116 19223 I godot   : OpenGL API OpenGL ES 3.2 V@415.0 (GIT@912136b, Ie3bb699d95, 1601292290) (Date:09/28/20) - Compatibility - Using Device: Qualcomm - Adreno (TM) 506\r\n09-25 18:18:37.785 19116 19223 I godot   :\r\n09-25 18:18:39.184 19116 19223 I godot   : Selected screen scale:  1.20000004768372\r\n09-25 18:18:39.371 19116 19223 I godot   : Selected screen scale:  1.20000004768372\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.134 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.134 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.135 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.135 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_custom_instance_class (.\\core/object/class_db.h:269)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_abstract_class (.\\core/object/class_db.h:216)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Parameter \"t\" is null.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: register_class (.\\core/object/class_db.h:201)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"singleton != nullptr\" is true.\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: ResourceUID (core\\io\\resource_uid.cpp:263)\r\n09-25 18:19:07.136 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.136 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.139 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.139 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.139 19116 19116 E godot   : USER ERROR: IP singleton already exist.\r\n09-25 18:19:07.139 19116 19116 E godot   :    at: create (core\\io\\ip.cpp:335)\r\n09-25 18:19:07.139 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.140 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.140 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.142 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.142 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.143 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.143 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.144 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.144 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.145 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.145 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.155 19116 19116 E godot   : USER ERROR: Condition \"object_slots[slot].object != nullptr\" is true. Returning: ObjectID()\r\n09-25 18:19:07.155 19116 19116 E godot   :    at: add_instance (core\\object\\object.cpp:2218)\r\n09-25 18:19:07.162 19116 19116 F libc    : Fatal signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x3fffffffc in tid 19116 (e.editor.v4.dev), pid 19116 (e.editor.v4.dev)\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : Build fingerprint: 'xiaomi/onc/onc:10/QKQ1.191008.001/V11.0.2.0.QFLMIXM:user/release-keys'\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : Revision: '0'\r\n09-25 18:19:07.370 19675 19675 F DEBUG   : ABI: 'arm64'\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : Timestamp: 2024-09-25 18:19:07-0300\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : pid: 19116, tid: 19116, name: e.editor.v4.dev  >>> org.godotengine.editor.v4.dev <<<\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : uid: 10463\r\n09-25 18:19:07.439 19675 19675 F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x3fffffffc\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x0  00000003fffffffc  x1  0000000000000001  x2  0000000000000004  x3  0000000000000003\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x4  0000000000000000  x5  0000000080000080  x6  6e636d47ff4c46ff  x7  7f7f7f7f7f7f7f7f\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x8  00000003fffffffc  x9  0000000000000001  x10 000000736bf55cc0  x11 0000000000000003\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x12 000000736bf54000  x13 0000000000000030  x14 fffffffffc000000  x15 fffffffff8000000\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x16 000000740803e890  x17 0000007408030a28  x18 000000740b804000  x19 000000740a62d000\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x20 0000000000000000  x21 000000740a62d000  x22 0000007ff5010dc0  x23 0000007378cd4f40\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x24 0000000000000008  x25 000000740a7e2020  x26 000000740a62d0b0  x27 0000000000000002\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     x28 0000007ff5010b50  x29 0000007ff500a250\r\n09-25 18:19:07.440 19675 19675 F DEBUG   :     sp  0000007ff500a230  lr  00000073150d41e4  pc  00000073150d41f4\r\n09-25 18:19:07.560 19675 19675 F DEBUG   :\r\n09-25 18:19:07.560 19675 19675 F DEBUG   : backtrace:\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #00 pc 0000000002d811f4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::setup_remote_filesystem(String const&, int, String const&, String&)+164)\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #01 pc 0000000002d811bc  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::setup_remote_filesystem(String const&, int, String const&, String&)+108)\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #02 pc 0000000002d81170  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::setup_remote_filesystem(String const&, int, String const&, String&)+32)\r\n09-25 18:19:07.561 19675 19675 F DEBUG   :       #03 pc 0000000002d7b530  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (OS_Android::open_dynamic_library(String const&, void*&, OS::GDExtensionData*)+776)\r\n09-25 18:19:07.562 19675 19675 F DEBUG   :       #04 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.562 19675 19675 F DEBUG   :       #05 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.562 19675 19675 F DEBUG   :       #06 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #07 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #08 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #09 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #10 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #11 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #12 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #13 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #14 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #15 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.563 19675 19675 F DEBUG   :       #16 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #17 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #18 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #19 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #20 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #21 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #22 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #23 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #24 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #25 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #26 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #27 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #28 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #29 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #30 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #31 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #32 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.564 19675 19675 F DEBUG   :       #33 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.565 19675 19675 F DEBUG   :       #34 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.565 19675 19675 F DEBUG   :       #35 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.566 19675 19675 F DEBUG   :       #36 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #37 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #38 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #39 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #40 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #41 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #42 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #43 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #44 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #45 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #46 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #47 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #48 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #49 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #50 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #51 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.567 19675 19675 F DEBUG   :       #52 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #53 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #54 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #55 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #56 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #57 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #58 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #59 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #60 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #61 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #62 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #63 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #64 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #65 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #66 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #67 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #68 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #69 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #70 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #71 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #72 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #73 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #74 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #75 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #76 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #77 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #78 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #79 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #80 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #81 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #82 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #83 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #84 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #85 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #86 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #87 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #88 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #89 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #90 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #91 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #92 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.568 19675 19675 F DEBUG   :       #93 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #94 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #95 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #96 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #97 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #98 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #99 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #100 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #101 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #102 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #103 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #104 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #105 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #106 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #107 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #108 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #109 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #110 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #111 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #112 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #113 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #114 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #115 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #116 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #117 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #118 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #119 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #120 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #121 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #122 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #123 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #124 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #125 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #126 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #127 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #128 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #129 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #130 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #131 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #132 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #133 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #134 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #135 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.569 19675 19675 F DEBUG   :       #136 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #137 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #138 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #139 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #140 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #141 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #142 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #143 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #144 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #145 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #146 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #147 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #148 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #149 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #150 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #151 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #152 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #153 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #154 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #155 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #156 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #157 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #158 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #159 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #160 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #161 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #162 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #163 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #164 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #165 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #166 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #167 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #168 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #169 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #170 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #171 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #172 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #173 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #174 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #175 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #176 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #177 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #178 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #179 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #180 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #181 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #182 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #183 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #184 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #185 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #186 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.570 19675 19675 F DEBUG   :       #187 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #188 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #189 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #190 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #191 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #192 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #193 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #194 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #195 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #196 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #197 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #198 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #199 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #200 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #201 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #202 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #203 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #204 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #205 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #206 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #207 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #208 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #209 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #210 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #211 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #212 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #213 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #214 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n09-25 18:19:07.571 19675 19675 F DEBUG   :       #215 pc 0000000002d8cab4  /data/app/org.godotengine.editor.v4.dev-N-f76n5Wtdwtq2SO_9Bsug==/lib/arm64/libgodot_android.so (RefCounted::_get_get_property_list() const+36)\r\n```\r\n\r\n</details>\r\n\r\nA thing i noticed is when you change the language, attempt to come back make the engine do a entire restart and probably this is undesired as well.", "created_at": "2025-03-01 01:53:18", "merge_commit_sha": "c301b2ad9ab05ffc4108abe19bd6408432ea8579", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103409", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/.github/workflows/android_builds.yml b/.github/workflows/android_builds.yml\nindex 443b0be0f388..426efac6ece3 100644\n--- a/.github/workflows/android_builds.yml\n+++ b/.github/workflows/android_builds.yml\n@@ -62,8 +62,8 @@ jobs:\n       - name: Download pre-built Android Swappy Frame Pacing Library\n         uses: dsaltares/fetch-gh-release-asset@1.1.2\n         with:\n-          repo: darksylinc/godot-swappy\n-          version: tags/v2023.3.0.0\n+          repo: godotengine/godot-swappy\n+          version: tags/from-source-2025-01-31\n           file: godot-swappy.7z\n           target: swappy/godot-swappy.7z\n \ndiff --git a/.gitignore b/.gitignore\nindex 2c3bf742ba2e..8adc7b786c63 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -263,6 +263,11 @@ bld/\n !thirdparty/**/arm/\n !thirdparty/**/arm64/\n \n+thirdparty/swappy-frame-pacing/arm64-v8a/abi.json\n+thirdparty/swappy-frame-pacing/armeabi-v7a/abi.json\n+thirdparty/swappy-frame-pacing/x86/abi.json\n+thirdparty/swappy-frame-pacing/x86_64/abi.json\n+\n # Visual Studio 2015/2017 cache/options directory\n .vs/\n \ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 571cfd9819c0..cac7c3f48d4e 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -187,7 +187,7 @@ def configure(env: \"SConsEnvironment\"):\n     has_swappy = detect_swappy()\n     if not has_swappy:\n         print_warning(\n-            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/darksylinc/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n+            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/godotengine/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n             + \" thirdparty/swappy-frame-pacing/arm64-v8a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/armeabi-v7a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/x86/libswappy_static.a\\n\"\ndiff --git a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\nindex d29ac01af384..25ce813968f7 100644\n--- a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n+++ b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n@@ -31,11 +31,12 @@\n \n // There are separate versions for each GameSDK component that use this format:\n #define ANDROID_GAMESDK_PACKED_VERSION(MAJOR, MINOR, BUGFIX) \\\n-    ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n+  ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n // Accessors\n #define ANDROID_GAMESDK_MAJOR_VERSION(PACKED) ((PACKED) >> 16)\n #define ANDROID_GAMESDK_MINOR_VERSION(PACKED) (((PACKED) >> 8) & 0xff)\n #define ANDROID_GAMESDK_BUGFIX_VERSION(PACKED) ((PACKED) & 0xff)\n \n-#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX, GIT) \\\n-#MAJOR \".\" #MINOR \".\" #BUGFIX \".\" #GIT\n+#define AGDK_STRINGIFY(NUMBER) #NUMBER\n+#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX) \\\n+  AGDK_STRINGIFY(MAJOR) \".\" AGDK_STRINGIFY(MINOR) \".\" AGDK_STRINGIFY(BUGFIX)\ndiff --git a/thirdparty/swappy-frame-pacing/swappyVk.h b/thirdparty/swappy-frame-pacing/swappyVk.h\nindex 020683cbc43c..654fcbf4a4a7 100644\n--- a/thirdparty/swappy-frame-pacing/swappyVk.h\n+++ b/thirdparty/swappy-frame-pacing/swappyVk.h\n@@ -281,30 +281,30 @@ void SwappyVk_uninjectTracer(const SwappyTracer* tracer);\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyVkFunctionProvider {\n-    /**\n-     * @brief Callback to initialize the function provider.\n-     *\n-     * This function is called by Swappy before any functions are requested.\n-     * E.g. so you can call dlopen on the Vulkan library.\n-     */\n-    bool (*init)();\n-\n-    /**\n-     * @brief Callback to get the address of a function.\n-     *\n-     * This function is called by Swappy to get the address of a Vulkan\n-     * function.\n-     * @param name The null-terminated name of the function.\n-     */\n-    void* (*getProcAddr)(const char* name);\n-\n-    /**\n-     * @brief Callback to close any resources owned by the function provider.\n-     *\n-     * This function is called by Swappy when no more functions will be\n-     * requested, e.g. so you can call dlclose on the Vulkan library.\n-     */\n-    void (*close)();\n+  /**\n+   * @brief Callback to initialize the function provider.\n+   *\n+   * This function is called by Swappy before any functions are requested.\n+   * E.g. so you can call dlopen on the Vulkan library.\n+   */\n+  bool (*init)();\n+\n+  /**\n+   * @brief Callback to get the address of a function.\n+   *\n+   * This function is called by Swappy to get the address of a Vulkan\n+   * function.\n+   * @param name The null-terminated name of the function.\n+   */\n+  void* (*getProcAddr)(const char* name);\n+\n+  /**\n+   * @brief Callback to close any resources owned by the function provider.\n+   *\n+   * This function is called by Swappy when no more functions will be\n+   * requested, e.g. so you can call dlclose on the Vulkan library.\n+   */\n+  void (*close)();\n } SwappyVkFunctionProvider;\n \n /**\n@@ -384,7 +384,8 @@ void SwappyVk_enableStats(VkSwapchainKHR swapchain, bool enabled);\n \n  * @see SwappyVk_enableStats.\n  */\n-void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t image);\n+void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain,\n+                               uint32_t image);\n \n /**\n  * @brief Returns the stats collected, if statistics collection was toggled on.\n@@ -396,11 +397,11 @@ void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t\n  * conditions.\n  *\n  * @param[in]  swapchain   - The swapchain for which stats are being queried.\n- * @param      swappyStats - Pointer to a SwappyStats that will be populated with\n- *                             the collected stats. Cannot be NULL.\n+ * @param      swappyStats - Pointer to a SwappyStats that will be populated\n+ * with the collected stats. Cannot be NULL.\n  * @see SwappyStats\n  */\n-void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n+void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats* swappyStats);\n \n /**\n  * @brief Clears the frame statistics collected so far.\n@@ -413,6 +414,58 @@ void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n  */\n void SwappyVk_clearStats(VkSwapchainKHR swapchain);\n \n+/**\n+ * @brief Reset the swappy pacing mechanism\n+ *\n+ * In cases where the frame timing history is irrelevant (for example during\n+ * scene/level transitions or after loading screens), calling this would\n+ * remove all the history for frame pacing. Calling this entry point\n+ * would reset the frame rate to the initial state at the end of the current\n+ * frame. Then swappy would just pace as normal with fresh state from next\n+ * frame. There are no error conditions associated with this call.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which frame pacing is reset.\n+ */\n+void SwappyVk_resetFramePacing(VkSwapchainKHR swapchain);\n+\n+/**\n+ * @brief Enable/Disable the swappy pacing mechanism\n+ *\n+ * By default frame pacing is enabled when swappy is used, however it can be\n+ * disabled at runtime by calling `SwappyVk_enableFramePacing(swapchain,\n+ * false)`. When the frame pacing is disabled, ::SwappyVk_enableBlockingWait\n+ * will control whether\n+ * ::SwappyVk_queuePresent will return immediately, or will block until the\n+ * previous frame's GPU work is completed. All enabling/disabling effects take\n+ * place from next frame. Once disabled, `SwappyVk_enableFramePacing(swapchain,\n+ * true)` will enable frame pacing again with a fresh frame time state -\n+ * equivalent of calling ::SwappyVk_resetFramePacing().\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, enables frame pacing otherwise disables it\n+ */\n+void SwappyVk_enableFramePacing(VkSwapchainKHR swapchain, bool enable);\n+\n+/**\n+ * @brief Enable/Disable blocking wait when frame-pacing is disabled\n+ *\n+ * By default ::SwappyVk_queuePresent will do a blocking wait until previous\n+ * frame's GPU work is completed. However when frame pacing is disabled, calling\n+ * `SwappyVk_enableBlockingWait(swapchain, false)` will ensure that\n+ * ::SwappyVk_queuePresent returns without waiting for previous frame's GPU\n+ * work. This behaviour impacts the GPU time returned in the\n+ * ::SwappyPostWaitCallback callback. If the last frame's GPU work is done by\n+ * the time ::SwappyVk_queuePresent for this frame is called, then the previous\n+ * frame's GPU time will be returned otherwise `-1` will be delivered in the\n+ * callback for the frame. This setting has no impact when frame pacing is\n+ * enabled.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, ::SwappyVk_queuePresent will block until\n+ * the previous frame's GPU work is complete.\n+ */\n+void SwappyVk_enableBlockingWait(VkSwapchainKHR swapchain, bool enable);\n+\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\ndiff --git a/thirdparty/swappy-frame-pacing/swappy_common.h b/thirdparty/swappy-frame-pacing/swappy_common.h\nindex b711ca910fb3..acceb4243df6 100644\n--- a/thirdparty/swappy-frame-pacing/swappy_common.h\n+++ b/thirdparty/swappy-frame-pacing/swappy_common.h\n@@ -48,22 +48,22 @@\n \n // Internal macros to track Swappy version, do not use directly.\n #define SWAPPY_MAJOR_VERSION 2\n-#define SWAPPY_MINOR_VERSION 0\n+#define SWAPPY_MINOR_VERSION 2\n #define SWAPPY_BUGFIX_VERSION 0\n-#define SWAPPY_PACKED_VERSION                                                  \\\n-    ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n-                                   SWAPPY_BUGFIX_VERSION)\n+#define SWAPPY_PACKED_VERSION                                                \\\n+  ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n+                                 SWAPPY_BUGFIX_VERSION)\n \n // Internal macros to generate a symbol to track Swappy version, do not use\n // directly.\n #define SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n+  PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n #define SWAPPY_VERSION_CONCAT(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n-#define SWAPPY_VERSION_SYMBOL                                          \\\n-    SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n-                          SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n-                          AGDK_GIT_COMMIT)\n+  SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n+#define SWAPPY_VERSION_SYMBOL                                        \\\n+  SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n+                        SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n+                        AGDK_GIT_COMMIT)\n \n // Define this to 1 to enable all logging from Swappy, by default it is\n // disabled in a release build and enabled in a debug build.\n@@ -83,29 +83,29 @@ typedef uint64_t SwappyThreadId;\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyThreadFunctions {\n-    /** @brief Thread start callback.\n-     *\n-     * This function is called by Swappy to start thread_func on a new thread.\n-     * @param user_data A value to be passed the thread function.\n-     * If the thread was started, this function should set the thread_id and\n-     * return 0. If the thread was not started, this function should return a\n-     * non-zero value.\n-     */\n-    int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n-                 void* user_data);\n-\n-    /** @brief Thread join callback.\n-     *\n-     * This function is called by Swappy to join the thread with given id.\n-     */\n-    void (*join)(SwappyThreadId thread_id);\n-\n-    /** @brief Thread joinable callback.\n-     *\n-     * This function is called by Swappy to discover whether the thread with the\n-     * given id is joinable.\n-     */\n-    bool (*joinable)(SwappyThreadId thread_id);\n+  /** @brief Thread start callback.\n+   *\n+   * This function is called by Swappy to start thread_func on a new thread.\n+   * @param user_data A value to be passed the thread function.\n+   * If the thread was started, this function should set the thread_id and\n+   * return 0. If the thread was not started, this function should return a\n+   * non-zero value.\n+   */\n+  int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n+               void* user_data);\n+\n+  /** @brief Thread join callback.\n+   *\n+   * This function is called by Swappy to join the thread with given id.\n+   */\n+  void (*join)(SwappyThreadId thread_id);\n+\n+  /** @brief Thread joinable callback.\n+   *\n+   * This function is called by Swappy to discover whether the thread with the\n+   * given id is joinable.\n+   */\n+  bool (*joinable)(SwappyThreadId thread_id);\n } SwappyThreadFunctions;\n \n #ifdef __cplusplus\n@@ -138,47 +138,46 @@ const char* Swappy_versionString();\n  * ::SwappyGL_enableStats or ::SwappyVk_enableStats.\n  */\n typedef struct SwappyStats {\n-    /** @brief Total frames swapped by swappy */\n-    uint64_t totalFrames;\n-\n-    /** @brief Histogram of the number of screen refreshes a frame waited in the\n-     * compositor queue after rendering was completed.\n-     *\n-     * For example:\n-     *     if a frame waited 2 refresh periods in the compositor queue after\n-     * rendering was done, the frame will be counted in idleFrames[2]\n-     */\n-    uint64_t idleFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * requested presentation time and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the requested\n-     * timestamp swappy set, the frame will be counted in lateFrames[2]\n-     */\n-    uint64_t lateFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between two\n-     * consecutive frames\n-     *\n-     * For example:\n-     *     if frame N was presented 2 refresh periods after frame N-1\n-     *     frame N will be counted in offsetFromPreviousFrame[2]\n-     */\n-    uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * call to Swappy_recordFrameStart and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the call to\n-     * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n-     */\n-    uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n+  /** @brief Total frames swapped by swappy */\n+  uint64_t totalFrames;\n+\n+  /** @brief Histogram of the number of screen refreshes a frame waited in the\n+   * compositor queue after rendering was completed.\n+   *\n+   * For example:\n+   *     if a frame waited 2 refresh periods in the compositor queue after\n+   * rendering was done, the frame will be counted in idleFrames[2]\n+   */\n+  uint64_t idleFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * requested presentation time and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the requested\n+   * timestamp swappy set, the frame will be counted in lateFrames[2]\n+   */\n+  uint64_t lateFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between two\n+   * consecutive frames\n+   *\n+   * For example:\n+   *     if frame N was presented 2 refresh periods after frame N-1\n+   *     frame N will be counted in offsetFromPreviousFrame[2]\n+   */\n+  uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * call to Swappy_recordFrameStart and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the call to\n+   * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n+   */\n+  uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n } SwappyStats;\n \n-\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\n@@ -236,43 +235,43 @@ typedef void (*SwappySwapIntervalChangedCallback)(void*);\n  * Injection of these is optional.\n  */\n typedef struct SwappyTracer {\n-    /**\n-     * Callback called before waiting to queue the frame to the composer.\n-     */\n-    SwappyPreWaitCallback preWait;\n-\n-    /**\n-     * Callback called after wait to queue the frame to the composer is done.\n-     */\n-    SwappyPostWaitCallback postWait;\n-\n-    /**\n-     * Callback called before calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPreSwapBuffersCallback preSwapBuffers;\n-\n-    /**\n-     * Callback called after calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPostSwapBuffersCallback postSwapBuffers;\n-\n-    /**\n-     * Callback called at the start of a frame.\n-     */\n-    SwappyStartFrameCallback startFrame;\n-\n-    /**\n-     * Pointer to some arbitrary data that will be passed as the first argument\n-     * of callbacks.\n-     */\n-    void* userData;\n-\n-    /**\n-     * Callback called when the swap interval was changed.\n-     */\n-    SwappySwapIntervalChangedCallback swapIntervalChanged;\n+  /**\n+   * Callback called before waiting to queue the frame to the composer.\n+   */\n+  SwappyPreWaitCallback preWait;\n+\n+  /**\n+   * Callback called after wait to queue the frame to the composer is done.\n+   */\n+  SwappyPostWaitCallback postWait;\n+\n+  /**\n+   * Callback called before calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPreSwapBuffersCallback preSwapBuffers;\n+\n+  /**\n+   * Callback called after calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPostSwapBuffersCallback postSwapBuffers;\n+\n+  /**\n+   * Callback called at the start of a frame.\n+   */\n+  SwappyStartFrameCallback startFrame;\n+\n+  /**\n+   * Pointer to some arbitrary data that will be passed as the first argument\n+   * of callbacks.\n+   */\n+  void* userData;\n+\n+  /**\n+   * Callback called when the swap interval was changed.\n+   */\n+  SwappySwapIntervalChangedCallback swapIntervalChanged;\n } SwappyTracer;\n \n /** @} */\n", "test_patch": "", "problem_statement": "Android rotating screen more than once causes a crash\n### Tested versions\n\nReproducible in:  4.4.dev4, 4.4.dev5, 4.4.beta, 4.4.rc1\nNot reproducible in: 4.4.dev3, 4.4.dev1, 4.3.stable\nRegression starting in 4.4.dev4 and still present in current 4.4.rc1\n\n### System information\n\nAndroid 14, Rendering: Forward Mobile Vulkan 1.1.128, GPU:Qualcomm Adreno 619, Hardware: Motorola One 5G Ace\n\n### Issue description\n\nRotating the phone screen more than once causes the exported game/app to crash on Android. Expected to be able to rotate the screen more than once in any direction without crashing.\n\n\n### Steps to reproduce\n\nCreate a new empty project, Set Project>Project Settings>Display>Window>Handheld>Orientation>Sensor.\nExport the project to Android and run.\nRotate the screen once than rotate it again (crash).\n\n### Minimal reproduction project (MRP)\n\nN/A. Reproducible in a new project with Display Orientation set to Sensor on Android.\n", "hints_text": "CC @godotengine/android \n\nFrom the 4.4-dev4 changelog, #98709 sounds related, but I didn't bisect or test a local revert to confirm.\nI could not reproduce it: [OrientationTest.zip](https://github.com/user-attachments/files/18972336/OrientationTest.zip)\n\n```\nGodot Engine v4.4.beta4.official.93d270693 - https://godotengine.org\nVulkan 1.1.128 - Forward Mobile - Using Device #0: Qualcomm - Adreno (TM) 650\n```\n\n@brycehenley Is my test project working for you?\nI also can't reproduce this issue.\n\nGodot v4.4.rc (394508d26) - Android - Single-window, 1 monitor - OpenGL ES 3 (Compatibility) - Adreno (TM) 613\n@Alex2782 I can reproduce the issue in your test project. It crashes on the second rotation for both using the sensor and selecting an orientation while using the Forward Mobile Vulkan rendering. Setting it to Compatibility OpenGL ES 3 it rotates as normal without crashing.\nI tested it on a much older handset Android 8.0 LG V20 GPU:Qualcomm Adreno 530 Forward Mobile Vulkan 1.0.61 and it rotates without crashing on that device.\n`adb logcat > logs.txt` _(Zip the file and upload it here)_\n\nPerhaps we can identify the cause in the logcat protocols. But for this you would have to activate developer mode on your smartphone and connect it with a USB cable. _(Then you could also start the apps directly with Godot Editor via remote debug.)_ \n\nAre you already familiar with this?\n[logs.zip](https://github.com/user-attachments/files/18973258/logs.zip)\n\nYes I am familiar with it. Here is the adb logcat dump. Let me know if you need anything else.\nThe following error message looks suspicious in the init process, but I'm not sure if it has anything to do with it.\n`ERROR: A queue family with the requested bits could not be found.`\n\n<details><summary>Logcat at start/init</summary>\n\n```java\n02-25 15:08:01.131 23756 23818 I godot   : Vulkan 1.1.128 - Forward Mobile - Using Device #0: Qualcomm - Adreno (TM) 619\n02-25 15:08:01.132 23756 23818 E godot   : ERROR: A queue family with the requested bits could not be found.\n02-25 15:08:01.132 23756 23818 E godot   :    at: command_queue_family_get (drivers/vulkan/rendering_device_driver_vulkan.cpp:2395)\n02-25 15:08:01.133 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x38\n02-25 15:08:01.133 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:01.133 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:01.133 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:01.133 23756 23818 E Gralloc4: isSupported(1, 1, 56, 1, ...) failed with 1\n...\n02-25 15:08:01.134 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 56 usage b00: 1\n02-25 15:08:01.134 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n02-25 15:08:01.134 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x3b\n02-25 15:08:01.134 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:01.134 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:01.134 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:01.134 23756 23818 E Gralloc4: isSupported(1, 1, 59, 1, ...) failed with 1\n...\n02-25 15:08:01.134 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 56 usage b00: 1\n02-25 15:08:01.134 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n02-25 15:08:01.134 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x3b\n02-25 15:08:01.134 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:01.134 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:01.134 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:01.134 23756 23818 E Gralloc4: isSupported(1, 1, 59, 1, ...) failed with 1\n...\n02-25 15:08:01.137 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 56 usage b00: 1\n02-25 15:08:01.137 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n02-25 15:08:01.137 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x3b\n02-25 15:08:01.137 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:01.137 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:01.137 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:01.137 23756 23818 E Gralloc4: isSupported(1, 1, 59, 1, ...) failed with 1\n...\n02-25 15:08:01.137 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 59 usage b00: 1\n02-25 15:08:01.137 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n```\n\n</details>\n\n\n['gpu-compare' with motorola razr 50 ultra](https://vulkan.gpuinfo.org/compare.php?devices[]=motorola%20motorola%20razr%2050%20ultra&os=android&devices[]=motorola%20motorola%20one%205G%20ace&os=android#devices). _(I tried 2 Motorola smartphones on Firebase Test Lab, no crash reproducible.)_\n\n`VK_QCOM_rotated_copy_commands` is e.g. not available on the \u201cMotorola One 5G Ace\u201d smartphone _(in case it should be important)_\n\n<details><summary>Logcat orientation change</summary>\n\n-------------\n\n```java\n02-25 15:08:05.947  1483 12929 I WindowManager: finishDrawing of orientation change: Window{8cae66a u0 com.example.orientationtest/com.godot.game.GodotApp} 33ms\n02-25 15:08:05.951  1483  1779 V WindowManager: Sent Transition (#4506) createdAt=02-25 15:08:05.878 via request=TransitionRequestInfo { type = CHANGE, triggerTask = null, pipTask = null, remoteTransition = null, displayChange = DisplayChange { displayId = 0, startAbsBounds = null, endAbsBounds = null, startRotation = 0, endRotation = 1, physicalDisplayChanged = false }, flags = 0, debugId = 4506 }\n02-25 15:08:05.952  1483  1779 V WindowManager:     startWCT=WindowContainerTransaction { changes = {} hops = [] errorCallbackToken=null taskFragmentOrganizer=null }\n02-25 15:08:05.952  1483  1779 V WindowManager:     info={id=4506 t=CHANGE f=0x0 trk=0 r=[0@Point(0, 0)] c=[\n02-25 15:08:05.952  1483  1779 V WindowManager:         {WCT{RemoteToken{62184fc Task{d373c3c #805 type=standard A=10278:com.example.orientationtest}}} m=CHANGE f=NONE p=WCT{RemoteToken{915eaa DefaultTaskDisplayArea@106271934}} leash=Surface(name=Task=805)/@0xb51fece sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:0},\n02-25 15:08:05.952  1483  1779 V WindowManager:         {WCT{RemoteToken{915eaa DefaultTaskDisplayArea@106271934}} m=CHANGE f=NONE p=WCT{RemoteToken{53518ee Display{#0 state=ON size=2400x1080 ROTATION_90}}} leash=Surface(name=DefaultTaskDisplayArea)/@0x88bdf7e sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:-1},\n02-25 15:08:05.952  1483  1779 V WindowManager:         {WCT{RemoteToken{53518ee Display{#0 state=ON size=2400x1080 ROTATION_90}}} m=CHANGE f=IS_DISPLAY leash=Surface(name=WindowedMagnification:0:31)/@0x9c527e3 sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:-1}\n02-25 15:08:05.952  1483  1779 V WindowManager:     ]}\n02-25 15:08:05.954  2591  2622 V WindowManagerShell: onTransitionReady (#4506) android.os.BinderProxy@81e92d8: {id=4506 t=CHANGE f=0x0 trk=0 r=[0@Point(0, 0)] c=[{WCT{android.window.IWindowContainerToken$Stub$Proxy@e92aa55} m=CHANGE f=NONE p=WCT{android.window.IWindowContainerToken$Stub$Proxy@7169c6a} leash=Surface(name=Task=805)/@0x57c36e0 sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:0},{WCT{android.window.IWindowContainerToken$Stub$Proxy@c45155b} m=CHANGE f=NONE p=WCT{android.window.IWindowContainerToken$Stub$Proxy@54e01f8} leash=Surface(name=DefaultTaskDisplayArea)/@0xfdbcd99 sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:-1},{WCT{android.window.IWindowContainerToken$Stub$Proxy@4a096d1} m=CHANGE f=IS_DISPLAY leash=Surface(name=WindowedMagnification:0:31)/@0x691585e sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:-1 snapshot=Surface(name=RotationLayer)/@0xb83743f}]}\n02-25 15:08:05.954  2591  2622 V WindowManagerShell: Playing animation for (#4506) android.os.BinderProxy@81e92d8@0\n02-25 15:08:05.954  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.transition.DefaultMixedHandler@28663d1\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.keyguard.KeyguardTransitionHandler@a485e36\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.pip.PipTransition@db553cf\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.activityembedding.ActivityEmbeddingController@6d7f15c\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.recents.RecentsTransitionHandler@ea3fc65\n02-25 15:08:05.955  2591  2622 V ShellRecents: RecentsTransitionHandler.startAnimation: no controller found\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.splitscreen.StageCoordinator@7e2311f\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.transition.RemoteTransitionHandler@dd76d3a\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:  try handler com.android.wm.shell.transition.DefaultTransitionHandler@9dcf9e1\n02-25 15:08:05.955  2591  2622 V WindowManagerShell: start default transition animation, info = {id=4506 t=CHANGE f=0x0 trk=0 r=[0@Point(0, 0)] c=[{WCT{android.window.IWindowContainerToken$Stub$Proxy@e92aa55} m=CHANGE f=NONE p=WCT{android.window.IWindowContainerToken$Stub$Proxy@7169c6a} leash=Surface(name=Task=805)/@0x57c36e0 sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:0},{WCT{android.window.IWindowContainerToken$Stub$Proxy@c45155b} m=CHANGE f=NONE p=WCT{android.window.IWindowContainerToken$Stub$Proxy@54e01f8} leash=Surface(name=DefaultTaskDisplayArea)/@0xfdbcd99 sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:-1},{WCT{android.window.IWindowContainerToken$Stub$Proxy@4a096d1} m=CHANGE f=IS_DISPLAY leash=Surface(name=WindowedMagnification:0:31)/@0x691585e sb=Rect(0, 0 - 1080, 2400) eb=Rect(0, 0 - 2400, 1080) d=0 r=0->1:-1 snapshot=Surface(name=RotationLayer)/@0xb83743f}]}\n02-25 15:08:05.955  2591  2622 V WindowManagerShell: Display is changing, resolve the animation hint.\n02-25 15:08:05.955  2591  2622 V WindowManagerShell:   task 805 isn't requesting seamless, so not seamless.\n02-25 15:08:05.962  2591  2622 V WindowManagerShell:  animated by com.android.wm.shell.transition.DefaultTransitionHandler@9dcf9e1\n02-25 15:08:05.968  2591  2591 D DisplayRepository: combining enabled=[0], connectedExternalDisplayIds=[], ignored=[]\n02-25 15:08:05.977  1483  1783 I DisplayDeviceRepository: Display device changed: DisplayDeviceInfo{\"Built-in Screen\": uniqueId=\"local:4630946218877315969\", 1080 x 2400, modeId 1, renderFrameRate 60.000004, defaultModeId 1, userPreferredModeId -1, supportedModes [{id=1, width=1080, height=2400, fps=60.000004, vsync=60.000004, alternativeRefreshRates=[], supportedHdrTypes=[2, 3, 4]}], colorMode 0, supportedColorModes [0, 7, 9], hdrCapabilities HdrCapabilities{mSupportedHdrTypes=[2, 3, 4], mMaxLuminance=450.0, mMaxAverageLuminance=225.15, mMinLuminance=0.3}, allmSupported false, gameContentTypeSupported false, density 420, 397.565 x 393.29 dpi, appVsyncOff 2333332, presDeadline 11500000, cutout DisplayCutout{insets=Rect(0, 106 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(478, 0 - 602, 106), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 physicalDisplayWidth=1080 physicalDisplayHeight=2400 density={2.625} cutoutSpec={M -62,0 L 62,0 L 62,106 L -62,106 Z} rotation={0} scale={1.0} physicalPixelDisplaySizeRatio={1.0}}} sideOverrides={}}, touch INTERNAL, rotation 0, type INTERNAL, address {port=129, model=0x40446d0cde1eeb}, deviceProductInfo DeviceProductInfo{name=, manufacturerPnpId=QCM, productId=1, modelYear=null, manufactureDate=ManufactureDate{week=27, year=2006}, connectionToSinkType=0}, state ON, committedState ON, frameRateOverride , brightnessMinimum 0.0, brightnessMaximum 1.0, brightnessDefault 0.45882353, hdrSdrRatio NaN, FLAG_ALLOWED_TO_BE_DEFAULT_DISPLAY, FLAG_ROTATES_WITH_CONTENT, FLAG_SECURE, FLAG_SUPPORTS_PROTECTED_BUFFERS, FLAG_TRUSTED, installOrientation 0, displayShape DisplayShape{ spec=-1893857183 displayWidth=1080 displayHeight=2400 physicalPixelDisplaySizeRatio=1.0 rotation=0 offsetX=0 offsetY=0 scale=1.0}}\n02-25 15:08:05.991 23756 23836 I SwappyDisplayManager: Terminating looper thread\n02-25 15:08:05.992 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x38\n02-25 15:08:05.992 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.992 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.992 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.992 23756 23818 E Gralloc4: isSupported(1, 1, 56, 1, ...) failed with 1\n02-25 15:08:05.992   913  4058 E qdgralloc: GetGpuPixelFormat: No map for format: 0x38\n02-25 15:08:05.992   913  4058 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.992   913  4058 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.992   913  4058 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.992 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 56 usage b00: 1\n02-25 15:08:05.992 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n02-25 15:08:05.992 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x3b\n02-25 15:08:05.992 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.992 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.992 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.992 23756 23818 E Gralloc4: isSupported(1, 1, 59, 1, ...) failed with 1\n02-25 15:08:05.993   913  4058 E qdgralloc: GetGpuPixelFormat: No map for format: 0x3b\n02-25 15:08:05.993   913  4058 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.993   913  4058 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.993   913  4058 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.993 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 59 usage b00: 1\n02-25 15:08:05.993 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n02-25 15:08:05.993 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x38\n02-25 15:08:05.993 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.993 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.993 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.993 23756 23818 E Gralloc4: isSupported(1, 1, 56, 1, ...) failed with 1\n02-25 15:08:05.994   913  4058 E qdgralloc: GetGpuPixelFormat: No map for format: 0x38\n02-25 15:08:05.994   913  4058 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.994   913  4058 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.994   913  4058 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.994 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 56 usage b00: 1\n02-25 15:08:05.994 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n02-25 15:08:05.994 23756 23818 E qdgralloc: GetGpuPixelFormat: No map for format: 0x3b\n02-25 15:08:05.994 23756 23818 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.994 23756 23818 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.994 23756 23818 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.994 23756 23818 E Gralloc4: isSupported(1, 1, 59, 1, ...) failed with 1\n02-25 15:08:05.994   913  4058 E qdgralloc: GetGpuPixelFormat: No map for format: 0x3b\n02-25 15:08:05.994   913  4058 E AdrenoUtils: <validate_memory_layout_input_parmas:1984>: Unknown Format 0\n02-25 15:08:05.994   913  4058 E AdrenoUtils: <adreno_init_memory_layout:4723>: Memory Layout input parameter validation failed!\n02-25 15:08:05.994   913  4058 E qdgralloc: GetGpuResourceSizeAndDimensions Graphics metadata init failed\n02-25 15:08:05.994 23756 23818 E GraphicBufferAllocator: Failed to allocate (4 x 4) layerCount 1 format 59 usage b00: 1\n02-25 15:08:05.994 23756 23818 E AHardwareBuffer: GraphicBuffer(w=4, h=4, lc=1) failed (Unknown error -1), handle=0x0\n02-25 15:08:06.005  2591  2591 D DisplayRepository: combining enabled=[0], connectedExternalDisplayIds=[], ignored=[]\n02-25 15:08:06.009  1483  2412 W UserManagerService: Requested status bar icon for non-badged user 0\n02-25 15:08:06.010   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.011 23756 23818 I SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.\n02-25 15:08:06.015 23756 23844 I SwappyDisplayManager: Starting looper thread\n02-25 15:08:06.020  2591  2591 I KeyguardBlueprintViewBinder: runTransition: running IntraBlueprintTransition: currentPriority=-1; config=Config(type=NoTransition, checkPriority=true, terminatePrevious=true)\n02-25 15:08:06.020  2591  2591 D DisplayRepository: combining enabled=[0], connectedExternalDisplayIds=[], ignored=[]\n02-25 15:08:06.022  2878  3489 D QCNEJ/WlanStaInfoRelay: Received action: android.net.wifi.RSSI_CHANGED\n02-25 15:08:06.023  1148 22991 I netd    : networkAddUidRangesParcel(NativeUidRangeConfig{netId: 568, uidRanges: [UidRangeParcel{start: 0, stop: 2147483647}], subPriority: 998}) <0.22ms>\n02-25 15:08:06.024  1148 22991 I netd    : networkRemoveUidRangesParcel(NativeUidRangeConfig{netId: 568, uidRanges: [UidRangeParcel{start: 0, stop: 2147483647}], subPriority: 998}) <0.18ms>\n02-25 15:08:06.026   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.030 14937 14937 I MagicTether: [ActiveNetworkTracker] setActiveNetwork: 568 [CONTEXT service_id=276 ]\n02-25 15:08:06.030 14937 14937 I MagicTether: [TetherService] onActiveNetworkChanged: network=568 isLost=false [CONTEXT service_id=276 ]\n02-25 15:08:06.030 14937 23717 I MagicTether: [WifiConnectionHandler] Ignoring getWifiConfigurationByNetworkId when checking connected state [CONTEXT service_id=276 ]\n02-25 15:08:06.030 14937 23717 I MagicTether: [WifiConnectionHandler] No networkId set, can't be connected. [CONTEXT service_id=276 ]\n02-25 15:08:06.031 14937 23717 I MagicTether: [TetherService] TRANSPORT_CELLULAR [false], TRANSPORT_ETHERNET [false], TRANSPORT_WIFI [true] [CONTEXT service_id=276 ]\n02-25 15:08:06.031 11769 11953 I BugleRcsEngine: handleMessage processing message:[NOTIFY_UPTIME_IGNORE_STATE_CHANGED] with [non-null]:RcsEngineImpl reference [CONTEXT log_prefix=\"RcsEngineImpl[DUAL_REG]:[341ad634-3b4e]>Handler\" thread_id=56 ]\n02-25 15:08:06.033 11769 11881 I BugleRcsEngine: Connected state: [1], networkType: [WIFI] [CONTEXT thread_id=46 ]\n02-25 15:08:06.033 14937 23717 I MagicTether: [TetherService] setRoles hasActiveNetworkConnection=true canActiveNetworkBeTethered=true isConnectedToInstantTether=false isWifiEnabled=true isHosting=false [CONTEXT service_id=276 ]\n02-25 15:08:06.037 14937 14937 I MagicTether: [LaunchUtils] Instant Wifi for status account: name: brycehenley97@gmail.com | type: com.google | isLaunched: true [CONTEXT service_id=276 ]\n02-25 15:08:06.038 14937 14937 I MagicTether: [TidepoolFeatureStatusManager] isInstantHotspotEnabled=true [CONTEXT service_id=276 ]\n02-25 15:08:06.038 14937 14937 I MagicTether: [TidepoolFeatureStatusManager] isInstantWifiEnabled=true [CONTEXT service_id=276 ]\n02-25 15:08:06.038 14937 14937 I MagicTether: [TetherService] startNearbyClientRole: start: false isInstantHotspotEnabled: true isInstantWifiEnabled: true [CONTEXT service_id=276 ]\n02-25 15:08:06.038 14937 14937 I MagicTether: [TetherService] Stopping Nearby client role [CONTEXT service_id=276 ]\n02-25 15:08:06.039 14937 14937 I MagicTether: [ClientTetherRole] Client role already stopped [CONTEXT service_id=276 ]\n02-25 15:08:06.039  1483  3871 D ActivityManager: sync unfroze 18104 com.google.android.apps.messaging for 7\n02-25 15:08:06.040 14937 14937 I MagicTether: [LaunchUtils] Instant Wifi for status account: name: brycehenley97@gmail.com | type: com.google | isLaunched: true [CONTEXT service_id=276 ]\n02-25 15:08:06.040 14937 14937 I MagicTether: [TidepoolFeatureStatusManager] isInstantHotspotEnabled=true [CONTEXT service_id=276 ]\n02-25 15:08:06.040 14937 14937 I MagicTether: [TidepoolFeatureStatusManager] isInstantWifiEnabled=true [CONTEXT service_id=276 ]\n02-25 15:08:06.040 14937 14937 I MagicTether: [TetherService] startNearbyHostRole: start: true isInstantHotspotEnabled: true isInstantWifiEnabled: true [CONTEXT service_id=276 ]\n02-25 15:08:06.040 14937 14937 I MagicTether: [TidepoolFeatureStatusManager] isInstantHotspotEnabled=true [CONTEXT service_id=276 ]\n02-25 15:08:06.040 14937 14937 I MagicTether: [HostTetherRole] Nearby host role already started [CONTEXT service_id=276 ]\n02-25 15:08:06.041  1483  1783 I DisplayDeviceRepository: Display device changed: DisplayDeviceInfo{\"Built-in Screen\": uniqueId=\"local:4630946218877315969\", 1080 x 2400, modeId 1, renderFrameRate 60.000004, defaultModeId 1, userPreferredModeId -1, supportedModes [{id=1, width=1080, height=2400, fps=60.000004, vsync=60.000004, alternativeRefreshRates=[], supportedHdrTypes=[2, 3, 4]}], colorMode 0, supportedColorModes [0, 7, 9], hdrCapabilities HdrCapabilities{mSupportedHdrTypes=[2, 3, 4], mMaxLuminance=450.0, mMaxAverageLuminance=225.15, mMinLuminance=0.3}, allmSupported false, gameContentTypeSupported false, density 420, 397.565 x 393.29 dpi, appVsyncOff 2333332, presDeadline 11500000, cutout DisplayCutout{insets=Rect(0, 106 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(478, 0 - 602, 106), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 physicalDisplayWidth=1080 physicalDisplayHeight=2400 density={2.625} cutoutSpec={M -62,0 L 62,0 L 62,106 L -62,106 Z} rotation={0} scale={1.0} physicalPixelDisplaySizeRatio={1.0}}} sideOverrides={}}, touch INTERNAL, rotation 0, type INTERNAL, address {port=129, model=0x40446d0cde1eeb}, deviceProductInfo DeviceProductInfo{name=, manufacturerPnpId=QCM, productId=1, modelYear=null, manufactureDate=ManufactureDate{week=27, year=2006}, connectionToSinkType=0}, state ON, committedState ON, frameRateOverride {uid=10278 frameRateHz=30.000002} , brightnessMinimum 0.0, brightnessMaximum 1.0, brightnessDefault 0.45882353, hdrSdrRatio NaN, FLAG_ALLOWED_TO_BE_DEFAULT_DISPLAY, FLAG_ROTATES_WITH_CONTENT, FLAG_SECURE, FLAG_SUPPORTS_PROTECTED_BUFFERS, FLAG_TRUSTED, installOrientation 0, displayShape DisplayShape{ spec=-1893857183 displayWidth=1080 displayHeight=2400 physicalPixelDisplaySizeRatio=1.0 rotation=0 offsetX=0 offsetY=0 scale=1.0}}\n02-25 15:08:06.041 18104 18104 E ActivityThread: Package [com.example.orientationtest] reported as REPLACED, but missing application info. Assuming REMOVED.\n02-25 15:08:06.042 18104 18104 E ActivityThread: Package [com.example.orientationtest] reported as REPLACED, but missing application info. Assuming REMOVED.\n02-25 15:08:06.043 23756 23827 W MessageQueue: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:06.043 23756 23827 W MessageQueue: java.lang.IllegalStateException: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.MessageQueue.enqueueMessage(MessageQueue.java:603)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.Handler.enqueueMessage(Handler.java:787)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.Handler.sendMessageAtTime(Handler.java:736)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.Handler.sendMessageDelayed(Handler.java:706)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.Handler.post(Handler.java:436)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:43)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.-$$Nest$mhandleDisplayEvent(Unknown Source:0)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal$DisplayManagerCallback.onDisplayEvent(DisplayManagerGlobal.java:1192)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.hardware.display.IDisplayManagerCallback$Stub.onTransact(IDisplayManagerCallback.java:87)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.Binder.execTransactInternal(Binder.java:1505)\n02-25 15:08:06.043 23756 23827 W MessageQueue: \tat android.os.Binder.execTransact(Binder.java:1444)\n02-25 15:08:06.044   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.044   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.044   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.045 23756 23827 W Binder  : Caught a RuntimeException from the binder stub implementation.\n02-25 15:08:06.045 23756 23827 W Binder  : java.util.concurrent.RejectedExecutionException: Handler (android.os.Handler) {3ca401f} is shutting down\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:44)\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal.-$$Nest$mhandleDisplayEvent(Unknown Source:0)\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal$DisplayManagerCallback.onDisplayEvent(DisplayManagerGlobal.java:1192)\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.hardware.display.IDisplayManagerCallback$Stub.onTransact(IDisplayManagerCallback.java:87)\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.os.Binder.execTransactInternal(Binder.java:1505)\n02-25 15:08:06.045 23756 23827 W Binder  : \tat android.os.Binder.execTransact(Binder.java:1444)\n02-25 15:08:06.050 11769 11953 I BugleRcsEngine: Rcs is enabled from user settings: true [CONTEXT log_prefix=\"ProvisioningEngineDataRetriever\" thread_id=56 ]\n02-25 15:08:06.050  1483  3871 I ImeTracker: com.example.orientationtest:9813def4: onRequestHide at ORIGIN_SERVER reason HIDE_SAME_WINDOW_FOCUSED_WITHOUT_EDITOR fromUser false\n02-25 15:08:06.050  1483  3871 I ImeTracker: com.example.orientationtest:9813def4: onCancelled at PHASE_SERVER_SHOULD_HIDE\n02-25 15:08:06.057   910   910 D DisplayDevice: setDesiredMode 4630946218877315969 {mode=30.00 Hz (60.00 Hz(60.00 Hz)), emitEvent=true, force=false}\n02-25 15:08:06.058  2591  2591 I KeyguardBlueprintViewBinder: onTransitionStart: IntraBlueprintTransition\n02-25 15:08:06.058  2591  2591 E KeyguardBlueprintViewBinder: onTransitionEnd: IntraBlueprintTransition\n02-25 15:08:06.058  1483  1783 I DisplayDeviceRepository: Display device changed: DisplayDeviceInfo{\"Built-in Screen\": uniqueId=\"local:4630946218877315969\", 1080 x 2400, modeId 1, renderFrameRate 30.000002, defaultModeId 1, userPreferredModeId -1, supportedModes [{id=1, width=1080, height=2400, fps=60.000004, vsync=60.000004, alternativeRefreshRates=[], supportedHdrTypes=[2, 3, 4]}], colorMode 0, supportedColorModes [0, 7, 9], hdrCapabilities HdrCapabilities{mSupportedHdrTypes=[2, 3, 4], mMaxLuminance=450.0, mMaxAverageLuminance=225.15, mMinLuminance=0.3}, allmSupported false, gameContentTypeSupported false, density 420, 397.565 x 393.29 dpi, appVsyncOff 2333332, presDeadline 11500000, cutout DisplayCutout{insets=Rect(0, 106 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(478, 0 - 602, 106), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 physicalDisplayWidth=1080 physicalDisplayHeight=2400 density={2.625} cutoutSpec={M -62,0 L 62,0 L 62,106 L -62,106 Z} rotation={0} scale={1.0} physicalPixelDisplaySizeRatio={1.0}}} sideOverrides={}}, touch INTERNAL, rotation 0, type INTERNAL, address {port=129, model=0x40446d0cde1eeb}, deviceProductInfo DeviceProductInfo{name=, manufacturerPnpId=QCM, productId=1, modelYear=null, manufactureDate=ManufactureDate{week=27, year=2006}, connectionToSinkType=0}, state ON, committedState ON, frameRateOverride {uid=10278 frameRateHz=30.000002} , brightnessMinimum 0.0, brightnessMaximum 1.0, brightnessDefault 0.45882353, hdrSdrRatio NaN, FLAG_ALLOWED_TO_BE_DEFAULT_DISPLAY, FLAG_ROTATES_WITH_CONTENT, FLAG_SECURE, FLAG_SUPPORTS_PROTECTED_BUFFERS, FLAG_TRUSTED, installOrientation 0, displayShape DisplayShape{ spec=-1893857183 displayWidth=1080 displayHeight=2400 physicalPixelDisplaySizeRatio=1.0 rotation=0 offsetX=0 offsetY=0 scale=1.0}}\n02-25 15:08:06.060  1483  1783 D DisplayManagerService: Ignore redundant display event 0/2 to 10131/8135\n02-25 15:08:06.060   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.060   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.060  1483  1783 D DisplayManagerService: Ignore redundant display event 0/2 to 10233/21891\n02-25 15:08:06.060  1279  2210 D audio_hw_primary: adev_set_parameters: enter: screen_state=on\n02-25 15:08:06.060  1279  2210 V msm8974_platform: platform_set_parameters: enter: screen_state=on\n02-25 15:08:06.060  1279  2210 V msm8974_platform: platform_set_parameters: exit with code(0)\n02-25 15:08:06.060  1279  2210 D audio_hw_primary: adev_set_parameters: exit with code(0) takes 0.05 ms\n02-25 15:08:06.062 23756 23827 W MessageQueue: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:06.062 23756 23827 W MessageQueue: java.lang.IllegalStateException: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.MessageQueue.enqueueMessage(MessageQueue.java:603)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.Handler.enqueueMessage(Handler.java:787)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.Handler.sendMessageAtTime(Handler.java:736)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.Handler.sendMessageDelayed(Handler.java:706)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.Handler.post(Handler.java:436)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:43)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.-$$Nest$mhandleDisplayEvent(Unknown Source:0)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal$DisplayManagerCallback.onDisplayEvent(DisplayManagerGlobal.java:1192)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.hardware.display.IDisplayManagerCallback$Stub.onTransact(IDisplayManagerCallback.java:87)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.Binder.execTransactInternal(Binder.java:1505)\n02-25 15:08:06.062 23756 23827 W MessageQueue: \tat android.os.Binder.execTransact(Binder.java:1444)\n02-25 15:08:06.063 23756 23827 W Binder  : Caught a RuntimeException from the binder stub implementation.\n02-25 15:08:06.063 23756 23827 W Binder  : java.util.concurrent.RejectedExecutionException: Handler (android.os.Handler) {3ca401f} is shutting down\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:44)\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal.-$$Nest$mhandleDisplayEvent(Unknown Source:0)\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal$DisplayManagerCallback.onDisplayEvent(DisplayManagerGlobal.java:1192)\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.hardware.display.IDisplayManagerCallback$Stub.onTransact(IDisplayManagerCallback.java:87)\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.os.Binder.execTransactInternal(Binder.java:1505)\n02-25 15:08:06.063 23756 23827 W Binder  : \tat android.os.Binder.execTransact(Binder.java:1444)\n02-25 15:08:06.066  2591  2591 D DisplayRepository: combining enabled=[0], connectedExternalDisplayIds=[], ignored=[]\n02-25 15:08:06.075   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.075   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.092   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.092   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.126   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.126   910   910 W HwcComposer: command 0x4080000 generated error 4\n02-25 15:08:06.127 14937 23214 I NearbyMediums: No BLE Fast/GATT advertisements found in the latest cycle.\n02-25 14:58:11.531     0     0 E msm_dwc3_perf_vote_work: in_perf_mode:0, interrupts in last sample:175\n02-25 15:08:06.141  2591  2622 V WindowManagerShell: Transition animation finished (aborted=false), notifying core (#4506) android.os.BinderProxy@81e92d8@0\n02-25 15:08:06.142  1483  1779 V WindowManager: Finish Transition (#4506): created at 02-25 15:08:05.878 collect-started=0.132ms request-sent=0.268ms started=3.502ms ready=35.368ms sent=72.881ms finished=264.041ms\n02-25 15:08:06.142  2591  2622 V WindowManagerShell: Track 0 became idle\n02-25 15:08:06.143  2591  2622 V WindowManagerShell: All active transition animations finished\n02-25 15:08:06.424 21479 21479 D SensorReceiver: Received intent: android.intent.action.CONFIGURATION_CHANGED\n02-25 15:08:06.425 21479 21479 D SensorReceiver: Sensor(s) [screen_orientation, screen_rotation] corresponding to received event android.intent.action.CONFIGURATION_CHANGED are disabled, skipping sensors update\n02-25 15:08:06.531 14937 23214 I NearbySharing: Network state changed: NetworkState(isRestricted=false, isOnline=true, isCongested=false, isMetered=false, isWifiConnected=true)\n02-25 14:58:11.959     0     0 I ufstw_suspend: 824 ufstw_lu4 goto suspend\n02-25 14:58:11.964     0     0 I ufstw_cancel_lu_jobs: 509 cancel_delayed_work_sync(tw_flush_work) ufstw_lu4 = 0\n02-25 14:58:11.973     0     0 I ufstw_cancel_lu_jobs: 512 cancel_work_sync(tw_lifetime_work) ufstw_lu4 = 0\n02-25 15:08:06.588  1324 11336 I WifiHAL : event received NL80211_CMD_VENDOR, vendor_id = 0x1374, subcmd = 0xd\n02-25 15:08:06.588  1642  1642 I cnss-daemon: nl80211 response handler invoked\n02-25 15:08:06.589  1642  1642 I cnss-daemon: nl80211_response_handler: cmd 103, vendorID 4980, subcmd 13  received\n02-25 15:08:06.872  1281 19478 E sensors-hal: handle_sns_client_event:62, mot_disprot_event: now=1128930374192150 ts=1128930262436852, type=16, status=3\n02-25 15:08:07.271  1281 19478 E sensors-hal: handle_sns_client_event:62, mot_disprot_event: now=1128930772865940 ts=1128930700642477, type=0, status=3\n02-25 15:08:07.272  2591  2622 V WindowManagerShell: Transition requested (#4507): android.os.BinderProxy@d8de7f7 TransitionRequestInfo { type = CHANGE, triggerTask = null, pipTask = null, remoteTransition = null, displayChange = DisplayChange { displayId = 0, startAbsBounds = null, endAbsBounds = null, startRotation = 1, endRotation = 0, physicalDisplayChanged = false }, flags = 0, debugId = 4507 }\n02-25 15:08:07.276  1483  1783 I ActivityTaskManager: Config changes=20000480 {1.0 310mcc240mnc [en_US] ldltr sw411dp w411dp h850dp 420dpi nrml long port night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 1080, 2400) mAppBounds=Rect(0, 106 - 1080, 2337) mMaxBounds=Rect(0, 0 - 1080, 2400) mDisplayRotation=ROTATION_0 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_0} as.2 s.25152 fontWeightAdjustment=0}\n02-25 15:08:07.279  1483  1783 W ActivityTaskManager: Current config: {1.0 310mcc240mnc [en_US] ldltr sw411dp w874dp h359dp 420dpi nrml long land night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 2400, 1080) mAppBounds=Rect(106, 0 - 2400, 1017) mMaxBounds=Rect(0, 0 - 2400, 1080) mDisplayRotation=ROTATION_90 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_90} as.2 s.25152 fontWeightAdjustment=0} unchanged for IME proc org.futo.inputmethod.latin.playstore\n02-25 15:08:07.286  1483  1783 I WindowManager: Override config changes=20000480 {1.0 310mcc240mnc [en_US] ldltr sw411dp w411dp h850dp 420dpi nrml long port night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 1080, 2400) mAppBounds=Rect(0, 106 - 1080, 2337) mMaxBounds=Rect(0, 0 - 1080, 2400) mDisplayRotation=ROTATION_0 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_0} as.2 s.25152 fontWeightAdjustment=0} for displayId=0\n02-25 15:08:07.302  1483  1783 W ImageReader_JNI: Unable to acquire a buffer item, very likely client tried to acquire more than maxImages buffers\n02-25 15:08:07.304  1483  1483 W WindowTokenClientController: Can't find attached WindowTokenClient for android.window.WindowTokenClient@748c1de\n02-25 15:08:07.304  1483  1783 V ActivityTaskManager: Sending to IME proc org.futo.inputmethod.latin.playstore new config {1.0 310mcc240mnc [en_US] ldltr sw411dp w411dp h850dp 420dpi nrml long port night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 1080, 2400) mAppBounds=Rect(0, 106 - 1080, 2337) mMaxBounds=Rect(0, 0 - 1080, 2400) mDisplayRotation=ROTATION_0 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_0} as.2 s.25195 fontWeightAdjustment=0}\n02-25 15:08:07.308 11197 11197 D b/254119092: TaskbarManager#mComponentCallbacks.onConfigurationChanged: {1.0 310mcc240mnc [en_US] ldltr sw411dp w411dp h850dp 420dpi nrml long port night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 1080, 2400) mAppBounds=Rect(0, 106 - 1080, 2337) mMaxBounds=Rect(0, 0 - 1080, 2400) mDisplayRotation=ROTATION_0 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_0} as.2 s.25152 fontWeightAdjustment=0}\n02-25 15:08:07.308 11197 11197 D b/254119092: mActivity and mContext agree taskbarIsPresent=false\n02-25 15:08:07.308 11197 11197 D b/254119092: ComponentCallbacks#onConfigurationChanged() configDiff={}\n02-25 15:08:07.308 11197 11197 D b/254119092: mActivity and mContext agree taskbarIsPresent=false\n02-25 15:08:07.308 11197 11197 D b/254119092: destroyExistingTaskbar: null\n02-25 15:08:07.308 11197 11197 D b/254119092: mActivity and mContext agree taskbarIsPresent=false\n02-25 15:08:07.308 11197 11197 D b/254119092: recreateTaskbar: isTaskbarEnabled=false [dp != null (i.e. mUserUnlocked)]=true FLAG_HIDE_NAVBAR_WINDOW=false dp.isTaskbarPresent=false\n02-25 15:08:07.308 11197 11197 D b/254119092: mActivity and mContext agree taskbarIsPresent=false\n02-25 15:08:07.308  2591  2622 V ShellDragAndDrop: Display changed: 0\n02-25 15:08:07.309 21775 21775 W LatinIME: Configuration changed\n02-25 15:08:07.309  1483  1783 I InputManager-JNI: Viewport [0] to add: local:4630946218877315969, isActive: true\n02-25 15:08:07.309 11197 11197 D b/254119092: DisplayController#onConfigurationChanged: {1.0 310mcc240mnc [en_US] ldltr sw411dp w411dp h850dp 420dpi nrml long port night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 1080, 2400) mAppBounds=Rect(0, 106 - 1080, 2337) mMaxBounds=Rect(0, 0 - 1080, 2400) mDisplayRotation=ROTATION_0 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_0} as.2 s.25152 fontWeightAdjustment=0}\n02-25 15:08:07.309  1483  2477 I InputReader: Reconfiguring input devices, changes=DISPLAY_INFO\n02-25 15:08:07.314  1483  1783 D DisplayManagerService: Ignore redundant display event 0/2 to 10131/8135\n02-25 15:08:07.314  1279  2210 D audio_hw_primary: adev_set_parameters: enter: screen_state=on\n02-25 15:08:07.314  1279  2210 V msm8974_platform: platform_set_parameters: enter: screen_state=on\n02-25 15:08:07.314  1279  2210 V msm8974_platform: platform_set_parameters: exit with code(0)\n02-25 15:08:07.314  1279  2210 D audio_hw_primary: adev_set_parameters: exit with code(0) takes 0.05 ms\n02-25 15:08:07.315  1483  1783 D DisplayManagerService: Ignore redundant display event 0/2 to 10233/21891\n02-25 15:08:07.316 23756 23827 W MessageQueue: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:07.316 23756 23827 W MessageQueue: java.lang.IllegalStateException: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.MessageQueue.enqueueMessage(MessageQueue.java:603)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.Handler.enqueueMessage(Handler.java:787)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.Handler.sendMessageAtTime(Handler.java:736)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.Handler.sendMessageDelayed(Handler.java:706)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.Handler.post(Handler.java:436)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:43)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.-$$Nest$mhandleDisplayEvent(Unknown Source:0)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal$DisplayManagerCallback.onDisplayEvent(DisplayManagerGlobal.java:1192)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.hardware.display.IDisplayManagerCallback$Stub.onTransact(IDisplayManagerCallback.java:87)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.Binder.execTransactInternal(Binder.java:1505)\n02-25 15:08:07.316 23756 23827 W MessageQueue: \tat android.os.Binder.execTransact(Binder.java:1444)\n02-25 15:08:07.316  1279  2210 D audio_hw_primary: adev_set_parameters: enter: rotation=0\n02-25 15:08:07.316  1279  2210 V msm8974_platform: platform_set_parameters: enter: rotation=0\n02-25 15:08:07.316  1279  2210 V msm8974_platform: platform_set_parameters: exit with code(0)\n02-25 15:08:07.316  1279  2210 D audio_hw_primary: adev_set_parameters: exit with code(0) takes 0.05 ms\n02-25 15:08:07.317 23756 23827 W Binder  : Caught a RuntimeException from the binder stub implementation.\n02-25 15:08:07.317 23756 23827 W Binder  : java.util.concurrent.RejectedExecutionException: Handler (android.os.Handler) {3ca401f} is shutting down\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:44)\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal.-$$Nest$mhandleDisplayEvent(Unknown Source:0)\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.hardware.display.DisplayManagerGlobal$DisplayManagerCallback.onDisplayEvent(DisplayManagerGlobal.java:1192)\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.hardware.display.IDisplayManagerCallback$Stub.onTransact(IDisplayManagerCallback.java:87)\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.os.Binder.execTransactInternal(Binder.java:1505)\n02-25 15:08:07.317 23756 23827 W Binder  : \tat android.os.Binder.execTransact(Binder.java:1444)\n02-25 15:08:07.319 23756 23756 W MessageQueue: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:07.319 23756 23756 W MessageQueue: java.lang.IllegalStateException: Handler (android.os.Handler) {3ca401f} sending message to a Handler on a dead thread\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.MessageQueue.enqueueMessage(MessageQueue.java:603)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.Handler.enqueueMessage(Handler.java:787)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.Handler.sendMessageAtTime(Handler.java:736)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.Handler.sendMessageDelayed(Handler.java:706)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.Handler.post(Handler.java:436)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:43)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.hardware.display.DisplayManagerGlobal.handleDisplayChangeFromWindowManager(DisplayManagerGlobal.java:425)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.app.servertransaction.ClientTransactionListenerController.onDisplayChanged(ClientTransactionListenerController.java:76)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:131)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.app.ActivityThread$H.handleMessage(ActivityThread.java:2595)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.Handler.dispatchMessage(Handler.java:107)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.Looper.loopOnce(Looper.java:232)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.os.Looper.loop(Looper.java:317)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat android.app.ActivityThread.main(ActivityThread.java:8592)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat java.lang.reflect.Method.invoke(Native Method)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:580)\n02-25 15:08:07.319 23756 23756 W MessageQueue: \tat com.android.internal.os.ZygoteInit.main(ZygoteInit.java:878)\n02-25 15:08:07.319 23756 23756 D AndroidRuntime: Shutting down VM\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: FATAL EXCEPTION: main\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: Process: com.example.orientationtest, PID: 23756\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: java.util.concurrent.RejectedExecutionException: Handler (android.os.Handler) {3ca401f} is shutting down\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.os.HandlerExecutor.execute(HandlerExecutor.java:44)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.hardware.display.DisplayManagerGlobal.handleDisplayChangeFromWindowManager(DisplayManagerGlobal.java:425)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.app.servertransaction.ClientTransactionListenerController.onDisplayChanged(ClientTransactionListenerController.java:76)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:131)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.app.ActivityThread$H.handleMessage(ActivityThread.java:2595)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.os.Handler.dispatchMessage(Handler.java:107)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.os.Looper.loopOnce(Looper.java:232)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.os.Looper.loop(Looper.java:317)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat android.app.ActivityThread.main(ActivityThread.java:8592)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat java.lang.reflect.Method.invoke(Native Method)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:580)\n02-25 15:08:07.319 23756 23756 E AndroidRuntime: \tat com.android.internal.os.ZygoteInit.main(ZygoteInit.java:878)\n02-25 15:08:07.320  2591  2591 I NoBackGesture: Config changed: newConfig={1.0 310mcc240mnc [en_US] ldltr sw411dp w411dp h850dp 420dpi nrml long port night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 1080, 2400) mAppBounds=Rect(0, 106 - 1080, 2337) mMaxBounds=Rect(0, 0 - 1080, 2400) mDisplayRotation=ROTATION_0 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_0} as.2 s.25192 fontWeightAdjustment=0} lastReportedConfig={1.0 310mcc240mnc [en_US] ldltr sw411dp w874dp h359dp 420dpi nrml long land night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 2400, 1080) mAppBounds=Rect(106, 0 - 2400, 1017) mMaxBounds=Rect(0, 0 - 2400, 1080) mDisplayRotation=ROTATION_90 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_90} as.2 s.25146 fontWeightAdjustment=0}\n02-25 15:08:07.321  2591  2591 I NoBackGesture: NavbarController: newConfig={1.0 310mcc240mnc [en_US] ldltr sw411dp w411dp h850dp 420dpi nrml long port night finger -keyb/v/h -nav/h winConfig={ mBounds=Rect(0, 0 - 1080, 2400) mAppBounds=Rect(0, 106 - 1080, 2337) mMaxBounds=Rect(0, 0 - 1080, 2400) mDisplayRotation=ROTATION_0 mWindowingMode=fullscreen mDisplayWindowingMode=fullscreen mActivityType=undefined mAlwaysOnTop=undefined mRotation=ROTATION_0} as.2 s.25192 fontWeightAdjustment=0} mTaskbarDelegate initialized=false willApplyConfigToNavbars=false navBarCount=1\n02-25 15:08:07.321  1483  2929 E ActivityManager: App crashed on incremental package com.example.orientationtest which is 100% loaded.\n02-25 15:08:07.322  1483  2929 E incfs   : IncFs_GetMetrics: failed to read file: /sys/fs/incremental-fs/instances/MT_data_app_vmdl198bbb641be-cd98-4594-8603-f9327d2a4af8/reads_delayed_min: No such file or directory\n02-25 15:08:07.326  1483 23849 I DropBoxManagerService: add tag=data_app_crash isTagEnabled=true flags=0x2\n02-25 15:08:07.326   910   910 D DisplayDevice: setDesiredMode 4630946218877315969 {mode=60.00 Hz (60.00 Hz(60.00 Hz)), emitEvent=true, force=false}\n02-25 15:08:07.327  1483  2929 W ActivityTaskManager:   Force finishing activity com.example.orientationtest/com.godot.game.GodotApp\n02-25 15:08:07.327  1483  1783 I DisplayDeviceRepository: Display device changed: DisplayDeviceInfo{\"Built-in Screen\": uniqueId=\"local:4630946218877315969\", 1080 x 2400, modeId 1, renderFrameRate 60.000004, defaultModeId 1, userPreferredModeId -1, supportedModes [{id=1, width=1080, height=2400, fps=60.000004, vsync=60.000004, alternativeRefreshRates=[], supportedHdrTypes=[2, 3, 4]}], colorMode 0, supportedColorModes [0, 7, 9], hdrCapabilities HdrCapabilities{mSupportedHdrTypes=[2, 3, 4], mMaxLuminance=450.0, mMaxAverageLuminance=225.15, mMinLuminance=0.3}, allmSupported false, gameContentTypeSupported false, density 420, 397.565 x 393.29 dpi, appVsyncOff 2333332, presDeadline 11500000, cutout DisplayCutout{insets=Rect(0, 106 - 0, 0) waterfall=Insets{left=0, top=0, right=0, bottom=0} boundingRect={Bounds=[Rect(0, 0 - 0, 0), Rect(478, 0 - 602, 106), Rect(0, 0 - 0, 0), Rect(0, 0 - 0, 0)]} cutoutPathParserInfo={CutoutPathParserInfo{displayWidth=1080 displayHeight=2400 physicalDisplayWidth=1080 physicalDisplayHeight=2400 density={2.625} cutoutSpec={M -62,0 L 62,0 L 62,106 L -62,106 Z} rotation={0} scale={1.0} physicalPixelDisplaySizeRatio={1.0}}} sideOverrides={}}, touch INTERNAL, rotation 0, type INTERNAL, address {port=129, model=0x40446d0cde1eeb}, deviceProductInfo DeviceProductInfo{name=, manufacturerPnpId=QCM, productId=1, modelYear=null, manufactureDate=ManufactureDate{week=27, year=2006}, connectionToSinkType=0}, state ON, committedState ON, frameRateOverride {uid=10278 frameRateHz=30.000002} , brightnessMinimum 0.0, brightnessMaximum 1.0, brightnessDefault 0.45882353, hdrSdrRatio NaN, FLAG_ALLOWED_TO_BE_DEFAULT_DISPLAY, FLAG_ROTATES_WITH_CONTENT, FLAG_SECURE, FLAG_SUPPORTS_PROTECTED_BUFFERS, FLAG_TRUSTED, installOrientation 0, displayShape DisplayShape{ spec=-1893857183 displayWidth=1080 displayHeight=2400 physicalPixelDisplaySizeRatio=1.0 rotation=0 offsetX=0 offsetY=0 scale=1.0}}\n02-25 15:08:07.334 23756 23756 I Process : Sending signal. PID: 23756 SIG: 9\n02-25 15:08:07.335  1483  1783 D DisplayManagerService: Ignore redundant display event 0/2 to 10131/8135\n02-25 15:08:07.336  1483  1783 D DisplayManagerService: Ignore redundant display event 0/2 to 10233/21891\n02-25 15:08:07.336  1279  2210 D audio_hw_primary: adev_set_parameters: enter: screen_state=on\n02-25 15:08:07.336  1279  2210 V msm8974_platform: platform_set_parameters: enter: screen_state=on\n02-25 15:08:07.336  1279  2210 V msm8974_platform: platform_set_parameters: exit with code(0)\n02-25 15:08:07.336  1279  2210 D audio_hw_primary: adev_set_parameters: exit with code(0) takes 0.09 ms\n02-25 15:08:07.342   910   910 I BpBinder: onLastStrongRef automatically unlinking death recipients: \n02-25 15:08:07.356  2591  2591 D DisplayRepository: combining enabled=[0], connectedExternalDisplayIds=[], ignored=[]\n02-25 15:08:07.366  1483 13447 I ActivityManager: Process com.example.orientationtest (pid 23756) has died: fg  TOP \n02-25 15:08:07.367  1483  3871 I WindowManager: WIN DEATH: Window{8cae66a u0 com.example.orientationtest/com.godot.game.GodotApp}\n02-25 15:08:07.367  1483  3871 W InputManager-JNI: Input channel object '8cae66a com.example.orientationtest/com.godot.game.GodotApp (client)' was disposed without first being removed with the input manager!\n02-25 15:08:07.369  1483  2668 I ImeTracker: com.example.orientationtest:c553b016: onRequestHide at ORIGIN_SERVER reason HIDE_REMOVE_CLIENT fromUser false\n02-25 15:08:07.369  1483  2668 I ImeTracker: com.example.orientationtest:c553b016: onCancelled at PHASE_SERVER_SHOULD_HIDE\n02-25 14:58:12.767     0     0 W binder_cleanup_transaction: 1 callbacks suppressed\n02-25 14:58:12.767     0     0 I binder  : undelivered transaction 179182577, process died.\n02-25 15:08:07.373  1483  1900 I libprocessgroup: Removed cgroup /sys/fs/cgroup/uid_10278/pid_23756\n02-25 15:08:07.381  1149  1149 I Zygote  : Process 23756 exited due to signal 9 (Killed)\n02-25 14:58:12.780     0     0 I binder  : undelivered transaction 179182684, process died.\n02-25 15:08:07.387  1483  1780 V GameManagerService: Game power mode OFF (no games in foreground)\n\n```\n\n</details>\n\n--------------------\n\n\n`SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.`\n\nWe could still try an export template without \u201cSwappy\u201d. I'll try to compile it for you tomorrow.\n @brycehenley Please try disabling `Frame Pacing` in the project settings first:\n\n<details> <summary>Screenshot:  Display -> Window -> Frame Pacing </summary>\n\n![Image](https://github.com/user-attachments/assets/1f12fa74-a14f-43fe-9cbd-2bfedf4f2b9e)\n</details>\n\n\n\n<details><summary>If that doesn't help, then try an export template without swappy.</summary>\n\n----------------------\n\n[android_debug_no_swappy_4.4-rc2.apk](https://drive.google.com/file/d/1NgGGyCBaM7L-TDcbjdumvOGsqt56Qe3d/view?usp=sharing) (85 MB Download, arm32 / arm64)\n**or** \nhttps://docs.godotengine.org/en/stable/contributing/development/compiling/compiling_for_android.html\n`scons platform=android target=template_debug arch=arm64 generate_apk=yes swappy=no`\n\n<details> <summary>Screenshot: Export -> Custom Template -> Debug </summary>\n\n![Image](https://github.com/user-attachments/assets/a59d1514-8100-4d52-b6ad-e8595c5797cc)\n</details>\n\n---------------\n\nI noticed that `SwappyDisplayManager` keeps restarting when the display orientation is changed.\nHowever, these logcat entries only disappear when \u201cFrame Pacing\u201d is deactivated under project settings.\n\n![Image](https://github.com/user-attachments/assets/47578dc4-721f-43af-bb89-51f8dff92b8d)\n</details>\n\nOn Firebase Test Lab I tested on 10 other devices, mostly `Adreno 610 `and `Adreno 619,` no crashes reproducible. (With swappy/frame pacing)\n\n\nRotating worked after disabling Frame Pacing.\n> Rotating worked after disabling Frame Pacing.\n\nCC @darksylinc\nWill take a look at it tomorrow! Thanks for the CC.\n\nIn the meantime the workaround is to disable Frame Pacing.\nIn the commit logs on the first page I see `swappy` 9 times\n\nhttps://android.googlesource.com/platform/frameworks/opt/gamesdk/+log\n\n> 80243e8 Fix race condition in Swappy destructor Bug: b/298957185 Test: Bouncyball by Victor Repetskyi \u00b7 1 year, 5 months ago\n\nMaybe we can try with a new version first? @darksylinc \n`v2023.3.0.0`\nhttps://github.com/darksylinc/godot-swappy/releases\nI cannot repro this on my phones, however I recognize this error from my own apps (non-Godot) that trace back to Swappy:\n\n```\nCaught a RuntimeException from the binder stub implementation.\njava.util.concurrent.RejectedExecutionException: Handler (android.os.Handler) {3ca401f} is shutting down\n\tat android.os.HandlerExecutor.execute(HandlerExecutor.java:44)\n\tat android.hardware.display.DisplayManagerGlobal$DisplayListenerDelegate.sendDisplayEvent(DisplayManagerGlobal.java:1219)\n\tat android.hardware.display.DisplayManagerGlobal.handleDisplayEvent(DisplayManagerGlobal.java:517)\n\tat android.hardware.display.DisplayManagerGlobal.-$$Nest$mhandleDisplayEvent(Unknown Source:0)\n\tat android.hardware.display.DisplayManagerGlobal$DisplayManagerCallback.onDisplayEvent(DisplayManagerGlobal.java:1192)\n\tat android.hardware.display.IDisplayManagerCallback$Stub.onTransact(IDisplayManagerCallback.java:87)\n\tat android.os.Binder.execTransactInternal(Binder.java:1505)\n\tat android.os.Binder.execTransact(Binder.java:1444)\n```\n\nWhich is more common in certain specific models for but I was never able to repro myself.\n\nI'll follow Alex2782's advise and build a newer version of Swappy.\nOK I created a new Android export template based on the latest version of Swappy.\n\nCould you test it out @brycehenley and see if that fixes your problem?\n\n[Download it from here](https://github.com/darksylinc/temp/releases/tag/swappy).\n\n**Edit:** In case you don't know where it goes, they must replace the ones in your export templates folder. You can see where the folder location is by going to `Editor-> Manage Export Templates`:\n\n![Image](https://github.com/user-attachments/assets/1349c4d8-473e-47cd-ba05-36a27ca4aacc)\n\nIn this picture, it's in `/home/matias/.local/share/godot/export_templates/4.4.beta` because I'm on Linux.\nalso possible: `Export -> Advanced Options -> Custom Template`\n\n<details><summary>Screenshot</summary>\n\n![Image](https://github.com/user-attachments/assets/73373160-303c-4fcc-a906-780d1e52157e)\n</details>\n\nEnable `Frame Pacing` again and check logcat: `adb logcat -s SwappyDisplayManager`\n```java\n--------- beginning of main\n02-28 00:24:58.768 29670 29822 I SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.\n02-28 00:24:58.771 29670 29981 I SwappyDisplayManager: Starting looper thread\n```\n\nUsing the custom export template with the latest version of Swappy solved the app crashing issue.\n\nLogcat shows Swappy starting and terminating the looper thread on every rotation. I'm not familiar with Swappy so I don't know if that is the expected behavior.\n\n```java\n02-27 17:18:32.851 20797 20869 I SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.\n02-27 17:18:32.853 20797 20903 I SwappyDisplayManager: Starting looper thread\n02-27 17:18:35.405 20797 20903 I SwappyDisplayManager: Terminating looper thread\n02-27 17:18:35.427 20797 20869 I SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.\n02-27 17:18:35.429 20797 20908 I SwappyDisplayManager: Starting looper thread\n02-27 17:18:39.830 20797 20908 I SwappyDisplayManager: Terminating looper thread\n02-27 17:18:39.845 20797 20869 I SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.\n02-27 17:18:39.847 20797 20914 I SwappyDisplayManager: Starting looper thread\n02-27 17:18:41.801 20797 20914 I SwappyDisplayManager: Terminating looper thread\n02-27 17:18:41.816 20797 20869 I SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.\n02-27 17:18:41.818 20797 20919 I SwappyDisplayManager: Starting looper thread\n02-27 17:18:43.804 20797 20919 I SwappyDisplayManager: Terminating looper thread\n02-27 17:18:43.825 20797 20869 I SwappyDisplayManager: Using internal com/google/androidgamesdk/SwappyDisplayManager class from dex bytes.\n02-27 17:18:43.828 20797 20924 I SwappyDisplayManager: Starting looper thread\n```\n\nThat's ok, thanks for testing!\n> Using the custom export template with the latest version of Swappy solved the app crashing issue.\n\nThat's awesome!\n\nI'll update the libs and prepare a PR.\n\n> Logcat shows Swappy starting and terminating the looper thread on every rotation. I'm not familiar with Swappy so I don't know if that is the expected behavior.\n\nAs long as it happens on every rotation, that is expected behavior.\nIf it gets spammed every frame without you doing anything, that would not be expected behavior.", "created_at": "2025-02-28 18:02:52", "merge_commit_sha": "e8c555b0021aad8608805d76b6ab3f5decfcc8ba", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103403", "base_commit": "1753893c60ac309c21a77201725fa2820caf7f1e", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex f1d13123d659..de52afa91cda 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -1207,7 +1207,7 @@ void EditorNode::_sources_changed(bool p_exist) {\n \t\t}\n \n \t\t// Start preview thread now that it's safe.\n-\t\tif (!singleton->cmdline_export_mode) {\n+\t\tif (!singleton->cmdline_mode) {\n \t\t\tEditorResourcePreview::get_singleton()->start();\n \t\t}\n \n@@ -1807,7 +1807,7 @@ void EditorNode::_save_scene_with_preview(String p_file, int p_idx) {\n \tsave_scene_progress->step(TTR(\"Saving Scene\"), 4);\n \t_save_scene(p_file, p_idx);\n \n-\tif (!singleton->cmdline_export_mode) {\n+\tif (!singleton->cmdline_mode) {\n \t\tEditorResourcePreview::get_singleton()->check_for_invalidation(p_file);\n \t}\n \n@@ -4944,7 +4944,7 @@ bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringNa\n void EditorNode::progress_add_task(const String &p_task, const String &p_label, int p_steps, bool p_can_cancel) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": begin: \" + p_label + \" steps: \" + itos(p_steps));\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->add_task(p_task, p_label, p_steps, p_can_cancel);\n@@ -4954,7 +4954,7 @@ void EditorNode::progress_add_task(const String &p_task, const String &p_label,\n bool EditorNode::progress_task_step(const String &p_task, const String &p_state, int p_step, bool p_force_refresh) {\n \tif (!singleton) {\n \t\treturn false;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(\"\\t\" + p_task + \": step \" + itos(p_step) + \": \" + p_state);\n \t\treturn false;\n \t} else if (singleton->progress_dialog) {\n@@ -4967,7 +4967,7 @@ bool EditorNode::progress_task_step(const String &p_task, const String &p_state,\n void EditorNode::progress_end_task(const String &p_task) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": end\");\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->end_task(p_task);\n@@ -5220,7 +5220,7 @@ Error EditorNode::export_preset(const String &p_preset, const String &p_path, bo\n \texport_defer.android_build_template = p_android_build_template;\n \texport_defer.patch = p_patch;\n \texport_defer.patches = p_patches;\n-\tcmdline_export_mode = true;\n+\tcmdline_mode = true;\n \treturn OK;\n }\n \n@@ -6848,6 +6848,11 @@ EditorNode::EditorNode() {\n \tDEV_ASSERT(!singleton);\n \tsingleton = this;\n \n+\t// Detecting headless mode, that means the editor is running in command line.\n+\tif (!DisplayServer::get_singleton()->window_can_draw()) {\n+\t\tcmdline_mode = true;\n+\t}\n+\n \tResource::_get_local_scene_func = _resource_get_edited_scene;\n \n \t{\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex de3af997473a..63788e645f30 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -419,7 +419,7 @@ class EditorNode : public Node {\n \tbool script_distraction_free = false;\n \n \tbool changing_scene = false;\n-\tbool cmdline_export_mode = false;\n+\tbool cmdline_mode = false;\n \tbool convert_old = false;\n \tbool immediate_dialog_confirmed = false;\n \tbool opening_prev = false;\n", "test_patch": "", "problem_statement": "Headless import always emits errors about `!tasks.has(p_task)`\n### Tested versions\n\n- Reproducible in: 4.4.rc2\n- Reproducible in: 4.4.dev2\n- Not reproducible in: 4.4.dev1\n\n### System information\n\nGodot v4.4.rc2 - Windows 11 (build 26100) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 9 7940HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\n(This is a formal issue for what's mentioned [here](https://github.com/godotengine/godot/issues/100900#issuecomment-2567712127), and potentially a duplicate of #100900 itself, but since that one mentions errors at startup I figured it's possibly a different issue.)\n\nWhen running Godot with `--headless --import` on any project, you're currently met with the following output:\n\n```\nERROR: Do not use progress dialog (task) while flushing the message queue or using call_deferred()!\n   at: add_task (editor/progress_dialog.cpp:183)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true.\n   at: end_task (editor/progress_dialog.cpp:240)\n```\n\nThe import seems to complete successfully despite that, I think.\n\nWhen bisecting it seems that this is a regression stemming from #93064.\n\n### Steps to reproduce\n\n- Create a new project.\n- Run `/path/to/godot --headless --import` in the project folder.\n- Note the errors.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "CC @Hilderin", "created_at": "2025-02-28 16:16:46", "merge_commit_sha": "02bedd8ac272351def33b3a16604bcbe46386b7f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103266", "base_commit": "39c201ca58a8ddf1e99e62c8453294a2662a2fd8", "patch": "diff --git a/editor/editor_dock_manager.cpp b/editor/editor_dock_manager.cpp\nindex 51c15f3db911..32269f91a109 100644\n--- a/editor/editor_dock_manager.cpp\n+++ b/editor/editor_dock_manager.cpp\n@@ -547,10 +547,10 @@ void EditorDockManager::load_docks_from_config(Ref<ConfigFile> p_layout, const S\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\tControl *dock = dock_map[name];\n-\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \n \t\t\tif (!all_docks[dock].enabled) {\n \t\t\t\t// Don't open disabled docks.\n+\t\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\tbool at_bottom = false;\n@@ -563,6 +563,7 @@ void EditorDockManager::load_docks_from_config(Ref<ConfigFile> p_layout, const S\n \t\t\t} else if (i >= 0) {\n \t\t\t\t_move_dock(dock, dock_slot[i], 0);\n \t\t\t}\n+\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \n \t\t\tif (closed_docks.has(name)) {\n \t\t\t\t_move_dock(dock, closed_dock_parent);\n", "test_patch": "", "problem_statement": "Bottom FileSystem dock does not save layout options\n### Tested versions\n\n- Reproducible in: 4.4.beta1.mono to 4.4.rc1.mono\n- Not reproducible in: 4.4.dev7.mono and earlier\n\n### System information\n\nGodot v4.4.rc1.mono - macOS Sequoia (15.3.1) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 Max (Apple8) - Apple M2 Max (12 threads)\n\n### Issue description\n\nThe bottom panel FileSystem dock does not save layout options (Split Mode, View items as list/thumbnails). Reopening the editor causes these layout options to be reset.\nThis issue exists only when the FileSystem dock is placed at the bottom panel, and does not exist when it is placed in any of the 8 slots on the side.\n\n### Steps to reproduce\n\nhttps://github.com/user-attachments/assets/b135bbb2-69f4-45ee-9ada-6a11bcfeb299\n\n1. Open any project.\n2. Move the FileSystem dock to the bottom panel.\n3. In the FileSystem dock, change Split Mode to top/bottom, and set View items as a list.\n4. Close Godot and reopen the project.\n5. Notice the FileSystem dock layout gets reset.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Reverting #100558 seems to fix the issue, CC @KoBeWi ", "created_at": "2025-02-24 23:13:11", "merge_commit_sha": "cc7a951140fbdf9b1173dd3f301f9b256f749284", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103259", "base_commit": "39c201ca58a8ddf1e99e62c8453294a2662a2fd8", "patch": "diff --git a/modules/bcdec/image_decompress_bcdec.cpp b/modules/bcdec/image_decompress_bcdec.cpp\nindex 6d97ca38abef..ad0c1729d64c 100644\n--- a/modules/bcdec/image_decompress_bcdec.cpp\n+++ b/modules/bcdec/image_decompress_bcdec.cpp\n@@ -158,9 +158,12 @@ void image_decompress_bcdec(Image *p_image) {\n \n \t// Compressed images' dimensions should be padded to the upper multiple of 4.\n \t// If they aren't, they need to be realigned (the actual data is correctly padded though).\n-\tif (width % 4 != 0 || height % 4 != 0) {\n-\t\tint new_width = width + (4 - (width % 4));\n-\t\tint new_height = height + (4 - (height % 4));\n+\tconst bool need_width_realign = width % 4 != 0;\n+\tconst bool need_height_realign = height % 4 != 0;\n+\n+\tif (need_width_realign || need_height_realign) {\n+\t\tint new_width = need_width_realign ? width + (4 - (width % 4)) : width;\n+\t\tint new_height = need_height_realign ? height + (4 - (height % 4)) : height;\n \n \t\tprint_verbose(vformat(\"Compressed image's dimensions are not multiples of 4 (%dx%d), aligning to (%dx%d)\", width, height, new_width, new_height));\n \n", "test_patch": "", "problem_statement": "Editor crash on startup caused by loading VRAM compressed texture with specific range of dimensions\n### Tested versions\n\n- Reproduced in 4.4 dev6, all betas, and rc1\n- Not reproduced in 4.4 dev1 through dev5\n\n### System information\n\nGodot v4.4.dev6 - Windows 10.0.19045 - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated Radeon RX 580 Series (Advanced Micro Devices, Inc.; 31.0.21921.1000) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nThe editor crashes after initialization. When running my big project with -v, the last lines displayed are these:\n```\nLoading resource: res://.godot/imported/some_texture.png-1c25004a89b329a9613253a73f2f1983.s3tc.ctex\n\tCompressed image's dimensions are not multiples of 4 (1024x1023), aligning to (1028x1024)\n```\nThe presence of `some_texture.png` actually causes the crash. I copied that texture to an empty project and found out that its dimensions, as well as it having alpha, cause a crash. Note that in the MRP, the above log message doesn't appear, although the same crash happens.\n\nI compiled with debug symbols and debugged in VS code, and the exception message is this:\n`Exception 0xc0000005 encountered at address 0x7ff6f73f5535: Access violation reading location 0x1589ca2d008`\nIt happens in `thirdparty/misc/bcdec.h`\n```\nstatic void bcdec__color_block(const void* compressedBlock, void* decompressedBlock, int destinationPitch, int onlyOpaqueMode) {\n    unsigned short c0, c1;\n    unsigned int refColors[4]; /* 0xAABBGGRR */\n    unsigned char* dstColors;\n    unsigned int colorIndices;\n    int i, j, idx;\n    unsigned int r0, g0, b0, r1, g1, b1, r, g, b;\n\n    c0 = ((unsigned short*)compressedBlock)[0]; <--------- exception here on line 119\n    c1 = ((unsigned short*)compressedBlock)[1];\n```\nAnd here's the call stack in case it helps:\n```\nstatic void bcdec__color_block(const void *, void *, int, int) (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:119)\nbcdec_bc3 (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:287)\nstatic void decompress_image(BCdecFormat, const void *, void *, const unsigned __int64, const unsigned __int64) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:129)\nvoid __cdecl image_decompress_bcdec(class Image *) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:239)\npublic: enum Error __cdecl Image::decompress(void) (c:\\tools\\Godot\\src\\godot\\core\\io\\image.cpp:2670)\npublic: virtual class Ref<class Texture2D> __cdecl EditorTexturePreviewPlugin::generate(class Ref<class Resource> const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\plugins\\editor_preview_plugins.cpp:164)\npublic: virtual class Ref<class Texture2D> __cdecl EditorResourcePreviewGenerator::generate_from_path(class String const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:73)\nprivate: void __cdecl EditorResourcePreview::_generate_preview(class Ref<class ImageTexture> &,class Ref<class ImageTexture> &,struct EditorResourcePreview::QueueItem const &,class String const &,class Dictionary &) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:205)\nprivate: void __cdecl EditorResourcePreview::_iterate(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:379)\nprivate: void __cdecl EditorResourcePreview::_thread(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:407)\nprivate: static void __cdecl EditorResourcePreview::_thread_func(void *) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:139)\nprivate: static void __cdecl Thread::callback(unsigned __int64,struct Thread::Settings const &,void (__cdecl*)(void *),void *) (c:\\tools\\Godot\\src\\godot\\core\\os\\thread.cpp:64)\nvoid std::invoke<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>( * *, unsigned __int64 *, struct Thread::Settings *,  * *, void * *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\type_traits:1741)\nunsigned int std::thread::_Invoke<std::tuple<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>,0,1,2,3,4>(void *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\thread:60)\nstatic unsigned long thread_start<unsigned int (__cdecl*)(void *),1>(void *) (@NoHotPatch:29828)\nBaseThreadInitThunk (@BaseThreadInitThunk:9)\nRtlUserThreadStart (@RtlUserThreadStart:12)\n```\n\n### Steps to reproduce\n\n1. Add a PNG texture to a project with dimensions of 1024x1023, and some alpha on at least one pixel. The MRP's `crash_texture.png` meets these criteria.\n2. Select the PNG in filesystem dock to reveal its import settings, and change the compress mode to \"VRAM compressed\"\n3. Reimport the texture and the editor crashes. It will also crash on each subsequent startup.\n\nOther resolutions that cause crash: 1024x1022, 1024x1021\nNo crash: 1024x1020, 1025x1023, 512x511\n\n### Minimal reproduction project (MRP)\n\n[texture_crash_mrp.zip](https://github.com/user-attachments/files/18947915/texture_crash_mrp.zip)\n", "hints_text": "I can reproduce this crash, bisecting.", "created_at": "2025-02-24 20:44:18", "merge_commit_sha": "9f4ac3c0b093b53dac9717fe672d59b2566d7ebc", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103176", "base_commit": "394508d26dcf1b7a9362453f9009c07d969f1a7e", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 6f57b880441f..bbdcb9e79aa1 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -732,7 +732,7 @@ def configure_mingw(env: \"SConsEnvironment\"):\n         if env[\"use_static_cpp\"]:\n             env.Append(LINKFLAGS=[\"-static\"])\n \n-    if env[\"arch\"] in [\"x86_32\", \"x86_64\"]:\n+    if env[\"arch\"] == \"x86_32\":\n         env[\"x86_libtheora_opt_gcc\"] = True\n \n     env.Append(CCFLAGS=[\"-ffp-contract=off\"])\n", "test_patch": "", "problem_statement": "VideoStreamPlayer causes game to crash upon playing video\n### Tested versions\n\n- Reproducible in v4.4.beta4.official [93d270693]\n- Not reproducible in v4.4.beta3.official [06acfccf8]\n\nThe only VideoStreamPlayer-related commit I saw in beta4 was #101958, so I think it is a likely cause of this issue.\n\n### System information\n\nWindows 11 - both Forward+ and Compatibility - both with and without dedicated GPU\n\n### Issue description\n\nGame closes without displaying any in-editor error messages upon playing a VideoStreamPlayer in 4.4 beta4.\n\n### Steps to reproduce\n\nPlay an Ogg Theora stream through a VideoStreamPlayer, either with `autoplay=true` or `play()`. Seems to affect both Forward+ and Compatibility renderers (haven't tested Mobile).\n\n### Minimal reproduction project (MRP)\n\n[videoplayerbug.zip](https://github.com/user-attachments/files/18838902/videoplayerbug.zip)\nThe main scene can be played to reproduce the issue. In beta3, this works as expected and a blue box moves across the screen. In beta4, the game exits immediately.\nMinGW GCC LTO internal compiler error when linking: cannot read 'LTO_section_decls'\n### Tested versions\n\n- Reproducible in d497631de0c67f22564e1efeb467cf9f061adc80 (commit before merge of workaround #102506) \n- Reproducible in 4.3.beta3 and latest `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) **with #102506 reverted**\n- Not reproducible in 4.3.stable or 4.4.beta2\n\n### System information\n\nFedora 41, mingw64-gcc-14.2.1-3.fc41, mingw64-headers-12.0.0-3.fc41, mingw64-binutils-2.42-2.fc41\n\n### Issue description\n\nThis is the bug report I promised in #102506, describing the actual bug that #102506 just hacks around, but that PR should be reverted and the bug fixed properly. This is very likely to be a GCC or binutils bug, and not a Godot bug.\n\nReproducible this bug requires (for now) to revert #102506 locally, as it seems like reintroducing this unnecessary code prevents the LTO internal compiler error. It's all fairly brittle though and I'm not confident it won't come back as we add/change other code, hence why this is a release blocker.\n\nWhen compiling current `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) with #102506 reverted and the following command, using MinGW-GCC:\n```\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n(mono module and LTO are important)\n\nThe linking steps fails with:\n```\nlto1: internal compiler error: cannot read 'LTO_section_decls' from /tmp/ccf5RNMk.ltrans115.o\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nSee <http://bugzilla.redhat.com/bugzilla> for instructions.\nmake: *** [/tmp/cct9c3iK.mk:347: /tmp/ccf5RNMk.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nOr this:\n```\nlto1: error: two or more sections for .gnu.lto__ZZL39_register_variant_builtin_methods_arrayvEN17Method_Array_back17get_argument_typeEi.lto_priv.0.37928630.b9f437417adc9a80\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/cc3CZrbQ.mk:347: /tmp/ccmO0Wsr.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nI debugged a bit with @bruvzg, who could also reproduce this with mingw-gcc on macOS with GCC 14.2.0. He tried with `-freport-bug` as advised by the error but that seems to prevent the bug.\n\n@Repiteo noted that the second error is similar to the one in #92585 (note: `x86_32` there, while here it's on `x86_64`), which we just worked around at the time by updating the base Fedora version to get newer mingw/gcc/binutils.\n\nBut here we're using the latest version provided on Fedora 41. mingw-headers and mingw-gcc on Fedora 42 aren't newer, but mingw-binutils is at 2.43.1, might be worth testing against.\n\nSince the error popped up between 4.4.beta2 and 4.4.beta3, I bisected it and landed on #102179. There's evidently nothing egregious in that patch that should trigger a LTO crash. Through trial and error, I manage to find a workaround in #102506 by doing a minimal partial revert of #102179. Reintroducing some of that code, even in a path that will never be executed (but could be, as it's checked by an undocumented project setting), seems to prevent the crash.\n\nWe also noticed that the presence of LTO objects from a previous build can also be a cause for the issue. But with a `git clean -fxd` this issue is still reproducible when reverting #102179.\n\nObviously, the problem is deeper so we need to dig. That's where I page @hpvb as the resident expert in debugging GCC bugs :D\n\n### Steps to reproduce\n\nSet up latest mingw with GCC 14.2.\n```\ngit revert e12a424bc569ac5ae9ff2944a8df7fc11b157d71\ngit clean -fxd\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "hints_text": "CC @berarma \nI can't reproduce it on Linux. The MRP works well here.\n\nI'll try it on a machine with Windows 11. In the mean time if someone could get a crash backtrace it may speed things up.\n\nDoes it crash before displaying anything or when the video is already playing?\nCan't reproduce on macOS (using provided videoplayerbug project).\n\nGodot v4.4.beta4 - macOS Sequoia (15.3.1) - Multi-window, 2 monitors - Metal (Forward+) - integrated Apple M1 Pro (Apple7) - Apple M1 Pro (10 threads)\nCan replicate this on Windows 11, will provide a stacktrace soon\nI can't confirm it on a custom build on the same branch, so unsure what is different between the two versions here, so can't provide a stacktrace as it won't occur in a debug build\nWhat compiler and compiler version are you using? What compiler does the official beta use?\n> I can't confirm it on a custom build on the same branch, so unsure what is different between the two versions here, so can't provide a stacktrace as it won't occur in a debug build\n\nThanks for testing it.\n\n> What compiler and compiler version are you using? What compiler does the official beta use?\n\nLooking at the build scripts it seems to be built using ~~mingw-llvm~~ (read comment below from akien-mga).\nTesting a production build currently, using MSVC in both cases, so might be MinGW specific, if it doesn't happen on a production MSVC build someone would need to build using MinGW to test (I don't have an editor build for that set up so it'd be easier if someone using it already can test to avoid the build time)\n> > What compiler and compiler version are you using? What compiler does the official beta use?\n> \n> Looking at the build scripts it seems to be built using mingw-llvm.\n\nIt's actually mingw-gcc 14.2.1 from Fedora 41 for x86_64 and x86_32, and [llvm-mingw](https://github.com/mstorsjo/llvm-mingw/) for arm64 only.\n\nAlso relevant, official builds are made with GCC LTO (`production=yes`), which may be a factor here.\nDoesn't happen in a `production=yes` MSVC build so likely gcc specific\nGCC and Windows specific.\n\nI've been able to reproduce the issue on a Windows 10 VM using the official build, tested that beta3 works on the same VM. Now I'm trying to build a custom version for Windows with D3D12 support but it doesn't run on the same VM because it requries OpenGL3.3 or D3D11. It looks like I haven't built with D3D12 support although I've followed the instructions.\nYou probably need to build with ANGLE to be able to run on that VM. https://docs.godotengine.org/en/stable/contributing/development/compiling/compiling_for_windows.html#compiling-with-angle-support\nI've made a custom build with the command `scons platform=windows debug_symbols=yes optimize=debug d3d12=yes angle_libs=/opt/angle/ linker=mold`, and it works.\n\nNow I'm building with `production=yes`.\nThis is the backtrace and this is the build command: `scons platform=windows d3d12=yes angle_libs=/opt/angle/ linker=mold use_static_cpp=yes lto=auto debug_symbols=yes`\n```\nCrashHandlerException: Program crashed with signal 11\nEngine version: Godot Engine v4.4.beta.custom_build (93d270693079ea7802c9e1334a2e0ecd8529eeed)                          Dumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] _gnu_exception_handler (./mingw-w64-crt/crt/crt_handler.c:223)\n[2] __tmainCRTStartup (./mingw-w64-crt/crt/crtexe.c:321)\n[3] WinMainCRTStartup (./mingw-w64-crt/crt/crtexe.c:176)\n-- END OF BACKTRACE --\n```\n\nIs this an [exception handler crash](https://github.com/godotengine/godot/pull/102900)?\nNot sure why the crash handler backtrace is like this, it's probably a separate issue we need to keep looking into @bruvzg.\n\nI ran the reproduction project through gdb and got a more helpful backtrace:\n```\nThread 1 received signal SIGSEGV, Segmentation fault.\n0x00000001404242e6 in oc_huff_token_decode_c ()\n(gdb) bt\n#0  0x00000001404242e6 in oc_huff_token_decode_c ()\n#1  0x000000014049b09e in VideoStreamPlaybackTheora::update(double) [clone .part.0] ()\n#2  0x0000000142cfd9f2 in VideoStreamPlayer::play() ()\n#3  0x00000001449648c1 in Object::notification(int, bool) ()\n#4  0x0000000142802d1f in Node::_propagate_enter_tree() ()\n#5  0x0000000142803015 in Node::_propagate_enter_tree() ()\n#6  0x000000014282a0c1 in Node::_set_tree(SceneTree*) ()\n#7  0x000000014006f748 in widechar_main(int, wchar_t**) ()\n#8  0x0000000145353ba3 in main ()\n```\n\nHere's how I did it for the record, which might be helpful for @berarma to debug further from Linux:\n\n- Compiled Godot in a `fedora:41` podman container with mingw-gcc and just `scons p=windows lto=full debug_symbols=yes`\n- Installed `wine`, and `mingw64-gdb`, which provides a Windows version of gdb in `/usr/x86_64-w64-mingw32/sys-root/mingw/bin/gdb.exe`\n- `cd` to the MRP folder\n- `wine /usr/x86_64-w64-mingw32/sys-root/mingw/bin/gdb.exe path/to/godot.windows.editor.x86_64.exe`\n- In the gdb prompt, `r --headless video_player.tscn`\n\nI discussed this with @hpvb who had a hunch that it might be related to another GCC LTO bug we're currently debugging in #102867. The flags suggested in https://github.com/godotengine/godot/issues/102867#issuecomment-2663930093 seem to solve this crash indeed in my test.\n@akien-mga, I got the same backtrace as you. The process was a bit different since I'm on Debian, but I just had to translate your steps.\n\nThere seems to be a gap in the backtrace, I'm not directly calling `oc_huff_token_decode_c` in the code but they're next to each other in the backtrace. Also, I can't see line numbers or the source code, gdb complains that there is no symbol table. Without this information it's hard to know what's happening.\n\nIn my tests, setting LTO and default optimization triggered the crash, but it wasn't always the case. Since I couldn't get a good backtrace I put several `printf` in the code to try to narrow down the code causing the crash and then it stopped crashing. The only change was the `printf` lines.\n\nIf I could get the debug symbols to work I could investigate more, without this, I'm out of ideas to try. I'll test a build with the flags suggested in #102867 to confirm your results and follow your work there.\nConfirmed it doesn't crash with the flags in https://github.com/godotengine/godot/issues/102867#issuecomment-2663930093. Tested also adding `d3d12=yes angle=...` both on Wine and Windows and it also works.\n\nI've resorted to reading the assembly to find out the line, and this is the line that causes the segmentation fault:\n\nhttps://github.com/godotengine/godot/blob/e567f49cbb292dd6bb628348e67c1f3c2a3a5f99/thirdparty/libtheora/huffdec.c#L482\n\nThe second argument (_tree) to the function `oc_huff_token_decode_c` is a bad pointer. This function is called with static int16 arrays defined inside static functions for the second argument, like this:\n\nhttps://github.com/godotengine/godot/blob/e567f49cbb292dd6bb628348e67c1f3c2a3a5f99/thirdparty/libtheora/decode.c#L319\n\nAnd this is where the array is defined:\n\nhttps://github.com/godotengine/godot/blob/e567f49cbb292dd6bb628348e67c1f3c2a3a5f99/thirdparty/libtheora/decode.c#L309\n\nThere are several calls to this function in this file, but since I don't have a complete backtrace I can't tell which one is causing the crash. Most of them use these static arrays, while some others use arrays read from the video headers.\n\nI've tried building with `ccflags=\"-fno-inline\"` to try and get a complete backtrace, but it fails with these errors:\n\n```\nlto1: error: two or more sections for .gnu.lto__ZZL40_register_variant_builtin_methods_stringvEN28Method_StringName_hex_to_int18get_argument_countEv.34588887.ba4a6b712d465bb9\nlto1: error: two or more sections for .gnu.lto__ZZN6embree12parallel_forIyZNS_17ParallelRadixSortINS_4sse212PresplitItemEjE17tbbRadixIterationEjbPKS3_PS3_yEUlyE0_EEvT_RKT0_ENKUlRKNS_5rangeIyEEE_clESG_.9227336.fefa44b2c0907de9\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/ccphOoha.mk:305: /tmp/cc6f9UAr.ltrans101.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/ccphOoha.mk:383: /tmp/cc6f9UAr.ltrans127.ltrans.o] Error 1\n./core/templates/sort_array.h: In function 'unguarded_insertion_sort.constprop.isra':\n./core/templates/sort_array.h:288:59: warning: iteration 1537228672809129301 invokes undefined behavior [-Waggressive-loop-optimizations]\n  288 |                         unguarded_linear_insert(i, p_array[i], p_array);\n      |                                                           ^\n./core/templates/sort_array.h:287:45: note: within this loop\n  287 |                 for (int64_t i = p_first; i != p_last; i++) {\n      |                                             ^\nthirdparty/misc/polypartition.cpp: In function 'Triangulate_OPT.isra':\nthirdparty/misc/polypartition.cpp:711:29: warning: argument 1 value '18446744073709551615' exceeds maximum object size 9223372036854775807 [-Walloc-size-larger-than=]\n  711 |   dpstates = new DPState *[n];\n      |                             ^\n/usr/lib/gcc/x86_64-w64-mingw32/12-posix/include/c++/new:128:26: note: in a call to allocation function 'operator new []' declared here\n  128 | _GLIBCXX_NODISCARD void* operator new[](std::size_t) _GLIBCXX_THROW (std::bad_alloc)\n      |                          ^\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/bin/x86_64-w64-mingw32-ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\nscons: *** [bin/godot.windows.editor.x86_64.exe] Error 1\nscons: building terminated because of errors.\n```\nAmended first paragraph in my last comment which didn't make any sense. Had a mental lapse between long builds.\nCould someone who reproduces the issue test these builds from #103077 to confirm that it's fixing the bug?\n\nhttps://github.com/godotengine/godot/pull/103077#issuecomment-2672226330\n> Could someone who reproduces the issue test these builds from [#103077](https://github.com/godotengine/godot/pull/103077) to confirm that it's fixing the bug?\n> \n> [#103077 (comment)](https://github.com/godotengine/godot/pull/103077#issuecomment-2672226330)\n\nI tested the 64-bit version, and it fixes the crash for me.\n\nHowever, the new build has some odd lag spikes in the video that weren't present in beta3. I'm unsure if this is related to the new build flags. I'll try to make a custom build of beta3 with these flags to confirm if they are the cause.\n> > Could someone who reproduces the issue test these builds from [#103077](https://github.com/godotengine/godot/pull/103077) to confirm that it's fixing the bug?\n> > [#103077 (comment)](https://github.com/godotengine/godot/pull/103077#issuecomment-2672226330)\n> \n> I tested the 64-bit version, and it fixes the crash for me.\n> \n> However, the new build has some odd lag spikes in the video that weren't present in beta3. I'm unsure if this is related to the new build flags. I'll try to make a custom build of beta3 with these flags to confirm if they are the cause.\n\nDoes this happen with the MRP? Do they play correctly in `ffplay`?\n\nVideos encoded with FFmpeg could be incorrectly encoded, although they should play the same in `ffplay` and Godot 4.4beta4.\n\nFFmpeg has already been fixed, but you will need a [very recent build](https://github.com/godotengine/godot-docs/pull/10614#issuecomment-2671246526).\n> Does this happen with the MRP? Do they play correctly in `ffplay`?\n> \n> Videos encoded with FFmpeg could be incorrectly encoded, although they should play the same in `ffplay` and Godot 4.4beta4.\n> \n> FFmpeg has already been fixed, but you will need a [very recent build](https://github.com/godotengine/godot-docs/pull/10614#issuecomment-2671246526).\n\nYes, specifically for the MRP above, on my Windows 11 machine (with RTX3070): beta3 produces smooth video output; rc.1 produces lag spikes. This behavior is repeatable.\n\nThe video in the MRP was encoded with `ffmpeg version 7.0.1-full_build-www.gyan.dev`. I'm not sure what you mean regarding ffmpeg being fixed -- was there a bug in their library for Ogg Theora encoding?\n> The video in the MRP was encoded with `ffmpeg version 7.0.1-full_build-www.gyan.dev`. I'm not sure what you mean regarding ffmpeg being fixed -- was there a bug in their library for Ogg Theora encoding?\n\nYes, there were a couple of bugs in FFmpeg that have been recently fixed in their static daily builds.\n\nPlease, re-encode the videos from the source with the newest version to make sure it is not due to those bugs.\nRe-encoded with version `2025-02-20-git-bc1a3bfd2c` of ffmpeg. New MRP: [videoplayerbug.zip](https://github.com/user-attachments/files/18894572/videoplayerbug.zip)\n\nSame issue. beta3 has smooth video playback while rc.1 has lag spikes. I set up beta3 with #103077 to see if the flags are the issue, but it's still compiling.\n\nUpdate: Not reproducible in both beta3 and beta3 with #103077 .\nI can't reproduce on Linux. There are some frame skips on both beta3 and beta4, but that's to be expected on my computer when playing a 1920x1080/144fps video on a decoder without GPU acceleration.\n\nCan you paste the FPS log for both versions?\nBoth versions show 144fps consistently for me. I tried setting max fps to 30 and it actually makes the issue worse (the entire video appears to slow down).\n\nHere's a recording of the playback on RC.1 for me: \n\nhttps://github.com/user-attachments/assets/0177706a-6d54-49ba-9f0b-0896176038d5\nCan you create a new issue with the new MRP and this information? I'm going to investigate it. Thanks!\nThe issue of videos playing with lag spikes has been submitted as #103106.\n> But here we're using the latest version provided on Fedora 41. mingw-headers and mingw-gcc on Fedora 42 aren't newer, but mingw-binutils is at 2.43.1, might be worth testing against.\n\nSo I actually tested reproducing the issue in a `fedora:42` podman container, and it seems fixed there. So it might have been a bug in binutils 2.42 that was fixed in 2.43.1 already.\n\nIf that's the case, we could just update to Fedora 42 already for official builds, or backport binutils 2.43.1.\nIt wouldn't solve the problem for end users whose latest MinGW distribution wouldn't have binutils 2.43.1 yet.\n> So it might have been a bug in binutils 2.42 that was fixed in 2.43.1 already.\n\nmacOS MinGW build I was able to reproduce it with seems to be using binutils 2.43.1.\n\nSources for the MinGW package are:\n```\nurl \"https://downloads.sourceforge.net/project/mingw-w64/mingw-w64/mingw-w64-release/mingw-w64-v12.0.0.tar.bz2\"\nsha256 \"cc41898aac4b6e8dd5cffd7331b9d9515b912df4420a3a612b5ea2955bbeed2f\"\n\nurl \"https://ftp.gnu.org/gnu/binutils/binutils-2.43.1.tar.bz2\"\nsha256 \"becaac5d295e037587b63a42fad57fe3d9d7b83f478eb24b67f9eec5d0f1872f\"\n\nurl \"https://ftp.gnu.org/gnu/gcc/gcc-14.2.0/gcc-14.2.0.tar.xz\"\nsha256 \"a7b39bc69cbf9e25826c5a60ab26477001f7c08d85cec04bc0e29cabed6f3cc9\"\n```\n> macOS MinGW build I was able to reproduce it with seems to be using binutils 2.43.1.\n\nYeah I tested too in a `fedora:41` podman container, installing the mingw-binutils packages from Fedora 42 (`mingw-binutils-generic-2.43.1-3.fc42.x86_64.rpm` and `mingw64-binutils-2.43.1-3.fc42.x86_64.rpm`) and I still reproduce the bug.\n\nSo there might be another component in Fedora 42 that's different, or it's just a coincidence.\nI've been able to reproduce this, I'm doing some work with gdb on the wrapper to see if I can work out what's going on.\nI have not been able to figure out what the problem is exactly, but I have been able to build Godot successfully with LTO with the following ccflags and linkflags: `-fno-use-linker-plugin -fwhole-program` this should result in at least similar optimization as with the normal lto. \n\nAt least for now I recommend using this while I try and figure out with the gcc folk what is up.\nRetested it with current `master` + reverted e12a424bc569ac5ae9ff2944a8df7fc11b157d71 and seems like it's no longer failing on macOS (toolchain is the same), so it's pretty random (probably timing sensitive race condition).\n@bruvzg it is not likely timing sensitive. The problem reproduces with or without using multiple threads.\n\nThe problem is almost certainly in the \"Whole Program Analysis\" (WPA) phase of LTO. This is the phase that will partition the LTO work into smaller objects to be processed in series or in parallel. This phase seems to partition the work wrong, which then results in the 115th partition to not be linkable.\n\nThe issue is that almost *any* change to the build will cause the problem to go away. For instance just turning LTO off for literally *any* of the .a or .o files, just one, causes the link to succeed.\n\nBecause of this the problem is turning out to be very hard to debug. But I'm afraid that it is not a race condition. ", "created_at": "2025-02-22 16:15:10", "merge_commit_sha": "58e4e34564b5f4cb37325212a50250eef2d35e31", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103105", "base_commit": "8ed125b42908d0d46d3b8967e3a3bc03f809b3af", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 0da2dceb5f4d..b4897bcd48f9 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -95,9 +95,11 @@ void EmbeddedProcess::set_keep_aspect(bool p_keep_aspect) {\n \t}\n }\n \n-Rect2i EmbeddedProcess::_get_global_embedded_window_rect() {\n-\tRect2i control_rect = get_global_rect();\n-\tcontrol_rect = Rect2i(control_rect.position + margin_top_left, (control_rect.size - get_margins_size()).maxi(1));\n+Rect2i EmbeddedProcess::get_adjusted_embedded_window_rect(Rect2i p_rect) {\n+\tRect2i control_rect = Rect2i(p_rect.position + margin_top_left, (p_rect.size - get_margins_size()).maxi(1));\n+\tif (window) {\n+\t\tcontrol_rect.position += window->get_position();\n+\t}\n \tif (window_size != Size2i()) {\n \t\tRect2i desired_rect = Rect2i();\n \t\tif (!keep_aspect && control_rect.size.x >= window_size.x && control_rect.size.y >= window_size.y) {\n@@ -116,12 +118,7 @@ Rect2i EmbeddedProcess::_get_global_embedded_window_rect() {\n }\n \n Rect2i EmbeddedProcess::get_screen_embedded_window_rect() {\n-\tRect2i rect = _get_global_embedded_window_rect();\n-\tif (window) {\n-\t\trect.position += window->get_position();\n-\t}\n-\n-\treturn rect;\n+\treturn get_adjusted_embedded_window_rect(get_global_rect());\n }\n \n int EmbeddedProcess::get_margin_size(Side p_side) const {\ndiff --git a/editor/plugins/embedded_process.h b/editor/plugins/embedded_process.h\nindex 55988be3f0b4..298424b0c553 100644\n--- a/editor/plugins/embedded_process.h\n+++ b/editor/plugins/embedded_process.h\n@@ -83,6 +83,7 @@ class EmbeddedProcess : public Control {\n \tvoid set_keep_aspect(bool p_keep_aspect);\n \tvoid queue_update_embedded_process();\n \n+\tRect2i get_adjusted_embedded_window_rect(Rect2i p_rect);\n \tRect2i get_screen_embedded_window_rect();\n \tint get_margin_size(Side p_side) const;\n \tSize2 get_margins_size();\ndiff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 6318bf6d1645..30c558e0bd5d 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -812,10 +812,28 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \t_update_embed_window_size();\n \tRect2i rect = embedded_process->get_screen_embedded_window_rect();\n \n+\t// On the first startup, the global rect of the embedded process control is invalid because it was\n+\t// never displayed. We will calculated it manually.\n+\tif (!window_wrapper->get_window_enabled() && rect.size.y < embedded_process->get_custom_minimum_size().y) {\n+\t\tSize2 old_min_size = embedded_process->get_custom_minimum_size();\n+\t\tembedded_process->set_custom_minimum_size(Size2i());\n+\n+\t\tControl *container = EditorNode::get_singleton()->get_editor_main_screen()->get_control();\n+\t\trect = container->get_global_rect();\n+\n+\t\tSize2 wrapped_min_size = window_wrapper->get_minimum_size();\n+\t\trect.position.y += wrapped_min_size.y;\n+\t\trect.size.y -= wrapped_min_size.y;\n+\n+\t\trect = embedded_process->get_adjusted_embedded_window_rect(rect);\n+\n+\t\tembedded_process->set_custom_minimum_size(old_min_size);\n+\t}\n+\n \t// When using the floating window, we need to force the position and size from the\n \t// editor/project settings, because the get_screen_embedded_window_rect of the\n \t// embedded_process will be updated only on the next frame.\n-\tif (p_idx == 0 && window_wrapper->get_window_enabled()) {\n+\tif (window_wrapper->get_window_enabled()) {\n \t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n \t\tif (placement.position != Point2i(INT_MAX, INT_MAX)) {\n \t\t\trect.position = placement.position;\n", "test_patch": "", "problem_statement": "Embedded Game window wrong first startup location and size\n### Tested versions\n\nReproductible since Godot 4.4 beta 4\nNot reprodictible in Godot 4.4 beta 3\n\n### System information\n\nGodot v4.4.rc (8ed125b42) - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 32.0.15.7216) - 11th Gen Intel(R) Core(TM) i5-11600KF @ 3.90GHz (12 threads)\n\n### Issue description\n\nWhen the game is started and the game is embedded inside the editor without the floating window and if the Game View tab was not accessed, the location and the size of the embedded game is wrong at the first startup of the game.\n\nhttps://github.com/user-attachments/assets/f3623b5f-65c0-42ab-8422-b19c5e4dc2cc\n\n### Steps to reproduce\n\n- Open the editor, set embedding at true and floating window at false\n- Go to another tab then Game View\n- Close the editor\n- Reopen a project in the editor\n- Start the game without going to the Game View\n- You will see the game for a split second really small and not correctly positionned on startup\n\n### Minimal reproduction project (MRP)\n\nAny project\n", "hints_text": "", "created_at": "2025-02-21 01:31:26", "merge_commit_sha": "ba47acab0a74de766b5a63cfb49547e4d75d4de5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102986", "base_commit": "49cc57a75dfd262bd49698910595becf3aae597b", "patch": "diff --git a/doc/classes/SceneTree.xml b/doc/classes/SceneTree.xml\nindex 77baef9d0898..9a31492d2018 100644\n--- a/doc/classes/SceneTree.xml\n+++ b/doc/classes/SceneTree.xml\n@@ -58,6 +58,7 @@\n \t\t\t\t1. The current scene node is immediately removed from the tree. From that point, [method Node.get_tree] called on the current (outgoing) scene will return [code]null[/code]. [member current_scene] will be [code]null[/code], too, because the new scene is not available yet.\n \t\t\t\t2. At the end of the frame, the formerly current scene, already removed from the tree, will be deleted (freed from memory) and then the new scene will be instantiated and added to the tree. [method Node.get_tree] and [member current_scene] will be back to working as usual.\n \t\t\t\tThis ensures that both scenes aren't running at the same time, while still freeing the previous scene in a safe way similar to [method Node.queue_free].\n+\t\t\t\tIf you want to reliably access the new scene, await the [signal scene_changed] signal.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"create_timer\">\n@@ -312,6 +313,17 @@\n \t\t\t\tEmitted immediately before [method Node._process] is called on every node in this tree.\n \t\t\t</description>\n \t\t</signal>\n+\t\t<signal name=\"scene_changed\">\n+\t\t\t<description>\n+\t\t\t\tEmitted after the new scene is added to scene tree and initialized. Can be used to reliably access [member current_scene] when changing scenes.\n+\t\t\t\t[codeblock]\n+\t\t\t\t# This code should be inside an autoload.\n+\t\t\t\tget_tree().change_scene_to_file(other_scene_path)\n+\t\t\t\tawait get_tree().scene_changed\n+\t\t\t\tprint(get_tree().current_scene) # Prints the new scene.\n+\t\t\t\t[/codeblock]\n+\t\t\t</description>\n+\t\t</signal>\n \t\t<signal name=\"tree_changed\">\n \t\t\t<description>\n \t\t\t\tEmitted any time the tree's hierarchy changes (nodes being moved, renamed, etc.).\ndiff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 4043eb55ac96..557fced85ed1 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -1517,6 +1517,8 @@ void SceneTree::_flush_scene_change() {\n \tpending_new_scene = nullptr;\n \t// Update display for cursor instantly.\n \troot->update_mouse_cursor_state();\n+\n+\temit_signal(SNAME(\"scene_changed\"));\n }\n \n Error SceneTree::change_scene_to_file(const String &p_path) {\n@@ -1784,6 +1786,7 @@ void SceneTree::_bind_methods() {\n \tADD_PROPERTY(PropertyInfo(Variant::BOOL, \"physics_interpolation\"), \"set_physics_interpolation_enabled\", \"is_physics_interpolation_enabled\");\n \n \tADD_SIGNAL(MethodInfo(\"tree_changed\"));\n+\tADD_SIGNAL(MethodInfo(\"scene_changed\"));\n \tADD_SIGNAL(MethodInfo(\"tree_process_mode_changed\")); //editor only signal, but due to API hash it can't be removed in run-time\n \tADD_SIGNAL(MethodInfo(\"node_added\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n \tADD_SIGNAL(MethodInfo(\"node_removed\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n", "test_patch": "", "problem_statement": "`change_scene_to_*` needs to await for two `process_frame`s\n### Tested versions\r\n\r\nGodot 4.2+\r\n\r\n### System information\r\n\r\nArch Linux\r\n\r\n### Issue description\r\n\r\n`change_scene_to_*()` methods always change scene in a deferred way.\r\n\r\nThe documentation says scene change happens at the end of the frame. But I have to await `SceneTree.process_frame` twice instead of once since #78988.\r\n\r\nhttps://github.com/godotengine/godot/blob/2d0ee20ff30461b6b10f6fdfba87511a0ebc6642/doc/classes/SceneTree.xml#L55-L56\r\n\r\n```gdscript\r\nvar tree := get_tree()\r\n\r\ntree.change_scene_to_file(path)\r\n\r\nawait tree.process_frame\r\n# expected & old behavior: new scene available here\r\n# actual: still not available\r\n\r\nawait tree.process_frame\r\n# actual: new scene available here\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nSee above, or use the MRP.\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[test-change-scene.zip](https://github.com/godotengine/godot/files/13700325/test-change-scene.zip)\r\n\n", "hints_text": "Okay, I thought it's because I put the code snippet inside `_unhandled_input()` and `process_frame` signals the start of `process()`.\r\n\r\nBut doesn't `_unhandled_input()` happen at the end of last frame by default?\n`_unhandled_input()` happens without delay right after `_input()` and the other `_*_input()` calls.\r\nThe execution of physics picking happens asynchronously in the next frame.\r\n\n@Sauermann Where does it happen inside a frame relative to `_process()`?\r\n\r\n* Before `_process()`: Then that explains it. But what signal should I await for (besides awaiting for `process_frame` twice) in order to access the new scene?\r\n* After `_process()`: Then it's a bug.\nThat I don't know. I haven't yet looked into the order of things happening within a single frame.\n```GDScript\r\nfunc change_scene(path: String) -> void:\r\n\tprint(\"------ changing to %s ------\" % path)\r\n\tvar tree := get_tree()\r\n\t\r\n\tprint(\"[Before] %s\" % tree.current_scene, \" - frame: \", Engine.get_process_frames())\r\n\ttree.change_scene_to_file(path)\r\n\t\r\n\tawait tree.process_frame\r\n\tprint(\"[after tree.process_frame] %s\" % tree.current_scene, \" - frame: \", Engine.get_process_frames())\r\n\t\r\n\tawait tree.process_frame\r\n\tprint(\"[after tree.process_frame] %s\" % tree.current_scene, \" - frame: \", Engine.get_process_frames())\r\n```\r\n\r\nOutput:\r\n```\r\n[Before] OldScene:<Node2D#27095205063> - frame: 65\r\n[after tree.process_frame] <Object#null> - frame: 65\r\n[after tree.process_frame] NewScene:<Node2D#29645341898> - frame: 66\r\n```\r\n\r\nThe first await isn't really waiting, when the call comes from `_unhandled_input` or `_input`.\r\nHowever, if you instead use `_process`:\r\n```\r\nfunc _process(delta: float) -> void:\r\n\tif Input.is_action_just_pressed(\"ui_accept\"):\r\n\t\tAutoload.change_scene(\"res://old_scene.tscn\")\r\n```\r\nThe output will now be:\r\n```\r\n[Before] OldScene:<Node2D#27095205063> - frame: 101\r\n[after tree.process_frame 1] NewScene:<Node2D#31088182474> - frame: 102\r\n[after tree.process_frame 2] NewScene:<Node2D#31088182474> - frame: 103\r\n```\r\nIf nothing else, this works as a work-around for the MRP.\nThis seems like an important caveat with `await tree.process_frame` that we should document.\n> Where does it happen inside a frame relative to `_process()`?\r\n> \r\n> * Before `_process()`: Then that explains it. But what signal should I await for (besides awaiting for `process_frame` twice) in order to access the new scene?\r\n> \r\n> * After `_process()`: Then it's a bug.\r\n\r\nIt's kinda irrelevant whether it happens before/after `_process()`. If `change_scene_to_*` is called anywhere outside [`process()`](https://github.com/godotengine/godot/blob/2d0ee20ff30461b6b10f6fdfba87511a0ebc6642/scene/main/scene_tree.cpp#L486-L558) (within the red interval in the diagram below) then it's guaranteed that after awaiting `process_frame` signal the scene change has not happened yet because flushing scene change is done within `process()` after emitting `process_frame` signal.\r\n\r\nThe same can be told about the black interval in the diagram below.\r\n\r\nFor awaiting single `process_frame` to be enough the `change_scene_to_*` would need to be called somewhere within the pink interval (so e.g. in `_process()`, like in https://github.com/godotengine/godot/issues/86286#issuecomment-1860662955).\r\n\r\n![dCDWa8XAe4](https://github.com/godotengine/godot/assets/9283098/d79a82ca-1c68-45f6-a8e6-2c15bc5d60e7)\r\n\r\n\r\n> [!NOTE]\r\n> I kinda ignored threading when analyzing this so it might be not that simple. :upside_down_face:\r\n\r\n---\r\n\r\nAnyway here's I think a somehow reliable way to detect/await the scene change:\r\n```gdscript\r\nextends Node\r\n\r\nsignal _scene_changed\r\n\r\n@onready var _tree: SceneTree = get_tree()\r\n\r\nfunc change_scene(path: String) -> Error:\r\n\tvar error: Error = _tree.change_scene_to_file(path)\r\n\tif error == OK:\r\n\t\tif not _tree.node_added.is_connected(_on_node_added):\r\n\t\t\t_tree.node_added.connect(_on_node_added)\r\n\t\tawait _scene_changed\r\n\t\t# Scene changed (and ready).\r\n\treturn error\r\n\r\nfunc _on_node_added(node: Node) -> void:\r\n\tif node == _tree.current_scene:\r\n\t\t_tree.node_added.disconnect(_on_node_added)\r\n\t\t# Here `_tree.current_scene` is already changed.\r\n\t\t# But note we are in the middle of executing `tree.root.add_child(current_scene)`.\r\n\t\t# So likely deferring it a little further is wanted, e.g. until its `ready` signal.\r\n\t\tawait _tree.current_scene.ready\r\n\t\t_scene_changed.emit()\r\n```\r\nGiven it's autoloaded as `SceneChanger` it could be used like `var error = await SceneChanger.change_scene(path)`.\r\n\r\nIt works because `current_scene` is assigned before `add_child()`:\r\nhttps://github.com/godotengine/godot/blob/bf8dd73e9d88d6ab146506699f43230b12c6a2b0/scene/main/scene_tree.cpp#L1396-L1406\nThanks for the workaround. I think `await tree.tree_changed` also works if the user can guarentee autoloads don't touch the scene tree during the scene change.\nI wish there was a signal `scene_changed` built into SceneTree. There's no signal that I know which happens at the end of the frame, after the physics and process calls. That's when the scene change happens.\r\n\r\nIs there some proposal for this to happen?\r\n\r\nFor reference, here's a [processing diagram](/godotengine/godot-docs/issues/9305) that I did for Godot 4. Here we can see how the input is handled at the very start of the frame and the scene is changed after the SceneTree.process_frame signal. Exactly as @kleonc explained.\r\n\r\nAnother possible workaround could be a timer in idle processing mode. It would trigger just after the scene change. So `await get_tree().create_timer(0).timeout`.", "created_at": "2025-02-18 09:48:51", "merge_commit_sha": "6ffe44d322ae50d1a061d93a3494e43d1803c0bb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102833", "base_commit": "750640cede4741a6a526fa5172a199bbb1ac0758", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 638262fb8bec..efc5719d2def 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -446,6 +446,10 @@ GameView::EmbedAvailability GameView::_get_embed_available() {\n \tif (get_tree()->get_root()->is_embedding_subwindows()) {\n \t\treturn EMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE;\n \t}\n+\tString display_driver = GLOBAL_GET(\"display/display_server/driver\");\n+\tif (display_driver == \"headless\" || display_driver == \"wayland\") {\n+\t\treturn EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER;\n+\t}\n \n \tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n \tif (placement.force_fullscreen) {\n@@ -489,7 +493,14 @@ void GameView::_update_ui() {\n \t\t\t}\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_FEATURE_NOT_SUPPORTED:\n-\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\tif (DisplayServer::get_singleton()->get_name() == \"Wayland\") {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on Wayland.\\nWayland can be disabled in the Editor Settings (Run > Platforms > Linux/*BSD > Prefer Wayland).\"));\n+\t\t\t} else {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER:\n+\t\t\tstate_label->set_text(vformat(TTR(\"Game embedding not available for the Display Server: '%s'.\\nDisplay Server can be modified in the Project Settings (Display > Display Server > Driver).\"), GLOBAL_GET(\"display/display_server/driver\")));\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_MINIMIZED:\n \t\t\tstate_label->set_text(TTR(\"Game embedding not available when the game starts minimized.\\nConsider overriding the window mode project setting with the editor feature tag to Windowed to use game embedding while leaving the exported project intact.\"));\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6be2d961ba08..6e08c269b063 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -108,6 +108,7 @@ class GameView : public VBoxContainer {\n \t\tEMBED_NOT_AVAILABLE_MAXIMIZED,\n \t\tEMBED_NOT_AVAILABLE_FULLSCREEN,\n \t\tEMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE,\n+\t\tEMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER,\n \t};\n \n \tinline static GameView *singleton = nullptr;\n", "test_patch": "", "problem_statement": "\"Game Embedding not available on your OS\" EndeavorOS Hyprland\n### Tested versions\n\nReproducible in: 4.4.beta3\n\n### System information\n\nGodot v4.4.beta3 - EndeavourOS #1 SMP PREEMPT_DYNAMIC Sun, 02 Feb 2025 01:02:29 +0000 on Wayland - Wayland display driver, Single-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) HD Graphics 500 (APL 2) - Intel(R) Celeron(R) CPU N3350 @ 1.10GHz (2 threads)\n\n### Issue description\n\nWas going to test for the first time the game embedding from 4.4 and was surprised to seed it did not work, the devlogs said it was available for linux so that got me wondering if it was a Hyprland issue, but I could not find anything online, or on the issues, easily available.\n\n### Steps to reproduce\n\n- Create any new project\n- Run any scene\n- Open game tab\n\n### Minimal reproduction project (MRP)\n\nAny godot project\n", "hints_text": "The message is effectively not very clear in your situation. Right now, the Game Embedding is not available when Godot Editor is using the Wayland display driver. It only support x11. It works on Linux Wayland if using X11 display driver.\n\nIt's documented in the original PR: https://github.com/godotengine/godot/pull/99010\n\nI'll check if the message could be adjusted for Linux.", "created_at": "2025-02-14 00:27:32", "merge_commit_sha": "b2aae7b72962ad1514d14d09b41b45ae837170ab", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102813", "base_commit": "1a0bf546772edc19837e96b5ac07a47a9f8a8b34", "patch": "diff --git a/editor/gui/scene_tree_editor.cpp b/editor/gui/scene_tree_editor.cpp\nindex ab834929cd58..5aedd940e482 100644\n--- a/editor/gui/scene_tree_editor.cpp\n+++ b/editor/gui/scene_tree_editor.cpp\n@@ -924,12 +924,19 @@ void SceneTreeEditor::_update_tree(bool p_scroll_to_selected) {\n \t\t// If pinned state changed, update the currently pinned node.\n \t\tif (AnimationPlayerEditor::get_singleton()->is_pinned() != node_cache.current_has_pin) {\n \t\t\tnode_cache.current_has_pin = AnimationPlayerEditor::get_singleton()->is_pinned();\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n \t\t}\n \t\t// If the current pinned node changed update both the old and new node.\n \t\tif (node_cache.current_pinned_node != pinned_node) {\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n-\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t// get_editing_node() will return deleted nodes. If the nodes are not in cache don't try to mark them.\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n+\t\t\tif (node_cache.has(node_cache.current_pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t}\n \t\t\tnode_cache.current_pinned_node = pinned_node;\n \t\t}\n \n@@ -2373,6 +2380,10 @@ HashMap<Node *, SceneTreeEditor::CachedNode>::Iterator SceneTreeEditor::NodeCach\n \treturn I;\n }\n \n+bool SceneTreeEditor::NodeCache::has(Node *p_node) {\n+\treturn get(p_node, false).operator bool();\n+}\n+\n void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \tif (!p_node) {\n \t\treturn;\n@@ -2382,6 +2393,11 @@ void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \t\teditor->selected = nullptr;\n \t}\n \n+\tif (p_node == current_pinned_node) {\n+\t\tcurrent_pinned_node = nullptr;\n+\t\tcurrent_has_pin = false;\n+\t}\n+\n \teditor->marked.erase(p_node);\n \n \tHashMap<Node *, CachedNode>::Iterator I = cache.find(p_node);\n@@ -2419,6 +2435,7 @@ void SceneTreeEditor::NodeCache::mark_dirty(Node *p_node, bool p_parents) {\n \t\tif (!p_parents) {\n \t\t\tbreak;\n \t\t}\n+\n \t\tnode = node->get_parent();\n \t}\n }\n@@ -2483,4 +2500,6 @@ void SceneTreeEditor::NodeCache::clear() {\n \t}\n \tcache.clear();\n \tto_delete.clear();\n+\tcurrent_pinned_node = nullptr;\n+\tcurrent_has_pin = false;\n }\ndiff --git a/editor/gui/scene_tree_editor.h b/editor/gui/scene_tree_editor.h\nindex e789e9692419..d29c4df0cdb2 100644\n--- a/editor/gui/scene_tree_editor.h\n+++ b/editor/gui/scene_tree_editor.h\n@@ -90,6 +90,7 @@ class SceneTreeEditor : public Control {\n \n \t\tHashMap<Node *, CachedNode>::Iterator add(Node *p_node, TreeItem *p_item);\n \t\tHashMap<Node *, CachedNode>::Iterator get(Node *p_node, bool p_deleted_ok = true);\n+\t\tbool has(Node *p_node);\n \t\tvoid remove(Node *p_node, bool p_recursive = false);\n \t\tvoid mark_dirty(Node *p_node, bool p_parents = true);\n \t\tvoid mark_children_dirty(Node *p_node, bool p_recursive = false);\n", "test_patch": "", "problem_statement": "Editor crash when interacting with a re-opened scene containing an animation player\n### Tested versions\n\nAt least 4.4.beta1 to current head `6dc78c8aa17ad46e701e0c4e7b7632c2f0e098f1` but involves code introduced in  https://github.com/godotengine/godot/pull/99700 or a related PR cc @hpvb \n\n~~As far as I've seen, the crash does not happen if the editor is compiled with `dev_build=yes`~~\n\n### System information\n\nGodot v4.4.beta.mono (6dc78c8aa) - macOS Sequoia (15.2.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 (Apple8) - Apple M2 (8 threads)\n\n### Issue description\n\nAfter closing and re-opening a scene containing an animation player and then either selecting a node or closing the scene tab several times, either SIGSEGV or SIGBUS crashes the editor. From lldb:\n```\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x3d9ec6003f8001a8)\n  * frame #0: 0x0000000102cb4df8 godot.macos.editor.arm64`Node::get_parent() const\n    frame #1: 0x0000000102468e1c godot.macos.editor.arm64`SceneTreeEditor::_update_tree(bool) + 500\n    frame #2: 0x0000000104bd0394 godot.macos.editor.arm64`CallQueue::_call_function(Callable const&, Variant const*, int, bool) + 336\n    frame #3: 0x0000000104bd06b0 godot.macos.editor.arm64`CallQueue::flush() + 352\n    frame #4: 0x0000000102ceb6d0 godot.macos.editor.arm64`SceneTree::physics_process(double) + 244\n    frame #5: 0x00000001003f366c godot.macos.editor.arm64`Main::iteration() + 596\n    frame #6: 0x0000000100383878 godot.macos.editor.arm64`OS_MacOS::run() + 148\n    frame #7: 0x00000001003b0ad4 godot.macos.editor.arm64`main + 388\n    frame #8: 0x0000000196350274 dyld`start + 2840\n```\nPresumably some call is getting inlined between _update_tree and get_parent?\n\n### Steps to reproduce\n\nClose and reopen the same scene several times in a row, optionally interacting with a node. In my tests, I saw a crash after anywhere between 1 and 4 close/reopen cycles with the last user action being any of opening the scene, closing the scene, or selecting a node in the tree.\n\n### Minimal reproduction project (MRP)\n\n[glb_test.zip](https://github.com/user-attachments/files/18680946/glb_test.zip)\n", "hints_text": "I tried to reproduce the issue on Linux with scenes from the 2D platformer demo in 4.4.beta2 but didn't get any crash.\n\nIt might be system specific, or scene specific. Is your scene particularly complex or using some specific node types which might be relevant?\n\nThe crash trace is a bit confusing, `SceneTreeEditor::_update_tree(bool) + 500` (if 500 is the line number) seems to be an empty line in `_update_node`, while `_update_tree` is much further down.\nThe 500 is in this case the function address offset. I agree the trace is weird though as it shows a get_parent call from _update_tree, which unless I missed something does not happen and I'm not sure what intermediary call might've been inlined to allow that. I don't remember exactly what conditions or versions I tested, and it might be system specific although I tested it in a pretty barebones scene before. I'll test again with beta2 on mac/linux/windows and see what comes up (also I'll change my lldb output format to maybe be clearer lol)\n\nEdit: I'm able to consistently reproduce this on macos in beta1 and beta2, both standard and mono, for scenes containing an AnimationPlayer, although re \"consistently\" I'm pretty sure it's a race condition somewhere as sometimes the crash happens on 1st interaction and sometimes it takes like a minute of spam open/closing the scene and clicking randomly on nodes. I'm going to try to repro on windows + linux and then see if I can get a better trace.\n\n[glb_test.zip](https://github.com/user-attachments/files/18680946/glb_test.zip)\n\nEdit 2: I was able to repro on Windows although it was waaaaay less likely than on the macbook. I was only able to get it to crash twice, both times with `STATUS_HEAP_CORRUPTION`. I only tested beta2 standard since on the macbook it didn't seem to matter.\n\nEdit 3: And I'm also able to repro on my older linux laptop also with beta2 pretty easily with SIGSEGV, although the info I get in console is completely useless.\nGood news(?) it does actually happen with debugging stuff enabled, I just was unlucky when previously testing it. Looks like maybe there's a race to update the pinned node and it can end up stale in certain cases:\n```\n[3] SceneTreeEditor::NodeCache::mark_dirty(Node*, bool) (in godot.macos.editor.dev.arm64.mono) (/Users/adam/code/godot/editor/gui/scene_tree_editor.cpp:2420)\n[4] SceneTreeEditor::_update_tree(bool) (in godot.macos.editor.dev.arm64.mono) (/Users/adam/code/godot/editor/gui/scene_tree_editor.cpp:932)\n```\nhttps://github.com/godotengine/godot/blob/master/editor/gui/scene_tree_editor.cpp#L932\n\nhttps://github.com/godotengine/godot/blob/master/editor/gui/scene_tree_editor.cpp#L2420\n\nIt sorta makes sense that I didn't run into this when testing the original pr before (besides the crash being sorta rare) since I was mostly using the test scene with thousands of empty base nodes and no AnimationPlayer. At worst, the mark dirty could check for instance validity rather than null but I'll try looking for a nicer solution.\nThank you for the great report and the digging!\n\nI want to have a look to see how a node actually gets in that state in the editor. It might need a different signal being handled. If a \"bad node\" can make it into that codepath then it would cause problems elsewhere as well, in code I didn't even touch.\n\nThis might have been a preexisting issue that was just even more rare before.\nMaybe there's a different triggering condition but the only thing I can think of is that the only time `current_pinned_node` is set is 1) if there's a current root node and 2) if the current pin is different from the previous pin, so the old pin always sticks around and if that node has already been freed the crash occurs. My first thought was just to reset all the fields in `node_cache.clear()`, so it would always be nulled when the edited scene changes, but that didn't work. I think since the old code updated the full tree each time it would be unlikely that this same crash could happen.\n\nEdit: ok I _did_ notice before while doing repro that I very rarely got a different offset and now it looks like `AnimationPlayerEditor::get_editing_node()` can actually give back an already freed node. So either it's freed by the time the the tree updates and it crashes or it's freed by the next time the tree updates and it crashes. Clearing the cache on the tree being reset only covers the second case.\nI understand what needs to happen, a PR is incoming! I'm on a trip this weekend so it might not be until Monday.\nWere you able to repro or were you going off of my description/stack trace? My impression was we needed to both clear the cache values when the tree was cleared and also update the AnimationPlayerEditor to clear its editing node when the scene was changed as well, but I wasn't sure of a good mechanism for the latter.\nSorry, it'll have to be tomorrow due to $reallife, I read through all of the code on the train and I figured out the cases you were referring to! I really do know how to fix it :)\n\nWe have signals to tell us when nodes get invalidated, but we never update the node pin cache. It should all work just fine if we make sure we update that cache also in response to the correct signals!\nNo worries, I was mostly asking because so far nobody else has mentioned being able to repro and it seems potentially multifaceted. I cleaned up the stashed changes I was messing around with last week here https://github.com/a-johnston/godot/commit/f230e9722b6c228d306308b69315c983825ac809 and while I think this addresses the issue I also don't know if it's just less likely (since it seems like a race) or if this goes too far and impacts some other functionality.\n\nEdit- maybe should mention I was testing opening/closing a tab, switching between two tabs with possible pins, and having multiple pinnable nodes within the same tab", "created_at": "2025-02-13 16:53:27", "merge_commit_sha": "25a3b38a838c7b9acb673c6de5ed684a7127ceae", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102774", "base_commit": "b607110ad211778a6426a00ca9c8cd99c0eb383c", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex b27665548f4b..79bf8975411b 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2204,6 +2204,10 @@\n \t\t\tThe CA certificates bundle to use for TLS connections. If this is set to a non-empty value, this will [i]override[/i] Godot's default [url=https://github.com/godotengine/godot/blob/master/thirdparty/certs/ca-certificates.crt]Mozilla certificate bundle[/url]. If left empty, the default certificate bundle will be used.\n \t\t\tIf in doubt, leave this setting empty.\n \t\t</member>\n+\t\t<member name=\"network/tls/enable_tls_v1.3\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n+\t\t\tIf [code]true[/code], enable TLSv1.3 negotiation.\n+\t\t\t[b]Note:[/b] This is experimental, and may cause connections to fail in some cases (notably, if the remote server uses TLS handshake fragmentation).\n+\t\t</member>\n \t\t<member name=\"physics/2d/default_angular_damp\" type=\"float\" setter=\"\" getter=\"\" default=\"1.0\">\n \t\t\tThe default rotational motion damping in 2D. Damping is used to gradually slow down physical objects over time. RigidBodies will fall back to this value when combining their own damping values and no area damping value is present.\n \t\t\tSuggested values are in the range [code]0[/code] to [code]30[/code]. At value [code]0[/code] objects will keep moving with the same velocity. Greater values will stop the object faster. A value equal to or greater than the physics tick rate ([member physics/common/physics_ticks_per_second]) will bring the object to a stop in one iteration.\ndiff --git a/modules/mbedtls/register_types.cpp b/modules/mbedtls/register_types.cpp\nindex bf65dfb0b76a..c0eca6ee18e0 100644\n--- a/modules/mbedtls/register_types.cpp\n+++ b/modules/mbedtls/register_types.cpp\n@@ -35,6 +35,8 @@\n #include \"packet_peer_mbed_dtls.h\"\n #include \"stream_peer_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n #include <psa/crypto.h>\n #endif\n@@ -50,6 +52,8 @@ void initialize_mbedtls_module(ModuleInitializationLevel p_level) {\n \t\treturn;\n \t}\n \n+\tGLOBAL_DEF(\"network/tls/enable_tls_v1.3\", false);\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n \tint status = psa_crypto_init();\n \tERR_FAIL_COND_MSG(status != PSA_SUCCESS, \"Failed to initialize psa crypto. The mbedTLS modules will not work.\");\ndiff --git a/modules/mbedtls/tls_context_mbedtls.cpp b/modules/mbedtls/tls_context_mbedtls.cpp\nindex f5c196596eb2..33c4cfd5450e 100644\n--- a/modules/mbedtls/tls_context_mbedtls.cpp\n+++ b/modules/mbedtls/tls_context_mbedtls.cpp\n@@ -30,6 +30,8 @@\n \n #include \"tls_context_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n static void my_debug(void *ctx, int level,\n \t\tconst char *file, int line,\n \t\tconst char *str) {\n@@ -144,6 +146,11 @@ Error TLSContextMbedTLS::init_server(int p_transport, Ref<TLSOptions> p_options,\n \t\tcookies = p_cookies;\n \t\tmbedtls_ssl_conf_dtls_cookies(&conf, mbedtls_ssl_cookie_write, mbedtls_ssl_cookie_check, &(cookies->cookie_ctx));\n \t}\n+\n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \tmbedtls_ssl_setup(&tls, &conf);\n \treturn OK;\n }\n@@ -187,6 +194,10 @@ Error TLSContextMbedTLS::init_client(int p_transport, const String &p_hostname,\n \t\t}\n \t}\n \n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \t// Set valid CAs\n \tmbedtls_ssl_conf_ca_chain(&conf, &(cas->cert), nullptr);\n \tmbedtls_ssl_setup(&tls, &conf);\n", "test_patch": "", "problem_statement": "[4.4 beta 1] TLS Handshake Error with Godot HTTPRequest\n### Tested versions\n\n4.4 beta 1 \n\n\n### System information\n\nWindows 11 - Godot 4.4 beta 1 - Vulkan (Mobile)\n\n### Issue description\n\nI\u2019m encountering a TLS handshake error when trying to make a request to https://graph.oculus.com/ using Godot's HTTPRequest.\n\n* Requests to https://www.google.com/ work without any issues.\n* Python's requests library can access the URL without any problems.\n* The same https://graph.oculus.com/ URL works correctly in Postman.\n* I attempted to create a certificate bundle as well, but it was unsuccessful.\n* This issue appears to be specific to Godot.\n\nCPP ERROR:\n\nE 0:00:01:0639   StreamPeerMbedTLS::_do_handshake: TLS handshake error: -28800\n  <C++ Source>   modules\\mbedtls\\stream_peer_mbedtls.cpp:88 @ StreamPeerMbedTLS::_do_handshake()\n\n### Steps to reproduce\n\n* Create simple project\n* Add a HTTPRequest node\n* Add script:\n```\nextends Node3D\n\n@onready var http: HTTPRequest = $HTTPRequest\n\nfunc _ready() -> void:\n\thttp.request(\"https://graph.oculus.com/\")\n\tprint(await http.request_completed)\n```\n* Run\n\n\n### Minimal reproduction project (MRP)\n\n[teste-vr.zip](https://github.com/user-attachments/files/18505403/teste-vr.zip)\n", "hints_text": "I am not in the right area right now, but try running a TLS analyzer on https://graph.oculus.com and https://www.google.com/ and see what's different.\nHello @fire , below is the analysis I performed using the tool: [SSLLabs](https://www.ssllabs.com/). The following key details were observed:\n\n---\n\n#### **TLS Version Support**\n- **Google**: Supports TLS versions starting from **TLS 1.0**.\n- **Meta**: Supports TLS versions starting from **TLS 1.2**.\n\n---\n\n#### **Key Usage**\n- **Google**: Utilizes an **RSA key** of **2048 bits** for its SSL certificate.\n- **Meta**: Utilizes an **EC key** of **256 bits** for its SSL certificate.\n\n---\n\n#### **Cipher Suites**\n\n**Google supports the following Cipher Suites:**\n\n- **TLS 1.3 (No server preference)**\n  - TLS_AES_128_GCM_SHA256 (0x1301): ECDH x25519 (eq. 3072 bits RSA), FS, 128-bit\n  - TLS_AES_256_GCM_SHA384 (0x1302): ECDH x25519 (eq. 3072 bits RSA), FS, 256-bit\n  - TLS_CHACHA20_POLY1305_SHA256 (0x1303): ECDH x25519 (eq. 3072 bits RSA), FS, 256-bit\n\n- **TLS 1.2 (Server-preferred order)**\n  - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xc02b): ECDH x25519, FS, 128-bit\n  - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 (0xcca9): ECDH x25519, FS, 256-bit\n  - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 (0xc02c): ECDH x25519, FS, 256-bit\n  - Other suites (WEAK):\n    - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013): FS, 128-bit\n    - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014): FS, 256-bit\n    - TLS_RSA_WITH_AES_128_GCM_SHA256 (0x9c): WEAK, 128-bit\n    - TLS_RSA_WITH_AES_256_GCM_SHA384 (0x9d): WEAK, 256-bit\n\n---\n\n**Meta supports the following Cipher Suites:**\n\n- **TLS 1.3 (Server-preferred order)**\n  - TLS_AES_128_GCM_SHA256 (0x1301): ECDH x25519, FS, 128-bit\n  - TLS_CHACHA20_POLY1305_SHA256 (0x1303): ECDH x25519, FS, 256-bit\n  - TLS_AES_256_GCM_SHA384 (0x1302): ECDH x25519, FS, 256-bit\n\n- **TLS 1.2 (Server-preferred order)**\n  - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f): ECDH secp256r1, FS, 128-bit\n  - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030): ECDH secp256r1, FS, 256-bit\n  - Other suites (WEAK):\n    - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013): FS, 128-bit\n    - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (0xc014): FS, 256-bit\n\n---\n\nI can confirm the issue (on Debian 12), the error (-28800, i.e. -0x7080) is `MBEDTLS_ERR_SSL_FEATURE_UNAVAILABLE`, so it seems we are either hitting a limitation of our build flags, or this is an issue with MBEDTLS not falling back to TLS 1.2 when a 1.3 is not available (e.g., TLS Handshake record layer fragmentation).\nIndeed, running in verbose mode I get:\n\n```\nthirdparty/mbedtls/library/ssl_tls13_generic.c:1552: Perform PSA-based ECDH/FFDH computation.\nthirdparty/mbedtls/library/ssl_tls13_client.c:1949: Switch to handshake keys for inbound traffic\nthirdparty/mbedtls/library/ssl_msg.c:5070: Ignore ChangeCipherSpec in TLS 1.3 compatibility mode\nthirdparty/mbedtls/library/ssl_msg.c:3297: TLS handshake fragmentation not supported\nthirdparty/mbedtls/library/ssl_msg.c:4244: mbedtls_ssl_handle_message_type() returned -28800 (-0x7080)\nthirdparty/mbedtls/library/ssl_tls13_client.c:2372: mbedtls_ssl_read_record() returned -28800 (-0x7080)\n```\n\nSo my suspects on TLS Handshake record layer fragmentation being the cause seems to be correct. Will investigate if we can try to fallback to TLS 1.2 manually in that scenario.\nThis appears to be a regression:\n- Reproducible in 4.4.dev3 and later, all the way to current `master` (296de7da830fa03425edf544427543087817e649)\n- Not reproducible in 4.3.stable, 4.4.dev1 and 4.4.dev2\n\nSo it was introduced in 4.4.dev3. Most likely from #96394 as @Faless already identified.\nFor reference, this is the mbedTLS issue -> https://github.com/Mbed-TLS/mbedtls/issues/1840\nAnd this https://github.com/Mbed-TLS/mbedtls/pull/9872 seems to be the most up to date PR implementing the missing feature (sadly the 3.x backport is not yet provided).\n\nI also have a branch implementing \"retrying\" the TLS connection using 1.2 in that scenario ( https://github.com/Faless/godot/tree/tls/fallback_to_tls12 ) but it's very hacky, and I don't particularly like the solution tbh (it forces us to keep track of a bunch of settings to re-attempt the TCP reconnection).\n\nI've been thinking about an alternative adding a global setting, and a TLSOption one, to force the maximum version of TLS to 1.2 instead, and let the devs handle this if necessary until mbedTLS implements the feature (hopefully soon?).", "created_at": "2025-02-12 15:44:17", "merge_commit_sha": "8add5838ace498c70ade956b4e1dded73cc3631d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102726", "base_commit": "5da6deaaca27f3d4ec5281d5b791408570919f15", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex c48b05002c82..7d41d2faa601 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2330,6 +2330,7 @@\n \t\t</member>\n \t\t<member name=\"physics/3d/run_on_separate_thread\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n \t\t\tIf [code]true[/code], the 3D physics server runs on a separate thread, making better use of multi-core CPUs. If [code]false[/code], the 3D physics server runs on the main thread. Running the physics server on a separate thread can increase performance, but restricts API access to only physics process.\n+\t\t\t[b]Note:[/b] When [member physics/3d/physics_engine] is set to [code]Jolt Physics[/code], enabling this setting will prevent the 3D physics server from being able to provide any context when reporting errors and warnings, and will instead always refer to nodes as [code]&lt;unknown&gt;[/code].\n \t\t</member>\n \t\t<member name=\"physics/3d/sleep_threshold_angular\" type=\"float\" setter=\"\" getter=\"\" default=\"0.139626\">\n \t\t\tThreshold angular velocity under which a 3D physics body will be considered inactive. See [constant PhysicsServer3D.SPACE_PARAM_BODY_ANGULAR_VELOCITY_SLEEP_THRESHOLD].\ndiff --git a/modules/jolt_physics/jolt_physics_server_3d.h b/modules/jolt_physics/jolt_physics_server_3d.h\nindex 7dac7610f71a..416e3df56aec 100644\n--- a/modules/jolt_physics/jolt_physics_server_3d.h\n+++ b/modules/jolt_physics/jolt_physics_server_3d.h\n@@ -421,6 +421,7 @@ class JoltPhysicsServer3D final : public PhysicsServer3D {\n \n \tvirtual int get_process_info(PhysicsServer3D::ProcessInfo p_process_info) override;\n \n+\tbool is_on_separate_thread() const { return on_separate_thread; }\n \tbool is_active() const { return active; }\n \n \tvoid free_space(JoltSpace3D *p_space);\ndiff --git a/modules/jolt_physics/objects/jolt_object_3d.cpp b/modules/jolt_physics/objects/jolt_object_3d.cpp\nindex 1c2019d9fa3f..e9e6d504e0e7 100644\n--- a/modules/jolt_physics/objects/jolt_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_object_3d.h\"\n \n+#include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n #include \"../spaces/jolt_layers.h\"\n #include \"../spaces/jolt_space_3d.h\"\n@@ -137,6 +138,12 @@ bool JoltObject3D::can_interact_with(const JoltObject3D &p_other) const {\n }\n \n String JoltObject3D::to_string() const {\n+\tstatic const String fallback_name = \"<unknown>\";\n+\n+\tif (JoltPhysicsServer3D::get_singleton()->is_on_separate_thread()) {\n+\t\treturn fallback_name; // Calling `Object::to_string` is not thread-safe.\n+\t}\n+\n \tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n+\treturn instance != nullptr ? instance->to_string() : fallback_name;\n }\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\nindex 281591af9a6c..040d98dace9f 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n@@ -727,8 +727,3 @@ bool JoltSoftBody3D::is_vertex_pinned(int p_index) const {\n \n \treturn pinned_vertices.has(physics_index);\n }\n-\n-String JoltSoftBody3D::to_string() const {\n-\tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n-}\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.h b/modules/jolt_physics/objects/jolt_soft_body_3d.h\nindex f236310f6c69..4d7eb039426b 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.h\n@@ -167,8 +167,6 @@ class JoltSoftBody3D final : public JoltObject3D {\n \tvoid unpin_all_vertices();\n \n \tbool is_vertex_pinned(int p_index) const;\n-\n-\tString to_string() const;\n };\n \n #endif // JOLT_SOFT_BODY_3D_H\n", "test_patch": "", "problem_statement": "Jolt Physics warnings for PhysicalBone3D fail to report bone names when running physics on separate thread\n### Tested versions\n\n- Reproducible in 4.4-beta2, 4.4-beta3\n- Not reproducible in 4.3 (no Jolt implementation)\n\n### System information\n\nGodot v4.4.beta3 - Fedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4080 SUPER (nvidia; 565.77) - AMD Ryzen 7 8700F 8-Core Processor (16 threads)\n\n### Issue description\n\nI am using the native Jolt Physics engine on a separate thread via project settings (`physics/3d/run_on_separate_thread`). I have an armature that needs updating, so Jolt is emitting warnings. However, the warning is attempting to fetch the names of the problem bones, which is not thread-safe, so the warning text is malformed and is passed with multiple errors (as seen below).\n\n```\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine_001). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects '' and ''.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\n\nWhen physics is set to run on the main thread, the problem resolves, showing the warnings as normal, including the bone names (expected behavior).\n```\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3027113173784>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3027146728218>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3102627426828>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3102660981262>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\nShould the warning itself be deferred to the main thread?\n\n### Steps to reproduce\n\n1. Set physics to run on a separate thread `physics/3d/run_on_separate_thread`\n2. Switch Physics Engine to Jolt Physics\n3. Set up a Skeleton3D with PhysicalBone3D bones that have joint properties unsupported in Jolt (i.e. a Pinjoint configured with impulse clamping)\n4. Restart editor to see errors in console, or launch game to see them in debugger\n\n### Minimal reproduction project (MRP)\n\nWarnings should appear as soon as this project is opened and imported.\n\n[physicalbone3d_report_2025-02-09_17-35-51.zip](https://github.com/user-attachments/files/18726415/physicalbone3d_report_2025-02-09_17-35-51.zip)\n", "hints_text": "> However, the warning is attempting to fetch the names of the problem bones, which is not thread-safe, so the warning text is malformed and is passed with multiple errors (as seen below).\n\nThat is indeed problematic, and happens in more places than just this particular warning.\n\nI'll need to see how to best fix this. The fact that I'm even reporting node names from the physics server to begin with is highly questionable, and arguably breaks the \"separation of concerns\" between the scene side of things and the servers, but the errors/warnings are somewhat useless without any context.\n\nIdeally they would be actual configuration warnings on the nodes themselves I guess. The current way of doing it is mostly a crude carry-over from the extension, where there weren't a lot of better options, but I also didn't want the Jolt module to \"spill over\" into other parts of the codebase while it's still experimental.\n> The fact that I'm even reporting node names from the physics server to begin with is highly questionable, and arguably breaks the \"separation of concerns\" between the scene side of things and the servers.\n\nHaving the node names reported by itself to help with debug is not the problem, but having a server rely back on anything from the SceneTree or nodes is.\n\nSo those node name strings would need a copy stored inside the server that maps to whatever server internal object. The server can not ask back anything from the SceneTree outside of very specifically designed callbacks, it is in general the wrong direction.\n> So those node name strings would need a copy stored inside the server that maps to whatever server internal object.\n\nI guess the issue with that is nodes changing names, or just initializing them late, with no ability (with the current interface) for the server to pick up on that change. I suppose that's a minor concession though, since it's likely to be a niche problem.\n\nThe bigger loss would be the inability to provide meaningful errors in release exports, since the stored node names would come at a potentially non-trivial memory cost, and thus rightfully shouldn't be stored in such builds. But seeing as how error-checking in Godot is sometimes compiled out entirely in release exports, I guess there's precedent for that already.\n\nIt does seem like the least invasive option though. Any sort of deferral of the error to the main thread would at the very least require a set of custom error macros in order to report the correct file and line, and you're still left with the conceptual problem of grabbing scene stuff from the server at times when it might not be appropriate to do so.\nThe server should not be responsible to pick up such node changes. It is the node duty to make those changes known to a server.\n\n\nE.g. could add a generic xyz_set_meta() function for all the RID types to the PhysicsServer API that allows to add random stuff with a Dictionary to them for debug and the nodes could call that everytime stuff like their name changes.\nWhile an API like that does seem mildly useful in general, adding to the physics server interface just for this (and at this late stage) seems unfortunate, and also makes the server error reporting more of a commitment than I intended for it to be.\n\nI would probably prefer to skip the metadata part and just have the server pull the names once, and then we could change/improve this for 4.5 instead.\nI'd suggest we should properly weigh the cost of adding a potentially heavy or hacky debugging infrastructure in servers, versus simply not providing the extra useful information we'd like to provide here.\n\nIt's a design constraint of Godot that once things are at the server level, it's not possible to go back to the scene structure. The Jolt integration inherits this design limitation and should maybe not try to work it around.\n\nA proper debugging infrastructure to be able to go back to scene level when needed for descriptive errors might be worth considering, but this is proposal material and not specific to Jolt warnings.\n\nIn this specific case, usage of invalid joint types while using the Jolt backend would be better checked at the node level via Node configuration warnings. Or we just live with only the physics server generic error, and users can grep their scenes and source code to find which scenes use unsupported joints.\nFor 4.4 I would just reduce the error detail and go with a generic error without any node names or specifics. It is imo too late in the 4.4 cycle for any of those other changes that require more work. They can be done for 4.5 and if kept simple enough maybe even backported with a patch later.\n\nI am not sure how feasible it is to add specific physics backend errors to node config warnings. Imo nodes should not really care what backend is available.\nWarnings/errors without context might be fine for this particular warning, since you can indeed (in the worst case) grep for the specific property and maybe find the offending node. There are however a few warnings/errors that relate to numerical values, such as the ones for invalid scaling, and which can end up triggering only at runtime in certain cases. Providing no context for those errors is likely to be frustrating to the point of being detrimental, so I'll probably opt to remove those entirely in that case.\nI threw together a PR for removing the various scene contexts: #102717\n\nLet me know what you think.", "created_at": "2025-02-11 20:22:40", "merge_commit_sha": "9ac02ccbcba7bb260575ef9ca5ffa87d49e1ebf7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102719", "base_commit": "1a0bf546772edc19837e96b5ac07a47a9f8a8b34", "patch": "diff --git a/platform/web/display_server_web.cpp b/platform/web/display_server_web.cpp\nindex 89cc6339d28b..180c05ef411d 100644\n--- a/platform/web/display_server_web.cpp\n+++ b/platform/web/display_server_web.cpp\n@@ -576,9 +576,17 @@ void DisplayServerWeb::_mouse_update_mode() {\n \n void DisplayServerWeb::mouse_set_mode(MouseMode p_mode) {\n \tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n-\tif (p_mode == mouse_mode_base) {\n+\n+\tif (mouse_mode_override_enabled) {\n+\t\tmouse_mode_base = p_mode;\n+\t\t// No need to update, as override is enabled.\n+\t\treturn;\n+\t}\n+\tif (p_mode == mouse_mode_base && p_mode == mouse_get_mode()) {\n+\t\t// No need to update, as it is currently set as the correct mode.\n \t\treturn;\n \t}\n+\n \tmouse_mode_base = p_mode;\n \t_mouse_update_mode();\n }\n@@ -596,9 +604,17 @@ DisplayServer::MouseMode DisplayServerWeb::mouse_get_mode() const {\n \n void DisplayServerWeb::mouse_set_mode_override(MouseMode p_mode) {\n \tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n-\tif (p_mode == mouse_mode_override) {\n+\n+\tif (!mouse_mode_override_enabled) {\n+\t\tmouse_mode_override = p_mode;\n+\t\t// No need to update, as override is not enabled.\n+\t\treturn;\n+\t}\n+\tif (p_mode == mouse_mode_override && p_mode == mouse_get_mode()) {\n+\t\t// No need to update, as it is currently set as the correct mode.\n \t\treturn;\n \t}\n+\n \tmouse_mode_override = p_mode;\n \t_mouse_update_mode();\n }\n", "test_patch": "", "problem_statement": "[Web] `Input.mouse_mode` can't capture mouse after user presses escape key in browser\n### Tested versions\n\n- Reproducible in Godot 4.4.beta2\n- Not Reproducible in 4.3\n\n### System information\n\nGodot v4.4.beta2 - Linux Mint 22 (Wilma) on X11 - X11 display driver, Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4060 Ti (nvidia; 550.120) - AMD Ryzen 9 3900X 12-Core Processor (24 threads)\n\n### Issue description\n\nI have discovered an edge case that likely happens often. When the mouse is captured browsers tend to tell the user that they can press escape to free there mouse. If we capture the users mouse and then they press escape we can not again capture it with the current behavior. Even though the engine knows that the mouse has been released. To capture the mouse again after the user has pressed escape we must first tell the engine to release the mouse and then capture it again. So that they engine executes the correct sequence.\n\nNote: https://github.com/godotengine/godot/issues/100758#issuecomment-2624679816\n\n### Steps to reproduce\n\n\n1. Extract MRP\n2. Open MRP in Godot 4.4.beta2\n3. Ensure exports are managed for Godot 4.4.beta2\n4. Run the MRP in the browser.\n5. Capture the mouse using the button provided.\n6. Press the escape key \"esc\".\n7. Observe that your mouse is released and visible.\n8. Attempt to capture the mouse using the button provided that says \"Capture Mouse\".\n9. Observe this does not work.\n10. Press the button that says \"Capture Mouse After Release\".\n11. Observe this works.\n\nAlternatively for step 10. You can also press space bar or press the \"Release Mouse\" button. and then you can press the \"Capture Mouse\" button and it will work.\n\n### Minimal reproduction project (MRP)\n\n[web-mouse-capture-part-2.zip](https://github.com/user-attachments/files/18608637/web-mouse-capture-part-2.zip)\n", "hints_text": "", "created_at": "2025-02-11 17:02:44", "merge_commit_sha": "9f2b673c6132af06895a071d879eb0ca98862c29", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102677", "base_commit": "296de7da830fa03425edf544427543087817e649", "patch": "diff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 172d6e547118..6da4d24e7256 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -3299,6 +3299,8 @@ void RendererCanvasRenderRD::_prepare_batch_texture_info(RID p_texture, TextureS\n \n RendererCanvasRenderRD::~RendererCanvasRenderRD() {\n \tRendererRD::MaterialStorage *material_storage = RendererRD::MaterialStorage::get_singleton();\n+\tRendererRD::TextureStorage *texture_storage = RendererRD::TextureStorage::get_singleton();\n+\n \t//canvas state\n \n \tmaterial_storage->material_free(default_canvas_group_material);\n@@ -3346,7 +3348,9 @@ RendererCanvasRenderRD::~RendererCanvasRenderRD() {\n \t\t}\n \t}\n \n-\tRendererRD::TextureStorage::get_singleton()->canvas_texture_free(default_canvas_texture);\n+\t// Disable the callback, as we're tearing everything down\n+\ttexture_storage->canvas_texture_set_invalidation_callback(default_canvas_texture, nullptr, nullptr);\n+\ttexture_storage->canvas_texture_free(default_canvas_texture);\n \t//pipelines don't need freeing, they are all gone after shaders are gone\n \n \tmemdelete(shader.default_version_data);\n", "test_patch": "", "problem_statement": "\"Attempted to free invalid ID\" errors are printed when exiting a project run with Debug Canvas Item Redraw\n### Tested versions\n\n- Reproducible in: 4.4.beta2, 4.4.beta2\n- Not reproducible in: 4.3.stable, 4.4.beta1\n\n### System information\n\nGodot v4.4.beta (36d90c73a) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (nvidia; 565.77) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nRunning the MRP with `--debug-canvas-item-redraw` will result in the following on exit:\n\n```\nERROR: Attempted to free invalid ID: 4509715660816\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\nERROR: Attempted to free invalid ID: 4526895530004\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\nERROR: Attempted to free invalid ID: 4539780431895\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\n```\n\nThe invalid IDs are the usually same on every run (in this particular project), especially the first one. No further information about this is printed when using `--verbose`.\n\nThe feature still works correctly, so it's not a big issue but we should still aim to fix it.\n\nI've bisected this to https://github.com/godotengine/godot/pull/101931. cc @stuartcarnie \n\n### Steps to reproduce\n\n- Add a CheckButton node.\n- With the editor being run from a terminal (so you can see all errors on exit), enable **Debug > Visible Canvas Item Redraw** or run the project with `--debug-canvas-item-redraw` when using Forward+ or Mobile.\n- Exit the project and notice errors being printed in the terminal.\n\n### Minimal reproduction project (MRP)\n\n[test_debug_canvas_item_redraw.zip](https://github.com/user-attachments/files/18739163/test_debug_canvas_item_redraw.zip)\n", "hints_text": "", "created_at": "2025-02-10 21:18:34", "merge_commit_sha": "cfe0fd62d03bf58104dcda98f0db7d26326f0ba7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102640", "base_commit": "c2732ae4b6fa4e7b543c065bedcd92759f6db387", "patch": "diff --git a/editor/plugins/tiles/tile_set_atlas_source_editor.cpp b/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\nindex ffb5bb5009db..80958b2043fb 100644\n--- a/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\n+++ b/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\n@@ -971,40 +971,44 @@ void TileSetAtlasSourceEditor::_update_atlas_view() {\n \t\ttile_create_help->set_visible(tools_button_group->get_pressed_button() == tool_setup_atlas_source_button);\n \t}\n \n-\tVector2i pos;\n-\tVector2 texture_region_base_size = tile_set_atlas_source->get_texture_region_size();\n-\tint texture_region_base_size_min = MIN(texture_region_base_size.x, texture_region_base_size.y);\n-\tfor (int i = 0; i < tile_set_atlas_source->get_tiles_count(); i++) {\n-\t\tVector2i tile_id = tile_set_atlas_source->get_tile_id(i);\n-\t\tint alternative_count = tile_set_atlas_source->get_alternative_tiles_count(tile_id);\n-\t\tif (alternative_count > 1) {\n-\t\t\t// Compute the right extremity of alternative.\n-\t\t\tint y_increment = 0;\n-\t\t\tpos.x = 0;\n-\t\t\tfor (int j = 1; j < alternative_count; j++) {\n-\t\t\t\tint alternative_id = tile_set_atlas_source->get_alternative_tile_id(tile_id, j);\n-\t\t\t\tRect2i rect = tile_atlas_view->get_alternative_tile_rect(tile_id, alternative_id);\n-\t\t\t\tpos.x = MAX(pos.x, rect.get_end().x);\n-\t\t\t\ty_increment = MAX(y_increment, rect.size.y);\n-\t\t\t}\n-\n-\t\t\t// Create and position the button.\n-\t\t\tButton *button = memnew(Button);\n-\t\t\tbutton->set_flat(true);\n-\t\t\tbutton->set_button_icon(get_editor_theme_icon(SNAME(\"Add\")));\n-\t\t\tbutton->add_theme_style_override(CoreStringName(normal), memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(SceneStringName(hover), memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(\"focus\", memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(SceneStringName(pressed), memnew(StyleBoxEmpty));\n-\t\t\tbutton->connect(SceneStringName(pressed), callable_mp(tile_set_atlas_source, &TileSetAtlasSource::create_alternative_tile).bind(tile_id, TileSetSource::INVALID_TILE_ALTERNATIVE));\n-\t\t\tbutton->set_rect(Rect2(Vector2(pos.x, pos.y + (y_increment - texture_region_base_size.y) / 2.0), Vector2(texture_region_base_size_min, texture_region_base_size_min)));\n-\t\t\tbutton->set_expand_icon(true);\n-\t\t\talternative_tiles_control->add_child(button);\n-\n-\t\t\tpos.y += y_increment;\n-\t\t}\n-\t}\n-\ttile_atlas_view->set_padding(Side::SIDE_RIGHT, texture_region_base_size_min);\n+\tif (tools_button_group->get_pressed_button() != tool_paint_button) {\n+\t\tVector2i pos;\n+\t\tVector2 texture_region_base_size = tile_set_atlas_source->get_texture_region_size();\n+\t\tint texture_region_base_size_min = MIN(texture_region_base_size.x, texture_region_base_size.y);\n+\t\tfor (int i = 0; i < tile_set_atlas_source->get_tiles_count(); i++) {\n+\t\t\tVector2i tile_id = tile_set_atlas_source->get_tile_id(i);\n+\t\t\tint alternative_count = tile_set_atlas_source->get_alternative_tiles_count(tile_id);\n+\t\t\tif (alternative_count > 1) {\n+\t\t\t\t// Compute the right extremity of alternative.\n+\t\t\t\tint y_increment = 0;\n+\t\t\t\tpos.x = 0;\n+\t\t\t\tfor (int j = 1; j < alternative_count; j++) {\n+\t\t\t\t\tint alternative_id = tile_set_atlas_source->get_alternative_tile_id(tile_id, j);\n+\t\t\t\t\tRect2i rect = tile_atlas_view->get_alternative_tile_rect(tile_id, alternative_id);\n+\t\t\t\t\tpos.x = MAX(pos.x, rect.get_end().x);\n+\t\t\t\t\ty_increment = MAX(y_increment, rect.size.y);\n+\t\t\t\t}\n+\n+\t\t\t\t// Create and position the button.\n+\t\t\t\tButton *button = memnew(Button);\n+\t\t\t\tbutton->set_flat(true);\n+\t\t\t\tbutton->set_button_icon(get_editor_theme_icon(SNAME(\"Add\")));\n+\t\t\t\tbutton->add_theme_style_override(CoreStringName(normal), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(SceneStringName(hover), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(\"focus\", memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(SceneStringName(pressed), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_constant_override(\"align_to_largest_stylebox\", false);\n+\t\t\t\tbutton->set_mouse_filter(Control::MOUSE_FILTER_PASS);\n+\t\t\t\tbutton->connect(SceneStringName(pressed), callable_mp(this, &TileSetAtlasSourceEditor::_tile_alternatives_create_button_pressed).bind(tile_id));\n+\t\t\t\tbutton->set_rect(Rect2(Vector2(pos.x, pos.y + (y_increment - texture_region_base_size.y) / 2.0), Vector2(texture_region_base_size_min, texture_region_base_size_min)));\n+\t\t\t\tbutton->set_expand_icon(true);\n+\t\t\t\talternative_tiles_control->add_child(button);\n+\n+\t\t\t\tpos.y += y_increment;\n+\t\t\t}\n+\t\t}\n+\t\ttile_atlas_view->set_padding(Side::SIDE_RIGHT, texture_region_base_size_min);\n+\t}\n \n \t// Redraw everything.\n \ttile_atlas_control->queue_redraw();\n@@ -2009,6 +2013,17 @@ void TileSetAtlasSourceEditor::_tile_alternatives_control_mouse_exited() {\n \talternative_tiles_control_unscaled->queue_redraw();\n }\n \n+void TileSetAtlasSourceEditor::_tile_alternatives_create_button_pressed(const Vector2i &p_atlas_coords) {\n+\tEditorUndoRedoManager *undo_redo = EditorUndoRedoManager::get_singleton();\n+\n+\t// FIXME: Doesn't undo changes to `next_alternative_id` counter.\n+\tundo_redo->create_action(TTR(\"Create tile alternatives\"));\n+\tint next_id = tile_set_atlas_source->get_next_alternative_tile_id(p_atlas_coords);\n+\tundo_redo->add_do_method(tile_set_atlas_source, \"create_alternative_tile\", p_atlas_coords, next_id);\n+\tundo_redo->add_undo_method(tile_set_atlas_source, \"remove_alternative_tile\", p_atlas_coords, next_id);\n+\tundo_redo->commit_action();\n+}\n+\n void TileSetAtlasSourceEditor::_tile_alternatives_control_draw() {\n \t// Update the hovered alternative tile.\n \tif (tools_button_group->get_pressed_button() == tool_select_button) {\ndiff --git a/editor/plugins/tiles/tile_set_atlas_source_editor.h b/editor/plugins/tiles/tile_set_atlas_source_editor.h\nindex 12a02e6a3980..b729364d1559 100644\n--- a/editor/plugins/tiles/tile_set_atlas_source_editor.h\n+++ b/editor/plugins/tiles/tile_set_atlas_source_editor.h\n@@ -253,6 +253,7 @@ class TileSetAtlasSourceEditor : public HSplitContainer {\n \tPopupMenu *alternative_tile_popup_menu = nullptr;\n \tControl *alternative_tiles_control = nullptr;\n \tControl *alternative_tiles_control_unscaled = nullptr;\n+\tvoid _tile_alternatives_create_button_pressed(const Vector2i &p_atlas_coords);\n \tvoid _tile_alternatives_control_draw();\n \tvoid _tile_alternatives_control_unscaled_draw();\n \tvoid _tile_alternatives_control_mouse_exited();\n", "test_patch": "", "problem_statement": "In tileset editor, attempting to paint terrain over alternative tile instead creates a new alternative tile\n### Tested versions\n\n- Reproducible for v4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.22631 - GLES3 (Compatibility) - AMD Radeon RX 6600M (Advanced Micro Devices, Inc.; 30.0.13024.5001) - AMD Ryzen 7 5800H with Radeon Graphics (16 Threads)\n\n### Issue description\n\nAttempting to paint terrain over an alternative tile instead results with the terrain editor creating a new alternative tile. Which shouldn't happen, as the alternative tile creation is done via \"Select\" tab of the tileset editor.\n\n### Steps to reproduce\n\n1. Load attached project\n2. Open `player.tscn`\n3. Open `TileMapLayer` node\n4. Switch to tileset editing, `Paint` mode\n5. Select property `Terrains` -> `Terrain Set 0` -> `Dots Biome`\n6. Attempt to paint this point:\n![Image](https://github.com/user-attachments/assets/814c2333-8a5a-4d8e-a20a-06daee32f4ef)\n7. Be greeted with this sight:\n![Image](https://github.com/user-attachments/assets/c6be7659-d9d3-43e8-8fd7-25ec609d998b)\n\n\n\n\n### Minimal reproduction project (MRP)\n\n[TerrainPainterBug.zip](https://github.com/user-attachments/files/17937477/TerrainPainterBug.zip)\n", "hints_text": "I tracked down the issue to the \"create alternative tile\" button that's appended to the end of the row.\n\nHere in this pic, it's changed up to use grey background instead of transparent.\n\nFor some reason, the button is missing the icon, is sized incorrectly and overlaps nearby squares, intercepting terrain editor input.\n\n![Image](https://github.com/user-attachments/assets/4216c202-1bfb-444b-815a-f2ca6947a227)", "created_at": "2025-02-09 23:32:53", "merge_commit_sha": "4a08fdc2a7df16062dc4d2aeb6731b50e6ec4d07", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102627", "base_commit": "261e7d32d37445de3ef3a9804346552fdac6096e", "patch": "diff --git a/platform/android/export/export_plugin.cpp b/platform/android/export/export_plugin.cpp\nindex 578f723e700f..0f50f725258c 100644\n--- a/platform/android/export/export_plugin.cpp\n+++ b/platform/android/export/export_plugin.cpp\n@@ -55,6 +55,10 @@\n #include \"modules/modules_enabled.gen.h\" // For mono.\n #include \"modules/svg/image_loader_svg.h\"\n \n+#ifdef MODULE_MONO_ENABLED\n+#include \"modules/mono/utils/path_utils.h\"\n+#endif\n+\n #ifdef ANDROID_ENABLED\n #include \"../os_android.h\"\n #endif\n@@ -2526,6 +2530,43 @@ bool EditorExportPlatformAndroid::has_valid_username_and_password(const Ref<Edit\n \treturn valid;\n }\n \n+#ifdef MODULE_MONO_ENABLED\n+bool _validate_dotnet_tfm(const String &required_tfm, String &r_error) {\n+\tString assembly_name = path::get_csharp_project_name();\n+\tString project_path = ProjectSettings::get_singleton()->globalize_path(\"res://\" + assembly_name + \".csproj\");\n+\n+\tif (!FileAccess::exists(project_path)) {\n+\t\treturn true;\n+\t}\n+\n+\tString pipe;\n+\tList<String> args;\n+\targs.push_back(\"build\");\n+\targs.push_back(project_path);\n+\targs.push_back(\"--getProperty:TargetFramework\");\n+\n+\tint exitcode;\n+\tError err = OS::get_singleton()->execute(\"dotnet\", args, &pipe, &exitcode, true);\n+\tif (err != OK || exitcode != 0) {\n+\t\tif (err != OK) {\n+\t\t\tWARN_PRINT(\"Failed to execute dotnet command. Error \" + String(error_names[err]));\n+\t\t} else if (exitcode != 0) {\n+\t\t\tprint_line(pipe);\n+\t\t\tWARN_PRINT(\"dotnet command exited with code \" + itos(exitcode) + \". See output above for more details.\");\n+\t\t}\n+\t\tr_error += vformat(TTR(\"Unable to determine the C# project's TFM, it may be incompatible. The export template only supports '%s'. Make sure the project targets '%s' or consider using gradle builds instead.\"), required_tfm, required_tfm) + \"\\n\";\n+\t} else {\n+\t\tString tfm = pipe.strip_edges();\n+\t\tif (tfm != required_tfm) {\n+\t\t\tr_error += vformat(TTR(\"C# project targets '%s' but the export template only supports '%s'. Consider using gradle builds instead.\"), tfm, required_tfm) + \"\\n\";\n+\t\t\treturn false;\n+\t\t}\n+\t}\n+\n+\treturn true;\n+}\n+#endif\n+\n bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<EditorExportPreset> &p_preset, String &r_error, bool &r_missing_templates, bool p_debug) const {\n \tString err;\n \tbool valid = false;\n@@ -2534,6 +2575,15 @@ bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<Edito\n #ifdef MODULE_MONO_ENABLED\n \t// Android export is still a work in progress, keep a message as a warning.\n \terr += TTR(\"Exporting to Android when using C#/.NET is experimental.\") + \"\\n\";\n+\n+\tif (!gradle_build_enabled) {\n+\t\t// For template exports we only support .NET 8 because the template\n+\t\t// includes .jar dependencies that may only be compatible with .NET 8.\n+\t\tif (!_validate_dotnet_tfm(\"net8.0\", err)) {\n+\t\t\tr_error = err;\n+\t\t\treturn false;\n+\t\t}\n+\t}\n #endif\n \n \t// Look for export templates (first official, and if defined custom templates).\n", "test_patch": "", "problem_statement": "(4.4.beta1) Android app crashes when exported with .NET 9\n### Tested versions\n\n**Reproducible:**\n4.4.beta1\n4.4.dev7\n\n**Not Reproducible:**\n4.4.dev3\n\n### System information\n\nGodot v4.4.beta1.mono - Windows 10 (build 19045) - OpenGL 3 (Compatibility)\n\n### Issue description\n\nWhen exporting to Android with .NET 9 using Gradle Build via the Remote Deploy, the app crashes immediately at startup.\n\nNote:  .NET 8 works fine, but .NET 9 causes the app to crash\n\nusing the command at runtime:\n**adb logcat|grep godot**\n\n> 01-22 19:27:18.818  1895  3450 I ActivityTaskManager: START u0 {act=android.intent.action.MAIN flg=0x10000000 cmp=com.example.test_android/com.godot.game.GodotApp} from uid 2000\n01-22 19:27:18.857  1895  2224 I ActivityManager: Start proc 1876:com.example.test_android/u0a411 for next-top-activity {com.example.test_android/com.godot.game.GodotApp}\n01-22 19:27:19.885  1895  2006 W ActivityTaskManager:   Force finishing activity com.example.test_android/com.godot.game.GodotApp\n01-22 19:27:19.987  1895  2220 I GameServiceProviderInstance: Failed to remove task overlay. This is expected if the task is already destroyed: GameSessionRecord{mTaskId=306, mState=GAME_SESSION_ATTACHED, mRootComponentName=ComponentInfo{com.example.test_android/com.godot.game.GodotApp}, mIGameSession=android.service.games.IGameSession$Stub$Proxy@3a45eaa, mSurfacePackage=android.view.SurfaceControlViewHost$SurfacePackage@3504a9b}\n01-22 19:27:20.386  1895  2200 W ActivityTaskManager: Activity top resumed state loss timeout for ActivityRecord{691de90 u0 com.example.test_android/com.godot.game.GodotApp} t-1 f}}\n\n\n\n\n\n\n\n### Steps to reproduce\n\n1. Godot 4.4.beta1\n2. Create a new project\n3. Create C# script and attach to a node in the main scene\n4. Update the visual studio project to target .NET 9: \n` <TargetFramework>net9.0</TargetFramework>`\n4. Remote Deploy to Android with Gradle Build\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "This is likely because .NET 9 introduced a new Java class (`net.dot.android.crypto.DotnetX509KeyManager`) in https://github.com/dotnet/runtime/pull/103337 and we're embedding the `System.Security.Cryptography.Native.Android` jar library from .NET 8. We were hoping the Java library wouldn't change often so it would remain compatible with newer versions for a while.", "created_at": "2025-02-09 18:50:37", "merge_commit_sha": "0b9fd7e1902e8fc9e58c5a4846a1b0e8b22ac665", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102625", "base_commit": "261e7d32d37445de3ef3a9804346552fdac6096e", "patch": "diff --git a/scene/gui/popup.cpp b/scene/gui/popup.cpp\nindex 94d7303ae504..cbba65e0088b 100644\n--- a/scene/gui/popup.cpp\n+++ b/scene/gui/popup.cpp\n@@ -247,8 +247,14 @@ void PopupPanel::_input_from_window(const Ref<InputEvent> &p_event) {\n \n \t\tRef<InputEventMouseButton> b = p_event;\n \t\t// Hide it if the shadows have been clicked.\n-\t\tif (b.is_valid() && b->is_pressed() && b->get_button_index() == MouseButton::LEFT && !panel->get_global_rect().has_point(b->get_position())) {\n-\t\t\t_close_pressed();\n+\t\tif (b.is_valid() && b->is_pressed() && b->get_button_index() == MouseButton::LEFT) {\n+\t\t\tRect2 panel_area = panel->get_global_rect();\n+\t\t\tfloat win_scale = get_content_scale_factor();\n+\t\t\tpanel_area.position *= win_scale;\n+\t\t\tpanel_area.size *= win_scale;\n+\t\t\tif (!panel_area.has_point(b->get_position())) {\n+\t\t\t\t_close_pressed();\n+\t\t\t}\n \t\t}\n \t} else {\n \t\tWARN_PRINT_ONCE(\"PopupPanel has received an invalid InputEvent. Consider filtering out invalid events.\");\ndiff --git a/scene/gui/popup_menu.cpp b/scene/gui/popup_menu.cpp\nindex 092a12bd1486..b6dc75754690 100644\n--- a/scene/gui/popup_menu.cpp\n+++ b/scene/gui/popup_menu.cpp\n@@ -327,16 +327,17 @@ int PopupMenu::_get_mouse_over(const Point2 &p_over) const {\n \t\titem_clickable_area.size.width -= scroll_width;\n \t}\n \tfloat win_scale = get_content_scale_factor();\n-\titem_clickable_area.position.y = (item_clickable_area.position.y + theme_cache.panel_style->get_margin(SIDE_TOP)) * win_scale;\n+\titem_clickable_area.position.x += theme_cache.panel_style->get_margin(SIDE_LEFT);\n+\titem_clickable_area.position.y += theme_cache.panel_style->get_margin(SIDE_TOP);\n+\titem_clickable_area.position *= win_scale;\n \titem_clickable_area.size.y -= theme_cache.panel_style->get_margin(SIDE_TOP) + theme_cache.panel_style->get_margin(SIDE_BOTTOM);\n \titem_clickable_area.size *= win_scale;\n \n-\tif (p_over.x < item_clickable_area.position.x || p_over.x >= item_clickable_area.position.x + item_clickable_area.size.width ||\n-\t\t\tp_over.y < item_clickable_area.position.y || p_over.y >= item_clickable_area.position.y + item_clickable_area.size.height) {\n+\tif (!item_clickable_area.has_point(p_over)) {\n \t\treturn -1;\n \t}\n \n-\tfloat ofs = item_clickable_area.position.y + theme_cache.v_separation * 0.5;\n+\tfloat ofs = item_clickable_area.position.y + (float)theme_cache.v_separation * win_scale * 0.5;\n \tfor (int i = 0; i < items.size(); i++) {\n \t\tofs += i > 0 ? (float)theme_cache.v_separation * win_scale : (float)theme_cache.v_separation * win_scale * 0.5;\n \t\tofs += _get_item_height(i) * win_scale;\n@@ -430,7 +431,7 @@ void PopupMenu::_activate_submenu(int p_over, bool p_by_keyboard) {\n \t\t\tthis_rect.size.x, scaled_ofs_cache + scroll_offset + theme_cache.panel_style->get_margin(SIDE_TOP) * win_scale - theme_cache.v_separation / 2));\n \n \t// If there is an area below the submenu item, add an autohide area there.\n-\tif (scaled_ofs_cache + scaled_height_cache + scroll_offset <= control->get_size().height) {\n+\tif (scaled_ofs_cache + scaled_height_cache + scroll_offset <= control->get_size().height * win_scale) {\n \t\tconst int from = scaled_ofs_cache + scaled_height_cache + scroll_offset + theme_cache.v_separation / 2;\n \t\tsubmenu_pum->add_autohide_area(Rect2(this_rect.position.x, this_rect.position.y + from, this_rect.size.x, this_rect.size.y - from));\n \t}\n@@ -605,9 +606,13 @@ void PopupMenu::_input_from_window_internal(const Ref<InputEvent> &p_event) {\n \t\t}\n \t\titem_clickable_area.size.width -= scroll_width;\n \t}\n-\titem_clickable_area.position.y = (item_clickable_area.position.y + theme_cache.panel_style->get_margin(SIDE_TOP)) * get_content_scale_factor();\n+\n+\tfloat win_scale = get_content_scale_factor();\n+\titem_clickable_area.position.x += theme_cache.panel_style->get_margin(SIDE_LEFT);\n+\titem_clickable_area.position.y += theme_cache.panel_style->get_margin(SIDE_TOP);\n+\titem_clickable_area.position *= win_scale;\n \titem_clickable_area.size.y -= theme_cache.panel_style->get_margin(SIDE_TOP) + theme_cache.panel_style->get_margin(SIDE_BOTTOM);\n-\titem_clickable_area.size *= get_content_scale_factor();\n+\titem_clickable_area.size *= win_scale;\n \n \tRef<InputEventMouseButton> b = p_event;\n \n@@ -622,9 +627,14 @@ void PopupMenu::_input_from_window_internal(const Ref<InputEvent> &p_event) {\n \t\t\t\tis_scrolling = is_layout_rtl() ? b->get_position().x < item_clickable_area.position.x : b->get_position().x > item_clickable_area.size.width;\n \n \t\t\t\t// Hide it if the shadows have been clicked.\n-\t\t\t\tif (get_flag(FLAG_POPUP) && !panel->get_global_rect().has_point(b->get_position())) {\n-\t\t\t\t\t_close_pressed();\n-\t\t\t\t\treturn;\n+\t\t\t\tif (get_flag(FLAG_POPUP)) {\n+\t\t\t\t\tRect2 panel_area = panel->get_global_rect();\n+\t\t\t\t\tpanel_area.position *= win_scale;\n+\t\t\t\t\tpanel_area.size *= win_scale;\n+\t\t\t\t\tif (!panel_area.has_point(b->get_position())) {\n+\t\t\t\t\t\t_close_pressed();\n+\t\t\t\t\t\treturn;\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tif (!item_clickable_area.has_point(b->get_position())) {\n", "test_patch": "", "problem_statement": "Popup menus broken when `content_scale_mode` is bigger then 1 and subwindows are not embedded\n### Tested versions\n\n- reproducable in 4.4 beta1\n- not reproducable in 4.4 dev 7 or before\n\n### System information\n\nWindows 10\n\n### Issue description\n\nWorking on applications (material maker in my case) you often want to allow scaling the window using the content_scale_factor AND allow using multiple native windows (so having embed subwindows off). Unfortunately at higher factors, popup menus (and option buttons, maybe more popups idk) don't function anymore. The lower parts of the popups does not receive input/clicks. Strangely enough the hover works fine, so I really have no clue what's going on.\n\n### Steps to reproduce\n\nCreate a popup menu or option button with a couple of items. Change the content scale factor to 2, turn embed subwindows off. Then run the game and try selecting the last popup item.\n\n### Minimal reproduction project (MRP)\n\n[mrp_scalemenupopupbug.zip](https://github.com/user-attachments/files/18592487/mrp_scalemenupopupbug.zip)\nHope this helps.\n", "hints_text": "Okay, looks like this one is the most likely cause, but I have no idea tbh: https://github.com/godotengine/godot/issues/54030\nBtw, it seems unlikely this will get fixed for 4.4, but one can always hope :). If there is something I could help with, let me know. \n\nI would certainly call this a regression unfortunately.\nI'll bisect this bug.\nBisected to #91333, @YeldhamDev \n\n![Image](https://github.com/user-attachments/assets/29956588-c83a-43e9-af9d-128d3c01a1fd)", "created_at": "2025-02-09 18:03:13", "merge_commit_sha": "ed79fe18e666ababbed4a03ebc40d0002963d36e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102618", "base_commit": "36d90c73a843afa2807a0b8dcbfbf52bdb8a759c", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 72c87bfc1c6d..17c6ede2d248 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -40,6 +40,12 @@ void EmbeddedProcess::_notification(int p_what) {\n \t\tcase NOTIFICATION_ENTER_TREE: {\n \t\t\twindow = get_window();\n \t\t} break;\n+\t\tcase NOTIFICATION_PROCESS: {\n+\t\t\tif (updated_embedded_process_queued) {\n+\t\t\t\tupdated_embedded_process_queued = false;\n+\t\t\t\t_update_embedded_process();\n+\t\t\t}\n+\t\t} break;\n \t\tcase NOTIFICATION_DRAW: {\n \t\t\t_draw();\n \t\t} break;\n@@ -179,6 +185,7 @@ void EmbeddedProcess::embed_process(OS::ProcessID p_pid) {\n \tstart_embedding_time = OS::get_singleton()->get_ticks_msec();\n \tembedding_grab_focus = has_focus();\n \ttimer_update_embedded_process->start();\n+\tset_process(true);\n \tset_notify_transform(true);\n \n \t// Attempt to embed the process, but if it has just started and the window is not ready yet,\n@@ -196,6 +203,7 @@ void EmbeddedProcess::reset() {\n \tembedding_grab_focus = false;\n \ttimer_embedding->stop();\n \ttimer_update_embedded_process->stop();\n+\tset_process(false);\n \tset_notify_transform(false);\n \tqueue_redraw();\n }\n@@ -251,11 +259,6 @@ void EmbeddedProcess::_timer_update_embedded_process_timeout() {\n \t\t\tqueue_update_embedded_process();\n \t\t}\n \t}\n-\n-\tif (updated_embedded_process_queued) {\n-\t\tupdated_embedded_process_queued = false;\n-\t\t_update_embedded_process();\n-\t}\n }\n \n void EmbeddedProcess::_update_embedded_process() {\n", "test_patch": "", "problem_statement": "[4.4 Beta 3] Embedded game window lags when changing positions and scale.\n### Tested versions\n\n- Reproductible in: v4.4.beta3.official [06acfccf8]\n\n### System information\n\nGodot v4.4.beta3 - Fedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 (nvidia; 565.77) - AMD Ryzen 9 7900X 12-Core Processor (24 threads)\n\n### Issue description\n\nWhen embedding the game window (either on a floating workspace or on the editor \"Game\" tab) and moving the \"main\" window, the embedded window will lag behind. This did not happen in earlier versions of the engine and I don't know if it happens on Windows.\n\nBETA 2\n\nhttps://github.com/user-attachments/assets/1e1b4f09-66a6-49bb-aee1-3af18d63956d\n\n---\n\nBETA 3\n\nhttps://github.com/user-attachments/assets/c5c0705d-1ae6-49c4-82ec-fa4ead231005\n\n### Steps to reproduce\n\n- Run a project on 4.4.beta3 with `Embed game on Next Play` enabled;\n- Move / scale the main window that's holding the embedded window around.\n\n### Minimal reproduction project (MRP)\n\nNot including an MRP since this can be replicated with an empty project.\n", "hints_text": "That's a side effect of #102251.\nOn low spec machine on Windows resizing the floating window was very slow. The embedded window is now updated less frequently, causing this out of sync effect. I'll try to think of another method to fix #102251 and still keep the embedded window in sync as much as possible.", "created_at": "2025-02-09 13:46:59", "merge_commit_sha": "fa85645c1a27d61e172023bd2c6ec7c2c02e527d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102535", "base_commit": "3f56b3b23916ff54a1715cb8444304ce3c50283d", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 961d81c034fd..c8b6227d1341 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -3710,7 +3710,9 @@ void EditorNode::set_addon_plugin_enabled(const String &p_addon, bool p_enabled,\n \t// Only try to load the script if it has a name. Else, the plugin has no init script.\n \tif (script_path.length() > 0) {\n \t\tscript_path = addon_path.get_base_dir().path_join(script_path);\n-\t\tscr = ResourceLoader::load(script_path, \"Script\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n+\t\t// We should not use the cached version on startup to prevent a script reload\n+\t\t// if it is already loaded and potentially running from autoloads. See GH-100750.\n+\t\tscr = ResourceLoader::load(script_path, \"Script\", EditorFileSystem::get_singleton()->doing_first_scan() ? ResourceFormatLoader::CACHE_MODE_REUSE : ResourceFormatLoader::CACHE_MODE_IGNORE);\n \n \t\tif (scr.is_null()) {\n \t\t\tshow_warning(vformat(TTR(\"Unable to load addon script from path: '%s'.\"), script_path));\n", "test_patch": "", "problem_statement": "Godot 4.4 throws errors when using `await` on EditorPlugin\n### Tested versions\n\n- Reproducible: 4.4-dev1 and 4.4-dev7\n- Not Reproducible: 4.3-stable\n\n### System information\n\nGodot v4.4.dev7 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1650 (NVIDIA; 32.0.15.6603) - Intel(R) Core(TM) i7-2600K CPU @ 3.40GHz (8 threads)\n\n### Issue description\n\nWhen the editor starts up, calling code from an Autoload to an EditorPlugin with a function that uses `while` and `await` will result in either:\n- Working fine.\n- Throwing a Bad Address Index error.\n- Throwing an Internal Script error with opcode 0, 1 or 99.\n- Crashing to desktop.\n\n![Image](https://github.com/user-attachments/assets/24fe74ed-8acc-4ff7-b0d8-8fa50fee318a)\n\n### Steps to reproduce\n\nThe MRP will throw the error when opening the project. If it doesn't, use \"Project > Reload Current Project\" as sometimes it may simply work.\n\nThis problem seems to require a combination of a few situations to happen:\n- The EditorPlugin must be enabled. The issue vanishes when disabled, even if there are no changes in the script execution.\n- The function must be called from the Autoloader to the EditorPlugin, if called from inside the EditorPlugin, it works fine.\n- the EditorPlugin class must be loaded inside the function using `load()`. Works fine with a preloaded variable on the class scope.\n- The `await` must be inside the `while` loop.\n\n\nSome background on why I'm running code like this:\n- To isolate editor access to only inside the EditorPlugin class.\n- My plugin checks for a resource file, if it doesn't exist, creates the file and updates the FileSystem if it's in editor mode.\n- After v4.2 or v4.3, the FileSystem takes a while to load and during that time any new files or requests to update are ignored.\n- I can't use `preload()` because EditorPlugin classes are not exported to runtime.\n\n### Minimal reproduction project (MRP)\n\n[project_bad_address.zip](https://github.com/user-attachments/files/18223024/project_bad_address.zip)\n", "hints_text": "I can reproduce this bug, i got the errors cited in this issue and this one too: \n\n```\n./modules/gdscript/gdscript_vm.cpp:723 - Condition ' op >= Variant::OP_MAX ' is true. Breaking..:\n res://addons/res_plugin/res_editor_plugin.gd:7 - Internal script error! Opcode: 0 (please report).\n```\n\nAnd when crashed i got this backtrace:\n\n<details><summary>Backtrace</summary>\n\n```\n================================================================\nCrashHandlerException: Program crashed with signal 11\nEngine version: Godot Engine v4.4.dev.custom_build (97ef3c837263099faf02d8ebafd6c77c94d2aaba)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] _gnu_exception_handler (C:/M/B/src/mingw-w64/mingw-w64-crt/crt/crt_handler.c:213)\n[2] StringName::hash() const (./core/string/string_name.h:140)\n[3] HashMapHasherDefault::hash(StringName const&) (./core/templates/hashfuncs.h:314)\n[4] HashMap<StringName, MethodBind*, HashMapHasherDefault, HashMapComparatorDefault<StringName>, DefaultTypedAllocator<HashMapElement<StringName, MethodBind*> > >::_hash(StringName const&) const (./core/templates/hash_map.h:85)\n[5] HashMap<StringName, MethodBind*, HashMapHasherDefault, HashMapComparatorDefault<StringName>, DefaultTypedAllocator<HashMapElement<StringName, MethodBind*> > >::_lookup_pos(StringName const&, unsigned int&) const (./core/templates/hash_map.h:106)\n[6] HashMap<StringName, MethodBind*, HashMapHasherDefault, HashMapComparatorDefault<StringName>, DefaultTypedAllocator<HashMapElement<StringName, MethodBind*> > >::getptr(StringName const&) (./core/templates/hash_map.h:300)\n[7] ClassDB::get_method(StringName const&, StringName const&) (./core/object/class_db.cpp:1027)\n[8] Object::callp(StringName const&, Variant const**, int, Callable::CallError&) (./core/object/object.cpp:808)\n[9] Variant::callp(StringName const&, Variant const**, int, Variant&, Callable::CallError&) (./core/variant/variant_call.cpp:1211)\n[10] GDScriptFunction::call(GDScriptInstance*, Variant const**, int, Callable::CallError&, GDScriptFunction::CallState*) (./modules/gdscript/gdscript_vm.cpp:1890)\n[11] GDScriptFunctionState::resume(Variant const&) (./modules/gdscript/gdscript_function.cpp:216)\n[12] GDScriptFunctionState::_signal_callback(Variant const**, int, Callable::CallError&) (./modules/gdscript/gdscript_function.cpp:166)\n[13] MethodBindVarArgTR<GDScriptFunctionState, Variant>::call(Object*, Variant const**, int, Callable::CallError&) const (./core/object/method_bind.h:271)\n[14] Object::callp(StringName const&, Variant const**, int, Callable::CallError&) (./core/object/object.cpp:811)\n[15] Callable::callp(Variant const**, int, Variant&, Callable::CallError&) const (./core/variant/callable.cpp:69)\n[16] CallableCustomBind::call(Variant const**, int, Variant&, Callable::CallError&) const (./core/variant/callable_bind.cpp:152)\n[17] Callable::callp(Variant const**, int, Variant&, Callable::CallError&) const (./core/variant/callable.cpp:57)\n[18] Object::emit_signalp(StringName const&, Variant const**, int) (./core/object/object.cpp:1198)\n[19] Node::emit_signalp(StringName const&, Variant const**, int) (./scene/main/node.cpp:3926)\n[20] Error Object::emit_signal<>(StringName const&) (./core/object/object.h:923)\n[21] EditorFileSystem::_notification(int) (./editor/editor_file_system.cpp:1569)\n[22] EditorFileSystem::_notificationv(int, bool) (./editor/editor_file_system.h:143)\n[23] Object::notification(int, bool) (./core/object/object.cpp:873)\n[24] SceneTree::_process_group(SceneTree::ProcessGroup*, bool) (./scene/main/scene_tree.cpp:1020)\n[25] SceneTree::_process(bool) (./scene/main/scene_tree.cpp:1097)\n[26] SceneTree::process(double) (./scene/main/scene_tree.cpp:580)\n[27] Main::iteration() (main/main.cpp:4338)\n[28] OS_Windows::run() (platform/windows/os_windows.cpp:1772)\n[29] widechar_main(int, wchar_t**) (platform/windows/godot_windows.cpp:180)\n[30] _main() (platform/windows/godot_windows.cpp:206)\n[31] main (platform/windows/godot_windows.cpp:225)\n[32] __tmainCRTStartup (C:/M/B/src/mingw-w64/mingw-w64-crt/crt/crtexe.c:267)\n[33] WinMainCRTStartup (C:/M/B/src/mingw-w64/mingw-w64-crt/crt/crtexe.c:157)\n-- END OF BACKTRACE --\n================================================================\n```\n\n</details>\n\n<br>\n\nThe errors are the same (expect for the one i cited) and the backtrace looks similar from this [other issue](https://github.com/godotengine/godot/issues/97053#issuecomment-2492683547), the way to trigger is different but both needs the await to happen. A difference between these two is the fact this one happens in 4.4 dev 1 too but the other issue only in 4.4 dev 2 too me (the issue author said that happens in 4.3 too but i was unable to reproduce in this version). I'll try to bisect it.\nBisected to #94802, @Hilderin\n\n![Image](https://github.com/user-attachments/assets/01b8ca08-0262-4ab6-9ec4-262333a04e36)\n\n<br>\n\nFrom the pr content and the fact of the other issue won't be able to trigger in 4.4 dev 1 i don't think this is the root cause, looks like this just make the problem more easier to trigger, but that is for the gd team to judge.\n\nAlso i got more errors and a slight different backtrace:\n\n```\nres://addons/res_plugin/res_editor_plugin.gd:7 - Internal script error! Opcode: 6881383 (please report).\n\nres://addons/res_plugin/res_editor_plugin.gd:7 - Internal script error! Opcode: 7078000 (please report).\n\n# With a bit more of effort i'll be able to get a negative opcode by making the int have a overflow :D\nres://addons/res_plugin/res_editor_plugin.gd:7 - Internal script error! Opcode: 1759949832 (please report).\n  \nC:\\Users\\Matheus\\Downloads\\Godot Source\\modules/gdscript/gdscript_vm.cpp:1628 - Condition ' constructor_idx < 0 || constructor_idx >= _constructors_count ' is true. Breaking..:\nres://addons/res_plugin/res_editor_plugin.gd:7 - Internal script error! Opcode: 32 (please report).\n\nC:\\Users\\Matheus\\Downloads\\Godot Source\\modules/gdscript/gdscript_vm.cpp:1953 - Condition ' (ip + 3 + instr_arg_count) > _code_size ' is true. Breaking..:\nres://addons/res_plugin/res_editor_plugin.gd:7 - Bad address index.\n```\n\nThis backtrace was compiling with MSVC, the other from my first commentary was with MinGw, not sure if the compiler make difference because the other issue also has slight different backtraces with the same compiler.\n\n<details><summary>Backtrace</summary>\n\n```\n================================================================\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.3.rc.custom_build (b0a8b3a1ef4e2e5b070b89de047b00034bbab82b)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] strlen (minkernel\\crts\\ucrt\\src\\appcrt\\string\\amd64\\strlen.asm:58)\n[1] strlen (minkernel\\crts\\ucrt\\src\\appcrt\\string\\amd64\\strlen.asm:58)\n[2] String::copy_from (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\string\\ustring.cpp:296)\n[3] String::String (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\string\\ustring.cpp:2444)\n[4] StringName::operator String (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\string\\string_name.h:144)\n[5] GDScriptFunction::call (C:\\Users\\Matheus\\Downloads\\Godot Source\\modules\\gdscript\\gdscript_vm.cpp:1794)\n[6] GDScriptFunctionState::resume (C:\\Users\\Matheus\\Downloads\\Godot Source\\modules\\gdscript\\gdscript_function.cpp:218)\n[7] GDScriptFunctionState::_signal_callback (C:\\Users\\Matheus\\Downloads\\Godot Source\\modules\\gdscript\\gdscript_function.cpp:166)\n[8] MethodBindVarArgTR<GDScriptFunctionState,Variant>::call (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\method_bind.h:271)\n[9] Object::callp (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\object.cpp:808)\n[10] Callable::callp (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\variant\\callable.cpp:69)\n[11] CallableCustomBind::call (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\variant\\callable_bind.cpp:153)\n[12] Callable::callp (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\variant\\callable.cpp:58)\n[13] Object::emit_signalp (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\object.cpp:1188)\n[14] Node::emit_signalp (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\node.cpp:3896)\n[15] Object::emit_signal<> (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\object.h:936)\n[16] EditorFileSystem::_notification (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.cpp:1484)\n[17] EditorFileSystem::_notificationv (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.h:141)\n[18] Object::notification (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\object.cpp:873)\n[19] SceneTree::_process_group (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\scene_tree.cpp:965)\n[20] SceneTree::_process (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\scene_tree.cpp:1042)\n[21] SceneTree::process (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\scene_tree.cpp:528)\n[22] Main::iteration (C:\\Users\\Matheus\\Downloads\\Godot Source\\main\\main.cpp:4108)\n[23] OS_Windows::run (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\os_windows.cpp:1666)\n[24] widechar_main (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:181)\n[25] _main (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:206)\n[26] main (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:220)\n[27] WinMain (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:234)\n[28] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[29] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n================================================================\n```\n\n</details>\nThis issue has been assign to me but I'll not be able to resolve it. My PR only put in invidence another issue that was already there like @matheusmdx said. If you want, I can revert #94802 because I have no idea how `await` works in GDScript and no idea what a `Opcode` is.\nCC @godotengine/gdscript \nThought I'd look a bit into the debugger to maybe learn a bit about the VM stuff. What looked odd to me was that the `GDScriptFunctionState` that is resumed, seems faulty. Its `function` doesn't match its `state`. The state comes from the `\"refresh_filesystem\"` function but the function is `@implicit_new` (or sometimes just garbage values). The instruction pointer is thus beyond the end of the code of the function, no clue what we are executing there, but it might explain why there are so many different errors. On creation the function is correctly set to `refresh_filesystem` but when resuming it seems to have changed. The object id of the `GDScriptFunctionState` stayed consistent but the memory to which `function` points has changed.\n\nThis happens because since #73776 the editor loads plugin scripts ignoring the cache. If the autoload is initialized before the plugins (probably some multithreading involved here since it is very inconsistent) it loads the plugin script and calls to it. Then in the plugin script a GDScriptFunctionState is created when awaiting. This function state points to some memory with the GDScript function. When the editor force loads the plugin script afterwards the script gets reloaded and frees all its functions in the process. Now the function state points to freed memory (which sometime contains a correct other function afterwards). Reverting #73776 seems to fix it for me (25 tries without error) but that's not the right solution I'd guess. As for the correct solution: it's my first time looking at the VM, I have no clue \u00af\\\\\\_(\u30c4)\\_/\u00af (maybe having editor plugins loaded before setting up the scene tree idk)\n\n\nRelated to #86362\n@HolonProduction Not sure if this info can helps but the problem seems to be something with the signal emission. This issue and others like #97053 and #101059 all have the common thing the use of `await` keyword but #100985 throw the same errors and don't use await anywhere, so the only thing they have in common is the fact the error happens in the line related with a signal.\nLooking at https://github.com/godotengine/godot/issues/100985 the instruction pointer is also beyond the code size, but it doesn't receive the instruction pointer from a saved state, so there has to be a different cause with that issue. It just looks identical on the surface, because in both cases the VM starts executing memory that isn't Gdscript byte code (at least that's how I understand it), but there are different causes I'd say.", "created_at": "2025-02-07 15:18:05", "merge_commit_sha": "9554481830c6137955b3cf124fa58cdf86ab397a", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102530", "base_commit": "3f56b3b23916ff54a1715cb8444304ce3c50283d", "patch": "diff --git a/editor/debugger/script_editor_debugger.cpp b/editor/debugger/script_editor_debugger.cpp\nindex 1363fca3c2c9..c4242f7dff60 100644\n--- a/editor/debugger/script_editor_debugger.cpp\n+++ b/editor/debugger/script_editor_debugger.cpp\n@@ -543,7 +543,7 @@ void ScriptEditorDebugger::_parse_message(const String &p_msg, uint64_t p_thread\n \t\ttime_vals.push_back(oe.sec);\n \t\ttime_vals.push_back(oe.msec);\n \t\tbool e;\n-\t\tString time = String(\"%d:%02d:%02d:%04d\").sprintf(time_vals, &e);\n+\t\tString time = String(\"%d:%02d:%02d:%03d\").sprintf(time_vals, &e);\n \n \t\t// Rest of the error data.\n \t\tbool source_is_project_file = oe.source_file.begins_with(\"res://\");\n", "test_patch": "", "problem_statement": "push_warning/error show a leading 0 in the timestamp for the milliseconds\n### Tested versions\n\n- v4.4.beta.gentoo [a013481b0]\n\n### System information\n\nLinux Gentoo Wayland\n\n### Issue description\n\nI was doing some good-ol' push_warning() debugging of my project and I was getting confused why some warnings were suddenly delayed by 900 msec. As it turns out, the Editor prints an additional zero when printing the timestamp.\n\nObserved behaviour:\n```\nW 0:00:00:0990   main.gd:10 @ ticker(): TICK 37\nW 0:00:01:0007   main.gd:10 @ ticker(): TICK 38\n```\n\nExpected behaviour:\n```\nW 0:00:00:990   main.gd:10 @ ticker(): TICK 37\nW 0:00:01:007   main.gd:10 @ ticker(): TICK 38\n```\n\nThe most likely culprit for this is in : `ScriptEditorDebugger::_parse_message` with the offending line being `String time = String(\"%d:%02d:%02d:%04d\").sprintf(time_vals, &e);`\n\n\n### Steps to reproduce\n\nDo a bunch of push_warnings and/or push_errors and observe the millisecond field in the timestamp.\n\n### Minimal reproduction project (MRP)\n\n* Create a new scene\n* Attach the following script and run the scene\n\n```gdscript\nextends Node\n\nfunc _ready() -> void:\n\tticker()\n\nfunc ticker() -> void:\n\tfor i in range(1, 100):\n\t\tpush_warning('TICK ', i)\n\t\tpush_error('TICK ', i)\n\t\tawait get_tree().physics_frame\n\n\tget_tree().quit()\n```\n", "hints_text": "This is also present in all previous 4.x versions, introduced in:\n* https://github.com/godotengine/godot/pull/36244\n\nBack before 4.0\n\nSimple to solve by returning to the previous format of `\"%d:%02d:%02d:%03d\"`", "created_at": "2025-02-07 13:04:26", "merge_commit_sha": "fc8ec5a4cabd786b425ec48eb17e699b2ae83144", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102513", "base_commit": "36d90c73a843afa2807a0b8dcbfbf52bdb8a759c", "patch": "diff --git a/core/io/resource_uid.cpp b/core/io/resource_uid.cpp\nindex 8a8c86087d45..a73adf9d7478 100644\n--- a/core/io/resource_uid.cpp\n+++ b/core/io/resource_uid.cpp\n@@ -154,6 +154,19 @@ String ResourceUID::get_id_path(ID p_id) const {\n \tERR_FAIL_COND_V_MSG(p_id == INVALID_ID, String(), \"Invalid UID.\");\n \tMutexLock l(mutex);\n \tconst ResourceUID::Cache *cache = unique_ids.getptr(p_id);\n+\n+#if TOOLS_ENABLED\n+\t// On startup, the scan_for_uid_on_startup callback should be set and will\n+\t// execute EditorFileSystem::scan_for_uid, which scans all project files\n+\t// to reload the UID cache before the first scan.\n+\t// Note: EditorFileSystem::scan_for_uid sets scan_for_uid_on_startup to nullptr\n+\t//       once the first scan_for_uid is complete.\n+\tif (!cache && scan_for_uid_on_startup) {\n+\t\tscan_for_uid_on_startup();\n+\t\tcache = unique_ids.getptr(p_id);\n+\t}\n+#endif\n+\n \tERR_FAIL_COND_V_MSG(!cache, String(), vformat(\"Unrecognized UID: \\\"%s\\\".\", id_to_text(p_id)));\n \tconst CharString &cs = cache->cs;\n \treturn String::utf8(cs.ptr());\ndiff --git a/core/io/resource_uid.h b/core/io/resource_uid.h\nindex 6d96953fcc1d..2912168dcb4b 100644\n--- a/core/io/resource_uid.h\n+++ b/core/io/resource_uid.h\n@@ -37,6 +37,8 @@\n \n class FileAccess;\n \n+typedef void (*ResourceUIDScanForUIDOnStartup)();\n+\n class ResourceUID : public Object {\n \tGDCLASS(ResourceUID, Object)\n public:\n@@ -63,6 +65,8 @@ class ResourceUID : public Object {\n \tstatic void _bind_methods();\n \n public:\n+\tinline static ResourceUIDScanForUIDOnStartup scan_for_uid_on_startup = nullptr;\n+\n \tString id_to_text(ID p_id) const;\n \tID text_to_id(const String &p_text) const;\n \ndiff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex 2d10e4305eaa..4c5663c3b99f 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -48,6 +48,9 @@\n #include \"scene/resources/packed_scene.h\"\n \n EditorFileSystem *EditorFileSystem::singleton = nullptr;\n+int EditorFileSystem::nb_files_total = 0;\n+EditorFileSystem::ScannedDirectory *EditorFileSystem::first_scan_root_dir = nullptr;\n+\n //the name is the version, to keep compatibility with different versions of Godot\n #define CACHE_FILE_NAME \"filesystem_cache10\"\n \n@@ -237,16 +240,72 @@ EditorFileSystem::ScannedDirectory::~ScannedDirectory() {\n \t}\n }\n \n-void EditorFileSystem::_first_scan_filesystem() {\n-\tEditorProgress ep = EditorProgress(\"first_scan_filesystem\", TTR(\"Project initialization\"), 5);\n+void EditorFileSystem::_load_first_scan_root_dir() {\n \tRef<DirAccess> d = DirAccess::create(DirAccess::ACCESS_RESOURCES);\n \tfirst_scan_root_dir = memnew(ScannedDirectory);\n \tfirst_scan_root_dir->full_path = \"res://\";\n+\n+\tnb_files_total = _scan_new_dir(first_scan_root_dir, d);\n+}\n+\n+void EditorFileSystem::scan_for_uid() {\n+\t// Load file structure into memory.\n+\t_load_first_scan_root_dir();\n+\n+\t// Load extensions for which an .import should exists.\n+\tList<String> extensionsl;\n+\tHashSet<String> import_extensions;\n+\tResourceFormatImporter::get_singleton()->get_recognized_extensions(&extensionsl);\n+\tfor (const String &E : extensionsl) {\n+\t\timport_extensions.insert(E);\n+\t}\n+\n+\t// Scan the file system to load uid.\n+\t_scan_for_uid_directory(first_scan_root_dir, import_extensions);\n+\n+\t// It's done, resetting the callback method to prevent a second scan.\n+\tResourceUID::scan_for_uid_on_startup = nullptr;\n+}\n+\n+void EditorFileSystem::_scan_for_uid_directory(const ScannedDirectory *p_scan_dir, const HashSet<String> &p_import_extensions) {\n+\tfor (ScannedDirectory *scan_sub_dir : p_scan_dir->subdirs) {\n+\t\t_scan_for_uid_directory(scan_sub_dir, p_import_extensions);\n+\t}\n+\n+\tfor (const String &scan_file : p_scan_dir->files) {\n+\t\tconst String ext = scan_file.get_extension().to_lower();\n+\n+\t\tif (ext == \"uid\" || ext == \"import\") {\n+\t\t\tcontinue;\n+\t\t}\n+\n+\t\tconst String path = p_scan_dir->full_path.path_join(scan_file);\n+\t\tResourceUID::ID uid = ResourceUID::INVALID_ID;\n+\t\tif (p_import_extensions.has(ext)) {\n+\t\t\tif (FileAccess::exists(path + \".import\")) {\n+\t\t\t\tuid = ResourceFormatImporter::get_singleton()->get_resource_uid(path);\n+\t\t\t}\n+\t\t} else {\n+\t\t\tuid = ResourceLoader::get_resource_uid(path);\n+\t\t}\n+\n+\t\tif (uid != ResourceUID::INVALID_ID) {\n+\t\t\tif (!ResourceUID::get_singleton()->has_id(uid)) {\n+\t\t\t\tResourceUID::get_singleton()->add_id(uid, path);\n+\t\t\t}\n+\t\t}\n+\t}\n+}\n+\n+void EditorFileSystem::_first_scan_filesystem() {\n+\tEditorProgress ep = EditorProgress(\"first_scan_filesystem\", TTR(\"Project initialization\"), 5);\n \tHashSet<String> existing_class_names;\n \tHashSet<String> extensions;\n \n-\tep.step(TTR(\"Scanning file structure...\"), 0, true);\n-\tnb_files_total = _scan_new_dir(first_scan_root_dir, d);\n+\tif (!first_scan_root_dir) {\n+\t\tep.step(TTR(\"Scanning file structure...\"), 0, true);\n+\t\t_load_first_scan_root_dir();\n+\t}\n \n \t// Preloading GDExtensions file extensions to prevent looping on all the resource loaders\n \t// for each files in _first_scan_process_scripts.\n@@ -440,6 +499,7 @@ void EditorFileSystem::_scan_filesystem() {\n \t\tsd = first_scan_root_dir;\n \t\t// Will be updated on scan.\n \t\tResourceUID::get_singleton()->clear();\n+\t\tResourceUID::scan_for_uid_on_startup = nullptr;\n \t\tprocessed_files = memnew(HashSet<String>());\n \t} else {\n \t\tRef<DirAccess> d = DirAccess::create(DirAccess::ACCESS_RESOURCES);\ndiff --git a/editor/editor_file_system.h b/editor/editor_file_system.h\nindex 5b78b86a3f3f..4f9302e045f8 100644\n--- a/editor/editor_file_system.h\n+++ b/editor/editor_file_system.h\n@@ -182,7 +182,7 @@ class EditorFileSystem : public Node {\n \tstatic void _thread_func(void *_userdata);\n \n \tEditorFileSystemDirectory *new_filesystem = nullptr;\n-\tScannedDirectory *first_scan_root_dir = nullptr;\n+\tstatic ScannedDirectory *first_scan_root_dir;\n \n \tbool filesystem_changed_queued = false;\n \tbool scanning = false;\n@@ -192,13 +192,17 @@ class EditorFileSystem : public Node {\n \tfloat scan_total;\n \tString filesystem_settings_version_for_import;\n \tbool revalidate_import_files = false;\n-\tint nb_files_total = 0;\n+\tstatic int nb_files_total;\n \n \tvoid _notify_filesystem_changed();\n \tvoid _scan_filesystem();\n \tvoid _first_scan_filesystem();\n \tvoid _first_scan_process_scripts(const ScannedDirectory *p_scan_dir, List<String> &p_gdextension_extensions, HashSet<String> &p_existing_class_names, HashSet<String> &p_extensions);\n \n+\tstatic void _scan_for_uid_directory(const ScannedDirectory *p_scan_dir, const HashSet<String> &p_import_extensions);\n+\n+\tstatic void _load_first_scan_root_dir();\n+\n \tHashSet<String> late_update_files;\n \n \tvoid _save_late_updated_files();\n@@ -255,7 +259,7 @@ class EditorFileSystem : public Node {\n \tHashSet<String> valid_extensions;\n \tHashSet<String> import_extensions;\n \n-\tint _scan_new_dir(ScannedDirectory *p_dir, Ref<DirAccess> &da);\n+\tstatic int _scan_new_dir(ScannedDirectory *p_dir, Ref<DirAccess> &da);\n \tvoid _process_file_system(const ScannedDirectory *p_scan_dir, EditorFileSystemDirectory *p_dir, ScanProgress &p_progress, HashSet<String> *p_processed_files);\n \n \tThread thread_sources;\n@@ -412,6 +416,8 @@ class EditorFileSystem : public Node {\n \n \tstatic bool _should_skip_directory(const String &p_path);\n \n+\tstatic void scan_for_uid();\n+\n \tvoid add_import_format_support_query(Ref<EditorFileSystemImportFormatSupportQuery> p_query);\n \tvoid remove_import_format_support_query(Ref<EditorFileSystemImportFormatSupportQuery> p_query);\n \tEditorFileSystem();\ndiff --git a/main/main.cpp b/main/main.cpp\nindex c65e6ba8acb4..6cd9c89fa8b7 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -3444,6 +3444,17 @@ Error Main::setup2(bool p_show_boot_logo) {\n \t// This loads global classes, so it must happen before custom loaders and savers are registered\n \tScriptServer::init_languages();\n \n+#if TOOLS_ENABLED\n+\n+\t// Setting up the callback to execute a scan for UIDs on disk when a UID\n+\t// does not exist in the UID cache on startup. This prevents invalid UID errors\n+\t// when opening a project without a UID cache file or with an invalid cache.\n+\tif (editor) {\n+\t\tResourceUID::scan_for_uid_on_startup = EditorFileSystem::scan_for_uid;\n+\t}\n+\n+#endif\n+\n \ttheme_db->initialize_theme();\n \taudio_server->load_default_bus_layout();\n \n@@ -3496,9 +3507,21 @@ void Main::setup_boot_logo() {\n \n \tif (show_logo) { //boot logo!\n \t\tconst bool boot_logo_image = GLOBAL_DEF_BASIC(\"application/boot_splash/show_image\", true);\n-\t\tconst String boot_logo_path = ResourceUID::ensure_path(GLOBAL_DEF_BASIC(PropertyInfo(Variant::STRING, \"application/boot_splash/image\", PROPERTY_HINT_FILE, \"*.png\"), String())).strip_edges();\n \t\tconst bool boot_logo_scale = GLOBAL_DEF_BASIC(\"application/boot_splash/fullsize\", true);\n \t\tconst bool boot_logo_filter = GLOBAL_DEF_BASIC(\"application/boot_splash/use_filter\", true);\n+\t\tString boot_logo_path = GLOBAL_DEF_BASIC(PropertyInfo(Variant::STRING, \"application/boot_splash/image\", PROPERTY_HINT_FILE, \"*.png\"), String());\n+\n+\t\t// If the UID cache is missing or invalid, it could be 'normal' for the UID to not exist in memory.\n+\t\t// It's too soon to scan the project files since the ResourceFormatImporter is not loaded yet,\n+\t\t// so to prevent printing errors, we will just skip the custom boot logo this time.\n+\t\tif (boot_logo_path.begins_with(\"uid://\")) {\n+\t\t\tconst ResourceUID::ID logo_id = ResourceUID::get_singleton()->text_to_id(boot_logo_path);\n+\t\t\tif (ResourceUID::get_singleton()->has_id(logo_id)) {\n+\t\t\t\tboot_logo_path = ResourceUID::get_singleton()->get_id_path(logo_id).strip_edges();\n+\t\t\t} else {\n+\t\t\t\tboot_logo_path = String();\n+\t\t\t}\n+\t\t}\n \n \t\tRef<Image> boot_logo;\n \n@@ -4215,7 +4238,7 @@ int Main::start() {\n \n #ifdef TOOLS_ENABLED\n \t\t\tif (editor) {\n-\t\t\t\tif (!recovery_mode && (game_path != String(GLOBAL_GET(\"application/run/main_scene\")) || !editor_node->has_scenes_in_session())) {\n+\t\t\t\tif (!recovery_mode && (game_path != ResourceUID::ensure_path(String(GLOBAL_GET(\"application/run/main_scene\"))) || !editor_node->has_scenes_in_session())) {\n \t\t\t\t\tError serr = editor_node->load_scene(local_game_path);\n \t\t\t\t\tif (serr != OK) {\n \t\t\t\t\t\tERR_PRINT(\"Failed to load scene\");\n", "test_patch": "", "problem_statement": "[4.4.dev7] The `Default Environment` setting is reset after the \"cold\" project loading (`res://` | `uid://` issue)\n### Tested versions\n\n- reproducible in 4.4.dev7 (maybe 4.4.x)\n- not reproducible: 4.3.stable\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6636) - 12th Gen Intel(R) Core(TM) i5-12400 (12 threads)\n\n### Issue description\n\nThe default environment setting (`rendering/environment/defaults/default_environment`) is reset after the **\"cold\"** project loading (deleting the `.godot` folder and loading project for the first time). However, it stays on place if it was saved as `res://...` path, not as `uid://...` value. Seems like `uid` related bug.\n\n### Steps to reproduce\n\nSteps for 4.4.dev7: \n- create new project;\n- create an `Environment` asset;\n- set it as default in `Project Settings`;\n- close the project;\n- delete the `.godot` folder;\n- open the project.\n\nNot reproduced with 4.3 -> 4.4 migration because its value will still be saved as `res://`, not `uid://`.\n\n### Minimal reproduction project (MRP)\n\n[test.zip](https://github.com/user-attachments/files/18270863/test.zip)\n\n", "hints_text": "Seems like the `Main Scene` (`run/main_scene`) setting has a similar issue: Godot will not open the `Main Scene` after the \"cold\" loading if it is saved as `uid://` value, but open perfectly fine if it is saved as `res://`. Shoud I create a separate issue for that? Pretty sure it is the same, but in theory can require a fix in several places.\nP.S.: The `Main Scene` setting is automatically replaced with `uid` after manually changing it to `res`.\nThis maybe due to running scan of filesystem after loading environment and main scene, or something like what. Needs investigating\nThe environment is loaded in SceneTree constructor, which happens before any filesystem scan that could load the UID. And interestingly, the code deletes the settting if file can't be found.\nhttps://github.com/godotengine/godot/blob/9630d4e2fc1d0fdef6f46f24e236548549f31d49/scene/main/scene_tree.cpp#L1970-L1984\nAfter analyzing the problem further, I have identified a few related issues and concerns:\n\n1. Before the first scan, the only source to link a UID to a path is the UID cache, which presents several issues:\n   - CI/CD will not function properly without the cache file being included in source control.\n   - If a file is moved outside the editor (e.g., due to a Git pull while the editor is closed), the correct paths will not be available when the editor starts.\n   - Any attempt to access a UID before the first scan will fail.\n\n2. There is a missing `ResourceUID::ensure_path(` call in the comparison within `main.cpp`:\n   The line `game_path != String(GLOBAL_GET(\"application/run/main_scene\"))` should include this call to ensure the UID is converted in the same way as when `game_path` is initialized.\n\nI seriously believe that the only way to ensure the UID cache is up to date is to reload the UID files before the first call to `ResourceUID::path_to_uid`. One possible solution is to make `EditorFileSystem::_scan_new_dir` a static method and invoke it in `main.cpp`. By storing the `ScannedDirectory`, we could reuse it in `EditorFileSystem::_first_scan_filesystem`, thus preventing a double scan. \n\nHowever, the main challenge with this approach is that it will be difficult to display a progress bar during the first scan, as the main window is created after the initial call to `ResourceUID::path_to_uid`. Maybe creating a temporaire small loading window could be an idea.\nAfter a bit more investigating, this approach will not work perfectly. The main issue is the possibility to have custom `ResourceLoader` with custom `get_resource_uid` methods from plugins and GDExtensions. I guess it would be difficult to load these plugins sooner in the editor startup. So the best approach should probably be to refactor the code the load the resource after the `EditorFileSystem` first scan when in the Editor. It's just very difficult to find every places the access `ResourceUid` before the first scan.", "created_at": "2025-02-07 03:06:27", "merge_commit_sha": "94b7399176c0ed4b07c65b49ff5bad6bd76b3781", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102454", "base_commit": "c394eaa45c8ed3b343fb5126b5381a659cfb6564", "patch": "diff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9716a42c97b9..055fcbeda64f 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -721,7 +721,6 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t_check_transfer_worker_buffer(buffer);\n \n \tBufferGetDataRequest get_data_request;\n-\tuint32_t flushed_copies = 0;\n \tget_data_request.callback = p_callback;\n \tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n \tget_data_request.size = p_size;\n@@ -738,22 +737,26 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\treturn err;\n \t\t}\n \n-\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n+\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\tif (flush_frames) {\n \t\t\tif (_buffer_make_mutable(buffer, p_buffer)) {\n \t\t\t\t// The buffer must be mutable to be used as a copy source.\n \t\t\t\tdraw_graph.add_synchronization();\n \t\t\t}\n \n-\t\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t\t}\n-\n-\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t}\n \n \t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\tif (flush_frames) {\n+\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n+\t\t}\n+\n \t\tRDD::BufferCopyRegion region;\n \t\tregion.src_offset = submit_from + p_offset;\n \t\tregion.dst_offset = block_write_offset;\n@@ -775,7 +778,7 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\tdraw_graph.add_synchronization();\n \t\t}\n \n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t}\n@@ -2098,7 +2101,6 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \tuint32_t block_write_offset;\n \tuint32_t block_write_amount;\n \tStagingRequiredAction required_action;\n-\tuint32_t flushed_copies = 0;\n \tfor (uint32_t i = 0; i < tex->mipmaps; i++) {\n \t\tuint32_t image_total = get_image_format_required_size(tex->format, tex->width, tex->height, tex->depth, i + 1, &w, &h, &d);\n \t\tuint32_t tight_mip_size = image_total - mipmap_offset;\n@@ -2119,17 +2121,21 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t\t\t\t\tError err = _staging_buffer_allocate(download_staging_buffers, to_allocate, required_align, block_write_offset, block_write_amount, required_action, false);\n \t\t\t\t\tERR_FAIL_COND_V(err, ERR_CANT_CREATE);\n \n-\t\t\t\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n-\t\t\t\t\t\tfor (uint32_t j = flushed_copies; j < get_data_request.frame_local_count; j++) {\n+\t\t\t\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tfor (uint32_t j = 0; j < get_data_request.frame_local_count; j++) {\n \t\t\t\t\t\t\tuint32_t local_index = get_data_request.frame_local_index + j;\n \t\t\t\t\t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t\t\t\t}\n \n \t\t\t\t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\t\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_texture_copy_regions.size();\n+\t\t\t\t\t}\n+\n \t\t\t\t\tRDD::BufferTextureCopyRegion copy_region;\n \t\t\t\t\tcopy_region.buffer_offset = block_write_offset;\n \t\t\t\t\tcopy_region.texture_subresources.aspect = tex->read_aspect_flags;\n@@ -2154,12 +2160,11 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t}\n \n \tif (get_data_request.frame_local_count > 0) {\n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t}\n \n-\t\tflushed_copies = get_data_request.frame_local_count;\n \t\tframes[frame].download_texture_get_data_requests.push_back(get_data_request);\n \t}\n \n", "test_patch": "", "problem_statement": "Editor crashes when callback for `RD::texture_get_data_async` is an empty method\n\n\n### Tested versions\n\n- Reproducable in 4.4-beta2, 4.4-beta1, 4.4-dev7\n\n(All versions with [#100110](https://github.com/godotengine/godot/pull/100110))\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 22631) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6094) - 12th Gen Intel(R) Core(TM) i5-12400F (12 threads)\n\n### Issue description\n\nWhen calling `RD::texture_get_data_async` from a tool script on every process and passing a callback to an empty method the Editor crashes after about 5 seconds.\n\n```\nERROR: FATAL: Index p_index = 8278 is out of bounds (count = 82).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nCrashHandlerException: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta2.official (a013481b0911e59cc3f3dea7ebb732450c3e1460)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n\n(no backtrace.. same with --verbose)\n```\n\nRunning the game does not trigger the crash. It only seems to be happening in the editor.\n\nHaving something happen in the callback also doesn't seem to trigger the crash or perhaps delays it to great extend. I doubt that the empty callback is the root cause. It probably just triggers whatever is wrong with using it in the editor faster. Though, I'm speculating here.\n\nIf this wasn't intended to work in the editor, there should be a guard.\n\n### Steps to reproduce\n\n- Uncommennt `@tool` at the top of node.gd\n- save\n- reopen the scene\n- switch to 2D\n- wait for about 5s\n\nAlso try uncommenting the print statement in the callback. That seems to stop the crash.\n\n### Minimal reproduction project (MRP)\n\n[texture-get-data-async-empty-callback-editor-crash.zip](https://github.com/user-attachments/files/18656439/texture-get-data-async-empty-callback-editor-crash.zip)\n", "hints_text": "Also crashes on my Linux install.\n\n\nGodot v4.4.beta2 - Debian GNU/Linux 12 (bookworm) 12 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) UHD Graphics 620 (WHL GT2) - Intel(R) Core(TM) i5-8365U CPU @ 1.60GHz (8 threads)\n\n```\nERROR: FATAL: Index p_index = 8469 is out of bounds (count = 171).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nhandle_crash: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta2.official (a013481b0911e59cc3f3dea7ebb732450c3e1460)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] /lib/x86_64-linux-gnu/libc.so.6(+0x3c050) [0x7f152fc99050] (??:0)\n[2] /home/henry/godot44.x86_64() [0x3d88fb6] (??:0)\n[3] /home/henry/godot44.x86_64() [0x3e14b80] (??:0)\n[4] /home/henry/godot44.x86_64() [0xb822bf] (??:0)\n[5] /home/henry/godot44.x86_64() [0xa087e6] (??:0)\n[6] /home/henry/godot44.x86_64() [0x28a33ba] (??:0)\n[7] /home/henry/godot44.x86_64() [0x4735d08] (??:0)\n[8] /home/henry/godot44.x86_64() [0x28b42ac] (??:0)\n[9] /home/henry/godot44.x86_64() [0x29032a3] (??:0)\n[10] /home/henry/godot44.x86_64() [0x29038c9] (??:0)\n[11] /home/henry/godot44.x86_64() [0x50ea5d] (??:0)\n[12] /home/henry/godot44.x86_64() [0x4208c3] (??:0)\n[13] /lib/x86_64-linux-gnu/libc.so.6(+0x2724a) [0x7f152fc8424a] (??:0)\n[14] /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x85) [0x7f152fc84305] (??:0)\n[15] /home/henry/godot44.x86_64() [0x44359a] (??:0)\n-- END OF BACKTRACE --\n================================================================\n```\nConfirmed in the current `master` branch (eee39f004b42a4948af90cdebedf65c34a4a4970). Backtrace:\n```\nERROR: FATAL: Index p_index = 8304 is out of bounds (count = 56).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nhandle_crash: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta.custom_build (eee39f004b42a4948af90cdebedf65c34a4a4970)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] /lib64/libc.so.6(+0x1a050) [0x7f7351eaf050] (??:0)\n[2] LocalVector<RenderingDeviceDriver::BufferTextureCopyRegion, unsigned int, false, false>::operator[](unsigned int) (/home/akien/Godot/godot/./core/templates/local_vector.h:178 (discriminator 2))\n[3] RenderingDevice::texture_get_data_async(RID, unsigned int, Callable const&) (/home/akien/Godot/godot/./servers/rendering/rendering_device.cpp:2159 (discriminator 1))\n[4] void call_with_validated_variant_args_ret_helper<__UnexistingClass, Error, RID, unsigned int, Callable const&, 0ul, 1ul, 2ul>(__UnexistingClass*, Error (__UnexistingClass::*)(RID, unsigned int, Callable const&), Variant const**, Variant*, IndexSequence<0ul, 1ul, 2ul>) (/home/akien/Godot/godot/./core/variant/binder_common.h:386 (discriminator 3))\n[5] void call_with_validated_object_instance_args_ret<__UnexistingClass, Error, RID, unsigned int, Callable const&>(__UnexistingClass*, Error (__UnexistingClass::*)(RID, unsigned int, Callable const&), Variant const**, Variant*) (/home/akien/Godot/godot/./core/variant/binder_common.h:674)\n[6] MethodBindTR<Error, RID, unsigned int, Callable const&>::validated_call(Object*, Variant const**, Variant*) const (/home/akien/Godot/godot/./core/object/method_bind.h:538)\n[7] GDScriptFunction::call(GDScriptInstance*, Variant const**, int, Callable::CallError&, GDScriptFunction::CallState*) (/home/akien/Godot/godot/./modules/gdscript/gdscript_vm.cpp:2247)\n[8] GDScriptInstance::callp(StringName const&, Variant const**, int, Callable::CallError&) (/home/akien/Godot/godot/./modules/gdscript/gdscript.cpp:2073 (discriminator 1))\n[9] Node::_gdvirtual__process_call(double) (/home/akien/Godot/godot/./scene/main/node.h:387 (discriminator 2))\n[10] Node::_notification(int) (/home/akien/Godot/godot/./scene/main/node.cpp:56)\n[11] Node::_notificationv(int, bool) (/home/akien/Godot/godot/./scene/main/node.h:49 (discriminator 14))\n[12] Object::notification(int, bool) (/home/akien/Godot/godot/./core/object/object.cpp:914)\n[13] SceneTree::_process_group(SceneTree::ProcessGroup*, bool) (/home/akien/Godot/godot/./scene/main/scene_tree.cpp:1060)\n[14] SceneTree::_process(bool) (/home/akien/Godot/godot/./scene/main/scene_tree.cpp:1132 (discriminator 2))\n[15] SceneTree::process(double) (/home/akien/Godot/godot/./scene/main/scene_tree.cpp:580)\n[16] Main::iteration() (/home/akien/Godot/godot/main/main.cpp:4473 (discriminator 3))\n[17] OS_LinuxBSD::run() (/home/akien/Godot/godot/platform/linuxbsd/os_linuxbsd.cpp:962 (discriminator 1))\n[18] godot-git(main+0x14b) [0x66347f1] (/home/akien/Godot/godot/platform/linuxbsd/godot_linuxbsd.cpp:85)\n[19] /lib64/libc.so.6(+0x3248) [0x7f7351e98248] (??:0)\n[20] /lib64/libc.so.6(__libc_start_main+0x8b) [0x7f7351e9830b] (??:0)\n[21] godot-git(_start+0x25) [0x66345e5] (??:?)\n-- END OF BACKTRACE --\n================================================================\n```\n\nIt's only reproducible in 4.4+ as the API doesn't exist in 4.3. The method was introduced in 4.4.dev7 with #100110 and that version crashes too.\n\nSpamming this function in `_process` definitely doesn't sound like a good idea and a supported use case, but it shouldn't crash.\n\nCC @DarioSamo @clayjohn \n> Spamming this function in _process definitely doesn't sound like a good idea and a supported use case, but it shouldn't crash.\n\n@akien-mga I'm working on NDI Output for Godot, so I need the texture every frame. ~~Is there a better place to call it from? Like on a draw notification/signal?~~ Now that you mention it, calling it every process doesn't make sense. The RenderingServer emits `frame_post_draw`. That'd be a better time to call the function.\nThis could be unrelated, but let's say I call `RD::texture_get_data_async` to request texture data, but in the meantime the Object/Node that owns the method pointed to by the Callable gets freed / deconstructed. Would that cause a crash? I think that's what I'm seeing here now that I'm calling it on `RenderingServer::frame_post_draw` instead of on every process.\n\n```\nrequest texture\nreceive texture\nrequest texture\nreceive texture\ndeconstructed!\nreceive texture <-- note this\n\n================================================================\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.4.beta.custom_build (0b6a717ac17f1d6bd7963740cf2c2128b36ff7aa)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] <couldn't map PC to fn name>\n[1] <couldn't map PC to fn name>\n[2] <couldn't map PC to fn name>\n[3] <couldn't map PC to fn name>\n[4] CallableCustomExtension::call (C:\\Users\\Henry\\Documents\\godot\\core\\extension\\gdextension_interface.cpp:173)\n[5] Callable::callp (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\callable.cpp:58)\n[6] CallableCustomBind::call (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\callable_bind.cpp:151)\n[7] Callable::callp (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\callable.cpp:58)\n[8] Callable::call<Vector<unsigned char> > (C:\\Users\\Henry\\Documents\\godot\\core\\variant\\variant.h:961)\n[9] RenderingDevice::_stall_for_frame (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_device.cpp:6575)\n[10] RenderingDevice::_begin_frame (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_device.cpp:6353)\n[11] RenderingDevice::swap_buffers (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_device.cpp:6223)\n[12] RenderingServerDefault::_draw (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_server_default.cpp:91)\n[13] RenderingServerDefault::draw (C:\\Users\\Henry\\Documents\\godot\\servers\\rendering\\rendering_server_default.cpp:417)\n[14] Main::iteration (C:\\Users\\Henry\\Documents\\godot\\main\\main.cpp:4490)\n[15] OS_Windows::run (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\os_windows.cpp:2062)\n[16] widechar_main (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\godot_windows.cpp:97)\n[17] _main (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\godot_windows.cpp:124)\n[18] main (C:\\Users\\Henry\\Documents\\godot\\platform\\windows\\godot_windows.cpp:136)\n[19] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[20] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n================================================================\n```\n\n> This could be unrelated, but let's say I call `RD::texture_get_data_async` to request texture data, but in the meantime the Object/Node that owns the method pointed to by the Callable gets freed / deconstructed. Would that cause a crash? I think that's what I'm seeing here now that I'm calling it on `RenderingServer::frame_post_draw` instead of on every process.\n\nThat'd likely lead to a crash yes. You're responsible for the lifetime of your objects and you shouldn't destroy them until the callback comes back.\n\nYou could easily work around that by handing off that responsibility to an object that always lives and is in charge of redirecting the data to the object.\n\nThat said, I'll still investigate the original stack trace to see if it can be reproduced in the situation that was mentioned in the OP first.", "created_at": "2025-02-05 12:50:41", "merge_commit_sha": "2687833dec98903d4365b7c183e7c3079635f9cb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102401", "base_commit": "f0f5319b0b5b56db9f8023ac4132088df9e86b9e", "patch": "diff --git a/modules/gdscript/gdscript_editor.cpp b/modules/gdscript/gdscript_editor.cpp\nindex cccfff6a8449..062d522b6818 100644\n--- a/modules/gdscript/gdscript_editor.cpp\n+++ b/modules/gdscript/gdscript_editor.cpp\n@@ -3956,10 +3956,14 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t} else {\n \t\t\t\t\t\t\tconst int dot_pos = doc_enum_name.rfind_char('.');\n \t\t\t\t\t\t\tif (dot_pos >= 0) {\n+\t\t\t\t\t\t\t\tError err = OK;\n \t\t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n-\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n-\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\tif (base_type.class_type != nullptr) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = GDScriptCache::get_shallow_script(base_type.script_path, err);\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n \t\t\t\t\t\t\t\t\tconst String enum_name = doc_enum_name.substr(dot_pos + 1);\n \t\t\t\t\t\t\t\t\tif (base_type.class_type->has_member(enum_name)) {\n \t\t\t\t\t\t\t\t\t\tconst GDScriptParser::ClassNode::Member member = base_type.class_type->get_member(enum_name);\n@@ -3972,8 +3976,19 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t} else if (base_type.script_type.is_valid()) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = base_type.script_type;\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n+\t\t\t\t\t\t\t\t\t// TODO: Find a way to obtain enum value location for a script\n+\t\t\t\t\t\t\t\t\tr_result.location = base_type.script_type->get_member_line(doc_enum_name.substr(dot_pos + 1));\n+\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\treturn OK;\n+\t\t\t\t\t\t\t\treturn err;\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t} else if (Variant::has_builtin_method(Variant::DICTIONARY, p_symbol)) {\n", "test_patch": "", "problem_statement": "Ctrl-Click on enum value/member does nothing\n### Tested versions\n\n- reproducible in: 4.4.dev7\n- reproducible on master (tested with a 03-Jan-2025 build - `v4.4.dev.gh-101012 [c37ada786]`)\n- works in: 4.4.dev6\n\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nI mentioned this here: https://github.com/godotengine/godot/issues/100680#issuecomment-2557966392\nWhile general control-click was restored with https://github.com/godotengine/godot/pull/100707 the enum issue remains.\n\nCTRL-clicking on an enum value/member does nothing (well, it actually navigates to the beginning of the line).\n\nE.g. enum like this:\n```\nclass_name E extends Object\n\nenum Team {\n\tNone,\n\tOne,\n}\n\nfunc test():\n\tvar t = E.Team.None\n```\nand CTRL-clicking on the `None` of `E.Team.None` does not take you to the `None` under `enum Team`.\n\n\n### Steps to reproduce\n\nOpen enum.gd in MRP - same code as in description.\n\n### Minimal reproduction project (MRP)\n\n[44dev7enum.zip](https://github.com/user-attachments/files/18303044/44dev7enum.zip)\n\n", "hints_text": "Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. \n\nhttps://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n\nIt seems that changing the class's documentation updates something and it suddenly works.\n\nI couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n> Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. https://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n> \n> It seems that changing the class's documentation updates something and it suddenly works.\n> \n> I couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n\nYes, ctrl-click change https://github.com/godotengine/godot/pull/100707 went into master after dev7.\n\nOkay that makes sense but still that behavior where adding documentation effects Ctrl+click is very weird... can you reproduce it on your computer?", "created_at": "2025-02-04 09:29:03", "merge_commit_sha": "54ffb8ab3e62cabbc62421381b63751890b42774", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102389", "base_commit": "f0f5319b0b5b56db9f8023ac4132088df9e86b9e", "patch": "diff --git a/modules/gdscript/gdscript_analyzer.cpp b/modules/gdscript/gdscript_analyzer.cpp\nindex 60109efc4d5b..99fab724e8da 100644\n--- a/modules/gdscript/gdscript_analyzer.cpp\n+++ b/modules/gdscript/gdscript_analyzer.cpp\n@@ -1093,7 +1093,12 @@ void GDScriptAnalyzer::resolve_class_member(GDScriptParser::ClassNode *p_class,\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (is_get_node) {\n-\t\t\t\t\t\t\tparser->push_warning(member.variable, GDScriptWarning::GET_NODE_DEFAULT_WITHOUT_ONREADY, is_using_shorthand ? \"$\" : \"get_node()\");\n+\t\t\t\t\t\t\tString offending_syntax = \"get_node()\";\n+\t\t\t\t\t\t\tif (is_using_shorthand) {\n+\t\t\t\t\t\t\t\tGDScriptParser::GetNodeNode *get_node_node = static_cast<GDScriptParser::GetNodeNode *>(expr);\n+\t\t\t\t\t\t\t\toffending_syntax = get_node_node->use_dollar ? \"$\" : \"%\";\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tparser->push_warning(member.variable, GDScriptWarning::GET_NODE_DEFAULT_WITHOUT_ONREADY, offending_syntax);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n", "test_patch": "diff --git a/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.gd b/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.gd\nindex c1776fe1b4d0..5feb1ad4e765 100644\n--- a/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.gd\n+++ b/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var add_node = do_add_node() # Hack to have one node on init and not fail at runtime.\n+var add_node = do_add_nodes() # Hack to have nodes on init and not fail at runtime.\n \n var shorthand = $Node\n var with_self = self.get_node(^\"Node\")\n@@ -8,11 +8,23 @@ var without_self = get_node(^\"Node\")\n var with_cast = get_node(^\"Node\") as Node\n var shorthand_with_cast = $Node as Node\n \n+var shorthand_unique = %UniqueNode\n+var shorthand_in_dollar_unique = $\"%UniqueNode\"\n+var without_self_unique = get_node(^\"%UniqueNode\")\n+var shorthand_with_cast_unique = %UniqueNode as Node\n+\n func test():\n \tprint(\"warn\")\n \n-func do_add_node():\n+func do_add_nodes():\n \tvar node = Node.new()\n \tnode.name = \"Node\"\n \t@warning_ignore(\"unsafe_call_argument\")\n \tadd_child(node)\n+\n+\tvar unique_node = Node.new()\n+\tunique_node.name = \"UniqueNode\"\n+\t@warning_ignore(\"unsafe_call_argument\")\n+\tadd_child(unique_node)\n+\tunique_node.owner = self\n+\tunique_node.unique_name_in_owner = true\ndiff --git a/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.out b/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.out\nindex ad92088a1273..fcfa7b3c45cf 100644\n--- a/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.out\n+++ b/modules/gdscript/tests/scripts/analyzer/warnings/get_node_without_onready.out\n@@ -4,4 +4,8 @@ GDTEST_OK\n ~~ WARNING at line 7: (GET_NODE_DEFAULT_WITHOUT_ONREADY) The default value is using \"get_node()\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this.\n ~~ WARNING at line 8: (GET_NODE_DEFAULT_WITHOUT_ONREADY) The default value is using \"get_node()\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this.\n ~~ WARNING at line 9: (GET_NODE_DEFAULT_WITHOUT_ONREADY) The default value is using \"$\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this.\n+~~ WARNING at line 11: (GET_NODE_DEFAULT_WITHOUT_ONREADY) The default value is using \"%\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this.\n+~~ WARNING at line 12: (GET_NODE_DEFAULT_WITHOUT_ONREADY) The default value is using \"$\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this.\n+~~ WARNING at line 13: (GET_NODE_DEFAULT_WITHOUT_ONREADY) The default value is using \"get_node()\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this.\n+~~ WARNING at line 14: (GET_NODE_DEFAULT_WITHOUT_ONREADY) The default value is using \"%\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this.\n warn\n", "problem_statement": "\"The default value is using \"$\" which won't return nodes...\" warning despite using Unique Name (\"%\")\n### Tested versions\n\n- Reproducible in v4.4.beta.custom_build [eee39f004]\n\n### System information\n\nGodot v4.4.beta (eee39f004) - macOS Sequoia (15.3.0) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon Pro 5500 XT OpenGL Engine - Intel(R) Core(TM) i7-10700K CPU @ 3.80GHz (16 threads)\n\n### Issue description\n\nThe error message for attempting to access a unique-named node in a class body without the `@onready` annotation is slightly incorrect - it claims the user is using \"$\", when in reality the user is using \"%\".\n\n![Image](https://github.com/user-attachments/assets/9ba9b6f5-1bf6-40f2-a5a8-1ab799010175)\n\n \n\n### Steps to reproduce\n\nIn a new GDScript file, on the class level, type the following:\n```gdscript\nvar something = %Hello\n```\n\nYou will get an error like\n```\nThe default value is using \"$\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this. (Warning treated as error.)gdscript(-1)\n```\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-02-04 01:37:57", "merge_commit_sha": "83b3c1e11eac0ab224fb3c1a31dc78398427ef5b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102312", "base_commit": "1586c5674bbafe1d7f4bd457d446f132b475890c", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex d96ee851374e..6cc54ab34c97 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -230,6 +230,8 @@ void GameView::_instance_starting(int p_idx, List<String> &r_arguments) {\n \t\twindow_wrapper->set_window_title(appname);\n \n \t\t_show_update_window_wrapper();\n+\n+\t\tembedded_process->grab_focus();\n \t}\n \n \t_update_arguments_for_instance(p_idx, r_arguments);\n", "test_patch": "", "problem_statement": "Floating game window doesn't get focus when launched\n### Tested versions\n\nGodot v4.4.beta2\n\n### System information\n\nFedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nFloating game window doesn't get focus when launched. \nThe editor behind still has focus so if you have script open you will accidentally edit the script.\n\nhttps://github.com/user-attachments/assets/5b4bea64-89b8-4f38-954b-770208a80159\n\nIn 4.4.beta1 the game window has focus correctly first time you launch it, but after that it behaves same as beta2\n\n### Steps to reproduce\n\nHave script open \nLaunch scene\nPress some buttons\nSwitch back to the script and see that you have typed in the script\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-02-02 02:18:03", "merge_commit_sha": "bbf29a537f3d2875bba4304b1543d4bf0278b6d9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102260", "base_commit": "1586c5674bbafe1d7f4bd457d446f132b475890c", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex b1156f61a3d9..e29d7424c5f3 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1959,18 +1959,12 @@ void FileSystemDock::_move_operation_confirm(const String &p_to_path, bool p_cop\n \t}\n \n \tif (p_copy) {\n-\t\tbool is_copied = false;\n \t\tfor (int i = 0; i < to_move.size(); i++) {\n \t\t\tif (to_move[i].path != new_paths[i]) {\n \t\t\t\t_try_duplicate_item(to_move[i], new_paths[i]);\n \t\t\t\tselect_after_scan = new_paths[i];\n-\t\t\t\tis_copied = true;\n \t\t\t}\n \t\t}\n-\n-\t\tif (is_copied) {\n-\t\t\t_rescan();\n-\t\t}\n \t} else {\n \t\t// Check groups.\n \t\tfor (int i = 0; i < to_move.size(); i++) {\n", "test_patch": "", "problem_statement": "Crash when duplicating file with Ctrl+Drag and drop\n### Tested versions\n\n4.4 dev7, dev6, didn't test earlier\n\n### System information\n\nW10\n\n### Issue description\n\n```\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.4.dev.custom_build (d2ada64a03d2abdb97cafe8f10623db8a2ce1d4c)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] std::_Atomic_storage<unsigned __int64,8>::load (C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.39.33519\\include\\atomic:1121)\n[1] std::_Atomic_storage<unsigned __int64,8>::load (C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.39.33519\\include\\atomic:1121)\n[2] SafeNumeric<unsigned __int64>::conditional_increment (C:\\godot_source\\core\\templates\\safe_refcount.h:139)\n[3] CowData<char32_t>::_ref (C:\\godot_source\\core\\templates\\cowdata.h:502)\n[4] String::String (C:\\godot_source\\core\\string\\ustring.h:602)\n[5] EditorFileSystemDirectory::get_file (C:\\godot_source\\editor\\editor_file_system.cpp:94)\n[6] EditorFileSystemDirectory::get_file_path (C:\\godot_source\\editor\\editor_file_system.cpp:126)\n[7] EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor\\editor_file_system.cpp:847)\n[8] EditorFileSystem::_notification (C:\\godot_source\\editor\\editor_file_system.cpp:1714)\n[9] EditorFileSystem::_notificationv (C:\\godot_source\\editor\\editor_file_system.h:145)\n[10] Object::notification (C:\\godot_source\\core\\object\\object.cpp:883)\n[11] SceneTree::_process_group (C:\\godot_source\\scene\\main\\scene_tree.cpp:1063)\n[12] SceneTree::_process (C:\\godot_source\\scene\\main\\scene_tree.cpp:1140)\n[13] SceneTree::process (C:\\godot_source\\scene\\main\\scene_tree.cpp:580)\n[14] Main::iteration (C:\\godot_source\\main\\main.cpp:4493)\n[15] ProgressDialog::_update_ui (C:\\godot_source\\editor\\progress_dialog.cpp:135)\n[16] ProgressDialog::task_step (C:\\godot_source\\editor\\progress_dialog.cpp:222)\n[17] EditorNode::progress_task_step (C:\\godot_source\\editor\\editor_node.cpp:4965)\n[18] EditorProgress::step (C:\\godot_source\\editor\\editor_node.cpp:180)\n[19] EditorFileSystem::reimport_files (C:\\godot_source\\editor\\editor_file_system.cpp:3118)\n[20] EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor\\editor_file_system.cpp:963)\n[21] EditorFileSystem::_refresh_filesystem (C:\\godot_source\\editor\\editor_file_system.cpp:3044)\n[22] call_with_variant_args_helper<EditorFileSystem> (C:\\godot_source\\core\\variant\\binder_common.h:320)\n[23] call_with_variant_args<EditorFileSystem> (C:\\godot_source\\core\\variant\\binder_common.h:430)\n[24] CallableCustomMethodPointer<EditorFileSystem,void>::call (C:\\godot_source\\core\\object\\callable_method_pointer.h:109)\n[25] Callable::callp (C:\\godot_source\\core\\variant\\callable.cpp:58)\n[26] Object::emit_signalp (C:\\godot_source\\core\\object\\object.cpp:1206)\n[27] Object::emit_signal<> (C:\\godot_source\\core\\object\\object.h:926)\n[28] SceneTree::process (C:\\godot_source\\scene\\main\\scene_tree.cpp:574)\n[29] Main::iteration (C:\\godot_source\\main\\main.cpp:4493)\n[30] OS_Windows::run (C:\\godot_source\\platform\\windows\\os_windows.cpp:2062)\n[31] widechar_main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:181)\n[32] _main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:206)\n[33] main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:220)\n[34] WinMain (C:\\godot_source\\platform\\windows\\godot_windows.cpp:234)\n[35] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[36] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n```\nAlternatively this error will appear:\n```\nERROR: Condition \"idx == -1\" is true. Continuing.\n   at: EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor/editor_file_system.cpp:899)\nERROR: Attempted to call reimport_files() recursively, this is not allowed.\n   at: (C:\\godot_source\\editor/editor_file_system.cpp:3055)\n```\n\n### Steps to reproduce\n\n1. Have any PNG file in your project\n2. Drag and drop it to another directory while holding Ctrl\n3. Either crash or error\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Seems to be a regression between 4.4 dev 3 and 4.4 dev 4, bisecting.\nBisected to #97090, @KoBeWi \n\n![Image](https://github.com/user-attachments/assets/466fdf14-8e8d-4a91-9bfa-c35f552ecbf3)\n\n<br>\n\nTesting in the latest master i receive this errors when doing a duplication\n\n```\nERROR: Condition \"!tasks.has(p_task)\" is true.\n   at: ProgressDialog::end_task (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor/progress_dialog.cpp:226)\nERROR: Task '_update_scan_actions' already exists.\n   at: (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor/progress_dialog.cpp:173)\n```\n\n<br>\n\nAnd this errors when duplicating and overwriting a file:\n\n```\nERROR: Task '_update_scan_actions' already exists.\n   at: (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor/progress_dialog.cpp:173)\nERROR: Condition \"idx == -1\" is true. Continuing.\n   at: EditorFileSystem::_update_scan_actions (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor/editor_file_system.cpp:899)\nERROR: Condition \"!tasks.has(p_task)\" is true.\n   at: ProgressDialog::end_task (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor/progress_dialog.cpp:226)\n```\n\n<br>\n\nAnd this is the backtrace when crash:\n\n```\nERROR: Task '_update_scan_actions' already exists.\n   at: (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor/progress_dialog.cpp:173)\nWARNING: Duplicate UID detected for Resource at \"res:///470544931_9164046170306256_6536684793976517544_n.jpg\".\nOld Resource path: \"res://470544931_9164046170306256_6536684793976517544_n.jpg\". The new file UID was changed automatically.\n     at: EditorFileSystem::_update_scan_actions (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor/editor_file_system.cpp:854)\n\n================================================================\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.4.dev.custom_build (8c6dbff6d35eb613c83f065c408a49ab02fa7f67)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] CowData<EditorFileSystemDirectory::FileInfo *>::size (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\templates\\cowdata.h:197)\n[1] CowData<EditorFileSystemDirectory::FileInfo *>::size (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\templates\\cowdata.h:197)\n[2] Vector<EditorFileSystemDirectory::FileInfo *>::size (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\templates\\vector.h:98)\n[3] EditorFileSystemDirectory::find_file_index (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.cpp:55)\n[4] EditorFileSystem::_update_scan_actions (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.cpp:898)\n[5] EditorFileSystem::_notification (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.cpp:1714)\n[6] EditorFileSystem::_notificationv (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.h:145)\n[7] Object::notification (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\object.cpp:883)\n[8] SceneTree::_process_group (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\scene_tree.cpp:1063)\n[9] SceneTree::_process (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\scene_tree.cpp:1140)\n[10] SceneTree::process (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\scene_tree.cpp:580)\n[11] Main::iteration (C:\\Users\\Matheus\\Downloads\\Godot Source\\main\\main.cpp:4493)\n[12] ProgressDialog::_update_ui (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\progress_dialog.cpp:135)\n[13] ProgressDialog::add_task (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\progress_dialog.cpp:200)\n[14] EditorNode::progress_add_task (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_node.cpp:4956)\n[15] EditorProgress::EditorProgress (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_node.cpp:190)\n[16] EditorFileSystem::_update_scan_actions (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.cpp:800)\n[17] EditorFileSystem::_refresh_filesystem (C:\\Users\\Matheus\\Downloads\\Godot Source\\editor\\editor_file_system.cpp:3044)\n[18] call_with_variant_args_helper<EditorFileSystem> (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\variant\\binder_common.h:320)\n[19] call_with_variant_args<EditorFileSystem> (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\variant\\binder_common.h:430)\n[20] CallableCustomMethodPointer<EditorFileSystem,void>::call (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\callable_method_pointer.h:109)\n[21] Callable::callp (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\variant\\callable.cpp:58)\n[22] Object::emit_signalp (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\object.cpp:1206)\n[23] Object::emit_signal<> (C:\\Users\\Matheus\\Downloads\\Godot Source\\core\\object\\object.h:926)\n[24] SceneTree::process (C:\\Users\\Matheus\\Downloads\\Godot Source\\scene\\main\\scene_tree.cpp:574)\n[25] Main::iteration (C:\\Users\\Matheus\\Downloads\\Godot Source\\main\\main.cpp:4493)\n[26] OS_Windows::run (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\os_windows.cpp:2062)\n[27] widechar_main (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:181)\n[28] _main (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:206)\n[29] main (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:220)\n[30] WinMain (C:\\Users\\Matheus\\Downloads\\Godot Source\\platform\\windows\\godot_windows.cpp:234)\n[31] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[32] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n================================================================\n```\nI did some extra tests today and seems is only file formats that generate the .import file triggers the bug:\n\nTriggers the bug: bmp, jpg, mp3, png, svg, tga, wav, webp\n\nCopy without issues: tscn, dds, gd, gdshader, tres, txt\n\n<br>\n\nWhen the engine crashes the copy is done with sucess so is something after the copy, also the normal way to copy (Right click -> Move/Duplicate To -> Copy) also triggers this bug in the same way.", "created_at": "2025-01-31 20:49:49", "merge_commit_sha": "021e07c1ed868c988773361a75144a79d1028137", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102247", "base_commit": "f0f5319b0b5b56db9f8023ac4132088df9e86b9e", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 1638c437125d..a348607a6e94 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -67,20 +67,10 @@ void EmbeddedProcess::_notification(int p_what) {\n \t\t} break;\n \t\tcase NOTIFICATION_APPLICATION_FOCUS_IN: {\n \t\t\tapplication_has_focus = true;\n-\t\t\tif (embedded_process_was_focused) {\n-\t\t\t\tembedded_process_was_focused = false;\n-\t\t\t\t// Refocus the embedded process if it was focused when the application lost focus,\n-\t\t\t\t// but do not refocus if the embedded process is currently focused (indicating it just lost focus)\n-\t\t\t\t// or if the current window is a different popup or secondary window.\n-\t\t\t\tif (embedding_completed && current_process_id != focused_process_id && window && window->has_focus()) {\n-\t\t\t\t\tgrab_focus();\n-\t\t\t\t\tqueue_update_embedded_process();\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\tlast_application_focus_time = OS::get_singleton()->get_ticks_msec();\n \t\t} break;\n \t\tcase NOTIFICATION_APPLICATION_FOCUS_OUT: {\n \t\t\tapplication_has_focus = false;\n-\t\t\tembedded_process_was_focused = embedding_completed && current_process_id == focused_process_id;\n \t\t} break;\n \t}\n }\n@@ -286,14 +276,27 @@ void EmbeddedProcess::_check_mouse_over() {\n \t// This method checks if the mouse is over the embedded process while the current application is focused.\n \t// The goal is to give focus to the embedded process as soon as the mouse hovers over it,\n \t// allowing the user to interact with it immediately without needing to click first.\n-\tif (!is_visible_in_tree() || !embedding_completed || !application_has_focus || !window || !window->has_focus() || Input::get_singleton()->is_mouse_button_pressed(MouseButton::LEFT) || Input::get_singleton()->is_mouse_button_pressed(MouseButton::RIGHT)) {\n+\tif (!embedding_completed || !application_has_focus || !window || has_focus() || !is_visible_in_tree() || !window->has_focus() || Input::get_singleton()->is_mouse_button_pressed(MouseButton::LEFT) || Input::get_singleton()->is_mouse_button_pressed(MouseButton::RIGHT)) {\n+\t\treturn;\n+\t}\n+\n+\t// Before checking whether the mouse is truly inside the embedded process, ensure\n+\t// the editor has enough time to re-render. When a breakpoint is hit in the script editor,\n+\t// `_check_mouse_over` may be triggered before the editor hides the game workspace.\n+\t// This prevents the embedded process from regaining focus immediately after the editor has taken it.\n+\tif (OS::get_singleton()->get_ticks_msec() - last_application_focus_time < 500) {\n \t\treturn;\n \t}\n \n-\tbool focused = has_focus();\n+\t// Input::is_mouse_button_pressed is not sufficient to detect the mouse button state\n+\t// while the floating game window is being resized.\n+\tBitField<MouseButtonMask> mouse_button_mask = DisplayServer::get_singleton()->mouse_get_button_state();\n+\tif (!mouse_button_mask.is_empty()) {\n+\t\treturn;\n+\t}\n \n \t// Not stealing focus from a textfield.\n-\tif (!focused && get_viewport()->gui_get_focus_owner() && get_viewport()->gui_get_focus_owner()->is_text_field()) {\n+\tif (get_viewport()->gui_get_focus_owner() && get_viewport()->gui_get_focus_owner()->is_text_field()) {\n \t\treturn;\n \t}\n \n@@ -309,14 +312,17 @@ void EmbeddedProcess::_check_mouse_over() {\n \t\treturn;\n \t}\n \n-\t// When we already have the focus and the user moves the mouse over the embedded process,\n-\t// we just need to refocus the process.\n-\tif (focused) {\n-\t\tqueue_update_embedded_process();\n-\t} else {\n-\t\tgrab_focus();\n-\t\tqueue_redraw();\n+\t// When there's a modal window, we don't want to grab the focus to prevent\n+\t// the game window to go in front of the modal window.\n+\tif (_get_current_modal_window()) {\n+\t\treturn;\n \t}\n+\n+\t// Force \"regrabbing\" the game window focus.\n+\tlast_updated_embedded_process_focused = false;\n+\n+\tgrab_focus();\n+\tqueue_redraw();\n }\n \n void EmbeddedProcess::_check_focused_process_id() {\n@@ -325,17 +331,48 @@ void EmbeddedProcess::_check_focused_process_id() {\n \t\tfocused_process_id = process_id;\n \t\tif (focused_process_id == current_process_id) {\n \t\t\t// The embedded process got the focus.\n-\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n-\t\t\tif (has_focus()) {\n-\t\t\t\t// Redraw to updated the focus style.\n-\t\t\t\tqueue_redraw();\n-\t\t\t} else {\n-\t\t\t\tgrab_focus();\n+\n+\t\t\t// Refocus the current model when focusing the embedded process.\n+\t\t\tWindow *modal_window = _get_current_modal_window();\n+\t\t\tif (!modal_window) {\n+\t\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n+\t\t\t\tif (has_focus()) {\n+\t\t\t\t\t// Redraw to updated the focus style.\n+\t\t\t\t\tqueue_redraw();\n+\t\t\t\t} else {\n+\t\t\t\t\tgrab_focus();\n+\t\t\t\t}\n \t\t\t}\n \t\t} else if (has_focus()) {\n \t\t\trelease_focus();\n \t\t}\n \t}\n+\n+\t// Ensure that the opened modal dialog is refocused when the focused process is the embedded process.\n+\tif (!application_has_focus && focused_process_id == current_process_id) {\n+\t\tWindow *modal_window = _get_current_modal_window();\n+\t\tif (modal_window) {\n+\t\t\tif (modal_window->get_mode() == Window::MODE_MINIMIZED) {\n+\t\t\t\tmodal_window->set_mode(Window::MODE_WINDOWED);\n+\t\t\t}\n+\t\t\tcallable_mp(modal_window, &Window::grab_focus).call_deferred();\n+\t\t}\n+\t}\n+}\n+\n+Window *EmbeddedProcess::_get_current_modal_window() {\n+\tVector<DisplayServer::WindowID> wl = DisplayServer::get_singleton()->get_window_list();\n+\tfor (const DisplayServer::WindowID &window_id : wl) {\n+\t\tWindow *w = Window::get_from_id(window_id);\n+\t\tif (!w) {\n+\t\t\tcontinue;\n+\t\t}\n+\n+\t\tif (w->is_exclusive()) {\n+\t\t\treturn w;\n+\t\t}\n+\t}\n+\treturn nullptr;\n }\n \n void EmbeddedProcess::_bind_methods() {\ndiff --git a/editor/plugins/embedded_process.h b/editor/plugins/embedded_process.h\nindex 3e800923a75d..6f56f255e618 100644\n--- a/editor/plugins/embedded_process.h\n+++ b/editor/plugins/embedded_process.h\n@@ -37,7 +37,7 @@ class EmbeddedProcess : public Control {\n \tGDCLASS(EmbeddedProcess, Control);\n \n \tbool application_has_focus = true;\n-\tbool embedded_process_was_focused = false;\n+\tuint64_t last_application_focus_time = 0;\n \tOS::ProcessID focused_process_id = 0;\n \tOS::ProcessID current_process_id = 0;\n \tbool embedding_grab_focus = false;\n@@ -68,6 +68,7 @@ class EmbeddedProcess : public Control {\n \tvoid _check_focused_process_id();\n \tbool _is_embedded_process_updatable();\n \tRect2i _get_global_embedded_window_rect();\n+\tWindow *_get_current_modal_window();\n \n protected:\n \tstatic void _bind_methods();\ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex d0ddac4b7f9e..1a407bdd4b2f 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -2986,7 +2986,8 @@ Error DisplayServerWindows::embed_process(WindowID p_window, OS::ProcessID p_pid\n \t// (e.g., a screen to the left of the main screen).\n \tconst Rect2i adjusted_rect = Rect2i(p_rect.position + _get_screens_origin(), p_rect.size);\n \n-\tSetWindowPos(ep->window_handle, nullptr, adjusted_rect.position.x, adjusted_rect.position.y, adjusted_rect.size.x, adjusted_rect.size.y, SWP_NOZORDER | SWP_NOACTIVATE | SWP_ASYNCWINDOWPOS);\n+\t// Use HWND_BOTTOM to prevent reordering of the embedded window over another popup.\n+\tSetWindowPos(ep->window_handle, HWND_BOTTOM, adjusted_rect.position.x, adjusted_rect.position.y, adjusted_rect.size.x, adjusted_rect.size.y, SWP_NOZORDER | SWP_NOACTIVATE | SWP_ASYNCWINDOWPOS);\n \n \tif (ep->is_visible != p_visible) {\n \t\tif (p_visible) {\n", "test_patch": "", "problem_statement": "Embed Game focus over modal popups\n### Tested versions\n\n- Reproductible in 4.4 beta 2 and master\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 32.0.15.6636) - 11th Gen Intel(R) Core(TM) i5-11600KF @ 3.90GHz (12 threads)\n\n### Issue description\n\nThe embedding is enabled in the editor and the game is running. If a modal popup is visible and the use click on the game window, the game window appears in front of the modal popup. If this popup is small enough, it disappears and the editor is not available (ex: stop button).\n\nhttps://github.com/user-attachments/assets/9ce74cc1-e7f0-44e8-87b8-fc60c69519e5\n\n\n\n### Steps to reproduce\n\n- Enable Embed Game and disable Make Floating\n- Run the game\n- While inside the Game tab, display a modal popup (ex: Settings, Create node, etc...)\n- Click the game window\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "hints_text": "", "created_at": "2025-01-31 15:37:12", "merge_commit_sha": "bd87c3a76b7e74729ddcbf4821de70c236569198", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102218", "base_commit": "134da374975114ef8e05cf81d1d30eff645e310e", "patch": "diff --git a/modules/gdscript/gdscript_parser.cpp b/modules/gdscript/gdscript_parser.cpp\nindex 077ab6f04667..4b95f5a83613 100644\n--- a/modules/gdscript/gdscript_parser.cpp\n+++ b/modules/gdscript/gdscript_parser.cpp\n@@ -3123,13 +3123,9 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\t\tcase DictionaryNode::LUA_TABLE:\n \t\t\t\t\tif (key != nullptr && key->type != Node::IDENTIFIER && key->type != Node::LITERAL) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (key != nullptr && key->type == Node::LITERAL && static_cast<LiteralNode *>(key)->value.get_type() != Variant::STRING) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (!match(GDScriptTokenizer::Token::EQUAL)) {\n \t\t\t\t\t\tif (match(GDScriptTokenizer::Token::COLON)) {\n@@ -3169,6 +3165,21 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\tif (key != nullptr && value != nullptr) {\n \t\t\t\tdictionary->elements.push_back({ key, value });\n \t\t\t}\n+\n+\t\t\t// Do phrase level recovery by inserting an imaginary expression for missing keys or values.\n+\t\t\t// This ensures the successfully parsed expression is part of the AST and can be analyzed.\n+\t\t\tif (key != nullptr && value == nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ key, dummy });\n+\t\t\t} else if (key == nullptr && value != nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ dummy, value });\n+\t\t\t}\n+\n \t\t} while (match(GDScriptTokenizer::Token::COMMA) && !is_at_end());\n \t}\n \tpop_multiline();\ndiff --git a/modules/gdscript/gdscript_parser.h b/modules/gdscript/gdscript_parser.h\nindex 5da2bc80207f..8afc6b5f05a6 100644\n--- a/modules/gdscript/gdscript_parser.h\n+++ b/modules/gdscript/gdscript_parser.h\n@@ -1453,6 +1453,18 @@ class GDScriptParser {\n \n \t\treturn node;\n \t}\n+\n+\t// Allocates a node for patching up the parse tree when an error occurred.\n+\t// Such nodes don't track their extents as they don't relate to actual tokens.\n+\ttemplate <typename T>\n+\tT *alloc_recovery_node() {\n+\t\tT *node = memnew(T);\n+\t\tnode->next = list;\n+\t\tlist = node;\n+\n+\t\treturn node;\n+\t}\n+\n \tvoid clear();\n \tvoid push_error(const String &p_message, const Node *p_origin = nullptr);\n #ifdef DEBUG_ENABLED\n", "test_patch": "diff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.cfg\nnew file mode 100644\nindex 000000000000..8920916a8984\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+exclude=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.gd\nnew file mode 100644\nindex 000000000000..7795c0636d4d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_1.gd\n@@ -0,0 +1,6 @@\n+extends Node\n+\n+var test = {\n+    t = 1,\n+    AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.cfg\nnew file mode 100644\nindex 000000000000..689a99b70c6d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+exclude=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.gd\nnew file mode 100644\nindex 000000000000..9ba440a10db4\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_key_2.gd\n@@ -0,0 +1,10 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    t = 1,\n+    TestEnum.\u27a1 = 1,\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.gd\nnew file mode 100644\nindex 000000000000..d5f087b3bd66\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_1.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    t = AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.gd\nnew file mode 100644\nindex 000000000000..9eb72aed30b9\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_2.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    = TestEnum.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.gd\nnew file mode 100644\nindex 000000000000..394aa28b6319\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_3.gd\n@@ -0,0 +1,6 @@\n+extends Node\n+\n+var test = {\n+    t = 1,\n+    e AutoTranslateMode.\u27a1,\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.gd\nnew file mode 100644\nindex 000000000000..17fc79b52d14\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_4.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    1 = TestEnum.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.gd\nnew file mode 100644\nindex 000000000000..aa6c52ae8071\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/lua_value_5.gd\n@@ -0,0 +1,6 @@\n+extends Node\n+\n+var test = {\n+    t = 1,\n+    1 AutoTranslateMode.\u27a1,\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.gd\nnew file mode 100644\nindex 000000000000..ad3009532b56\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_1.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.gd\nnew file mode 100644\nindex 000000000000..d5a50261cc52\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_2.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    AutoTranslateMode.\u27a1:\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.gd\nnew file mode 100644\nindex 000000000000..a2b6fa0106e7\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_3.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    TestEnum.\u27a1 \"test\"\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.gd\nnew file mode 100644\nindex 000000000000..ac7b3f8614c1\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_key_4.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    AutoTranslateMode.\u27a1: 1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.gd\nnew file mode 100644\nindex 000000000000..5ea4cab76fc1\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_1.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    1: AutoTranslateMode.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.cfg\nnew file mode 100644\nindex 000000000000..5e69ae24f97d\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"VALUE\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.gd\nnew file mode 100644\nindex 000000000000..fd14b2152ddd\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_2.gd\n@@ -0,0 +1,9 @@\n+extends Node\n+\n+enum TestEnum {\n+    VALUE,\n+}\n+\n+var test = {\n+    : TestEnum.\u27a1\n+}\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.cfg b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.cfg\nnew file mode 100644\nindex 000000000000..e464da23f817\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.cfg\n@@ -0,0 +1,4 @@\n+[output]\n+include=[\n+    {\"display\": \"AUTO_TRANSLATE_MODE_INHERIT\"},\n+]\ndiff --git a/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.gd b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.gd\nnew file mode 100644\nindex 000000000000..befd4cc0cce9\n--- /dev/null\n+++ b/modules/gdscript/tests/scripts/completion/enum_values_in_dictionary/py_value_3.gd\n@@ -0,0 +1,5 @@\n+extends Node\n+\n+var test = {\n+    1 AutoTranslateMode.\u27a1\n+}\n", "problem_statement": "[3.x] Autocomplete fails when typing the key before the value in a dictionary\n**Godot version:**\r\nGodot 3.2.stable.official\r\n\r\n**OS/device including version:**\r\nWindows 10 home\r\n\r\n**Issue description:**\r\nWhen adding a key to the dictionary, the autocomplete does not work until I enter the value. The workaround is to start by entering `:any_value` then moving the cursor back and entering the key for the autocomplete to work.\r\n\r\n**Steps to reproduce:**\r\nCreate the following script and try to add a key value pair to `data`, the enum does not autocomplete until a value is added :\r\n```\r\nextends Reference\r\n\r\nvar\tdata = {InnerClass.INNER_ENUM_VALUE_1:1}\r\n\r\nclass InnerClass:\r\n\tenum {INNER_ENUM_VALUE_1}\r\n\r\n```\r\n**Minimal reproduction project:**\r\nDon't need a project, just the above script.\n", "hints_text": "", "created_at": "2025-01-30 23:32:28", "merge_commit_sha": "bef5d1e4f87da43a19c4ab2c8ff17704f88bb9b4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102184", "base_commit": "56d82044702465912ced016654d203587cabe084", "patch": "diff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 3c1809c3586b..99273ffa81c7 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -559,11 +559,6 @@ void SceneTree::iteration_prepare() {\n \t\t// are flushed before pumping the interpolation prev and currents.\n \t\tflush_transform_notifications();\n \t\tVisualServer::get_singleton()->tick();\n-\n-\t\t// Any objects performing client physics interpolation\n-\t\t// should be given an opportunity to keep their previous transforms\n-\t\t// up to date before each new physics tick.\n-\t\t_client_physics_interpolation.physics_process();\n \t}\n }\n \n@@ -572,6 +567,11 @@ void SceneTree::iteration_end() {\n \t// to be flushed to the VisualServer before finishing a physics tick.\n \tif (_physics_interpolation_enabled) {\n \t\tflush_transform_notifications();\n+\n+\t\t// Any objects performing client physics interpolation\n+\t\t// should be given an opportunity to keep their previous transforms\n+\t\t// up to date.\n+\t\t_client_physics_interpolation.physics_process();\n \t}\n }\n \n", "test_patch": "", "problem_statement": "`get_global_transform_interpolated()` may return wrong value when FPS < physics ticks per second\n### Tested versions\n\n- Reproducible in v3.6.stable.official [de2f0f147]\n- Reproducible in v4.4.dev1.official [28a72fa43]\n- Reproducible in v4.4.beta1.official [d33da79d3]\n- Reproducible in v4.4.beta.custom_build [a013481b0]\n\n### System information\n\nGodot v4.4.beta (a013481b0) - CachyOS Linux #1 SMP PREEMPT_DYNAMIC Mon, 20 Jan 2025 21:26:55 +0000 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) HD Graphics 620 (KBL GT2) - Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz (4 threads)\n\n### Issue description\n\nWhen FPS drops below `physics_ticks_per_second` the function `get_global_transform_interpolated()` sometimes returns wrong value.\n\nWhen calling `get_global_transform_interpolated()` in a `_process()` I expect to get the most recent interpolated transform regardless of how many physics ticks happen between successive process frames. I think the actual returned value may be interpolated transform only after 1 physics tick that occurred directly after the previous process frame.\n\nThe issue is about functionality introduced to `4.4.dev1` in https://github.com/godotengine/godot/pull/92391 but it is also reproducible in `3.6` version of physics interpolation.\n\n### Steps to reproduce\n\nRun the MRP and notice NinePatchRect is constantly jittering.\n\nIn order to reproduce the issue the project has `max_fps` set lower than `physics_ticks_per_second`.\n\nIf needed I can provide even more simplified MRP without the usage of `Camera3D.unproject_position()`.\n\n### Minimal reproduction project (MRP)\n\nGodot 4.x project:\n[test-physics-interpolation-maxfps.zip](https://github.com/user-attachments/files/18580802/test-physics-interpolation-maxfps.zip)\n\nGodot 3.x project:\n[Test Physics Interpolation max_fps Godot3.zip](https://github.com/user-attachments/files/18580804/Test.Physics.Interpolation.max_fps.Godot3.zip)\n", "hints_text": "Related #94060.\n\nUPDATE:\nAh! I think I understand the difference here, maybe the timeout is not working. There should be a timeout which prevents this. Will investigate.\nYou are absolutely right, I must have subconsciously assumed the frame rate would be higher than the tick rate, because it only updates the previous transform during the frame call. I'll put in a mechanism to fix this. \ud83d\udc4d \n\nUPDATE:\nTurns out there is already a mechanism to deal with tick rate higher than the frame rate, and it is working fine in a test project. So there is something special about your MRP which is causing the behaviour seen, still investigating.\n\nModifying your project so the target is not a physics object seems to work fine (as in my MRP), so it looks to be something to do with the timing that the physics engine is updating the Ball, relative to when the interpolation records it. Will probably have to look more tomorrow.\nThink I've got it, the client interpolation pump was being updated _before_ the physics had called back to update the item transforms during the iteration. This seemed not to be a problem when the frame rate was higher than tick rate, but caused a glitch the other way round when there was more than 1 tick per frame.\n\nIt looks fairly simple to fix by moving the point in the iteration we update the client interpolation pump.\n\nWell done for spotting this! \ud83d\udc4d \n\nAlso likely it was missed because most of the testing was on non-physics objects (to simplify things).", "created_at": "2025-01-30 11:52:01", "merge_commit_sha": "a4349590c5a037945cfa4b4f770edf3b70adda35", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Linux Headless w/ Mono (target=release_debug, tools=yes)', '.github/workflows/runner.yml']", "['Static Checks (clang-format, black format, file format, documentation checks)', '.github/workflows/runner.yml']"], ["['Linux Server w/ Mono (target=release, tools=no)', '.github/workflows/runner.yml']", "['Editor (target=release_debug, tools=yes)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102163", "base_commit": "a013481b0911e59cc3f3dea7ebb732450c3e1460", "patch": "diff --git a/platform/web/js/libs/audio.position.worklet.js b/platform/web/js/libs/audio.position.worklet.js\nindex bf3ac4ae2d23..7dbeb8a0adde 100644\n--- a/platform/web/js/libs/audio.position.worklet.js\n+++ b/platform/web/js/libs/audio.position.worklet.js\n@@ -28,10 +28,20 @@\n /* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n /**************************************************************************/\n \n+const POST_THRESHOLD_S = 0.1;\n+\n class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n-\tconstructor() {\n-\t\tsuper();\n+\tconstructor(...args) {\n+\t\tsuper(...args);\n+\t\tthis.lastPostTime = currentTime;\n \t\tthis.position = 0;\n+\n+\t\tthis.port.onmessage = (event) => {\n+\t\t\tif (event?.data?.type === 'clear') {\n+\t\t\t\tthis.lastPostTime = currentTime;\n+\t\t\t\tthis.position = 0;\n+\t\t\t}\n+\t\t};\n \t}\n \n \tprocess(inputs, _outputs, _parameters) {\n@@ -39,10 +49,15 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\t\tconst input = inputs[0];\n \t\t\tif (input.length > 0) {\n \t\t\t\tthis.position += input[0].length;\n-\t\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n-\t\t\t\treturn true;\n \t\t\t}\n \t\t}\n+\n+\t\t// Posting messages is expensive. Let's limit the number of posts.\n+\t\tif (currentTime - this.lastPostTime > POST_THRESHOLD_S) {\n+\t\t\tthis.lastPostTime = currentTime;\n+\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n+\t\t}\n+\n \t\treturn true;\n \t}\n }\ndiff --git a/platform/web/js/libs/library_godot_audio.js b/platform/web/js/libs/library_godot_audio.js\nindex 0c83e3587d84..c5fa7d5f0fad 100644\n--- a/platform/web/js/libs/library_godot_audio.js\n+++ b/platform/web/js/libs/library_godot_audio.js\n@@ -460,7 +460,11 @@ class SampleNode {\n \t\tconst sampleNodeBus = this.getSampleNodeBus(bus);\n \t\tsampleNodeBus.setVolume(options.volume);\n \n-\t\tthis.connectPositionWorklet(options.start);\n+\t\tthis.connectPositionWorklet(options.start).catch((err) => {\n+\t\t\tconst newErr = new Error('Failed to create PositionWorklet.');\n+\t\t\tnewErr.cause = err;\n+\t\t\tGodotRuntime.error(newErr);\n+\t\t});\n \t}\n \n \t/**\n@@ -612,44 +616,34 @@ class SampleNode {\n \t * Sets up and connects the source to the GodotPositionReportingProcessor\n \t * If the worklet module is not loaded in, it will be added\n \t */\n-\tconnectPositionWorklet(start) {\n-\t\ttry {\n-\t\t\tthis._positionWorklet = this.createPositionWorklet();\n-\t\t\tthis._source.connect(this._positionWorklet);\n-\t\t\tif (start) {\n-\t\t\t\tthis.start();\n-\t\t\t}\n-\t\t} catch (error) {\n-\t\t\tif (error?.name !== 'InvalidStateError') {\n-\t\t\t\tthrow error;\n-\t\t\t}\n-\t\t\tconst path = GodotConfig.locate_file('godot.audio.position.worklet.js');\n-\t\t\tGodotAudio.ctx.audioWorklet\n-\t\t\t\t.addModule(path)\n-\t\t\t\t.then(() => {\n-\t\t\t\t\tif (!this.isCanceled) {\n-\t\t\t\t\t\tthis._positionWorklet = this.createPositionWorklet();\n-\t\t\t\t\t\tthis._source.connect(this._positionWorklet);\n-\t\t\t\t\t\tif (start) {\n-\t\t\t\t\t\t\tthis.start();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}).catch((addModuleError) => {\n-\t\t\t\t\tGodotRuntime.error('Failed to create PositionWorklet.', addModuleError);\n-\t\t\t\t});\n+\tasync connectPositionWorklet(start) {\n+\t\tawait GodotAudio.audioPositionWorkletPromise;\n+\t\tif (this.isCanceled) {\n+\t\t\treturn;\n+\t\t}\n+\t\tthis.getPositionWorklet();\n+\t\tthis._source.connect(this._positionWorklet);\n+\t\tif (start) {\n+\t\t\tthis.start();\n \t\t}\n \t}\n \n \t/**\n-\t * Creates the AudioWorkletProcessor used to track playback position.\n-\t * @returns {AudioWorkletNode}\n+\t * Get a AudioWorkletProcessor from the pool, or create one if no processor is available.\n \t */\n-\tcreatePositionWorklet() {\n-\t\tconst worklet = new AudioWorkletNode(\n-\t\t\tGodotAudio.ctx,\n-\t\t\t'godot-position-reporting-processor'\n-\t\t);\n-\t\tworklet.port.onmessage = (event) => {\n+\tgetPositionWorklet() {\n+\t\tif (this._positionWorklet != null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tif (GodotAudio.audioPositionWorkletPool.length == 0) {\n+\t\t\tthis._positionWorklet = new AudioWorkletNode(\n+\t\t\t\tGodotAudio.ctx,\n+\t\t\t\t'godot-position-reporting-processor'\n+\t\t\t);\n+\t\t} else {\n+\t\t\tthis._positionWorklet = GodotAudio.audioPositionWorkletPool.pop();\n+\t\t}\n+\t\tthis._positionWorklet.port.onmessage = (event) => {\n \t\t\tswitch (event.data['type']) {\n \t\t\tcase 'position':\n \t\t\t\tthis._playbackPosition = (parseInt(event.data.data, 10) / this.getSample().sampleRate) + this.offset;\n@@ -658,7 +652,6 @@ class SampleNode {\n \t\t\t\t// Do nothing.\n \t\t\t}\n \t\t};\n-\t\treturn worklet;\n \t}\n \n \t/**\n@@ -688,6 +681,8 @@ class SampleNode {\n \t\tif (this._positionWorklet) {\n \t\t\tthis._positionWorklet.disconnect();\n \t\t\tthis._positionWorklet.port.onmessage = null;\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n+\t\t\tGodotAudio.audioPositionWorkletPool.push(this._positionWorklet);\n \t\t\tthis._positionWorklet = null;\n \t\t}\n \n@@ -731,7 +726,10 @@ class SampleNode {\n \t\tconst pauseTime = this.isPaused\n \t\t\t? this.pauseTime\n \t\t\t: 0;\n-\t\tthis.connectPositionWorklet();\n+\t\tif (this._positionWorklet != null) {\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n+\t\t\tthis._source.connect(this._positionWorklet);\n+\t\t}\n \t\tthis._source.start(this.startTime, this.offset + pauseTime);\n \t\tthis.isStarted = true;\n \t}\n@@ -1199,6 +1197,10 @@ const _GodotAudio = {\n \t\tdriver: null,\n \t\tinterval: 0,\n \n+\t\t/** @type {Promise} */\n+\t\taudioPositionWorkletPromise: null,\n+\t\taudioPositionWorkletPool: [],\n+\n \t\t/**\n \t\t * Converts linear volume to Db.\n \t\t * @param {number} linear Linear value to convert.\n@@ -1265,6 +1267,10 @@ const _GodotAudio = {\n \t\t\t\tonlatencyupdate(computed_latency);\n \t\t\t}, 1000);\n \t\t\tGodotOS.atexit(GodotAudio.close_async);\n+\n+\t\t\tconst path = GodotConfig.locate_file('godot.audio.position.worklet.js');\n+\t\t\tGodotAudio.audioPositionWorkletPromise = ctx.audioWorklet.addModule(path);\n+\n \t\t\treturn ctx.destination.channelCount;\n \t\t},\n \n", "test_patch": "", "problem_statement": "v4.4 Sound quickly regresses on the Web: freezes, noises, crackles\n### Tested versions\n\nReproducible in: v4.4.dev3.official [f4af8201b], v4.4.dev2, v4.4.dev1\r\nNot reproducible in: v4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.4.dev3 - Windows 10.0.19045 - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - GeForce GT 740M - Intel(R) Core(TM) i5-3317U CPU @ 1.70GHz (4 threads)\n\n### Issue description\n\nOn the Web over time, the sound begins to freeze, break and crackle terribly. The heavier the stage and the weaker the hardware on which the game is launched, the faster it happens. For example, the sounds in the game I created start to freeze after a minute on a modern computer. On a weak laptop almost immediately. And immediately on a phone. Also, in remote debugging, this degradation of sounds occurs more slowly than when exporting a project.\r\n\r\nI tried different solutions, but they all didn't work. Because of this, I had to move the whole project to version 4.3 and that solved the problem.\r\n\r\nSo at the moment version 4.4 is not playable on web platforms. At least for me.\r\n\r\nFor testing I created separate projects for 4.4 and 4.3. with a minimum number of objects just so that there is at least some load on the engine.\n\n### Steps to reproduce\n\nRun the project in remote debugging on the Web.\r\nWait a few minutes (depending on your hardware). My sound began to degrade sharply at the 3rd minute.\r\nIf you want, try to run the same project on version 4.3. You won't find any such problems, no matter how much you play.\n\n### Minimal reproduction project (MRP)\n\n[audiotest-4.4.zip](https://github.com/user-attachments/files/17602861/audiotest-4.4.zip)\r\n\r\n[audiotest-4.3.zip](https://github.com/user-attachments/files/17602859/audiotest-4.3.zip)\r\n\n", "hints_text": "I confirm the problem. It is played on Linux in Chrome and FireFox browsers.\nI also confirm the issue. Here is my (work-in-progress) project exported from two different Godot versions:\n\n- [Froge 4.3](https://rburing.itch.io/froge-4-3?secret=LEGEJVXHEuaHXoqmv2zlZ0u1SU) (exported from Godot 4.3-stable)\n- [Froge 4.4](https://rburing.itch.io/froge-4-4?secret=ZnPD765il6PkacENN3CyUeStyU) (exported from Godot 4.4-beta1)\n\nStart the game and wait about 2 minutes (the exact time may depend on your device).\n\nThe looped music (an .ogg file played by an AudioStreamPlayer) starts to stutter, crackle, and slow down.\n\nTested on Firefox on Linux.\n\nI can provide the project source upon request.\n\ncc @adamscott \nI've narrowed down the issue, it started on 4.4-dev1. For completeness: [Froge 4.4-dev1](https://rburing.itch.io/froge-4-4-dev1?secret=N7HUGjKguo20JFpm36RWKGrpotM).\n\nMy guess is that maybe it has something to do with looping and floating point precision.\n\nEdit: Probably related to\n\n- https://github.com/godotengine/godot/pull/95197\n\n", "created_at": "2025-01-29 22:04:30", "merge_commit_sha": "a7e5469155defaceb4dfa223fec0fa46b73ad40e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102062", "base_commit": "ee4acfbfbf15b3528c34a8d4f65d66097e636044", "patch": "diff --git a/core/variant/variant_utility.cpp b/core/variant/variant_utility.cpp\nindex ec9492ac5d1c..a53b5660d5a5 100644\n--- a/core/variant/variant_utility.cpp\n+++ b/core/variant/variant_utility.cpp\n@@ -999,9 +999,7 @@ void VariantUtilityFunctions::print_rich(const Variant **p_args, int p_arg_count\n \tr_error.error = Callable::CallError::CALL_OK;\n }\n \n-#undef print_verbose\n-\n-void VariantUtilityFunctions::print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error) {\n+void VariantUtilityFunctions::_print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error) {\n \tif (OS::get_singleton()->is_stdout_verbose()) {\n \t\tString s;\n \t\tfor (int i = 0; i < p_arg_count; i++) {\n@@ -1581,16 +1579,16 @@ static _FORCE_INLINE_ Variant::Type get_ret_type_helper(void (*p_func)(P...)) {\n \t};                                                                                                           \\\n \tregister_utility_function<Func_##m_func>(#m_func, m_args)\n \n-#define FUNCBINDVARARGV(m_func, m_args, m_category)                                                              \\\n+#define FUNCBINDVARARGV_CNAME(m_func, m_func_cname, m_args, m_category)                                          \\\n \tclass Func_##m_func {                                                                                        \\\n \tpublic:                                                                                                      \\\n \t\tstatic void call(Variant *r_ret, const Variant **p_args, int p_argcount, Callable::CallError &r_error) { \\\n \t\t\tr_error.error = Callable::CallError::CALL_OK;                                                        \\\n-\t\t\tVariantUtilityFunctions::m_func(p_args, p_argcount, r_error);                                        \\\n+\t\t\tVariantUtilityFunctions::m_func_cname(p_args, p_argcount, r_error);                                  \\\n \t\t}                                                                                                        \\\n \t\tstatic void validated_call(Variant *r_ret, const Variant **p_args, int p_argcount) {                     \\\n \t\t\tCallable::CallError c;                                                                               \\\n-\t\t\tVariantUtilityFunctions::m_func(p_args, p_argcount, c);                                              \\\n+\t\t\tVariantUtilityFunctions::m_func_cname(p_args, p_argcount, c);                                        \\\n \t\t}                                                                                                        \\\n \t\tstatic void ptrcall(void *ret, const void **p_args, int p_argcount) {                                    \\\n \t\t\tVector<Variant> args;                                                                                \\\n@@ -1625,6 +1623,8 @@ static _FORCE_INLINE_ Variant::Type get_ret_type_helper(void (*p_func)(P...)) {\n \t};                                                                                                           \\\n \tregister_utility_function<Func_##m_func>(#m_func, m_args)\n \n+#define FUNCBINDVARARGV(m_func, m_args, m_category) FUNCBINDVARARGV_CNAME(m_func, m_func, m_args, m_category)\n+\n #define FUNCBIND(m_func, m_args, m_category)                                                                     \\\n \tclass Func_##m_func {                                                                                        \\\n \tpublic:                                                                                                      \\\n@@ -1832,7 +1832,7 @@ void Variant::_register_variant_utility_functions() {\n \tFUNCBINDVARARGV(printt, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(prints, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(printraw, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n-\tFUNCBINDVARARGV(print_verbose, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n+\tFUNCBINDVARARGV_CNAME(print_verbose, _print_verbose, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(push_error, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(push_warning, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \ndiff --git a/core/variant/variant_utility.h b/core/variant/variant_utility.h\nindex 75cde4942b5f..a653369621a0 100644\n--- a/core/variant/variant_utility.h\n+++ b/core/variant/variant_utility.h\n@@ -133,8 +133,7 @@ struct VariantUtilityFunctions {\n \tstatic String type_string(Variant::Type p_type);\n \tstatic void print(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void print_rich(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n-#undef print_verbose\n-\tstatic void print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n+\tstatic void _print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void printerr(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void printt(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void prints(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n", "test_patch": "", "problem_statement": "`print_verbose` makes build fail when `scu_build=yes`\n### Tested versions\n\n- 4.4.beta\n\n### System information\n\nWindows 11\n\n### Issue description\n\nThe `print_verbose` macro is causing one of the CI jobs that uses `scu_build=yes` to fail in my PR although I didn't modify the file calling it.\nhttps://github.com/godotengine/godot/actions/runs/12934119444/job/36074414239\n\nMy local build also fails when I use `scu_build=yes` but works fine otherwise.\n```sh\n[100%] godot\\core/debugger/remote_debugger_peer.cpp(172): error C3861: 'print_verbose': identifier not found\n```\n\nBy the way, it works if I replace it with `WARN_VERBOSE`.\n\n### Steps to reproduce\n\n- Checkout https://github.com/godotengine/godot/pull/100516\n- I changed calls to `print_verbose`  in `core/debugger/remote_debugger_peer.cpp` to `WARN_VERBOSE` to fix CI. Change it back to `print_verbose`. \n- Build it with `scons scu_build=yes`.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "I can confirm that cherry-picking the mentioned pr and trying to compile with `scu_build=yes` in MSVC 14.3 results in the error (i cherry-picked before the change in the pr that replace the `print_verbose` for `WARN_VERBOSE`)\n\n![Image](https://github.com/user-attachments/assets/784c5a90-6d12-444c-a35d-05834addb85f)\nThe problem is likely due to this, in `variant_utility.cpp` and `variant_utility.h`:\n```\n#undef print_verbose\n```\nThis means anything that tries to use `print_verbose` after these files will fail (unless it is defined after this point).\n\nWe can't do much about the header, but for the cpp, we can add it as an exception from the scu build so it gets compiled on its own and doesn't affect any other files.\n\nIt likely wasn't due to your PR, but your PR may have inadvertently changed the grouping of which files were compiled together, which exposed this bug.\n\nI'll see if it can be fixed with a simple exception rule.\n\n### UPDATE\nThe gravy thickens:\n```\n    process_folder([\"core/variant\"], [\"variant_utility\"])\n```\nIt is already added as an exception in the SCU build, so the problem may be the header, and inclusion order. This may be a gotcha of the header (and if so could theoretically also occur in non-scu build). I'll see if there is a sensible fix.\n\nI *think* that `VariantUtility` is providing it's own version of `print_verbose` (instead of the define) so the function can be bound and used by gdscript using the same name.\n\nThe problem the `#undef` causes is that any file that includes `variant_utility.h` can no longer use `print_verbose` from c++ _unless_ it includes `core/string/print_string.h` _after_ variant utility. Unfortunately the `clangformat` step re-orders includes, so could inadvertently cause this problem. \ud83e\udd14 \n\nYes I confirmed the hypothesis.\nAdding:\n```\n#ifndef print_verbose\n#define print_verbose(m_text)             \\\n{                                     \\\n\t\t\tif (is_print_verbose_enabled()) { \\\n\t\t\t\tprint_line(m_text);           \\\n\t}                                 \\\n}\n#endif\n```\nInto `remote_debugger_peer.cpp` solves the problem (although isn't a good proper fix).\n\nEssentially this happens:\n* `print_string.h` is included (defining print_verbose)\n* Someone includes `variant_utility.h` (undefining it)\n* At this stage reincluding `print_string.h` doesn't work as the include guards prevent it running a second time, and `print_verbose` remains undefined.", "created_at": "2025-01-26 18:01:50", "merge_commit_sha": "7902b6f99bd8335a9f2da73f4398cefaa9508b76", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102006", "base_commit": "6dc78c8aa17ad46e701e0c4e7b7632c2f0e098f1", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 723c762a72a5..ad501e77a6d8 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -301,6 +301,7 @@ void GameView::_stop_pressed() {\n \t}\n \n \t_detach_script_debugger();\n+\tpaused = false;\n \n \tEditorNode::get_singleton()->set_unfocused_low_processor_usage_mode_enabled(true);\n \tembedded_process->reset();\n@@ -515,15 +516,26 @@ void GameView::_update_embed_menu_options() {\n }\n \n void GameView::_update_embed_window_size() {\n-\tif (embed_size_mode == SIZE_MODE_FIXED || embed_size_mode == SIZE_MODE_KEEP_ASPECT) {\n-\t\t//The embedded process control will need the desired window size.\n-\t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n-\t\tembedded_process->set_window_size(placement.size);\n+\tif (paused) {\n+\t\t// When paused, Godot does not re-render. As a result, resizing the game window to a larger size\n+\t\t// causes artifacts and flickering. However, resizing to a smaller size seems fine.\n+\t\t// To prevent artifacts and flickering, we will force the game window to maintain its size.\n+\t\t// Using the same technique as SIZE_MODE_FIXED, the embedded process control will\n+\t\t// prevent resizing the game to a larger size while maintaining the aspect ratio.\n+\t\tembedded_process->set_window_size(size_paused);\n+\t\tembedded_process->set_keep_aspect(false);\n+\n \t} else {\n-\t\t//Stretch... No need for the window size.\n-\t\tembedded_process->set_window_size(Size2i());\n+\t\tif (embed_size_mode == SIZE_MODE_FIXED || embed_size_mode == SIZE_MODE_KEEP_ASPECT) {\n+\t\t\t// The embedded process control will need the desired window size.\n+\t\t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n+\t\t\tembedded_process->set_window_size(placement.size);\n+\t\t} else {\n+\t\t\t// Stretch... No need for the window size.\n+\t\t\tembedded_process->set_window_size(Size2i());\n+\t\t}\n+\t\tembedded_process->set_keep_aspect(embed_size_mode == SIZE_MODE_KEEP_ASPECT);\n \t}\n-\tembedded_process->set_keep_aspect(embed_size_mode == SIZE_MODE_KEEP_ASPECT);\n }\n \n void GameView::_hide_selection_toggled(bool p_pressed) {\n@@ -787,7 +799,8 @@ void GameView::_window_close_request() {\n \t\tembedded_process->reset();\n \n \t\t// When the embedding is not complete, we need to kill the process.\n-\t\tif (embedded_process->is_embedding_in_progress()) {\n+\t\t// If the game is paused, the close request will not be processed by the game, so it's better to kill the process.\n+\t\tif (paused || embedded_process->is_embedding_in_progress()) {\n \t\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n \t\t\t// actually closes.\n \t\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n@@ -795,6 +808,20 @@ void GameView::_window_close_request() {\n \t}\n }\n \n+void GameView::_debugger_breaked(bool p_breaked, bool p_can_debug) {\n+\tif (p_breaked == paused) {\n+\t\treturn;\n+\t}\n+\n+\tpaused = p_breaked;\n+\n+\tif (paused) {\n+\t\tsize_paused = embedded_process->get_screen_embedded_window_rect().size;\n+\t}\n+\n+\t_update_embed_window_size();\n+}\n+\n GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tsingleton = this;\n \n@@ -984,6 +1011,8 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tp_wrapper->set_override_close_request(true);\n \tp_wrapper->connect(\"window_close_requested\", callable_mp(this, &GameView::_window_close_request));\n \tp_wrapper->connect(\"window_size_changed\", callable_mp(this, &GameView::_update_floating_window_settings));\n+\n+\tEditorDebuggerNode::get_singleton()->connect(\"breaked\", callable_mp(this, &GameView::_debugger_breaked));\n }\n \n ///////\n@@ -1053,15 +1082,18 @@ void GameViewPlugin::_window_visibility_changed(bool p_visible) {\n }\n \n void GameViewPlugin::_save_last_editor(const String &p_editor) {\n-\tif (p_editor != get_name()) {\n+\tif (p_editor != get_plugin_name()) {\n \t\tlast_editor = p_editor;\n \t}\n }\n \n void GameViewPlugin::_focus_another_editor() {\n \tif (window_wrapper->get_window_enabled()) {\n-\t\tERR_FAIL_COND(last_editor.is_empty());\n-\t\tEditorInterface::get_singleton()->set_main_screen_editor(last_editor);\n+\t\tif (last_editor.is_empty()) {\n+\t\t\tEditorNode::get_singleton()->get_editor_main_screen()->select(EditorMainScreen::EDITOR_2D);\n+\t\t} else {\n+\t\t\tEditorInterface::get_singleton()->set_main_screen_editor(last_editor);\n+\t\t}\n \t}\n }\n \ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 7402b270e3c0..dd384280b5fb 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -122,6 +122,8 @@ class GameView : public VBoxContainer {\n \tbool embed_on_play = true;\n \tbool make_floating_on_play = true;\n \tEmbedSizeMode embed_size_mode = SIZE_MODE_FIXED;\n+\tbool paused = false;\n+\tSize2 size_paused;\n \n \tRect2i floating_window_rect;\n \tint floating_window_screen = -1;\n@@ -186,6 +188,8 @@ class GameView : public VBoxContainer {\n \tvoid _detach_script_debugger();\n \tvoid _remote_window_title_changed(String title);\n \n+\tvoid _debugger_breaked(bool p_breaked, bool p_can_debug);\n+\n protected:\n \tvoid _notification(int p_what);\n \n", "test_patch": "", "problem_statement": "Horrible Flickering when closing docks while embedded game is paused\n### Tested versions\n\n- Reproducible in Godot 4.4 beta1\n\n### System information\n\n\ud83e\ude9f Windows 11 - \ud83e\udd16 Godot 4.4 beta1\n\n### Issue description\n\nClosing a dock while the game is paused and embedded causes the screen to flicker pretty badly.\n\n\u26a0\ufe0f Photosensitivity warning \u26a0\ufe0f\n\ud83c\udfa5 See screen recording:\n\nhttps://github.com/user-attachments/assets/4cb0c17c-bc7b-4723-9e30-91b3ea54bf1f\n\n### Steps to reproduce\n\nEnable 'Embed Game on Next Play' in the Game tab.\n\n1. Run a game.\n2. Open a dock.\n3. Pause the game. \n4. Close the dock.\n5. Survive the flickering \u26a0\ufe0f\ud83d\udd26\ud83d\udcf8\ud83d\udca5\ud83d\ude35\u200d\ud83d\udcab\ud83d\ude35\u200d\ud83d\udcab\ud83d\ude35\u200d\ud83d\udcab\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Thanks for reporting the issue.\n\nI'm unfortunately not able to reproduce on my computer on Windows 11 with 4.4 Beta 1 or with the current master version.\n\nCan you give us a little more information:\n- Are you using the Pause button on the right or the Suspend button on the left? Does the same issue happens in both pause mode?\n![Image](https://github.com/user-attachments/assets/58a087e7-06b7-406f-9b89-1572191525ad)\n\n- Does the same flickering happens when you resize the dock area or the left or right dock while the game is paused?\n- Does the flickering happens in an empty project. If not, can you give us a MRP that reproduce the error?\n- Can you give us more details on your graphic card model?\n- Are you in Compatibility mode or Forward+?\n\nI assume it's the pause button, the one in the right corner, because I couldn't detect any other visual artifacts\nhttps://github.com/user-attachments/assets/1acc2be0-b8ca-43d7-8bc2-b89d88357829\nI still can't reproduce. It's weird that the embedded causes that. It seems a problem where Godot does not rerender in some situation because it's paused. Do you have the same artefacts if running not embedded, pause the game and try to resize the game window?\nI'm able to reproduce, but only in the Floating Window, not in embedded in the editor. Fun fact, the actefact are present for me even when not embedded at all. I guess this bug was there before the embedding but it was not very problematic because nobody tries to resize the game window while it's paused usually.\n\nhttps://github.com/user-attachments/assets/ed6b2f91-a3aa-49fa-a723-24c144949a33\nCan confirm it only happens with the top right pause button.\nThe dock has to be open before pausing. If the dock opens because of the pause action, the game properly resizes and there's no flickering.\nThe game size not updating while paused is somewhat expected, but the the flickering (when embedded) seems very undesireable.\n\nSorry, should've mentioned I'm on Compatability backend with an AMD Ryzen 6800U.\n\nHmmmm... wasn't able to get it to flicker in a fresh project. Neither on Forward+ nor Compatability... Might have something to do with redraws in my project. Tho I don't think I'm doing anything crazy there.\nThanks for the info. It's definitively something with the redraw, but I don't think it's really some specific to your project. I think it will be difficult to fix Godot to force the rerender when the game is paused. I'm working on a workaround to hide the game and display a message when the game is embedded, paused and resized.", "created_at": "2025-01-25 01:58:02", "merge_commit_sha": "108e662bea1cf4367c5c1ab9c6aba2d2600507c6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101987", "base_commit": "b0655dc86f096b3496a9ab5b18965676d4fb35ba", "patch": "diff --git a/platform/linuxbsd/wayland/display_server_wayland.cpp b/platform/linuxbsd/wayland/display_server_wayland.cpp\nindex 532eaa6bcf49..f9b34ff043bf 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.cpp\n+++ b/platform/linuxbsd/wayland/display_server_wayland.cpp\n@@ -1033,7 +1033,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \t\tHashMap<CursorShape, CustomCursor>::Iterator cursor_c = custom_cursors.find(p_shape);\n \n \t\tif (cursor_c) {\n-\t\t\tif (cursor_c->value.rid == p_cursor->get_rid() && cursor_c->value.hotspot == p_hotspot) {\n+\t\t\tif (cursor_c->value.resource == p_cursor && cursor_c->value.hotspot == p_hotspot) {\n \t\t\t\t// We have a cached cursor. Nice.\n \t\t\t\twayland_thread.cursor_set_shape(p_shape);\n \t\t\t\treturn;\n@@ -1049,7 +1049,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \n \t\tCustomCursor &cursor = custom_cursors[p_shape];\n \n-\t\tcursor.rid = p_cursor->get_rid();\n+\t\tcursor.resource = p_cursor;\n \t\tcursor.hotspot = p_hotspot;\n \n \t\twayland_thread.cursor_shape_set_custom_image(p_shape, image, p_hotspot);\ndiff --git a/platform/linuxbsd/wayland/display_server_wayland.h b/platform/linuxbsd/wayland/display_server_wayland.h\nindex 8c3bac9c7e3b..43a8b01b3208 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.h\n+++ b/platform/linuxbsd/wayland/display_server_wayland.h\n@@ -101,7 +101,7 @@ class DisplayServerWayland : public DisplayServer {\n \t};\n \n \tstruct CustomCursor {\n-\t\tRID rid;\n+\t\tRef<Resource> resource;\n \t\tPoint2i hotspot;\n \t};\n \n", "test_patch": "", "problem_statement": "Wayland Cursor custom image doesn't update when using Image instead of Texture2D\n### Tested versions\n\n- v4.4.beta.gentoo [4ce466d7f]\n\n### System information\n\nLinux Gentoo using Wayland\n\n### Issue description\n\nWhen using the Wayland DisplayServer you can only update the custom mouse cursor once if you are using Image instead of Texture2D resources and the images have the same hotspot.\n\nThe function `Input.set_custom_mouse_cursor` claims that it is okay to use either an Image or a Texture2D as a custom cursor image. The caching code in `DisplayServerWayland::cursor_set_custom_image` checks for cursor reuse using \"get_rid()\" on the provided resource. Since an Image does not have a RID, any image will always enter the branch `// We have a cached cursor. Nice.`.\n\nBug is visible since #96647 was fixed, although the underlying bug was already older than that.\n\n### Workarounds\n* Use Texture2D instead of image resources - may cause undesired overhead to convert back to image\n* Reset the cursor in between - may cause cursor flickering\n* Move the hotspot locations to force a cache miss - unwanted extra work to make images suitable with different hotspots\n\n### Steps to reproduce\n\n* Force editor and game to use the Wayland display server\n* Make sure the referenced `img1` and `img2` are imported as Image and not as Texture.\n\n```gdscript\nInput.set_custom_mouse_cursor(img1, Input.CURSOR_ARROW)\n# Correctly shows img1 as the cursor\nInput.set_custom_mouse_cursor(img2, Input.CURSOR_ARROW)\n# Still shows img1 as the cursor\n```\n\n### Minimal reproduction project (MRP)\n\n[wayland-cursor-reproducer.zip](https://github.com/user-attachments/files/18510307/wayland-cursor-reproducer.zip)\n", "hints_text": "Hi, thank you for you report and for the thorough analysis!\n\n> Since an Image does not have a RID\n\nShoot, I really had no idea. You just saved me from _a lot_ of debugging :D\n\nYou see, this `Image` thing is actually relatively new. For a long time the custom cursor method only supported `Texture2D` but then #88970 allowed images and this quirk slipped right through.\n\nI'll fix this ASAP!", "created_at": "2025-01-24 14:36:43", "merge_commit_sha": "4f3dddbbffb272b561b89f8bbc28955040750c7e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101952", "base_commit": "b0655dc86f096b3496a9ab5b18965676d4fb35ba", "patch": "diff --git a/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl b/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\nindex 8e393c07bdb2..6fb8fe6ca339 100644\n--- a/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\n+++ b/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\n@@ -733,7 +733,7 @@ void light_process_spot(uint idx, vec3 vertex, vec3 eye_vec, vec3 normal, vec3 v\n \t\tvec4 v = vec4(vertex + normal_bias, 1.0);\n \n \t\tvec4 splane = (spot_lights.data[idx].shadow_matrix * v);\n-\t\tsplane.z += spot_lights.data[idx].shadow_bias / (light_length * spot_lights.data[idx].inv_radius);\n+\t\tsplane.z += spot_lights.data[idx].shadow_bias;\n \t\tsplane /= splane.w;\n \n \t\tif (sc_use_light_soft_shadows() && spot_lights.data[idx].soft_shadow_size > 0.0) {\ndiff --git a/servers/rendering/renderer_scene_cull.cpp b/servers/rendering/renderer_scene_cull.cpp\nindex 0b98fc6769e7..ef79ef8cda7a 100644\n--- a/servers/rendering/renderer_scene_cull.cpp\n+++ b/servers/rendering/renderer_scene_cull.cpp\n@@ -2510,7 +2510,7 @@ bool RendererSceneCull::_light_instance_update_shadow(Instance *p_instance, cons\n \t\t\t\t}\n \n \t\t\t\treal_t radius = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_RANGE);\n-\t\t\t\treal_t z_near = MIN(0.005f, radius);\n+\t\t\t\treal_t z_near = MIN(0.025f, radius);\n \t\t\t\tProjection cm;\n \t\t\t\tcm.set_perspective(90, 1, z_near, radius);\n \n@@ -2600,7 +2600,7 @@ bool RendererSceneCull::_light_instance_update_shadow(Instance *p_instance, cons\n \n \t\t\treal_t radius = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_RANGE);\n \t\t\treal_t angle = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_SPOT_ANGLE);\n-\t\t\treal_t z_near = MIN(0.005f, radius);\n+\t\t\treal_t z_near = MIN(0.025f, radius);\n \n \t\t\tProjection cm;\n \t\t\tcm.set_perspective(angle * 2.0, 1.0, z_near, radius);\n", "test_patch": "", "problem_statement": "SpotLight3D shadow has significant peter-panning with default settings (4.4-dev7 and 4.4-beta1)\n### Tested versions\n\nReproducible in: 4.4-dev7 and 4.4-beta1\nNot reproducible in: 4.4-dev6 and before\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 (NVIDIA; 32.0.15.6603) - 13th Gen Intel(R) Core(TM) i7-13700K (24 threads)\n\n### Issue description\n\nShadow casting SpotLight3D has noticeable peter-panning effect with default bias value. Example below:\n\n![Image](https://github.com/user-attachments/assets/501f57ff-6c38-477d-aa8e-0e2e695ab5ba)\n\n### Steps to reproduce\n\nCreate a new 3D scene\nAdd floor into the scene and add mesh on the floor\nAdd SpotLight3D and enable shadows\nPoint the spotlight towards mesh and observe shadow it casts\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Confirmed, bisecting\nBisected to https://github.com/godotengine/godot/pull/100319, CC @Flarkk\n\nIt doesn't seem like this was an intentional or expected change, can confirm this with a very normal setup, see MRP\n\n[MRP.zip](https://github.com/user-attachments/files/18494408/MRP.zip)\nWhat's the bias of the spotlight in the MRP ? 0.1 or 0.001 ? (I don't have my computer at hand right now).\n\nI remember there was a hard coded factor somewhere for spotlights bias I had trouble with until I figured it out at the time of writing #100319\nIt's default settings, which should be sufficient in this case I'd say, everything is bog standard\nI'm wondering whether the standard value could have changed and make this issue apparent now but not at the time of my PR. \n\nThis is because I remember that at this time the bias input was multiplied or divided by 100 or something for spotlights somewhere before being passed to the rendering logic (don't know why). If this has changed since then it can have a material impact.\n\nWill check when I get back to my computer.\nBut if the default value changed it wouldn't show up, because the default isn't stored, so a project created in 4.4.beta1 would still show up the same at the time the PR was merged, it *could* have changed while you were working on it though, but it was apparent at the time of merger\n\nIt occurs immediately at the PR, and at the merged branch (i.e. without rebase), but not immediately before it\nOh yes it's not stored, you're right.\nWill take a look.\nI found that the problem is the 0.005 I chose for the fixed light znear, thinking that the default light range was 1 and that this would behave like before (znear = 0.005 * range).\n\nBut the default range is actually 5, so znar has to be 0.025 to behave as before with the default setup.\n\nWith that fixed I noticed something else : peter-panning now visibly grows with the spotlight's range even at reasonable values. This is not the case with Omnis that now behave exactly like before.\n\nI'm now investigating whether it could be related to the hardcoded bias factor set to spotlights I mentioned above :\nhttps://github.com/godotengine/godot/blob/a7146ef807a7676f51a8a63cf4441ad647f4be66/servers/rendering/renderer_rd/storage_rd/light_storage.cpp#L963-L967\n\nWill issue a PR once I resolved this too.", "created_at": "2025-01-23 08:34:10", "merge_commit_sha": "c695eb9159ef0273cc9c15cb73a3e7048e3e9935", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101895", "base_commit": "a7146ef807a7676f51a8a63cf4441ad647f4be66", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex b1f7a8498a3a..f0f1a915f011 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -652,14 +652,20 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \tr_arguments.insert_after(N, itos(rect.size.x) + \"x\" + itos(rect.size.y));\n }\n \n-void GameView::_window_before_closing() {\n+void GameView::_window_close_request() {\n \t// Before the parent window closed, we close the embedded game. That prevents\n \t// the embedded game to be seen without a parent window for a fraction of second.\n \tif (EditorRunBar::get_singleton()->is_playing() && (embedded_process->is_embedding_completed() || embedded_process->is_embedding_in_progress())) {\n+\t\t// Try to gracefully close the window. That way, the NOTIFICATION_WM_CLOSE_REQUEST\n+\t\t// notification should be propagated in the game process.\n \t\tembedded_process->reset();\n-\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n-\t\t// actually closes.\n-\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\n+\t\t// When the embedding is not complete, we need to kill the process.\n+\t\tif (embedded_process->is_embedding_in_progress()) {\n+\t\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n+\t\t\t// actually closes.\n+\t\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\t\t}\n \t}\n }\n \n@@ -829,7 +835,8 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tp_debugger->connect(\"session_started\", callable_mp(this, &GameView::_sessions_changed));\n \tp_debugger->connect(\"session_stopped\", callable_mp(this, &GameView::_sessions_changed));\n \n-\tp_wrapper->connect(\"window_before_closing\", callable_mp(this, &GameView::_window_before_closing));\n+\tp_wrapper->set_override_close_request(true);\n+\tp_wrapper->connect(\"window_close_requested\", callable_mp(this, &GameView::_window_close_request));\n \tp_wrapper->connect(\"window_size_changed\", callable_mp(this, &GameView::_update_floating_window_settings));\n }\n \ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 959da73dcde8..273652dae821 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -162,7 +162,7 @@ class GameView : public VBoxContainer {\n \tvoid _camera_override_button_toggled(bool p_pressed);\n \tvoid _camera_override_menu_id_pressed(int p_id);\n \n-\tvoid _window_before_closing();\n+\tvoid _window_close_request();\n \tvoid _update_floating_window_settings();\n \tvoid _attach_script_debugger();\n \tvoid _detach_script_debugger();\ndiff --git a/editor/window_wrapper.cpp b/editor/window_wrapper.cpp\nindex 37a3efc91e90..22e2fda68567 100644\n--- a/editor/window_wrapper.cpp\n+++ b/editor/window_wrapper.cpp\n@@ -101,12 +101,6 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \n \tNode *parent = _get_wrapped_control_parent();\n \n-\t// In the GameView plugin, we need to the the signal before the window is actually closed\n-\t// to prevent the embedded game to be seen the parent window for a fraction of a second.\n-\tif (!p_visible) {\n-\t\temit_signal(\"window_before_closing\");\n-\t}\n-\n \tif (wrapped_control->get_parent() != parent) {\n \t\t// Move the control to the window.\n \t\twrapped_control->reparent(parent, false);\n@@ -120,7 +114,7 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \t}\n \n \twindow->set_visible(p_visible);\n-\tif (!p_visible) {\n+\tif (!p_visible && !override_close_request) {\n \t\temit_signal(\"window_close_requested\");\n \t}\n \temit_signal(\"window_visibility_changed\", p_visible);\n@@ -141,10 +135,17 @@ void WindowWrapper::_window_size_changed() {\n \temit_signal(SNAME(\"window_size_changed\"));\n }\n \n+void WindowWrapper::_window_close_request() {\n+\tif (override_close_request) {\n+\t\temit_signal(\"window_close_requested\");\n+\t} else {\n+\t\tset_window_enabled(false);\n+\t}\n+}\n+\n void WindowWrapper::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"window_visibility_changed\", PropertyInfo(Variant::BOOL, \"visible\")));\n \tADD_SIGNAL(MethodInfo(\"window_close_requested\"));\n-\tADD_SIGNAL(MethodInfo(\"window_before_closing\"));\n \tADD_SIGNAL(MethodInfo(\"window_size_changed\"));\n }\n \n@@ -330,6 +331,10 @@ void WindowWrapper::grab_window_focus() {\n \t}\n }\n \n+void WindowWrapper::set_override_close_request(bool p_enabled) {\n+\toverride_close_request = p_enabled;\n+}\n+\n WindowWrapper::WindowWrapper() {\n \tif (!EditorNode::get_singleton()->is_multi_window_enabled()) {\n \t\treturn;\n@@ -342,7 +347,7 @@ WindowWrapper::WindowWrapper() {\n \tadd_child(window);\n \twindow->hide();\n \n-\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::set_window_enabled).bind(false));\n+\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::_window_close_request));\n \twindow->connect(\"size_changed\", callable_mp(this, &WindowWrapper::_window_size_changed));\n \n \tShortcutBin *capturer = memnew(ShortcutBin);\ndiff --git a/editor/window_wrapper.h b/editor/window_wrapper.h\nindex 3f4e9385861c..e33c8c179d53 100644\n--- a/editor/window_wrapper.h\n+++ b/editor/window_wrapper.h\n@@ -50,12 +50,15 @@ class WindowWrapper : public MarginContainer {\n \n \tRef<Shortcut> enable_shortcut;\n \n+\tbool override_close_request = false;\n+\n \tRect2 _get_default_window_rect() const;\n \tNode *_get_wrapped_control_parent() const;\n \n \tvoid _set_window_enabled_with_rect(bool p_visible, const Rect2 p_rect);\n \tvoid _set_window_rect(const Rect2 p_rect);\n \tvoid _window_size_changed();\n+\tvoid _window_close_request();\n \n protected:\n \tstatic void _bind_methods();\n@@ -84,6 +87,8 @@ class WindowWrapper : public MarginContainer {\n \tvoid set_margins_enabled(bool p_enabled);\n \tvoid grab_window_focus();\n \n+\tvoid set_override_close_request(bool p_enabled);\n+\n \tWindowWrapper();\n \t~WindowWrapper();\n };\ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex b17f72dc5c04..b1945eb47a2e 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -5849,6 +5849,24 @@ Error DisplayServerX11::remove_embedded_process(OS::ProcessID p_pid) {\n \t}\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n+\n+\t// Handle bad window errors silently because just in case the embedded window was closed.\n+\tint (*oldHandler)(Display *, XErrorEvent *) = XSetErrorHandler(&bad_window_error_handler);\n+\n+\t// Send the message to gracefully close the window.\n+\tXEvent ev;\n+\tmemset(&ev, 0, sizeof(ev));\n+\tev.xclient.type = ClientMessage;\n+\tev.xclient.window = ep->process_window;\n+\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n+\tev.xclient.format = 32;\n+\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n+\tev.xclient.data.l[1] = CurrentTime;\n+\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\n+\t// Restore default error handler.\n+\tXSetErrorHandler(oldHandler);\n+\n \tembedded_processes.erase(p_pid);\n \tmemdelete(ep);\n \ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex ac7fa8b3c69e..1d3a6f0ca4f2 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -2975,6 +2975,9 @@ Error DisplayServerWindows::remove_embedded_process(OS::ProcessID p_pid) {\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n \n+\t// Send a close message to gracefully close the process.\n+\tPostMessage(ep->window_handle, WM_CLOSE, 0, 0);\n+\n \t// This is a workaround to ensure the parent window correctly regains focus after the\n \t// embedded window is closed. When the embedded window is closed while it has focus,\n \t// the parent window (the editor) does not become active. It appears focused but is not truly activated.\n", "test_patch": "", "problem_statement": "Closing game running in editor no longer sends NotificationWMCloseRequest - v4.4Beta1\n### Tested versions\n\n- Reproducible in 4.4Beta1 .NET\n- Not reproducible in 4.3 .NET\n\n### System information\n\nWindows 11 - Godot_v4.4-beta1_mono_win64\n\n### Issue description\n\nWhen closing the game while running it via the editor, a NotificationWMCloseRequest is no longer sent in 4.4.\n\n### Steps to reproduce\n\nSee minimal reproduction project\n\n### Minimal reproduction project (MRP)\n\nAttached is a simple 'save on exit' project that will demonstrate the issue.  When running the game in the editor interface in 4.3, the entire game state will be saved upon closing (and loaded when you next restart the game).  When running the game in the editor interface in 4.4, the game will no longer save because a NotificationWMCloseRequest is no longer sent when the game is closing.\n\nNote: The `StageManager` class is responsible for receiving the NotificationWMCloseRequest in this project.\n\n[BrackeysFirstSavedGame.zip](https://github.com/user-attachments/files/18483606/BrackeysFirstSavedGame.zip)\n", "hints_text": "Seems like another issue with embedded mode.\n\nIt is still work if you run the project in non-embedded mode. `NOTIFICATION_WM_CLOSE_REQUEST` is sent when `close` button in the window title is pressed, not when the game exits. It's not emitted when closing by any other means (like `get_tree().quit()` for example).\n\nWhen running in an embedded / floating mode, the actual window title bar is not visible, and closing the floating window stops the game instantly (same as pressing the stop button in the editor).\nI disabled embedded-mode and, you are correct, everything appears to be working again.\n\nI think it would be preferable as a future enhancement to cause quitting the game while in embedded mode or via clicking the `Stop Running Project` button to trigger a `NOTIFICATION_WM_CLOSE_REQUEST`, but it can maybe be argued this is not a regression.", "created_at": "2025-01-22 02:01:55", "merge_commit_sha": "76f074b01d089cdfa0272b5515585979b6607da9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101803", "base_commit": "7b1ed520bdcca21d36e25e2094802b9b33dae2c6", "patch": "diff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex d1a40e7b105c..ac2b37470ef1 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -210,20 +210,6 @@ void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \tp_jolt_body.MoveKinematic(new_position, new_rotation, p_step);\n }\n \n-void JoltBody3D::_pre_step_rigid(float p_step, JPH::Body &p_jolt_body) {\n-\t_integrate_forces(p_step, p_jolt_body);\n-\t_enqueue_call_queries();\n-}\n-\n-void JoltBody3D::_pre_step_kinematic(float p_step, JPH::Body &p_jolt_body) {\n-\t_update_gravity(p_jolt_body);\n-\t_move_kinematic(p_step, p_jolt_body);\n-\n-\tif (reports_contacts()) {\n-\t\t_enqueue_call_queries();\n-\t}\n-}\n-\n JPH::EAllowedDOFs JoltBody3D::_calculate_allowed_dofs() const {\n \tif (is_static()) {\n \t\treturn JPH::EAllowedDOFs::All;\n@@ -1237,13 +1223,18 @@ void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID:\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID_LINEAR: {\n-\t\t\t_pre_step_rigid(p_step, p_jolt_body);\n+\t\t\t_integrate_forces(p_step, p_jolt_body);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_KINEMATIC: {\n-\t\t\t_pre_step_kinematic(p_step, p_jolt_body);\n+\t\t\t_update_gravity(p_jolt_body);\n+\t\t\t_move_kinematic(p_step, p_jolt_body);\n \t\t} break;\n \t}\n \n+\tif (_should_call_queries()) {\n+\t\t_enqueue_call_queries();\n+\t}\n+\n \tcontact_count = 0;\n }\n \ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.h b/modules/jolt_physics/objects/jolt_body_3d.h\nindex 4f5d4006edcf..9b9472e73ae8 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_body_3d.h\n@@ -110,6 +110,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvirtual void _add_to_space() override;\n \n+\tbool _should_call_queries() const { return state_sync_callback.is_valid() || custom_integration_callback.is_valid(); }\n \tvoid _enqueue_call_queries();\n \tvoid _dequeue_call_queries();\n \n@@ -117,9 +118,6 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvoid _move_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n-\tvoid _pre_step_rigid(float p_step, JPH::Body &p_jolt_body);\n-\tvoid _pre_step_kinematic(float p_step, JPH::Body &p_jolt_body);\n-\n \tJPH::EAllowedDOFs _calculate_allowed_dofs() const;\n \n \tJPH::MassProperties _calculate_mass_properties(const JPH::Shape &p_shape) const;\n", "test_patch": "", "problem_statement": "Jolt Physics and sync_to_physics prevents any AnimatableBody3D transforms\n### Tested versions\n\n- Reproducible: 4.4.beta1\n- Not reproducible: 4.4.dev7\n\n### System information\n\nGodot v4.4.beta1 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1070 (NVIDIA; 32.0.15.6094) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nUsing the Jolt physics engine and enabling `AnimatableBody3D.sync_to_physics` stops the object from moving at all when setting a transform, position or similar.\n\nDisabling `sync_to_physics`, or switching to the Godot physics engine fixes the problem.\n\n \n\n### Steps to reproduce\n\nCreate an `AnimatableBody3D` Node. Set `sync_to_physics` to true. Use the Jolt physics engine.\n\n### Minimal reproduction project (MRP)\n\n[jolt-transform-bug.zip](https://github.com/user-attachments/files/18464415/jolt-transform-bug.zip)\n\n", "hints_text": "I guess https://github.com/godotengine/godot/pull/100056 now depends on this \nThis looks to be yet another regression caused by #100983.", "created_at": "2025-01-19 15:34:02", "merge_commit_sha": "7c69fbd292a9aeb28399d1743866b9c70561bc77", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101760", "base_commit": "7b1ed520bdcca21d36e25e2094802b9b33dae2c6", "patch": "diff --git a/modules/websocket/wsl_peer.cpp b/modules/websocket/wsl_peer.cpp\nindex 9ffc343571e8..f50b4c480652 100644\n--- a/modules/websocket/wsl_peer.cpp\n+++ b/modules/websocket/wsl_peer.cpp\n@@ -860,10 +860,12 @@ void WSLPeer::close(int p_code, String p_reason) {\n \t\t}\n \t}\n \n-\theartbeat_waiting = false;\n-\tin_buffer.clear();\n-\tpacket_buffer.resize(0);\n-\tpending_message.clear();\n+\tif (ready_state == STATE_CLOSED) {\n+\t\theartbeat_waiting = false;\n+\t\tin_buffer.clear();\n+\t\tpacket_buffer.resize(0);\n+\t\tpending_message.clear();\n+\t}\n }\n \n IPAddress WSLPeer::get_connected_host() const {\n", "test_patch": "", "problem_statement": "[4.4.dev5] Websockets stuck in STATE_CLOSING\n### Tested versions\n\nStarting with 4.4.dev5\nConfirmed to work with 4.4.dev4\n\n### System information\n\nGodot v4.4.dev5 - Windows 10.0.26100 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 6700 XT (Advanced Micro Devices, Inc.; 32.0.12033.1030) - Intel(R) Core(TM) i5-9600K CPU @ 3.70GHz (6 threads)\n\n### Issue description\n\nClient WebSocketPeers get stuck on STATE_CLOSING when close() is called.\n\n### Steps to reproduce\n\n- Download MRP with any Godot version >= 4.4.dev5\n- Click on \"Client disconnect\"\n- Check output\n\n### Minimal reproduction project (MRP)\n\n[100948.zip](https://github.com/user-attachments/files/18277136/100948.zip)\n\n", "hints_text": "", "created_at": "2025-01-18 15:00:47", "merge_commit_sha": "7a63dc94ae9c7e4db1144bd47096fe8010c09046", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101752", "base_commit": "7b1ed520bdcca21d36e25e2094802b9b33dae2c6", "patch": "diff --git a/core/core_bind.cpp b/core/core_bind.cpp\nindex 6974d98234cc..acd589783ece 100644\n--- a/core/core_bind.cpp\n+++ b/core/core_bind.cpp\n@@ -113,12 +113,12 @@ PackedStringArray ResourceLoader::get_dependencies(const String &p_path) {\n }\n \n bool ResourceLoader::has_cached(const String &p_path) {\n-\tString local_path = ProjectSettings::get_singleton()->localize_path(p_path);\n+\tString local_path = ::ResourceLoader::_validate_local_path(p_path);\n \treturn ResourceCache::has(local_path);\n }\n \n Ref<Resource> ResourceLoader::get_cached_ref(const String &p_path) {\n-\tString local_path = ProjectSettings::get_singleton()->localize_path(p_path);\n+\tString local_path = ::ResourceLoader::_validate_local_path(p_path);\n \treturn ResourceCache::get_ref(local_path);\n }\n \ndiff --git a/core/io/resource_loader.cpp b/core/io/resource_loader.cpp\nindex 8f873d859b65..7cc91ef4318b 100644\n--- a/core/io/resource_loader.cpp\n+++ b/core/io/resource_loader.cpp\n@@ -495,7 +495,7 @@ void ResourceLoader::_run_load_task(void *p_userdata) {\n \tcurr_load_task = curr_load_task_backup;\n }\n \n-static String _validate_local_path(const String &p_path) {\n+String ResourceLoader::_validate_local_path(const String &p_path) {\n \tResourceUID::ID uid = ResourceUID::get_singleton()->text_to_id(p_path);\n \tif (uid != ResourceUID::INVALID_ID) {\n \t\treturn ResourceUID::get_singleton()->get_id_path(uid);\ndiff --git a/core/io/resource_loader.h b/core/io/resource_loader.h\nindex f933e88b23bf..56052b6a6fc4 100644\n--- a/core/io/resource_loader.h\n+++ b/core/io/resource_loader.h\n@@ -36,6 +36,10 @@\n #include \"core/object/worker_thread_pool.h\"\n #include \"core/os/thread.h\"\n \n+namespace core_bind {\n+class ResourceLoader;\n+}\n+\n class ConditionVariable;\n \n template <int Tag>\n@@ -101,6 +105,7 @@ typedef void (*ResourceLoadedCallback)(Ref<Resource> p_resource, const String &p\n \n class ResourceLoader {\n \tfriend class LoadToken;\n+\tfriend class core_bind::ResourceLoader;\n \n \tenum {\n \t\tMAX_LOADERS = 64\n@@ -217,6 +222,8 @@ class ResourceLoader {\n \n \tstatic bool _ensure_load_progress();\n \n+\tstatic String _validate_local_path(const String &p_path);\n+\n public:\n \tstatic Error load_threaded_request(const String &p_path, const String &p_type_hint = \"\", bool p_use_sub_threads = false, ResourceFormatLoader::CacheMode p_cache_mode = ResourceFormatLoader::CACHE_MODE_REUSE);\n \tstatic ThreadLoadStatus load_threaded_get_status(const String &p_path, float *r_progress = nullptr);\n", "test_patch": "", "problem_statement": "[4.4beta1] ResourceLoader.has_cached() does not return proper values for UIDs\n### Tested versions\n\nReproducible in 4.4 dev 4, 5, 6, 7, and beta 1. Probably in previous 4.4 dev builds as well.\n\n### System information\n\nGodot v4.4.beta1 - Arch Linux #1 SMP PREEMPT_DYNAMIC Fri, 10 Jan 2025 00:39:41 +0000 on Wayland - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated AMD Radeon RX 6600 XT (RADV NAVI23) - AMD Ryzen 5 5600X 6-Core Processor (12 threads)\n\n### Issue description\n\nPassing a UID into `ResourceLoader.has_cached()` returns `false` for a resource that is cached. Passing the resource path for the resource with the same UID properly returns `true`.\n\n### Steps to reproduce\n\n1. Create a Sprite2D node and attach the `icon.svg` as the texture.\n2. Attach a script to the Sprite2D node to see if the `icon.svg` resource is cached. Something like:\n```\nextends Sprite2D\n\nvar resource_path: String = \"res://icon.svg\"\nvar uid: String = \"\" # Insert UID of icon.svg here.\n\n\nfunc _ready():\n\tprint(\"ResourceLoader.has_cached results:\\nResource Path: \",\n\t\t\tResourceLoader.has_cached(resource_path), \" UID: \", ResourceLoader.has_cached(uid))\n```\n3. Observe that passing the resource path returns `true` whereas passing the UID returns `false`.\n\n### Minimal reproduction project (MRP)\n\n[resource-loader-bug.zip](https://github.com/user-attachments/files/18463852/resource-loader-bug.zip)\n", "hints_text": "While ResourceLoader class in core has been properly changed to handle UIDs, the `has_cached()` function has no ResourceLoader equivalent and is just handled in `core_bind.cpp`.\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/core_bind.cpp#L115-L118\nDoing a brief once over of the `localize_path()` function, it does not seem to be able to handle UIDs.\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/config/project_settings.cpp#L149-L213\nSomewhere in this chain, UIDs probably need to be properly handled as the rest of ResourceLoader functions seem fit to handle them.\n\nEdit: As reference, ResourceLoader passes `path`s to this function and refers to the returned path as the `local_path`:\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/io/resource_loader.cpp#L498-L507\n`ResourceLoader.get_cached_ref()` probably has the same problem.\nhttps://github.com/godotengine/godot/blob/7b1ed520bdcca21d36e25e2094802b9b33dae2c6/core/core_bind.cpp#L120-L122", "created_at": "2025-01-18 12:32:53", "merge_commit_sha": "376b1c9de9c05b5cedfc9f53daed294e8148f964", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101726", "base_commit": "b15b24b087e792335d919fd83055f50f276fbe22", "patch": "diff --git a/SConstruct b/SConstruct\nindex 94bef048a072..8f8f329f233d 100644\n--- a/SConstruct\n+++ b/SConstruct\n@@ -107,22 +107,11 @@ for x in sorted(glob.glob(\"platform/*\")):\n     sys.path.remove(tmppath)\n     sys.modules.pop(\"detect\")\n \n-custom_tools = [\"default\"]\n-\n-platform_arg = ARGUMENTS.get(\"platform\", ARGUMENTS.get(\"p\", False))\n-\n-if platform_arg == \"android\":\n-    custom_tools = [\"clang\", \"clang++\", \"as\", \"ar\", \"link\"]\n-elif platform_arg == \"web\":\n-    # Use generic POSIX build toolchain for Emscripten.\n-    custom_tools = [\"cc\", \"c++\", \"ar\", \"link\", \"textfile\", \"zip\"]\n-elif os.name == \"nt\" and methods.get_cmdline_bool(\"use_mingw\", False):\n-    custom_tools = [\"mingw\"]\n-\n # We let SCons build its default ENV as it includes OS-specific things which we don't\n-# want to have to pull in manually.\n+# want to have to pull in manually. However we enforce no \"tools\", which we register\n+# further down after parsing our platform-specific configuration.\n # Then we prepend PATH to make it take precedence, while preserving SCons' own entries.\n-env = Environment(tools=custom_tools)\n+env = Environment(tools=[])\n env.PrependENVPath(\"PATH\", os.getenv(\"PATH\"))\n env.PrependENVPath(\"PKG_CONFIG_PATH\", os.getenv(\"PKG_CONFIG_PATH\"))\n if \"TERM\" in os.environ:  # Used for colored output.\n@@ -168,11 +157,7 @@ if profile:\n opts = Variables(customs, ARGUMENTS)\n \n # Target build options\n-if env.scons_version >= (4, 3):\n-    opts.Add([\"platform\", \"p\"], \"Target platform (%s)\" % \"|\".join(platform_list), \"\")\n-else:\n-    opts.Add(\"platform\", \"Target platform (%s)\" % \"|\".join(platform_list), \"\")\n-    opts.Add(\"p\", \"Alias for 'platform'\", \"\")\n+opts.Add(([\"platform\", \"p\"], \"Target platform (%s)\" % \"|\".join(platform_list), \"\"))\n opts.Add(EnumVariable(\"target\", \"Compilation target\", \"editor\", (\"editor\", \"template_release\", \"template_debug\")))\n opts.Add(EnumVariable(\"arch\", \"CPU architecture\", \"auto\", [\"auto\"] + architectures, architecture_aliases))\n opts.Add(BoolVariable(\"dev_build\", \"Developer build with dev-only debugging code (DEV_ENABLED)\", False))\n@@ -312,10 +297,7 @@ if env[\"import_env_vars\"]:\n \n # Platform selection: validate input, and add options.\n \n-if env.scons_version < (4, 3) and not env[\"platform\"]:\n-    env[\"platform\"] = env[\"p\"]\n-\n-if env[\"platform\"] == \"\":\n+if not env[\"platform\"]:\n     # Missing `platform` argument, try to detect platform automatically\n     if (\n         sys.platform.startswith(\"linux\")\n@@ -330,7 +312,7 @@ if env[\"platform\"] == \"\":\n     elif sys.platform == \"win32\":\n         env[\"platform\"] = \"windows\"\n \n-    if env[\"platform\"] != \"\":\n+    if env[\"platform\"]:\n         print(f'Automatically detected platform: {env[\"platform\"]}')\n \n # Deprecated aliases kept for compatibility.\n@@ -352,7 +334,7 @@ if env[\"platform\"] not in platform_list:\n \n     if env[\"platform\"] == \"list\":\n         print(text)\n-    elif env[\"platform\"] == \"\":\n+    elif not env[\"platform\"]:\n         print_error(\"Could not detect platform automatically.\\n\" + text)\n     else:\n         print_error(f'Invalid target platform \"{env[\"platform\"]}\".\\n' + text)\n@@ -434,6 +416,23 @@ env.modules_detected = modules_detected\n opts.Update(env, {**ARGUMENTS, **env.Dictionary()})\n Help(opts.GenerateHelpText(env))\n \n+\n+# FIXME: Tool assignment happening at this stage is a direct consequence of getting the platform logic AFTER the SCons\n+# environment was already been constructed. Fixing this would require a broader refactor where all options are setup\n+# ahead of time with native validator/converter functions.\n+tmppath = \"./platform/\" + env[\"platform\"]\n+sys.path.insert(0, tmppath)\n+import detect\n+\n+custom_tools = [\"default\"]\n+try:  # Platform custom tools are optional\n+    custom_tools = detect.get_tools(env)\n+except AttributeError:\n+    pass\n+for tool in custom_tools:\n+    env.Tool(tool)\n+\n+\n # add default include paths\n \n env.Prepend(CPPPATH=[\"#\"])\n@@ -515,10 +514,6 @@ if not env[\"deprecated\"]:\n if env[\"precision\"] == \"double\":\n     env.Append(CPPDEFINES=[\"REAL_T_IS_DOUBLE\"])\n \n-tmppath = \"./platform/\" + env[\"platform\"]\n-sys.path.insert(0, tmppath)\n-import detect\n-\n # Default num_jobs to local cpu count if not user specified.\n # SCons has a peculiarity where user-specified options won't be overridden\n # by SetOption, so we can rely on this to know if we should use our default.\n@@ -587,7 +582,7 @@ if env[\"dev_mode\"]:\n if env[\"production\"]:\n     env[\"use_static_cpp\"] = methods.get_cmdline_bool(\"use_static_cpp\", True)\n     env[\"debug_symbols\"] = methods.get_cmdline_bool(\"debug_symbols\", False)\n-    if platform_arg == \"android\":\n+    if env[\"platform\"] == \"android\":\n         env[\"swappy\"] = methods.get_cmdline_bool(\"swappy\", True)\n     # LTO \"auto\" means we handle the preferred option in each platform detect.py.\n     env[\"lto\"] = ARGUMENTS.get(\"lto\", \"auto\")\ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 03a208391cf3..571cfd9819c0 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -19,6 +19,10 @@ def can_build():\n     return os.path.exists(get_env_android_sdk_root())\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    return [\"clang\", \"clang++\", \"as\", \"ar\", \"link\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable\n \ndiff --git a/platform/web/detect.py b/platform/web/detect.py\nindex 87315a405f27..9b9234480408 100644\n--- a/platform/web/detect.py\n+++ b/platform/web/detect.py\n@@ -28,6 +28,11 @@ def can_build():\n     return WhereIs(\"emcc\") is not None\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    # Use generic POSIX build toolchain for Emscripten.\n+    return [\"cc\", \"c++\", \"ar\", \"link\", \"textfile\", \"zip\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable\n \ndiff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 943de74a3e9d..db65bb64a7b5 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -155,6 +155,13 @@ def detect_build_env_arch():\n     return \"\"\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    if os.name != \"nt\" or env[\"use_mingw\"]:\n+        return [\"mingw\"]\n+    else:\n+        return [\"default\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable, EnumVariable\n \n@@ -326,10 +333,6 @@ def setup_mingw(env: \"SConsEnvironment\"):\n         print_error(\"No valid compilers found, use MINGW_PREFIX environment variable to set MinGW path.\")\n         sys.exit(255)\n \n-    env.Tool(\"mingw\")\n-    env.AppendUnique(CCFLAGS=env.get(\"ccflags\", \"\").split())\n-    env.AppendUnique(RCFLAGS=env.get(\"rcflags\", \"\").split())\n-\n     print(\"Using MinGW, arch %s\" % (env[\"arch\"]))\n \n \n", "test_patch": "", "problem_statement": "SCons detect configure removes LINKFLAGS added beforehand (eg. command line)\n### Tested versions\n\nReproducible: Master\nNot Reproducible: 4.3\n\n### System information\n\nGodot v4.4.dev (bb2225753) - Windows 11 (build 22631) - Multi-window, 3 monitors - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 4070 (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 3700X 8-Core Processor (16 threads)\n\n### Issue description\n\nHey,\n\nbuilding with SCons on Master does not respect linkflags in the command line anymore (4.3 is not a problem).\nThats the build command I use:\n```scons dev_build=yes use_mingw=yes use_llvm=yes dev_mode=yes compiledb=yes linkflags=\"-Wl,-pdb=\" ccflags=\"-g -gcodeview\"```\nAnd it does not add the linkflags anymore.\n\nI could narrow it down to https://github.com/godotengine/godot/blob/1aaf20b1f1f3ab59f04db74b166540327a3f1f90/SConstruct#L616\nAdding a linkflag parameter before is ignored and after not.\nAs this was already there in 4.3, I cannot exactly tell what brought up the behavior in the current master.\n\n\n\n\n### Steps to reproduce\n\nAdd ```env.Append(LINKFLAGS=[\"-Whatever\"])``` before: https://github.com/godotengine/godot/blob/1aaf20b1f1f3ab59f04db74b166540327a3f1f90/SConstruct#L616\nIt is removed.\nAdd ```env.Append(LINKFLAGS=[\"-Whatever\"])``` after the line and it is added.\n\n### Minimal reproduction project (MRP)\n\n---\n", "hints_text": "Confirmed, that's a regression from #98105.\n\nThe `env.Tool(\"mingw\")` added in this PR in the setup function resets flags, and then it just manually reparses 2 of the potential user-defined flags but not `linkflags`.\n\nI'd question whether this change was necessary, this PR seems to add a number of hacks. (Not that it wasn't hacky before, but at least those were battle-tested hacks :P)", "created_at": "2025-01-17 23:15:25", "merge_commit_sha": "46434b0f2ee25f036ce36a7c928438b766ce1fc5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101700", "base_commit": "1b7b009674e05b566be11a5377b935f5d3d6c0ee", "patch": "diff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex e9dfbd6189c1..76b2502bade3 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -126,7 +126,10 @@ int ViewportTexture::get_width() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn 0;\n \t}\n-\treturn get_size().width;\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size.width;\n+\t}\n+\treturn vp->size.width * vp->get_stretch_transform().get_scale().width;\n }\n \n int ViewportTexture::get_height() const {\n@@ -134,7 +137,10 @@ int ViewportTexture::get_height() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn 0;\n \t}\n-\treturn get_size().height;\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size.height;\n+\t}\n+\treturn vp->size.height * vp->get_stretch_transform().get_scale().height;\n }\n \n Size2 ViewportTexture::get_size() const {\n@@ -142,8 +148,11 @@ Size2 ViewportTexture::get_size() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn Size2();\n \t}\n-\tfloat scale = MIN(vp->get_screen_transform().get_scale().width, vp->get_screen_transform().get_scale().height);\n-\treturn Size2(vp->size.width * scale, vp->size.height * scale).ceil();\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size;\n+\t}\n+\tSize2 scale = vp->get_stretch_transform().get_scale();\n+\treturn Size2(vp->size.width * scale.width, vp->size.height * scale.height).ceil();\n }\n \n RID ViewportTexture::get_rid() const {\n", "test_patch": "", "problem_statement": "TextureRect with ViewportTexture from SubViewport in SubViewportContainer crashes when switching back to scene tab.\n### Tested versions\n\n- Reproducible in v4.4-beta1.mono.official\n- Not reproducible in v4.3.stable.mono.official\n\n### System information\n\nGodot v4.4.beta1.mono - Ubuntu 24.04.1 LTS 24.04 on X11 - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 SUPER (nvidia; 550.120) - Intel(R) Core(TM) i7-14700KF (28 threads)\n\n### Issue description\n\nWhen a scene contains a `TextureRect`  inside of `CanvasLayer`, which has a `ViewportTexture` pointing to a `SubViewport` in a `SubViewportContainer`, the editor will crash when switching back to that scene tab.\n\nThis crash does not occur when `TextureRect` is not in a `CanvasLayer` or when `SubViewport` is not in a `SubViewportContainer`.\n\nA sample backtrace can be found below:\n\n```\n================================================================\nhandle_crash: Program crashed with signal 11\nEngine version: Godot Engine v4.4.beta1.mono.official (d33da79d3f8fe84be2521d25b9ba8e440cf25a88)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] /usr/lib/dotnet8/shared/Microsoft.NETCore.App/8.0.12/libcoreclr.so(+0x6068bc) [0x7ec4948068bc] (??:0)\n[2] /usr/lib/dotnet8/shared/Microsoft.NETCore.App/8.0.12/libcoreclr.so(+0x605ef5) [0x7ec494805ef5] (??:0)\n[3] /lib/x86_64-linux-gnu/libc.so.6(+0x45320) [0x7ec4cbe45320] (??:0)\n[4] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2945d4a] (??:0)\n[5] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2943eb9] (??:0)\n[6] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x294c182] (??:0)\n[7] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2a563dc] (??:0)\n[8] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2ac99e3] (??:0)\n[9] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x21180c1] (??:0)\n[10] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x477e0c8] (??:0)\n[11] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x28a284f] (??:0)\n[12] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x21180b7] (??:0)\n[13] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x477e0c8] (??:0)\n[14] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29336f6] (??:0)\n[15] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2933975] (??:0)\n[16] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2933975] (??:0)\n[17] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2934792] (??:0)\n[18] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2934a10] (??:0)\n[19] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x1950204] (??:0)\n[20] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x484291a] (??:0)\n[21] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x1cd37a6] (??:0)\n[22] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x484291a] (??:0)\n[23] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2cd0e0c] (??:0)\n[24] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2cd1bbe] (??:0)\n[25] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x294e07f] (??:0)\n[26] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29c4915] (??:0)\n[27] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29c5ab6] (??:0)\n[28] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29dc19c] (??:0)\n[29] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4f5510b] (??:0)\n[30] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4cf5ed] (??:0)\n[31] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x44a0843] (??:0)\n[32] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x44a2c2f] (??:0)\n[33] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4d8a83] (??:0)\n[34] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x41e313] (??:0)\n[35] /lib/x86_64-linux-gnu/libc.so.6(+0x2a1ca) [0x7ec4cbe2a1ca] (??:0)\n[36] /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x8b) [0x7ec4cbe2a28b] (??:0)\n[37] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x443faa] (??:0)\n-- END OF BACKTRACE --\n================================================================\n```\n\n### Steps to reproduce\n\n- Create a scene with the setup below, where the `ViewportTexture` in the `TextureRect` is pointing at `SubViewport`.\n- Open a new tab in the editor\n- Switch back to the scene containing the `TextureRect`\n\n![Image](https://github.com/user-attachments/assets/aa3adc29-9eda-498d-8762-c8be95f0e221)\n\n### Minimal reproduction project (MRP)\n\n[crashrepro.zip](https://github.com/user-attachments/files/18454471/crashrepro.zip)\n", "hints_text": "Can confirm on [4ce466d7f], with the following backtrace:\n```\n================================================================\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.4.beta.custom_build (4ce466d7fa79e351d4295d5bb47e3266089c3a59)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] SubViewport::get_screen_transform_internal (godot\\scene\\main\\viewport.cpp:5252)\n[1] Viewport::get_screen_transform (godot\\scene\\main\\viewport.cpp:3939)\n[2] ViewportTexture::get_size (godot\\scene\\main\\viewport.cpp:145)\n[3] TextureRect::get_minimum_size (godot\\scene\\gui\\texture_rect.cpp:111)\n[4] Control::_update_minimum_size_cache (godot\\scene\\gui\\control.cpp:1676)\n[5] Control::get_combined_minimum_size (godot\\scene\\gui\\control.cpp:1686)\n[6] Control::_size_changed (godot\\scene\\gui\\control.cpp:1704)\n[7] Control::_notification (godot\\scene\\gui\\control.cpp:3386)\n[8] Control::_notificationv (godot\\scene\\gui\\control.h:47)\n[9] TextureRect::_notificationv (godot\\scene\\gui\\texture_rect.h:37)\n[10] Object::notification (godot\\core\\object\\object.cpp:911)\n[11] CanvasItem::_notification (godot\\scene\\main\\canvas_item.cpp:327)\n[12] CanvasItem::_notificationv (godot\\scene\\main\\canvas_item.h:44)\n[13] Control::_notificationv (godot\\scene\\gui\\control.h:47)\n[14] TextureRect::_notificationv (godot\\scene\\gui\\texture_rect.h:37)\n[15] Object::notification (godot\\core\\object\\object.cpp:911)\n[16] Node::_propagate_enter_tree (godot\\scene\\main\\node.cpp:310)\n[17] Node::_propagate_enter_tree (godot\\scene\\main\\node.cpp:327)\n[18] Node::_propagate_enter_tree (godot\\scene\\main\\node.cpp:327)\n[19] Node::_set_tree (godot\\scene\\main\\node.cpp:3287)\n[20] Node::_add_child_nocheck (godot\\scene\\main\\node.cpp:1636)\n[21] Node::add_child (godot\\scene\\main\\node.cpp:1668)\n[22] EditorNode::_set_current_scene_nocheck (godot\\editor\\editor_node.cpp:3908)\n[23] EditorNode::_set_current_scene (godot\\editor\\editor_node.cpp:3873)\n[24] call_with_variant_args_helper<EditorNode,int,0> (godot\\core\\variant\\binder_common.h:315)\n[25] call_with_variant_args<EditorNode,int> (godot\\core\\variant\\binder_common.h:429)\n[26] CallableCustomMethodPointer<EditorNode,void,int>::call (godot\\core\\object\\callable_method_pointer.h:105)\n[27] Callable::callp (godot\\core\\variant\\callable.cpp:57)\n[28] Object::emit_signalp (godot\\core\\object\\object.cpp:1237)\n[29] Node::emit_signalp (godot\\scene\\main\\node.cpp:4022)\n[30] Object::emit_signal<int> (godot\\core\\object\\object.h:933)\n[31] EditorSceneTabs::_scene_tab_changed (godot\\editor\\gui\\editor_scene_tabs.cpp:76)\n[32] call_with_variant_args_helper<EditorSceneTabs,int,0> (godot\\core\\variant\\binder_common.h:315)\n[33] call_with_variant_args<EditorSceneTabs,int> (godot\\core\\variant\\binder_common.h:429)\n[34] CallableCustomMethodPointer<EditorSceneTabs,void,int>::call (godot\\core\\object\\callable_method_pointer.h:105)\n[35] Callable::callp (godot\\core\\variant\\callable.cpp:57)\n[36] Object::emit_signalp (godot\\core\\object\\object.cpp:1237)\n[37] Node::emit_signalp (godot\\scene\\main\\node.cpp:4022)\n[38] Object::emit_signal<int> (godot\\core\\object\\object.h:933)\n[39] TabBar::set_current_tab (godot\\scene\\gui\\tab_bar.cpp:702)\n[40] TabBar::gui_input (godot\\scene\\gui\\tab_bar.cpp:283)\n[41] Control::_call_gui_input (godot\\scene\\gui\\control.cpp:1825)\n[42] Viewport::_gui_call_input (godot\\scene\\main\\viewport.cpp:1615)\n[43] Viewport::_gui_input_event (godot\\scene\\main\\viewport.cpp:1851)\n[44] Viewport::push_input (godot\\scene\\main\\viewport.cpp:3273)\n[45] Window::_window_input (godot\\scene\\main\\window.cpp:1694)\n[46] call_with_variant_args_helper<Window,Ref<InputEvent> const &,0> (godot\\core\\variant\\binder_common.h:315)\n[47] call_with_variant_args<Window,Ref<InputEvent> const &> (godot\\core\\variant\\binder_common.h:429)\n[48] CallableCustomMethodPointer<Window,void,Ref<InputEvent> const &>::call (godot\\core\\object\\callable_method_pointer.h:105)\n[49] Callable::callp (godot\\core\\variant\\callable.cpp:57)\n[50] Callable::call<Ref<InputEvent> > (godot\\core\\variant\\variant.h:961)\n[51] DisplayServerWindows::_dispatch_input_event (godot\\platform\\windows\\display_server_windows.cpp:4189)\n[52] DisplayServerWindows::_dispatch_input_events (godot\\platform\\windows\\display_server_windows.cpp:4159)\n[53] Input::_parse_input_event_impl (godot\\core\\input\\input.cpp:922)\n[54] Input::flush_buffered_events (godot\\core\\input\\input.cpp:1203)\n[55] DisplayServerWindows::process_events (godot\\platform\\windows\\display_server_windows.cpp:3570)\n[56] OS_Windows::run (godot\\platform\\windows\\os_windows.cpp:2061)\n[57] widechar_main (godot\\platform\\windows\\godot_windows.cpp:180)\n[58] _main (godot\\platform\\windows\\godot_windows.cpp:206)\n[59] main (godot\\platform\\windows\\godot_windows.cpp:220)\n[60] WinMain (godot\\platform\\windows\\godot_windows.cpp:234)\n[61] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[62] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n================================================================\n```\n\nWill bisect\nBisected to [0bc2c269cbd6dcec44d1d780d21bea9cbcd2e436] which is:\n* https://github.com/godotengine/godot/pull/97745\n\nCC @scgm0 \n> Bisected to [[0bc2c26](https://github.com/godotengine/godot/commit/0bc2c269cbd6dcec44d1d780d21bea9cbcd2e436)] which is:\n> \n>     * [Improve blurred content of embedded windows #97745](https://github.com/godotengine/godot/pull/97745)\n> \n> \n> CC [@scgm0](https://github.com/scgm0)\n\nI'll check it out, please give me some time as my computer doesn't compile godot very fast. (I'm only replying now also because I'm just compiling godot)\n", "created_at": "2025-01-17 16:05:03", "merge_commit_sha": "b5737f897e1d5a201dba2cf900a884195f80da04", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101625", "base_commit": "0726d3c7d5125d1a72ec318a2ec4ff11f9f7f8bb", "patch": "diff --git a/scene/gui/scroll_container.cpp b/scene/gui/scroll_container.cpp\nindex f3c50c626c17..3bad76baada4 100644\n--- a/scene/gui/scroll_container.cpp\n+++ b/scene/gui/scroll_container.cpp\n@@ -292,16 +292,20 @@ void ScrollContainer::_gui_focus_changed(Control *p_control) {\n void ScrollContainer::ensure_control_visible(Control *p_control) {\n \tERR_FAIL_COND_MSG(!is_ancestor_of(p_control), \"Must be an ancestor of the control.\");\n \n-\tRect2 global_rect = get_global_rect();\n-\tRect2 other_rect = p_control->get_global_rect();\n+\t// Just eliminate the rotation of this ScrollContainer.\n+\tTransform2D other_in_this = get_global_transform().affine_inverse() * p_control->get_global_transform();\n+\n+\tSize2 size = get_size();\n+\tRect2 other_rect = other_in_this.xform(Rect2(Point2(), p_control->get_size()));\n+\n \tfloat side_margin = v_scroll->is_visible() ? v_scroll->get_size().x : 0.0f;\n \tfloat bottom_margin = h_scroll->is_visible() ? h_scroll->get_size().y : 0.0f;\n \n-\tVector2 diff = Vector2(MAX(MIN(other_rect.position.x - (is_layout_rtl() ? side_margin : 0.0f), global_rect.position.x), other_rect.position.x + other_rect.size.x - global_rect.size.x + (!is_layout_rtl() ? side_margin : 0.0f)),\n-\t\t\tMAX(MIN(other_rect.position.y, global_rect.position.y), other_rect.position.y + other_rect.size.y - global_rect.size.y + bottom_margin));\n+\tVector2 diff = Vector2(MAX(MIN(other_rect.position.x - (is_layout_rtl() ? side_margin : 0.0f), 0.0f), other_rect.position.x + other_rect.size.x - size.x + (!is_layout_rtl() ? side_margin : 0.0f)),\n+\t\t\tMAX(MIN(other_rect.position.y, 0.0f), other_rect.position.y + other_rect.size.y - size.y + bottom_margin));\n \n-\tset_h_scroll(get_h_scroll() + (diff.x - global_rect.position.x));\n-\tset_v_scroll(get_v_scroll() + (diff.y - global_rect.position.y));\n+\tset_h_scroll(get_h_scroll() + diff.x);\n+\tset_v_scroll(get_v_scroll() + diff.y);\n }\n \n void ScrollContainer::_reposition_children() {\n", "test_patch": "", "problem_statement": "Follow Focus not working as expected in a rotated `ScrollContainer`\n### Tested versions\nBad: v4.0.stable.official [92bee43ad], master\n\n### System information\n\nGodot v4.4.dev (e19746352) - Linux Mint 22 (Wilma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1050 Ti (nvidia; 535.183.01) - Intel(R) Core(TM) i5-7300HQ CPU @ 2.50GHz (4 threads)\n\n### Issue description\n\nhttps://github.com/user-attachments/assets/443244ff-871d-42f7-b653-a80cc0ff159d\n\nNavigating down in a rotating `ScrollContainer` with follow focus enabled, the focused control is not fully visible. Note the StyleBox border.\n\n### Steps to reproduce\n\n1. Import and run the MRP;\n2. Select any node inside the `ScrollContainer` and navigate using `Tab`/`Shift + Tab`.\n3. Navigate down to reproduce the issue.\n\n### Minimal reproduction project (MRP)\n\n[MRP.zip](https://github.com/user-attachments/files/18432280/MRP.zip)\n", "hints_text": "", "created_at": "2025-01-16 05:02:17", "merge_commit_sha": "69c5b0307086a61fdc4377dc2a07b3918ad33107", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101616", "base_commit": "4ce466d7fa79e351d4295d5bb47e3266089c3a59", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex f626891bd8ea..caf877f40789 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1486,6 +1486,11 @@ void FileSystemDock::_try_move_item(const FileOrFolder &p_item, const String &p_\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tRef<Resource> res = ResourceCache::get_ref(old_path);\n+\t\t\t\tif (res.is_valid()) {\n+\t\t\t\t\tres->set_path_cache(new_path);\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \ndiff --git a/editor/plugins/script_editor_plugin.cpp b/editor/plugins/script_editor_plugin.cpp\nindex 77dd61b26346..1a1e5697c2d2 100644\n--- a/editor/plugins/script_editor_plugin.cpp\n+++ b/editor/plugins/script_editor_plugin.cpp\n@@ -1170,11 +1170,10 @@ void ScriptEditor::_live_auto_reload_running_scripts() {\n bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \tdisk_changed_list->clear();\n \tTreeItem *r = disk_changed_list->create_item();\n-\tdisk_changed_list->set_hide_root(true);\n \n \tbool need_ask = false;\n \tbool need_reload = false;\n-\tbool use_autoreload = bool(EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\"));\n+\tbool use_autoreload = EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\");\n \n \tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n \t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n@@ -1188,12 +1187,12 @@ bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \t\t\t\tcontinue; //internal script, who cares\n \t\t\t}\n \n-\t\t\tuint64_t last_date = edited_res->get_last_modified_time();\n-\t\t\tuint64_t date = FileAccess::get_modified_time(edited_res->get_path());\n+\t\t\tuint64_t last_date = se->edited_file_data.last_modified_time;\n+\t\t\tuint64_t date = FileAccess::get_modified_time(se->edited_file_data.path);\n \n \t\t\tif (last_date != date) {\n \t\t\t\tTreeItem *ti = disk_changed_list->create_item(r);\n-\t\t\t\tti->set_text(0, edited_res->get_path().get_file());\n+\t\t\t\tti->set_text(0, se->edited_file_data.path.get_file());\n \n \t\t\t\tif (!use_autoreload || se->is_unsaved()) {\n \t\t\t\t\tneed_ask = true;\n@@ -2231,11 +2230,6 @@ void ScriptEditor::_update_script_names() {\n \t\t\tRef<Texture2D> icon = se->get_theme_icon();\n \t\t\tString path = se->get_edited_resource()->get_path();\n \t\t\tbool saved = !path.is_empty();\n-\t\t\tif (saved) {\n-\t\t\t\t// The script might be deleted, moved, or renamed, so make sure\n-\t\t\t\t// to update original path to previously edited resource.\n-\t\t\t\tse->set_meta(\"_edit_res_path\", path);\n-\t\t\t}\n \t\t\tString name = se->get_name();\n \t\t\tRef<Script> scr = se->get_edited_resource();\n \n@@ -2633,7 +2627,8 @@ bool ScriptEditor::edit(const Ref<Resource> &p_resource, int p_line, int p_col,\n \n \t// If we delete a script within the filesystem, the original resource path\n \t// is lost, so keep it as metadata to figure out the exact tab to delete.\n-\tse->set_meta(\"_edit_res_path\", p_resource->get_path());\n+\tse->edited_file_data.path = p_resource->get_path();\n+\tse->edited_file_data.last_modified_time = FileAccess::get_modified_time(p_resource->get_path());\n \tif (se->get_edit_menu()) {\n \t\tse->get_edit_menu()->hide();\n \t\tmenu_hb->add_child(se->get_edit_menu());\n@@ -3042,6 +3037,15 @@ void ScriptEditor::_files_moved(const String &p_old_file, const String &p_new_fi\n \tif (!script_editor_cache->has_section(p_old_file)) {\n \t\treturn;\n \t}\n+\n+\tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n+\t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n+\t\tif (se && se->edited_file_data.path == p_old_file) {\n+\t\t\tse->edited_file_data.path = p_new_file;\n+\t\t\tbreak;\n+\t\t}\n+\t}\n+\n \tVariant state = script_editor_cache->get_value(p_old_file, \"state\");\n \tscript_editor_cache->erase_section(p_old_file);\n \tscript_editor_cache->set_value(p_new_file, \"state\", state);\n@@ -3064,7 +3068,7 @@ void ScriptEditor::_file_removed(const String &p_removed_file) {\n \t\tif (!se) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (se->get_meta(\"_edit_res_path\") == p_removed_file) {\n+\t\tif (se->edited_file_data.path == p_removed_file) {\n \t\t\t// The script is deleted with no undo, so just close the tab.\n \t\t\t_close_tab(i, false, false);\n \t\t}\n@@ -4414,9 +4418,10 @@ ScriptEditor::ScriptEditor(WindowWrapper *p_wrapper) {\n \t\tvbc->add_child(files_are_newer_label);\n \n \t\tdisk_changed_list = memnew(Tree);\n-\t\tvbc->add_child(disk_changed_list);\n+\t\tdisk_changed_list->set_hide_root(true);\n \t\tdisk_changed_list->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \t\tdisk_changed_list->set_v_size_flags(SIZE_EXPAND_FILL);\n+\t\tvbc->add_child(disk_changed_list);\n \n \t\tLabel *what_action_label = memnew(Label);\n \t\twhat_action_label->set_text(TTR(\"What action should be taken?\"));\ndiff --git a/editor/plugins/script_editor_plugin.h b/editor/plugins/script_editor_plugin.h\nindex 892a6155d5b7..50e6cfd91cd6 100644\n--- a/editor/plugins/script_editor_plugin.h\n+++ b/editor/plugins/script_editor_plugin.h\n@@ -173,6 +173,11 @@ class ScriptEditorBase : public VBoxContainer {\n \tstatic void _bind_methods();\n \n public:\n+\tstruct EditedFileData {\n+\t\tString path;\n+\t\tuint64_t last_modified_time = -1;\n+\t} edited_file_data;\n+\n \tvirtual void add_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \tvirtual void set_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \ndiff --git a/editor/plugins/script_text_editor.cpp b/editor/plugins/script_text_editor.cpp\nindex ece9616b69b2..79de2e4cebb5 100644\n--- a/editor/plugins/script_text_editor.cpp\n+++ b/editor/plugins/script_text_editor.cpp\n@@ -456,6 +456,7 @@ void ScriptTextEditor::convert_indent() {\n \n void ScriptTextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void ScriptTextEditor::goto_line(int p_line, int p_column) {\ndiff --git a/editor/plugins/text_editor.cpp b/editor/plugins/text_editor.cpp\nindex ee2d592ed3fd..6af3befe1c41 100644\n--- a/editor/plugins/text_editor.cpp\n+++ b/editor/plugins/text_editor.cpp\n@@ -302,6 +302,7 @@ void TextEditor::convert_indent() {\n \n void TextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void TextEditor::goto_line(int p_line, int p_column) {\n", "test_patch": "", "problem_statement": "Duplicating a script triggers modified outside Godot dialog\n### Tested versions\n\nGodot v4.4.dev7\n\nTried v4.4.dev2 too and it did not happen there\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - Wayland display driver, Single-window\n\n### Issue description\n\nIf you duplicate a script in FileSystem with the script open and then either save the open file or focus another window and then back to Godot it triggers the modified outside Godot dialog for the open script.\n\nhttps://github.com/user-attachments/assets/ddfba1e6-8ac9-4812-a46a-3fa22d1bbd4a\n\n\n### Steps to reproduce\n\n^\n\n### Minimal reproduction project (MRP)\n\n[doc.zip](https://github.com/user-attachments/files/18423743/doc.zip)\n", "hints_text": "Bisecting\nBisected to [2430b7f9b41c84e37c4d47f5adde9cdb9c9b1d59], so would be based on universal UIDs:\n* https://github.com/godotengine/godot/pull/97352\n\nUnsure what exactly is going on though \nThis is caused by wrong implementation of change detection in script editor. It uses Resource's `last_modifed_time`, which seems to not be a last modified time of the file. This line causes the script's \"modified time\" to change, causing mismatch with the actual time of the file.\nhttps://github.com/godotengine/godot/blob/4ce466d7fa79e351d4295d5bb47e3266089c3a59/editor/editor_file_system.cpp#L2984", "created_at": "2025-01-16 00:03:34", "merge_commit_sha": "6fdf91cc2f3f186197f22b72bfe12c5db6354608", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101570", "base_commit": "1b7b009674e05b566be11a5377b935f5d3d6c0ee", "patch": "diff --git a/editor/editor_properties.cpp b/editor/editor_properties.cpp\nindex 69b44a3e8f88..b1a4bb76f325 100644\n--- a/editor/editor_properties.cpp\n+++ b/editor/editor_properties.cpp\n@@ -2599,6 +2599,17 @@ void EditorPropertyColor::_color_changed(const Color &p_color) {\n \tget_edited_object()->set(get_edited_property(), p_color);\n }\n \n+void EditorPropertyColor::_picker_created() {\n+\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_popup_opening));\n+\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n+}\n+\n+void EditorPropertyColor::_popup_opening() {\n+\tEditorNode::get_singleton()->setup_color_picker(picker->get_picker());\n+\tlast_color = picker->get_pick_color();\n+\twas_checked = !is_checkable() || is_checked();\n+}\n+\n void EditorPropertyColor::_popup_closed() {\n \tget_edited_object()->set(get_edited_property(), was_checked ? Variant(last_color) : Variant());\n \tif (!picker->get_pick_color().is_equal_approx(last_color)) {\n@@ -2606,11 +2617,6 @@ void EditorPropertyColor::_popup_closed() {\n \t}\n }\n \n-void EditorPropertyColor::_picker_opening() {\n-\tlast_color = picker->get_pick_color();\n-\twas_checked = !is_checkable() || is_checked();\n-}\n-\n void EditorPropertyColor::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_ENTER_TREE:\n@@ -2654,9 +2660,7 @@ EditorPropertyColor::EditorPropertyColor() {\n \tadd_child(picker);\n \tpicker->set_flat(true);\n \tpicker->connect(\"color_changed\", callable_mp(this, &EditorPropertyColor::_color_changed));\n-\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(EditorNode::get_singleton(), &EditorNode::setup_color_picker).bind(picker->get_picker()));\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_picker_opening));\n+\tpicker->connect(\"picker_created\", callable_mp(this, &EditorPropertyColor::_picker_created), CONNECT_ONE_SHOT);\n }\n \n ////////////// NODE PATH //////////////////////\ndiff --git a/editor/editor_properties.h b/editor/editor_properties.h\nindex bcdae5342d28..6fe8cc3c3f38 100644\n--- a/editor/editor_properties.h\n+++ b/editor/editor_properties.h\n@@ -593,8 +593,9 @@ class EditorPropertyColor : public EditorProperty {\n \tGDCLASS(EditorPropertyColor, EditorProperty);\n \tColorPickerButton *picker = nullptr;\n \tvoid _color_changed(const Color &p_color);\n+\tvoid _picker_created();\n+\tvoid _popup_opening();\n \tvoid _popup_closed();\n-\tvoid _picker_opening();\n \n \tColor last_color;\n \tbool live_changes_enabled = true;\n", "test_patch": "", "problem_statement": "Inspector loads slowly when there's many Color properties\n### Tested versions\n\nReproducible in 4.4.dev7, and probably many versions earlier.\n\n### System information\n\nWindows 11\n\n### Issue description\n\nInspectors (or project/editor settings) that contain many Color properties will load slowly. Additionally, they can be slow to switch away from.\n\n### Steps to reproduce\n\nFor example, check out:\n```\nEditor Settings > Text Editor > Theme     (the worst example)\nEditor Settings > Editors > 3D Gizmos\nEditor Settings > Editors > Visual Editors\nProject Settings > Debug > Shapes\n```\n\n\n\n### Minimal reproduction project (MRP)\n\nAlso, I made an MPR that has a Node with an exported `Array[Color]`, and some extra Color properties. Try repeatedly switching between the `Colorful` and `Colorless` nodes (make sure the Array is expanded).\n\n[color_picker.zip](https://github.com/user-attachments/files/18418402/color_picker.zip)\n", "hints_text": "", "created_at": "2025-01-15 03:12:27", "merge_commit_sha": "a7146ef807a7676f51a8a63cf4441ad647f4be66", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101489", "base_commit": "a013481b0911e59cc3f3dea7ebb732450c3e1460", "patch": "diff --git a/core/config/project_settings.cpp b/core/config/project_settings.cpp\nindex fdcd4f9b6064..a12b89683118 100644\n--- a/core/config/project_settings.cpp\n+++ b/core/config/project_settings.cpp\n@@ -1263,10 +1263,10 @@ void ProjectSettings::refresh_global_class_list() {\n \tArray script_classes = get_global_class_list();\n \tfor (int i = 0; i < script_classes.size(); i++) {\n \t\tDictionary c = script_classes[i];\n-\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\tcontinue;\n \t\t}\n-\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t}\n }\n \ndiff --git a/core/object/script_language.cpp b/core/object/script_language.cpp\nindex 4ef53dba1dff..33bf7ab48a0f 100644\n--- a/core/object/script_language.cpp\n+++ b/core/object/script_language.cpp\n@@ -269,10 +269,10 @@ void ScriptServer::init_languages() {\n \n \t\t\tfor (const Variant &script_class : script_classes) {\n \t\t\t\tDictionary c = script_class;\n-\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n-\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t\t}\n \t\t\tProjectSettings::get_singleton()->clear(\"_global_script_classes\");\n \t\t}\n@@ -281,10 +281,10 @@ void ScriptServer::init_languages() {\n \t\tArray script_classes = ProjectSettings::get_singleton()->get_global_class_list();\n \t\tfor (const Variant &script_class : script_classes) {\n \t\t\tDictionary c = script_class;\n-\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\tcontinue;\n \t\t\t}\n-\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t}\n \t}\n \n@@ -390,7 +390,7 @@ void ScriptServer::global_classes_clear() {\n \tinheriters_cache.clear();\n }\n \n-void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path) {\n+void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool) {\n \tERR_FAIL_COND_MSG(p_class == p_base || (global_classes.has(p_base) && get_global_class_native_base(p_base) == p_class), \"Cyclic inheritance in script class.\");\n \tGlobalScriptClass *existing = global_classes.getptr(p_class);\n \tif (existing) {\n@@ -399,6 +399,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\t\texisting->base = p_base;\n \t\t\texisting->path = p_path;\n \t\t\texisting->language = p_language;\n+\t\t\texisting->is_abstract = p_is_abstract;\n+\t\t\texisting->is_tool = p_is_tool;\n \t\t\tinheriters_cache_dirty = true;\n \t\t}\n \t} else {\n@@ -407,6 +409,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\tg.language = p_language;\n \t\tg.path = p_path;\n \t\tg.base = p_base;\n+\t\tg.is_abstract = p_is_abstract;\n+\t\tg.is_tool = p_is_tool;\n \t\tglobal_classes[p_class] = g;\n \t\tinheriters_cache_dirty = true;\n \t}\n@@ -480,6 +484,16 @@ StringName ScriptServer::get_global_class_native_base(const String &p_class) {\n \treturn base;\n }\n \n+bool ScriptServer::is_global_class_abstract(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_abstract;\n+}\n+\n+bool ScriptServer::is_global_class_tool(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_tool;\n+}\n+\n void ScriptServer::get_global_class_list(List<StringName> *r_global_classes) {\n \tList<StringName> classes;\n \tfor (const KeyValue<StringName, GlobalScriptClass> &E : global_classes) {\n@@ -507,12 +521,15 @@ void ScriptServer::save_global_classes() {\n \tget_global_class_list(&gc);\n \tArray gcarr;\n \tfor (const StringName &E : gc) {\n+\t\tconst GlobalScriptClass &global_class = global_classes[E];\n \t\tDictionary d;\n \t\td[\"class\"] = E;\n-\t\td[\"language\"] = global_classes[E].language;\n-\t\td[\"path\"] = global_classes[E].path;\n-\t\td[\"base\"] = global_classes[E].base;\n+\t\td[\"language\"] = global_class.language;\n+\t\td[\"path\"] = global_class.path;\n+\t\td[\"base\"] = global_class.base;\n \t\td[\"icon\"] = class_icons.get(E, \"\");\n+\t\td[\"is_abstract\"] = global_class.is_abstract;\n+\t\td[\"is_tool\"] = global_class.is_tool;\n \t\tgcarr.push_back(d);\n \t}\n \tProjectSettings::get_singleton()->store_global_class_list(gcarr);\ndiff --git a/core/object/script_language.h b/core/object/script_language.h\nindex 6ceeb4287512..8158d633ae14 100644\n--- a/core/object/script_language.h\n+++ b/core/object/script_language.h\n@@ -62,6 +62,8 @@ class ScriptServer {\n \t\tStringName language;\n \t\tString path;\n \t\tStringName base;\n+\t\tbool is_abstract = false;\n+\t\tbool is_tool = false;\n \t};\n \n \tstatic HashMap<StringName, GlobalScriptClass> global_classes;\n@@ -86,7 +88,7 @@ class ScriptServer {\n \tstatic void thread_exit();\n \n \tstatic void global_classes_clear();\n-\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path);\n+\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool);\n \tstatic void remove_global_class(const StringName &p_class);\n \tstatic void remove_global_class_by_path(const String &p_path);\n \tstatic bool is_global_class(const StringName &p_class);\n@@ -94,6 +96,8 @@ class ScriptServer {\n \tstatic String get_global_class_path(const String &p_class);\n \tstatic StringName get_global_class_base(const String &p_class);\n \tstatic StringName get_global_class_native_base(const String &p_class);\n+\tstatic bool is_global_class_abstract(const String &p_class);\n+\tstatic bool is_global_class_tool(const String &p_class);\n \tstatic void get_global_class_list(List<StringName> *r_global_classes);\n \tstatic void get_inheriters_list(const StringName &p_base_type, List<StringName> *r_classes);\n \tstatic void save_global_classes();\n@@ -443,7 +447,7 @@ class ScriptLanguage : public Object {\n \tvirtual void frame();\n \n \tvirtual bool handles_global_class_type(const String &p_type) const { return false; }\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const { return String(); }\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const { return String(); }\n \n \tvirtual ~ScriptLanguage() {}\n };\ndiff --git a/core/object/script_language_extension.h b/core/object/script_language_extension.h\nindex 09c395e71e8d..715ec43fb35a 100644\n--- a/core/object/script_language_extension.h\n+++ b/core/object/script_language_extension.h\n@@ -672,7 +672,7 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \n \tGDVIRTUAL1RC_REQUIRED(Dictionary, _get_global_class_name, const String &)\n \n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override {\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override {\n \t\tDictionary ret;\n \t\tGDVIRTUAL_CALL(_get_global_class_name, p_path, ret);\n \t\tif (!ret.has(\"name\")) {\n@@ -684,6 +684,12 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \t\tif (r_icon_path != nullptr && ret.has(\"icon_path\")) {\n \t\t\t*r_icon_path = ret[\"icon_path\"];\n \t\t}\n+\t\tif (r_is_abstract != nullptr && ret.has(\"is_abstract\")) {\n+\t\t\t*r_is_abstract = ret[\"is_abstract\"];\n+\t\t}\n+\t\tif (r_is_tool != nullptr && ret.has(\"is_tool\")) {\n+\t\t\t*r_is_tool = ret[\"is_tool\"];\n+\t\t}\n \t\treturn ret[\"name\"];\n \t}\n };\ndiff --git a/editor/connections_dialog.cpp b/editor/connections_dialog.cpp\nindex 429467d3403c..dca43411e10b 100644\n--- a/editor/connections_dialog.cpp\n+++ b/editor/connections_dialog.cpp\n@@ -1446,7 +1446,7 @@ void ConnectionsDock::update_tree() {\n \t\t\t\tdoc_class_name = String();\n \t\t\t}\n \n-\t\t\tclass_icon = editor_data.get_script_icon(script_base);\n+\t\t\tclass_icon = editor_data.get_script_icon(script_base->get_path());\n \t\t\tif (class_icon.is_null() && has_theme_icon(native_base, EditorStringName(EditorIcons))) {\n \t\t\t\tclass_icon = get_editor_theme_icon(native_base);\n \t\t\t}\ndiff --git a/editor/create_dialog.cpp b/editor/create_dialog.cpp\nindex 7f1670bcb648..5eebb1c492e5 100644\n--- a/editor/create_dialog.cpp\n+++ b/editor/create_dialog.cpp\n@@ -257,14 +257,9 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\tinherits = ClassDB::get_parent_class(p_type);\n \t\tinherited_type = TypeCategory::CPP_TYPE;\n \t} else {\n-\t\tif (p_type_category == TypeCategory::PATH_TYPE || ScriptServer::is_global_class(p_type)) {\n-\t\t\tRef<Script> scr;\n-\t\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n-\t\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n-\t\t\t\tscr = ResourceLoader::load(p_type, \"Script\");\n-\t\t\t} else {\n-\t\t\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_type);\n-\t\t\t}\n+\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n+\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n+\t\t\tRef<Script> scr = ResourceLoader::load(p_type, \"Script\");\n \t\t\tERR_FAIL_COND(scr.is_null());\n \n \t\t\tRef<Script> base = scr->get_base_script();\n@@ -286,6 +281,10 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\t\t\t\tinherited_type = TypeCategory::PATH_TYPE;\n \t\t\t\t}\n \t\t\t}\n+\t\t} else if (ScriptServer::is_global_class(p_type)) {\n+\t\t\tinherits = ScriptServer::get_global_class_base(p_type);\n+\t\t\tbool is_native_class = ClassDB::class_exists(inherits);\n+\t\t\tinherited_type = is_native_class ? TypeCategory::CPP_TYPE : TypeCategory::OTHER_TYPE;\n \t\t} else {\n \t\t\tinherits = custom_type_parents[p_type];\n \t\t\tif (ClassDB::class_exists(inherits)) {\n@@ -315,18 +314,14 @@ void CreateDialog::_configure_search_option_item(TreeItem *r_item, const StringN\n \t\tr_item->set_metadata(0, p_type);\n \t\tr_item->set_text(0, p_type);\n \n-\t\tString script_path = ScriptServer::get_global_class_path(p_type);\n-\t\tRef<Script> scr = ResourceLoader::load(script_path, \"Script\");\n-\n-\t\tERR_FAIL_COND(scr.is_null());\n-\t\tis_abstract = scr->is_abstract();\n+\t\tis_abstract = ScriptServer::is_global_class_abstract(p_type);\n \n \t\tString tooltip = TTR(\"Script path: %s\");\n-\t\tbool is_tool = scr->is_tool();\n+\t\tbool is_tool = ScriptServer::is_global_class_tool(p_type);\n \t\tif (is_tool) {\n \t\t\ttooltip = TTR(\"The script will run in the editor.\") + \"\\n\" + tooltip;\n \t\t}\n-\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, script_path));\n+\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, ScriptServer::get_global_class_path(p_type)));\n \t\tif (is_tool) {\n \t\t\tint button_index = r_item->get_button_count(0) - 1;\n \t\t\tr_item->set_button_color(0, button_index, get_theme_color(SNAME(\"accent_color\"), EditorStringName(Editor)));\ndiff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex 73af9f39a6f5..f31e6aba4169 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -983,20 +983,6 @@ bool EditorData::script_class_is_parent(const String &p_class, const String &p_i\n \treturn true;\n }\n \n-StringName EditorData::script_class_get_base(const String &p_class) const {\n-\tRef<Script> script = script_class_load_script(p_class);\n-\tif (script.is_null()) {\n-\t\treturn StringName();\n-\t}\n-\n-\tRef<Script> base_script = script->get_base_script();\n-\tif (base_script.is_null()) {\n-\t\treturn ScriptServer::get_global_class_base(p_class);\n-\t}\n-\n-\treturn script->get_language()->get_global_class_name(base_script->get_path());\n-}\n-\n Variant EditorData::script_class_instance(const String &p_class) {\n \tif (ScriptServer::is_global_class(p_class)) {\n \t\tRef<Script> script = script_class_load_script(p_class);\n@@ -1026,22 +1012,25 @@ void EditorData::script_class_set_icon_path(const String &p_class, const String\n \t_script_class_icon_paths[p_class] = p_icon_path;\n }\n \n-String EditorData::script_class_get_icon_path(const String &p_class) const {\n-\tif (!ScriptServer::is_global_class(p_class)) {\n-\t\treturn String();\n-\t}\n-\n+String EditorData::script_class_get_icon_path(const String &p_class, bool *r_valid) const {\n \tString current = p_class;\n-\tString ret = _script_class_icon_paths[current];\n-\twhile (ret.is_empty()) {\n-\t\tcurrent = script_class_get_base(current);\n+\twhile (true) {\n \t\tif (!ScriptServer::is_global_class(current)) {\n+\t\t\t// If the classnames chain has a native class ancestor, we're done with success.\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = ClassDB::class_exists(current);\n+\t\t\t}\n \t\t\treturn String();\n \t\t}\n-\t\tret = _script_class_icon_paths.has(current) ? _script_class_icon_paths[current] : String();\n+\t\tHashMap<StringName, String>::ConstIterator E = _script_class_icon_paths.find(current);\n+\t\tif ((bool)E) {\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = true;\n+\t\t\t}\n+\t\t\treturn E->value;\n+\t\t}\n+\t\tcurrent = ScriptServer::get_global_class_base(current);\n \t}\n-\n-\treturn ret;\n }\n \n StringName EditorData::script_class_get_name(const String &p_path) const {\n@@ -1126,28 +1115,42 @@ Ref<Texture2D> EditorData::_load_script_icon(const String &p_path) const {\n \treturn nullptr;\n }\n \n-Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n+Ref<Texture2D> EditorData::get_script_icon(const String &p_script_path) {\n \t// Take from the local cache, if available.\n-\tif (_script_icon_cache.has(p_script)) {\n+\tif (_script_icon_cache.has(p_script_path)) {\n \t\t// Can be an empty value if we can't resolve any icon for this script.\n \t\t// An empty value is still cached to avoid unnecessary attempts at resolving it again.\n-\t\treturn _script_icon_cache[p_script];\n+\t\treturn _script_icon_cache[p_script_path];\n+\t}\n+\n+\t// Fast path in case the whole hierarchy is made of global classes.\n+\tStringName class_name = script_class_get_name(p_script_path);\n+\t{\n+\t\tif (class_name != StringName()) {\n+\t\t\tbool icon_valid = false;\n+\t\t\tString icon_path = script_class_get_icon_path(class_name, &icon_valid);\n+\t\t\tif (icon_valid) {\n+\t\t\t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n+\t\t\t\t_script_icon_cache[p_script_path] = icon;\n+\t\t\t\treturn icon;\n+\t\t\t}\n+\t\t}\n \t}\n \n-\tRef<Script> base_scr = p_script;\n+\tRef<Script> base_scr = ResourceLoader::load(p_script_path, \"Script\");\n \twhile (base_scr.is_valid()) {\n \t\t// Check for scripted classes.\n \t\tString icon_path;\n-\t\tStringName class_name = script_class_get_name(base_scr->get_path());\n-\t\tif (base_scr->is_built_in() || class_name == StringName()) {\n+\t\tStringName base_class_name = script_class_get_name(base_scr->get_path());\n+\t\tif (base_scr->is_built_in() || base_class_name == StringName()) {\n \t\t\ticon_path = base_scr->get_class_icon_path();\n \t\t} else {\n-\t\t\ticon_path = script_class_get_icon_path(class_name);\n+\t\t\ticon_path = script_class_get_icon_path(base_class_name);\n \t\t}\n \n \t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n \t\tif (icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = icon;\n+\t\t\t_script_icon_cache[p_script_path] = icon;\n \t\t\treturn icon;\n \t\t}\n \n@@ -1155,7 +1158,7 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\t// TODO: Should probably be deprecated in 4.x\n \t\tconst EditorData::CustomType *ctype = get_custom_type_by_path(base_scr->get_path());\n \t\tif (ctype && ctype->icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = ctype->icon;\n+\t\t\t_script_icon_cache[p_script_path] = ctype->icon;\n \t\t\treturn ctype->icon;\n \t\t}\n \n@@ -1163,21 +1166,16 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\tbase_scr = base_scr->get_base_script();\n \t}\n \n-\t// No custom icon was found in the inheritance chain, so check the base\n-\t// class of the script instead.\n-\tString base_type;\n-\tp_script->get_language()->get_global_class_name(p_script->get_path(), &base_type);\n-\n \t// Check if the base type is an extension-defined type.\n-\tRef<Texture2D> ext_icon = extension_class_get_icon(base_type);\n+\tRef<Texture2D> ext_icon = extension_class_get_icon(class_name);\n \tif (ext_icon.is_valid()) {\n-\t\t_script_icon_cache[p_script] = ext_icon;\n+\t\t_script_icon_cache[p_script_path] = ext_icon;\n \t\treturn ext_icon;\n \t}\n \n \t// If no icon found, cache it as null.\n-\t_script_icon_cache[p_script] = Ref<Texture>();\n-\treturn nullptr;\n+\t_script_icon_cache[p_script_path] = Ref<Texture2D>();\n+\treturn Ref<Texture2D>();\n }\n \n void EditorData::clear_script_icon_cache() {\ndiff --git a/editor/editor_data.h b/editor/editor_data.h\nindex 5b49304c73f2..943c661b6b2e 100644\n--- a/editor/editor_data.h\n+++ b/editor/editor_data.h\n@@ -147,7 +147,7 @@ class EditorData {\n \n \tHashMap<StringName, String> _script_class_icon_paths;\n \tHashMap<String, StringName> _script_class_file_to_path;\n-\tHashMap<Ref<Script>, Ref<Texture>> _script_icon_cache;\n+\tHashMap<String, Ref<Texture>> _script_icon_cache;\n \n \tRef<Texture2D> _load_script_icon(const String &p_path) const;\n \n@@ -241,7 +241,6 @@ class EditorData {\n \tvoid notify_scene_saved(const String &p_path);\n \n \tbool script_class_is_parent(const String &p_class, const String &p_inherits);\n-\tStringName script_class_get_base(const String &p_class) const;\n \tVariant script_class_instance(const String &p_class);\n \n \tRef<Script> script_class_load_script(const String &p_class) const;\n@@ -249,7 +248,7 @@ class EditorData {\n \tStringName script_class_get_name(const String &p_path) const;\n \tvoid script_class_set_name(const String &p_path, const StringName &p_class);\n \n-\tString script_class_get_icon_path(const String &p_class) const;\n+\tString script_class_get_icon_path(const String &p_class, bool *r_valid = nullptr) const;\n \tvoid script_class_set_icon_path(const String &p_class, const String &p_icon_path);\n \tvoid script_class_clear_icon_paths() { _script_class_icon_paths.clear(); }\n \tvoid script_class_save_icon_paths();\n@@ -257,7 +256,7 @@ class EditorData {\n \n \tRef<Texture2D> extension_class_get_icon(const String &p_class) const;\n \n-\tRef<Texture2D> get_script_icon(const Ref<Script> &p_script);\n+\tRef<Texture2D> get_script_icon(const String &p_script_path);\n \tvoid clear_script_icon_cache();\n \n \tEditorData();\ndiff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex b8ce3ff65bf7..1db6c2a188e4 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -49,7 +49,7 @@\n \n EditorFileSystem *EditorFileSystem::singleton = nullptr;\n //the name is the version, to keep compatibility with different versions of Godot\n-#define CACHE_FILE_NAME \"filesystem_cache8\"\n+#define CACHE_FILE_NAME \"filesystem_cache10\"\n \n int EditorFileSystemDirectory::find_file_index(const String &p_file) const {\n \tfor (int i = 0; i < files.size(); i++) {\n@@ -166,19 +166,19 @@ uint64_t EditorFileSystemDirectory::get_file_import_modified_time(int p_idx) con\n }\n \n String EditorFileSystemDirectory::get_file_script_class_name(int p_idx) const {\n-\treturn files[p_idx]->script_class_name;\n+\treturn files[p_idx]->class_info.name;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_extends(int p_idx) const {\n-\treturn files[p_idx]->script_class_extends;\n+\treturn files[p_idx]->class_info.extends;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_icon_path(int p_idx) const {\n-\treturn files[p_idx]->script_class_icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n String EditorFileSystemDirectory::get_file_icon_path(int p_idx) const {\n-\treturn files[p_idx]->icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n StringName EditorFileSystemDirectory::get_file_type(int p_idx) const {\n@@ -303,13 +303,13 @@ void EditorFileSystem::_first_scan_process_scripts(const ScannedDirectory *p_sca\n \t\t\tconst String type = ResourceLoader::get_resource_type(path);\n \n \t\t\tif (ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n-\t\t\t\tString script_class_extends;\n-\t\t\t\tString script_class_icon_path;\n-\t\t\t\tString script_class_name = _get_global_script_class(type, path, &script_class_extends, &script_class_icon_path);\n-\t\t\t\t_register_global_class_script(path, path, type, script_class_name, script_class_extends, script_class_icon_path);\n+\t\t\t\tconst ScriptClassInfo &info = _get_global_script_class(type, path);\n+\t\t\t\tScriptClassInfoUpdate update(info);\n+\t\t\t\tupdate.type = type;\n+\t\t\t\t_register_global_class_script(path, path, update);\n \n-\t\t\t\tif (!script_class_name.is_empty()) {\n-\t\t\t\t\tp_existing_class_names.insert(script_class_name);\n+\t\t\t\tif (!info.name.is_empty()) {\n+\t\t\t\t\tp_existing_class_names.insert(info.name);\n \t\t\t\t}\n \t\t\t}\n \t\t}\n@@ -383,33 +383,25 @@ void EditorFileSystem::_scan_filesystem() {\n \t\t\t\t\tname = cpath.path_join(name);\n \n \t\t\t\t\tFileCache fc;\n-\t\t\t\t\tfc.type = split[1];\n-\t\t\t\t\tif (fc.type.contains_char('/')) {\n-\t\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n-\t\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n-\t\t\t\t\t}\n+\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n+\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n \t\t\t\t\tfc.uid = split[2].to_int();\n \t\t\t\t\tfc.modification_time = split[3].to_int();\n \t\t\t\t\tfc.import_modification_time = split[4].to_int();\n \t\t\t\t\tfc.import_valid = split[5].to_int() != 0;\n \t\t\t\t\tfc.import_group_file = split[6].strip_edges();\n-\t\t\t\t\tfc.script_class_name = split[7].get_slice(\"<>\", 0);\n-\t\t\t\t\tfc.script_class_extends = split[7].get_slice(\"<>\", 1);\n-\t\t\t\t\tfc.script_class_icon_path = split[7].get_slice(\"<>\", 2);\n-\t\t\t\t\tfc.import_md5 = split[7].get_slice(\"<>\", 3);\n-\t\t\t\t\tString dest_paths = split[7].get_slice(\"<>\", 4);\n-\t\t\t\t\tif (!dest_paths.is_empty()) {\n-\t\t\t\t\t\tfc.import_dest_paths = dest_paths.split(\"<*>\");\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tString deps = split[8].strip_edges();\n-\t\t\t\t\tif (deps.length()) {\n-\t\t\t\t\t\tVector<String> dp = deps.split(\"<>\");\n-\t\t\t\t\t\tfor (int i = 0; i < dp.size(); i++) {\n-\t\t\t\t\t\t\tconst String &path = dp[i];\n-\t\t\t\t\t\t\tfc.deps.push_back(path);\n-\t\t\t\t\t\t}\n+\t\t\t\t\t{\n+\t\t\t\t\t\tconst Vector<String> &slices = split[7].split(\"<>\");\n+\t\t\t\t\t\tERR_CONTINUE(slices.size() < 7);\n+\t\t\t\t\t\tfc.class_info.name = slices[0];\n+\t\t\t\t\t\tfc.class_info.extends = slices[1];\n+\t\t\t\t\t\tfc.class_info.icon_path = slices[2];\n+\t\t\t\t\t\tfc.class_info.is_abstract = slices[3].to_int();\n+\t\t\t\t\t\tfc.class_info.is_tool = slices[4].to_int();\n+\t\t\t\t\t\tfc.import_md5 = slices[5];\n+\t\t\t\t\t\tfc.import_dest_paths = slices[6].split(\"<*>\");\n \t\t\t\t\t}\n+\t\t\t\t\tfc.deps = split[8].strip_edges().split(\"<>\");\n \n \t\t\t\t\tfile_cache[name] = fc;\n \t\t\t\t}\n@@ -859,7 +851,7 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\t}\n \n \t\t\t\tif (ClassDB::is_parent_class(ia.new_file->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(new_file_path, ia.new_file->type, ia.new_file->script_class_name, ia.new_file->script_class_extends, ia.new_file->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(new_file_path, ScriptClassInfoUpdate::from_file_info(ia.new_file));\n \t\t\t\t}\n \t\t\t\tif (ia.new_file->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(new_file_path);\n@@ -870,9 +862,9 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString script_class_name = ia.dir->files[idx]->script_class_name;\n+\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), \"\", \"\", \"\", \"\");\n+\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n@@ -883,11 +875,11 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tia.dir->files.remove_at(idx);\n \n \t\t\t\t// Restore another script with the same global class name if it exists.\n-\t\t\t\tif (!script_class_name.is_empty()) {\n+\t\t\t\tif (!class_name.is_empty()) {\n \t\t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n-\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, script_class_name, old_fi);\n+\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, class_name, old_fi);\n \t\t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \n@@ -1161,10 +1153,8 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = fc->import_md5;\n \t\t\t\tfi->import_dest_paths = fc->import_dest_paths;\n \t\t\t\tfi->import_valid = fc->import_valid;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n \t\t\t\tfi->import_group_file = fc->import_group_file;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\t// Ensures backward compatibility when the project is loaded for the first time with the added import_md5\n \t\t\t\t// and import_dest_paths properties in the file cache.\n@@ -1202,7 +1192,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t} else {\n \t\t\t\t// Using get_resource_import_info() to prevent calling 3 times ResourceFormatImporter::_get_path_and_type.\n \t\t\t\tResourceFormatImporter::get_singleton()->get_resource_import_info(path, fi->type, fi->uid, fi->import_group_file);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->modified_time = 0;\n \t\t\t\tfi->import_modified_time = 0;\n \t\t\t\tfi->import_md5 = \"\";\n@@ -1227,22 +1217,20 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = \"\";\n \t\t\t\tfi->import_dest_paths = Vector<String>();\n \t\t\t\tfi->import_valid = true;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\tif (first_scan && ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n \t\t\t\t\tbool update_script = false;\n-\t\t\t\t\tString old_class_name = fi->script_class_name;\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n-\t\t\t\t\tif (old_class_name != fi->script_class_name) {\n+\t\t\t\t\tString old_class_name = fi->class_info.name;\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n+\t\t\t\t\tif (old_class_name != fi->class_info.name) {\n \t\t\t\t\t\tupdate_script = true;\n-\t\t\t\t\t} else if (!fi->script_class_name.is_empty() && (!ScriptServer::is_global_class(fi->script_class_name) || ScriptServer::get_global_class_path(fi->script_class_name) != path)) {\n+\t\t\t\t\t} else if (!fi->class_info.name.is_empty() && (!ScriptServer::is_global_class(fi->class_info.name) || ScriptServer::get_global_class_path(fi->class_info.name) != path)) {\n \t\t\t\t\t\t// This script has a class name but is not in the global class names or the path of the class has changed.\n \t\t\t\t\t\tupdate_script = true;\n \t\t\t\t\t}\n \t\t\t\t\tif (update_script) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t} else {\n@@ -1256,7 +1244,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t}\n \t\t\t\tfi->uid = ResourceLoader::get_resource_uid(path);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->deps = _get_dependencies(path);\n \t\t\t\tfi->modified_time = mt;\n \t\t\t\tfi->import_modified_time = 0;\n@@ -1267,7 +1255,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t// Files in dep_update_list are forced for rescan to update dependencies. They don't need other updates.\n \t\t\t\tif (!dep_update_list.has(path)) {\n \t\t\t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t\t_queue_update_scene_groups(path);\n@@ -1428,7 +1416,7 @@ void EditorFileSystem::_scan_fs_changes(EditorFileSystemDirectory *p_dir, ScanPr\n \t\t\t\t\tif (fi->type == \"\" && other_file_extensions.has(ext)) {\n \t\t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t\t}\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\t\tfi->import_valid = (fi->type == \"TextFile\" || fi->type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(path);\n \t\t\t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(path);\n \n@@ -1587,7 +1575,7 @@ void EditorFileSystem::_remove_invalid_global_class_names(const HashSet<String>\n \n String EditorFileSystem::_get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info) {\n \tfor (EditorFileSystemDirectory::FileInfo *fi : p_dir->files) {\n-\t\tif (fi->script_class_name == p_class_name) {\n+\t\tif (fi->class_info.name == p_class_name) {\n \t\t\tr_file_info = fi;\n \t\t\treturn p_dir->get_path().path_join(fi->file);\n \t\t}\n@@ -1768,7 +1756,7 @@ void EditorFileSystem::_save_filesystem_cache(EditorFileSystemDirectory *p_dir,\n \t\tcache_string.append(itos(file_info->import_modified_time));\n \t\tcache_string.append(itos(file_info->import_valid));\n \t\tcache_string.append(file_info->import_group_file);\n-\t\tcache_string.append(String(\"<>\").join({ file_info->script_class_name, file_info->script_class_extends, file_info->script_class_icon_path, file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n+\t\tcache_string.append(String(\"<>\").join({ file_info->class_info.name, file_info->class_info.extends, file_info->class_info.icon_path, itos(file_info->class_info.is_abstract), itos(file_info->class_info.is_tool), file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n \t\tcache_string.append(String(\"<>\").join(file_info->deps));\n \n \t\tp_file->store_line(String(\"::\").join(cache_string));\n@@ -1980,29 +1968,21 @@ Vector<String> EditorFileSystem::_get_dependencies(const String &p_path) {\n \treturn ret;\n }\n \n-String EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const {\n+EditorFileSystem::ScriptClassInfo EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path) const {\n+\tScriptClassInfo info;\n \tfor (int i = 0; i < ScriptServer::get_language_count(); i++) {\n \t\tif (ScriptServer::get_language(i)->handles_global_class_type(p_type)) {\n-\t\t\tString global_name;\n-\t\t\tString extends;\n-\t\t\tString icon_path;\n-\n-\t\t\tglobal_name = ScriptServer::get_language(i)->get_global_class_name(p_path, &extends, &icon_path);\n-\t\t\t*r_extends = extends;\n-\t\t\t*r_icon_path = icon_path;\n-\t\t\treturn global_name;\n+\t\t\tinfo.name = ScriptServer::get_language(i)->get_global_class_name(p_path, &info.extends, &info.icon_path, &info.is_abstract, &info.is_tool);\n \t\t}\n \t}\n-\t*r_extends = String();\n-\t*r_icon_path = String();\n-\treturn String();\n+\treturn info;\n }\n \n void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInfo *file_info) {\n \tString icon_path;\n \tif (file_info->resource_script_class != StringName()) {\n \t\ticon_path = EditorNode::get_editor_data().script_class_get_icon_path(file_info->resource_script_class);\n-\t} else if (file_info->script_class_icon_path.is_empty() && !file_info->deps.is_empty()) {\n+\t} else if (file_info->class_info.icon_path.is_empty() && !file_info->deps.is_empty()) {\n \t\tconst String &script_dep = file_info->deps[0]; // Assuming the first dependency is a script.\n \t\tconst String &script_path = script_dep.contains(\"::\") ? script_dep.get_slice(\"::\", 2) : script_dep;\n \t\tif (!script_path.is_empty()) {\n@@ -2014,7 +1994,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t\t\t\tint script_file;\n \t\t\t\t\tEditorFileSystemDirectory *efsd = find_file(script_path, &script_file);\n \t\t\t\t\tif (efsd) {\n-\t\t\t\t\t\ticon_path = efsd->files[script_file]->script_class_icon_path;\n+\t\t\t\t\t\ticon_path = efsd->files[script_file]->class_info.icon_path;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tfile_icon_cache.insert(script_path, icon_path);\n@@ -2029,7 +2009,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t}\n \t}\n \n-\tfile_info->icon_path = icon_path;\n+\tfile_info->class_info.icon_path = icon_path;\n }\n \n void EditorFileSystem::_update_files_icon_path(EditorFileSystemDirectory *edp) {\n@@ -2068,10 +2048,10 @@ void EditorFileSystem::_update_script_classes() {\n \t\t}\n \n \t\tint step_count = 0;\n-\t\tfor (const KeyValue<String, ScriptInfo> &E : update_script_paths) {\n-\t\t\t_register_global_class_script(E.key, E.key, E.value.type, E.value.script_class_name, E.value.script_class_extends, E.value.script_class_icon_path);\n+\t\tfor (const KeyValue<String, ScriptClassInfoUpdate> &E : update_script_paths) {\n+\t\t\t_register_global_class_script(E.key, E.key, E.value);\n \t\t\tif (ep) {\n-\t\t\t\tep->step(E.value.script_class_name, step_count++, false);\n+\t\t\t\tep->step(E.value.name, step_count++, false);\n \t\t\t}\n \t\t}\n \n@@ -2181,16 +2161,10 @@ void EditorFileSystem::_process_update_pending() {\n \t_update_pending_scene_groups();\n }\n \n-void EditorFileSystem::_queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update) {\n \tMutexLock update_script_lock(update_script_mutex);\n \n-\tScriptInfo si;\n-\tsi.type = p_type;\n-\tsi.script_class_name = p_script_class_name;\n-\tsi.script_class_extends = p_script_class_extends;\n-\tsi.script_class_icon_path = p_script_class_icon_path;\n-\tupdate_script_paths.insert(p_path, si);\n-\n+\tupdate_script_paths.insert(p_path, p_script_update);\n \tupdate_script_paths_documentation.insert(p_path);\n }\n \n@@ -2291,8 +2265,10 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (ClassDB::is_parent_class(fs->files[cpos]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(file, fs->files[cpos]->type, \"\", \"\", \"\");\n-\t\t\t\t\tif (!fs->files[cpos]->script_class_icon_path.is_empty()) {\n+\t\t\t\t\tScriptClassInfoUpdate update;\n+\t\t\t\t\tupdate.type = fs->files[cpos]->type;\n+\t\t\t\t\t_queue_update_script_class(file, update);\n+\t\t\t\t\tif (!fs->files[cpos]->class_info.icon_path.is_empty()) {\n \t\t\t\t\t\tupdate_files_icon_cache = true;\n \t\t\t\t\t}\n \t\t\t\t}\n@@ -2349,16 +2325,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t}\n \n \t\t\tEditorFileSystemDirectory::FileInfo *fi = fs->files[cpos];\n-\t\t\tconst String old_script_class_icon_path = fi->script_class_icon_path;\n-\t\t\tconst String old_class_name = fi->script_class_name;\n+\t\t\tconst String old_script_class_icon_path = fi->class_info.icon_path;\n+\t\t\tconst String old_class_name = fi->class_info.name;\n \t\t\tfi->type = type;\n \t\t\tfi->resource_script_class = script_class;\n \t\t\tfi->uid = uid;\n-\t\t\tfi->script_class_name = _get_global_script_class(type, file, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\tfi->class_info = _get_global_script_class(type, file);\n \t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(file);\n \t\t\tfi->modified_time = FileAccess::get_modified_time(file);\n \t\t\tfi->deps = _get_dependencies(file);\n-\t\t\tfi->import_valid = type == \"TextFile\" || type == \"OtherFile\" || ResourceLoader::is_import_valid(file);\n+\t\t\tfi->import_valid = (type == \"TextFile\" || type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(file);\n \n \t\t\tif (uid != ResourceUID::INVALID_ID) {\n \t\t\t\tif (ResourceUID::get_singleton()->has_id(uid)) {\n@@ -2384,7 +2360,7 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\tEditorResourcePreview::get_singleton()->check_for_invalidation(file);\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t_queue_update_script_class(file, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t_queue_update_script_class(file, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t}\n \t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t_queue_update_scene_groups(file);\n@@ -2392,16 +2368,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Resource\"))) {\n \t\t\t\tfiles_to_update_icon_path.push_back(fi);\n-\t\t\t} else if (old_script_class_icon_path != fi->script_class_icon_path) {\n+\t\t\t} else if (old_script_class_icon_path != fi->class_info.icon_path) {\n \t\t\t\tupdate_files_icon_cache = true;\n \t\t\t}\n \n \t\t\t// Restore another script as the global class name if multiple scripts had the same old class name.\n-\t\t\tif (!old_class_name.is_empty() && fi->script_class_name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n+\t\t\tif (!old_class_name.is_empty() && fi->class_info.name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n \t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n \t\t\t\tString old_file = _get_file_by_class_name(filesystem, old_class_name, old_fi);\n \t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t}\n \t\t\t}\n \t\t\tupdated = true;\n@@ -2435,16 +2411,16 @@ HashSet<String> EditorFileSystem::get_valid_extensions() const {\n \treturn valid_extensions;\n }\n \n-void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update) {\n \tScriptServer::remove_global_class_by_path(p_search_path); // First remove, just in case it changed\n \n-\tif (p_script_class_name.is_empty()) {\n+\tif (p_script_update.name.is_empty()) {\n \t\treturn;\n \t}\n \n \tString lang;\n \tfor (int j = 0; j < ScriptServer::get_language_count(); j++) {\n-\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_type)) {\n+\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_script_update.type)) {\n \t\t\tlang = ScriptServer::get_language(j)->get_name();\n \t\t\tbreak;\n \t\t}\n@@ -2453,9 +2429,9 @@ void EditorFileSystem::_register_global_class_script(const String &p_search_path\n \t\treturn; // No lang found that can handle this global class\n \t}\n \n-\tScriptServer::add_global_class(p_script_class_name, p_script_class_extends, lang, p_target_path);\n-\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_class_name, p_script_class_icon_path);\n-\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_class_name);\n+\tScriptServer::add_global_class(p_script_update.name, p_script_update.extends, lang, p_target_path, p_script_update.is_abstract, p_script_update.is_tool);\n+\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_update.name, p_script_update.icon_path);\n+\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_update.name);\n }\n \n void EditorFileSystem::register_global_class_script(const String &p_search_path, const String &p_target_path) {\n@@ -2463,7 +2439,7 @@ void EditorFileSystem::register_global_class_script(const String &p_search_path,\n \tEditorFileSystemDirectory *efsd = find_file(p_search_path, &index_file);\n \tif (efsd) {\n \t\tconst EditorFileSystemDirectory::FileInfo *fi = efsd->files[index_file];\n-\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, ScriptClassInfoUpdate::from_file_info(fi));\n \t} else {\n \t\tScriptServer::remove_global_class_by_path(p_search_path);\n \t}\ndiff --git a/editor/editor_file_system.h b/editor/editor_file_system.h\nindex 61041209a7fd..5b78b86a3f3f 100644\n--- a/editor/editor_file_system.h\n+++ b/editor/editor_file_system.h\n@@ -66,11 +66,15 @@ class EditorFileSystemDirectory : public Object {\n \t\tString import_group_file;\n \t\tVector<String> deps;\n \t\tbool verified = false; //used for checking changes\n-\t\t// These are for script resources only.\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n-\t\tString icon_path;\n+\t\t// This is for script resources only.\n+\t\tstruct ScriptClassInfo {\n+\t\t\tString name;\n+\t\t\tString extends;\n+\t\t\tString icon_path;\n+\t\t\tbool is_abstract = false;\n+\t\t\tbool is_tool = false;\n+\t\t};\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tVector<FileInfo *> files;\n@@ -203,9 +207,11 @@ class EditorFileSystem : public Node {\n \n \tstatic EditorFileSystem *singleton;\n \n+\tusing ScriptClassInfo = EditorFileSystemDirectory::FileInfo::ScriptClassInfo;\n+\n \t/* Used for reading the filesystem cache file */\n \tstruct FileCache {\n-\t\tString type;\n+\t\tStringName type;\n \t\tString resource_script_class;\n \t\tResourceUID::ID uid = ResourceUID::INVALID_ID;\n \t\tuint64_t modification_time = 0;\n@@ -215,9 +221,7 @@ class EditorFileSystem : public Node {\n \t\tVector<String> deps;\n \t\tbool import_valid = false;\n \t\tString import_group_file;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tHashMap<String, FileCache> file_cache;\n@@ -288,17 +292,27 @@ class EditorFileSystem : public Node {\n \t\t}\n \t};\n \n-\tstruct ScriptInfo {\n-\t\tString type;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\tstruct ScriptClassInfoUpdate : public ScriptClassInfo {\n+\t\tStringName type;\n+\t\tScriptClassInfoUpdate() = default;\n+\t\texplicit ScriptClassInfoUpdate(const ScriptClassInfo &p_info) :\n+\t\t\t\tScriptClassInfo(p_info) {}\n+\t\tstatic ScriptClassInfoUpdate from_file_info(const EditorFileSystemDirectory::FileInfo *p_fi) {\n+\t\t\tScriptClassInfoUpdate update;\n+\t\t\tupdate.type = p_fi->type;\n+\t\t\tupdate.name = p_fi->class_info.name;\n+\t\t\tupdate.extends = p_fi->class_info.extends;\n+\t\t\tupdate.icon_path = p_fi->class_info.icon_path;\n+\t\t\tupdate.is_abstract = p_fi->class_info.is_abstract;\n+\t\t\tupdate.is_tool = p_fi->class_info.is_tool;\n+\t\t\treturn update;\n+\t\t}\n \t};\n \n \tMutex update_script_mutex;\n-\tHashMap<String, ScriptInfo> update_script_paths;\n+\tHashMap<String, ScriptClassInfoUpdate> update_script_paths;\n \tHashSet<String> update_script_paths_documentation;\n-\tvoid _queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update);\n \tvoid _update_script_classes();\n \tvoid _update_script_documentation();\n \tvoid _process_update_pending();\n@@ -312,7 +326,7 @@ class EditorFileSystem : public Node {\n \tvoid _update_pending_scene_groups();\n \tvoid _get_all_scenes(EditorFileSystemDirectory *p_dir, HashSet<String> &r_list);\n \n-\tString _get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const;\n+\tScriptClassInfo _get_global_script_class(const String &p_type, const String &p_path) const;\n \n \tstatic Error _resource_import(const String &p_path);\n \tstatic Ref<Resource> _load_resource_on_startup(ResourceFormatImporter *p_importer, const String &p_path, Error *r_error, bool p_use_sub_threads, float *r_progress, ResourceFormatLoader::CacheMode p_cache_mode);\n@@ -359,7 +373,7 @@ class EditorFileSystem : public Node {\n \tvoid _remove_invalid_global_class_names(const HashSet<String> &p_existing_class_names);\n \tString _get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info);\n \n-\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update);\n \n protected:\n \tvoid _notification(int p_what);\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 4b7abdf2b072..3ada85d3de91 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -4805,13 +4805,13 @@ void EditorNode::_pick_main_scene_custom_action(const String &p_custom_action_na\n \t}\n }\n \n-Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback, bool p_fallback_script_to_theme) {\n+Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback, bool p_fallback_script_to_theme) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \tEditorData &ed = EditorNode::get_editor_data();\n \n \t// Check for a script icon first.\n-\tif (p_script.is_valid()) {\n-\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script);\n+\tif (!p_script_path.is_empty()) {\n+\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script_path);\n \t\tif (script_icon.is_valid()) {\n \t\t\treturn script_icon;\n \t\t}\n@@ -4819,14 +4819,15 @@ Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, cons\n \t\tif (p_fallback_script_to_theme) {\n \t\t\t// Look for the native base type in the editor theme. This is relevant for\n \t\t\t// scripts extending other scripts and for built-in classes.\n-\t\t\tString script_class_name = p_script->get_language()->get_global_class_name(p_script->get_path());\n \t\t\tString base_type;\n-\t\t\tif (script_class_name.is_empty()) {\n-\t\t\t\tbase_type = p_script->get_instance_base_type();\n+\t\t\tif (ScriptServer::is_global_class(p_class)) {\n+\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(p_class);\n \t\t\t} else {\n-\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(script_class_name);\n+\t\t\t\tRef<Script> scr = ResourceLoader::load(p_script_path, \"Script\");\n+\t\t\t\tif (scr.is_valid()) {\n+\t\t\t\t\tbase_type = scr->get_instance_base_type();\n+\t\t\t\t}\n \t\t\t}\n-\n \t\t\tif (theme.is_valid() && theme->has_icon(base_type, EditorStringName(EditorIcons))) {\n \t\t\t\treturn theme->get_icon(base_type, EditorStringName(EditorIcons));\n \t\t\t}\n@@ -4899,21 +4900,21 @@ Ref<Texture2D> EditorNode::get_object_icon(const Object *p_object, const String\n \tif (Object::cast_to<MultiNodeEdit>(p_object)) {\n \t\treturn get_class_icon(Object::cast_to<MultiNodeEdit>(p_object)->get_edited_class_name(), p_fallback);\n \t} else {\n-\t\treturn _get_class_or_script_icon(p_object->get_class(), scr, p_fallback);\n+\t\treturn _get_class_or_script_icon(p_object->get_class(), scr.is_valid() ? scr->get_path() : String(), p_fallback);\n \t}\n }\n \n Ref<Texture2D> EditorNode::get_class_icon(const String &p_class, const String &p_fallback) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \n-\tRef<Script> scr;\n+\tString script_path;\n \tif (ScriptServer::is_global_class(p_class)) {\n-\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_class);\n+\t\tscript_path = ScriptServer::get_global_class_path(p_class);\n \t} else if (ResourceLoader::exists(p_class)) { // If the script is not a class_name we check if the script resource exists.\n-\t\tscr = ResourceLoader::load(p_class);\n+\t\tscript_path = p_class;\n \t}\n \n-\treturn _get_class_or_script_icon(p_class, scr, p_fallback, true);\n+\treturn _get_class_or_script_icon(p_class, script_path, p_fallback, true);\n }\n \n bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringName &p_class) {\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex b77f6553fe96..2410996c948e 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -648,7 +648,7 @@ class EditorNode : public Node {\n \tvoid _feature_profile_changed();\n \tbool _is_class_editor_disabled_by_feature_profile(const StringName &p_class);\n \n-\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n+\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n \n \tvoid _pick_main_scene_custom_action(const String &p_custom_action_name);\n \ndiff --git a/modules/gdscript/gdscript.cpp b/modules/gdscript/gdscript.cpp\nindex db5a3b65ccb0..2383401630c4 100644\n--- a/modules/gdscript/gdscript.cpp\n+++ b/modules/gdscript/gdscript.cpp\n@@ -2831,7 +2831,7 @@ bool GDScriptLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == \"GDScript\";\n }\n \n-String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tError err;\n \tRef<FileAccess> f = FileAccess::open(p_path, FileAccess::READ, &err);\n \tif (err) {\n@@ -2932,6 +2932,12 @@ String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_b\n \tif (r_icon_path) {\n \t\t*r_icon_path = c->simplified_icon_path;\n \t}\n+\tif (r_is_abstract) {\n+\t\t*r_is_abstract = false;\n+\t}\n+\tif (r_is_tool) {\n+\t\t*r_is_tool = parser.is_tool();\n+\t}\n \treturn c->identifier != nullptr ? String(c->identifier->name) : String();\n }\n \ndiff --git a/modules/gdscript/gdscript.h b/modules/gdscript/gdscript.h\nindex ed04482f4811..9e96b8833496 100644\n--- a/modules/gdscript/gdscript.h\n+++ b/modules/gdscript/gdscript.h\n@@ -638,7 +638,7 @@ class GDScriptLanguage : public ScriptLanguage {\n \t/* GLOBAL CLASSES */\n \n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \tvoid add_orphan_subclass(const String &p_qualified_name, const ObjectID &p_subclass);\n \tRef<GDScript> get_orphan_subclass(const String &p_qualified_name);\ndiff --git a/modules/mono/csharp_script.cpp b/modules/mono/csharp_script.cpp\nindex e9a821c65a95..76c3ca3cb3eb 100644\n--- a/modules/mono/csharp_script.cpp\n+++ b/modules/mono/csharp_script.cpp\n@@ -445,9 +445,9 @@ bool CSharpLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == get_type();\n }\n \n-String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tString class_name;\n-\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, &class_name);\n+\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, r_is_abstract, r_is_tool, &class_name);\n \treturn class_name;\n }\n \ndiff --git a/modules/mono/csharp_script.h b/modules/mono/csharp_script.h\nindex 525357a4c413..4dfed135f861 100644\n--- a/modules/mono/csharp_script.h\n+++ b/modules/mono/csharp_script.h\n@@ -530,7 +530,7 @@ class CSharpLanguage : public ScriptLanguage {\n \n \t/* SCRIPT GLOBAL CLASS FUNCTIONS */\n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \t/* DEBUGGER FUNCTIONS */\n \tString debug_get_error() const override;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\nindex c7be0464b6c8..b0ff041fa49a 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n@@ -19,7 +19,7 @@ public unsafe struct ManagedCallbacks\n         public delegate* unmanaged<godot_string_name*, IntPtr, IntPtr> ScriptManagerBridge_CreateManagedForGodotObjectBinding;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_variant**, int, godot_bool> ScriptManagerBridge_CreateManagedForGodotObjectScriptInstance;\n         public delegate* unmanaged<IntPtr, godot_string_name*, void> ScriptManagerBridge_GetScriptNativeName;\n-        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n+        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_bool*, godot_bool*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n         public delegate* unmanaged<IntPtr, IntPtr, void> ScriptManagerBridge_SetGodotObjectPtr;\n         public delegate* unmanaged<IntPtr, godot_string_name*, godot_variant**, int, godot_bool*, void> ScriptManagerBridge_RaiseEventSignal;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_bool> ScriptManagerBridge_ScriptIsOrInherits;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\nindex e53f05f05825..a327b9cd354b 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n@@ -199,7 +199,7 @@ internal static unsafe void GetScriptNativeName(IntPtr scriptPtr, godot_string_n\n         }\n \n         [UnmanagedCallersOnly]\n-        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_string* outClassName)\n+        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_bool* outIsAbstract, godot_bool* outIsTool, godot_string* outClassName)\n         {\n             // This method must always return the outBaseType for every script, even if the script is\n             // not a global class. But if the script is not a global class it must return an empty\n@@ -254,6 +254,16 @@ internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_s\n                 }\n             }\n \n+            if (outIsAbstract != null)\n+            {\n+                *outIsAbstract = scriptType.IsAbstract.ToGodotBool();\n+            }\n+\n+            if (outIsTool != null)\n+            {\n+                *outIsTool = Attribute.IsDefined(scriptType, typeof(ToolAttribute)).ToGodotBool();\n+            }\n+\n             if (!IsGlobalClass(scriptType))\n             {\n                 // Scripts that are not global classes should not have a name.\ndiff --git a/modules/mono/mono_gd/gd_mono_cache.h b/modules/mono/mono_gd/gd_mono_cache.h\nindex 7c24f28b3a2a..f618921cd02b 100644\n--- a/modules/mono/mono_gd/gd_mono_cache.h\n+++ b/modules/mono/mono_gd/gd_mono_cache.h\n@@ -85,7 +85,7 @@ struct ManagedCallbacks {\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectBinding = GCHandleIntPtr(GD_CLR_STDCALL *)(const StringName *, Object *);\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectScriptInstance = bool(GD_CLR_STDCALL *)(const CSharpScript *, Object *, const Variant **, int32_t);\n \tusing FuncScriptManagerBridge_GetScriptNativeName = void(GD_CLR_STDCALL *)(const CSharpScript *, StringName *);\n-\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, String *);\n+\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, bool *, bool *, String *);\n \tusing FuncScriptManagerBridge_SetGodotObjectPtr = void(GD_CLR_STDCALL *)(GCHandleIntPtr, Object *);\n \tusing FuncScriptManagerBridge_RaiseEventSignal = void(GD_CLR_STDCALL *)(GCHandleIntPtr, const StringName *, const Variant **, int32_t, bool *);\n \tusing FuncScriptManagerBridge_ScriptIsOrInherits = bool(GD_CLR_STDCALL *)(const CSharpScript *, const CSharpScript *);\n", "test_patch": "diff --git a/modules/gdscript/tests/gdscript_test_runner.cpp b/modules/gdscript/tests/gdscript_test_runner.cpp\nindex 14dd79da9048..c7f92daa646a 100644\n--- a/modules/gdscript/tests/gdscript_test_runner.cpp\n+++ b/modules/gdscript/tests/gdscript_test_runner.cpp\n@@ -368,7 +368,9 @@ static bool generate_class_index_recursive(const String &p_dir) {\n \t\t\t}\n \t\t\tString base_type;\n \t\t\tString source_file = current_dir.path_join(next);\n-\t\t\tString class_name = GDScriptLanguage::get_singleton()->get_global_class_name(source_file, &base_type);\n+\t\t\tbool is_abstract = false;\n+\t\t\tbool is_tool = false;\n+\t\t\tString class_name = GDScriptLanguage::get_singleton()->get_global_class_name(source_file, &base_type, nullptr, &is_abstract, &is_tool);\n \t\t\tif (class_name.is_empty()) {\n \t\t\t\tnext = dir->get_next();\n \t\t\t\tcontinue;\n@@ -376,7 +378,7 @@ static bool generate_class_index_recursive(const String &p_dir) {\n \t\t\tERR_FAIL_COND_V_MSG(ScriptServer::is_global_class(class_name), false,\n \t\t\t\t\t\"Class name '\" + class_name + \"' from \" + source_file + \" is already used in \" + ScriptServer::get_global_class_path(class_name));\n \n-\t\t\tScriptServer::add_global_class(class_name, base_type, gdscript_name, source_file);\n+\t\t\tScriptServer::add_global_class(class_name, base_type, gdscript_name, source_file, is_abstract, is_tool);\n \t\t}\n \n \t\tnext = dir->get_next();\ndiff --git a/modules/gdscript/tests/test_gdscript.cpp b/modules/gdscript/tests/test_gdscript.cpp\nindex 7e93569e3901..ec20ed19fb9b 100644\n--- a/modules/gdscript/tests/test_gdscript.cpp\n+++ b/modules/gdscript/tests/test_gdscript.cpp\n@@ -297,10 +297,10 @@ void test(TestType p_type) {\n \tTypedArray<Dictionary> script_classes = ProjectSettings::get_singleton()->get_global_class_list();\n \tfor (int i = 0; i < script_classes.size(); i++) {\n \t\tDictionary c = script_classes[i];\n-\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\tcontinue;\n \t\t}\n-\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t}\n \n \tVector<uint8_t> buf;\n", "problem_statement": "Excessive error spam when a global script is not valid\n### Tested versions\n\n4.4 dev7\n\n### System information\n\nW10\n\n### Issue description\n\nIf you have a global script (with `class_name`) and it has an error, the error will be spammed occasionally when using editor. I observed it e.g. when opening CreateDialog to add a node (happens once), or every time you try to autocomplete something.\nhttps://github.com/user-attachments/assets/97e7b7f2-e148-42ee-a481-025a07a2d38f\nWhat's relevant though is that the error appears at all. It means the script is loaded and/or parsed needlessly *very often* and it probably applies to all global scripts. We should find a way to avoid that. The scripts should be parsed only after they change and use some cache whenever the editor needs something script-related.\n\n### Steps to reproduce\n\n1. Add a script with class name\n2. Introduce some parsing error, e.g. a random word wherever\n3. In another script, try autocompleting something\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-01-13 12:54:50", "merge_commit_sha": "acddf31c39f719b9012b1b3248ac28450238855b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101210", "base_commit": "4cf02312f6674083c5a628b4701643e1157c85f0", "patch": "diff --git a/servers/rendering/dummy/storage/material_storage.cpp b/servers/rendering/dummy/storage/material_storage.cpp\nindex e8b553ca7636..b22971a750cd 100644\n--- a/servers/rendering/dummy/storage/material_storage.cpp\n+++ b/servers/rendering/dummy/storage/material_storage.cpp\n@@ -30,6 +30,8 @@\n \n #include \"material_storage.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n using namespace RendererDummy;\n \n MaterialStorage *MaterialStorage::singleton = nullptr;\n@@ -42,6 +44,103 @@ MaterialStorage::MaterialStorage() {\n \n MaterialStorage::~MaterialStorage() {\n \tsingleton = nullptr;\n+\tglobal_shader_variables.clear();\n+}\n+\n+void MaterialStorage::global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) {\n+\tERR_FAIL_COND(global_shader_variables.has(p_name));\n+\n+\tglobal_shader_variables[p_name] = p_type;\n+}\n+\n+void MaterialStorage::global_shader_parameter_remove(const StringName &p_name) {\n+\tif (!global_shader_variables.has(p_name)) {\n+\t\treturn;\n+\t}\n+\n+\tglobal_shader_variables.erase(p_name);\n+}\n+\n+Vector<StringName> MaterialStorage::global_shader_parameter_get_list() const {\n+\tVector<StringName> names;\n+\tfor (const KeyValue<StringName, RS::GlobalShaderParameterType> &E : global_shader_variables) {\n+\t\tnames.push_back(E.key);\n+\t}\n+\tnames.sort_custom<StringName::AlphCompare>();\n+\treturn names;\n+}\n+\n+RS::GlobalShaderParameterType MaterialStorage::global_shader_parameter_get_type(const StringName &p_name) const {\n+\tif (!global_shader_variables.has(p_name)) {\n+\t\tprint_line(\"don't have name, sorry\");\n+\t\treturn RS::GLOBAL_VAR_TYPE_MAX;\n+\t}\n+\n+\treturn global_shader_variables[p_name];\n+}\n+\n+void MaterialStorage::global_shader_parameters_load_settings(bool p_load_textures) {\n+\tList<PropertyInfo> settings;\n+\tProjectSettings::get_singleton()->get_property_list(&settings);\n+\n+\tfor (const PropertyInfo &E : settings) {\n+\t\tif (E.name.begins_with(\"shader_globals/\")) {\n+\t\t\tStringName name = E.name.get_slice(\"/\", 1);\n+\t\t\tDictionary d = GLOBAL_GET(E.name);\n+\n+\t\t\tERR_CONTINUE(!d.has(\"type\"));\n+\t\t\tERR_CONTINUE(!d.has(\"value\"));\n+\n+\t\t\tString type = d[\"type\"];\n+\n+\t\t\tstatic const char *global_var_type_names[RS::GLOBAL_VAR_TYPE_MAX] = {\n+\t\t\t\t\"bool\",\n+\t\t\t\t\"bvec2\",\n+\t\t\t\t\"bvec3\",\n+\t\t\t\t\"bvec4\",\n+\t\t\t\t\"int\",\n+\t\t\t\t\"ivec2\",\n+\t\t\t\t\"ivec3\",\n+\t\t\t\t\"ivec4\",\n+\t\t\t\t\"rect2i\",\n+\t\t\t\t\"uint\",\n+\t\t\t\t\"uvec2\",\n+\t\t\t\t\"uvec3\",\n+\t\t\t\t\"uvec4\",\n+\t\t\t\t\"float\",\n+\t\t\t\t\"vec2\",\n+\t\t\t\t\"vec3\",\n+\t\t\t\t\"vec4\",\n+\t\t\t\t\"color\",\n+\t\t\t\t\"rect2\",\n+\t\t\t\t\"mat2\",\n+\t\t\t\t\"mat3\",\n+\t\t\t\t\"mat4\",\n+\t\t\t\t\"transform_2d\",\n+\t\t\t\t\"transform\",\n+\t\t\t\t\"sampler2D\",\n+\t\t\t\t\"sampler2DArray\",\n+\t\t\t\t\"sampler3D\",\n+\t\t\t\t\"samplerCube\",\n+\t\t\t\t\"samplerExternalOES\"\n+\t\t\t};\n+\n+\t\t\tRS::GlobalShaderParameterType gvtype = RS::GLOBAL_VAR_TYPE_MAX;\n+\n+\t\t\tfor (int i = 0; i < RS::GLOBAL_VAR_TYPE_MAX; i++) {\n+\t\t\t\tif (global_var_type_names[i] == type) {\n+\t\t\t\t\tgvtype = RS::GlobalShaderParameterType(i);\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tERR_CONTINUE(gvtype == RS::GLOBAL_VAR_TYPE_MAX); //type invalid\n+\n+\t\t\tif (!global_shader_variables.has(name)) {\n+\t\t\t\tglobal_shader_parameter_add(name, gvtype, Variant());\n+\t\t\t}\n+\t\t}\n+\t}\n }\n \n RID MaterialStorage::shader_allocate() {\n@@ -131,3 +230,56 @@ void MaterialStorage::get_shader_parameter_list(RID p_shader, List<PropertyInfo>\n \t\tp_param_list->push_back(pi);\n \t}\n }\n+\n+RID MaterialStorage::material_allocate() {\n+\treturn material_owner.allocate_rid();\n+}\n+\n+void MaterialStorage::material_initialize(RID p_rid) {\n+\tmaterial_owner.initialize_rid(p_rid, DummyMaterial());\n+}\n+\n+void MaterialStorage::material_free(RID p_rid) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_rid);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial_owner.free(p_rid);\n+}\n+\n+void MaterialStorage::material_set_shader(RID p_material, RID p_shader) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial->shader = p_shader;\n+}\n+\n+void MaterialStorage::material_set_next_pass(RID p_material, RID p_next_material) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial->next_pass = p_next_material;\n+}\n+\n+void MaterialStorage::material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\tDummyShader *shader = shader_owner.get_or_null(material->shader);\n+\n+\tif (shader) {\n+\t\tfor (const KeyValue<StringName, ShaderLanguage::ShaderNode::Uniform> &E : shader->uniforms) {\n+\t\t\tif (E.value.scope != ShaderLanguage::ShaderNode::Uniform::SCOPE_INSTANCE) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tRendererMaterialStorage::InstanceShaderParam p;\n+\t\t\tp.info = ShaderLanguage::uniform_to_property_info(E.value);\n+\t\t\tp.info.name = E.key; //supply name\n+\t\t\tp.index = E.value.instance_index;\n+\t\t\tp.default_value = ShaderLanguage::constant_value_to_variant(E.value.default_value, E.value.type, E.value.array_size, E.value.hint);\n+\t\t\tr_parameters->push_back(p);\n+\t\t}\n+\t}\n+\tif (material->next_pass.is_valid()) {\n+\t\tmaterial_get_instance_shader_parameters(material->next_pass, r_parameters);\n+\t}\n+}\ndiff --git a/servers/rendering/dummy/storage/material_storage.h b/servers/rendering/dummy/storage/material_storage.h\nindex 9422c395e2e6..ef46cf3b9b4f 100644\n--- a/servers/rendering/dummy/storage/material_storage.h\n+++ b/servers/rendering/dummy/storage/material_storage.h\n@@ -42,6 +42,8 @@ class MaterialStorage : public RendererMaterialStorage {\n private:\n \tstatic MaterialStorage *singleton;\n \n+\tHashMap<StringName, RS::GlobalShaderParameterType> global_shader_variables;\n+\n \tstruct DummyShader {\n \t\tHashMap<StringName, ShaderLanguage::ShaderNode::Uniform> uniforms;\n \t};\n@@ -50,6 +52,13 @@ class MaterialStorage : public RendererMaterialStorage {\n \n \tShaderCompiler dummy_compiler;\n \n+\tstruct DummyMaterial {\n+\t\tRID shader;\n+\t\tRID next_pass;\n+\t};\n+\n+\tmutable RID_Owner<DummyMaterial> material_owner;\n+\n public:\n \tstatic MaterialStorage *get_singleton() { return singleton; }\n \n@@ -58,16 +67,16 @@ class MaterialStorage : public RendererMaterialStorage {\n \n \t/* GLOBAL SHADER UNIFORM API */\n \n-\tvirtual void global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) override {}\n-\tvirtual void global_shader_parameter_remove(const StringName &p_name) override {}\n-\tvirtual Vector<StringName> global_shader_parameter_get_list() const override { return Vector<StringName>(); }\n+\tvirtual void global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) override;\n+\tvirtual void global_shader_parameter_remove(const StringName &p_name) override;\n+\tvirtual Vector<StringName> global_shader_parameter_get_list() const override;\n \n \tvirtual void global_shader_parameter_set(const StringName &p_name, const Variant &p_value) override {}\n \tvirtual void global_shader_parameter_set_override(const StringName &p_name, const Variant &p_value) override {}\n \tvirtual Variant global_shader_parameter_get(const StringName &p_name) const override { return Variant(); }\n-\tvirtual RS::GlobalShaderParameterType global_shader_parameter_get_type(const StringName &p_name) const override { return RS::GLOBAL_VAR_TYPE_MAX; }\n+\tvirtual RS::GlobalShaderParameterType global_shader_parameter_get_type(const StringName &p_name) const override;\n \n-\tvirtual void global_shader_parameters_load_settings(bool p_load_textures = true) override {}\n+\tvirtual void global_shader_parameters_load_settings(bool p_load_textures = true) override;\n \tvirtual void global_shader_parameters_clear() override {}\n \n \tvirtual int32_t global_shader_parameters_instance_allocate(RID p_instance) override { return 0; }\n@@ -95,23 +104,26 @@ class MaterialStorage : public RendererMaterialStorage {\n \tvirtual RS::ShaderNativeSourceCode shader_get_native_source_code(RID p_shader) const override { return RS::ShaderNativeSourceCode(); }\n \n \t/* MATERIAL API */\n-\tvirtual RID material_allocate() override { return RID(); }\n-\tvirtual void material_initialize(RID p_rid) override {}\n-\tvirtual void material_free(RID p_rid) override {}\n+\n+\tbool owns_material(RID p_rid) { return material_owner.owns(p_rid); }\n+\n+\tvirtual RID material_allocate() override;\n+\tvirtual void material_initialize(RID p_rid) override;\n+\tvirtual void material_free(RID p_rid) override;\n \n \tvirtual void material_set_render_priority(RID p_material, int priority) override {}\n-\tvirtual void material_set_shader(RID p_shader_material, RID p_shader) override {}\n+\tvirtual void material_set_shader(RID p_shader_material, RID p_shader) override;\n \n \tvirtual void material_set_param(RID p_material, const StringName &p_param, const Variant &p_value) override {}\n \tvirtual Variant material_get_param(RID p_material, const StringName &p_param) const override { return Variant(); }\n \n-\tvirtual void material_set_next_pass(RID p_material, RID p_next_material) override {}\n+\tvirtual void material_set_next_pass(RID p_material, RID p_next_material) override;\n \n \tvirtual bool material_is_animated(RID p_material) override { return false; }\n \tvirtual bool material_casts_shadows(RID p_material) override { return false; }\n \tvirtual RS::CullMode material_get_cull_mode(RID p_material) const override { return RS::CULL_MODE_DISABLED; }\n \n-\tvirtual void material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) override {}\n+\tvirtual void material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) override;\n \tvirtual void material_update_dependency(RID p_material, DependencyTracker *p_instance) override {}\n };\n \ndiff --git a/servers/rendering/dummy/storage/utilities.h b/servers/rendering/dummy/storage/utilities.h\nindex 4e20dee640e5..02e163fd8e8e 100644\n--- a/servers/rendering/dummy/storage/utilities.h\n+++ b/servers/rendering/dummy/storage/utilities.h\n@@ -77,6 +77,9 @@ class Utilities : public RendererUtilities {\n \t\t} else if (RendererDummy::MaterialStorage::get_singleton()->owns_shader(p_rid)) {\n \t\t\tRendererDummy::MaterialStorage::get_singleton()->shader_free(p_rid);\n \t\t\treturn true;\n+\t\t} else if (RendererDummy::MaterialStorage::get_singleton()->owns_material(p_rid)) {\n+\t\t\tRendererDummy::MaterialStorage::get_singleton()->material_free(p_rid);\n+\t\t\treturn true;\n \t\t}\n \t\treturn false;\n \t}\n", "test_patch": "", "problem_statement": "Sometimes when exporting in \"--headless\" mode, shaders with \"global uniform\" doesn't work\n### Tested versions\n\nReproduced: v4.3.stable.mono\n\n### System information\n\nGodot v4.3.stable.mono - Windows 10.0.19045 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2060 (NVIDIA; 32.0.15.6094) - AMD Ryzen 5 1600 Six-Core Processor (12 Threads)\n\n### Issue description\n\nSimilar to https://github.com/godotengine/godot/issues/102362, which seems only visual, but in some cases might change into completely breaking a shader.\nThe issue happens when you have shader with global uniforms (correctly added to the Project Settings) and export it.\n\nBehavior of exporting the project normally or via cmd and that of exporting it **via cmd with --headless** mode is different. Doing it the first method works correctly, doing it the second method breaks the shaders with global uniforms. \n\nBut importantly, the working of the exported shader will be based on **how the project was exported for the first time** \n\nSo:\n1. Export normally -> shader works in the build\n2. Export with --headless -> shader still work in the build\n\nBUT:\n1. Export with --headless -> shader does NOT work in the build\n2. **Export normally -> shader STILL does NOT work in the build**\n\nI traced this behavior to the \".godot/exported\" folder - if you remove it, you \"restart\" the process, as above.\n\nI noticed it first when setting up my CI pipeline (with Github Actions). As there is no .godot folder on the machine, and it uses --headless, it's gonna break the shaders every time. Only fix I found was including .godot/exported in the source control.\n\n\n### Steps to reproduce\n\n1. In empty project, create shader that uses \"global uniform\". Then create material using that shader and apply it on some mesh (not sure if required)\n2. Add the required global uniforms in Project Settings\n3. Remove the  \".godot/exported\" folder (if exists)\n4. Export the project using command line using \"--headless\" mode. (In case of MRP I use godot --headless --export-release \"Windows Desktop\" \"build/Shader Test.exe\")\n5. Notice the shader does not use the uniform correctly in the build\n\n### Minimal reproduction project (MRP)\n\n[shader-test.zip](https://github.com/user-attachments/files/18642930/shader-test.zip)\n", "hints_text": "", "created_at": "2025-01-07 04:51:54", "merge_commit_sha": "a0c3798fba393a02ec087b0cfdbe5e526c3c7769", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101162", "base_commit": "da4f9339ea7f614f5965e6a6b918b8c8285f2e1d", "patch": "diff --git a/scene/resources/particle_process_material.cpp b/scene/resources/particle_process_material.cpp\nindex dd81b1c4380d..13bc02014b01 100644\n--- a/scene/resources/particle_process_material.cpp\n+++ b/scene/resources/particle_process_material.cpp\n@@ -523,6 +523,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tfloat animation_offset;\\n\";\n \tcode += \"\tfloat lifetime;\\n\";\n \tcode += \"\tvec4 color;\\n\";\n+\tcode += \"\tfloat emission_texture_position;\\n\";\n \tcode += \"};\\n\\n\";\n \n \tcode += \"struct DynamicsParameters {\\n\";\n@@ -579,11 +580,15 @@ void ParticleProcessMaterial::_update_shader() {\n \tif (color_initial_ramp.is_valid()) {\n \t\tcode += \"\tparams.color *= texture(color_initial_ramp, vec2(rand_from_seed(alt_seed)));\\n\";\n \t}\n-\tif (emission_color_texture.is_valid() && (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS)) {\n-\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n-\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n-\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n-\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n+\t\tcode += \"\tparams.emission_texture_position = rand_from_seed(alt_seed);\\n\";\n+\n+\t\tif (emission_color_texture.is_valid()) {\n+\t\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n+\t\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\t\t}\n \t}\n \tcode += \"}\\n\\n\";\n \n@@ -614,7 +619,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t}\n \tcode += \"}\\n\\n\";\n \n-\tcode += \"vec3 calculate_initial_position(inout uint alt_seed) {\\n\";\n+\tcode += \"vec3 calculate_initial_position(inout DisplayParameters params, inout uint alt_seed) {\\n\";\n \tcode += \"\tfloat pi = 3.14159;\\n\";\n \tcode += \"\tvec3 pos = vec3(0.0);\\n\";\n \tcode += \"\t{ // Emission shape.\\n\";\n@@ -639,7 +644,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t\tcode += \"\t\tpos = vec3(rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0) * emission_box_extents;\\n\";\n \t}\n \tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tcode += \"\t\tpos = texelFetch(emission_texture_points, emission_tex_ofs, 0).xyz;\\n\";\n@@ -860,7 +865,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\t\tTRANSFORM[2].xyz = vec3(0.0, 0.0, 1.0);\\n\";\n \tcode += \"\t}\\n\";\n \tcode += \"\tif (RESTART_POSITION) {\\n\";\n-\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(alt_seed);\\n\";\n+\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(params, alt_seed);\\n\";\n \tif (turbulence_enabled) {\n \t\tcode += \"\t\tfloat initial_turbulence_displacement = mix(turbulence_initial_displacement_min, turbulence_initial_displacement_max, rand_from_seed(alt_seed));\\n\";\n \t\tcode += \"\t\tvec3 noise_direction = get_noise_direction(TRANSFORM[3].xyz);\\n\";\n@@ -871,7 +876,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tif (RESTART_VELOCITY) {\\n\";\n \tcode += \"\t\tVELOCITY = get_random_direction_from_spread(alt_seed, spread) * dynamic_params.initial_velocity_multiplier;\\n\";\n \tif (emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tif (particle_flags[PARTICLE_FLAG_DISABLE_Z]) {\n", "test_patch": "", "problem_statement": "GPUParticles2D emission mask captures random color instead of pixel color\n### Tested versions\n\n- Reproducible in: v4.2.stable.mono.official [46dc27791]\n\n### System information\n\nGodot v4.2.stable.mono - Windows 10.0.22621 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 31.0.15.4629) - 13th Gen Intel(R) Core(TM) i5-13600KF (20 Threads)\n\n### Issue description\n\nEmission mask for GPUParticles2D captures colors incorrectly, instead of copying colors from place where particles spawned, it uses random color from mask texture\n\n### Steps to reproduce\n\n1. Create `GPUParticles2D` node\r\n2. Set `Amount` to 10000 to make it look more detailed\r\n3. Create `ParticlesProcessMaterial` for it\r\n4. Load emission mask for it, using some color texture and with options `Solid pixels` and `Capture Colors from Pixels` (`centered` doesn't matter)\r\n5. View result\n\n### Minimal reproduction project (MRP)\n\n[Bug.zip](https://github.com/godotengine/godot/files/14071691/Bug.zip)\r\n\n", "hints_text": "", "created_at": "2025-01-05 22:26:47", "merge_commit_sha": "33c0fc5508f47af8fcd4b49d08d55a9021aef590", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101127", "base_commit": "bdf625bd54958c737fa6b7213b07581cc91059ad", "patch": "diff --git a/modules/gdscript/gdscript_editor.cpp b/modules/gdscript/gdscript_editor.cpp\nindex c20c17f34860..7ee8d8c42614 100644\n--- a/modules/gdscript/gdscript_editor.cpp\n+++ b/modules/gdscript/gdscript_editor.cpp\n@@ -3684,12 +3684,12 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::GROUP:\n \t\t\t\t\t\treturn ERR_BUG;\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::CLASS: {\n-\t\t\t\t\t\tString type_name;\n-\t\t\t\t\t\tString enum_name;\n-\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(member.get_datatype()), type_name, enum_name);\n+\t\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(member.get_datatype()), doc_type_name, doc_enum_name);\n \n \t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS;\n-\t\t\t\t\t\tr_result.class_name = type_name;\n+\t\t\t\t\t\tr_result.class_name = doc_type_name;\n \t\t\t\t\t} break;\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::CONSTANT:\n \t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n@@ -3712,11 +3712,11 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t}\n \n \t\t\t\tif (member.type != GDScriptParser::ClassNode::Member::CLASS) {\n-\t\t\t\t\tString type_name;\n-\t\t\t\t\tString enum_name;\n-\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), type_name, enum_name);\n+\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), doc_type_name, doc_enum_name);\n \n-\t\t\t\t\tr_result.class_name = type_name;\n+\t\t\t\t\tr_result.class_name = doc_type_name;\n \t\t\t\t\tr_result.class_member = name;\n \t\t\t\t}\n \n@@ -3934,21 +3934,35 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\tcase GDScriptParser::DataType::ENUM: {\n \t\t\t\tif (base_type.is_meta_type) {\n \t\t\t\t\tif (base_type.enum_values.has(p_symbol)) {\n-\t\t\t\t\t\tString type_name;\n-\t\t\t\t\t\tString enum_name;\n-\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), type_name, enum_name);\n+\t\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), doc_type_name, doc_enum_name);\n \n-\t\t\t\t\t\tif (CoreConstants::is_global_enum(enum_name)) {\n+\t\t\t\t\t\tif (CoreConstants::is_global_enum(doc_enum_name)) {\n \t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n \t\t\t\t\t\t\tr_result.class_name = \"@GlobalScope\";\n \t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\treturn OK;\n \t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tconst int dot_pos = enum_name.rfind_char('.');\n+\t\t\t\t\t\t\tconst int dot_pos = doc_enum_name.rfind_char('.');\n \t\t\t\t\t\t\tif (dot_pos >= 0) {\n \t\t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n-\t\t\t\t\t\t\t\tr_result.class_name = enum_name.left(dot_pos);\n+\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n \t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\tif (base_type.class_type != nullptr) {\n+\t\t\t\t\t\t\t\t\tconst String enum_name = doc_enum_name.substr(dot_pos + 1);\n+\t\t\t\t\t\t\t\t\tif (base_type.class_type->has_member(enum_name)) {\n+\t\t\t\t\t\t\t\t\t\tconst GDScriptParser::ClassNode::Member member = base_type.class_type->get_member(enum_name);\n+\t\t\t\t\t\t\t\t\t\tif (member.type == GDScriptParser::ClassNode::Member::ENUM) {\n+\t\t\t\t\t\t\t\t\t\t\tfor (const GDScriptParser::EnumNode::Value &value : member.m_enum->values) {\n+\t\t\t\t\t\t\t\t\t\t\t\tif (value.identifier->name == p_symbol) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\tr_result.location = value.line;\n+\t\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\treturn OK;\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n", "test_patch": "", "problem_statement": "Ctrl-Click on enum value/member does nothing\n### Tested versions\n\n- reproducible in: 4.4.dev7\n- reproducible on master (tested with a 03-Jan-2025 build - `v4.4.dev.gh-101012 [c37ada786]`)\n- works in: 4.4.dev6\n\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nI mentioned this here: https://github.com/godotengine/godot/issues/100680#issuecomment-2557966392\nWhile general control-click was restored with https://github.com/godotengine/godot/pull/100707 the enum issue remains.\n\nCTRL-clicking on an enum value/member does nothing (well, it actually navigates to the beginning of the line).\n\nE.g. enum like this:\n```\nclass_name E extends Object\n\nenum Team {\n\tNone,\n\tOne,\n}\n\nfunc test():\n\tvar t = E.Team.None\n```\nand CTRL-clicking on the `None` of `E.Team.None` does not take you to the `None` under `enum Team`.\n\n\n### Steps to reproduce\n\nOpen enum.gd in MRP - same code as in description.\n\n### Minimal reproduction project (MRP)\n\n[44dev7enum.zip](https://github.com/user-attachments/files/18303044/44dev7enum.zip)\n\n", "hints_text": "Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. \n\nhttps://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n\nIt seems that changing the class's documentation updates something and it suddenly works.\n\nI couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n> Hi, I was looking at your bug and messing around, and some very weird things were happening ... here's a video in 4.4.dev7. https://github.com/user-attachments/assets/90ab71d5-b7aa-428e-b8d5-bb237c101167\n> \n> It seems that changing the class's documentation updates something and it suddenly works.\n> \n> I couldn't reproduce this behavior at all in master ... it just goes to the class's documentation page.\n\nYes, ctrl-click change https://github.com/godotengine/godot/pull/100707 went into master after dev7.\n\nOkay that makes sense but still that behavior where adding documentation effects Ctrl+click is very weird... can you reproduce it on your computer?", "created_at": "2025-01-04 14:14:17", "merge_commit_sha": "0b6a717ac17f1d6bd7963740cf2c2128b36ff7aa", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101014", "base_commit": "4cf02312f6674083c5a628b4701643e1157c85f0", "patch": "diff --git a/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp b/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\nindex 6db68f413ebd..db9a9bef04b2 100644\n--- a/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\n+++ b/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\n@@ -350,7 +350,7 @@ void CollisionShape3DGizmoPlugin::redraw(EditorNode3DGizmo *p_gizmo) {\n \n \tif (cs->get_debug_fill_enabled()) {\n \t\tRef<ArrayMesh> array_mesh = s->get_debug_arraymesh_faces(collision_color);\n-\t\tif (array_mesh.is_valid()) {\n+\t\tif (array_mesh.is_valid() && array_mesh->get_surface_count() > 0) {\n \t\t\tp_gizmo->add_mesh(array_mesh, material_arraymesh);\n \t\t}\n \t}\ndiff --git a/scene/resources/3d/shape_3d.cpp b/scene/resources/3d/shape_3d.cpp\nindex 63d424fb3724..4eae3ffeb2e5 100644\n--- a/scene/resources/3d/shape_3d.cpp\n+++ b/scene/resources/3d/shape_3d.cpp\n@@ -132,9 +132,12 @@ Ref<ArrayMesh> Shape3D::get_debug_mesh() {\n \t\tdebug_mesh_cache->surface_set_material(0, material);\n \n \t\tif (debug_fill) {\n-\t\t\tArray solid_array = get_debug_arraymesh_faces(debug_color * Color(1.0, 1.0, 1.0, 0.0625))->surface_get_arrays(0);\n-\t\t\tdebug_mesh_cache->add_surface_from_arrays(Mesh::PRIMITIVE_TRIANGLES, solid_array);\n-\t\t\tdebug_mesh_cache->surface_set_material(1, material);\n+\t\t\tRef<ArrayMesh> array_mesh = get_debug_arraymesh_faces(debug_color * Color(1.0, 1.0, 1.0, 0.0625));\n+\t\t\tif (array_mesh.is_valid() && array_mesh->get_surface_count() > 0) {\n+\t\t\t\tArray solid_array = array_mesh->surface_get_arrays(0);\n+\t\t\t\tdebug_mesh_cache->add_surface_from_arrays(Mesh::PRIMITIVE_TRIANGLES, solid_array);\n+\t\t\t\tdebug_mesh_cache->surface_set_material(1, material);\n+\t\t\t}\n \t\t}\n \t}\n \n", "test_patch": "", "problem_statement": "[4.4 dev7] Seperation Ray causes Mesh surface errors\n### Tested versions\n\n-reproducible in 4.4 Dev 7, mono version \n\n### System information\n\nGodot v4.4.dev7.mono - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1070 (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i5-7640X CPU @ 4.00GHz (4 threads)\n\n### Issue description\n\nThree errors are thrown when starting a scene with a CollisionShape3D with shape set to Seperation Ray.\n![Image](https://github.com/user-attachments/assets/8da0920f-c8db-420f-9ff6-c955df909800)\n\n\n### Steps to reproduce\n\nOpen the attached project. Run the main scene.\n\nAlternatively, run a scene with a CollisionShape3D, with the shape set to Seperation Ray.\n\n### Minimal reproduction project (MRP)\n\n[surface-error-example.zip](https://github.com/user-attachments/files/18215122/surface-error-example.zip)\n\n", "hints_text": "Seems a regression between 4.4 dev 5 and 4.4 dev 6, also, the bug needs `Debug -> Visible Collision Shapes` enabled to happen. I'll start the bisect.\nBisescted to #90644, @BattyBovine\n\n![Image](https://github.com/user-attachments/assets/47b5b20f-de9f-4c5c-a147-8bb9ff238e95)\n\nI managed to reproduce this issue. It seems like it should be an easy fix. The only issue here seems to be that the separation ray generates an empty debug mesh array, which Godot does not like. I'll get a fix for it soon.", "created_at": "2025-01-02 07:41:02", "merge_commit_sha": "bacf8d198deea244863a6cd885b12e9f89214117", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100983", "base_commit": "2582793d408ade0b6ed42f913ae33e7da5fb9184", "patch": "diff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex 50ee2699a244..eccd7c385478 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -59,6 +59,26 @@ JPH::ObjectLayer JoltArea3D::_get_object_layer() const {\n \treturn space->map_to_object_layer(_get_broad_phase_layer(), collision_layer, collision_mask);\n }\n \n+bool JoltArea3D::_has_pending_events() const {\n+\tif (body_monitor_callback.is_valid()) {\n+\t\tfor (const KeyValue<JPH::BodyID, Overlap> &E : bodies_by_id) {\n+\t\t\tif (!E.value.pending_added.is_empty() || !E.value.pending_removed.is_empty()) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (area_monitor_callback.is_valid()) {\n+\t\tfor (const KeyValue<JPH::BodyID, Overlap> &E : areas_by_id) {\n+\t\t\tif (!E.value.pending_added.is_empty() || !E.value.pending_removed.is_empty()) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\treturn false;\n+}\n+\n void JoltArea3D::_add_to_space() {\n \tjolt_shape = build_shape();\n \n@@ -90,6 +110,18 @@ void JoltArea3D::_add_to_space() {\n \tjolt_settings = nullptr;\n }\n \n+void JoltArea3D::_enqueue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->enqueue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n+void JoltArea3D::_dequeue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->dequeue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n void JoltArea3D::_add_shape_pair(Overlap &p_overlap, const JPH::BodyID &p_body_id, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id) {\n \tconst JoltReadableBody3D other_jolt_body = space->read_body(p_body_id);\n \tconst JoltShapedObject3D *other_object = other_jolt_body.as_shaped();\n@@ -270,6 +302,8 @@ void JoltArea3D::_space_changing() {\n \t\t_force_bodies_exited(true);\n \t\t_force_areas_exited(true);\n \t}\n+\n+\t_dequeue_call_queries();\n }\n \n void JoltArea3D::_space_changed() {\n@@ -304,7 +338,8 @@ void JoltArea3D::_gravity_changed() {\n }\n \n JoltArea3D::JoltArea3D() :\n-\t\tJoltShapedObject3D(OBJECT_TYPE_AREA) {\n+\t\tJoltShapedObject3D(OBJECT_TYPE_AREA),\n+\t\tcall_queries_element(this) {\n }\n \n bool JoltArea3D::is_default_area() const {\n@@ -659,7 +694,13 @@ void JoltArea3D::area_exited(const JPH::BodyID &p_body_id) {\n \toverlap->shape_pairs.clear();\n }\n \n-void JoltArea3D::call_queries(JPH::Body &p_jolt_body) {\n+void JoltArea3D::call_queries() {\n \t_flush_events(bodies_by_id, body_monitor_callback);\n \t_flush_events(areas_by_id, area_monitor_callback);\n }\n+\n+void JoltArea3D::post_step(float p_step, JPH::Body &p_jolt_body) {\n+\tif (_has_pending_events()) {\n+\t\t_enqueue_call_queries();\n+\t}\n+}\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.h b/modules/jolt_physics/objects/jolt_area_3d.h\nindex d151a7d05ad3..18410c34cfc2 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.h\n+++ b/modules/jolt_physics/objects/jolt_area_3d.h\n@@ -89,6 +89,8 @@ class JoltArea3D final : public JoltShapedObject3D {\n \n \ttypedef HashMap<JPH::BodyID, Overlap, BodyIDHasher> OverlapsById;\n \n+\tSelfList<JoltArea3D> call_queries_element;\n+\n \tOverlapsById bodies_by_id;\n \tOverlapsById areas_by_id;\n \n@@ -115,8 +117,13 @@ class JoltArea3D final : public JoltShapedObject3D {\n \n \tvirtual JPH::EMotionType _get_motion_type() const override { return JPH::EMotionType::Kinematic; }\n \n+\tbool _has_pending_events() const;\n+\n \tvirtual void _add_to_space() override;\n \n+\tvoid _enqueue_call_queries();\n+\tvoid _dequeue_call_queries();\n+\n \tvoid _add_shape_pair(Overlap &p_overlap, const JPH::BodyID &p_body_id, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id);\n \tbool _remove_shape_pair(Overlap &p_overlap, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id);\n \n@@ -217,10 +224,12 @@ class JoltArea3D final : public JoltShapedObject3D {\n \tvoid body_exited(const JPH::BodyID &p_body_id, bool p_notify = true);\n \tvoid area_exited(const JPH::BodyID &p_body_id);\n \n-\tvoid call_queries(JPH::Body &p_jolt_body);\n+\tvoid call_queries();\n \n \tvirtual bool has_custom_center_of_mass() const override { return false; }\n \tvirtual Vector3 get_center_of_mass_custom() const override { return Vector3(); }\n+\n+\tvirtual void post_step(float p_step, JPH::Body &p_jolt_body) override;\n };\n \n #endif // JOLT_AREA_3D_H\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex 59ba42c6ca91..3768dc8d0a9c 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -128,6 +128,7 @@ void JoltBody3D::_add_to_space() {\n \tjolt_settings->mAllowDynamicOrKinematic = true;\n \tjolt_settings->mCollideKinematicVsNonDynamic = reports_all_kinematic_contacts();\n \tjolt_settings->mUseManifoldReduction = !reports_contacts();\n+\tjolt_settings->mAllowSleeping = is_sleep_actually_allowed();\n \tjolt_settings->mLinearDamping = 0.0f;\n \tjolt_settings->mAngularDamping = 0.0f;\n \tjolt_settings->mMaxLinearVelocity = JoltProjectSettings::get_max_linear_velocity();\n@@ -153,11 +154,19 @@ void JoltBody3D::_add_to_space() {\n \tjolt_settings = nullptr;\n }\n \n-void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n-\tif (!p_jolt_body.IsActive()) {\n-\t\treturn;\n+void JoltBody3D::_enqueue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->enqueue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n+void JoltBody3D::_dequeue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->dequeue_call_queries(&call_queries_element);\n \t}\n+}\n \n+void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n \t_update_gravity(p_jolt_body);\n \n \tif (!custom_integrator) {\n@@ -182,8 +191,6 @@ void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n \t\tp_jolt_body.AddForce(to_jolt(constant_force));\n \t\tp_jolt_body.AddTorque(to_jolt(constant_torque));\n \t}\n-\n-\tsync_state = true;\n }\n \n void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n@@ -201,27 +208,19 @@ void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \t}\n \n \tp_jolt_body.MoveKinematic(new_position, new_rotation, p_step);\n-\n-\tsync_state = true;\n-}\n-\n-void JoltBody3D::_pre_step_static(float p_step, JPH::Body &p_jolt_body) {\n-\t// Nothing to do.\n }\n \n void JoltBody3D::_pre_step_rigid(float p_step, JPH::Body &p_jolt_body) {\n \t_integrate_forces(p_step, p_jolt_body);\n+\t_enqueue_call_queries();\n }\n \n void JoltBody3D::_pre_step_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \t_update_gravity(p_jolt_body);\n-\n \t_move_kinematic(p_step, p_jolt_body);\n \n \tif (reports_contacts()) {\n-\t\t// This seems to emulate the behavior of Godot Physics, where kinematic bodies are set as active (and thereby\n-\t\t// have their state synchronized on every step) only if its max reported contacts is non-zero.\n-\t\tsync_state = true;\n+\t\t_enqueue_call_queries();\n \t}\n }\n \n@@ -428,6 +427,20 @@ void JoltBody3D::_update_possible_kinematic_contacts() {\n \t}\n }\n \n+void JoltBody3D::_update_sleep_allowed() {\n+\tconst bool value = is_sleep_actually_allowed();\n+\n+\tif (!in_space()) {\n+\t\tjolt_settings->mAllowSleeping = value;\n+\t\treturn;\n+\t}\n+\n+\tconst JoltWritableBody3D body = space->write_body(jolt_id);\n+\tERR_FAIL_COND(body.is_invalid());\n+\n+\tbody->SetAllowSleeping(value);\n+}\n+\n void JoltBody3D::_destroy_joint_constraints() {\n \tfor (JoltJoint3D *joint : joints) {\n \t\tjoint->destroy();\n@@ -460,6 +473,7 @@ void JoltBody3D::_mode_changed() {\n \t_update_object_layer();\n \t_update_kinematic_transform();\n \t_update_mass_properties();\n+\t_update_sleep_allowed();\n \twake_up();\n }\n \n@@ -478,6 +492,7 @@ void JoltBody3D::_space_changing() {\n \n \t_destroy_joint_constraints();\n \t_exit_all_areas();\n+\t_dequeue_call_queries();\n }\n \n void JoltBody3D::_space_changed() {\n@@ -486,9 +501,8 @@ void JoltBody3D::_space_changed() {\n \t_update_kinematic_transform();\n \t_update_group_filter();\n \t_update_joint_constraints();\n+\t_update_sleep_allowed();\n \t_areas_changed();\n-\n-\tsync_state = false;\n }\n \n void JoltBody3D::_areas_changed() {\n@@ -519,11 +533,18 @@ void JoltBody3D::_axis_lock_changed() {\n \n void JoltBody3D::_contact_reporting_changed() {\n \t_update_possible_kinematic_contacts();\n+\t_update_sleep_allowed();\n+\twake_up();\n+}\n+\n+void JoltBody3D::_sleep_allowed_changed() {\n+\t_update_sleep_allowed();\n \twake_up();\n }\n \n JoltBody3D::JoltBody3D() :\n-\t\tJoltShapedObject3D(OBJECT_TYPE_BODY) {\n+\t\tJoltShapedObject3D(OBJECT_TYPE_BODY),\n+\t\tcall_queries_element(this) {\n }\n \n JoltBody3D::~JoltBody3D() {\n@@ -573,7 +594,7 @@ Variant JoltBody3D::get_state(PhysicsServer3D::BodyState p_state) const {\n \t\t\treturn is_sleeping();\n \t\t}\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\treturn can_sleep();\n+\t\t\treturn is_sleep_allowed();\n \t\t}\n \t\tdefault: {\n \t\t\tERR_FAIL_V_MSG(Variant(), vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -596,7 +617,7 @@ void JoltBody3D::set_state(PhysicsServer3D::BodyState p_state, const Variant &p_\n \t\t\tset_is_sleeping(p_value);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\tset_can_sleep(p_value);\n+\t\t\tset_is_sleep_allowed(p_value);\n \t\t} break;\n \t\tdefault: {\n \t\t\tERR_FAIL_MSG(vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -712,6 +733,10 @@ bool JoltBody3D::is_sleeping() const {\n \treturn !body->IsActive();\n }\n \n+bool JoltBody3D::is_sleep_actually_allowed() const {\n+\treturn sleep_allowed && !(is_kinematic() && reports_contacts());\n+}\n+\n void JoltBody3D::set_is_sleeping(bool p_enabled) {\n \tif (!in_space()) {\n \t\tsleep_initially = p_enabled;\n@@ -727,27 +752,14 @@ void JoltBody3D::set_is_sleeping(bool p_enabled) {\n \t}\n }\n \n-bool JoltBody3D::can_sleep() const {\n-\tif (!in_space()) {\n-\t\treturn jolt_settings->mAllowSleeping;\n-\t}\n-\n-\tconst JoltReadableBody3D body = space->read_body(jolt_id);\n-\tERR_FAIL_COND_V(body.is_invalid(), false);\n-\n-\treturn body->GetAllowSleeping();\n-}\n-\n-void JoltBody3D::set_can_sleep(bool p_enabled) {\n-\tif (!in_space()) {\n-\t\tjolt_settings->mAllowSleeping = p_enabled;\n+void JoltBody3D::set_is_sleep_allowed(bool p_enabled) {\n+\tif (sleep_allowed == p_enabled) {\n \t\treturn;\n \t}\n \n-\tconst JoltWritableBody3D body = space->write_body(jolt_id);\n-\tERR_FAIL_COND(body.is_invalid());\n+\tsleep_allowed = p_enabled;\n \n-\tbody->SetAllowSleeping(p_enabled);\n+\t_sleep_allowed_changed();\n }\n \n Basis JoltBody3D::get_principal_inertia_axes() const {\n@@ -1187,11 +1199,7 @@ void JoltBody3D::remove_joint(JoltJoint3D *p_joint) {\n \t_joints_changed();\n }\n \n-void JoltBody3D::call_queries(JPH::Body &p_jolt_body) {\n-\tif (!sync_state) {\n-\t\treturn;\n-\t}\n-\n+void JoltBody3D::call_queries() {\n \tif (custom_integration_callback.is_valid()) {\n \t\tconst Variant direct_state_variant = get_direct_state();\n \t\tconst Variant *args[2] = { &direct_state_variant, &custom_integration_userdata };\n@@ -1218,8 +1226,6 @@ void JoltBody3D::call_queries(JPH::Body &p_jolt_body) {\n \t\t\tERR_PRINT_ONCE(vformat(\"Failed to call state synchronization callback for '%s'. It returned the following error: '%s'.\", to_string(), Variant::get_callable_error_text(state_sync_callback, args, 1, ce)));\n \t\t}\n \t}\n-\n-\tsync_state = false;\n }\n \n void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n@@ -1227,7 +1233,7 @@ void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n \n \tswitch (mode) {\n \t\tcase PhysicsServer3D::BODY_MODE_STATIC: {\n-\t\t\t_pre_step_static(p_step, p_jolt_body);\n+\t\t\t// Will never happen.\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID:\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID_LINEAR: {\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.h b/modules/jolt_physics/objects/jolt_body_3d.h\nindex dc1e258bec86..8e5a149437a3 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_body_3d.h\n@@ -57,6 +57,8 @@ class JoltBody3D final : public JoltShapedObject3D {\n \t};\n \n private:\n+\tSelfList<JoltBody3D> call_queries_element;\n+\n \tLocalVector<RID> exceptions;\n \tLocalVector<Contact> contacts;\n \tLocalVector<JoltArea3D *> areas;\n@@ -96,7 +98,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tuint32_t locked_axes = 0;\n \n-\tbool sync_state = false;\n+\tbool sleep_allowed = true;\n \tbool sleep_initially = false;\n \tbool custom_center_of_mass = false;\n \tbool custom_integrator = false;\n@@ -108,11 +110,13 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvirtual void _add_to_space() override;\n \n+\tvoid _enqueue_call_queries();\n+\tvoid _dequeue_call_queries();\n+\n \tvoid _integrate_forces(float p_step, JPH::Body &p_jolt_body);\n \n \tvoid _move_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n-\tvoid _pre_step_static(float p_step, JPH::Body &p_jolt_body);\n \tvoid _pre_step_rigid(float p_step, JPH::Body &p_jolt_body);\n \tvoid _pre_step_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n@@ -128,6 +132,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid _update_group_filter();\n \tvoid _update_joint_constraints();\n \tvoid _update_possible_kinematic_contacts();\n+\tvoid _update_sleep_allowed();\n \n \tvoid _destroy_joint_constraints();\n \n@@ -144,6 +149,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid _exceptions_changed();\n \tvoid _axis_lock_changed();\n \tvoid _contact_reporting_changed();\n+\tvoid _sleep_allowed_changed();\n \n public:\n \tJoltBody3D();\n@@ -175,8 +181,9 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid put_to_sleep() { set_is_sleeping(true); }\n \tvoid wake_up() { set_is_sleeping(false); }\n \n-\tbool can_sleep() const;\n-\tvoid set_can_sleep(bool p_enabled);\n+\tbool is_sleep_allowed() const { return sleep_allowed; }\n+\tbool is_sleep_actually_allowed() const;\n+\tvoid set_is_sleep_allowed(bool p_enabled);\n \n \tBasis get_principal_inertia_axes() const;\n \tVector3 get_inverse_inertia() const;\n@@ -238,7 +245,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid add_joint(JoltJoint3D *p_joint);\n \tvoid remove_joint(JoltJoint3D *p_joint);\n \n-\tvoid call_queries(JPH::Body &p_jolt_body);\n+\tvoid call_queries();\n \n \tvirtual void pre_step(float p_step, JPH::Body &p_jolt_body) override;\n \ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex 9c83718fb6e6..577e8157a53d 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -160,13 +160,14 @@ void JoltShapedObject3D::_update_shape() {\n \tconst JoltWritableBody3D body = space->write_body(jolt_id);\n \tERR_FAIL_COND(body.is_invalid());\n \n-\tprevious_jolt_shape = jolt_shape;\n-\tjolt_shape = build_shape();\n-\n-\tif (jolt_shape == previous_jolt_shape) {\n+\tJPH::ShapeRefC new_shape = build_shape();\n+\tif (new_shape == jolt_shape) {\n \t\treturn;\n \t}\n \n+\tprevious_jolt_shape = jolt_shape;\n+\tjolt_shape = new_shape;\n+\n \tspace->get_body_iface().SetShape(jolt_id, jolt_shape, false, JPH::EActivation::DontActivate);\n \n \t_shapes_built();\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\nindex c9e834fd42e2..281591af9a6c 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n@@ -438,7 +438,7 @@ void JoltSoftBody3D::set_is_sleeping(bool p_enabled) {\n \t}\n }\n \n-bool JoltSoftBody3D::can_sleep() const {\n+bool JoltSoftBody3D::is_sleep_allowed() const {\n \tif (!in_space()) {\n \t\treturn true;\n \t}\n@@ -449,7 +449,7 @@ bool JoltSoftBody3D::can_sleep() const {\n \treturn body->GetAllowSleeping();\n }\n \n-void JoltSoftBody3D::set_can_sleep(bool p_enabled) {\n+void JoltSoftBody3D::set_is_sleep_allowed(bool p_enabled) {\n \tif (!in_space()) {\n \t\treturn;\n \t}\n@@ -532,7 +532,7 @@ Variant JoltSoftBody3D::get_state(PhysicsServer3D::BodyState p_state) const {\n \t\t\treturn is_sleeping();\n \t\t}\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\treturn can_sleep();\n+\t\t\treturn is_sleep_allowed();\n \t\t}\n \t\tdefault: {\n \t\t\tERR_FAIL_V_MSG(Variant(), vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -555,7 +555,7 @@ void JoltSoftBody3D::set_state(PhysicsServer3D::BodyState p_state, const Variant\n \t\t\tset_is_sleeping(p_value);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\tset_can_sleep(p_value);\n+\t\t\tset_is_sleep_allowed(p_value);\n \t\t} break;\n \t\tdefault: {\n \t\t\tERR_FAIL_MSG(vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.h b/modules/jolt_physics/objects/jolt_soft_body_3d.h\nindex 45e8be2e7bf4..f236310f6c69 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.h\n@@ -124,8 +124,8 @@ class JoltSoftBody3D final : public JoltObject3D {\n \tbool is_sleeping() const;\n \tvoid set_is_sleeping(bool p_enabled);\n \n-\tbool can_sleep() const;\n-\tvoid set_can_sleep(bool p_enabled);\n+\tbool is_sleep_allowed() const;\n+\tvoid set_is_sleep_allowed(bool p_enabled);\n \n \tvoid put_to_sleep() { set_is_sleeping(true); }\n \tvoid wake_up() { set_is_sleeping(false); }\ndiff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\nindex 85cf08d4c921..85a29a244bdd 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n@@ -86,10 +86,6 @@ void JoltContactListener3D::OnSoftBodyContactAdded(const JPH::Body &p_soft_body,\n \n #endif\n \n-bool JoltContactListener3D::_is_listening_for(const JPH::Body &p_body) const {\n-\treturn listening_for.has(p_body.GetID());\n-}\n-\n bool JoltContactListener3D::_try_override_collision_response(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings) {\n \tif (p_jolt_body1.IsSensor() || p_jolt_body2.IsSensor()) {\n \t\treturn false;\n@@ -178,16 +174,19 @@ bool JoltContactListener3D::_try_apply_surface_velocities(const JPH::Body &p_jol\n \treturn true;\n }\n \n-bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings) {\n-\tif (p_body1.IsSensor() || p_body2.IsSensor()) {\n+bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings) {\n+\tif (p_jolt_body1.IsSensor() || p_jolt_body2.IsSensor()) {\n \t\treturn false;\n \t}\n \n-\tif (!_is_listening_for(p_body1) && !_is_listening_for(p_body2)) {\n+\tconst JoltBody3D *body1 = reinterpret_cast<JoltBody3D *>(p_jolt_body1.GetUserData());\n+\tconst JoltBody3D *body2 = reinterpret_cast<JoltBody3D *>(p_jolt_body2.GetUserData());\n+\n+\tif (!body1->reports_contacts() && !body2->reports_contacts()) {\n \t\treturn false;\n \t}\n \n-\tconst JPH::SubShapeIDPair shape_pair(p_body1.GetID(), p_manifold.mSubShapeID1, p_body2.GetID(), p_manifold.mSubShapeID2);\n+\tconst JPH::SubShapeIDPair shape_pair(p_jolt_body1.GetID(), p_manifold.mSubShapeID1, p_jolt_body2.GetID(), p_manifold.mSubShapeID2);\n \n \tManifold &manifold = [&]() -> Manifold & {\n \t\tconst MutexLock write_lock(write_mutex);\n@@ -201,8 +200,7 @@ bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JP\n \tmanifold.depth = p_manifold.mPenetrationDepth;\n \n \tJPH::CollisionEstimationResult collision;\n-\n-\tJPH::EstimateCollisionResponse(p_body1, p_body2, p_manifold, collision, p_settings.mCombinedFriction, p_settings.mCombinedRestitution, JoltProjectSettings::get_bounce_velocity_threshold(), 5);\n+\tJPH::EstimateCollisionResponse(p_jolt_body1, p_jolt_body2, p_manifold, collision, p_settings.mCombinedFriction, p_settings.mCombinedRestitution, JoltProjectSettings::get_bounce_velocity_threshold(), 5);\n \n \tfor (JPH::uint i = 0; i < contact_count; ++i) {\n \t\tconst JPH::RVec3 relative_point1 = JPH::RVec3(p_manifold.mRelativeContactPointsOn1[i]);\n@@ -211,8 +209,8 @@ bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JP\n \t\tconst JPH::RVec3 world_point1 = p_manifold.mBaseOffset + relative_point1;\n \t\tconst JPH::RVec3 world_point2 = p_manifold.mBaseOffset + relative_point2;\n \n-\t\tconst JPH::Vec3 velocity1 = p_body1.GetPointVelocity(world_point1);\n-\t\tconst JPH::Vec3 velocity2 = p_body2.GetPointVelocity(world_point2);\n+\t\tconst JPH::Vec3 velocity1 = p_jolt_body1.GetPointVelocity(world_point1);\n+\t\tconst JPH::Vec3 velocity2 = p_jolt_body2.GetPointVelocity(world_point2);\n \n \t\tconst JPH::CollisionEstimationResult::Impulse &impulse = collision.mImpulses[i];\n \n@@ -532,13 +530,7 @@ void JoltContactListener3D::_flush_area_exits() {\n \tarea_exits.clear();\n }\n \n-void JoltContactListener3D::listen_for(JoltShapedObject3D *p_object) {\n-\tlistening_for.insert(p_object->get_jolt_id());\n-}\n-\n void JoltContactListener3D::pre_step() {\n-\tlistening_for.clear();\n-\n #ifdef DEBUG_ENABLED\n \tdebug_contact_count = 0;\n #endif\ndiff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.h b/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\nindex 26136abd83ac..41b3c9ef3bb2 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\n@@ -85,7 +85,6 @@ class JoltContactListener3D final\n \t};\n \n \tHashMap<JPH::SubShapeIDPair, Manifold, ShapePairHasher> manifolds_by_shape_pair;\n-\tHashSet<JPH::BodyID, BodyIDHasher> listening_for;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_overlaps;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_enters;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_exits;\n@@ -107,12 +106,10 @@ class JoltContactListener3D final\n \tvirtual void OnSoftBodyContactAdded(const JPH::Body &p_soft_body, const JPH::SoftBodyManifold &p_manifold) override;\n #endif\n \n-\tbool _is_listening_for(const JPH::Body &p_body) const;\n-\n \tbool _try_override_collision_response(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings);\n \tbool _try_override_collision_response(const JPH::Body &p_jolt_soft_body, const JPH::Body &p_jolt_other_body, JPH::SoftBodyContactSettings &p_settings);\n \tbool _try_apply_surface_velocities(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings);\n-\tbool _try_add_contacts(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings);\n+\tbool _try_add_contacts(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings);\n \tbool _try_evaluate_area_overlap(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold);\n \tbool _try_remove_contacts(const JPH::SubShapeIDPair &p_shape_pair);\n \tbool _try_remove_area_overlap(const JPH::SubShapeIDPair &p_shape_pair);\n@@ -131,8 +128,6 @@ class JoltContactListener3D final\n \texplicit JoltContactListener3D(JoltSpace3D *p_space) :\n \t\t\tspace(p_space) {}\n \n-\tvoid listen_for(JoltShapedObject3D *p_object);\n-\n \tvoid pre_step();\n \tvoid post_step();\n \ndiff --git a/modules/jolt_physics/spaces/jolt_space_3d.cpp b/modules/jolt_physics/spaces/jolt_space_3d.cpp\nindex 57d813df2b95..78bdf778f554 100644\n--- a/modules/jolt_physics/spaces/jolt_space_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_space_3d.cpp\n@@ -63,55 +63,36 @@ constexpr double DEFAULT_SOLVER_ITERATIONS = 8;\n } // namespace\n \n void JoltSpace3D::_pre_step(float p_step) {\n-\tbody_accessor.acquire_all();\n-\n \tcontact_listener->pre_step();\n \n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSoftBody()) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n-\t\t\tJoltShapedObject3D *object = reinterpret_cast<JoltShapedObject3D *>(jolt_body->GetUserData());\n-\n-\t\t\tobject->pre_step(p_step, *jolt_body);\n+\tconst JPH::BodyLockInterface &lock_iface = get_lock_iface();\n+\tconst JPH::BodyID *active_rigid_bodies = physics_system->GetActiveBodiesUnsafe(JPH::EBodyType::RigidBody);\n+\tconst JPH::uint32 active_rigid_body_count = physics_system->GetNumActiveBodies(JPH::EBodyType::RigidBody);\n \n-\t\t\tif (object->reports_contacts()) {\n-\t\t\t\tcontact_listener->listen_for(object);\n-\t\t\t}\n-\t\t}\n+\tfor (JPH::uint32 i = 0; i < active_rigid_body_count; i++) {\n+\t\tJPH::Body *jolt_body = lock_iface.TryGetBody(active_rigid_bodies[i]);\n+\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\t\tobject->pre_step(p_step, *jolt_body);\n \t}\n-\n-\tbody_accessor.release();\n }\n \n void JoltSpace3D::_post_step(float p_step) {\n-\tbody_accessor.acquire_all();\n-\n \tcontact_listener->post_step();\n \n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSoftBody()) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n+\t// WARNING: The list of active bodies may have changed between `pre_step` and `post_step`.\n \n-\t\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\tconst JPH::BodyLockInterface &lock_iface = get_lock_iface();\n+\tconst JPH::BodyID *active_rigid_bodies = physics_system->GetActiveBodiesUnsafe(JPH::EBodyType::RigidBody);\n+\tconst JPH::uint32 active_rigid_body_count = physics_system->GetNumActiveBodies(JPH::EBodyType::RigidBody);\n \n-\t\t\tobject->post_step(p_step, *jolt_body);\n-\t\t}\n+\tfor (JPH::uint32 i = 0; i < active_rigid_body_count; i++) {\n+\t\tJPH::Body *jolt_body = lock_iface.TryGetBody(active_rigid_bodies[i]);\n+\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\t\tobject->post_step(p_step, *jolt_body);\n \t}\n-\n-\tbody_accessor.release();\n }\n \n JoltSpace3D::JoltSpace3D(JPH::JobSystem *p_job_system) :\n-\t\tbody_accessor(this),\n \t\tjob_system(p_job_system),\n \t\ttemp_allocator(new JoltTempAllocator()),\n \t\tlayers(new JoltLayers()),\n@@ -208,44 +189,21 @@ void JoltSpace3D::step(float p_step) {\n \t_post_step(p_step);\n \n \tbodies_added_since_optimizing = 0;\n-\thas_stepped = true;\n \tstepping = false;\n }\n \n void JoltSpace3D::call_queries() {\n-\tif (!has_stepped) {\n-\t\t// We need to skip the first invocation of this method, because there will be pending notifications that need to\n-\t\t// be flushed first, which can cause weird conflicts with things like `_integrate_forces`. This happens to also\n-\t\t// emulate the behavior of Godot Physics, where (active) collision objects must register to have `call_queries`\n-\t\t// invoked, which they don't do until the physics step, which happens after this.\n-\t\t//\n-\t\t// TODO: This would be better solved by just doing what Godot Physics does with `GodotSpace*D::active_list`.\n-\t\treturn;\n-\t}\n-\n-\tbody_accessor.acquire_all();\n-\n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (!jolt_body->IsSensor() && !jolt_body->IsSoftBody()) {\n-\t\t\t\tJoltBody3D *body = reinterpret_cast<JoltBody3D *>(jolt_body->GetUserData());\n-\t\t\t\tbody->call_queries(*jolt_body);\n-\t\t\t}\n-\t\t}\n+\twhile (body_call_queries_list.first()) {\n+\t\tJoltBody3D *body = body_call_queries_list.first()->self();\n+\t\tbody_call_queries_list.remove(body_call_queries_list.first());\n+\t\tbody->call_queries();\n \t}\n \n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSensor()) {\n-\t\t\t\tJoltArea3D *area = reinterpret_cast<JoltArea3D *>(jolt_body->GetUserData());\n-\t\t\t\tarea->call_queries(*jolt_body);\n-\t\t\t}\n-\t\t}\n+\twhile (area_call_queries_list.first()) {\n+\t\tJoltArea3D *body = area_call_queries_list.first()->self();\n+\t\tarea_call_queries_list.remove(area_call_queries_list.first());\n+\t\tbody->call_queries();\n \t}\n-\n-\tbody_accessor.release();\n }\n \n double JoltSpace3D::get_param(PhysicsServer3D::SpaceParameter p_param) const {\n@@ -445,6 +403,30 @@ void JoltSpace3D::try_optimize() {\n \tbodies_added_since_optimizing = 0;\n }\n \n+void JoltSpace3D::enqueue_call_queries(SelfList<JoltBody3D> *p_body) {\n+\tif (!p_body->in_list()) {\n+\t\tbody_call_queries_list.add(p_body);\n+\t}\n+}\n+\n+void JoltSpace3D::enqueue_call_queries(SelfList<JoltArea3D> *p_area) {\n+\tif (!p_area->in_list()) {\n+\t\tarea_call_queries_list.add(p_area);\n+\t}\n+}\n+\n+void JoltSpace3D::dequeue_call_queries(SelfList<JoltBody3D> *p_body) {\n+\tif (p_body->in_list()) {\n+\t\tbody_call_queries_list.remove(p_body);\n+\t}\n+}\n+\n+void JoltSpace3D::dequeue_call_queries(SelfList<JoltArea3D> *p_area) {\n+\tif (p_area->in_list()) {\n+\t\tarea_call_queries_list.remove(p_area);\n+\t}\n+}\n+\n void JoltSpace3D::add_joint(JPH::Constraint *p_jolt_ref) {\n \tphysics_system->AddConstraint(p_jolt_ref);\n }\ndiff --git a/modules/jolt_physics/spaces/jolt_space_3d.h b/modules/jolt_physics/spaces/jolt_space_3d.h\nindex eb666644eae6..989df9a49853 100644\n--- a/modules/jolt_physics/spaces/jolt_space_3d.h\n+++ b/modules/jolt_physics/spaces/jolt_space_3d.h\n@@ -48,6 +48,7 @@\n #include <stdint.h>\n \n class JoltArea3D;\n+class JoltBody3D;\n class JoltContactListener3D;\n class JoltJoint3D;\n class JoltLayers;\n@@ -55,7 +56,8 @@ class JoltObject3D;\n class JoltPhysicsDirectSpaceState3D;\n \n class JoltSpace3D {\n-\tJoltBodyWriter3D body_accessor;\n+\tSelfList<JoltBody3D>::List body_call_queries_list;\n+\tSelfList<JoltArea3D>::List area_call_queries_list;\n \n \tRID rid;\n \n@@ -73,7 +75,6 @@ class JoltSpace3D {\n \n \tbool active = false;\n \tbool stepping = false;\n-\tbool has_stepped = false;\n \n \tvoid _pre_step(float p_step);\n \tvoid _post_step(float p_step);\n@@ -132,6 +133,11 @@ class JoltSpace3D {\n \n \tvoid try_optimize();\n \n+\tvoid enqueue_call_queries(SelfList<JoltBody3D> *p_body);\n+\tvoid enqueue_call_queries(SelfList<JoltArea3D> *p_area);\n+\tvoid dequeue_call_queries(SelfList<JoltBody3D> *p_body);\n+\tvoid dequeue_call_queries(SelfList<JoltArea3D> *p_area);\n+\n \tvoid add_joint(JPH::Constraint *p_jolt_ref);\n \tvoid add_joint(JoltJoint3D *p_joint);\n \tvoid remove_joint(JPH::Constraint *p_jolt_ref);\n", "test_patch": "", "problem_statement": "`RigidBody3D` frozen as kinematic doesn't always report contacts with Jolt Physics\n### Tested versions\n\nReproducible in: 4.4.dev [a7a2a12bfd1c34057f158f4510841bcc766a9348]\n\n### System information\n\nWindows 11 (10.0.26100)\n\n### Issue description\n\nThis is an issue introduced by #100533.\n\nIn short, a `RigidBody3D` frozen with `FREEZE_MODE_KINEMATIC` and `contact_monitor` enabled (along with a non-zero `max_contacts_reported`) is currently only able to report contacts when moving.\n\nThis differs from Godot Physics, where contacts are reported regardless if such a body is stationary or moving.\n\nThe reason for this is that #100533 made it so contacts are only reported for active/awake bodies. The problem with this is that kinematic bodies are only considered to be active/awake for the physics step after having moved, which meant that you'd have to be moving the kinematic body in order for contacts to be reported for it.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Run the main scene.\n- Note how no contact is reported in the Output window until the capsule starts moving.\n- Switch physics engine to `GodotPhysics3D`.\n- Note how contacts are reported right as the box falls on top of the capsule.\n\n### Minimal reproduction project (MRP)\n\n[jolt-kinematic-contacts.zip](https://github.com/user-attachments/files/18219118/jolt-kinematic-contacts.zip)\n`RigidBody3D` frozen as kinematic doesn't always report contacts with Jolt Physics\n### Tested versions\n\nReproducible in: 4.4.dev [a7a2a12bfd1c34057f158f4510841bcc766a9348]\n\n### System information\n\nWindows 11 (10.0.26100)\n\n### Issue description\n\nThis is an issue introduced by #100533.\n\nIn short, a `RigidBody3D` frozen with `FREEZE_MODE_KINEMATIC` and `contact_monitor` enabled (along with a non-zero `max_contacts_reported`) is currently only able to report contacts when moving.\n\nThis differs from Godot Physics, where contacts are reported regardless if such a body is stationary or moving.\n\nThe reason for this is that #100533 made it so contacts are only reported for active/awake bodies. The problem with this is that kinematic bodies are only considered to be active/awake for the physics step after having moved, which meant that you'd have to be moving the kinematic body in order for contacts to be reported for it.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Run the main scene.\n- Note how no contact is reported in the Output window until the capsule starts moving.\n- Switch physics engine to `GodotPhysics3D`.\n- Note how contacts are reported right as the box falls on top of the capsule.\n\n### Minimal reproduction project (MRP)\n\n[jolt-kinematic-contacts.zip](https://github.com/user-attachments/files/18219118/jolt-kinematic-contacts.zip)\n", "hints_text": "\n", "created_at": "2024-12-31 17:45:41", "merge_commit_sha": "1f2d535f78a323fdd7471053af2be3fcaeed4158", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100916", "base_commit": "efa144396d8003c4b3021bca8242ce5cda4d131f", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 9d14e702be41..03c2f2067e9c 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -296,6 +296,7 @@ void EmbeddedProcess::_check_focused_process_id() {\n \t\tfocused_process_id = process_id;\n \t\tif (focused_process_id == current_process_id) {\n \t\t\t// The embedded process got the focus.\n+\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n \t\t\tif (has_focus()) {\n \t\t\t\t// Redraw to updated the focus style.\n \t\t\t\tqueue_redraw();\n@@ -312,6 +313,7 @@ void EmbeddedProcess::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"embedding_completed\"));\n \tADD_SIGNAL(MethodInfo(\"embedding_failed\"));\n \tADD_SIGNAL(MethodInfo(\"embedded_process_updated\"));\n+\tADD_SIGNAL(MethodInfo(\"embedded_process_focused\"));\n }\n \n EmbeddedProcess::EmbeddedProcess() {\ndiff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex f7e58258d425..d611f0a773cf 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -260,6 +260,12 @@ void GameView::_embedded_process_updated() {\n \tgame_size_label->set_text(vformat(\"%dx%d\", game_rect.size.x, game_rect.size.y));\n }\n \n+void GameView::_embedded_process_focused() {\n+\tif (embed_on_play && !window_wrapper->get_window_enabled()) {\n+\t\tEditorNode::get_singleton()->get_editor_main_screen()->select(EditorMainScreen::EDITOR_GAME);\n+\t}\n+}\n+\n void GameView::_project_settings_changed() {\n \t// Update the window size and aspect ratio.\n \t_update_embed_window_size();\n@@ -730,6 +736,7 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tembedded_process->connect(\"embedding_failed\", callable_mp(this, &GameView::_embedding_failed));\n \tembedded_process->connect(\"embedding_completed\", callable_mp(this, &GameView::_embedding_completed));\n \tembedded_process->connect(\"embedded_process_updated\", callable_mp(this, &GameView::_embedded_process_updated));\n+\tembedded_process->connect(\"embedded_process_focused\", callable_mp(this, &GameView::_embedded_process_focused));\n \tembedded_process->set_custom_minimum_size(Size2i(100, 100));\n \n \tstate_label = memnew(Label());\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6568f07b746c..64d679657c33 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -143,6 +143,7 @@ class GameView : public VBoxContainer {\n \tvoid _embedding_completed();\n \tvoid _embedding_failed();\n \tvoid _embedded_process_updated();\n+\tvoid _embedded_process_focused();\n \tvoid _project_settings_changed();\n \n \tvoid _update_ui();\n", "test_patch": "", "problem_statement": "Debugging embedded game does not refocus on continue\n### Tested versions\n\nGodot v4.4.dev (99a8ab795)\n\n### System information\n\nGodot v4.4.dev (99a8ab795) - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Laptop GPU (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 5800H with Radeon Graphics (16 threads)\n\n### Issue description\n\nWhen the game is embedded without the floating window, after hitting a breakpoint in the script editor, when I pressed Continue, the game tab is not refocused and Godot enters a wierd state where the editor is not focused, the game is probably focused but not visible.\n\n### Steps to reproduce\n\n- In the Game Workspace, enabled Embed and disable Floating Window\n- Attach a script and add a breakpoint anywhere\n- Start the game\n- Hit the breakpoint\n- Press Continue\n\nhttps://github.com/user-attachments/assets/fe304f67-773d-4948-9ec7-790e06b28db6\n\n\n### Minimal reproduction project (MRP)\n\n[test-godot-focus-debugging.zip](https://github.com/user-attachments/files/18269775/test-godot-focus-debugging.zip)\n\n", "hints_text": "", "created_at": "2024-12-29 23:19:19", "merge_commit_sha": "9ec36eb243a9df1ad83bc867b007d0159c299363", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100913", "base_commit": "9630d4e2fc1d0fdef6f46f24e236548549f31d49", "patch": "diff --git a/doc/classes/TextEdit.xml b/doc/classes/TextEdit.xml\nindex 89e2a2017af1..826a491888df 100644\n--- a/doc/classes/TextEdit.xml\n+++ b/doc/classes/TextEdit.xml\n@@ -349,9 +349,12 @@\n \t\t<method name=\"get_line_column_at_pos\" qualifiers=\"const\">\n \t\t\t<return type=\"Vector2i\" />\n \t\t\t<param index=\"0\" name=\"position\" type=\"Vector2i\" />\n-\t\t\t<param index=\"1\" name=\"allow_out_of_bounds\" type=\"bool\" default=\"true\" />\n+\t\t\t<param index=\"1\" name=\"clamp_line\" type=\"bool\" default=\"true\" />\n+\t\t\t<param index=\"2\" name=\"clamp_column\" type=\"bool\" default=\"true\" />\n \t\t\t<description>\n-\t\t\t\tReturns the line and column at the given position. In the returned vector, [code]x[/code] is the column, [code]y[/code] is the line. If [param allow_out_of_bounds] is [code]false[/code] and the position is not over the text, both vector values will be set to [code]-1[/code].\n+\t\t\t\tReturns the line and column at the given position. In the returned vector, [code]x[/code] is the column and [code]y[/code] is the line.\n+\t\t\t\tIf [param clamp_line] is [code]false[/code] and [param position] is below the last line, [code]Vector2i(-1, -1)[/code] is returned.\n+\t\t\t\tIf [param clamp_column] is [code]false[/code] and [param position] is outside the column range of the line, [code]Vector2i(-1, -1)[/code] is returned.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"get_line_count\" qualifiers=\"const\">\ndiff --git a/misc/extension_api_validation/4.3-stable.expected b/misc/extension_api_validation/4.3-stable.expected\nindex 7b5889f464b9..9c96811f875f 100644\n--- a/misc/extension_api_validation/4.3-stable.expected\n+++ b/misc/extension_api_validation/4.3-stable.expected\n@@ -309,3 +309,10 @@ Validate extension JSON: API was removed: classes/EditorSceneFormatImporter/meth\n \n This virtual method, and the internal public `get_import_flags`, were never used by the engine, since it was open sourced.\n So we're removing it despite the compat breakage as there's no way for users to rely on this affecting engine behavior.\n+\n+\n+GH-100913\n+---------\n+Validate extension JSON: Error: Field 'classes/TextEdit/methods/get_line_column_at_pos/arguments': size changed value in new API, from 2 to 3.\n+\n+Added optional argument to disallow positions that are outside the column range of the line. Compatibility method registered.\ndiff --git a/scene/gui/code_edit.cpp b/scene/gui/code_edit.cpp\nindex 7f8b4dca7862..be8b6f075d9c 100644\n--- a/scene/gui/code_edit.cpp\n+++ b/scene/gui/code_edit.cpp\n@@ -421,7 +421,7 @@ void CodeEdit::gui_input(const Ref<InputEvent> &p_gui_input) {\n \t\t\t\t\t\tmpos.x = get_size().x - mpos.x;\n \t\t\t\t\t}\n \n-\t\t\t\t\tPoint2i pos = get_line_column_at_pos(mpos, false);\n+\t\t\t\t\tPoint2i pos = get_line_column_at_pos(mpos, false, false);\n \t\t\t\t\tint line = pos.y;\n \t\t\t\t\tint col = pos.x;\n \n@@ -443,18 +443,18 @@ void CodeEdit::gui_input(const Ref<InputEvent> &p_gui_input) {\n \n \t\tif (symbol_lookup_on_click_enabled) {\n \t\t\tif (mm->is_command_or_control_pressed() && mm->get_button_mask().is_empty()) {\n-\t\t\t\tsymbol_lookup_pos = get_line_column_at_pos(mpos);\n+\t\t\t\tsymbol_lookup_pos = get_line_column_at_pos(mpos, false, false);\n \t\t\t\tsymbol_lookup_new_word = get_word_at_pos(mpos);\n \t\t\t\tif (symbol_lookup_new_word != symbol_lookup_word) {\n \t\t\t\t\temit_signal(SNAME(\"symbol_validate\"), symbol_lookup_new_word);\n \t\t\t\t}\n-\t\t\t} else if (!mm->is_command_or_control_pressed() || (!mm->get_button_mask().is_empty() && symbol_lookup_pos != get_line_column_at_pos(mpos))) {\n+\t\t\t} else if (!mm->is_command_or_control_pressed() || (!mm->get_button_mask().is_empty() && symbol_lookup_pos != get_line_column_at_pos(mpos, false, false))) {\n \t\t\t\tset_symbol_lookup_word_as_valid(false);\n \t\t\t}\n \t\t}\n \n \t\tif (symbol_tooltip_on_hover_enabled) {\n-\t\t\tsymbol_tooltip_pos = get_line_column_at_pos(mpos, false);\n+\t\t\tsymbol_tooltip_pos = get_line_column_at_pos(mpos, false, false);\n \t\t\tsymbol_tooltip_word = get_word_at_pos(mpos);\n \t\t\tsymbol_tooltip_timer->start();\n \t\t}\n@@ -2388,7 +2388,7 @@ bool CodeEdit::is_symbol_lookup_on_click_enabled() const {\n \n String CodeEdit::get_text_for_symbol_lookup() const {\n \tPoint2i mp = get_local_mouse_pos();\n-\tPoint2i pos = get_line_column_at_pos(mp, false);\n+\tPoint2i pos = get_line_column_at_pos(mp, false, false);\n \tint line = pos.y;\n \tint col = pos.x;\n \ndiff --git a/scene/gui/text_edit.compat.inc b/scene/gui/text_edit.compat.inc\nindex bf73229868ef..d15740390e9d 100644\n--- a/scene/gui/text_edit.compat.inc\n+++ b/scene/gui/text_edit.compat.inc\n@@ -34,8 +34,13 @@ void TextEdit::_set_selection_mode_compat_86978(SelectionMode p_mode, int p_line\n \tset_selection_mode(p_mode);\n }\n \n+Point2i TextEdit::_get_line_column_at_pos_bind_compat_100913(const Point2i &p_pos, bool p_allow_out_of_bounds) const {\n+\treturn get_line_column_at_pos(p_pos, p_allow_out_of_bounds, true);\n+}\n+\n void TextEdit::_bind_compatibility_methods() {\n \tClassDB::bind_compatibility_method(D_METHOD(\"set_selection_mode\", \"mode\", \"line\", \"column\", \"caret_index\"), &TextEdit::_set_selection_mode_compat_86978, DEFVAL(-1), DEFVAL(-1), DEFVAL(0));\n+\tClassDB::bind_compatibility_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"allow_out_of_bounds\"), &TextEdit::_get_line_column_at_pos_bind_compat_100913, DEFVAL(true));\n }\n \n #endif\ndiff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex addbff1e979a..b707a5a93342 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -4397,9 +4397,12 @@ Point2 TextEdit::get_local_mouse_pos() const {\n }\n \n String TextEdit::get_word_at_pos(const Vector2 &p_pos) const {\n-\tPoint2i pos = get_line_column_at_pos(p_pos);\n+\tPoint2i pos = get_line_column_at_pos(p_pos, false, false);\n \tint row = pos.y;\n \tint col = pos.x;\n+\tif (row < 0 || col < 0) {\n+\t\treturn \"\";\n+\t}\n \n \tString s = text[row];\n \tif (s.length() == 0) {\n@@ -4435,7 +4438,7 @@ String TextEdit::get_word_at_pos(const Vector2 &p_pos) const {\n \treturn String();\n }\n \n-Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_of_bounds) const {\n+Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_clamp_line, bool p_clamp_column) const {\n \tfloat rows = p_pos.y - theme_cache.style_normal->get_margin(SIDE_TOP);\n \tif (!editable) {\n \t\trows -= theme_cache.style_readonly->get_offset().y / 2;\n@@ -4462,10 +4465,10 @@ Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_\n \n \tint visible_lines = get_visible_line_count_in_range(first_vis_line, row);\n \tif (rows > visible_lines) {\n-\t\tif (!p_allow_out_of_bounds) {\n-\t\t\treturn Point2i(-1, -1);\n+\t\tif (p_clamp_line) {\n+\t\t\treturn Point2i(text[row].length(), row);\n \t\t}\n-\t\treturn Point2i(text[row].length(), row);\n+\t\treturn Point2i(-1, -1);\n \t}\n \n \tint colx = p_pos.x - (theme_cache.style_normal->get_margin(SIDE_LEFT) + gutters_width + gutter_padding);\n@@ -4482,6 +4485,11 @@ Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_\n \t} else {\n \t\tcolx -= wrap_indent;\n \t}\n+\n+\tif (!p_clamp_column && (colx < 0 || colx > TS->shaped_text_get_size(text_rid).x)) {\n+\t\treturn Point2i(-1, -1);\n+\t}\n+\n \tint col = TS->shaped_text_hit_test_position(text_rid, colx);\n \tif (!caret_mid_grapheme_enabled) {\n \t\tcol = TS->shaped_text_closest_character_pos(text_rid, col);\n@@ -6740,7 +6748,7 @@ void TextEdit::_bind_methods() {\n \n \tClassDB::bind_method(D_METHOD(\"get_word_at_pos\", \"position\"), &TextEdit::get_word_at_pos);\n \n-\tClassDB::bind_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"allow_out_of_bounds\"), &TextEdit::get_line_column_at_pos, DEFVAL(true));\n+\tClassDB::bind_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"clamp_line\", \"clamp_column\"), &TextEdit::get_line_column_at_pos, DEFVAL(true), DEFVAL(true));\n \tClassDB::bind_method(D_METHOD(\"get_pos_at_line_column\", \"line\", \"column\"), &TextEdit::get_pos_at_line_column);\n \tClassDB::bind_method(D_METHOD(\"get_rect_at_line_column\", \"line\", \"column\"), &TextEdit::get_rect_at_line_column);\n \ndiff --git a/scene/gui/text_edit.h b/scene/gui/text_edit.h\nindex ef5110963023..8609b86eccf0 100644\n--- a/scene/gui/text_edit.h\n+++ b/scene/gui/text_edit.h\n@@ -658,6 +658,7 @@ class TextEdit : public Control {\n \n #ifndef DISABLE_DEPRECATED\n \tvoid _set_selection_mode_compat_86978(SelectionMode p_mode, int p_line = -1, int p_column = -1, int p_caret = 0);\n+\tPoint2i _get_line_column_at_pos_bind_compat_100913(const Point2i &p_pos, bool p_allow_out_of_bounds = true) const;\n \tstatic void _bind_compatibility_methods();\n #endif // DISABLE_DEPRECATED\n \n@@ -860,7 +861,7 @@ class TextEdit : public Control {\n \n \tString get_word_at_pos(const Vector2 &p_pos) const;\n \n-\tPoint2i get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_of_bounds = true) const;\n+\tPoint2i get_line_column_at_pos(const Point2i &p_pos, bool p_clamp_line = true, bool p_clamp_column = true) const;\n \tPoint2i get_pos_at_line_column(int p_line, int p_column) const;\n \tRect2i get_rect_at_line_column(int p_line, int p_column) const;\n \n", "test_patch": "", "problem_statement": "Documentation tooltip trigger area includes end-of-line and whitespace surrounding a symbol\n### Tested versions\n\nv4.4.dev7.official [46c8f8c5c]\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - Intel(R) Iris(R) Xe Graphics (Intel Corporation; 32.0.101.5768) - 11th Gen Intel(R) Core(TM) i7-1185G7 @ 3.00GHz (8 threads)\n\n### Issue description\n\nThe symbol info / documentation tooltips (#91060) are triggered by hovering in the empty space at the end of a line or the whitespace surrounding a symbol.\n\nhttps://github.com/user-attachments/assets/d15df433-edad-4044-8bb5-b02c89c869ec\n\n\n### Steps to reproduce\n\nStop the mouse cursor in the space surrounding a hoverable symbol.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2024-12-29 19:50:20", "merge_commit_sha": "e87f4f67b0c1cde93b3a282a8e5815f51a7a9865", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100860", "base_commit": "99a8ab795d65e816ea7c452aa0fb55d02385c048", "patch": "diff --git a/scene/gui/spin_box.cpp b/scene/gui/spin_box.cpp\nindex ffe6e2bb9785..e76170623955 100644\n--- a/scene/gui/spin_box.cpp\n+++ b/scene/gui/spin_box.cpp\n@@ -40,7 +40,7 @@ Size2 SpinBox::get_minimum_size() const {\n \treturn ms;\n }\n \n-void SpinBox::_update_text(bool p_keep_line_edit) {\n+void SpinBox::_update_text(bool p_only_update_if_value_changed) {\n \tdouble step = get_step();\n \tif (use_custom_arrow_step && custom_arrow_step != 0.0) {\n \t\tstep = custom_arrow_step;\n@@ -50,6 +50,11 @@ void SpinBox::_update_text(bool p_keep_line_edit) {\n \t\tvalue = TS->format_number(value);\n \t}\n \n+\tif (p_only_update_if_value_changed && value == last_text_value) {\n+\t\treturn;\n+\t}\n+\tlast_text_value = value;\n+\n \tif (!line_edit->is_editing()) {\n \t\tif (!prefix.is_empty()) {\n \t\t\tvalue = prefix + \" \" + value;\n@@ -58,17 +63,12 @@ void SpinBox::_update_text(bool p_keep_line_edit) {\n \t\t\tvalue += \" \" + suffix;\n \t\t}\n \t}\n-\n-\tif (p_keep_line_edit && value == last_updated_text && value != line_edit->get_text()) {\n-\t\treturn;\n-\t}\n-\n \tline_edit->set_text_with_selection(value);\n-\tlast_updated_text = value;\n }\n \n void SpinBox::_text_submitted(const String &p_string) {\n \tif (p_string.is_empty()) {\n+\t\t_update_text();\n \t\treturn;\n \t}\n \n@@ -288,14 +288,12 @@ void SpinBox::_line_edit_editing_toggled(bool p_toggled_on) {\n \t\t\tline_edit->select_all();\n \t\t}\n \t} else {\n-\t\t// Discontinue because the focus_exit was caused by canceling or the text is empty.\n \t\tif (Input::get_singleton()->is_action_pressed(\"ui_cancel\") || line_edit->get_text().is_empty()) {\n-\t\t\t_update_text();\n-\t\t\treturn;\n+\t\t\t_update_text(); // Revert text if editing was canceled.\n+\t\t} else {\n+\t\t\t_update_text(true); // Update text in case value was changed this frame (e.g. on `focus_exited`).\n+\t\t\t_text_submitted(line_edit->get_text());\n \t\t}\n-\n-\t\tline_edit->deselect();\n-\t\t_text_submitted(line_edit->get_text());\n \t}\n }\n \ndiff --git a/scene/gui/spin_box.h b/scene/gui/spin_box.h\nindex 564294649c94..79076d3f4692 100644\n--- a/scene/gui/spin_box.h\n+++ b/scene/gui/spin_box.h\n@@ -58,13 +58,13 @@ class SpinBox : public Range {\n \tvoid _range_click_timeout();\n \tvoid _release_mouse_from_drag_mode();\n \n-\tvoid _update_text(bool p_keep_line_edit = false);\n+\tvoid _update_text(bool p_only_update_if_value_changed = false);\n \tvoid _text_submitted(const String &p_string);\n \tvoid _text_changed(const String &p_string);\n \n \tString prefix;\n \tString suffix;\n-\tString last_updated_text;\n+\tString last_text_value;\n \tdouble custom_arrow_step = 0.0;\n \tbool use_custom_arrow_step = false;\n \n", "test_patch": "", "problem_statement": "Setting SpinBox value with signal gets overwritten by the LineEdit's text value when the LineEdit is about to lose focus.\n### Tested versions\n\n- Reproducible in v4.4.dev7.official [46c8f8c5c]\n- Reproducible in v4.3.stable.official [77dcf97d8]\n- Reproducible in v4.2.2.stable.official [15073afe3]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.19045 - GLES3 (Compatibility) - NVIDIA GeForce GTX 750 Ti (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i5-6400 CPU @ 2.70GHz (4 Threads)\n\n### Issue description\n\nWhen setting a SpinBox value with a signal **when the SpinBox's LineEdit still has focus** and is about to lose focus the value is first set correctly but then is set again to the LineEdit's displayed value. If the value is set with `set_value_no_signal` to prevent emmiting a signal, the SpinBox will emit the `value_changed` signal with the incorrect value.\n\nhttps://github.com/user-attachments/assets/32618d3e-910a-418e-b913-0fc2db197b9d\n\n\n### Steps to reproduce\n\nUsing the MRP:\n\n1. Click on the SpinBox's LineEdit.\n2. Click on the LineEdit next to it (Or any other node. This is just so that the SpinBox loses focus)\n3. The value will be set correctly (and a signal emmited depending on what method to set the value was used)\n4. The value will then be set to whatever the SpinBox's LineEdit is displaying instead of the set value and a signal will be emmited.\n\nThe MRP has prints to inform of the values the moment before and after they are set.\n\nI've seen that the issue only occours if the value is set right before the SpinBox loses focus.\n\nThe issue is prevented if you ALSO set the SpinBox's value to its TextBox:\n`spin_box.get_line_edit().text = str(spin_box.value)`\n\n### Minimal reproduction project (MRP)\n\n[debugging.zip](https://github.com/user-attachments/files/18256719/debugging.zip)\n\n", "hints_text": "", "created_at": "2024-12-27 21:19:46", "merge_commit_sha": "2850b7113c7de26c79a3d86acf7595713a6d71e5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100792", "base_commit": "0f95e9f8e665cedaa5aace5f6f86de2b4b5a8c60", "patch": "diff --git a/doc/classes/EditorScenePostImportPlugin.xml b/doc/classes/EditorScenePostImportPlugin.xml\nindex 0004ec65c646..ddcbb757ad32 100644\n--- a/doc/classes/EditorScenePostImportPlugin.xml\n+++ b/doc/classes/EditorScenePostImportPlugin.xml\n@@ -71,6 +71,7 @@\n \t\t\t<param index=\"0\" name=\"scene\" type=\"Node\" />\n \t\t\t<description>\n \t\t\t\tPre Process the scene. This function is called right after the scene format loader loaded the scene and no changes have been made.\n+\t\t\t\tPre process may be used to adjust internal import options in the [code]\"nodes\"[/code], [code]\"meshes\"[/code], [code]\"animations\"[/code] or [code]\"materials\"[/code] keys inside [code]get_option_value(\"_subresources\")[/code].\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"add_import_option\">\ndiff --git a/editor/import/3d/resource_importer_scene.cpp b/editor/import/3d/resource_importer_scene.cpp\nindex 695c12150df3..fe9e58014197 100644\n--- a/editor/import/3d/resource_importer_scene.cpp\n+++ b/editor/import/3d/resource_importer_scene.cpp\n@@ -2934,38 +2934,22 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \n \tDictionary subresources = p_options[\"_subresources\"];\n \n-\tDictionary node_data;\n-\tif (subresources.has(\"nodes\")) {\n-\t\tnode_data = subresources[\"nodes\"];\n-\t}\n-\n-\tDictionary material_data;\n-\tif (subresources.has(\"materials\")) {\n-\t\tmaterial_data = subresources[\"materials\"];\n-\t}\n-\n-\tDictionary animation_data;\n-\tif (subresources.has(\"animations\")) {\n-\t\tanimation_data = subresources[\"animations\"];\n-\t}\n-\n-\tDictionary mesh_data;\n-\tif (subresources.has(\"meshes\")) {\n-\t\tmesh_data = subresources[\"meshes\"];\n-\t}\n-\n \tError err = OK;\n \n \t// Check whether any of the meshes or animations have nonexistent save paths\n \t// and if they do, fail the import immediately.\n-\terr = _check_resource_save_paths(mesh_data);\n-\tif (err != OK) {\n-\t\treturn err;\n+\tif (subresources.has(\"meshes\")) {\n+\t\terr = _check_resource_save_paths(subresources[\"meshes\"]);\n+\t\tif (err != OK) {\n+\t\t\treturn err;\n+\t\t}\n \t}\n \n-\terr = _check_resource_save_paths(animation_data);\n-\tif (err != OK) {\n-\t\treturn err;\n+\tif (subresources.has(\"animations\")) {\n+\t\terr = _check_resource_save_paths(subresources[\"animations\"]);\n+\t\tif (err != OK) {\n+\t\t\treturn err;\n+\t\t}\n \t}\n \n \tList<String> missing_deps; // for now, not much will be done with this\n@@ -3005,6 +2989,27 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \t\tpost_importer_plugins.write[i]->pre_process(scene, p_options);\n \t}\n \n+\t// data in _subresources may be modified by pre_process(), so wait until now to check.\n+\tDictionary node_data;\n+\tif (subresources.has(\"nodes\")) {\n+\t\tnode_data = subresources[\"nodes\"];\n+\t}\n+\n+\tDictionary material_data;\n+\tif (subresources.has(\"materials\")) {\n+\t\tmaterial_data = subresources[\"materials\"];\n+\t}\n+\n+\tDictionary animation_data;\n+\tif (subresources.has(\"animations\")) {\n+\t\tanimation_data = subresources[\"animations\"];\n+\t}\n+\n+\tDictionary mesh_data;\n+\tif (subresources.has(\"meshes\")) {\n+\t\tmesh_data = subresources[\"meshes\"];\n+\t}\n+\n \tfloat fps = 30;\n \tif (p_options.has(SNAME(\"animation/fps\"))) {\n \t\tfps = (float)p_options[SNAME(\"animation/fps\")];\n", "test_patch": "", "problem_statement": "Unable to assign Skeleton with Import Script\n### Tested versions\r\n\r\n- Reproducible in all 4.x versions.\r\n\r\n### System information\r\n\r\nGodot v4.3.rc3.mono - Linux Mint 22 (Wilma) - X11 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4060 Ti (nvidia; 535.183.01) - AMD Ryzen 7 5700X 8-Core Processor (16 Threads)\r\n\r\n### Issue description\r\n\r\nThe ConfigFile class set_value method erases key/value pair when value is set to null (this is per class docs for ConfigFile.set_value). However, some files such as .glb.import files have required keys stored with explicit values for some options.\r\n\r\nThere is already the method erase_section() and erase_section_key(), and we need the ability to write null values to key/value pairs.\r\n\r\nExample for when we need to be able to write an explicit null:\r\n```\r\n[params]\r\n\r\n{_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"rest_pose/external_animation_library\": null,\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nIf this value is not set, then the entire PATH:Armature/Skeleton3D node is over written by the engine on the next import.\r\nThus an entry to set skeleton  ex. {\"nodes\" : {\"PATH:Armature/Skeleton3D\": {\"retarget/bone_map\": Resource(\"res://bone_map.tres\")}}} will also be erased and unset.\r\n\r\nTo justification that a change is needed:\r\n\r\nIf one copies and pastes a correct but partial entry, the editor will erase the incomplete entry upon next import...example:\r\n```\r\n_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nbecomes:\r\n`_subresources={}`\r\n\r\n\r\n\r\n\r\nIf one copies and pastes the complete correct node entry with the required null value, the editor is fine.  example:\r\n```\r\n_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"rest_pose/external_animation_library\": null,\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nTherefore one must conclude that the Class used to read and write configuration files such as .import files, should be able to write key/value pairs that include explicit null values.\r\n\r\nThere is already the method erase_section() and erase_section_key(), and we need the ability to write null values to key/value pairs.\r\n\r\n### Steps to reproduce\r\n\r\n\r\n```\r\n@tool # Needed so it runs in editor.\r\nextends EditorScenePostImport\r\n\r\nvar config = ConfigFile.new()\r\n\r\nfunc _post_import(scene):\r\n\tset_skeleton()\r\n\r\nfunc set_skeleton() -> void:\r\n\tvar bone_map : BoneMap = load(\"res://explosive_bone_map.tres\")\r\n\tconfig.load(\"res://relax.glb.import\")\r\n\tvar rest_pose_node : Dictionary\r\n\trest_pose_node = {\"nodes\" : {\"PATH:Armature/Skeleton3D\": {\"rest_post/external_animation_library\": null}}}\r\n\tconfig.set_value(\"params\", \"_subresources\", rest_pose_node)\r\n\tconfig.save(\"res://relax.glb.import\")\r\n\r\n```\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[Animation Test.zip](https://github.com/user-attachments/files/16593811/Animation.Test.zip)\r\n\r\nEDIT: I said FBX by mistake up above, I corrected that to GLB....I am not sure if that's important or not...I would expect the import file behavior to be the same for either.\n", "hints_text": "The FBX code should be changed instead to accept a missing `rest_pose/external_animation_library`.\r\n\r\nChanging the way ConfigFile behaves would break compat.\n@lyuma Could look into this.\nSo there are two things going on here:\r\n\r\nOne is that there's a stray null in the .import file. I have a PR which should fix this, but the null doesn't do anything and so this is a purely cosmetic fix: I don't think this issue is a release blocker.\r\n\r\nThe second problem relates to the discussion from #95413, where I advised use of ConfigFile (typoed as ConfigMap) for modifying the .import file. The issue is that the config file likely will be overwritten after the import finishes, and hence it is not possible to modify the .import from within a PostImport script (or PostImportPlugin) in the way the MRP is doing.\r\n\r\nUnfortunately I'm not aware of a clean way to do what that MRP is trying to do. In my code, I run a script which modifies the .import files specifically when an import is not currently happening, then trigger a reimport after. There's definitely a big API gap here.\r\n\r\nI don't have a suggestion on how to fix the MRP to work correctly, but the closest thing I can think to suggest is run the code outside the import (perhaps in a call_deferred) and then run reimport_files on EditorFileSystem. Make sure to avoid an infinite loop, since the reimport_files will run the script again.\nThank you Lyuma.\r\n\r\nyeah, ok....doing it outside of the import process kind of defeats the point. I was trying to automate all necessary configurations and modifications to an animation library during the import process because this stuff gets written to the res file in the .godot/import folder, the setting the bones up was the last piece of this particular puzzle to fully automate it.\r\n\r\nEDIT: Another thought, I wonder if I could run a tool script that will set the import script up prior to import? Then I could just trigger an import and the skeleton could already be in place before that happens.\r\n\r\nEDIT2: OK, that checks out ... I replicated that workflow manually by cutting the import script configuration item and the _subresources configuration with an external text editor, saving the file, then letting godot reimport and resetting those 2 settings back to default. Then, I pasted those lines back in to the file from the external text editor, saved the file, and triggered another import....Godot set the skeleton and ran the import script with intended results.\r\n\r\nVery kludgy, but it works for now, so thanks\r\n\n> doing it outside of the import process kind of defeats the point\r\n\r\nYeah I agree the usecase of changing settings during import makes sense. I'll try and see if there's a way we can improve the APIs in 4.4 to account for this. Though either way, `EditorScenePostImport` is too late because it literally is the last thing that runs.... so the way your script was written still would have to be changed.\r\n\r\nIn my opinion, `EditorScenePostImportPlugin`, and other such plugins that happen earlier in the import flow, would ideally have a way to adjust import options on the fly without doing a reimport. This is something I hope to make possible in 4.4\n> > doing it outside of the import process kind of defeats the point\r\n> \r\n> Yeah I agree the usecase of changing settings during import makes sense. I'll try and see if there's a way we can improve the APIs in 4.4 to account for this. Though either way, `EditorScenePostImport` is too late because it literally is the last thing that runs.... so the way your script was written still would have to be changed.\r\n> \r\n> In my opinion, `EditorScenePostImportPlugin`, and other such plugins that happen earlier in the import flow, would ideally have a way to adjust import options on the fly without doing a reimport. This is something I hope to make possible in 4.4\r\n\r\nHi Lyuma,\r\nHave you had a chance to look into this? I don't see anything in the PRs that addresses it, but maybe I am just missing it. I am still hoping to fully automate this process so I am not doing it by hand 1600+ times.\r\n\r\nThanks,\r\nScot\r\n\n> > This is something I hope to make possible in 4.4\n> \nBeen fighting with stress and I haven't gotten anywhere near progressing on my ambitious priorities that I put down for 4.4 (I work on Godot as a volunteer).\n\nIf you want to increase the chance that I make this before the 4.4 feature freeze, could you propose some ideas for your dream API to change .import options during import? Like an extra function in post import plugin? Having some direction would help me focus.\n> > This is something I hope to make possible in 4.4\r\n> Been fighting with stress and I haven't gotten anywhere near progressing on my ambitious priorities that I put down for 4.4 (I work on Godot as a volunteer). If you want to increase the chance that I make this before the 4.4 feature freeze, could you propose some ideas for your dream API to change .import options during import? Like an extra function in post import plugin? Having some direction would help me focus.\r\n\r\nLyuma, sorry you are dealing with stress. That really sucks, thank you for what you are able to accomplish. Being the lead dev (whether in name or action) on a section of the engine I am sure has a cost to you.\r\n\r\nReally the most important thing to me is the ability to assign a skeleton from script. The way it is now, I have to manually import the asset (model or animation), assign the skeleton through the UI, reimport, and THEN assign the import script and reimport again.\r\n\r\nBest case be ability to import through script only\r\n\r\nBUT \r\n\r\nIt would already be much better if I could simply assign the skeleton within the script so I don't have so many manual operations per asset (i.e. import, assign script, reimport  (3 ops) vs.  import, open, assign skeleton, reimport, assign script, reimport (6 ops). That alone would cut the work of importing thousands of assets in half.\r\n\r\nThank you for all the hard work you do. \nFrom reading the Godot code, I did find out that you can actually call `get_option_value()` from the `_pre_process` method of EditorScenePostImportPlugin with the argument `_subresources`, and that will return a Dictionary which allows you to modify settings such as the BoneMap of the Armature/Skeleton3D node, without actually needing to modify .import before import. If it were better documented, I think this is pretty reasonable solution.\n\nYou do need to be careful of course when modifying such settings, and having the user go through this instead of having a convenient API will reduce the chance that someone does this unintentionally and makes a mistake, so I would be curious if this gets you unstuck.\n\nThat said, I came here to see if I could improve Godot's APIs.\n\nSo the two things I'm trying to decide between are:\n\n1. To make the options dict mutable (the EditorFileSystem code actually writes the .import file afterwards, so there's no technical reason that it needs to be passed as `const` to the importers.\n\nI do worry there is more of a stylistic reason not to do this: it feels a bit late to modify import options, while the file is already in the process of being imported, particularly the global options since many of them take effect before even the `pre_process` method of `EditorScenePostImportPlugin`. So making it too easy for users to accidentally edit the import options (if the options dictionary is mutable), could lead to inadvertent corruption of the .import settings. It also means we could get into conflicts between plugins since the order things get modified might matter. It just doesn't feel good to rush this into 4.4\n\n2. Add a callback in EditorFileSystem before import, but after assigning the default project settings, so the import settings can be changed. The problem is, I don't think this helps your situation. I think the `_pre_process` is the perfect place to do this, since then you have access to the Node tree and you know which node is the skeleton and so on.\n\nBut if you want to set a setting like `nodes/import_as_skeleton_bones` (which is often useful when importing animation files, for example), that cannot be done from a post-import plugin, since that option is consumed by the GLTF import code. For this type of option, the ability to adjust import settings from EditorFileSystem might be helpful. The main problem I have here is it might imply building a whole plugin system, for a relatively niche usecase: the desired settings are not the default, but you only know the filename and nothing else, how would it know what settings to write to the .import file before the import begins, without knowing more context about the file.\n\nAnyway, maybe I'm just making an excuse to not work on this API for 4.4. But I am really curious if the EditorScenePostImportPlugin idea I had with _subresources works for you, since that would solve most of the problems:\n\n```gd\nextends EditorScenePostImportPlugin\n\nfunc _pre_process(scene: Node):\n\tsubresources = get_option_value(\"_subresources\")\n\tif not subresources.has(\"nodes\"):\n\t\tsubresources[\"nodes\"] = {}\n\n\tvar bone_map : BoneMap = load(\"res://explosive_bone_map.tres\")\n\n\t# Possibly do some recursive search on scene to determine the actual Skeleton3D node. Sometimes it is not inside Armature.\n\tnode_path = \"Armature/Skeleton3D\"\n\tif not subresources[\"nodes\"].has(\"PATH:\" + node_path):\n\t\tsubresources[\"nodes\"][\"PATH:\" + node_path] = {}\n\t\t# Set it in the if statement to allow the user to override after the first import.\n\t\tsubresources[\"nodes\"][\"PATH:\" + node_path][\"retarget/bone_map\"] = bone_map\n```\n\nOoh I think I see the problem... resource_importer_scene.cpp pre-caches the nodes dictionary and fails if it was not assigned to begin with...\n```cpp\n\tDictionary subresources = p_options[\"_subresources\"];\n\n\tDictionary node_data;\n\tif (subresources.has(\"nodes\")) {\n\t\tnode_data = subresources[\"nodes\"];\n\t}\n\n\tDictionary material_data;\n\tif (subresources.has(\"materials\")) {\n\t\tmaterial_data = subresources[\"materials\"];\n\t}\n\n\tDictionary animation_data;\n\tif (subresources.has(\"animations\")) {\n\t\tanimation_data = subresources[\"animations\"];\n\t}\n\n\tDictionary mesh_data;\n\tif (subresources.has(\"meshes\")) {\n\t\tmesh_data = subresources[\"meshes\"];\n\t}\n```\nI think we should simply move these if statements after the _pre_process function, and that's something I should be able to change for Godot 4.4", "created_at": "2024-12-24 15:38:27", "merge_commit_sha": "a7d84fa022334da4e198affc0fe3cd79e8becce5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100786", "base_commit": "fdbf6ecc9f06d665f1dc4a5e3867a54d91ae7f0f", "patch": "diff --git a/editor/import/3d/resource_importer_scene.cpp b/editor/import/3d/resource_importer_scene.cpp\nindex 81af2e0543aa..211ee77ca197 100644\n--- a/editor/import/3d/resource_importer_scene.cpp\n+++ b/editor/import/3d/resource_importer_scene.cpp\n@@ -1303,9 +1303,9 @@ Node *ResourceImporterScene::_post_fix_animations(Node *p_node, Node *p_root, co\n \t\t\t\tDictionary anim_settings = p_animation_data[name];\n \n \t\t\t\t{\n-\t\t\t\t\tint slices_count = anim_settings[\"slices/amount\"];\n+\t\t\t\t\tint slice_count = anim_settings[\"slices/amount\"];\n \n-\t\t\t\t\tfor (int i = 0; i < slices_count; i++) {\n+\t\t\t\t\tfor (int i = 0; i < slice_count; i++) {\n \t\t\t\t\t\tString slice_name = anim_settings[\"slice_\" + itos(i + 1) + \"/name\"];\n \t\t\t\t\t\tint from_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/start_frame\"];\n \t\t\t\t\t\tint end_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/end_frame\"];\n@@ -1531,8 +1531,26 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n \t\t\t\t\t\t\tif (matdata.has(\"use_external/enabled\") && bool(matdata[\"use_external/enabled\"]) && matdata.has(\"use_external/path\")) {\n \t\t\t\t\t\t\t\tString path = matdata[\"use_external/path\"];\n \t\t\t\t\t\t\t\tRef<Material> external_mat = ResourceLoader::load(path);\n+\t\t\t\t\t\t\t\tif (external_mat.is_null()) {\n+\t\t\t\t\t\t\t\t\tif (matdata.has(\"use_external/fallback_path\")) {\n+\t\t\t\t\t\t\t\t\t\tString fallback_save_path = matdata[\"use_external/fallback_path\"];\n+\t\t\t\t\t\t\t\t\t\tif (!fallback_save_path.is_empty()) {\n+\t\t\t\t\t\t\t\t\t\t\texternal_mat = ResourceLoader::load(fallback_save_path);\n+\t\t\t\t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n+\t\t\t\t\t\t\t\t\t\t\t\tpath = fallback_save_path;\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n \t\t\t\t\t\t\t\t\tm->set_surface_material(i, external_mat);\n+\t\t\t\t\t\t\t\t\tif (!path.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t\t\t\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(path);\n+\t\t\t\t\t\t\t\t\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\t\t\t\t\t\t\t\t\tmatdata[\"use_external/path\"] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\tmatdata[\"use_external/fallback_path\"] = external_mat->get_path();\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n@@ -1784,13 +1802,14 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n }\n \n Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> anim, bool p_save_to_file, const String &p_save_to_path, bool p_keep_custom_tracks) {\n-\tif (!p_save_to_file || !p_save_to_path.is_resource_file()) {\n+\tString res_path = ResourceUID::ensure_path(p_save_to_path);\n+\tif (!p_save_to_file || !res_path.is_resource_file()) {\n \t\treturn anim;\n \t}\n \n-\tif (FileAccess::exists(p_save_to_path) && p_keep_custom_tracks) {\n+\tif (FileAccess::exists(res_path) && p_keep_custom_tracks) {\n \t\t// Copy custom animation tracks from previously imported files.\n-\t\tRef<Animation> old_anim = ResourceLoader::load(p_save_to_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n+\t\tRef<Animation> old_anim = ResourceLoader::load(res_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n \t\tif (old_anim.is_valid()) {\n \t\t\tfor (int i = 0; i < old_anim->get_track_count(); i++) {\n \t\t\t\tif (!old_anim->track_is_imported(i)) {\n@@ -1801,16 +1820,21 @@ Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> ani\n \t\t}\n \t}\n \n-\tif (ResourceCache::has(p_save_to_path)) {\n-\t\tRef<Animation> old_anim = ResourceCache::get_ref(p_save_to_path);\n+\tif (ResourceCache::has(res_path)) {\n+\t\tRef<Animation> old_anim = ResourceCache::get_ref(res_path);\n \t\tif (old_anim.is_valid()) {\n \t\t\told_anim->copy_from(anim);\n \t\t\tanim = old_anim;\n \t\t}\n \t}\n-\tanim->set_path(p_save_to_path, true); // Set path to save externally.\n-\tError err = ResourceSaver::save(anim, p_save_to_path, ResourceSaver::FLAG_CHANGE_PATH);\n-\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + p_save_to_path);\n+\tanim->set_path(res_path, true); // Set path to save externally.\n+\tError err = ResourceSaver::save(anim, res_path, ResourceSaver::FLAG_CHANGE_PATH);\n+\n+\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + res_path);\n+\tif (p_save_to_path.begins_with(\"uid://\")) {\n+\t\t// slow\n+\t\tResourceSaver::set_uid(res_path, ResourceUID::get_singleton()->text_to_id(p_save_to_path));\n+\t}\n \treturn anim;\n }\n \n@@ -2041,6 +2065,7 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MESH: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/shadow_meshes\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lightmap_uv\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lods\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n@@ -2049,11 +2074,13 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MATERIAL: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"use_external/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/path\", PROPERTY_HINT_FILE, \"*.material,*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t} break;\n \t\tcase INTERNAL_IMPORT_CATEGORY_ANIMATION: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"settings/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/keep_custom_tracks\"), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slices/amount\", PROPERTY_HINT_RANGE, \"0,256,1\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), 0));\n \n@@ -2063,7 +2090,8 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/end_frame\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \".res,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/keep_custom_tracks\"), false));\n \t\t\t}\n \t\t} break;\n@@ -2527,7 +2555,7 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \n \t\t\t\t\tif (bool(mesh_settings.get(\"save_to_file/enabled\", false))) {\n \t\t\t\t\t\tsave_to_file = mesh_settings.get(\"save_to_file/path\", String());\n-\t\t\t\t\t\tif (!save_to_file.is_resource_file()) {\n+\t\t\t\t\t\tif (!ResourceUID::ensure_path(save_to_file).is_resource_file()) {\n \t\t\t\t\t\t\tsave_to_file = \"\";\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n@@ -2581,16 +2609,24 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \t\t\t\tsrc_mesh_node->get_mesh()->optimize_indices();\n \n \t\t\t\tif (!save_to_file.is_empty()) {\n-\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_to_file);\n+\t\t\t\t\tString save_res_path = ResourceUID::ensure_path(save_to_file);\n+\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_res_path);\n \t\t\t\t\tif (existing.is_valid()) {\n \t\t\t\t\t\t//if somehow an existing one is useful, create\n \t\t\t\t\t\texisting->reset_state();\n \t\t\t\t\t}\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh(existing);\n \n-\t\t\t\t\tResourceSaver::save(mesh, save_to_file); //override\n+\t\t\t\t\tError err = ResourceSaver::save(mesh, save_res_path); //override\n+\t\t\t\t\tif (err != OK) {\n+\t\t\t\t\t\tWARN_PRINT(vformat(\"Failed to save mesh %s to '%s'.\", mesh->get_name(), save_res_path));\n+\t\t\t\t\t}\n+\t\t\t\t\tif (err == OK && save_to_file.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t// slow\n+\t\t\t\t\t\tResourceSaver::set_uid(save_res_path, ResourceUID::get_singleton()->text_to_id(save_to_file));\n+\t\t\t\t\t}\n \n-\t\t\t\t\tmesh->set_path(save_to_file, true); //takeover existing, if needed\n+\t\t\t\t\tmesh->set_path(save_res_path, true); //takeover existing, if needed\n \n \t\t\t\t} else {\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh();\n@@ -2868,14 +2904,66 @@ Node *ResourceImporterScene::pre_import(const String &p_source_file, const HashM\n \treturn scene;\n }\n \n-Error ResourceImporterScene::_check_resource_save_paths(const Dictionary &p_data) {\n+static Error convert_path_to_uid(ResourceUID::ID p_source_id, const String &p_hash_str, Dictionary &p_settings, const String &p_path_key, const String &p_fallback_path_key) {\n+\tconst String &raw_save_path = p_settings[p_path_key];\n+\tString save_path = ResourceUID::ensure_path(raw_save_path);\n+\tif (raw_save_path.begins_with(\"uid://\")) {\n+\t\tif (save_path.is_empty() || !DirAccess::exists(save_path.get_base_dir())) {\n+\t\t\tif (p_settings.has(p_fallback_path_key)) {\n+\t\t\t\tString fallback_save_path = p_settings[p_fallback_path_key];\n+\t\t\t\tif (!fallback_save_path.is_empty() && DirAccess::exists(fallback_save_path.get_base_dir())) {\n+\t\t\t\t\tsave_path = fallback_save_path;\n+\t\t\t\t\tResourceUID::get_singleton()->add_id(ResourceUID::get_singleton()->text_to_id(raw_save_path), save_path);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tp_settings[p_fallback_path_key] = save_path;\n+\t\t}\n+\t}\n+\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\tif (!save_path.is_empty() && !raw_save_path.begins_with(\"uid://\")) {\n+\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(save_path);\n+\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t} else {\n+\t\t\tResourceUID::ID save_id = hash64_murmur3_64(p_hash_str.hash64(), p_source_id) & 0x7FFFFFFFFFFFFFFF;\n+\t\t\tif (ResourceUID::get_singleton()->has_id(save_id)) {\n+\t\t\t\tif (save_path != ResourceUID::get_singleton()->get_id_path(save_id)) {\n+\t\t\t\t\t// The user has specified a path which does not match the default UID.\n+\t\t\t\t\tsave_id = ResourceUID::get_singleton()->create_id();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(save_id);\n+\t\t\tResourceUID::get_singleton()->add_id(save_id, save_path);\n+\t\t}\n+\t\tp_settings[p_fallback_path_key] = save_path;\n+\t}\n+\treturn OK;\n+}\n+\n+Error ResourceImporterScene::_check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data) {\n \tArray keys = p_data.keys();\n-\tfor (int i = 0; i < keys.size(); i++) {\n-\t\tconst Dictionary &settings = p_data[keys[i]];\n+\tfor (int di = 0; di < keys.size(); di++) {\n+\t\tDictionary settings = p_data[keys[di]];\n \n \t\tif (bool(settings.get(\"save_to_file/enabled\", false)) && settings.has(\"save_to_file/path\")) {\n-\t\t\tconst String save_path = ResourceUID::ensure_path(settings[\"save_to_file/path\"]);\n-\t\t\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix;\n+\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings, \"save_to_file/path\", \"save_to_file/fallback_path\");\n+\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Resource save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t}\n+\n+\t\tif (settings.has(\"slices/amount\")) {\n+\t\t\tint slice_count = settings[\"slices/amount\"];\n+\t\t\tfor (int si = 0; si < slice_count; si++) {\n+\t\t\t\tif (bool(settings.get(\"slice_\" + itos(si + 1) + \"/save_to_file/enabled\", false)) &&\n+\t\t\t\t\t\tsettings.has(\"slice_\" + itos(si + 1) + \"/save_to_file/path\")) {\n+\t\t\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix + itos(si + 1);\n+\t\t\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings,\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/path\",\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/fallback_path\");\n+\t\t\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Slice save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t\t\t}\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -2940,14 +3028,14 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \t// Check whether any of the meshes or animations have nonexistent save paths\n \t// and if they do, fail the import immediately.\n \tif (subresources.has(\"meshes\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"meshes\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"m\", subresources[\"meshes\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\n \t}\n \n \tif (subresources.has(\"animations\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"animations\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"a\", subresources[\"animations\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\ndiff --git a/editor/import/3d/resource_importer_scene.h b/editor/import/3d/resource_importer_scene.h\nindex af79746a4c34..68c06efbabbc 100644\n--- a/editor/import/3d/resource_importer_scene.h\n+++ b/editor/import/3d/resource_importer_scene.h\n@@ -210,7 +210,7 @@ class ResourceImporterScene : public ResourceImporter {\n \t\tSHAPE_TYPE_AUTOMATIC,\n \t};\n \n-\tstatic Error _check_resource_save_paths(const Dictionary &p_data);\n+\tstatic Error _check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data);\n \tArray _get_skinned_pose_transforms(ImporterMeshInstance3D *p_src_mesh_node);\n \tvoid _replace_owner(Node *p_node, Node *p_scene, Node *p_new_owner);\n \tNode *_generate_meshes(Node *p_node, const Dictionary &p_mesh_data, bool p_generate_lods, bool p_create_shadow_meshes, LightBakeMode p_light_bake_mode, float p_lightmap_texel_size, const Vector<uint8_t> &p_src_lightmap_cache, Vector<Vector<uint8_t>> &r_lightmap_caches);\ndiff --git a/editor/import/3d/scene_import_settings.cpp b/editor/import/3d/scene_import_settings.cpp\nindex 71b010a97026..609835385b1e 100644\n--- a/editor/import/3d/scene_import_settings.cpp\n+++ b/editor/import/3d/scene_import_settings.cpp\n@@ -1585,6 +1585,10 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\tcontinue; //ignore\n \t\t}\n \t\tString path = item->get_text(1);\n+\t\tString uid_path = path;\n+\t\tif (path.begins_with(\"uid://\")) {\n+\t\t\tpath = ResourceUID::uid_to_path(uid_path);\n+\t\t}\n \t\tif (!path.is_resource_file()) {\n \t\t\tcontinue;\n \t\t}\n@@ -1601,9 +1605,11 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\t\tEditorNode::get_singleton()->add_io_error(TTR(\"Can't make material external to file, write error:\") + \"\\n\\t\" + path);\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n+\t\t\t\tuid_path = ResourceUID::path_to_uid(path);\n \n \t\t\t\tmd.settings[\"use_external/enabled\"] = true;\n-\t\t\t\tmd.settings[\"use_external/path\"] = path;\n+\t\t\t\tmd.settings[\"use_external/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"use_external/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_MESH_SAVE_PATHS: {\n@@ -1611,14 +1617,16 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\tMeshData &md = mesh_map[id];\n \n \t\t\t\tmd.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tmd.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tmd.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"save_to_file/fallback_path\"] = path;\n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_ANIMATION_SAVE_PATHS: {\n \t\t\t\tERR_CONTINUE(!animation_map.has(id));\n \t\t\t\tAnimationData &ad = animation_map[id];\n \n \t\t\t\tad.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tad.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tad.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tad.settings[\"save_to_file/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t}\n", "test_patch": "", "problem_statement": "Resources saved to file from an imported scene do not save with consistent UIDs\n### Godot version\r\n\r\nv4.0.beta.custom_build [98e0d5995]\r\n\r\n### System information\r\n\r\nFedora 36\r\n\r\n### Issue description\r\n\r\nIf \"save to file\" is enabled for meshes or animations in an imported scene, the saved resources are given a random UID if the file doesn't already exist.\r\nThis is annoying if you've `.gitignore`d these files, which makes sense to do since they're auto-generated from glTF files. For example, I did so for the vehicle meshes in the [Truck Town](https://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town) demo. If you clone this repo right now, opening any of the vehicle scenes gives multiple invalid UID errors because when the mesh `.res` files are generated they don't get the same UIDs.\r\n\r\nI don't know how UIDs work, but I assume the way to fix this would be to remember what UID the resources are saved to in the glTF's `.import` file? That way it would be generated with the same UID every time.\r\n\r\n### Steps to reproduce\r\n\r\n1. Save a mesh or animation resource from a scene to a file using the advanced import options\r\n2. Reference that resource in a scene and save it\r\n3. Delete the resource and reimport the scene to regenerate it\r\n4. Open the scene referencing the resource, notice the invalid UID error\r\n\r\n### Minimal reproduction project\r\n\r\nhttps://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town\n", "hints_text": "Related https://github.com/godotengine/godot/issues/62258\nI'm having this problem in 4.1.1 and it's causing me to lose work. Once these warnings have appeared, the next time you open your project, references in resources affected will be missing entirely. This has caused models to go missing, which have to be reassigned in the scenes they were used in, and materials go missing from those models.\r\n\r\nThe thing costing me the most time is that for some reason, even though I have external materials (not from the .glb file), those that are referenced in the .glb as \"use external\" are affected by this issue as well. They lose their reference to the shader they were using, causing all the parameters for that material to be removed, so I have to reconfigure everything on top of reassigning the reference.\r\n\r\nThis issue seems to be intermittent or at least somewhat random, I had time where it didn't happen, but now it is happening frequently enough to halt development of 3D assets until this bug is resolved. It happens on some models/materials and not on others, there doesn't seem to be a common factor between instances.\r\n\r\nIs there a reason this issue is not assigned to a milestone? I know there are other people affected by this issue, here and on the Godot forums. And it seems to have been around in some form on older versions too.\n> I'm having this problem in 4.1.1 and it's causing me to lose work. Once these warnings have appeared, the next time you open your project, references in resources affected will be missing entirely. This has caused models to go missing, which have to be reassigned in the scenes they were used in, and materials go missing from those models.\r\n\r\nI noticed something similar, but I couldn't figure out how to reproduce it so I didn't open a separate issue.\r\nWhat was happening in my case was that the meshes were being saved with the same exact UID as the imported scene. So when loading scenes or resources referencing the mesh, it would try to load the scene they came from instead. But you can't assign a PackedScene to a property that expects a Mesh, so it just assigned null without any errors.\r\nTo fix it, I removed the line from the `.import` file that stored the UID, then deleted the mesh files, then reimported.\r\n\r\n\r\n\nThis sounds like a bug that could cause some pretty severe (but possibly rare) problems.\r\nI also noticed that when I tried to use the dependency menu to point towards the right resource instead, setting it just did nothing, but that would make sense if the UID's were the same.\r\n\r\nI did find that deleting the mesh imports and re-importing the `.glb` fixed those temporarily. But it seemed to come back quickly. I didn't try deleting the line from the `.import` file, is that the one for the `.glb`?\r\nUnfortunately, this \"fix\" won't work for my broken materials, as they are not imported from the `.glb`.\r\nI still don't know why those are being broken in the same way, it has to be because of the UID overlap, I'm just not sure what it was overlapping with. I think I remember the shader reference pointing towards the `.glb` or a mesh or something else, but the shader is completely separate to the imported `.glb`.\r\n\r\nNot sure what we are supposed to do with the invalid UID warning, as it seems to be able to fallback to the text path, but not allow us to fix the UID's.\n> This sounds like a bug that could cause some pretty severe (but possibly rare) problems.\r\n\r\n@VentaGhost I can confirm this.\r\nRight now I pretty much cannot properly use git with my project because the .res files will have tons of diffs and it is really bad. If I had any back-end knowledge, I'd immediately go fix it myself, but I do not. :c\n@betalars So this issue is still happening in the latest version? I had hoped some of the UID changes that came with 4.2 would fix this. Is this with an existing project from before 4.2 or with a new project created with 4.2? Because I wonder if it's just an issue with your project files. Still very unfortunate there isn't a way to fix this, this bug has basically killed that project I was working on because it kept resetting my materials. Might try importing everything to a fresh project at some point but I'd rather not waste time if the bug still exists.\r\nBy any chance are you working on Linux? Because I'd expect more people to have experienced this bug especially with large projects unless it's platform specific?\n@VantaGhost there still seems to be an issue, [as demonstrated in this demo project](https://github.com/betalars/godot-uuid-bug) when initialising a new Project in Godot 4.2\r\n\r\nIn the last commit, something about the res file changes.\r\n\r\nSteps to \"reproduce\":\r\n\r\n1. `git clone git@github.com:betalars/godot-uuid-bug.git`\r\n2. open the project in godot\r\n3. `git diff`\r\n\r\nHowever, I think this is actually a new issue, as the UUID included in the scene seems to be consistent.\r\n\r\nHow I forced this error to happen on my side:\r\n1. I initialised the Repo\r\n2. Added a Suzanne res, umported it to the main scene\r\n3. git commit\r\n4. closed godot\r\n5. deleted .godot\r\n6. re-opend godot\r\n7. suddenly: [a diff](https://github.com/betalars/godot-uuid-bug/commit/b50a8f5ad64fc5d5669691efc49451ae1fd9c115)\r\n\r\n@AThousandShips can you try to look into this? I think the [issue I've opened before](https://github.com/godotengine/godot/issues/87614) may be it's own problem.\r\n\r\nI use nixos as an OS\nUnable to do so right now, someone else might be able to look into it\nUpdate: it is a known issue", "created_at": "2024-12-24 12:42:28", "merge_commit_sha": "16816f426b2de8c10ed394b6a8d260ffcb5f3a30", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100766", "base_commit": "0f95e9f8e665cedaa5aace5f6f86de2b4b5a8c60", "patch": "diff --git a/drivers/metal/metal_objects.mm b/drivers/metal/metal_objects.mm\nindex b44c496e4f6f..04900a0e5162 100644\n--- a/drivers/metal/metal_objects.mm\n+++ b/drivers/metal/metal_objects.mm\n@@ -56,6 +56,10 @@\n \n #import <os/signpost.h>\n \n+// We have to undefine these macros because they are defined in NSObjCRuntime.h.\n+#undef MIN\n+#undef MAX\n+\n void MDCommandBuffer::begin() {\n \tDEV_ASSERT(commandBuffer == nil);\n \tcommandBuffer = queue.commandBufferWithUnretainedReferences;\n@@ -764,6 +768,7 @@\n \t\t[render.encoder setVertexBuffers:render.vertex_buffers.ptr()\n \t\t\t\t\t\t\t\t offsets:render.vertex_offsets.ptr()\n \t\t\t\t\t\t\t   withRange:NSMakeRange(first, p_binding_count)];\n+\t\trender.dirty.clear_flag(RenderState::DIRTY_VERTEX);\n \t} else {\n \t\trender.dirty.set_flag(RenderState::DIRTY_VERTEX);\n \t}\n@@ -1082,7 +1087,7 @@\n \n \tUniformSet const &set = p_shader->sets[index];\n \n-\tfor (uint32_t i = 0; i < uniforms.size(); i++) {\n+\tfor (uint32_t i = 0; i < MIN(uniforms.size(), set.uniforms.size()); i++) {\n \t\tRDD::BoundUniform const &uniform = uniforms[i];\n \t\tUniformInfo ui = set.uniforms[i];\n \ndiff --git a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\nindex 7bd2d75c74a3..2ed4efd1572e 100644\n--- a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n@@ -541,13 +541,15 @@ void ParticlesStorage::_particles_allocate_emission_buffer(Particles *particles)\n \n void ParticlesStorage::_particles_ensure_unused_emission_buffer(Particles *particles) {\n \tif (particles->unused_emission_storage_buffer.is_null()) {\n-\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\t// For rendering devices that do not support empty arrays (like C++),\n+\t\t// we need to size the buffer with at least 1 element.\n+\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(ParticleEmissionBuffer));\n \t}\n }\n \n void ParticlesStorage::_particles_ensure_unused_trail_buffer(Particles *particles) {\n \tif (particles->unused_trail_storage_buffer.is_null()) {\n-\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(16 * sizeof(float)); // Size of mat4.\n \t}\n }\n \n", "test_patch": "", "problem_statement": "Metal: Error compiling compute shader on iPhone A12\nWhen compiling the `particles.glsl` shader for an A12 or earlier device, it fails with the following error:\n\n```\nvalidateComputeFunctionArguments:1083: failed assertion `Compute Function(main0): argument src_particles[0] from buffer(4) with offset(0) and length(16) has space for 16 bytes, but argument has a length(128).'\n```\n\n> [!NOTE]\n>\n> Disabling API validation allows the app to run.\n\nThe issue is that when using classic binding (i.e. not argument buffers), the ABI for the shader passes the structures as arguments to the entry point:\n\n```metal\nstruct ParticleEmission\n{\n    float4x4 xform;\n    packed_float3 velocity;\n    uint flags;\n    float4 color;\n    float4 custom;\n};\n\nstruct SourceEmission\n{\n    int particle_count;\n    uint pad0;\n    uint pad1;\n    uint pad2;\n    ParticleEmission data[1];\n};\n\nkernel void main0(device SourceEmission& src_particles [[buffer(5)]], uint3 gl_GlobalInvocationID [[thread_position_in_grid]])\n{\n// ...\n```\n\nNote that the `src_particles` argument is a `struct SourceEmission`. Note again that this struct has an embedded type `struct ParticleEmission[1]`. Metal doesn't support unsized arrays, but SPRIV-Cross works around it by passing an embedded struct of size `1`. Interestingly, Metal is a variant of C++, and even Godot's definition has to use a sized array for the structure definition:\n\nhttps://github.com/godotengine/godot/blob/2450dee1bc1495daa2b7bdf06c7b3ddfbf8007e1/servers/rendering/renderer_rd/storage_rd/particles_storage.h#L157\n\nThe issue is that when Godot binds an empty emission buffer, it does not need to account for this, so it allocates a size 16:\n\nhttps://github.com/godotengine/godot/blob/d9ef826c545e7d623279c312ca837b947a4989b3/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp#L544\n\n_Originally posted by @TCROC in https://github.com/godotengine/godot/issues/99820#issuecomment-2558697999_\n            \n", "hints_text": "", "created_at": "2024-12-23 15:27:45", "merge_commit_sha": "13992bbf7bf0d14f0dcdcb3ace8e1d49d4d5bdd9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100533", "base_commit": "abf47965fca199f73d435c94b1be5be73c3f9964", "patch": "diff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\nindex 21fb76464b27..85cf08d4c921 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n@@ -407,24 +407,28 @@ void JoltContactListener3D::_flush_contacts() {\n \t\tconst JPH::SubShapeIDPair &shape_pair = E.key;\n \t\tManifold &manifold = E.value;\n \n-\t\tconst JPH::BodyID body_ids[2] = { shape_pair.GetBody1ID(), shape_pair.GetBody2ID() };\n-\t\tconst JoltReadableBodies3D jolt_bodies = space->read_bodies(body_ids, 2);\n+\t\tconst JoltReadableBody3D jolt_body1 = space->read_body(shape_pair.GetBody1ID());\n+\t\tconst JoltReadableBody3D jolt_body2 = space->read_body(shape_pair.GetBody2ID());\n \n-\t\tJoltBody3D *body1 = jolt_bodies[0].as_body();\n+\t\tJoltBody3D *body1 = jolt_body1.as_body();\n \t\tERR_FAIL_NULL(body1);\n \n-\t\tJoltBody3D *body2 = jolt_bodies[1].as_body();\n+\t\tJoltBody3D *body2 = jolt_body2.as_body();\n \t\tERR_FAIL_NULL(body2);\n \n \t\tconst int shape_index1 = body1->find_shape_index(shape_pair.GetSubShapeID1());\n \t\tconst int shape_index2 = body2->find_shape_index(shape_pair.GetSubShapeID2());\n \n-\t\tfor (const Contact &contact : manifold.contacts1) {\n-\t\t\tbody1->add_contact(body2, manifold.depth, shape_index1, shape_index2, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\tif (jolt_body1->IsActive()) {\n+\t\t\tfor (const Contact &contact : manifold.contacts1) {\n+\t\t\t\tbody1->add_contact(body2, manifold.depth, shape_index1, shape_index2, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\t\t}\n \t\t}\n \n-\t\tfor (const Contact &contact : manifold.contacts2) {\n-\t\t\tbody2->add_contact(body1, manifold.depth, shape_index2, shape_index1, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\tif (jolt_body2->IsActive()) {\n+\t\t\tfor (const Contact &contact : manifold.contacts2) {\n+\t\t\t\tbody2->add_contact(body1, manifold.depth, shape_index2, shape_index1, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\t\t}\n \t\t}\n \n \t\tmanifold.contacts1.clear();\n", "test_patch": "", "problem_statement": "Jolt Physics: state.get_contact_collider_position() Fails for Sleeping Bodies Despite get_contact_count() > 0\n### Tested versions\n\n- Reproducible in: 4.3.stable\n\n### System information\n\nWindows 10 - Vulkan (Forward+) - NVIDIA RTX 3060\n\n### Issue description\n\n**Jolt was just integrated to Godot, so I believe this should be in Godot issues. If not let me know!**\n\nWhen using Jolt Physics in Godot 4, and trying to get collision contact points between bodies, calling state.get_contact_collider_position(index) for a RigidBody3D results in an \"Index out of bounds\" error if the body gets in sleep mode. This occurs even when get_contact_count() reports a value greater than 0. The error does not occur with default Godot Physics\n\nThe error:\n```\n_physics_process(): Index p_contact_idx = 0 is out of bounds (body->get_contact_count() = 0).\n  <C++ Source>   src\\objects\\jolt_physics_direct_body_state_3d.cpp:217 @ _get_contact_collider_position()\n```\n\nThis behavior affects contact point calculations for bodies that are stationary but still colliding with other objects\n\n### Steps to reproduce\n\n1. Set up a scene with two colliding RigidBody3D objects.\n2. Ensure Jolt Physics is installed and defined as current physics engine\n3. Enable contact_monitor and set max_contacts_reported to a non-zero value (e.g., 5).\n4. Let one of the bodies come to rest, causing it to enter sleep mode.\n5. Execute the code below inside the body that has come to a rest:\n\n```\nextends RigidBody3D\n\nfunc _ready() -> void:\n\tcontact_monitor = true\n\tmax_contacts_reported = 5\n\nfunc _physics_process(_delta: float) -> void:\n\t# Get body rid\n\tvar rid := get_rid()\n\t# Get body physics state\n\tvar state := PhysicsServer3D.body_get_direct_state(rid)\n\t\n\tfor i in get_contact_count():\n\t\tprint(\"Contact count: \", get_contact_count(),\n\t\t\t\"  \", state.get_contact_collider_position(i))\n```\n\n**Expected Behavior:**\nstate.get_contact_collider_position(index) should return valid contact points if get_contact_count() > 0, even when the body is in sleep mode.\n\n**Observed Behavior:**\nAn \"Index out of bounds\" error occurs, and get_contact_collider_position() fails.\n\n### Minimal reproduction project (MRP)\n\nI had to remove macOS, Linux and android libraries from the Jolt folder to make the file small enough to upload. You can always reinstall jolt add-on to make sure.\n\n[BugJoltContact.zip](https://github.com/user-attachments/files/18168435/BugJoltContact.zip)\n\n\n\n", "hints_text": "", "created_at": "2024-12-17 22:30:58", "merge_commit_sha": "6e2cf2aa7b78a25d1b054f2ec0f02cd658482f84", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100510", "base_commit": "4364ed6ccd001cbfe7cb781d074100695c878d90", "patch": "diff --git a/editor/editor_paths.cpp b/editor/editor_paths.cpp\nindex 8e9df68f3b70..cd17559ac3dc 100644\n--- a/editor/editor_paths.cpp\n+++ b/editor/editor_paths.cpp\n@@ -237,6 +237,17 @@ EditorPaths::EditorPaths() {\n \t\t}\n \t}\n \n+\t// Temporary dir.\n+\t{\n+\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\tdir->make_dir_recursive(temp_dir);\n+\t\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\t\tERR_PRINT(\"Could not create editor temporary directory: \" + temp_dir);\n+\t\t\t\tpaths_valid = false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n \t// Validate or create project-specific editor data dir,\n \t// including shader cache subdir.\n \tif (Engine::get_singleton()->is_project_manager_hint() || (Main::is_cmdline_tool() && !ProjectSettings::get_singleton()->is_project_loaded())) {\n", "test_patch": "", "problem_statement": "Can't export project in self-contained mode\n### Tested versions\n\nRegression from #100150\n\n### System information\n\nW10\n\n### Issue description\n\nWhen using portable mode (the `._sc_` thing), exporting project results in:\n```\n  ERROR: Couldn't save project.binary at 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Can't open file from path 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Cannot remove non-existent file or directory: 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: C:\\godot_source\\editor\\export\\editor_export_platform.h:241 - Save ZIP: Failed to move temporary file \"C:/godot_source/bin/editor_data/temp/packtmp\" to \"C:/Program Files/Godot/BugReports/Repro/.export/project.zip\".\n```\nAlthough after further testing, seems like temp folder is missing for some reason and it's not created automatically. I didn't test if it's a problem in non-portable mode (it would happen with a clean Godot installation).\n\n### Steps to reproduce\n\n1. Enable [self-contained mode](https://docs.godotengine.org/en/stable/tutorials/io/data_paths.html#doc-data-paths-self-contained-mode)\n2. Export project\n3. The exported files are not created\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2024-12-17 14:19:52", "merge_commit_sha": "2b7ea6223bd0bdaa75706849c9dee1a82b2e2d01", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100235", "base_commit": "a372214a4a047ccf63d23c4406337b30e55ff60b", "patch": "diff --git a/core/object/object.h b/core/object/object.h\nindex da8e8d1b86ee..11b94a7fbf0a 100644\n--- a/core/object/object.h\n+++ b/core/object/object.h\n@@ -572,7 +572,7 @@ class Object {\n \t\tCONNECT_PERSIST = 2, // hint for scene to save this connection\n \t\tCONNECT_ONE_SHOT = 4,\n \t\tCONNECT_REFERENCE_COUNTED = 8,\n-\t\tCONNECT_INHERITED = 16, // Whether or not the connection is in an instance of a scene.\n+\t\tCONNECT_INHERITED = 16, // Used in editor builds.\n \t};\n \n \tstruct Connection {\ndiff --git a/scene/resources/packed_scene.cpp b/scene/resources/packed_scene.cpp\nindex 8b1cbdf488a5..d6748ed2e64f 100644\n--- a/scene/resources/packed_scene.cpp\n+++ b/scene/resources/packed_scene.cpp\n@@ -1060,12 +1060,6 @@ Error SceneState::_parse_connections(Node *p_owner, Node *p_node, HashMap<String\n \t\t\t\tcontinue;\n \t\t\t}\n \n-\t\t\t// Don't include signals that are from scene instances\n-\t\t\t// (they are already saved in the scenes themselves).\n-\t\t\tif (c.flags & CONNECT_INHERITED) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n \t\t\t// only connections that originate or end into main saved scene are saved\n \t\t\t// everything else is discarded\n \n", "test_patch": "diff --git a/tests/scene/test_packed_scene.h b/tests/scene/test_packed_scene.h\nindex 3698b00c6b86..df23c251c00b 100644\n--- a/tests/scene/test_packed_scene.h\n+++ b/tests/scene/test_packed_scene.h\n@@ -96,6 +96,8 @@ TEST_CASE(\"[PackedScene] Signals Preserved when Packing Scene\") {\n \t\tCHECK_EQ(state->get_connection_count(), 3);\n \t}\n \n+\t/*\n+\t// FIXME: This subcase requires GH-48064 to be fixed.\n \tSUBCASE(\"Signals that should not be saved\") {\n \t\tint subscene_flags = Object::CONNECT_PERSIST | Object::CONNECT_INHERITED;\n \t\t// subscene node to itself\n@@ -115,6 +117,7 @@ TEST_CASE(\"[PackedScene] Signals Preserved when Packing Scene\") {\n \t\tRef<SceneState> state = packed_scene->get_state();\n \t\tCHECK_EQ(state->get_connection_count(), 0);\n \t}\n+\t*/\n \n \tmemdelete(main_scene_root);\n }\n", "problem_statement": "4.4-dev6: Signals don't work in exported builds if .godot dir was created by dev6\n### Tested versions\n\n- Reproducible in: v4.4.dev6.official [1f47e4c4e]\n- Not reproducible in: v4.4.dev5.official [9e6098432]\n\n### System information\n\nGodot v4.4.dev6 - Ubuntu 24.04.1 LTS 24.04 on X11 - X11 display driver, Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1060 6GB (nvidia; 535.183.01) - Intel(R) Core(TM) i5-4570 CPU @ 3.20GHz (4 threads)\n\n### Issue description\n\nIn 4.4-dev6, _signals do not work, at all_ in exported builds. The signal handlers are never called. I have tried both built-in signals (such as clicking a button) and custom signals (calling `.emit()`).\n\nHowever, the circumstances are extremely weird. It is not tied to the Godot version you used to export, but rather, _the Godot version that created the `.godot` directory_.\n\nTo elaborate:\n* If you create a new project in 4.4-dev6, then export it, signals are broken.\n* If you create a project in 4.4-dev5, then upgrade to 4.4-dev6, then export, signals work.\n* However, if you delete the `.godot` directory, then re-open with 4.4-dev6, signals are broken.\n* But, if you then re-open the project (with the `.godot` dir created in dev6) in 4.4-dev5, and export, signals are still broken!\n\nSo this bug can manifest in 4.4-dev5 and earlier, but only if the `.godot` dir was created by dev6.\n\nI'm at a loss to explain this behaviour, but I have tested it extensively (on Linux), both on a \"real\" project and in a minimal repro. I have compared the \"good\" and \"bad\" `.godot` directories and can't see much that would distinguish them - the binary `.scn` files are different but you would expect those to regenerate every time you re-save the scene. And shader cache files are different, but you wouldn't expect that to affect something as unrelated as signals.\n\nAnd to be clear, everything works fine in the editor. It's only broken for exported builds.\n\nI have tested both the Linux native and Web exports, and the issue affects both.\n\n### Steps to reproduce\n\n1. Create a new project using 4.4-dev6.\n2. Create a new \"User Interface\" scene.\n3. Attach a script to the scene.\n4. Add a Button to the scene and give it some text.\n5. In the editor, connect the Button's `pressed()` signal up to a new method.\n6. Add the code `print('Button pressed')` to the signal handler. For good measure, also `$Button.text = 'Pressed'`.\n7. Run the project (setting the scene as the main scene) and verify that clicking the button prints \"Button pressed\" to the console and changes the button text.\n8. Project > Export and add a Linux native export, without changing any settings.\n9. Export Project. Ensure that \"Export With Debug\" is ticked.\n10. From the command line, run `New Game Project.x86_64`.\n11. Observe that clicking the button has no effect, neither printing to the console, nor changing the text.\n\nAs mentioned above, there are some very weird interactions if we change Godot versions:\n- Open the project in dev5 - it is still broken.\n- Delete the `.godot` dir and re-open in dev5 - it now works.\n- Open the project in dev6 - it still works.\n- Delete the `.godot` dir and re-open in dev6 - it is now broken again.\n\n### Minimal reproduction project (MRP)\n\n[signal-repro.zip](https://github.com/user-attachments/files/18038555/signal-repro.zip)\n\n", "hints_text": "Just looking at the dev6 changelog, a possible commit that might have caused this is #97303. (Because perhaps the \"avoid duplicating signals\" avoided something necessary to do with signals, and wrote that into the PackedScene inside the `.godot` directory, which means signals don't fire even if it's loaded in old versions.)\nI tested the issue (on the Web platform, running dev5 and dev6 as explained) and I can confirm it.\nI can confirm too that the regression is caused by #97303. I reverted the PR from master, then created a project with it. And it works when exported.\nCC @cixil \nThe problem seems to be how the `CONNECT_INHERITED` is applied.\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/scene/resources/packed_scene.cpp#L609\nChanging this to use `GEN_EDIT_STATE_MAIN` fixes the bug, but it's probably not the right fix.\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/editor/export/editor_export_platform.cpp#L825\nThe bug happens, because scenes are processed during export if you have `editor/export/convert_text_resources_to_binary` enabled, and due to wrong inheritance state, the connections are lost.\nWell there is another case of this bug (or at least I think it is related). Signal connections don't work in scenes instantiated by plugins, like custom main screens.\n\nEDIT:\nOk confirmed it to be the same problem.\n\nEDIT2:\nIt's actually caused by my specific way of creating some nodes. I pack a scene and then instantiate it multiple times.\n\nEDIT3:\nThese might be related: #48064 #85372 #85606\nDon't know if it matters, but you can get around this bug by connecting signals via code instead of the UI.\nConfirmed on android XR builds. Good to know ^_^\nCan anyone explain exactly what the role is for this flag:\n\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/core/object/object.h#L575\n\nand these enums?:\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/scene/resources/packed_scene.h#L126-L131\n\nre @KoBeWi's comment\nI don't quite understand why the inherited flag would be *added*  during instantiation, isn't this flag just supposed to be a way for the editor to determine which connections are a part of the scene?\nhttps://github.com/godotengine/godot/blob/aa8d9b83f66488dbb2c9c918e9016ef80f821fb4/scene/resources/packed_scene.cpp#L609\n\nEDIT: Ah I see this is added when instantiated scenes are added as children in the editor? I forget the same code is used in the game runtime and in the editor\nThe flag is temporary. All connections that belong to a different scene than the currently opened one will get the flag once the scene is loaded; this applies to instances and inherited scenes.\nI guess a simple fix to #97303 could be to add `#ifdef TOOLS_ENABLED` around the check for the inherited flag (haven't tested). But I'm not sure if this issue points to an incorrect use of `CONNECT_INHERITED` that should be fixed instead.\nThe problem exists in the editor.", "created_at": "2024-12-10 09:15:06", "merge_commit_sha": "c2e4ae782a399adf42c664d3d21d8defe49ba8e5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100116", "base_commit": "a372214a4a047ccf63d23c4406337b30e55ff60b", "patch": "diff --git a/drivers/wasapi/audio_driver_wasapi.cpp b/drivers/wasapi/audio_driver_wasapi.cpp\nindex b5cb8da249af..7d5680699f41 100644\n--- a/drivers/wasapi/audio_driver_wasapi.cpp\n+++ b/drivers/wasapi/audio_driver_wasapi.cpp\n@@ -123,6 +123,8 @@ const IID IID_IAudioCaptureClient = __uuidof(IAudioCaptureClient);\n \n static bool default_output_device_changed = false;\n static bool default_input_device_changed = false;\n+static int output_reinit_countdown = 0;\n+static int input_reinit_countdown = 0;\n \n // Silence warning due to a COM API weirdness (GH-35194).\n #if defined(__GNUC__) && !defined(__clang__)\n@@ -134,6 +136,8 @@ class CMMNotificationClient : public IMMNotificationClient {\n \tLONG _cRef = 1;\n \n public:\n+\tComPtr<IMMDeviceEnumerator> enumerator = nullptr;\n+\n \tCMMNotificationClient() {}\n \tvirtual ~CMMNotificationClient() {}\n \n@@ -199,6 +203,9 @@ class CMMNotificationClient : public IMMNotificationClient {\n static CMMNotificationClient notif_client;\n \n Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_input, bool p_reinit, bool p_no_audio_client_3) {\n+\t// This function can be called recursively, so clean up before starting:\n+\taudio_device_finish(p_device);\n+\n \tWAVEFORMATEX *pwfex;\n \tComPtr<IMMDeviceEnumerator> enumerator = nullptr;\n \tComPtr<IMMDevice> output_device = nullptr;\n@@ -225,21 +232,25 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tComPtr<IMMDevice> tmp_device = nullptr;\n \n \t\t\thr = devices->Item(i, &tmp_device);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot get devices item.\");\n \n \t\t\tComPtr<IPropertyStore> props = nullptr;\n \t\t\thr = tmp_device->OpenPropertyStore(STGM_READ, &props);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot open property store.\");\n \n \t\t\tPROPVARIANT propvar;\n \t\t\tPropVariantInit(&propvar);\n \n \t\t\thr = props->GetValue(PKEY_Device_FriendlyNameGodot, &propvar);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot get value.\");\n \n \t\t\tif (p_device->device_name == String(propvar.pwszVal)) {\n \t\t\t\thr = tmp_device->GetId(&strId);\n-\t\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\t\tif (unlikely(hr != S_OK)) {\n+\t\t\t\t\tPropVariantClear(&propvar);\n+\t\t\t\t\tERR_PRINT(\"Cannot get device ID string.\");\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \n \t\t\t\tfound = true;\n \t\t\t}\n@@ -270,9 +281,14 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n \t}\n \n+\tif (notif_client.enumerator != nullptr) {\n+\t\tnotif_client.enumerator->UnregisterEndpointNotificationCallback(&notif_client);\n+\t\tnotif_client.enumerator = nullptr;\n+\t}\n \thr = enumerator->RegisterEndpointNotificationCallback(&notif_client);\n-\n-\tif (hr != S_OK) {\n+\tif (hr == S_OK) {\n+\t\tnotif_client.enumerator = enumerator;\n+\t} else {\n \t\tERR_PRINT(\"WASAPI: RegisterEndpointNotificationCallback error\");\n \t}\n \n@@ -317,6 +333,7 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \n \thr = p_device->audio_client->GetMixFormat(&pwfex);\n \tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\t// From this point onward, CoTaskMemFree(pwfex) must be called before returning or pwfex will leak!\n \n \tprint_verbose(\"WASAPI: wFormatTag = \" + itos(pwfex->wFormatTag));\n \tprint_verbose(\"WASAPI: nChannels = \" + itos(pwfex->nChannels));\n@@ -340,6 +357,7 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tprint_verbose(\"WASAPI: closest->cbSize = \" + itos(closest->cbSize));\n \n \t\t\tWARN_PRINT(\"WASAPI: Using closest match instead\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tpwfex = closest;\n \t\t}\n \t}\n@@ -359,11 +377,13 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tp_device->format_tag = WAVE_FORMAT_IEEE_FLOAT;\n \t\t} else {\n \t\t\tERR_PRINT(\"WASAPI: Format not supported\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n \t\t}\n \t} else {\n \t\tif (p_device->format_tag != WAVE_FORMAT_PCM && p_device->format_tag != WAVE_FORMAT_IEEE_FLOAT) {\n \t\t\tERR_PRINT(\"WASAPI: Format not supported\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n \t\t}\n \t}\n@@ -376,10 +396,28 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tpwfex->nAvgBytesPerSec = pwfex->nSamplesPerSec * pwfex->nChannels * (pwfex->wBitsPerSample / 8);\n \t\t}\n \t\thr = p_device->audio_client->Initialize(AUDCLNT_SHAREMODE_SHARED, streamflags, p_input ? REFTIMES_PER_SEC : 0, 0, pwfex, nullptr);\n-\t\tERR_FAIL_COND_V_MSG(hr != S_OK, ERR_CANT_OPEN, \"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\n+\t\tif (p_reinit) {\n+\t\t\t// In case we're trying to re-initialize the device, prevent throwing this error on the console,\n+\t\t\t// otherwise if there is currently no device available this will spam the console.\n+\t\t\tif (hr != S_OK) {\n+\t\t\t\tprint_verbose(\"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\t\t\t\tCoTaskMemFree(pwfex);\n+\t\t\t\treturn ERR_CANT_OPEN;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tif (unlikely(hr != S_OK)) {\n+\t\t\t\tCoTaskMemFree(pwfex);\n+\t\t\t\tERR_FAIL_V_MSG(ERR_CANT_OPEN, \"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\t\t\t}\n+\t\t}\n+\n \t\tUINT32 max_frames;\n \t\thr = p_device->audio_client->GetBufferSize(&max_frames);\n-\t\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\t\tif (unlikely(hr != S_OK)) {\n+\t\t\tCoTaskMemFree(pwfex);\n+\t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n+\t\t}\n \n \t\t// Due to WASAPI Shared Mode we have no control of the buffer size\n \t\tif (!p_input) {\n@@ -453,7 +491,10 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t} else {\n \t\thr = p_device->audio_client->GetService(IID_IAudioRenderClient, (void **)&p_device->render_client);\n \t}\n-\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\tif (unlikely(hr != S_OK)) {\n+\t\tCoTaskMemFree(pwfex);\n+\t\tERR_FAIL_V(ERR_CANT_OPEN);\n+\t}\n \n \t// Free memory\n \tCoTaskMemFree(pwfex);\n@@ -464,6 +505,11 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n Error AudioDriverWASAPI::init_output_device(bool p_reinit) {\n \tError err = audio_device_init(&audio_output, false, p_reinit);\n \tif (err != OK) {\n+\t\t// We've tried to init the device, but have failed. Time to clean up.\n+\t\tError finish_err = finish_output_device();\n+\t\tif (finish_err != OK) {\n+\t\t\tERR_PRINT(\"WASAPI: finish_output_device error after failed output audio_device_init\");\n+\t\t}\n \t\treturn err;\n \t}\n \n@@ -504,6 +550,11 @@ Error AudioDriverWASAPI::init_output_device(bool p_reinit) {\n Error AudioDriverWASAPI::init_input_device(bool p_reinit) {\n \tError err = audio_device_init(&audio_input, true, p_reinit);\n \tif (err != OK) {\n+\t\t// We've tried to init the device, but have failed. Time to clean up.\n+\t\tError finish_err = finish_input_device();\n+\t\tif (finish_err != OK) {\n+\t\t\tERR_PRINT(\"WASAPI: finish_input_device error after failed input audio_device_init\");\n+\t\t}\n \t\treturn err;\n \t}\n \n@@ -826,9 +877,15 @@ void AudioDriverWASAPI::thread_func(void *p_udata) {\n \t\t}\n \n \t\tif (!ad->audio_output.audio_client) {\n-\t\t\tError err = ad->init_output_device(true);\n-\t\t\tif (err == OK) {\n-\t\t\t\tad->start();\n+\t\t\tif (output_reinit_countdown < 1) {\n+\t\t\t\tError err = ad->init_output_device(true);\n+\t\t\t\tif (err == OK) {\n+\t\t\t\t\tad->start();\n+\t\t\t\t} else {\n+\t\t\t\t\toutput_reinit_countdown = 1000;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\toutput_reinit_countdown--;\n \t\t\t}\n \n \t\t\tavail_frames = 0;\n@@ -899,9 +956,15 @@ void AudioDriverWASAPI::thread_func(void *p_udata) {\n \t\t\t}\n \n \t\t\tif (!ad->audio_input.audio_client) {\n-\t\t\t\tError err = ad->init_input_device(true);\n-\t\t\t\tif (err == OK) {\n-\t\t\t\t\tad->input_start();\n+\t\t\t\tif (input_reinit_countdown < 1) {\n+\t\t\t\t\tError err = ad->init_input_device(true);\n+\t\t\t\t\tif (err == OK) {\n+\t\t\t\t\t\tad->input_start();\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tinput_reinit_countdown = 1000;\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tinput_reinit_countdown--;\n \t\t\t\t}\n \t\t\t}\n \t\t}\n", "test_patch": "", "problem_statement": "Godot will throw errors infinitely when Windows audio driver was once used by another app\n### Tested versions\n\nGodot 4.3 Stable\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\nWhen another app (like audio or video editing software) uses Windows Audio system, Godot begin to throw errors and will not stop until it will be fully closed and reopened. Even if another app is already closed and is no longer using the driver.\n\n![Image](https://github.com/user-attachments/assets/14b78097-b33d-454a-8e61-bd50e776841b)\n\n\n### Steps to reproduce\n\nOpen Godot\nOpen Vegas Pro or other video editing app at the same time\n\n### Minimal reproduction project (MRP)\n\nN/A (and not required)\n", "hints_text": "Tested on Win 10 with Adobe Audition and Premiere Pro at the same time with a Godot editor + running project (4.4 dev 5) with audio and I could not reproduce the error.\n\n(my audio output device is a USB Sound Blaster Play 3)\n> Tested on Win 10 with Adobe Audition and Premiere Pro at the same time with a Godot editor + running project (4.4 dev 5) with audio and I could not reproduce the error.\n> \n> (my audio output device is a USB Sound Blaster Play 3)\n\nMy audio is Realtek ALC1220 based, and the issue appeared with Vegas Pro 21\nDuplicate of https://github.com/godotengine/godot/issues/18732 (though maybe that issue should emphasize the fact that the error spams).", "created_at": "2024-12-06 19:49:52", "merge_commit_sha": "9d2798d4aacfb5875d7144cce9b727a7c8f246d2", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100069", "base_commit": "aa8d9b83f66488dbb2c9c918e9016ef80f821fb4", "patch": "diff --git a/editor/editor_settings_dialog.cpp b/editor/editor_settings_dialog.cpp\nindex 8989b9cf9b9b..2f7dfe16072e 100644\n--- a/editor/editor_settings_dialog.cpp\n+++ b/editor/editor_settings_dialog.cpp\n@@ -314,6 +314,10 @@ void EditorSettingsDialog::_event_config_confirmed() {\n \n void EditorSettingsDialog::_update_builtin_action(const String &p_name, const Array &p_events) {\n \tArray old_input_array = EditorSettings::get_singleton()->get_builtin_action_overrides(p_name);\n+\tif (old_input_array.is_empty()) {\n+\t\tList<Ref<InputEvent>> defaults = InputMap::get_singleton()->get_builtins_with_feature_overrides_applied()[current_edited_identifier];\n+\t\told_input_array = _event_list_to_array_helper(defaults);\n+\t}\n \n \tEditorUndoRedoManager *undo_redo = EditorUndoRedoManager::get_singleton();\n \tundo_redo->create_action(vformat(TTR(\"Edit Built-in Action: %s\"), p_name));\n@@ -321,11 +325,11 @@ void EditorSettingsDialog::_update_builtin_action(const String &p_name, const Ar\n \tundo_redo->add_undo_method(EditorSettings::get_singleton(), \"mark_setting_changed\", \"builtin_action_overrides\");\n \tundo_redo->add_do_method(EditorSettings::get_singleton(), \"set_builtin_action_override\", p_name, p_events);\n \tundo_redo->add_undo_method(EditorSettings::get_singleton(), \"set_builtin_action_override\", p_name, old_input_array);\n+\tundo_redo->add_do_method(this, \"_update_shortcuts\");\n+\tundo_redo->add_undo_method(this, \"_update_shortcuts\");\n \tundo_redo->add_do_method(this, \"_settings_changed\");\n \tundo_redo->add_undo_method(this, \"_settings_changed\");\n \tundo_redo->commit_action();\n-\n-\t_update_shortcuts();\n }\n \n void EditorSettingsDialog::_update_shortcut_events(const String &p_path, const Array &p_events) {\n", "test_patch": "", "problem_statement": "Editor Settings Shortcuts: Undoing changes to built-in actions creates empty action\n### Tested versions\n\nv4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.22631 - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 980 Ti (NVIDIA; 32.0.15.6603) - 13th Gen Intel(R) Core(TM) i7-13700K (24 Threads)\n\n### Issue description\n\nTwo issues happen when undoing/redoing changes to the built-in actions in the Shortcuts list:\n \n1. Undo/redo have a 1 second delay\n2. Undoing back to the default shortcut results in an empty shortcut rather than the default.\n\nhttps://github.com/user-attachments/assets/b24c9694-a1d1-4979-9b5e-63cc22127cc2\n\n\n\n### Steps to reproduce\n\n- Change one of the built-in editor shortcuts\n- Undo with Ctrl-Z\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2024-12-05 20:16:46", "merge_commit_sha": "4d77bbf4907fdffc43cbf3d46c35bf6f6bd9371e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-32248", "base_commit": "a4fd565191e3184a174757f7a8fbda6afc98e50a", "patch": "diff --git a/src/random.cpp b/src/random.cpp\nindex 5da053f74e4a6..fa3d8ec3f1e07 100644\n--- a/src/random.cpp\n+++ b/src/random.cpp\n@@ -41,9 +41,6 @@\n #ifdef HAVE_SYSCTL_ARND\n #include <sys/sysctl.h>\n #endif\n-#if defined(HAVE_STRONG_GETAUXVAL) && defined(__aarch64__)\n-#include <sys/auxv.h>\n-#endif\n \n namespace {\n \n@@ -189,62 +186,6 @@ uint64_t GetRdSeed() noexcept\n #endif\n }\n \n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-\n-bool g_rndr_supported = false;\n-\n-void InitHardwareRand()\n-{\n-    if (getauxval(AT_HWCAP2) & HWCAP2_RNG) {\n-        g_rndr_supported = true;\n-    }\n-}\n-\n-void ReportHardwareRand()\n-{\n-    // This must be done in a separate function, as InitHardwareRand() may be indirectly called\n-    // from global constructors, before logging is initialized.\n-    if (g_rndr_supported) {\n-        LogPrintf(\"Using RNDR and RNDRRS as additional entropy sources\\n\");\n-    }\n-}\n-\n-/** Read 64 bits of entropy using rndr.\n- *\n- * Must only be called when RNDR is supported.\n- */\n-uint64_t GetRNDR() noexcept\n-{\n-    uint8_t ok = 0;\n-    uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDR--Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_0; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n-        __asm__ volatile(\"yield\");\n-    } while (true);\n-    return r1;\n-}\n-\n-/** Read 64 bits of entropy using rndrrs.\n- *\n- * Must only be called when RNDRRS is supported.\n- */\n-uint64_t GetRNDRRS() noexcept\n-{\n-    uint8_t ok = 0;\n-    uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n-        __asm__ volatile(\"yield\");\n-    } while (true);\n-    return r1;\n-}\n-\n #else\n /* Access to other hardware random number generators could be added here later,\n  * assuming it is sufficiently fast (in the order of a few hundred CPU cycles).\n@@ -263,12 +204,6 @@ void SeedHardwareFast(CSHA512& hasher) noexcept {\n         hasher.Write((const unsigned char*)&out, sizeof(out));\n         return;\n     }\n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n-        uint64_t out = GetRNDR();\n-        hasher.Write((const unsigned char*)&out, sizeof(out));\n-        return;\n-    }\n #endif\n }\n \n@@ -294,14 +229,6 @@ void SeedHardwareSlow(CSHA512& hasher) noexcept {\n         }\n         return;\n     }\n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n-        for (int i = 0; i < 4; ++i) {\n-            uint64_t out = GetRNDRRS();\n-            hasher.Write((const unsigned char*)&out, sizeof(out));\n-        }\n-        return;\n-    }\n #endif\n }\n \n", "test_patch": "", "problem_statement": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13\n### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_\n", "hints_text": "I have Samsung Galaxy S23 Ultra:\n\n![Image](https://github.com/user-attachments/assets/26d0c0cd-54fd-45fd-9f15-82ad34c3e52b)\n\n![Image](https://github.com/user-attachments/assets/c5c9c148-9f05-4023-8253-f94a10699f91)\n> Build with: Android NDK 25.1.8937393 & 27.2.12479018\n\nWe've had some problems building on android (including NDK 25, see #29360), and are curious how you do the builds for that platform, for testing, can you list more specific build instructions please?\nHey @laanwj ! Our Nunchuk Android app is open source at https://github.com/nunchuk-io/nunchuk-android. You can take a look at the build instructions included in the repo. Let us know if you have any questions!\nThanks! i'd looked there but couldn't find anything that compiles Bitcoin Core, or any C++ code for that matter.\nYou need to first compile the SDK, which is a wrapper for libnunchuk (written in C++ and reuses Core code). @laanwj \n\nhttps://github.com/nunchuk-io/nunchuk-android-nativesdk\nHas not been fixed since #31908 reverted #31826, but also out of scope - see https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2669309907.  I believe this should stay closed.\nThis should be re-opened as per latest discussion in https://github.com/bitcoin/bitcoin/pull/31908 @glozow \n\nTL;DR: Either test and merge the updated fix (https://github.com/bitcoin/bitcoin/pull/31912), or revert the RNDR/RNDRRS feature entirely.\n> TL;DR: Either test and merge the updated fix ([#31912](https://github.com/bitcoin/bitcoin/pull/31912)), or revert the RNDR/RNDRRS feature entirely.\n\n31912 is currently a draft, so before further review and testing (and merge), it would be good to get something non-draft ready first.\nReflecting on this after a while, i'm still not convinced that a hardware feature not working to spec needs to be handled in user space. IMO this needs to be fixed (or worked around otherwise) in the kernel, as per https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2669309907.\n\nEdit: If you can point ot another project (such as OpenSSL) merging code to handle this edge case i'd be more easily convinced we need this.\n> This should be re-opened as per latest discussion in https://github.com/bitcoin/bitcoin/pull/31908 @glozow \n\nI don't see any recent discussion on that thread? I'm not trying to die on this hill or say this problem isn't bad, but there are 414 issues open and imo we should only keep the ones that fall within the scope of what this project supports.\n@laanwj Reposting my earlier comment here:\n\n\u201cI think one could argue that the fix should be made both in the kernel and in Core.\n\nThe design of GetRandBytes() and GetStrongRandBytes() is about being robust and sourcing entropy from multiple sources, so that even if one or some of those sources fail, Core can still obtain sufficiently good entropy. There could be multiple reasons hardware entropy fails to return lower down in the stack.\u201d\n\nSince NOT getting entropy from RNDR/RNDRRS is not a dealbreaker, Core shouldn\u2019t freeze if the RNDR/RNDRRS stack fails for any reason (hardware or otherwise), and there should exist a sensible timeout. The question is about the robustness of the feature design itself.\n@hugohn The reason it was reverted wasn't because the patch didn't work - it could have been fixed instead. It was reverted because merging it broke the build for more platforms than ones suffering just this issue, and this went undetected by all processes we have in place (both manual review and CI infrastructure). It's one thing to accept a patch to improve compatibility with an unsupported platform if it doesn't affect others, but this event clearly showed we weren't equipped to properly assess that. My view is that we shouldn't try to fix this again until/unless there is infrastructure in place that would help us detect build failures like this going forward.\n@sipa What would it take to add the CI infrastructure needed? From @maflcko's comments it sounds like it\u2019s possible?\n\nIn the meantime, given that RNDR/RNDRRS is only supported on a small subset of hardware, it might be prudent to temporarily revert the feature until CI support or hardware adoption is more robust. This would align with a conservative approach.\nThe discussion is a bit spread out, but when I looked in https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2687917758, the feature wasn't compiled into the release binaries. This raises two questions:\n\n* Why? My understanding is that the kernel headers in guix should provide the `HWCAP2_RNG` macro?\n* What is the target audience? Currently it only seems to be self-compiled executables.\n\nAbout the CI: It is possible, but testing compilation or the path on a \"happy\" device doesn't help with the issue here on \"sad\" devices. See https://github.com/bitcoin/bitcoin/pull/31908#issuecomment-2676190482\nAgree, let's just drop the support for now, it's rarely supported (broken on like half of the chips that support it in the first place), apparently not compiled into the release binary anyway, hard to test, and there are plenty of other sources of entropy. \n\nIt's not worth so much discussion, or CI work.", "created_at": "2025-04-11 06:17:44", "merge_commit_sha": "dfa2813e31ba188d8317c19ba427dbd697918116", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['ASan + LSan + UBSan + integer, no depends, USDT', '.github/workflows/ci.yml']", "['Linux->Windows cross, no tests', '.github/workflows/ci.yml']"], ["['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-31826", "base_commit": "43e71f74988b2ad87e4bfc0e1b5c921ab86ec176", "patch": "diff --git a/src/random.cpp b/src/random.cpp\nindex 5b605e988d0c5..6acbbcc210a15 100644\n--- a/src/random.cpp\n+++ b/src/random.cpp\n@@ -192,11 +192,13 @@ uint64_t GetRdSeed() noexcept\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n \n bool g_rndr_supported = false;\n+bool g_rndrrs_supported = false;\n \n void InitHardwareRand()\n {\n     if (getauxval(AT_HWCAP2) & HWCAP2_RNG) {\n         g_rndr_supported = true;\n+        g_rndrrs_supported = VerifyRNDRRS();\n     }\n }\n \n@@ -204,8 +206,10 @@ void ReportHardwareRand()\n {\n     // This must be done in a separate function, as InitHardwareRand() may be indirectly called\n     // from global constructors, before logging is initialized.\n-    if (g_rndr_supported) {\n+    if (g_rndr_supported && g_rndrrs_supported) {\n         LogPrintf(\"Using RNDR and RNDRRS as additional entropy sources\\n\");\n+    } else if (g_rndr_supported) {\n+        LogPrintf(\"Using RNDR as an additional entropy source\\n\");\n     }\n }\n \n@@ -227,24 +231,43 @@ uint64_t GetRNDR() noexcept\n     return r1;\n }\n \n-/** Read 64 bits of entropy using rndrrs.\n- *\n+// Helper function to retrieve random value using RNDRRS\n+bool GetRNDRRSInternal(uint64_t &r1) noexcept\n+{\n+    uint8_t ok = 0;\n+    __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n+                     : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n+    return ok != 0;\n+}\n+\n+\n+/** Read 64 bits of entropy using RNDRRS.\n  * Must only be called when RNDRRS is supported.\n  */\n uint64_t GetRNDRRS() noexcept\n {\n-    uint8_t ok = 0;\n     uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n+    while (!GetRNDRRSInternal(r1)) {\n         __asm__ volatile(\"yield\");\n-    } while (true);\n+    }\n     return r1;\n }\n \n+/** Verify if RNDRRS is supported and functional.\n+ * Return true if it works within the retry limit.\n+ */\n+bool VerifyRNDRRS() noexcept\n+{\n+    uint64_t test;\n+    for (int retry = 0; retry < 10; ++retry) {\n+        if (GetRNDRRSInternal(test)) {\n+            return true;\n+        }\n+        __asm__ volatile(\"yield\");\n+    }\n+    return false;\n+}\n+\n #else\n /* Access to other hardware random number generators could be added here later,\n  * assuming it is sufficiently fast (in the order of a few hundred CPU cycles).\n@@ -295,7 +318,7 @@ void SeedHardwareSlow(CSHA512& hasher) noexcept {\n         return;\n     }\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n+    if (g_rndrrs_supported) {\n         for (int i = 0; i < 4; ++i) {\n             uint64_t out = GetRNDRRS();\n             hasher.Write((const unsigned char*)&out, sizeof(out));\n", "test_patch": "", "problem_statement": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13\n### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_\n", "hints_text": "", "created_at": "2025-02-08 10:17:10", "merge_commit_sha": "139640079ff52de5a7935e98225da76686ef32cb", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"], ["['Win64 native fuzz, VS 2022', '.github/workflows/ci.yml']", "['test each commit', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30962", "base_commit": "393f323bd60b9d47be697820a7ddf075700a7273", "patch": "diff --git a/src/validation.cpp b/src/validation.cpp\nindex b47b1d09ae1e9..5da3387ad296f 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2020,7 +2020,8 @@ void Chainstate::CheckForkWarningConditions()\n \n     // Before we get past initial download, we cannot reliably alert about forks\n     // (we assume we don't get stuck on a fork before finishing our initial sync)\n-    if (m_chainman.IsInitialBlockDownload()) {\n+    // Also not applicable to the background chainstate\n+    if (m_chainman.IsInitialBlockDownload() || this->GetRole() == ChainstateRole::BACKGROUND) {\n         return;\n     }\n \n", "test_patch": "", "problem_statement": "`invalidateblock` during background validation\nIf you call `invalidateblock` (on the tip) during background validation, the node will currently do the following:\r\n#### bitcoin-cli invalidateblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:01:15Z [background validation] UpdateTip: new best=0000000000000000008dd2857255b2e5fc0c3955740c74dac6bafd0de09c344e height=482000 version=0x20000000 log2_work=86.991735 tx=249395394 date='2017-08-25T19:52:51Z' progress=0.230269 cache=238.7MiB(1748399txo)\r\n2024-09-24T13:02:42Z Saw new header hash=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671\r\n2024-09-24T13:02:45Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81087txo)\r\n2024-09-24T13:02:52Z [background validation] UpdateTip: new best=000000000000000000b7738efb4c4acbc841c032294d2e6ab09295f4117c7b3a height=484000 version=0x20000002 log2_work=87.061771 tx=252628356 date='2017-09-07T11:50:44Z' progress=0.233253 cache=688.5MiB(5222117txo)\r\n2024-09-24T13:02:58Z UpdateTip: new best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec height=862670 version=0x3fff0000 log2_work=95.172216 tx=1085323202 date='2024-09-24T13:00:39Z' progress=0.999999 cache=11.8MiB(77967txo)\r\n2024-09-24T13:02:58Z InvalidChainFound: invalid block=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe  height=862671  log2_work=95.172229  date=2024-09-24T13:02:21Z\r\n2024-09-24T13:02:58Z InvalidChainFound:  current best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec  height=862670  log2_work=95.172216  date=2024-09-24T13:00:39Z\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\n<repeat for every new block processed in the background validation>\r\n```\r\n#### bitcoin-cli reconsiderblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81332txo)\r\n2024-09-24T13:03:16Z New outbound-full-relay v2 peer connected: version: 70016, blocks=862671, peer=69\r\n2024-09-24T13:04:44Z [background validation] UpdateTip: new best=000000000000000000a2a8104d61651f76c666b70754d6e9346176385f7afa24 height=486000 version=0x20000000 log2_work=87.131847 tx=255540060 date='2017-09-19T09:09:00Z' progress=0.235942 cache=1014.2MiB(7475508txo)\r\n2024-09-24T13:06:42Z [background validation] UpdateTip: new best=000000000000000000f980eebec0616501eead146975f1df5ca9a1db40309547 height=488000 version=0x20000000 log2_work=87.210415 tx=258791302 date='2017-10-02T21:02:34Z' progress=0.238943 cache=1284.3MiB(9681780txo)\r\n2024-09-24T13:08:01Z [background validation] UpdateTip: new best=000000000000000000de069137b17b8d5a3dfbd5b145b2dcfb203f15d0c4de90 height=490000 version=0x20000000 log2_work=87.286453 tx=262368718 date='2017-10-15T17:57:17Z' progress=0.242246 cache=1521.0MiB(11621530txo)\r\n```\r\n\r\nPrinting these warning messages does not seem useful, or even the correct thing to do during a background sync; as the chain being warned about, is still our best, active chain?\n", "hints_text": "", "created_at": "2024-09-24 18:22:17", "merge_commit_sha": "da612cea032ba241e2d82418baf171b06e5f0142", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30884", "base_commit": "e43ce250c6fb65cc0c8903296c8ab228539d2204", "patch": "diff --git a/src/addrdb.cpp b/src/addrdb.cpp\nindex e9838d722291e..b89141c88e324 100644\n--- a/src/addrdb.cpp\n+++ b/src/addrdb.cpp\n@@ -73,7 +73,7 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n         remove(pathTmp);\n         return false;\n     }\n-    if (!FileCommit(fileout.Get())) {\n+    if (!fileout.Commit()) {\n         fileout.fclose();\n         remove(pathTmp);\n         LogError(\"%s: Failed to flush file %s\\n\", __func__, fs::PathToString(pathTmp));\ndiff --git a/src/bench/streams_findbyte.cpp b/src/bench/streams_findbyte.cpp\nindex 5098262e9afa6..004bf8ffc9dc7 100644\n--- a/src/bench/streams_findbyte.cpp\n+++ b/src/bench/streams_findbyte.cpp\n@@ -19,7 +19,7 @@ static void FindByte(benchmark::Bench& bench)\n     uint8_t data[file_size] = {0};\n     data[file_size-1] = 1;\n     file << data;\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n     BufferedFile bf{file, /*nBufSize=*/file_size + 1, /*nRewindIn=*/file_size};\n \n     bench.run([&] {\ndiff --git a/src/index/blockfilterindex.cpp b/src/index/blockfilterindex.cpp\nindex 41bdca9df562a..26de7eee32fc0 100644\n--- a/src/index/blockfilterindex.cpp\n+++ b/src/index/blockfilterindex.cpp\n@@ -151,7 +151,7 @@ bool BlockFilterIndex::CustomCommit(CDBBatch& batch)\n         LogError(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n-    if (!FileCommit(file.Get())) {\n+    if (!file.Commit()) {\n         LogError(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n@@ -201,11 +201,11 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n             LogPrintf(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!TruncateFile(last_file.Get(), pos.nPos)) {\n+        if (!last_file.Truncate(pos.nPos)) {\n             LogPrintf(\"%s: Failed to truncate filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!FileCommit(last_file.Get())) {\n+        if (!last_file.Commit()) {\n             LogPrintf(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\ndiff --git a/src/index/txindex.cpp b/src/index/txindex.cpp\nindex 80f615ed0e77b..425a7f00a0d08 100644\n--- a/src/index/txindex.cpp\n+++ b/src/index/txindex.cpp\n@@ -87,10 +87,7 @@ bool TxIndex::FindTx(const uint256& tx_hash, uint256& block_hash, CTransactionRe\n     CBlockHeader header;\n     try {\n         file >> header;\n-        if (fseek(file.Get(), postx.nTxOffset, SEEK_CUR)) {\n-            LogError(\"%s: fseek(...) failed\\n\", __func__);\n-            return false;\n-        }\n+        file.seek(postx.nTxOffset, SEEK_CUR);\n         file >> TX_WITH_WITNESS(tx);\n     } catch (const std::exception& e) {\n         LogError(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\nindex b40ca0260beee..44c2808c3bd46 100644\n--- a/src/node/blockstorage.cpp\n+++ b/src/node/blockstorage.cpp\n@@ -683,7 +683,7 @@ bool BlockManager::UndoWriteToDisk(const CBlockUndo& blockundo, FlatFilePos& pos\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write undo data\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\n@@ -981,7 +981,7 @@ bool BlockManager::WriteBlockToDisk(const CBlock& block, FlatFilePos& pos) const\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write block\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\ndiff --git a/src/node/mempool_persist.cpp b/src/node/mempool_persist.cpp\nindex a265c2e12d15a..ff7de8c64a259 100644\n--- a/src/node/mempool_persist.cpp\n+++ b/src/node/mempool_persist.cpp\n@@ -199,8 +199,8 @@ bool DumpMempool(const CTxMemPool& pool, const fs::path& dump_path, FopenFn mock\n         LogInfo(\"Writing %d unbroadcast transactions to file.\\n\", unbroadcast_txids.size());\n         file << unbroadcast_txids;\n \n-        if (!skip_file_commit && !FileCommit(file.Get()))\n-            throw std::runtime_error(\"FileCommit failed\");\n+        if (!skip_file_commit && !file.Commit())\n+            throw std::runtime_error(\"Commit failed\");\n         file.fclose();\n         if (!RenameOver(dump_path + \".new\", dump_path)) {\n             throw std::runtime_error(\"Rename failed\");\ndiff --git a/src/node/utxo_snapshot.cpp b/src/node/utxo_snapshot.cpp\nindex 976421e455391..7d589c886b824 100644\n--- a/src/node/utxo_snapshot.cpp\n+++ b/src/node/utxo_snapshot.cpp\n@@ -73,9 +73,11 @@ std::optional<uint256> ReadSnapshotBaseBlockhash(fs::path chaindir)\n     }\n     afile >> base_blockhash;\n \n-    if (std::fgetc(afile.Get()) != EOF) {\n+    int64_t position = afile.tell();\n+    afile.seek(0, SEEK_END);\n+    if (position != afile.tell()) {\n         LogPrintf(\"[snapshot] warning: unexpected trailing data in %s\\n\", read_from_str);\n-    } else if (std::ferror(afile.Get())) {\n+    } else if (afile.IsError()) {\n         LogPrintf(\"[snapshot] warning: i/o error reading %s\\n\", read_from_str);\n     }\n     return base_blockhash;\ndiff --git a/src/streams.cpp b/src/streams.cpp\nindex cdd36a86feb17..5f7baf92b9e8e 100644\n--- a/src/streams.cpp\n+++ b/src/streams.cpp\n@@ -4,21 +4,29 @@\n \n #include <span.h>\n #include <streams.h>\n+#include <util/fs_helpers.h>\n \n #include <array>\n \n+AutoFile::AutoFile(std::FILE* file, std::vector<std::byte> data_xor)\n+    : m_file{file}, m_xor{std::move(data_xor)}\n+{\n+    if (!IsNull()) {\n+        auto pos{std::ftell(m_file)};\n+        if (pos >= 0) m_position = pos;\n+    }\n+}\n+\n std::size_t AutoFile::detail_fread(Span<std::byte> dst)\n {\n     if (!m_file) throw std::ios_base::failure(\"AutoFile::read: file handle is nullptr\");\n-    if (m_xor.empty()) {\n-        return std::fread(dst.data(), 1, dst.size(), m_file);\n-    } else {\n-        const auto init_pos{std::ftell(m_file)};\n-        if (init_pos < 0) throw std::ios_base::failure(\"AutoFile::read: ftell failed\");\n-        std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n-        util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n-        return ret;\n+    size_t ret = std::fread(dst.data(), 1, dst.size(), m_file);\n+    if (!m_xor.empty()) {\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::read: position unknown\");\n+        util::Xor(dst.subspan(0, ret), m_xor, *m_position);\n     }\n+    if (m_position.has_value()) *m_position += ret;\n+    return ret;\n }\n \n void AutoFile::seek(int64_t offset, int origin)\n@@ -29,18 +37,23 @@ void AutoFile::seek(int64_t offset, int origin)\n     if (std::fseek(m_file, offset, origin) != 0) {\n         throw std::ios_base::failure(feof() ? \"AutoFile::seek: end of file\" : \"AutoFile::seek: fseek failed\");\n     }\n+    if (origin == SEEK_SET) {\n+        m_position = offset;\n+    } else if (origin == SEEK_CUR && m_position.has_value()) {\n+        *m_position += offset;\n+    } else {\n+        int64_t r{std::ftell(m_file)};\n+        if (r < 0) {\n+            throw std::ios_base::failure(\"AutoFile::seek: ftell failed\");\n+        }\n+        m_position = r;\n+    }\n }\n \n int64_t AutoFile::tell()\n {\n-    if (IsNull()) {\n-        throw std::ios_base::failure(\"AutoFile::tell: file handle is nullptr\");\n-    }\n-    int64_t r{std::ftell(m_file)};\n-    if (r < 0) {\n-        throw std::ios_base::failure(\"AutoFile::tell: ftell failed\");\n-    }\n-    return r;\n+    if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::tell: position unknown\");\n+    return *m_position;\n }\n \n void AutoFile::read(Span<std::byte> dst)\n@@ -60,6 +73,7 @@ void AutoFile::ignore(size_t nSize)\n             throw std::ios_base::failure(feof() ? \"AutoFile::ignore: end of file\" : \"AutoFile::ignore: fread failed\");\n         }\n         nSize -= nNow;\n+        if (m_position.has_value()) *m_position += nNow;\n     }\n }\n \n@@ -70,19 +84,34 @@ void AutoFile::write(Span<const std::byte> src)\n         if (std::fwrite(src.data(), 1, src.size(), m_file) != src.size()) {\n             throw std::ios_base::failure(\"AutoFile::write: write failed\");\n         }\n+        if (m_position.has_value()) *m_position += src.size();\n     } else {\n-        auto current_pos{std::ftell(m_file)};\n-        if (current_pos < 0) throw std::ios_base::failure(\"AutoFile::write: ftell failed\");\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::write: position unknown\");\n         std::array<std::byte, 4096> buf;\n         while (src.size() > 0) {\n             auto buf_now{Span{buf}.first(std::min<size_t>(src.size(), buf.size()))};\n             std::copy(src.begin(), src.begin() + buf_now.size(), buf_now.begin());\n-            util::Xor(buf_now, m_xor, current_pos);\n+            util::Xor(buf_now, m_xor, *m_position);\n             if (std::fwrite(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n                 throw std::ios_base::failure{\"XorFile::write: failed\"};\n             }\n             src = src.subspan(buf_now.size());\n-            current_pos += buf_now.size();\n+            *m_position += buf_now.size();\n         }\n     }\n }\n+\n+bool AutoFile::Commit()\n+{\n+    return ::FileCommit(m_file);\n+}\n+\n+bool AutoFile::IsError()\n+{\n+    return ferror(m_file);\n+}\n+\n+bool AutoFile::Truncate(unsigned size)\n+{\n+    return ::TruncateFile(m_file, size);\n+}\ndiff --git a/src/streams.h b/src/streams.h\nindex c2a9dea2878d1..431a4d77c6ced 100644\n--- a/src/streams.h\n+++ b/src/streams.h\n@@ -390,9 +390,10 @@ class AutoFile\n protected:\n     std::FILE* m_file;\n     std::vector<std::byte> m_xor;\n+    std::optional<int64_t> m_position;\n \n public:\n-    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={}) : m_file{file}, m_xor{std::move(data_xor)} {}\n+    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={});\n \n     ~AutoFile() { fclose(); }\n \n@@ -419,12 +420,6 @@ class AutoFile\n         return ret;\n     }\n \n-    /** Get wrapped FILE* without transfer of ownership.\n-     * @note Ownership of the FILE* will remain with this class. Use this only if the scope of the\n-     * AutoFile outlives use of the passed pointer.\n-     */\n-    std::FILE* Get() const { return m_file; }\n-\n     /** Return true if the wrapped FILE* is nullptr, false otherwise.\n      */\n     bool IsNull() const { return m_file == nullptr; }\n@@ -458,6 +453,10 @@ class AutoFile\n         ::Unserialize(*this, obj);\n         return *this;\n     }\n+\n+    bool Commit();\n+    bool IsError();\n+    bool Truncate(unsigned size);\n };\n \n /** Wrapper around an AutoFile& that implements a ring buffer to\ndiff --git a/src/util/asmap.cpp b/src/util/asmap.cpp\nindex f50cd8a28c12d..04b0673c49b42 100644\n--- a/src/util/asmap.cpp\n+++ b/src/util/asmap.cpp\n@@ -203,10 +203,10 @@ std::vector<bool> DecodeAsmap(fs::path path)\n         LogPrintf(\"Failed to open asmap file from disk\\n\");\n         return bits;\n     }\n-    fseek(filestr, 0, SEEK_END);\n-    int length = ftell(filestr);\n+    file.seek(0, SEEK_END);\n+    int length = file.tell();\n     LogPrintf(\"Opened asmap file %s (%d bytes) from disk\\n\", fs::quoted(fs::PathToString(path)), length);\n-    fseek(filestr, 0, SEEK_SET);\n+    file.seek(0, SEEK_SET);\n     uint8_t cur_byte;\n     for (int i = 0; i < length; ++i) {\n         file >> cur_byte;\n", "test_patch": "diff --git a/src/test/fuzz/autofile.cpp b/src/test/fuzz/autofile.cpp\nindex 45316b6b218db..81761c7bf9694 100644\n--- a/src/test/fuzz/autofile.cpp\n+++ b/src/test/fuzz/autofile.cpp\n@@ -56,7 +56,6 @@ FUZZ_TARGET(autofile)\n                 WriteToStream(fuzzed_data_provider, auto_file);\n             });\n     }\n-    (void)auto_file.Get();\n     (void)auto_file.IsNull();\n     if (fuzzed_data_provider.ConsumeBool()) {\n         FILE* f = auto_file.release();\ndiff --git a/src/test/streams_tests.cpp b/src/test/streams_tests.cpp\nindex 9217f05945f0c..777122df6d03a 100644\n--- a/src/test/streams_tests.cpp\n+++ b/src/test/streams_tests.cpp\n@@ -261,7 +261,7 @@ BOOST_AUTO_TEST_CASE(streams_buffered_file)\n     for (uint8_t j = 0; j < 40; ++j) {\n         file << j;\n     }\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n \n     // The buffer size (second arg) must be greater than the rewind\n     // amount (third arg).\n@@ -391,7 +391,7 @@ BOOST_AUTO_TEST_CASE(streams_buffered_file_skip)\n     for (uint8_t j = 0; j < 40; ++j) {\n         file << j;\n     }\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n \n     // The buffer is 25 bytes, allow rewinding 10 bytes.\n     BufferedFile bf{file, 25, 10};\n@@ -444,7 +444,7 @@ BOOST_AUTO_TEST_CASE(streams_buffered_file_rand)\n         for (uint8_t i = 0; i < fileSize; ++i) {\n             file << i;\n         }\n-        std::rewind(file.Get());\n+        file.seek(0, SEEK_SET);\n \n         size_t bufSize = m_rng.randrange(300) + 1;\n         size_t rewindSize = m_rng.randrange(bufSize);\n", "problem_statement": "28.0rc1 synchronizes much slower on Windows\nBitcoin Core 28.0rc1 (both pre-built and self-built binary) on Windows 10 synchronizes much slower than 27.0 after around block 120,000 when blocks stop being almost empty. I'm running with default settings (dbcache=450, pruning disabled).\r\n\r\nTime to synchronize to block 300,000: (measured around 10 runs each, alternating between the versions)\r\n27.0: **695 seconds**\r\n28.0rc1: **2760 seconds**\r\n\r\n![28.0rc1](https://github.com/user-attachments/assets/060a1e18-7f97-4e86-9ba8-5bf867b3510e)\r\n\r\nRunning the Linux pre-built binary in WSL doesn't show the slowdown, so it's probably limited to Windows.\r\n\r\n~~I'm going to bisect this, but that will definitely take me a while. If anyone suspects a commit/PR that I should look at first that might help.~~ I've bisected this down to #28052, for more details see https://github.com/bitcoin/bitcoin/issues/30833#issuecomment-2335184072.\n", "hints_text": "Try whether #28280 had any impact.\nI actually benchmarked #28280 right before it got merged: https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2268695679\r\n\r\nFrom the results it definitely seems that PR is not to blame and the regression happened later.\nhttps://github.com/bitcoin/bitcoin/pull/30326?\nReason I suspect #30326 is because `try_emplace` must be doing more work than just `find` and is only called after blocks stop being empty because previous coins are now being looked up to be spent.\r\n\r\nRelevant stackoverflow https://stackoverflow.com/questions/24209592/performance-of-emplace-is-worse-than-check-followed-by-emplace\n@andrewtoth I cannot imagine that causing a 5x slowdown, though?\nOnly did one run of each but I have basically the opposite result: 4406 seconds for 27.1, and 2949 for 28.0rc1.\n@vostrnad when you say synchronizes, do you mean running with `-reindex-chainstate` or are you starting with a fresh data directory and downloading blocks from peers? If the latter, are you downloading blocks from a node in your local network?\n@andrewtoth I updated the OP. I'm synchronizing from a local node with a fresh datadir each time.\n@vostrnad  I'm trying to get a Windows box setup to reproduce this myself, but if you get a chance, could you do a run of both again with `-debug=bench` set, and post the final set of `[bench]` logs that get written to debug.log? Those might help narrow where the slowdown is coming from.\nI've bisected this down to #28052. From the benchmark results it appears to be solely responsible for the slowdown between 27.0 and 28.0rc1 (so #30326 should be fine @andrewtoth).\r\n\r\nBenchmark results: (fresh sync to block 300,000 from a local node, using default settings, all binaries self-built using Mingw-w64, around 6 runs each)\r\n\r\nd82283950f5ff3b2116e705f931c6e89e5fdd0be (v27.0): **738s \u00b1 16s**\r\nfa7f7ac040a9467c307b20e77dc47c87d7377ded (first commit of #28052): **733s \u00b1 21s**\r\nfa895c72832f9555b52d5bb1dba1093f73de3136 (top commit of #28052): **2827s \u00b1 9s**\r\n88f0419c1ab1e5f3ccf425435e530d8ceb72c7f1 (v28.0rc1): **2815 \u00b1 13s**\r\n\r\n![blocksxor](https://github.com/user-attachments/assets/180f6600-fe2f-4cef-8bcd-6c5fa6c405fc)\r\n\n@vostrnad Does the performance on Windows recover if you run with the `-blocksxor=0` option?\n@sipa No, it's exactly the same with `-blocksxor=0`.\n> @sipa No, it's exactly the same with `-blocksxor=0`.\r\n\r\nThis has uncovered a bug in #28052, `InitBlocksdirXorKey` does not return an empty `std::vector<std::byte>` when the `-blocksxor=0` argument is used, it instead [returns](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1185) a [vector with 8 bytes equal to zero](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1152):\r\n\r\n```cpp\r\nstatic auto InitBlocksdirXorKey(const BlockManager::Options& opts)\r\n{\r\n    std::array<std::byte, 8> xor_key{};\r\n    \r\n    if (opts.use_xor && fs::is_empty(opts.blocks_dir)) {\r\n        // Only use random fresh key when the boolean option is set and on the\r\n        // very first start of the program.\r\n        FastRandomContext{}.fillrand(xor_key);\r\n    }\r\n    \r\n    // [...]\r\n    return std::vector<std::byte>{xor_key.begin(), xor_key.end()};\r\n}\r\n```\r\n\r\nIn turn, this causes us to go through the XOR logic of [`AutoFile::detail_fread()`](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/streams.cpp#L10-L22) and [`AutoFile::write()`](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/streams.cpp#L66-L88) since the block autofiles' `std::vector<std::byte> m_xor` are [initialized](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1190) to the return value of `InitBlocksdirXorKey`.\r\n\r\nE.g.: https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/streams.cpp#L10-L23\r\n\r\nI have a branch off of `28.x` (https://github.com/davidgumberg/bitcoin/commit/aa0be4031cbe5bed407bc7a1753875cc1c4ddccb) that should fix this issue when `-blocksxor=0` but I haven't tested yet\r\n\r\nI also managed to reproduce (n=1) the issue on Windows 10 LTSC Build 17763:\r\n\r\n```bash\r\nbitcoind.exe -dbcache=450 -stopatheight=300000 -debug=bench -connect=localnode:8333\r\n```\r\n\r\n28.0rc1 took 7,368 seconds\r\n27.1 took 3,594 seconds\n> This has uncovered a bug in https://github.com/bitcoin/bitcoin/pull/28052, InitBlocksdirXorKey does not return an empty std::vector<std::byte> when the -blocksxor=0 argument is used, it instead [returns](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1185) a [vector with 8 bytes equal to zero](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1152):\r\n\r\nI may be missing something because I am looking at the blocksxor stuff the first time but that doesn't seem to be a bug. When XOR is disabled we still write the xor file with zeros. There is even a functional test for that behavior: https://github.com/bitcoin/bitcoin/blob/master/test/functional/feature_blocksxor.py#L64 Your branch seems to change that expected behavior.\nSeems worth experimenting with:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src%2Fstreams.cpp#L76-L80\r\n\r\nI wonder if the array creation, the copy, or the xoring here are the long pole in the tent? Experimenting with the all 0s xor key can help isolate.\r\n\r\nI'll have to take a look, but do we have any IBD tests/benches mimicking a significant IBD (e.g. first 400k blocks)? It would be good to catch performence regressions automatically.\r\n\r\nSomething on [bitcoinperf.com](https://codespeed.bitcoinperf.com/comparison/)? (looks like maybe the data there is stale)\r\n\r\nOr something like a functional test that has two nodes, one node creating a chain of similar complexity/size (if we don't want to store that part of mainnet), then the second node does IBD from first? Ci could run the test and be set to timeout for an excessively long IBD (which albeit is subjective so not ideal). Maybe it's better to leave CI out of this?\n> > This has uncovered a bug in #28052, InitBlocksdirXorKey does not return an empty std::vectorstd::byte when the -blocksxor=0 argument is used, it instead [returns](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1185) a [vector with 8 bytes equal to zero](https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src/node/blockstorage.cpp#L1152):\r\n> \r\n> I may be missing something because I am looking at the blocksxor stuff the first time but that doesn't seem to be a bug. When XOR is disabled we still write the xor file with zeros. There is even a functional test for that behavior: https://github.com/bitcoin/bitcoin/blob/master/test/functional/feature_blocksxor.py#L64 Your branch seems to change that expected behavior.\r\n\r\nYou're right, creating an xor.dat with all zeroes when `-blocksxor=0` was intended, so not a bug in that PR. Still, the fact that when a user disables xor'ing blocks we still perform all the usual XOR logic, but with an XOR pattern of zeroes doesn't make sense to me, and it seems like an unintended side effect of https://github.com/bitcoin/bitcoin/pull/28052 .\r\n\r\nI tested https://github.com/davidgumberg/bitcoin/commit/aa0be4031cbe5bed407bc7a1753875cc1c4ddccb with `-blocksxor=0` and the same Windows setup and the performance regression goes away.\r\n\r\nI'm still investigating, but my bench logs indicate that the regression is coming from writing block undo data, the difference between the (reported) total block connection time between v27.1 and v28.0rc1 is +1,337.85 seconds for v28, and the difference in (reported) time spent writing undo block data is +1,579.31s for v28:\r\n\r\n<details>\r\n\r\n<summary>Version 28.0 rc1 bench logs</summary>\r\n\r\n```diff\r\n [bench]   - Using cached block\r\n [bench]   - Load block from disk: 0.57ms\r\n [bench]     - Sanity checks: 0.02ms [5.37s (0.02ms/blk)]\r\n [bench]     - Fork checks: 0.40ms [159.15s (0.53ms/blk)]\r\n [bench]       - Connect 512 transactions: 2.95ms (0.006ms/tx, 0.002ms/txin) [303.09s (1.01ms/blk)]\r\n [bench]     - Verify 1180 txins: 3.45ms (0.003ms/txin) [425.49s (1.42ms/blk)]\r\n+[bench]     - Write undo data: 26.38ms [2296.37s (7.65ms/blk)]\r\n [bench]     - Index writing: 0.46ms [148.03s (0.49ms/blk)]\r\n [bench]   - Connect total: 31.98ms [3281.81s (10.94ms/blk)]\r\n [bench]   - Flush: 2.44ms [246.56s (0.82ms/blk)]\r\n [bench]   - Writing chainstate: 0.89ms [107.89s (0.36ms/blk)]\r\n UpdateTip: new best=000000000000000049a0914d83df36982c77ac1f65ade6a52bdced2ce312aba9 height=300001 version=0x00000002 log2_work=78.499665 tx=38464301 date='2014-05-10T06:51:23Z' progress=0.035833 cache=641.2MiB(5186028txo)\r\n [bench]   - Connect postprocess: 0.64ms [261.25s (0.87ms/blk)]\r\n+[bench] - Connect block: 36.53ms [4041.91s (13.47ms/blk)]\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Version 27.1 bench logs</summary>\r\n\r\n```diff\r\n [bench]   - Using cached block\r\n [bench]   - Load block from disk: 1.03ms\r\n [bench]     - Sanity checks: 0.02ms [5.58s (0.02ms/blk)]\r\n [bench]     - Fork checks: 0.36ms [154.95s (0.52ms/blk)]\r\n [bench]       - Connect 173 transactions: 1.39ms (0.008ms/tx, 0.003ms/txin) [330.82s (1.10ms/blk)]\r\n [bench]     - Verify 435 txins: 2.02ms (0.005ms/txin) [478.57s (1.60ms/blk)]\r\n+[bench]     - Write undo data: 1.24ms [717.06s (2.39ms/blk)]\r\n [bench]     - Index writing: 0.33ms [152.89s (0.51ms/blk)]\r\n [bench]   - Connect total: 5.11ms [1754.52s (5.85ms/blk)]\r\n [bench]   - Flush: 1.35ms [310.98s (1.04ms/blk)]\r\n [bench]   - Writing chainstate: 0.33ms [149.58s (0.50ms/blk)]\r\n UpdateTip: new best=000000000000000082aee4ff546c1db5e1aa5f9bfbaa0c76300a792b3e91fce7 height=300003 version=0x00000002 log2_work=78.499897 tx=38464563 date='2014-05-10T06:58:47Z' progress=0.035342 cache=510.6MiB(4668409txo)\r\n [bench]   - Connect postprocess: 0.86ms [356.88s (1.19ms/blk)]\r\n+[bench] - Connect block: 8.68ms [2704.06s (9.01ms/blk)]\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>\r\n\r\nMy modified branch of 28.x with `-blocksxor=0` bench logs\r\n\r\n</summary>\r\n\r\n```diff\r\n [bench]   - Using cached block\r\n [bench]   - Load block from disk: 0.23ms\r\n [bench]     - Sanity checks: 0.01ms [5.35s (0.02ms/blk)]\r\n [bench]     - Fork checks: 0.29ms [150.64s (0.50ms/blk)]\r\n [bench]       - Connect 512 transactions: 2.18ms (0.004ms/tx, 0.002ms/txin) [308.30s (1.03ms/blk)]\r\n [bench]     - Verify 1180 txins: 2.58ms (0.002ms/txin) [448.44s (1.49ms/blk)]\r\n+[bench]     - Write undo data: 1.62ms [758.14s (2.53ms/blk)]\r\n [bench]     - Index writing: 0.30ms [127.39s (0.42ms/blk)]\r\n [bench]   - Connect total: 5.72ms [1710.90s (5.70ms/blk)]\r\n [bench]   - Flush: 2.31ms [258.95s (0.86ms/blk)]\r\n [bench]   - Writing chainstate: 0.49ms [142.43s (0.47ms/blk)]\r\n UpdateTip: new best=000000000000000049a0914d83df36982c77ac1f65ade6a52bdced2ce312aba9 height=300001 version=0x00000002 log2_work=78.499665 tx=38464301 date='2014-05-10T06:51:23Z' progress=0.035817 cache=641.2MiB(5186028txo)\r\n [bench]   - Connect postprocess: 0.89ms [305.06s (1.02ms/blk)]\r\n+[bench] - Connect block: 9.64ms [2531.72s (8.44ms/blk)]\r\n```\r\n\r\n</details>\n@davidgumberg Well from the (apparently mistaken) assumption that the XOR logic comes with no material performance cost, it made sense to always want to use it (even with a pattern of zero), just from a perspective of minimizing different code branch combinations.\n\nIf the XOR logic is too slow (on some systems), as it appears to be, we have two options:\n* Disabling it when (nonzero) XORing is not enabled, but that leaves us with the uncomfortable choice to make of (perhaps selectively) disabling (nonzero) XORing by default, as Windows users will otherwise still suffer with 28.0.\n* Fixing the performance issue.\n> My bench logs indicate that the regression is coming from writing block undo data, the difference between the (reported) total block connection time between v27.1 and v28.0rc1 is +1,337.85 seconds for v28, and the difference in (reported) time spent writing undo block data is +1,579.31s for v28:\r\n\r\nThis is saying that the total time for writing undo block data exceeds total block connection time. But, writing undo block data is a subsection of block connection time, so it should always be less no?\r\n\r\nAlso, the logs show `Using cached block`, meaning it is not counting saving the block itself to disk in the `Connect block` benchmark. So, actually saving the blocks in `AcceptBlock` might be taking even more time than writing the undo blocks.\n@andrewtoth \r\n>> My bench logs indicate that the regression is coming from writing block undo data, the difference between the (reported) total block connection time between v27.1 and v28.0rc1 is +1,337.85 seconds for v28, and the difference in (reported) time spent writing undo block data is +1,579.31s for v28:\r\n>\r\n> This is saying that the total time for writing undo block data exceeds total block connection time. But, writing undo block data is a subsection of block connection time, so it should always be less no?\r\n\r\nSorry, I did not express that well, the two numbers I gave are the delta between v27.1 and v28.0rc1, total time spent writing undo block data is 2,296.37s in v28 and 717.06s in v27.1. Total time spent doing block connection is 4041.91s in v28.0rc1 and 2704.06s in v27.1.\r\n \r\nOther parts of the v28 sync are faster (at least in my n=1 run~~s~~) , e.g. flushing the temporary `CCoinsViewCache` takes ~60 fewer seconds in v28 compensating for the increased time spent writing undo data.\r\n\r\n> Also, the logs show Using cached block, meaning it is not counting saving the block itself to disk in the Connect block benchmark. So, actually saving the blocks in AcceptBlock might be taking even more time than writing the undo blocks.\r\n\r\nI see, I guess that explains why the difference in wall clock time taken (v28 took 3,774 more seconds) is more than double the size of the slowdown reported by the ConnectBlock bench logs (v28 took 1,337.85 seconds longer doing block connection).\r\n\r\n---\r\n\r\n@tdb3\r\n> Seems worth experimenting with:\r\n> \r\n> https://github.com/bitcoin/bitcoin/blob/fa460884406b35b0dee75af23f42e8b4c4acbebc/src%2Fstreams.cpp#L76-L80\r\n> \r\n> I wonder if the array creation, the copy, or the xoring here are the long pole in the tent? Experimenting with the all 0s xor key can help isolate.\r\n\r\nIt seems there was some prior discussion around this in #28060 which may be of interest:\r\nhttps://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260260590\r\n\r\n---\r\n\r\nI wonder if this issue could be caused by number of calls we make to `fwrite` because of the write buffering in xor path of `AutoFile::write()`, maybe platforms other than windows are optimizing our writes into batches behind the scenes? I don't know much about how I/O works behind the scenes, just a guess.\n> I wonder if this issue could be caused by number of calls we make to `fwrite` because of the write buffering in xor path of `AutoFile::write()`, maybe platforms other than windows are optimizing our writes into batches behind the scenes? I don't know much about how I/O works behind the scenes, just a guess.\r\n\r\nI have not checked, but this would be my guess.\nThe xor patch didn't change buffering. Yes, in theory there is a 4096 byte max buffer, however, this is never hit in practice. Undo data consists of small integers (4 bytes or 1 byte) and short strings (like output scripts).\r\n\r\nI expect that if you print the number of writes before and after, they are exactly the same. If you also print the size of the writes they should show a histogram where 1-byte writes are the most common (probably all varint), followed by various writes all shorter than 33 bytes (or whatever the largest output script is).\r\n\r\nI don't have Windows, so I can't say what is happening there and why something is observable there, while the same isn't observable on Linux.\r\n\r\nIt may be useful to run the Xor benchmark on the same machine in Windows and on Linux, to see if the performance differs there: `./bench_bitcoin -filter=Xor -min-time=100`.\r\n\r\nAlso, it is possible to write a new benchmark, to see if the xor overhead is unexpectely large inside AutoFile:\r\n\r\n```diff\r\ndiff --git a/src/bench/xor.cpp b/src/bench/xor.cpp\r\nindex fc9dc5d172..96cb952c3b 100644\r\n--- a/src/bench/xor.cpp\r\n+++ b/src/bench/xor.cpp\r\n@@ -21,4 +21,19 @@ static void Xor(benchmark::Bench& bench)\r\n     });\r\n }\r\n \r\n+static void AutoFileXor(benchmark::Bench& bench)\r\n+{\r\n+    FastRandomContext frc{/*fDeterministic=*/true};\r\n+    auto data{frc.randbytes<std::byte>(4'000'000)};\r\n+    auto key{frc.randbytes<std::byte>(8)};\r\n+\r\n+    auto path{path_to_a_temp_file_on_the_storage_device_under_test};\r\n+\r\n+    bench.batch(data.size()).unit(\"byte\").run([&] {\r\n+        AutoFile f{fsbridge::fopen(path, \"wb+\"), key};\r\n+        f << data;\r\n+    });\r\n+}\r\n+\r\n BENCHMARK(Xor, benchmark::PriorityLevel::HIGH);\r\n+BENCHMARK(AutoFileXor, benchmark::PriorityLevel::HIGH);\r\n```\r\n\r\n<!---\r\n\r\nGenerally, when providing an xor pattern to an `AutoFile` before using its `write` method, it is expected that the `write` is slower. This should hold on any platform and the relative slowdown should depend on the write speed of the underlying storage, as well as the CPU speed.\nApart from the benchmark, it may also be useful to create a flamegraph/heatmap, so that it is easy to see where the time is spent.\nI managed to get bitcoind compiled on my windows installation (Windows 10 Pro 22H2, MSVC 2022), didn't observe a notable difference in the benchmarks.\r\nI'm still in the process of trying to test the sync speed, but if it's due to the undo data, then a reindex-chainstate should be sufficient to see the difference?! Did anyone try that already?\n> I managed to get bitcoind compiled on my windows installation (Windows 10 Pro 22H2, MSVC 2022), didn't observe a notable difference in the benchmarks.\r\n\r\nI hope everyone measuring performance on Windows has disabled all antivirus software, at least for the data directory. Right?\n@hebasto Yes, I have disabled antivirus for both the data directory and the directory where the binaries are located, I checked that the antivirus CPU utilization stays low during the benchmarks, and I'm using identical directory locations for both versions so they wouldn't be treated differently by the antivirus anyway.\nDiscussion from today's IRC meeting is that we should move forward with @davidgumberg's patch and default to false on Windows for this release.", "created_at": "2024-09-12 15:57:22", "merge_commit_sha": "9f1aa88d4d9596aeb5220fa30ee3972294b62793", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30666", "base_commit": "6fc4692797121b54de0c54e5b09ee47f322c038a", "patch": "diff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex 7ffd03e71af5a..4a7af39b15144 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -1648,6 +1648,7 @@ void ReconsiderBlock(ChainstateManager& chainman, uint256 block_hash) {\n         }\n \n         chainman.ActiveChainstate().ResetBlockFailureFlags(pblockindex);\n+        chainman.RecalculateBestHeader();\n     }\n \n     BlockValidationState state;\ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex 8e4ea8eda2f62..dcaa8dba26602 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2045,8 +2045,9 @@ void Chainstate::InvalidChainFound(CBlockIndex* pindexNew)\n     if (!m_chainman.m_best_invalid || pindexNew->nChainWork > m_chainman.m_best_invalid->nChainWork) {\n         m_chainman.m_best_invalid = pindexNew;\n     }\n+    SetBlockFailureFlags(pindexNew);\n     if (m_chainman.m_best_header != nullptr && m_chainman.m_best_header->GetAncestor(pindexNew->nHeight) == pindexNew) {\n-        m_chainman.m_best_header = m_chain.Tip();\n+        m_chainman.RecalculateBestHeader();\n     }\n \n     LogPrintf(\"%s: invalid block=%s  height=%d  log2_work=%f  date=%s\\n\", __func__,\n@@ -3785,6 +3786,17 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n     return true;\n }\n \n+void Chainstate::SetBlockFailureFlags(CBlockIndex* invalid_block)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    for (auto& [_, block_index] : m_blockman.m_block_index) {\n+        if (block_index.GetAncestor(invalid_block->nHeight) == invalid_block && !(block_index.nStatus & BLOCK_FAILED_MASK)) {\n+            block_index.nStatus |= BLOCK_FAILED_CHILD;\n+        }\n+    }\n+}\n+\n void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     AssertLockHeld(cs_main);\n \n@@ -6396,6 +6408,17 @@ std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n \n+void ChainstateManager::RecalculateBestHeader()\n+{\n+    AssertLockHeld(cs_main);\n+    m_best_header = ActiveChain().Tip();\n+    for (auto& entry : m_blockman.m_block_index) {\n+        if (!(entry.second.nStatus & BLOCK_FAILED_MASK) && m_best_header->nChainWork < entry.second.nChainWork) {\n+            m_best_header = &entry.second;\n+        }\n+    }\n+}\n+\n bool ChainstateManager::ValidatedSnapshotCleanup()\n {\n     AssertLockHeld(::cs_main);\ndiff --git a/src/validation.h b/src/validation.h\nindex 059ae52bdf4ca..29ff6bd94cd4e 100644\n--- a/src/validation.h\n+++ b/src/validation.h\n@@ -735,6 +735,9 @@ class Chainstate\n         EXCLUSIVE_LOCKS_REQUIRED(!m_chainstate_mutex)\n         LOCKS_EXCLUDED(::cs_main);\n \n+    /** Set invalidity status to all descendants of a block */\n+    void SetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     /** Remove invalidity status from a block and its descendants. */\n     void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n@@ -1321,6 +1324,11 @@ class ChainstateManager\n     //! nullopt.\n     std::optional<int> GetSnapshotBaseHeight() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! If, due to invalidation / reconsideration of blocks, the previous\n+    //! best header is no longer valid / guaranteed to be the most-work\n+    //! header in our block-index not known to be invalid, recalculate it.\n+    void RecalculateBestHeader() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     CCheckQueue<CScriptCheck>& GetCheckQueue() { return m_script_check_queue; }\n \n     ~ChainstateManager();\n", "test_patch": "diff --git a/test/functional/rpc_getchaintips.py b/test/functional/rpc_getchaintips.py\nindex 1bd4413ce1ec2..226e995307cef 100755\n--- a/test/functional/rpc_getchaintips.py\n+++ b/test/functional/rpc_getchaintips.py\n@@ -10,6 +10,10 @@\n - verify that getchaintips now returns two chain tips.\n \"\"\"\n \n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n \n@@ -18,44 +22,73 @@ def set_test_params(self):\n         self.num_nodes = 4\n \n     def run_test(self):\n+        self.log.info(\"Test getchaintips behavior with two chains of different length\")\n         tips = self.nodes[0].getchaintips()\n         assert_equal(len(tips), 1)\n         assert_equal(tips[0]['branchlen'], 0)\n         assert_equal(tips[0]['height'], 200)\n         assert_equal(tips[0]['status'], 'active')\n \n-        # Split the network and build two chains of different lengths.\n+        self.log.info(\"Split the network and build two chains of different lengths.\")\n         self.split_network()\n         self.generate(self.nodes[0], 10, sync_fun=lambda: self.sync_all(self.nodes[:2]))\n         self.generate(self.nodes[2], 20, sync_fun=lambda: self.sync_all(self.nodes[2:]))\n \n-        tips = self.nodes[1].getchaintips ()\n-        assert_equal (len (tips), 1)\n+        tips = self.nodes[1].getchaintips()\n+        assert_equal(len(tips), 1)\n         shortTip = tips[0]\n-        assert_equal (shortTip['branchlen'], 0)\n-        assert_equal (shortTip['height'], 210)\n-        assert_equal (tips[0]['status'], 'active')\n+        assert_equal(shortTip['branchlen'], 0)\n+        assert_equal(shortTip['height'], 210)\n+        assert_equal(tips[0]['status'], 'active')\n \n-        tips = self.nodes[3].getchaintips ()\n-        assert_equal (len (tips), 1)\n+        tips = self.nodes[3].getchaintips()\n+        assert_equal(len(tips), 1)\n         longTip = tips[0]\n-        assert_equal (longTip['branchlen'], 0)\n-        assert_equal (longTip['height'], 220)\n-        assert_equal (tips[0]['status'], 'active')\n+        assert_equal(longTip['branchlen'], 0)\n+        assert_equal(longTip['height'], 220)\n+        assert_equal(tips[0]['status'], 'active')\n \n-        # Join the network halves and check that we now have two tips\n+        self.log.info(\"Join the network halves and check that we now have two tips\")\n         # (at least at the nodes that previously had the short chain).\n-        self.join_network ()\n+        self.join_network()\n \n-        tips = self.nodes[0].getchaintips ()\n-        assert_equal (len (tips), 2)\n-        assert_equal (tips[0], longTip)\n+        tips = self.nodes[0].getchaintips()\n+        assert_equal(len(tips), 2)\n+        assert_equal(tips[0], longTip)\n \n-        assert_equal (tips[1]['branchlen'], 10)\n-        assert_equal (tips[1]['status'], 'valid-fork')\n+        assert_equal(tips[1]['branchlen'], 10)\n+        assert_equal(tips[1]['status'], 'valid-fork')\n         tips[1]['branchlen'] = 0\n         tips[1]['status'] = 'active'\n-        assert_equal (tips[1], shortTip)\n+        assert_equal(tips[1], shortTip)\n+\n+        self.log.info(\"Test getchaintips behavior with invalid blocks\")\n+        self.disconnect_nodes(0, 1)\n+        n0 = self.nodes[0]\n+        tip = int(n0.getbestblockhash(), 16)\n+        start_height = self.nodes[0].getblockcount()\n+        # Create invalid block (too high coinbase)\n+        block_time = n0.getblock(n0.getbestblockhash())['time'] + 1\n+        invalid_block = create_block(tip, create_coinbase(start_height+1, nValue=100), block_time)\n+        invalid_block.solve()\n+\n+        block_time += 1\n+        block2 = create_block(invalid_block.sha256, create_coinbase(2), block_time, version=4)\n+        block2.solve()\n+\n+        self.log.info(\"Submit headers-only chain\")\n+        n0.submitheader(invalid_block.serialize().hex())\n+        n0.submitheader(block2.serialize().hex())\n+        tips = n0.getchaintips()\n+        assert_equal(len(tips), 3)\n+        assert_equal(tips[0]['status'], 'headers-only')\n+\n+        self.log.info(\"Submit invalid block that invalidates the headers-only chain\")\n+        n0.submitblock(invalid_block.serialize().hex())\n+        tips = n0.getchaintips()\n+        assert_equal(len(tips), 3)\n+        assert_equal(tips[0]['status'], 'invalid')\n+\n \n if __name__ == '__main__':\n     GetChainTipsTest(__file__).main()\ndiff --git a/test/functional/rpc_invalidateblock.py b/test/functional/rpc_invalidateblock.py\nindex db79d55259007..e2eb033f09c75 100755\n--- a/test/functional/rpc_invalidateblock.py\n+++ b/test/functional/rpc_invalidateblock.py\n@@ -6,6 +6,10 @@\n \n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.address import ADDRESS_BCRT1_UNSPENDABLE_DESCRIPTOR\n+from test_framework.blocktools import (\n+    create_block,\n+    create_coinbase,\n+)\n from test_framework.util import (\n     assert_equal,\n     assert_raises_rpc_error,\n@@ -35,12 +39,33 @@ def run_test(self):\n         self.connect_nodes(0, 1)\n         self.sync_blocks(self.nodes[0:2])\n         assert_equal(self.nodes[0].getblockcount(), 6)\n-        badhash = self.nodes[1].getblockhash(2)\n+\n+        # Add a header to the tip of node 0 without submitting the block. This shouldn't\n+        # affect results since this chain will be invalidated next.\n+        tip = self.nodes[0].getbestblockhash()\n+        block_time = self.nodes[0].getblock(self.nodes[0].getbestblockhash())['time'] + 1\n+        block = create_block(int(tip, 16), create_coinbase(self.nodes[0].getblockcount()), block_time, version=4)\n+        block.solve()\n+        self.nodes[0].submitheader(block.serialize().hex())\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"] + 1)\n \n         self.log.info(\"Invalidate block 2 on node 0 and verify we reorg to node 0's original chain\")\n+        badhash = self.nodes[1].getblockhash(2)\n+        self.nodes[0].invalidateblock(badhash)\n+        assert_equal(self.nodes[0].getblockcount(), 4)\n+        assert_equal(self.nodes[0].getbestblockhash(), besthash_n0)\n+        # Should report consistent blockchain info\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"])\n+\n+        self.log.info(\"Reconsider block 6 on node 0 again and verify that the best header is set correctly\")\n+        self.nodes[0].reconsiderblock(tip)\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"] + 1)\n+\n+        self.log.info(\"Invalidate block 2 on node 0 and verify we reorg to node 0's original chain again\")\n         self.nodes[0].invalidateblock(badhash)\n         assert_equal(self.nodes[0].getblockcount(), 4)\n         assert_equal(self.nodes[0].getbestblockhash(), besthash_n0)\n+        assert_equal(self.nodes[0].getblockchaininfo()[\"headers\"], self.nodes[0].getblockchaininfo()[\"blocks\"])\n \n         self.log.info(\"Make sure we won't reorg to a lower work chain:\")\n         self.connect_nodes(1, 2)\n@@ -83,6 +108,8 @@ def run_test(self):\n         self.nodes[1].reconsiderblock(blocks[-4])\n         # Should be back at the tip by now\n         assert_equal(self.nodes[1].getbestblockhash(), blocks[-1])\n+        # Should report consistent blockchain info\n+        assert_equal(self.nodes[1].getblockchaininfo()[\"headers\"], self.nodes[1].getblockchaininfo()[\"blocks\"])\n \n         self.log.info(\"Verify that invalidating an unknown block throws an error\")\n         assert_raises_rpc_error(-5, \"Block not found\", self.nodes[1].invalidateblock, \"00\" * 32)\n", "problem_statement": "Header inconsistency after invalidate/reconsider block\nDemonstration using regtest.\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 0,\r\n  \"headers\": 0,\r\n```\r\n\r\nMine a block\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 1,\r\n  \"headers\": 1,\r\n```\r\nCall invalidateblock\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 0,\r\n  \"headers\": 0,\r\n# getchaintips\r\n    \"height\": 1,\r\n    \"hash\": \"06702ef73c7d8629294f8b6386646f888d60979932ba2ee45e3495d8f25006b5\",\r\n    \"branchlen\": 1,\r\n    \"status\": \"invalid\"\r\n  },\r\n  {\r\n    \"height\": 0,\r\n    \"hash\": \"0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206\",\r\n    \"branchlen\": 0,\r\n    \"status\": \"active\"\r\n```\r\nCall reconsiderblock\r\n```bash\r\n# getchaintips\r\n    \"height\": 1,\r\n    \"hash\": \"06702ef73c7d8629294f8b6386646f888d60979932ba2ee45e3495d8f25006b5\",\r\n    \"branchlen\": 0,\r\n    \"status\": \"active\"\r\n```\r\n\r\nHeader count returned by getblockchaininfo is now < # of blocks.\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 1,\r\n  \"headers\": 0,\r\n```\n", "hints_text": "Is this a regression?\n> Is this a regression?\r\n\r\nCan recreate the same behaviour with builds of 23.x and 22.x.", "created_at": "2024-08-16 17:36:29", "merge_commit_sha": "85bcfeea23568053ea09013fb8263fa1511d7123", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 14 native, arm64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30588", "base_commit": "1afa3c84fcdcad3b54ec13f29d7957ec1c2b01d0", "patch": "diff --git a/depends/packages/zeromq.mk b/depends/packages/zeromq.mk\nindex 7620df5477727..df018a1032247 100644\n--- a/depends/packages/zeromq.mk\n+++ b/depends/packages/zeromq.mk\n@@ -10,6 +10,7 @@ $(package)_patches += builtin_sha1.patch\n $(package)_patches += fix_have_windows.patch\n $(package)_patches += openbsd_kqueue_headers.patch\n $(package)_patches += cmake_minimum.patch\n+$(package)_patches += cacheline_undefined.patch\n $(package)_patches += no_librt.patch\n \n define $(package)_set_vars\n@@ -25,6 +26,7 @@ define $(package)_preprocess_cmds\n   patch -p1 < $($(package)_patch_dir)/remove_libstd_link.patch && \\\n   patch -p1 < $($(package)_patch_dir)/macos_mktemp_check.patch && \\\n   patch -p1 < $($(package)_patch_dir)/builtin_sha1.patch && \\\n+  patch -p1 < $($(package)_patch_dir)/cacheline_undefined.patch && \\\n   patch -p1 < $($(package)_patch_dir)/fix_have_windows.patch && \\\n   patch -p1 < $($(package)_patch_dir)/openbsd_kqueue_headers.patch && \\\n   patch -p1 < $($(package)_patch_dir)/cmake_minimum.patch && \\\ndiff --git a/depends/patches/zeromq/cacheline_undefined.patch b/depends/patches/zeromq/cacheline_undefined.patch\nnew file mode 100644\nindex 0000000000000..02bd2a5fe5d5a\n--- /dev/null\n+++ b/depends/patches/zeromq/cacheline_undefined.patch\n@@ -0,0 +1,15 @@\n+Use proper STREQUAL instead of EQUAL to compare strings.txt\n+\n+See: https://github.com/zeromq/libzmq/pull/4711.\n+\n+--- a/CMakeLists.txt\n++++ b/CMakeLists.txt\n+@@ -476,7 +476,7 @@ execute_process(\n+ if(CACHELINE_SIZE STREQUAL \"\"\n+    OR CACHELINE_SIZE EQUAL 0\n+    OR CACHELINE_SIZE EQUAL -1\n+-   OR CACHELINE_SIZE EQUAL \"undefined\")\n++   OR CACHELINE_SIZE STREQUAL \"undefined\")\n+   set(ZMQ_CACHELINE_SIZE 64)\n+ else()\n+   set(ZMQ_CACHELINE_SIZE ${CACHELINE_SIZE})\n", "test_patch": "", "problem_statement": "build: Native ./depends build fails on s390x\nSteps to reproduce on a fresh s390x machine:\r\n\r\n```\r\nmake NO_QT=1 NO_WALLET=1 NO_UPNP=1 NO_NATPMP=1 -j $(nproc)\r\n```\r\n\r\n(Cross-compilation to s390x works)\r\n\r\n\r\nOutput:\r\n\r\n```\r\nBuilding zeromq...\r\nmake[1]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[2]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\n[  1%] Building CXX object CMakeFiles/objects.dir/src/address.cpp.o\r\nIn file included from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/precompiled.hpp:16,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/address.cpp:3:\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/platform.hpp:22:28: error: 'undefined' was not declared in this scope\r\n   22 | #define ZMQ_CACHELINE_SIZE undefined\r\n      |                            ^~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/command.hpp:191:26: note: in expansion of macro 'ZMQ_CACHELINE_SIZE'\r\n  191 | __attribute__ ((aligned (ZMQ_CACHELINE_SIZE)))\r\n      |                          ^~~~~~~~~~~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/platform.hpp:22:28: error: 'undefined' was not declared in this scope\r\n   22 | #define ZMQ_CACHELINE_SIZE undefined\r\n      |                            ^~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/yqueue.hpp:34:45: note: in expansion of macro 'ZMQ_CACHELINE_SIZE'\r\n   34 | template <typename T, int N, size_t ALIGN = ZMQ_CACHELINE_SIZE> class yqueue_t\r\n      |                                             ^~~~~~~~~~~~~~~~~~\r\nIn file included from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/mailbox.hpp:12,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ctx.hpp:11,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/address.cpp:6:\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:155:18: error: template argument 3 is invalid\r\n  155 |     yqueue_t<T, N> _queue;\r\n      |                  ^\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In constructor 'zmq::ypipe_t<T, N>::ypipe_t()':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:26:16: error: request for member 'push' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   26 |         _queue.push ();\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:30:32: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   30 |         _r = _w = _f = &_queue.back ();\r\n      |                                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:31:25: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   31 |         _c.set (&_queue.back ());\r\n      |                         ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'void zmq::ypipe_t<T, N>::write(const T&, bool)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:50:16: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   50 |         _queue.back () = value_;\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:51:16: error: request for member 'push' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   51 |         _queue.push ();\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:55:26: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   55 |             _f = &_queue.back ();\r\n      |                          ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::unwrite(T*)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:66:27: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   66 |         if (_f == &_queue.back ())\r\n      |                           ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:68:16: error: request for member 'unpush' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   68 |         _queue.unpush ();\r\n      |                ^~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:69:26: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   69 |         *value_ = _queue.back ();\r\n      |                          ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::check_read()':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:104:21: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  104 |         if (&_queue.front () != _r && _r)\r\n      |                     ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:111:30: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  111 |         _r = _c.cas (&_queue.front (), NULL);\r\n      |                              ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:117:21: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  117 |         if (&_queue.front () == _r || !_r)\r\n      |                     ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::read(T*)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:134:26: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  134 |         *value_ = _queue.front ();\r\n      |                          ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:135:16: error: request for member 'pop' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  135 |         _queue.pop ();\r\n      |                ^~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::probe(bool (*)(const T&))':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:147:31: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  147 |         return (*fn_) (_queue.front ());\r\n      |                               ^~~~~\r\nAt global scope:\r\ncc1plus: note: unrecognized command-line option '-Wno-tautological-constant-compare' may have been intended to silence earlier diagnostics\r\nmake[3]: *** [CMakeFiles/objects.dir/build.make:90: CMakeFiles/objects.dir/src/address.cpp.o] Error 1\r\nmake[3]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[2]: *** [CMakeFiles/Makefile2:88: CMakeFiles/objects.dir/all] Error 2\r\nmake[2]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[1]: *** [Makefile:136: all] Error 2\r\nmake[1]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake: *** [funcs.mk:301: /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/.stamp_built] Error 2\r\n```\r\n\r\n\n", "hints_text": "", "created_at": "2024-08-05 12:47:37", "merge_commit_sha": "43740f4971f45cd5499470b6a085b3ecd8b96d28", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30435", "base_commit": "4d6af61d879914a660e73db5c2f2e6c4d0aa8243", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e4b65fbfa94f6..03969b00bb661 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -296,10 +296,11 @@ void Shutdown(NodeContext& node)\n \n     StopTorControl();\n \n+    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n     // After everything has been shut down, but before things get flushed, stop the\n-    // scheduler and load block thread.\n+    // the scheduler. After this point, SyncWithValidationInterfaceQueue() should not be called anymore\n+    // as this would prevent the shutdown from completing.\n     if (node.scheduler) node.scheduler->stop();\n-    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n \n     // After the threads that potentially access these pointers have been stopped,\n     // destruct and reset all to nullptr.\n", "test_patch": "", "problem_statement": "Shutdown during reindex-chainstate can block forever\nDuring `Shutdown`, we stop the scheduler before waiting on the load-block thread. But the load-block thread can call `LimitValidationInterfaceQueue` via `ActivateBestChain`. `LimitValidationInterfaceQueue` then schedules a dummy call and waits for it. But since the scheduler has stopped, it never gets there, and blocks forever. Shutdown remains joined to the thread, and also never exits.\r\n\r\nCan we just wait for the load-block thread before killing the scheduler?\n", "hints_text": "I've observed such behavior but did not notice the reasons.\r\n\r\nThanks @luke-jr!\nI had what I think was a similar issue (scriptcheck thread hanging, waiting on `SyncWithValidationInterfaceQueue` to complete). I found the changing `SyncWithValidationInterfaceQueue` to be:\r\n\r\n```c++\r\nvoid SyncWithValidationInterfaceQueue()\r\n{\r\n    AssertLockNotHeld(cs_main);\r\n    // Block until the validation queue drains\r\n    auto promise = std::make_shared<std::promise<void>>();\r\n    CallFunctionInValidationInterfaceQueue([promise] {\r\n        promise->set_value();\r\n    });\r\n    std::future_status status;\r\n    do {\r\n        status = promise->get_future().wait_for(10s);\r\n    } while (status != std::future_status::ready); // && !ShutdownRequested());\r\n}\r\n```\r\n\r\nfixed my problem. In particular, `Shutdown()` calls `scheduler->stop()` before `StopScriptCheckWorkerThreads()` which gives a deadlock: scheduler is stopped, but worker threads can't complete because they're waiting for the scheduler to finish off the promise. Just having the scriptcheck threads exit early isn't enough, because after the scriptcheck threads have finished `FlushBackgroundCallbacks()` is called which does the `promise->set_value()` above, so `promise` still needs to exist, hence making it a `shared_ptr`.\nI also experienced this issue - my bitcoind hanged and when I dumped the running threads, it was waiting on `LimitValidationInterfaceQueue` but the scheduler thread had already exited. I did not have `reindex-chainstate` enabled. I think this can happen in any situation where the callbacks aren't cleared quickly enough and `SyncWithValidationInterfaceQueue` is called.", "created_at": "2024-07-12 05:21:12", "merge_commit_sha": "1d24d383b45ec54b65da2c9ea86554f45a8f1b06", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30404", "base_commit": "bd5d1688b4311e21c0e0ff89a3ae02ef7d0543b8", "patch": "diff --git a/src/node/warnings.cpp b/src/node/warnings.cpp\nindex b99c845900abf..87389e472b934 100644\n--- a/src/node/warnings.cpp\n+++ b/src/node/warnings.cpp\n@@ -28,8 +28,7 @@ Warnings::Warnings()\n }\n bool Warnings::Set(warning_type id, bilingual_str message)\n {\n-    LOCK(m_mutex);\n-    const auto& [_, inserted]{m_warnings.insert({id, std::move(message)})};\n+    const auto& [_, inserted]{WITH_LOCK(m_mutex, return m_warnings.insert({id, std::move(message)}))};\n     if (inserted) uiInterface.NotifyAlertChanged();\n     return inserted;\n }\n", "test_patch": "", "problem_statement": "Double lock detected in `Warnings::GetMessages()`\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nRunning `bitcoin-qt -testnet` results in it eventually deadlocking due to a double lock in the warnings code.\n\n### Expected behaviour\n\nShould not double lock.\n\n### Steps to reproduce\n\n1. Build with `--enable-debug` (or define `DEBUG_LOCKORDER`\r\n2. Run `bitcoin-qt -testnet`, and either sync or reindex\r\n3. It will assert and crash on its own (without `DEBUG_LOCKORDER`, it will eventually hang)\n\n### Relevant log output\n\n\r\n```\r\n2024-07-05T23:22:12.212000Z [scheduler] [../../../src/qt/bitcoin.cpp:215] [DebugMessageHandler] [qt] GUI: ClientModel: NotifyAlertChanged\r\n2024-07-05T23:22:12.212029Z [scheduler] [../../../src/sync.cpp:129] [double_lock_detected] DOUBLE LOCK DETECTED\r\n2024-07-05T23:22:12.212052Z [scheduler] [../../../src/sync.cpp:130] [double_lock_detected] Lock order:\r\n2024-07-05T23:22:12.212072Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:31 (in thread 'scheduler')\r\n2024-07-05T23:22:12.212092Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler')\r\nAssertion failed: detected double lock for 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler'), details in debug log.\r\n```\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nbd5d1688b4311e21c0e0ff89a3ae02ef7d0543b8\n\n### Operating system and version\n\nArch\n\n### Machine specifications\n\n_No response_\n", "hints_text": "cc @stickies-v as you were the last to touch the warnings code.", "created_at": "2024-07-06 22:15:15", "merge_commit_sha": "a83f050dbe1392fc6b1b6c2a140c7346653b40d3", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30147", "base_commit": "323b0acfcb9380ce4b3c12a3d0b341d7bb3bfe08", "patch": "diff --git a/contrib/verify-binaries/README.md b/contrib/verify-binaries/README.md\nindex 04d683e69b559..0f3e16a5bc9d3 100644\n--- a/contrib/verify-binaries/README.md\n+++ b/contrib/verify-binaries/README.md\n@@ -50,6 +50,7 @@ Get JSON output and don't prompt for user input (no auto key import):\n \n ```sh\n ./contrib/verify-binaries/verify.py --json pub 22.0-x86\n+./contrib/verify-binaries/verify.py --json pub 23.0-rc5-linux-gnu\n ```\n \n Rely only on local GPG state and manually specified keys, while requiring a\n@@ -57,14 +58,15 @@ threshold of at least 10 trusted signatures:\n ```sh\n ./contrib/verify-binaries/verify.py \\\n     --trusted-keys 74E2DEF5D77260B98BC19438099BAD163C70FBFA,9D3CC86A72F8494342EA5FD10A41BDC3F4FAFF1C \\\n-    --min-good-sigs 10 pub 22.0-x86\n+    --min-good-sigs 10 pub 22.0-linux\n ```\n \n-If you only want to download the binaries for a certain platform, add the corresponding suffix, e.g.:\n+If you only want to download the binaries for a certain architecture and/or platform, add the corresponding suffix, e.g.:\n \n ```sh\n-./contrib/verify-binaries/verify.py pub 24.0.1-darwin\n-./contrib/verify-binaries/verify.py pub 23.1-rc1-win64\n+./contrib/verify-binaries/verify.py pub 25.2-x86_64-linux\n+./contrib/verify-binaries/verify.py pub 24.1-rc1-darwin\n+./contrib/verify-binaries/verify.py pub 27.0-win64-setup.exe\n ```\n \n If you do not want to keep the downloaded binaries, specify the cleanup option.\ndiff --git a/contrib/verify-binaries/verify.py b/contrib/verify-binaries/verify.py\nindex 12e6e10d8a4de..6c07b36c9d8cd 100755\n--- a/contrib/verify-binaries/verify.py\n+++ b/contrib/verify-binaries/verify.py\n@@ -97,23 +97,17 @@ def bool_from_env(key, default=False) -> bool:\n \n \n VERSION_FORMAT = \"<major>.<minor>[.<patch>][-rc[0-9]][-platform]\"\n-VERSION_EXAMPLE = \"22.0-x86_64 or 23.1-rc1-darwin\"\n+VERSION_EXAMPLE = \"22.0 or 23.1-rc1-darwin.dmg or 27.0-x86_64-linux-gnu\"\n \n def parse_version_string(version_str):\n-    parts = version_str.split('-')\n-    version_base = parts[0]\n-    version_rc = \"\"\n-    version_os = \"\"\n-    if len(parts) == 2:  # \"<version>-rcN\" or \"version-platform\"\n-        if \"rc\" in parts[1]:\n-            version_rc = parts[1]\n-        else:\n-            version_os = parts[1]\n-    elif len(parts) == 3:  # \"<version>-rcN-platform\"\n-        version_rc = parts[1]\n-        version_os = parts[2]\n+    # \"<version>[-rcN][-platform]\"\n+    version_base, _, platform = version_str.partition('-')\n+    rc = \"\"\n+    if platform.startswith(\"rc\"): # \"<version>-rcN[-platform]\"\n+        rc, _, platform = platform.partition('-')\n+    # else \"<version>\" or \"<version>-platform\"\n \n-    return version_base, version_rc, version_os\n+    return version_base, rc, platform\n \n \n def download_with_wget(remote_file, local_file):\n@@ -514,7 +508,9 @@ def cleanup():\n     # Extract hashes and filenames\n     hashes_to_verify = parse_sums_file(SUMS_FILENAME, [os_filter])\n     if not hashes_to_verify:\n-        log.error(\"no files matched the platform specified\")\n+        available_versions = [\"-\".join(line[1].split(\"-\")[2:]) for line in parse_sums_file(SUMS_FILENAME, [])]\n+        closest_match = difflib.get_close_matches(os_filter, available_versions, cutoff=0, n=1)[0]\n+        log.error(f\"No files matched the platform specified. Did you mean: {closest_match}\")\n         return ReturnCode.NO_BINARIES_MATCH\n \n     # remove binaries that are known not to be hosted by bitcoincore.org\n", "test_patch": "diff --git a/contrib/verify-binaries/test.py b/contrib/verify-binaries/test.py\nindex 22d718ece334a..875606ec22678 100755\n--- a/contrib/verify-binaries/test.py\n+++ b/contrib/verify-binaries/test.py\n@@ -12,6 +12,21 @@ def main():\n     expect_code(run_verify(\"\", \"pub\", '0.32.awefa.12f9h'), 11, \"Malformed version should fail\")\n     expect_code(run_verify('--min-good-sigs 20', \"pub\", \"22.0\"), 9, \"--min-good-sigs 20 should fail\")\n \n+    print(\"- testing verification (22.0-x86_64-linux-gnu.tar.gz)\", flush=True)\n+    _220_x86_64_linux_gnu = run_verify(\"--json\", \"pub\", \"22.0-x86_64-linux-gnu.tar.gz\")\n+    try:\n+        result = json.loads(_220_x86_64_linux_gnu.stdout.decode())\n+    except Exception:\n+        print(\"failed on 22.0-x86_64-linux-gnu.tar.gz --json:\")\n+        print_process_failure(_220_x86_64_linux_gnu)\n+        raise\n+\n+    expect_code(_220_x86_64_linux_gnu, 0, \"22.0-x86_64-linux-gnu.tar.gz should succeed\")\n+    v = result['verified_binaries']\n+    assert result['good_trusted_sigs']\n+    assert len(v) == 1\n+    assert v['bitcoin-22.0-x86_64-linux-gnu.tar.gz'] == '59ebd25dd82a51638b7a6bb914586201e67db67b919b2a1ff08925a7936d1b16'\n+\n     print(\"- testing verification (22.0)\", flush=True)\n     _220 = run_verify(\"--json\", \"pub\", \"22.0\")\n     try:\n", "problem_statement": "bug: verify-binaries/verify.py incorrectly parses version string; gives error or downloads wrong files\n### Current behaviour\r\n\r\nWhen I run:\r\n`./verify.py pub 27.0-x86_64-linux-gnu` instead of downloading the version I told it, it downloads every version in the SHA256SUMS file starting with the first.\r\n\r\nThe `version_os` and (also `version_rc`) are completely ignored which causes wrong files to download when an -rcN is intended.\r\n\r\nWhen I attempt to work around and give it a 1 dash string such as\r\n`./verify.py pub 27.0-x86_64` it will start with bitcoin-27.0-x86_64-apple-darwin which is not useful if I only needed bitcoin-27.0-x86_64-linux-gnu.\r\n\r\nUpdate: it will also parse `\"27.0-aarch64\"` wrong. Setting `rc_version=\"aarch64\"` which causes no file found errors. But this is a valid string.\r\n\r\n### Expected behaviour\r\n\r\nI expected it to only download bitcoin-27.0-x86_64-linux-gnu.tar.gz when I run `./verify.py pub 27.0-x86_64-linux-gnu`.\r\nI expected `rc_version` to be set to the `-rcN` release candidate number as per the comments and documentation.\r\n\r\n### Steps to reproduce\r\n\r\nFollow the instructions in the README.md \r\n> If you only want to download the binaries for a certain platform, add the corresponding suffix, e.g.:\r\n\r\nBut instead of the examples, give it a platform suffix with any dashes and it will ignore the requested platform.\r\nOr give \"<version>-aarch64\" and aarch64 it will be interpreted as a release candidate number causing errors.\r\n\r\n### Relevant log output\r\n\r\n```\r\n./verify.py pub 27.0-x86_64-linux-gnu\r\n[INFO] got file https://bitcoincore.org/bin/bitcoin-core-27.0/SHA256SUMS.asc as SHA256SUMS.asc\r\n[WARNING] https://bitcoin.org failed to provide file (https://bitcoin.org/bin/bitcoin-core-27.0/SHA256SUMS.asc). Continuing based solely upon https://bitcoincore.org.\r\n[INFO] got file https://bitcoincore.org/bin/bitcoin-core-27.0/SHA256SUMS as SHA256SUMS\r\n[WARNING] https://bitcoin.org failed to provide file (https://bitcoin.org/bin/bitcoin-core-27.0/SHA256SUMS). Continuing based solely upon https://bitcoincore.org.\r\n[INFO] got 3 good signatures\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('1E4AED62986CD25D', 'Wladimir J. van der Laan <laanwj@protonmail.com>', trusted=False, status='')\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('17565732E08E5E41', 'Ava Chow <me@achow101.com>', trusted=False, status='')\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('3152347D07DA627C', 'Stephan Oeste (it) <it@oeste.de>', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('410108112E7EA81F', 'hebasto@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('C2371D91CB716EA7', 'sebastian.falbesoner@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('E7E2984B6289C93A', 'pinheadmz@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('2EEB9F5CC09526C1', 'fanquake@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('F62711DBDCA8AE56', 'kvaciral@protonmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('57FF9BDBCC301009', '', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('8E4256593F177720', 'gugger@gmail.com', trusted=False, status='')\r\n[INFO] removing *-unsigned binaries (bitcoin-27.0-arm64-apple-darwin-unsigned.tar.gz, bitcoin-27.0-arm64-apple-darwin-unsigned.zip, bitcoin-27.0-x86_64-apple-darwin-unsigned.tar.gz, bitcoin-27.0-x86_64-apple-darwin-unsigned.zip, bitcoin-27.0-win64-setup-unsigned.exe, bitcoin-27.0-win64-unsigned.tar.gz) from verification since https://bitcoincore.org does not host *-unsigned binaries\r\n[INFO] removing *-debug binaries (bitcoin-27.0-aarch64-linux-gnu-debug.tar.gz, bitcoin-27.0-arm-linux-gnueabihf-debug.tar.gz, bitcoin-27.0-powerpc64-linux-gnu-debug.tar.gz, bitcoin-27.0-powerpc64le-linux-gnu-debug.tar.gz, bitcoin-27.0-riscv64-linux-gnu-debug.tar.gz, bitcoin-27.0-x86_64-linux-gnu-debug.tar.gz, bitcoin-27.0-win64-debug.zip) from verification since https://bitcoincore.org does not host *-debug binaries\r\n[INFO] removing *-codesignatures binaries (bitcoin-27.0-codesignatures-27.0.tar.gz) from verification since https://bitcoincore.org does not host *-codesignatures binaries\r\n[INFO] downloading bitcoin-27.0-aarch64-linux-gnu.tar.gz to /tmp/bitcoin_verify_binaries.27.0-x86_64-linux-gnu\r\n```\r\n\r\n```\r\namnesia@amnesia:~/.local/share/bitcoin-core$ ./verify.py pub 27.0-aarch64\r\n[ERROR] couldn't fetch file (https://bitcoincore.org/bin/bitcoin-core-27.0/test.aarch64/SHA256SUMS.asc). Have you specified the version number in the following format?\r\n<major>.<minor>[.<patch>][-rc[0-9]][-platform] (example: 22.0-x86_64 or 23.1-rc1-darwin)\r\nwget output:\r\n  --2024-05-21 12:28:08--  https://bitcoincore.org/bin/bitcoin-core-27.0/test.aarch64/SHA256SUMS.asc\r\n  Resolving bitcoincore.org (bitcoincore.org)... 198.251.83.116\r\n  Connecting to bitcoincore.org (bitcoincore.org)|198.251.83.116|:443... connected.\r\n  HTTP request sent, awaiting response... 404 Not Found\r\n  2024-05-21 12:28:14 ERROR 404: Not Found.\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\ngit clone\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nmaster / 27.0\r\n\r\n### Operating system and version\r\n\r\nDebian 12\r\n\r\n### Machine specifications\r\n\r\nVM, 4GB RAM, virtIO SSD, wired\n", "hints_text": "I would like to be assigned to this issue and will send a PR in an hour.", "created_at": "2024-05-21 17:18:00", "merge_commit_sha": "2cd7c6bd939e4e37b00b5b822b62eb933f720dc6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30065", "base_commit": "d661e2b1b771abafb0b152842d775d3150032230", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e60feecf108be..3c4b72d3e4ffe 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -147,11 +147,12 @@ static constexpr bool DEFAULT_STOPAFTERBLOCKIMPORT{false};\n // Win32 LevelDB doesn't use filedescriptors, and the ones used for\n // accessing block files don't count towards the fd_set size limit\n // anyway.\n-#define MIN_CORE_FILEDESCRIPTORS 0\n+#define MIN_LEVELDB_FDS 0\n #else\n-#define MIN_CORE_FILEDESCRIPTORS 150\n+#define MIN_LEVELDB_FDS 150\n #endif\n \n+static constexpr int MIN_CORE_FDS = MIN_LEVELDB_FDS + NUM_FDS_MESSAGE_CAPTURE;\n static const char* DEFAULT_ASMAP_FILENAME=\"ip_asn.map\";\n \n /**\n@@ -834,8 +835,7 @@ void InitLogging(const ArgsManager& args)\n namespace { // Variables internal to initialization process only\n \n int nMaxConnections;\n-int nUserMaxConnections;\n-int nFD;\n+int available_fds;\n ServiceFlags nLocalServices = ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);\n int64_t peer_connect_timeout;\n std::set<BlockFilterType> g_enabled_filter_types;\n@@ -987,27 +987,33 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"Cannot set -listen=0 together with -listenonion=1\"));\n     }\n \n-    // Make sure enough file descriptors are available\n-    int nBind = std::max(nUserBind, size_t(1));\n-    nUserMaxConnections = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n-    nMaxConnections = std::max(nUserMaxConnections, 0);\n-\n-    nFD = RaiseFileDescriptorLimit(nMaxConnections + MIN_CORE_FILEDESCRIPTORS + MAX_ADDNODE_CONNECTIONS + nBind + NUM_FDS_MESSAGE_CAPTURE);\n+    // Make sure enough file descriptors are available. We need to reserve enough FDs to account for the bare minimum,\n+    // plus all manual connections and all bound interfaces. Any remainder will be available for connection sockets\n \n-#ifdef USE_POLL\n-    int fd_max = nFD;\n-#else\n-    int fd_max = FD_SETSIZE;\n+    // Number of bound interfaces (we have at least one)\n+    int nBind = std::max(nUserBind, size_t(1));\n+    // Maximum number of connections with other nodes, this accounts for all types of outbounds and inbounds except for manual\n+    int user_max_connection = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n+    if (user_max_connection < 0) {\n+        return InitError(Untranslated(\"-maxconnections must be greater or equal than zero\"));\n+    }\n+    // Reserve enough FDs to account for the bare minimum, plus any manual connections, plus the bound interfaces\n+    int min_required_fds = MIN_CORE_FDS + MAX_ADDNODE_CONNECTIONS + nBind;\n+\n+    // Try raising the FD limit to what we need (available_fds may be smaller than the requested amount if this fails)\n+    available_fds = RaiseFileDescriptorLimit(user_max_connection + min_required_fds);\n+    // If we are using select instead of poll, our actual limit may be even smaller\n+#ifndef USE_POLL\n+    available_fds = std::min(FD_SETSIZE, available_fds);\n #endif\n+    if (available_fds < min_required_fds)\n+        return InitError(strprintf(_(\"Not enough file descriptors available. %d available, %d required.\"), available_fds, min_required_fds));\n+\n     // Trim requested connection counts, to fit into system limitations\n-    // <int> in std::min<int>(...) to work around FreeBSD compilation issue described in #2695\n-    nMaxConnections = std::max(std::min<int>(nMaxConnections, fd_max - nBind - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE), 0);\n-    if (nFD < MIN_CORE_FILEDESCRIPTORS)\n-        return InitError(_(\"Not enough file descriptors available.\"));\n-    nMaxConnections = std::min(nFD - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE, nMaxConnections);\n+    nMaxConnections = std::min(available_fds - min_required_fds, user_max_connection);\n \n-    if (nMaxConnections < nUserMaxConnections)\n-        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), nUserMaxConnections, nMaxConnections));\n+    if (nMaxConnections < user_max_connection)\n+        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), user_max_connection, nMaxConnections));\n \n     // ********************************************************* Step 3: parameter-to-internal-flags\n     if (auto result{init::SetLoggingCategories(args)}; !result) return InitError(util::ErrorString(result));\n@@ -1155,7 +1161,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         return false;\n     }\n \n-    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, nFD);\n+    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, available_fds);\n \n     // Warn about relative -datadir path.\n     if (args.IsArgSet(\"-datadir\") && !args.GetPathArg(\"-datadir\").is_absolute()) {\n", "test_patch": "", "problem_statement": "Improve minimum file descriptor accounting and documentation\n#16003 has been closed, and I've pulled out the unrelated p2p change. However I think it's worth someone following up and taking a look at our startup file descriptor accounting. \r\n\r\nAs mentioned in #16003, if `bitcoind` is started somewhere that the maximum number of open file descriptors is limited, we can run into some nonsensical behaviour. Such as a \"negative\" number of maximum connections:\r\n\r\n```bash\r\n# using bash\r\nulimit -n 150\r\nsrc/bitcoind\r\n[init] Using at most -8 automatic connections (150 file descriptors available)\r\n```\r\n\r\nIt's also impossible to shutdown `bitcoind` from this state as the `opencon` thread will never exit.\r\n\r\nIt would be good for someone to look through this code, document assumptions, and fix issues like the above.\r\n\r\nYou do not need to request permission to start working on this. You are encouraged to comment on the issue if you are planning to work on it. This will help other contributors monitor which issues are actively being addressed and is also an effective way to request assistance if and when you need it.\r\n\r\nFor guidance on contributing, please read [CONTRIBUTING.md](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md) before opening your pull request.\r\n\n", "hints_text": "Hii @fanquake  I would like to be assigned to work on this issue as my first contribution to bitcoin-core.\r\n\r\nThanks.\r\n\r\nEdit : Started working on this :) \nThanks @MrSquanchee!\r\n\r\nI've added most of my thoughts on this in the closed issue above. As of now, the FD counts are pretty much hardcoded in, and I think it would be nice to get away from that in a modular way if we want things like a configurable number of inbound/outbound/feeler connections, lots of RPC threads, FDs used by future changes that will have possibly missed modifying the initial FD count, etc. \r\n\r\nThere's also the concept of \"soft limits\" of FDs, which is currently implemented in a way that reduces the possible maximum of 125 inbound connections when we allocate them to *some* other stuff, but I think this \"soft limit\" should be applied to the maximum number of FDs available to the process. This would be nice, as most Linux distros give you 1024 FDs, which would allow for much more varied configurations and eliminate the need to reduce the 125 inbound count.\r\n\r\nThere's also an assumption that every system will use the same count, which I'm not sure will be true in the future, or is true now (I didn't really have a large enough test bed of OSes when I opened the issue, which was kind of discouraging). Something that actually measures the number of FDs open by the process might also be helpful, instead of assuming we've measured correctly.\r\n\r\nWith that in mind, something that tells us the number of required, requested, and allocated FDs on startup would be informative. Similar to what I had in the closed issue, which is what causes the bug above (the allocated number of FDs returned gets reduced lower than the required number of FDs). So if we don't get our requested amount, we can *possibly* revamp our counts in such a way that we still meet the required amount. \r\n\r\nOn another note: arbitrarily changing FD counts to critical things is not a solution in my mind, but in support of more robust configs, there's at least some bigger nodes that need to vary these counts, and probably a sane minimum we can use for most stuff (current values could be a sane minimum and default maximum for some things, ie. feeler connections).\nAlso, don't hesitate to pick our brains in #bitcoin-core-dev on freenode or pm me on there! :)\nThere is no formal assignment process on Bitcoin Core @MrSquanchee so we can't stop somebody else from working on it if they want to. But it is helpful to know you are working on it.\nHii Guys, Thanks for reminding me about this. I have been a bit busy. I would not mind if anyone else would want to work on this Issue.\r\nMight start working on bitcoin later :)\nIf anyone is looking for somewhere to get started, I've cleaned up the file descriptor code in `init.cpp` a little [here](https://github.com/troygiorshev/bitcoin/commit/d9e1c1e83afc29782e26c1ae020539dc15444f75).\n> If anyone is looking for somewhere to get started, I've cleaned up the file descriptor code in `init.cpp` a little [here](https://github.com/troygiorshev/bitcoin/commit/d9e1c1e83afc29782e26c1ae020539dc15444f75).\r\n\r\nI've also taken the liberty to meddle with this: here's a [branch](https://github.com/NelsonFrancisco/bitcoin/compare/master...NelsonFrancisco:n2021-31-03-fd)\r\n\r\nMade a branch with a \"sanitizing\" of this code before trying to achieve the issue here. I found the \"nMaxConnections\" variable value to be really hard to track, so I've thrown an error, if -maxconnections is less than 0, and used a temporary variable before finally defining nMaxConnections. So, I believe I changed no behavior besides the error throwing.\r\n\r\nI believe also, that \"AppInitParameterInteraction\" should be divided into several functions. It simply does too much, IMO. Maybe in a separated commit, what do you think?\r\n\r\nSo, for the problem in itself: is it possible for the nMaxConnections variable to get a negative value? What's the best approach to solve this? Change the following calculation `nFD - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE` ?\nIs anyone working on this? I am very new to open source and would like to start networking :)\r\n\nIn addition to improving fd planning, I wonder if we should have all our fd allocations check if they exceed our known limitations, and if so, close the new fd, kill a random p2p socket, and try again?", "created_at": "2024-05-08 19:47:35", "merge_commit_sha": "2756797ecaf07b1a39645282e879bc70890e3f0b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-29985", "base_commit": "a46065e36cf868265c909dc5edf29dc17be53c1f", "patch": "diff --git a/depends/packages/qt.mk b/depends/packages/qt.mk\nindex 0acf4cf565504..d057b2d410a18 100644\n--- a/depends/packages/qt.mk\n+++ b/depends/packages/qt.mk\n@@ -22,6 +22,7 @@ $(package)_patches += fix-macos-linker.patch\n $(package)_patches += memory_resource.patch\n $(package)_patches += utc_from_string_no_optimize.patch\n $(package)_patches += windows_lto.patch\n+$(package)_patches += zlib-timebits64.patch\n \n $(package)_qttranslations_file_name=qttranslations-$($(package)_suffix)\n $(package)_qttranslations_sha256_hash=24d4c58bc2a40c0f44f59ee64af4192c7d0038c1e45af61646cfc5b65058f271\n@@ -251,6 +252,7 @@ define $(package)_preprocess_cmds\n   patch -p1 -i $($(package)_patch_dir)/utc_from_string_no_optimize.patch && \\\n   patch -p1 -i $($(package)_patch_dir)/guix_cross_lib_path.patch && \\\n   patch -p1 -i $($(package)_patch_dir)/windows_lto.patch && \\\n+  patch -p1 -i $($(package)_patch_dir)/zlib-timebits64.patch && \\\n   mkdir -p qtbase/mkspecs/macx-clang-linux &&\\\n   cp -f qtbase/mkspecs/macx-clang/qplatformdefs.h qtbase/mkspecs/macx-clang-linux/ &&\\\n   cp -f $($(package)_patch_dir)/mac-qmake.conf qtbase/mkspecs/macx-clang-linux/qmake.conf && \\\ndiff --git a/depends/patches/qt/zlib-timebits64.patch b/depends/patches/qt/zlib-timebits64.patch\nnew file mode 100644\nindex 0000000000000..139c1dfa77f3e\n--- /dev/null\n+++ b/depends/patches/qt/zlib-timebits64.patch\n@@ -0,0 +1,31 @@\n+From a566e156b3fa07b566ddbf6801b517a9dba04fa3 Mon Sep 17 00:00:00 2001\n+From: Mark Adler <madler@alumni.caltech.edu>\n+Date: Sat, 29 Jul 2023 22:13:09 -0700\n+Subject: [PATCH] Avoid compiler complaints if _TIME_BITS defined when building\n+ zlib.\n+\n+zlib does not use time_t, so _TIME_BITS is irrelevant. However it\n+may be defined anyway as part of a sledgehammer indiscriminately\n+applied to all builds.\n+\n+From https://github.com/madler/zlib/commit/a566e156b3fa07b566ddbf6801b517a9dba04fa3.patch\n+---\n+ qtbase/src/3rdparty/zlib/src/gzguts.h | 5 ++---\n+ 1 file changed, 2 insertions(+), 3 deletions(-)\n+\n+diff --git a/qtbase/src/3rdparty/zlib/src/gzguts.h b/qtbase/src/3rdparty/zlib/src/gzguts.h\n+index e23f831f5..f9375047e 100644\n+--- a/qtbase/src/3rdparty/zlib/src/gzguts.h\n++++ b/qtbase/src/3rdparty/zlib/src/gzguts.h\n+@@ -26,9 +26,8 @@\n+ #  ifndef _LARGEFILE_SOURCE\n+ #    define _LARGEFILE_SOURCE 1\n+ #  endif\n+-#  ifdef _FILE_OFFSET_BITS\n+-#    undef _FILE_OFFSET_BITS\n+-#  endif\n++#  undef _FILE_OFFSET_BITS\n++#  undef _TIME_BITS\n+ #endif\n+ \n+ #ifdef HAVE_HIDDEN\n", "test_patch": "", "problem_statement": "depends: Cross-compiling `qt` for `arm-linux-gnueabihf` fails\nOn Ubuntu 24.04 with glibc 2.39:\r\n```\r\ncompiling ../3rdparty/zlib/src/gzclose.c\r\nIn file included from /usr/arm-linux-gnueabihf/include/features.h:394,\r\n                 from /usr/arm-linux-gnueabihf/include/bits/libc-header-start.h:33,\r\n                 from /usr/arm-linux-gnueabihf/include/stdio.h:28,\r\n                 from ../3rdparty/zlib/src/gzguts.h:40,\r\n                 from ../3rdparty/zlib/src/gzclose.c:6:\r\n/usr/arm-linux-gnueabihf/include/features-time64.h:26:5: error: #error \"_TIME_BITS=64 is allowed only with _FILE_OFFSET_BITS=64\"\r\n   26 | #   error \"_TIME_BITS=64 is allowed only with _FILE_OFFSET_BITS=64\"\r\n      |     ^~~~~\r\n```\r\n\r\nSome similar issues in https://bugreports.qt.io suggest to switch from the builtin `zlib` to a system one. But that doesn't look like an option for us.\n", "hints_text": "This is caused by the 32 to 64 bit time_t transition (for the 2038 epoch problem). It will affect all 32-bit Linux systems.\r\n\r\nI would guess solving this requires a minimal patch to the zlib inside Qt to make the right combination of defines. i'll take a look at it.", "created_at": "2024-04-28 11:42:13", "merge_commit_sha": "ad42d63519839b5751db0f294b5de7cfdc332e61", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-29850", "base_commit": "3f6a6da3b08da15c10cbf2806f672da4a57254f6", "patch": "diff --git a/src/net.cpp b/src/net.cpp\nindex e388f05b037ad..3e959c187c2c7 100644\n--- a/src/net.cpp\n+++ b/src/net.cpp\n@@ -2256,7 +2256,11 @@ void CConnman::ThreadDNSAddressSeed()\n             if (!resolveSource.SetInternal(host)) {\n                 continue;\n             }\n-            unsigned int nMaxIPs = 256; // Limits number of IPs learned from a DNS seed\n+            // Limit number of IPs learned from a single DNS seed. This limit exists to prevent the results from\n+            // one DNS seed from dominating AddrMan. Note that the number of results from a UDP DNS query is\n+            // bounded to 33 already, but it is possible for it to use TCP where a larger number of results can be\n+            // returned.\n+            unsigned int nMaxIPs = 32;\n             const auto addresses{LookupHost(host, nMaxIPs, true)};\n             if (!addresses.empty()) {\n                 for (const CNetAddr& ip : addresses) {\n", "test_patch": "", "problem_statement": "Decreasing nMaxIPs when learning from DNS seeds\nCurrently, our `nMaxIPs` when learning from DNS seeds is 256. @TheBlueMatt pointed out to me that if one of the seeds decided to actually return that many addresses, it would bias the addresses we add to `AddrMan` and consequently choose as our initial outbound peers. A quick `drill -t` of all the current seeds show that none yielded more than 26 results, meaning that if any of the seeds decided to return all 256 results (perhaps malicious ones), results from that seed would take over more than half of `AddrMan`.\r\n\r\nIf there were no TCP-fallback, this wouldn't be too much of a problem as at maximum we could fit around 31 IPs in a UDP packet. However, it seems that `glibc` [uses the TCP-fallback](https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1811471) by default, which would mean that obtaining 256 IPs is entirely possible.\n", "hints_text": "wrote a little python 3 script that will list number of answers with the same `getaddrinfo` call as what we use:\r\n```python3\r\nimport socket\r\n\r\nseeds = [\"seed.bitcoin.sipa.be\",\r\n         \"dnsseed.bluematt.me\",\r\n         \"dnsseed.bitcoin.dashjr.org\",\r\n         \"seed.bitcoinstats.com\",\r\n         \"seed.bitcoin.jonasschnelli.ch\",\r\n         \"seed.btc.petertodd.org\",\r\n         \"seed.bitcoin.sprovoost.nl\",\r\n         \"dnsseed.emzy.de\"]\r\n\r\nfor seed in seeds:\r\n    result = len(socket.getaddrinfo(seed, None, family=socket.AF_UNSPEC, type=socket.SOCK_STREAM, proto=socket.IPPROTO_TCP, flags=socket.AI_ADDRCONFIG))\r\n    print(\"{:>4}\\t{}\".format(result, seed))\r\n```\r\n-----\r\nHere's the result:\r\n```\r\n  25    seed.bitcoin.sipa.be\r\n  33    dnsseed.bluematt.me\r\n  38    dnsseed.bitcoin.dashjr.org\r\n  50    seed.bitcoinstats.com\r\n  38    seed.bitcoin.jonasschnelli.ch\r\n  23    seed.btc.petertodd.org\r\n  35    seed.bitcoin.sprovoost.nl\r\n  41    dnsseed.emzy.de\r\n```\nGiven the range of # of results (23-50), I'd be interested in what people think a good `nMaxIPs` choice would be.\nEvenly divided by the limit on whichever bucket DNS seeds go into?\n> Evenly divided by the limit on whichever bucket DNS seeds go into?\r\n\r\n@pstratem Not 100% sure what you mean, could you elaborate a little?\n@dongcarl Given the range of responses `nMaxIPs=32` sounds like a good number.\r\n\r\nHow easy would it be to update the DNS seeders to always return up to 32 addresses and then in bitcoin-core only accept 32 addresses from a DNS seeder. \n@EthanHeilman That's not actually up to the seeder implementation, as recursive resolving may transform the response in various ways. And it's also restricted to being able to fit in a UDP packet.\n@sipa Do recursive revolvers transform DNS responses except for censorship, billing and malware purposes?\n> Do recursive revolvers transform DNS responses except for censorship, billing and malware purposes?\r\n\r\nNope, they largely do not. If the response has been modified, something has gone wrong...\n32, indeed, seems like a good number. With my hostname, 33 across v4+v6 fits neatly in the two 500 byte payload responses with an authority section, though if the server doesn't have an authority/additional section you could go a bit higher. To avoid biasing, we probably want a limit that is the ~minimum of all the seeds.\r\n\r\n@petertodd and @sipa looks like y'all should be able to increase the number of responses your seeds provide?\r\n\r\nWhile we're at it @cdecker looks like your seed violates the DNS spec for non-EDNS requests (it sends back 739 bytes if you query for v6 addresses, though your limit for v4 looks OK).\r\n\r\nOf course that said, we could also probably look at the number of requests that use EDNS, and use (and provide) a larger limit if thats common enough (TCP fallback isn't sooo expensive). I don't, however, know if @sipa's seeder supports EDNS which would be a blocker.\r\n\r\n```\r\n$  dig +nodnssec +noedns @ns.as397444.net dnsseed.bluematt.me\r\n...\r\ndnsseed.bluematt.me.\t3600\tIN\tCNAME\tx1.dnsseed.bluematt.me.\r\n...\r\n;; MSG SIZE  rcvd: 486\r\n```\r\n\r\n```\r\n$  dig +nodnssec +noedns @ns.as397444.net dnsseed.bluematt.me AAAA\r\n...\r\ndnsseed.bluematt.me.\t3600\tIN\tCNAME\tx1.dnsseed.bluematt.me.\r\n...\r\n;; MSG SIZE  rcvd: 486\r\n```\n> While we're at it @cdecker looks like your seed violates the DNS spec for non-EDNS requests (it sends back 739 bytes if you query for v6 addresses, though your limit for v4 looks OK).\r\n\r\nI'll fix that asap, thanks for the heads up\n@sipa ", "created_at": "2024-04-11 12:45:06", "merge_commit_sha": "3310a965bd491755fa2c67879f12ebd0b4fb0bae", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18828", "base_commit": "773a4b919853369166811becb87b9e78ad918211", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/MainPage.cpp b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\nindex 5daf396b72e..054c8480ccf 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n@@ -38,6 +38,7 @@ using namespace winrt::Windows::System;\n using namespace winrt::Windows::UI::Xaml::Controls;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static const std::wstring_view openJsonTag{ L\"OpenJson_Nav\" };\r\n static const std::wstring_view launchTag{ L\"Launch_Nav\" };\r\n static const std::wstring_view interactionTag{ L\"Interaction_Nav\" };\r\n static const std::wstring_view renderingTag{ L\"Rendering_Nav\" };\r\n@@ -324,6 +325,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \r\n             if (const auto navString = clickedItemContainer.Tag().try_as<hstring>())\r\n             {\r\n+                if (*navString == openJsonTag)\r\n+                {\r\n+                    const auto window = CoreWindow::GetForCurrentThread();\r\n+                    const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n+                    const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n+                    const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n+                                            WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n+                    const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n+                    OpenJson.raise(nullptr, target);\r\n+                    return;\r\n+                }\r\n                 _Navigate(*navString, BreadcrumbSubPage::None);\r\n             }\r\n             else if (const auto profile = clickedItemContainer.Tag().try_as<Editor::ProfileViewModel>())\r\n@@ -575,27 +587,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         }\r\n     }\r\n \r\n-    void MainPage::OpenJsonTapped(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& /*args*/)\r\n-    {\r\n-        const auto window = CoreWindow::GetForCurrentThread();\r\n-        const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n-        const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n-        const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n-                                WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n-\r\n-        const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-        OpenJson.raise(nullptr, target);\r\n-    }\r\n-\r\n-    void MainPage::OpenJsonKeyDown(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args)\r\n-    {\r\n-        if (args.Key() == VirtualKey::Enter || args.Key() == VirtualKey::Space)\r\n-        {\r\n-            const auto target = args.KeyStatus().IsMenuKeyDown ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-            OpenJson.raise(nullptr, target);\r\n-        }\r\n-    }\r\n-\r\n     void MainPage::SaveButton_Click(const IInspectable& /*sender*/, const RoutedEventArgs& /*args*/)\r\n     {\r\n         _settingsClone.LogSettingChanges(false);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.h b/src/cascadia/TerminalSettingsEditor/MainPage.h\nindex 81724effb11..582f8813b1d 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.h\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.h\n@@ -30,8 +30,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \n         void UpdateSettings(const Model::CascadiaSettings& settings);\n \n-        void OpenJsonKeyDown(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args);\n-        void OpenJsonTapped(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& args);\n         void SettingsNav_Loaded(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\n         void SettingsNav_ItemInvoked(const Microsoft::UI::Xaml::Controls::NavigationView& sender, const Microsoft::UI::Xaml::Controls::NavigationViewItemInvokedEventArgs& args);\n         void SaveButton_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.xaml b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\nindex 3a0773062aa..c6d36e8f200 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n@@ -171,8 +171,8 @@\n             <!--  The OpenJson item needs both Tapped and KeyDown handler  -->\r\n             <muxc:NavigationViewItem x:Name=\"OpenJsonNavItem\"\r\n                                      x:Uid=\"Nav_OpenJSON\"\r\n-                                     KeyDown=\"OpenJsonKeyDown\"\r\n-                                     Tapped=\"OpenJsonTapped\">\r\n+                                     SelectsOnInvoked=\"False\"\r\n+                                     Tag=\"OpenJson_Nav\">\r\n                 <muxc:NavigationViewItem.Icon>\r\n                     <FontIcon Glyph=\"&#xE713;\" />\r\n                 </muxc:NavigationViewItem.Icon>\r\n", "test_patch": "", "problem_statement": "[Settings]: In scan mode, Screen Reader users are not able to open 'Open JSON file' control.\n### Windows Terminal version\n\n1.12.3472.0\n\n### Windows build number\n\n10.0.22504.1010\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 22504.1010)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\nTool: Accessibility Insights for Windows Version 1.1.1741.1\n\n### Steps to reproduce\n\n**Repro Steps:**\r\n1. Open Windows Terminal.\r\n2. Open Settings page using 'Ctr+,'.\r\n3. Open Narrator using 'Win+Ctrl+ Enter' key. Turn ON Narrator scan mode using 'Caps lock + Space' key.\r\n4. Now navigate to 'Open JSON file' control and try to activate it then observe the issue.\r\n\r\n**User Experience:**\r\nScreen Reader users will be impacted here as they are not able to activate a control in scan mode which will not enhance the UX of those users.\r\n\r\n**Guideline Reference:**\r\nEN 301 549 V3.2.1: 11.5.2.12 Execution of available actions\r\n\r\n**Attachments:**\r\n[Uploading In scan mode, Screen Reader users are not able to open 'Open JSON file' control..zip\u2026]()\n\n### Expected Behavior\n\nIn scan mode, Screen Reader users should be able to open 'Open JSON file' control using 'Enter' key.\n\n### Actual Behavior\n\nIn scan mode, Screen Reader users are not able to open 'Open JSON file' control using 'Enter' key. Screen Reader Users is only able to open JSON file in Scan off mode.\n", "hints_text": "Copying over some relevant information from #12319:\r\n> > PowerToys v0.55 settings has a NavigationView. It doesn't have this issue.\r\nXAML Controls Gallery also doesn't have this issue.\r\n\r\n> Hmm. That might actually be on us then. PT Settings is also XAML Islands IIRC, so if their NavView works, then it's probably how we're using it.\r\n\r\nThere's a chance this is on https://github.com/microsoft/microsoft-ui-xaml, but we need to verify that first.", "created_at": "2025-04-23 19:00:06", "merge_commit_sha": "a8a47b93671361e529ff9f967d0e7c1b028eebb9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18826", "base_commit": "68d9e0d0389101d65f91e5f3bd3fda34df7564f3", "patch": "diff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex 90f6d5936f5..5824bcb2f2a 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -4,8 +4,6 @@\n #include \"precomp.h\"\r\n #include \"renderer.hpp\"\r\n \r\n-#pragma hdrstop\r\n-\r\n using namespace Microsoft::Console::Render;\r\n using namespace Microsoft::Console::Types;\r\n \r\n@@ -90,6 +88,11 @@ IRenderData* Renderer::GetRenderData() const noexcept\n             _pData->UnlockConsole();\r\n         });\r\n \r\n+        if (_isSynchronizingOutput)\r\n+        {\r\n+            _synchronizeWithOutput();\r\n+        }\r\n+\r\n         // Last chance check if anything scrolled without an explicit invalidate notification since the last frame.\r\n         _CheckViewportAndScroll();\r\n \r\n@@ -183,6 +186,71 @@ void Renderer::NotifyPaintFrame() noexcept\n     _thread.NotifyPaint();\r\n }\r\n \r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputBegin() noexcept\r\n+{\r\n+    // Kick the render thread into calling `_synchronizeWithOutput()`.\r\n+    _isSynchronizingOutput = true;\r\n+}\r\n+\r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputEnd() noexcept\r\n+{\r\n+    // Unblock `_synchronizeWithOutput()` from the `WaitOnAddress` call.\r\n+    _isSynchronizingOutput = false;\r\n+    WakeByAddressSingle(&_isSynchronizingOutput);\r\n+\r\n+    // It's crucial to give the render thread at least a chance to gain the lock.\r\n+    // Otherwise, a VT application could continuously spam DECSET 2026 (Synchronized Output) and\r\n+    // essentially drop our renderer to 10 FPS, because `_isSynchronizingOutput` is always true.\r\n+    //\r\n+    // Obviously calling LockConsole/UnlockConsole here is an awful, ugly hack,\r\n+    // since there's no guarantee that this is the same lock as the one the VT parser uses.\r\n+    // But the alternative is Denial-Of-Service of the render thread.\r\n+    //\r\n+    // Note that this causes raw throughput of DECSET 2026 to be comparatively low, but that's fine.\r\n+    // Apps that use DECSET 2026 don't produce that sequence continuously, but rather at a fixed rate.\r\n+    _pData->UnlockConsole();\r\n+    _pData->LockConsole();\r\n+}\r\n+\r\n+void Renderer::_synchronizeWithOutput() noexcept\r\n+{\r\n+    constexpr DWORD timeout = 100;\r\n+\r\n+    UINT64 start = 0;\r\n+    DWORD elapsed = 0;\r\n+    bool wrong = false;\r\n+\r\n+    QueryUnbiasedInterruptTime(&start);\r\n+\r\n+    // Wait for `_isSynchronizingOutput` to be set to false or for a timeout to occur.\r\n+    while (true)\r\n+    {\r\n+        // We can't call a blocking function while holding the console lock, so release it temporarily.\r\n+        _pData->UnlockConsole();\r\n+        const auto ok = WaitOnAddress(&_isSynchronizingOutput, &wrong, sizeof(_isSynchronizingOutput), timeout - elapsed);\r\n+        _pData->LockConsole();\r\n+\r\n+        if (!ok || !_isSynchronizingOutput)\r\n+        {\r\n+            break;\r\n+        }\r\n+\r\n+        UINT64 now;\r\n+        QueryUnbiasedInterruptTime(&now);\r\n+        elapsed = static_cast<DWORD>((now - start) / 10000);\r\n+        if (elapsed >= timeout)\r\n+        {\r\n+            break;\r\n+        }\r\n+    }\r\n+\r\n+    // If a timeout occurred, `_isSynchronizingOutput` may still be true.\r\n+    // Set it to false now to skip calling `_synchronizeWithOutput()` on the next frame.\r\n+    _isSynchronizingOutput = false;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Called when the system has requested we redraw a portion of the console.\r\n // Arguments:\r\ndiff --git a/src/renderer/base/renderer.hpp b/src/renderer/base/renderer.hpp\nindex d5f6be56d18..c8c30457604 100644\n--- a/src/renderer/base/renderer.hpp\n+++ b/src/renderer/base/renderer.hpp\n@@ -35,6 +35,8 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT PaintFrame();\r\n \r\n         void NotifyPaintFrame() noexcept;\r\n+        void SynchronizedOutputBegin() noexcept;\r\n+        void SynchronizedOutputEnd() noexcept;\r\n         void TriggerSystemRedraw(const til::rect* const prcDirtyClient);\r\n         void TriggerRedraw(const Microsoft::Console::Types::Viewport& region);\r\n         void TriggerRedraw(const til::point* const pcoord);\r\n@@ -91,6 +93,7 @@ namespace Microsoft::Console::Render\n \r\n         [[nodiscard]] HRESULT _PaintFrame() noexcept;\r\n         [[nodiscard]] HRESULT _PaintFrameForEngine(_In_ IRenderEngine* const pEngine) noexcept;\r\n+        void _synchronizeWithOutput() noexcept;\r\n         bool _CheckViewportAndScroll();\r\n         [[nodiscard]] HRESULT _PaintBackground(_In_ IRenderEngine* const pEngine);\r\n         void _PaintBufferOutput(_In_ IRenderEngine* const pEngine);\r\n@@ -124,6 +127,7 @@ namespace Microsoft::Console::Render\n         std::function<void()> _pfnBackgroundColorChanged;\r\n         std::function<void()> _pfnFrameColorChanged;\r\n         std::function<void()> _pfnRendererEnteredErrorState;\r\n+        bool _isSynchronizingOutput = false;\r\n         bool _forceUpdateViewport = false;\r\n \r\n         til::point_span _lastSelectionPaintSpan{};\r\ndiff --git a/src/renderer/base/thread.cpp b/src/renderer/base/thread.cpp\nindex 467bef73585..39b7ec60783 100644\n--- a/src/renderer/base/thread.cpp\n+++ b/src/renderer/base/thread.cpp\n@@ -34,7 +34,7 @@ DWORD WINAPI RenderThread::_ThreadProc()\n \r\n         // Between waiting on _hEvent and calling PaintFrame() there should be a minimal delay,\r\n         // so that a key press progresses to a drawing operation as quickly as possible.\r\n-        // As such, we wait for the renderer to complete _before_ waiting on _hEvent.\r\n+        // As such, we wait for the renderer to complete _before_ waiting on `_redraw`.\r\n         renderer->WaitUntilCanRender();\r\n \r\n         _redraw.wait();\r\n@@ -78,6 +78,8 @@ void RenderThread::EnablePainting() noexcept\n     }\r\n }\r\n \r\n+// This function is meant to only be called by `Renderer`. You should use `TriggerTeardown()` instead,\r\n+// even if you plan to call `EnablePainting()` later, because that ensures proper synchronization.\r\n void RenderThread::DisablePainting() noexcept\r\n {\r\n     _enable.ResetEvent();\r\ndiff --git a/src/terminal/adapter/DispatchTypes.hpp b/src/terminal/adapter/DispatchTypes.hpp\nindex f1adb1457c8..b99dd997dde 100644\n--- a/src/terminal/adapter/DispatchTypes.hpp\n+++ b/src/terminal/adapter/DispatchTypes.hpp\n@@ -544,6 +544,7 @@ namespace Microsoft::Console::VirtualTerminal::DispatchTypes\n         ALTERNATE_SCROLL = DECPrivateMode(1007),\r\n         ASB_AlternateScreenBuffer = DECPrivateMode(1049),\r\n         XTERM_BracketedPasteMode = DECPrivateMode(2004),\r\n+        SO_SynchronizedOutput = DECPrivateMode(2026),\r\n         GCM_GraphemeClusterMode = DECPrivateMode(2027),\r\n         W32IM_Win32InputMode = DECPrivateMode(9001),\r\n     };\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 9158b962ab3..c8f4c5eb85e 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1914,6 +1914,19 @@ void AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n     case DispatchTypes::ModeParams::XTERM_BracketedPasteMode:\n         _api.SetSystemMode(ITerminalApi::Mode::BracketedPaste, enable);\n         break;\n+    case DispatchTypes::ModeParams::SO_SynchronizedOutput:\n+        if (_renderer)\n+        {\n+            if (enable)\n+            {\n+                _renderer->SynchronizedOutputBegin();\n+            }\n+            else\n+            {\n+                _renderer->SynchronizedOutputEnd();\n+            }\n+        }\n+        break;\n     case DispatchTypes::ModeParams::GCM_GraphemeClusterMode:\n         break;\n     case DispatchTypes::ModeParams::W32IM_Win32InputMode:\n", "test_patch": "", "problem_statement": "Implement synchronized update control sequences\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\n\r\nhttps://gitlab.com/gnachman/iterm2/-/wikis/synchronized-updates-spec\r\n\r\nThe goal of synchronized updates is to avoid showing a half-drawn screen, such as while paging through a document in an editor.\r\n\r\nA new control sequence is proposed that indicates the beginning and end of a update. No new content should be rendered by the terminal emulator until the update ends, at which point any changes made during the update should be applied atomically.\r\n\r\nThe purpose of this sequence is to provide a hint to the terminal emulator about how to draw atomically. If it turns out to be too difficult to do under some particular input, the hint can be safely ignored\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\n\n```[tasklist]\n### Tasks\n```\n\n", "hints_text": "Yea okay, this seems well thought out. I like that there are contingincies included for \"what happens when the client app disconnects before sending an \\<end\\>\". Plus, I think we did add support for DCS sequences relatively recently, so this shouldn't be too bad. \r\n\r\nPart of the trick here is gonna be conpty, and the way we use that to render the _effects_ of output on the console buffer. I'd guess that this would have to be implemented in `conhost`, and then at the end of the synchronized update, conhost would render _once_ to the terminal. That makes sense to me. \nNote that this idea was discussed in terminal-wg a while back, and I think it was generally agreed that a DCS sequence was a bad choice for this. One of the benefits of this functionality is that it shouldn't require feature detection - if a terminal doesn't support it, then you just don't get the optimisation. However, that's not the case if you're using a DCS sequence, because there are a number of terminals that will output garbage if you send them an unrecognised DCS. So now an app can't really use this functionality unless they first determine whether it's supported somehow.\r\n\r\nAs is typical for terminal-wg, there was no official conclusion to the discussion, but the general consensus seemed to have been that a DECSET private mode sequence would be preferable, and the mode number that was settled on was 2026. I know at least one terminal has implemented synchronized updates via mode 2026, and at least one application is using that mode.\r\n\r\nAlso I know @gnachman has said \"If I had it to do over again, I'd push for DECSET/DECRST\", but he hasn't actually agreed to supporting the proposed mode in iTerm2 as far as I'm aware. If we're going to implement this, I'd much rather we used a DECSET mode than DCS, but I'd also like to have seen some definite commitment to that approach from people like iTerm2.\n> However, that's not the case if you're using a DCS sequence, because there are a number of terminals that will output garbage if you send them an unrecognised DCS\r\n\r\nGuh, I hate that. Maybe we come up with an agreement between us and iTerm2 to move forward onto a DECSET/DECRST implementation. We'd obviously have to still support the DCS version of the sequence, but maybe we can help push the ecosystem forward a bit here. Here's what I'm thinking:\r\n\r\n* We implement support for the DCS version of this sequence.\r\n* _At the same time_, as we add support for the DCS version, we add support for the DECSET/DECRST version. \r\n* **At the same time**, iTerm2 adds support for the DECSET/DECRST version. \r\n\r\nAt this point, we'd update any existing documentation to suggest that app developers use the new version of the sequence, and the old one is deprecated. Terminal emulators that haven't been updated with support for the new sequence will silently ignore it. Apps that aren't updated to use the new sequence will still continue to work (and will _start_ working on the console/Terminal).\r\n\r\nThis would obviously require buyoff from @gnachman, but this seems like a reasonable path, and one that would work cross-platform. Thoughts?\r\n\r\n##### notes: terminal-wg [pr](https://gitlab.freedesktop.org/terminal-wg/specifications/-/merge_requests/2)\nI am fine with this. I believe Kitty has also implemented support for this control sequence, so check with @kovidgoyal too.\nYou can go ahead and use DECSET/DECRESET if it floats your boat. Since you are also implementing support for the DCS version, I dont really care. I will note that the only terminals that dont support DCS sequences are Apple's and the Linux kernel console. Using DECSET/DECRESET means that no future modifications can be made to the protocol to implement additional features. Which will mean in the long term that DECSET/DECRESET will be the deprecated ones, but hey, no harm in having them, just another redundant code path. Just be careful when choosing numbers for the codes to not conflict with existing uses, which was one of the motivations for choosing DCS in the first place. \n> Just be careful when choosing numbers for the codes to not conflict with existing uses,\r\n\r\nI like to compare that feature a little bit to double buffering in graphics APIs, such as OpenGL (first released in 1992), wich is also there to avoid tearing effects. That standard had never changed. So i am pretty confident it won't need any feature extension here, too.\r\n\r\n\nThat's not a valid comparison. OpenGL's double bufferring buffers a single thing, a pixel buffer, and over a fast local link. In the terminal case you are bufferring terminal state beyond just what is drawn on the screen and over latency variable, lossy networks. \n> That's not a valid comparison. OpenGL's double bufferring buffers a single thing, a pixel buffer, and over a fast local link. In the terminal case you are bufferring terminal state beyond just what is drawn on the screen and over latency variable, lossy networks.\r\n\r\n@kovidgoyal i do not want to fight over little differences when I explicitly did not say equal but like. That would be way to off-topic. Feel free to ignore my opinion. ;-)\n@zadjii-msft good morning. I'd like to ask if there there had been actually any brainstorming progress on the msft side of the fence? I stilll do also think that DECSM/DECRM are the right choice, and I came back to see if here was any progress until then. :)\nI actually hacked together a basic implementation of this a while back (just the mode 2026 approach) which I've been using in my local fork. We didn't have the ability to do DCS at the time, and I was also waiting to see what iTerm2 would do. But I suspect now that gnachman has changed his mind about supporting mode 2026 (it would have taken all of 3 lines of code if he was going to do it). So if it were up to me, I'd say we should just do the mode and ignore the DCS approach. Supporting both will push apps to use DCS, which is exactly what we want to avoid.\r\n\r\nEven if we don't care about all the other terminals that will be negatively effected by the use of DCS (which I can assure you is more than two), the Windows console itself didn't support DCS until very recently. So there are still likely to be a significant number of users on an older version of Windows that'll break if sent a DCS sequence, and upgrading is not always an option (I know, because several of my computers are on older versions that aren't being offered upgrades).\r\n\r\nIf it turns out there are actually apps using the DCS sequence that can't be persuaded to add support for the mode, then we can always reconsider adding a DCS alias later (but preferably when the #6328 fix is more widely deployed).\n> I'd say we should just do the mode and ignore the DCS approach. Supporting both will push apps to use DCS, which is exactly what we want to avoid.\r\n\r\nI am all in, and absolutely agree with you on that decision. \r\n\r\nFor reference, I've put together the spec as well with the (more interestingly maybe) list of supporting software for the \"synchronized rendering\" feature [here](https://gist.github.com/christianparpart/d8a62cc1ab659194337d73e399004036). @j4james I can't await adding you (your branch / PR) once ready to it, too. Looking forward to it. :)\nI'm happy to do DECSET 2026. I've been busy, but will do it now.\n> I'm happy to do DECSET 2026. I've been busy, but will do it now.\r\n\r\nI am really happy to hear from you. Looking forward to it.\nDone in commit f7efeb4bbaa5ba2796f94c3bab32e5c64ee9c743\nAny updates or progress on this?", "created_at": "2025-04-23 00:30:35", "merge_commit_sha": "773a4b919853369166811becb87b9e78ad918211", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18798", "base_commit": "90c312f7da9499cf97c4f0575db4e69ff8352ee9", "patch": "diff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex df30a3ffb23..7cd232ad539 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -2061,14 +2061,6 @@ void TextBuffer::_ExpandTextRow(til::inclusive_rect& textRow) const\n     }\r\n }\r\n \r\n-size_t TextBuffer::SpanLength(const til::point coordStart, const til::point coordEnd) const\r\n-{\r\n-    const auto bufferSize = GetSize();\r\n-    // The coords are inclusive, so to get the (inclusive) length we add 1.\r\n-    const auto length = bufferSize.CompareInBounds(coordEnd, coordStart) + 1;\r\n-    return gsl::narrow<size_t>(length);\r\n-}\r\n-\r\n // Routine Description:\r\n // - Retrieves the plain text data between the specified coordinates.\r\n // Arguments:\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex 775417caab0..fca973f50de 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -199,8 +199,6 @@ class TextBuffer final\n     std::wstring GetCustomIdFromId(uint16_t id) const;\r\n     void CopyHyperlinkMaps(const TextBuffer& OtherBuffer);\r\n \r\n-    size_t SpanLength(const til::point coordStart, const til::point coordEnd) const;\r\n-\r\n     std::wstring GetPlainText(til::point start, til::point end) const;\r\n \r\n     struct CopyRequest\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex 0a94352e724..4bd41d58d01 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -2868,6 +2868,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 // coloring other matches, then we need to make sure those get redrawn,\r\n                 // too.\r\n                 _renderer->TriggerRedrawAll();\r\n+                _updateSelectionUI();\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 9e6350df044..91def441079 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1571,10 +1571,10 @@ void Terminal::SerializeMainBuffer(const wchar_t* destination) const\n \r\n void Terminal::ColorSelection(const TextAttribute& attr, winrt::Microsoft::Terminal::Core::MatchMode matchMode)\r\n {\r\n-    const auto colorSelection = [this](const til::point coordStart, const til::point coordEnd, const TextAttribute& attr) {\r\n+    const auto colorSelection = [this](const til::point coordStartInclusive, const til::point coordEndExclusive, const TextAttribute& attr) {\r\n         auto& textBuffer = _activeBuffer();\r\n-        const auto spanLength = textBuffer.SpanLength(coordStart, coordEnd);\r\n-        textBuffer.Write(OutputCellIterator(attr, spanLength), coordStart);\r\n+        const auto spanLength = textBuffer.GetSize().CompareInBounds(coordEndExclusive, coordStartInclusive, true);\r\n+        textBuffer.Write(OutputCellIterator(attr, spanLength), coordStartInclusive);\r\n     };\r\n \r\n     for (const auto [start, end] : _GetSelectionSpans())\r\n", "test_patch": "", "problem_statement": "\"Color selection\" off-by-one regression: it colors 1 cell past the end\n### Windows Terminal version\n\n1.23.10732.0\n\n### Windows build number\n\n10.0.26388.1001\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nI use the \"Color Selection\" feature a lot, and often the \"all matches\" variant, which lets you select some text, and then change the fg/bg color for all occurrences of the selected text.\n\nRecently it started coloring one cell past the end of the selection. In the screenshot below, I selected \"abcd\", but the colorization applies to \"abcde\" (as well as \"abcdeX\", demonstrating that the search is not similarly afected):\n\n![Image](https://github.com/user-attachments/assets/6258a18f-d941-443d-9f3e-c7fd6750dbe3)\n\n### Expected Behavior\n\nJust the \"abcd\" should have been colorized.\n\n### Actual Behavior\n\nColorization included one character past the end.\n", "hints_text": "As we all know, the two hardest things in computer science are naming things, cache invalidation, and off-by-one errors. :D\nAlas, another victim of #18106 ", "created_at": "2025-04-14 22:14:40", "merge_commit_sha": "0b4f9662c7f459857b08ef70c2cfb2b6e682c6c5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18781", "base_commit": "ad19d2c967e896c5426b9d98dfdbc2c4279eb319", "patch": "diff --git a/src/host/_stream.cpp b/src/host/_stream.cpp\nindex 85cadb1cfef..30901515402 100644\n--- a/src/host/_stream.cpp\n+++ b/src/host/_stream.cpp\n@@ -269,17 +269,26 @@ void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& t\n             case UNICODE_LINEFEED:\r\n             {\r\n                 auto pos = cursor.GetPosition();\r\n-                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN) && pos.x != 0)\r\n+\r\n+                // If DISABLE_NEWLINE_AUTO_RETURN is not set, any LF behaves like a CRLF.\r\n+                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN))\r\n                 {\r\n                     pos.x = 0;\r\n-                    // This causes the current \\n to be replaced with a \\r\\n in the ConPTY VT output.\r\n-                    wch = 0;\r\n-                    lastCharWrapped = true;\r\n+\r\n+                    // Setting wch=0 and lastCharWrapped=true will cause the code at the end\r\n+                    // of the loop to emit a CRLF. However, we only do this if the preceding\r\n+                    // character isn't already a CR. We don't want to emit CR CR LF after all.\r\n+                    if (it == beg || it[-1] != '\\r')\r\n+                    {\r\n+                        wch = 0;\r\n+                        lastCharWrapped = true;\r\n+                    }\r\n                 }\r\n \r\n                 textBuffer.GetMutableRowByOffset(pos.y).SetWrapForced(false);\r\n                 pos.y = pos.y + 1;\r\n                 AdjustCursorPosition(screenInfo, pos, psScrollY);\r\n+\r\n                 break;\r\n             }\r\n             case UNICODE_CARRIAGERETURN:\r\n", "test_patch": "", "problem_statement": "\\n with ENABLE_PROCESSED_OUTPUT and without ENABLE_WRAP_AT_EOL_OUTPUT\n### Windows Terminal version\n\n1.22.2362\n\n### Windows build number\n\n10.0.19045\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nDisable ENABLE_WRAP_AT_EOL_OUTPUT, keep ENABLE_PROCESSED_OUTPUT enabled, write to the end of line, then insert \\n .  Traditionally the newline would operate as CRLF (processed output semantics) and start at the beginning of the following line.  Note this is Win32 semantics, VT semantics are different; in this sequence, VT support is not enabled.\n\nIn WT 1.22.x, this generates VT semantics.  Replacing \\n with \\r\\n works as expected.\n\n```\n#include <windows.h>\n\nint main(int argc, char * argv[])\n{\n    CONSOLE_SCREEN_BUFFER_INFO screenBufferInfo;\n    DWORD consoleWidth;\n    DWORD charIndex;\n    DWORD lineIndex;\n    DWORD charsWritten;\n    HANDLE consoleHandle;\n    LPSTR buffer;\n\n    consoleHandle = GetStdHandle(STD_OUTPUT_HANDLE);\n    GetConsoleScreenBufferInfo(consoleHandle, &screenBufferInfo);\n    consoleWidth = screenBufferInfo.dwSize.X;\n\n    //\n    //  Disable ENABLE_WRAP_AT_EOL_OUTPUT\n    //\n    SetConsoleMode(consoleHandle, ENABLE_PROCESSED_OUTPUT);\n    buffer = malloc(consoleWidth + 1);\n\n    for (lineIndex = 0; lineIndex < 3; lineIndex++) {\n        for (charIndex = 0; charIndex < consoleWidth; charIndex++) {\n            buffer[charIndex] = '1' + lineIndex;\n        }\n        WriteConsole(consoleHandle, buffer, consoleWidth, &charsWritten, NULL);\n        WriteConsole(consoleHandle, \"\\n\", 1, &charsWritten, NULL);\n    }\n\n    return 0;\n}\n```\n\n### Expected Behavior\n\nBehavior in WT 1.21, as well as Conhost, including OpenConsole from WT 1.22:\n\n![Image](https://github.com/user-attachments/assets/77fcdf2e-5693-4294-965c-08c7f5e3a1f8)\n\n### Actual Behavior\n\nBehavior in WT 1.22:\n\n![Image](https://github.com/user-attachments/assets/296a4a57-0c42-4c7b-bd65-6c165e28eb35)\n\n\n", "hints_text": "Whoa, thanks for catching this! Probably an issue in the new (as of 1.22) translation layer for console APIs to VT. :)", "created_at": "2025-04-10 21:48:28", "merge_commit_sha": "354e05d7139d00ae4c6d7ca84caa074bfd030131", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18462", "base_commit": "08f9afe31547c109536eb260171fe3b83835d1ff", "patch": "diff --git a/.github/actions/spelling/allow/allow.txt b/.github/actions/spelling/allow/allow.txt\nindex 630edfebce7..a936b3df359 100644\n--- a/.github/actions/spelling/allow/allow.txt\n+++ b/.github/actions/spelling/allow/allow.txt\n@@ -11,6 +11,7 @@ colorbrewer\n commandlines\n consvc\n copyable\n+CText\n dalet\n dcs\n deselection\ndiff --git a/src/cascadia/TerminalConnection/ConptyConnection.cpp b/src/cascadia/TerminalConnection/ConptyConnection.cpp\nindex 0a0b26aa934..075eb734356 100644\n--- a/src/cascadia/TerminalConnection/ConptyConnection.cpp\n+++ b/src/cascadia/TerminalConnection/ConptyConnection.cpp\n@@ -428,6 +428,20 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n             TerminalOutput.raise(L\"\\r\\n\");\n             TerminalOutput.raise(badPathText);\n         }\n+        // If the requested action requires elevation, display appropriate message\n+        else if (hr == HRESULT_FROM_WIN32(ERROR_ELEVATION_REQUIRED))\n+        {\n+            const auto elevationText = RS_(L\"ElevationRequired\");\n+            TerminalOutput.raise(L\"\\r\\n\");\n+            TerminalOutput.raise(elevationText);\n+        }\n+        // If the requested executable was not found, display appropriate message\n+        else if (hr == HRESULT_FROM_WIN32(ERROR_FILE_NOT_FOUND))\n+        {\n+            const auto fileNotFoundText = RS_(L\"FileNotFound\");\n+            TerminalOutput.raise(L\"\\r\\n\");\n+            TerminalOutput.raise(fileNotFoundText);\n+        }\n \n         _transitionToState(ConnectionState::Failed);\n \ndiff --git a/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw b/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\nindex 3532e310491..82c7291a607 100644\n--- a/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\n@@ -209,7 +209,7 @@\n   </data>\r\n   <data name=\"CtrlDToClose\" xml:space=\"preserve\">\r\n     <value>You can now close this terminal with Ctrl+D, or press Enter to restart.</value>\r\n-\t  <comment>\"Ctrl+D\" and \"Enter\" represent keys the user will press (control+D and Enter).</comment>\r\n+    <comment>\"Ctrl+D\" and \"Enter\" represent keys the user will press (control+D and Enter).</comment>\r\n   </data>\r\n   <data name=\"ProcessFailedToLaunch\" xml:space=\"preserve\">\r\n     <value>[error {0} when launching `{1}']</value>\r\n@@ -220,4 +220,10 @@\n     <value>Could not access starting directory \"{0}\"</value>\r\n     <comment>The first argument {0} is a path to a directory on the filesystem, as provided by the user.</comment>\r\n   </data>\r\n-</root>\r\n+  <data name=\"ElevationRequired\" xml:space=\"preserve\">\r\n+    <value>The requested operation requires elevation.</value>\r\n+  </data>\r\n+  <data name=\"FileNotFound\" xml:space=\"preserve\">\r\n+    <value>The system cannot find the file specified.</value>\r\n+  </data>\r\n+</root>\n\\ No newline at end of file\n", "test_patch": "", "problem_statement": "Show a more descriptive error message when the ConptyConnection fails to start for some reason\n# Description of the new feature/enhancement\r\n\r\nShow a speaking error message, when it is necessary to run Terminal with admin privileges. See https://github.com/microsoft/terminal/issues/4272 for the problem\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\nShow a more descriptive error message when the ConptyConnection fails to start for some reason\n# Description of the new feature/enhancement\r\n\r\nShow a speaking error message, when it is necessary to run Terminal with admin privileges. See https://github.com/microsoft/terminal/issues/4272 for the problem\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\n", "hints_text": "How about just displaying the error message that matches the error code, like so:\r\n\r\n```\r\n[error 0x800702e4 when launching `C:\\Program Files\\PowerShell\\6\\pwsh.exe']\r\nThe requested operation requires elevation.\r\n```\r\n\r\nOr does Windows Terminal have to recognize the 0x800702e4 code specifically and display something more verbose?\nI think displaying the error message would be perfectly fine. I had to google it. With the error message, this wouldn't have been necessary.\nCould even extend that to process exit codes that look like NTSTATUS error codes:\r\n\r\n```\r\n[process exited with code 3221225786]\r\nThe application terminated as a result of a CTRL+C.\r\n```\r\n\r\nThat would have a greater risk of false matches, though.\nThis isn't a bad idea, and I bet @DHowett thought about something like this when he first added the error codes\nYeah, we can definitely do better with these error messages!\nFor those who'd like to try this themselves, I added a similar kind of error message in #10045. \r\n\r\nCollected relevant error messages:\r\n\r\nSymbolic Name | Error Description | Header\r\n-- | -- | --\r\nERROR_ELEVATION_REQUIRED | The requested operation requires elevation. | winerror.h\r\nSTATUS_CONTROL_C_EXIT | {Application Exit by CTRL+C} The application terminated as a result of a CTRL+C. | ntstatus.h\r\n[MSG_DIR_BAD_COMMAND_OR_FILE ](https://github.com/microsoft/terminal/issues/11073)| '%1' is not recognized as an internal or external command, operable program or batch file. | cmdmsg.h\r\n\r\n\nHello , I have read through the issue and I want to try to help in adding the new error message , Can someone guide me as to how to recreate the same runtime conditions as in #4272 ?\n@Harshit-Agarwal-2022, create a Windows Terminal profile that runs `%windir%\\system32\\msconfig.exe`, and try to start that profile.  The application requires elevation, and this causes error 2147943140 (0x800702e4) as in <https://github.com/microsoft/terminal/issues/4272> (unless Windows Terminal itself is elevated).\n@Harshit-Agarwal-2022 You still working on this issue?\n\n@ATOMworkplace I was facing some issues with vs 2022 while building the terminal repo on my local system so i havent started with the issue yet , you can work on it if you want , I was able to recreate the error log using @KalleOlaviNiemitalo 's instructions\n@Harshit-Agarwal-2022 Sure, thanks for letting me know, I'll give it a try and see what I can do.\nHow about just displaying the error message that matches the error code, like so:\r\n\r\n```\r\n[error 0x800702e4 when launching `C:\\Program Files\\PowerShell\\6\\pwsh.exe']\r\nThe requested operation requires elevation.\r\n```\r\n\r\nOr does Windows Terminal have to recognize the 0x800702e4 code specifically and display something more verbose?\nI think displaying the error message would be perfectly fine. I had to google it. With the error message, this wouldn't have been necessary.\nCould even extend that to process exit codes that look like NTSTATUS error codes:\r\n\r\n```\r\n[process exited with code 3221225786]\r\nThe application terminated as a result of a CTRL+C.\r\n```\r\n\r\nThat would have a greater risk of false matches, though.\nThis isn't a bad idea, and I bet @DHowett thought about something like this when he first added the error codes\nYeah, we can definitely do better with these error messages!\nFor those who'd like to try this themselves, I added a similar kind of error message in #10045. \r\n\r\nCollected relevant error messages:\r\n\r\nSymbolic Name | Error Description | Header\r\n-- | -- | --\r\nERROR_ELEVATION_REQUIRED | The requested operation requires elevation. | winerror.h\r\nSTATUS_CONTROL_C_EXIT | {Application Exit by CTRL+C} The application terminated as a result of a CTRL+C. | ntstatus.h\r\n[MSG_DIR_BAD_COMMAND_OR_FILE ](https://github.com/microsoft/terminal/issues/11073)| '%1' is not recognized as an internal or external command, operable program or batch file. | cmdmsg.h\r\n\r\n\nHello , I have read through the issue and I want to try to help in adding the new error message , Can someone guide me as to how to recreate the same runtime conditions as in #4272 ?\n@Harshit-Agarwal-2022, create a Windows Terminal profile that runs `%windir%\\system32\\msconfig.exe`, and try to start that profile.  The application requires elevation, and this causes error 2147943140 (0x800702e4) as in <https://github.com/microsoft/terminal/issues/4272> (unless Windows Terminal itself is elevated).\n@Harshit-Agarwal-2022 You still working on this issue?\n\n@ATOMworkplace I was facing some issues with vs 2022 while building the terminal repo on my local system so i havent started with the issue yet , you can work on it if you want , I was able to recreate the error log using @KalleOlaviNiemitalo 's instructions\n@Harshit-Agarwal-2022 Sure, thanks for letting me know, I'll give it a try and see what I can do.", "created_at": "2025-01-26 06:32:10", "merge_commit_sha": "f7e853cd9f515ff0c7e52ab0eb0604bb95d47ba3", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18445", "base_commit": "25392ea6042242eceeb95cca29ca18784cf0ee7b", "patch": "diff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex 55f9bac881d..b77cf969f49 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -1354,6 +1354,7 @@ PNMLINK\n pntm\n POBJECT\n Podcast\n+POINTERUPDATE\n POINTSLIST\n policheck\n POLYTEXTW\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 3724edd542c..d40ea2feb7f 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -47,66 +47,6 @@ constexpr std::wstring_view StateCollapsed{ L\"Collapsed\" };\n DEFINE_ENUM_FLAG_OPERATORS(winrt::Microsoft::Terminal::Control::CopyFormat);\r\n DEFINE_ENUM_FLAG_OPERATORS(winrt::Microsoft::Terminal::Control::MouseButtonState);\r\n \r\n-// WinUI 3's UIElement.ProtectedCursor property allows someone to set the cursor on a per-element basis.\r\n-// This would allow us to hide the cursor when the TermControl has input focus and someone starts typing.\r\n-// Unfortunately, no equivalent exists for WinUI 2 so we fake it with the CoreWindow.\r\n-// There are 3 downsides:\r\n-// * SetPointerCapture() is global state and may interfere with other components.\r\n-// * You can't start dragging the cursor (for text selection) while it's still hidden.\r\n-// * The CoreWindow covers the union of all window rectangles, so the cursor is hidden even if it's outside\r\n-//   the current foreground window, but still on top of another Terminal window in the background.\r\n-static void hideCursorUntilMoved()\r\n-{\r\n-    static bool cursorIsHidden;\r\n-    static const auto shouldVanish = []() {\r\n-        BOOL shouldVanish = TRUE;\r\n-        SystemParametersInfoW(SPI_GETMOUSEVANISH, 0, &shouldVanish, 0);\r\n-        if (!shouldVanish)\r\n-        {\r\n-            return false;\r\n-        }\r\n-\r\n-        const auto window = CoreWindow::GetForCurrentThread();\r\n-        static constexpr auto releaseCapture = [](CoreWindow window, PointerEventArgs) {\r\n-            if (cursorIsHidden)\r\n-            {\r\n-                window.ReleasePointerCapture();\r\n-            }\r\n-        };\r\n-        static constexpr auto restoreCursor = [](CoreWindow window, PointerEventArgs) {\r\n-            if (cursorIsHidden)\r\n-            {\r\n-                cursorIsHidden = false;\r\n-                window.PointerCursor(CoreCursor{ CoreCursorType::Arrow, 0 });\r\n-            }\r\n-        };\r\n-\r\n-        winrt::Windows::Foundation::TypedEventHandler<CoreWindow, PointerEventArgs> releaseCaptureHandler{ releaseCapture };\r\n-        std::ignore = window.PointerMoved(releaseCaptureHandler);\r\n-        std::ignore = window.PointerPressed(releaseCaptureHandler);\r\n-        std::ignore = window.PointerReleased(releaseCaptureHandler);\r\n-        std::ignore = window.PointerWheelChanged(releaseCaptureHandler);\r\n-        std::ignore = window.PointerCaptureLost(restoreCursor);\r\n-        return true;\r\n-    }();\r\n-\r\n-    if (shouldVanish && !cursorIsHidden)\r\n-    {\r\n-        try\r\n-        {\r\n-            const auto window = CoreWindow::GetForCurrentThread();\r\n-            window.PointerCursor(nullptr);\r\n-            window.SetPointerCapture();\r\n-            cursorIsHidden = true;\r\n-        }\r\n-        catch (...)\r\n-        {\r\n-            // Swallow the 0x80070057 \"Failed to get pointer information.\" exception that randomly occurs.\r\n-            // Curiously, it doesn't happen during the PointerCursor() but during the SetPointerCapture() call (thanks, WinUI).\r\n-        }\r\n-    }\r\n-}\r\n-\r\n // InputPane::GetForCurrentView() does not reliably work for XAML islands,\r\n // as it assumes that there's a 1:1 relationship between windows and threads.\r\n //\r\n@@ -1551,8 +1491,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             return;\r\n         }\r\n \r\n-        hideCursorUntilMoved();\r\n-\r\n         const auto ch = e.Character();\r\n         const auto keyStatus = e.KeyStatus();\r\n         const auto scanCode = gsl::narrow_cast<WORD>(keyStatus.ScanCode);\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.cpp b/src/cascadia/WindowsTerminal/IslandWindow.cpp\nindex 4c950cb986d..4b965be4022 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.cpp\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.cpp\n@@ -26,6 +26,48 @@ using VirtualKeyModifiers = winrt::Windows::System::VirtualKeyModifiers;\n #define XAML_HOSTING_WINDOW_CLASS_NAME L\"CASCADIA_HOSTING_WINDOW_CLASS\"\r\n #define IDM_SYSTEM_MENU_BEGIN 0x1000\r\n \r\n+// WinUI doesn't support the \"Hide cursor on input\" setting which is why all the modern Windows apps\r\n+// are broken in that respect. We want to support it though, so we implement an imitation of it here.\r\n+// We use the classic ShowCursor() API to hide it on keydown and show it on a select few messages.\r\n+// WinUI's SetPointerCapture() cannot be used for this, because it races with internal WinUI code\r\n+// calling that function and has proven itself to be very unreliable in practice.\r\n+//\r\n+// With UWP half the input stack got split off, and so most input events get rerouted through\r\n+// the CoreInput child window running in another thread (aka InputHost aka Windows.UI.Input).\r\n+// HideCursor() is called by WindowEmperor because WM_KEYDOWN is otherwise sent directly to that\r\n+// CoreInput window. Same for WM_POINTERUPDATE which we use to reliably detect cursor movement.\r\n+// WM_ACTIVATE on the other hand is only sent to each specific window and cannot be hooked by\r\n+// inspecting the MSG struct coming from GetMessage. That's why the code must be here.\r\n+// Best not think about this too much...\r\n+bool IslandWindow::IsCursorHidden() noexcept\r\n+{\r\n+    return _cursorHidden;\r\n+}\r\n+\r\n+void IslandWindow::HideCursor() noexcept\r\n+{\r\n+    static const auto shouldVanish = []() noexcept {\r\n+        BOOL shouldVanish = TRUE;\r\n+        SystemParametersInfoW(SPI_GETMOUSEVANISH, 0, &shouldVanish, 0);\r\n+        return shouldVanish != FALSE;\r\n+    }();\r\n+\r\n+    if (!_cursorHidden && shouldVanish)\r\n+    {\r\n+        ShowCursor(FALSE);\r\n+        _cursorHidden = true;\r\n+    }\r\n+}\r\n+\r\n+void IslandWindow::ShowCursorMaybe(const UINT message) noexcept\r\n+{\r\n+    if (_cursorHidden && (message == WM_ACTIVATE || message == WM_POINTERUPDATE))\r\n+    {\r\n+        _cursorHidden = false;\r\n+        ShowCursor(TRUE);\r\n+    }\r\n+}\r\n+\r\n IslandWindow::IslandWindow() noexcept :\r\n     _interopWindowHandle{ nullptr },\r\n     _rootGrid{ nullptr },\r\n@@ -425,6 +467,11 @@ void IslandWindow::_OnGetMinMaxInfo(const WPARAM /*wParam*/, const LPARAM lParam\n \r\n [[nodiscard]] LRESULT IslandWindow::MessageHandler(UINT const message, WPARAM const wparam, LPARAM const lparam) noexcept\r\n {\r\n+    if (IsCursorHidden())\r\n+    {\r\n+        ShowCursorMaybe(message);\r\n+    }\r\n+\r\n     switch (message)\r\n     {\r\n     case WM_GETMINMAXINFO:\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.h b/src/cascadia/WindowsTerminal/IslandWindow.h\nindex 8432d4e8134..47d4e38ce98 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.h\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.h\n@@ -14,6 +14,10 @@ class IslandWindow :\n     public BaseWindow<IslandWindow>\n {\n public:\n+    static bool IsCursorHidden() noexcept;\n+    static void HideCursor() noexcept;\n+    static void ShowCursorMaybe(const UINT message) noexcept;\n+\n     IslandWindow() noexcept;\n     virtual ~IslandWindow() override;\n \n@@ -143,7 +147,7 @@ class IslandWindow :\n     bool _minimizeToNotificationArea{ false };\n \n     std::unordered_map<UINT, SystemMenuItemInfo> _systemMenuItems;\n-    UINT _systemMenuNextItemId;\n+    UINT _systemMenuNextItemId = 0;\n     void _resetSystemMenu();\n \n private:\n@@ -154,4 +158,6 @@ class IslandWindow :\n     // though the total height will take into account the non-client area\n     // and the requirements of components hosted in the client area\n     static constexpr float minimumHeight = 0;\n+\n+    inline static bool _cursorHidden;\n };\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 59f26b50b16..16e128d077b 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -417,6 +417,16 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n                 _dispatchSpecialKey(msg);\r\n                 continue;\r\n             }\r\n+\r\n+            if (msg.message == WM_KEYDOWN)\r\n+            {\r\n+                IslandWindow::HideCursor();\r\n+            }\r\n+        }\r\n+\r\n+        if (IslandWindow::IsCursorHidden())\r\n+        {\r\n+            IslandWindow::ShowCursorMaybe(msg.message);\r\n         }\r\n \r\n         TranslateMessage(&msg);\r\n", "test_patch": "", "problem_statement": "[Terminal Canary] Cursor doesn't show up in Terminal\n### Windows Terminal version\n\n1.23.10011.0\n\n### Windows build number\n\n10.0.27764.1000\n\n### Other Software\n\nsudo for Windows (1.0.1)\n\n### Steps to reproduce\n\n1. Launch Terminal Canary \n2. Launch a command with `sudo`\n3. Hover over the terminal with the cursor\n\n### Expected Behavior\n\nThe cursor should be visible when you hover over the Terminal launched with administrative privileges.\n\n### Actual Behavior\n\nCursor isn't showing when you hover over the Terminal.\n\nhttps://github.com/user-attachments/assets/b0ace3d3-c69e-475b-bac9-c864db5d76c7\n\n\n", "hints_text": "Thanks for the report! This was most likely fixed by #18345. It took a while to merge it because we were out on vacation. It should be available in the next canary build (tomorrow?).\nStill happens even in the latest build. New plan: Ditch WinRT, and do it via Win32.", "created_at": "2025-01-21 13:02:50", "merge_commit_sha": "c56fb1b2d287db9ef1eb97545a81760e3faf3452", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18444", "base_commit": "25392ea6042242eceeb95cca29ca18784cf0ee7b", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 59f26b50b16..91e1a9bdb92 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -387,6 +387,9 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     MSG msg{};\r\n     while (GetMessageW(&msg, nullptr, 0, 0))\r\n     {\r\n+        // This is `if (WM_KEYDOWN || WM_KEYUP || WM_SYSKEYDOWN || WM_SYSKEYUP)`.\r\n+        // It really doesn't need to be written that obtuse, but it at\r\n+        // least nicely mirrors our `keyDown = msg.message & 1` logic.\r\n         // FYI: For the key-down/up messages the lowest bit indicates if it's up.\r\n         if ((msg.message & ~1) == WM_KEYDOWN || (msg.message & ~1) == WM_SYSKEYDOWN)\r\n         {\r\n@@ -401,7 +404,7 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n                 loggedInteraction = true;\r\n             }\r\n \r\n-            const bool keyDown = msg.message & 1;\r\n+            const bool keyDown = (msg.message & 1) == 0;\r\n             if (\r\n                 // GH#638: The Xaml input stack doesn't allow an application to suppress the \"caret browsing\"\r\n                 // dialog experience triggered when you press F7. Official recommendation from the Xaml\r\n@@ -438,15 +441,13 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     __assume(false);\r\n }\r\n \r\n-void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\r\n+void WindowEmperor::_dispatchSpecialKey(const MSG& msg) const\r\n {\r\n-    const auto hwnd = msg.hwnd;\r\n+    // Each CoreInput window is a child of our IslandWindow.\r\n+    // We can figure out the IslandWindow HWND via GetAncestor().\r\n+    const auto hwnd = GetAncestor(msg.hwnd, GA_ROOT);\r\n     AppHost* window = nullptr;\r\n \r\n-    // Just in case someone has targed a specific HWND,\r\n-    // we'll try to dispatch it to the corresponding class.\r\n-    // Usually this will not find anything because under WinUI the hidden CoreInput\r\n-    // window is responsible for all input handling (for whatever reason).\r\n     for (const auto& h : _windows)\r\n     {\r\n         const auto w = h->GetWindow();\r\n@@ -457,6 +458,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n         }\r\n     }\r\n \r\n+    // Fallback.\r\n     if (!window)\r\n     {\r\n         window = _mostRecentWindow();\r\n@@ -468,7 +470,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n \r\n     const auto vkey = gsl::narrow_cast<uint32_t>(msg.wParam);\r\n     const auto scanCode = gsl::narrow_cast<uint8_t>(msg.lParam >> 16);\r\n-    const bool keyDown = msg.message & 1;\r\n+    const bool keyDown = (msg.message & 1) == 0;\r\n     window->OnDirectKeyEvent(vkey, scanCode, keyDown);\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.h b/src/cascadia/WindowsTerminal/WindowEmperor.h\nindex 6b9b101507f..ca30159ac2d 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.h\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.h\n@@ -50,7 +50,7 @@ class WindowEmperor\n     AppHost* _mostRecentWindow() const noexcept;\r\n     bool _summonWindow(const SummonWindowSelectionArgs& args) const;\r\n     void _summonAllWindows() const;\r\n-    void _dispatchSpecialKey(MSG& msg) const;\r\n+    void _dispatchSpecialKey(const MSG& msg) const;\r\n     void _dispatchCommandline(winrt::TerminalApp::CommandlineArgs args);\r\n     safe_void_coroutine _dispatchCommandlineCurrentDesktop(winrt::TerminalApp::CommandlineArgs args);\r\n     LRESULT _messageHandler(HWND window, UINT message, WPARAM wParam, LPARAM lParam) noexcept;\r\n", "test_patch": "", "problem_statement": "Alt and F7 don't work in 1.23.3481.0\n### Windows Terminal version\n\n1.23.3481.0\n\n### Windows build number\n\n10.0.19045.5247\n\n### Other Software\n\nFAR Manager 3.0.6401.0 x64\n\nwhen migrate from canary build terminal-1.23.3461.0 to next canary build terminal-1.23.3481.0\ni have trouble with keys: Alt/RAlt and F7\n\n### Steps to reproduce\n\nrun utility KeyEvents.exe and press Alt and F7\n\n\n\n### Expected Behavior\n\nresult when press Alt:\n\nterminal-1.23.3461.0 - good behavior\n02:56:37 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n02:56:37 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\nresult when press f7:\n\nterminal-1.23.3461.0 - good behavior\n\n03:08:36 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:08:36 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n### Actual Behavior\n\nresult when press Alt:\n\nterminal-1.23.3481.0 - bad behavior\n02:54:44 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n\n\nresult when press f7:\n\nterminal-1.23.3481.0 - bad behavior\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n", "hints_text": "@lhecker @DHowett \n\nafter close issue is out:\nterminal-1.23.10061.0\nterminal-1.23.10081.0\n\nbut nothing fixed. \nThe problem still exists...", "created_at": "2025-01-21 12:52:11", "merge_commit_sha": "b33bde199226da043efc15f9cb90cc9971996898", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18325", "base_commit": "19460f98e059f1b4993a06afe5db2e412fa4b84d", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 66bc375d0af..6c25d4c8ade 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -170,6 +170,14 @@ static wil::unique_mutex acquireMutexOrAttemptHandoff(const wchar_t* className,\n                 .cbData = gsl::narrow<DWORD>(payload.size()),\r\n                 .lpData = payload.data(),\r\n             };\r\n+\r\n+            // Allow the existing instance to gain foreground rights.\r\n+            DWORD processId = 0;\r\n+            if (GetWindowThreadProcessId(hwnd, &processId) && processId)\r\n+            {\r\n+                AllowSetForegroundWindow(processId);\r\n+            }\r\n+\r\n             if (SendMessageTimeoutW(hwnd, WM_COPYDATA, 0, reinterpret_cast<LPARAM>(&cds), SMTO_ABORTIFHUNG | SMTO_ERRORONEXIT, 5000, nullptr))\r\n             {\r\n                 return {};\r\n", "test_patch": "", "problem_statement": "New window instances do not gain foreground rights\n### Windows Terminal version\n\n1.23.3471.0\n\n### Windows build number\n\n_No response_\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n* Set \"New instance behavior\" to \"Create a new window\"\n* Launch from the start menu (= first window, first tab)\n* Explicitly minimize\n* Launch from the start menu again\n\n### Expected Behavior\n\nNew window is in the foreground.\n\n### Actual Behavior\n\nNew window fails to gain foreground rights.\n", "hints_text": "Can we `AllowSetForeground`? I suppose we don't know the PID of the instance holding the mutex, do we. hmm....", "created_at": "2024-12-13 16:36:26", "merge_commit_sha": "50060452ea115b85e2af672434db8a1c1e140f1f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18188", "base_commit": "772f546ac43f5c3bd8ecc2929ef2da8a5d0e886e", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/MainPage.cpp b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\nindex 739e0c5e6f8..62e496c1d15 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n@@ -457,6 +457,15 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \r\n         _SetupProfileEventHandling(profile);\r\n \r\n+        if (profile.Orphaned())\r\n+        {\r\n+            contentFrame().Navigate(xaml_typename<Editor::Profiles_Base_Orphaned>(), winrt::make<implementation::NavigateToProfileArgs>(profile, *this));\r\n+            const auto crumb = winrt::make<Breadcrumb>(box_value(profile), profile.Name(), BreadcrumbSubPage::None);\r\n+            _breadcrumbs.Append(crumb);\r\n+            profile.CurrentPage(ProfileSubPage::Base);\r\n+            return;\r\n+        }\r\n+\r\n         contentFrame().Navigate(xaml_typename<Editor::Profiles_Base>(), winrt::make<implementation::NavigateToProfileArgs>(profile, *this));\r\n         const auto crumb = winrt::make<Breadcrumb>(box_value(profile), profile.Name(), BreadcrumbSubPage::None);\r\n         _breadcrumbs.Append(crumb);\r\n@@ -621,6 +630,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         _Navigate(profileViewModel, BreadcrumbSubPage::None);\r\n     }\r\n \r\n+    static MUX::Controls::InfoBadge _createGlyphIconBadge(wil::zwstring_view glyph)\r\n+    {\r\n+        MUX::Controls::InfoBadge badge;\r\n+        MUX::Controls::FontIconSource icon;\r\n+        icon.FontFamily(winrt::Windows::UI::Xaml::Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n+        icon.FontSize(12);\r\n+        icon.Glyph(glyph);\r\n+        badge.IconSource(icon);\r\n+        return badge;\r\n+    }\r\n+\r\n     MUX::Controls::NavigationViewItem MainPage::_CreateProfileNavViewItem(const Editor::ProfileViewModel& profile)\r\n     {\r\n         MUX::Controls::NavigationViewItem profileNavItem;\r\n@@ -628,6 +648,15 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         profileNavItem.Tag(box_value<Editor::ProfileViewModel>(profile));\r\n         profileNavItem.Icon(UI::IconPathConverter::IconWUX(profile.EvaluatedIcon()));\r\n \r\n+        if (profile.Orphaned())\r\n+        {\r\n+            profileNavItem.InfoBadge(_createGlyphIconBadge(L\"\\xE7BA\") /* Warning Triangle */);\r\n+        }\r\n+        else if (profile.Hidden())\r\n+        {\r\n+            profileNavItem.InfoBadge(_createGlyphIconBadge(L\"\\xED1A\") /* Hide */);\r\n+        }\r\n+\r\n         // Update the menu item when the icon/name changes\r\n         auto weakMenuItem{ make_weak(profileNavItem) };\r\n         profile.PropertyChanged([weakMenuItem](const auto&, const WUX::Data::PropertyChangedEventArgs& args) {\r\n@@ -642,6 +671,10 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n                 {\r\n                     menuItem.Content(box_value(tag.Name()));\r\n                 }\r\n+                else if (args.PropertyName() == L\"Hidden\")\r\n+                {\r\n+                    menuItem.InfoBadge(tag.Hidden() ? _createGlyphIconBadge(L\"\\xED1A\") /* Hide */ : nullptr);\r\n+                }\r\n             }\r\n         });\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj b/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\nindex 7d2aed1b744..7d6456886ac 100644\n--- a/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\n+++ b/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\n@@ -113,6 +113,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </ClInclude>\r\n+    <ClInclude Include=\"Profiles_Base_Orphaned.h\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </ClInclude>\r\n     <ClInclude Include=\"Profiles_Advanced.h\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n@@ -176,6 +180,9 @@\n     <Page Include=\"Profiles_Base.xaml\">\r\n       <SubType>Designer</SubType>\r\n     </Page>\r\n+    <Page Include=\"Profiles_Base_Orphaned.xaml\">\r\n+      <SubType>Designer</SubType>\r\n+    </Page>\r\n     <Page Include=\"Profiles_Advanced.xaml\">\r\n       <SubType>Designer</SubType>\r\n     </Page>\r\n@@ -269,6 +276,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </ClCompile>\r\n+    <ClCompile Include=\"Profiles_Base_Orphaned.cpp\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </ClCompile>\r\n     <ClCompile Include=\"Profiles_Advanced.cpp\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n@@ -354,6 +365,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </Midl>\r\n+    <Midl Include=\"Profiles_Base_Orphaned.idl\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </Midl>\r\n     <Midl Include=\"Profiles_Advanced.idl\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\nindex 66d8371c3ea..ab927bd890b 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\n@@ -225,6 +225,11 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         return !IsBaseLayer();\r\n     }\r\n \r\n+    bool ProfileViewModel::Orphaned() const\r\n+    {\r\n+        return _profile.Orphaned();\r\n+    }\r\n+\r\n     Editor::AppearanceViewModel ProfileViewModel::DefaultAppearance()\r\n     {\r\n         return _defaultAppearanceViewModel;\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\nindex c396fe38ec8..0b84a515ead 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\n@@ -85,6 +85,8 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         bool AutoMarkPromptsAvailable() const noexcept;\r\n         bool RepositionCursorWithMouseAvailable() const noexcept;\r\n \r\n+        bool Orphaned() const;\r\n+\r\n         til::typed_event<Editor::ProfileViewModel, Editor::DeleteProfileEventArgs> DeleteProfileRequested;\r\n \r\n         VIEW_MODEL_OBSERVABLE_PROPERTY(ProfileSubPage, CurrentPage);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\nindex 9bf20079cba..08f0108a8a9 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\n@@ -81,6 +81,7 @@ namespace Microsoft.Terminal.Settings.Editor\n         void CreateUnfocusedAppearance();\r\n         void DeleteUnfocusedAppearance();\r\n \r\n+\tBoolean Orphaned { get; };\r\n         OBSERVABLE_PROJECTED_PROFILE_SETTING(String, Name);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Guid, Guid);\r\n         OBSERVABLE_PROJECTED_PROFILE_SETTING(String, Source);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp\nnew file mode 100644\nindex 00000000000..bc27cc4c2da\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp\n@@ -0,0 +1,50 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+#include \"pch.h\"\n+#include \"Profiles_Base_Orphaned.h\"\n+#include \"Profiles_Base_Orphaned.g.cpp\"\n+#include \"ProfileViewModel.h\"\n+\n+#include <LibraryResources.h>\n+#include \"..\\WinRTUtils\\inc\\Utils.h\"\n+\n+using namespace winrt::Windows::UI::Xaml;\n+using namespace winrt::Windows::UI::Xaml::Controls;\n+using namespace winrt::Windows::UI::Xaml::Navigation;\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n+{\n+    Profiles_Base_Orphaned::Profiles_Base_Orphaned()\n+    {\n+        InitializeComponent();\n+        Automation::AutomationProperties::SetName(DeleteButton(), RS_(L\"Profile_DeleteButton/Text\"));\n+    }\n+\n+    void Profiles_Base_Orphaned::OnNavigatedTo(const NavigationEventArgs& e)\n+    {\n+        const auto args = e.Parameter().as<Editor::NavigateToProfileArgs>();\n+        _Profile = args.Profile();\n+\n+        _layoutUpdatedRevoker = LayoutUpdated(winrt::auto_revoke, [this](auto /*s*/, auto /*e*/) {\n+            // This event fires every time the layout changes, but it is always the last one to fire\n+            // in any layout change chain. That gives us great flexibility in finding the right point\n+            // at which to initialize our renderer (and our terminal).\n+            // Any earlier than the last layout update and we may not know the terminal's starting size.\n+\n+            // Only let this succeed once.\n+            _layoutUpdatedRevoker.revoke();\n+\n+            if (_Profile.FocusDeleteButton())\n+            {\n+                DeleteButton().Focus(FocusState::Programmatic);\n+                _Profile.FocusDeleteButton(false);\n+            }\n+        });\n+    }\n+\n+    void Profiles_Base_Orphaned::DeleteConfirmation_Click(const IInspectable& /*sender*/, const RoutedEventArgs& /*e*/)\n+    {\n+        winrt::get_self<ProfileViewModel>(_Profile)->DeleteProfile();\n+    }\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h\nnew file mode 100644\nindex 00000000000..3fca070c89e\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h\n@@ -0,0 +1,30 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+#pragma once\n+\n+#include \"Profiles_Base_Orphaned.g.h\"\n+#include \"ViewModelHelpers.h\"\n+#include \"Utils.h\"\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n+{\n+    struct Profiles_Base_Orphaned : public HasScrollViewer<Profiles_Base_Orphaned>, Profiles_Base_OrphanedT<Profiles_Base_Orphaned>\n+    {\n+    public:\n+        Profiles_Base_Orphaned();\n+\n+        void OnNavigatedTo(const Windows::UI::Xaml::Navigation::NavigationEventArgs& e);\n+        void DeleteConfirmation_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& e);\n+\n+        WINRT_PROPERTY(Editor::ProfileViewModel, Profile, nullptr);\n+\n+    private:\n+        winrt::Windows::UI::Xaml::Controls::SwapChainPanel::LayoutUpdated_revoker _layoutUpdatedRevoker;\n+    };\n+};\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::factory_implementation\n+{\n+    BASIC_FACTORY(Profiles_Base_Orphaned);\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl\nnew file mode 100644\nindex 00000000000..e0266fd3d8a\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl\n@@ -0,0 +1,13 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+import \"ProfileViewModel.idl\";\n+\n+namespace Microsoft.Terminal.Settings.Editor\n+{\n+    [default_interface] runtimeclass Profiles_Base_Orphaned : Windows.UI.Xaml.Controls.Page\n+    {\n+        Profiles_Base_Orphaned();\n+        ProfileViewModel Profile { get; };\n+    }\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml\nnew file mode 100644\nindex 00000000000..a21bbf5e85b\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml\n@@ -0,0 +1,59 @@\n+<!--\r\n+    Copyright (c) Microsoft Corporation. All rights reserved. Licensed under\r\n+    the MIT License. See LICENSE in the project root for license information.\r\n+-->\r\n+<Page x:Class=\"Microsoft.Terminal.Settings.Editor.Profiles_Base_Orphaned\"\r\n+      xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\"\r\n+      xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\"\r\n+      xmlns:d=\"http://schemas.microsoft.com/expression/blend/2008\"\r\n+      xmlns:local=\"using:Microsoft.Terminal.Settings.Editor\"\r\n+      xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"\r\n+      xmlns:model=\"using:Microsoft.Terminal.Settings.Model\"\r\n+      xmlns:mtu=\"using:Microsoft.Terminal.UI\"\r\n+      xmlns:muxc=\"using:Microsoft.UI.Xaml.Controls\"\r\n+      mc:Ignorable=\"d\">\r\n+\r\n+    <Page.Resources>\r\n+        <ResourceDictionary>\r\n+            <ResourceDictionary.MergedDictionaries>\r\n+                <ResourceDictionary Source=\"CommonResources.xaml\" />\r\n+            </ResourceDictionary.MergedDictionaries>\r\n+        </ResourceDictionary>\r\n+    </Page.Resources>\r\n+\r\n+    <StackPanel Style=\"{StaticResource SettingsStackStyle}\">\r\n+        <!--  Delete Button  -->\r\n+        <local:SettingContainer x:Uid=\"Profile_Delete_Orphaned\">\r\n+            <local:SettingContainer.Content>\r\n+                <Button x:Name=\"DeleteButton\"\r\n+                        Click=\"DeleteConfirmation_Click\"\r\n+                        Style=\"{StaticResource DeleteButtonStyle}\">\r\n+                    <Button.Content>\r\n+                        <StackPanel Orientation=\"Horizontal\">\r\n+                            <FontIcon FontSize=\"{StaticResource StandardIconSize}\"\r\n+                                      Glyph=\"&#xE74D;\" />\r\n+                            <TextBlock x:Uid=\"Profile_DeleteButton\"\r\n+                                       Margin=\"10,0,0,0\" />\r\n+                        </StackPanel>\r\n+                    </Button.Content>\r\n+                </Button>\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+\r\n+        <local:SettingContainer x:Uid=\"Profile_Name\">\r\n+            <local:SettingContainer.Content>\r\n+                <TextBlock FontFamily=\"Segoe UI, Segoe Fluent Icons, Segoe MDL2 Assets\"\r\n+                           Style=\"{StaticResource SettingsPageItemDescriptionStyle}\"\r\n+                           Text=\"{x:Bind Profile.Name, Mode=OneTime}\" />\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+\r\n+        <local:SettingContainer x:Uid=\"Profile_Source_Orphaned\">\r\n+            <local:SettingContainer.Content>\r\n+                <TextBlock FontFamily=\"Segoe UI, Segoe Fluent Icons, Segoe MDL2 Assets\"\r\n+                           Style=\"{StaticResource SettingsPageItemDescriptionStyle}\"\r\n+                           Text=\"{x:Bind Profile.Source, Mode=OneTime}\" />\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+    </StackPanel>\r\n+</Page>\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex 46524ca62d4..86c0ae46144 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -1961,4 +1961,16 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+  <data name=\"Profile_Delete_Orphaned.Header\" xml:space=\"preserve\">\r\n+    <value>Profile no longer detected</value>\r\n+  </data>\r\n+  <data name=\"Profile_Delete_Orphaned.HelpText\" xml:space=\"preserve\">\r\n+    <value>This automatically-detected profile appears to have been uninstalled. Changes you have made to it are preserved, but it cannot be used until it has been reinstalled.</value>\r\n+  </data>\r\n+  <data name=\"Profile_Source_Orphaned.Header\" xml:space=\"preserve\">\r\n+    <value>Original Source</value>\r\n+  </data>\r\n+  <data name=\"Profile_Source_Orphaned.HelpText\" xml:space=\"preserve\">\r\n+    <value>Indicates the software that originally created this profile.</value>\r\n+  </data>\r\n+</root>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\nindex 6b412d28b68..eeb3d7cc2e3 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\n@@ -103,7 +103,7 @@ Model::CascadiaSettings CascadiaSettings::Copy() const\n             for (const auto& profile : targetProfiles)\r\n             {\r\n                 allProfiles.emplace_back(*profile);\r\n-                if (!profile->Hidden())\r\n+                if (!profile->Hidden() && !profile->Orphaned())\r\n                 {\r\n                     activeProfiles.emplace_back(*profile);\r\n                 }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\nindex 15a6bd153c9..ea9bda76166 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n@@ -1226,12 +1226,12 @@ CascadiaSettings::CascadiaSettings(SettingsLoader&& loader) :\n             const auto& parents = profile->Parents();\r\n             if (std::none_of(parents.begin(), parents.end(), [&](const auto& parent) { return parent->Source() == source; }))\r\n             {\r\n-                continue;\r\n+                profile->Orphaned(true);\r\n             }\r\n         }\r\n \r\n         allProfiles.emplace_back(*profile);\r\n-        if (!profile->Hidden())\r\n+        if (!profile->Hidden() && !profile->Orphaned())\r\n         {\r\n             activeProfiles.emplace_back(*profile);\r\n         }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.cpp b/src/cascadia/TerminalSettingsModel/Profile.cpp\nindex 561a21017fc..88ae6e8590b 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Profile.cpp\n@@ -104,6 +104,7 @@ winrt::com_ptr<Profile> Profile::CopySettings() const\n     const auto defaultAppearance = AppearanceConfig::CopyAppearance(winrt::get_self<AppearanceConfig>(_DefaultAppearance), weakProfile);\r\n \r\n     profile->_Deleted = _Deleted;\r\n+    profile->_Orphaned = _Orphaned;\r\n     profile->_Updates = _Updates;\r\n     profile->_Guid = _Guid;\r\n     profile->_Name = _Name;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.h b/src/cascadia/TerminalSettingsModel/Profile.h\nindex 24fbb7d1f2d..86110c206ea 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.h\n+++ b/src/cascadia/TerminalSettingsModel/Profile.h\n@@ -115,6 +115,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         void Icon(const hstring& value);\r\n \r\n         WINRT_PROPERTY(bool, Deleted, false);\r\n+        WINRT_PROPERTY(bool, Orphaned, false);\r\n         WINRT_PROPERTY(OriginTag, Origin, OriginTag::None);\r\n         WINRT_PROPERTY(guid, Updates);\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.idl b/src/cascadia/TerminalSettingsModel/Profile.idl\nindex b93a52aa797..331fc1345cf 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.idl\n+++ b/src/cascadia/TerminalSettingsModel/Profile.idl\n@@ -41,6 +41,8 @@ namespace Microsoft.Terminal.Settings.Model\n \r\n         // True if the user explicitly removed this Profile from settings.json.\r\n         Boolean Deleted { get; };\r\n+        // True if the user *kept* this Profile, but it disappeared from the system.\r\n+        Boolean Orphaned { get; };\r\n \r\n         // Helper for magically using a commandline for an icon for a profile\r\n         // without an explicit icon.\r\n", "test_patch": "", "problem_statement": "Re-registered WSL distro profiles do not get auto generated on terminal restart unless state.json is deleted.\n### Windows Terminal version (or Windows build number)\n\nMicrosoft Windows [Version 10.0.19043.1237]\n\n### Other Software\n\nWSL\n\n### Steps to reproduce\n\n- close terminal\r\n- re-register an existing WSL distribution which had an existing profile in WT before\r\n- remove that profile from WT's config\r\n- open terminal\r\n- config file does NOT contain the new distribution's auto-generated profile\n\n### Expected Behavior\n\nAn auto-generated profile for the WSL distro which was registered.\n\n### Actual Behavior\n\nA profile is not added automatically, to make WT add the profile, the state.json file must be deleted, and the terminal must be reopened.\r\n\r\nI'm just blindly guessing but I'm assuming this bug as to do w caching existing profiles in state.json, wt looks at the guid in state.json, assumes thats already generated, and skips trying to generate it again for the config.\r\n\r\nAlso, just for my own curiosity, how are the GUIDs generated for a distro? Is it a uuid v5 with the terminal uuid namespace? I registered a custom distro using `wsl --import` and it gave it a GUID too. A uuid v5 is what i could tell from the source code, but i tried generating some UUID v5s myself using the terminal's runtime namespace and the name of the distro, and the results weren't the same.\n", "hints_text": "Ok so I may have found the cause,\r\n\r\nBefore:\r\n\r\n![image](https://user-images.githubusercontent.com/67145097/137368092-4cc0921b-e68b-4b8e-a0da-692718a4171c.png)\r\n\r\n\r\nAs you can see, `state.json` has the `Ubuntu` distro's GUID in the `generatedProfiles` array.\r\n\r\nNow lets assume that the user decides to uninstall Ubuntu, and hence removes the Ubuntu profile from `settings.json`,\r\n\r\n![image](https://user-images.githubusercontent.com/67145097/137368291-74b52954-5df6-469e-ac6e-ed7f16a546d2.png)\r\n\r\n\r\nAs you can see, the GUID of `Ubuntu` isn't removed from `state.json` upon removing it from `settings.json`.\r\n\r\nNow lets assume that the user decides to reinstall Ubuntu again, and restarts Windows Terminal, since the GUID of Ubuntu is still in the generatedProfiles array even thought the profile IS NOT generated, the Ubuntu profile won't be regenerated this time, hence causing the bug.\r\n\r\nThe workaround has been to remove the GUID of that distro which is still stuck in state.json and make any modification to the config causing the state.json file to be rewritten.\nOkay yep, that's exactly what happened here. Same as in #11593.\r\n\r\n1. We found the WSL profile, generated it into the settings.json file, and then added that guid to `state.json` so we wouldn't generate it again.\r\n2. We saw that the distro was gone, so we _removed it from the file_\r\n3. When we re-found the profile, we see that we already added it into the `state`, so we skip it.\r\n\r\nWe should maybe not do 2 anymore. @lhecker thoughts?\nYes, we should not do 2. Only now after #11184 merged do we have the ability to _find_ disconnected generator \"leaf profiles.\" They used to be omitted from the settings model entirely at parse time.\r\n\r\nI've mentioned to a couple of you a UI that would display something like, \"This profile was generated and seems to have disappeared. We've *kept your local copy* just in case.\" etc.\n(we only do 2 when you [save] while the distro is gone. That's still a big footgun.)\nOh right I meant to test this today...\r\nIf I remove my WSL distro and launch WT the distro is _not_ removed from the file. However hitting \"Save\" in the settings UI removes it, as only \"visible\" profiles are saved.\r\nImplementing Dustin's suggestion shouldn't be too hard. This is the code responsible for removing such profiles: https://github.com/microsoft/terminal/blob/9662bc69102e2e152a062a9060cb63d2742582d3/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp#L776-L788\r\n\r\nI'm not sure if it would be enough to simply mark such profiles as \"hidden\".\nSo i had this problem just now when re-registering Debian, i notice that it didn't created the Debian profile even when i wanted to duplicate.\r\n\r\nTo resolve what i did was delete all `generatedProfiles` in `state.json` that wasn't in use in `settings.json`, then i go to duplicate a profile, and this time Debian was a option.", "created_at": "2024-11-13 18:55:33", "merge_commit_sha": "90866c7c93c4743926d481b07d66a3e3e4eb1da8", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18132", "base_commit": "fa8273065f7d95b0a2588e27a174ad443755bc17", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.xaml b/src/cascadia/TerminalApp/CommandPalette.xaml\nindex eb47534f9c5..2ed0c136e5f 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.xaml\n+++ b/src/cascadia/TerminalApp/CommandPalette.xaml\n@@ -23,6 +23,27 @@\n \r\n     <UserControl.Resources>\r\n         <ResourceDictionary>\r\n+            <!--  KeyChordText styles  -->\r\n+            <Style x:Key=\"KeyChordBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n+                <Setter Property=\"Background\" Value=\"Transparent\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <Style x:Key=\"KeyChordTextBlockStyle\"\r\n+                   TargetType=\"TextBlock\">\r\n+                <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <!--  ParsedCommandLineText styles  -->\r\n+            <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n+                <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n+            </Style>\r\n+\r\n             <DataTemplate x:Key=\"ListItemTemplate\"\r\n                           x:DataType=\"local:FilteredCommand\">\r\n                 <ListViewItem HorizontalContentAlignment=\"Stretch\"\r\n@@ -69,12 +90,12 @@\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n                             Background=\"{ThemeResource FlyoutPresenterBackground}\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n                 </Grid>\r\n@@ -118,12 +139,12 @@\n                             HorizontalAlignment=\"Right\"\r\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n \r\n@@ -219,79 +240,6 @@\n                                                GeneralItemTemplate=\"{StaticResource GeneralItemTemplate}\"\r\n                                                NestedItemTemplate=\"{StaticResource NestedItemTemplate}\"\r\n                                                TabItemTemplate=\"{StaticResource TabItemTemplate}\" />\r\n-\r\n-            <ResourceDictionary.ThemeDictionaries>\r\n-                <ResourceDictionary x:Key=\"Dark\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"Light\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"HighContrast\">\r\n-\r\n-                    <!--  KeyChordText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-\r\n-                    <!--  ParsedCommandLineText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-                </ResourceDictionary>\r\n-            </ResourceDictionary.ThemeDictionaries>\r\n         </ResourceDictionary>\r\n     </UserControl.Resources>\r\n \r\n@@ -375,7 +323,7 @@\n                     Padding=\"16,12\"\r\n                     HorizontalAlignment=\"Stretch\"\r\n                     VerticalAlignment=\"Center\"\r\n-                    Style=\"{ThemeResource ParsedCommandLineBorderStyle}\"\r\n+                    Style=\"{StaticResource ParsedCommandLineBorderStyle}\"\r\n                     Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(ParsedCommandLineText), Mode=OneWay}\">\r\n \r\n                 <ScrollViewer MaxHeight=\"200\"\r\n", "test_patch": "", "problem_statement": "[Windows Terminal - Command Palette]: 'Shortcut keys' in 'Command Palette' are not visible in high contrast themes for focused or hovered rows.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Pre-requisite:**\r\nSettings>Accessibility>Contrast themes>Aquatic/Desert theme>Reopen the application.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Follow the above-mentioned pre-requisite step.\r\n3. Now open any application like 'Windows Terminal'.\r\n4. Open command Palette by pressing 'Ctrl + Shift + P' keys.\r\n5. 'Command Palette' will open.\r\n6.  Now navigate to any row by up/down arrow keys or hover with mouse.\r\n7. Observe the issue.\r\n\r\n**User experience:**\r\nUsers relying on high contrast themes, especially those with visual impairments, may find it challenging to see the shortcut keys in the Command Palette. This issue impacts navigation efficiency, as users cannot easily identify or use the shortcuts for commands.\r\n\r\n**MAS Reference Link:**\r\n[MAS 4.3.1 \u2013 No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)\r\n\r\n**Attachment:**\r\n[Shortcut keys is not visible in high contrast themes.zip](https://github.com/user-attachments/files/16973765/Shortcut.keys.is.not.visible.in.high.contrast.themes.zip)\n\n### Expected Behavior\n\nThe shortcut keys for commands in the Command Palette should be clearly visible in high contrast themes when rows are focused or hovered. Proper contrast between the text and background should ensure that users can easily see the shortcut keys.\n\n### Actual Behavior\n\nThe shortcut keys associated with the commands in the Command Palette are not visible or are poorly visible when focused or hovered in high contrast themes. The lack of proper contrast makes it difficult to see the shortcut keys, impairing navigation.\n", "hints_text": "", "created_at": "2024-10-31 18:20:02", "merge_commit_sha": "e83434ff7e921b19f216bcd0dde3fe2dd8be6c04", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18116", "base_commit": "8d3f12b1c065a965974cd6b5bc7a81176ffb0f1b", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex ec903dc5b80..9774c51844c 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -733,6 +733,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The name or GUID of the profile to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\n@@ -804,6 +807,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The ID of the action to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex b3111e9b639..99064fef8bb 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,7 +989,7 @@ namespace winrt::TerminalApp::implementation\n \n                 for (auto&& [profileIndex, remainingProfile] : remainingProfilesEntry.Profiles())\n                 {\n-                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex));\n+                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex, {}));\n                 }\n \n                 break;\n@@ -1003,7 +1003,7 @@ namespace winrt::TerminalApp::implementation\n                     break;\n                 }\n \n-                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex());\n+                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex(), profileEntry.Icon());\n                 items.push_back(profileItem);\n                 break;\n             }\n@@ -1013,7 +1013,7 @@ namespace winrt::TerminalApp::implementation\n                 const auto actionId = actionEntry.ActionId();\n                 if (_settings.ActionMap().GetActionByID(actionId))\n                 {\n-                    auto actionItem = _CreateNewTabFlyoutAction(actionId);\n+                    auto actionItem = _CreateNewTabFlyoutAction(actionId, actionEntry.Icon());\n                     items.push_back(actionItem);\n                 }\n \n@@ -1028,7 +1028,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given profile with the given index.\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex, const winrt::hstring& iconPathOverride)\n     {\n         auto profileMenuItem = WUX::Controls::MenuFlyoutItem{};\n \n@@ -1049,9 +1049,10 @@ namespace winrt::TerminalApp::implementation\n         auto profileName = profile.Name();\n         profileMenuItem.Text(profileName);\n \n-        // If there's an icon set for this profile, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = profile.EvaluatedIcon();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this profile, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? profile.EvaluatedIcon() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\n@@ -1112,7 +1113,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given action\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride)\n     {\n         auto actionMenuItem = WUX::Controls::MenuFlyoutItem{};\n         const auto action{ _settings.ActionMap().GetActionByID(actionId) };\n@@ -1125,9 +1126,10 @@ namespace winrt::TerminalApp::implementation\n \n         actionMenuItem.Text(action.Name());\n \n-        // If there's an icon set for this action, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = action.IconPath();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this action, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? action.IconPath() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 9e5d3029c7f..30627d5b7ee 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -316,8 +316,8 @@ namespace winrt::TerminalApp::implementation\n         void _CreateNewTabFlyout();\n         std::vector<winrt::Windows::UI::Xaml::Controls::MenuFlyoutItemBase> _CreateNewTabFlyoutItems(winrt::Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::NewTabMenuEntry> entries);\n         winrt::Windows::UI::Xaml::Controls::IconElement _CreateNewTabFlyoutIcon(const winrt::hstring& icon);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex, const winrt::hstring& iconPathOverride);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride);\n \n         void _OpenNewTabDropdown();\n         HRESULT _OpenNewTab(const Microsoft::Terminal::Settings::Model::INewContentArgs& newContentArgs);\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\nindex b48207e74e9..6f7773e715c 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ActionIdKey{ \"id\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ActionEntry::ActionEntry() noexcept :\r\n     ActionEntryT<ActionEntry, NewTabMenuEntry>(NewTabMenuEntryType::Action)\r\n@@ -22,6 +23,7 @@ Json::Value ActionEntry::ToJson() const\n     auto json = NewTabMenuEntry::ToJson();\r\n \r\n     JsonUtils::SetValueForKey(json, ActionIdKey, _ActionId);\r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n \r\n     return json;\r\n }\r\n@@ -31,6 +33,7 @@ winrt::com_ptr<NewTabMenuEntry> ActionEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ActionEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ActionIdKey, entry->_ActionId);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.h b/src/cascadia/TerminalSettingsModel/ActionEntry.h\nindex 9c89077828c..711cec13bfc 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.h\n@@ -28,6 +28,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         static com_ptr<NewTabMenuEntry> FromJson(const Json::Value& json);\r\n \r\n         WINRT_PROPERTY(winrt::hstring, ActionId);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n     };\r\n }\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\nindex 84bc3777695..acf1f33f6f4 100644\n--- a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n+++ b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n@@ -33,6 +33,7 @@ namespace Microsoft.Terminal.Settings.Model\n \r\n         Profile Profile;\r\n         Int32 ProfileIndex;\r\n+        String Icon;\r\n     }\r\n \r\n     [default_interface] runtimeclass ActionEntry : NewTabMenuEntry\r\n@@ -40,6 +41,7 @@ namespace Microsoft.Terminal.Settings.Model\n         ActionEntry();\r\n \r\n         String ActionId;\r\n+        String Icon;\r\n     }\r\n \r\n     enum FolderEntryInlining\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\nindex c857eea8678..5f01a293beb 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ProfileKey{ \"profile\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ProfileEntry::ProfileEntry() noexcept :\r\n     ProfileEntry{ winrt::hstring{} }\r\n@@ -46,6 +47,8 @@ Json::Value ProfileEntry::ToJson() const\n         JsonUtils::SetValueForKey(json, ProfileKey, _Profile.Guid());\r\n     }\r\n \r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n+\r\n     return json;\r\n }\r\n \r\n@@ -54,6 +57,7 @@ winrt::com_ptr<NewTabMenuEntry> ProfileEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ProfileEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ProfileKey, entry->_ProfileName);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.h b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\nindex fe0f4573d29..9ea78497f1f 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n@@ -41,6 +41,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n \r\n         WINRT_PROPERTY(Model::Profile, Profile);\r\n         WINRT_PROPERTY(int, ProfileIndex);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n \r\n     private:\r\n         winrt::hstring _ProfileName;\r\n", "test_patch": "", "problem_statement": "In newTabMenu allow assignment/override of the icon property for the action items\n### Description of the new feature\n\nHi.\n\nOne small cosmetic suggestion. \n\nCurrently, I can define actions->command which I can then select as the action in newTabMenu.\nIf I would like to have an icon (or glyph) for that item displayed in the newTabMenu, icon needs to be defined at the level of actions->command. That will result in icon being visible in the command palette as well, which I'd like to avoid (I don't like it visually to have only one or a few items with the icon in a long list of commands).\n\nWould it be possible to have a possibility to define \"icon\" for newTabMenu action items (\"type\": \"action\"). That would allow assignment of desired icons/glyphs to desired commands only in newTabMenu and not in command palette.\n\nOther option would be to have a property on the actions->command item level that would allow for the icon not to be displayed in the command palette (e.g. iconVisibility to have one of the following values: \"newtabmenu\", \"commandpalette\", \"both\", \"none\").\n\nOne more thing that could work is to allow the whole custom command to be excluded from the command palette.\n\nThank you in advance!\n\n### Proposed technical implementation details\n\n_No response_\n", "hints_text": "It should totally let you do that! This must have just been overlooked in the initial implementation. \n\nSomething like:\n\n```json\n        {\n            \"type\": \"action\",\n            \"id\": \"User.scrollToMark.D3F0B923\",\n            \"icon\": \"d:\\\\dev\\\\public\\\\terminal\\\\res\\\\terminal.ico\"\n        }\n```\n\nshould totally work. Thanks for filing!\n\n(We should probably allow that for profile entries too)", "created_at": "2024-10-27 11:52:46", "merge_commit_sha": "5b634657980ecfa2d65e9ffec622dfd842839628", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18109", "base_commit": "8d3f12b1c065a965974cd6b5bc7a81176ffb0f1b", "patch": "diff --git a/src/cascadia/TerminalApp/TabBase.cpp b/src/cascadia/TerminalApp/TabBase.cpp\nindex 2d5e8da4433..55f2cffcb57 100644\n--- a/src/cascadia/TerminalApp/TabBase.cpp\n+++ b/src/cascadia/TerminalApp/TabBase.cpp\n@@ -458,45 +458,67 @@ namespace winrt::TerminalApp::implementation\n             deselectedFontBrush.Color(winrt::Windows::UI::Colors::White());\r\n         }\r\n \r\n-        // Prior to MUX 2.7, we set TabViewItemHeaderBackground, but now we can\r\n-        // use TabViewItem().Background() for that. HOWEVER,\r\n-        // TabViewItem().Background() only sets the color of the tab background\r\n-        // when the TabViewItem is unselected. So we still need to set the other\r\n-        // properties ourselves.\r\n-        //\r\n-        // In GH#11294 we thought we'd still need to set\r\n-        // TabViewItemHeaderBackground manually, but GH#11382 discovered that\r\n-        // Background() was actually okay after all.\r\n-\r\n-        const auto& tabItemResources{ TabViewItem().Resources() };\r\n-\r\n-        TabViewItem().Background(deselectedTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundSelected\"), selectedTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPointerOver\"), hoverTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPressed\"), selectedTabBrush);\r\n-\r\n-        // Similarly, TabViewItem().Foreground()  sets the color for the text\r\n-        // when the TabViewItem isn't selected, but not when it is hovered,\r\n-        // pressed, dragged, or selected, so we'll need to just set them all\r\n-        // anyways.\r\n-        TabViewItem().Foreground(deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForeground\"), deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundSelected\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPointerOver\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPressed\"), fontBrush);\r\n-\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForeground\"), deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPressed\"), secondaryFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPointerOver\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderPressedCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderPointerOverCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderSelectedCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPressed\"), subtleFillColorTertiaryBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\"), subtleFillColorSecondaryBrush);\r\n-\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundActiveTab\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundPressed\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundPointerOver\"), fontBrush);\r\n+        // Add the empty theme dictionaries\r\n+        const auto& tabItemThemeResources{ TabViewItem().Resources().ThemeDictionaries() };\r\n+        ResourceDictionary lightThemeDictionary;\r\n+        ResourceDictionary darkThemeDictionary;\r\n+        ResourceDictionary highContrastThemeDictionary;\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"Light\"), lightThemeDictionary);\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"Dark\"), darkThemeDictionary);\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"HighContrast\"), highContrastThemeDictionary);\r\n+\r\n+        // Now actually set the resources we want in them.\r\n+        // Before, we used to put these on the ResourceDictionary directly.\r\n+        // However, HighContrast mode may require some adjustments. So let's just add\r\n+        //   all three so we can make those adjustments on the HighContrast version.\r\n+        for (const auto& [k, v] : tabItemThemeResources)\r\n+        {\r\n+            const bool isHighContrast = winrt::unbox_value<hstring>(k) == L\"HighContrast\";\r\n+            const auto& currentDictionary = v.as<ResourceDictionary>();\r\n+\r\n+            // TabViewItem.Background\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackground\"), deselectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundSelected\"), selectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPointerOver\"), isHighContrast ? fontBrush : hoverTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPressed\"), selectedTabBrush);\r\n+\r\n+            // TabViewItem.Foreground (aka text)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForeground\"), deselectedFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundSelected\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPointerOver\"), isHighContrast ? selectedTabBrush : fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPressed\"), fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Foreground (aka X)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForeground\"), deselectedFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPressed\"), isHighContrast ? deselectedFontBrush : secondaryFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPointerOver\"), isHighContrast ? deselectedFontBrush : fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Foreground _when_ interacting with the tab\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderPressedCloseButtonForeground\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderPointerOverCloseButtonForeground\"), isHighContrast ? selectedTabBrush : fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderSelectedCloseButtonForeground\"), fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Background (aka X button)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackground\"), deselectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPressed\"), isHighContrast ? selectedTabBrush : subtleFillColorTertiaryBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\"), isHighContrast ? selectedTabBrush : subtleFillColorSecondaryBrush);\r\n+\r\n+            // A few miscellaneous resources that WinUI said may be removed in the future\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundActiveTab\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundPressed\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundPointerOver\"), fontBrush);\r\n+\r\n+            // Add a few extra ones for high contrast mode\r\n+            // BODGY: contrary to the docs, Insert() seems to throw if the value already exists\r\n+            //   Make sure you don't touch any that already exist here!\r\n+            if (isHighContrast)\r\n+            {\r\n+                // TabViewItem.CloseButton.Border: in HC mode, the border makes the button more clearly visible\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushPressed\"), fontBrush);\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushPointerOver\"), fontBrush);\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushSelected\"), fontBrush);\r\n+            }\r\n+        }\r\n \r\n         _RefreshVisualState();\r\n     }\r\n@@ -511,36 +533,55 @@ namespace winrt::TerminalApp::implementation\n     void TabBase::_ClearTabBackgroundColor()\r\n     {\r\n         static const winrt::hstring keys[] = {\r\n+            // TabViewItem.Background\r\n             L\"TabViewItemHeaderBackground\",\r\n             L\"TabViewItemHeaderBackgroundSelected\",\r\n             L\"TabViewItemHeaderBackgroundPointerOver\",\r\n             L\"TabViewItemHeaderBackgroundPressed\",\r\n+\r\n+            // TabViewItem.Foreground (aka text)\r\n             L\"TabViewItemHeaderForeground\",\r\n             L\"TabViewItemHeaderForegroundSelected\",\r\n             L\"TabViewItemHeaderForegroundPointerOver\",\r\n             L\"TabViewItemHeaderForegroundPressed\",\r\n+\r\n+            // TabViewItem.CloseButton.Foreground (aka X)\r\n             L\"TabViewItemHeaderCloseButtonForeground\",\r\n-            L\"TabViewItemHeaderCloseButtonForegroundPressed\",\r\n+            L\"TabViewItemHeaderForegroundSelected\",\r\n             L\"TabViewItemHeaderCloseButtonForegroundPointerOver\",\r\n+            L\"TabViewItemHeaderCloseButtonForegroundPressed\",\r\n+\r\n+            // TabViewItem.CloseButton.Foreground _when_ interacting with the tab\r\n             L\"TabViewItemHeaderPressedCloseButtonForeground\",\r\n             L\"TabViewItemHeaderPointerOverCloseButtonForeground\",\r\n             L\"TabViewItemHeaderSelectedCloseButtonForeground\",\r\n+\r\n+            // TabViewItem.CloseButton.Background (aka X button)\r\n+            L\"TabViewItemHeaderCloseButtonBackground\",\r\n             L\"TabViewItemHeaderCloseButtonBackgroundPressed\",\r\n             L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\",\r\n+\r\n+            // A few miscellaneous resources that WinUI said may be removed in the future\r\n             L\"TabViewButtonForegroundActiveTab\",\r\n             L\"TabViewButtonForegroundPressed\",\r\n-            L\"TabViewButtonForegroundPointerOver\"\r\n+            L\"TabViewButtonForegroundPointerOver\",\r\n+\r\n+            // TabViewItem.CloseButton.Border: in HC mode, the border makes the button more clearly visible\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushPressed\",\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushPointerOver\",\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushSelected\"\r\n         };\r\n \r\n-        const auto& tabItemResources{ TabViewItem().Resources() };\r\n+        const auto& tabItemThemeResources{ TabViewItem().Resources().ThemeDictionaries() };\r\n \r\n         // simply clear any of the colors in the tab's dict\r\n         for (const auto& keyString : keys)\r\n         {\r\n-            auto key = winrt::box_value(keyString);\r\n-            if (tabItemResources.HasKey(key))\r\n+            const auto key = winrt::box_value(keyString);\r\n+            for (const auto& [_, v] : tabItemThemeResources)\r\n             {\r\n-                tabItemResources.Remove(key);\r\n+                const auto& themeDictionary = v.as<ResourceDictionary>();\r\n+                themeDictionary.Remove(key);\r\n             }\r\n         }\r\n \r\n", "test_patch": "", "problem_statement": "[High Contrast] Colored tabs lose color when unfocused\n### Windows Terminal version\n\n1.14.1262.0\n\n### Windows build number\n\n10.0.22621.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Enter high contrast mode\r\n2. color a tab\r\n3. switch focus to another tab\n\n### Expected Behavior\n\ncolored tab should still retain the color\n\n### Actual Behavior\n\ncolored tab reverted to high contrast color (until focused again).\n", "hints_text": "", "created_at": "2024-10-25 22:46:54", "merge_commit_sha": "72df7ac20ea3e9d306ed68f2f600eee51f227f7b", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18106", "base_commit": "8e4da6e938430e11535e444032cfa2c32a6ab1a2", "patch": "diff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex b77cf969f49..1a896e0ced6 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -163,6 +163,7 @@ CBN\n cbt\n Ccc\n CCCBB\n+CCCDDD\n cch\n CCHAR\n CCmd\n@@ -369,6 +370,7 @@ DColor\n dcommon\n DComposition\n dde\n+DDDCCC\n DDESHARE\n DDevice\n DEADCHAR\ndiff --git a/src/buffer/out/Row.cpp b/src/buffer/out/Row.cpp\nindex 7a46215b6fc..63ba83f4cd5 100644\n--- a/src/buffer/out/Row.cpp\n+++ b/src/buffer/out/Row.cpp\n@@ -80,11 +80,12 @@ constexpr OutIt copy_n_small(InIt first, Diff count, OutIt dest)\n     return dest;\r\n }\r\n \r\n-CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept :\r\n+CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t charsLength, til::CoordType currentColumn, til::CoordType columnCount) noexcept :\r\n     _chars{ chars },\r\n     _charOffsets{ charOffsets },\r\n-    _lastCharOffset{ lastCharOffset },\r\n-    _currentColumn{ currentColumn }\r\n+    _charsLength{ charsLength },\r\n+    _currentColumn{ currentColumn },\r\n+    _columnCount{ columnCount }\r\n {\r\n }\r\n \r\n@@ -92,7 +93,7 @@ CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* cha\n // This function in particular returns the glyph's first column.\r\n til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept\r\n {\r\n-    targetOffset = clamp(targetOffset, 0, _lastCharOffset);\r\n+    targetOffset = clamp(targetOffset, 0, _charsLength);\r\n \r\n     // This code needs to fulfill two conditions on top of the obvious (a forward/backward search):\r\n     // A: We never want to stop on a column that is marked with CharOffsetsTrailer (= \"GetLeadingColumn\").\r\n@@ -130,10 +131,14 @@ til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) no\n til::CoordType CharToColumnMapper::GetTrailingColumnAt(ptrdiff_t offset) noexcept\r\n {\r\n     auto col = GetLeadingColumnAt(offset);\r\n-    // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n-    // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n-    for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+\r\n+    if (col < _columnCount)\r\n     {\r\n+        // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n+        // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n+        for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+        {\r\n+        }\r\n     }\r\n     return col;\r\n }\r\n@@ -1114,6 +1119,9 @@ std::wstring_view ROW::GetText() const noexcept\n     return { _chars.data(), width };\r\n }\r\n \r\n+// Arguments:\r\n+// - columnBegin: inclusive\r\n+// - columnEnd: exclusive\r\n std::wstring_view ROW::GetText(til::CoordType columnBegin, til::CoordType columnEnd) const noexcept\r\n {\r\n     const auto columns = GetReadableColumnCount();\r\n@@ -1219,15 +1227,15 @@ T ROW::_adjustForward(T column) const noexcept\n }\r\n \r\n // Creates a CharToColumnMapper given an offset into _chars.data().\r\n-// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120).\r\n+// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120].\r\n CharToColumnMapper ROW::_createCharToColumnMapper(ptrdiff_t offset) const noexcept\r\n {\r\n     const auto charsSize = _charSize();\r\n-    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize - 1);\r\n+    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize);\r\n     // We can sort of guess what column belongs to what offset because BMP glyphs are very common and\r\n     // UTF-16 stores them in 1 char. In other words, usually a ROW will have N chars for N columns.\r\n     const auto guessedColumn = gsl::narrow_cast<til::CoordType>(clamp(offset, 0, _columnCount));\r\n-    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn };\r\n+    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn, _columnCount };\r\n }\r\n \r\n const std::optional<ScrollbarData>& ROW::GetScrollbarData() const noexcept\r\ndiff --git a/src/buffer/out/Row.hpp b/src/buffer/out/Row.hpp\nindex d2c19036baf..44156d1b881 100644\n--- a/src/buffer/out/Row.hpp\n+++ b/src/buffer/out/Row.hpp\n@@ -71,7 +71,7 @@ struct RowCopyTextFromState\n // into a ROW's text this class can tell you what cell that pointer belongs to.\r\n struct CharToColumnMapper\r\n {\r\n-    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept;\r\n+    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn, til::CoordType columnCount) noexcept;\r\n \r\n     til::CoordType GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept;\r\n     til::CoordType GetTrailingColumnAt(ptrdiff_t offset) noexcept;\r\n@@ -85,8 +85,9 @@ struct CharToColumnMapper\n \r\n     const wchar_t* _chars;\r\n     const uint16_t* _charOffsets;\r\n-    ptrdiff_t _lastCharOffset;\r\n+    ptrdiff_t _charsLength;\r\n     til::CoordType _currentColumn;\r\n+    til::CoordType _columnCount;\r\n };\r\n \r\n class ROW final\r\ndiff --git a/src/buffer/out/UTextAdapter.cpp b/src/buffer/out/UTextAdapter.cpp\nindex ff0861ce54d..717d97812aa 100644\n--- a/src/buffer/out/UTextAdapter.cpp\n+++ b/src/buffer/out/UTextAdapter.cpp\n@@ -411,16 +411,13 @@ Microsoft::Console::ICU::unique_uregex Microsoft::Console::ICU::CreateRegex(cons\n     return unique_uregex{ re };\r\n }\r\n \r\n-// Returns an inclusive point range given a text start and end position.\r\n+// Returns a half-open [beg,end) range given a text start and end position.\r\n // This function is designed to be used with uregex_start64/uregex_end64.\r\n til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegularExpression* re)\r\n {\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     const auto nativeIndexBeg = uregex_start64(re, 0, &status);\r\n-    auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n-\r\n-    // The parameters are given as a half-open [beg,end) range, but the point_span we return in closed [beg,end].\r\n-    nativeIndexEnd--;\r\n+    const auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n \r\n     const auto& textBuffer = *static_cast<const TextBuffer*>(ut->context);\r\n     til::point_span ret;\r\n@@ -439,7 +436,7 @@ til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegula\n     if (utextAccess(ut, nativeIndexEnd, true))\r\n     {\r\n         const auto y = accessCurrentRow(ut);\r\n-        ret.end.x = textBuffer.GetRowByOffset(y).GetTrailingColumnAtCharOffset(ut->chunkOffset);\r\n+        ret.end.x = textBuffer.GetRowByOffset(y).GetLeadingColumnAtCharOffset(ut->chunkOffset);\r\n         ret.end.y = y;\r\n     }\r\n     else\r\ndiff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex a920854b732..df30a3ffb23 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -1118,6 +1118,14 @@ void TextBuffer::TriggerNewTextNotification(const std::wstring_view newText)\n     }\r\n }\r\n \r\n+void TextBuffer::TriggerSelection()\r\n+{\r\n+    if (_isActiveBuffer && _renderer)\r\n+    {\r\n+        _renderer->TriggerSelection();\r\n+    }\r\n+}\r\n+\r\n // Method Description:\r\n // - get delimiter class for buffer cell position\r\n // - used for double click selection and uia word navigation\r\n@@ -1132,6 +1140,213 @@ DelimiterClass TextBuffer::_GetDelimiterClassAt(const til::point pos, const std:\n     return GetRowByOffset(realPos.y).DelimiterClassAt(realPos.x, wordDelimiters);\r\n }\r\n \r\n+til::point TextBuffer::GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos < bufferSize.Origin())\r\n+    {\r\n+        // can't move further back, so return early at origin\r\n+        return bufferSize.Origin();\r\n+    }\r\n+    else if (pos >= limit)\r\n+    {\r\n+        // clamp to limit,\r\n+        // but still do movement\r\n+        pos = limit;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     CCC___|   -->   |CCC___  CCC|___\r\n+    //     DDD___|   -->   |DDD___  DDD|___\r\n+    //     ___CCC|   -->   ___|CCC  ___|CCC\r\n+    //     DDDCCC|   -->   DDD|CCC  DDD|CCC\r\n+    //     ___DDD|   -->   ___|DDD  ___|DDD\r\n+    //     CCCDDD|   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the beginning of the delimiter class run\r\n+    // 2. (includeWhitespace) if we were on a ControlChar, go back one more delimiter class run\r\n+    const auto initialDelimiter = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.Left())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the left boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+    else if (initialDelimiter == DelimiterClass::ControlChar)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+        pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+til::point TextBuffer::GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // can't move further forward,\r\n+        // so return early at limit\r\n+        return limit;\r\n+    }\r\n+    else if (const auto origin{ bufferSize.Origin() }; pos < origin)\r\n+    {\r\n+        // clamp to origin,\r\n+        // but still do movement\r\n+        pos = origin;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     |CCC___   -->   CCC___|  CCC|___\r\n+    //     |DDD___   -->   DDD___|  DDD|___\r\n+    //     |___CCC   -->   ___|CCC  ___|CCC\r\n+    //     |DDDCCC   -->   DDD|CCC  DDD|CCC\r\n+    //     |___DDD   -->   ___|DDD  ___|DDD\r\n+    //     |CCCDDD   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the end of the delimiter class run\r\n+    // 2. (includeWhitespace) if the next delimiter class run is a ControlChar, go forward one more delimiter class run\r\n+    pos = _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the right boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+\r\n+    if (const auto nextDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+        nextDelimClass == DelimiterClass::ControlChar)\r\n+    {\r\n+        return _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+bool TextBuffer::IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    if (!bufferSize.IsInExclusiveBounds(pos))\r\n+    {\r\n+        // not in bounds\r\n+        return false;\r\n+    }\r\n+\r\n+    // buffer boundaries are always word boundaries\r\n+    if (pos == bufferSize.Origin() || pos == bufferSize.BottomInclusiveRightExclusive())\r\n+    {\r\n+        return true;\r\n+    }\r\n+\r\n+    // at beginning of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.Left())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y - 1);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // at end of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // we can treat text as contiguous,\r\n+    // use DecrementInBounds (not exclusive) here\r\n+    auto prevPos = pos;\r\n+    bufferSize.DecrementInBounds(prevPos);\r\n+    const auto prevDelimiterClass = _GetDelimiterClassAt(prevPos, wordDelimiters);\r\n+\r\n+    // if we changed delimiter class\r\n+    // and the current delimiter class is not a control char,\r\n+    // we're at a word boundary\r\n+    const auto currentDelimiterClass = _GetDelimiterClassAt(pos, wordDelimiters);\r\n+    return prevDelimiterClass != currentDelimiterClass && currentDelimiterClass != DelimiterClass::ControlChar;\r\n+}\r\n+\r\n+til::point TextBuffer::_GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.Origin(); pos = nextPos)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.RightExclusive())\r\n+        {\r\n+            // wrapped onto previous line,\r\n+            // check if it was forced to wrap\r\n+            const auto& row = GetRowByOffset(nextPos.y);\r\n+            if (!row.WasWrapForced())\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (_GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class, we're done (don't apply move)\r\n+            return pos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+// Method Description:\r\n+// - Get the exclusive position for the end of the current delimiter class run\r\n+// Arguments:\r\n+// - pos - the buffer position being within the current delimiter class\r\n+// - wordDelimiters - what characters are we considering for the separation of words\r\n+til::point TextBuffer::_GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.BottomInclusiveRightExclusive(); pos = nextPos)\r\n+    {\r\n+        bufferSize.IncrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.Left())\r\n+        {\r\n+            // wrapped onto next line,\r\n+            // check if it was forced to wrap or switched delimiter class\r\n+            const auto& row = GetRowByOffset(pos.y);\r\n+            if (!row.WasWrapForced() || _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (bufferSize.IsInBounds(nextPos) && _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class,\r\n+            // apply the move and return\r\n+            return nextPos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n // Method Description:\r\n // - Get the til::point for the beginning of the word you are on\r\n // Arguments:\r\n@@ -1520,13 +1735,14 @@ til::point TextBuffer::GetGlyphStart(const til::point pos, std::optional<til::po\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    // limit is exclusive, so we need to move back to be within valid bounds\r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    // if we're on a trailing byte, move to the leading byte\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n         bufferSize.DecrementInBounds(resultPos, true);\r\n     }\r\n@@ -1548,12 +1764,13 @@ til::point TextBuffer::GetGlyphEnd(const til::point pos, bool accessibilityMode,\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n     {\r\n         bufferSize.IncrementInBounds(resultPos, true);\r\n     }\r\n@@ -1610,6 +1827,31 @@ bool TextBuffer::MoveToNextGlyph(til::point& pos, bool allowExclusiveEnd, std::o\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move forward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.IncrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Update pos to be the beginning of the previous glyph/character. This is used for accessibility\r\n // Arguments:\r\n@@ -1642,6 +1884,31 @@ bool TextBuffer::MoveToPreviousGlyph(til::point& pos, std::optional<til::point>\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move backward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.DecrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Determines the line-by-line rectangles based on two COORDs\r\n // - expands the rectangles to support wide glyphs\r\n@@ -1660,12 +1927,10 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n {\r\n     std::vector<til::inclusive_rect> textRects;\r\n \r\n-    const auto bufferSize = GetSize();\r\n-\r\n     // (0,0) is the top-left of the screen\r\n     // the physically \"higher\" coordinate is closer to the top-left\r\n     // the physically \"lower\" coordinate is closer to the bottom-right\r\n-    const auto [higherCoord, lowerCoord] = bufferSize.CompareInBounds(start, end) <= 0 ?\r\n+    const auto [higherCoord, lowerCoord] = start <= end ?\r\n                                                std::make_tuple(start, end) :\r\n                                                std::make_tuple(end, start);\r\n \r\n@@ -1686,6 +1951,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n         }\r\n         else\r\n         {\r\n+            const auto bufferSize = GetSize();\r\n             textRow.left = (row == higherCoord.y) ? higherCoord.x : bufferSize.Left();\r\n             textRow.right = (row == lowerCoord.y) ? lowerCoord.x : bufferSize.RightInclusive();\r\n         }\r\n@@ -1710,7 +1976,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n // - Else if a blockSelection, returns spans corresponding to each line in the block selection\r\n // Arguments:\r\n // - start: beginning of the text region of interest (inclusive)\r\n-// - end: the other end of the text region of interest (inclusive)\r\n+// - end: the other end of the text region of interest (exclusive)\r\n // - blockSelection: when enabled, get spans for each line covered by the block\r\n // - bufferCoordinates: when enabled, treat the coordinates as relative to\r\n //                      the buffer rather than the screen.\r\n@@ -1780,31 +2046,17 @@ void TextBuffer::_ExpandTextRow(til::inclusive_rect& textRow) const\n \r\n     // expand left side of rect\r\n     til::point targetPoint{ textRow.left, textRow.top };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.Left())\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.DecrementInExclusiveBounds(targetPoint);\r\n         textRow.left = targetPoint.x;\r\n     }\r\n \r\n     // expand right side of rect\r\n     targetPoint = { textRow.right, textRow.bottom };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.RightInclusive())\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.IncrementInExclusiveBounds(targetPoint);\r\n         textRow.right = targetPoint.x;\r\n     }\r\n }\r\n@@ -1821,8 +2073,8 @@ size_t TextBuffer::SpanLength(const til::point coordStart, const til::point coor\n // - Retrieves the plain text data between the specified coordinates.\r\n // Arguments:\r\n // - trimTrailingWhitespace - remove the trailing whitespace at the end of the result.\r\n-// - start - where to start getting text (should be at or prior to \"end\")\r\n-// - end - where to end getting text\r\n+// - start - where to start getting text (should be at or prior to \"end\") (inclusive)\r\n+// - end - where to end getting text (exclusive)\r\n // Return Value:\r\n // - Just the text.\r\n std::wstring TextBuffer::GetPlainText(const til::point start, const til::point end) const\r\n@@ -1851,7 +2103,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto maxX = req.bufferCoordinates ? req.maxX : ScreenToBufferLineInclusive(til::point{ req.maxX, iRow }, lineRendition).x;\r\n \r\n         rowBeg = minX;\r\n-        rowEnd = maxX + 1; // +1 to get an exclusive end\r\n+        rowEnd = maxX;\r\n     }\r\n     else\r\n     {\r\n@@ -1860,7 +2112,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto end = req.bufferCoordinates ? req.end : ScreenToBufferLineInclusive(req.end, lineRendition);\r\n \r\n         rowBeg = iRow != beg.y ? 0 : beg.x;\r\n-        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x + 1; // +1 to get an exclusive end\r\n+        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x;\r\n     }\r\n \r\n     // Our selection mechanism doesn't stick to glyph boundaries at the moment.\r\n@@ -1905,7 +2157,7 @@ std::wstring TextBuffer::GetPlainText(const CopyRequest& req) const\n         const auto& row = GetRowByOffset(iRow);\r\n         const auto& [rowBeg, rowEnd, addLineBreak] = _RowCopyHelper(req, iRow, row);\r\n \r\n-        // save selected text\r\n+        // save selected text (exclusive end)\r\n         selectedText += row.GetText(rowBeg, rowEnd);\r\n \r\n         if (addLineBreak && iRow != req.end.y)\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex c97de9e7523..775417caab0 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -170,9 +170,15 @@ class TextBuffer final\n     void TriggerScroll();\r\n     void TriggerScroll(const til::point delta);\r\n     void TriggerNewTextNotification(const std::wstring_view newText);\r\n+    void TriggerSelection();\r\n \r\n     til::point GetWordStart(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     til::point GetWordEnd(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    til::point GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    til::point GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    bool IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n     bool MoveToNextWord(til::point& pos, const std::wstring_view wordDelimiters, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousWord(til::point& pos, const std::wstring_view wordDelimiters) const;\r\n \r\n@@ -180,6 +186,8 @@ class TextBuffer final\n     til::point GetGlyphEnd(const til::point pos, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToNextGlyph(til::point& pos, bool allowBottomExclusive = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousGlyph(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n \r\n     const std::vector<til::inclusive_rect> GetTextRects(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n     std::vector<til::point_span> GetTextSpans(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n@@ -322,6 +330,8 @@ class TextBuffer final\n     void _SetFirstRowIndex(const til::CoordType FirstRowIndex) noexcept;\r\n     void _ExpandTextRow(til::inclusive_rect& selectionRow) const;\r\n     DelimiterClass _GetDelimiterClassAt(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForAccessibility(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForSelection(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordEndForAccessibility(const til::point target, const std::wstring_view wordDelimiters, const til::point limit) const;\r\ndiff --git a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\nindex be9e941c757..81974fe83ab 100644\n--- a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n+++ b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n@@ -49,15 +49,15 @@ class UTextAdapterTests\n             return { { beg, 0 }, { end, 0 } };\r\n         };\r\n \r\n-        auto expected = std::vector{ s(0, 2), s(8, 10) };\r\n+        auto expected = std::vector{ s(0, 3), s(8, 11) };\r\n         auto actual = buffer.SearchText(L\"abc\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(5, 5) };\r\n+        expected = std::vector{ s(5, 6) };\r\n         actual = buffer.SearchText(L\"\ud835\udcb7\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(12, 15) };\r\n+        expected = std::vector{ s(12, 16) };\r\n         actual = buffer.SearchText(L\"\u30cd\u30b3\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex b46da5236af..72a8e85ad55 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1200,7 +1200,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         const auto bufferSize{ _terminal->GetTextBuffer().GetSize() };\r\n         info.StartAtLeftBoundary = _terminal->GetSelectionAnchor().x == bufferSize.Left();\r\n-        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightInclusive();\r\n+        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightExclusive();\r\n         return info;\r\n     }\r\n \r\n@@ -1217,8 +1217,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             return;\r\n         }\r\n \r\n+        // clamp the converted position to be within the viewport bounds\r\n+        // x: allow range of [0, RightExclusive]\r\n+        // GH #18106: right exclusive needed for selection to support exclusive end\r\n         til::point terminalPosition{\r\n-            std::clamp(position.x, 0, _terminal->GetViewport().Width() - 1),\r\n+            std::clamp(position.x, 0, _terminal->GetViewport().Width()),\r\n             std::clamp(position.y, 0, _terminal->GetViewport().Height() - 1)\r\n         };\r\n \r\n@@ -2722,7 +2725,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bufferSize.DecrementInBounds(inclusiveEnd);\r\n \r\n         _terminal->SelectNewRegion(s.start, inclusiveEnd);\r\n-        _renderer->TriggerSelection();\r\n     }\r\n \r\n     void ControlCore::SelectCommand(const bool goUp)\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex 1da3b89ab1d..f4c0feed2a3 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -241,7 +241,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                               const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                               const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         const auto altEnabled = modifiers.IsAltPressed();\r\n         const auto shiftEnabled = modifiers.IsShiftPressed();\r\n@@ -338,7 +338,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                             const Core::Point pixelPosition,\r\n                                             const bool pointerPressedInBounds)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n         // Returning true from this function indicates that the caller should do no further processing of this movement.\r\n         bool handledCompletely = false;\r\n \r\n@@ -372,7 +372,19 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // _touchdown_ point here. We want to start the selection\r\n                     // from where the user initially clicked, not where they are\r\n                     // now.\r\n-                    _core->SetSelectionAnchor(_getTerminalPosition(til::point{ touchdownPoint }));\r\n+                    auto termPos = _getTerminalPosition(til::point{ touchdownPoint }, false);\r\n+                    if (dx < 0)\r\n+                    {\r\n+                        // _getTerminalPosition(_, false) will floor the x-value,\r\n+                        //   meaning that the selection will start on the left-side\r\n+                        //   of the current cell. This is great if the use is dragging\r\n+                        //   towards the right.\r\n+                        // If the user is dragging towards the left (dx < 0),\r\n+                        //   we want to select the current cell, so place the anchor on the right\r\n+                        //   side of the current cell.\r\n+                        termPos.x++;\r\n+                    }\r\n+                    _core->SetSelectionAnchor(termPos);\r\n \r\n                     // stop tracking the touchdown point\r\n                     _singleClickTouchdownPos = std::nullopt;\r\n@@ -428,7 +440,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                                const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                                const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, false);\r\n         // Short-circuit isReadOnly check to avoid warning dialog\r\n         if (!_core->IsInReadOnlyMode() && _canSendVTMouseInput(modifiers))\r\n         {\r\n@@ -475,7 +487,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                           const Core::Point pixelPosition,\r\n                                           const Control::MouseButtonState buttonState)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         // Short-circuit isReadOnly check to avoid warning dialog.\r\n         //\r\n@@ -662,7 +674,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - cursorPosition: in pixels, relative to the origin of the control\r\n     void ControlInteractivity::SetEndSelectionPoint(const Core::Point pixelPosition)\r\n     {\r\n-        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }));\r\n+        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }, true));\r\n         _selectionNeedsToBeCopied = true;\r\n     }\r\n \r\n@@ -672,12 +684,22 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Arguments:\r\n     // - pixelPosition: the (x,y) position of a given point (i.e.: mouse cursor).\r\n     //    NOTE: origin (0,0) is top-left.\r\n+    // - roundToNearestCell: if true, round the x-value. Otherwise, floor it (standard int division)\r\n     // Return Value:\r\n     // - the corresponding viewport terminal position for the given Point parameter\r\n-    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition)\r\n+    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell)\r\n     {\r\n         // Get the size of the font, which is in pixels\r\n-        const til::size fontSize{ _core->GetFont().GetSize() };\r\n+        const auto fontSize{ _core->GetFont().GetSize() };\r\n+\r\n+        if (roundToNearestCell)\r\n+        {\r\n+            // GH#5099: round the x-value to the nearest cell\r\n+            til::point result;\r\n+            result.x = gsl::narrow_cast<til::CoordType>(std::round(gsl::narrow_cast<double>(pixelPosition.x) / fontSize.width));\r\n+            result.y = pixelPosition.y / fontSize.height;\r\n+            return result;\r\n+        }\r\n         // Convert the location in pixels to characters within the current viewport.\r\n         return pixelPosition / fontSize;\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 18d55b53cfa..dcf2c811d02 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -155,7 +155,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bool _canSendVTMouseInput(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers);\r\n         bool _shouldSendAlternateScroll(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers, const int32_t delta);\r\n \r\n-        til::point _getTerminalPosition(const til::point pixelPosition);\r\n+        til::point _getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell);\r\n \r\n         bool _sendMouseEventHelper(const til::point terminalPosition,\r\n                                    const unsigned int pointerUpdateKind,\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 67a1523e99b..9e6350df044 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -478,7 +478,7 @@ bool Terminal::ShouldSendAlternateScroll(const unsigned int uiButton,\n // - The position relative to the viewport\r\n std::wstring Terminal::GetHyperlinkAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos));\r\n+    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos, false));\r\n }\r\n \r\n std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\r\n@@ -502,12 +502,8 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n         result = GetHyperlinkIntervalFromViewportPosition(viewportPos);\r\n         if (result.has_value())\r\n         {\r\n-            // GetPlainText and _ConvertToBufferCell work with inclusive coordinates, but interval's\r\n-            // stop point is (horizontally) exclusive, so let's just update it.\r\n-            result->stop.x--;\r\n-\r\n-            result->start = _ConvertToBufferCell(result->start);\r\n-            result->stop = _ConvertToBufferCell(result->stop);\r\n+            result->start = _ConvertToBufferCell(result->start, false);\r\n+            result->stop = _ConvertToBufferCell(result->stop, true);\r\n         }\r\n     }\r\n     else\r\n@@ -544,7 +540,7 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n // - The hyperlink ID\r\n uint16_t Terminal::GetHyperlinkIdAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos))->TextAttr().GetHyperlinkId();\r\n+    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos, false))->TextAttr().GetHyperlinkId();\r\n }\r\n \r\n // Method description:\r\n@@ -1466,7 +1462,6 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n                 // PointTree uses half-open ranges and viewport-relative coordinates.\r\n                 range.start.y -= beg;\r\n                 range.end.y -= beg;\r\n-                range.end.x++;\r\n                 intervals.push_back(PointTree::interval(range.start, range.end, 0));\r\n             } while (uregex_findNext(re.get(), &status));\r\n         }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex 0ff2cb1955e..1459c39fc3c 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -478,7 +478,7 @@ class Microsoft::Terminal::Core::Terminal final :\n     std::vector<til::point_span> _GetSelectionSpans() const noexcept;\r\n     std::pair<til::point, til::point> _PivotSelection(const til::point targetPos, bool& targetStart) const noexcept;\r\n     std::pair<til::point, til::point> _ExpandSelectionAnchors(std::pair<til::point, til::point> anchors) const;\r\n-    til::point _ConvertToBufferCell(const til::point viewportPos) const;\r\n+    til::point _ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const;\r\n     void _ScrollToPoint(const til::point pos);\r\n     void _MoveByChar(SelectionDirection direction, til::point& pos);\r\n     void _MoveByWord(SelectionDirection direction, til::point& pos);\r\ndiff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 6a800f329dd..9501f64a85e 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -93,14 +93,21 @@ const til::point Terminal::GetSelectionEnd() const noexcept\n til::point Terminal::SelectionStartForRendering() const\r\n {\r\n     auto pos{ _selection->start };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n     if (pos.x != bufferSize.Left())\r\n     {\r\n         // In general, we need to draw the marker one before the\r\n         // beginning of the selection.\r\n         // When we're at the left boundary, we want to\r\n         // flip the marker, so we skip this step.\r\n-        bufferSize.DecrementInBounds(pos);\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -112,14 +119,21 @@ til::point Terminal::SelectionStartForRendering() const\n til::point Terminal::SelectionEndForRendering() const\r\n {\r\n     auto pos{ _selection->end };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n-    if (pos.x != bufferSize.RightInclusive())\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        // In general, we need to draw the marker one after the\r\n-        // end of the selection.\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // sln->end is exclusive\r\n+        // In general, we need to draw the marker on the same cell.\r\n         // When we're at the right boundary, we want to\r\n-        // flip the marker, so we skip this step.\r\n-        bufferSize.IncrementInBounds(pos);\r\n+        // flip the marker, so we move one cell to the left.\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -157,7 +171,7 @@ void Terminal::MultiClickSelection(const til::point viewportPos, SelectionExpans\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = expansionMode;\r\n@@ -179,7 +193,7 @@ void Terminal::SetSelectionAnchor(const til::point viewportPos)\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = SelectionExpansion::Char;\r\n@@ -198,7 +212,7 @@ void Terminal::SetSelectionEnd(const til::point viewportPos, std::optional<Selec\n // - based on the selection expansion mode\r\n // Arguments:\r\n // - viewportPos: the (x,y) coordinate on the visible viewport\r\n-// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for ShiftClick\r\n+// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for Shift+Click\r\n void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewportPos, std::optional<SelectionExpansion> newExpansionMode)\r\n {\r\n     wil::hide_name _selection;\r\n@@ -209,7 +223,12 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n         return;\r\n     }\r\n \r\n-    const auto textBufferPos = _ConvertToBufferCell(viewportPos);\r\n+    auto textBufferPos = _ConvertToBufferCell(viewportPos, true);\r\n+    if (newExpansionMode && *newExpansionMode == SelectionExpansion::Char && textBufferPos >= selection->pivot)\r\n+    {\r\n+        // Shift+Click forwards should highlight the clicked space\r\n+        _activeBuffer().GetSize().IncrementInExclusiveBounds(textBufferPos);\r\n+    }\r\n \r\n     // if this is a shiftClick action, we need to overwrite the _multiClickSelectionMode value (even if it's the same)\r\n     // Otherwise, we may accidentally expand during other selection-based actions\r\n@@ -248,7 +267,7 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n // - the new start/end for a selection\r\n std::pair<til::point, til::point> Terminal::_PivotSelection(const til::point targetPos, bool& targetStart) const noexcept\r\n {\r\n-    if (targetStart = _activeBuffer().GetSize().CompareInBounds(targetPos, _selection->pivot) <= 0)\r\n+    if (targetStart = targetPos <= _selection->pivot)\r\n     {\r\n         // target is before pivot\r\n         // treat target as start\r\n@@ -273,17 +292,31 @@ std::pair<til::point, til::point> Terminal::_ExpandSelectionAnchors(std::pair<ti\n     auto start = anchors.first;\r\n     auto end = anchors.second;\r\n \r\n-    const auto bufferSize = _activeBuffer().GetSize();\r\n+    const auto& buffer = _activeBuffer();\r\n+    const auto bufferSize = buffer.GetSize();\r\n     switch (_multiClickSelectionMode)\r\n     {\r\n     case SelectionExpansion::Line:\r\n         start = { bufferSize.Left(), start.y };\r\n-        end = { bufferSize.RightInclusive(), end.y };\r\n+        end = { bufferSize.RightExclusive(), end.y };\r\n         break;\r\n     case SelectionExpansion::Word:\r\n-        start = _activeBuffer().GetWordStart(start, _wordDelimiters);\r\n-        end = _activeBuffer().GetWordEnd(end, _wordDelimiters);\r\n+    {\r\n+        start = buffer.GetWordStart2(start, _wordDelimiters, false);\r\n+\r\n+        // GH#5099: We round to the nearest cell boundary,\r\n+        //   so we would normally prematurely expand to the next word\r\n+        //   as we approach it during a 2x-click+drag.\r\n+        //   To remedy this, decrement the end's position by 1.\r\n+        //   However, only do this when expanding right (it's correct\r\n+        //   as is when expanding left).\r\n+        if (end > _selection->pivot)\r\n+        {\r\n+            bufferSize.DecrementInExclusiveBounds(end);\r\n+        }\r\n+        end = buffer.GetWordEnd2(end, _wordDelimiters, false);\r\n         break;\r\n+    }\r\n     case SelectionExpansion::Char:\r\n     default:\r\n         // no expansion is necessary\r\n@@ -376,9 +409,9 @@ void Terminal::ExpandSelectionToWord()\n         const auto& buffer = _activeBuffer();\r\n         auto selection{ _selection.write() };\r\n         wil::hide_name _selection;\r\n-        selection->start = buffer.GetWordStart(selection->start, _wordDelimiters);\r\n+        selection->start = buffer.GetWordStart2(selection->start, _wordDelimiters, false);\r\n         selection->pivot = selection->start;\r\n-        selection->end = buffer.GetWordEnd(selection->end, _wordDelimiters);\r\n+        selection->end = buffer.GetWordEnd2(selection->end, _wordDelimiters, false);\r\n \r\n         // if we're targeting both endpoints, instead just target \"end\"\r\n         if (WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) && WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::End))\r\n@@ -529,7 +562,6 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n         selection->start = result->first;\r\n         selection->pivot = result->first;\r\n         selection->end = result->second;\r\n-        bufferSize.DecrementInBounds(selection->end);\r\n         _selectionIsTargetingUrl = true;\r\n         _selectionEndpoint = SelectionEndpoint::End;\r\n     }\r\n@@ -625,7 +657,7 @@ void Terminal::UpdateSelection(SelectionDirection direction, SelectionExpansion\n     }\r\n     auto targetPos{ WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) ? _selection->start : _selection->end };\r\n \r\n-    // 2 Perform the movement\r\n+    // 2. Perform the movement\r\n     switch (mode)\r\n     {\r\n     case SelectionExpansion::Char:\r\n@@ -695,12 +727,12 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n-        _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphStart(pos);\r\n+        _activeBuffer().MoveToPreviousGlyph2(pos);\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphEnd(pos);\r\n+        // We need the limit to be the mutable viewport here,\r\n+        // otherwise we're allowed to navigate by character past the mutable bottom\r\n+        _activeBuffer().MoveToNextGlyph2(pos, _GetMutableViewport().BottomInclusiveRightExclusive());\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -714,7 +746,7 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n         const auto bufferSize{ _activeBuffer().GetSize() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + 1 };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -722,61 +754,45 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n \r\n void Terminal::_MoveByWord(SelectionDirection direction, til::point& pos)\r\n {\r\n+    const auto& buffer = _activeBuffer();\r\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n     {\r\n-        const auto wordStartPos{ _activeBuffer().GetWordStart(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(_selection->pivot, pos) < 0)\r\n-        {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = wordStartPos;\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        }\r\n-        else if (wordStartPos == pos)\r\n-        {\r\n-            // already at the beginning of the current word,\r\n-            // move to the beginning of the previous word\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // move to the beginning of the current word\r\n-            pos = wordStartPos;\r\n+            // didn't move because we're already at the beginning of a word,\r\n+            // so move to the beginning of the previous word\r\n+            buffer.GetSize().DecrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Right:\r\n     {\r\n-        const auto wordEndPos{ _activeBuffer().GetWordEnd(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(pos, _selection->pivot) < 0)\r\n+        const auto mutableViewportEndExclusive = _GetMutableViewport().BottomInclusiveRightExclusive();\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        }\r\n-        else if (wordEndPos == pos)\r\n-        {\r\n-            // already at the end of the current word,\r\n-            // move to the end of the next word\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n-        {\r\n-            // move to the end of the current word\r\n-            pos = wordEndPos;\r\n+            // didn't move because we're already at the end of a word,\r\n+            // so move to the end of the next word\r\n+            buffer.GetSize().IncrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Up:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordStart2(pos, _wordDelimiters, true);\r\n         break;\r\n     case SelectionDirection::Down:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordEnd2(pos, _wordDelimiters, true);\r\n         break;\r\n     }\r\n }\r\n@@ -790,7 +806,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         pos = { bufferSize.Left(), pos.y };\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        pos = { bufferSize.RightInclusive(), pos.y };\r\n+        pos = { bufferSize.RightExclusive(), pos.y };\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -804,7 +820,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         const auto viewportHeight{ _GetMutableViewport().Height() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + viewportHeight };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -821,7 +837,7 @@ void Terminal::_MoveByBuffer(SelectionDirection direction, til::point& pos) noex\n         break;\r\n     case SelectionDirection::Right:\r\n     case SelectionDirection::Down:\r\n-        pos = { bufferSize.RightInclusive(), _GetMutableViewport().BottomInclusive() };\r\n+        pos = { bufferSize.RightExclusive(), _GetMutableViewport().BottomInclusive() };\r\n         break;\r\n     }\r\n }\r\n@@ -901,13 +917,17 @@ Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singl\n // - convert viewport position to the corresponding location on the buffer\r\n // Arguments:\r\n // - viewportPos: a coordinate on the viewport\r\n+// - allowRightExclusive: if true, clamp to the right exclusive boundary of the buffer.\r\n+//     Careful! This position doesn't point to any data in the buffer!\r\n // Return Value:\r\n // - the corresponding location on the buffer\r\n-til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\r\n+til::point Terminal::_ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const\r\n {\r\n     const auto yPos = _VisibleStartIndex() + viewportPos.y;\r\n     til::point bufferPos = { viewportPos.x, yPos };\r\n-    _activeBuffer().GetSize().Clamp(bufferPos);\r\n+    const auto bufferSize = _activeBuffer().GetSize();\r\n+    bufferPos.x = std::clamp(bufferPos.x, bufferSize.Left(), allowRightExclusive ? bufferSize.RightExclusive() : bufferSize.RightInclusive());\r\n+    bufferPos.y = std::clamp(bufferPos.y, bufferSize.Top(), bufferSize.BottomInclusive());\r\n     return bufferPos;\r\n }\r\n \r\n@@ -917,7 +937,7 @@ til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\n // - pos: a coordinate relative to the buffer (not viewport)\r\n void Terminal::_ScrollToPoint(const til::point pos)\r\n {\r\n-    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInBounds(pos))\r\n+    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInExclusiveBounds(pos))\r\n     {\r\n         if (const auto amtAboveView = visibleViewport.Top() - pos.y; amtAboveView > 0)\r\n         {\r\ndiff --git a/src/cascadia/TerminalCore/terminalrenderdata.cpp b/src/cascadia/TerminalCore/terminalrenderdata.cpp\nindex 006d87aabe5..d7bca1077cc 100644\n--- a/src/cascadia/TerminalCore/terminalrenderdata.cpp\n+++ b/src/cascadia/TerminalCore/terminalrenderdata.cpp\n@@ -201,6 +201,11 @@ til::CoordType Terminal::_ScrollToPoints(const til::point coordStart, const til:\n     return _VisibleStartIndex();\r\n }\r\n \r\n+// Method Description:\r\n+// - selects the region from coordStart to coordEnd\r\n+// Arguments:\r\n+// - coordStart - The start point (inclusive)\r\n+// - coordEnd - The end point (inclusive)\r\n void Terminal::SelectNewRegion(const til::point coordStart, const til::point coordEnd)\r\n {\r\n     const auto newScrollOffset = _ScrollToPoints(coordStart, coordEnd);\r\n@@ -210,6 +215,7 @@ void Terminal::SelectNewRegion(const til::point coordStart, const til::point coo\n     const auto newCoordEnd = til::point{ coordEnd.x, coordEnd.y - newScrollOffset };\r\n     SetSelectionAnchor(newCoordStart);\r\n     SetSelectionEnd(newCoordEnd, SelectionExpansion::Char);\r\n+    _activeBuffer().TriggerSelection();\r\n }\r\n \r\n const std::wstring_view Terminal::GetConsoleTitle() const noexcept\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\nindex e018e1fd2ad..999809cb397 100644\n--- a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n@@ -419,7 +419,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -440,7 +440,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -450,7 +450,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -460,7 +460,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -502,7 +502,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -663,7 +663,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 26, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 27, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -673,7 +673,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -731,7 +731,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 29, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 30, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -741,7 +741,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -804,7 +804,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 1, 1 };\r\n-            const til::point expectedEnd{ 1, 2 };\r\n+            const til::point expectedEnd{ 2, 2 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\nindex 49fcd6d21eb..282b1995da7 100644\n--- a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n@@ -438,8 +438,9 @@ namespace ControlUnitTests\n         // The viewport is on row 21, so the selection will be on:\r\n         // {(5, 5)+(0, 21)} to {(5, 5)+(0, 21)}\r\n         til::point expectedAnchor{ 5, 26 };\r\n+        til::point expectedEnd{ 6, 26 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Scroll up a line, with the left mouse button selected\");\r\n         interactivity->MouseWheel(modifiers,\r\n@@ -449,10 +450,11 @@ namespace ControlUnitTests\n \r\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The viewport is now on row 20, so the selection will be on:\r\n-        // {(5, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n-        til::point newExpectedAnchor{ 5, 25 };\r\n+        // {(5 + 1, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n+        // NOTE: newExpectedAnchor should be expectedEnd moved up one row\r\n+        til::point newExpectedAnchor{ 6, 25 };\r\n         // Remember, the anchor is always before the end in the buffer. So yes,\r\n-        // se started the selection on 5,26, but now that's the end.\r\n+        // we started the selection on 5,26, but now that's the end.\r\n         VERIFY_ARE_EQUAL(newExpectedAnchor, core->_terminal->GetSelectionAnchor());\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n     }\r\n@@ -628,7 +630,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify that it started on the first cell we clicked on, not the one we dragged to\");\r\n         til::point expectedAnchor{ 0, 0 };\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        til::point expectedEnd{ 2, 0 };\r\n+        til::point expectedEnd{ 3, 0 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         interactivity->PointerReleased(noMouseDown,\r\n@@ -798,8 +800,9 @@ namespace ControlUnitTests\n         // The viewport is on row (historySize + 5), so the selection will be on:\r\n         // {(5, (historySize+5))+(0, 21)} to {(5, (historySize+5))+(0, 21)}\r\n         til::point expectedAnchor{ 5, settings->HistorySize() + 5 };\r\n+        til::point expectedEnd{ 6, expectedAnchor.y }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Output a line of text\");\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n@@ -807,6 +810,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -815,7 +819,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 1, core->_terminal->GetScrollOffset());\r\n \r\n@@ -825,6 +829,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -833,7 +838,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 2, core->_terminal->GetScrollOffset());\r\n \r\n@@ -858,15 +863,17 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"anchor:({},{})\", anchor.x, anchor.y).c_str());\r\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n+            // Selection was updated, but we didn't highlight a full cell\r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n             VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n         }\r\n \r\n-        Log::Comment(L\"Output a line ant move the mouse a little to update the selection, all at once\");\r\n+        Log::Comment(L\"Output a line and move the mouse a little to update the selection, all at once\");\r\n         // Same as above. The viewport has moved, so the mouse is still over the\r\n         // same character, even though it's at a new offset.\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 3, core->_terminal->GetScrollOffset());\r\n         interactivity->PointerMoved(leftMouseDown,\r\n                                     WM_LBUTTONDOWN, //pointerUpdateKind\r\n@@ -883,7 +890,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n \r\n         // Output enough text for the selection to get pushed off the buffer\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\nindex 11f01c75297..1585fef905f 100644\n--- a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n@@ -126,20 +126,20 @@ namespace TerminalCoreUnitTests\n \r\n             // Test with no scrollback\r\n             Log::Comment(L\"Single click selection with NO scrollback value\");\r\n-            ValidateSingleClickSelection(0, { 9, 9 }, { 9, 9 });\r\n+            ValidateSingleClickSelection(0, { 10, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Double click selection with NO scrollback value\");\r\n-            ValidateDoubleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateDoubleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Triple click selection with NO scrollback value\");\r\n-            ValidateTripleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateTripleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n \r\n             // Test with max scrollback\r\n             const til::CoordType expected_row = SHRT_MAX - 1;\r\n             Log::Comment(L\"Single click selection with MAXIMUM scrollback value\");\r\n-            ValidateSingleClickSelection(SHRT_MAX, { 9, expected_row }, { 9, expected_row });\r\n+            ValidateSingleClickSelection(SHRT_MAX, { 10, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Double click selection with MAXIMUM scrollback value\");\r\n-            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Triple click selection with MAXIMUM scrollback value\");\r\n-            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n         }\r\n \r\n         TEST_METHOD(SelectFromOutofBounds)\r\n@@ -155,7 +155,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const auto leftBoundary = viewport.Left();\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n             const auto topBoundary = viewport.Top();\r\n             const auto bottomBoundary = viewport.BottomInclusive();\r\n \r\n@@ -163,7 +163,7 @@ namespace TerminalCoreUnitTests\n             // should clamp to right boundary\r\n             term.SetSelectionAnchor({ 20, 5 });\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n-            ValidateLinearSelection(term, { rightBoundary, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { rightExclusiveBoundary, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Simulate click past left (x,y) = (-20,5)\r\n             // should clamp to left boundary\r\n@@ -197,7 +197,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const til::CoordType leftBoundary = 0;\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n \r\n             // Simulate click at (x,y) = (5,5)\r\n             term.SetSelectionAnchor({ 5, 5 });\r\n@@ -205,7 +205,7 @@ namespace TerminalCoreUnitTests\n             // Case 1: Move out of right boundary\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n             term.SetSelectionEnd({ 20, 5 });\r\n-            ValidateLinearSelection(term, { 5, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { 5, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Move out of left boundary\r\n             Log::Comment(L\"Out of bounds: X-value negative\");\r\n@@ -312,7 +312,7 @@ namespace TerminalCoreUnitTests\n \r\n             // Validate selection area\r\n             // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 6, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyph_Leading)\r\n@@ -334,8 +334,8 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionAnchor(clickPos);\r\n \r\n             // Validate selection area\r\n-            // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            // Selection should clamp to the left side of the glyph and stay degenerate\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 4, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyphsInBoxSelection)\r\n@@ -356,12 +356,26 @@ namespace TerminalCoreUnitTests\n             GetTextBuffer(term).GetCursor().SetPosition({ 7, 11 });\r\n             term.Write(burrito);\r\n \r\n+            // Text buffer should look like this:\r\n+            // -------------\r\n+            // |     A      |\r\n+            // |            |\r\n+            // |    \ud83c\udf2f      |\r\n+            // |       \ud83c\udf2f   |\r\n+            // |        B   |\r\n+            // -------------\r\n+            // A: selection anchor\r\n+            // B: selection end\r\n+            // The boundaries of the selection should cut through\r\n+            //  the middle of the burritos, but the selection\r\n+            //  should expand to encompass each burrito entirely.\r\n+\r\n             // Simulate ALT + click at (x,y) = (5,8)\r\n             term.SetSelectionAnchor({ 5, 8 });\r\n             term.SetBlockSelection(true);\r\n \r\n-            // Simulate move to (x,y) = (7,12)\r\n-            term.SetSelectionEnd({ 7, 12 });\r\n+            // Simulate move to (x,y) = (8,12)\r\n+            term.SetSelectionEnd({ 8, 12 });\r\n \r\n             // Simulate renderer calling TriggerSelection and acquiring selection area\r\n             auto selectionSpans = term.GetSelectionSpans();\r\n@@ -376,18 +390,18 @@ namespace TerminalCoreUnitTests\n                 if (rowValue == 10)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 4, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n                 else if (rowValue == 11)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 9, rowValue }), sp.end);\r\n                 }\r\n                 else\r\n                 {\r\n                     // Verify all lines\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n \r\n                 rowValue++;\r\n@@ -414,7 +428,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size() - 1), 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size()), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_Delimiter)\r\n@@ -432,7 +446,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_DelimiterClass)\r\n@@ -457,10 +471,10 @@ namespace TerminalCoreUnitTests\n \r\n             // ---Validate selection area---\r\n             // \"Terminal\" is in class 2\r\n-            // \">\" is in class 1\r\n+            // \":\" and \">\" are in class 1\r\n             // the white space to the right of the \">\" is in class 0\r\n             // Double-clicking the \">\" should only highlight that cell\r\n-            ValidateLinearSelection(term, { 15, 10 }, { 15, 10 });\r\n+            ValidateLinearSelection(term, { 15, 10 }, { 16, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Right)\r\n@@ -489,7 +503,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 21, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Left)\r\n@@ -502,7 +516,7 @@ namespace TerminalCoreUnitTests\n             auto settings = winrt::make<MockTermSettings>(0, 100, 100);\r\n             term.UpdateSettings(settings);\r\n \r\n-            // Insert text at position (21,10)\r\n+            // Insert text at position (4,10)\r\n             const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n@@ -513,12 +527,12 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,10)\r\n             //\r\n             // buffer: doubleClickMe dragThroughHere\r\n-            //         ^                ^\r\n-            //       finish            start\r\n+            //          ^               ^\r\n+            //        finish           start\r\n             term.SetSelectionEnd({ 5, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClick_GeneralCase)\r\n@@ -532,7 +546,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Line);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Horizontal)\r\n@@ -549,7 +563,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 7, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Vertical)\r\n@@ -565,7 +579,7 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,11)\r\n             term.SetSelectionEnd({ 5, 11 });\r\n \r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 11 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 11 });\r\n         }\r\n \r\n         TEST_METHOD(ShiftClick)\r\n@@ -579,20 +593,20 @@ namespace TerminalCoreUnitTests\n             term.UpdateSettings(settings);\r\n \r\n             // Insert text at position (4,10)\r\n-            const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n+            const std::wstring_view text = L\"doubleClickMe dragThroughHere anotherWord\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n \r\n-            // Step 1: Create a selection on \"doubleClickMe\"\r\n+            Log::Comment(L\"Step 1 : Create a selection on \\\"doubleClickMe\\\"\");\r\n             {\r\n                 // Simulate double click at (x,y) = (5,10)\r\n                 term.MultiClickSelection({ 5, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 16, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 17, 10 });\r\n             }\r\n \r\n-            // Step 2: Shift+Click to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 2: Shift+Click to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+Click at (x,y) = (21,10)\r\n                 //\r\n@@ -602,10 +616,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area: \"doubleClickMe drag\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 21, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 22, 10 });\r\n             }\r\n \r\n-            // Step 3: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 3: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -615,10 +629,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Triple-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 4: Shift+Triple-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+TripleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -628,60 +642,62 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Line);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 100, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 5: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start            click      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^           ^\r\n+                //       start            click       finish\r\n+                // NOTE: end is exclusive, so finish should point to the spot AFTER \"dragThroughHere\"\r\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag past \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 6: Drag past \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (35,10)\r\n                 // Since we were preceded by a double-click, we're in \"word\" expansion mode\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere     |\r\n-                //         ^                                 ^\r\n-                //       start                             finish (boundary)\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                              ^\r\n+                //       start                          finish\r\n                 term.SetSelectionEnd({ 35, 10 });\r\n \r\n-                // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                // Validate selection area: \"doubleClickMe dragThroughHere anotherWord\" selected\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 45, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag back to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 7: Drag back to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (21,10)\r\n+                // Should still be in \"word\" expansion mode!\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start             drag      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^\r\n+                //       start            finish\r\n                 term.SetSelectionEnd({ 21, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 7: Drag within \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 8: Drag within \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (25,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                    ^      ^\r\n-                //       start                 drag  finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                    ^\r\n+                //       start                finish\r\n                 term.SetSelectionEnd({ 25, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" still selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n         }\r\n \r\n@@ -691,25 +707,27 @@ namespace TerminalCoreUnitTests\n             DummyRenderer renderer{ &term };\r\n             term.Create({ 100, 100 }, 0, renderer);\r\n \r\n-            // Step 1: Create a selection\r\n+            Log::Comment(L\"Step 1: Create a selection\");\r\n             {\r\n-                // (10,10) to (20, 10)\r\n+                // (10,10) to (20, 10) (inclusive)\r\n                 term.SelectNewRegion({ 10, 10 }, { 20, 10 });\r\n \r\n                 // Validate selection area\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n \r\n-            // Step 2: Drag to (5,10)\r\n+            Log::Comment(L\"Step 2: Drag to (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 });\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should be (10, 10)\r\n+                // NOTES:\r\n+                // - Pivot should be (10, 10)\r\n+                // - though end is generally exclusive, since we moved behind the pivot, end is actually inclusive\r\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 3: Drag back to (20,10)\r\n+            Log::Comment(L\"Step 3: Drag back to (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 });\r\n \r\n@@ -718,7 +736,7 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Click at (5,10)\r\n+            Log::Comment(L\"Step 4: Shift+Click at (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n@@ -727,13 +745,14 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Click back at (20,10)\r\n+            Log::Comment(L\"Step 5: Shift+Click back at (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should still be (10, 10)\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                //   Pivot should still be (10, 10)\r\n+                //   Shift+Click makes end inclusive (so add 1)\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n         }\r\n     };\r\ndiff --git a/src/host/selection.cpp b/src/host/selection.cpp\nindex 300068d9671..d7dcf21ebe2 100644\n--- a/src/host/selection.cpp\n+++ b/src/host/selection.cpp\n@@ -43,11 +43,32 @@ void Selection::_RegenerateSelectionSpans() const\n     endSelectionAnchor.x = (_d->coordSelectionAnchor.x == _d->srSelectionRect.left) ? _d->srSelectionRect.right : _d->srSelectionRect.left;\r\n     endSelectionAnchor.y = (_d->coordSelectionAnchor.y == _d->srSelectionRect.top) ? _d->srSelectionRect.bottom : _d->srSelectionRect.top;\r\n \r\n+    // GH #18106: Conhost and Terminal share most of the selection code.\r\n+    //    Both now store the selection data as a half-open range [start, end),\r\n+    //     where \"end\" is the bottom-right-most point.\r\n+    //    Note that Conhost defines start/end as \"start was set in time before end\",\r\n+    //     whereas above (and in Terminal) we're treating start/end as \"start is physically before end\".\r\n+    //    We want Conhost to still operate as an inclusive range.\r\n+    //    To make it \"feel\" inclusive, we need to adjust the \"end\" endpoint\r\n+    //     by incrementing it by one, so that the \"end\" endpoint is rendered\r\n+    //     and handled as selected.\r\n     const auto blockSelection = !IsLineSelection();\r\n-    _lastSelectionSpans = screenInfo.GetTextBuffer().GetTextSpans(_d->coordSelectionAnchor,\r\n-                                                                  endSelectionAnchor,\r\n-                                                                  blockSelection,\r\n-                                                                  false);\r\n+    const auto& buffer = screenInfo.GetTextBuffer();\r\n+    auto startSelectionAnchor = _d->coordSelectionAnchor;\r\n+    if (blockSelection)\r\n+    {\r\n+        // Compare x-values when we're in block selection!\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor.x <= endSelectionAnchor.x ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    else\r\n+    {\r\n+        // General comparison for line selection.\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor <= endSelectionAnchor ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    _lastSelectionSpans = buffer.GetTextSpans(startSelectionAnchor,\r\n+                                              endSelectionAnchor,\r\n+                                              blockSelection,\r\n+                                              false);\r\n     _lastSelectionGeneration = _d.generation();\r\n }\r\n \r\ndiff --git a/src/host/ut_host/ClipboardTests.cpp b/src/host/ut_host/ClipboardTests.cpp\nindex 21d4c7b13b8..24f2693c643 100644\n--- a/src/host/ut_host/ClipboardTests.cpp\n+++ b/src/host/ut_host/ClipboardTests.cpp\n@@ -84,7 +84,7 @@ class ClipboardTests\n         const auto& screenInfo = gci.GetActiveOutputBuffer();\r\n         const auto& buffer = screenInfo.GetTextBuffer();\r\n \r\n-        constexpr til::point_span selection = { { 0, 0 }, { 14, 3 } };\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 15, 3 } };\r\n         const auto req = TextBuffer::CopyRequest::FromConfig(buffer, selection.start, selection.end, false, !fLineSelection, false);\r\n         return buffer.GetPlainText(req);\r\n     }\r\ndiff --git a/src/host/ut_host/SearchTests.cpp b/src/host/ut_host/SearchTests.cpp\nindex 423273b3c38..d37c3556d40 100644\n--- a/src/host/ut_host/SearchTests.cpp\n+++ b/src/host/ut_host/SearchTests.cpp\n@@ -60,7 +60,7 @@ class SearchTests\n         const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n \r\n         auto coordEndExpected = coordStartExpected;\r\n-        coordEndExpected.x += 1;\r\n+        coordEndExpected.x += 2;\r\n \r\n         VERIFY_IS_TRUE(s.SelectCurrent());\r\n         VERIFY_ARE_EQUAL(coordStartExpected, gci.renderData.GetSelectionAnchor());\r\ndiff --git a/src/host/ut_host/SelectionTests.cpp b/src/host/ut_host/SelectionTests.cpp\nindex 62eac812053..f314e8dcc9e 100644\n--- a/src/host/ut_host/SelectionTests.cpp\n+++ b/src/host/ut_host/SelectionTests.cpp\n@@ -74,7 +74,7 @@ class SelectionTests\n                 VERIFY_ARE_EQUAL(span.end.y, sRectangleLineNumber);\r\n \r\n                 VERIFY_ARE_EQUAL(span.start.x, m_pSelection->_d->srSelectionRect.left);\r\n-                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right);\r\n+                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right + 1);\r\n             }\r\n         }\r\n     }\r\n@@ -141,15 +141,17 @@ class SelectionTests\n         }\r\n     }\r\n \r\n-    void VerifyGetSelectionSpans_LineMode(const til::point start, const til::point end)\r\n+    void VerifyGetSelectionSpans_LineMode(const til::point inclusiveStart, const til::point inclusiveEnd)\r\n     {\r\n         const auto selectionSpans = m_pSelection->GetSelectionSpans();\r\n \r\n         if (VERIFY_ARE_EQUAL(1u, selectionSpans.size()))\r\n         {\r\n             auto& span{ selectionSpans[0] };\r\n-            VERIFY_ARE_EQUAL(start, span.start, L\"start\");\r\n-            VERIFY_ARE_EQUAL(end, span.end, L\"end\");\r\n+            VERIFY_ARE_EQUAL(inclusiveStart, span.start, L\"start\");\r\n+\r\n+            const til::point exclusiveEnd{ inclusiveEnd.x + 1, inclusiveEnd.y };\r\n+            VERIFY_ARE_EQUAL(exclusiveEnd, span.end, L\"end\");\r\n         }\r\n     }\r\n \r\ndiff --git a/src/host/ut_host/TextBufferTests.cpp b/src/host/ut_host/TextBufferTests.cpp\nindex 2d6c1d1628e..4252609e30f 100644\n--- a/src/host/ut_host/TextBufferTests.cpp\n+++ b/src/host/ut_host/TextBufferTests.cpp\n@@ -2432,11 +2432,11 @@ void TextBufferTests::GetTextRects()\n     std::vector<til::inclusive_rect> expected{};\r\n     if (blockSelection)\r\n     {\r\n-        expected.push_back({ 1, 0, 7, 0 });\r\n-        expected.push_back({ 1, 1, 8, 1 }); // expand right\r\n-        expected.push_back({ 1, 2, 7, 2 });\r\n-        expected.push_back({ 0, 3, 7, 3 }); // expand left\r\n-        expected.push_back({ 1, 4, 7, 4 });\r\n+        expected.push_back({ 1, 0, 8, 0 });\r\n+        expected.push_back({ 1, 1, 9, 1 }); // expand right\r\n+        expected.push_back({ 1, 2, 8, 2 });\r\n+        expected.push_back({ 0, 3, 8, 3 }); // do not expand\r\n+        expected.push_back({ 1, 4, 8, 4 });\r\n     }\r\n     else\r\n     {\r\n@@ -2444,11 +2444,11 @@ void TextBufferTests::GetTextRects()\n         expected.push_back({ 0, 1, 19, 1 });\r\n         expected.push_back({ 0, 2, 19, 2 });\r\n         expected.push_back({ 0, 3, 19, 3 });\r\n-        expected.push_back({ 0, 4, 7, 4 });\r\n+        expected.push_back({ 0, 4, 8, 4 });\r\n     }\r\n \r\n     til::point start{ 1, 0 };\r\n-    til::point end{ 7, 4 };\r\n+    til::point end{ 8, 4 };\r\n     const auto result = _buffer->GetTextRects(start, end, blockSelection, false);\r\n     VERIFY_ARE_EQUAL(expected.size(), result.size());\r\n     for (size_t i = 0; i < expected.size(); ++i)\r\n@@ -2494,8 +2494,9 @@ void TextBufferTests::GetPlainText()\n                                                        L\"  3  \" };\r\n         WriteLinesToBuffer(bufferText, *_buffer);\r\n \r\n-        // simulate a selection from origin to {4,4}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 4 } };\r\n+        // simulate a selection from origin to {5,4}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 4 } };\r\n \r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, false };\r\n         const auto result = _buffer->GetPlainText(req);\r\n@@ -2589,8 +2590,9 @@ void TextBufferTests::GetPlainText()\n         // |     |\r\n         // |_____|\r\n \r\n-        // simulate a selection from origin to {4,5}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 5 } };\r\n+        // simulate a selection from origin to {5,5}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 5 } };\r\n \r\n         const auto formatWrappedRows = blockSelection;\r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, formatWrappedRows };\r\ndiff --git a/src/inc/til/point.h b/src/inc/til/point.h\nindex 17bc9d1c861..95eed691671 100644\n--- a/src/inc/til/point.h\n+++ b/src/inc/til/point.h\n@@ -322,6 +322,42 @@ namespace til // Terminal Implementation Library. Also: \"Today I Learned\"\n                 func(y, x1, x2);\r\n             }\r\n         }\r\n+\r\n+        // Similar to iterate_rows above, but the \"end\" point is exclusive\r\n+        // and RightExclusive (aka \"width\") is an allowable coordinate\r\n+        constexpr void iterate_rows_exclusive(til::CoordType width, auto&& func) const\r\n+        {\r\n+            // Copy the members so that the compiler knows it doesn't\r\n+            // need to re-read them on every loop iteration.\r\n+            const auto w = width;\r\n+            auto ax = std::clamp(start.x, 0, w);\r\n+            auto ay = start.y;\r\n+            auto bx = std::clamp(end.x, 0, w);\r\n+            auto by = end.y;\r\n+\r\n+            // if start is at RightExclusive,\r\n+            // treat it as (0, y+1) (left-most point on next line)\r\n+            if (ax == w)\r\n+            {\r\n+                ay++;\r\n+                ax = 0;\r\n+            }\r\n+\r\n+            // if end is on left boundary,\r\n+            // treat it as (w, y-1) (RightExclusive on previous line)\r\n+            if (bx == 0)\r\n+            {\r\n+                by--;\r\n+                bx = w;\r\n+            }\r\n+\r\n+            for (auto y = ay; y <= by; ++y)\r\n+            {\r\n+                const auto x1 = y != ay ? 0 : ax;\r\n+                const auto x2 = y != by ? w : bx;\r\n+                func(y, x1, x2);\r\n+            }\r\n+        }\r\n     };\r\n }\r\n \r\ndiff --git a/src/renderer/atlas/AtlasEngine.api.cpp b/src/renderer/atlas/AtlasEngine.api.cpp\nindex a80ae930ba9..10cf2e3a405 100644\n--- a/src/renderer/atlas/AtlasEngine.api.cpp\n+++ b/src/renderer/atlas/AtlasEngine.api.cpp\n@@ -89,11 +89,11 @@ void AtlasEngine::_invalidateSpans(std::span<const til::point_span> spans, const\n     const auto viewport = til::rect{ 0, 0, _api.s->viewportCellCount.x, _api.s->viewportCellCount.y };\r\n     for (auto&& sp : spans)\r\n     {\r\n-        sp.iterate_rows(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n+        sp.iterate_rows_exclusive(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n             const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n             beg <<= shift;\r\n             end <<= shift;\r\n-            til::rect rect{ beg, row, end + 1, row + 1 };\r\n+            til::rect rect{ beg, row, end, row + 1 };\r\n             rect = rect.to_origin(viewportOrigin);\r\n             rect &= viewport;\r\n             _api.invalidatedRows.start = gsl::narrow_cast<u16>(std::min<int>(_api.invalidatedRows.start, std::max<int>(0, rect.top)));\r\ndiff --git a/src/renderer/atlas/AtlasEngine.cpp b/src/renderer/atlas/AtlasEngine.cpp\nindex 0de92b62373..90b9083b5d3 100644\n--- a/src/renderer/atlas/AtlasEngine.cpp\n+++ b/src/renderer/atlas/AtlasEngine.cpp\n@@ -427,13 +427,13 @@ try\n     if (y > hiStart.y)\r\n     {\r\n         const auto isFinalRow = y == hiEnd.y;\r\n-        const auto end = isFinalRow ? std::min(hiEnd.x + 1, x2) : x2;\r\n+        const auto end = isFinalRow ? std::min(hiEnd.x, x2) : x2;\r\n         _fillColorBitmap(row, x1, end, fgColor, bgColor);\r\n \r\n         // Return early if we couldn't paint the whole region (either this was not the last row, or\r\n         // it was the last row but the highlight ends outside of our x range.)\r\n         // We will resume from here in the next call.\r\n-        if (!isFinalRow || hiEnd.x /*inclusive*/ >= x2 /*exclusive*/)\r\n+        if (!isFinalRow || hiEnd.x > x2)\r\n         {\r\n             return S_OK;\r\n         }\r\n@@ -448,10 +448,10 @@ try\n         hiEnd = it->end - offset;\r\n \r\n         const auto isStartInside = y == hiStart.y && hiStart.x < x2;\r\n-        const auto isEndInside = y == hiEnd.y && hiEnd.x < x2;\r\n+        const auto isEndInside = y == hiEnd.y && hiEnd.x <= x2;\r\n         if (isStartInside && isEndInside)\r\n         {\r\n-            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x) + 1, fgColor, bgColor);\r\n+            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x), fgColor, bgColor);\r\n             ++it;\r\n         }\r\n         else\r\ndiff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex c44216ac470..31ab5a410e3 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -342,9 +342,8 @@ try\n             const til::rect vp{ _viewport.ToExclusive() };\r\n             for (auto&& sp : spans)\r\n             {\r\n-                sp.iterate_rows(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n+                sp.iterate_rows_exclusive(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n                     const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n-                    max += 1; // Selection spans are inclusive (still)\r\n                     min <<= shift;\r\n                     max <<= shift;\r\n                     til::rect r{ min, row, max, row + 1 };\r\ndiff --git a/src/types/TermControlUiaProvider.cpp b/src/types/TermControlUiaProvider.cpp\nindex 34bd94f9404..3e4091bd963 100644\n--- a/src/types/TermControlUiaProvider.cpp\n+++ b/src/types/TermControlUiaProvider.cpp\n@@ -157,14 +157,8 @@ HRESULT TermControlUiaProvider::GetSelectionRange(_In_ IRawElementProviderSimple\n     RETURN_HR_IF_NULL(E_INVALIDARG, ppUtr);\r\n     *ppUtr = nullptr;\r\n \r\n-    const auto start = _pData->GetSelectionAnchor();\r\n-\r\n-    // we need to make end exclusive\r\n-    auto end = _pData->GetSelectionEnd();\r\n-    _pData->GetTextBuffer().GetSize().IncrementInBounds(end, true);\r\n-\r\n     TermControlUiaTextRange* result = nullptr;\r\n-    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, start, end, _pData->IsBlockSelection(), wordDelimiters));\r\n+    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, _pData->GetSelectionAnchor(), _pData->GetSelectionEnd(), _pData->IsBlockSelection(), wordDelimiters));\r\n     *ppUtr = result;\r\n     return S_OK;\r\n }\r\ndiff --git a/src/types/UiaTextRangeBase.cpp b/src/types/UiaTextRangeBase.cpp\nindex 0ce958e6985..9b3d7040a5e 100644\n--- a/src/types/UiaTextRangeBase.cpp\n+++ b/src/types/UiaTextRangeBase.cpp\n@@ -972,7 +972,7 @@ CATCH_RETURN();\n // Return Value:\r\n // - the text that the UiaTextRange encompasses\r\n #pragma warning(push)\r\n-#pragma warning(disable : 26447) // compiler isn't filtering throws inside the try/catch\r\n+#pragma warning(disable : 26440) // The function ... can be declared as noexcept.\r\n std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\r\n {\r\n     std::wstring textData{};\r\n@@ -987,13 +987,12 @@ std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\n \r\n         // TODO GH#5406: create a different UIA parent object for each TextBuffer\r\n         // nvaccess/nvda#11428: Ensure our endpoints are in bounds\r\n-        THROW_HR_IF(E_FAIL, !bufferSize.IsInBounds(_start, true) || !bufferSize.IsInBounds(_end, true));\r\n+        auto isValid = [&](const til::point& point) {\r\n+            return bufferSize.IsInExclusiveBounds(point) || point == bufferSize.EndExclusive();\r\n+        };\r\n+        THROW_HR_IF(E_FAIL, !isValid(_start) || !isValid(_end));\r\n \r\n-        // convert _end to be inclusive\r\n-        auto inclusiveEnd = _end;\r\n-        bufferSize.DecrementInBounds(inclusiveEnd, true);\r\n-\r\n-        const auto req = TextBuffer::CopyRequest{ buffer, _start, inclusiveEnd, _blockRange, true, false, false, true };\r\n+        const auto req = TextBuffer::CopyRequest{ buffer, _start, _end, _blockRange, true, false, false, true };\r\n         auto plainText = buffer.GetPlainText(req);\r\n \r\n         if (plainText.size() > maxLengthAsSize)\r\ndiff --git a/src/types/inc/viewport.hpp b/src/types/inc/viewport.hpp\nindex fd0d5b302f8..0f1ea0bdeb8 100644\n--- a/src/types/inc/viewport.hpp\n+++ b/src/types/inc/viewport.hpp\n@@ -41,20 +41,26 @@ namespace Microsoft::Console::Types\n         til::point Origin() const noexcept;\r\n         til::point BottomRightInclusive() const noexcept;\r\n         til::point BottomRightExclusive() const noexcept;\r\n+        til::point BottomInclusiveRightExclusive() const noexcept;\r\n         til::point EndExclusive() const noexcept;\r\n         til::size Dimensions() const noexcept;\r\n \r\n         bool IsInBounds(const Viewport& other) const noexcept;\r\n         bool IsInBounds(const til::point pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IsInExclusiveBounds(const til::point pos) const noexcept;\r\n \r\n         void Clamp(til::point& pos) const;\r\n         Viewport Clamp(const Viewport& other) const noexcept;\r\n \r\n         bool IncrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n         bool DecrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IncrementInExclusiveBounds(til::point& pos) const noexcept;\r\n+        bool DecrementInExclusiveBounds(til::point& pos) const noexcept;\r\n         int CompareInBounds(const til::point first, const til::point second, bool allowEndExclusive = false) const noexcept;\r\n+        int CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept;\r\n \r\n         bool WalkInBounds(til::point& pos, const til::CoordType delta, bool allowEndExclusive = false) const noexcept;\r\n+        bool WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept;\r\n         til::point GetWalkOrigin(const til::CoordType delta) const noexcept;\r\n         static til::CoordType DetermineWalkDirection(const Viewport& source, const Viewport& target) noexcept;\r\n \r\ndiff --git a/src/types/viewport.cpp b/src/types/viewport.cpp\nindex 30c5307dd14..ce4b38565eb 100644\n--- a/src/types/viewport.cpp\n+++ b/src/types/viewport.cpp\n@@ -118,6 +118,11 @@ til::point Viewport::BottomRightExclusive() const noexcept\n     return { RightExclusive(), BottomExclusive() };\r\n }\r\n \r\n+til::point Viewport::BottomInclusiveRightExclusive() const noexcept\r\n+{\r\n+    return { RightExclusive(), BottomInclusive() };\r\n+}\r\n+\r\n // Method Description:\r\n // - For Accessibility, get a til::point representing the end of this viewport in exclusive terms.\r\n // - This is needed to represent an exclusive endpoint in UiaTextRange that includes the last\r\n@@ -295,6 +300,61 @@ bool Viewport::WalkInBounds(til::point& pos, const til::CoordType delta, bool al\n     return off == offClamped;\r\n }\r\n \r\n+bool Viewport::IncrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, 1);\r\n+}\r\n+\r\n+bool Viewport::DecrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, -1);\r\n+}\r\n+\r\n+bool Viewport::IsInExclusiveBounds(const til::point pos) const noexcept\r\n+{\r\n+    return pos.x >= Left() && pos.x <= RightExclusive() &&\r\n+           pos.y >= Top() && pos.y <= BottomInclusive();\r\n+}\r\n+\r\n+int Viewport::CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept\r\n+{\r\n+    // Assert that our coordinates are within the expected boundaries\r\n+    assert(IsInExclusiveBounds(first));\r\n+    assert(IsInExclusiveBounds(second));\r\n+\r\n+    // First set the distance vertically\r\n+    //   If first is on row 4 and second is on row 6, first will be -2 rows behind second * an 80 character row would be -160.\r\n+    //   For the same row, it'll be 0 rows * 80 character width = 0 difference.\r\n+    auto retVal = (first.y - second.y) * Width();\r\n+\r\n+    // Now adjust for horizontal differences\r\n+    //   If first is in position 15 and second is in position 30, first is -15 left in relation to 30.\r\n+    retVal += (first.x - second.x);\r\n+\r\n+    // Further notes:\r\n+    //   If we already moved behind one row, this will help correct for when first is right of second.\r\n+    //     For example, with row 4, col 79 and row 5, col 0 as first and second respectively, the distance is -1.\r\n+    //     Assume the row width is 80.\r\n+    //     Step one will set the retVal as -80 as first is one row behind the second.\r\n+    //     Step two will then see that first is 79 - 0 = +79 right of second and add 79\r\n+    //     The total is -80 + 79 = -1.\r\n+    return retVal;\r\n+}\r\n+\r\n+bool Viewport::WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept\r\n+{\r\n+    const auto l = static_cast<ptrdiff_t>(_sr.left);\r\n+    const auto t = static_cast<ptrdiff_t>(_sr.top);\r\n+    const auto w = static_cast<ptrdiff_t>(std::max(0, _sr.right - _sr.left + 2));\r\n+    const auto h = static_cast<ptrdiff_t>(std::max(0, _sr.bottom - _sr.top + 1));\r\n+    const auto max = w * h;\r\n+    const auto off = w * (pos.y - t) + (pos.x - l) + delta;\r\n+    const auto offClamped = std::clamp(off, ptrdiff_t{ 0 }, max);\r\n+    pos.x = gsl::narrow_cast<til::CoordType>(offClamped % w + l);\r\n+    pos.y = gsl::narrow_cast<til::CoordType>(offClamped / w + t);\r\n+    return off == offClamped;\r\n+}\r\n+\r\n // Routine Description:\r\n // - If walking through a viewport, one might want to know the origin\r\n //   for the direction walking.\r\n", "test_patch": "", "problem_statement": "[Windows Terminal]: Screen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\n### Windows Terminal version\r\n\r\n1.22.2362.0\r\n\r\n### Windows build number\r\n\r\n27695.1000\r\n\r\n### Other Software\r\n\r\nTest Environment:\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\n\r\n### Steps to reproduce\r\n\r\n**Repro steps :**\r\n1.Open Windows Terminal.\r\n2.Navigate to the editor.\r\n3.Turn on Narrator by pressing 'Ctrl + Windows + Enter' keys.\r\n4.Now turn on mark mode by pressing 'Ctrl + Shift + M' keys.\r\n5. Now navigate among words using 'Ctrl + Left/Right' keys.\r\n6.Observe the screen reader narration here.\r\n\r\n**Observation using NVDA and JAWS screen reader:**\r\nSame issue repro with NVDA and JAWS screen reader also.\r\n\r\n**User Experience**\r\nUsers who rely on screen reader may not get the info properly while navigating in mark mode.\r\n \r\n **WCAG Reference Link:**\r\n https://www.w3.org/WAI/WCAG21/Understanding/info-and-relationships\r\n \r\n**Attachment :**\r\n[Screen reader is not announcing full word information while navigating via ctrl + left_right arrow keys.zip](https://github.com/user-attachments/files/16943981/Screen.reader.is.not.announcing.full.word.information.while.navigating.via.ctrl.%2B.left_right.arrow.keys.zip)\r\n\r\n\r\n### Expected Behavior\r\n\r\nScreen reader should narrate complete word information while navigating using ctrl + left/right arrow keys in mark mode.\r\n\r\n### Actual Behavior\r\n\r\nScreen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\r\nFor example:\r\nFor word \"Microsoft\", screen reader is just announcing as 'M selected' when we navigate using 'Ctrl + Left' arrow key and announces as 't selected' using 'Ctrl + Right' arrow.\n", "hints_text": "This is by design. Pressing Ctrl+Left/Right moves you to the previous/next word respectively. You're just moving the cursor around, which is why the resulting announcement by the screen reader is what is selected (in the case above, \"M\"). If you want to expand the selection instead of just moving the cursor, you'll need to hold the Shift key.\r\n\r\nClosing as by design.\nBut should we perhaps narrate an entire word when the cursor position moves by more than 1 cell? That's what seems to happen when using Word at least. I'm not entirely sure how to implement this though.\n@carlos-zamora,\r\nThis issue is logged from the feedback of Adam Samec. As mentioned in the mail we should be able to navigate among the words using 'Ctrl + Left/Right' arrow keys.\r\nScreen reader is just narrating as selected with single character information instead of narrating the complete word information.\nI see. Ok, reopening.\r\n\r\nRelated issues:\r\n- #13447 \r\n- #15787\r\n\r\nI suspect that fixing both of those issues may fix this one inadvertently. Totally based on a hunch, but I wonder if screen readers behave differently when the cursor moves as a degenerate range (like, maybe they automatically read out the current word since there's no selected text).\r\n\r\nTried looking at Word under accevent but all I got was TextSelectionChanged events, which means that the screen reader has special logic to handle that (pretty standard) then calls the UIA APIs off of the text provider.", "created_at": "2024-10-23 20:19:57", "merge_commit_sha": "64d4fbab17f181c19b502d3170f36f8e16c594b1", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Update PR', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18095", "base_commit": "b2524f9db4f8664a70e0d8b2e963f21d7b3ced67", "patch": "diff --git a/policies/WindowsTerminal.admx b/policies/WindowsTerminal.admx\nindex 48c36aec7eb..ccda3e0ffd7 100644\n--- a/policies/WindowsTerminal.admx\n+++ b/policies/WindowsTerminal.admx\n@@ -9,6 +9,7 @@\n   <supportedOn>\r\n     <definitions>\r\n       <definition name=\"SUPPORTED_WindowsTerminal_1_21\" displayName=\"$(string.SUPPORTED_WindowsTerminal_1_21)\" />\r\n+      <definition name=\"SUPPORTED_WindowsTerminalCanary_1_23\" displayName=\"$(string.SUPPORTED_WindowsTerminalCanary_1_23)\" />\r\n     </definitions>\r\n   </supportedOn>\r\n   <categories>\r\n@@ -24,5 +25,12 @@\n         <multiText id=\"DisabledProfileSources\" valueName=\"DisabledProfileSources\" required=\"true\" />\r\n       </elements>\r\n     </policy>\r\n+    <policy name=\"EnabledLMProviders\" class=\"Both\" displayName=\"$(string.EnabledLMProviders)\" explainText=\"$(string.EnabledLMProvidersText)\" presentation=\"$(presentation.EnabledLMProviders)\" key=\"Software\\Policies\\Microsoft\\Windows Terminal\">\r\n+      <parentCategory ref=\"WindowsTerminal\" />\r\n+      <supportedOn ref=\"SUPPORTED_WindowsTerminalCanary_1_23\" />\r\n+      <elements>\r\n+        <multiText id=\"EnabledLMProviders\" valueName=\"EnabledLMProviders\" required=\"false\" />\r\n+      </elements>\r\n+    </policy>\r\n   </policies>\r\n </policyDefinitions>\r\ndiff --git a/policies/en-US/WindowsTerminal.adml b/policies/en-US/WindowsTerminal.adml\nindex 5516292e123..089b4bdd7e2 100644\n--- a/policies/en-US/WindowsTerminal.adml\n+++ b/policies/en-US/WindowsTerminal.adml\n@@ -7,6 +7,7 @@\n     <stringTable>\r\n       <string id=\"WindowsTerminal\">Windows Terminal</string>\r\n       <string id=\"SUPPORTED_WindowsTerminal_1_21\">At least Windows Terminal 1.21</string>\r\n+      <string id=\"SUPPORTED_WindowsTerminalCanary_1_23\">At least Windows Terminal Canary 1.23</string>\r\n       <string id=\"DisabledProfileSources\">Disabled Profile Sources</string>\r\n       <string id=\"DisabledProfileSourcesText\">Profiles will not be generated from any sources listed here. Source names can be arbitrary strings. Potential candidates can be found as the \"source\" property on profile definitions in Windows Terminal's settings.json file.\r\n \r\n@@ -18,11 +19,25 @@ Common sources are:\n For instance, setting this policy to Windows.Terminal.Wsl will disable the builtin WSL integration of Windows Terminal.\r\n \r\n Note: Existing profiles will disappear from Windows Terminal after adding their source to this policy.</string>\r\n+      <string id=\"EnabledLMProviders\">Enabled Language Model/AI Providers</string>\r\n+      <string id=\"EnabledLMProvidersText\">The listed Language Models/AI Providers will be available for use in Terminal Chat.\r\n+\r\n+Enabling the policy but leaving the list empty disallows all providers and therefore disables the Terminal Chat feature completely.\r\n+\r\n+Common providers are:\r\n+- AzureOpenAI\r\n+- OpenAI\r\n+- GitHubCopilot\r\n+\r\n+For instance, setting this policy to GitHubCopilot will allow the use of GitHubCopilot in Terminal Chat.</string>\r\n     </stringTable>\r\n     <presentationTable>\r\n       <presentation id=\"DisabledProfileSources\">\r\n         <multiTextBox refId=\"DisabledProfileSources\">List of disabled sources (one per line)</multiTextBox>\r\n       </presentation>\r\n+      <presentation id=\"EnabledLMProviders\">\r\n+        <multiTextBox refId=\"EnabledLMProviders\">List of enabled Language Model/AI Providers (one per line)</multiTextBox>\r\n+      </presentation>\r\n     </presentationTable>\r\n   </resources>\r\n </policyDefinitionResources>\r\ndiff --git a/src/cascadia/QueryExtension/ExtensionPalette.cpp b/src/cascadia/QueryExtension/ExtensionPalette.cpp\nindex 29fec0e9c0d..9606a96d1ea 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.cpp\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.cpp\n@@ -99,16 +99,16 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n         _lmProvider = lmProvider;\n         _clearAndInitializeMessages(nullptr, nullptr);\n \n-        const auto brandingData = _lmProvider.BrandingData();\n-        const auto headerIconPath = brandingData.HeaderIconPath().empty() ? terminalChatLogoPath : brandingData.HeaderIconPath();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n+        const auto headerIconPath = (!brandingData || brandingData.HeaderIconPath().empty()) ? terminalChatLogoPath : brandingData.HeaderIconPath();\n         Windows::Foundation::Uri headerImageSourceUri{ headerIconPath };\n         Media::Imaging::BitmapImage headerImageSource{ headerImageSourceUri };\n         HeaderIcon().Source(headerImageSource);\n \n-        const auto headerText = brandingData.HeaderText().empty() ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n+        const auto headerText = (!brandingData || brandingData.HeaderText().empty()) ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n         QueryIntro().Text(headerText);\n \n-        const auto subheaderText = brandingData.SubheaderText().empty() ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n+        const auto subheaderText = (!brandingData || brandingData.SubheaderText().empty()) ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n         TitleSubheader().Text(subheaderText);\n     }\n \n@@ -234,9 +234,9 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n             }\n         }\n \n-        const auto brandingData = _lmProvider.BrandingData();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n         const auto responseAttribution = response.ResponseAttribution().empty() ? _ProfileName : response.ResponseAttribution();\n-        const auto badgeUriPath = _lmProvider ? brandingData.BadgeIconPath() : winrt::hstring{};\n+        const auto badgeUriPath = brandingData ? brandingData.BadgeIconPath() : L\"\";\n         const auto responseGroupedMessages = winrt::make<GroupedChatMessages>(time, false, winrt::single_threaded_vector(std::move(messageParts)), responseAttribution, badgeUriPath);\n         _messages.Append(responseGroupedMessages);\n \ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 36a2b20b5bf..1aeb8cb013e 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -662,18 +662,23 @@ namespace winrt::TerminalApp::implementation\n     void TerminalPage::_HandleToggleAIChat(const IInspectable& /*sender*/,\r\n                                            const ActionEventArgs& args)\r\n     {\r\n-        if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n-        {\r\n-            _loadQueryExtension();\r\n-            ExtensionPresenter().Visibility(Visibility::Visible);\r\n-            _extensionPalette.Visibility(Visibility::Visible);\r\n-        }\r\n-        else\r\n+        args.Handled(false);\r\n+        // only handle this if the feature is allowed\r\n+        if (WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All))\r\n         {\r\n-            _extensionPalette.Visibility(Visibility::Collapsed);\r\n-            ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n+            {\r\n+                _loadQueryExtension();\r\n+                ExtensionPresenter().Visibility(Visibility::Visible);\r\n+                _extensionPalette.Visibility(Visibility::Visible);\r\n+            }\r\n+            else\r\n+            {\r\n+                _extensionPalette.Visibility(Visibility::Collapsed);\r\n+                ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            }\r\n+            args.Handled(true);\r\n         }\r\n-        args.Handled(true);\r\n     }\r\n \r\n     void TerminalPage::_HandleSetColorScheme(const IInspectable& /*sender*/,\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex f17d32cdea5..fbb1d62c829 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,58 +989,61 @@ namespace winrt::TerminalApp::implementation\n                 _SetAcceleratorForMenuItem(commandPaletteFlyout, commandPaletteKeyChord);\n             }\n \n-            // Create the AI chat button.\n-            auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n-            AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n-            const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n-\n-            WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n-            Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n-\n-            // BODGY\n-            // Manually load this icon from an SVG path; it is ironically much more humane this way.\n-            // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n-            // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n-            {\n-                static constexpr wil::zwstring_view pathSVG{\n-                    L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n-                    \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n-                    \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n-                    \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n-                    \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n-                    \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n-                    \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n-                    \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n-                    \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n-                    \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n-                    \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n-                    \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n-                    \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n-                    \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n-                    \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n-                    \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n-                    \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n-                    \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n-                    \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n-                };\n-                try\n+            // Create the AI chat button if AI features are allowed\n+            if (WI_IsAnyFlagSet(_settings.GlobalSettings().AIInfo().AllowedLMProviders(), EnabledLMProviders::All))\n+            {\n+                auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n+                AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n+                const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n+\n+                WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n+                Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n+\n+                // BODGY\n+                // Manually load this icon from an SVG path; it is ironically much more humane this way.\n+                // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n+                // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n                 {\n-                    hstring hsPathSVG{ pathSVG };\n-                    auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n-                    WUX::Controls::PathIcon pathIcon;\n-                    pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n-                    AIChatFlyout.Icon(pathIcon);\n+                    static constexpr wil::zwstring_view pathSVG{\n+                        L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n+                        \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n+                        \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n+                        \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n+                        \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n+                        \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n+                        \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n+                        \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n+                        \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n+                        \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n+                        \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n+                        \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n+                        \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n+                        \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n+                        \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n+                        \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n+                        \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n+                        \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n+                        \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n+                    };\n+                    try\n+                    {\n+                        hstring hsPathSVG{ pathSVG };\n+                        auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n+                        WUX::Controls::PathIcon pathIcon;\n+                        pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n+                        AIChatFlyout.Icon(pathIcon);\n+                    }\n+                    CATCH_LOG();\n                 }\n-                CATCH_LOG();\n-            }\n \n-            AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n-            newTabFlyout.Items().Append(AIChatFlyout);\n+                AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n+                newTabFlyout.Items().Append(AIChatFlyout);\n \n-            const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n-            if (AIChatKeyChord)\n-            {\n-                _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n+                if (AIChatKeyChord)\n+                {\n+                    _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                }\n             }\n \n             // Create the about button.\n@@ -5755,31 +5758,34 @@ namespace winrt::TerminalApp::implementation\n             }\n         }\n \n-        // we now have a provider of the correct type, update that\n-        winrt::hstring newAuthValues = authValuesString;\n-        if (newAuthValues.empty())\n+        if (_lmProvider)\n         {\n-            Windows::Data::Json::JsonObject authValuesJson;\n-            const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n-            switch (providerType)\n+            // we now have a provider of the correct type, update that\n+            winrt::hstring newAuthValues = authValuesString;\n+            if (newAuthValues.empty())\n             {\n-            case LLMProvider::AzureOpenAI:\n-                authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::OpenAI:\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::GithubCopilot:\n-                newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n-                break;\n-            default:\n-                break;\n+                Windows::Data::Json::JsonObject authValuesJson;\n+                const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n+                switch (providerType)\n+                {\n+                case LLMProvider::AzureOpenAI:\n+                    authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::OpenAI:\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::GithubCopilot:\n+                    newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n+                    break;\n+                default:\n+                    break;\n+                }\n             }\n+            _lmProvider.SetAuthentication(newAuthValues);\n         }\n-        _lmProvider.SetAuthentication(newAuthValues);\n \n         if (_extensionPalette)\n         {\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettings.xaml b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\nindex 676071a0930..c99020d6b97 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n@@ -40,8 +40,9 @@\n                            Style=\"{StaticResource TextBlockSubHeaderStyle}\" />\r\n                 <!--  GitHub Copilot  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_GithubCopilot\"\r\n-                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\"\r\n-                                        Visibility=\"{x:Bind ViewModel.GithubCopilotFeatureEnabled}\">\r\n+                                        CurrentValue=\"{x:Bind ViewModel.GithubCopilotStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.GithubCopilotAllowed}\"\r\n+                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreGithubCopilotTokensSet, Mode=OneWay}\">\r\n                             <Grid.ColumnDefinitions>\r\n@@ -137,6 +138,8 @@\n                 </local:SettingContainer>\r\n                 <!--  Azure OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_AzureOpenAIKeyAndEndpoint\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.AzureOpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.AzureOpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreAzureOpenAIKeyAndEndpointSet, Mode=OneWay}\">\r\n@@ -261,6 +264,8 @@\n                 </local:SettingContainer>\r\n                 <!--  OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_OpenAIKey\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.OpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.OpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.IsOpenAIKeySet, Mode=OneWay}\">\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\nindex 85ac83dc138..9a7df4b771c 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n@@ -17,6 +17,8 @@ using namespace winrt::Windows::UI::Xaml::Controls;\n using namespace winrt::Microsoft::Terminal::Settings::Model;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static constexpr std::wstring_view lockGlyph{ L\"\\uE72E\" };\r\n+\r\n namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\r\n {\r\n     AISettingsViewModel::AISettingsViewModel(Model::CascadiaSettings settings) :\r\n@@ -38,7 +40,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIEndpoint(winrt::hstring endpoint)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIEndpoint(endpoint);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n     }\r\n \r\n     winrt::hstring AISettingsViewModel::AzureOpenAIKey()\r\n@@ -49,7 +51,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIKey(key);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::AzureOpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::AzureOpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::AzureOpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::AzureOpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsOpenAIKeySet()\r\n@@ -65,7 +77,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::OpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().OpenAIKey(key);\r\n-        _NotifyChanges(L\"IsOpenAIKeySet\");\r\n+        _NotifyChanges(L\"IsOpenAIKeySet\", L\"OpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::OpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::OpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::OpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::OpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::AzureOpenAIActive()\r\n@@ -78,8 +100,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::AzureOpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::OpenAIActive()\r\n@@ -92,8 +118,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::OpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::AreGithubCopilotTokensSet()\r\n@@ -109,7 +139,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::GithubCopilotAuthValues(winrt::hstring authValues)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().GithubCopilotAuthValues(authValues);\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::GithubCopilotActive()\r\n@@ -122,13 +152,22 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::GithubCopilot);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n-    bool AISettingsViewModel::GithubCopilotFeatureEnabled()\r\n+    bool AISettingsViewModel::GithubCopilotAllowed() const noexcept\r\n     {\r\n-        return Feature_GithubCopilot::IsEnabled();\r\n+        return Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::GithubCopilot);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::GithubCopilotStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::GithubCopilot);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsTerminalPackaged()\r\n@@ -152,6 +191,55 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::_OnGithubAuthCompleted(const winrt::hstring& message)\r\n     {\r\n         _githubCopilotAuthMessage = message;\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\", L\"GithubCopilotStatus\");\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::_getStatusHelper(const Model::LLMProvider provider)\r\n+    {\r\n+        bool allowed;\r\n+        bool active;\r\n+        bool loggedIn;\r\n+        switch (provider)\r\n+        {\r\n+        case LLMProvider::AzureOpenAI:\r\n+            allowed = AzureOpenAIAllowed();\r\n+            active = AzureOpenAIActive();\r\n+            loggedIn = AreAzureOpenAIKeyAndEndpointSet();\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            allowed = OpenAIAllowed();\r\n+            active = OpenAIActive();\r\n+            loggedIn = IsOpenAIKeySet();\r\n+            break;\r\n+        case LLMProvider::GithubCopilot:\r\n+            allowed = GithubCopilotAllowed();\r\n+            active = GithubCopilotActive();\r\n+            loggedIn = AreGithubCopilotTokensSet();\r\n+            break;\r\n+        default:\r\n+            return L\"\";\r\n+        }\r\n+\r\n+        if (!allowed)\r\n+        {\r\n+            // not allowed, display the lock glyph\r\n+            return winrt::hstring{ lockGlyph } + L\" \" + RS_(L\"AISettings_ProviderNotAllowed\");\r\n+        }\r\n+        else if (active && loggedIn)\r\n+        {\r\n+            // active provider and logged in\r\n+            return RS_(L\"AISettings_ActiveLoggedIn\");\r\n+        }\r\n+        else if (active)\r\n+        {\r\n+            // active provider, not logged in\r\n+            return RS_(L\"AISettings_Active\");\r\n+        }\r\n+        else if (loggedIn)\r\n+        {\r\n+            // logged in, not active provider\r\n+            return RS_(L\"AISettings_LoggedIn\");\r\n+        }\r\n+        return L\"\";\r\n     }\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\nindex 41e8e7379b5..a0822dc65a3 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n@@ -24,27 +24,34 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         void AzureOpenAIKey(winrt::hstring key);\r\n         bool AzureOpenAIActive();\r\n         void AzureOpenAIActive(bool active);\r\n+        bool AzureOpenAIAllowed() const noexcept;\r\n+        winrt::hstring AzureOpenAIStatus();\r\n \r\n         bool IsOpenAIKeySet();\r\n         winrt::hstring OpenAIKey();\r\n         void OpenAIKey(winrt::hstring key);\r\n         bool OpenAIActive();\r\n         void OpenAIActive(bool active);\r\n+        bool OpenAIAllowed() const noexcept;\r\n+        winrt::hstring OpenAIStatus();\r\n \r\n         bool AreGithubCopilotTokensSet();\r\n         winrt::hstring GithubCopilotAuthMessage();\r\n         void GithubCopilotAuthValues(winrt::hstring authValues);\r\n         bool GithubCopilotActive();\r\n         void GithubCopilotActive(bool active);\r\n-        bool GithubCopilotFeatureEnabled();\r\n+        bool GithubCopilotAllowed() const noexcept;\r\n         bool IsTerminalPackaged();\r\n         void InitiateGithubAuth_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& e);\r\n         til::typed_event<Windows::Foundation::IInspectable, Windows::Foundation::IInspectable> GithubAuthRequested;\r\n+        winrt::hstring GithubCopilotStatus();\r\n \r\n     private:\r\n         Model::CascadiaSettings _Settings;\r\n         winrt::hstring _githubCopilotAuthMessage;\r\n \r\n+        winrt::hstring _getStatusHelper(const winrt::Microsoft::Terminal::Settings::Model::LLMProvider provider);\r\n+\r\n         winrt::Microsoft::Terminal::Settings::Editor::MainPage::GithubAuthCompleted_revoker _githubAuthCompleteRevoker;\r\n \r\n         void _OnGithubAuthCompleted(const winrt::hstring& message);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\nindex 6a31438ae84..3844b549800 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n@@ -15,16 +15,21 @@ namespace Microsoft.Terminal.Settings.Editor\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         Boolean AzureOpenAIActive;\r\n+        Boolean AzureOpenAIAllowed { get; };\r\n+        String AzureOpenAIStatus { get; };\r\n \r\n         Boolean IsOpenAIKeySet { get; };\r\n         String OpenAIKey;\r\n         Boolean OpenAIActive;\r\n+        Boolean OpenAIAllowed { get; };\r\n+        String OpenAIStatus { get; };\r\n \r\n         Boolean AreGithubCopilotTokensSet { get; };\r\n         String GithubCopilotAuthMessage { get; };\r\n         void GithubCopilotAuthValues(String authValues);\r\n         Boolean GithubCopilotActive;\r\n-        Boolean GithubCopilotFeatureEnabled { get; };\r\n+        Boolean GithubCopilotAllowed { get; };\r\n+        String GithubCopilotStatus { get; };\r\n         Boolean IsTerminalPackaged { get; };\r\n \r\n         void InitiateGithubAuth_Click(IInspectable sender, Windows.UI.Xaml.RoutedEventArgs args);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex 61c71d8a176..1eb01d86b1e 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -792,6 +792,22 @@\n     <value>Awaiting authentication completion from browser...</value>\r\n     <comment>Text displayed after the user clicks the button to initiate the GitHub authentication flow in their browser.</comment>\r\n   </data>\r\n+  <data name=\"AISettings_Active\" xml:space=\"preserve\">\r\n+    <value>Active</value>\r\n+    <comment>Text displayed when the service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_LoggedIn\" xml:space=\"preserve\">\r\n+    <value>Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ActiveLoggedIn\" xml:space=\"preserve\">\r\n+    <value>Active, Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider and that service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ProviderNotAllowed\" xml:space=\"preserve\">\r\n+    <value>Disabled by your administrator</value>\r\n+    <comment>Text displayed when the service provider has been disabled by the administrator.</comment>\r\n+  </data>\r\n   <data name=\"AISettings_PortableModeDisclaimer.Text\" xml:space=\"preserve\">\r\n     <value>Unable to authenticate to GitHub in unpackaged mode. Please launch Terminal as a packaged application to authenticate.</value>\r\n     <comment>Text displayed to the user when Terminal is un unpackaged mode.</comment>\r\n@@ -2109,4 +2125,4 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+</root>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.cpp b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\nindex 7af8678a3b4..562592b05d0 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n@@ -19,6 +19,45 @@ static constexpr wil::zwstring_view PasswordVaultAIEndpoint = L\"TerminalAIEndpoi\n static constexpr wil::zwstring_view PasswordVaultOpenAIKey = L\"TerminalOpenAIKey\";\r\n static constexpr wil::zwstring_view PasswordVaultGithubCopilotAuthValues = L\"TerminalGithubCopilotAuthValues\";\r\n \r\n+// When new LM providers are added here, make sure you also update the admx/adml!\r\n+static constexpr wil::zwstring_view AzureOpenAIPolicyKey = L\"AzureOpenAI\";\r\n+static constexpr wil::zwstring_view OpenAIPolicyKey = L\"OpenAI\";\r\n+static constexpr wil::zwstring_view GitHubCopilotPolicyKey = L\"GitHubCopilot\";\r\n+\r\n+winrt::Microsoft::Terminal::Settings::Model::EnabledLMProviders AIConfig::AllowedLMProviders() noexcept\r\n+{\r\n+    Model::EnabledLMProviders enabledLMProviders{ Model::EnabledLMProviders::All };\r\n+    // get our allowed list of LM providers from the registry\r\n+    for (const auto key : { HKEY_LOCAL_MACHINE, HKEY_CURRENT_USER })\r\n+    {\r\n+        wchar_t buffer[512]; // \"640K ought to be enough for anyone\"\r\n+        DWORD bufferSize = sizeof(buffer);\r\n+        if (RegGetValueW(key, LR\"(Software\\Policies\\Microsoft\\Windows Terminal)\", L\"EnabledLMProviders\", RRF_RT_REG_MULTI_SZ, nullptr, buffer, &bufferSize) == 0)\r\n+        {\r\n+            WI_ClearAllFlags(enabledLMProviders, Model::EnabledLMProviders::All);\r\n+            for (auto p = buffer; *p;)\r\n+            {\r\n+                const std::wstring_view value{ p };\r\n+                if (value == AzureOpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::AzureOpenAI);\r\n+                }\r\n+                else if (value == OpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::OpenAI);\r\n+                }\r\n+                else if (value == GitHubCopilotPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::GithubCopilot);\r\n+                }\r\n+                p += value.size() + 1;\r\n+            }\r\n+            break;\r\n+        }\r\n+    }\r\n+    return enabledLMProviders;\r\n+}\r\n+\r\n winrt::com_ptr<AIConfig> AIConfig::CopyAIConfig(const AIConfig* source)\r\n {\r\n     auto aiConfig{ winrt::make_self<AIConfig>() };\r\n@@ -108,16 +147,36 @@ winrt::hstring AIConfig::GithubCopilotAuthValues()\n \r\n winrt::Microsoft::Terminal::Settings::Model::LLMProvider AIConfig::ActiveProvider()\r\n {\r\n+    const auto allowedLMProviders = AllowedLMProviders();\r\n     const auto val{ _getActiveProviderImpl() };\r\n     if (val)\r\n     {\r\n-        // an active provider was explicitly set, return that\r\n-        // special case: only allow github copilot if the feature is enabled\r\n-        if (*val == LLMProvider::GithubCopilot && !Feature_GithubCopilot::IsEnabled())\r\n+        const auto setProvider = *val;\r\n+        // an active provider was explicitly set, return that as long as it is allowed\r\n+        switch (setProvider)\r\n         {\r\n-            return LLMProvider{};\r\n+        case LLMProvider::GithubCopilot:\r\n+            if (Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::GithubCopilot))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::AzureOpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::AzureOpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::OpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        default:\r\n+            break;\r\n         }\r\n-        return *val;\r\n+        return LLMProvider{};\r\n     }\r\n     else if (!AzureOpenAIEndpoint().empty() && !AzureOpenAIKey().empty())\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.h b/src/cascadia/TerminalSettingsModel/AIConfig.h\nindex 5bcf5868af4..5d1cf9e1767 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.h\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.h\n@@ -33,6 +33,8 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         Json::Value ToJson() const;\r\n         void LayerJson(const Json::Value& json);\r\n \r\n+        static Model::EnabledLMProviders AllowedLMProviders() noexcept;\r\n+\r\n         // Key and endpoint storage\r\n         // These are not written to the json, they are stored in the Windows Security Storage Vault\r\n         winrt::hstring AzureOpenAIEndpoint() noexcept;\r\n@@ -58,6 +60,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         _BASE_INHERITABLE_SETTING(Model::AIConfig, std::optional<LLMProvider>, ActiveProvider);\r\n \r\n     private:\r\n+        Model::EnabledLMProviders _enabledLMProviders{ Model::EnabledLMProviders::All };\r\n         winrt::hstring _RetrieveCredential(const wil::zwstring_view credential);\r\n         void _SetCredential(const wil::zwstring_view credential, const winrt::hstring& value);\r\n         std::unordered_map<std::wstring, std::wstring> _credentialCache;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.idl b/src/cascadia/TerminalSettingsModel/AIConfig.idl\nindex e3f15435591..f4ee727eece 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.idl\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.idl\n@@ -7,17 +7,28 @@ namespace Microsoft.Terminal.Settings.Model\n {\r\n     enum LLMProvider\r\n     {\r\n+        None,\r\n         AzureOpenAI,\n         OpenAI,\r\n         GithubCopilot\n     };\r\n \r\n+    [flags] enum EnabledLMProviders\r\n+    {\r\n+        AzureOpenAI = 0x1,\r\n+        OpenAI = 0x2,\r\n+        GithubCopilot = 0x4,\r\n+        All = 0xffffffff\r\n+    };\r\n+\r\n     delegate void AzureOpenAISettingChangedHandler();\r\n     delegate void OpenAISettingChangedHandler();\r\n \r\n     [default_interface] runtimeclass AIConfig {\r\n         INHERITABLE_SETTING(LLMProvider, ActiveProvider);\r\n \r\n+        static EnabledLMProviders AllowedLMProviders { get; };\r\n+\r\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         static event AzureOpenAISettingChangedHandler AzureOpenAISettingChanged;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.cpp b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\nindex bebe9ac76bd..4a212aa4edd 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n@@ -348,11 +348,18 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n     // - Actions of the parents are overridden by the children\r\n     void ActionMap::_PopulateCumulativeActionMap(std::unordered_map<hstring, Model::Command>& actionMap)\r\n     {\r\n+        // special case: don't add any ToggleAIChat actions if the feature has been disabled\r\n+        // note: we only refuse to add these actions to the cumulative action map, that way we don't remove them from the user's settings file\r\n+        // this means that these actions won't show up in the command palette, but any keybindings/modifications/etc to them will persist\r\n+        const auto terminalChatDisabled = !WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All);\r\n         for (const auto& [cmdID, cmd] : _ActionMap)\r\n         {\r\n             if (!actionMap.contains(cmdID))\r\n             {\r\n-                actionMap.emplace(cmdID, cmd);\r\n+                if (!terminalChatDisabled || cmd.ActionAndArgs().Action() != ShortcutAction::ToggleAIChat)\r\n+                {\r\n+                    actionMap.emplace(cmdID, cmd);\r\n+                }\r\n             }\r\n         }\r\n \r\n", "test_patch": "", "problem_statement": "[Terminal Chat AI] Allow company wide disabling this feature \n<!-- \n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\n\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\n\nAll good? Then proceed!\n-->\n\n# Description of the new feature/enhancement\n\nSome companies don't allow the usage of AI features or software that has AI feature for privacy reasons. \n\nPlease implement a way to centrally force disable this feature.\n\n# Proposed technical implementation details (optional)\n\nThis can be a policy or HKLM registry value/setting that admins can use to easily disabled this feature for all users.\n\nThis setting should work for portable, store and manually installed versions and on all chanels.\n\n", "hints_text": "Perfectly reasonable ask. I'll link it up to #15000, thanks!\r\n\r\nMy understanding of GPO is that it can be used to set a reg key, so we can easily query that regardless of what distribution method used. \n@zadjii-msft \nI suggest you to implement a common class where you do the registry reading and that return standardized values like we did in PowerToys (https://github.com/microsoft/PowerToys/blob/main/src/common/utils/gpo.h).\n\nEither you evaluate the Policy ones at application startup or every time the settings window and chat window gets opened.\n\nThe default expected behavior of policies is that computer scope has a higher priority than user scoope. And that you are able to set it either in user or in computer scope.\n\nI think the category in the ADMX file should be `Microsoft\\Windows Components\\Windows Terminal`. The Registry key can be `Software\\Policies\\Microsoft\\Windows Terminal` or `Software\\Policies\\Microsoft\\Windows\\Terminal`.\nGiven the current setup process requires custom azure resources, isn't that sufficient for an approval process at least short term?\n> Given the current setup process requires custom azure resources, isn't that sufficient for an approval process at least short term?\n\nI thought everyone is able to create such an required account including private persons. Is that wrong? Don't know about this.\n\nIf I require a special company account/license/configuration then it should be enough for short term.", "created_at": "2024-10-22 02:14:30", "merge_commit_sha": "438621fccb3e36a9b64858d8167ca7fd59a9cfbd", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-18022", "base_commit": "4386bf07fd65f763693132ee5e4c43a2a571dc76", "patch": "diff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 30b8ec15b81..0eba4511a92 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -491,14 +491,14 @@ namespace winrt::TerminalApp::implementation\n                 // Because this will always return -1 in this scenario unfortunately.\r\n                 //\r\n                 // So, what we're going to try to do is move the focus to the tab\r\n-                // to the left, within the bounds of how many tabs we have.\r\n+                // to the right, within the bounds of how many tabs we have.\r\n                 //\r\n                 // EX: we have 4 tabs: [A, B, C, D]. If we close:\r\n                 // * A (tabIndex=0): We'll want to focus tab B (now in index 0)\r\n-                // * B (tabIndex=1): We'll want to focus tab A (now in index 0)\r\n-                // * C (tabIndex=2): We'll want to focus tab B (now in index 1)\r\n+                // * B (tabIndex=1): We'll want to focus tab C (now in index 1)\r\n+                // * C (tabIndex=2): We'll want to focus tab D (now in index 2)\r\n                 // * D (tabIndex=3): We'll want to focus tab C (now in index 2)\r\n-                const auto newSelectedIndex = std::clamp<int32_t>(tabIndex - 1, 0, _tabs.Size() - 1);\r\n+                const auto newSelectedIndex = std::clamp<int32_t>(tabIndex, 0, _tabs.Size() - 1);\r\n                 // _UpdatedSelectedTab will do the work of setting up the new tab as\r\n                 // the focused one, and unfocusing all the others.\r\n                 auto newSelectedTab{ _tabs.GetAt(newSelectedIndex) };\r\n", "test_patch": "", "problem_statement": "Focus should move to next tab when closing a tab\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\nWhen a tab is closed, focus should move to the tab to the right instead of to the left.\r\n\r\nIn Firefox and Chrome, when a tab is closed by clicking on \ud83d\uddd9, the cursor naturally lands on the following tab, and the browser shows the content of that tab, allowing the user to close multiple tabs by chain-clicking.\r\n\r\nIn Terminal, when a tab is closed by clicking on \ud83d\uddd9 (or by any other method), the previous tab is shown even though the cursor is on the following tab. The user must move their cursor from the \ud83d\uddd9, click elsewhere on the tab to preview its contents, and then decide whether to close it. An absentminded user may close important tabs because of this unexpected behavior, particularly because Terminal does not confirm tab closing #6549. Before the user moves their cursor, the tab does not show its usual hover effect, adding to the confusion.\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\r\n\n", "hints_text": "Hi I'm an AI powered bot that finds similar issues based off the issue title.\n\nPlease view the issues below to see if they solve your problem, and if the issue describes your problem please consider closing this one and thumbs upping the other issue to help us prioritize it. Thank you!\n\n\n### Closed similar issues:\n- [Close Tabs to the Right (#7633)](https://github.com/microsoft/terminal/issues/7633),  similarity score: 0.76\n\n> Note: You can give me feedback by thumbs upping or thumbs downing this comment.\nGiven that others might have had this problem, I have tried searching for similar (open and closed) issues here and on Google\u2014no luck at all. This issue is not about closing all tabs to the right #5524.", "created_at": "2024-10-10 03:47:45", "merge_commit_sha": "d0e94365d0eebda4f0faccd63b0ff238b6f67822", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17993", "base_commit": "489a0f082d16e0ed5fe40f31eaf08ea7aeaf0838", "patch": "diff --git a/src/cascadia/QueryExtension/ExtensionPalette.cpp b/src/cascadia/QueryExtension/ExtensionPalette.cpp\nindex 61657a7810a..bfae56125be 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.cpp\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.cpp\n@@ -382,6 +382,7 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n         const auto key = e.OriginalKey();\n         const auto coreWindow = CoreWindow::GetForCurrentThread();\n         const auto ctrlDown = WI_IsFlagSet(coreWindow.GetKeyState(winrt::Windows::System::VirtualKey::Control), CoreVirtualKeyStates::Down);\n+        const auto shiftDown = WI_IsFlagSet(coreWindow.GetKeyState(winrt::Windows::System::VirtualKey::Shift), CoreVirtualKeyStates::Down);\n \n         if (key == VirtualKey::Escape)\n         {\n@@ -393,7 +394,7 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n \n             e.Handled(true);\n         }\n-        else if (key == VirtualKey::Enter)\n+        else if (key == VirtualKey::Enter && !shiftDown)\n         {\n             if (const auto& textBox = e.OriginalSource().try_as<TextBox>())\n             {\ndiff --git a/src/cascadia/QueryExtension/ExtensionPalette.xaml b/src/cascadia/QueryExtension/ExtensionPalette.xaml\nindex 2f807a86e4a..f6f3dce09ff 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.xaml\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.xaml\n@@ -392,6 +392,7 @@\n                      Height=\"100\"\r\n                      Margin=\"16,0,16,4\"\r\n                      Padding=\"18,8,8,8\"\r\n+                     AcceptsReturn=\"True\"\r\n                      IsSpellCheckEnabled=\"False\"\r\n                      PlaceholderText=\"{x:Bind QueryBoxPlaceholderText}\"\r\n                      Text=\"\"\r\n", "test_patch": "", "problem_statement": "[Terminal Chat] Shift+Enter should add a newline in the textbox\nI pressed \"Shift+Enter\" expecting a newline and accidentally submitted my query.\r\n\r\nWith the text box being so large, it feels like \"Shift+Enter\" should be accepted to add newlines.\r\n\r\nI _think_ this is an easy fix. We might just have to use this property: https://learn.microsoft.com/en-us/uwp/api/windows.ui.xaml.controls.textbox.acceptsreturn?view=winrt-26100#windows-ui-xaml-controls-textbox-acceptsreturn\n", "hints_text": "", "created_at": "2024-10-03 21:08:14", "merge_commit_sha": "c989f86ad61d357deb43bb20983cec5c179880da", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17951", "base_commit": "a7e47b711a2adc7b9e80eddea8168089f7d3b11e", "patch": "diff --git a/src/terminal/adapter/SixelParser.cpp b/src/terminal/adapter/SixelParser.cpp\nindex f9dbdf6603a..979dd42371c 100644\n--- a/src/terminal/adapter/SixelParser.cpp\n+++ b/src/terminal/adapter/SixelParser.cpp\n@@ -715,8 +715,16 @@ void SixelParser::_eraseImageBufferRows(const int rowCount, const til::CoordType\n     const auto pixelCount = rowCount * _cellSize.height;\r\n     const auto bufferOffset = rowOffset * _cellSize.height * _imageMaxWidth;\r\n     const auto bufferOffsetEnd = bufferOffset + pixelCount * _imageMaxWidth;\r\n-    _imageBuffer.erase(_imageBuffer.begin() + bufferOffset, _imageBuffer.begin() + bufferOffsetEnd);\r\n-    _imageCursor.y -= pixelCount;\r\n+    if (static_cast<size_t>(bufferOffsetEnd) >= _imageBuffer.size()) [[unlikely]]\r\n+    {\r\n+        _imageBuffer.clear();\r\n+        _imageCursor.y = 0;\r\n+    }\r\n+    else\r\n+    {\r\n+        _imageBuffer.erase(_imageBuffer.begin() + bufferOffset, _imageBuffer.begin() + bufferOffsetEnd);\r\n+        _imageCursor.y -= pixelCount;\r\n+    }\r\n }\r\n \r\n void SixelParser::_maybeFlushImageBuffer(const bool endOfSequence)\r\n", "test_patch": "", "problem_statement": "Resizing the font while playing a sixel video can trigger a crash\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n10.0.19045.4894\n\n### Other Software\n\n[img2sixel](https://github.com/saitoha/libsixel)\n\n### Steps to reproduce\n\n1. Start a WSL shell in Windows Terminal.\r\n2. Get some content in the buffer so that resizing will force a reflow.\r\n3. View an animated gif with `img2sixel filename.gif` so you've got some sixel content being constantly refreshed.\r\n4. Resize the font with the mouse scroll wheel, so you're rapidly growing and shrinking the animation. Make sure the image sometimes grows larger than the viewport.\n\n### Expected Behavior\n\nThe animation should continue to play without any problems, aside from the fact that some partial frames will be pushed into the scrollback buffer when the image becomes too large to fit the height of the page.\n\n### Actual Behavior\n\nThe terminal eventually crashes.\r\n\r\nThis doesn't happen in OpenConsole, but that is assumedly because it resizes the window when you change the font size, so the text dimensions never change, and thus no reflow is required. Although now that I say that, I suspect you could possibly cause it to crash just by resizing the window in a way that triggers a reflow.\n", "hints_text": "", "created_at": "2024-09-22 17:21:40", "merge_commit_sha": "fc586e2662c1b490e4f1817c1b3ba8388442da14", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17945", "base_commit": "a7e47b711a2adc7b9e80eddea8168089f7d3b11e", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..94d2a938a81 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -140,8 +140,10 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetWindowTitle(const std::wstring_view title) override;\r\n     CursorType GetUserDefaultCursorStyle() const noexcept override;\r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n-    void SetConsoleOutputCP(const unsigned int codepage) noexcept override;\r\n-    unsigned int GetConsoleOutputCP() const noexcept override;\r\n+    void SetCodePage(const unsigned int codepage) noexcept override;\r\n+    void ResetCodePage() noexcept override;\r\n+    unsigned int GetOutputCodePage() const noexcept override;\r\n+    unsigned int GetInputCodePage() const noexcept override;\r\n     void CopyToClipboard(wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\n     void SetWorkingDirectory(std::wstring_view uri) override;\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 40ff599e115..e6edec3ee92 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -116,14 +116,25 @@ bool Terminal::ResizeWindow(const til::CoordType width, const til::CoordType hei\n     return false;\r\n }\r\n \r\n-void Terminal::SetConsoleOutputCP(const unsigned int /*codepage*/) noexcept\r\n+void Terminal::SetCodePage(const unsigned int /*codepage*/) noexcept\r\n {\r\n-    // TODO: This will be needed to support 8-bit charsets and DOCS sequences.\r\n+    // Code pages are dealt with in ConHost, so this isn't needed.\r\n }\r\n \r\n-unsigned int Terminal::GetConsoleOutputCP() const noexcept\r\n+void Terminal::ResetCodePage() noexcept\r\n {\r\n-    // TODO: See SetConsoleOutputCP above.\r\n+    // There is nothing to reset, since the code page never changes.\r\n+}\r\n+\r\n+unsigned int Terminal::GetOutputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n+    return CP_UTF8;\r\n+}\r\n+\r\n+unsigned int Terminal::GetInputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n     return CP_UTF8;\r\n }\r\n \r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex f199362f7af..b8109bca718 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -1140,7 +1140,6 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n     {\r\n         // Set new code page\r\n         gci.OutputCP = codepage;\r\n-\r\n         SetConsoleCPInfo(TRUE);\r\n     }\r\n \r\n@@ -1157,13 +1156,36 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n {\r\n     try\r\n     {\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-        return DoSrvSetConsoleOutputCodePage(codepage);\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultOutputCP = codepage;\r\n+        return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n }\r\n \r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage)\r\n+{\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+\r\n+    // Return if it's not known as a valid codepage ID.\r\n+    RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n+\r\n+    // Do nothing if no change.\r\n+    if (gci.CP != codepage)\r\n+    {\r\n+        // Set new code page\r\n+        gci.CP = codepage;\r\n+        SetConsoleCPInfo(FALSE);\r\n+    }\r\n+\r\n+    return S_OK;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Sets the codepage used for translating text when calling A versions of functions affecting the input buffer.\r\n // Arguments:\r\n@@ -1177,19 +1199,10 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n         auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-\r\n-        // Return if it's not known as a valid codepage ID.\r\n-        RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n-\r\n-        // Do nothing if no change.\r\n-        if (gci.CP != codepage)\r\n-        {\r\n-            // Set new code page\r\n-            gci.CP = codepage;\r\n-\r\n-            SetConsoleCPInfo(FALSE);\r\n-        }\r\n-\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultCP = codepage;\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\ndiff --git a/src/host/getset.h b/src/host/getset.h\nindex 4c042813c27..f3030eb6050 100644\n--- a/src/host/getset.h\n+++ b/src/host/getset.h\n@@ -19,3 +19,4 @@ Revision History:\n class SCREEN_INFORMATION;\r\n \r\n [[nodiscard]] HRESULT DoSrvSetConsoleOutputCodePage(const unsigned int codepage);\r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage);\r\ndiff --git a/src/host/output.cpp b/src/host/output.cpp\nindex e57412f5310..729821c841a 100644\n--- a/src/host/output.cpp\n+++ b/src/host/output.cpp\n@@ -35,6 +35,8 @@ using namespace Microsoft::Console::Interactivity;\n     // codepage by console.cpl or shell32. The default codepage is OEMCP.\r\n     gci.CP = gci.GetCodePage();\r\n     gci.OutputCP = gci.GetCodePage();\r\n+    gci.DefaultCP = gci.GetCodePage();\r\n+    gci.DefaultOutputCP = gci.GetCodePage();\r\n \r\n     gci.Flags |= CONSOLE_USE_PRIVATE_FLAGS;\r\n \r\ndiff --git a/src/host/outputStream.cpp b/src/host/outputStream.cpp\nindex d88be99ef33..3fbeb3cafaf 100644\n--- a/src/host/outputStream.cpp\n+++ b/src/host/outputStream.cpp\n@@ -221,27 +221,52 @@ void ConhostInternalGetSet::ShowWindow(bool showOrHide)\n }\r\n \r\n // Routine Description:\r\n-// - Connects the SetConsoleOutputCP API call directly into our Driver Message servicing call inside Conhost.exe\r\n+// - Set the code page used for translating text when calling A versions of I/O functions.\r\n // Arguments:\r\n-// - codepage - the new output codepage of the console.\r\n+// - codepage - the new code page of the console.\r\n // Return Value:\r\n // - <none>\r\n-void ConhostInternalGetSet::SetConsoleOutputCP(const unsigned int codepage)\r\n+void ConhostInternalGetSet::SetCodePage(const unsigned int codepage)\r\n {\r\n-    THROW_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n }\r\n \r\n // Routine Description:\r\n-// - Gets the codepage used for translating text when calling A versions of functions affecting the output buffer.\r\n+// - Reset the code pages to their default values.\r\n // Arguments:\r\n // - <none>\r\n // Return Value:\r\n-// - the outputCP of the console.\r\n-unsigned int ConhostInternalGetSet::GetConsoleOutputCP() const\r\n+// - <none>\r\n+void ConhostInternalGetSet::ResetCodePage()\r\n+{\r\n+    const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(gci.DefaultOutputCP));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(gci.DefaultCP));\r\n+}\r\n+\r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of output functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the output code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetOutputCodePage() const\r\n {\r\n     return ServiceLocator::LocateGlobals().getConsoleInformation().OutputCP;\r\n }\r\n \r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of input functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the input code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetInputCodePage() const\r\n+{\r\n+    return ServiceLocator::LocateGlobals().getConsoleInformation().CP;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Copies the given content to the clipboard.\r\n // Arguments:\r\ndiff --git a/src/host/outputStream.hpp b/src/host/outputStream.hpp\nindex 6b564abbf8d..7b76e5f3d0a 100644\n--- a/src/host/outputStream.hpp\n+++ b/src/host/outputStream.hpp\n@@ -53,8 +53,10 @@ class ConhostInternalGetSet final : public Microsoft::Console::VirtualTerminal::\n \r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override;\r\n-    unsigned int GetConsoleOutputCP() const override;\r\n+    void SetCodePage(const unsigned int codepage) override;\r\n+    void ResetCodePage() override;\r\n+    unsigned int GetOutputCodePage() const override;\r\n+    unsigned int GetInputCodePage() const override;\r\n \r\n     void CopyToClipboard(const wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\ndiff --git a/src/host/server.h b/src/host/server.h\nindex 1e14a94b731..0a0f905777b 100644\n--- a/src/host/server.h\n+++ b/src/host/server.h\n@@ -90,6 +90,9 @@ class CONSOLE_INFORMATION :\n     // the following fields are used for ansi-unicode translation\r\n     UINT CP = 0;\r\n     UINT OutputCP = 0;\r\n+    // the VT RIS sequence uses these default values to reset the code pages\r\n+    UINT DefaultCP = 0;\r\n+    UINT DefaultOutputCP = 0;\r\n \r\n     ULONG CtrlFlags = 0; // indicates outstanding ctrl requests\r\n     ULONG LimitingProcessId = 0;\r\ndiff --git a/src/terminal/adapter/ITermDispatch.hpp b/src/terminal/adapter/ITermDispatch.hpp\nindex 3df5ef30178..8ec9e33bdc0 100644\n--- a/src/terminal/adapter/ITermDispatch.hpp\n+++ b/src/terminal/adapter/ITermDispatch.hpp\n@@ -122,6 +122,7 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual void LockingShiftRight(const VTInt gsetNumber) = 0; // LS1R, LS2R, LS3R\r\n     virtual void SingleShift(const VTInt gsetNumber) = 0; // SS2, SS3\r\n     virtual void AcceptC1Controls(const bool enabled) = 0; // DECAC1\r\n+    virtual void SendC1Controls(const bool enabled) = 0; // S8C1T, S7C1T\r\n     virtual void AnnounceCodeStructure(const VTInt ansiLevel) = 0; // ACS\r\n \r\n     virtual void SoftReset() = 0; // DECSTR\r\ndiff --git a/src/terminal/adapter/ITerminalApi.hpp b/src/terminal/adapter/ITerminalApi.hpp\nindex b874bfb8cd4..532133f9a84 100644\n--- a/src/terminal/adapter/ITerminalApi.hpp\n+++ b/src/terminal/adapter/ITerminalApi.hpp\n@@ -72,8 +72,10 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         virtual void ShowWindow(bool showOrHide) = 0;\r\n \r\n-        virtual void SetConsoleOutputCP(const unsigned int codepage) = 0;\r\n-        virtual unsigned int GetConsoleOutputCP() const = 0;\r\n+        virtual void SetCodePage(const unsigned int codepage) = 0;\r\n+        virtual void ResetCodePage() = 0;\r\n+        virtual unsigned int GetOutputCodePage() const = 0;\r\n+        virtual unsigned int GetInputCodePage() const = 0;\r\n \r\n         virtual void CopyToClipboard(const wil::zwstring_view content) = 0;\r\n         virtual void SetTaskbarProgress(const DispatchTypes::TaskbarState state, const size_t progress) = 0;\r\ndiff --git a/src/terminal/adapter/InteractDispatch.cpp b/src/terminal/adapter/InteractDispatch.cpp\nindex fa1a0826047..a8fc483aee6 100644\n--- a/src/terminal/adapter/InteractDispatch.cpp\n+++ b/src/terminal/adapter/InteractDispatch.cpp\n@@ -62,7 +62,7 @@ void InteractDispatch::WriteString(const std::wstring_view string)\n {\r\n     if (!string.empty())\r\n     {\r\n-        const auto codepage = _api.GetConsoleOutputCP();\r\n+        const auto codepage = _api.GetOutputCodePage();\r\n         InputEventQueue keyEvents;\r\n \r\n         for (const auto& wch : string)\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 3899c7cd84d..9ee93ede8b8 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1243,7 +1243,7 @@ void AdaptDispatch::FillRectangularArea(const VTParameter ch, const VTInt top, c\n     const auto charValue = ch.value_or(0) == 0 ? 32 : ch.value();\n     const auto glChar = (charValue >= 32 && charValue <= 126);\n     const auto grChar = (charValue >= 160 && charValue <= 255);\n-    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetConsoleOutputCP() == CP_UTF8);\n+    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetOutputCodePage() == CP_UTF8);\n     if (glChar || grChar || unicodeChar)\n     {\n         const auto fillChar = _termOutput.TranslateKey(gsl::narrow_cast<wchar_t>(charValue));\n@@ -1377,8 +1377,7 @@ void AdaptDispatch::RequestChecksumRectangularArea(const VTInt id, const VTInt p\n             }\n         }\n     }\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", id, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", id, checksum));\n }\n \n // Routine Description:\n@@ -1484,7 +1483,7 @@ void AdaptDispatch::DeviceAttributes()\n     // 32 = Text macros\n     // 42 = ISO Latin-2 character set\n \n-    _api.ReturnResponse(L\"\\x1b[?61;4;6;7;14;21;22;23;24;28;32;42c\");\n+    _ReturnCsiResponse(L\"?61;4;6;7;14;21;22;23;24;28;32;42c\");\n }\n \n // Routine Description:\n@@ -1496,7 +1495,7 @@ void AdaptDispatch::DeviceAttributes()\n // - <none>\n void AdaptDispatch::SecondaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1b[>0;10;1c\");\n+    _ReturnCsiResponse(L\">0;10;1c\");\n }\n \n // Routine Description:\n@@ -1506,7 +1505,7 @@ void AdaptDispatch::SecondaryDeviceAttributes()\n // - <none>\n void AdaptDispatch::TertiaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1bP!|00000000\\x1b\\\\\");\n+    _ReturnDcsResponse(L\"!|00000000\");\n }\n \n // Routine Description:\n@@ -1544,10 +1543,10 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n     switch (permission)\n     {\n     case DispatchTypes::ReportingPermission::Unsolicited:\n-        _api.ReturnResponse(L\"\\x1b[2;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"2;1;1;128;128;1;0x\");\n         break;\n     case DispatchTypes::ReportingPermission::Solicited:\n-        _api.ReturnResponse(L\"\\x1b[3;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"3;1;1;128;128;1;0x\");\n         break;\n     default:\n         break;\n@@ -1562,7 +1561,7 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n // - <none>\n void AdaptDispatch::_DeviceStatusReport(const wchar_t* parameters) const\n {\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{}n\"), parameters));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}n\"), parameters));\n }\n \n // Routine Description:\n@@ -1598,14 +1597,12 @@ void AdaptDispatch::_CursorPositionReport(const bool extendedReport)\n     {\n         // An extended report also includes the page number.\n         const auto pageNumber = page.Number();\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber));\n     }\n     else\n     {\n         // The standard report only returns the cursor position.\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%d;%dR\", cursorPosition.y, cursorPosition.x);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%d;%dR\", cursorPosition.y, cursorPosition.x));\n     }\n }\n \n@@ -1619,8 +1616,7 @@ void AdaptDispatch::_MacroSpaceReport() const\n {\n     const auto spaceInBytes = _macroBuffer ? _macroBuffer->GetSpaceAvailable() : MacroBuffer::MAX_SPACE;\n     // The available space is measured in blocks of 16 bytes, so we need to divide by 16.\n-    const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%zu*{\", spaceInBytes / 16);\n-    _api.ReturnResponse(response);\n+    _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%zu*{\", spaceInBytes / 16));\n }\n \n // Routine Description:\n@@ -1633,8 +1629,7 @@ void AdaptDispatch::_MacroChecksumReport(const VTParameter id) const\n {\n     const auto requestId = id.value_or(0);\n     const auto checksum = _macroBuffer ? _macroBuffer->CalculateChecksum() : 0;\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", requestId, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", requestId, checksum));\n }\n \n // Routine Description:\n@@ -1732,7 +1727,7 @@ void AdaptDispatch::RequestDisplayedExtent()\n     const auto height = page.Viewport().height();\n     const auto left = page.XPanOffset() + 1;\n     const auto top = page.YPanOffset() + 1;\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n }\n \n // Routine Description:\n@@ -2068,7 +2063,7 @@ void AdaptDispatch::RequestMode(const DispatchTypes::ModeParams param)\n         prefix = L\"?\";\n     }\n \n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\x1b[{}{};{}$y\"), prefix, mode, state));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}{};{}$y\"), prefix, mode, state));\n }\n \n // - DECKPAM, DECKPNM - Sets the keypad input mode to either Application mode or Numeric mode (true, false respectively)\n@@ -2785,22 +2780,15 @@ void AdaptDispatch::_InitTabStopsForWidth(const VTInt width)\n // - codingSystem - The coding system that will be selected.\n void AdaptDispatch::DesignateCodingSystem(const VTID codingSystem)\n {\n-    // If we haven't previously saved the initial code page, do so now.\n-    // This will be used to restore the code page in response to a reset.\n-    if (!_initialCodePage.has_value())\n-    {\n-        _initialCodePage = _api.GetConsoleOutputCP();\n-    }\n-\n     switch (codingSystem)\n     {\n     case DispatchTypes::CodingSystem::ISO2022:\n-        _api.SetConsoleOutputCP(28591);\n+        _api.SetCodePage(28591);\n         AcceptC1Controls(true);\n         _termOutput.EnableGrTranslation(true);\n         break;\n     case DispatchTypes::CodingSystem::UTF8:\n-        _api.SetConsoleOutputCP(CP_UTF8);\n+        _api.SetCodePage(CP_UTF8);\n         AcceptC1Controls(false);\n         _termOutput.EnableGrTranslation(false);\n         break;\n@@ -2871,6 +2859,24 @@ void AdaptDispatch::AcceptC1Controls(const bool enabled)\n     _api.GetStateMachine().SetParserMode(StateMachine::Mode::AcceptC1, enabled);\n }\n \n+//Routine Description:\n+// S8C1T/S7C1T - Enable or disable the sending of C1 controls in key sequences\n+//   and query responses. When this is enabled, C1 controls are sent as a single\n+//   codepoint. When disabled, they're sent as a two character escape sequence.\n+//Arguments:\n+// - enabled - true to send C1 controls, false to send escape sequences.\n+void AdaptDispatch::SendC1Controls(const bool enabled)\n+{\n+    // If this is an attempt to enable C1 controls, the input code page must be\n+    // one of the DOCS choices (UTF-8 or ISO-8859-1), otherwise there's a risk\n+    // that those controls won't have a valid encoding.\n+    const auto codepage = _api.GetInputCodePage();\n+    if (enabled == false || codepage == CP_UTF8 || codepage == 28591)\n+    {\n+        _terminalInput.SetInputMode(TerminalInput::Mode::SendC1, enabled);\n+    }\n+}\n+\n //Routine Description:\n // ACS - Announces the ANSI conformance level for subsequent data exchange.\n //  This requires certain character sets to be mapped into the terminal's\n@@ -3003,13 +3009,11 @@ void AdaptDispatch::HardReset()\n \n     // Completely reset the TerminalOutput state.\n     _termOutput = {};\n-    if (_initialCodePage.has_value())\n-    {\n-        // Restore initial code page if previously changed by a DOCS sequence.\n-        _api.SetConsoleOutputCP(_initialCodePage.value());\n-    }\n-    // Disable parsing of C1 control codes.\n+    // Reset the code page to the default value.\n+    _api.ResetCodePage();\n+    // Disable parsing and sending of C1 control codes.\n     AcceptC1Controls(false);\n+    SendC1Controls(false);\n \n     // Sets the SGR state to normal - this must be done before EraseInDisplay\n     //      to ensure that it clears with the default background color.\n@@ -3276,7 +3280,7 @@ void AdaptDispatch::RequestColorTableEntry(const size_t tableIndex)\n     {\n         const til::color c{ color };\n         // Scale values up to match xterm's 16-bit color report format.\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]4;{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+        _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"4;{};rgb:{:04x}/{:04x}/{:04x}\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n     }\n }\n \n@@ -3321,7 +3325,7 @@ void AdaptDispatch::RequestXtermColorResource(const size_t resource)\n         {\n             const til::color c{ color };\n             // Scale values up to match xterm's 16-bit color report format.\n-            _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+            _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"{};rgb:{:04x}/{:04x}/{:04x}\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n         }\n     }\n }\n@@ -3377,7 +3381,7 @@ void AdaptDispatch::WindowManipulation(const DispatchTypes::WindowManipulationTy\n \n     const auto reportSize = [&](const auto size) {\n         const auto reportType = function - 10;\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{}t\"), reportType, size.height, size.width));\n+        _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{}t\"), reportType, size.height, size.width));\n     };\n \n     switch (function)\n@@ -3844,7 +3848,7 @@ void AdaptDispatch::RequestUserPreferenceCharset()\n {\n     const auto size = _termOutput.GetUserPreferenceCharsetSize();\n     const auto id = _termOutput.GetUserPreferenceCharsetId();\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P{}!u{}\\033\\\\\"), (size == 96 ? 1 : 0), id));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"{}!u{}\"), (size == 96 ? 1 : 0), id));\n }\n \n // Method Description:\n@@ -3976,9 +3980,9 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ s.\n+    // A valid response always starts with 2 $ s.\n     fmt::basic_memory_buffer<wchar_t, TextColor::TABLE_SIZE * 18> response;\n-    response.append(L\"\\033P2$s\"sv);\n+    response.append(L\"2$s\"sv);\n \n     const auto modelNumber = static_cast<int>(colorModel);\n     for (size_t colorNumber = 0; colorNumber < TextColor::TABLE_SIZE; colorNumber++)\n@@ -4003,9 +4007,7 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4108,7 +4110,7 @@ ITermDispatch::StringHandler AdaptDispatch::RequestSetting()\n                 _ReportDECACSetting(VTParameter{ parameter });\n                 break;\n             default:\n-                _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+                _ReturnDcsResponse(L\"0$r\");\n                 break;\n             }\n             return false;\n@@ -4147,10 +4149,10 @@ void AdaptDispatch::_ReportSGRSetting() const\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 1 $ r.\n+    // A valid response always starts with 1 $ r.\n     // Then the '0' parameter is to reset the SGR attributes to the defaults.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P1$r0\"sv);\n+    response.append(L\"1$r0\"sv);\n \n     const auto& attr = _pages.ActivePage().Attributes();\n     const auto ulStyle = attr.GetUnderlineStyle();\n@@ -4202,9 +4204,9 @@ void AdaptDispatch::_ReportSGRSetting() const\n     addColor(40, attr.GetBackground());\n     addColor(50, attr.GetUnderlineColor());\n \n-    // The 'm' indicates this is an SGR response, and ST ends the sequence.\n-    response.append(L\"m\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    // The 'm' indicates this is an SGR response.\n+    response.append(L\"m\"sv);\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4217,10 +4219,9 @@ void AdaptDispatch::_ReportDECSTBMSetting()\n {\n     const auto page = _pages.ActivePage();\n     const auto [marginTop, marginBottom] = _GetVerticalMargins(page, false);\n-    // A valid response always starts with DCS 1 $ r, the 'r' indicates this\n-    // is a DECSTBM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the final 'r' indicates this is a DECSTBM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}r\\033\\\\\"), marginTop + 1, marginBottom + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}r\"), marginTop + 1, marginBottom + 1));\n }\n \n // Method Description:\n@@ -4233,10 +4234,9 @@ void AdaptDispatch::_ReportDECSLRMSetting()\n {\n     const auto pageWidth = _pages.ActivePage().Width();\n     const auto [marginLeft, marginRight] = _GetHorizontalMargins(pageWidth);\n-    // A valid response always starts with DCS 1 $ r, the 's' indicates this\n-    // is a DECSLRM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the 's' indicates this is a DECSLRM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}s\\033\\\\\"), marginLeft + 1, marginRight + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}s\"), marginLeft + 1, marginRight + 1));\n }\n \n // Method Description:\n@@ -4249,26 +4249,26 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n {\n     const auto& cursor = _pages.ActivePage().Cursor();\n     const auto blinking = cursor.IsBlinkingAllowed();\n-    // A valid response always starts with DCS 1 $ r. This is followed by a\n+    // A valid response always starts with 1 $ r. This is followed by a\n     // number from 1 to 6 representing the cursor style. The ' q' indicates\n-    // this is a DECSCUSR response, and ST ends the sequence.\n+    // this is a DECSCUSR response.\n     switch (cursor.GetType())\n     {\n     case CursorType::FullBox:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r1 q\\033\\\\\" : L\"\\033P1$r2 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r1 q\" : L\"1$r2 q\");\n         break;\n     case CursorType::Underscore:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r3 q\\033\\\\\" : L\"\\033P1$r4 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r3 q\" : L\"1$r4 q\");\n         break;\n     case CursorType::VerticalBar:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r5 q\\033\\\\\" : L\"\\033P1$r6 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r5 q\" : L\"1$r6 q\");\n         break;\n     default:\n         // If we have a non-standard style, this is likely because it's the\n         // user's chosen default style, so we report a default value of 0.\n         // That way, if an application later tries to restore the cursor with\n         // the returned value, it should be reset to its original state.\n-        _api.ReturnResponse(L\"\\033P1$r0 q\\033\\\\\");\n+        _ReturnDcsResponse(L\"1$r0 q\");\n         break;\n     }\n }\n@@ -4282,10 +4282,10 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n void AdaptDispatch::_ReportDECSCASetting() const\n {\n     const auto isProtected = _pages.ActivePage().Attributes().IsProtected();\n-    // A valid response always starts with DCS 1 $ r. This is followed by '1' if\n-    // the protected attribute is set, or '0' if not. The '\"q' indicates this is\n-    // a DECSCA response, and ST ends the sequence.\n-    _api.ReturnResponse(isProtected ? L\"\\033P1$r1\\\"q\\033\\\\\" : L\"\\033P1$r0\\\"q\\033\\\\\");\n+    // A valid response always starts with 1 $ r. This is followed by '1' if the\n+    // protected attribute is set, or '0' if not. The '\"q' indicates this is a\n+    // DECSCA response.\n+    _ReturnDcsResponse(isProtected ? L\"1$r1\\\"q\" : L\"1$r0\\\"q\");\n }\n \n // Method Description:\n@@ -4297,10 +4297,10 @@ void AdaptDispatch::_ReportDECSCASetting() const\n void AdaptDispatch::_ReportDECSACESetting() const\n {\n     const auto rectangularExtent = _modes.test(Mode::RectangularChangeExtent);\n-    // A valid response always starts with DCS 1 $ r. This is followed by '2' if\n+    // A valid response always starts with 1 $ r. This is followed by '2' if\n     // the extent is rectangular, or '1' if it's a stream. The '*x' indicates\n-    // this is a DECSACE response, and ST ends the sequence.\n-    _api.ReturnResponse(rectangularExtent ? L\"\\033P1$r2*x\\033\\\\\" : L\"\\033P1$r1*x\\033\\\\\");\n+    // this is a DECSACE response.\n+    _ReturnDcsResponse(rectangularExtent ? L\"1$r2*x\" : L\"1$r1*x\");\n }\n \n // Method Description:\n@@ -4324,12 +4324,11 @@ void AdaptDispatch::_ReportDECACSetting(const VTInt itemNumber) const\n         bgIndex = _renderSettings.GetColorAliasIndex(ColorAlias::FrameBackground);\n         break;\n     default:\n-        _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+        _ReturnDcsResponse(L\"0$r\");\n         return;\n     }\n-    // A valid response always starts with DCS 1 $ r, the ',|' indicates this\n-    // is a DECAC response, and ST ends the sequence.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{};{},|\\033\\\\\"), itemNumber, fgIndex, bgIndex));\n+    // A valid response always starts with 1 $ r and the ',|' indicates this is a DECAC response.\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{};{},|\"), itemNumber, fgIndex, bgIndex));\n }\n \n // Routine Description:\n@@ -4442,9 +4441,9 @@ void AdaptDispatch::_ReportCursorInformation()\n     const auto charset2 = _termOutput.GetCharsetId(2);\n     const auto charset3 = _termOutput.GetCharsetId(3);\n \n-    // A valid response always starts with DCS 1 $ u and ends with ST.\n+    // A valid response always starts with 1 $ u.\n     const auto response = fmt::format(\n-        FMT_COMPILE(L\"\\033P1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\\033\\\\\"),\n+        FMT_COMPILE(L\"1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\"),\n         cursorPosition.y,\n         cursorPosition.x,\n         page.Number(),\n@@ -4458,7 +4457,7 @@ void AdaptDispatch::_ReportCursorInformation()\n         charset1,\n         charset2,\n         charset3);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4623,9 +4622,9 @@ void AdaptDispatch::_ReportTabStops()\n \n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ u.\n+    // A valid response always starts with 2 $ u.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P2$u\"sv);\n+    response.append(L\"2$u\"sv);\n \n     auto need_separator = false;\n     for (auto column = 0; column < width; column++)\n@@ -4638,9 +4637,7 @@ void AdaptDispatch::_ReportTabStops()\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4685,6 +4682,26 @@ ITermDispatch::StringHandler AdaptDispatch::_RestoreTabStops()\n     };\n }\n \n+void AdaptDispatch::_ReturnCsiResponse(const std::wstring_view response) const\n+{\n+    const auto csi = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9B\" : L\"\\x1B[\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}\"), csi, response));\n+}\n+\n+void AdaptDispatch::_ReturnDcsResponse(const std::wstring_view response) const\n+{\n+    const auto dcs = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x90\" : L\"\\x1BP\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), dcs, response, st));\n+}\n+\n+void AdaptDispatch::_ReturnOscResponse(const std::wstring_view response) const\n+{\n+    const auto osc = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9D\" : L\"\\x1B]\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), osc, response, st));\n+}\n+\n // Routine Description:\n // - DECPS - Plays a sequence of musical notes.\n // Arguments:\ndiff --git a/src/terminal/adapter/adaptDispatch.hpp b/src/terminal/adapter/adaptDispatch.hpp\nindex 4fc85ebc92a..161e21d358d 100644\n--- a/src/terminal/adapter/adaptDispatch.hpp\n+++ b/src/terminal/adapter/adaptDispatch.hpp\n@@ -121,6 +121,7 @@ namespace Microsoft::Console::VirtualTerminal\n         void LockingShiftRight(const VTInt gsetNumber) override; // LS1R, LS2R, LS3R\n         void SingleShift(const VTInt gsetNumber) noexcept override; // SS2, SS3\n         void AcceptC1Controls(const bool enabled) override; // DECAC1\n+        void SendC1Controls(const bool enabled) override; // S8C1T, S7C1T\n         void AnnounceCodeStructure(const VTInt ansiLevel) override; // ACS\n         void SoftReset() override; // DECSTR\n         void HardReset() override; // RIS\n@@ -289,6 +290,10 @@ namespace Microsoft::Console::VirtualTerminal\n         void _ReportTabStops();\n         StringHandler _RestoreTabStops();\n \n+        void _ReturnCsiResponse(const std::wstring_view response) const;\n+        void _ReturnDcsResponse(const std::wstring_view response) const;\n+        void _ReturnOscResponse(const std::wstring_view response) const;\n+\n         std::vector<uint8_t> _tabStopColumns;\n         bool _initDefaultTabStops = true;\n \n@@ -302,7 +307,6 @@ namespace Microsoft::Console::VirtualTerminal\n         std::shared_ptr<SixelParser> _sixelParser;\n         std::unique_ptr<FontBuffer> _fontBuffer;\n         std::shared_ptr<MacroBuffer> _macroBuffer;\n-        std::optional<unsigned int> _initialCodePage;\n \n         // We have two instances of the saved cursor state, because we need\n         // one for the main buffer (at index 0), and another for the alt buffer\ndiff --git a/src/terminal/adapter/termDispatch.hpp b/src/terminal/adapter/termDispatch.hpp\nindex bb12dc32880..bd91d38d7e9 100644\n--- a/src/terminal/adapter/termDispatch.hpp\n+++ b/src/terminal/adapter/termDispatch.hpp\n@@ -115,6 +115,7 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     void LockingShiftRight(const VTInt /*gsetNumber*/) override {} // LS1R, LS2R, LS3R\r\n     void SingleShift(const VTInt /*gsetNumber*/) override {} // SS2, SS3\r\n     void AcceptC1Controls(const bool /*enabled*/) override {} // DECAC1\r\n+    void SendC1Controls(const bool /*enabled*/) override {} // S8C1T, S7C1T\r\n     void AnnounceCodeStructure(const VTInt /*ansiLevel*/) override {} // ACS\r\n \r\n     void SoftReset() override {} // DECSTR\r\ndiff --git a/src/terminal/adapter/ut_adapter/adapterTest.cpp b/src/terminal/adapter/ut_adapter/adapterTest.cpp\nindex ab2e08d3b85..5fab90f3d39 100644\n--- a/src/terminal/adapter/ut_adapter/adapterTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/adapterTest.cpp\n@@ -158,17 +158,28 @@ class TestGetSet final : public ITerminalApi\n         return true;\r\n     }\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override\r\n+    void SetCodePage(const unsigned int codepage) override\r\n     {\r\n-        Log::Comment(L\"SetConsoleOutputCP MOCK called...\");\r\n-        THROW_HR_IF(E_FAIL, !_setConsoleOutputCPResult);\r\n-        VERIFY_ARE_EQUAL(_expectedOutputCP, codepage);\r\n+        Log::Comment(L\"SetCodePage MOCK called...\");\r\n+        THROW_HR_IF(E_FAIL, !_setCodePageResult);\r\n+        VERIFY_ARE_EQUAL(_expectedCodePage, codepage);\r\n     }\r\n \r\n-    unsigned int GetConsoleOutputCP() const override\r\n+    void ResetCodePage() override\r\n     {\r\n-        Log::Comment(L\"GetConsoleOutputCP MOCK called...\");\r\n-        return _expectedOutputCP;\r\n+        Log::Comment(L\"ResetCodePage MOCK called...\");\r\n+    }\r\n+\r\n+    unsigned int GetOutputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetOutputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n+    }\r\n+\r\n+    unsigned int GetInputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetInputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n     }\r\n \r\n     void CopyToClipboard(const wil::zwstring_view /*content*/)\r\n@@ -367,7 +378,7 @@ class TestGetSet final : public ITerminalApi\n     til::point _expectedCursorPos;\r\n \r\n     TextAttribute _expectedAttribute = {};\r\n-    unsigned int _expectedOutputCP = 0;\r\n+    unsigned int _expectedCodePage = 0;\r\n     bool _isPty = false;\r\n \r\n     bool _returnResponseResult = false;\r\n@@ -376,8 +387,7 @@ class TestGetSet final : public ITerminalApi\n \r\n     bool _setWindowTitleResult = false;\r\n     std::wstring_view _expectedWindowTitle{};\r\n-    bool _setConsoleOutputCPResult = false;\r\n-    bool _getConsoleOutputCPResult = false;\r\n+    bool _setCodePageResult = false;\r\n     bool _expectedShowWindow = false;\r\n \r\n     std::wstring _expectedMenuJson{};\r\n@@ -3529,15 +3539,15 @@ class AdapterTest\n \r\n         Log::Comment(L\"3. Designate ISO-2022 coding system\");\r\n         // Code page should be set to ISO-8859-1 and C1 parsing enabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = 28591;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = 28591;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::ISO2022);\r\n         VERIFY_IS_TRUE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n \r\n         Log::Comment(L\"4. Designate UTF-8 coding system\");\r\n         // Code page should be set to UTF-8 and C1 parsing disabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = CP_UTF8;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::UTF8);\r\n         VERIFY_IS_FALSE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n     }\r\n@@ -3962,6 +3972,39 @@ class AdapterTest\n         _pDispatch->PagePositionAbsolute(1);\r\n     }\r\n \r\n+    TEST_METHOD(SendC1ControlTest)\r\n+    {\r\n+        const auto S7C1T = L\"\\033 F\";\r\n+        const auto S8C1T = L\"\\033 G\";\r\n+\r\n+        _testGetSet->PrepData();\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n+\r\n+        Log::Comment(L\"Generating reports with C1 control sequences\");\r\n+        _stateMachine->ProcessString(S8C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9b>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x90!|00000000\\x9c\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9d\\x34;0;rgb:0c0c/0c0c/0c0c\\x9c\");\r\n+\r\n+        Log::Comment(L\"Generating reports with 7-bit escape sequence\");\r\n+        _stateMachine->ProcessString(S7C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b[>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1bP!|00000000\\x1b\\\\\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b]4;0;rgb:0c0c/0c0c/0c0c\\x1b\\\\\");\r\n+    }\r\n+\r\n private:\r\n     TerminalInput _terminalInput;\r\n     std::unique_ptr<TestGetSet> _testGetSet;\r\ndiff --git a/src/terminal/adapter/ut_adapter/inputTest.cpp b/src/terminal/adapter/ut_adapter/inputTest.cpp\nindex d3c4c3d0d06..ab893be7724 100644\n--- a/src/terminal/adapter/ut_adapter/inputTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/inputTest.cpp\n@@ -36,6 +36,7 @@ class Microsoft::Console::VirtualTerminal::InputTest\n     TEST_METHOD(CtrlNumTest);\r\n     TEST_METHOD(BackarrowKeyModeTest);\r\n     TEST_METHOD(AutoRepeatModeTest);\r\n+    TEST_METHOD(SendC1ControlTest);\r\n \r\n     wchar_t GetModifierChar(const bool fShift, const bool fAlt, const bool fCtrl)\r\n     {\r\n@@ -790,3 +791,20 @@ void InputTest::AutoRepeatModeTest()\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput(L\"A\"), input.HandleKey(down));\r\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput({}), input.HandleKey(up));\r\n }\r\n+\r\n+void InputTest::SendC1ControlTest()\r\n+{\r\n+    TerminalInput input;\r\n+\r\n+    Log::Comment(L\"Sending keys with C1 control sequences\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, true);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x9bH\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x8fP\"), input, 0, VK_F1);\r\n+\r\n+    Log::Comment(L\"Sending keys with 7-bit escape sequence\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, false);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1b[H\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1bOP\"), input, 0, VK_F1);\r\n+}\r\ndiff --git a/src/terminal/input/terminalInput.cpp b/src/terminal/input/terminalInput.cpp\nindex 7c09ef46155..ac0795bdc41 100644\n--- a/src/terminal/input/terminalInput.cpp\n+++ b/src/terminal/input/terminalInput.cpp\n@@ -53,7 +53,7 @@ void TerminalInput::SetInputMode(const Mode mode, const bool enabled) noexcept\n \r\n     // If we've changed one of the modes that alter the VT input sequences,\r\n     // we'll need to regenerate our keyboard map.\r\n-    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey };\r\n+    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey, Mode::SendC1 };\r\n     if (keyMapModes.test(mode))\r\n     {\r\n         _initKeyboardMap();\r\n@@ -353,6 +353,19 @@ try\n \r\n     _keyMap.clear();\r\n \r\n+    // The CSI and SS3 introducers are C1 control codes, which can either be\r\n+    // sent as a single codepoint, or as a two character escape sequence.\r\n+    if (_inputMode.test(Mode::SendC1))\r\n+    {\r\n+        _csi = L\"\\x9B\";\r\n+        _ss3 = L\"\\x8F\";\r\n+    }\r\n+    else\r\n+    {\r\n+        _csi = L\"\\x1B[\";\r\n+        _ss3 = L\"\\x1BO\";\r\n+    }\r\n+\r\n     // PAUSE doesn't have a VT mapping, but traditionally we've mapped it to ^Z,\r\n     // regardless of modifiers.\r\n     defineKeyWithUnusedModifiers(VK_PAUSE, L\"\\x1A\"s);\r\ndiff --git a/src/terminal/input/terminalInput.hpp b/src/terminal/input/terminalInput.hpp\nindex e8ae53267e2..40488269569 100644\n--- a/src/terminal/input/terminalInput.hpp\n+++ b/src/terminal/input/terminalInput.hpp\n@@ -33,6 +33,7 @@ namespace Microsoft::Console::VirtualTerminal\n             CursorKey,\r\n             BackarrowKey,\r\n             Win32,\r\n+            SendC1,\r\n \r\n             Utf8MouseEncoding,\r\n             SgrMouseEncoding,\r\n@@ -80,10 +81,8 @@ namespace Microsoft::Console::VirtualTerminal\n         til::enumset<Mode> _inputMode{ Mode::Ansi, Mode::AutoRepeat, Mode::AlternateScroll };\r\n         bool _forceDisableWin32InputMode{ false };\r\n \r\n-        // In the future, if we add support for \"8-bit\" input mode, these prefixes\r\n-        // will sometimes be replaced with equivalent C1 control characters.\r\n-        static constexpr auto _csi = L\"\\x1B[\";\r\n-        static constexpr auto _ss3 = L\"\\x1BO\";\r\n+        const wchar_t* _csi = L\"\\x1B[\";\r\n+        const wchar_t* _ss3 = L\"\\x1BO\";\r\n \r\n         void _initKeyboardMap() noexcept;\r\n         DWORD _trackControlKeyState(const KEY_EVENT_RECORD& key);\r\n@@ -108,9 +107,9 @@ namespace Microsoft::Console::VirtualTerminal\n #pragma endregion\r\n \r\n #pragma region MouseInput\r\n-        [[nodiscard]] static OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n \r\n         [[nodiscard]] OutputType _makeAlternateScrollOutput(short delta) const;\r\n \r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.cpp b/src/terminal/parser/OutputStateMachineEngine.cpp\nindex 5339c29bdf9..edb53e100d0 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.cpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.cpp\n@@ -256,6 +256,12 @@ bool OutputStateMachineEngine::ActionEscDispatch(const VTID id)\n     case EscActionCodes::DECAC1_AcceptC1Controls:\r\n         _dispatch->AcceptC1Controls(true);\r\n         break;\r\n+    case EscActionCodes::S7C1T_Send7bitC1Controls:\r\n+        _dispatch->SendC1Controls(false);\r\n+        break;\r\n+    case EscActionCodes::S8C1T_Send8bitC1Controls:\r\n+        _dispatch->SendC1Controls(true);\r\n+        break;\r\n     case EscActionCodes::ACS_AnsiLevel1:\r\n         _dispatch->AnnounceCodeStructure(1);\r\n         break;\r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.hpp b/src/terminal/parser/OutputStateMachineEngine.hpp\nindex ad594c269cd..ab41e066cfa 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.hpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.hpp\n@@ -77,6 +77,8 @@ namespace Microsoft::Console::VirtualTerminal\n             LS2R_LockingShift = VTID(\"}\"),\r\n             LS3R_LockingShift = VTID(\"|\"),\r\n             DECAC1_AcceptC1Controls = VTID(\" 7\"),\r\n+            S7C1T_Send7bitC1Controls = VTID(\" F\"),\r\n+            S8C1T_Send8bitC1Controls = VTID(\" G\"),\r\n             ACS_AnsiLevel1 = VTID(\" L\"),\r\n             ACS_AnsiLevel2 = VTID(\" M\"),\r\n             ACS_AnsiLevel3 = VTID(\" N\"),\r\ndiff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 65e7460e9b8..12954512bdb 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -25,6 +25,9 @@ StateMachine::StateMachine(std::unique_ptr<IStateMachineEngine> engine, const bo\n     _oscString{},\r\n     _cachedSequence{ std::nullopt }\r\n {\r\n+    // The state machine must always accept C1 controls for the input engine,\r\n+    // otherwise it won't work when the ConPTY terminal has S8C1T enabled.\r\n+    _parserMode.set(Mode::AcceptC1, _isEngineForInput);\r\n     _ActionClear();\r\n }\r\n \r\n", "test_patch": "", "problem_statement": "Add support for the S8C1T/S7C1T escape sequences\n# Description of the new feature/enhancement\r\n\r\nThe `S8C1T` and `S7C1T` commands enable an application to choose whether the terminal should use C1 controls when sending key sequences and query responses. For example, instead of encoding a `CSI` prefix as `ESC` `[`, the terminal would use a single `CSI` codepoint (i.e. `U+009B`).\r\n\r\nBack in the days of the 8-bit hardware terminals, this had the advantage of being slightly more efficient (your sequence introducers would take 1 byte rather than 2). And another bonus was that it made it easy to distinguish an <kbd>Esc</kbd> key (assuming your keyboard had one) from other key sequences that merely started with the `ESC` character.\r\n\r\nHowever, these days you're more likely to be using a UTF-8 encoding, in which case a C1 control character is still going to occupy two bytes, so there is no advantage in terms of sequence length. And the ability to distinguish an <kbd>Esc</kbd> key from other key sequences is somewhat diminished by the modern usage of `ESC` as a prefix for <kbd>Alt</kbd> key combinations.\r\n\r\nIn short, there's probably not much demand for this functionality outside of people wanting to connect to legacy systems, but it would be nice to have just for completeness sake (it's a requirement for VT level 2 conformance).\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nSome of the framework for the key sequence encoding was already added in PR #16511, so that just needs to be hooked up to a new input mode which can be toggled by the `S8C1T` and `S7C1T` escape sequences. We need to do something similar in `AdaptDispatch` for all the query responses, but that's also fairly straightforward.\r\n\r\nHowever, if we want to support 8-bit C1 sequences, as used in legacy systems, we also need a way to switch the input code page from UTF-8 to something that can cleanly pass through 8-bit bytes (like ISO-8859-1). Fortunately we already have a `DOCS` escape sequence which sets the *output* code page to ISO-8859-1, and I think it's reasonable to extend that to set the input code page at the same time.\r\n\r\nThe catch is that this won't work in a WSL shell, because WSL doesn't pay any attention to the input code page. And while it is potentially usable from a Windows shell, the typical use case will involve connecting to a remote system, which means you're going to ned a ssh or telnet client that is 8-bit capable (and I think that rules out the Windows inbox clients).\r\n\r\nThe bottom line is there are a few hoops you need to jump through to get this to work. Given these limitations, is it still worth adding?\n", "hints_text": "", "created_at": "2024-09-21 14:25:46", "merge_commit_sha": "aa256ad5c9656c8aac75b1cf40c0ecae869dd4c0", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17912", "base_commit": "6196a3d0f754f7ec32ecccb46b97701c6ac6955b", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\nindex 0e12e7d3de7..72b254e4e41 100644\n--- a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n@@ -44,6 +44,9 @@\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n \r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorDark2\" />\r\n+\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"HighContrast\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -73,6 +76,9 @@\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight1\" />\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"Dark\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -106,6 +112,9 @@\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight2\" />\r\n         </ResourceDictionary>\r\n     </ResourceDictionary.ThemeDictionaries>\r\n \r\n@@ -136,7 +145,7 @@\n \r\n     <Style x:Key=\"SettingContainerFontIconStyle\"\r\n            TargetType=\"FontIcon\">\r\n-        <Setter Property=\"Foreground\" Value=\"{StaticResource SystemAccentColor}\" />\r\n+        <Setter Property=\"Foreground\" Value=\"{ThemeResource SettingContainerResetButtonIconForeground}\" />\r\n         <Setter Property=\"FontSize\" Value=\"11\" />\r\n         <Setter Property=\"FontFamily\" Value=\"{ThemeResource SymbolThemeFontFamily}\" />\r\n     </Style>\r\n", "test_patch": "", "problem_statement": "[Windows Terminal - Settings]: In dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Prerequisites:**\r\nSettings> Personalization> Colors> Choose your Mode> Dark Mode.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Apply dark mode by following the prerequisites.\r\n3. Now open 'Setting' and activate 'Startup' tab.\r\n4. Navigate to the 'Defaults' tab and activate it.\r\n5. Now navigate to the 'Appearance' button and activate it.\r\n6. Now navigate to any control like 'Line height' and change value.\r\n7. 'Reset to inherited value' button will appear.\r\n8. Open Accessibility Insights for windows and check contrast ratio of 'Reset to inherited value' icon. \r\n9. Observe the issue.\r\n\r\n**User experience:**\r\nLow vision users will find difficulty in tracking the control, if contrast ratio for the control's icon is less than '3:1' (Required).\r\n\r\n**WCAG Reference Link:**\r\n[[MAS 4.3.1 \u2013 No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)](https://www.w3.org/WAI/WCAG22/Understanding/non-text-contrast)\r\n\r\n**Attachment:**\r\n[MAS1.4.11 - In Dark mode, cca failed for 'Reset to inherited value' button..zip](https://github.com/user-attachments/files/16959865/MAS1.4.11.-.In.Dark.mode.cca.failed.for.Reset.to.inherited.value.button.zip)\n\n### Expected Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon should be greater than or equal to 3:1. \n\n### Actual Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\r\n\r\n**Note:**\r\nSame issue repro for all 'Reset to inherited value' button's icon throughout.\n", "hints_text": "@SaurabhNew is there an associated severity rating for this issue?", "created_at": "2024-09-11 23:12:16", "merge_commit_sha": "0bd19e9cfc31383f17e453e18df6649bdd6cf64a", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17886", "base_commit": "544452dad41d05b865f1fa1d665397befaa9ec2b", "patch": "diff --git a/src/cascadia/TerminalApp/Pane.cpp b/src/cascadia/TerminalApp/Pane.cpp\nindex a210b701528..dc235b06024 100644\n--- a/src/cascadia/TerminalApp/Pane.cpp\n+++ b/src/cascadia/TerminalApp/Pane.cpp\n@@ -2956,13 +2956,13 @@ bool Pane::ContainsReadOnly() const\n // - <none>\r\n void Pane::CollectTaskbarStates(std::vector<winrt::TerminalApp::TaskbarState>& states)\r\n {\r\n-    if (_IsLeaf())\r\n+    if (_content)\r\n     {\r\n         auto tbState{ winrt::make<winrt::TerminalApp::implementation::TaskbarState>(_content.TaskbarState(),\r\n                                                                                     _content.TaskbarProgress()) };\r\n         states.push_back(tbState);\r\n     }\r\n-    else\r\n+    else if (_firstChild && _secondChild)\r\n     {\r\n         _firstChild->CollectTaskbarStates(states);\r\n         _secondChild->CollectTaskbarStates(states);\r\n", "test_patch": "", "problem_statement": "Crash when choosing 'Close all other panes'\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n10.0.27699.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1.\tOpen Windows Terminal.\r\n2.\tSplit panes so there are at least two panes.\r\n3.\tCtrl+Shift+P and choose \u2018Close all other panes\u2019\r\n\n\n### Expected Behavior\n\nNo crash.\n\n### Actual Behavior\n\nTerminal crashes with an access violation:\r\n\r\n```\r\n(3c78.4aa0): Access violation - code c0000005 (first/second chance not available)\r\nFor analysis of this file, run !analyze -v\r\nTerminalApp!winrt::impl::consume_TerminalApp_IPaneContent<winrt::TerminalApp::IPaneContent>::TaskbarProgress+0x34 [inlined in TerminalApp!Pane::CollectTaskbarStates+0x82]:\r\n00007ffb`45483032 488b01          mov     rax,qword ptr [rcx] ds:00000000`00000000=????????????????\r\n```\r\n\r\nHere is the call stack:\r\n\r\n```\r\nTerminalApp!winrt::impl::consume_TerminalApp_IPaneContent<winrt::TerminalApp::IPaneContent>::TaskbarProgress\r\nTerminalApp!Pane::CollectTaskbarStates\r\nTerminalApp!Pane::CollectTaskbarStates\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalTab::GetCombinedTaskbarState\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalPage::TaskbarState\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalWindow::TaskbarState\r\nTerminalApp!winrt::impl::produce<winrt::TerminalApp::implementation::TerminalWindow,winrt::TerminalApp::ITerminalWindow>::get_TaskbarState\r\nWindowsTerminal\r\nWindowsTerminal\r\nTerminalApp!winrt::Windows::Foundation::TypedEventHandler<winrt::Windows::Foundation::IInspectable,winrt::Windows::Foundation::IInspectable>::operator()\r\nTerminalApp!wil::details::dispatcher_handler::operator()\r\nTerminalApp!winrt::impl::delegate<winrt::Windows::UI::Core::DispatchedHandler,wil::details::dispatcher_handler>::Invoke\r\nWindows_UI!Microsoft::WRL::Details::DelegateArgTraits<long (__cdecl Windows::System::IDispatcherQueueHandler::*)(void)>::DelegateInvokeHelper<Microsoft::WRL::Implements<Microsoft::WRL::RuntimeClassFlags<2>,Windows::System::IDispatcherQueueHandler,Microsoft::WRL::FtmBase>,<lambda_980f345bc6e4ac8a906323c24a5fe9b1>,-1>::Invoke\r\nCoreMessaging!Windows::System::DispatcherQueue::DeferInvokeCallback\r\nCoreMessaging!CFlat::SehSafe::Execute<<lambda_654db17c35df07198786f0867aa10de6> >\r\nCoreMessaging!Microsoft::CoreUI::ActionCallback::ImportAdapter$\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::DeferredCall::Callback_Dispatch\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::DeferredCallDispatcher::Callback_OnDispatch\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::Dispatcher::Callback_DispatchLoop\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::EventLoop::Callback_RunCoreLoop\r\nuser32!_fnDWORD\r\nntdll!KiUserCallbackDispatcherContinue\r\nwin32u!NtUserGetMessage\r\nuser32!GetMessageW\r\nWindowsTerminal\r\nWindowsTerminal\r\nWindowsTerminal\r\nucrtbase!thread_start<unsigned int (__cdecl*)(void *),1>\r\nKERNEL32!BaseThreadInitThunk\r\nntdll!RtlUserThreadStart\r\n```\n", "hints_text": "I suspect this is the same underlying bug as #17869. If I try and reproduce that one in the debugger I get a very similar stack trace to this crash.\nThis must've regressed in #17750. Since we never wrote down what made it originally crash, I guessed it happened by simply closing panes, but this shows it was via the \"Close all other panes\" action. Not 100% sure how to best fix it. There were two simple options and neither worked. The correct approach would be to not tie the model (binary tree of panes) to the animations but fixing that is not an option for a hotfix.", "created_at": "2024-09-09 17:04:28", "merge_commit_sha": "bc6f3e22757415e42e658597c60b40c003941289", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17885", "base_commit": "544452dad41d05b865f1fa1d665397befaa9ec2b", "patch": "diff --git a/src/buffer/out/search.cpp b/src/buffer/out/search.cpp\nindex 31c7081b2b9..75143f047ca 100644\n--- a/src/buffer/out/search.cpp\n+++ b/src/buffer/out/search.cpp\n@@ -16,7 +16,7 @@ bool Search::IsStale(const Microsoft::Console::Render::IRenderData& renderData,\n            _lastMutationId != renderData.GetTextBuffer().GetLastMutationId();\r\n }\r\n \r\n-bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n+void Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n {\r\n     const auto& textBuffer = renderData.GetTextBuffer();\r\n \r\n@@ -30,15 +30,15 @@ bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const st\n     _results = std::move(result).value_or(std::vector<til::point_span>{});\r\n     _index = reverse ? gsl::narrow_cast<ptrdiff_t>(_results.size()) - 1 : 0;\r\n     _step = reverse ? -1 : 1;\r\n-    return true;\r\n-}\r\n \r\n-void Search::MoveToCurrentSelection()\r\n-{\r\n     if (_renderData->IsSelectionActive())\r\n     {\r\n         MoveToPoint(_renderData->GetTextBuffer().ScreenToBufferPosition(_renderData->GetSelectionAnchor()));\r\n     }\r\n+    else if (const auto span = _renderData->GetSearchHighlightFocused())\r\n+    {\r\n+        MoveToPoint(_step > 0 ? span->start : span->end);\r\n+    }\r\n }\r\n \r\n void Search::MoveToPoint(const til::point anchor) noexcept\r\ndiff --git a/src/buffer/out/search.h b/src/buffer/out/search.h\nindex 763b5d40c73..304de1ab889 100644\n--- a/src/buffer/out/search.h\n+++ b/src/buffer/out/search.h\n@@ -36,9 +36,8 @@ class Search final\n     Search() = default;\r\n \r\n     bool IsStale(const Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags) const noexcept;\r\n-    bool Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n+    void Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n \r\n-    void MoveToCurrentSelection();\r\n     void MoveToPoint(til::point anchor) noexcept;\r\n     void MovePastPoint(til::point anchor) noexcept;\r\n     void FindNext(bool reverse) noexcept;\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex cd4f5f58b81..5d379ba6c5e 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1697,38 +1697,41 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     SearchResults ControlCore::Search(SearchRequest request)\r\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n+\r\n         SearchFlag flags{};\r\n         WI_SetFlagIf(flags, SearchFlag::CaseInsensitive, !request.CaseSensitive);\r\n         WI_SetFlagIf(flags, SearchFlag::RegularExpression, request.RegularExpression);\r\n         const auto searchInvalidated = _searcher.IsStale(*_terminal.get(), request.Text, flags);\r\n \r\n-        if (searchInvalidated || !request.Reset)\r\n+        if (searchInvalidated || !request.ResetOnly)\r\n         {\r\n             std::vector<til::point_span> oldResults;\r\n+            til::point_span oldFocused;\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused())\r\n+            {\r\n+                oldFocused = *focused;\r\n+            }\r\n \r\n             if (searchInvalidated)\r\n             {\r\n                 oldResults = _searcher.ExtractResults();\r\n                 _searcher.Reset(*_terminal.get(), request.Text, flags, !request.GoForward);\r\n-\r\n-                if (SnapSearchResultToSelection())\r\n-                {\r\n-                    _searcher.MoveToCurrentSelection();\r\n-                    SnapSearchResultToSelection(false);\r\n-                }\r\n-\r\n                 _terminal->SetSearchHighlights(_searcher.Results());\r\n             }\r\n-            else\r\n+\r\n+            if (!request.ResetOnly)\r\n             {\r\n                 _searcher.FindNext(!request.GoForward);\r\n             }\r\n \r\n-            if (const auto idx = _searcher.CurrentMatch(); idx >= 0)\r\n+            _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(std::max<ptrdiff_t>(0, _searcher.CurrentMatch())));\r\n+            _renderer->TriggerSearchHighlight(oldResults);\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused(); focused && *focused != oldFocused)\r\n             {\r\n-                _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(idx), request.ScrollOffset);\r\n+                _terminal->ScrollToSearchHighlight(request.ScrollOffset);\r\n             }\r\n-            _renderer->TriggerSearchHighlight(oldResults);\r\n         }\r\n \r\n         int32_t totalMatches = 0;\r\n@@ -1756,27 +1759,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n         _terminal->SetSearchHighlights({});\r\n-        _terminal->SetSearchHighlightFocused({}, 0);\r\n+        _terminal->SetSearchHighlightFocused(0);\r\n         _renderer->TriggerSearchHighlight(_searcher.Results());\r\n         _searcher = {};\r\n     }\r\n \r\n-    // Method Description:\r\n-    // - Tells ControlCore to snap the current search result index to currently\r\n-    //   selected text if the search was started using it.\r\n-    void ControlCore::SnapSearchResultToSelection(bool shouldSnap) noexcept\r\n-    {\r\n-        _snapSearchResultToSelection = shouldSnap;\r\n-    }\r\n-\r\n-    // Method Description:\r\n-    // - Returns true, if we should snap the current search result index to\r\n-    //   the currently selected text after a new search is started, else false.\r\n-    bool ControlCore::SnapSearchResultToSelection() const noexcept\r\n-    {\r\n-        return _snapSearchResultToSelection;\r\n-    }\r\n-\r\n     void ControlCore::Close()\r\n     {\r\n         if (!_IsClosing())\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 9ac8e5450c3..2e9f2490d9d 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -228,8 +228,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         SearchResults Search(SearchRequest request);\r\n         const std::vector<til::point_span>& SearchResultRows() const noexcept;\r\n         void ClearSearch();\r\n-        void SnapSearchResultToSelection(bool snap) noexcept;\r\n-        bool SnapSearchResultToSelection() const noexcept;\r\n \r\n         void LeftClickOnTerminal(const til::point terminalPosition,\r\n                                  const int numberOfClicks,\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.idl b/src/cascadia/TerminalControl/ControlCore.idl\nindex 3be52269a89..ee1a4787e22 100644\n--- a/src/cascadia/TerminalControl/ControlCore.idl\n+++ b/src/cascadia/TerminalControl/ControlCore.idl\n@@ -55,7 +55,7 @@ namespace Microsoft.Terminal.Control\n         Boolean GoForward;\r\n         Boolean CaseSensitive;\r\n         Boolean RegularExpression;\r\n-        Boolean Reset;\r\n+        Boolean ResetOnly;\r\n         Int32 ScrollOffset;\r\n     };\r\n \r\n@@ -148,7 +148,6 @@ namespace Microsoft.Terminal.Control\n \r\n         SearchResults Search(SearchRequest request);\r\n         void ClearSearch();\r\n-        Boolean SnapSearchResultToSelection;\r\n \r\n         Microsoft.Terminal.Core.Color ForegroundColor { get; };\r\n         Microsoft.Terminal.Core.Color BackgroundColor { get; };\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 565ea02ccf6..5f981f89e65 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -576,7 +576,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // but since code paths differ, extra work is required to ensure correctness.\r\n                     if (!_core.HasMultiLineSelection())\r\n                     {\r\n-                        _core.SnapSearchResultToSelection(true);\r\n                         const auto selectedLine{ _core.SelectedText(true) };\r\n                         _searchBox->PopulateTextbox(selectedLine);\r\n                     }\r\n@@ -3844,7 +3843,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         const auto goForward = _searchBox->GoForward();\r\n         const auto caseSensitive = _searchBox->CaseSensitive();\r\n         const auto regularExpression = _searchBox->RegularExpression();\r\n-        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _calculateSearchScrollOffset() };\r\n+        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _searchScrollOffset };\r\n         _handleSearchResults(_core.Search(request));\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c5876e1497c..df24a3e8917 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1259,15 +1259,17 @@ void Terminal::SetSearchHighlights(const std::vector<til::point_span>& highlight\n // Method Description:\r\n // - Stores the focused search highlighted region in the terminal\r\n // - If the region isn't empty, it will be brought into view\r\n-void Terminal::SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset)\r\n+void Terminal::SetSearchHighlightFocused(const size_t focusedIdx) noexcept\r\n {\r\n     _assertLocked();\r\n     _searchHighlightFocused = focusedIdx;\r\n+}\r\n \r\n-    // bring the focused region into the view if the index is in valid range\r\n-    if (focusedIdx < _searchHighlights.size())\r\n+void Terminal::ScrollToSearchHighlight(til::CoordType searchScrollOffset)\r\n+{\r\n+    if (_searchHighlightFocused < _searchHighlights.size())\r\n     {\r\n-        const auto focused = til::at(_searchHighlights, focusedIdx);\r\n+        const auto focused = til::at(_searchHighlights, _searchHighlightFocused);\r\n         const auto adjustedStart = til::point{ focused.start.x, std::max(0, focused.start.y - searchScrollOffset) };\r\n         const auto adjustedEnd = til::point{ focused.end.x, std::max(0, focused.end.y - searchScrollOffset) };\r\n         _ScrollToPoints(adjustedStart, adjustedEnd);\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..d62a76b3bc8 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -234,7 +234,8 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetClearQuickFixCallback(std::function<void()> pfn) noexcept;\r\n     void SetWindowSizeChangedCallback(std::function<void(int32_t, int32_t)> pfn) noexcept;\r\n     void SetSearchHighlights(const std::vector<til::point_span>& highlights) noexcept;\r\n-    void SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset);\r\n+    void SetSearchHighlightFocused(size_t focusedIdx) noexcept;\r\n+    void ScrollToSearchHighlight(til::CoordType searchScrollOffset);\r\n \r\n     void BlinkCursor() noexcept;\r\n     void SetCursorOn(const bool isOn) noexcept;\r\ndiff --git a/src/interactivity/win32/find.cpp b/src/interactivity/win32/find.cpp\nindex 033918e3ae5..07996c47767 100644\n--- a/src/interactivity/win32/find.cpp\n+++ b/src/interactivity/win32/find.cpp\n@@ -57,7 +57,6 @@ INT_PTR CALLBACK FindDialogProc(HWND hWnd, UINT Message, WPARAM wParam, LPARAM l\n             if (searcher.IsStale(gci.renderData, lastFindString, flags))\r\n             {\r\n                 searcher.Reset(gci.renderData, lastFindString, flags, reverse);\r\n-                searcher.MoveToCurrentSelection();\r\n             }\r\n             else\r\n             {\r\n", "test_patch": "", "problem_statement": "Search results steal focus and scroll when the buffer changes at all\n### Windows Terminal version\n\n1.21.1272.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n- Fill the buffer with enough text to make it scrollable (for example, using `Get-Random -Count 1000` in PowerShell),\r\n- search something in such a way that the last result is outside the view,\r\n- select a search result which is not the last (optinal),\r\n- type something in the prompt.\n\n### Expected Behavior\n\nWhile typing in the prompt nothing happen, the select result stays the same, and the view focus the prompt.\n\n### Actual Behavior\n\nWhen typing, the search appear to retrigger, and the focus goes to the last result, moving the prompt outside view.\n", "hints_text": "Hey, I've been hitting this too!\n\nMarking it up for 1.22 and as P1 - we should fix it and backport to 1.21 before 1.21 goes stable.", "created_at": "2024-09-09 17:00:06", "merge_commit_sha": "d9131c68893fe114a6091d262c23a5a26199d023", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17852", "base_commit": "17a55da0f9889aafd84df024299982e7b94f5482", "patch": "diff --git a/src/host/settings.cpp b/src/host/settings.cpp\nindex e2dd84b78e7..0df97dbd354 100644\n--- a/src/host/settings.cpp\n+++ b/src/host/settings.cpp\n@@ -36,7 +36,7 @@ Settings::Settings() :\n     _bAutoPosition(true),\r\n     _uHistoryBufferSize(DEFAULT_NUMBER_OF_COMMANDS),\r\n     _uNumberOfHistoryBuffers(DEFAULT_NUMBER_OF_BUFFERS),\r\n-    _bHistoryNoDup(false),\r\n+    _bHistoryNoDup(true),\r\n     // ColorTable initialized below\r\n     _uCodePage(ServiceLocator::LocateGlobals().uiOEMCP),\r\n     _uScrollScale(1),\r\n@@ -110,7 +110,7 @@ void Settings::ApplyDesktopSpecificDefaults()\n     _bQuickEdit = TRUE;\r\n     _uHistoryBufferSize = 50;\r\n     _uNumberOfHistoryBuffers = 4;\r\n-    _bHistoryNoDup = FALSE;\r\n+    _bHistoryNoDup = true;\r\n \r\n     _renderSettings.ResetColorTable();\r\n \r\ndiff --git a/src/propsheet/registry.cpp b/src/propsheet/registry.cpp\nindex 64d392aa76d..3a7283e080e 100644\n--- a/src/propsheet/registry.cpp\n+++ b/src/propsheet/registry.cpp\n@@ -79,7 +79,7 @@ VOID InitRegistryValues(\n     pStateInfo->CursorSize = 25;\r\n     pStateInfo->HistoryBufferSize = 25;\r\n     pStateInfo->NumberOfHistoryBuffers = 4;\r\n-    pStateInfo->HistoryNoDup = 0;\r\n+    pStateInfo->HistoryNoDup = 1;\r\n \r\n     // clang-format off\r\n     if (pStateInfo->fIsV2Console)\r\n", "test_patch": "", "problem_statement": "Command History (F7) is added to when selected command from the list\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.4037\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a clean command prompt - nothing in the list in F7.\r\n2. Type in a command, e.g. \"dir\"\r\n3. Type in a second different command, e.g. \"dir D*\"\r\n4. Press F7 to see the command list - it will contain two commands. Select the first one from the list.\r\n5. Press F7 to see the command list again, it will now contain three commands. This is unexpected. \n\n### Expected Behavior\n\nSelecting the command from the command list was previously (in Windows 10 command prompt) the way you issued it to ensure it didn't get added to the history, thus allowing you to maintain a nice tidy command list.\n\n### Actual Behavior\n\nInstead it was added to the history.\n", "hints_text": "", "created_at": "2024-09-03 15:33:21", "merge_commit_sha": "5fdfd51209fc681e66657d6697ce031bc4319619", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17786", "base_commit": "6dd9c468ebc77e0025939b32fb927e85f3172b25", "patch": "diff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex d8d975f667c..357b43c1aa1 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -98,7 +98,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         Connection(connection);\r\n \r\n         _terminal->SetWriteInputCallback([this](std::wstring_view wstr) {\r\n-            _sendInputToConnection(wstr);\r\n+            _pendingResponses.append(wstr);\r\n         });\r\n \r\n         // GH#8969: pre-seed working directory to prevent potential races\r\n@@ -419,6 +419,17 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Return Value:\r\n     // - <none>\r\n     void ControlCore::_sendInputToConnection(std::wstring_view wstr)\r\n+    {\r\n+        _connection.WriteInput(winrt_wstring_to_array_view(wstr));\r\n+    }\r\n+\r\n+    // Method Description:\r\n+    // - Writes the given sequence as input to the active terminal connection,\r\n+    // Arguments:\r\n+    // - wstr: the string of characters to write to the terminal connection.\r\n+    // Return Value:\r\n+    // - <none>\r\n+    void ControlCore::SendInput(const std::wstring_view wstr)\r\n     {\r\n         if (wstr.empty())\r\n         {\r\n@@ -435,21 +446,10 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         else\r\n         {\r\n-            _connection.WriteInput(winrt_wstring_to_array_view(wstr));\r\n+            _sendInputToConnection(wstr);\r\n         }\r\n     }\r\n \r\n-    // Method Description:\r\n-    // - Writes the given sequence as input to the active terminal connection,\r\n-    // Arguments:\r\n-    // - wstr: the string of characters to write to the terminal connection.\r\n-    // Return Value:\r\n-    // - <none>\r\n-    void ControlCore::SendInput(const std::wstring_view wstr)\r\n-    {\r\n-        _sendInputToConnection(wstr);\r\n-    }\r\n-\r\n     bool ControlCore::SendCharEvent(const wchar_t ch,\r\n                                     const WORD scanCode,\r\n                                     const ::Microsoft::Terminal::Core::ControlKeyStates modifiers)\r\n@@ -485,7 +485,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -643,7 +643,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -662,7 +662,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -1412,7 +1412,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n \r\n         // It's important to not hold the terminal lock while calling this function as sending the data may take a long time.\r\n-        _sendInputToConnection(filtered);\r\n+        SendInput(filtered);\r\n \r\n         const auto lock = _terminal->LockForWriting();\r\n         _terminal->ClearSelection();\r\n@@ -2107,7 +2107,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // Sending input requires that we're unlocked, because\r\n                     // writing the input pipe may block indefinitely.\r\n                     const auto suspension = _terminal->SuspendLock();\r\n-                    _sendInputToConnection(buffer);\r\n+                    SendInput(buffer);\r\n                 }\r\n             }\r\n         }\r\n@@ -2164,6 +2164,12 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 _terminal->Write(hstr);\r\n             }\r\n \r\n+            if (!_pendingResponses.empty())\r\n+            {\r\n+                _sendInputToConnection(_pendingResponses);\r\n+                _pendingResponses.clear();\r\n+            }\r\n+\r\n             // Start the throttled update of where our hyperlinks are.\r\n             const auto shared = _shared.lock_shared();\r\n             if (shared->outputIdle)\r\n@@ -2480,9 +2486,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out && !out->empty())\r\n         {\r\n-            // _sendInputToConnection() asserts that we aren't in focus mode,\r\n-            // but window focus events are always fine to send.\r\n-            _connection.WriteInput(winrt_wstring_to_array_view(*out));\r\n+            _sendInputToConnection(*out);\r\n         }\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 938d048243b..57484c0b7b7 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -319,6 +319,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         winrt::com_ptr<ControlSettings> _settings{ nullptr };\r\n \r\n         std::shared_ptr<::Microsoft::Terminal::Core::Terminal> _terminal{ nullptr };\r\n+        std::wstring _pendingResponses;\r\n \r\n         // NOTE: _renderEngine must be ordered before _renderer.\r\n         //\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 26daf24e5d2..82e06b03d4a 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -24,7 +24,6 @@ void Terminal::ReturnResponse(const std::wstring_view response)\n {\r\n     if (_pfnWriteInput && !response.empty())\r\n     {\r\n-        const auto suspension = _readWriteLock.suspend();\r\n         _pfnWriteInput(response);\r\n     }\r\n }\r\n", "test_patch": "", "problem_statement": "Low reliability of VT replies\n### Windows Terminal version\r\n\r\nLatest source\r\n\r\n### Windows build number\r\n\r\n10.0.19045.4780\r\n\r\n### Other Software\r\n\r\nNo\r\n\r\n### Steps to reproduce\r\n\r\nI want to query some terminal state, in particular the latest and greatest palette (#17729).\r\nTo do so, I build a bunch of those `\"\\x1b]4;N;?\\x1b\\\\\"`, send them in one go and wait for the reply.\r\nSince I want to support not only the latest nightlies and do not want the older versions to deadlock on unknown queries, I prepend and append another query, the one that even prehistoric versions understand: `\"\\x1b[c\"`.\r\nIf there is something between those DA replies, it must be the one I need.\r\nIf there are only two DA replies, then it is probably not supported.\r\n\r\nThis approach works flawlessly in OpenConsole.\r\nIn WT, however, not so much: way, way too often random parts of the reply are simply missing.\r\n\r\n1. Compile the code:\r\n    \r\n<details>\r\n<summary>Code</summary>\r\n  \r\n```C++\r\n#ifndef _CRT_SECURE_NO_WARNINGS\r\n#define _CRT_SECURE_NO_WARNINGS\r\n#endif\r\n\r\n#ifndef _UNICODE\r\n#define _UNICODE\r\n#endif\r\n\r\n#ifndef UNICODE\r\n#define UNICODE\r\n#endif\r\n\r\n#include <algorithm>\r\n#include <format>\r\n#include <exception>\r\n#include <iostream>\r\n#include <optional>\r\n#include <ranges>\r\n#include <string>\r\n#include <string_view>\r\n\r\n#include <string.h>\r\n\r\n#include <windows.h>\r\n\r\nusing namespace std::literals;\r\n\r\nauto win32_error()\r\n{\r\n\treturn std::runtime_error(std::format(\"Error 0x{:08X}, look it up\"sv, GetLastError()));\r\n};\r\n\r\nauto invalid_response()\r\n{\r\n\treturn std::runtime_error(\"Invalid response\");\r\n}\r\n\r\nauto invalid_response(const size_t Index)\r\n{\r\n\treturn std::runtime_error(std::format(\"Invalid response at #{}\"sv, Index));\r\n}\r\n\r\nauto printable(const std::wstring_view Str)\r\n{\r\n\tstd::wstring Printable;\r\n\tstd::ranges::transform(Str, std::back_inserter(Printable), [](wchar_t Char){ return Char < L' ' ? Char + L'\\u2400' : Char; });\r\n\treturn Printable;\r\n}\r\n\r\nvoid write(const std::wstring_view Str)\r\n{\r\n\tDWORD Written;\r\n\tif (!WriteConsole(GetStdHandle(STD_OUTPUT_HANDLE), Str.data(), static_cast<DWORD>(Str.size()), &Written, {}))\r\n\t\tthrow win32_error();\r\n}\r\n\r\nvoid write(const std::string_view Str)\r\n{\r\n\twrite(std::wstring(Str.begin(), Str.end()));\r\n}\r\n\r\nstd::wstring query(const std::wstring& Command)\r\n{\r\n\tconst auto Dummy = L\"\\x1b[c\"s;\r\n\r\n\twrite(Dummy + Command + Dummy);\r\n\r\n\t// Sleep(1);\r\n\r\n\tstd::wstring Response;\r\n\r\n\tstd::optional<size_t>\r\n\t\tFirstTokenPrefixPos,\r\n\t\tFirstTokenSuffixPos,\r\n\t\tSecondTokenPrefixPos,\r\n\t\tSecondTokenSuffixPos;\r\n\r\n\tconst auto\r\n\t\tTokenPrefix = L\"\\x1b[?\"sv,\r\n\t\tTokenSuffix = L\"c\"sv;\r\n\r\n\twhile (!SecondTokenSuffixPos)\r\n\t{\r\n\t\twchar_t ResponseBuffer[8192];\r\n\t\tDWORD ResponseSize;\r\n\r\n\t\tif (!ReadConsole(GetStdHandle(STD_INPUT_HANDLE), ResponseBuffer, ARRAYSIZE(ResponseBuffer),  &ResponseSize, {}))\r\n\t\t\tthrow win32_error();\r\n\r\n\t\tResponse.append(ResponseBuffer, ResponseSize);\r\n\r\n\t\tif (!FirstTokenPrefixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenPrefix); Pos != Response.npos)\r\n\t\t\t\tFirstTokenPrefixPos = Pos;\r\n\r\n\t\tif (FirstTokenPrefixPos && !FirstTokenSuffixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenSuffix, *FirstTokenPrefixPos + TokenPrefix.size()); Pos != Response.npos)\r\n\t\t\t\tFirstTokenSuffixPos = Pos;\r\n\r\n\t\tif (FirstTokenSuffixPos && !SecondTokenPrefixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenPrefix, *FirstTokenSuffixPos + TokenSuffix.size()); Pos != Response.npos)\r\n\t\t\t\tSecondTokenPrefixPos = Pos;\r\n\r\n\t\tif (SecondTokenPrefixPos && !SecondTokenSuffixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenSuffix, *SecondTokenPrefixPos + TokenPrefix.size()); Pos != Response.npos)\r\n\t\t\t\tSecondTokenSuffixPos = Pos;\r\n\t}\r\n\r\n\tResponse.resize(*SecondTokenPrefixPos);\r\n\tResponse.erase(0, *FirstTokenSuffixPos + TokenSuffix.size());\r\n\r\n\tif (Response.empty())\r\n\t\tthrow std::runtime_error(\"Query is not supported\"s);\r\n\r\n\treturn Response;\r\n}\r\n\r\nvoid set_modes()\r\n{\r\n\tconst auto\r\n\t\tIn = GetStdHandle(STD_INPUT_HANDLE),\r\n\t\tOut = GetStdHandle(STD_OUTPUT_HANDLE);\r\n\r\n\tDWORD InMode;\r\n\tif (!GetConsoleMode(In, &InMode))\r\n\t\tthrow win32_error();\r\n\r\n\tif (!SetConsoleMode(In, (InMode & ~(ENABLE_LINE_INPUT | ENABLE_ECHO_INPUT | ENABLE_QUICK_EDIT_MODE)) | ENABLE_MOUSE_INPUT | ENABLE_EXTENDED_FLAGS | ENABLE_VIRTUAL_TERMINAL_INPUT))\r\n\t\tthrow win32_error();\r\n\r\n\tDWORD OutMode;\r\n\tif (!GetConsoleMode(Out, &OutMode))\r\n\t\tthrow win32_error();\r\n\r\n\tif (!SetConsoleMode(Out, OutMode | ENABLE_PROCESSED_OUTPUT | ENABLE_VIRTUAL_TERMINAL_PROCESSING))\r\n\t\tthrow win32_error();\r\n}\r\n\r\nint main()\r\n{\r\n\ttry\r\n\t{\r\n\t\tset_modes();\r\n\r\n\t\tstd::wstring Str;\r\n\r\n\t\tfor (size_t i = 0; i != 256; ++i)\r\n\t\t\tstd::format_to(std::back_inserter(Str), L\"\\x1b]4;{};?\\x1b\\\\\"sv, i);\r\n\r\n\t\tfor (;;)\r\n\t\t{\r\n\t\t\tconst auto ReplyData = query(Str);\r\n\r\n\t\t\tstd::wstring_view Reply(ReplyData);\r\n\r\n\t\t\tif (!Reply.ends_with(L\"\\\\\"sv))\r\n\t\t\t\tthrow invalid_response();\r\n\r\n\t\t\tReply.remove_suffix(1);\r\n\r\n\t\t\tsize_t Index = 0;\r\n\r\n\t\t\tfor (const auto& Part: std::views::split(Reply, L\"\\\\\"sv))\r\n\t\t\t{\r\n\t\t\t\tstd::wstring_view ColorStr(Part.begin(), Part.end());\r\n\r\n\t\t\t\ttry\r\n\t\t\t\t{\r\n\t\t\t\t\tif (!ColorStr.starts_with(L\"\\x1b]4;\"sv))\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(L\"\\x1b]4;\"sv.size());\r\n\r\n\t\t\t\t\twchar_t* Ptr;\r\n\t\t\t\t\tconst auto ReportedIndex = std::wcstol(ColorStr.data(), &Ptr, 10);\r\n\r\n\t\t\t\t\tif (Ptr == ColorStr.data())\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tif (ReportedIndex != Index)\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(Ptr - ColorStr.data());\r\n\r\n\t\t\t\t\tconst auto End = ColorStr.find(L\"\\x1b\"sv);\r\n\t\t\t\t\tif (End == ColorStr.npos)\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_suffix(ColorStr.size() - End);\r\n\r\n\t\t\t\t\tif (!ColorStr.starts_with(L\";rgb:\"sv))\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(L\";rgb:\"sv.size());\r\n\r\n\t\t\t\t\tif (ColorStr.size() != L\"ffff/ffff/ffff\"sv.size())\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\t\t\t\t}\r\n\t\t\t\tcatch (const std::runtime_error& e)\r\n\t\t\t\t{\r\n\t\t\t\t\tBeep(500, 200);\r\n\r\n\t\t\t\t\twrite(e.what());\r\n\t\t\t\t\twrite(L\": \"sv);\r\n\t\t\t\t\twrite(printable(ColorStr));\r\n\t\t\t\t\twrite(L\"\\n\"sv);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t++Index;\r\n\t\t\t}\r\n\r\n\t\t\tstd::wcout << L\"Everything is OK\"sv << std::endl;\r\n\r\n\t\t}\r\n\t}\r\n\tcatch (const std::exception& e)\r\n\t{\r\n\t\tstd::cerr << e.what() << std::endl;\r\n\t}\r\n}\r\n```\r\n</details>\r\n\r\n2. Run it in WT.\r\n \r\n\r\n\r\n### Expected Behavior\r\n\r\nThe program should print \"Everything is OK\" in a loop indefinitely and nothing else:\r\n```\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\n...and so on.\r\n```\r\n\r\n### Actual Behavior\r\n\r\nThe program prints \"Everything is OK\" a few times, then it detects errors due to missing bits in the reply, e.g.\r\n```\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nInvalid response at #234: c/1c1c\u241b\r\nEverything is OK\r\n```\r\n\r\nEventually it deadlocks in `ReadConsole`.\r\n\r\nAdding a delay between sending the query and reading the reply improves the situation dramatically, but still not to 100% and it does not feel like the right thing to do: fixing issues with `Sleep(N)` never works in the long term.\r\n\r\nSplitting it to smaller queries also helps, but again, it is guesswork.\r\nOverall it is about 2700 characters to send and about 7000 to receive. It does not look like something humongous by modern standards.\r\n\r\nMoving the mouse or pressing keyboard keys noticeably increases the error rate. Again, only in WT.\r\n\n", "hints_text": "I believe this is caused by #16224. Since the terminal lock isn't held anymore, any thread can write into the input pipe concurrently. In our case that's the VT parser thread sending VT responses and the UI thread sending cursor messages.", "created_at": "2024-08-23 14:14:56", "merge_commit_sha": "b07589e7a87e1d7a2f6144744a59c866c672a78e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17770", "base_commit": "b3f41626b4d212da8ca7c08077b12c289f918c86", "patch": "diff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..8f8f9f0df66 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -717,11 +717,14 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         // terminal.\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _core.UpdateSettings(settings, unfocusedAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _core.UpdateSettings(settings, unfocusedAppearance);\r\n \r\n-        _UpdateSettingsFromUIThread();\r\n+            _UpdateSettingsFromUIThread();\r\n \r\n-        _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+            _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n@@ -730,10 +733,15 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - newAppearance: the new appearance to set\r\n     winrt::fire_and_forget TermControl::UpdateAppearance(IControlAppearance newAppearance)\r\n     {\r\n+        auto weakThis{ get_weak() };\r\n+\r\n         // Dispatch a call to the UI thread\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _UpdateAppearanceFromUIThread(newAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _UpdateAppearanceFromUIThread(newAppearance);\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n", "test_patch": "", "problem_statement": "'unfocusedAppearance' option with any value including empty dictionary causes Windows Terminal to crash all instances when closing just one\n### Windows Terminal version\n\n1.20.11781\n\n### Windows build number\n\n10.0.22631.2861\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nSo after quite a bit of troubleshooting (including re-installing my entire Windows 11 OS), I've narrowed down the bug and can consistently replicate it.\n\n\n1. Add the `unfocusedAppearance` option in the `defaults` section of your Windows Terminal config, e.g.\n\n```\n   \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        ...\n    },\n```\n\n2. OR alternative use this full config (minimal example):\n\n```md\n{\n    \"$help\": \"https://aka.ms/terminal-documentation\",\n    \"$schema\": \"https://aka.ms/terminal-profiles-schema\",\n    \"actions\": \n    [\n        {\n            \"command\": \n            {\n                \"action\": \"copy\",\n                \"singleLine\": false\n            },\n            \"keys\": \"ctrl+c\"\n        },\n        {\n            \"command\": \"paste\",\n            \"keys\": \"ctrl+v\"\n        },\n        {\n            \"command\": \"find\",\n            \"keys\": \"ctrl+shift+f\"\n        },\n        {\n            \"command\": \n            {\n                \"action\": \"splitPane\",\n                \"split\": \"auto\",\n                \"splitMode\": \"duplicate\"\n            },\n            \"keys\": \"alt+shift+d\"\n        }\n    ],\n    \"copyFormatting\": \"none\",\n    \"copyOnSelect\": false,\n    \"defaultProfile\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n    \"newTabMenu\": \n    [\n        {\n            \"type\": \"remainingProfiles\"\n        }\n    ],\n    \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"opacity\": 90,\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        \"list\": \n        [\n            {\n                \"guid\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n                \"hidden\": false,\n                \"name\": \"Windows PowerShell\"\n            },\n            {\n                \"guid\": \"{0caa0dad-35be-5f56-a8ff-afceeeaa6101}\",\n                \"hidden\": false,\n                \"name\": \"Command Prompt\"\n            }\n        ]\n    },\n    \"schemes\": \n    [\n        {\n            \"background\": \"#0C0C0C\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#012456\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell Powershell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#282C34\",\n            \"black\": \"#282C34\",\n            \"blue\": \"#61AFEF\",\n            \"brightBlack\": \"#5A6374\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B6C2\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C678DD\",\n            \"brightRed\": \"#E06C75\",\n            \"brightWhite\": \"#DCDFE4\",\n            \"brightYellow\": \"#E5C07B\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#56B6C2\",\n            \"foreground\": \"#DCDFE4\",\n            \"green\": \"#98C379\",\n            \"name\": \"One Half Dark\",\n            \"purple\": \"#C678DD\",\n            \"red\": \"#E06C75\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#DCDFE4\",\n            \"yellow\": \"#E5C07B\"\n        },\n        {\n            \"background\": \"#FAFAFA\",\n            \"black\": \"#383A42\",\n            \"blue\": \"#0184BC\",\n            \"brightBlack\": \"#4F525D\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B5C1\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C577DD\",\n            \"brightRed\": \"#DF6C75\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#E4C07A\",\n            \"cursorColor\": \"#4F525D\",\n            \"cyan\": \"#0997B3\",\n            \"foreground\": \"#383A42\",\n            \"green\": \"#50A14F\",\n            \"name\": \"One Half Light\",\n            \"purple\": \"#A626A4\",\n            \"red\": \"#E45649\",\n            \"selectionBackground\": \"#4F525D\",\n            \"white\": \"#FAFAFA\",\n            \"yellow\": \"#C18301\"\n        },\n        {\n            \"background\": \"#002B36\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#839496\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Dark\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#FDF6E3\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#002B36\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#657B83\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Light\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#073642\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#D3D7CF\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Dark\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#FFFFFF\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#000000\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#555753\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Light\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#555753\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#000080\",\n            \"brightBlack\": \"#808080\",\n            \"brightBlue\": \"#0000FF\",\n            \"brightCyan\": \"#00FFFF\",\n            \"brightGreen\": \"#00FF00\",\n            \"brightPurple\": \"#FF00FF\",\n            \"brightRed\": \"#FF0000\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#FFFF00\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#008080\",\n            \"foreground\": \"#C0C0C0\",\n            \"green\": \"#008000\",\n            \"name\": \"Vintage\",\n            \"purple\": \"#800080\",\n            \"red\": \"#800000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#C0C0C0\",\n            \"yellow\": \"#808000\"\n        }\n    ],\n    \"themes\": []\n}\n```\n\n3. Now launch two instances of Windows Terminal.\n4. Using your mouse, press the 'x' button on the top-right of the first instance.\n5. The first instance will freeze a bit, crash, and cause both instances to shut.\n6. If you view Event Viewer logs, under Application logs, you will see that the application has indeed crashed with an ERROR.\n\nOther things to know:\n- Removing the `unfocusedAppearance` option fixes the issue (but you lose that feature).\n- The `unfocusedAppearance` use to work for me on older builds (I don't know which ones but I use to use this feature a lot).\n- Adding any options in the `unfocusedAppearance` still causes the crash.\n- Shutting any of the Windows Terminal using 'CTRL+W' shortcut avoids this crashing behaviour.\n\n### Expected Behavior\n\nWhen I shut a single instance of Windows Terminal, it should only shut that instance and not shut all other instances. This likely happens because the parent process crashes, killing all spawned windows terminal children.\n\n### Actual Behavior\n\nPressing the 'x' button causes all windows terminal instances to shut.\n", "hints_text": "", "created_at": "2024-08-22 17:00:36", "merge_commit_sha": "eabebc4cb227293df4839f75bd195b04992ba506", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17738", "base_commit": "9b21b78feea9ff0a0b9ff2c8fa4b4aa5602d3889", "patch": "diff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 07918e902bc..0eebe1308c9 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -2029,6 +2029,7 @@ void StateMachine::ProcessString(const std::wstring_view string)\n     if (_state != VTStates::Ground)\r\n     {\r\n         const auto run = _CurrentRun();\r\n+        auto cacheUnusedRun = true;\r\n \r\n         // One of the \"weird things\" in VT input is the case of something like\r\n         // <kbd>alt+[</kbd>. In VT, that's encoded as `\\x1b[`. However, that's\r\n@@ -2066,15 +2067,22 @@ void StateMachine::ProcessString(const std::wstring_view string)\n                     _ActionEscDispatch(run.back());\r\n                 }\r\n                 _EnterGround();\r\n+                // No need to cache the run, since we've dealt with it now.\r\n+                cacheUnusedRun = false;\r\n             }\r\n         }\r\n-        else if (_state != VTStates::SosPmApcString && _state != VTStates::DcsPassThrough && _state != VTStates::DcsIgnore)\r\n+        else if (_state == VTStates::SosPmApcString || _state == VTStates::DcsPassThrough || _state == VTStates::DcsIgnore)\r\n         {\r\n-            // If the engine doesn't require flushing at the end of the string, we\r\n-            // want to cache the partial sequence in case we have to flush the whole\r\n-            // thing to the terminal later. There is no need to do this if we've\r\n-            // reached one of the string processing states, though, since that data\r\n+            // There is no need to cache the run if we've reached one of the\r\n+            // string processing states in the output engine, since that data\r\n             // will be dealt with as soon as it is received.\r\n+            cacheUnusedRun = false;\r\n+        }\r\n+\r\n+        // If the run hasn't been dealt with in one of the cases above, we cache\r\n+        // the partial sequence in case we have to flush the whole thing later.\r\n+        if (cacheUnusedRun)\r\n+        {\r\n             if (!_cachedSequence)\r\n             {\r\n                 _cachedSequence.emplace(std::wstring{});\r\n", "test_patch": "", "problem_statement": "Pasting specific texts into vim (WSL) breaks some keys\n### Windows Terminal version\r\n\r\n1.20.10303.0 and 1.19.10302.0\r\n\r\n### Windows build number\r\n\r\n10.0.22621.0\r\n\r\n### Other Software\r\n\r\nvim 9.1.31 in WSL\r\nnvim v0.9.5 in WSL\r\n\r\n### Steps to reproduce\r\n\r\n1. Open vim in WSL using Terminal 1.20.10303.0 or 1.19.10302.0. **Version 1.18.10301.0 is unaffected.**\r\n2. Enter insert mode by pressing i.\r\n3. Paste in the following text with right click or shift+insert: https://gist.githubusercontent.com/csdivad/8c1069a35b52fb806ee8e4484b38f1f3/raw/37616af9daee626df6e7065059de5d5d87d8c9ec/test.txt\r\n\r\nThis input is a base64 encoded chunk of Lorem Ipsum.\r\nThe issue only happens with specific inputs. I encountered it first when pasting another base64 encoded text, but that had sensitive data in it.\r\nThen I played around with `dd if=lorem.txt bs=1 count=... | base64 -w 180` until I found a configuration that also triggered the issue.\r\n\r\n### Expected Behavior\r\n\r\nEscape, backspace and Function keys works properly after the paste.\r\nOnly the pasted text appears in the editor.\r\n\r\n### Actual Behavior\r\n\r\nYou are now stuck in editing mode. Esc, backspace and other keys are now sending weird escape sequences.\r\nAfter the last character a `1~` appears. Pressing esc inserts `^[`, pressing backspace inserts `^?`.\n", "hints_text": "Git bisect suggests that this broke in revision efbfb12145da959f74c368cdfc92f7892ce724d5. I'm not sure why though.\r\n\r\n@csdivad I think you should be able to escape from this state in vim by pressing <kbd>Ctrl</kbd>+<kbd>C</kbd>.\nI have a little more information now. It looks like the bracketed paste sequences are getting corrupted somehow. The paste starts with the opening sequence (`\\e[200~`), but only ends with part of the closing sequence (`1~`).\r\n\r\nAs a result, vim thinks you're still pasting content, so it won't process any command keys unless you manually terminate the paste. <kbd>Ctrl</kbd>+<kbd>C</kbd> is one way of doing that, but you could also enter the closing bracket sequence manually: <kbd>Esc</kbd> <kbd>[</kbd> <kbd>2</kbd> <kbd>0</kbd> <kbd>1</kbd> <kbd>~</kbd>.\r\n\r\nThe length of the paste seems to be a factor in the bug, because for every additional character I add to the pasted content, one more character is included in the closing bracket sequence, until it's sending the full sequence. At that point, additional content doesn't seem make any difference.\nI think I know why it's failing now. There's assumedly a 4096 byte buffer somewhere, and the pasted content along with the bracketed paste sequences adds up to just over 4096 bytes. As a result, the closing bracket sequence is cut off, and what we end up receiving in the initial packet is something like this:\r\n\r\n```\r\n\\e[200~ ... PASTED CONTENT ... \\e[20\r\n```\r\n\r\nWhen the parser gets to that last escape, we have [a heuristic](https://github.com/microsoft/terminal/blob/ef96e225da6b0df496390eed9fe31dc7e434a939/src/terminal/parser/stateMachine.cpp#L2155) that looks for a single escape, or a two byte Alt+key sequence, but this fits neither of those patterns, so it seems we just drop those characters!\r\n\r\nThen when the next packet arrives, we get the remaining characters for the closing bracket (`1~`), but since the start of the sequence has been lost, it's now just treated as plain text.\r\n\r\nThe more I think about, the more convinced I am that what we're doing here is completely wrong, but I don't know what the correct solution would be.\nhttps://github.com/microsoft/terminal/blob/ef96e225da6b0df496390eed9fe31dc7e434a939/src/terminal/parser/stateMachine.cpp#L2152-L2155\r\n\r\nI wonder if it's sufficient to *always* switch into a normal VT state machine mode once we've encountered a Win32 Input Mode sequence, e.g.:\r\n\r\n```\r\n        if (_isEngineForInput && !_engine->EncounteredWin32InputModeSequence())\r\n        {\r\n```\nCould we just amend the heuristic to also account for bracketed paste mode? Like, if we've started a bracketed paste, don't ever flush the state machine at the end of a write? Not sure how bad that would be.\nSorry, I think I've been misleading everyone. I've just been looking at this again, and I now realise that my initial understanding was wrong.\r\n\r\nWhen the first packet ends with half an escape sequence (the `\\e[20`), I thought it just dropped those characters, but that's not actually what's happening. They've already been parsed and are now \"preserved\" in the state machine, which is why it's not in the ground state. When the next packet arrives, it does actually continue parsing the sequence from where it left off, but that's the point when something goes wrong which I'm not sure I understand.\r\n\r\nIt gets to a point where it decides it should flush the content to the input queue. However, the only thing it can flush is what it has in the current buffer, which is the second half of the sequence. So I think that's how the first half ends up being dropped, and vim sees the second half of the sequence as additional pasted text.\r\n\r\nI think it's best I leave this to someone else to figure out, because I seem to be out of my depth here.\nAny update on this?\r\nThe issue is now present in the Store release (1.19.10573.0).\nI've just had this issue come up again in a different context (a VT query response that exceeded 4K), and I think I have a better understanding of what's going wrong now.\r\n\r\nAs I mentioned above:\r\n> It gets to a point where it decides it should flush the content to the input queue. However, the only thing it can flush is what it has in the current buffer, which is the second half of the sequence.\r\n\r\nBut the state machine already has a process for dealing with this. If you exit the state machine and you're not in the ground state, it can save the current run in the `_cachedSequence` field. Then if it needs to flush at a later point in time, it can combine the `_cachedSequence` with the latest run so you won't lose anything.\r\n\r\nThe problem is that this process is only applied to the output state machine. See here:\r\nhttps://github.com/microsoft/terminal/blob/0199ca33ddb4a02ca3549627d772ce6b330ed1ce/src/terminal/parser/stateMachine.cpp#L2073-L2084\r\n\r\nSo I think all we need to do is copy that chunk of code up a couple of lines into the `_isEngineForInput` branch and all will be good.\r\n\r\nI've done a basic test with this patch, and it seems to fix my problem as well as the vim pasting bug described in this issue. I don't know if there are any edge cases I'm missing though.", "created_at": "2024-08-18 21:52:55", "merge_commit_sha": "131728b17d50a81d0ecc0686589a2742b7742149", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17731", "base_commit": "4c018efd641dd71502e4019078bb6325c68b7f9a", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex a7530807d07..87236331fca 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1425,6 +1425,11 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n         LR\"(\\b(?:https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|$!:,.;]*[A-Za-z0-9+&@#/%=~_|$])\",\r\n     };\r\n \r\n+    if (!_detectURLs)\r\n+    {\r\n+        return {};\r\n+    }\r\n+\r\n     auto text = ICU::UTextFromTextBuffer(_activeBuffer(), beg, end + 1);\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     PointTree::interval_vector intervals;\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\nindex 827c4da85ce..ac9841369db 100644\n--- a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n@@ -607,6 +607,13 @@ void TerminalBufferTests::TestURLPatternDetection()\n     constexpr auto urlStartX = BeforeStr.size();\r\n     constexpr auto urlEndX = BeforeStr.size() + UrlStr.size() - 1;\r\n \r\n+    // This is off by default; turn it on for the test.\r\n+    auto originalDetectURLs = term->_detectURLs;\r\n+    auto restoreDetectUrls = wil::scope_exit([&]() {\r\n+        term->_detectURLs = originalDetectURLs;\r\n+    });\r\n+    term->_detectURLs = true;\r\n+\r\n     auto& termSm = *term->_stateMachine;\r\n     termSm.ProcessString(fmt::format(FMT_COMPILE(L\"{}{}{}\"), BeforeStr, UrlStr, AfterStr));\r\n     term->UpdatePatternsUnderLock();\r\n", "test_patch": "", "problem_statement": "Can't off feature \"Auto recognize URLs\"\n### Windows Terminal version\n\n1.22.2281.0\n\n### Windows build number\n\n10.0.19045.3448\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nbroken features:\r\n\"experimental.detectURLs\": false,\r\n\r\nwork fine:\r\nMicrosoft.WindowsTerminal_1.17.11461.0_x64.zip\r\nMicrosoft.WindowsTerminal_1.18.2681.0_x64.zip\r\n\r\n\r\nbroken:\r\nMicrosoft.WindowsTerminal_1.19.10302.0_x64.zip\r\n...\r\nMicrosoft.WindowsTerminal_1.20.11781.0_x64.zip\r\n\r\nlatest Canary terminal-1.22.2281.0 also broken\r\n\r\n\r\ntest URL:\r\nhttps://aka.ms/terminal-documentation\r\n\n\n### Expected Behavior\n\nrecognized URLs are not highlighted\n\n### Actual Behavior\n\nrecognized URLs is highlighted\r\nanyway\r\n\r\nwhen \r\n\"experimental.detectURLs\": false,\r\nor\r\n\"experimental.detectURLs\": true,\n", "hints_text": "This regressed in cd80f3c76496c7664ed710907d7d473f634191bc because this line got removed from the branch:\r\nhttps://github.com/microsoft/terminal/blob/5651f087702d97f8c5e48db6cd4199aed8a04479/src/cascadia/TerminalCore/Terminal.cpp#L1340-L1342\r\n\r\nThe fix is to add a `_detectURLs` check here:\r\nhttps://github.com/microsoft/terminal/blob/1ef497970f8409def5ac03e26ba54439d0aad4e0/src/cascadia/TerminalCore/Terminal.cpp#L1422-L1452", "created_at": "2024-08-16 22:55:27", "merge_commit_sha": "735ef2823ed72d80ce91df0176646979e4568831", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17706", "base_commit": "0199ca33ddb4a02ca3549627d772ce6b330ed1ce", "patch": "diff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png\nnew file mode 100644\nindex 00000000000..9e712ad8d95\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png\nnew file mode 100644\nindex 00000000000..82aa697c74f\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png\nnew file mode 100644\nindex 00000000000..ea8c240656d\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png\nnew file mode 100644\nindex 00000000000..54a8c126ff7\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png\nnew file mode 100644\nindex 00000000000..66486474a59\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png\nnew file mode 100644\nindex 00000000000..68aa47b458f\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png\nnew file mode 100644\nindex 00000000000..1fa174e5ac7\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png\nnew file mode 100644\nindex 00000000000..57615ac57ee\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png\nnew file mode 100644\nindex 00000000000..d7f31d5d715\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png differ\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\nindex 3d576f60603..6febe041d67 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n@@ -20,9 +20,6 @@\n #include \"SshHostGenerator.h\"\r\n #endif\r\n \r\n-// userDefault.h is like the above, but with a default template for the user's settings.json.\r\n-#include <LegacyProfileGeneratorNamespaces.h>\r\n-\r\n #include \"ApplicationState.h\"\r\n #include \"DefaultTerminal.h\"\r\n #include \"FileUtils.h\"\r\n@@ -465,6 +462,11 @@ bool SettingsLoader::FixupUserSettings()\n         CommandlinePatch{ DEFAULT_WINDOWS_POWERSHELL_GUID, L\"powershell.exe\", L\"%SystemRoot%\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\" },\r\n     };\r\n \r\n+    static constexpr std::array iconsToClearFromVisualStudioProfiles{\r\n+        std::wstring_view{ L\"ms-appx:///ProfileIcons/{61c54bbd-c2c6-5271-96e7-009a87ff44bf}.png\" },\r\n+        std::wstring_view{ L\"ms-appx:///ProfileIcons/{0caa0dad-35be-5f56-a8ff-afceeeaa6101}.png\" },\r\n+    };\r\n+\r\n     auto fixedUp = userSettings.fixupsAppliedDuringLoad;\r\n     fixedUp = userSettings.globals->FixupsAppliedDuringLoad() || fixedUp;\r\n \r\n@@ -473,28 +475,39 @@ bool SettingsLoader::FixupUserSettings()\n     {\r\n         fixedUp = RemapColorSchemeForProfile(profile) || fixedUp;\r\n \r\n-        if (!profile->HasCommandline())\r\n+        if (profile->HasCommandline())\r\n         {\r\n-            continue;\r\n+            for (const auto& patch : commandlinePatches)\r\n+            {\r\n+                if (profile->Guid() == patch.guid && til::equals_insensitive_ascii(profile->Commandline(), patch.before))\r\n+                {\r\n+                    profile->ClearCommandline();\r\n+\r\n+                    // GH#12842:\r\n+                    // With the commandline field on the user profile gone, it's actually unknown what\r\n+                    // commandline it'll inherit, since a user profile can have multiple parents. We have to\r\n+                    // make sure we restore the correct commandline in case we don't inherit the expected one.\r\n+                    if (profile->Commandline() != patch.after)\r\n+                    {\r\n+                        profile->Commandline(winrt::hstring{ patch.after });\r\n+                    }\r\n+\r\n+                    fixedUp = true;\r\n+                    break;\r\n+                }\r\n+            }\r\n         }\r\n \r\n-        for (const auto& patch : commandlinePatches)\r\n+        if (profile->HasIcon() && profile->HasSource() && profile->Source() == VisualStudioGenerator::Namespace)\r\n         {\r\n-            if (profile->Guid() == patch.guid && til::equals_insensitive_ascii(profile->Commandline(), patch.before))\r\n+            for (auto&& icon : iconsToClearFromVisualStudioProfiles)\r\n             {\r\n-                profile->ClearCommandline();\r\n-\r\n-                // GH#12842:\r\n-                // With the commandline field on the user profile gone, it's actually unknown what\r\n-                // commandline it'll inherit, since a user profile can have multiple parents. We have to\r\n-                // make sure we restore the correct commandline in case we don't inherit the expected one.\r\n-                if (profile->Commandline() != patch.after)\r\n+                if (profile->Icon() == icon)\r\n                 {\r\n-                    profile->Commandline(winrt::hstring{ patch.after });\r\n+                    profile->ClearIcon();\r\n+                    fixedUp = true;\r\n+                    break;\r\n                 }\r\n-\r\n-                fixedUp = true;\r\n-                break;\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.cpp b/src/cascadia/TerminalSettingsModel/Profile.cpp\nindex 0f568b37e53..66382c857b1 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Profile.cpp\n@@ -329,7 +329,7 @@ Json::Value Profile::ToJson() const\n     // Recall: Icon isn't actually a setting in the MTSM_PROFILE_SETTINGS. We\r\n     // defined it manually in Profile, so make sure we only serialize the Icon\r\n     // if the user actually changed it here.\r\n-    JsonUtils::SetValueForKey(json, IconKey, (writeBasicSettings && HasIcon()) ? Icon() : _Icon);\r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n \r\n     // PermissiveStringConverter is unnecessary for serialization\r\n     JsonUtils::SetValueForKey(json, PaddingKey, _Padding);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\nindex 3fd3bca8a71..2fcfb1cc528 100644\n--- a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\n+++ b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\n@@ -9,9 +9,11 @@\n \r\n using namespace winrt::Microsoft::Terminal::Settings::Model;\r\n \r\n+std::wstring_view VisualStudioGenerator::Namespace{ L\"Windows.Terminal.VisualStudio\" };\r\n+\r\n std::wstring_view VisualStudioGenerator::GetNamespace() const noexcept\r\n {\r\n-    return std::wstring_view{ L\"Windows.Terminal.VisualStudio\" };\r\n+    return Namespace;\r\n }\r\n \r\n void VisualStudioGenerator::GenerateProfiles(std::vector<winrt::com_ptr<implementation::Profile>>& profiles) const\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\nindex 766d2cd7775..ef36284db74 100644\n--- a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\n@@ -26,6 +26,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n     class VisualStudioGenerator : public IDynamicProfileGenerator\r\n     {\r\n     public:\r\n+        static std::wstring_view Namespace;\r\n         std::wstring_view GetNamespace() const noexcept override;\r\n         void GenerateProfiles(std::vector<winrt::com_ptr<implementation::Profile>>& profiles) const override;\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h b/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\nindex dd5d42dba38..eab94e89546 100644\n--- a/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\n@@ -41,7 +41,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n \r\n         std::wstring GetProfileIconPath() const\r\n         {\r\n-            return L\"ms-appx:///ProfileIcons/{0caa0dad-35be-5f56-a8ff-afceeeaa6101}.png\";\r\n+            return L\"ms-appx:///ProfileIcons/vs-cmd.png\";\r\n         }\r\n \r\n         std::wstring GetProfileName(const VsSetupConfiguration::VsSetupInstance& instance) const;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h b/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\nindex b7d14e8b951..7557b503c0b 100644\n--- a/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\n@@ -38,7 +38,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n \r\n         std::wstring GetProfileIconPath() const\r\n         {\r\n-            return L\"ms-appx:///ProfileIcons/{61c54bbd-c2c6-5271-96e7-009a87ff44bf}.png\";\r\n+            return L\"ms-appx:///ProfileIcons/vs-powershell.png\";\r\n         }\r\n \r\n         std::wstring GetProfileName(const VsSetupConfiguration::VsSetupInstance& instance) const;\r\n", "test_patch": "", "problem_statement": "Better icons for Visual Studio Developer Command Prompt/Powershell profiles\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\nCustom icons for the `Developer PowerShell for VS 2022` and `Developer Command Prompt for VS 2022` profiles would be a nice touch.\r\n\r\n![5tXWrREqj0](https://github.com/user-attachments/assets/2456f899-1a19-4dfe-848c-e8543d339584)\r\n\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\n# Proposed technical implementation details (optional)\r\nInclude images in the app's `ProfileIcons/` directory and automatically use them for said profiles. I threw these together in GIMP. If they are satisfactory, feel free to use them.\r\n\r\n![cmd_vs](https://github.com/user-attachments/assets/1d3da7f9-1de7-40f1-9932-196fa10ec130)\r\n\r\n![powershell5_vs](https://github.com/user-attachments/assets/1cb5ab60-31b2-4825-8666-74eca7b243fa)\r\n\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\r\n\n", "hints_text": "", "created_at": "2024-08-12 23:49:12", "merge_commit_sha": "06c07ab50dd75af3e1a1afc51cb4c688190fda92", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17510", "base_commit": "295cd17b028d288ff81445f532d9301b44f6ffd9", "patch": "diff --git a/.github/actions/spelling/allow/apis.txt b/.github/actions/spelling/allow/apis.txt\nindex 839fcbe76b2..3a760315415 100644\n--- a/.github/actions/spelling/allow/apis.txt\n+++ b/.github/actions/spelling/allow/apis.txt\n@@ -65,8 +65,8 @@ GETTEXTLENGTH\n Hashtable\n HIGHCONTRASTON\n HIGHCONTRASTW\n-hinternet\n HIGHQUALITYSCALE\n+hinternet\n HINTERNET\n hotkeys\n href\n@@ -155,6 +155,7 @@ NOTIFYBYPOS\n NOTIFYICON\n NOTIFYICONDATA\n ntprivapi\n+NTSYSCALLAPI\n numr\n oaidl\n ocidl\ndiff --git a/.github/actions/spelling/expect/alphabet.txt b/.github/actions/spelling/expect/alphabet.txt\nindex 6a2ee3bb519..ccd019fb734 100644\n--- a/.github/actions/spelling/expect/alphabet.txt\n+++ b/.github/actions/spelling/expect/alphabet.txt\n@@ -1,20 +1,15 @@\n-AAAAA\n-AAAAAAAAAAAAA\n AAAAAABBBBBBCCC\n AAAAABBBBBBCCC\n abcd\n abcd\n ABCDEFGHIJ\n abcdefghijk\n-ABCDEFGHIJKLMNO\n-abcdefghijklmnop\n ABCDEFGHIJKLMNOPQRS\n ABCDEFGHIJKLMNOPQRST\n ABCG\n ABE\n abf\n BBBBB\n-BBBBBBBB\n BBBBBCCC\n BBBBCCCCC\n BBGGRR\n@@ -29,10 +24,8 @@ QQQQQQQQQQABCDEFGHIJKLMNOPQRSTQQQQQQQQQ\n QQQQQQQQQQABCDEFGHIJKLMNOPQRSTQQQQQQQQQQ\n QQQQQQQQQQABCDEFGHIJPQRST\n QQQQQQQQQQABCDEFGHIJPQRSTQQQQQQQQQQ\n-qrstuvwxyz\n qwerty\n qwertyuiopasdfg\n-YYYYYYYDDDDDDDDDDD\n ZAAZZ\n ZABBZ\n ZBAZZ\ndiff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex 63c7d273c6e..e0c9fd972d1 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -17,7 +17,6 @@ ADDALIAS\n ADDREF\n ADDSTRING\n ADDTOOL\n-AFew\n AFill\n AFX\n AHelper\n@@ -66,7 +65,6 @@ ARRAYSIZE\n ARROWKEYS\n asan\n ASBSET\n-asdfghjkl\n ASetting\n ASingle\n ASYNCDONTCARE\n@@ -125,6 +123,7 @@ BKCOLOR\n BKGND\n Bksp\n Blt\n+blu\n BLUESCROLL\n bmi\n BODGY\n@@ -145,7 +144,6 @@ buffersize\n buflen\n buildtransitive\n buildsystems\n-burriter\n BValue\n bytebuffer\n cac\n@@ -210,7 +208,6 @@ cmw\n CNL\n cnn\n Codeflow\n-codenav\n codepages\n codepath\n coinit\n@@ -362,6 +359,7 @@ DBGFONTS\n DBGOUTPUT\n dbh\n dblclk\n+Dcd\n DColor\n DCOLORVALUE\n dcommon\n@@ -379,7 +377,7 @@ DECALN\n DECANM\n DECARM\n DECAUPSS\n-DECAWM\n+decawm\n DECBI\n DECBKM\n DECCARA\n@@ -421,6 +419,7 @@ DECPCCM\n DECPCTERM\n DECPS\n DECRARA\n+decrc\n DECRC\n DECREQTPARM\n DECRLM\n@@ -436,6 +435,7 @@ DECRSPS\n decrst\n DECSACE\n DECSASD\n+decsc\n DECSC\n DECSCA\n DECSCNM\n@@ -475,7 +475,6 @@ DEFPUSHBUTTON\n defterm\n DELAYLOAD\n DELETEONRELEASE\n-Delt\n depersist\n deprioritized\n deserializers\n@@ -556,7 +555,6 @@ Efast\n efghijklmn\n EHsc\n EINS\n-EJO\n ELEMENTNOTAVAILABLE\n EMPTYBOX\n enabledelayedexpansion\n@@ -626,7 +624,6 @@ FINDDOWN\n FINDREGEX\n FINDSTRINGEXACT\n FINDUP\n-FIter\n FITZPATRICK\n FIXEDFILEINFO\n Flg\n@@ -723,6 +720,7 @@ GETWHEELSCROLLLINES\n Gfun\n gfx\n GGI\n+GHgh\n GHIJK\n GHIJKL\n gitcheckin\n@@ -948,7 +946,6 @@ LCONTROL\n LCTRL\n lcx\n LEFTALIGN\n-libpopcnt\n libsancov\n libtickit\n licate\n@@ -1046,7 +1043,6 @@ MAPBITMAP\n MAPVIRTUALKEY\n MAPVK\n MAXDIMENSTRING\n-maxing\n MAXSHORT\n maxval\n maxversiontested\n@@ -1504,7 +1500,6 @@ REGSTR\n RELBINPATH\n remoting\n renamer\n-renderengine\n rendersize\n reparented\n reparenting\n@@ -1844,7 +1839,6 @@ Trd\n TREX\n triaged\n triaging\n-Tribool\n TRIMZEROHEADINGS\n trx\n tsa\n@@ -1938,7 +1932,6 @@ uxtheme\n Vanara\n vararg\n vclib\n-vcprintf\n vcxitems\n vectorize\n VERCTRL\n@@ -1982,7 +1975,6 @@ vtio\n vtmode\n vtpipeterm\n vtpt\n-vtrenderer\n VTRGB\n VTRGBTo\n vtseq\n@@ -2004,6 +1996,7 @@ wcswidth\n wddm\n wddmcon\n WDDMCONSOLECONTEXT\n+WDK\n wdm\n webpage\n websites\n@@ -2071,7 +2064,6 @@ Winperf\n WInplace\n winres\n winrt\n-wintelnet\n winternl\n winuser\n winuserp\n@@ -2172,7 +2164,6 @@ XTWINOPS\n xunit\n xutr\n XVIRTUALSCREEN\n-XWalk\n yact\n YCast\n YCENTER\n@@ -2181,7 +2172,6 @@ YLimit\n YPan\n YSubstantial\n YVIRTUALSCREEN\n-YWalk\n Zab\n zabcd\n Zabcdefghijklmn\n@@ -2189,6 +2179,5 @@ Zabcdefghijklmnopqrstuvwxyz\n ZCmd\n ZCtrl\n ZWJs\n-zxcvbnm\n ZYXWVU\n ZYXWVUTd\ndiff --git a/NOTICE.md b/NOTICE.md\nindex 091060db2cd..c08d041f8e2 100644\n--- a/NOTICE.md\n+++ b/NOTICE.md\n@@ -84,71 +84,6 @@ THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n ```\r\n \r\n-## kimwalisch/libpopcnt\r\n-\r\n-**Source**: [https://github.com/kimwalisch/libpopcnt](https://github.com/kimwalisch/libpopcnt)\r\n-\r\n-### License\r\n-\r\n-```\r\n-BSD 2-Clause License\r\n-\r\n-Copyright (c) 2016 - 2019, Kim Walisch\r\n-Copyright (c) 2016 - 2019, Wojciech Mu\u0142a\r\n-\r\n-All rights reserved.\r\n-\r\n-Redistribution and use in source and binary forms, with or without\r\n-modification, are permitted provided that the following conditions are met:\r\n-\r\n-1. Redistributions of source code must retain the above copyright notice, this\r\n-   list of conditions and the following disclaimer.\r\n-2. Redistributions in binary form must reproduce the above copyright notice,\r\n-   this list of conditions and the following disclaimer in the documentation\r\n-   and/or other materials provided with the distribution.\r\n-\r\n-THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n-ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n-WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n-DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\r\n-ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n-(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n-LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n-ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n-(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n-SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n-```\r\n-\r\n-## dynamic_bitset\r\n-\r\n-**Source**: [https://github.com/pinam45/dynamic_bitset](https://github.com/pinam45/dynamic_bitset)\r\n-\r\n-### License\r\n-\r\n-```\r\n-MIT License\r\n-\r\n-Copyright (c) 2019 Maxime Pinard\r\n-\r\n-Permission is hereby granted, free of charge, to any person obtaining a copy\r\n-of this software and associated documentation files (the \"Software\"), to deal\r\n-in the Software without restriction, including without limitation the rights\r\n-to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n-copies of the Software, and to permit persons to whom the Software is\r\n-furnished to do so, subject to the following conditions:\r\n-\r\n-The above copyright notice and this permission notice shall be included in all\r\n-copies or substantial portions of the Software.\r\n-\r\n-THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n-IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n-FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n-AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n-LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n-OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n-SOFTWARE.\r\n-```\r\n-\r\n ## \\{fmt\\}\r\n \r\n **Source**: [https://github.com/fmtlib/fmt](https://github.com/fmtlib/fmt)\r\ndiff --git a/OpenConsole.sln b/OpenConsole.sln\nindex a6b0afa9453..6d1e8aefba2 100644\n--- a/OpenConsole.sln\n+++ b/OpenConsole.sln\n@@ -131,7 +131,6 @@ EndProject\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"InteractivityWin32\", \"src\\interactivity\\win32\\lib\\win32.LIB.vcxproj\", \"{06EC74CB-9A12-429C-B551-8532EC964726}\"\r\n \tProjectSection(ProjectDependencies) = postProject\r\n \t\t{1C959542-BAC2-4E55-9A6D-13251914CBB9} = {1C959542-BAC2-4E55-9A6D-13251914CBB9}\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842} = {990F2657-8580-4828-943F-5DD657D11842}\r\n \t\t{AF0A096A-8B3A-4949-81EF-7DF8F0FEE91F} = {AF0A096A-8B3A-4949-81EF-7DF8F0FEE91F}\r\n \tEndProjectSection\r\n EndProject\r\n@@ -140,14 +139,9 @@ EndProject\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"InteractivityBase\", \"src\\interactivity\\base\\lib\\InteractivityBase.vcxproj\", \"{06EC74CB-9A12-429C-B551-8562EC964846}\"\r\n EndProject\r\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"Interactivity.Win32.Tests.Unit\", \"src\\interactivity\\win32\\ut_interactivity_win32\\Interactivity.Win32.UnitTests.vcxproj\", \"{D3B92829-26CB-411A-BDA2-7F5DA3D25DD4}\"\r\n-\tProjectSection(ProjectDependencies) = postProject\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842} = {990F2657-8580-4828-943F-5DD657D11842}\r\n-\tEndProjectSection\r\n EndProject\r\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"CloseTest\", \"src\\tools\\closetest\\CloseTest.vcxproj\", \"{C7A6A5D9-60BE-4AEB-A5F6-AFE352F86CBB}\"\r\n EndProject\r\n-Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"RendererVt\", \"src\\renderer\\vt\\lib\\vt.vcxproj\", \"{990F2657-8580-4828-943F-5DD657D11842}\"\r\n-EndProject\r\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"VtPipeTerm\", \"src\\tools\\vtpipeterm\\VtPipeTerm.vcxproj\", \"{814DBDDE-894E-4327-A6E1-740504850098}\"\r\n \tProjectSection(ProjectDependencies) = postProject\r\n \t\t{9CBD7DFA-1754-4A9D-93D7-857A9D17CB1B} = {9CBD7DFA-1754-4A9D-93D7-857A9D17CB1B}\r\n@@ -157,8 +151,6 @@ Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"ConEchoKey\", \"src\\tools\\ech\n EndProject\r\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"Types\", \"src\\types\\lib\\types.vcxproj\", \"{18D09A24-8240-42D6-8CB6-236EEE820263}\"\r\n EndProject\r\n-Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"RendererVt.unittest\", \"src\\renderer\\vt\\ut_lib\\vt.unittest.vcxproj\", \"{990F2657-8580-4828-943F-5DD657D11843}\"\r\n-EndProject\r\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"BufferOut\", \"src\\buffer\\out\\lib\\bufferout.vcxproj\", \"{0CF235BD-2DA0-407E-90EE-C467E8BBC714}\"\r\n EndProject\r\n Project(\"{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}\") = \"TerminalConnection\", \"src\\cascadia\\TerminalConnection\\TerminalConnection.vcxproj\", \"{CA5CAD1A-C46D-4588-B1C0-40F31AE9100B}\"\r\n@@ -1117,29 +1109,6 @@ Global\n \t\t{C7A6A5D9-60BE-4AEB-A5F6-AFE352F86CBB}.Release|x64.Build.0 = Release|x64\r\n \t\t{C7A6A5D9-60BE-4AEB-A5F6-AFE352F86CBB}.Release|x86.ActiveCfg = Release|Win32\r\n \t\t{C7A6A5D9-60BE-4AEB-A5F6-AFE352F86CBB}.Release|x86.Build.0 = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.AuditMode|Any CPU.ActiveCfg = AuditMode|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.AuditMode|ARM64.ActiveCfg = Release|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.AuditMode|x64.ActiveCfg = Release|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.AuditMode|x86.ActiveCfg = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Debug|Any CPU.ActiveCfg = Debug|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Debug|ARM64.ActiveCfg = Debug|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Debug|ARM64.Build.0 = Debug|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Debug|x64.ActiveCfg = Debug|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Debug|x64.Build.0 = Debug|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Debug|x86.ActiveCfg = Debug|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Debug|x86.Build.0 = Debug|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Fuzzing|Any CPU.ActiveCfg = Fuzzing|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Fuzzing|ARM64.ActiveCfg = Fuzzing|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Fuzzing|x64.ActiveCfg = Fuzzing|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Fuzzing|x64.Build.0 = Fuzzing|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Fuzzing|x86.ActiveCfg = Fuzzing|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Release|Any CPU.ActiveCfg = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Release|ARM64.ActiveCfg = Release|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Release|ARM64.Build.0 = Release|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Release|x64.ActiveCfg = Release|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Release|x64.Build.0 = Release|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Release|x86.ActiveCfg = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842}.Release|x86.Build.0 = Release|Win32\r\n \t\t{814DBDDE-894E-4327-A6E1-740504850098}.AuditMode|Any CPU.ActiveCfg = AuditMode|Win32\r\n \t\t{814DBDDE-894E-4327-A6E1-740504850098}.AuditMode|ARM64.ActiveCfg = Release|ARM64\r\n \t\t{814DBDDE-894E-4327-A6E1-740504850098}.AuditMode|x64.ActiveCfg = Release|x64\r\n@@ -1210,28 +1179,6 @@ Global\n \t\t{18D09A24-8240-42D6-8CB6-236EEE820263}.Release|x64.Build.0 = Release|x64\r\n \t\t{18D09A24-8240-42D6-8CB6-236EEE820263}.Release|x86.ActiveCfg = Release|Win32\r\n \t\t{18D09A24-8240-42D6-8CB6-236EEE820263}.Release|x86.Build.0 = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.AuditMode|Any CPU.ActiveCfg = AuditMode|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.AuditMode|ARM64.ActiveCfg = Release|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.AuditMode|x64.ActiveCfg = Release|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.AuditMode|x86.ActiveCfg = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Debug|Any CPU.ActiveCfg = Debug|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Debug|ARM64.ActiveCfg = Debug|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Debug|ARM64.Build.0 = Debug|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Debug|x64.ActiveCfg = Debug|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Debug|x64.Build.0 = Debug|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Debug|x86.ActiveCfg = Debug|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Debug|x86.Build.0 = Debug|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Fuzzing|Any CPU.ActiveCfg = Fuzzing|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Fuzzing|ARM64.ActiveCfg = Fuzzing|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Fuzzing|x64.ActiveCfg = Fuzzing|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Fuzzing|x86.ActiveCfg = Fuzzing|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Release|Any CPU.ActiveCfg = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Release|ARM64.ActiveCfg = Release|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Release|ARM64.Build.0 = Release|ARM64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Release|x64.ActiveCfg = Release|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Release|x64.Build.0 = Release|x64\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Release|x86.ActiveCfg = Release|Win32\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843}.Release|x86.Build.0 = Release|Win32\r\n \t\t{0CF235BD-2DA0-407E-90EE-C467E8BBC714}.AuditMode|Any CPU.ActiveCfg = AuditMode|Win32\r\n \t\t{0CF235BD-2DA0-407E-90EE-C467E8BBC714}.AuditMode|ARM64.ActiveCfg = AuditMode|ARM64\r\n \t\t{0CF235BD-2DA0-407E-90EE-C467E8BBC714}.AuditMode|ARM64.Build.0 = AuditMode|ARM64\r\n@@ -2444,11 +2391,9 @@ Global\n \t\t{06EC74CB-9A12-429C-B551-8562EC964846} = {E8F24881-5E37-4362-B191-A3BA0ED7F4EB}\r\n \t\t{D3B92829-26CB-411A-BDA2-7F5DA3D25DD4} = {E8F24881-5E37-4362-B191-A3BA0ED7F4EB}\r\n \t\t{C7A6A5D9-60BE-4AEB-A5F6-AFE352F86CBB} = {A10C4720-DCA4-4640-9749-67F4314F527C}\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11842} = {05500DEF-2294-41E3-AF9A-24E580B82836}\r\n \t\t{814DBDDE-894E-4327-A6E1-740504850098} = {A10C4720-DCA4-4640-9749-67F4314F527C}\r\n \t\t{814CBEEE-894E-4327-A6E1-740504850098} = {A10C4720-DCA4-4640-9749-67F4314F527C}\r\n \t\t{18D09A24-8240-42D6-8CB6-236EEE820263} = {89CDCC5C-9F53-4054-97A4-639D99F169CD}\r\n-\t\t{990F2657-8580-4828-943F-5DD657D11843} = {05500DEF-2294-41E3-AF9A-24E580B82836}\r\n \t\t{0CF235BD-2DA0-407E-90EE-C467E8BBC714} = {1E4A062E-293B-4817-B20D-BF16B979E350}\r\n \t\t{CA5CAD1A-C46D-4588-B1C0-40F31AE9100B} = {59840756-302F-44DF-AA47-441A9D673202}\r\n \t\t{CA5CAD1A-ABCD-429C-B551-8562EC954746} = {9921CA0A-320C-4460-8623-3A3196E7F4CB}\r\ndiff --git a/oss/dynamic_bitset/LICENSE b/oss/dynamic_bitset/LICENSE\ndeleted file mode 100644\nindex ee9bc70667d..00000000000\n--- a/oss/dynamic_bitset/LICENSE\n+++ /dev/null\n@@ -1,21 +0,0 @@\n-MIT License\r\n-\r\n-Copyright (c) 2019 Maxime Pinard\r\n-\r\n-Permission is hereby granted, free of charge, to any person obtaining a copy\r\n-of this software and associated documentation files (the \"Software\"), to deal\r\n-in the Software without restriction, including without limitation the rights\r\n-to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n-copies of the Software, and to permit persons to whom the Software is\r\n-furnished to do so, subject to the following conditions:\r\n-\r\n-The above copyright notice and this permission notice shall be included in all\r\n-copies or substantial portions of the Software.\r\n-\r\n-THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n-IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n-FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n-AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n-LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n-OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n-SOFTWARE.\r\ndiff --git a/oss/dynamic_bitset/MAINTAINER_README.md b/oss/dynamic_bitset/MAINTAINER_README.md\ndeleted file mode 100644\nindex 283b1414f09..00000000000\n--- a/oss/dynamic_bitset/MAINTAINER_README.md\n+++ /dev/null\n@@ -1,17 +0,0 @@\n-### Notes for Future Maintainers\r\n-\r\n-This was originally imported by @miniksa in March 2020.\r\n-\r\n-The provenance information (where it came from and which commit) is stored in the file `cgmanifest.json` in the same directory as this readme.\r\n-Please update the provenance information in that file when ingesting an updated version of the dependent library.\r\n-That provenance file is automatically read and inventoried by Microsoft systems to ensure compliance with appropriate governance standards.\r\n-\r\n-## What should be done to update this in the future?\r\n-\r\n-1. Go to pinam45/dynamic_bitset repository on GitHub.\r\n-2. Take the entire contents of the include directory wholesale and drop it in the root directory here.\r\n-3. Don't change anything about it.\r\n-4. Validate that the license in the root of the repository didn't change and update it if so. It is sitting in the same directory as this readme. \r\n-   If it changed dramatically, ensure that it is still compatible with our license scheme. Also update the NOTICE file in the root of our repository to declare the third-party usage.\r\n-5. Submit the pull.\r\n-\r\ndiff --git a/oss/dynamic_bitset/cgmanifest.json b/oss/dynamic_bitset/cgmanifest.json\ndeleted file mode 100644\nindex 32a19e36327..00000000000\n--- a/oss/dynamic_bitset/cgmanifest.json\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-{\r\n-  \"$schema\": \"https://json.schemastore.org/component-detection-manifest.json\",\r\n-  \"Registrations\": [\r\n-    {\r\n-      \"component\": {\r\n-        \"type\": \"git\",\r\n-        \"git\": {\r\n-          \"repositoryUrl\": \"https://github.com/pinam45/dynamic_bitset\",\r\n-          \"commitHash\": \"00f2d066ce9deebf28b006636150e5a882beb83f\"\r\n-        }\r\n-      }\r\n-    }\r\n-  ],\r\n-  \"Version\": 1\r\n-}\r\ndiff --git a/oss/dynamic_bitset/dynamic_bitset.hpp b/oss/dynamic_bitset/dynamic_bitset.hpp\ndeleted file mode 100644\nindex 8a0e385fb47..00000000000\n--- a/oss/dynamic_bitset/dynamic_bitset.hpp\n+++ /dev/null\n@@ -1,1944 +0,0 @@\n-//\r\n-// Copyright (c) 2019 Maxime Pinard\r\n-//\r\n-// Distributed under the MIT license\r\n-// See accompanying file LICENSE or copy at\r\n-// https://opensource.org/licenses/MIT\r\n-//\r\n-#ifndef DYNAMIC_BITSET_DYNAMIC_BITSET_HPP\r\n-#define DYNAMIC_BITSET_DYNAMIC_BITSET_HPP\r\n-\r\n-#include <memory>\r\n-#include <vector>\r\n-#include <algorithm>\r\n-#include <string>\r\n-#include <string_view>\r\n-#include <functional>\r\n-#include <type_traits>\r\n-#include <climits>\r\n-#include <cmath>\r\n-#include <cassert>\r\n-\r\n-#ifndef DYNAMIC_BITSET_NO_LIBPOPCNT\r\n-#\tif __has_include(<libpopcnt.h>)\r\n-#\t\tinclude <libpopcnt.h>\r\n-#\t\tdefine DYNAMIC_BITSET_USE_LIBPOPCNT\r\n-#\tendif\r\n-#endif\r\n-\r\n-#if defined(__clang__)\r\n-#\tdefine DYNAMIC_BITSET_CLANG\r\n-#\tifdef __has_builtin\r\n-#\t\tif __has_builtin(__builtin_popcount) && __has_builtin(__builtin_popcountl) \\\r\n-\t\t  && __has_builtin(__builtin_popcountll)\r\n-#\t\t\tdefine DYNAMIC_BITSET_CLANG_builtin_popcount\r\n-#\t\tendif\r\n-#\t\tif __has_builtin(__builtin_ctz) && __has_builtin(__builtin_ctzl) \\\r\n-\t\t  && __has_builtin(__builtin_ctzll)\r\n-#\t\t\tdefine DYNAMIC_BITSET_CLANG_builtin_ctz\r\n-#\t\tendif\r\n-#\tendif\r\n-#elif defined(__GNUC__)\r\n-#\tdefine DYNAMIC_BITSET_GCC\r\n-#elif defined(_MSC_VER)\r\n-#\tdefine DYNAMIC_BITSET_MSVC\r\n-#\tinclude <intrin.h>\r\n-#\tpragma intrinsic(_BitScanForward)\r\n-#\tif defined(_M_X64) || defined(_M_ARM64)\r\n-#\t\tdefine DYNAMIC_BITSET_MSVC_64\r\n-#\t\tpragma intrinsic(_BitScanForward64)\r\n-#\telse\r\n-#\tendif\r\n-#endif\r\n-\r\n-template<typename Block = unsigned long long, typename Allocator = std::allocator<Block>>\r\n-class dynamic_bitset\r\n-{\r\n-\tstatic_assert(std::is_unsigned<Block>::value, \"Block is not an unsigned integral type\");\r\n-\r\n-public:\r\n-\ttypedef size_t size_type;\r\n-\ttypedef Block block_type;\r\n-\ttypedef Allocator allocator_type;\r\n-\r\n-\tstatic constexpr size_type bits_per_block = CHAR_BIT * sizeof(block_type);\r\n-\tstatic constexpr size_type npos = std::numeric_limits<size_type>::max();\r\n-\r\n-\tclass reference\r\n-\t{\r\n-\tpublic:\r\n-\t\tconstexpr reference(dynamic_bitset<Block, Allocator>& bitset, size_type bit_pos);\r\n-\t\tconstexpr reference(const reference&) noexcept = default;\r\n-\t\tconstexpr reference(reference&&) noexcept = default;\r\n-\t\t~reference() noexcept = default;\r\n-\r\n-\t\tconstexpr reference& operator=(bool v);\r\n-\t\tconstexpr reference& operator=(const reference& rhs);\r\n-\t\tconstexpr reference& operator=(reference&& rhs) noexcept;\r\n-\r\n-\t\tconstexpr reference& operator&=(bool v);\r\n-\t\tconstexpr reference& operator|=(bool v);\r\n-\t\tconstexpr reference& operator^=(bool v);\r\n-\t\tconstexpr reference& operator-=(bool v);\r\n-\r\n-\t\t[[nodiscard]] constexpr bool operator~() const;\r\n-\t\t[[nodiscard]] constexpr operator bool() const;\r\n-\t\tconstexpr void operator&() = delete;\r\n-\r\n-\t\tconstexpr reference& set();\r\n-\t\tconstexpr reference& reset();\r\n-\t\tconstexpr reference& flip();\r\n-\t\tconstexpr reference& assign(bool v);\r\n-\r\n-\tprivate:\r\n-\t\tblock_type& m_block;\r\n-\t\tblock_type m_mask;\r\n-\t};\r\n-\ttypedef bool const_reference;\r\n-\r\n-\t// copy/move constructors = default\r\n-\tconstexpr dynamic_bitset(const dynamic_bitset<Block, Allocator>& other) = default;\r\n-\tconstexpr dynamic_bitset(dynamic_bitset<Block, Allocator>&& other) noexcept = default;\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator=(\r\n-\t  const dynamic_bitset<Block, Allocator>& other) = default;\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator=(\r\n-\t  dynamic_bitset<Block, Allocator>&& other) noexcept = default;\r\n-\r\n-\t// other constructors\r\n-\tconstexpr explicit dynamic_bitset(const allocator_type& allocator = allocator_type());\r\n-\tconstexpr explicit dynamic_bitset(size_type nbits,\r\n-\t                                  unsigned long long init_val = 0,\r\n-\t                                  const allocator_type& allocator = allocator_type());\r\n-\tconstexpr dynamic_bitset(std::initializer_list<block_type> init_vals,\r\n-\t                         const allocator_type& allocator = allocator_type());\r\n-\r\n-\t// string constructors\r\n-\ttemplate<typename _CharT, typename _Traits>\r\n-\tconstexpr explicit dynamic_bitset(\r\n-\t  std::basic_string_view<_CharT, _Traits> str,\r\n-\t  typename std::basic_string_view<_CharT, _Traits>::size_type pos = 0,\r\n-\t  typename std::basic_string_view<_CharT, _Traits>::size_type n =\r\n-\t    std::basic_string_view<_CharT, _Traits>::npos,\r\n-\t  _CharT zero = _CharT('0'),\r\n-\t  _CharT one = _CharT('1'),\r\n-\t  const allocator_type& allocator = allocator_type());\r\n-\r\n-\ttemplate<typename _CharT, typename _Traits, typename _Alloc>\r\n-\tconstexpr explicit dynamic_bitset(\r\n-\t  const std::basic_string<_CharT, _Traits, _Alloc>& str,\r\n-\t  typename std::basic_string<_CharT, _Traits, _Alloc>::size_type pos = 0,\r\n-\t  typename std::basic_string<_CharT, _Traits, _Alloc>::size_type n =\r\n-\t    std::basic_string<_CharT, _Traits, _Alloc>::npos,\r\n-\t  _CharT zero = _CharT('0'),\r\n-\t  _CharT one = _CharT('1'),\r\n-\t  const allocator_type& allocator = allocator_type());\r\n-\r\n-\ttemplate<typename _CharT>\r\n-\tconstexpr explicit dynamic_bitset(\r\n-\t  const _CharT* str,\r\n-\t  typename std::basic_string<_CharT>::size_type pos = 0,\r\n-\t  typename std::basic_string<_CharT>::size_type n = std::basic_string<_CharT>::npos,\r\n-\t  _CharT zero = _CharT('0'),\r\n-\t  _CharT one = _CharT('1'),\r\n-\t  const allocator_type& allocator = allocator_type());\r\n-\r\n-\t// destructor\r\n-\t~dynamic_bitset() noexcept = default;\r\n-\r\n-\t// size changing operations\r\n-\tconstexpr void resize(size_type nbits, bool value = false);\r\n-\tconstexpr void clear();\r\n-\tconstexpr void push_back(bool value);\r\n-\tconstexpr void pop_back();\r\n-\tconstexpr void append(block_type block);\r\n-\tconstexpr void append(std::initializer_list<block_type> blocks);\r\n-\ttemplate<typename BlockInputIterator>\r\n-\tconstexpr void append(BlockInputIterator first, BlockInputIterator last);\r\n-\r\n-\t// bitset operations\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator&=(\r\n-\t  const dynamic_bitset<Block, Allocator>& rhs);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator|=(\r\n-\t  const dynamic_bitset<Block, Allocator>& rhs);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator^=(\r\n-\t  const dynamic_bitset<Block, Allocator>& rhs);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator-=(\r\n-\t  const dynamic_bitset<Block, Allocator>& rhs);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator<<=(size_type shift);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& operator>>=(size_type shift);\r\n-\t[[nodiscard]] constexpr dynamic_bitset<Block, Allocator> operator<<(size_type shift) const;\r\n-\t[[nodiscard]] constexpr dynamic_bitset<Block, Allocator> operator>>(size_type shift) const;\r\n-\t[[nodiscard]] constexpr dynamic_bitset<Block, Allocator> operator~() const;\r\n-\r\n-\t// bit operations\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& set(size_type pos, size_type len, bool value);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& set(size_type pos, bool value = true);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& set();\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& reset(size_type pos, size_type len);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& reset(size_type pos);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& reset();\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& flip(size_type pos, size_type len);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& flip(size_type pos);\r\n-\tconstexpr dynamic_bitset<Block, Allocator>& flip();\r\n-\t[[nodiscard]] constexpr bool test(size_type pos) const;\r\n-\t[[nodiscard]] constexpr bool test_set(size_type pos, bool value = true);\r\n-\t[[nodiscard]] constexpr bool all() const;\r\n-\t[[nodiscard]] constexpr bool any() const;\r\n-\t[[nodiscard]] constexpr bool none() const;\r\n-\t[[nodiscard]] constexpr size_type count() const noexcept;\r\n-\r\n-\t// subscript operators\r\n-\t[[nodiscard]] constexpr reference operator[](size_type pos);\r\n-\t[[nodiscard]] constexpr const_reference operator[](size_type pos) const;\r\n-\r\n-\t//container-like functions\r\n-\t[[nodiscard]] constexpr size_type size() const noexcept;\r\n-\t[[nodiscard]] constexpr size_type num_blocks() const noexcept;\r\n-\t[[nodiscard]] constexpr bool empty() const noexcept;\r\n-\t[[nodiscard]] constexpr size_type capacity() const noexcept;\r\n-\tconstexpr void reserve(size_type num_bits);\r\n-\tconstexpr void shrink_to_fit();\r\n-\r\n-\t// subsets\r\n-\t[[nodiscard]] constexpr bool is_subset_of(const dynamic_bitset<Block, Allocator>& bitset) const;\r\n-\t[[nodiscard]] constexpr bool is_proper_subset_of(\r\n-\t  const dynamic_bitset<Block, Allocator>& bitset) const;\r\n-\t[[nodiscard]] constexpr bool intersects(const dynamic_bitset<Block, Allocator>& bitset) const;\r\n-\r\n-\t// find functions\r\n-\t[[nodiscard]] constexpr size_type find_first() const;\r\n-\t[[nodiscard]] constexpr size_type find_next(size_type prev) const;\r\n-\r\n-\t// utils\r\n-\tconstexpr void swap(dynamic_bitset<Block, Allocator>& other);\r\n-\t[[nodiscard]] constexpr allocator_type get_allocator() const;\r\n-\ttemplate<typename _CharT = char,\r\n-\t         typename _Traits = std::char_traits<_CharT>,\r\n-\t         typename _Alloc = std::allocator<_CharT>>\r\n-\t[[nodiscard]] constexpr std::basic_string<_CharT, _Traits, _Alloc> to_string(\r\n-\t  _CharT zero = _CharT('0'),\r\n-\t  _CharT one = _CharT('1')) const;\r\n-\ttemplate<typename Function, typename... Parameters>\r\n-\tconstexpr void iterate_bits_on(Function&& function, Parameters&&... parameters) const;\r\n-\r\n-\t// friend external binary operators\r\n-\ttemplate<typename Block_, typename Allocator_>\r\n-\tfriend constexpr bool operator==(const dynamic_bitset<Block_, Allocator_>& lhs,\r\n-\t                                 const dynamic_bitset<Block_, Allocator_>& rhs);\r\n-\ttemplate<typename Block_, typename Allocator_>\r\n-\tfriend constexpr bool operator<(const dynamic_bitset<Block_, Allocator_>& lhs,\r\n-\t                                const dynamic_bitset<Block_, Allocator_>& rhs);\r\n-\r\n-private:\r\n-\ttemplate<typename T>\r\n-\tstruct dependent_false : public std::false_type\r\n-\t{\r\n-\t};\r\n-\r\n-\tstd::vector<Block, Allocator> m_blocks;\r\n-\tsize_type m_bits_number;\r\n-\r\n-\tstatic constexpr block_type zero_block = block_type(0);\r\n-\tstatic constexpr block_type one_block = block_type(~zero_block);\r\n-\tstatic constexpr size_type block_last_bit_index = bits_per_block - 1;\r\n-\r\n-\tstatic constexpr size_type blocks_required(size_type nbits) noexcept;\r\n-\r\n-\tstatic constexpr size_type block_index(size_type pos) noexcept;\r\n-\tstatic constexpr size_type bit_index(size_type pos) noexcept;\r\n-\r\n-\tstatic constexpr block_type bit_mask(size_type pos) noexcept;\r\n-\tstatic constexpr block_type bit_mask(size_type first, size_type last) noexcept;\r\n-\r\n-\tstatic constexpr void set_block_bits(block_type& block,\r\n-\t                                     size_type first,\r\n-\t                                     size_type last,\r\n-\t                                     bool val = true) noexcept;\r\n-\tstatic constexpr void flip_block_bits(block_type& block,\r\n-\t                                      size_type first,\r\n-\t                                      size_type last) noexcept;\r\n-\r\n-\tstatic constexpr size_type block_count(const block_type& block) noexcept;\r\n-\tstatic constexpr size_type block_count(const block_type& block, size_type nbits) noexcept;\r\n-\r\n-\tstatic constexpr size_type first_on(const block_type& block) noexcept;\r\n-\r\n-\ttemplate<typename _CharT, typename _Traits>\r\n-\tconstexpr void init_from_string(std::basic_string_view<_CharT, _Traits> str,\r\n-\t                                typename std::basic_string_view<_CharT, _Traits>::size_type pos,\r\n-\t                                typename std::basic_string_view<_CharT, _Traits>::size_type n,\r\n-\t                                _CharT zero,\r\n-\t                                _CharT one);\r\n-\r\n-\tconstexpr block_type& get_block(size_type pos);\r\n-\tconstexpr const block_type& get_block(size_type pos) const;\r\n-\tconstexpr block_type& last_block();\r\n-\tconstexpr block_type last_block() const;\r\n-\r\n-\t// used bits in the last block\r\n-\tconstexpr size_type extra_bits_number() const noexcept;\r\n-\t// unused bits in the last block\r\n-\tconstexpr size_type unused_bits_number() const noexcept;\r\n-\r\n-\ttemplate<typename BinaryOperation>\r\n-\tconstexpr void apply(const dynamic_bitset<Block, Allocator>& other, BinaryOperation binary_op);\r\n-\ttemplate<typename UnaryOperation>\r\n-\tconstexpr void apply(UnaryOperation unary_op);\r\n-\tconstexpr void apply_left_shift(size_type shift);\r\n-\tconstexpr void apply_right_shift(size_type shift);\r\n-\r\n-\t// reset unused bits to 0\r\n-\tconstexpr void sanitize();\r\n-\r\n-\t// check functions used in asserts\r\n-\tconstexpr bool check_unused_bits() const noexcept;\r\n-\tconstexpr bool check_size() const noexcept;\r\n-\tconstexpr bool check_consistency() const noexcept;\r\n-};\r\n-\r\n-// Deduction guideline for expressions like \"dynamic_bitset a(32);\" with an integral type as parameter\r\n-// to use the constructor with the initial size instead of the constructor with the allocator.\r\n-template<typename integral_type, typename = std::enable_if_t<std::is_integral_v<integral_type>>>\r\n-dynamic_bitset(integral_type)->dynamic_bitset<>;\r\n-\r\n-//=================================================================================================\r\n-// dynamic_bitset external functions declarations\r\n-//=================================================================================================\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator!=(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                          const dynamic_bitset<Block, Allocator>& rhs);\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator<=(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                          const dynamic_bitset<Block, Allocator>& rhs);\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator>(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                         const dynamic_bitset<Block, Allocator>& rhs);\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator>=(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                          const dynamic_bitset<Block, Allocator>& rhs);\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator&(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs);\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator|(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs);\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator^(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs);\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator-(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs);\r\n-\r\n-template<typename _CharT, typename _Traits, typename Block, typename Allocator>\r\n-constexpr std::basic_ostream<_CharT, _Traits>& operator<<(\r\n-  std::basic_ostream<_CharT, _Traits>& os,\r\n-  const dynamic_bitset<Block, Allocator>& bitset);\r\n-\r\n-template<typename _CharT, typename _Traits, typename Block, typename Allocator>\r\n-constexpr std::basic_istream<_CharT, _Traits>& operator>>(std::basic_istream<_CharT, _Traits>& is,\r\n-                                                          dynamic_bitset<Block, Allocator>& bitset);\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void swap(dynamic_bitset<Block, Allocator>& bitset1,\r\n-                    dynamic_bitset<Block, Allocator>& bitset2);\r\n-\r\n-//=================================================================================================\r\n-// dynamic_bitset::reference functions implementations\r\n-//=================================================================================================\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>::reference::reference(\r\n-  dynamic_bitset<Block, Allocator>& bitset,\r\n-  size_type bit_pos)\r\n-  : m_block(bitset.get_block(bit_pos)), m_mask(dynamic_bitset<Block, Allocator>::bit_mask(bit_pos))\r\n-{\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::operator=(bool v)\r\n-{\r\n-\tassign(v);\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::operator=(const dynamic_bitset<Block, Allocator>::reference& rhs)\r\n-{\r\n-\tassign(rhs);\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::operator=(dynamic_bitset::reference&& rhs) noexcept\r\n-{\r\n-\tassign(rhs);\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::operator&=(bool v)\r\n-{\r\n-\tif(!v)\r\n-\t{\r\n-\t\treset();\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::operator|=(bool v)\r\n-{\r\n-\tif(v)\r\n-\t{\r\n-\t\tset();\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::operator^=(bool v)\r\n-{\r\n-\tif(v)\r\n-\t{\r\n-\t\tflip();\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::operator-=(bool v)\r\n-{\r\n-\tif(v)\r\n-\t{\r\n-\t\treset();\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::reference::operator~() const\r\n-{\r\n-\treturn (m_block & m_mask) == zero_block;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>::reference::operator bool() const\r\n-{\r\n-\treturn (m_block & m_mask) != zero_block;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::set()\r\n-{\r\n-\tm_block |= m_mask;\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::reset()\r\n-{\r\n-\tm_block &= ~m_mask;\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::flip()\r\n-{\r\n-\tm_block ^= m_mask;\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::reference& dynamic_bitset<Block, Allocator>::\r\n-  reference::assign(bool v)\r\n-{\r\n-\tif(v)\r\n-\t{\r\n-\t\tset();\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\treset();\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-//=================================================================================================\r\n-// dynamic_bitset public functions implementations\r\n-//=================================================================================================\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>::dynamic_bitset(const allocator_type& allocator)\r\n-  : m_blocks(allocator), m_bits_number(0)\r\n-{\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>::dynamic_bitset(size_type nbits,\r\n-                                                           unsigned long long init_val,\r\n-                                                           const allocator_type& allocator)\r\n-  : m_blocks(blocks_required(nbits), allocator), m_bits_number(nbits)\r\n-{\r\n-\tif(nbits == 0 || init_val == 0)\r\n-\t{\r\n-\t\treturn;\r\n-\t}\r\n-\r\n-\tconstexpr size_type init_val_required_blocks = sizeof(unsigned long long) / sizeof(block_type);\r\n-\tif constexpr(init_val_required_blocks == 1)\r\n-\t{\r\n-\t\tm_blocks[0] = init_val;\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tconst unsigned long long block_mask = static_cast<unsigned long long>(one_block);\r\n-\t\tconst size_type blocks_to_init = std::min(m_blocks.size(), init_val_required_blocks);\r\n-\t\tfor(size_type i = 0; i < blocks_to_init; ++i)\r\n-\t\t{\r\n-\t\t\tm_blocks[i] = block_type((init_val >> (i * bits_per_block) & block_mask));\r\n-\t\t}\r\n-\t}\r\n-\tsanitize();\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>::dynamic_bitset(\r\n-  std::initializer_list<block_type> init_vals,\r\n-  const allocator_type& allocator)\r\n-  : m_blocks(allocator), m_bits_number(0)\r\n-{\r\n-\tappend(init_vals);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename _CharT, typename _Traits>\r\n-constexpr dynamic_bitset<Block, Allocator>::dynamic_bitset(\r\n-  std::basic_string_view<_CharT, _Traits> str,\r\n-  typename std::basic_string_view<_CharT, _Traits>::size_type pos,\r\n-  typename std::basic_string_view<_CharT, _Traits>::size_type n,\r\n-  _CharT zero,\r\n-  _CharT one,\r\n-  const allocator_type& allocator)\r\n-  : m_blocks(allocator), m_bits_number(0)\r\n-{\r\n-\tassert(pos < str.size());\r\n-\tinit_from_string(str, pos, n, zero, one);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename _CharT, typename _Traits, typename _Alloc>\r\n-constexpr dynamic_bitset<Block, Allocator>::dynamic_bitset(\r\n-  const std::basic_string<_CharT, _Traits, _Alloc>& str,\r\n-  typename std::basic_string<_CharT, _Traits, _Alloc>::size_type pos,\r\n-  typename std::basic_string<_CharT, _Traits, _Alloc>::size_type n,\r\n-  _CharT zero,\r\n-  _CharT one,\r\n-  const allocator_type& allocator)\r\n-  : m_blocks(allocator), m_bits_number(0)\r\n-{\r\n-\tassert(pos < str.size());\r\n-\tinit_from_string(std::basic_string_view<_CharT, _Traits>(str), pos, n, zero, one);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename _CharT>\r\n-constexpr dynamic_bitset<Block, Allocator>::dynamic_bitset(\r\n-  const _CharT* str,\r\n-  typename std::basic_string<_CharT>::size_type pos,\r\n-  typename std::basic_string<_CharT>::size_type n,\r\n-  _CharT zero,\r\n-  _CharT one,\r\n-  const allocator_type& allocator)\r\n-  : m_blocks(allocator), m_bits_number(0)\r\n-{\r\n-\tinit_from_string(std::basic_string_view<_CharT>(str), pos, n, zero, one);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::resize(size_type nbits, bool value)\r\n-{\r\n-\tif(nbits == m_bits_number)\r\n-\t{\r\n-\t\treturn;\r\n-\t}\r\n-\r\n-\tconst size_type old_num_blocks = num_blocks();\r\n-\tconst size_type new_num_blocks = blocks_required(nbits);\r\n-\r\n-\tconst block_type init_value = value ? one_block : zero_block;\r\n-\tif(new_num_blocks != old_num_blocks)\r\n-\t{\r\n-\t\tm_blocks.resize(new_num_blocks, init_value);\r\n-\t}\r\n-\r\n-\tif(value && nbits > m_bits_number && old_num_blocks > 0)\r\n-\t{\r\n-\t\t// set value of the new bits in the old last block\r\n-\t\tconst size_type extra_bits = extra_bits_number();\r\n-\t\tif(extra_bits > 0)\r\n-\t\t{\r\n-\t\t\tm_blocks[old_num_blocks - 1] |= (init_value << extra_bits);\r\n-\t\t}\r\n-\t}\r\n-\r\n-\tm_bits_number = nbits;\r\n-\tsanitize();\r\n-\tassert(check_consistency());\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::clear()\r\n-{\r\n-\tm_blocks.clear();\r\n-\tm_bits_number = 0;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::push_back(bool value)\r\n-{\r\n-\tconst size_type new_last_bit = m_bits_number++;\r\n-\tif(m_bits_number <= m_blocks.size() * bits_per_block)\r\n-\t{\r\n-\t\tif(value)\r\n-\t\t{\r\n-\t\t\tset(new_last_bit, value);\r\n-\t\t}\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tm_blocks.push_back(block_type(value));\r\n-\t}\r\n-\tassert(operator[](new_last_bit) == value);\r\n-\tassert(check_consistency());\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::pop_back()\r\n-{\r\n-\tif(empty())\r\n-\t{\r\n-\t\treturn;\r\n-\t}\r\n-\r\n-\t--m_bits_number;\r\n-\tif(m_blocks.size() > blocks_required(m_bits_number))\r\n-\t{\r\n-\t\tm_blocks.pop_back();\r\n-\t\t// no extra bits: sanitize not required\r\n-\t\tassert(extra_bits_number() == 0);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tsanitize();\r\n-\t}\r\n-\tassert(check_consistency());\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::append(block_type block)\r\n-{\r\n-\tconst size_type extra_bits = extra_bits_number();\r\n-\tif(extra_bits == 0)\r\n-\t{\r\n-\t\tm_blocks.push_back(block);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tlast_block() |= (block << extra_bits);\r\n-\t\tm_blocks.push_back(block_type(block >> (bits_per_block - extra_bits)));\r\n-\t}\r\n-\r\n-\tm_bits_number += bits_per_block;\r\n-\tassert(check_consistency());\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::append(std::initializer_list<block_type> blocks)\r\n-{\r\n-\tif(blocks.size() == 0)\r\n-\t{\r\n-\t\treturn;\r\n-\t}\r\n-\r\n-\tappend(std::cbegin(blocks), std::cend(blocks));\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename BlockInputIterator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::append(BlockInputIterator first,\r\n-                                                        BlockInputIterator last)\r\n-{\r\n-\tif(first == last)\r\n-\t{\r\n-\t\treturn;\r\n-\t}\r\n-\r\n-\t// if random access iterators, std::distance complexity is constant\r\n-\tif constexpr(std::is_same_v<\r\n-\t               typename std::iterator_traits<BlockInputIterator>::iterator_category,\r\n-\t               std::random_access_iterator_tag>)\r\n-\t{\r\n-\t\tassert(std::distance(first, last) > 0);\r\n-\t\tm_blocks.reserve(m_blocks.size() + static_cast<size_type>(std::distance(first, last)));\r\n-\t}\r\n-\r\n-\tconst size_type extra_bits = extra_bits_number();\r\n-\tconst size_type unused_bits = unused_bits_number();\r\n-\tif(extra_bits == 0)\r\n-\t{\r\n-\t\tauto pos = m_blocks.insert(std::end(m_blocks), first, last);\r\n-\t\tassert(std::distance(pos, std::end(m_blocks)) > 0);\r\n-\t\tm_bits_number +=\r\n-\t\t  static_cast<size_type>(std::distance(pos, std::end(m_blocks))) * bits_per_block;\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tlast_block() |= (*first << extra_bits);\r\n-\t\tblock_type block = block_type(*first >> unused_bits);\r\n-\t\t++first;\r\n-\t\twhile(first != last)\r\n-\t\t{\r\n-\t\t\tblock |= (*first << extra_bits);\r\n-\t\t\tm_blocks.push_back(block);\r\n-\t\t\tm_bits_number += bits_per_block;\r\n-\t\t\tblock = block_type(*first >> unused_bits);\r\n-\t\t\t++first;\r\n-\t\t}\r\n-\t\tm_blocks.push_back(block);\r\n-\t\tm_bits_number += bits_per_block;\r\n-\t}\r\n-\r\n-\tassert(check_consistency());\r\n-}\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::operator&=(\r\n-  const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tassert(size() == rhs.size());\r\n-\t//apply(rhs, std::bit_and());\r\n-\tfor(size_type i = 0; i < m_blocks.size(); ++i)\r\n-\t{\r\n-\t\tm_blocks[i] &= rhs.m_blocks[i];\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::operator|=(\r\n-  const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tassert(size() == rhs.size());\r\n-\t//apply(rhs, std::bit_or());\r\n-\tfor(size_type i = 0; i < m_blocks.size(); ++i)\r\n-\t{\r\n-\t\tm_blocks[i] |= rhs.m_blocks[i];\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::operator^=(\r\n-  const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tassert(size() == rhs.size());\r\n-\t//apply(rhs, std::bit_xor());\r\n-\tfor(size_type i = 0; i < m_blocks.size(); ++i)\r\n-\t{\r\n-\t\tm_blocks[i] ^= rhs.m_blocks[i];\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::operator-=(\r\n-  const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tassert(size() == rhs.size());\r\n-\t//apply(rhs, [](const block_type& x, const block_type& y) { return (x & ~y); });\r\n-\tfor(size_type i = 0; i < m_blocks.size(); ++i)\r\n-\t{\r\n-\t\tm_blocks[i] &= ~rhs.m_blocks[i];\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::operator<<=(\r\n-  size_type shift)\r\n-{\r\n-\tif(shift != 0)\r\n-\t{\r\n-\t\tif(shift >= m_bits_number)\r\n-\t\t{\r\n-\t\t\treset();\r\n-\t\t}\r\n-\t\telse\r\n-\t\t{\r\n-\t\t\tapply_left_shift(shift);\r\n-\t\t\tsanitize(); // unused bits can have changed, reset them to 0\r\n-\t\t}\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::operator>>=(\r\n-  size_type shift)\r\n-{\r\n-\tif(shift != 0)\r\n-\t{\r\n-\t\tif(shift >= m_bits_number)\r\n-\t\t{\r\n-\t\t\treset();\r\n-\t\t}\r\n-\t\telse\r\n-\t\t{\r\n-\t\t\tapply_right_shift(shift);\r\n-\t\t}\r\n-\t}\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> dynamic_bitset<Block, Allocator>::operator<<(\r\n-  size_type shift) const\r\n-{\r\n-\treturn dynamic_bitset<Block, Allocator>(*this) <<= shift;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> dynamic_bitset<Block, Allocator>::operator>>(\r\n-  size_type shift) const\r\n-{\r\n-\treturn dynamic_bitset<Block, Allocator>(*this) >>= shift;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> dynamic_bitset<Block, Allocator>::operator~() const\r\n-{\r\n-\tdynamic_bitset<Block, Allocator> bitset(*this);\r\n-\tbitset.flip();\r\n-\treturn bitset;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::set(size_type pos,\r\n-                                                                                  size_type len,\r\n-                                                                                  bool value)\r\n-{\r\n-\tassert(pos < size());\r\n-\tassert(pos + len - 1 < size());\r\n-\tif(len == 0)\r\n-\t{\r\n-\t\treturn *this;\r\n-\t}\r\n-\r\n-\tconst size_type first_block = block_index(pos);\r\n-\tconst size_type last_block = block_index(pos + len - 1);\r\n-\tconst size_type first_bit_index = bit_index(pos);\r\n-\tconst size_type last_bit_index = bit_index(pos + len - 1);\r\n-\r\n-\tif(first_block == last_block)\r\n-\t{\r\n-\t\tset_block_bits(m_blocks[first_block], first_bit_index, last_bit_index, value);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tsize_type first_full_block = first_block;\r\n-\t\tsize_type last_full_block = last_block;\r\n-\r\n-\t\tif(first_bit_index != 0)\r\n-\t\t{\r\n-\t\t\t++first_full_block; // first block is not full\r\n-\t\t\tset_block_bits(m_blocks[first_block], first_bit_index, block_last_bit_index, value);\r\n-\t\t}\r\n-\r\n-\t\tif(last_bit_index != block_last_bit_index)\r\n-\t\t{\r\n-\t\t\t--last_full_block; // last block is not full\r\n-\t\t\tset_block_bits(m_blocks[last_block], 0, last_bit_index, value);\r\n-\t\t}\r\n-\r\n-\t\tconst block_type full_block = value ? one_block : zero_block;\r\n-\t\tfor(size_type i = first_full_block; i <= last_full_block; ++i)\r\n-\t\t{\r\n-\t\t\tm_blocks[i] = full_block;\r\n-\t\t}\r\n-\t}\r\n-\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::set(size_type pos,\r\n-                                                                                  bool value)\r\n-{\r\n-\tassert(pos < size());\r\n-\r\n-\tif(value)\r\n-\t{\r\n-\t\tm_blocks[block_index(pos)] |= bit_mask(pos);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tm_blocks[block_index(pos)] &= ~bit_mask(pos);\r\n-\t}\r\n-\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::set()\r\n-{\r\n-\tstd::fill(std::begin(m_blocks), std::end(m_blocks), one_block);\r\n-\tsanitize();\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::reset(size_type pos,\r\n-                                                                                    size_type len)\r\n-{\r\n-\treturn set(pos, len, false);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::reset(size_type pos)\r\n-{\r\n-\treturn set(pos, false);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::reset()\r\n-{\r\n-\tstd::fill(std::begin(m_blocks), std::end(m_blocks), zero_block);\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::flip(size_type pos,\r\n-                                                                                   size_type len)\r\n-{\r\n-\tassert(pos < size());\r\n-\tassert(pos + len - 1 < size());\r\n-\tif(len == 0)\r\n-\t{\r\n-\t\treturn *this;\r\n-\t}\r\n-\r\n-\tconst size_type first_block = block_index(pos);\r\n-\tconst size_type last_block = block_index(pos + len - 1);\r\n-\tconst size_type first_bit_index = bit_index(pos);\r\n-\tconst size_type last_bit_index = bit_index(pos + len - 1);\r\n-\r\n-\tif(first_block == last_block)\r\n-\t{\r\n-\t\tflip_block_bits(m_blocks[first_block], first_bit_index, last_bit_index);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tsize_type first_full_block = first_block;\r\n-\t\tsize_type last_full_block = last_block;\r\n-\r\n-\t\tif(first_bit_index != 0)\r\n-\t\t{\r\n-\t\t\t++first_full_block; // first block is not full\r\n-\t\t\tflip_block_bits(m_blocks[first_block], first_bit_index, block_last_bit_index);\r\n-\t\t}\r\n-\r\n-\t\tif(last_bit_index != block_last_bit_index)\r\n-\t\t{\r\n-\t\t\t--last_full_block; // last block is not full\r\n-\t\t\tflip_block_bits(m_blocks[last_block], 0, last_bit_index);\r\n-\t\t}\r\n-\r\n-\t\tfor(size_type i = first_full_block; i <= last_full_block; ++i)\r\n-\t\t{\r\n-\t\t\tm_blocks[i] = block_type(~m_blocks[i]);\r\n-\t\t}\r\n-\t}\r\n-\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::flip(size_type pos)\r\n-{\r\n-\tassert(pos < size());\r\n-\tm_blocks[block_index(pos)] ^= bit_mask(pos);\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator>& dynamic_bitset<Block, Allocator>::flip()\r\n-{\r\n-\tstd::transform(\r\n-\t  std::cbegin(m_blocks), std::cend(m_blocks), std::begin(m_blocks), std::bit_not<block_type>());\r\n-\tsanitize();\r\n-\treturn *this;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::test(size_type pos) const\r\n-{\r\n-\tassert(pos < size());\r\n-\treturn (m_blocks[block_index(pos)] & bit_mask(pos)) != zero_block;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::test_set(size_type pos, bool value)\r\n-{\r\n-\tbool const result = test(pos);\r\n-\tif(result != value)\r\n-\t{\r\n-\t\tset(pos, value);\r\n-\t}\r\n-\treturn result;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::all() const\r\n-{\r\n-\tif(empty())\r\n-\t{\r\n-\t\treturn true;\r\n-\t}\r\n-\r\n-\tconst block_type full_block = one_block;\r\n-\tif(extra_bits_number() == 0)\r\n-\t{\r\n-\t\tfor(const block_type& block: m_blocks)\r\n-\t\t{\r\n-\t\t\tif(block != full_block)\r\n-\t\t\t{\r\n-\t\t\t\treturn false;\r\n-\t\t\t}\r\n-\t\t}\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tfor(size_type i = 0; i < m_blocks.size() - 1; ++i)\r\n-\t\t{\r\n-\t\t\tif(m_blocks[i] != full_block)\r\n-\t\t\t{\r\n-\t\t\t\treturn false;\r\n-\t\t\t}\r\n-\t\t}\r\n-\t\tif(last_block() != (full_block >> unused_bits_number()))\r\n-\t\t{\r\n-\t\t\treturn false;\r\n-\t\t}\r\n-\t}\r\n-\treturn true;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::any() const\r\n-{\r\n-\tfor(const block_type& block: m_blocks)\r\n-\t{\r\n-\t\tif(block != zero_block)\r\n-\t\t{\r\n-\t\t\treturn true;\r\n-\t\t}\r\n-\t}\r\n-\treturn false;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::none() const\r\n-{\r\n-\treturn !any();\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block,\r\n-                                                                              Allocator>::count()\r\n-  const noexcept\r\n-{\r\n-\tif(empty())\r\n-\t{\r\n-\t\treturn 0;\r\n-\t}\r\n-\r\n-#ifdef DYNAMIC_BITSET_USE_LIBPOPCNT\r\n-\tconst size_type count =\r\n-\t  static_cast<size_type>(popcnt(m_blocks.data(), m_blocks.size() * sizeof(block_type)));\r\n-#else\r\n-\tsize_type count = 0;\r\n-\r\n-\t// full blocks\r\n-\tfor(size_type i = 0; i < m_blocks.size() - 1; ++i)\r\n-\t{\r\n-\t\tcount += block_count(m_blocks[i]);\r\n-\t}\r\n-\r\n-\t// last block\r\n-\tconst block_type& block = last_block();\r\n-\tif(block != zero_block)\r\n-\t{\r\n-\t\tconst size_t extra_bits = extra_bits_number();\r\n-\t\tif(extra_bits == 0)\r\n-\t\t{\r\n-\t\t\tcount += block_count(block);\r\n-\t\t}\r\n-\t\telse\r\n-\t\t{\r\n-\t\t\tcount += block_count(block, extra_bits);\r\n-\t\t}\r\n-\t}\r\n-#endif\r\n-\treturn count;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr\r\n-  typename dynamic_bitset<Block, Allocator>::reference dynamic_bitset<Block, Allocator>::operator[](\r\n-    size_type pos)\r\n-{\r\n-\tassert(pos < size());\r\n-\treturn dynamic_bitset<Block, Allocator>::reference(*this, pos);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::\r\n-  const_reference dynamic_bitset<Block, Allocator>::operator[](size_type pos) const\r\n-{\r\n-\treturn test(pos);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block,\r\n-                                                                              Allocator>::size()\r\n-  const noexcept\r\n-{\r\n-\treturn m_bits_number;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  num_blocks() const noexcept\r\n-{\r\n-\treturn m_blocks.size();\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::empty() const noexcept\r\n-{\r\n-\treturn size() == 0;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block,\r\n-                                                                              Allocator>::capacity()\r\n-  const noexcept\r\n-{\r\n-\treturn m_blocks.capacity() * bits_per_block;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::reserve(size_type num_bits)\r\n-{\r\n-\tm_blocks.reserve(blocks_required(num_bits));\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::shrink_to_fit()\r\n-{\r\n-\tm_blocks.shrink_to_fit();\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::is_subset_of(\r\n-  const dynamic_bitset<Block, Allocator>& bitset) const\r\n-{\r\n-\tassert(size() == bitset.size());\r\n-\tfor(size_type i = 0; i < m_blocks.size(); ++i)\r\n-\t{\r\n-\t\tif((m_blocks[i] & ~bitset.m_blocks[i]) != zero_block)\r\n-\t\t{\r\n-\t\t\treturn false;\r\n-\t\t}\r\n-\t}\r\n-\treturn true;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::is_proper_subset_of(\r\n-  const dynamic_bitset<Block, Allocator>& bitset) const\r\n-{\r\n-\tassert(size() == bitset.size());\r\n-\tbool is_proper = false;\r\n-\tfor(size_type i = 0; i < m_blocks.size(); ++i)\r\n-\t{\r\n-\t\tconst block_type& self_block = m_blocks[i];\r\n-\t\tconst block_type& other_block = bitset.m_blocks[i];\r\n-\r\n-\t\tif((self_block & ~other_block) != zero_block)\r\n-\t\t{\r\n-\t\t\treturn false;\r\n-\t\t}\r\n-\t\tif((~self_block & other_block) != zero_block)\r\n-\t\t{\r\n-\t\t\tis_proper = true;\r\n-\t\t}\r\n-\t}\r\n-\treturn is_proper;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::intersects(\r\n-  const dynamic_bitset<Block, Allocator>& bitset) const\r\n-{\r\n-\tconst size_type min_blocks_number = std::min(m_blocks.size(), bitset.m_blocks.size());\r\n-\tfor(size_type i = 0; i < min_blocks_number; ++i)\r\n-\t{\r\n-\t\tif((m_blocks[i] & bitset.m_blocks[i]) != zero_block)\r\n-\t\t{\r\n-\t\t\treturn true;\r\n-\t\t}\r\n-\t}\r\n-\treturn false;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  find_first() const\r\n-{\r\n-\tfor(size_type i = 0; i < m_blocks.size(); ++i)\r\n-\t{\r\n-\t\tif(m_blocks[i] != zero_block)\r\n-\t\t{\r\n-\t\t\treturn i * bits_per_block + first_on(m_blocks[i]);\r\n-\t\t}\r\n-\t}\r\n-\treturn npos;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  find_next(size_type prev) const\r\n-{\r\n-\tif(empty() || prev >= (size() - 1))\r\n-\t{\r\n-\t\treturn npos;\r\n-\t}\r\n-\r\n-\tconst size_type first_bit = prev + 1;\r\n-\tconst size_type first_block = block_index(first_bit);\r\n-\tconst size_type first_bit_index = bit_index(first_bit);\r\n-\tconst block_type first_block_shifted = block_type(m_blocks[first_block] >> first_bit_index);\r\n-\r\n-\tif(first_block_shifted != zero_block)\r\n-\t{\r\n-\t\treturn first_bit + first_on(first_block_shifted);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tfor(size_type i = first_block + 1; i < m_blocks.size(); ++i)\r\n-\t\t{\r\n-\t\t\tif(m_blocks[i] != zero_block)\r\n-\t\t\t{\r\n-\t\t\t\treturn i * bits_per_block + first_on(m_blocks[i]);\r\n-\t\t\t}\r\n-\t\t}\r\n-\t}\r\n-\treturn npos;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::swap(dynamic_bitset<Block, Allocator>& other)\r\n-{\r\n-\tstd::swap(m_blocks, other.m_blocks);\r\n-\tstd::swap(m_bits_number, other.m_bits_number);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::allocator_type dynamic_bitset<\r\n-  Block,\r\n-  Allocator>::get_allocator() const\r\n-{\r\n-\treturn m_blocks.get_allocator();\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename _CharT, typename _Traits, typename _Alloc>\r\n-constexpr std::basic_string<_CharT, _Traits, _Alloc> dynamic_bitset<Block, Allocator>::to_string(\r\n-  _CharT zero,\r\n-  _CharT one) const\r\n-{\r\n-\tconst size_type len = size();\r\n-\tstd::basic_string<_CharT, _Traits, _Alloc> str(len, zero);\r\n-\tfor(size_type i_block = 0; i_block < m_blocks.size(); ++i_block)\r\n-\t{\r\n-\t\tif(m_blocks[i_block] == zero_block)\r\n-\t\t{\r\n-\t\t\tcontinue;\r\n-\t\t}\r\n-\t\tblock_type mask = block_type(1);\r\n-\t\tconst size_type limit =\r\n-\t\t  i_block * bits_per_block < len ? len - i_block * bits_per_block : bits_per_block;\r\n-\t\tfor(size_type i_bit = 0; i_bit < limit; ++i_bit)\r\n-\t\t{\r\n-\t\t\tif((m_blocks[i_block] & mask) != zero_block)\r\n-\t\t\t{\r\n-\t\t\t\t_Traits::assign(str[len - (i_block * bits_per_block + i_bit + 1)], one);\r\n-\t\t\t}\r\n-\t\t\tmask <<= 1;\r\n-\t\t}\r\n-\t}\r\n-\treturn str;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename Function, typename... Parameters>\r\n-constexpr void dynamic_bitset<Block, Allocator>::iterate_bits_on(Function&& function,\r\n-                                                                 Parameters&&... parameters) const\r\n-{\r\n-\tif constexpr(!std::is_invocable_v<Function, size_t, Parameters...>)\r\n-\t{\r\n-\t\tstatic_assert(dependent_false<Function>::value, \"Function take invalid arguments\");\r\n-\t\t// function should take (size_t, parameters...) as arguments\r\n-\t}\r\n-\r\n-\tif constexpr(std::is_same_v<std::invoke_result_t<Function, size_t, Parameters...>, void>)\r\n-\t{\r\n-\t\tsize_t i_bit = find_first();\r\n-\t\twhile(i_bit != npos)\r\n-\t\t{\r\n-\t\t\tstd::invoke(\r\n-\t\t\t  std::forward<Function>(function), i_bit, std::forward<Parameters>(parameters)...);\r\n-\t\t\ti_bit = find_next(i_bit);\r\n-\t\t}\r\n-\t}\r\n-\telse if constexpr(std::is_convertible_v<std::invoke_result_t<Function, size_t, Parameters...>,\r\n-\t                                        bool>)\r\n-\t{\r\n-\t\tsize_t i_bit = find_first();\r\n-\t\twhile(i_bit != npos)\r\n-\t\t{\r\n-\t\t\tif(!std::invoke(\r\n-\t\t\t     std::forward<Function>(function), i_bit, std::forward<Parameters>(parameters)...))\r\n-\t\t\t{\r\n-\t\t\t\tbreak;\r\n-\t\t\t}\r\n-\t\t\ti_bit = find_next(i_bit);\r\n-\t\t}\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tstatic_assert(dependent_false<Function>::value, \"Function have invalid return type\");\r\n-\t\t// return type should be void, or convertible to bool\r\n-\t}\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-[[nodiscard]] constexpr bool operator==(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                        const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\treturn (lhs.m_bits_number == rhs.m_bits_number) && (lhs.m_blocks == rhs.m_blocks);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-[[nodiscard]] constexpr bool operator<(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                       const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tusing size_type = typename dynamic_bitset<Block, Allocator>::size_type;\r\n-\tusing block_type = typename dynamic_bitset<Block, Allocator>::block_type;\r\n-\tconst size_type lhs_size = lhs.size();\r\n-\tconst size_type rhs_size = rhs.size();\r\n-\tconst size_type lhs_blocks_size = lhs.m_blocks.size();\r\n-\tconst size_type rhs_blocks_size = rhs.m_blocks.size();\r\n-\r\n-\tif(lhs_size == rhs_size)\r\n-\t{\r\n-\t\t// if comparison of two empty bitsets\r\n-\t\tif(lhs_size == 0)\r\n-\t\t{\r\n-\t\t\treturn false;\r\n-\t\t}\r\n-\r\n-\t\tfor(size_type i = lhs_blocks_size - 1; i > 0; --i)\r\n-\t\t{\r\n-\t\t\tif(lhs.m_blocks[i] != rhs.m_blocks[i])\r\n-\t\t\t{\r\n-\t\t\t\treturn lhs.m_blocks[i] < rhs.m_blocks[i];\r\n-\t\t\t}\r\n-\t\t}\r\n-\t\treturn lhs.m_blocks[0] < rhs.m_blocks[0];\r\n-\t}\r\n-\r\n-\t// empty bitset inferior to 0-only bitset\r\n-\tif(lhs_size == 0)\r\n-\t{\r\n-\t\treturn true;\r\n-\t}\r\n-\tif(rhs_size == 0)\r\n-\t{\r\n-\t\treturn false;\r\n-\t}\r\n-\r\n-\tconst bool rhs_longer = rhs_size > lhs_size;\r\n-\tconst dynamic_bitset<Block, Allocator>& longest_bitset = rhs_longer ? rhs : lhs;\r\n-\tconst size_type longest_blocks_size = std::max(lhs_blocks_size, rhs_blocks_size);\r\n-\tconst size_type shortest_blocks_size = std::min(lhs_blocks_size, rhs_blocks_size);\r\n-\tfor(size_type i = longest_blocks_size - 1; i >= shortest_blocks_size; --i)\r\n-\t{\r\n-\t\tif(longest_bitset.m_blocks[i] != block_type(0))\r\n-\t\t{\r\n-\t\t\treturn rhs_longer;\r\n-\t\t}\r\n-\t}\r\n-\r\n-\tfor(size_type i = shortest_blocks_size - 1; i > 0; --i)\r\n-\t{\r\n-\t\tif(lhs.m_blocks[i] != rhs.m_blocks[i])\r\n-\t\t{\r\n-\t\t\treturn lhs.m_blocks[i] < rhs.m_blocks[i];\r\n-\t\t}\r\n-\t}\r\n-\tif(lhs.m_blocks[0] != rhs.m_blocks[0])\r\n-\t{\r\n-\t\treturn lhs.m_blocks[0] < rhs.m_blocks[0];\r\n-\t}\r\n-\treturn lhs_size < rhs_size;\r\n-}\r\n-\r\n-//=================================================================================================\r\n-// dynamic_bitset private functions implementations\r\n-//=================================================================================================\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  blocks_required(size_type nbits) noexcept\r\n-{\r\n-\treturn nbits / bits_per_block + static_cast<size_type>(nbits % bits_per_block > 0);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  block_index(size_type pos) noexcept\r\n-{\r\n-\treturn pos / bits_per_block;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  bit_index(size_type pos) noexcept\r\n-{\r\n-\treturn pos % bits_per_block;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::block_type dynamic_bitset<Block, Allocator>::\r\n-  bit_mask(size_type pos) noexcept\r\n-{\r\n-\treturn block_type(block_type(1) << bit_index(pos));\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::block_type dynamic_bitset<Block, Allocator>::\r\n-  bit_mask(size_type first, size_type last) noexcept\r\n-{\r\n-\tfirst = bit_index(first);\r\n-\tlast = bit_index(last);\r\n-\tif(last == (block_last_bit_index))\r\n-\t{\r\n-\t\treturn block_type(one_block << first);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\treturn block_type(((block_type(1) << (last + 1)) - 1) ^ ((block_type(1) << first) - 1));\r\n-\t}\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::set_block_bits(block_type& block,\r\n-                                                                size_type first,\r\n-                                                                size_type last,\r\n-                                                                bool val) noexcept\r\n-{\r\n-\tif(val)\r\n-\t{\r\n-\t\tblock |= bit_mask(first, last);\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tblock &= ~bit_mask(first, last);\r\n-\t}\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::flip_block_bits(block_type& block,\r\n-                                                                 size_type first,\r\n-                                                                 size_type last) noexcept\r\n-{\r\n-\tblock ^= bit_mask(first, last);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  block_count(const block_type& block) noexcept\r\n-{\r\n-\tif(block == zero_block)\r\n-\t{\r\n-\t\treturn 0;\r\n-\t}\r\n-\r\n-#if defined(DYNAMIC_BITSET_GCC) \\\r\n-  || (defined(DYNAMIC_BITSET_CLANG) && defined(DYNAMIC_BITSET_CLANG_builtin_popcount))\r\n-\tif constexpr(std::is_same_v<block_type, unsigned long long>)\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_popcountll(block));\r\n-\t}\r\n-\tif constexpr(std::is_same_v<block_type, unsigned long>)\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_popcountl(block));\r\n-\t}\r\n-\tif constexpr(sizeof(block_type) <= sizeof(unsigned int))\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_popcount(static_cast<unsigned int>(block)));\r\n-\t}\r\n-#endif\r\n-\r\n-\tsize_type count = 0;\r\n-\tblock_type mask = 1;\r\n-\tfor(size_type bit_index = 0; bit_index < bits_per_block; ++bit_index)\r\n-\t{\r\n-\t\tcount += ((block & mask) != zero_block);\r\n-\t\tmask <<= 1;\r\n-\t}\r\n-\treturn count;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  block_count(const block_type& block, size_type nbits) noexcept\r\n-{\r\n-\tassert(nbits <= bits_per_block);\r\n-\tif(block == zero_block)\r\n-\t{\r\n-\t\treturn 0;\r\n-\t}\r\n-\r\n-#if defined(DYNAMIC_BITSET_GCC) \\\r\n-  || (defined(DYNAMIC_BITSET_CLANG) && defined(DYNAMIC_BITSET_CLANG_builtin_popcount))\r\n-\tconst block_type shifted_block = block_type(block << (bits_per_block - nbits));\r\n-\tif constexpr(std::is_same_v<block_type, unsigned long long>)\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_popcountll(shifted_block));\r\n-\t}\r\n-\tif constexpr(std::is_same_v<block_type, unsigned long>)\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_popcountl(shifted_block));\r\n-\t}\r\n-\tif constexpr(sizeof(block_type) <= sizeof(unsigned int))\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_popcount(static_cast<unsigned int>(shifted_block)));\r\n-\t}\r\n-#endif\r\n-\r\n-\tsize_type count = 0;\r\n-\tblock_type mask = 1;\r\n-\tfor(size_type bit_index = 0; bit_index < nbits; ++bit_index)\r\n-\t{\r\n-\t\tcount += ((block & mask) != zero_block);\r\n-\t\tmask <<= 1;\r\n-\t}\r\n-\r\n-\treturn count;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  first_on(const block_type& block) noexcept\r\n-{\r\n-\tassert(block != zero_block);\r\n-\r\n-#if defined(DYNAMIC_BITSET_GCC) \\\r\n-  || (defined(DYNAMIC_BITSET_CLANG) && defined(DYNAMIC_BITSET_CLANG_builtin_ctz))\r\n-\tif constexpr(std::is_same_v<block_type, unsigned long long>)\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_ctzll(block));\r\n-\t}\r\n-\tif constexpr(std::is_same_v<block_type, unsigned long>)\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_ctzl(block));\r\n-\t}\r\n-\tif constexpr(sizeof(block_type) <= sizeof(unsigned int))\r\n-\t{\r\n-\t\treturn static_cast<size_type>(__builtin_ctz(static_cast<unsigned int>(block)));\r\n-\t}\r\n-#elif defined(DYNAMIC_BITSET_MSVC)\r\n-#\tif defined(DYNAMIC_BITSET_MSVC_64)\r\n-\tif constexpr(std::is_same_v<block_type, unsigned __int64>)\r\n-\t{\r\n-\t\tunsigned long index = std::numeric_limits<unsigned long>::max();\r\n-\t\t_BitScanForward64(&index, block);\r\n-\t\treturn static_cast<size_type>(index);\r\n-\t}\r\n-#\tendif\r\n-\tif constexpr(std::is_same_v<block_type, unsigned long>)\r\n-\t{\r\n-\t\tunsigned long index = std::numeric_limits<unsigned long>::max();\r\n-\t\t_BitScanForward(&index, block);\r\n-\t\treturn static_cast<size_type>(index);\r\n-\t}\r\n-\tif constexpr(sizeof(block_type) <= sizeof(unsigned long))\r\n-\t{\r\n-\t\tunsigned long index = std::numeric_limits<unsigned long>::max();\r\n-\t\t_BitScanForward(&index, static_cast<unsigned long>(block));\r\n-\t\treturn static_cast<size_type>(index);\r\n-\t}\r\n-#endif\r\n-\r\n-\tblock_type mask = block_type(1);\r\n-\tfor(size_type i = 0; i < bits_per_block; ++i)\r\n-\t{\r\n-\t\tif((block & mask) != zero_block)\r\n-\t\t{\r\n-\t\t\treturn i;\r\n-\t\t}\r\n-\t\tmask <<= 1;\r\n-\t}\r\n-\treturn npos;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename _CharT, typename _Traits>\r\n-constexpr void dynamic_bitset<Block, Allocator>::init_from_string(\r\n-  std::basic_string_view<_CharT, _Traits> str,\r\n-  typename std::basic_string_view<_CharT, _Traits>::size_type pos,\r\n-  typename std::basic_string_view<_CharT, _Traits>::size_type n,\r\n-  [[maybe_unused]] _CharT zero,\r\n-  _CharT one)\r\n-{\r\n-\tassert(pos < str.size());\r\n-\r\n-\tconst size_type size = std::min(n, str.size() - pos);\r\n-\tm_bits_number = size;\r\n-\r\n-\tm_blocks.clear();\r\n-\tm_blocks.resize(blocks_required(size));\r\n-\tfor(size_t i = 0; i < size; ++i)\r\n-\t{\r\n-\t\tconst _CharT c = str[(pos + size - 1) - i];\r\n-\t\tassert(c == zero || c == one);\r\n-\t\tif(c == one)\r\n-\t\t{\r\n-\t\t\tset(i);\r\n-\t\t}\r\n-\t}\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::block_type& dynamic_bitset<Block, Allocator>::\r\n-  get_block(size_type pos)\r\n-{\r\n-\treturn m_blocks[block_index(pos)];\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr const typename dynamic_bitset<Block, Allocator>::block_type& dynamic_bitset<\r\n-  Block,\r\n-  Allocator>::get_block(size_type pos) const\r\n-{\r\n-\treturn m_blocks[block_index(pos)];\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::block_type& dynamic_bitset<Block, Allocator>::\r\n-  last_block()\r\n-{\r\n-\treturn m_blocks[m_blocks.size() - 1];\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::block_type dynamic_bitset<Block, Allocator>::\r\n-  last_block() const\r\n-{\r\n-\treturn m_blocks[m_blocks.size() - 1];\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  extra_bits_number() const noexcept\r\n-{\r\n-\treturn bit_index(m_bits_number);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr typename dynamic_bitset<Block, Allocator>::size_type dynamic_bitset<Block, Allocator>::\r\n-  unused_bits_number() const noexcept\r\n-{\r\n-\treturn bits_per_block - extra_bits_number();\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename BinaryOperation>\r\n-constexpr void dynamic_bitset<Block, Allocator>::apply(\r\n-  const dynamic_bitset<Block, Allocator>& other,\r\n-  BinaryOperation binary_op)\r\n-{\r\n-\tassert(num_blocks() == other.num_blocks());\r\n-\tstd::transform(std::cbegin(m_blocks),\r\n-\t               std::cend(m_blocks),\r\n-\t               std::cbegin(other.m_blocks),\r\n-\t               std::begin(m_blocks),\r\n-\t               binary_op);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-template<typename UnaryOperation>\r\n-constexpr void dynamic_bitset<Block, Allocator>::apply(UnaryOperation unary_op)\r\n-{\r\n-\tstd::transform(std::cbegin(m_blocks), std::cend(m_blocks), std::begin(m_blocks), unary_op);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::apply_left_shift(size_type shift)\r\n-{\r\n-\tassert(shift > 0);\r\n-\tassert(shift < capacity());\r\n-\r\n-\tconst size_type blocks_shift = shift / bits_per_block;\r\n-\tconst size_type bits_offset = shift % bits_per_block;\r\n-\r\n-\tif(bits_offset == 0)\r\n-\t{\r\n-\t\tfor(size_type i = m_blocks.size() - 1; i >= blocks_shift; --i)\r\n-\t\t{\r\n-\t\t\tm_blocks[i] = m_blocks[i - blocks_shift];\r\n-\t\t}\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tconst size_type reverse_bits_offset = bits_per_block - bits_offset;\r\n-\t\tfor(size_type i = m_blocks.size() - 1; i > blocks_shift; --i)\r\n-\t\t{\r\n-\t\t\tm_blocks[i] =\r\n-\t\t\t  block_type((m_blocks[i - blocks_shift] << bits_offset)\r\n-\t\t\t             | block_type(m_blocks[i - blocks_shift - 1] >> reverse_bits_offset));\r\n-\t\t}\r\n-\t\tm_blocks[blocks_shift] = block_type(m_blocks[0] << bits_offset);\r\n-\t}\r\n-\r\n-\t// set bit that came at the right to 0 in unmodified blocks\r\n-\tstd::fill(std::begin(m_blocks),\r\n-\t          std::begin(m_blocks)\r\n-\t            + static_cast<typename decltype(m_blocks)::difference_type>(blocks_shift),\r\n-\t          zero_block);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::apply_right_shift(size_type shift)\r\n-{\r\n-\tassert(shift > 0);\r\n-\tassert(shift < capacity());\r\n-\r\n-\tconst size_type blocks_shift = shift / bits_per_block;\r\n-\tconst size_type bits_offset = shift % bits_per_block;\r\n-\tconst size_type last_block_to_shift = m_blocks.size() - blocks_shift - 1;\r\n-\r\n-\tif(bits_offset == 0)\r\n-\t{\r\n-\t\tfor(size_type i = 0; i <= last_block_to_shift; ++i)\r\n-\t\t{\r\n-\t\t\tm_blocks[i] = m_blocks[i + blocks_shift];\r\n-\t\t}\r\n-\t}\r\n-\telse\r\n-\t{\r\n-\t\tconst size_type reverse_bits_offset = bits_per_block - bits_offset;\r\n-\t\tfor(size_type i = 0; i < last_block_to_shift; ++i)\r\n-\t\t{\r\n-\t\t\tm_blocks[i] =\r\n-\t\t\t  block_type((m_blocks[i + blocks_shift] >> bits_offset)\r\n-\t\t\t             | block_type(m_blocks[i + blocks_shift + 1] << reverse_bits_offset));\r\n-\t\t}\r\n-\t\tm_blocks[last_block_to_shift] = block_type(m_blocks[m_blocks.size() - 1] >> bits_offset);\r\n-\t}\r\n-\r\n-\t// set bit that came at the left to 0 in unmodified blocks\r\n-\tstd::fill(\r\n-\t  std::begin(m_blocks)\r\n-\t    + static_cast<typename decltype(m_blocks)::difference_type>(last_block_to_shift + 1),\r\n-\t  std::end(m_blocks),\r\n-\t  zero_block);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void dynamic_bitset<Block, Allocator>::sanitize()\r\n-{\r\n-\tsize_type shift = m_bits_number % bits_per_block;\r\n-\tif(shift > 0)\r\n-\t{\r\n-\t\tlast_block() &= ~(one_block << shift);\r\n-\t}\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::check_unused_bits() const noexcept\r\n-{\r\n-\tconst size_type extra_bits = extra_bits_number();\r\n-\tif(extra_bits > 0)\r\n-\t{\r\n-\t\treturn (last_block() & (one_block << extra_bits)) == zero_block;\r\n-\t}\r\n-\treturn true;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::check_size() const noexcept\r\n-{\r\n-\treturn blocks_required(size()) == m_blocks.size();\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool dynamic_bitset<Block, Allocator>::check_consistency() const noexcept\r\n-{\r\n-\treturn check_unused_bits() && check_size();\r\n-}\r\n-\r\n-//=================================================================================================\r\n-// dynamic_bitset external functions implementations\r\n-//=================================================================================================\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator!=(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                          const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\treturn !(lhs == rhs);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator<=(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                          const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\treturn !(rhs < lhs);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator>(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                         const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\treturn rhs < lhs;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr bool operator>=(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                          const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\treturn !(lhs < rhs);\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator&(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tdynamic_bitset<Block, Allocator> result(lhs);\r\n-\treturn result &= rhs;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator|(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tdynamic_bitset<Block, Allocator> result(lhs);\r\n-\treturn result |= rhs;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator^(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tdynamic_bitset<Block, Allocator> result(lhs);\r\n-\treturn result ^= rhs;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr dynamic_bitset<Block, Allocator> operator-(const dynamic_bitset<Block, Allocator>& lhs,\r\n-                                                     const dynamic_bitset<Block, Allocator>& rhs)\r\n-{\r\n-\tdynamic_bitset<Block, Allocator> result(lhs);\r\n-\treturn result -= rhs;\r\n-}\r\n-\r\n-template<typename _CharT, typename _Traits, typename Block, typename Allocator>\r\n-constexpr std::basic_ostream<_CharT, _Traits>& operator<<(\r\n-  std::basic_ostream<_CharT, _Traits>& os,\r\n-  const dynamic_bitset<Block, Allocator>& bitset)\r\n-{\r\n-\t// A better implementation is possible\r\n-\treturn os << bitset.template to_string<_CharT, _Traits>();\r\n-}\r\n-\r\n-template<typename _CharT, typename _Traits, typename Block, typename Allocator>\r\n-constexpr std::basic_istream<_CharT, _Traits>& operator>>(std::basic_istream<_CharT, _Traits>& is,\r\n-                                                          dynamic_bitset<Block, Allocator>& bitset)\r\n-{\r\n-\t// A better implementation is possible\r\n-\tconstexpr _CharT zero = _CharT('0');\r\n-\tconstexpr _CharT one = _CharT('1');\r\n-\ttypename std::basic_istream<_CharT, _Traits>::sentry s(is);\r\n-\tif(!s)\r\n-\t{\r\n-\t\treturn is;\r\n-\t}\r\n-\r\n-\tdynamic_bitset<Block, Allocator> reverse_bitset;\r\n-\t_CharT val;\r\n-\tis.get(val);\r\n-\twhile(is.good())\r\n-\t{\r\n-\t\tif(val == one)\r\n-\t\t{\r\n-\t\t\treverse_bitset.push_back(true);\r\n-\t\t}\r\n-\t\telse if(val == zero)\r\n-\t\t{\r\n-\t\t\treverse_bitset.push_back(false);\r\n-\t\t}\r\n-\t\telse\r\n-\t\t{\r\n-\t\t\tis.unget();\r\n-\t\t\tbreak;\r\n-\t\t}\r\n-\t\tis.get(val);\r\n-\t}\r\n-\r\n-\tbitset.clear();\r\n-\tif(!reverse_bitset.empty())\r\n-\t{\r\n-\t\tfor(typename dynamic_bitset<Block, Allocator>::size_type i = reverse_bitset.size() - 1;\r\n-\t\t    i > 0;\r\n-\t\t    --i)\r\n-\t\t{\r\n-\t\t\tbitset.push_back(reverse_bitset.test(i));\r\n-\t\t}\r\n-\t\tbitset.push_back(reverse_bitset.test(0));\r\n-\t}\r\n-\r\n-\treturn is;\r\n-}\r\n-\r\n-template<typename Block, typename Allocator>\r\n-constexpr void swap(dynamic_bitset<Block, Allocator>& bitset1,\r\n-                    dynamic_bitset<Block, Allocator>& bitset2)\r\n-{\r\n-\tbitset1.swap(bitset2);\r\n-}\r\n-\r\n-#endif //DYNAMIC_BITSET_DYNAMIC_BITSET_HPP\r\ndiff --git a/oss/libpopcnt/LICENSE b/oss/libpopcnt/LICENSE\ndeleted file mode 100644\nindex 15a721096fb..00000000000\n--- a/oss/libpopcnt/LICENSE\n+++ /dev/null\n@@ -1,26 +0,0 @@\n-BSD 2-Clause License\r\n-\r\n-Copyright (c) 2016 - 2019, Kim Walisch\r\n-Copyright (c) 2016 - 2019, Wojciech Mu\u0142a\r\n-\r\n-All rights reserved.\r\n-\r\n-Redistribution and use in source and binary forms, with or without\r\n-modification, are permitted provided that the following conditions are met:\r\n-\r\n-1. Redistributions of source code must retain the above copyright notice, this\r\n-   list of conditions and the following disclaimer.\r\n-2. Redistributions in binary form must reproduce the above copyright notice,\r\n-   this list of conditions and the following disclaimer in the documentation\r\n-   and/or other materials provided with the distribution.\r\n-\r\n-THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n-ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n-WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n-DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\r\n-ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n-(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n-LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n-ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n-(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n-SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\ndiff --git a/oss/libpopcnt/MAINTAINER_README.md b/oss/libpopcnt/MAINTAINER_README.md\ndeleted file mode 100644\nindex 843a481edbf..00000000000\n--- a/oss/libpopcnt/MAINTAINER_README.md\n+++ /dev/null\n@@ -1,17 +0,0 @@\n-### Notes for Future Maintainers\r\n-\r\n-This was originally imported by @miniksa in March 2020.\r\n-\r\n-The provenance information (where it came from and which commit) is stored in the file `cgmanifest.json` in the same directory as this readme.\r\n-Please update the provenance information in that file when ingesting an updated version of the dependent library.\r\n-That provenance file is automatically read and inventoried by Microsoft systems to ensure compliance with appropriate governance standards.\r\n-\r\n-## What should be done to update this in the future?\r\n-\r\n-1. Go to kimwalisch/libpopcnt repository on GitHub.\r\n-2. Take the `libpopcnt.h` file.\r\n-3. Don't change anything about it.\r\n-4. Validate that the `LICENSE` in the root of the repository didn't change and update it if so. It is sitting in the same directory as this readme. \r\n-   If it changed dramatically, ensure that it is still compatible with our license scheme. Also update the NOTICE file in the root of our repository to declare the third-party usage.\r\n-5. Submit the pull.\r\n-\r\ndiff --git a/oss/libpopcnt/cgmanifest.json b/oss/libpopcnt/cgmanifest.json\ndeleted file mode 100644\nindex b65c9c29b07..00000000000\n--- a/oss/libpopcnt/cgmanifest.json\n+++ /dev/null\n@@ -1,15 +0,0 @@\n-{\r\n-  \"$schema\": \"https://json.schemastore.org/component-detection-manifest.json\",\r\n-  \"Registrations\": [\r\n-    {\r\n-      \"component\": {\r\n-        \"type\": \"git\",\r\n-        \"git\": {\r\n-          \"repositoryUrl\": \"https://github.com/kimwalisch/libpopcnt\",\r\n-          \"commitHash\": \"c49987e90e56191c399cab881ab87b5daecc9b8e\"\r\n-        }\r\n-      }\r\n-    }\r\n-  ],\r\n-  \"Version\": 1\r\n-}\r\ndiff --git a/oss/libpopcnt/libpopcnt.h b/oss/libpopcnt/libpopcnt.h\ndeleted file mode 100644\nindex de24253d9a6..00000000000\n--- a/oss/libpopcnt/libpopcnt.h\n+++ /dev/null\n@@ -1,798 +0,0 @@\n-/*\n- * libpopcnt.h - C/C++ library for counting the number of 1 bits (bit\n- * population count) in an array as quickly as possible using\n- * specialized CPU instructions i.e. POPCNT, AVX2, AVX512, NEON.\n- *\n- * Copyright (c) 2016 - 2020, Kim Walisch\n- * Copyright (c) 2016 - 2018, Wojciech Mu\u0142a\n- *\n- * All rights reserved.\n- *\n- * Redistribution and use in source and binary forms, with or without\n- * modification, are permitted provided that the following conditions are met:\n- *\n- * 1. Redistributions of source code must retain the above copyright notice, this\n- *    list of conditions and the following disclaimer.\n- * 2. Redistributions in binary form must reproduce the above copyright notice,\n- *    this list of conditions and the following disclaimer in the documentation\n- *    and/or other materials provided with the distribution.\n- *\n- * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n- * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n- * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n- * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n- * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n- * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\n- * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n- * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n- */\n-\n-#ifndef LIBPOPCNT_H\n-#define LIBPOPCNT_H\n-\n-#include <stdint.h>\n-#include <string.h>\n-\n-#ifndef __has_builtin\n-  #define __has_builtin(x) 0\n-#endif\n-\n-#ifndef __has_attribute\n-  #define __has_attribute(x) 0\n-#endif\n-\n-#ifdef __GNUC__\n-  #define GNUC_PREREQ(x, y) \\\n-      (__GNUC__ > x || (__GNUC__ == x && __GNUC_MINOR__ >= y))\n-#else\n-  #define GNUC_PREREQ(x, y) 0\n-#endif\n-\n-#ifdef __clang__\n-  #define CLANG_PREREQ(x, y) \\\n-      (__clang_major__ > x || (__clang_major__ == x && __clang_minor__ >= y))\n-#else\n-  #define CLANG_PREREQ(x, y) 0\n-#endif\n-\n-#if (_MSC_VER < 1900) && \\\n-    !defined(__cplusplus)\n-  #define inline __inline\n-#endif\n-\n-#if (defined(__i386__) || \\\n-     defined(__x86_64__) || \\\n-     defined(_M_IX86) || \\\n-     defined(_M_X64))\n-  #define X86_OR_X64\n-#endif\n-\n-#if GNUC_PREREQ(4, 2) || \\\n-    __has_builtin(__builtin_popcount)\n-  #define HAVE_BUILTIN_POPCOUNT\n-#endif\n-\n-#if GNUC_PREREQ(4, 2) || \\\n-    CLANG_PREREQ(3, 0)\n-  #define HAVE_ASM_POPCNT\n-#endif\n-\n-#if defined(X86_OR_X64) && \\\n-   (defined(HAVE_ASM_POPCNT) || \\\n-    defined(_MSC_VER))\n-  #define HAVE_POPCNT\n-#endif\n-\n-#if defined(X86_OR_X64) && \\\n-    GNUC_PREREQ(4, 9)\n-  #define HAVE_AVX2\n-#endif\n-\n-#if defined(X86_OR_X64) && \\\n-    GNUC_PREREQ(5, 0)\n-  #define HAVE_AVX512\n-#endif\n-\n-#if defined(X86_OR_X64) && !defined(_M_ARM64EC)\n-  /* MSVC compatible compilers (Windows) */\n-  #if defined(_MSC_VER)\n-    /* clang-cl (LLVM 10 from 2020) requires /arch:AVX2 or\n-    * /arch:AVX512 to enable vector instructions */\n-    #if defined(__clang__)\n-      #if defined(__AVX2__)\n-        #define HAVE_AVX2\n-      #endif\n-      #if defined(__AVX512__)\n-        #define HAVE_AVX2\n-        #define HAVE_AVX512\n-      #endif\n-    /* MSVC 2017 or later does not require\n-    * /arch:AVX2 or /arch:AVX512 */\n-    #elif _MSC_VER >= 1910\n-      #define HAVE_AVX2\n-      #define HAVE_AVX512\n-    #endif\n-  /* Clang (Unix-like OSes) */\n-  #elif CLANG_PREREQ(3, 8) && \\\n-        __has_attribute(target) && \\\n-        (!defined(__apple_build_version__) || __apple_build_version__ >= 8000000)\n-    #define HAVE_AVX2\n-    #define HAVE_AVX512\n-  #endif\n-#endif\n-\n-/*\n- * Only enable CPUID runtime checks if this is really\n- * needed. E.g. do not enable if user has compiled\n- * using -march=native on a CPU that supports AVX512.\n- */\n-#if defined(X86_OR_X64) && \\\n-   (defined(__cplusplus) || \\\n-    defined(_MSC_VER) || \\\n-   (GNUC_PREREQ(4, 2) || \\\n-    __has_builtin(__sync_val_compare_and_swap))) && \\\n-   ((defined(HAVE_AVX512) && !(defined(__AVX512__) || defined(__AVX512BW__))) || \\\n-    (defined(HAVE_AVX2) && !defined(__AVX2__)) || \\\n-    (defined(HAVE_POPCNT) && !defined(__POPCNT__)))\n-  #define HAVE_CPUID\n-#endif\n-\n-#ifdef __cplusplus\n-extern \"C\" {\n-#endif\n-\n-/*\n- * This uses fewer arithmetic operations than any other known\n- * implementation on machines with fast multiplication.\n- * It uses 12 arithmetic operations, one of which is a multiply.\n- * http://en.wikipedia.org/wiki/Hamming_weight#Efficient_implementation\n- */\n-static inline uint64_t popcount64(uint64_t x)\n-{\n-  uint64_t m1 = 0x5555555555555555ll;\n-  uint64_t m2 = 0x3333333333333333ll;\n-  uint64_t m4 = 0x0F0F0F0F0F0F0F0Fll;\n-  uint64_t h01 = 0x0101010101010101ll;\n-\n-  x -= (x >> 1) & m1;\n-  x = (x & m2) + ((x >> 2) & m2);\n-  x = (x + (x >> 4)) & m4;\n-\n-  return (x * h01) >> 56;\n-}\n-\n-#if defined(HAVE_ASM_POPCNT) && \\\n-    defined(__x86_64__)\n-\n-static inline uint64_t popcnt64(uint64_t x)\n-{\n-  __asm__ (\"popcnt %1, %0\" : \"=r\" (x) : \"0\" (x));\n-  return x;\n-}\n-\n-#elif defined(HAVE_ASM_POPCNT) && \\\n-      defined(__i386__)\n-\n-static inline uint32_t popcnt32(uint32_t x)\n-{\n-  __asm__ (\"popcnt %1, %0\" : \"=r\" (x) : \"0\" (x));\n-  return x;\n-}\n-\n-static inline uint64_t popcnt64(uint64_t x)\n-{\n-  return popcnt32((uint32_t) x) +\n-         popcnt32((uint32_t)(x >> 32));\n-}\n-\n-#elif defined(_MSC_VER) && \\\n-      defined(_M_X64)\n-\n-#include <nmmintrin.h>\n-\n-static inline uint64_t popcnt64(uint64_t x)\n-{\n-  return _mm_popcnt_u64(x);\n-}\n-\n-#elif defined(_MSC_VER) && \\\n-      defined(_M_IX86)\n-\n-#include <nmmintrin.h>\n-\n-static inline uint64_t popcnt64(uint64_t x)\n-{\n-  return _mm_popcnt_u32((uint32_t) x) + \n-         _mm_popcnt_u32((uint32_t)(x >> 32));\n-}\n-\n-/* non x86 CPUs */\n-#elif defined(HAVE_BUILTIN_POPCOUNT)\n-\n-static inline uint64_t popcnt64(uint64_t x)\n-{\n-  return __builtin_popcountll(x);\n-}\n-\n-/* no hardware POPCNT,\n- * use pure integer algorithm */\n-#else\n-\n-static inline uint64_t popcnt64(uint64_t x)\n-{\n-  return popcount64(x);\n-}\n-\n-#endif\n-\n-#if defined(HAVE_CPUID)\n-\n-#if defined(_MSC_VER)\n-  #include <intrin.h>\n-  #include <immintrin.h>\n-#endif\n-\n-/* %ecx bit flags */\n-#define bit_POPCNT (1 << 23)\n-\n-/* %ebx bit flags */\n-#define bit_AVX2   (1 << 5)\n-#define bit_AVX512 (1 << 30)\n-\n-/* xgetbv bit flags */\n-#define XSTATE_SSE (1 << 1)\n-#define XSTATE_YMM (1 << 2)\n-#define XSTATE_ZMM (7 << 5)\n-\n-static inline void run_cpuid(int eax, int ecx, int* abcd)\n-{\n-#if defined(_MSC_VER)\n-  __cpuidex(abcd, eax, ecx);\n-#else\n-  int ebx = 0;\n-  int edx = 0;\n-\n-  #if defined(__i386__) && \\\n-      defined(__PIC__)\n-    /* in case of PIC under 32-bit EBX cannot be clobbered */\n-    __asm__ (\"movl %%ebx, %%edi;\"\n-             \"cpuid;\"\n-             \"xchgl %%ebx, %%edi;\"\n-             : \"=D\" (ebx),\n-               \"+a\" (eax),\n-               \"+c\" (ecx),\n-               \"=d\" (edx));\n-  #else\n-    __asm__ (\"cpuid;\"\n-             : \"+b\" (ebx),\n-               \"+a\" (eax),\n-               \"+c\" (ecx),\n-               \"=d\" (edx));\n-  #endif\n-\n-  abcd[0] = eax;\n-  abcd[1] = ebx;\n-  abcd[2] = ecx;\n-  abcd[3] = edx;\n-#endif\n-}\n-\n-#if defined(HAVE_AVX2) || \\\n-    defined(HAVE_AVX512)\n-\n-static inline int get_xcr0()\n-{\n-  int xcr0;\n-\n-#if defined(_MSC_VER)\n-  xcr0 = (int) _xgetbv(0);\n-#else\n-  __asm__ (\"xgetbv\" : \"=a\" (xcr0) : \"c\" (0) : \"%edx\" );\n-#endif\n-\n-  return xcr0;\n-}\n-\n-#endif\n-\n-static inline int get_cpuid()\n-{\n-  int flags = 0;\n-  int abcd[4];\n-\n-  run_cpuid(1, 0, abcd);\n-\n-  if ((abcd[2] & bit_POPCNT) == bit_POPCNT)\n-    flags |= bit_POPCNT;\n-\n-#if defined(HAVE_AVX2) || \\\n-    defined(HAVE_AVX512)\n-\n-  int osxsave_mask = (1 << 27);\n-\n-  /* ensure OS supports extended processor state management */\n-  if ((abcd[2] & osxsave_mask) != osxsave_mask)\n-    return 0;\n-\n-  int ymm_mask = XSTATE_SSE | XSTATE_YMM;\n-  int zmm_mask = XSTATE_SSE | XSTATE_YMM | XSTATE_ZMM;\n-\n-  int xcr0 = get_xcr0();\n-\n-  if ((xcr0 & ymm_mask) == ymm_mask)\n-  {\n-    run_cpuid(7, 0, abcd);\n-\n-    if ((abcd[1] & bit_AVX2) == bit_AVX2)\n-      flags |= bit_AVX2;\n-\n-    if ((xcr0 & zmm_mask) == zmm_mask)\n-    {\n-      if ((abcd[1] & bit_AVX512) == bit_AVX512)\n-        flags |= bit_AVX512;\n-    }\n-  }\n-\n-#endif\n-\n-  return flags;\n-}\n-\n-#endif /* cpuid */\n-\n-#if defined(HAVE_AVX2)\n-\n-#include <immintrin.h>\n-\n-#if !defined(_MSC_VER)\n-  __attribute__ ((target (\"avx2\")))\n-#endif\n-static inline void CSA256(__m256i* h, __m256i* l, __m256i a, __m256i b, __m256i c)\n-{\n-  __m256i u = _mm256_xor_si256(a, b);\n-  *h = _mm256_or_si256(_mm256_and_si256(a, b), _mm256_and_si256(u, c));\n-  *l = _mm256_xor_si256(u, c);\n-}\n-\n-#if !defined(_MSC_VER)\n-  __attribute__ ((target (\"avx2\")))\n-#endif\n-static inline __m256i popcnt256(__m256i v)\n-{\n-  __m256i lookup1 = _mm256_setr_epi8(\n-      4, 5, 5, 6, 5, 6, 6, 7,\n-      5, 6, 6, 7, 6, 7, 7, 8,\n-      4, 5, 5, 6, 5, 6, 6, 7,\n-      5, 6, 6, 7, 6, 7, 7, 8\n-  );\n-\n-  __m256i lookup2 = _mm256_setr_epi8(\n-      4, 3, 3, 2, 3, 2, 2, 1,\n-      3, 2, 2, 1, 2, 1, 1, 0,\n-      4, 3, 3, 2, 3, 2, 2, 1,\n-      3, 2, 2, 1, 2, 1, 1, 0\n-  );\n-\n-  __m256i low_mask = _mm256_set1_epi8(0x0f);\n-  __m256i lo = _mm256_and_si256(v, low_mask);\n-  __m256i hi = _mm256_and_si256(_mm256_srli_epi16(v, 4), low_mask);\n-  __m256i popcnt1 = _mm256_shuffle_epi8(lookup1, lo);\n-  __m256i popcnt2 = _mm256_shuffle_epi8(lookup2, hi);\n-\n-  return _mm256_sad_epu8(popcnt1, popcnt2);\n-}\n-\n-/*\n- * AVX2 Harley-Seal popcount (4th iteration).\n- * The algorithm is based on the paper \"Faster Population Counts\n- * using AVX2 Instructions\" by Daniel Lemire, Nathan Kurz and\n- * Wojciech Mula (23 Nov 2016).\n- * @see https://arxiv.org/abs/1611.07612\n- */\n-#if !defined(_MSC_VER)\n-  __attribute__ ((target (\"avx2\")))\n-#endif\n-static inline uint64_t popcnt_avx2(const __m256i* ptr, uint64_t size)\n-{\n-  __m256i cnt = _mm256_setzero_si256();\n-  __m256i ones = _mm256_setzero_si256();\n-  __m256i twos = _mm256_setzero_si256();\n-  __m256i fours = _mm256_setzero_si256();\n-  __m256i eights = _mm256_setzero_si256();\n-  __m256i sixteens = _mm256_setzero_si256();\n-  __m256i twosA, twosB, foursA, foursB, eightsA, eightsB;\n-\n-  uint64_t i = 0;\n-  uint64_t limit = size - size % 16;\n-  uint64_t* cnt64;\n-\n-  for(; i < limit; i += 16)\n-  {\n-    CSA256(&twosA, &ones, ones, _mm256_loadu_si256(ptr + i + 0), _mm256_loadu_si256(ptr + i + 1));\n-    CSA256(&twosB, &ones, ones, _mm256_loadu_si256(ptr + i + 2), _mm256_loadu_si256(ptr + i + 3));\n-    CSA256(&foursA, &twos, twos, twosA, twosB);\n-    CSA256(&twosA, &ones, ones, _mm256_loadu_si256(ptr + i + 4), _mm256_loadu_si256(ptr + i + 5));\n-    CSA256(&twosB, &ones, ones, _mm256_loadu_si256(ptr + i + 6), _mm256_loadu_si256(ptr + i + 7));\n-    CSA256(&foursB, &twos, twos, twosA, twosB);\n-    CSA256(&eightsA, &fours, fours, foursA, foursB);\n-    CSA256(&twosA, &ones, ones, _mm256_loadu_si256(ptr + i + 8), _mm256_loadu_si256(ptr + i + 9));\n-    CSA256(&twosB, &ones, ones, _mm256_loadu_si256(ptr + i + 10), _mm256_loadu_si256(ptr + i + 11));\n-    CSA256(&foursA, &twos, twos, twosA, twosB);\n-    CSA256(&twosA, &ones, ones, _mm256_loadu_si256(ptr + i + 12), _mm256_loadu_si256(ptr + i + 13));\n-    CSA256(&twosB, &ones, ones, _mm256_loadu_si256(ptr + i + 14), _mm256_loadu_si256(ptr + i + 15));\n-    CSA256(&foursB, &twos, twos, twosA, twosB);\n-    CSA256(&eightsB, &fours, fours, foursA, foursB);\n-    CSA256(&sixteens, &eights, eights, eightsA, eightsB);\n-\n-    cnt = _mm256_add_epi64(cnt, popcnt256(sixteens));\n-  }\n-\n-  cnt = _mm256_slli_epi64(cnt, 4);\n-  cnt = _mm256_add_epi64(cnt, _mm256_slli_epi64(popcnt256(eights), 3));\n-  cnt = _mm256_add_epi64(cnt, _mm256_slli_epi64(popcnt256(fours), 2));\n-  cnt = _mm256_add_epi64(cnt, _mm256_slli_epi64(popcnt256(twos), 1));\n-  cnt = _mm256_add_epi64(cnt, popcnt256(ones));\n-\n-  for(; i < size; i++)\n-    cnt = _mm256_add_epi64(cnt, popcnt256(_mm256_loadu_si256(ptr + i)));\n-\n-  cnt64 = (uint64_t*) &cnt;\n-\n-  return cnt64[0] +\n-         cnt64[1] +\n-         cnt64[2] +\n-         cnt64[3];\n-}\n-\n-#endif\n-\n-#if defined(HAVE_AVX512)\n-\n-#include <immintrin.h>\n-\n-#if !defined(_MSC_VER)\n-  __attribute__ ((target (\"avx512bw\")))\n-#endif\n-static inline __m512i popcnt512(__m512i v)\n-{\n-  __m512i m1 = _mm512_set1_epi8(0x55);\n-  __m512i m2 = _mm512_set1_epi8(0x33);\n-  __m512i m4 = _mm512_set1_epi8(0x0F);\n-  __m512i vm = _mm512_and_si512(_mm512_srli_epi16(v, 1), m1);\n-  __m512i t1 = _mm512_sub_epi8(v, vm);\n-  __m512i tm = _mm512_and_si512(t1, m2);\n-  __m512i tm2 = _mm512_and_si512(_mm512_srli_epi16(t1, 2), m2);\n-  __m512i t2 = _mm512_add_epi8(tm, tm2);\n-  __m512i tt = _mm512_add_epi8(t2, _mm512_srli_epi16(t2, 4));\n-  __m512i t3 = _mm512_and_si512(tt, m4);\n-\n-  return _mm512_sad_epu8(t3, _mm512_setzero_si512());\n-}\n-\n-#if !defined(_MSC_VER)\n-  __attribute__ ((target (\"avx512bw\")))\n-#endif\n-static inline void CSA512(__m512i* h, __m512i* l, __m512i a, __m512i b, __m512i c)\n-{\n-  *l = _mm512_ternarylogic_epi32(c, b, a, 0x96);\n-  *h = _mm512_ternarylogic_epi32(c, b, a, 0xe8);\n-}\n-\n-/*\n- * AVX512 Harley-Seal popcount (4th iteration).\n- * The algorithm is based on the paper \"Faster Population Counts\n- * using AVX2 Instructions\" by Daniel Lemire, Nathan Kurz and\n- * Wojciech Mula (23 Nov 2016).\n- * @see https://arxiv.org/abs/1611.07612\n- */\n-#if !defined(_MSC_VER)\n-  __attribute__ ((target (\"avx512bw\")))\n-#endif\n-static inline uint64_t popcnt_avx512(const __m512i* ptr, const uint64_t size)\n-{\n-  __m512i cnt = _mm512_setzero_si512();\n-  __m512i ones = _mm512_setzero_si512();\n-  __m512i twos = _mm512_setzero_si512();\n-  __m512i fours = _mm512_setzero_si512();\n-  __m512i eights = _mm512_setzero_si512();\n-  __m512i sixteens = _mm512_setzero_si512();\n-  __m512i twosA, twosB, foursA, foursB, eightsA, eightsB;\n-\n-  uint64_t i = 0;\n-  uint64_t limit = size - size % 16;\n-  uint64_t* cnt64;\n-\n-  for(; i < limit; i += 16)\n-  {\n-    CSA512(&twosA, &ones, ones, _mm512_loadu_si512(ptr + i + 0), _mm512_loadu_si512(ptr + i + 1));\n-    CSA512(&twosB, &ones, ones, _mm512_loadu_si512(ptr + i + 2), _mm512_loadu_si512(ptr + i + 3));\n-    CSA512(&foursA, &twos, twos, twosA, twosB);\n-    CSA512(&twosA, &ones, ones, _mm512_loadu_si512(ptr + i + 4), _mm512_loadu_si512(ptr + i + 5));\n-    CSA512(&twosB, &ones, ones, _mm512_loadu_si512(ptr + i + 6), _mm512_loadu_si512(ptr + i + 7));\n-    CSA512(&foursB, &twos, twos, twosA, twosB);\n-    CSA512(&eightsA, &fours, fours, foursA, foursB);\n-    CSA512(&twosA, &ones, ones, _mm512_loadu_si512(ptr + i + 8), _mm512_loadu_si512(ptr + i + 9));\n-    CSA512(&twosB, &ones, ones, _mm512_loadu_si512(ptr + i + 10), _mm512_loadu_si512(ptr + i + 11));\n-    CSA512(&foursA, &twos, twos, twosA, twosB);\n-    CSA512(&twosA, &ones, ones, _mm512_loadu_si512(ptr + i + 12), _mm512_loadu_si512(ptr + i + 13));\n-    CSA512(&twosB, &ones, ones, _mm512_loadu_si512(ptr + i + 14), _mm512_loadu_si512(ptr + i + 15));\n-    CSA512(&foursB, &twos, twos, twosA, twosB);\n-    CSA512(&eightsB, &fours, fours, foursA, foursB);\n-    CSA512(&sixteens, &eights, eights, eightsA, eightsB);\n-\n-    cnt = _mm512_add_epi64(cnt, popcnt512(sixteens));\n-  }\n-\n-  cnt = _mm512_slli_epi64(cnt, 4);\n-  cnt = _mm512_add_epi64(cnt, _mm512_slli_epi64(popcnt512(eights), 3));\n-  cnt = _mm512_add_epi64(cnt, _mm512_slli_epi64(popcnt512(fours), 2));\n-  cnt = _mm512_add_epi64(cnt, _mm512_slli_epi64(popcnt512(twos), 1));\n-  cnt = _mm512_add_epi64(cnt, popcnt512(ones));\n-\n-  for(; i < size; i++)\n-    cnt = _mm512_add_epi64(cnt, popcnt512(_mm512_loadu_si512(ptr + i)));\n-\n-  cnt64 = (uint64_t*) &cnt;\n-\n-  return cnt64[0] +\n-         cnt64[1] +\n-         cnt64[2] +\n-         cnt64[3] +\n-         cnt64[4] +\n-         cnt64[5] +\n-         cnt64[6] +\n-         cnt64[7];\n-}\n-\n-#endif\n-\n-/* x86 CPUs */\n-#if defined(X86_OR_X64)\n-\n-/*\n- * Count the number of 1 bits in the data array\n- * @data: An array\n- * @size: Size of data in bytes\n- */\n-static inline uint64_t popcnt(const void* data, uint64_t size)\n-{\n-  uint64_t i = 0;\n-  uint64_t cnt = 0;\n-  const uint8_t* ptr = (const uint8_t*) data;\n-\n-/*\n- * CPUID runtime checks are only enabled if this is needed.\n- * E.g. CPUID is disabled when a user compiles his\n- * code using -march=native on a CPU with AVX512.\n- */\n-#if defined(HAVE_CPUID)\n-  #if defined(__cplusplus)\n-    /* C++11 thread-safe singleton */\n-    static const int cpuid = get_cpuid();\n-  #else\n-    static int cpuid_ = -1;\n-    int cpuid = cpuid_;\n-    if (cpuid == -1)\n-    {\n-      cpuid = get_cpuid();\n-\n-      #if defined(_MSC_VER)\n-        _InterlockedCompareExchange(&cpuid_, cpuid, -1);\n-      #else\n-        __sync_val_compare_and_swap(&cpuid_, -1, cpuid);\n-      #endif\n-    }\n-  #endif\n-#endif\n-\n-#if defined(HAVE_AVX512)\n-  #if defined(__AVX512__) || defined(__AVX512BW__)\n-    /* AVX512 requires arrays >= 1024 bytes */\n-    if (i + 1024 <= size)\n-  #else\n-    if ((cpuid & bit_AVX512) &&\n-        i + 1024 <= size)\n-  #endif\n-    {\n-      const __m512i* ptr512 = (const __m512i*)(ptr + i);\n-      cnt += popcnt_avx512(ptr512, (size - i) / 64);\n-      i = size - size % 64;\n-    }\n-#endif\n-\n-#if defined(HAVE_AVX2)\n-  #if defined(__AVX2__)\n-    /* AVX2 requires arrays >= 512 bytes */\n-    if (i + 512 <= size)\n-  #else\n-    if ((cpuid & bit_AVX2) &&\n-        i + 512 <= size)\n-  #endif\n-    {\n-      const __m256i* ptr256 = (const __m256i*)(ptr + i);\n-      cnt += popcnt_avx2(ptr256, (size - i) / 32);\n-      i = size - size % 32;\n-    }\n-#endif\n-\n-#if defined(HAVE_POPCNT)\n-  /* \n-   * The user has compiled without -mpopcnt.\n-   * Unfortunately the MSVC compiler does not have\n-   * a POPCNT macro so we cannot get rid of the\n-   * runtime check for MSVC.\n-   */\n-  #if !defined(__POPCNT__)\n-    if (cpuid & bit_POPCNT)\n-  #endif\n-    {\n-      /* We use unaligned memory accesses here to improve performance */\n-      for (; i < size - size % 8; i += 8)\n-        cnt += popcnt64(*(const uint64_t*)(ptr + i));\n-      for (; i < size; i++)\n-        cnt += popcnt64(ptr[i]);\n-\n-      return cnt;\n-    }\n-#endif\n-\n-#if !defined(HAVE_POPCNT) || \\\n-    !defined(__POPCNT__)\n-  /*\n-   * Pure integer popcount algorithm.\n-   * We use unaligned memory accesses here to improve performance.\n-   */\n-  for (; i < size - size % 8; i += 8)\n-    cnt += popcount64(*(const uint64_t*)(ptr + i));\n-\n-  if (i < size)\n-  {\n-    uint64_t val = 0;\n-    size_t bytes = (size_t)(size - i);\n-    memcpy(&val, &ptr[i], bytes);\n-    cnt += popcount64(val);\n-  }\n-\n-  return cnt;\n-#endif\n-}\n-\n-#elif defined(__ARM_NEON) || \\\n-      defined(__aarch64__)\n-\n-#include <arm_neon.h>\n-\n-static inline uint64x2_t vpadalq(uint64x2_t sum, uint8x16_t t)\n-{\n-  return vpadalq_u32(sum, vpaddlq_u16(vpaddlq_u8(t)));\n-}\n-\n-/*\n- * Count the number of 1 bits in the data array\n- * @data: An array\n- * @size: Size of data in bytes\n- */\n-static inline uint64_t popcnt(const void* data, uint64_t size)\n-{\n-  uint64_t i = 0;\n-  uint64_t cnt = 0;\n-  uint64_t chunk_size = 64;\n-  const uint8_t* ptr = (const uint8_t*) data;\n-\n-  if (size >= chunk_size)\n-  {\n-    uint64_t iters = size / chunk_size;\n-    uint64x2_t sum = vcombine_u64(vcreate_u64(0), vcreate_u64(0));\n-    uint8x16_t zero = vcombine_u8(vcreate_u8(0), vcreate_u8(0));\n-\n-    do\n-    {\n-      uint8x16_t t0 = zero;\n-      uint8x16_t t1 = zero;\n-      uint8x16_t t2 = zero;\n-      uint8x16_t t3 = zero;\n-\n-      /*\n-       * After every 31 iterations we need to add the\n-       * temporary sums (t0, t1, t2, t3) to the total sum.\n-       * We must ensure that the temporary sums <= 255\n-       * and 31 * 8 bits = 248 which is OK.\n-       */\n-      uint64_t limit = (i + 31 < iters) ? i + 31 : iters;\n-  \n-      /* Each iteration processes 64 bytes */\n-      for (; i < limit; i++)\n-      {\n-        uint8x16x4_t input = vld4q_u8(ptr);\n-        ptr += chunk_size;\n-\n-        t0 = vaddq_u8(t0, vcntq_u8(input.val[0]));\n-        t1 = vaddq_u8(t1, vcntq_u8(input.val[1]));\n-        t2 = vaddq_u8(t2, vcntq_u8(input.val[2]));\n-        t3 = vaddq_u8(t3, vcntq_u8(input.val[3]));\n-      }\n-\n-      sum = vpadalq(sum, t0);\n-      sum = vpadalq(sum, t1);\n-      sum = vpadalq(sum, t2);\n-      sum = vpadalq(sum, t3);\n-    }\n-    while (i < iters);\n-\n-    i = 0;\n-    size %= chunk_size;\n-\n-    uint64_t tmp[2];\n-    vst1q_u64(tmp, sum);\n-    cnt += tmp[0];\n-    cnt += tmp[1];\n-  }\n-\n-#if defined(__ARM_FEATURE_UNALIGNED)\n-  /* We use unaligned memory accesses here to improve performance */\n-  for (; i < size - size % 8; i += 8)\n-    cnt += popcnt64(*(const uint64_t*)(ptr + i));\n-#else\n-  if (i + 8 <= size)\n-  {\n-    /* Align memory to an 8 byte boundary */\n-    for (; (uintptr_t)(ptr + i) % 8; i++)\n-      cnt += popcnt64(ptr[i]);\n-    for (; i < size - size % 8; i += 8)\n-      cnt += popcnt64(*(const uint64_t*)(ptr + i));\n-  }\n-#endif\n-\n-  if (i < size)\n-  {\n-    uint64_t val = 0;\n-    size_t bytes = (size_t)(size - i);\n-    memcpy(&val, &ptr[i], bytes);\n-    cnt += popcount64(val);\n-  }\n-\n-  return cnt;\n-}\n-\n-/* all other CPUs */\n-#else\n-\n-/*\n- * Count the number of 1 bits in the data array\n- * @data: An array\n- * @size: Size of data in bytes\n- */\n-static inline uint64_t popcnt(const void* data, uint64_t size)\n-{\n-  uint64_t i = 0;\n-  uint64_t cnt = 0;\n-  const uint8_t* ptr = (const uint8_t*) data;\n-\n-  if (size >= 8)\n-  {\n-    /*\n-     * Since we don't know whether this CPU architecture\n-     * supports unaligned memory accesses we align\n-     * memory to an 8 byte boundary.\n-     */\n-    for (; (uintptr_t)(ptr + i) % 8; i++)\n-      cnt += popcnt64(ptr[i]);\n-    for (; i < size - size % 8; i += 8)\n-      cnt += popcnt64(*(const uint64_t*)(ptr + i));\n-  }\n-\n-  for (; i < size; i++)\n-    cnt += popcnt64(ptr[i]);\n-\n-  return cnt;\n-}\n-\n-#endif\n-\n-#ifdef __cplusplus\n-} /* extern \"C\" */\n-#endif\n-\n-#endif /* LIBPOPCNT_H */\ndiff --git a/src/ConsolePerf.wprp b/src/ConsolePerf.wprp\nindex dffa239cccd..544eec39c87 100644\n--- a/src/ConsolePerf.wprp\n+++ b/src/ConsolePerf.wprp\n@@ -42,7 +42,6 @@\n         <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.Host\" Name=\"fe1ff234-1f09-50a8-d38d-c44fab43e818\"/>\r\n         <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.Server\" Name=\"1A541C01-589A-496E-85A7-A9E02170166D\"/>\r\n         <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.VirtualTerminal.Parser\" Name=\"c9ba2a84-d3ca-5e19-2bd6-776a0910cb9d\"/>\r\n-        <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.Render.VtEngine\" Name=\"c9ba2a95-d3ca-5e19-2bd6-776a0910cb9d\"/>\r\n         <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.UIA\" Name=\"e7ebce59-2161-572d-b263-2f16a6afb9e5\"/>\r\n         <!-- Now define some profiles. We'll call them by ID when collecting. Also, the Base is where it is inheriting from and is a .wprpi file built... -->\r\n         <!-- ... into WPR automatically. Go look in the WPR install directory or in the documentation to find it. -->\r\n@@ -66,7 +65,6 @@\n                         <EventProviderId Value=\"EventProvider-Microsoft.Windows.Console.Host\"/>\r\n                         <EventProviderId Value=\"EventProvider-Microsoft.Windows.Console.Server\"/>\r\n                         <EventProviderId Value=\"EventProvider-Microsoft.Windows.Console.VirtualTerminal.Parser\"/>\r\n-                        <EventProviderId Value=\"EventProvider-Microsoft.Windows.Console.Render.VtEngine\"/>\r\n                         <EventProviderId Value=\"EventProvider-Microsoft.Windows.Console.UIA\"/>\r\n                     </EventProviders>\r\n                 </EventCollectorId>\r\ndiff --git a/src/Terminal.wprp b/src/Terminal.wprp\nindex 129d83ca0a0..1abe7df41a3 100644\n--- a/src/Terminal.wprp\n+++ b/src/Terminal.wprp\n@@ -18,7 +18,6 @@\n     <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.Host\" Name=\"fe1ff234-1f09-50a8-d38d-c44fab43e818\"/>\n     <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.Server\" Name=\"1A541C01-589A-496E-85A7-A9E02170166D\"/>\n     <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.VirtualTerminal.Parser\" Name=\"c9ba2a84-d3ca-5e19-2bd6-776a0910cb9d\"/>\n-    <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.Render.VtEngine\" Name=\"c9ba2a95-d3ca-5e19-2bd6-776a0910cb9d\"/>\n     <EventProvider Id=\"EventProvider-Microsoft.Windows.Console.UIA\" Name=\"e7ebce59-2161-572d-b263-2f16a6afb9e5\"/>\n \n     <!-- Profile for General Terminal logging -->\ndiff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex 40e3405dcd4..b64f0317010 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -716,13 +716,6 @@ OutputCellIterator TextBuffer::WriteLine(const OutputCellIterator givenIt,\n // - true if we successfully incremented the buffer.\r\n void TextBuffer::IncrementCircularBuffer(const TextAttribute& fillAttributes)\r\n {\r\n-    // FirstRow is at any given point in time the array index in the circular buffer that corresponds\r\n-    // to the logical position 0 in the window (cursor coordinates and all other coordinates).\r\n-    if (_isActiveBuffer && _renderer)\r\n-    {\r\n-        _renderer->TriggerFlush(true);\r\n-    }\r\n-\r\n     // Prune hyperlinks to delete obsolete references\r\n     _PruneHyperlinks();\r\n \r\ndiff --git a/src/cascadia/TerminalConnection/ConptyConnection.cpp b/src/cascadia/TerminalConnection/ConptyConnection.cpp\nindex e33ddc7b0af..5b8cb22028a 100644\n--- a/src/cascadia/TerminalConnection/ConptyConnection.cpp\n+++ b/src/cascadia/TerminalConnection/ConptyConnection.cpp\n@@ -5,6 +5,7 @@\n #include \"ConptyConnection.h\"\n \n #include <conpty-static.h>\n+#include <winmeta.h>\n \n #include \"CTerminalHandoff.h\"\n #include \"LibraryResources.h\"\n@@ -31,29 +32,6 @@ static constexpr auto _errorFormat = L\"{0} ({0:#010x})\"sv;\n \n namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n {\n-    // Function Description:\n-    // - creates some basic anonymous pipes and passes them to CreatePseudoConsole\n-    // Arguments:\n-    // - size: The size of the conpty to create, in characters.\n-    // - phInput: Receives the handle to the newly-created anonymous pipe for writing input to the conpty.\n-    // - phOutput: Receives the handle to the newly-created anonymous pipe for reading the output of the conpty.\n-    // - phPc: Receives a token value to identify this conpty\n-#pragma warning(suppress : 26430) // This statement sufficiently checks the out parameters. Analyzer cannot find this.\n-    static HRESULT _CreatePseudoConsoleAndPipes(const COORD size, const DWORD dwFlags, HANDLE* phInput, HANDLE* phOutput, HPCON* phPC) noexcept\n-    {\n-        RETURN_HR_IF(E_INVALIDARG, phPC == nullptr || phInput == nullptr || phOutput == nullptr);\n-\n-        wil::unique_hfile outPipeOurSide, outPipePseudoConsoleSide;\n-        wil::unique_hfile inPipeOurSide, inPipePseudoConsoleSide;\n-\n-        RETURN_IF_WIN32_BOOL_FALSE(CreatePipe(&inPipePseudoConsoleSide, &inPipeOurSide, nullptr, 0));\n-        RETURN_IF_WIN32_BOOL_FALSE(CreatePipe(&outPipeOurSide, &outPipePseudoConsoleSide, nullptr, 0));\n-        RETURN_IF_FAILED(ConptyCreatePseudoConsole(size, inPipePseudoConsoleSide.get(), outPipePseudoConsoleSide.get(), dwFlags, phPC));\n-        *phInput = inPipeOurSide.release();\n-        *phOutput = outPipeOurSide.release();\n-        return S_OK;\n-    }\n-\n     // Function Description:\n     // - launches the client application attached to the new pseudoconsole\n     HRESULT ConptyConnection::_LaunchAttachedClient() noexcept\n@@ -174,8 +152,11 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n \n     // Who decided that?\n #pragma warning(suppress : 26455) // Default constructor should not throw. Declare it 'noexcept' (f.6).\n-    ConptyConnection::ConptyConnection()\n+    ConptyConnection::ConptyConnection() :\n+        _writeOverlappedEvent{ CreateEventExW(nullptr, nullptr, CREATE_EVENT_MANUAL_RESET, EVENT_ALL_ACCESS) }\n     {\n+        THROW_LAST_ERROR_IF(!_writeOverlappedEvent);\n+        _writeOverlapped.hEvent = _writeOverlappedEvent.get();\n     }\n \n     // Function Description:\n@@ -236,7 +217,7 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n             _environment = settings.TryLookup(L\"environment\").try_as<Windows::Foundation::Collections::ValueSet>();\n             _profileGuid = unbox_prop_or<winrt::guid>(settings, L\"profileGuid\", _profileGuid);\n \n-            _flags = PSEUDOCONSOLE_RESIZE_QUIRK;\n+            _flags = 0;\n \n             // If we're using an existing buffer, we want the new connection\n             // to reuse the existing cursor. When not setting this flag, the\n@@ -310,10 +291,8 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n \n         _sessionId = Utils::CreateGuid();\n \n-        wil::unique_hfile inPipePseudoConsoleSide;\n-        wil::unique_hfile outPipePseudoConsoleSide;\n-        THROW_IF_WIN32_BOOL_FALSE(CreatePipe(&inPipePseudoConsoleSide, &_inPipe, nullptr, 0));\n-        THROW_IF_WIN32_BOOL_FALSE(CreatePipe(&_outPipe, &outPipePseudoConsoleSide, nullptr, 0));\n+        auto pipe = Utils::CreateOverlappedPipe(PIPE_ACCESS_DUPLEX, 128 * 1024);\n+        auto pipeClientClone = duplicateHandle(pipe.client.get());\n \n         auto ownedSignal = duplicateHandle(signal);\n         auto ownedReference = duplicateHandle(reference);\n@@ -338,8 +317,9 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n         }\n         CATCH_LOG()\n \n-        *in = inPipePseudoConsoleSide.release();\n-        *out = outPipePseudoConsoleSide.release();\n+        _pipe = std::move(pipe.server);\n+        *in = pipe.client.release();\n+        *out = pipeClientClone.release();\n     }\n \n     winrt::hstring ConptyConnection::Commandline() const\n@@ -366,9 +346,11 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n \n         // If we do not have pipes already, then this is a fresh connection... not an inbound one that is a received\n         // handoff from an already-started PTY process.\n-        if (!_inPipe)\n+        if (!_pipe)\n         {\n-            THROW_IF_FAILED(_CreatePseudoConsoleAndPipes(til::unwrap_coord_size(dimensions), _flags, &_inPipe, &_outPipe, &_hPC));\n+            auto pipe = Utils::CreateOverlappedPipe(PIPE_ACCESS_DUPLEX, 128 * 1024);\n+            THROW_IF_FAILED(ConptyCreatePseudoConsole(til::unwrap_coord_size(dimensions), pipe.client.get(), pipe.client.get(), _flags, &_hPC));\n+            _pipe = std::move(pipe.server);\n \n             if (_initialParentHwnd != 0)\n             {\n@@ -500,10 +482,44 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n             return;\n         }\n \n-        // convert from UTF-16LE to UTF-8 as ConPty expects UTF-8\n-        // TODO GH#3378 reconcile and unify UTF-8 converters\n-        auto str = winrt::to_string(data);\n-        LOG_IF_WIN32_BOOL_FALSE(WriteFile(_inPipe.get(), str.c_str(), (DWORD)str.length(), nullptr, nullptr));\n+        // Ensure a linear and predictable write order, even across multiple threads.\n+        // A ticket lock is the perfect fit for this as it acts as first-come-first-serve.\n+        std::lock_guard guard{ _writeLock };\n+\n+        if (_writePending)\n+        {\n+            _writePending = false;\n+\n+            DWORD read;\n+            if (!GetOverlappedResult(_pipe.get(), &_writeOverlapped, &read, TRUE))\n+            {\n+                // Not much we can do when the wait fails. This will kill the connection.\n+                LOG_LAST_ERROR();\n+                _hPC.reset();\n+                return;\n+            }\n+        }\n+\n+        if (FAILED_LOG(til::u16u8(data, _writeBuffer)))\n+        {\n+            return;\n+        }\n+\n+        if (!WriteFile(_pipe.get(), _writeBuffer.data(), gsl::narrow_cast<DWORD>(_writeBuffer.length()), nullptr, &_writeOverlapped))\n+        {\n+            switch (const auto gle = GetLastError())\n+            {\n+            case ERROR_BROKEN_PIPE:\n+                _hPC.reset();\n+                break;\n+            case ERROR_IO_PENDING:\n+                _writePending = true;\n+                break;\n+            default:\n+                LOG_WIN32(gle);\n+                break;\n+            }\n+        }\n     }\n \n     void ConptyConnection::Resize(uint32_t rows, uint32_t columns)\n@@ -562,23 +578,17 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n     {\n         _transitionToState(ConnectionState::Closing);\n \n-        // .reset()ing either of these two will signal ConPTY to send out a CTRL_CLOSE_EVENT to all attached clients.\n-        // FYI: The other members of this class are concurrently read by the _hOutputThread\n-        // thread running in the background and so they're not safe to be .reset().\n+        // This will signal ConPTY to send out a CTRL_CLOSE_EVENT to all attached clients.\n+        // Once they're all disconnected it'll close its half of the pipes.\n         _hPC.reset();\n-        _inPipe.reset();\n \n         if (_hOutputThread)\n         {\n-            // Loop around `CancelSynchronousIo()` just in case the signal to shut down was missed.\n-            // This may happen if we called `CancelSynchronousIo()` while not being stuck\n-            // in `ReadFile()` and if OpenConsole refuses to exit in a timely manner.\n+            // Loop around `CancelIoEx()` just in case the signal to shut down was missed.\n             for (;;)\n             {\n-                // ConptyConnection::Close() blocks the UI thread, because `_TerminalOutputHandlers` might indirectly\n-                // reference UI objects like `ControlCore`. CancelSynchronousIo() allows us to have the background\n-                // thread exit as fast as possible by aborting any ongoing writes coming from OpenConsole.\n-                CancelSynchronousIo(_hOutputThread.get());\n+                // The output thread may be stuck waiting for the OVERLAPPED to be signaled.\n+                CancelIoEx(_pipe.get(), nullptr);\n \n                 // Waiting for the output thread to exit ensures that all pending TerminalOutput.raise()\n                 // calls have returned and won't notify our caller (ControlCore) anymore. This ensures that\n@@ -588,17 +598,15 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n                 {\n                     break;\n                 }\n-\n-                LOG_LAST_ERROR();\n             }\n         }\n \n-        // Now that the background thread is done, we can safely clean up the other system objects, without\n-        // race conditions, or fear of deadlocking ourselves (e.g. by calling CloseHandle() on _outPipe).\n-        _outPipe.reset();\n         _hOutputThread.reset();\n         _piClient.reset();\n+        _pipe.reset();\n \n+        // The output thread should have already transitioned us to Closed.\n+        // This exists just in case there was no output thread.\n         _transitionToState(ConnectionState::Closed);\n     }\n     CATCH_LOG()\n@@ -645,72 +653,98 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n             _LastConPtyClientDisconnected();\n         });\n \n+        const wil::unique_event overlappedEvent{ CreateEventExW(nullptr, nullptr, CREATE_EVENT_MANUAL_RESET, EVENT_ALL_ACCESS) };\n+        OVERLAPPED overlapped{ .hEvent = overlappedEvent.get() };\n+        bool overlappedPending = false;\n         char buffer[128 * 1024];\n         DWORD read = 0;\n \n         til::u8state u8State;\n         std::wstring wstr;\n \n-        // process the data of the output pipe in a loop\n-        while (true)\n+        // If we use overlapped IO We want to queue ReadFile() calls before processing the\n+        // string, because TerminalOutput.raise() may take a while (relatively speaking).\n+        // That's why the loop looks a little weird as it starts a read, processes the\n+        // previous string, and finally converts the previous read to the next string.\n+        for (;;)\n         {\n-            const auto readFail{ !ReadFile(_outPipe.get(), &buffer[0], sizeof(buffer), &read, nullptr) };\n-\n-            // When we call CancelSynchronousIo() in Close() this is the branch that's taken and gets us out of here.\n-            if (_isStateAtOrBeyond(ConnectionState::Closing))\n+            // When we have a `wstr` that's ready for processing we must do so without blocking.\n+            // Otherwise, whatever the user typed will be delayed until the next IO operation.\n+            // With overlapped IO that's not a problem because the ReadFile() calls won't block.\n+            if (!ReadFile(_pipe.get(), &buffer[0], sizeof(buffer), &read, &overlapped))\n             {\n-                return 0;\n+                if (GetLastError() != ERROR_IO_PENDING)\n+                {\n+                    break;\n+                }\n+                overlappedPending = true;\n             }\n \n-            if (readFail) // reading failed (we must check this first, because read will also be 0.)\n+            // wstr can be empty in two situations:\n+            // * The previous call to til::u8u16 failed.\n+            // * We're using overlapped IO, and it's the first iteration.\n+            if (!wstr.empty())\n             {\n-                // EXIT POINT\n-                const auto lastError = GetLastError();\n-                if (lastError == ERROR_BROKEN_PIPE)\n+                if (!_receivedFirstByte)\n                 {\n-                    _LastConPtyClientDisconnected();\n-                    return S_OK;\n+                    const auto now = std::chrono::high_resolution_clock::now();\n+                    const std::chrono::duration<double> delta = now - _startTime;\n+\n+#pragma warning(suppress : 26477 26485 26494 26482 26446) // We don't control TraceLoggingWrite\n+                    TraceLoggingWrite(g_hTerminalConnectionProvider,\n+                                      \"ReceivedFirstByte\",\n+                                      TraceLoggingDescription(\"An event emitted when the connection receives the first byte\"),\n+                                      TraceLoggingGuid(_sessionId, \"SessionGuid\", \"The WT_SESSION's GUID\"),\n+                                      TraceLoggingFloat64(delta.count(), \"Duration\"),\n+                                      TraceLoggingKeyword(MICROSOFT_KEYWORD_MEASURES),\n+                                      TelemetryPrivacyDataTag(PDT_ProductAndServicePerformance));\n+                    _receivedFirstByte = true;\n                 }\n-                else\n+\n+                try\n                 {\n-                    _indicateExitWithStatus(HRESULT_FROM_WIN32(lastError)); // print a message\n-                    _transitionToState(ConnectionState::Failed);\n-                    return gsl::narrow_cast<DWORD>(HRESULT_FROM_WIN32(lastError));\n+                    TerminalOutput.raise(wstr);\n                 }\n+                CATCH_LOG();\n             }\n \n-            const auto result{ til::u8u16(std::string_view{ &buffer[0], read }, wstr, u8State) };\n-            if (FAILED(result))\n+            // Here's the counterpart to the start of the loop. We processed whatever was in `wstr`,\n+            // so blocking synchronously on the pipe is now possible.\n+            // If we used overlapped IO, we need to wait for the ReadFile() to complete.\n+            // If we didn't, we can now safely block on our ReadFile() call.\n+            if (overlappedPending)\n             {\n-                // EXIT POINT\n-                _indicateExitWithStatus(result); // print a message\n-                _transitionToState(ConnectionState::Failed);\n-                return gsl::narrow_cast<DWORD>(result);\n+                overlappedPending = false;\n+                if (FAILED(Utils::GetOverlappedResultSameThread(&overlapped, &read)))\n+                {\n+                    break;\n+                }\n             }\n \n-            if (wstr.empty())\n+            // winsock2 (WSA) handles of the \\Device\\Afd type are transparently compatible with\n+            // ReadFile() and the WSARecv() documentations contains this important information:\n+            // > For byte streams, zero bytes having been read [..] indicates graceful closure and that no more bytes will ever be read.\n+            // --> Exit if we've read 0 bytes.\n+            if (read == 0)\n             {\n-                return 0;\n+                break;\n             }\n \n-            if (!_receivedFirstByte)\n+            if (_isStateAtOrBeyond(ConnectionState::Closing))\n             {\n-                const auto now = std::chrono::high_resolution_clock::now();\n-                const std::chrono::duration<double> delta = now - _startTime;\n-\n-#pragma warning(suppress : 26477 26485 26494 26482 26446) // We don't control TraceLoggingWrite\n-                TraceLoggingWrite(g_hTerminalConnectionProvider,\n-                                  \"ReceivedFirstByte\",\n-                                  TraceLoggingDescription(\"An event emitted when the connection receives the first byte\"),\n-                                  TraceLoggingGuid(_sessionId, \"SessionGuid\", \"The WT_SESSION's GUID\"),\n-                                  TraceLoggingFloat64(delta.count(), \"Duration\"),\n-                                  TraceLoggingKeyword(MICROSOFT_KEYWORD_MEASURES),\n-                                  TelemetryPrivacyDataTag(PDT_ProductAndServicePerformance));\n-                _receivedFirstByte = true;\n+                break;\n             }\n \n-            // Pass the output to our registered event handlers\n-            TerminalOutput.raise(wstr);\n+            TraceLoggingWrite(\n+                g_hTerminalConnectionProvider,\n+                \"ReadFile\",\n+                TraceLoggingCountedUtf8String(&buffer[0], read, \"buffer\"),\n+                TraceLoggingGuid(_sessionId, \"session\"),\n+                TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\n+                TraceLoggingKeyword(TIL_KEYWORD_TRACE));\n+\n+            // If we hit a parsing error, eat it. It's bad utf-8, we can't do anything with it.\n+            FAILED_LOG(til::u8u16({ &buffer[0], gsl::narrow_cast<size_t>(read) }, wstr, u8State));\n         }\n \n         return 0;\ndiff --git a/src/cascadia/TerminalConnection/ConptyConnection.h b/src/cascadia/TerminalConnection/ConptyConnection.h\nindex 5c604ec29a3..6fd476b0cb0 100644\n--- a/src/cascadia/TerminalConnection/ConptyConnection.h\n+++ b/src/cascadia/TerminalConnection/ConptyConnection.h\n@@ -5,9 +5,10 @@\n \n #include \"ConptyConnection.g.h\"\n #include \"BaseTerminalConnection.h\"\n-\n #include \"ITerminalHandoff.h\"\n+\n #include <til/env.h>\n+#include <til/ticket_lock.h>\n \n namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n {\n@@ -74,12 +75,17 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n         bool _receivedFirstByte{ false };\n         std::chrono::high_resolution_clock::time_point _startTime{};\n \n-        wil::unique_hfile _inPipe; // The pipe for writing input to\n-        wil::unique_hfile _outPipe; // The pipe for reading output from\n+        wil::unique_hfile _pipe;\n         wil::unique_handle _hOutputThread;\n         wil::unique_process_information _piClient;\n         wil::unique_any<HPCON, decltype(closePseudoConsoleAsync), closePseudoConsoleAsync> _hPC;\n \n+        til::ticket_lock _writeLock;\n+        wil::unique_event _writeOverlappedEvent;\n+        OVERLAPPED _writeOverlapped{};\n+        std::string _writeBuffer;\n+        bool _writePending = false;\n+\n         DWORD _flags{ 0 };\n \n         til::env _initialEnv{};\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 01987a3bd5e..2aec6b1445a 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -52,14 +52,6 @@ void Terminal::Create(til::size viewportSize, til::CoordType scrollbackLines, Re\n     auto dispatch = std::make_unique<AdaptDispatch>(*this, &renderer, _renderSettings, _terminalInput);\r\n     auto engine = std::make_unique<OutputStateMachineEngine>(std::move(dispatch));\r\n     _stateMachine = std::make_unique<StateMachine>(std::move(engine));\r\n-\r\n-    // Until we have a true pass-through mode (GH#1173), the decision as to\r\n-    // whether C1 controls are interpreted or not is made at the conhost level.\r\n-    // If they are being filtered out, then we will simply never receive them.\r\n-    // But if they are being accepted by conhost, there's a chance they may get\r\n-    // passed through in some situations, so it's important that our state\r\n-    // machine is always prepared to accept them.\r\n-    _stateMachine->SetParserMode(StateMachine::Mode::AlwaysAcceptC1, true);\r\n }\r\n \r\n // Method Description:\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex 663a649dc28..2c4b72fe9d3 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -47,7 +47,6 @@ namespace TerminalCoreUnitTests\n {\r\n     class TerminalBufferTests;\r\n     class TerminalApiTest;\r\n-    class ConptyRoundtripTests;\r\n     class ScrollTest;\r\n };\r\n #endif\r\n@@ -150,7 +149,6 @@ class Microsoft::Terminal::Core::Terminal final :\n     void UseAlternateScreenBuffer(const TextAttribute& attrs) override;\r\n     void UseMainScreenBuffer() override;\r\n \r\n-    bool IsConsolePty() const noexcept override;\r\n     bool IsVtInputEnabled() const noexcept override;\r\n     void NotifyAccessibilityChange(const til::rect& changedRect) noexcept override;\r\n     void NotifyBufferRotation(const int delta) override;\r\n@@ -480,7 +478,6 @@ class Microsoft::Terminal::Core::Terminal final :\n #ifdef UNIT_TESTING\r\n     friend class TerminalCoreUnitTests::TerminalBufferTests;\r\n     friend class TerminalCoreUnitTests::TerminalApiTest;\r\n-    friend class TerminalCoreUnitTests::ConptyRoundtripTests;\r\n     friend class TerminalCoreUnitTests::ScrollTest;\r\n #endif\r\n };\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex f916521d91a..5982d184c52 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -310,11 +310,6 @@ void Terminal::ShowWindow(bool showOrHide)\n     }\r\n }\r\n \r\n-bool Terminal::IsConsolePty() const noexcept\r\n-{\r\n-    return false;\r\n-}\r\n-\r\n bool Terminal::IsVtInputEnabled() const noexcept\r\n {\r\n     return false;\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\nindex c9f2dbb2ae6..2aaaed243f3 100644\n--- a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n@@ -273,8 +273,6 @@ namespace ControlUnitTests\n         // contents. ConPTY will handle the actual clearing of the buffer\r\n         // contents. We can only ensure that the viewport moved when we did a\r\n         // clear scrollback.\r\n-        //\r\n-        // The ConptyRoundtripTests test the actual clearing of the contents.\r\n     }\r\n     void ControlCoreTests::TestClearScreen()\r\n     {\r\n@@ -312,8 +310,6 @@ namespace ControlUnitTests\n         // contents. ConPTY will handle the actual clearing of the buffer\r\n         // contents. We can only ensure that the viewport moved when we did a\r\n         // clear scrollback.\r\n-        //\r\n-        // The ConptyRoundtripTests test the actual clearing of the contents.\r\n     }\r\n     void ControlCoreTests::TestClearAll()\r\n     {\r\n@@ -351,8 +347,6 @@ namespace ControlUnitTests\n         // contents. ConPTY will handle the actual clearing of the buffer\r\n         // contents. We can only ensure that the viewport moved when we did a\r\n         // clear scrollback.\r\n-        //\r\n-        // The ConptyRoundtripTests test the actual clearing of the contents.\r\n     }\r\n \r\n     void ControlCoreTests::TestReadEntireBuffer()\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/ConptyRoundtripTests.cpp b/src/cascadia/UnitTests_TerminalCore/ConptyRoundtripTests.cpp\ndeleted file mode 100644\nindex 2f965351b59..00000000000\n--- a/src/cascadia/UnitTests_TerminalCore/ConptyRoundtripTests.cpp\n+++ /dev/null\n@@ -1,5055 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-//\r\n-// This test class creates an in-proc conpty host as well as a Terminal, to\r\n-// validate that strings written to the conpty create the same response on the\r\n-// terminal end. Tests can be written that validate both the contents of the\r\n-// host buffer as well as the terminal buffer. Every time that\r\n-// `renderer.PaintFrame()` is called, the tests will validate the expected\r\n-// output, and then flush the output of the VtEngine straight to the Terminal.\r\n-\r\n-#include \"pch.h\"\r\n-#include \"../../types/inc/Viewport.hpp\"\r\n-#include \"../../types/inc/convert.hpp\"\r\n-\r\n-#include \"../renderer/inc/DummyRenderer.hpp\"\r\n-#include \"../../renderer/base/Renderer.hpp\"\r\n-#include \"../../renderer/vt/Xterm256Engine.hpp\"\r\n-#include \"../../renderer/vt/XtermEngine.hpp\"\r\n-\r\n-#include \"../host/inputBuffer.hpp\"\r\n-#include \"../host/readDataCooked.hpp\"\r\n-#include \"../host/output.h\"\r\n-#include \"../host/_stream.h\" // For WriteCharsLegacy\r\n-#include \"test/CommonState.hpp\"\r\n-\r\n-#include \"../cascadia/TerminalCore/Terminal.hpp\"\r\n-\r\n-#include \"../../inc/TestUtils.h\"\r\n-\r\n-using namespace WEX::Common;\r\n-using namespace WEX::Logging;\r\n-using namespace WEX::TestExecution;\r\n-using namespace Microsoft::Console::Types;\r\n-using namespace Microsoft::Console::Interactivity;\r\n-using namespace Microsoft::Console::VirtualTerminal;\r\n-\r\n-using namespace Microsoft::Console;\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-using namespace Microsoft::Terminal::Core;\r\n-\r\n-namespace TerminalCoreUnitTests\r\n-{\r\n-    class ConptyRoundtripTests;\r\n-};\r\n-using namespace TerminalCoreUnitTests;\r\n-\r\n-class TerminalCoreUnitTests::ConptyRoundtripTests final\r\n-{\r\n-    // !!! DANGER: Many tests in this class expect the Terminal and Host buffers\r\n-    // to be 80x32. If you change these, you'll probably inadvertently break a\r\n-    // bunch of tests !!!\r\n-    static const til::CoordType TerminalViewWidth = 80;\r\n-    static const til::CoordType TerminalViewHeight = 32;\r\n-\r\n-    // This test class is for tests that are supposed to emit something in the PTY layer\r\n-    // and then check that they've been staged for presentation correctly inside\r\n-    // the Terminal application. Which sequences were used to get here don't matter.\r\n-    TEST_CLASS(ConptyRoundtripTests);\r\n-\r\n-    TEST_CLASS_SETUP(ClassSetup)\r\n-    {\r\n-        m_state = std::make_unique<CommonState>();\r\n-\r\n-        m_state->InitEvents();\r\n-        m_state->PrepareGlobalInputBuffer();\r\n-        m_state->PrepareGlobalRenderer();\r\n-        m_state->PrepareGlobalScreenBuffer(TerminalViewWidth, TerminalViewHeight, TerminalViewWidth, TerminalViewHeight);\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_CLASS_CLEANUP(ClassCleanup)\r\n-    {\r\n-        m_state->CleanupGlobalScreenBuffer();\r\n-        m_state->CleanupGlobalRenderer();\r\n-        m_state->CleanupGlobalInputBuffer();\r\n-\r\n-        m_state.release();\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_METHOD_SETUP(MethodSetup)\r\n-    {\r\n-        // STEP 1: Set up the Terminal\r\n-        term = std::make_unique<Terminal>(Terminal::TestDummyMarker{});\r\n-        emptyRenderer = std::make_unique<DummyRenderer>(term.get());\r\n-        term->Create({ TerminalViewWidth, TerminalViewHeight }, 100, *emptyRenderer);\r\n-\r\n-        // STEP 2: Set up the Conpty\r\n-\r\n-        // Set up some sane defaults\r\n-        auto& g = ServiceLocator::LocateGlobals();\r\n-        auto& gci = g.getConsoleInformation();\r\n-\r\n-        gci.SetColorTableEntry(TextColor::DEFAULT_FOREGROUND, INVALID_COLOR);\r\n-        gci.SetColorTableEntry(TextColor::DEFAULT_BACKGROUND, INVALID_COLOR);\r\n-        gci.SetFillAttribute(0x07); // DARK_WHITE on DARK_BLACK\r\n-        gci.CalculateDefaultColorIndices();\r\n-\r\n-        m_state->PrepareNewTextBufferInfo(true, TerminalViewWidth, TerminalViewHeight);\r\n-        auto& currentBuffer = gci.GetActiveOutputBuffer();\r\n-        // Make sure a test hasn't left us in the alt buffer on accident\r\n-        VERIFY_IS_FALSE(currentBuffer._IsAltBuffer());\r\n-        VERIFY_SUCCEEDED(currentBuffer.SetViewportOrigin(true, { 0, 0 }, true));\r\n-        VERIFY_ARE_EQUAL(til::point{}, currentBuffer.GetTextBuffer().GetCursor().GetPosition());\r\n-\r\n-        // Set up an xterm-256 renderer for conpty\r\n-        auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-        auto initialViewport = currentBuffer.GetViewport();\r\n-\r\n-        auto vtRenderEngine = std::make_unique<Xterm256Engine>(std::move(hFile),\r\n-                                                               initialViewport);\r\n-        auto pfn = std::bind(&ConptyRoundtripTests::_writeCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-        vtRenderEngine->SetTestCallback(pfn);\r\n-\r\n-        // Enable the resize quirk, as the Terminal is going to be reacting as if it's enabled.\r\n-        vtRenderEngine->SetResizeQuirk(true);\r\n-\r\n-        // Configure the OutputStateMachine's _pfnFlushToTerminal\r\n-        // Use OutputStateMachineEngine::SetTerminalConnection\r\n-        g.pRender->AddRenderEngine(vtRenderEngine.get());\r\n-        gci.GetActiveOutputBuffer().SetTerminalConnection(vtRenderEngine.get());\r\n-\r\n-        _pConApi = std::make_unique<ConhostInternalGetSet>(gci);\r\n-\r\n-        // Manually set the console into conpty mode. We're not actually going\r\n-        // to set up the pipes for conpty, but we want the console to behave\r\n-        // like it would in conpty mode.\r\n-        //\r\n-        // Also, make sure to backdoor enable the resize quirk here too.\r\n-        g.EnableConptyModeForTests(std::move(vtRenderEngine), true);\r\n-\r\n-        expectedOutput.clear();\r\n-        _checkConptyOutput = true;\r\n-        _logConpty = false;\r\n-\r\n-        VERIFY_ARE_EQUAL(gci.GetActiveOutputBuffer().GetViewport().Dimensions(),\r\n-                         gci.GetActiveOutputBuffer().GetBufferSize().Dimensions(),\r\n-                         L\"If this test fails, then there's a good chance \"\r\n-                         L\"another test resized the buffer but didn't use IsolationLevel:Method\");\r\n-        VERIFY_ARE_EQUAL(gci.GetActiveOutputBuffer().GetViewport(),\r\n-                         gci.GetActiveOutputBuffer().GetBufferSize(),\r\n-                         L\"If this test fails, then there's a good chance \"\r\n-                         L\"another test resized the buffer but didn't use IsolationLevel:Method\");\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_METHOD_CLEANUP(MethodCleanup)\r\n-    {\r\n-        m_state->CleanupNewTextBufferInfo();\r\n-\r\n-        auto& engines = ServiceLocator::LocateGlobals().pRender->_engines;\r\n-        std::fill(engines.begin(), engines.end(), nullptr);\r\n-\r\n-        VERIFY_ARE_EQUAL(0u, expectedOutput.size(), L\"Tests should drain all the output they push into the expected output buffer.\");\r\n-\r\n-        emptyRenderer = nullptr;\r\n-        term = nullptr;\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_METHOD(ConptyOutputTestCanary);\r\n-    TEST_METHOD(SimpleWriteOutputTest);\r\n-    TEST_METHOD(WriteTwoLinesUsesNewline);\r\n-    TEST_METHOD(WriteAFewSimpleLines);\r\n-\r\n-    TEST_METHOD(PassthroughClearScrollback);\r\n-\r\n-    TEST_METHOD(PassthroughClearAll);\r\n-\r\n-    TEST_METHOD(PassthroughHardReset);\r\n-\r\n-    TEST_METHOD(PassthroughCursorShapeImmediately);\r\n-\r\n-    TEST_METHOD(PassthroughDECCTR);\r\n-\r\n-    TEST_METHOD(TestWrappingALongString);\r\n-    TEST_METHOD(TestAdvancedWrapping);\r\n-    TEST_METHOD(TestExactWrappingWithoutSpaces);\r\n-    TEST_METHOD(TestExactWrappingWithSpaces);\r\n-\r\n-    TEST_METHOD(MoveCursorAtEOL);\r\n-\r\n-    TEST_METHOD(TestResizeHeight);\r\n-\r\n-    TEST_METHOD(OutputWrappedLinesAtTopOfBuffer);\r\n-    TEST_METHOD(OutputWrappedLinesAtBottomOfBuffer);\r\n-    TEST_METHOD(ScrollWithChangesInMiddle);\r\n-    TEST_METHOD(DontWrapMoveCursorInSingleFrame);\r\n-    TEST_METHOD(ClearHostTrickeryTest);\r\n-    TEST_METHOD(OverstrikeAtBottomOfBuffer);\r\n-    TEST_METHOD(MarginsWithStatusLine);\r\n-    TEST_METHOD(OutputWrappedLineWithSpace);\r\n-    TEST_METHOD(OutputWrappedLineWithSpaceAtBottomOfBuffer);\r\n-\r\n-    TEST_METHOD(BreakLinesOnCursorMovement);\r\n-\r\n-    TEST_METHOD(ScrollWithMargins);\r\n-\r\n-    TEST_METHOD(TestCursorInDeferredEOLPositionOnNewLineWithSpaces);\r\n-\r\n-    TEST_METHOD(ResizeRepaintVimExeBuffer);\r\n-\r\n-    TEST_METHOD(ClsAndClearHostClearsScrollbackTest);\r\n-\r\n-    TEST_METHOD(TestResizeWithCookedRead);\r\n-\r\n-    TEST_METHOD(NewLinesAtBottomWithBackground);\r\n-\r\n-    TEST_METHOD(WrapNewLineAtBottom);\r\n-    TEST_METHOD(WrapNewLineAtBottomLikeMSYS);\r\n-\r\n-    TEST_METHOD(DeleteWrappedWord);\r\n-\r\n-    TEST_METHOD(HyperlinkIdConsistency);\r\n-\r\n-    TEST_METHOD(ResizeInitializeBufferWithDefaultAttrs);\r\n-\r\n-    TEST_METHOD(ClearBufferSignal);\r\n-\r\n-    TEST_METHOD(SimpleAltBufferTest);\r\n-    TEST_METHOD(AltBufferToAltBufferTest);\r\n-\r\n-    TEST_METHOD(TestPowerLineFirstFrame);\r\n-\r\n-    TEST_METHOD(AltBufferResizeCrash);\r\n-\r\n-    TEST_METHOD(TestNoExtendedAttrsOptimization);\r\n-    TEST_METHOD(TestNoBackgroundAttrsOptimization);\r\n-\r\n-    TEST_METHOD(SimplePromptRegions);\r\n-    TEST_METHOD(MultilinePromptRegions);\r\n-    TEST_METHOD(ManyMultilinePromptsWithTrailingSpaces);\r\n-    TEST_METHOD(ReflowPromptRegions);\r\n-    TEST_METHOD(ClearMarksTest);\r\n-\r\n-private:\r\n-    bool _writeCallback(const char* const pch, const size_t cch);\r\n-    void _flushFirstFrame();\r\n-    void _resizeConpty(const til::CoordType sx, const til::CoordType sy);\r\n-    void _clearConpty();\r\n-    void _clear(int clearBufferMethod, SCREEN_INFORMATION& si);\r\n-\r\n-    [[nodiscard]] std::tuple<TextBuffer*, TextBuffer*> _performResize(const til::size newSize);\r\n-\r\n-    std::deque<std::string> expectedOutput;\r\n-\r\n-    std::unique_ptr<CommonState> m_state;\r\n-    std::unique_ptr<Microsoft::Console::VirtualTerminal::ITerminalApi> _pConApi;\r\n-\r\n-    // Tests can set these variables how they link to configure the behavior of the test harness.\r\n-    bool _checkConptyOutput{ true }; // If true, the test class will check that the output from conpty was expected\r\n-    bool _logConpty{ false }; // If true, the test class will log all the output from conpty. Helpful for debugging.\r\n-\r\n-    std::unique_ptr<DummyRenderer> emptyRenderer;\r\n-    std::unique_ptr<Terminal> term;\r\n-\r\n-    ApiRoutines _apiRoutines;\r\n-};\r\n-\r\n-bool ConptyRoundtripTests::_writeCallback(const char* const pch, const size_t cch)\r\n-{\r\n-    auto actualString = std::string(pch, cch);\r\n-\r\n-    if (_checkConptyOutput)\r\n-    {\r\n-        VERIFY_IS_GREATER_THAN(expectedOutput.size(),\r\n-                               static_cast<size_t>(0),\r\n-                               NoThrowString().Format(L\"writing=\\\"%hs\\\", expecting %u strings\", TestUtils::ReplaceEscapes(actualString).c_str(), expectedOutput.size()));\r\n-\r\n-        auto first = expectedOutput.front();\r\n-        expectedOutput.pop_front();\r\n-\r\n-        Log::Comment(NoThrowString().Format(L\"Expected =\\t\\\"%hs\\\"\", TestUtils::ReplaceEscapes(first).c_str()));\r\n-        Log::Comment(NoThrowString().Format(L\"Actual =\\t\\\"%hs\\\"\", TestUtils::ReplaceEscapes(actualString).c_str()));\r\n-\r\n-        VERIFY_ARE_EQUAL(first.length(), cch);\r\n-        VERIFY_ARE_EQUAL(first, actualString);\r\n-    }\r\n-    else if (_logConpty)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Writing \\\"%hs\\\" to Terminal\", TestUtils::ReplaceEscapes(actualString).c_str()));\r\n-    }\r\n-\r\n-    // Write the string back to our Terminal\r\n-    const auto converted = ConvertToW(CP_UTF8, actualString);\r\n-    term->Write(converted);\r\n-\r\n-    return true;\r\n-}\r\n-\r\n-void ConptyRoundtripTests::_flushFirstFrame()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[2J\");\r\n-    expectedOutput.push_back(\"\\x1b[m\");\r\n-    expectedOutput.push_back(\"\\x1b[H\"); // Go Home\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::_resizeConpty(const til::CoordType sx,\r\n-                                         const til::CoordType sy)\r\n-{\r\n-    // Largely taken from implementation in PtySignalInputThread::_InputThread\r\n-    if (_pConApi->ResizeWindow(sx, sy))\r\n-    {\r\n-        auto& g = ServiceLocator::LocateGlobals();\r\n-        auto& gci = g.getConsoleInformation();\r\n-        VERIFY_SUCCEEDED(gci.GetVtIo()->SuppressResizeRepaint());\r\n-    }\r\n-}\r\n-\r\n-void ConptyRoundtripTests::_clearConpty()\r\n-{\r\n-    // Taken verbatim from implementation in PtySignalInputThread::_DoClearBuffer\r\n-    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-    THROW_IF_FAILED(gci.GetActiveOutputBuffer().ClearBuffer());\r\n-}\r\n-\r\n-[[nodiscard]] std::tuple<TextBuffer*, TextBuffer*> ConptyRoundtripTests::_performResize(const til::size newSize)\r\n-{\r\n-    // IMPORTANT! Anyone calling this should make sure that the test is running\r\n-    // in IsolationLevel: Method. If you don't add that, then it might secretly\r\n-    // pollute other tests!\r\n-\r\n-    Log::Comment(L\"========== Resize the Terminal and conpty ==========\");\r\n-\r\n-    auto resizeResult = term->UserResize(newSize);\r\n-    VERIFY_SUCCEEDED(resizeResult);\r\n-    _resizeConpty(newSize.width, newSize.height);\r\n-\r\n-    // After we resize, make sure to get the new textBuffers\r\n-    TextBuffer* hostTb = &ServiceLocator::LocateGlobals().getConsoleInformation().GetActiveOutputBuffer().GetTextBuffer();\r\n-    TextBuffer* termTb = term->_mainBuffer.get();\r\n-    return { hostTb, termTb };\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ConptyOutputTestCanary()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"This is a simple test to make sure that everything is working as expected.\"));\r\n-\r\n-    _flushFirstFrame();\r\n-}\r\n-\r\n-void ConptyRoundtripTests::SimpleWriteOutputTest()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write some simple output, and make sure it gets rendered largely \"\r\n-        L\"unmodified to the terminal\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    expectedOutput.push_back(\"Hello World\");\r\n-    hostSm.ProcessString(L\"Hello World\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    TestUtils::VerifyExpectedString(termTb, L\"Hello World \", { 0, 0 });\r\n-}\r\n-\r\n-void ConptyRoundtripTests::WriteTwoLinesUsesNewline()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write two lines of output. We should use \\r\\n to move the cursor\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    hostSm.ProcessString(L\"AAA\");\r\n-    hostSm.ProcessString(L\"\\x1b[2;1H\");\r\n-    hostSm.ProcessString(L\"BBB\");\r\n-\r\n-    auto verifyData = [](TextBuffer& tb) {\r\n-        TestUtils::VerifyExpectedString(tb, L\"AAA\", { 0, 0 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"BBB\", { 0, 1 });\r\n-    };\r\n-\r\n-    verifyData(hostTb);\r\n-\r\n-    expectedOutput.push_back(\"AAA\");\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    expectedOutput.push_back(\"BBB\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyData(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::WriteAFewSimpleLines()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write more lines of output. We should use \\r\\n to move the cursor\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    hostSm.ProcessString(L\"AAA\\n\");\r\n-    hostSm.ProcessString(L\"BBB\\n\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"CCC\");\r\n-    auto verifyData = [](TextBuffer& tb) {\r\n-        TestUtils::VerifyExpectedString(tb, L\"AAA\", { 0, 0 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"BBB\", { 0, 1 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"   \", { 0, 2 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"CCC\", { 0, 3 });\r\n-    };\r\n-\r\n-    verifyData(hostTb);\r\n-\r\n-    expectedOutput.push_back(\"AAA\");\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    expectedOutput.push_back(\"BBB\");\r\n-    // Jump down to the fourth line because emitting spaces didn't do anything\r\n-    // and we will skip to emitting the CCC segment.\r\n-    expectedOutput.push_back(\"\\x1b[4;1H\");\r\n-    expectedOutput.push_back(\"CCC\");\r\n-\r\n-    // Cursor goes back on.\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyData(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestWrappingALongString()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-    _checkConptyOutput = false;\r\n-\r\n-    const auto initialTermView = term->GetViewport();\r\n-\r\n-    const auto charsToWrite = gsl::narrow_cast<til::CoordType>(TestUtils::Test100CharsString.size());\r\n-    VERIFY_ARE_EQUAL(100, charsToWrite);\r\n-\r\n-    VERIFY_ARE_EQUAL(0, initialTermView.Top());\r\n-    VERIFY_ARE_EQUAL(32, initialTermView.BottomExclusive());\r\n-\r\n-    hostSm.ProcessString(TestUtils::Test100CharsString);\r\n-\r\n-    const auto secondView = term->GetViewport();\r\n-\r\n-    VERIFY_ARE_EQUAL(0, secondView.Top());\r\n-    VERIFY_ARE_EQUAL(32, secondView.BottomExclusive());\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        auto& cursor = tb.GetCursor();\r\n-        // Verify the cursor wrapped to the second line\r\n-        VERIFY_ARE_EQUAL(charsToWrite % initialTermView.Width(), cursor.GetPosition().x);\r\n-        VERIFY_ARE_EQUAL(1, cursor.GetPosition().y);\r\n-\r\n-        // Verify that we marked the 0th row as _wrapped_\r\n-        const auto& row0 = tb.GetRowByOffset(0);\r\n-        VERIFY_IS_TRUE(row0.WasWrapForced());\r\n-\r\n-        const auto& row1 = tb.GetRowByOffset(1);\r\n-        VERIFY_IS_FALSE(row1.WasWrapForced());\r\n-\r\n-        TestUtils::VerifyExpectedString(tb, TestUtils::Test100CharsString, { 0, 0 });\r\n-    };\r\n-\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyBuffer(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestAdvancedWrapping()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-    const auto initialTermView = term->GetViewport();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    const auto charsToWrite = gsl::narrow_cast<til::CoordType>(TestUtils::Test100CharsString.size());\r\n-    VERIFY_ARE_EQUAL(100, charsToWrite);\r\n-\r\n-    hostSm.ProcessString(TestUtils::Test100CharsString);\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"          \");\r\n-    hostSm.ProcessString(L\"1234567890\");\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        auto& cursor = tb.GetCursor();\r\n-        // Verify the cursor wrapped to the second line\r\n-        VERIFY_ARE_EQUAL(2, cursor.GetPosition().y);\r\n-        VERIFY_ARE_EQUAL(20, cursor.GetPosition().x);\r\n-\r\n-        // Verify that we marked the 0th row as _wrapped_\r\n-        const auto& row0 = tb.GetRowByOffset(0);\r\n-        VERIFY_IS_TRUE(row0.WasWrapForced());\r\n-\r\n-        const auto& row1 = tb.GetRowByOffset(1);\r\n-        VERIFY_IS_FALSE(row1.WasWrapForced());\r\n-\r\n-        TestUtils::VerifyExpectedString(tb, TestUtils::Test100CharsString, { 0, 0 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"          1234567890\", { 0, 2 });\r\n-    };\r\n-\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    // First write the first 80 characters from the string\r\n-    expectedOutput.push_back(R\"(!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnop)\");\r\n-    // Without line breaking, write the remaining 20 chars\r\n-    expectedOutput.push_back(R\"(qrstuvwxyz{|}~!\"#$%&)\");\r\n-    // This is the hard line break\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    // Now write row 2 of the buffer\r\n-    expectedOutput.push_back(\"          1234567890\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyBuffer(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestExactWrappingWithoutSpaces()\r\n-{\r\n-    // This test (and TestExactWrappingWitSpaces) reveals a bug in the old\r\n-    // implementation.\r\n-    //\r\n-    // If a line _exactly_ wraps to the next line, we can't tell if the line\r\n-    // should really wrap, or manually break. The client app is writing a line\r\n-    // that's exactly the width of the buffer that manually breaks at the\r\n-    // end of the line, followed by another line.\r\n-    //\r\n-    // With the old PaintBufferLine interface, there's no way to know if this\r\n-    // case is because the line wrapped or not. Hence, the addition of the\r\n-    // `lineWrapped` parameter\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    const auto initialTermView = term->GetViewport();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    const auto charsToWrite = initialTermView.Width();\r\n-    VERIFY_ARE_EQUAL(80, charsToWrite);\r\n-\r\n-    for (auto i = 0; i < charsToWrite; i++)\r\n-    {\r\n-        // This is a handy way of just printing the printable characters that\r\n-        // _aren't_ the space character.\r\n-        const auto wch = static_cast<wchar_t>(33 + (i % 94));\r\n-        hostSm.ProcessCharacter(wch);\r\n-    }\r\n-\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"1234567890\");\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        auto& cursor = tb.GetCursor();\r\n-        // Verify the cursor wrapped to the second line\r\n-        VERIFY_ARE_EQUAL(1, cursor.GetPosition().y);\r\n-        VERIFY_ARE_EQUAL(10, cursor.GetPosition().x);\r\n-\r\n-        // Verify that we marked the 0th row as _not wrapped_\r\n-        const auto& row0 = tb.GetRowByOffset(0);\r\n-        VERIFY_IS_FALSE(row0.WasWrapForced());\r\n-\r\n-        const auto& row1 = tb.GetRowByOffset(1);\r\n-        VERIFY_IS_FALSE(row1.WasWrapForced());\r\n-\r\n-        TestUtils::VerifyExpectedString(tb, LR\"(!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnop)\", { 0, 0 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"1234567890\", { 0, 1 });\r\n-    };\r\n-\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    // First write the first 80 characters from the string\r\n-    expectedOutput.push_back(R\"(!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnop)\");\r\n-\r\n-    // This is the hard line break\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    // Now write row 2 of the buffer\r\n-    expectedOutput.push_back(\"1234567890\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyBuffer(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestExactWrappingWithSpaces()\r\n-{\r\n-    // This test is also explained by the comment at the top of TestExactWrappingWithoutSpaces\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-    const auto initialTermView = term->GetViewport();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    const auto charsToWrite = initialTermView.Width();\r\n-    VERIFY_ARE_EQUAL(80, charsToWrite);\r\n-\r\n-    for (auto i = 0; i < charsToWrite; i++)\r\n-    {\r\n-        // This is a handy way of just printing the printable characters that\r\n-        // _aren't_ the space character.\r\n-        const auto wch = static_cast<wchar_t>(33 + (i % 94));\r\n-        hostSm.ProcessCharacter(wch);\r\n-    }\r\n-\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"          \");\r\n-    hostSm.ProcessString(L\"1234567890\");\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        auto& cursor = tb.GetCursor();\r\n-        // Verify the cursor wrapped to the second line\r\n-        VERIFY_ARE_EQUAL(1, cursor.GetPosition().y);\r\n-        VERIFY_ARE_EQUAL(20, cursor.GetPosition().x);\r\n-\r\n-        // Verify that we marked the 0th row as _not wrapped_\r\n-        const auto& row0 = tb.GetRowByOffset(0);\r\n-        VERIFY_IS_FALSE(row0.WasWrapForced());\r\n-\r\n-        const auto& row1 = tb.GetRowByOffset(1);\r\n-        VERIFY_IS_FALSE(row1.WasWrapForced());\r\n-\r\n-        TestUtils::VerifyExpectedString(tb, LR\"(!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnop)\", { 0, 0 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"          1234567890\", { 0, 1 });\r\n-    };\r\n-\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    // First write the first 80 characters from the string\r\n-    expectedOutput.push_back(R\"(!\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnop)\");\r\n-\r\n-    // This is the hard line break\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    // Now write row 2 of the buffer\r\n-    expectedOutput.push_back(\"          1234567890\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyBuffer(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::MoveCursorAtEOL()\r\n-{\r\n-    // This is a test for GH#1245\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-    _flushFirstFrame();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write exactly a full line of text\"));\r\n-    hostSm.ProcessString(std::wstring(TerminalViewWidth, L'A'));\r\n-\r\n-    auto verifyData0 = [](TextBuffer& tb) {\r\n-        auto iter = tb.GetCellDataAt({ 0, 0 });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter, 0, TerminalViewWidth);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter, 0, TerminalViewWidth);\r\n-    };\r\n-\r\n-    verifyData0(hostTb);\r\n-\r\n-    // TODO: GH#405/#4415 - Before #405 merges, the VT sequences conpty emits\r\n-    // might change, but the buffer contents shouldn't.\r\n-    // If they do change and these tests break, that's to be expected.\r\n-    expectedOutput.push_back(std::string(TerminalViewWidth, 'A'));\r\n-    expectedOutput.push_back(\"\\x1b[1;80H\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyData0(termTb);\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Emulate backspacing at a bash prompt when the previous line wrapped.\\n\"\r\n-        L\"We'll move the cursor up to the last char of the prev line, and erase it.\"));\r\n-    hostSm.ProcessString(L\"\\x1b[1;80H\");\r\n-    hostSm.ProcessString(L\"\\x1b[K\");\r\n-\r\n-    auto verifyData1 = [](TextBuffer& tb) {\r\n-        auto iter = tb.GetCellDataAt({ 0, 0 });\r\n-        // There should be 79 'A's, followed by a space, and the following line should be blank.\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter, 0, TerminalViewWidth - 1);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter, 0, 1);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter, 0, TerminalViewWidth);\r\n-\r\n-        auto& cursor = tb.GetCursor();\r\n-        VERIFY_ARE_EQUAL(TerminalViewWidth - 1, cursor.GetPosition().x);\r\n-        VERIFY_ARE_EQUAL(0, cursor.GetPosition().y);\r\n-    };\r\n-\r\n-    verifyData1(hostTb);\r\n-\r\n-    expectedOutput.push_back(\" \");\r\n-    expectedOutput.push_back(\"\\x1b[1;80H\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyData1(termTb);\r\n-\r\n-    // This test is sometimes flaky in cleanup.\r\n-    expectedOutput.clear();\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestResizeHeight()\r\n-{\r\n-    // This test class is _60_ tests to ensure that resizing the terminal works\r\n-    // with conpty correctly. There's a lot of min/maxing in expressions here,\r\n-    // to account for the sheer number of cases here, and that we have to handle\r\n-    // both resizing larger and smaller all in one test.\r\n-\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:dx\", L\"{-1, 0, 1}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:dy\", L\"{-10, -1, 0, 1, 10}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:printedRows\", L\"{1, 10, 50, 200}\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-    int dx, dy;\r\n-    int printedRows;\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"dx\", dx), L\"change in width of buffer\");\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"dy\", dy), L\"change in height of buffer\");\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"printedRows\", printedRows), L\"Number of rows of text to print\");\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-    const auto initialHostView = si.GetViewport();\r\n-    const auto initialTermView = term->GetViewport();\r\n-    const auto initialTerminalBufferHeight = term->GetTextBuffer().GetSize().Height();\r\n-\r\n-    VERIFY_ARE_EQUAL(0, initialHostView.Top());\r\n-    VERIFY_ARE_EQUAL(TerminalViewHeight, initialHostView.BottomExclusive());\r\n-    VERIFY_ARE_EQUAL(0, initialTermView.Top());\r\n-    VERIFY_ARE_EQUAL(TerminalViewHeight, initialTermView.BottomExclusive());\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Print %d lines of output, which will scroll the viewport\", printedRows));\r\n-\r\n-    for (auto i = 0; i < printedRows; i++)\r\n-    {\r\n-        // This looks insane, but this expression is carefully crafted to give\r\n-        // us only printable characters, starting with `!` (0n33).\r\n-        // Similar statements are used elsewhere throughout this test.\r\n-        auto wstr = std::wstring(1, static_cast<wchar_t>((i) % 93) + 33);\r\n-        hostSm.ProcessString(wstr);\r\n-        hostSm.ProcessString(L\"\\r\\n\");\r\n-    }\r\n-\r\n-    // Conpty doesn't have a scrollback, its view's origin is always 0,0\r\n-    const auto secondHostView = si.GetViewport();\r\n-    VERIFY_ARE_EQUAL(0, secondHostView.Top());\r\n-    VERIFY_ARE_EQUAL(TerminalViewHeight, secondHostView.BottomExclusive());\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    const auto secondTermView = term->GetViewport();\r\n-    // If we've printed more lines than the height of the buffer, then we're\r\n-    // expecting the viewport to have moved down. Otherwise, the terminal's\r\n-    // viewport will stay at 0,0.\r\n-    const auto expectedTerminalViewBottom = std::max(std::min(printedRows + 1, term->GetBufferHeight()), term->GetViewport().Height());\r\n-\r\n-    VERIFY_ARE_EQUAL(expectedTerminalViewBottom, secondTermView.BottomExclusive());\r\n-    VERIFY_ARE_EQUAL(expectedTerminalViewBottom - initialTermView.Height(), secondTermView.Top());\r\n-\r\n-    auto verifyTermData = [&expectedTerminalViewBottom, &printedRows, this, &initialTerminalBufferHeight](TextBuffer& termTb, const int resizeDy = 0) {\r\n-        // Some number of lines of text were lost from the scrollback. The\r\n-        // number of lines lost will be determined by whichever of the initial\r\n-        // or current buffer is smaller.\r\n-        const auto numLostRows = std::max(0,\r\n-                                          printedRows - std::min(term->GetTextBuffer().GetSize().Height(), initialTerminalBufferHeight) + 1);\r\n-\r\n-        const auto rowsWithText = std::min(printedRows, expectedTerminalViewBottom) - 1 + std::min(resizeDy, 0);\r\n-\r\n-        for (til::CoordType row = 0; row < rowsWithText; row++)\r\n-        {\r\n-            SetVerifyOutput settings(VerifyOutputSettings::LogOnlyFailures);\r\n-            auto iter = termTb.GetCellDataAt({ 0, row });\r\n-            const wchar_t expectedChar = static_cast<wchar_t>((row + numLostRows) % 93) + 33;\r\n-\r\n-            auto expectedString = std::wstring(1, expectedChar);\r\n-\r\n-            if (iter->Chars() != expectedString)\r\n-            {\r\n-                Log::Comment(NoThrowString().Format(L\"row [%d] was mismatched\", row));\r\n-            }\r\n-            VERIFY_ARE_EQUAL(expectedString, (iter++)->Chars());\r\n-            VERIFY_ARE_EQUAL(L\" \", (iter)->Chars());\r\n-        }\r\n-    };\r\n-    auto verifyHostData = [&si, &initialHostView, &printedRows](TextBuffer& hostTb, const int resizeDy = 0) {\r\n-        const auto hostView = si.GetViewport();\r\n-\r\n-        // In the host, there are two regions we're interested in:\r\n-\r\n-        // 1. the first section of the buffer with the output in it. Before\r\n-        //    we're resized, this will be filled with one character on each row.\r\n-        // 2. The second area below the first that's empty (filled with spaces).\r\n-        //    Initially, this is only one row.\r\n-        // After we resize, different things will happen.\r\n-        // * If we decrease the height of the buffer, the characters in the\r\n-        //   buffer will all move _up_ the same number of rows. We'll want to\r\n-        //   only check the first initialView+dy rows for characters.\r\n-        // * If we increase the height, rows will be added at the bottom. We'll\r\n-        //   want to check the initial viewport height for the original\r\n-        //   characters, but then we'll want to look for more blank rows at the\r\n-        //   bottom. The characters in the initial viewport won't have moved.\r\n-\r\n-        const auto originalViewHeight = resizeDy < 0 ? initialHostView.Height() + resizeDy : initialHostView.Height();\r\n-        const auto rowsWithText = std::min(originalViewHeight - 1, printedRows);\r\n-        const auto scrolled = printedRows > initialHostView.Height();\r\n-        // The last row of the viewport should be empty\r\n-        // The second last row will have '0'+50\r\n-        // The third last row will have '0'+49\r\n-        // ...\r\n-        // The <height> last row will have '0'+(50-height+1)\r\n-        const auto firstChar = static_cast<wchar_t>(scrolled ?\r\n-                                                        (printedRows - originalViewHeight + 1) :\r\n-                                                        0);\r\n-\r\n-        til::CoordType row = 0;\r\n-        // Don't include the last row of the viewport in this check, since it'll\r\n-        // be blank. We'll check it in the below loop.\r\n-        for (; row < rowsWithText; row++)\r\n-        {\r\n-            SetVerifyOutput settings(VerifyOutputSettings::LogOnlyFailures);\r\n-            auto iter = hostTb.GetCellDataAt({ 0, row });\r\n-\r\n-            const auto expectedChar = static_cast<wchar_t>(((firstChar + row) % 93) + 33);\r\n-            auto expectedString = std::wstring(1, static_cast<wchar_t>(expectedChar));\r\n-\r\n-            if (iter->Chars() != expectedString)\r\n-            {\r\n-                Log::Comment(NoThrowString().Format(L\"row [%d] was mismatched\", row));\r\n-            }\r\n-            VERIFY_ARE_EQUAL(expectedString, (iter++)->Chars(), NoThrowString().Format(L\"%s\", expectedString.data()));\r\n-            VERIFY_ARE_EQUAL(L\" \", (iter)->Chars());\r\n-        }\r\n-\r\n-        // Check that the remaining rows in the viewport are empty.\r\n-        for (; row < hostView.Height(); row++)\r\n-        {\r\n-            SetVerifyOutput settings(VerifyOutputSettings::LogOnlyFailures);\r\n-            auto iter = hostTb.GetCellDataAt({ 0, row });\r\n-            VERIFY_ARE_EQUAL(L\" \", (iter)->Chars());\r\n-        }\r\n-    };\r\n-\r\n-    verifyHostData(*hostTb);\r\n-    verifyTermData(*termTb);\r\n-\r\n-    const til::size newViewportSize{ TerminalViewWidth + dx,\r\n-                                     TerminalViewHeight + dy };\r\n-    // After we resize, make sure to get the new textBuffers\r\n-    std::tie(hostTb, termTb) = _performResize(newViewportSize);\r\n-\r\n-    // Conpty's doesn't have a scrollback, its view's origin is always 0,0\r\n-    const auto thirdHostView = si.GetViewport();\r\n-    VERIFY_ARE_EQUAL(0, thirdHostView.Top());\r\n-    VERIFY_ARE_EQUAL(newViewportSize.height, thirdHostView.BottomExclusive());\r\n-\r\n-    // The Terminal should be stuck to the top of the viewport, unless dy<0,\r\n-    // rows=50. In that set of cases, we _didn't_ pin the top of the Terminal to\r\n-    // the old top, we actually shifted it down (because the output was at the\r\n-    // bottom of the window, not empty lines).\r\n-    const auto thirdTermView = term->GetViewport();\r\n-    if (dy < 0 && (printedRows > initialTermView.Height() && printedRows < initialTerminalBufferHeight))\r\n-    {\r\n-        VERIFY_ARE_EQUAL(secondTermView.Top() - dy, thirdTermView.Top());\r\n-        VERIFY_ARE_EQUAL(expectedTerminalViewBottom, thirdTermView.BottomExclusive());\r\n-    }\r\n-    else\r\n-    {\r\n-        VERIFY_ARE_EQUAL(secondTermView.Top(), thirdTermView.Top());\r\n-        VERIFY_ARE_EQUAL(expectedTerminalViewBottom + dy, thirdTermView.BottomExclusive());\r\n-    }\r\n-\r\n-    verifyHostData(*hostTb, dy);\r\n-    // Note that at this point, nothing should have changed with the Terminal.\r\n-    verifyTermData(*termTb, dy);\r\n-\r\n-    Log::Comment(NoThrowString().Format(L\"Paint a frame to update the Terminal\"));\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Conpty's doesn't have a scrollback, its view's origin is always 0,0\r\n-    const auto fourthHostView = si.GetViewport();\r\n-    VERIFY_ARE_EQUAL(0, fourthHostView.Top());\r\n-    VERIFY_ARE_EQUAL(newViewportSize.height, fourthHostView.BottomExclusive());\r\n-\r\n-    // The Terminal should be stuck to the top of the viewport, unless dy<0,\r\n-    // rows=50. In that set of cases, we _didn't_ pin the top of the Terminal to\r\n-    // the old top, we actually shifted it down (because the output was at the\r\n-    // bottom of the window, not empty lines).\r\n-    const auto fourthTermView = term->GetViewport();\r\n-    if (dy < 0 && (printedRows > initialTermView.Height() && printedRows < initialTerminalBufferHeight))\r\n-    {\r\n-        VERIFY_ARE_EQUAL(secondTermView.Top() - dy, thirdTermView.Top());\r\n-        VERIFY_ARE_EQUAL(expectedTerminalViewBottom, thirdTermView.BottomExclusive());\r\n-    }\r\n-    else\r\n-    {\r\n-        VERIFY_ARE_EQUAL(secondTermView.Top(), thirdTermView.Top());\r\n-        VERIFY_ARE_EQUAL(expectedTerminalViewBottom + dy, thirdTermView.BottomExclusive());\r\n-    }\r\n-    verifyHostData(*hostTb, dy);\r\n-    verifyTermData(*termTb, dy);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::PassthroughCursorShapeImmediately()\r\n-{\r\n-    // This is a test for GH#4106, and more indirectly, GH #2011.\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Change the cursor shape with VT. This should immediately be flushed to the Terminal.\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _logConpty = true;\r\n-\r\n-    VERIFY_ARE_NOT_EQUAL(CursorType::VerticalBar, hostTb.GetCursor().GetType());\r\n-    VERIFY_ARE_NOT_EQUAL(CursorType::VerticalBar, termTb.GetCursor().GetType());\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[5 q\");\r\n-    hostSm.ProcessString(L\"\\x1b[5 q\");\r\n-\r\n-    VERIFY_ARE_EQUAL(CursorType::VerticalBar, hostTb.GetCursor().GetType());\r\n-    VERIFY_ARE_EQUAL(CursorType::VerticalBar, termTb.GetCursor().GetType());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::PassthroughClearScrollback()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write more lines of output than there are lines in the viewport. Clear the scrollback with ^[[3J\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _logConpty = true;\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"Writing line %d/%d\", i, end));\r\n-        expectedOutput.push_back(\"X\");\r\n-        if (i < hostView.BottomInclusive())\r\n-        {\r\n-            expectedOutput.push_back(\"\\r\\n\");\r\n-        }\r\n-        else\r\n-        {\r\n-            // After we hit the bottom of the viewport, the newlines come in\r\n-            // separated by empty writes for whatever reason.\r\n-            expectedOutput.push_back(\"\\r\");\r\n-            expectedOutput.push_back(\"\\n\");\r\n-            expectedOutput.push_back(\"\");\r\n-        }\r\n-\r\n-        hostSm.ProcessString(L\"X\\n\");\r\n-\r\n-        VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    }\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Verify that we've printed height*2 lines of X's to the Terminal\r\n-    const auto termFirstView = term->GetViewport();\r\n-    for (til::CoordType y = 0; y < 2 * termFirstView.Height(); y++)\r\n-    {\r\n-        TestUtils::VerifyExpectedString(termTb, L\"X  \", { 0, y });\r\n-    }\r\n-\r\n-    // Write a Erase Scrollback VT sequence to the host, it should come through to the Terminal\r\n-    expectedOutput.push_back(\"\\x1b[3J\");\r\n-    hostSm.ProcessString(L\"\\x1b[3J\");\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    const auto termSecondView = term->GetViewport();\r\n-    VERIFY_ARE_EQUAL(0, termSecondView.Top());\r\n-\r\n-    // Verify the top of the Terminal viewport contains the contents of the old viewport\r\n-    for (til::CoordType y = 0; y < termSecondView.BottomInclusive(); y++)\r\n-    {\r\n-        TestUtils::VerifyExpectedString(termTb, L\"X  \", { 0, y });\r\n-    }\r\n-\r\n-    // Verify below the new viewport (the old viewport) has been cleared out\r\n-    for (auto y = termSecondView.BottomInclusive(); y < termFirstView.BottomInclusive(); y++)\r\n-    {\r\n-        TestUtils::VerifyExpectedString(termTb, std::wstring(TerminalViewWidth, L' '), { 0, y });\r\n-    }\r\n-}\r\n-\r\n-void ConptyRoundtripTests::PassthroughClearAll()\r\n-{\r\n-    // see https://github.com/microsoft/terminal/issues/2832\r\n-    Log::Comment(L\"This is a test to make sure that when the client emits a \"\r\n-                 L\"^[[2J, we actually forward the 2J to the terminal, to move \"\r\n-                 L\"the viewport. 2J importantly moves the viewport, so that \"\r\n-                 L\"all the _current_ buffer contents are moved to scrollback. \"\r\n-                 L\"We shouldn't just paint over the current viewport with spaces.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        if (i > 0)\r\n-        {\r\n-            sm.ProcessString(L\"\\r\\n\");\r\n-        }\r\n-\r\n-        sm.ProcessString(L\"~\");\r\n-    }\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport, const bool afterClear = false) {\r\n-        const auto width = viewport.width();\r\n-\r\n-        // \"~\" rows\r\n-        for (til::CoordType row = 0; row < viewport.bottom; row++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", row));\r\n-            VERIFY_IS_FALSE(tb.GetRowByOffset(row).WasWrapForced());\r\n-            auto iter = tb.GetCellDataAt({ 0, row });\r\n-            if (afterClear && row >= viewport.top)\r\n-            {\r\n-                TestUtils::VerifySpanOfText(L\" \", iter, 0, width);\r\n-            }\r\n-            else\r\n-            {\r\n-                TestUtils::VerifySpanOfText(L\"~\", iter, 0, 1);\r\n-                TestUtils::VerifySpanOfText(L\" \", iter, 0, width - 1);\r\n-            }\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-\r\n-    const til::rect originalTerminalView{ term->_mutableViewport.ToInclusive() };\r\n-\r\n-    // Here, we'll emit the 2J to EraseAll, and move the viewport contents into\r\n-    // the scrollback.\r\n-    sm.ProcessString(L\"\\x1b[2J\");\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Make sure that the terminal's new viewport is actually just lower than it\r\n-    // used to be.\r\n-    const til::rect newTerminalView{ term->_mutableViewport.ToInclusive() };\r\n-    VERIFY_ARE_EQUAL(end, newTerminalView.top);\r\n-    VERIFY_IS_GREATER_THAN(newTerminalView.top, originalTerminalView.top);\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (after) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), true);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, newTerminalView, true);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::PassthroughHardReset()\r\n-{\r\n-    // This test is highly similar to PassthroughClearScrollback.\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write more lines of output than there are lines in the viewport. Clear everything with ^[c\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _logConpty = true;\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"Writing line %d/%d\", i, end));\r\n-        expectedOutput.push_back(\"X\");\r\n-        if (i < hostView.BottomInclusive())\r\n-        {\r\n-            expectedOutput.push_back(\"\\r\\n\");\r\n-        }\r\n-        else\r\n-        {\r\n-            // After we hit the bottom of the viewport, the newlines come in\r\n-            // separated by empty writes for whatever reason.\r\n-            expectedOutput.push_back(\"\\r\");\r\n-            expectedOutput.push_back(\"\\n\");\r\n-            expectedOutput.push_back(\"\");\r\n-        }\r\n-\r\n-        hostSm.ProcessString(L\"X\\n\");\r\n-\r\n-        VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    }\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Verify that we've printed height*2 lines of X's to the Terminal\r\n-    const auto termFirstView = term->GetViewport();\r\n-    for (til::CoordType y = 0; y < 2 * termFirstView.Height(); y++)\r\n-    {\r\n-        TestUtils::VerifyExpectedString(termTb, L\"X  \", { 0, y });\r\n-    }\r\n-\r\n-    // Write a Hard Reset VT sequence to the host, it should come through to the Terminal\r\n-    // along with a DECSET sequence to re-enable win32 input and focus events.\r\n-    expectedOutput.push_back(\"\\033c\");\r\n-    expectedOutput.push_back(\"\\033[?9001h\\033[?1004h\");\r\n-    hostSm.ProcessString(L\"\\033c\");\r\n-\r\n-    const auto termSecondView = term->GetViewport();\r\n-    VERIFY_ARE_EQUAL(0, termSecondView.Top());\r\n-\r\n-    // Verify everything has been cleared out\r\n-    for (til::CoordType y = 0; y < termFirstView.BottomInclusive(); y++)\r\n-    {\r\n-        TestUtils::VerifyExpectedString(termTb, std::wstring(TerminalViewWidth, L' '), { 0, y });\r\n-    }\r\n-}\r\n-\r\n-void ConptyRoundtripTests::PassthroughDECCTR()\r\n-{\r\n-    Log::Comment(L\"Update the color table with DECCTR. This should immediately be flushed to the Terminal.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& termRenderSettings = term->GetRenderSettings();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _logConpty = true;\r\n-\r\n-    // We're going to update color table entries 101 through 103, so we start by\r\n-    // initializing those entries to black in the Terminal render settings.\r\n-    termRenderSettings.SetColorTableEntry(101, RGB(0, 0, 0));\r\n-    termRenderSettings.SetColorTableEntry(102, RGB(0, 0, 0));\r\n-    termRenderSettings.SetColorTableEntry(103, RGB(0, 0, 0));\r\n-\r\n-    // DECCTR is expected to arrive in two parts. The control sequence comes\r\n-    // first, and the string content follows in the second packet.\r\n-    expectedOutput.push_back(\"\\x1bP2$p\");\r\n-    expectedOutput.push_back(\"101;2;100;0;0/102;2;0;100;0/103;2;0;0;100\\x1b\\\\\");\r\n-\r\n-    // Send the control sequence to the host.\r\n-    hostSm.ProcessString(L\"\\x1bP2$p101;2;100;0;0/102;2;0;100;0/103;2;0;0;100\\x1b\\\\\");\r\n-\r\n-    // Verify that the color table entries have been updated in the Terminal.\r\n-    VERIFY_ARE_EQUAL(RGB(255, 0, 0), termRenderSettings.GetColorTableEntry(101));\r\n-    VERIFY_ARE_EQUAL(RGB(0, 255, 0), termRenderSettings.GetColorTableEntry(102));\r\n-    VERIFY_ARE_EQUAL(RGB(0, 0, 255), termRenderSettings.GetColorTableEntry(103));\r\n-\r\n-    termRenderSettings.ResetColorTable();\r\n-}\r\n-\r\n-void ConptyRoundtripTests::OutputWrappedLinesAtTopOfBuffer()\r\n-{\r\n-    Log::Comment(\r\n-        L\"Case 1: Write a wrapped line right at the start of the buffer, before any circling\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    const auto wrappedLineLength = TerminalViewWidth + 20;\r\n-\r\n-    sm.ProcessString(std::wstring(wrappedLineLength, L'A'));\r\n-\r\n-    auto verifyBuffer = [](const TextBuffer& tb) {\r\n-        // Buffer contents should look like the following: (80 wide)\r\n-        // (w) means we hard wrapped the line\r\n-        // (b) means the line is _not_ wrapped (it's broken, the default state.)\r\n-        // cursor is on the '_'\r\n-        //\r\n-        // |AAAAAAAA...AAAA| (w)\r\n-        // |AAAAA_  ...    | (b) (There are 20 'A's on this line.)\r\n-        // |        ...    | (b)\r\n-\r\n-        VERIFY_IS_TRUE(tb.GetRowByOffset(0).WasWrapForced());\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(1).WasWrapForced());\r\n-        auto iter0 = tb.GetCellDataAt({ 0, 0 });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter0, 0, TerminalViewWidth);\r\n-        auto iter1 = tb.GetCellDataAt({ 0, 1 });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter1, 0, 20);\r\n-        auto iter2 = tb.GetCellDataAt({ 20, 1 });\r\n-        TestUtils::VerifySpanOfText(L\" \", iter2, 0, TerminalViewWidth - 20);\r\n-    };\r\n-\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    expectedOutput.push_back(std::string(TerminalViewWidth, 'A'));\r\n-    expectedOutput.push_back(std::string(20, 'A'));\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyBuffer(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::OutputWrappedLinesAtBottomOfBuffer()\r\n-{\r\n-    Log::Comment(\r\n-        L\"Case 2: Write a wrapped line at the end of the buffer, once the conpty started circling\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    // First, fill the buffer with contents, so conpty starts circling\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"Writing line %d/%d\", i, end));\r\n-        expectedOutput.push_back(\"X\");\r\n-        if (i < hostView.BottomInclusive())\r\n-        {\r\n-            expectedOutput.push_back(\"\\r\\n\");\r\n-        }\r\n-        else\r\n-        {\r\n-            // After we hit the bottom of the viewport, the newlines come in\r\n-            // separated by empty writes for whatever reason.\r\n-            expectedOutput.push_back(\"\\r\");\r\n-            expectedOutput.push_back(\"\\n\");\r\n-            expectedOutput.push_back(\"\");\r\n-        }\r\n-\r\n-        hostSm.ProcessString(L\"X\\n\");\r\n-\r\n-        VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    }\r\n-\r\n-    const auto wrappedLineLength = TerminalViewWidth + 20;\r\n-\r\n-    // The following diagrams show the buffer contents after each string emitted\r\n-    // from conpty. For each of these diagrams:\r\n-    // (w) means we hard wrapped the line\r\n-    // (b) means the line is _not_ wrapped (it's broken, the default state.)\r\n-    // cursor is on the '_'\r\n-\r\n-    // Initial state:\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |_              | (b)\r\n-\r\n-    expectedOutput.push_back(std::string(TerminalViewWidth, 'A'));\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AAAA|_ (w) The cursor is actually on the last A here\r\n-\r\n-    // TODO GH#5228 might break the \"newline & repaint the wrapped char\" checks here, that's okay.\r\n-    expectedOutput.push_back(\"\\r\"); // This \\r\\n is emitted by ScrollFrame to\r\n-    expectedOutput.push_back(\"\\n\"); // add a newline to the bottom of the buffer\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AAAA| (b)\r\n-    // |_              | (b)\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[31;80H\"); // Move the cursor BACK to the wrapped row\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AAAA| (b) The cursor is actually on the last A here\r\n-    // |               | (b)\r\n-\r\n-    expectedOutput.push_back(std::string(1, 'A')); // Reprint the last character of the wrapped row\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AAAA|_ (w) The cursor is actually on the last A here\r\n-    // |               | (b)\r\n-\r\n-    expectedOutput.push_back(std::string(20, 'A')); // Print the second line.\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AAAA| (w)\r\n-    // |AAAAA_         | (b) There are 20 'A's on this line.\r\n-\r\n-    hostSm.ProcessString(std::wstring(wrappedLineLength, L'A'));\r\n-\r\n-    auto verifyBuffer = [](const TextBuffer& tb, const til::CoordType wrappedRow) {\r\n-        // Buffer contents should look like the following: (80 wide)\r\n-        // (w) means we hard wrapped the line\r\n-        // (b) means the line is _not_ wrapped (it's broken, the default state.)\r\n-        // cursor is on the '_'\r\n-        //\r\n-        // |X              | (b)\r\n-        // |X              | (b)\r\n-        // ...\r\n-        // |X              | (b)\r\n-        // |AAAAAAAA...AAAA| (w)\r\n-        // |AAAAA_  ...    | (b) (There are 20 'A's on this line.)\r\n-\r\n-        VERIFY_IS_TRUE(tb.GetRowByOffset(wrappedRow).WasWrapForced());\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(wrappedRow + 1).WasWrapForced());\r\n-\r\n-        auto iter0 = tb.GetCellDataAt({ 0, wrappedRow });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter0, 0, TerminalViewWidth);\r\n-        auto iter1 = tb.GetCellDataAt({ 0, wrappedRow + 1 });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter1, 0, 20);\r\n-        auto iter2 = tb.GetCellDataAt({ 20, wrappedRow + 1 });\r\n-        TestUtils::VerifySpanOfText(L\" \", iter2, 0, TerminalViewWidth - 20);\r\n-    };\r\n-\r\n-    verifyBuffer(hostTb, hostView.BottomInclusive() - 1);\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    verifyBuffer(termTb, term->_mutableViewport.BottomInclusive() - 1);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ScrollWithChangesInMiddle()\r\n-{\r\n-    Log::Comment(L\"This test checks emitting a wrapped line at the bottom of the\"\r\n-                 L\" viewport while _also_ emitting other text elsewhere in the same frame. This\"\r\n-                 L\" output will cause us to scroll the viewport in one frame, but we need to\"\r\n-                 L\" make sure the wrapped line _stays_ wrapped, and the scrolled text appears in\"\r\n-                 L\" the right place.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    // First, fill the buffer with contents, so conpty starts circling\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"Writing line %d/%d\", i, end));\r\n-        expectedOutput.push_back(\"X\");\r\n-        if (i < hostView.BottomInclusive())\r\n-        {\r\n-            expectedOutput.push_back(\"\\r\\n\");\r\n-        }\r\n-        else\r\n-        {\r\n-            // After we hit the bottom of the viewport, the newlines come in\r\n-            // separated by empty writes for whatever reason.\r\n-            expectedOutput.push_back(\"\\r\");\r\n-            expectedOutput.push_back(\"\\n\");\r\n-            expectedOutput.push_back(\"\");\r\n-        }\r\n-\r\n-        hostSm.ProcessString(L\"X\\n\");\r\n-\r\n-        VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    }\r\n-\r\n-    const auto wrappedLineLength = TerminalViewWidth + 20;\r\n-\r\n-    // In the Terminal, we're going to expect:\r\n-    expectedOutput.push_back(\"\\x1b[15;1H\"); // Move the cursor to row 14, col 0\r\n-    expectedOutput.push_back(\"Y\"); // Print a 'Y'\r\n-    expectedOutput.push_back(\"\\x1b[32;1H\"); // Move the cursor to the last row\r\n-    expectedOutput.push_back(std::string(TerminalViewWidth, 'A')); // Print the first 80 'A's\r\n-    // This is going to be the end of the first frame - b/c we moved the cursor\r\n-    // in the middle of the frame, we're going to hide/show the cursor during\r\n-    // this frame\r\n-    expectedOutput.push_back(\"\\x1b[?25h\"); // hide the cursor\r\n-    // On the subsequent frame:\r\n-    // TODO GH#5228 might break the \"newline & repaint the wrapped char\" checks here, that's okay.\r\n-    expectedOutput.push_back(\"\\r\"); // This \\r\\n is emitted by ScrollFrame to\r\n-    expectedOutput.push_back(\"\\n\"); // add a newline to the bottom of the buffer\r\n-    expectedOutput.push_back(\"\\x1b[31;80H\"); // Move the cursor BACK to the wrapped row\r\n-    expectedOutput.push_back(std::string(1, 'A')); // Reprint the last character of the wrapped row\r\n-    expectedOutput.push_back(std::string(20, 'A')); // Print the second line.\r\n-\r\n-    _logConpty = true;\r\n-\r\n-    // To the host, we'll do something very similar:\r\n-    hostSm.ProcessString(L\"\\x1b\"\r\n-                         L\"7\"); // Save cursor\r\n-    hostSm.ProcessString(L\"\\x1b[15;1H\"); // Move the cursor to row 14, col 0\r\n-    hostSm.ProcessString(L\"Y\"); // Print a 'Y'\r\n-    hostSm.ProcessString(L\"\\x1b\"\r\n-                         L\"8\"); // Restore\r\n-    hostSm.ProcessString(std::wstring(wrappedLineLength, L'A')); // Print 100 'A's\r\n-\r\n-    auto verifyBuffer = [](const TextBuffer& tb, const til::rect& viewport) {\r\n-        const auto wrappedRow = viewport.bottom - 2;\r\n-        const auto start = viewport.top;\r\n-        for (auto i = start; i < wrappedRow; i++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", i));\r\n-            TestUtils::VerifyExpectedString(tb, i == start + 13 ? L\"Y\" : L\"X\", { 0, i });\r\n-        }\r\n-\r\n-        VERIFY_IS_TRUE(tb.GetRowByOffset(wrappedRow).WasWrapForced());\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(wrappedRow + 1).WasWrapForced());\r\n-\r\n-        auto iter0 = tb.GetCellDataAt({ 0, wrappedRow });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter0, 0, TerminalViewWidth);\r\n-\r\n-        auto iter1 = tb.GetCellDataAt({ 0, wrappedRow + 1 });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter1, 0, 20);\r\n-        auto iter2 = tb.GetCellDataAt({ 20, wrappedRow + 1 });\r\n-        TestUtils::VerifySpanOfText(L\" \", iter2, 0, TerminalViewWidth - 20);\r\n-    };\r\n-\r\n-    Log::Comment(NoThrowString().Format(L\"Checking the host buffer...\"));\r\n-    verifyBuffer(hostTb, hostView.ToExclusive());\r\n-    Log::Comment(NoThrowString().Format(L\"... Done\"));\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(NoThrowString().Format(L\"Checking the terminal buffer...\"));\r\n-    verifyBuffer(termTb, term->_mutableViewport.ToExclusive());\r\n-    Log::Comment(NoThrowString().Format(L\"... Done\"));\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ScrollWithMargins()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-    const auto initialTermView = term->GetViewport();\r\n-\r\n-    Log::Comment(L\"Flush first frame.\");\r\n-    _flushFirstFrame();\r\n-\r\n-    // Fill up the buffer with some text.\r\n-    // We're going to write something like this:\r\n-    // AAAA\r\n-    // BBBB\r\n-    // CCCC\r\n-    // ........\r\n-    // QQQQ\r\n-    // ****************\r\n-    // The letters represent the data in the TMUX pane.\r\n-    // The final *** line represents the mode line which we will\r\n-    // attempt to hold in place and not scroll.\r\n-    // Note that the last line will contain one '*' less than the width of the window.\r\n-\r\n-    Log::Comment(L\"Fill host with text pattern by feeding it into VT parser.\");\r\n-    const auto rowsToWrite = initialTermView.Height() - 1;\r\n-\r\n-    // For all lines but the last one, write out a few of a letter.\r\n-    for (auto i = 0; i < rowsToWrite; ++i)\r\n-    {\r\n-        const auto wch = static_cast<wchar_t>(L'A' + i);\r\n-        hostSm.ProcessCharacter(wch);\r\n-        hostSm.ProcessCharacter(wch);\r\n-        hostSm.ProcessCharacter(wch);\r\n-        hostSm.ProcessCharacter(wch);\r\n-        hostSm.ProcessCharacter('\\n');\r\n-    }\r\n-\r\n-    // For the last one, write out the asterisks for the mode line.\r\n-    for (auto i = 0; i < initialTermView.Width() - 1; ++i)\r\n-    {\r\n-        hostSm.ProcessCharacter('*');\r\n-    }\r\n-\r\n-    // no newline in the bottom right corner or it will move unexpectedly.\r\n-\r\n-    // Now set up the verification that the buffers are full of the pattern we expect.\r\n-    // This function will verify the text backing buffers.\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        auto& cursor = tb.GetCursor();\r\n-        // Verify the cursor is waiting in the bottom right corner\r\n-        VERIFY_ARE_EQUAL(initialTermView.Height() - 1, cursor.GetPosition().y);\r\n-        VERIFY_ARE_EQUAL(initialTermView.Width() - 1, cursor.GetPosition().x);\r\n-\r\n-        // For all rows except the last one, verify that we have a run of four letters.\r\n-        for (auto i = 0; i < rowsToWrite; ++i)\r\n-        {\r\n-            const std::wstring expectedString(4, static_cast<wchar_t>(L'A' + i));\r\n-            const til::point expectedPos{ 0, i };\r\n-            TestUtils::VerifyExpectedString(tb, expectedString, expectedPos);\r\n-        }\r\n-\r\n-        // For the last row, verify we have an entire row of asterisks for the mode line.\r\n-        const std::wstring expectedModeLine(initialTermView.Width() - 1, L'*');\r\n-        const til::point expectedPos{ 0, rowsToWrite };\r\n-        TestUtils::VerifyExpectedString(tb, expectedModeLine, expectedPos);\r\n-    };\r\n-\r\n-    // This will verify the text emitted from the PTY.\r\n-    for (auto i = 0; i < rowsToWrite; ++i)\r\n-    {\r\n-        const std::string expectedString(4, static_cast<char>('A' + i));\r\n-        expectedOutput.push_back(expectedString);\r\n-        expectedOutput.push_back(\"\\r\\n\");\r\n-    }\r\n-    {\r\n-        const std::string expectedString(initialTermView.Width() - 1, '*');\r\n-        expectedOutput.push_back(expectedString);\r\n-    }\r\n-\r\n-    Log::Comment(L\"Verify host buffer contains pattern.\");\r\n-    // Verify the host side.\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    Log::Comment(L\"Emit PTY frame and validate it transmits the right data.\");\r\n-    // Paint the frame\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"Verify terminal buffer contains pattern.\");\r\n-    // Verify the terminal side.\r\n-    verifyBuffer(termTb);\r\n-\r\n-    Log::Comment(L\"!!! OK. Set up the scroll region and let's get scrolling!\");\r\n-    // This is a simulation of what TMUX does to scroll everything except the mode line.\r\n-    // First build up our VT strings...\r\n-    std::wstring reducedScrollRegion;\r\n-    {\r\n-        std::wstringstream wss;\r\n-        // For 20 tall buffer...\r\n-        // ESC[1;19r\r\n-        // Set scroll region to lines 1-19.\r\n-        wss << L\"\\x1b[1;\" << initialTermView.Height() - 1 << L\"r\";\r\n-        reducedScrollRegion = wss.str();\r\n-    }\r\n-    std::wstring completeScrollRegion;\r\n-    {\r\n-        std::wstringstream wss;\r\n-        // For 20 tall buffer...\r\n-        // ESC[1;20r\r\n-        // Set scroll region to lines 1-20. (or the whole buffer)\r\n-        wss << L\"\\x1b[1;\" << initialTermView.Height() << L\"r\";\r\n-        completeScrollRegion = wss.str();\r\n-    }\r\n-    std::wstring reducedCursorBottomRight;\r\n-    {\r\n-        std::wstringstream wss;\r\n-        // For 20 tall and 100 wide buffer\r\n-        // ESC[19;100H\r\n-        // Put cursor on line 19 (1 before last) and the right most column 100.\r\n-        // (Remember that in VT, we start counting from 1 not 0.)\r\n-        wss << L\"\\x1b[\" << initialTermView.Height() - 1 << L\";\" << initialTermView.Width() << \"H\";\r\n-        reducedCursorBottomRight = wss.str();\r\n-    }\r\n-    std::wstring completeCursorAtPromptLine;\r\n-    {\r\n-        std::wstringstream wss;\r\n-        // For 20 tall and 100 wide buffer\r\n-        // ESC[19;1H\r\n-        // Put cursor on line 19 (1 before last) and the left most column 1.\r\n-        // (Remember that in VT, we start counting from 1 not 0.)\r\n-        wss << L\"\\x1b[\" << initialTermView.Height() - 1 << L\";1H\";\r\n-        completeCursorAtPromptLine = wss.str();\r\n-    }\r\n-\r\n-    Log::Comment(L\"Perform all the operations on the buffer.\");\r\n-\r\n-    // OK this is what TMUX does.\r\n-    // 1. Mark off the scroll area as everything but the mode line.\r\n-    hostSm.ProcessString(reducedScrollRegion);\r\n-    // 2. Put the cursor in the bottom-right corner of the scroll region.\r\n-    hostSm.ProcessString(reducedCursorBottomRight);\r\n-    // 3. Send a single newline which should do the heavy lifting\r\n-    //    of pushing everything in the scroll region up by 1 line and\r\n-    //    leave everything outside the region alone.\r\n-\r\n-    // This entire block is subject to change in the future with optimizations.\r\n-    {\r\n-        // Cursor gets redrawn in the bottom right of the scroll region with the repaint that is forced\r\n-        // early while the screen is rotated.\r\n-        std::stringstream ss;\r\n-        ss << \"\\x1b[\" << initialTermView.Height() - 1 << \";\" << initialTermView.Width() << \"H\";\r\n-        expectedOutput.push_back(ss.str());\r\n-\r\n-        expectedOutput.push_back(\"\\x1b[?25h\"); // turn the cursor back on too.\r\n-    }\r\n-\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    // 4. Remove the scroll area by setting it to the entire size of the viewport.\r\n-    hostSm.ProcessString(completeScrollRegion);\r\n-    // 5. Put the cursor back at the beginning of the new line that was just revealed.\r\n-    hostSm.ProcessString(completeCursorAtPromptLine);\r\n-\r\n-    // Set up the verifications like above.\r\n-    auto verifyBufferAfter = [&](const TextBuffer& tb, const auto panOffset) {\r\n-        auto& cursor = tb.GetCursor();\r\n-        // Verify the cursor is waiting on the freshly revealed line (1 above mode line)\r\n-        // and in the left most column.\r\n-        const auto bottomLine = initialTermView.BottomInclusive() + panOffset;\r\n-        VERIFY_ARE_EQUAL(bottomLine - 1, cursor.GetPosition().y);\r\n-        VERIFY_ARE_EQUAL(0, cursor.GetPosition().x);\r\n-\r\n-        // For all rows except the last two, verify that we have a run of four letters.\r\n-        for (auto i = 0; i < rowsToWrite - 1; ++i)\r\n-        {\r\n-            // Start with B this time because the A line got scrolled off the top.\r\n-            const std::wstring expectedString(4, static_cast<wchar_t>(L'B' + i));\r\n-            const til::point expectedPos{ 0, panOffset + i };\r\n-            TestUtils::VerifyExpectedString(tb, expectedString, expectedPos);\r\n-        }\r\n-\r\n-        // For the second to last row, verify that it is blank.\r\n-        {\r\n-            const std::wstring expectedBlankLine(initialTermView.Width(), L' ');\r\n-            const til::point blankLinePos{ 0, panOffset + rowsToWrite - 1 };\r\n-            TestUtils::VerifyExpectedString(tb, expectedBlankLine, blankLinePos);\r\n-        }\r\n-\r\n-        // For the last row, verify we have an entire row of asterisks for the mode line.\r\n-        {\r\n-            const std::wstring expectedModeLine(initialTermView.Width() - 1, L'*');\r\n-            const til::point modeLinePos{ 0, panOffset + rowsToWrite };\r\n-            TestUtils::VerifyExpectedString(tb, expectedModeLine, modeLinePos);\r\n-        }\r\n-    };\r\n-\r\n-    // This will verify the text emitted from the PTY.\r\n-\r\n-    expectedOutput.push_back(\"\\r\\n\"); // cursor moved to bottom left corner\r\n-    expectedOutput.push_back(\"\\n\"); // linefeed pans the viewport down\r\n-    {\r\n-        // Cursor gets reset into second line from bottom, left most column\r\n-        std::stringstream ss;\r\n-        ss << \"\\x1b[\" << initialTermView.Height() - 1 << \";1H\";\r\n-        expectedOutput.push_back(ss.str());\r\n-    }\r\n-    {\r\n-        // Bottom of the scroll region is replaced with a blank line\r\n-        const std::string expectedString(initialTermView.Width(), ' ');\r\n-        expectedOutput.push_back(expectedString);\r\n-    }\r\n-    expectedOutput.push_back(\"\\r\\n\"); // cursor moved to bottom left corner\r\n-    {\r\n-        // Mode line is redrawn at the bottom of the viewport\r\n-        const std::string expectedString(initialTermView.Width() - 1, '*');\r\n-        expectedOutput.push_back(expectedString);\r\n-        expectedOutput.push_back(\" \");\r\n-    }\r\n-    {\r\n-        // Cursor gets reset into second line from bottom, left most column\r\n-        std::stringstream ss;\r\n-        ss << \"\\x1b[\" << initialTermView.Height() - 1 << \";1H\";\r\n-        expectedOutput.push_back(ss.str());\r\n-    }\r\n-    expectedOutput.push_back(\"\\x1b[?25h\"); // turn the cursor back on too.\r\n-\r\n-    Log::Comment(L\"Verify host buffer contains pattern moved up one and mode line still in place.\");\r\n-    // Verify the host side.\r\n-    verifyBufferAfter(hostTb, 0);\r\n-\r\n-    Log::Comment(L\"Emit PTY frame and validate it transmits the right data.\");\r\n-    // Paint the frame\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"Verify terminal buffer contains pattern moved up one and mode line still in place.\");\r\n-    // Verify the terminal side. Note the viewport has panned down a line.\r\n-    verifyBufferAfter(termTb, 1);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::DontWrapMoveCursorInSingleFrame()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/pull/5181#issuecomment-607427840\r\n-    Log::Comment(L\"This is a test for when a line of text exactly wrapped, but \"\r\n-                 L\"the cursor didn't end the frame at the end of line (waiting \"\r\n-                 L\"for more wrapped text). We should still move the cursor in \"\r\n-                 L\"this case.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    auto verifyBuffer = [](const TextBuffer& tb) {\r\n-        // Simple verification: Make sure the cursor is in the correct place,\r\n-        // and that it's visible. We don't care so much about the buffer\r\n-        // contents in this test.\r\n-        const til::point expectedCursor{ 8, 3 };\r\n-        VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-        VERIFY_IS_TRUE(tb.GetCursor().IsVisible());\r\n-    };\r\n-\r\n-    hostSm.ProcessString(L\"\\x1b[?25l\");\r\n-    hostSm.ProcessString(L\"\\x1b[H\");\r\n-    hostSm.ProcessString(L\"\\x1b[75C\");\r\n-    hostSm.ProcessString(L\"XXXXX\");\r\n-    hostSm.ProcessString(L\"\\x1b[4;9H\");\r\n-    hostSm.ProcessString(L\"\\x1b[?25h\");\r\n-\r\n-    Log::Comment(L\"Checking the host buffer state\");\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[75C\");\r\n-    expectedOutput.push_back(\"XXXXX\");\r\n-    expectedOutput.push_back(\"\\x1b[4;9H\");\r\n-    // We're _not_ expecting a cursor on here, because we didn't actually hide\r\n-    // the cursor during the course of this frame\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"Checking the terminal buffer state\");\r\n-    verifyBuffer(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ClearHostTrickeryTest()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:paintEachNewline\", L\"{0, 1, 2}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:cursorOnNextLine\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:paintAfterDECALN\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:changeAttributes\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:useLongSpaces\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:printTextAfterSpaces\", L\"{false, true}\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-    constexpr auto PaintEveryNewline = 0;\r\n-    constexpr auto PaintAfterAllNewlines = 1;\r\n-\r\n-    INIT_TEST_PROPERTY(int, paintEachNewline, L\"Any of: manually PaintFrame after each newline is emitted, once at the end of all newlines, or not at all\");\r\n-    INIT_TEST_PROPERTY(bool, cursorOnNextLine, L\"Either leave the cursor on the first line, or place it on the second line of the buffer\");\r\n-    INIT_TEST_PROPERTY(bool, paintAfterDECALN, L\"Controls whether we manually paint a frame after the DECALN sequence is emitted.\");\r\n-    INIT_TEST_PROPERTY(bool, changeAttributes, L\"If true, change the text attributes after the 'A's and spaces\");\r\n-    INIT_TEST_PROPERTY(bool, useLongSpaces, L\"If true, print 10 spaces instead of 5, longer than a CUF sequence.\");\r\n-    INIT_TEST_PROPERTY(bool, printTextAfterSpaces, L\"If true, print \\\"ZZZZZ\\\" after the spaces on the first line.\");\r\n-\r\n-    // See https://github.com/microsoft/terminal/issues/5039#issuecomment-606833841\r\n-    Log::Comment(L\"This is a more than comprehensive test for GH#5039. We're \"\r\n-                 L\"going to print some text to the buffer, then fill the alt-\"\r\n-                 L\"buffer with text, then switch back to the main buffer. The \"\r\n-                 L\"text from the alt buffer should not pollute the main buffer.\");\r\n-\r\n-    // The text we're printing will look like one of the following, with the\r\n-    // cursor on the _\r\n-    //  * cursorOnNextLine=false, useLongSpaces=false:\r\n-    //    AAAAA     ZZZZZ_\r\n-    //  * cursorOnNextLine=false, useLongSpaces=true:\r\n-    //    AAAAA          ZZZZZ_\r\n-    //  * cursorOnNextLine=true, useLongSpaces=false:\r\n-    //    AAAAA     ZZZZZ\r\n-    //    BBBBB_\r\n-    //  * cursorOnNextLine=true, useLongSpaces=true:\r\n-    //    AAAAA          ZZZZZ\r\n-    //    BBBBB_\r\n-    //\r\n-    // If printTextAfterSpaces=false, then we won't print the \"ZZZZZ\"\r\n-    //\r\n-    // The interesting case that repros the bug in GH#5039 is\r\n-    //  - paintEachNewline=DontPaintAfterNewlines (2)\r\n-    //  - cursorOnNextLine=false\r\n-    //  - paintAfterDECALN=<any>\r\n-    //  - changeAttributes=true\r\n-    //  - useLongSpaces=<any>\r\n-    //  - printTextAfterSpaces=<any>\r\n-    //\r\n-    // All the possible cases are left here though, to catch potential future regressions.\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    auto verifyBuffer = [&cursorOnNextLine, &useLongSpaces, &printTextAfterSpaces](const TextBuffer& tb,\r\n-                                                                                   const til::rect viewport) {\r\n-        // We _would_ expect the Terminal's cursor to be on { 8, 0 }, but this\r\n-        // is currently broken due to #381/#4676. So we'll use the viewport\r\n-        // provided to find the actual Y position of the cursor.\r\n-        const auto viewTop = viewport.origin().y;\r\n-        const auto cursorRow = viewTop + (cursorOnNextLine ? 1 : 0);\r\n-        const auto cursorCol = (cursorOnNextLine ? 5 :\r\n-                                                   (10 + (useLongSpaces ? 5 : 0) + (printTextAfterSpaces ? 5 : 0)));\r\n-        const til::point expectedCursor{ cursorCol, cursorRow };\r\n-\r\n-        VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-        VERIFY_IS_TRUE(tb.GetCursor().IsVisible());\r\n-        auto iter = TestUtils::VerifyExpectedString(tb, L\"AAAAA\", { 0, viewTop });\r\n-        TestUtils::VerifyExpectedString(useLongSpaces ? L\"          \" : L\"     \", iter);\r\n-        if (printTextAfterSpaces)\r\n-        {\r\n-            TestUtils::VerifyExpectedString(L\"ZZZZZ\", iter);\r\n-        }\r\n-        else\r\n-        {\r\n-            TestUtils::VerifyExpectedString(L\"     \", iter);\r\n-        }\r\n-        TestUtils::VerifyExpectedString(L\"     \", iter);\r\n-\r\n-        if (cursorOnNextLine)\r\n-        {\r\n-            TestUtils::VerifyExpectedString(tb, L\"BBBBB\", { 0, cursorRow });\r\n-        }\r\n-    };\r\n-\r\n-    // We're _not_ checking the conpty output during this test, only the side effects.\r\n-    _checkConptyOutput = false;\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    Log::Comment(L\"Setting up the host buffer...\");\r\n-    hostSm.ProcessString(L\"AAAAA\");\r\n-    hostSm.ProcessString(useLongSpaces ? L\"          \" : L\"     \");\r\n-    if (changeAttributes)\r\n-    {\r\n-        hostSm.ProcessString(L\"\\x1b[44m\");\r\n-    }\r\n-    if (printTextAfterSpaces)\r\n-    {\r\n-        hostSm.ProcessString(L\"ZZZZZ\");\r\n-    }\r\n-    hostSm.ProcessString(L\"\\x1b[0m\");\r\n-\r\n-    if (cursorOnNextLine)\r\n-    {\r\n-        hostSm.ProcessString(L\"\\n\");\r\n-        hostSm.ProcessString(L\"BBBBB\");\r\n-    }\r\n-    Log::Comment(L\"Painting after the initial setup.\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"Switching to the alt buffer and using DECALN to fill it with 'E's\");\r\n-    hostSm.ProcessString(L\"\\x1b[?1049h\");\r\n-    hostSm.ProcessString(L\"\\x1b#8\");\r\n-    if (paintAfterDECALN)\r\n-    {\r\n-        VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    }\r\n-\r\n-    for (auto i = 0; i < si.GetViewport().Height(); i++)\r\n-    {\r\n-        hostSm.ProcessString(L\"\\n\");\r\n-        if (paintEachNewline == PaintEveryNewline)\r\n-        {\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-        }\r\n-    }\r\n-    if (paintEachNewline == PaintAfterAllNewlines)\r\n-    {\r\n-        VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    }\r\n-    Log::Comment(L\"Returning to the main buffer.\");\r\n-    hostSm.ProcessString(L\"\\x1b[?1049l\");\r\n-\r\n-    Log::Comment(L\"Checking the host buffer state\");\r\n-    verifyBuffer(hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"Checking the terminal buffer state\");\r\n-    verifyBuffer(termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::OverstrikeAtBottomOfBuffer()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/pull/5181#issuecomment-607545241\r\n-    Log::Comment(L\"This test replicates the zsh menu-complete functionality. In\"\r\n-                 L\" the course of a single frame, we're going to both scroll \"\r\n-                 L\"the frame and print multiple lines of text above the bottom line.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    auto verifyBuffer = [](const TextBuffer& tb,\r\n-                           const til::rect viewport) {\r\n-        const auto lastRow = viewport.bottom - 1;\r\n-        const til::point expectedCursor{ 0, lastRow - 1 };\r\n-        VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-        VERIFY_IS_TRUE(tb.GetCursor().IsVisible());\r\n-\r\n-        TestUtils::VerifyExpectedString(tb, L\"AAAAAAAAAA          DDDDDDDDDD\", { 0, lastRow - 2 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"BBBBBBBBBB\", { 0, lastRow - 1 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"FFFFFFFFFE\", { 0, lastRow });\r\n-    };\r\n-\r\n-    _logConpty = true;\r\n-    // We're _not_ checking the conpty output during this test, only the side effects.\r\n-    _checkConptyOutput = false;\r\n-\r\n-    hostSm.ProcessString(L\"\\x1b#8\");\r\n-\r\n-    hostSm.ProcessString(L\"\\x1b[32;1H\");\r\n-\r\n-    hostSm.ProcessString(L\"\\x1b[J\");\r\n-    hostSm.ProcessString(L\"AAAAAAAAAA\");\r\n-    hostSm.ProcessString(L\"\\x1b[K\");\r\n-    hostSm.ProcessString(L\"\\r\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"BBBBBBBBBB\");\r\n-    hostSm.ProcessString(L\"\\x1b[K\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"CCCCCCCCCC\");\r\n-    hostSm.ProcessString(L\"\\x1b[2A\");\r\n-    hostSm.ProcessString(L\"\\r\");\r\n-    hostSm.ProcessString(L\"\\x1b[20C\");\r\n-    hostSm.ProcessString(L\"DDDDDDDDDD\");\r\n-    hostSm.ProcessString(L\"\\x1b[K\");\r\n-    hostSm.ProcessString(L\"\\r\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"\\x1b[1B\");\r\n-    hostSm.ProcessString(L\"EEEEEEEEEE\");\r\n-    hostSm.ProcessString(L\"\\r\");\r\n-    hostSm.ProcessString(L\"FFFFFFFFF\");\r\n-    hostSm.ProcessString(L\"\\r\");\r\n-    hostSm.ProcessString(L\"\\x1b[A\");\r\n-    hostSm.ProcessString(L\"\\x1b[A\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-\r\n-    verifyBuffer(termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::MarginsWithStatusLine()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/issues/5161\r\n-    //\r\n-    // This test reproduces a case from the MSYS/cygwin (runtime < 3.1) vim.\r\n-    // From what I can tell, they implement scrolling by emitting a newline at\r\n-    // the bottom of the buffer (to create a new blank line), then they use\r\n-    // ScrollConsoleScreenBuffer to shift the status line(s) down a line, and\r\n-    // then they re-printing the status line.\r\n-    Log::Comment(L\"Newline, and scroll the bottom lines of the buffer down with\"\r\n-                 L\" ScrollConsoleScreenBuffer to emulate how cygwin VIM works\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    auto verifyBuffer = [](const TextBuffer& tb,\r\n-                           const til::rect viewport) {\r\n-        const auto lastRow = viewport.bottom - 1;\r\n-        const til::point expectedCursor{ 1, lastRow };\r\n-        VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-        VERIFY_IS_TRUE(tb.GetCursor().IsVisible());\r\n-\r\n-        TestUtils::VerifyExpectedString(tb, L\"EEEEEEEEEE\", { 0, lastRow - 4 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"AAAAAAAAAA\", { 0, lastRow - 3 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"          \", { 0, lastRow - 2 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"XBBBBBBBBB\", { 0, lastRow - 1 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"YCCCCCCCCC\", { 0, lastRow });\r\n-    };\r\n-\r\n-    // We're _not_ checking the conpty output during this test, only the side effects.\r\n-    _checkConptyOutput = false;\r\n-\r\n-    // Use DECALN to fill the buffer with 'E's.\r\n-    hostSm.ProcessString(L\"\\x1b#8\");\r\n-\r\n-    const auto originalBottom = si.GetViewport().BottomInclusive();\r\n-    // Print 3 lines into the bottom of the buffer:\r\n-    // AAAAAAAAAA\r\n-    // BBBBBBBBBB\r\n-    // CCCCCCCCCC\r\n-    // In this test, the 'B' and 'C' lines represent the status lines at the\r\n-    // bottom of vim, and the 'A' line is a buffer line.\r\n-    hostSm.ProcessString(L\"\\x1b[30;1H\");\r\n-\r\n-    hostSm.ProcessString(L\"AAAAAAAAAA\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"BBBBBBBBBB\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"CCCCCCCCCC\");\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // After printing the 'C' line, the cursor is on the bottom line of the viewport.\r\n-    // Emit a newline here to get a new line at the bottom of the viewport.\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    const auto newBottom = si.GetViewport().BottomInclusive();\r\n-\r\n-    {\r\n-        // Emulate calling ScrollConsoleScreenBuffer to scroll the B and C lines\r\n-        // down one line.\r\n-        til::inclusive_rect src;\r\n-        src.top = newBottom - 2;\r\n-        src.left = 0;\r\n-        src.right = si.GetViewport().Width();\r\n-        src.bottom = originalBottom;\r\n-        til::point tgt{ 0, newBottom - 1 };\r\n-        TextAttribute useThisAttr(0x07); // We don't terribly care about the attributes so this is arbitrary\r\n-        ScrollRegion(si, src, std::nullopt, tgt, L' ', useThisAttr);\r\n-    }\r\n-\r\n-    // Move the cursor to the location of the B line\r\n-    hostSm.ProcessString(L\"\\x1b[31;1H\");\r\n-\r\n-    // Print an 'X' on the 'B' line, and a 'Y' on the 'C' line.\r\n-    hostSm.ProcessString(L\"X\");\r\n-    hostSm.ProcessString(L\"\\n\");\r\n-    hostSm.ProcessString(L\"Y\");\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-\r\n-    verifyBuffer(termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::OutputWrappedLineWithSpace()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/pull/5181#issuecomment-610110348\r\n-    Log::Comment(L\"Ensures that a buffer line in conhost that wrapped _on a \"\r\n-                 L\"space_ will still be emitted as wrapped.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    const auto firstTextLength = TerminalViewWidth - 2;\r\n-    const auto spacesLength = 3;\r\n-    const auto secondTextLength = 1;\r\n-\r\n-    sm.ProcessString(std::wstring(firstTextLength, L'A'));\r\n-    sm.ProcessString(std::wstring(spacesLength, L' '));\r\n-    sm.ProcessString(std::wstring(secondTextLength, L'B'));\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        // Buffer contents should look like the following: (80 wide)\r\n-        // (w) means we hard wrapped the line\r\n-        // (b) means the line is _not_ wrapped (it's broken, the default state.)\r\n-        //\r\n-        // |AAAA...AA  | (w)\r\n-        // | B_ ...    | (b) (cursor is on the '_')\r\n-        // |    ...    | (b)\r\n-\r\n-        VERIFY_IS_TRUE(tb.GetRowByOffset(0).WasWrapForced());\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(1).WasWrapForced());\r\n-\r\n-        // First row\r\n-        auto iter0 = tb.GetCellDataAt({ 0, 0 });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter0, 0, firstTextLength);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter0, 0, 2);\r\n-\r\n-        // Second row\r\n-        auto iter1 = tb.GetCellDataAt({ 0, 1 });\r\n-        TestUtils::VerifySpanOfText(L\" \", iter1, 0, 1);\r\n-        auto iter2 = tb.GetCellDataAt({ 1, 1 });\r\n-        TestUtils::VerifySpanOfText(L\"B\", iter2, 0, secondTextLength);\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(hostTb);\r\n-\r\n-    auto firstLine = std::string(firstTextLength, 'A');\r\n-    firstLine += \"  \";\r\n-    std::string secondLine{ \" B\" };\r\n-\r\n-    expectedOutput.push_back(firstLine);\r\n-    expectedOutput.push_back(secondLine);\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-    verifyBuffer(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::OutputWrappedLineWithSpaceAtBottomOfBuffer()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/pull/5181#issuecomment-610110348\r\n-    // This is the same test as OutputWrappedLineWithSpace, but at the bottom of\r\n-    // the buffer, so we get scrolling behavior as well.\r\n-    Log::Comment(L\"Ensures that a buffer line in conhost that wrapped _on a \"\r\n-                 L\"space_ will still be emitted as wrapped.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    // First, fill the buffer with contents, so conpty starts circling\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"Writing line %d/%d\", i, end));\r\n-        expectedOutput.push_back(\"X\");\r\n-        if (i < hostView.BottomInclusive())\r\n-        {\r\n-            expectedOutput.push_back(\"\\r\\n\");\r\n-        }\r\n-        else\r\n-        {\r\n-            // After we hit the bottom of the viewport, the newlines come in\r\n-            // separated by empty writes for whatever reason.\r\n-            expectedOutput.push_back(\"\\r\");\r\n-            expectedOutput.push_back(\"\\n\");\r\n-            expectedOutput.push_back(\"\");\r\n-        }\r\n-\r\n-        sm.ProcessString(L\"X\\n\");\r\n-\r\n-        VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    }\r\n-\r\n-    const auto firstTextLength = TerminalViewWidth - 2;\r\n-    const auto spacesLength = 3;\r\n-    const auto secondTextLength = 1;\r\n-\r\n-    auto firstLine = std::string(firstTextLength, 'A');\r\n-    firstLine += \"  \";\r\n-    std::string secondLine{ \" B\" };\r\n-\r\n-    // The following diagrams show the buffer contents after each string emitted\r\n-    // from conpty. For each of these diagrams:\r\n-    // (w) means we hard wrapped the line\r\n-    // (b) means the line is _not_ wrapped (it's broken, the default state.)\r\n-    // cursor is on the '_'\r\n-\r\n-    // Initial state:\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |_              | (b)\r\n-\r\n-    expectedOutput.push_back(firstLine);\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AA _| (w) The cursor is actually on the last ' ' here\r\n-\r\n-    // TODO GH#5228 might break the \"newline & repaint the wrapped char\" checks here, that's okay.\r\n-    expectedOutput.push_back(\"\\r\"); // This \\r\\n is emitted by ScrollFrame to\r\n-    expectedOutput.push_back(\"\\n\"); // add a newline to the bottom of the buffer\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AA | (b)\r\n-    // |_              | (b)\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[31;80H\"); // Move the cursor BACK to the wrapped row\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AA _| (b) The cursor is actually on the last ' ' here\r\n-    // |               | (b)\r\n-\r\n-    expectedOutput.push_back(std::string(1, ' ')); // Reprint the last character of the wrapped row\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AA  |_ (w) The cursor is actually on the last ' ' here\r\n-    // |               | (b)\r\n-\r\n-    expectedOutput.push_back(secondLine);\r\n-    // |X              | (b)\r\n-    // |X              | (b)\r\n-    // ...\r\n-    // |X              | (b)\r\n-    // |AAAAAAAA...AA  | (w)\r\n-    // | B_            | (b)\r\n-\r\n-    sm.ProcessString(std::wstring(firstTextLength, L'A'));\r\n-    sm.ProcessString(std::wstring(spacesLength, L' '));\r\n-    sm.ProcessString(std::wstring(secondTextLength, L'B'));\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport) {\r\n-        // Buffer contents should look like the following: (80 wide)\r\n-        // (w) means we hard wrapped the line\r\n-        // (b) means the line is _not_ wrapped (it's broken, the default state.)\r\n-        //\r\n-        // |AAAA...AA  | (w)\r\n-        // | B_ ...    | (b) (cursor is on the '_')\r\n-        // |    ...    | (b)\r\n-\r\n-        const auto wrappedRow = viewport.bottom - 2;\r\n-        VERIFY_IS_TRUE(tb.GetRowByOffset(wrappedRow).WasWrapForced());\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(wrappedRow + 1).WasWrapForced());\r\n-\r\n-        // First row\r\n-        auto iter0 = tb.GetCellDataAt({ 0, wrappedRow });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter0, 0, firstTextLength);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter0, 0, 2);\r\n-\r\n-        // Second row\r\n-        auto iter1 = tb.GetCellDataAt({ 0, wrappedRow + 1 });\r\n-        TestUtils::VerifySpanOfText(L\" \", iter1, 0, 1);\r\n-        auto iter2 = tb.GetCellDataAt({ 1, wrappedRow + 1 });\r\n-        TestUtils::VerifySpanOfText(L\"B\", iter2, 0, secondTextLength);\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(hostTb, hostView.ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-    verifyBuffer(termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::BreakLinesOnCursorMovement()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:cursorMovementMode\", L\"{0, 1, 2, 3, 4, 5, 6}\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-    constexpr auto MoveCursorWithCUP = 0;\r\n-    constexpr auto MoveCursorWithCR_LF = 1;\r\n-    constexpr auto MoveCursorWithLF_CR = 2;\r\n-    constexpr auto MoveCursorWithVPR_CR = 3;\r\n-    constexpr auto MoveCursorWithCUB_LF = 4;\r\n-    constexpr auto MoveCursorWithCUD_CR = 5;\r\n-    constexpr auto MoveCursorWithNothing = 6;\r\n-    INIT_TEST_PROPERTY(int, cursorMovementMode, L\"Controls how we move the cursor, either with CUP, newline/carriage-return, or some other VT sequence\");\r\n-\r\n-    Log::Comment(L\"This is a test for GH#5291. WSL vim uses spaces to clear the\"\r\n-                 L\" ends of blank lines, not EL. This test ensures we emit text\"\r\n-                 L\" from conpty such that the terminal re-creates the state of\"\r\n-                 L\" the host, which includes wrapped lines of lots of spaces.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    // Any of the cursor movements that use a LF will actually hard break the\r\n-    // line - everything else will leave it marked as wrapped.\r\n-    const auto expectHardBreak = (cursorMovementMode == MoveCursorWithLF_CR) ||\r\n-                                 (cursorMovementMode == MoveCursorWithCR_LF) ||\r\n-                                 (cursorMovementMode == MoveCursorWithCUB_LF);\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb,\r\n-                            const til::rect viewport) {\r\n-        const auto lastRow = viewport.bottom - 1;\r\n-        const til::point expectedCursor{ 5, lastRow };\r\n-        VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-        VERIFY_IS_TRUE(tb.GetCursor().IsVisible());\r\n-\r\n-        for (auto y = viewport.top; y < lastRow; y++)\r\n-        {\r\n-            // We're using CUP to move onto the status line _always_, so the\r\n-            // second-last row will always be marked as wrapped.\r\n-            const auto rowWrapped = (!expectHardBreak) || (y == lastRow - 1);\r\n-            VERIFY_ARE_EQUAL(rowWrapped, tb.GetRowByOffset(y).WasWrapForced());\r\n-            TestUtils::VerifyExpectedString(tb, L\"~    \", { 0, y });\r\n-        }\r\n-\r\n-        TestUtils::VerifyExpectedString(tb, L\"AAAAA\", { 0, lastRow });\r\n-    };\r\n-\r\n-    // We're _not_ checking the conpty output during this test, only the side effects.\r\n-    _logConpty = true;\r\n-    _checkConptyOutput = false;\r\n-\r\n-    // Lock must be taken to manipulate alt/main buffer state.\r\n-    gci.LockConsole();\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    // Use DECALN to fill the buffer with 'E's.\r\n-    hostSm.ProcessString(L\"\\x1b#8\");\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"Switching to the alt buffer\");\r\n-    hostSm.ProcessString(L\"\\x1b[?1049h\");\r\n-    auto restoreBuffer = wil::scope_exit([&] { hostSm.ProcessString(L\"\\x1b[?1049l\"); });\r\n-    auto& altBuffer = gci.GetActiveOutputBuffer();\r\n-    auto& altTextBuffer = altBuffer.GetTextBuffer();\r\n-\r\n-    // Go home and clear the screen.\r\n-    hostSm.ProcessString(L\"\\x1b[H\");\r\n-    hostSm.ProcessString(L\"\\x1b[2J\");\r\n-\r\n-    // Write out lines of '~' followed by enough spaces to fill the line.\r\n-    hostSm.ProcessString(L\"\\x1b[94m\");\r\n-    for (auto y = 0; y < altBuffer.GetViewport().BottomInclusive(); y++)\r\n-    {\r\n-        // Vim uses CUP to position the cursor on the first cell of each row, every row.\r\n-        if (cursorMovementMode == MoveCursorWithCUP)\r\n-        {\r\n-            std::wstringstream ss;\r\n-            ss << L\"\\x1b[\";\r\n-            ss << y + 1;\r\n-            ss << L\";1H\";\r\n-            hostSm.ProcessString(ss.str());\r\n-        }\r\n-        // As an additional test, try breaking lines manually with \\r\\n\r\n-        else if (cursorMovementMode == MoveCursorWithCR_LF)\r\n-        {\r\n-            // Don't need to newline on the 0'th row\r\n-            if (y > 0)\r\n-            {\r\n-                hostSm.ProcessString(L\"\\r\\n\");\r\n-            }\r\n-        }\r\n-        // As an additional test, try breaking lines manually with \\n\\r\r\n-        else if (cursorMovementMode == MoveCursorWithLF_CR)\r\n-        {\r\n-            // Don't need to newline on the 0'th row\r\n-            if (y > 0)\r\n-            {\r\n-                hostSm.ProcessString(L\"\\n\\r\");\r\n-            }\r\n-        }\r\n-        // As an additional test, move the cursor down with VPR, then to the start of the line with CR\r\n-        else if (cursorMovementMode == MoveCursorWithVPR_CR)\r\n-        {\r\n-            // Don't need to newline on the 0'th row\r\n-            if (y > 0)\r\n-            {\r\n-                hostSm.ProcessString(L\"\\x1b[1e\");\r\n-                hostSm.ProcessString(L\"\\r\");\r\n-            }\r\n-        }\r\n-        // As an additional test, move the cursor back with CUB, then down with LF\r\n-        else if (cursorMovementMode == MoveCursorWithCUB_LF)\r\n-        {\r\n-            // Don't need to newline on the 0'th row\r\n-            if (y > 0)\r\n-            {\r\n-                hostSm.ProcessString(L\"\\x1b[80D\");\r\n-                hostSm.ProcessString(L\"\\n\");\r\n-            }\r\n-        }\r\n-        // As an additional test, move the cursor down with CUD, then to the start of the line with CR\r\n-        else if (cursorMovementMode == MoveCursorWithCUD_CR)\r\n-        {\r\n-            // Don't need to newline on the 0'th row\r\n-            if (y > 0)\r\n-            {\r\n-                hostSm.ProcessString(L\"\\x1b[B\");\r\n-                hostSm.ProcessString(L\"\\r\");\r\n-            }\r\n-        }\r\n-        // Win32 vim.exe will simply do _nothing_ in this scenario. It'll just\r\n-        // print the lines one after the other, without moving the cursor,\r\n-        // relying on us auto moving to the following line.\r\n-        else if (cursorMovementMode == MoveCursorWithNothing)\r\n-        {\r\n-        }\r\n-\r\n-        // IMPORTANT! The way vim writes these blank lines is as '~' followed by\r\n-        // enough spaces to fill the line.\r\n-        // This bug (GH#5291 won't repro if you don't have the spaces).\r\n-        std::wstring line{ L\"~\" };\r\n-        line += std::wstring(79, L' ');\r\n-        hostSm.ProcessString(line);\r\n-    }\r\n-\r\n-    // Print the \"Status Line\"\r\n-    hostSm.ProcessString(L\"\\x1b[32;1H\");\r\n-    hostSm.ProcessString(L\"\\x1b[m\");\r\n-    hostSm.ProcessString(L\"AAAAA\");\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(altTextBuffer, altBuffer.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-    // GH#3492: Now that we support the alt buffer, make sure to validate the\r\n-    // _alt buffer's_ contents.\r\n-    verifyBuffer(*term->_altBuffer, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestCursorInDeferredEOLPositionOnNewLineWithSpaces()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-    const auto termView = term->GetViewport();\r\n-\r\n-    _flushFirstFrame();\r\n-    _checkConptyOutput = false;\r\n-\r\n-    // newline down to the bottom\r\n-    hostSm.ProcessString(std::wstring(gsl::narrow_cast<size_t>(TerminalViewHeight), L'\\n'));\r\n-    // fill width-1 with \"A\", then add one space and another character..\r\n-    hostSm.ProcessString(std::wstring(gsl::narrow_cast<size_t>(TerminalViewWidth) - 1, L'A') + L\" B\");\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, til::CoordType bottomRow) {\r\n-        // Buffer contents should look like the following: (80 wide)\r\n-        // (w) means we hard wrapped the line\r\n-        // (b) means the line is _not_ wrapped (it's broken, the default state.)\r\n-        // cursor is on the '_'\r\n-        //\r\n-        // | ^ ^ ^ ^ ^ ^ ^ | ( ) (entire buffer above us; contents do not matter)\r\n-        // |               | ( ) (entire buffer above us; contents do not matter)\r\n-        // |AAAAAAAA...AAA | (w) (79 'A's, one space)\r\n-        // |B_      ...    | (b) (There's only one 'B' on this line)\r\n-\r\n-        til::point cursorPos{ tb.GetCursor().GetPosition() };\r\n-        // The cursor should be on the second char of the last line\r\n-        VERIFY_ARE_EQUAL(til::point(1, bottomRow), cursorPos);\r\n-\r\n-        const auto& secondToLastRow = tb.GetRowByOffset(bottomRow - 1);\r\n-        const auto& lastRow = tb.GetRowByOffset(bottomRow);\r\n-        VERIFY_IS_TRUE(secondToLastRow.WasWrapForced());\r\n-        VERIFY_IS_FALSE(lastRow.WasWrapForced());\r\n-\r\n-        auto expectedStringSecondToLastRow{ std::wstring(gsl::narrow_cast<size_t>(tb.GetSize().Width()) - 1, L'A') + L\" \" };\r\n-        TestUtils::VerifyExpectedString(tb, expectedStringSecondToLastRow, { 0, bottomRow - 1 });\r\n-        TestUtils::VerifyExpectedString(tb, L\"B\", { 0, bottomRow });\r\n-    };\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    verifyBuffer(hostTb, hostView.BottomInclusive());\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    const auto newTermView = term->GetViewport();\r\n-    verifyBuffer(termTb, newTermView.BottomInclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ResizeRepaintVimExeBuffer()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    // See https://github.com/microsoft/terminal/issues/5428\r\n-    Log::Comment(L\"This test emulates what happens when you decrease the width \"\r\n-                 L\"of the window while running vim.exe.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    // This is a helper that will recreate the way that vim redraws the buffer.\r\n-    auto drawVim = [&sm, &si]() {\r\n-        const auto hostView = si.GetViewport();\r\n-        const auto width = hostView.Width();\r\n-\r\n-        // Write:\r\n-        // * AAA to the first line\r\n-        // * BBB to the second line\r\n-        // * a bunch of lines with a \"~\" followed by spaces (just the way vim.exe likes to render)\r\n-        // * A status line with a bunch of \"X\"s and _a single space in the last cell_.\r\n-        sm.ProcessString(L\"AAA\");\r\n-        sm.ProcessString(L\"\\r\\n\");\r\n-        sm.ProcessString(L\"BBB\");\r\n-        sm.ProcessString(L\"\\r\\n\");\r\n-\r\n-        for (auto i = 2; i < hostView.BottomInclusive(); i++)\r\n-        {\r\n-            // IMPORTANT! The way vim writes these blank lines is as '~' followed by\r\n-            // enough spaces to fill the line.\r\n-            std::wstring line{ L\"~\" };\r\n-            line += std::wstring(width - 1, L' ');\r\n-            sm.ProcessString(line);\r\n-        }\r\n-        sm.ProcessString(std::wstring(width - 1, L'X'));\r\n-        sm.ProcessString(L\" \");\r\n-\r\n-        // Move the cursor back home, as if it's on the first \"A\". The bug won't\r\n-        // repro without this!\r\n-        sm.ProcessString(L\"\\x1b[H\");\r\n-    };\r\n-\r\n-    drawVim();\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport) {\r\n-        const auto firstRow = viewport.top;\r\n-        const auto width = viewport.width();\r\n-        const WEX::TestExecution::DisableVerifyExceptions disableExceptionsScope;\r\n-\r\n-        // First row\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(firstRow).WasWrapForced());\r\n-        auto iter0 = tb.GetCellDataAt({ 0, firstRow });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter0, 0, 3);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter0, 0, width - 3);\r\n-\r\n-        // Second row\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(firstRow + 1).WasWrapForced());\r\n-        auto iter1 = tb.GetCellDataAt({ 0, firstRow + 1 });\r\n-        TestUtils::VerifySpanOfText(L\"B\", iter1, 0, 3);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter1, 0, width - 3);\r\n-\r\n-        // \"~\" rows\r\n-        for (auto row = firstRow + 2; row < viewport.bottom - 1; row++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", row));\r\n-            VERIFY_IS_TRUE(tb.GetRowByOffset(row).WasWrapForced());\r\n-            auto iter = tb.GetCellDataAt({ 0, row });\r\n-            TestUtils::VerifySpanOfText(L\"~\", iter, 0, 1);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter, 0, width - 1);\r\n-        }\r\n-\r\n-        // Last row\r\n-        {\r\n-            const auto row = viewport.bottom - 1;\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", row));\r\n-            VERIFY_IS_TRUE(tb.GetRowByOffset(row).WasWrapForced());\r\n-            auto iter = tb.GetCellDataAt({ 0, row });\r\n-            TestUtils::VerifySpanOfText(L\"X\", iter, 0, width - 1);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter, 0, 1);\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-\r\n-    // After we resize, make sure to get the new textBuffers\r\n-    std::tie(hostTb, termTb) = _performResize({ TerminalViewWidth - 1,\r\n-                                                TerminalViewHeight });\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"Re-painting vim\");\r\n-    // vim will redraw itself when it notices the buffer size change.\r\n-    drawVim();\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (after) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ClsAndClearHostClearsScrollbackTest()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/issues/3126#issuecomment-620677742\r\n-\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:clearBufferMethod\", L\"{0, 1, 2}\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-    INIT_TEST_PROPERTY(int, clearBufferMethod, L\"Controls whether we clear the buffer like cmd or like powershell\");\r\n-\r\n-    Log::Comment(L\"This test checks the shims for cmd.exe and powershell.exe. \"\r\n-                 L\"Their build in commands for clearing the console buffer \"\r\n-                 L\"should work to clear the terminal buffer, not just the \"\r\n-                 L\"terminal viewport.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        if (i > 0)\r\n-        {\r\n-            sm.ProcessString(L\"\\r\\n\");\r\n-        }\r\n-\r\n-        sm.ProcessString(L\"~\");\r\n-    }\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport, const bool afterClear = false) {\r\n-        const auto width = viewport.width();\r\n-\r\n-        // \"~\" rows\r\n-        for (til::CoordType row = 0; row < viewport.bottom; row++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", row));\r\n-            VERIFY_IS_FALSE(tb.GetRowByOffset(row).WasWrapForced());\r\n-            auto iter = tb.GetCellDataAt({ 0, row });\r\n-            if (afterClear)\r\n-            {\r\n-                TestUtils::VerifySpanOfText(L\" \", iter, 0, width);\r\n-            }\r\n-            else\r\n-            {\r\n-                TestUtils::VerifySpanOfText(L\"~\", iter, 0, 1);\r\n-                TestUtils::VerifySpanOfText(L\" \", iter, 0, width - 1);\r\n-            }\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-\r\n-    VERIFY_ARE_EQUAL(si.GetViewport().Dimensions(), si.GetBufferSize().Dimensions());\r\n-    VERIFY_ARE_EQUAL(si.GetViewport(), si.GetBufferSize());\r\n-\r\n-    _clear(clearBufferMethod, si);\r\n-\r\n-    VERIFY_ARE_EQUAL(si.GetViewport().Dimensions(), si.GetBufferSize().Dimensions());\r\n-    VERIFY_ARE_EQUAL(si.GetViewport(), si.GetBufferSize());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (after) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), true);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::_clear(int clearBufferMethod, SCREEN_INFORMATION& si)\r\n-{\r\n-    constexpr auto ClearLikeCls = 0;\r\n-    constexpr auto ClearLikeClearHost = 1;\r\n-    constexpr auto ClearWithVT = 2;\r\n-\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    if (clearBufferMethod == ClearLikeCls)\r\n-    {\r\n-        // Execute the cls, EXACTLY LIKE CMD.\r\n-\r\n-        CONSOLE_SCREEN_BUFFER_INFOEX csbiex{ 0 };\r\n-        csbiex.cbSize = sizeof(CONSOLE_SCREEN_BUFFER_INFOEX);\r\n-        _apiRoutines.GetConsoleScreenBufferInfoExImpl(si, csbiex);\r\n-\r\n-        til::inclusive_rect src{ 0 };\r\n-        src.top = 0;\r\n-        src.left = 0;\r\n-        src.right = csbiex.dwSize.X;\r\n-        src.bottom = csbiex.dwSize.Y;\r\n-\r\n-        til::point tgt{ 0, -csbiex.dwSize.Y };\r\n-        VERIFY_SUCCEEDED(_apiRoutines.ScrollConsoleScreenBufferWImpl(si,\r\n-                                                                     src,\r\n-                                                                     tgt,\r\n-                                                                     std::nullopt, // no clip provided,\r\n-                                                                     L' ',\r\n-                                                                     csbiex.wAttributes,\r\n-                                                                     true));\r\n-    }\r\n-    else if (clearBufferMethod == ClearLikeClearHost)\r\n-    {\r\n-        CONSOLE_SCREEN_BUFFER_INFOEX csbiex{ 0 };\r\n-        csbiex.cbSize = sizeof(CONSOLE_SCREEN_BUFFER_INFOEX);\r\n-        _apiRoutines.GetConsoleScreenBufferInfoExImpl(si, csbiex);\r\n-\r\n-        const auto totalCellsInBuffer = csbiex.dwSize.X * csbiex.dwSize.Y;\r\n-        size_t cellsWritten = 0;\r\n-        VERIFY_SUCCEEDED(_apiRoutines.FillConsoleOutputCharacterWImpl(si,\r\n-                                                                      L' ',\r\n-                                                                      totalCellsInBuffer,\r\n-                                                                      { 0, 0 },\r\n-                                                                      cellsWritten,\r\n-                                                                      true));\r\n-        VERIFY_SUCCEEDED(_apiRoutines.FillConsoleOutputAttributeImpl(si,\r\n-                                                                     csbiex.wAttributes,\r\n-                                                                     totalCellsInBuffer,\r\n-                                                                     { 0, 0 },\r\n-                                                                     cellsWritten));\r\n-    }\r\n-    else if (clearBufferMethod == ClearWithVT)\r\n-    {\r\n-        sm.ProcessString(L\"\\x1b[2J\");\r\n-        VERIFY_ARE_EQUAL(si.GetViewport().Dimensions(), si.GetBufferSize().Dimensions());\r\n-        VERIFY_ARE_EQUAL(si.GetViewport(), si.GetBufferSize());\r\n-\r\n-        sm.ProcessString(L\"\\x1b[3J\");\r\n-    }\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestResizeWithCookedRead()\r\n-{\r\n-    // see https://github.com/microsoft/terminal/issues/1856\r\n-    Log::Comment(L\"This test checks a crash in conpty where resizing the \"\r\n-                 L\"window with any data in a cooked read (like the input line \"\r\n-                 L\"in cmd.exe) would cause the conpty to crash.\");\r\n-\r\n-    // Resizing with a COOKED_READ used to cause a crash in\r\n-    // `Selection::s_GetInputLineBoundaries` north of\r\n-    // `Selection::GetValidAreaBoundaries`.\r\n-    //\r\n-    // If this test completes successfully, then we know that we didn't crash.\r\n-\r\n-    // The specific cases that repro the original crash are:\r\n-    // * (0, -10)\r\n-    // * (0, -1)\r\n-    // * (0, 0)\r\n-    // the rest of the cases are added here for completeness.\r\n-\r\n-    // Don't let the cooked read pollute other tests\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:dx\", L\"{-10, -1, 0, 1, 10}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:dy\", L\"{-10, -1, 0, 1, 10}\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    INIT_TEST_PROPERTY(int, dx, L\"The change in width of the buffer\");\r\n-    INIT_TEST_PROPERTY(int, dy, L\"The change in height of the buffer\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    // Setup the cooked read data\r\n-    m_state->PrepareReadHandle();\r\n-    // TODO GH#5618: This string will get mangled, but we don't really care\r\n-    // about the buffer contents in this test, so it doesn't really matter.\r\n-    m_state->PrepareCookedReadData(L\"This is some cooked read data\");\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // After we resize, make sure to get the new textBuffers\r\n-    std::tie(hostTb, termTb) = _performResize({ TerminalViewWidth + dx,\r\n-                                                TerminalViewHeight + dy });\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // By simply reaching the end of this test, we know that we didn't crash. Hooray!\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ResizeInitializeBufferWithDefaultAttrs()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/issues/3848\r\n-    Log::Comment(L\"This test checks that the attributes in the text buffer are \"\r\n-                 L\"initialized to a sensible value during a resize. The entire \"\r\n-                 L\"buffer shouldn't be filled with _whatever the current \"\r\n-                 L\"attributes are_, it should be filled with the default \"\r\n-                 L\"attributes (however the application defines that). Then, \"\r\n-                 L\"after the resize, we should still be able to print to the \"\r\n-                 L\"buffer with the old \\\"current attributes\\\"\");\r\n-\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:dx\", L\"{-1, 0, 1}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:dy\", L\"{-1, 0, 1}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:leaveTrailingChar\", L\"{false, true}\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    INIT_TEST_PROPERTY(int, dx, L\"The change in width of the buffer\");\r\n-    INIT_TEST_PROPERTY(int, dy, L\"The change in height of the buffer\");\r\n-    INIT_TEST_PROPERTY(bool, leaveTrailingChar, L\"If true, we'll print one additional '#' on row 3\");\r\n-\r\n-    // Do nothing if the resize would just be a no-op.\r\n-    if (dx == 0 && dy == 0)\r\n-    {\r\n-        return;\r\n-    }\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    auto defaultAttrs = si.GetAttributes();\r\n-    auto conhostGreenAttrs = TextAttribute();\r\n-    conhostGreenAttrs.SetIndexedBackground(TextColor::DARK_GREEN);\r\n-    auto terminalGreenAttrs = TextAttribute();\r\n-    terminalGreenAttrs.SetIndexedBackground(TextColor::DARK_GREEN);\r\n-\r\n-    // Use an initial ^[[m to start printing with default-on-default\r\n-    sm.ProcessString(L\"\\x1b[m\");\r\n-\r\n-    // Print three lines with \"# #\", where the first \"# \" are in\r\n-    // default-on-green.\r\n-    for (auto i = 0; i < 3; i++)\r\n-    {\r\n-        sm.ProcessString(L\"\\x1b[42m\");\r\n-        sm.ProcessString(L\"# \");\r\n-        sm.ProcessString(L\"\\x1b[m\");\r\n-        sm.ProcessString(L\"#\");\r\n-        sm.ProcessString(L\"\\r\\n\");\r\n-    }\r\n-\r\n-    // Now, leave the active attributes as default-on-green. When we resize the\r\n-    // buffers, we don't want them initialized with default-on-green, we want\r\n-    // them to use whatever the set default attributes are.\r\n-    sm.ProcessString(L\"\\x1b[42m\");\r\n-\r\n-    // If leaveTrailingChar is true, we'll leave one default-on-green '#' on row\r\n-    // 3. This will force conpty to change the Terminal's colors to\r\n-    // default-on-green, so we can check that not only conhost initialize the\r\n-    // buffer colors correctly, but so does the Terminal.\r\n-    if (leaveTrailingChar)\r\n-    {\r\n-        sm.ProcessString(L\"#\");\r\n-    }\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport, const bool isTerminal, const bool afterResize) {\r\n-        const auto width = viewport.width();\r\n-\r\n-        // Conhost and Terminal attributes are potentially different.\r\n-        const auto greenAttrs = isTerminal ? terminalGreenAttrs : conhostGreenAttrs;\r\n-\r\n-        for (til::CoordType row = 0; row < tb.GetSize().Height(); row++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d...\", row));\r\n-\r\n-            VERIFY_IS_FALSE(tb.GetRowByOffset(row).WasWrapForced());\r\n-\r\n-            const auto hasChar = row < 3;\r\n-            const auto actualDefaultAttrs = isTerminal ? TextAttribute() : defaultAttrs;\r\n-\r\n-            if (hasChar)\r\n-            {\r\n-                auto iter = TestUtils::VerifyLineContains(tb, { 0, row }, L'#', greenAttrs, 1u);\r\n-                TestUtils::VerifyLineContains(iter, L' ', greenAttrs, 1u);\r\n-                TestUtils::VerifyLineContains(iter, L'#', TextAttribute(), 1u);\r\n-                // After the resize, the default attrs of the last char will\r\n-                // extend to fill the rest of the row. This is GH#32. If that\r\n-                // bug ever gets fixed, this test will break, but that's\r\n-                // ABSOLUTELY OKAY.\r\n-                TestUtils::VerifyLineContains(iter, L' ', (afterResize ? TextAttribute() : actualDefaultAttrs), static_cast<size_t>(width - 3));\r\n-            }\r\n-            else if (leaveTrailingChar && row == 3)\r\n-            {\r\n-                auto iter = TestUtils::VerifyLineContains(tb, { 0, row }, L'#', greenAttrs, 1u);\r\n-                TestUtils::VerifyLineContains(iter, L' ', (actualDefaultAttrs), static_cast<size_t>(width - 1));\r\n-            }\r\n-            else\r\n-            {\r\n-                TestUtils::VerifyLineContains(tb, { 0, row }, L' ', actualDefaultAttrs, viewport.narrow_width<size_t>());\r\n-            }\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), false, false);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true, false);\r\n-\r\n-    // After we resize, make sure to get the new textBuffers\r\n-    std::tie(hostTb, termTb) = _performResize({ TerminalViewWidth + dx,\r\n-                                                TerminalViewHeight + dy });\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (after) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), false, true);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true, true);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::NewLinesAtBottomWithBackground()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:paintEachNewline\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:spacesToPrint\", L\"{1, 7, 8, 9, 32}\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-\r\n-    INIT_TEST_PROPERTY(bool, paintEachNewline, L\"If true, call PaintFrame after each pair of lines.\");\r\n-    INIT_TEST_PROPERTY(int, spacesToPrint, L\"Controls the number of spaces printed after the first '#'\");\r\n-\r\n-    // See https://github.com/microsoft/terminal/issues/5502\r\n-    Log::Comment(L\"Attempts to emit text to a new bottom line with spaces with \"\r\n-                 L\"a colored background. When that happens, we should make \"\r\n-                 L\"sure to still print the spaces, because the information \"\r\n-                 L\"about their background color is important.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    auto defaultAttrs = si.GetAttributes();\r\n-    auto conhostBlueAttrs = defaultAttrs;\r\n-    conhostBlueAttrs.SetIndexedForeground(TextColor::DARK_GREEN);\r\n-    conhostBlueAttrs.SetIndexedBackground(TextColor::DARK_BLUE);\r\n-    auto terminalBlueAttrs = TextAttribute();\r\n-    terminalBlueAttrs.SetIndexedForeground(TextColor::DARK_GREEN);\r\n-    terminalBlueAttrs.SetIndexedBackground(TextColor::DARK_BLUE);\r\n-\r\n-    // We're going to print 4 more rows than the entire height of the viewport,\r\n-    // causing the buffer to circle 4 times. This is 2 extra iterations of the\r\n-    // two lines we're printing per iteration.\r\n-    const auto circledRows = 4;\r\n-    for (auto i = 0; i < (TerminalViewHeight + circledRows) / 2; i++)\r\n-    {\r\n-        // We're printing pairs of lines: ('_' is a space character)\r\n-        //\r\n-        // Line 1 chars: __________________ (break)\r\n-        // Line 1 attrs: DDDDDDDDDDDDDDDDDD (all default attrs)\r\n-        // Line 2 chars: ____#_________#___ (break)\r\n-        // Line 2 attrs: BBBBBBBBBBBBBBDDDD (First spacesToPrint+5 are blue BG, then default attrs)\r\n-        //                    [<----->]\r\n-        //                      This number of spaces controlled by spacesToPrint\r\n-        if (i > 0)\r\n-        {\r\n-            sm.ProcessString(L\"\\r\\n\");\r\n-        }\r\n-\r\n-        // In WSL:\r\n-        // echo -e \"\\e[m\\r\\n\\e[44;32m    #         \\e[m#\"\r\n-\r\n-        sm.ProcessString(L\"\\x1b[m\");\r\n-        sm.ProcessString(L\"\\r\");\r\n-        sm.ProcessString(L\"\\n\");\r\n-        sm.ProcessString(L\"\\x1b[44;32m\");\r\n-        sm.ProcessString(L\"    #\");\r\n-        sm.ProcessString(std::wstring(spacesToPrint, L' '));\r\n-        sm.ProcessString(L\"\\x1b[m\");\r\n-        sm.ProcessString(L\"#\");\r\n-\r\n-        if (paintEachNewline)\r\n-        {\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-        }\r\n-    }\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport) {\r\n-        const auto width = viewport.width();\r\n-        const auto isTerminal = viewport.top != 0;\r\n-\r\n-        // Conhost and Terminal attributes are potentially different.\r\n-        const auto blueAttrs = isTerminal ? terminalBlueAttrs : conhostBlueAttrs;\r\n-\r\n-        for (til::CoordType row = 0; row < viewport.bottom - 2; row++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", row));\r\n-            VERIFY_IS_FALSE(tb.GetRowByOffset(row).WasWrapForced());\r\n-\r\n-            const auto isBlank = (row % 2) == 0;\r\n-            const auto rowCircled = row > (viewport.bottom - 1 - circledRows);\r\n-            // When the buffer circles, new lines will be initialized using the\r\n-            // current text attributes. Those will be the default-on-default\r\n-            // attributes. All of the Terminal's buffer will use\r\n-            // default-on-default.\r\n-            const auto actualDefaultAttrs = rowCircled || isTerminal ? TextAttribute() : defaultAttrs;\r\n-            Log::Comment(NoThrowString().Format(L\"isBlank=%d, rowCircled=%d\", isBlank, rowCircled));\r\n-\r\n-            if (isBlank)\r\n-            {\r\n-                TestUtils::VerifyLineContains(tb, { 0, row }, L' ', actualDefaultAttrs, viewport.narrow_width<size_t>());\r\n-            }\r\n-            else\r\n-            {\r\n-                auto iter = TestUtils::VerifyLineContains(tb, { 0, row }, L' ', blueAttrs, 4u);\r\n-                TestUtils::VerifyLineContains(iter, L'#', blueAttrs, 1u);\r\n-                TestUtils::VerifyLineContains(iter, L' ', blueAttrs, static_cast<size_t>(spacesToPrint));\r\n-                TestUtils::VerifyLineContains(iter, L'#', TextAttribute(), 1u);\r\n-                TestUtils::VerifyLineContains(iter, L' ', actualDefaultAttrs, static_cast<size_t>(width - 15));\r\n-            }\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::WrapNewLineAtBottom()\r\n-{\r\n-    // The actual bug case is\r\n-    // * paintEachNewline=2 (PaintEveryLine)\r\n-    // * writingMethod=1 (PrintWithWriteCharsLegacy)\r\n-    // * circledRows=4\r\n-    //\r\n-    // Though, mysteriously, the bug that this test caught _WASN'T_ the fix for\r\n-    // #5691\r\n-\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:paintEachNewline\", L\"{0, 1, 2}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:writingMethod\", L\"{0, 1}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:circledRows\", L\"{2, 4, 10}\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-\r\n-    // By modifying how often we call PaintFrame, we can test if different\r\n-    // timings for the frame affect the results. In this test we'll be printing\r\n-    // a bunch of paired lines. These values control when the PaintFrame calls\r\n-    // will occur:\r\n-    constexpr auto PaintAfterBothLines = 1; // Paint after each pair of lines is output\r\n-    constexpr auto PaintEveryLine = 2; // Paint after each and every line is output.\r\n-\r\n-    constexpr auto PrintWithPrintString = 0;\r\n-    constexpr auto PrintWithWriteCharsLegacy = 1;\r\n-\r\n-    INIT_TEST_PROPERTY(int, writingMethod, L\"Controls using either ProcessString or WriteCharsLegacy to write to the buffer\");\r\n-    INIT_TEST_PROPERTY(int, circledRows, L\"Controls the number of lines we output.\");\r\n-    INIT_TEST_PROPERTY(int, paintEachNewline, L\"Controls whether we should call PaintFrame every line of text or not.\");\r\n-\r\n-    // GH#5839 -\r\n-    // This test does expose a real bug when using WriteCharsLegacy to emit\r\n-    // wrapped lines in conpty without delayed EOL wrap. However, this fix has\r\n-    // not yet been made, so for now, we need to just skip the cases that cause\r\n-    // this.\r\n-    if (writingMethod == PrintWithWriteCharsLegacy && paintEachNewline == PaintEveryLine)\r\n-    {\r\n-        Log::Result(WEX::Logging::TestResults::Skipped);\r\n-        return;\r\n-    }\r\n-\r\n-    // This test was originally written for\r\n-    //   https://github.com/microsoft/terminal/issues/5691\r\n-    //\r\n-    // It does not _actually_ test #5691 however, it merely checks another issue\r\n-    // found during debugging.\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    const auto width = static_cast<size_t>(TerminalViewWidth);\r\n-\r\n-    const auto charsInFirstLine = width;\r\n-    const auto numCharsFirstColor = 30;\r\n-    const auto numCharsSecondColor = charsInFirstLine - numCharsFirstColor;\r\n-    const auto charsInSecondLine = width / 2;\r\n-\r\n-    const auto defaultAttrs = TextAttribute();\r\n-    const auto conhostDefaultAttrs = si.GetAttributes();\r\n-\r\n-    // Helper to abstract calls into either StateMachine::ProcessString or\r\n-    // WriteCharsLegacy\r\n-    auto print = [&](const std::wstring_view str) {\r\n-        if (writingMethod == PrintWithPrintString)\r\n-        {\r\n-            sm.ProcessString(str);\r\n-        }\r\n-        else if (writingMethod == PrintWithWriteCharsLegacy)\r\n-        {\r\n-            WriteCharsLegacy(si, str, nullptr);\r\n-        }\r\n-    };\r\n-\r\n-    // Each of the lines of text in the buffer will look like the following:\r\n-    //\r\n-    // Line 1 chars: ~~~~~~~~~~~~~~~~~~ <wrap>\r\n-    // Line 1 attrs: YYYYYYYDDDDDDDDDDD (First 30 are yellow FG, then default attrs)\r\n-    // Line 2 chars: ~~~~~~~~~~________ <break> (there are width/2 '~'s here)\r\n-    // Line 2 attrs: DDDDDDDDDDDDDDDDDD (all are default attrs)\r\n-    //\r\n-\r\n-    for (auto i = 0; i < (TerminalViewHeight + circledRows) / 2; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"writing pair of lines %d\", i));\r\n-\r\n-        if (i > 0)\r\n-        {\r\n-            sm.ProcessString(L\"\\r\\n\");\r\n-        }\r\n-\r\n-        sm.ProcessString(L\"\\x1b[33m\");\r\n-\r\n-        print(std::wstring(numCharsFirstColor, L'~'));\r\n-\r\n-        sm.ProcessString(L\"\\x1b[m\");\r\n-\r\n-        print(std::wstring(numCharsSecondColor, L'~'));\r\n-\r\n-        // If we're painting every line, then paint now, while conpty is in a\r\n-        // deferred EOL state. Otherwise, we'll wait to paint till after more output.\r\n-        if (paintEachNewline == PaintEveryLine)\r\n-        {\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-        }\r\n-\r\n-        // Print the rest of the string of text, which should continue from the\r\n-        // wrapped line before it.\r\n-        print(std::wstring(charsInSecondLine, L'~'));\r\n-\r\n-        if (paintEachNewline == PaintEveryLine ||\r\n-            paintEachNewline == PaintAfterBothLines)\r\n-        {\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-        }\r\n-    }\r\n-\r\n-    // At this point, the entire buffer looks like:\r\n-    //\r\n-    // row[0]: |~~~~~~~~~~~~~~~~~~~| <wrap>\r\n-    // row[1]: |~~~~~~             | <break>\r\n-    // row[2]: |~~~~~~~~~~~~~~~~~~~| <wrap>\r\n-    // row[3]: |~~~~~~             | <break>\r\n-    // row[4]: |~~~~~~~~~~~~~~~~~~~| <wrap>\r\n-    // row[5]: |~~~~~~             | <break>\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport) {\r\n-        const auto width = viewport.width();\r\n-        const auto isTerminal = viewport.top != 0;\r\n-\r\n-        for (til::CoordType row = 0; row < viewport.bottom; row++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", row));\r\n-\r\n-            // The first line wrapped, the second didn't, so on and so forth\r\n-            const auto isWrapped = (row % 2) == 0;\r\n-            const auto rowCircled = row >= (viewport.bottom - circledRows);\r\n-\r\n-            const auto actualNonSpacesAttrs = defaultAttrs;\r\n-            const auto actualSpacesAttrs = rowCircled || isTerminal ? defaultAttrs : conhostDefaultAttrs;\r\n-\r\n-            VERIFY_ARE_EQUAL(isWrapped, tb.GetRowByOffset(row).WasWrapForced());\r\n-            if (isWrapped)\r\n-            {\r\n-                TestUtils::VerifyExpectedString(tb, std::wstring(charsInFirstLine, L'~'), { 0, row });\r\n-            }\r\n-            else\r\n-            {\r\n-                auto iter = TestUtils::VerifyExpectedString(tb, std::wstring(charsInSecondLine, L'~'), { 0, row });\r\n-                TestUtils::VerifyExpectedString(std::wstring(width - charsInSecondLine, L' '), iter);\r\n-            }\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-    VERIFY_ARE_EQUAL(circledRows, term->_mutableViewport.Top());\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::WrapNewLineAtBottomLikeMSYS()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/issues/5691\r\n-    Log::Comment(L\"This test attempts to print text like the MSYS `less` pager \"\r\n-                 L\"does. When it prints a wrapped line, we should make sure to \"\r\n-                 L\"not break the line wrapping.\");\r\n-\r\n-    // The importantly valuable variable here ended up being\r\n-    // writingMethod=PrintWithWriteCharsLegacy. That was the one thing that\r\n-    // actually repro'd this bug. The other variables were introduced as part of\r\n-    // debugging, and are left for completeness.\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:circledRows\", L\"{2, 4, 10}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:paintEachNewline\", L\"{0, 1, 2}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:writingMethod\", L\"{0, 1}\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-\r\n-    // By modifying how often we call PaintFrame, we can test if different\r\n-    // timings for the frame affect the results. In this test we'll be printing\r\n-    // a bunch of paired lines. These values control when the PaintFrame calls\r\n-    // will occur:\r\n-    constexpr auto PaintAfterBothLines = 1; // Paint after each pair of lines is output\r\n-    constexpr auto PaintEveryLine = 2; // Paint after each and every line is output.\r\n-\r\n-    constexpr auto PrintWithPrintString = 0;\r\n-    constexpr auto PrintWithWriteCharsLegacy = 1;\r\n-\r\n-    INIT_TEST_PROPERTY(int, writingMethod, L\"Controls using either ProcessString or WriteCharsLegacy to write to the buffer\");\r\n-    INIT_TEST_PROPERTY(int, circledRows, L\"Controls the number of lines we output.\");\r\n-    INIT_TEST_PROPERTY(int, paintEachNewline, L\"Controls whether we should call PaintFrame every line of text or not.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    const auto width = static_cast<size_t>(TerminalViewWidth);\r\n-\r\n-    const auto charsInFirstLine = width;\r\n-    const auto numCharsFirstColor = 30;\r\n-    const auto numCharsSecondColor = charsInFirstLine - numCharsFirstColor;\r\n-    const auto charsInSecondLine = width / 2;\r\n-\r\n-    const auto defaultAttrs = TextAttribute();\r\n-    const auto conhostDefaultAttrs = si.GetAttributes();\r\n-\r\n-    // Helper to abstract calls into either StateMachine::ProcessString or\r\n-    // WriteCharsLegacy\r\n-    auto print = [&](const std::wstring_view str) {\r\n-        if (writingMethod == PrintWithPrintString)\r\n-        {\r\n-            sm.ProcessString(str);\r\n-        }\r\n-        else if (writingMethod == PrintWithWriteCharsLegacy)\r\n-        {\r\n-            WriteCharsLegacy(si, str, nullptr);\r\n-        }\r\n-    };\r\n-\r\n-    // Each of the lines of text in the buffer will look like the following:\r\n-    //\r\n-    // Line 1 chars: ~~~~~~~~~~~~~~~~~~ <wrap>\r\n-    // Line 1 attrs: YYYYYYYDDDDDDDDDDD (First 30 are yellow FG, then default attrs)\r\n-    // Line 2 chars: ~~~~~~~~~~________ <break> (there are width/2 '~'s here)\r\n-    // Line 2 attrs: DDDDDDDDDDDDDDDDDD (all are default attrs)\r\n-    //\r\n-    // The last line of the buffer will be used as a \"prompt\" line, with a\r\n-    // single ':' in it. This is similar to the way `less` typically displays\r\n-    // its prompt at the bottom of the buffer.\r\n-\r\n-    // First, print a whole viewport full of text.\r\n-    for (auto i = 0; i < (TerminalViewHeight) / 2; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"writing pair of lines %d\", i));\r\n-\r\n-        sm.ProcessString(L\"\\x1b[33m\");\r\n-        print(std::wstring(numCharsFirstColor, L'~'));\r\n-        sm.ProcessString(L\"\\x1b[m\");\r\n-\r\n-        if (paintEachNewline == PaintEveryLine)\r\n-        {\r\n-            print(std::wstring(numCharsSecondColor, L'~'));\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-            print(std::wstring(charsInSecondLine, L'~'));\r\n-        }\r\n-        else\r\n-        {\r\n-            // If we're not painting each and every line, then just print all of\r\n-            // the wrapped text in one go. These '~'s will wrap from the first\r\n-            // line onto the second line.\r\n-            print(std::wstring(numCharsSecondColor + charsInSecondLine, L'~'));\r\n-        }\r\n-\r\n-        sm.ProcessString(L\"\\r\\n\");\r\n-\r\n-        if (paintEachNewline == PaintEveryLine ||\r\n-            paintEachNewline == PaintAfterBothLines)\r\n-        {\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-        }\r\n-    }\r\n-\r\n-    // Then print the trailing ':' on the last line.\r\n-    print(L\":\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // At this point, the entire buffer looks like:\r\n-    //\r\n-    // row[25]: |~~~~~~~~~~~~~~~~~~~| <wrap>\r\n-    // row[26]: |~~~~~~             | <break>\r\n-    // row[27]: |~~~~~~~~~~~~~~~~~~~| <wrap>\r\n-    // row[28]: |~~~~~~             | <break>\r\n-    // row[29]: |~~~~~~~~~~~~~~~~~~~| <wrap>\r\n-    // row[30]: |~~~~~~             | <break>\r\n-    // row[31]: |:                  | <break>\r\n-\r\n-    // Now, we'll print the lines that wrapped, after circling the buffer.\r\n-    for (auto i = 0; i < (circledRows) / 2; i++)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(L\"writing pair of lines %d\", i + (TerminalViewHeight / 2)));\r\n-\r\n-        print(L\"\\r\");\r\n-        sm.ProcessString(L\"\\x1b[33m\");\r\n-        print(std::wstring(numCharsFirstColor, L'~'));\r\n-        sm.ProcessString(L\"\\x1b[m\");\r\n-\r\n-        if (paintEachNewline == PaintEveryLine)\r\n-        {\r\n-            // If we're painting every line, then we'll print the first line and\r\n-            // redraw the \"prompt\" line (with the ':'), paint the buffer, then\r\n-            // print the second line and reprint the prompt, as if the user was\r\n-            // slowly hitting the down arrow one line per frame.\r\n-            print(std::wstring(numCharsSecondColor, L'~'));\r\n-            print(L\":\");\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-            print(L\"\\r\");\r\n-            print(std::wstring(charsInSecondLine, L'~'));\r\n-        }\r\n-        else\r\n-        {\r\n-            // Otherwise, we'll print the wrapped line all in one frame.\r\n-            print(std::wstring(numCharsSecondColor + charsInSecondLine, L'~'));\r\n-        }\r\n-\r\n-        // Print the prompt at the bottom of the buffer\r\n-        print(L\"\\r\\n\");\r\n-        print(L\":\");\r\n-\r\n-        if (paintEachNewline == PaintEveryLine ||\r\n-            paintEachNewline == PaintAfterBothLines)\r\n-        {\r\n-            VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-        }\r\n-    }\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport) {\r\n-        const auto width = viewport.width();\r\n-        const auto isTerminal = viewport.top != 0;\r\n-        auto lastRow = viewport.bottom - 1;\r\n-        for (til::CoordType row = 0; row < lastRow; row++)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"Checking row %d\", row));\r\n-\r\n-            // The first line wrapped, the second didn't, so on and so forth.\r\n-            // However, because conpty's buffer is only as tall as the viewport,\r\n-            // we're going to lose lines off the top of the buffer. Most\r\n-            // importantly, because we'll have the \"prompt\" line in the conpty\r\n-            // buffer, then the top line of the conpty will _not_ be wrapped,\r\n-            // when the 0th line of the terminal buffer _is_.\r\n-            const auto isWrapped = (row % 2) == (isTerminal ? 0 : 1);\r\n-            const auto rowCircled = row >= (viewport.bottom - circledRows);\r\n-\r\n-            const auto actualNonSpacesAttrs = defaultAttrs;\r\n-            const auto actualSpacesAttrs = rowCircled || isTerminal ? defaultAttrs : conhostDefaultAttrs;\r\n-\r\n-            // When using WriteCharsLegacy to emit a wrapped line, with the\r\n-            // frame painted before the second half of the wrapped line, the\r\n-            // cursor needs to be manually moved to the second line, because\r\n-            // that's what is expected of WriteCharsLegacy, and the terminal\r\n-            // would otherwise delay that movement. But this means the line\r\n-            // won't be marked as wrapped, and there's no easy way to fix that.\r\n-            // For now we're just skipping this test.\r\n-            if (!(writingMethod == PrintWithWriteCharsLegacy && paintEachNewline == PaintEveryLine && isWrapped))\r\n-            {\r\n-                VERIFY_ARE_EQUAL(isWrapped, tb.GetRowByOffset(row).WasWrapForced());\r\n-            }\r\n-\r\n-            if (isWrapped)\r\n-            {\r\n-                TestUtils::VerifyExpectedString(tb, std::wstring(charsInFirstLine, L'~'), { 0, row });\r\n-            }\r\n-            else\r\n-            {\r\n-                auto iter = TestUtils::VerifyExpectedString(tb, std::wstring(charsInSecondLine, L'~'), { 0, row });\r\n-                TestUtils::VerifyExpectedString(std::wstring(width - charsInSecondLine, L' '), iter);\r\n-            }\r\n-        }\r\n-        VERIFY_IS_FALSE(tb.GetRowByOffset(lastRow).WasWrapForced());\r\n-        auto iter = TestUtils::VerifyExpectedString(tb, std::wstring(1, L':'), { 0, lastRow });\r\n-        TestUtils::VerifyExpectedString(std::wstring(width - 1, L' '), iter);\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state ==========\");\r\n-    VERIFY_ARE_EQUAL(circledRows + 1, term->_mutableViewport.Top());\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::DeleteWrappedWord()\r\n-{\r\n-    // See https://github.com/microsoft/terminal/issues/5839\r\n-    Log::Comment(L\"This test ensures that when we print a empty row beneath a \"\r\n-                 L\"wrapped row, that we _actually_ clear it.\");\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    // Print two lines of text:\r\n-    // |AAAAAAAAAAAAA BBBBBB| <wrap>\r\n-    // |BBBBBBBB_           | <break>\r\n-    // (cursor on the '_')\r\n-\r\n-    sm.ProcessString(L\"\\x1b[?25l\");\r\n-    sm.ProcessString(std::wstring(50, L'A'));\r\n-    sm.ProcessString(L\" \");\r\n-    sm.ProcessString(std::wstring(50, L'B'));\r\n-    sm.ProcessString(L\"\\x1b[?25h\");\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport, const bool after) {\r\n-        const auto width = viewport.width();\r\n-\r\n-        auto iter1 = tb.GetCellDataAt({ 0, 0 });\r\n-        TestUtils::VerifySpanOfText(L\"A\", iter1, 0, 50);\r\n-        TestUtils::VerifySpanOfText(L\" \", iter1, 0, 1);\r\n-        if (after)\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, 50);\r\n-\r\n-            auto iter2 = tb.GetCellDataAt({ 0, 1 });\r\n-            TestUtils::VerifySpanOfText(L\" \", iter2, 0, width);\r\n-        }\r\n-        else\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\"B\", iter1, 0, 50);\r\n-\r\n-            auto iter2 = tb.GetCellDataAt({ 0, 1 });\r\n-            TestUtils::VerifySpanOfText(L\"B\", iter2, 0, 50 - (width - 51));\r\n-            TestUtils::VerifySpanOfText(L\" \", iter2, 0, width);\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), false);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), false);\r\n-\r\n-    // Now, go back and erase all the 'B's, as if the user executed a\r\n-    // backward-kill-word in PowerShell. Afterwards, the buffer will look like:\r\n-    //\r\n-    // |AAAAAAAAAAAAA_      |\r\n-    // |                    |\r\n-    //\r\n-    // We're doing this the same way PsReadline redraws the prompt - by just\r\n-    // reprinting all of it.\r\n-\r\n-    sm.ProcessString(L\"\\x1b[?25l\");\r\n-    sm.ProcessString(L\"\\x1b[H\");\r\n-    sm.ProcessString(std::wstring(50, L'A'));\r\n-    sm.ProcessString(L\" \");\r\n-\r\n-    sm.ProcessString(std::wstring(TerminalViewWidth - 51, L' '));\r\n-\r\n-    sm.ProcessString(L\"\\x1b[2;1H\");\r\n-    sm.ProcessString(std::wstring(50 - (TerminalViewWidth - 51), L' '));\r\n-    sm.ProcessString(L\"\\x1b[1;50H\");\r\n-    sm.ProcessString(L\"\\x1b[?25h\");\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (after) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), true);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true);\r\n-}\r\n-\r\n-// This test checks that upon conpty rendering again, terminal still maintains\r\n-// the same hyperlink IDs\r\n-void ConptyRoundtripTests::HyperlinkIdConsistency()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write a link - the text will simply be 'Link' and the uri will be 'http://example.com'\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& hostSm = si.GetStateMachine();\r\n-    auto& hostTb = si.GetTextBuffer();\r\n-    auto& termTb = *term->_mainBuffer;\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    hostSm.ProcessString(L\"\\x1b]8;;http://example.com\\x1b\\\\Link\\x1b]8;;\\x1b\\\\\");\r\n-\r\n-    // For self-generated IDs, conpty will send a custom ID of the form\r\n-    // {sessionID}-{self-generated ID}\r\n-    // self-generated IDs begin at 1 and increment from there\r\n-    const std::string fmt{ \"\\x1b]8;id={}-1;http://example.com\\x1b\\\\\" };\r\n-    auto s = fmt::format(fmt, GetCurrentProcessId());\r\n-    expectedOutput.push_back(s);\r\n-    expectedOutput.push_back(\"Link\");\r\n-    expectedOutput.push_back(\"\\x1b]8;;\\x1b\\\\\");\r\n-\r\n-    // Force a frame\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Move the cursor down\r\n-    hostSm.ProcessString(L\"\\x1b[2;1H\");\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-\r\n-    // Force a frame\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Move the cursor to somewhere in the link text\r\n-    hostSm.ProcessString(L\"\\x1b[1;2H\");\r\n-    expectedOutput.push_back(\"\\x1b[1;2H\");\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    // Force a frame\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Move the cursor off the link\r\n-    hostSm.ProcessString(L\"\\x1b[2;1H\");\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-\r\n-    // Force a frame\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    auto verifyData = [](TextBuffer& tb) {\r\n-        // Check that all the linked cells still have the same ID\r\n-        auto& row = tb.GetRowByOffset(0);\r\n-        auto id = row.GetAttrByColumn(0).GetHyperlinkId();\r\n-        for (uint16_t i = 1; i < 4; ++i)\r\n-        {\r\n-            VERIFY_ARE_EQUAL(id, row.GetAttrByColumn(i).GetHyperlinkId());\r\n-        }\r\n-    };\r\n-\r\n-    verifyData(hostTb);\r\n-    verifyData(termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ClearBufferSignal()\r\n-{\r\n-    Log::Comment(L\"Write some text to the conpty buffer. Send a ClearBuffer \"\r\n-                 L\"signal, and check that all but the cursor line is removed \"\r\n-                 L\"from the host and the terminal.\");\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    // Print two lines of text:\r\n-    // |AAAAAAAAAAAAA BBBBBB| <wrap>\r\n-    // |BBBBBBBB_           | <break>\r\n-    // (cursor on the '_')\r\n-    // A's are in blue-on-green,\r\n-    // B's are in red-on-yellow\r\n-\r\n-    sm.ProcessString(L\"\\x1b[?25l\");\r\n-    sm.ProcessString(L\"\\x1b[34;42m\");\r\n-    sm.ProcessString(std::wstring(50, L'A'));\r\n-    sm.ProcessString(L\" \");\r\n-    sm.ProcessString(L\"\\x1b[31;43m\");\r\n-    sm.ProcessString(std::wstring(50, L'B'));\r\n-    sm.ProcessString(L\"\\x1b[?25h\");\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport, const bool before) {\r\n-        const auto width = viewport.width();\r\n-        const auto numCharsOnSecondLine = 50 - (width - 51);\r\n-        auto iter1 = tb.GetCellDataAt({ 0, 0 });\r\n-        if (before)\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\"A\", iter1, 0, 50);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, 1);\r\n-            TestUtils::VerifySpanOfText(L\"B\", iter1, 0, 50);\r\n-            til::point expectedCursor{ numCharsOnSecondLine, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-        }\r\n-        else\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\"B\", iter1, 0, numCharsOnSecondLine);\r\n-            til::point expectedCursor{ numCharsOnSecondLine, 0 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), true);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true);\r\n-\r\n-    Log::Comment(L\"========== Clear the ConPTY buffer with the signal ==========\");\r\n-    _clearConpty();\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (after) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), false);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), false);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::SimpleAltBufferTest()\r\n-{\r\n-    Log::Comment(L\"A test for entering and exiting the alt buffer, via conpty. \"\r\n-                 L\"Ensures cursor is in the right place, and contents are \"\r\n-                 L\"restored accordingly.\");\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    // Print two lines of text:\r\n-    // |AAAAAAAA            | <break>\r\n-    // |BBBBBBBB_           | <break>\r\n-    // (cursor on the '_')\r\n-    // A's are in blue-on-green,\r\n-    // B's are in red-on-yellow\r\n-\r\n-    // A one line version: (more or less)\r\n-    //\r\n-    // printf \"\\x1b[2J\\x1b[H\" ; printf\r\n-    // \"\\x1b[?25l\\x1b[34;42mAAAAA\\n\\x1b[31;43mBBBBB\\x1b[?25h\" ; sleep 2 ; printf\r\n-    // \"\\x1b[?1049h\" ; sleep 2 ; printf \"CCCCC\" ; sleep 2 ; printf \"\\x1b[?1049l\"\r\n-    // ; sleep 2\r\n-\r\n-    sm.ProcessString(L\"\\x1b[?25l\");\r\n-    sm.ProcessString(L\"\\x1b[34;42m\");\r\n-    sm.ProcessString(std::wstring(50, L'A'));\r\n-    sm.ProcessString(L\"\\n\");\r\n-    sm.ProcessString(L\"\\x1b[31;43m\");\r\n-    sm.ProcessString(std::wstring(50, L'B'));\r\n-    sm.ProcessString(L\"\\x1b[?25h\");\r\n-\r\n-    // Four frames here:\r\n-    // * After text is printed to main buffer\r\n-    // * after we go to the alt buffer\r\n-    // * print more to the alt buffer\r\n-    // * after we go back to the buffer\r\n-\r\n-    enum class Frame : int\r\n-    {\r\n-        InMainBufferBefore = 0,\r\n-        InAltBufferBefore,\r\n-        InAltBufferAfter,\r\n-        InMainBufferAfter\r\n-    };\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport, const Frame frame) {\r\n-        const auto width = viewport.width();\r\n-        auto iter0 = tb.GetCellDataAt({ 0, 0 });\r\n-        auto iter1 = tb.GetCellDataAt({ 0, 1 });\r\n-        switch (frame)\r\n-        {\r\n-        case Frame::InMainBufferBefore:\r\n-        case Frame::InMainBufferAfter:\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\"A\", iter0, 0, 50);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter0, 0, static_cast<size_t>(width - 50));\r\n-\r\n-            TestUtils::VerifySpanOfText(L\"B\", iter1, 0, 50);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, static_cast<size_t>(width - 50));\r\n-            til::point expectedCursor{ 50, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-            break;\r\n-        }\r\n-        case Frame::InAltBufferBefore:\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\" \", iter0, 0, width);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, width);\r\n-\r\n-            til::point expectedCursor{ 50, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-            break;\r\n-        }\r\n-        case Frame::InAltBufferAfter:\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\" \", iter0, 0, width);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, 50u);\r\n-            TestUtils::VerifySpanOfText(L\"C\", iter1, 0, 5u);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, static_cast<size_t>(width - 55));\r\n-\r\n-            til::point expectedCursor{ 55, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-            break;\r\n-        }\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (InMainBufferBefore) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), Frame::InMainBufferBefore);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (InMainBufferBefore) ==========\");\r\n-    VERIFY_ARE_EQUAL(0, term->_GetMutableViewport().Top());\r\n-    verifyBuffer(*termTb, term->_GetMutableViewport().ToExclusive(), Frame::InMainBufferBefore);\r\n-\r\n-    Log::Comment(L\"========== Switch to the alt buffer ==========\");\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-    sm.ProcessString(L\"\\x1b[?1049h\");\r\n-    // Don't leave ourselves in the alt buffer - that'll pollute other tests.\r\n-    auto leaveAltBuffer = wil::scope_exit([&] { sm.ProcessString(L\"\\x1b[?1049l\"); });\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    auto& siAlt = gci.GetActiveOutputBuffer();\r\n-    auto* hostAltTb = &siAlt.GetTextBuffer();\r\n-    auto* termAltTb = &term->_activeBuffer();\r\n-\r\n-    VERIFY_IS_TRUE(term->_inAltBuffer());\r\n-    VERIFY_ARE_NOT_EQUAL(termAltTb, termTb);\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (InAltBufferBefore) ==========\");\r\n-    verifyBuffer(*hostAltTb, siAlt.GetViewport().ToExclusive(), Frame::InAltBufferBefore);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (InAltBufferBefore) ==========\");\r\n-    VERIFY_ARE_EQUAL(0, term->_GetMutableViewport().Top());\r\n-    verifyBuffer(*termAltTb, term->_GetMutableViewport().ToExclusive(), Frame::InAltBufferBefore);\r\n-\r\n-    Log::Comment(L\"========== Add some text to the alt buffer ==========\");\r\n-\r\n-    sm.ProcessString(L\"CCCCC\");\r\n-    Log::Comment(L\"========== Checking the host buffer state (InAltBufferAfter) ==========\");\r\n-    verifyBuffer(*hostAltTb, siAlt.GetViewport().ToExclusive(), Frame::InAltBufferAfter);\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (InAltBufferAfter) ==========\");\r\n-    VERIFY_ARE_EQUAL(0, term->_GetMutableViewport().Top());\r\n-    verifyBuffer(*termAltTb, term->_GetMutableViewport().ToExclusive(), Frame::InAltBufferAfter);\r\n-\r\n-    Log::Comment(L\"========== Back to the main buffer ==========\");\r\n-\r\n-    sm.ProcessString(L\"\\x1b[?1049l\");\r\n-    Log::Comment(L\"========== Checking the host buffer state (InMainBufferAfter) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), Frame::InMainBufferAfter);\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (InMainBufferAfter) ==========\");\r\n-    VERIFY_ARE_EQUAL(0, term->_GetMutableViewport().Top());\r\n-    verifyBuffer(*termTb, term->_GetMutableViewport().ToExclusive(), Frame::InMainBufferAfter);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::AltBufferToAltBufferTest()\r\n-{\r\n-    Log::Comment(L\"When we request the alt buffer when we're already in the alt buffer, we should still clear it out and replace it.\");\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = true;\r\n-\r\n-    // Print two lines of text:\r\n-    // |AAAAAAAA            | <break>\r\n-    // |BBBBBBBB_           | <break>\r\n-    // (cursor on the '_')\r\n-    // A's are in blue-on-green,\r\n-    // B's are in red-on-yellow\r\n-\r\n-    // A one line version: (more or less)\r\n-    //\r\n-    // printf \"\\x1b[2J\\x1b[H\" ; printf\r\n-    // \"\\x1b[?25l\\x1b[34;42mAAAAA\\n\\x1b[31;43mBBBBB\\x1b[?25h\" ; sleep 2 ; printf\r\n-    // \"\\x1b[?1049h\" ; sleep 2 ; printf \"CCCCC\" ; sleep 2 ; printf \"\\x1b[?1049h\"\r\n-    // ; sleep 2\r\n-\r\n-    sm.ProcessString(L\"\\x1b[?25l\");\r\n-    sm.ProcessString(L\"\\x1b[34;42m\");\r\n-    sm.ProcessString(std::wstring(50, L'A'));\r\n-    sm.ProcessString(L\"\\n\");\r\n-    sm.ProcessString(L\"\\x1b[31;43m\");\r\n-    sm.ProcessString(std::wstring(50, L'B'));\r\n-    sm.ProcessString(L\"\\x1b[?25h\");\r\n-\r\n-    // Four frames here:\r\n-    // * After text is printed to main buffer\r\n-    // * after we go to the alt buffer\r\n-    // * print more to the alt buffer\r\n-    // * after we go back to the buffer\r\n-\r\n-    enum class Frame : int\r\n-    {\r\n-        InMainBufferBefore = 0,\r\n-        InAltBufferBefore,\r\n-        InAltBufferAfter,\r\n-        StillInAltBuffer\r\n-    };\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& viewport, const Frame frame) {\r\n-        const auto width = viewport.width();\r\n-        auto iter0 = tb.GetCellDataAt({ 0, 0 });\r\n-        auto iter1 = tb.GetCellDataAt({ 0, 1 });\r\n-        switch (frame)\r\n-        {\r\n-        case Frame::InMainBufferBefore:\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\"A\", iter0, 0, 50);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter0, 0, static_cast<size_t>(width - 50));\r\n-\r\n-            TestUtils::VerifySpanOfText(L\"B\", iter1, 0, 50);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, static_cast<size_t>(width - 50));\r\n-            til::point expectedCursor{ 50, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-            break;\r\n-        }\r\n-        case Frame::InAltBufferBefore:\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\" \", iter0, 0, width);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, width);\r\n-\r\n-            til::point expectedCursor{ 50, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-            break;\r\n-        }\r\n-        case Frame::InAltBufferAfter:\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\" \", iter0, 0, width);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, 50u);\r\n-            TestUtils::VerifySpanOfText(L\"C\", iter1, 0, 5u);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, static_cast<size_t>(width - 55));\r\n-\r\n-            til::point expectedCursor{ 55, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-            break;\r\n-        }\r\n-        case Frame::StillInAltBuffer:\r\n-        {\r\n-            TestUtils::VerifySpanOfText(L\" \", iter0, 0, width);\r\n-            TestUtils::VerifySpanOfText(L\" \", iter1, 0, width);\r\n-\r\n-            til::point expectedCursor{ 55, 1 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, tb.GetCursor().GetPosition());\r\n-            break;\r\n-        }\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (InMainBufferBefore) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), Frame::InMainBufferBefore);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (InMainBufferBefore) ==========\");\r\n-    verifyBuffer(*termTb, term->_GetMutableViewport().ToExclusive(), Frame::InMainBufferBefore);\r\n-\r\n-    Log::Comment(L\"========== Switch to the alt buffer ==========\");\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-    sm.ProcessString(L\"\\x1b[?1049h\");\r\n-    // Don't leave ourselves in the alt buffer - that'll pollute other tests.\r\n-    auto leaveAltBuffer = wil::scope_exit([&] { sm.ProcessString(L\"\\x1b[?1049l\"); });\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    auto* siAlt = &gci.GetActiveOutputBuffer();\r\n-    auto* hostAltTb = &siAlt->GetTextBuffer();\r\n-    auto* termAltTb = &term->_activeBuffer();\r\n-\r\n-    VERIFY_IS_TRUE(term->_inAltBuffer());\r\n-    VERIFY_ARE_NOT_EQUAL(termAltTb, termTb);\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (InAltBufferBefore) ==========\");\r\n-    verifyBuffer(*hostAltTb, siAlt->GetViewport().ToExclusive(), Frame::InAltBufferBefore);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (InAltBufferBefore) ==========\");\r\n-    verifyBuffer(*termAltTb, term->_GetMutableViewport().ToExclusive(), Frame::InAltBufferBefore);\r\n-\r\n-    Log::Comment(L\"========== Add some text to the alt buffer ==========\");\r\n-\r\n-    sm.ProcessString(L\"CCCCC\");\r\n-    Log::Comment(L\"========== Checking the host buffer state (InAltBufferAfter) ==========\");\r\n-    verifyBuffer(*hostAltTb, siAlt->GetViewport().ToExclusive(), Frame::InAltBufferAfter);\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (InAltBufferAfter) ==========\");\r\n-    verifyBuffer(*termAltTb, term->_GetMutableViewport().ToExclusive(), Frame::InAltBufferAfter);\r\n-\r\n-    Log::Comment(L\"========== Stay in the alt buffer, what happens? ==========\");\r\n-\r\n-    sm.ProcessString(L\"\\x1b[?1049h\");\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    siAlt = &gci.GetActiveOutputBuffer();\r\n-    hostAltTb = &siAlt->GetTextBuffer();\r\n-    termAltTb = &term->_activeBuffer();\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (StillInAltBuffer) ==========\");\r\n-    verifyBuffer(*hostAltTb, siAlt->GetViewport().ToExclusive(), Frame::StillInAltBuffer);\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (StillInAltBuffer) ==========\");\r\n-    verifyBuffer(*termAltTb, term->_GetMutableViewport().ToExclusive(), Frame::StillInAltBuffer);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestPowerLineFirstFrame()\r\n-{\r\n-    Log::Comment(L\"This is a test for GH#8341. If we received colored spaces \"\r\n-                 L\"BEFORE the first frame, we should still emit them!\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    TextAttribute whiteOnGreen{};\r\n-    whiteOnGreen.SetIndexedForeground(TextColor::DARK_WHITE);\r\n-    whiteOnGreen.SetIndexedBackground(TextColor::BRIGHT_GREEN);\r\n-\r\n-    TextAttribute greenOnBlack{};\r\n-    greenOnBlack.SetIndexedForeground(TextColor::BRIGHT_GREEN);\r\n-    greenOnBlack.SetIndexedBackground(TextColor::BRIGHT_BLACK);\r\n-\r\n-    TextAttribute whiteOnBlack{};\r\n-    whiteOnBlack.SetIndexedForeground(TextColor::DARK_WHITE);\r\n-    whiteOnBlack.SetIndexedBackground(TextColor::BRIGHT_BLACK);\r\n-\r\n-    TextAttribute blackOnDefault{};\r\n-    blackOnDefault.SetIndexedForeground(TextColor::BRIGHT_BLACK);\r\n-\r\n-    TextAttribute defaultOnDefault{};\r\n-\r\n-    Log::Comment(L\"========== Fill test content ==========\");\r\n-\r\n-    // As a pwsh one-liner:\r\n-    //\r\n-    //  \"`e[37m`e[102m foo\\bar `e[92m`e[100m\u25b6 `e[37mBar `e[90m`e[49m\u25b6 `e[m\"\r\n-    //\r\n-    // Generally taken from\r\n-    // https://github.com/microsoft/terminal/issues/8341#issuecomment-731310022,\r\n-    // but minimized for easier testing.\r\n-\r\n-    sm.ProcessString(L\"\\x1b[37m\\x1b[102m\" // dark white on bright green\r\n-                     L\" foo\\\\bar \");\r\n-    sm.ProcessString(L\"\\x1b[92m\\x1b[100m\" // bright green on bright black\r\n-                     L\"\u25b6 \");\r\n-    sm.ProcessString(L\"\\x1b[37m\" // dark white on bright black\r\n-                     L\"Bar \");\r\n-    sm.ProcessString(L\"\\x1b[90m\\x1b[49m\" // bright black on default\r\n-                     L\"\u25b6 \");\r\n-    sm.ProcessString(L\"\\x1b[m\\n\"); // default on default\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        // If this test fails on character 8, then it's because we didn't emit the space, we just moved ahead.\r\n-        auto iter0 = TestUtils::VerifyLineContains(tb, { 0, 0 }, whiteOnGreen, 9u);\r\n-        TestUtils::VerifyLineContains(iter0, OutputCellIterator{ greenOnBlack, 2u });\r\n-        TestUtils::VerifyLineContains(iter0, OutputCellIterator{ whiteOnBlack, 4u });\r\n-        TestUtils::VerifyLineContains(iter0, OutputCellIterator{ blackOnDefault, 2u });\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Check host buffer ==========\");\r\n-    verifyBuffer(*hostTb);\r\n-\r\n-    Log::Comment(L\"========== Paint first frame ==========\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Check terminal buffer ==========\");\r\n-    verifyBuffer(*termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::AltBufferResizeCrash()\r\n-{\r\n-    Log::Comment(L\"During the review for GH#12719, it was noticed that this \"\r\n-                 L\"particular combination of resizing could crash the terminal.\"\r\n-                 L\" This test makes sure we don't.\");\r\n-\r\n-    // Anything that resizes the buffer needs IsolationLevel:Method\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    // Don't leave ourselves in the alt buffer - that'll pollute other tests.\r\n-    auto leaveAltBuffer = wil::scope_exit([&] { sm.ProcessString(L\"\\x1b[?1049l\"); });\r\n-\r\n-    // Note: we really don't care about the output in this test. We could, but\r\n-    // mostly we care to ensure we don't crash. If we make it through this test,\r\n-    // then it's a success.\r\n-\r\n-    Log::Comment(L\"========== Resize to 132x24 ==========\");\r\n-    sm.ProcessString(L\"\\x1b[8;24;132t\");\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Move cursor to (99,11) ==========\");\r\n-    sm.ProcessString(L\"\\x1b[12;100H\");\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Switch to the alt buffer ==========\");\r\n-    sm.ProcessString(L\"\\x1b[?1049h\");\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Resize to 80x10 ==========\");\r\n-    sm.ProcessString(L\"\\x1b[8;10;80t\");\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestNoExtendedAttrsOptimization()\r\n-{\r\n-    Log::Comment(L\"We don't want conpty to optimize out runs of spaces that DO \"\r\n-                 L\"have extended attrs, because EL / ECH don't fill space with \"\r\n-                 L\"those attributes\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    TextAttribute reverseAttrs{};\r\n-    reverseAttrs.SetReverseVideo(true);\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        auto iter0 = TestUtils::VerifyLineContains(tb, { 0, 0 }, L' ', reverseAttrs, 9u);\r\n-        TestUtils::VerifyExpectedString(L\"test\", iter0);\r\n-        TestUtils::VerifyLineContains(iter0, L' ', reverseAttrs, 9u);\r\n-\r\n-        TestUtils::VerifyLineContains(tb, { 0, 1 }, L' ', reverseAttrs, static_cast<uint32_t>(TerminalViewWidth));\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Fill test content ==========\");\r\n-    sm.ProcessString(L\"\\x1b[7m         test         \\x1b[m\\n\");\r\n-    sm.ProcessString(L\"\\x1b[7m\");\r\n-    sm.ProcessString(std::wstring(TerminalViewWidth, L' '));\r\n-    sm.ProcessString(L\"\\x1b[m\\n\");\r\n-\r\n-    Log::Comment(L\"========== Check host buffer ==========\");\r\n-    verifyBuffer(*hostTb);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Check terminal buffer ==========\");\r\n-    verifyBuffer(*termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::TestNoBackgroundAttrsOptimization()\r\n-{\r\n-    Log::Comment(L\"Same as above, with BG attrs\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    TextAttribute bgAttrs{};\r\n-    bgAttrs.SetIndexedBackground(TextColor::DARK_WHITE);\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        auto iter0 = TestUtils::VerifyLineContains(tb, { 0, 0 }, L' ', bgAttrs, 9u);\r\n-        TestUtils::VerifyExpectedString(L\"test\", iter0);\r\n-        TestUtils::VerifyLineContains(iter0, L' ', bgAttrs, 9u);\r\n-\r\n-        TestUtils::VerifyLineContains(tb, { 0, 1 }, L' ', bgAttrs, static_cast<uint32_t>(TerminalViewWidth));\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Fill test content ==========\");\r\n-    sm.ProcessString(L\"\\x1b[47m         test         \\x1b[m\\n\");\r\n-    sm.ProcessString(L\"\\x1b[47m\");\r\n-    sm.ProcessString(std::wstring(TerminalViewWidth, L' '));\r\n-    sm.ProcessString(L\"\\x1b[m\\n\");\r\n-\r\n-    Log::Comment(L\"========== Check host buffer ==========\");\r\n-    verifyBuffer(*hostTb);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Check terminal buffer ==========\");\r\n-    verifyBuffer(*termTb);\r\n-}\r\n-\r\n-#define FTCS_A L\"\\x1b]133;A\\x1b\\\\\"\r\n-#define FTCS_B L\"\\x1b]133;B\\x1b\\\\\"\r\n-#define FTCS_C L\"\\x1b]133;C\\x1b\\\\\"\r\n-#define FTCS_D L\"\\x1b]133;D\\x1b\\\\\"\r\n-\r\n-void ConptyRoundtripTests::SimplePromptRegions()\r\n-{\r\n-    Log::Comment(L\"Same as the ScreenBufferTests::ComplicatedPromptRegions, but in conpty\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        const auto& cursor = tb.GetCursor();\r\n-        {\r\n-            const til::point expectedCursor{ 17, 4 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, cursor.GetPosition());\r\n-        }\r\n-        const WEX::TestExecution::DisableVerifyExceptions disableExceptionsScope;\r\n-\r\n-        const auto& row0 = tb.GetRowByOffset(0);\r\n-        const auto& row4 = tb.GetRowByOffset(4);\r\n-        VERIFY_IS_TRUE(row0.GetScrollbarData().has_value());\r\n-        VERIFY_IS_TRUE(row4.GetScrollbarData().has_value());\r\n-\r\n-        const auto marks = tb.GetMarkExtents();\r\n-        VERIFY_ARE_EQUAL(2u, marks.size());\r\n-\r\n-        {\r\n-            auto& mark = marks[0];\r\n-            const til::point expectedStart{ 0, 0 };\r\n-            const til::point expectedEnd{ 17, 0 };\r\n-            const til::point expectedOutputStart{ 24, 0 }; // `Foo-Bar` is 7 characters\r\n-            const til::point expectedOutputEnd{ 13, 3 };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedOutputStart, *mark.commandEnd);\r\n-            VERIFY_ARE_EQUAL(expectedOutputEnd, *mark.outputEnd);\r\n-        }\r\n-        {\r\n-            auto& mark = marks[1];\r\n-            const til::point expectedStart{ 0, 4 };\r\n-            const til::point expectedEnd{ 17, 4 };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-            VERIFY_IS_FALSE(mark.commandEnd.has_value());\r\n-            VERIFY_IS_FALSE(mark.outputEnd.has_value());\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Fill test content ==========\");\r\n-\r\n-    auto _writePrompt = [](StateMachine& stateMachine, const auto& path) {\r\n-        // A prompt looks like:\r\n-        // `PWSH C:\\Windows> `\r\n-        //\r\n-        // which is 17 characters for C:\\Windows\r\n-        stateMachine.ProcessString(FTCS_D);\r\n-        stateMachine.ProcessString(FTCS_A);\r\n-        stateMachine.ProcessString(L\"\\x1b]9;9;\");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"\\x7\");\r\n-        stateMachine.ProcessString(L\"PWSH \");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"> \");\r\n-        stateMachine.ProcessString(FTCS_B);\r\n-    };\r\n-\r\n-    _writePrompt(sm, L\"C:\\\\Windows\");\r\n-    sm.ProcessString(L\"Foo-bar\");\r\n-    sm.ProcessString(FTCS_C);\r\n-    sm.ProcessString(L\"\\r\\n\");\r\n-    sm.ProcessString(L\"This is some text     \\r\\n\"); // y=1\r\n-    sm.ProcessString(L\"with varying amounts  \\r\\n\"); // y=2\r\n-    sm.ProcessString(L\"of whitespace\\r\\n\"); // y=3\r\n-\r\n-    _writePrompt(sm, L\"C:\\\\Windows\"); // y=4\r\n-\r\n-    Log::Comment(L\"========== Check host buffer ==========\");\r\n-    verifyBuffer(*hostTb);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Check terminal buffer ==========\");\r\n-    verifyBuffer(*termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::MultilinePromptRegions()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    auto bufferWidth = term->GetViewport().Width();\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        const auto& cursor = tb.GetCursor();\r\n-        {\r\n-            const til::point expectedCursor{ 2, 6 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, cursor.GetPosition());\r\n-        }\r\n-        const WEX::TestExecution::DisableVerifyExceptions disableExceptionsScope;\r\n-\r\n-        const auto& row0 = tb.GetRowByOffset(0);\r\n-        const auto& row5 = tb.GetRowByOffset(5);\r\n-        VERIFY_IS_TRUE(row0.GetScrollbarData().has_value());\r\n-        VERIFY_IS_TRUE(row5.GetScrollbarData().has_value());\r\n-\r\n-        const auto marks = tb.GetMarkExtents();\r\n-        VERIFY_ARE_EQUAL(2u, marks.size());\r\n-\r\n-        {\r\n-            Log::Comment(L\"Row 0\");\r\n-            const auto& row = tb.GetRowByOffset(0);\r\n-            const auto& attrs = row.Attributes();\r\n-            const auto& runs = attrs.runs();\r\n-            VERIFY_ARE_EQUAL(2u, runs.size());\r\n-            auto run0 = runs[0];\r\n-            auto run1 = runs[1];\r\n-            VERIFY_ARE_EQUAL(17, run0.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::Prompt, run0.value.GetMarkAttributes());\r\n-\r\n-            VERIFY_ARE_EQUAL(bufferWidth - 17, run1.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::None, run1.value.GetMarkAttributes());\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"Row 1\");\r\n-            const auto& row = tb.GetRowByOffset(1);\r\n-            const auto& attrs = row.Attributes();\r\n-            const auto& runs = attrs.runs();\r\n-            VERIFY_ARE_EQUAL(3u, runs.size());\r\n-            auto run0 = runs[0];\r\n-            auto run1 = runs[1];\r\n-            auto run2 = runs[2];\r\n-            VERIFY_ARE_EQUAL(2, run0.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::Prompt, run0.value.GetMarkAttributes());\r\n-\r\n-            VERIFY_ARE_EQUAL(7, run1.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::Command, run1.value.GetMarkAttributes());\r\n-\r\n-            VERIFY_ARE_EQUAL(bufferWidth - 9, run2.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::None, run2.value.GetMarkAttributes());\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"Row 2\");\r\n-            const auto& row = tb.GetRowByOffset(2);\r\n-            const auto& attrs = row.Attributes();\r\n-            const auto& runs = attrs.runs();\r\n-            VERIFY_ARE_EQUAL(2u, runs.size());\r\n-            auto run0 = runs[0];\r\n-            auto run1 = runs[1];\r\n-            VERIFY_ARE_EQUAL(22, run0.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::Output, run0.value.GetMarkAttributes());\r\n-\r\n-            VERIFY_ARE_EQUAL(bufferWidth - 22, run1.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::None, run1.value.GetMarkAttributes());\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"Row 3\");\r\n-            const auto& row = tb.GetRowByOffset(3);\r\n-            const auto& attrs = row.Attributes();\r\n-            const auto& runs = attrs.runs();\r\n-            VERIFY_ARE_EQUAL(2u, runs.size());\r\n-            auto run0 = runs[0];\r\n-            auto run1 = runs[1];\r\n-            VERIFY_ARE_EQUAL(22, run0.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::Output, run0.value.GetMarkAttributes());\r\n-\r\n-            VERIFY_ARE_EQUAL(bufferWidth - 22, run1.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::None, run1.value.GetMarkAttributes());\r\n-        }\r\n-\r\n-        {\r\n-            auto& mark = marks[0];\r\n-            const til::point expectedStart{ 0, 0 };\r\n-            const til::point expectedEnd{ 2, 1 };\r\n-            const til::point expectedOutputStart{ 9, 1 }; // `Foo-Bar` is 7 characters\r\n-            const til::point expectedOutputEnd{ 13, 4 };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedOutputStart, *mark.commandEnd);\r\n-            VERIFY_ARE_EQUAL(expectedOutputEnd, *mark.outputEnd);\r\n-        }\r\n-        {\r\n-            auto& mark = marks[1];\r\n-            const til::point expectedStart{ 0, 5 };\r\n-            const til::point expectedEnd{ 2, 6 };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-            VERIFY_IS_FALSE(mark.commandEnd.has_value());\r\n-            VERIFY_IS_FALSE(mark.outputEnd.has_value());\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Fill test content ==========\");\r\n-\r\n-    auto _writePrompt = [](StateMachine& stateMachine, const auto& path) {\r\n-        // A prompt looks like:\r\n-        // `PWSH C:\\Windows >`\r\n-        // `> `\r\n-        //\r\n-        // which two rows. The first is 17 characters for C:\\Windows\r\n-        stateMachine.ProcessString(FTCS_D);\r\n-        stateMachine.ProcessString(FTCS_A);\r\n-        stateMachine.ProcessString(L\"\\x1b]9;9;\");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"\\x7\");\r\n-        stateMachine.ProcessString(L\"PWSH \");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\" >\\r\\n\");\r\n-        stateMachine.ProcessString(L\"> \");\r\n-        stateMachine.ProcessString(FTCS_B);\r\n-    };\r\n-\r\n-    _writePrompt(sm, L\"C:\\\\Windows\"); // y=0,1\r\n-    sm.ProcessString(L\"Foo-bar\");\r\n-    sm.ProcessString(FTCS_C);\r\n-    sm.ProcessString(L\"\\r\\n\");\r\n-    sm.ProcessString(L\"This is some text     \\r\\n\"); // y=2\r\n-    sm.ProcessString(L\"with varying amounts  \\r\\n\"); // y=3\r\n-    sm.ProcessString(L\"of whitespace\\r\\n\"); // y=4\r\n-\r\n-    _writePrompt(sm, L\"C:\\\\Windows\"); // y=5, 6\r\n-\r\n-    Log::Comment(L\"========== Check host buffer ==========\");\r\n-    verifyBuffer(*hostTb);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Check terminal buffer ==========\");\r\n-    verifyBuffer(*termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ManyMultilinePromptsWithTrailingSpaces()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    auto bufferWidth = term->GetViewport().Width();\r\n-\r\n-    auto verifyFirstRowOfPrompt = [&](const ROW& row) {\r\n-        const auto& attrs = row.Attributes();\r\n-        const auto& runs = attrs.runs();\r\n-        VERIFY_ARE_EQUAL(2u, runs.size());\r\n-        auto run0 = runs[0];\r\n-        auto run1 = runs[1];\r\n-        VERIFY_ARE_EQUAL(17, run0.length);\r\n-        VERIFY_ARE_EQUAL(MarkKind::Prompt, run0.value.GetMarkAttributes());\r\n-\r\n-        VERIFY_ARE_EQUAL(bufferWidth - 17, run1.length);\r\n-        VERIFY_ARE_EQUAL(MarkKind::None, run1.value.GetMarkAttributes());\r\n-    };\r\n-    auto verifySecondRowOfPrompt = [&](const ROW& row, const auto expectedCommandLength) {\r\n-        const auto& attrs = row.Attributes();\r\n-        const auto& runs = attrs.runs();\r\n-        VERIFY_ARE_EQUAL(3u, runs.size());\r\n-        auto run0 = runs[0];\r\n-        auto run1 = runs[1];\r\n-        auto run2 = runs[2];\r\n-        VERIFY_ARE_EQUAL(2, run0.length);\r\n-        VERIFY_ARE_EQUAL(MarkKind::Prompt, run0.value.GetMarkAttributes());\r\n-\r\n-        VERIFY_ARE_EQUAL(expectedCommandLength, run1.length);\r\n-        VERIFY_ARE_EQUAL(MarkKind::Command, run1.value.GetMarkAttributes());\r\n-\r\n-        VERIFY_ARE_EQUAL(bufferWidth - (2 + expectedCommandLength), run2.length);\r\n-        VERIFY_ARE_EQUAL(MarkKind::None, run2.value.GetMarkAttributes());\r\n-    };\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb) {\r\n-        const auto& cursor = tb.GetCursor();\r\n-        {\r\n-            const til::point expectedCursor{ 0, 11 };\r\n-            VERIFY_ARE_EQUAL(expectedCursor, cursor.GetPosition());\r\n-        }\r\n-        const WEX::TestExecution::DisableVerifyExceptions disableExceptionsScope;\r\n-\r\n-        const auto marks = tb.GetMarkExtents();\r\n-        VERIFY_ARE_EQUAL(3u, marks.size());\r\n-\r\n-        Log::Comment(L\"Row 0\");\r\n-        verifyFirstRowOfPrompt(tb.GetRowByOffset(0));\r\n-\r\n-        Log::Comment(L\"Row 1\");\r\n-        verifySecondRowOfPrompt(tb.GetRowByOffset(1), 7);\r\n-\r\n-        {\r\n-            Log::Comment(L\"Row 2\");\r\n-            const auto& row = tb.GetRowByOffset(2);\r\n-            const auto& attrs = row.Attributes();\r\n-            const auto& runs = attrs.runs();\r\n-            VERIFY_ARE_EQUAL(2u, runs.size());\r\n-            auto run0 = runs[0];\r\n-            auto run1 = runs[1];\r\n-            VERIFY_ARE_EQUAL(22, run0.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::Output, run0.value.GetMarkAttributes());\r\n-\r\n-            VERIFY_ARE_EQUAL(bufferWidth - 22, run1.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::None, run1.value.GetMarkAttributes());\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"Row 3\");\r\n-            const auto& row = tb.GetRowByOffset(3);\r\n-            const auto& attrs = row.Attributes();\r\n-            const auto& runs = attrs.runs();\r\n-            VERIFY_ARE_EQUAL(2u, runs.size());\r\n-            auto run0 = runs[0];\r\n-            auto run1 = runs[1];\r\n-            VERIFY_ARE_EQUAL(22, run0.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::Output, run0.value.GetMarkAttributes());\r\n-\r\n-            VERIFY_ARE_EQUAL(bufferWidth - 22, run1.length);\r\n-            VERIFY_ARE_EQUAL(MarkKind::None, run1.value.GetMarkAttributes());\r\n-        }\r\n-\r\n-        Log::Comment(L\"Row 5\");\r\n-        verifyFirstRowOfPrompt(tb.GetRowByOffset(5));\r\n-\r\n-        Log::Comment(L\"Row 6\");\r\n-        verifySecondRowOfPrompt(tb.GetRowByOffset(6), 7);\r\n-\r\n-        Log::Comment(L\"Row 8\");\r\n-        verifyFirstRowOfPrompt(tb.GetRowByOffset(8));\r\n-\r\n-        Log::Comment(L\"Row 9\");\r\n-        verifySecondRowOfPrompt(tb.GetRowByOffset(9), 6);\r\n-\r\n-        {\r\n-            Log::Comment(L\"Foo-bar mark on rows 0 & 1\");\r\n-\r\n-            auto& mark = marks[0];\r\n-            const til::point expectedStart{ 0, 0 };\r\n-            const til::point expectedEnd{ 2, 1 };\r\n-\r\n-            // The command ends at {9,1} (the end of the Foo-Bar string).\r\n-            // However, the first character in the output is at {0,2}.\r\n-            const til::point expectedOutputStart{ 9, 1 }; // `Foo-Bar` is 7 characters\r\n-            const til::point expectedOutputEnd{ 13, 4 };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedOutputStart, *mark.commandEnd);\r\n-            VERIFY_ARE_EQUAL(expectedOutputEnd, *mark.outputEnd);\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"Boo-far mark on rows 5 & 6\");\r\n-            auto& mark = marks[1];\r\n-            const til::point expectedStart{ 0, 5 };\r\n-            const til::point expectedEnd{ 2, 6 };\r\n-            const til::point expectedOutputStart{ 9, 6 }; // `Boo-far` is 7 characters\r\n-            const til::point expectedOutputEnd{ 22, 7 };\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedOutputStart, *mark.commandEnd);\r\n-            VERIFY_ARE_EQUAL(expectedOutputEnd, *mark.outputEnd);\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"yikes? mark on rows 8 & 9\");\r\n-            auto& mark = marks[2];\r\n-            const til::point expectedStart{ 0, 8 };\r\n-            const til::point expectedEnd{ 2, 9 };\r\n-            const til::point expectedOutputStart{ 8, 9 }; // `yikes?` is 6 characters\r\n-            const til::point expectedOutputEnd{ 22, 10 };\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedOutputStart, *mark.commandEnd);\r\n-            VERIFY_ARE_EQUAL(expectedOutputEnd, *mark.outputEnd);\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Fill test content ==========\");\r\n-\r\n-    auto writePrompt = [](StateMachine& stateMachine, const auto& path) {\r\n-        // A prompt looks like:\r\n-        // `PWSH C:\\Windows >`\r\n-        // `> `\r\n-        //\r\n-        // which two rows. The first is 17 characters for C:\\Windows\r\n-        stateMachine.ProcessString(FTCS_D);\r\n-        stateMachine.ProcessString(FTCS_A);\r\n-        stateMachine.ProcessString(L\"\\x1b]9;9;\");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"\\x7\");\r\n-        stateMachine.ProcessString(L\"PWSH \");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\" >\\r\\n\");\r\n-        stateMachine.ProcessString(L\"> \");\r\n-        stateMachine.ProcessString(FTCS_B);\r\n-    };\r\n-    auto writeCommand = [](StateMachine& stateMachine, const auto& cmd) {\r\n-        stateMachine.ProcessString(cmd);\r\n-        stateMachine.ProcessString(FTCS_C);\r\n-        stateMachine.ProcessString(L\"\\r\\n\");\r\n-    };\r\n-\r\n-    writePrompt(sm, L\"C:\\\\Windows\"); // y=0,1\r\n-    writeCommand(sm, L\"Foo-bar\");\r\n-    sm.ProcessString(L\"This is some text     \\r\\n\"); // y=2\r\n-    sm.ProcessString(L\"with varying amounts  \\r\\n\"); // y=3\r\n-    sm.ProcessString(L\"of whitespace\\r\\n\"); // y=4\r\n-\r\n-    writePrompt(sm, L\"C:\\\\Windows\"); // y=5, 6\r\n-    writeCommand(sm, L\"Boo-far\"); // y=6\r\n-    sm.ProcessString(L\"This is more text     \\r\\n\"); // y=7\r\n-\r\n-    writePrompt(sm, L\"C:\\\\Windows\"); // y=8,9\r\n-    writeCommand(sm, L\"yikes?\"); // y=9\r\n-    sm.ProcessString(L\"This is even more     \\r\\n\"); // y=10\r\n-\r\n-    Log::Comment(L\"========== Check host buffer ==========\");\r\n-    verifyBuffer(*hostTb);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Check terminal buffer ==========\");\r\n-    verifyBuffer(*termTb);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ReflowPromptRegions()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\") // always isolate things that resize the buffer\r\n-        TEST_METHOD_PROPERTY(L\"Data:dx\", L\"{-15, -1, 0, 1, 15}\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    INIT_TEST_PROPERTY(int, dx, L\"The change in width of the buffer\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    gci.LockConsole(); // Lock must be taken to manipulate alt/main buffer state.\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-\r\n-    auto originalWidth = term->GetViewport().Width();\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& /*viewport*/, const bool /*isTerminal*/, const bool afterResize) {\r\n-        const WEX::TestExecution::DisableVerifyExceptions disableExceptionsScope;\r\n-\r\n-        // Just the dx=+1 case doesn't unwrap the line onto one line, but the dx=+15 case does.\r\n-        const bool unwrapped = afterResize && dx > 1;\r\n-        const int unwrapAdjust = unwrapped ? -1 : 0;\r\n-        const auto marks = tb.GetMarkExtents();\r\n-        VERIFY_ARE_EQUAL(3u, marks.size());\r\n-        {\r\n-            Log::Comment(L\"Mark 0\");\r\n-\r\n-            auto& mark = marks[0];\r\n-            const til::point expectedStart{ 0, 0 };\r\n-            const til::point expectedEnd{ 10, 0 };\r\n-            const til::point expectedOutputStart{ 17, 0 }; // `Foo-Bar` is 7 characters\r\n-            const til::point expectedOutputEnd{ 13, 3 };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedOutputStart, *mark.commandEnd);\r\n-            VERIFY_ARE_EQUAL(expectedOutputEnd, *mark.outputEnd);\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"Mark 1\");\r\n-\r\n-            auto& mark = marks[1];\r\n-            const til::point expectedStart{ 0, 4 };\r\n-            const til::point expectedEnd{ 10, 4 };\r\n-            // {originalWidth} characters of 'F', maybe wrapped.\r\n-            const til::point originalPos = til::point{ 10, 5 };\r\n-            til::point afterPos = originalPos;\r\n-            // walk that original pos dx times into the actual real place in the buffer.\r\n-            auto bufferViewport = tb.GetSize();\r\n-            bufferViewport.WalkInBounds(afterPos, -dx);\r\n-            const auto expectedOutputStart = !afterResize ?\r\n-                                                 originalPos : // printed exactly a row, so we're exactly below the prompt\r\n-                                                 afterPos;\r\n-            const til::point expectedOutputEnd{ 22, 6 + unwrapAdjust };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-\r\n-            VERIFY_ARE_EQUAL(expectedOutputStart, *mark.commandEnd);\r\n-            VERIFY_ARE_EQUAL(expectedOutputEnd, *mark.outputEnd);\r\n-        }\r\n-        {\r\n-            Log::Comment(L\"Mark 2\");\r\n-\r\n-            auto& mark = marks[2];\r\n-            const til::point expectedStart{ 0, 7 + unwrapAdjust };\r\n-            const til::point expectedEnd{ 10, 7 + unwrapAdjust };\r\n-            VERIFY_ARE_EQUAL(expectedStart, mark.start);\r\n-            VERIFY_ARE_EQUAL(expectedEnd, mark.end);\r\n-            VERIFY_IS_TRUE(mark.commandEnd.has_value());\r\n-            VERIFY_IS_FALSE(mark.outputEnd.has_value());\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Fill test content ==========\");\r\n-\r\n-    auto writePrompt = [](StateMachine& stateMachine, const auto& path) {\r\n-        // A prompt looks like:\r\n-        // `PWSH C:\\> `\r\n-        //\r\n-        // which is 10 characters for \"C:\\\"\r\n-        stateMachine.ProcessString(FTCS_D);\r\n-        stateMachine.ProcessString(FTCS_A);\r\n-        stateMachine.ProcessString(L\"\\x1b]9;9;\");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"\\x7\");\r\n-        stateMachine.ProcessString(L\"PWSH \");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"> \");\r\n-        stateMachine.ProcessString(FTCS_B);\r\n-    };\r\n-    auto writeCommand = [](StateMachine& stateMachine, const auto& cmd) {\r\n-        stateMachine.ProcessString(cmd);\r\n-        stateMachine.ProcessString(FTCS_C);\r\n-        stateMachine.ProcessString(L\"\\r\\n\");\r\n-    };\r\n-\r\n-    // This first prompt didn't reflow at all\r\n-    writePrompt(sm, L\"C:\\\\\"); // y=0\r\n-    writeCommand(sm, L\"Foo-bar\"); // y=0\r\n-    sm.ProcessString(L\"This is some text     \\r\\n\"); // y=1\r\n-    sm.ProcessString(L\"with varying amounts  \\r\\n\"); // y=2\r\n-    sm.ProcessString(L\"of whitespace\\r\\n\"); // y=3\r\n-\r\n-    // This second one, the command does. It stretches across lines\r\n-    writePrompt(sm, L\"C:\\\\\"); // y=4\r\n-    writeCommand(sm, std::wstring(originalWidth, L'F')); // y=4,5\r\n-    sm.ProcessString(L\"This is more text     \\r\\n\"); // y=6\r\n-\r\n-    writePrompt(sm, L\"C:\\\\\"); // y=7\r\n-    writeCommand(sm, L\"yikes?\"); // y=7\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), false, false);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true, false);\r\n-\r\n-    // After we resize, make sure to get the new textBuffers\r\n-    std::tie(hostTb, termTb) = _performResize({ TerminalViewWidth + dx,\r\n-                                                TerminalViewHeight });\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (after) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive(), false, true);\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true, true);\r\n-}\r\n-\r\n-void ConptyRoundtripTests::ClearMarksTest()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:clearBufferMethod\", L\"{0, 1, 2}\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-\r\n-    INIT_TEST_PROPERTY(int, clearBufferMethod, L\"Controls whether we clear the buffer like cmd or like powershell\");\r\n-\r\n-    Log::Comment(L\"This test checks the shims for cmd.exe and powershell.exe. \"\r\n-                 L\"Their build in commands for clearing the console buffer \"\r\n-                 L\"should work to clear the terminal buffer, not just the \"\r\n-                 L\"terminal viewport.\");\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto* hostTb = &si.GetTextBuffer();\r\n-    auto* termTb = term->_mainBuffer.get();\r\n-\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    _checkConptyOutput = false;\r\n-    _logConpty = false;\r\n-\r\n-    const auto hostView = si.GetViewport();\r\n-    const auto end = 2 * hostView.Height();\r\n-\r\n-    auto writePrompt = [](StateMachine& stateMachine, const auto& path) {\r\n-        // A prompt looks like:\r\n-        // `PWSH C:\\> `\r\n-        //\r\n-        // which is 10 characters for \"C:\\\"\r\n-        stateMachine.ProcessString(FTCS_D);\r\n-        stateMachine.ProcessString(FTCS_A);\r\n-        stateMachine.ProcessString(L\"\\x1b]9;9;\");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"\\x7\");\r\n-        stateMachine.ProcessString(L\"PWSH \");\r\n-        stateMachine.ProcessString(path);\r\n-        stateMachine.ProcessString(L\"> \");\r\n-        stateMachine.ProcessString(FTCS_B);\r\n-    };\r\n-    auto writeCommand = [](StateMachine& stateMachine, const auto& cmd) {\r\n-        stateMachine.ProcessString(cmd);\r\n-        stateMachine.ProcessString(FTCS_C);\r\n-        stateMachine.ProcessString(L\"\\r\\n\");\r\n-    };\r\n-\r\n-    for (auto i = 0; i < end; i++)\r\n-    {\r\n-        writePrompt(sm, L\"C:\\\\\");\r\n-        writeCommand(sm, L\"Foo-bar\");\r\n-        sm.ProcessString(L\"This is some text     \\r\\n\");\r\n-    }\r\n-    writePrompt(sm, L\"C:\\\\\");\r\n-\r\n-    auto verifyBuffer = [&](const TextBuffer& tb, const til::rect& /*viewport*/, const bool afterClear = false) {\r\n-        const WEX::TestExecution::DisableVerifyExceptions disableExceptionsScope;\r\n-        const auto marks = tb.GetMarkExtents();\r\n-        if (afterClear)\r\n-        {\r\n-            VERIFY_ARE_EQUAL(0u, marks.size());\r\n-        }\r\n-        else\r\n-        {\r\n-            VERIFY_IS_GREATER_THAN(marks.size(), 1u, L\"There should be at least one mark\");\r\n-        }\r\n-    };\r\n-\r\n-    Log::Comment(L\"========== Checking the host buffer state (before) ==========\");\r\n-    verifyBuffer(*hostTb, si.GetViewport().ToExclusive());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (before) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive());\r\n-\r\n-    VERIFY_ARE_EQUAL(si.GetViewport().Dimensions(), si.GetBufferSize().Dimensions());\r\n-    VERIFY_ARE_EQUAL(si.GetViewport(), si.GetBufferSize());\r\n-\r\n-    _clear(clearBufferMethod, si);\r\n-\r\n-    VERIFY_ARE_EQUAL(si.GetViewport().Dimensions(), si.GetBufferSize().Dimensions());\r\n-    VERIFY_ARE_EQUAL(si.GetViewport(), si.GetBufferSize());\r\n-\r\n-    Log::Comment(L\"Painting the frame\");\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-    Log::Comment(L\"========== Checking the terminal buffer state (after) ==========\");\r\n-    verifyBuffer(*termTb, term->_mutableViewport.ToExclusive(), true);\r\n-}\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/ScrollTest.cpp b/src/cascadia/UnitTests_TerminalCore/ScrollTest.cpp\nindex 33cf3cee8cf..a23831b173c 100644\n--- a/src/cascadia/UnitTests_TerminalCore/ScrollTest.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/ScrollTest.cpp\n@@ -34,7 +34,6 @@ namespace\n         HRESULT StartPaint() noexcept { return S_OK; }\r\n         HRESULT EndPaint() noexcept { return S_OK; }\r\n         HRESULT Present() noexcept { return S_OK; }\r\n-        HRESULT PrepareForTeardown(_Out_ bool* /*pForcePaint*/) noexcept { return S_OK; }\r\n         HRESULT ScrollFrame() noexcept { return S_OK; }\r\n         HRESULT Invalidate(const til::rect* /*psrRegion*/) noexcept { return S_OK; }\r\n         HRESULT InvalidateCursor(const til::rect* /*psrRegion*/) noexcept { return S_OK; }\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/UnitTests.vcxproj b/src/cascadia/UnitTests_TerminalCore/UnitTests.vcxproj\nindex 94967d5b0ed..b6f38d81ab4 100644\n--- a/src/cascadia/UnitTests_TerminalCore/UnitTests.vcxproj\n+++ b/src/cascadia/UnitTests_TerminalCore/UnitTests.vcxproj\n@@ -23,7 +23,6 @@\n       <PrecompiledHeader>Create</PrecompiledHeader>\r\n     </ClCompile>\r\n     <ClCompile Include=\"TerminalApiTest.cpp\" />\r\n-    <ClCompile Include=\"ConptyRoundtripTests.cpp\" />\r\n     <ClCompile Include=\"TerminalBufferTests.cpp\" />\r\n     <ClCompile Include=\"ScrollTest.cpp\" />\r\n     <ClCompile Include=\"TilWinRtHelpersTests.cpp\" />\r\n@@ -47,45 +46,6 @@\n     <ProjectReference Include=\"..\\TerminalCore\\lib\\TerminalCore-lib.vcxproj\">\r\n       <Project>{ca5cad1a-abcd-429c-b551-8562ec954746}</Project>\r\n     </ProjectReference>\r\n-\r\n-    <!-- The following are all Console Host (host.lib) dependencies. We're\r\n-      including them for the ConptyRoundtripTests, which instantiate a console\r\n-      host, then user the output from conpty to dump directly into a Terminal,\r\n-      and make sure the buffer contents align. -->\r\n-\r\n-    <ProjectReference Include=\"..\\..\\renderer\\vt\\ut_lib\\vt.unittest.vcxproj\">\r\n-      <Project>{990F2657-8580-4828-943F-5DD657D11843}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\renderer\\base\\lib\\base.vcxproj\">\r\n-      <Project>{af0a096a-8b3a-4949-81ef-7df8f0fee91f}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"$(OpenConsoleDir)\\src\\host\\ut_lib\\host.unittest.vcxproj\">\r\n-      <Project>{06ec74cb-9a12-429c-b551-8562ec954746}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\propslib\\propslib.vcxproj\">\r\n-      <Project>{345fd5a4-b32b-4f29-bd1c-b033bd2c35cc}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\interactivity\\base\\lib\\InteractivityBase.vcxproj\">\r\n-      <Project>{06ec74cb-9a12-429c-b551-8562ec964846}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\interactivity\\win32\\lib\\win32.LIB.vcxproj\">\r\n-      <Project>{06ec74cb-9a12-429c-b551-8532ec964726}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\tsf\\tsf.vcxproj\">\r\n-      <Project>{2fd12fbb-1ddb-46d8-b818-1023c624caca}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\server\\lib\\server.vcxproj\">\r\n-      <Project>{18d09a24-8240-42d6-8cb6-236eee820262}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\terminal\\adapter\\lib\\adapter.vcxproj\">\r\n-      <Project>{dcf55140-ef6a-4736-a403-957e4f7430bb}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\internal\\internal.vcxproj\">\r\n-      <Project>{ef3e32a7-5ff6-42b4-b6e2-96cd7d033f00}</Project>\r\n-    </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\renderer\\gdi\\lib\\gdi.vcxproj\">\r\n-      <Project>{1c959542-bac2-4e55-9a6d-13251914cbb9}</Project>\r\n-    </ProjectReference>\r\n   </ItemGroup>\r\n   <ItemGroup>\r\n     <ClInclude Include=\"MockTermSettings.h\" />\r\ndiff --git a/src/common.build.pre.props b/src/common.build.pre.props\nindex 72249d16c02..315902305ae 100644\n--- a/src/common.build.pre.props\n+++ b/src/common.build.pre.props\n@@ -141,7 +141,7 @@\n       <SDLCheck>true</SDLCheck>\r\n       <PrecompiledHeaderFile>precomp.h</PrecompiledHeaderFile>\r\n       <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>\r\n-      <AdditionalIncludeDirectories>$(SolutionDir)\\src\\inc;$(SolutionDir)\\dep;$(SolutionDir)\\dep\\Console;$(SolutionDir)\\dep\\Win32K;$(SolutionDir)\\oss\\chromium;$(SolutionDir)\\oss\\dynamic_bitset;$(SolutionDir)\\oss\\interval_tree;$(SolutionDir)\\oss\\libpopcnt;$(SolutionDir)\\oss\\pcg\\include;%(AdditionalIncludeDirectories);</AdditionalIncludeDirectories>\r\n+      <AdditionalIncludeDirectories>$(SolutionDir)\\src\\inc;$(SolutionDir)\\dep;$(SolutionDir)\\dep\\Console;$(SolutionDir)\\dep\\Win32K;$(SolutionDir)\\oss\\chromium;$(SolutionDir)\\oss\\interval_tree;$(SolutionDir)\\oss\\pcg\\include;%(AdditionalIncludeDirectories);</AdditionalIncludeDirectories>\r\n       <MultiProcessorCompilation>true</MultiProcessorCompilation>\r\n       <MinimalRebuild>false</MinimalRebuild>\r\n       <RuntimeTypeInfo>false</RuntimeTypeInfo>\r\ndiff --git a/src/host/ConsoleArguments.cpp b/src/host/ConsoleArguments.cpp\nindex 0829c6cb70a..d1ecdcb2b16 100644\n--- a/src/host/ConsoleArguments.cpp\n+++ b/src/host/ConsoleArguments.cpp\n@@ -18,7 +18,6 @@ const std::wstring_view ConsoleArguments::FILEPATH_LEADER_PREFIX = L\"\\\\??\\\\\";\n const std::wstring_view ConsoleArguments::WIDTH_ARG = L\"--width\";\r\n const std::wstring_view ConsoleArguments::HEIGHT_ARG = L\"--height\";\r\n const std::wstring_view ConsoleArguments::INHERIT_CURSOR_ARG = L\"--inheritcursor\";\r\n-const std::wstring_view ConsoleArguments::RESIZE_QUIRK = L\"--resizeQuirk\";\r\n const std::wstring_view ConsoleArguments::FEATURE_ARG = L\"--feature\";\r\n const std::wstring_view ConsoleArguments::FEATURE_PTY_ARG = L\"pty\";\r\n const std::wstring_view ConsoleArguments::COM_SERVER_ARG = L\"-Embedding\";\r\n@@ -495,12 +494,6 @@ void ConsoleArguments::s_ConsumeArg(_Inout_ std::vector<std::wstring>& args, _In\n             s_ConsumeArg(args, i);\r\n             hr = S_OK;\r\n         }\r\n-        else if (arg == RESIZE_QUIRK)\r\n-        {\r\n-            _resizeQuirk = true;\r\n-            s_ConsumeArg(args, i);\r\n-            hr = S_OK;\r\n-        }\r\n         else if (arg == GLYPH_WIDTH)\r\n         {\r\n             hr = s_GetArgumentValue(args, i, &_textMeasurement);\r\n@@ -652,10 +645,6 @@ bool ConsoleArguments::GetInheritCursor() const\n {\r\n     return _inheritCursor;\r\n }\r\n-bool ConsoleArguments::IsResizeQuirkEnabled() const\r\n-{\r\n-    return _resizeQuirk;\r\n-}\r\n \r\n #ifdef UNIT_TESTING\r\n // Method Description:\r\ndiff --git a/src/host/ConsoleArguments.hpp b/src/host/ConsoleArguments.hpp\nindex 5067c6d3853..902e7f1c667 100644\n--- a/src/host/ConsoleArguments.hpp\n+++ b/src/host/ConsoleArguments.hpp\n@@ -46,7 +46,6 @@ class ConsoleArguments\n \r\n     std::wstring GetOriginalCommandLine() const;\r\n     std::wstring GetClientCommandline() const;\r\n-    std::wstring GetVtMode() const;\r\n     const std::wstring& GetTextMeasurement() const;\r\n     bool GetForceV1() const;\r\n     bool GetForceNoHandoff() const;\r\n@@ -54,7 +53,6 @@ class ConsoleArguments\n     short GetWidth() const;\r\n     short GetHeight() const;\r\n     bool GetInheritCursor() const;\r\n-    bool IsResizeQuirkEnabled() const;\r\n \r\n #ifdef UNIT_TESTING\r\n     void EnableConptyModeForTests();\r\n@@ -72,7 +70,6 @@ class ConsoleArguments\n     static const std::wstring_view WIDTH_ARG;\r\n     static const std::wstring_view HEIGHT_ARG;\r\n     static const std::wstring_view INHERIT_CURSOR_ARG;\r\n-    static const std::wstring_view RESIZE_QUIRK;\r\n     static const std::wstring_view FEATURE_ARG;\r\n     static const std::wstring_view FEATURE_PTY_ARG;\r\n     static const std::wstring_view COM_SERVER_ARG;\r\n@@ -107,7 +104,6 @@ class ConsoleArguments\n         _serverHandle(serverHandle),\r\n         _signalHandle(signalHandle),\r\n         _inheritCursor(inheritCursor),\r\n-        _resizeQuirk(false),\r\n         _runAsComServer{ runAsComServer }\r\n     {\r\n     }\r\n@@ -135,7 +131,6 @@ class ConsoleArguments\n     DWORD _serverHandle;\r\n     DWORD _signalHandle;\r\n     bool _inheritCursor;\r\n-    bool _resizeQuirk{ false };\r\n \r\n     [[nodiscard]] HRESULT _GetClientCommandline(_Inout_ std::vector<std::wstring>& args,\r\n                                                 const size_t index,\r\ndiff --git a/src/host/CursorBlinker.cpp b/src/host/CursorBlinker.cpp\nindex 78f072ccc94..68250b5f423 100644\n--- a/src/host/CursorBlinker.cpp\n+++ b/src/host/CursorBlinker.cpp\n@@ -82,10 +82,8 @@ void CursorBlinker::TimerRoutine(SCREEN_INFORMATION& ScreenInfo) const noexcept\n     auto& cursor = buffer.GetCursor();\r\n     auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n     auto* const pAccessibilityNotifier = ServiceLocator::LocateAccessibilityNotifier();\r\n-    const auto inConpty{ gci.IsInVtIoMode() };\r\n \r\n-    // GH#2988: ConPTY can now be focused, but it doesn't need to do any of this work either.\r\n-    if (inConpty || !WI_IsFlagSet(gci.Flags, CONSOLE_HAS_FOCUS))\r\n+    if (!WI_IsFlagSet(gci.Flags, CONSOLE_HAS_FOCUS))\r\n     {\r\n         goto DoScroll;\r\n     }\r\n@@ -165,6 +163,12 @@ void CursorBlinker::TimerRoutine(SCREEN_INFORMATION& ScreenInfo) const noexcept\n //   guCaretBlinkTime is -1.\r\n void CursorBlinker::SetCaretTimer() const noexcept\r\n {\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    if (gci.IsInVtIoMode())\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n     using filetime_duration = std::chrono::duration<int64_t, std::ratio<1, 10000000>>;\r\n     static constexpr DWORD dwDefTimeout = 0x212;\r\n \r\ndiff --git a/src/host/PtySignalInputThread.cpp b/src/host/PtySignalInputThread.cpp\nindex 534a6d3ae87..45860f9c1a0 100644\n--- a/src/host/PtySignalInputThread.cpp\n+++ b/src/host/PtySignalInputThread.cpp\n@@ -179,11 +179,7 @@ void PtySignalInputThread::_DoResizeWindow(const ResizeWindowData& data)\n         return;\r\n     }\r\n \r\n-    if (_api.ResizeWindow(data.sx, data.sy))\r\n-    {\r\n-        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-        THROW_IF_FAILED(gci.GetVtIo()->SuppressResizeRepaint());\r\n-    }\r\n+    _api.ResizeWindow(data.sx, data.sy);\r\n }\r\n \r\n void PtySignalInputThread::_DoClearBuffer() const\r\ndiff --git a/src/host/VtInputThread.cpp b/src/host/VtInputThread.cpp\nindex 2df7ee14989..65c62abf25e 100644\n--- a/src/host/VtInputThread.cpp\n+++ b/src/host/VtInputThread.cpp\n@@ -55,54 +55,112 @@ DWORD WINAPI VtInputThread::StaticVtInputThreadProc(_In_ LPVOID lpParameter)\n void VtInputThread::_InputThread()\r\n {\r\n     const auto cleanup = wil::scope_exit([this]() {\r\n-        ServiceLocator::LocateGlobals().getConsoleInformation().GetVtIo()->CloseInput();\r\n+        _hFile.reset();\r\n+        ServiceLocator::LocateGlobals().getConsoleInformation().GetVtIo()->SendCloseEvent();\r\n     });\r\n \r\n+    OVERLAPPED* overlapped = nullptr;\r\n+    OVERLAPPED overlappedBuf{};\r\n+    wil::unique_event overlappedEvent;\r\n+    bool overlappedPending = false;\r\n     char buffer[4096];\r\n-    DWORD dwRead = 0;\r\n+    DWORD read = 0;\r\n \r\n     til::u8state u8State;\r\n     std::wstring wstr;\r\n \r\n+    if (Utils::HandleWantsOverlappedIo(_hFile.get()))\r\n+    {\r\n+        overlappedEvent.reset(CreateEventExW(nullptr, nullptr, CREATE_EVENT_MANUAL_RESET, EVENT_ALL_ACCESS));\r\n+        if (overlappedEvent)\r\n+        {\r\n+            overlappedBuf.hEvent = overlappedEvent.get();\r\n+            overlapped = &overlappedBuf;\r\n+        }\r\n+    }\r\n+\r\n+    // If we use overlapped IO We want to queue ReadFile() calls before processing the\r\n+    // string, because LockConsole/ProcessString may take a while (relatively speaking).\r\n+    // That's why the loop looks a little weird as it starts a read, processes the\r\n+    // previous string, and finally converts the previous read to the next string.\r\n     for (;;)\r\n     {\r\n-        const auto ok = ReadFile(_hFile.get(), buffer, ARRAYSIZE(buffer), &dwRead, nullptr);\r\n-\r\n-        // The ReadFile() documentations calls out that:\r\n-        // > If the lpNumberOfBytesRead parameter is zero when ReadFile returns TRUE on a pipe, the other\r\n-        // > end of the pipe called the WriteFile function with nNumberOfBytesToWrite set to zero.\r\n-        // But I was unable to replicate any such behavior. I'm not sure it's true anymore.\r\n-        //\r\n-        // However, what the documentations fails to mention is that winsock2 (WSA) handles of the \\Device\\Afd type are\r\n-        // transparently compatible with ReadFile() and the WSARecv() documentations contains this important information:\r\n-        // > For byte streams, zero bytes having been read [..] indicates graceful closure and that no more bytes will ever be read.\r\n-        // In other words, for pipe HANDLE of unknown type you should consider `lpNumberOfBytesRead == 0` as an exit indicator.\r\n-        //\r\n-        // Here, `dwRead == 0` fixes a deadlock when exiting conhost while being in use by WSL whose hypervisor pipes are WSA.\r\n-        if (!ok || dwRead == 0)\r\n+        // When we have a `wstr` that's ready for processing we must do so without blocking.\r\n+        // Otherwise, whatever the user typed will be delayed until the next IO operation.\r\n+        // With overlapped IO that's not a problem because the ReadFile() calls won't block.\r\n+        if (overlapped)\r\n         {\r\n-            break;\r\n+            if (!ReadFile(_hFile.get(), &buffer[0], sizeof(buffer), &read, overlapped))\r\n+            {\r\n+                if (GetLastError() != ERROR_IO_PENDING)\r\n+                {\r\n+                    break;\r\n+                }\r\n+                overlappedPending = true;\r\n+            }\r\n         }\r\n \r\n-        // If we hit a parsing error, eat it. It's bad utf-8, we can't do anything with it.\r\n-        if (FAILED_LOG(til::u8u16({ buffer, gsl::narrow_cast<size_t>(dwRead) }, wstr, u8State)))\r\n+        // wstr can be empty in two situations:\r\n+        // * The previous call to til::u8u16 failed.\r\n+        // * We're using overlapped IO, and it's the first iteration.\r\n+        if (!wstr.empty())\r\n+        {\r\n+            try\r\n+            {\r\n+                // Make sure to call the GLOBAL Lock/Unlock, not the gci's lock/unlock.\r\n+                // Only the global unlock attempts to dispatch ctrl events. If you use the\r\n+                //      gci's unlock, when you press C-c, it won't be dispatched until the\r\n+                //      next console API call. For something like `powershell sleep 60`,\r\n+                //      that won't happen for 60s\r\n+                LockConsole();\r\n+                const auto unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n+\r\n+                _pInputStateMachine->ProcessString(wstr);\r\n+            }\r\n+            CATCH_LOG();\r\n+        }\r\n+\r\n+        // Here's the counterpart to the start of the loop. We processed whatever was in `wstr`,\r\n+        // so blocking synchronously on the pipe is now possible.\r\n+        // If we used overlapped IO, we need to wait for the ReadFile() to complete.\r\n+        // If we didn't, we can now safely block on our ReadFile() call.\r\n+        if (overlapped)\r\n         {\r\n-            continue;\r\n+            if (overlappedPending)\r\n+            {\r\n+                overlappedPending = false;\r\n+                if (FAILED(Utils::GetOverlappedResultSameThread(overlapped, &read)))\r\n+                {\r\n+                    break;\r\n+                }\r\n+            }\r\n+        }\r\n+        else\r\n+        {\r\n+            if (!ReadFile(_hFile.get(), &buffer[0], sizeof(buffer), &read, overlapped))\r\n+            {\r\n+                break;\r\n+            }\r\n         }\r\n \r\n-        try\r\n+        // winsock2 (WSA) handles of the \\Device\\Afd type are transparently compatible with\r\n+        // ReadFile() and the WSARecv() documentations contains this important information:\r\n+        // > For byte streams, zero bytes having been read [..] indicates graceful closure and that no more bytes will ever be read.\r\n+        // --> Exit if we've read 0 bytes.\r\n+        if (read == 0)\r\n         {\r\n-            // Make sure to call the GLOBAL Lock/Unlock, not the gci's lock/unlock.\r\n-            // Only the global unlock attempts to dispatch ctrl events. If you use the\r\n-            //      gci's unlock, when you press C-c, it won't be dispatched until the\r\n-            //      next console API call. For something like `powershell sleep 60`,\r\n-            //      that won't happen for 60s\r\n-            LockConsole();\r\n-            const auto unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-\r\n-            _pInputStateMachine->ProcessString(wstr);\r\n+            break;\r\n         }\r\n-        CATCH_LOG();\r\n+\r\n+        TraceLoggingWrite(\r\n+            g_hConhostV2EventTraceProvider,\r\n+            \"ConPTY ReadFile\",\r\n+            TraceLoggingCountedUtf8String(&buffer[0], read, \"buffer\"),\r\n+            TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n+            TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n+\r\n+        // If we hit a parsing error, eat it. It's bad utf-8, we can't do anything with it.\r\n+        FAILED_LOG(til::u8u16({ &buffer[0], gsl::narrow_cast<size_t>(read) }, wstr, u8State));\r\n     }\r\n }\r\n \r\ndiff --git a/src/host/VtIo.cpp b/src/host/VtIo.cpp\nindex 71f170aed3a..06fb4309371 100644\n--- a/src/host/VtIo.cpp\n+++ b/src/host/VtIo.cpp\n@@ -4,11 +4,12 @@\n #include \"precomp.h\"\r\n #include \"VtIo.hpp\"\r\n \r\n+#include <til/unicode.h>\r\n+\r\n #include \"handle.h\" // LockConsole\r\n #include \"output.h\" // CloseConsoleProcessState\r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n #include \"../renderer/base/renderer.hpp\"\r\n-#include \"../renderer/vt/Xterm256Engine.hpp\"\r\n #include \"../types/inc/CodepointWidthDetector.hpp\"\r\n #include \"../types/inc/utils.hpp\"\r\n \r\n@@ -19,16 +20,9 @@ using namespace Microsoft::Console::Types;\n using namespace Microsoft::Console::Utils;\r\n using namespace Microsoft::Console::Interactivity;\r\n \r\n-VtIo::VtIo() :\r\n-    _initialized(false),\r\n-    _lookingForCursorPosition(false)\r\n-{\r\n-}\r\n-\r\n [[nodiscard]] HRESULT VtIo::Initialize(const ConsoleArguments* const pArgs)\r\n {\r\n     _lookingForCursorPosition = pArgs->GetInheritCursor();\r\n-    _resizeQuirk = pArgs->IsResizeQuirkEnabled();\r\n \r\n     // If we were already given VT handles, set up the VT IO engine to use those.\r\n     if (pArgs->InConptyMode())\r\n@@ -90,6 +84,16 @@ VtIo::VtIo() :\n     _hOutput.reset(OutHandle);\r\n     _hSignal.reset(SignalHandle);\r\n \r\n+    if (Utils::HandleWantsOverlappedIo(_hOutput.get()))\r\n+    {\r\n+        _overlappedEvent.reset(CreateEventExW(nullptr, nullptr, CREATE_EVENT_MANUAL_RESET, EVENT_ALL_ACCESS));\r\n+        if (_overlappedEvent)\r\n+        {\r\n+            _overlappedBuf.hEvent = _overlappedEvent.get();\r\n+            _overlapped = &_overlappedBuf;\r\n+        }\r\n+    }\r\n+\r\n     // The only way we're initialized is if the args said we're in conpty mode.\r\n     // If the args say so, then at least one of in, out, or signal was specified\r\n     _initialized = true;\r\n@@ -97,7 +101,7 @@ VtIo::VtIo() :\n }\r\n \r\n // Method Description:\r\n-// - Create the VtRenderer and the VtInputThread for this console.\r\n+// - Create the VtEngine and the VtInputThread for this console.\r\n // MUST BE DONE AFTER CONSOLE IS INITIALIZED, to make sure we've gotten the\r\n //  buffer size from the attached client application.\r\n // Arguments:\r\n@@ -112,11 +116,9 @@ VtIo::VtIo() :\n     {\r\n         return S_FALSE;\r\n     }\r\n-    auto& globals = ServiceLocator::LocateGlobals();\r\n \r\n-    const auto& gci = globals.getConsoleInformation();\r\n     // SetWindowVisibility uses the console lock to protect access to _pVtRenderEngine.\r\n-    assert(gci.IsConsoleLocked());\r\n+    assert(ServiceLocator::LocateGlobals().getConsoleInformation().IsConsoleLocked());\r\n \r\n     try\r\n     {\r\n@@ -124,21 +126,6 @@ VtIo::VtIo() :\n         {\r\n             _pVtInputThread = std::make_unique<VtInputThread>(std::move(_hInput), _lookingForCursorPosition);\r\n         }\r\n-\r\n-        if (IsValidHandle(_hOutput.get()))\r\n-        {\r\n-            auto initialViewport = Viewport::FromDimensions({ 0, 0 }, gci.GetWindowSize());\r\n-\r\n-            auto xterm256Engine = std::make_unique<Xterm256Engine>(std::move(_hOutput),\r\n-                                                                   initialViewport);\r\n-            _pVtRenderEngine = std::move(xterm256Engine);\r\n-\r\n-            if (_pVtRenderEngine)\r\n-            {\r\n-                _pVtRenderEngine->SetTerminalOwner(this);\r\n-                _pVtRenderEngine->SetResizeQuirk(_resizeQuirk);\r\n-            }\r\n-        }\r\n     }\r\n     CATCH_RETURN();\r\n \r\n@@ -167,49 +154,49 @@ bool VtIo::IsUsingVt() const\n     {\r\n         return S_FALSE;\r\n     }\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n \r\n-    if (_pVtRenderEngine)\r\n+    if (_pVtInputThread)\r\n     {\r\n-        try\r\n-        {\r\n-            g.pRender->AddRenderEngine(_pVtRenderEngine.get());\r\n-            g.getConsoleInformation().GetActiveOutputBuffer().SetTerminalConnection(_pVtRenderEngine.get());\r\n-\r\n-            // Force the whole window to be put together first.\r\n-            // We don't really need the handle, we just want to leverage the setup steps.\r\n-            ServiceLocator::LocatePseudoWindow();\r\n-        }\r\n-        CATCH_RETURN();\r\n+        LOG_IF_FAILED(_pVtInputThread->Start());\r\n     }\r\n \r\n-    if (_pVtInputThread)\r\n     {\r\n-        LOG_IF_FAILED(_pVtInputThread->Start());\r\n+        auto writer = GetWriter();\r\n+\r\n+        // GH#4999 - Send a sequence to the connected terminal to request\r\n+        // win32-input-mode from them. This will enable the connected terminal to\r\n+        // send us full INPUT_RECORDs as input. If the terminal doesn't understand\r\n+        // this sequence, it'll just ignore it.\r\n+\r\n+        writer.WriteUTF8(\r\n+            \"\\033[?1004h\" // Focus Event Mode\r\n+            \"\\033[?9001h\" // Win32 Input Mode\r\n+        );\r\n+\r\n+        // MSFT: 15813316\r\n+        // If the terminal application wants us to inherit the cursor position,\r\n+        //  we're going to emit a VT sequence to ask for the cursor position, then\r\n+        //  wait 1s until we get a response.\r\n+        // If we get a response, the InteractDispatch will call SetCursorPosition,\r\n+        //      which will call to our VtIo::SetCursorPosition method.\r\n+        if (_lookingForCursorPosition)\r\n+        {\r\n+            writer.WriteUTF8(\"\\x1b[6n\"); // Cursor Position Report (DSR CPR)\r\n+        }\r\n+\r\n+        writer.Submit();\r\n     }\r\n \r\n-    // MSFT: 15813316\r\n-    // If the terminal application wants us to inherit the cursor position,\r\n-    //  we're going to emit a VT sequence to ask for the cursor position, then\r\n-    //  wait 3s until we get a response.\r\n-    // If we get a response, the InteractDispatch will call SetCursorPosition,\r\n-    //      which will call to our VtIo::SetCursorPosition method.\r\n-    if (_lookingForCursorPosition && _pVtRenderEngine && _pVtInputThread)\r\n+    if (_lookingForCursorPosition)\r\n     {\r\n         _lookingForCursorPosition = false;\r\n-        LOG_IF_FAILED(_pVtRenderEngine->RequestCursor());\r\n \r\n         // Allow the input thread to momentarily gain the console lock.\r\n-        const auto suspension = g.getConsoleInformation().SuspendLock();\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        const auto suspension = gci.SuspendLock();\r\n         _pVtInputThread->WaitUntilDSR(3000);\r\n     }\r\n \r\n-    // GH#4999 - Send a sequence to the connected terminal to request\r\n-    // win32-input-mode from them. This will enable the connected terminal to\r\n-    // send us full INPUT_RECORDs as input. If the terminal doesn't understand\r\n-    // this sequence, it'll just ignore it.\r\n-    LOG_IF_FAILED(_pVtRenderEngine->RequestWin32Input());\r\n-\r\n     if (_pPtySignalInputThread)\r\n     {\r\n         // Let the signal thread know that the console is connected.\r\n@@ -247,25 +234,6 @@ void VtIo::CreatePseudoWindow()\n     }\r\n }\r\n \r\n-void VtIo::SetWindowVisibility(bool showOrHide) noexcept\r\n-{\r\n-    auto& gci = ::Microsoft::Console::Interactivity::ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-\r\n-    gci.LockConsole();\r\n-    auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n-\r\n-    // ConsoleInputThreadProcWin32 calls VtIo::CreatePseudoWindow,\r\n-    // which calls CreateWindowExW, which causes a WM_SIZE message.\r\n-    // In short, this function might be called before _pVtRenderEngine exists.\r\n-    // See PtySignalInputThread::CreatePseudoWindow().\r\n-    if (!_pVtRenderEngine)\r\n-    {\r\n-        return;\r\n-    }\r\n-\r\n-    LOG_IF_FAILED(_pVtRenderEngine->SetWindowVisibility(showOrHide));\r\n-}\r\n-\r\n // Method Description:\r\n // - Create and start the signal thread. The signal thread can be created\r\n //      independent of the i/o threads, and doesn't require a client first\r\n@@ -302,69 +270,6 @@ void VtIo::SetWindowVisibility(bool showOrHide) noexcept\n     return S_OK;\r\n }\r\n \r\n-// Method Description:\r\n-// - Prevent the renderer from emitting output on the next resize. This prevents\r\n-//      the host from echoing a resize to the terminal that requested it.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if the renderer successfully suppressed the next repaint, otherwise an\r\n-//      appropriate HRESULT indicating failure.\r\n-[[nodiscard]] HRESULT VtIo::SuppressResizeRepaint()\r\n-{\r\n-    auto hr = S_OK;\r\n-    if (_pVtRenderEngine)\r\n-    {\r\n-        hr = _pVtRenderEngine->SuppressResizeRepaint();\r\n-    }\r\n-    return hr;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Attempts to set the initial cursor position, if we're looking for it.\r\n-//      If we're not trying to inherit the cursor, does nothing.\r\n-// Arguments:\r\n-// - coordCursor: The initial position of the cursor.\r\n-// Return Value:\r\n-// - S_OK if we successfully inherited the cursor or did nothing, else an\r\n-//      appropriate HRESULT\r\n-[[nodiscard]] HRESULT VtIo::SetCursorPosition(const til::point coordCursor)\r\n-{\r\n-    auto hr = S_OK;\r\n-    if (_lookingForCursorPosition)\r\n-    {\r\n-        if (_pVtRenderEngine)\r\n-        {\r\n-            hr = _pVtRenderEngine->InheritCursor(coordCursor);\r\n-        }\r\n-\r\n-        _lookingForCursorPosition = false;\r\n-    }\r\n-    return hr;\r\n-}\r\n-\r\n-[[nodiscard]] HRESULT VtIo::SwitchScreenBuffer(const bool useAltBuffer)\r\n-{\r\n-    auto hr = S_OK;\r\n-    if (_pVtRenderEngine)\r\n-    {\r\n-        hr = _pVtRenderEngine->SwitchScreenBuffer(useAltBuffer);\r\n-    }\r\n-    return hr;\r\n-}\r\n-\r\n-void VtIo::CloseInput()\r\n-{\r\n-    _pVtInputThread = nullptr;\r\n-    SendCloseEvent();\r\n-}\r\n-\r\n-void VtIo::CloseOutput()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    g.getConsoleInformation().GetActiveOutputBuffer().SetTerminalConnection(nullptr);\r\n-}\r\n-\r\n void VtIo::SendCloseEvent()\r\n {\r\n     LockConsole();\r\n@@ -379,73 +284,16 @@ void VtIo::SendCloseEvent()\n     }\r\n }\r\n \r\n-// The name of this method is an analogy to TCP_CORK. It instructs\r\n-// the VT renderer to stop flushing its buffer to the output pipe.\r\n-// Don't forget to uncork it!\r\n-void VtIo::CorkRenderer(bool corked) const noexcept\r\n-{\r\n-    _pVtRenderEngine->Cork(corked);\r\n-}\r\n-\r\n-#ifdef UNIT_TESTING\r\n-// Method Description:\r\n-// - This is a test helper method. It can be used to trick VtIo into responding\r\n-//   true to `IsUsingVt`, which will cause the console host to act in conpty\r\n-//   mode.\r\n-// Arguments:\r\n-// - vtRenderEngine: a VT renderer that our VtIo should use as the vt engine during these tests\r\n-// Return Value:\r\n-// - <none>\r\n-void VtIo::EnableConptyModeForTests(std::unique_ptr<Microsoft::Console::Render::VtEngine> vtRenderEngine, const bool resizeQuirk)\r\n-{\r\n-    _initialized = true;\r\n-    _resizeQuirk = resizeQuirk;\r\n-    _pVtRenderEngine = std::move(vtRenderEngine);\r\n-}\r\n-#endif\r\n-\r\n-// Method Description:\r\n-// - Returns true if the Resize Quirk is enabled. This changes the behavior of\r\n-//   conpty to _not_ InvalidateAll the entire viewport on a resize operation.\r\n-//   This is used by the Windows Terminal, because it is prepared to be\r\n-//   connected to a conpty, and handles its own buffer specifically for a\r\n-//   conpty scenario.\r\n-// - See also: GH#3490, #4354, #4741\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - true iff we were started with the `--resizeQuirk` flag enabled.\r\n-bool VtIo::IsResizeQuirkEnabled() const\r\n+// Returns true for C0 characters and C1 [single-character] CSI.\r\n+// A copy of isActionableFromGround() from stateMachine.cpp.\r\n+static constexpr bool IsControlCharacter(wchar_t wch) noexcept\r\n {\r\n-    return _resizeQuirk;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Manually tell the renderer that it should emit a \"Erase Scrollback\"\r\n-//   sequence to the connected terminal. We need to do this in certain cases\r\n-//   that we've identified where we believe the client wanted the entire\r\n-//   terminal buffer cleared, not just the viewport. For more information, see\r\n-//   GH#3126.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we wrote the sequences successfully, otherwise an appropriate HRESULT\r\n-[[nodiscard]] HRESULT VtIo::ManuallyClearScrollback() const noexcept\r\n-{\r\n-    if (_pVtRenderEngine)\r\n-    {\r\n-        return _pVtRenderEngine->ManuallyClearScrollback();\r\n-    }\r\n-    return S_OK;\r\n-}\r\n-\r\n-[[nodiscard]] HRESULT VtIo::RequestMouseMode(bool enable) const noexcept\r\n-{\r\n-    if (_pVtRenderEngine)\r\n-    {\r\n-        return _pVtRenderEngine->RequestMouseMode(enable);\r\n-    }\r\n-    return S_OK;\r\n+    // This is equivalent to:\r\n+    //   return (wch <= 0x1f) || (wch >= 0x7f && wch <= 0x9f);\r\n+    // It's written like this to get MSVC to emit optimal assembly for findActionableFromGround.\r\n+    // It lacks the ability to turn boolean operators into binary operations and also happens\r\n+    // to fail to optimize the printable-ASCII range check into a subtraction & comparison.\r\n+    return (wch <= 0x1f) | (static_cast<wchar_t>(wch - 0x7f) <= 0x20);\r\n }\r\n \r\n // Formats the given console attributes to their closest VT equivalent.\r\n@@ -510,3 +358,411 @@ void VtIo::FormatAttributes(std::wstring& target, const TextAttribute& attribute\n \r\n     target.append(bufW, len);\r\n }\r\n+\r\n+VtIo::Writer VtIo::GetWriter() noexcept\r\n+{\r\n+    _corked += 1;\r\n+    return Writer{ this };\r\n+}\r\n+\r\n+VtIo::Writer::Writer(VtIo* io) noexcept :\r\n+    _io{ io }\r\n+{\r\n+}\r\n+\r\n+VtIo::Writer::~Writer() noexcept\r\n+{\r\n+    // If _io is non-null, then we didn't call Submit, e.g. because of an exception.\r\n+    // We need to avoid flushing the buffer in that case.\r\n+    if (_io)\r\n+    {\r\n+        _io->_writerTainted = true;\r\n+        _io->_uncork();\r\n+    }\r\n+}\r\n+\r\n+VtIo::Writer::Writer(Writer&& other) noexcept :\r\n+    _io{ std::exchange(other._io, nullptr) }\r\n+{\r\n+}\r\n+\r\n+VtIo::Writer& VtIo::Writer::operator=(Writer&& other) noexcept\r\n+{\r\n+    if (this != &other)\r\n+    {\r\n+        this->~Writer();\r\n+        _io = std::exchange(other._io, nullptr);\r\n+    }\r\n+    return *this;\r\n+}\r\n+\r\n+VtIo::Writer::operator bool() const noexcept\r\n+{\r\n+    return _io != nullptr;\r\n+}\r\n+\r\n+void VtIo::Writer::Submit()\r\n+{\r\n+    const auto io = std::exchange(_io, nullptr);\r\n+    io->_uncork();\r\n+}\r\n+\r\n+void VtIo::_uncork()\r\n+{\r\n+    _corked -= 1;\r\n+    if (_corked <= 0)\r\n+    {\r\n+        _flushNow();\r\n+    }\r\n+}\r\n+\r\n+void VtIo::_flushNow()\r\n+{\r\n+    size_t minSize = 0;\r\n+\r\n+    if (_writerRestoreCursor)\r\n+    {\r\n+        minSize = 4;\r\n+        _writerRestoreCursor = false;\r\n+        _back.append(\"\\x1b\\x38\"); // DECRC: DEC Restore Cursor (+ attributes)\r\n+    }\r\n+\r\n+    if (_overlappedPending)\r\n+    {\r\n+        _overlappedPending = false;\r\n+\r\n+        DWORD written;\r\n+        if (FAILED(Utils::GetOverlappedResultSameThread(_overlapped, &written)))\r\n+        {\r\n+            // Not much we can do here. Let's treat this like a ERROR_BROKEN_PIPE.\r\n+            _hOutput.reset();\r\n+            SendCloseEvent();\r\n+        }\r\n+    }\r\n+\r\n+    _front.clear();\r\n+    _front.swap(_back);\r\n+\r\n+    // If it's >128KiB large and twice as large as the previous buffer, free the memory.\r\n+    // This ensures that there's a pathway for shrinking the buffer from large sizes.\r\n+    if (const auto cap = _back.capacity(); cap > 128 * 1024 && cap / 2 > _front.size())\r\n+    {\r\n+        _back = std::string{};\r\n+    }\r\n+\r\n+    // We encountered an exception and shouldn't flush the broken pieces.\r\n+    if (_writerTainted)\r\n+    {\r\n+        _writerTainted = false;\r\n+        return;\r\n+    }\r\n+\r\n+    // If _back (now _front) was empty, we can return early. If all _front contains is\r\n+    // DECSC/DECRC that was added by BackupCursor & us, we can also return early.\r\n+    if (_front.size() <= minSize)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    // No point in calling WriteFile if we already encountered ERROR_BROKEN_PIPE.\r\n+    // We do this after the above, so that _back doesn't grow indefinitely.\r\n+    if (!_hOutput)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    const auto write = gsl::narrow_cast<DWORD>(_front.size());\r\n+\r\n+    TraceLoggingWrite(\r\n+        g_hConhostV2EventTraceProvider,\r\n+        \"ConPTY WriteFile\",\r\n+        TraceLoggingCountedUtf8String(_front.data(), write, \"buffer\"),\r\n+        TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n+        TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n+\r\n+    for (;;)\r\n+    {\r\n+        if (WriteFile(_hOutput.get(), _front.data(), write, nullptr, _overlapped))\r\n+        {\r\n+            return;\r\n+        }\r\n+\r\n+        switch (const auto gle = GetLastError())\r\n+        {\r\n+        case ERROR_BROKEN_PIPE:\r\n+            _hOutput.reset();\r\n+            SendCloseEvent();\r\n+            return;\r\n+        case ERROR_IO_PENDING:\r\n+            _overlappedPending = true;\r\n+            return;\r\n+        default:\r\n+            LOG_WIN32(gle);\r\n+            return;\r\n+        }\r\n+    }\r\n+}\r\n+\r\n+void VtIo::Writer::BackupCursor() const\r\n+{\r\n+    if (!_io->_writerRestoreCursor)\r\n+    {\r\n+        _io->_writerRestoreCursor = true;\r\n+        _io->_back.append(\"\\x1b\\x37\"); // DECSC: DEC Save Cursor (+ attributes)\r\n+    }\r\n+}\r\n+\r\n+void VtIo::Writer::WriteUTF8(std::string_view str) const\r\n+{\r\n+    _io->_back.append(str);\r\n+}\r\n+\r\n+void VtIo::Writer::WriteUTF16(std::wstring_view str) const\r\n+{\r\n+    if (str.empty())\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    const auto existingUTF8Len = _io->_back.size();\r\n+    const auto incomingUTF16Len = str.size();\r\n+\r\n+    // When converting from UTF-16 to UTF-8 the worst case is 3 bytes per UTF-16 code unit.\r\n+    const auto incomingUTF8Cap = incomingUTF16Len * 3;\r\n+    const auto totalUTF8Cap = existingUTF8Len + incomingUTF8Cap;\r\n+\r\n+    // Since WideCharToMultiByte() only supports `int` lengths, we check for an overflow past INT_MAX/3.\r\n+    // We also check for an overflow of totalUTF8Cap just to be sure.\r\n+    if (incomingUTF16Len > gsl::narrow_cast<size_t>(INT_MAX / 3) || totalUTF8Cap <= existingUTF8Len)\r\n+    {\r\n+        THROW_HR_MSG(E_INVALIDARG, \"string too large\");\r\n+    }\r\n+\r\n+    // NOTE: Throwing inside resize_and_overwrite invokes undefined behavior.\r\n+    _io->_back._Resize_and_overwrite(totalUTF8Cap, [&](char* buf, const size_t) noexcept {\r\n+        const auto len = WideCharToMultiByte(CP_UTF8, 0, str.data(), gsl::narrow_cast<int>(incomingUTF16Len), buf + existingUTF8Len, gsl::narrow_cast<int>(incomingUTF8Cap), nullptr, nullptr);\r\n+        return existingUTF8Len + std::max(0, len);\r\n+    });\r\n+}\r\n+\r\n+// When DISABLE_NEWLINE_AUTO_RETURN is not set (Bad! Don't do it!) we'll do newline translation for you.\r\n+// That's the only difference of this function from WriteUTF16: It does LF -> CRLF translation.\r\n+void VtIo::Writer::WriteUTF16TranslateCRLF(std::wstring_view str) const\r\n+{\r\n+    const auto beg = str.begin();\r\n+    const auto end = str.end();\r\n+    auto begCopy = beg;\r\n+    auto endCopy = beg;\r\n+\r\n+    // Our goal is to prepend a \\r in front of \\n that don't already have one.\r\n+    // There's no point in replacing \\n\\n\\n with \\r\\n\\r\\n\\r\\n, however. It's just fine to do \\r\\n\\n\\n.\r\n+    // After all we aren't a text file, we're a terminal, and \\r\\n and \\n are identical if we're at the first column.\r\n+    for (;;)\r\n+    {\r\n+        // To do so, we'll first find the next LF and emit the unrelated text before it.\r\n+        endCopy = std::find(endCopy, end, L'\\n');\r\n+        WriteUTF16({ begCopy, endCopy });\r\n+        begCopy = endCopy;\r\n+\r\n+        // Done? Great.\r\n+        if (begCopy == end)\r\n+        {\r\n+            break;\r\n+        }\r\n+\r\n+        // We only need to prepend a CR if the LF isn't already preceded by one.\r\n+        if (begCopy == beg || begCopy[-1] != L'\\r')\r\n+        {\r\n+            _io->_back.push_back('\\r');\r\n+        }\r\n+\r\n+        // Now extend the end of the next WriteUTF16 *past* this series of CRs and LFs.\r\n+        // We've just ensured that the LF is preceded by a CR, so we can skip all this safely.\r\n+        while (++endCopy != end && (*endCopy == L'\\n' || *endCopy == L'\\r'))\r\n+        {\r\n+        }\r\n+    }\r\n+}\r\n+\r\n+// Same as WriteUTF16, but replaces control characters with spaces.\r\n+// We don't outright remove them because that would mess up the cursor position.\r\n+// conhost traditionally assigned control chars a width of 1 when in the raw write mode.\r\n+void VtIo::Writer::WriteUTF16StripControlChars(std::wstring_view str) const\r\n+{\r\n+    auto it = str.data();\r\n+    const auto end = it + str.size();\r\n+\r\n+    // We can picture `str` as a repeated sequence of regular characters followed by control characters.\r\n+    while (it != end)\r\n+    {\r\n+        const auto begControlChars = FindActionableControlCharacter(it, end - it);\r\n+\r\n+        WriteUTF16({ it, begControlChars });\r\n+\r\n+        for (it = begControlChars; it != end && IsControlCharacter(*it); ++it)\r\n+        {\r\n+            WriteUCS2StripControlChars(*it);\r\n+        }\r\n+    }\r\n+}\r\n+\r\n+void VtIo::Writer::WriteUCS2(wchar_t ch) const\r\n+{\r\n+    char buf[4];\r\n+    size_t len = 0;\r\n+\r\n+    if (til::is_surrogate(ch))\r\n+    {\r\n+        ch = UNICODE_REPLACEMENT;\r\n+    }\r\n+\r\n+    if (ch <= 0x7f)\r\n+    {\r\n+        buf[len++] = static_cast<char>(ch);\r\n+    }\r\n+    else if (ch <= 0x7ff)\r\n+    {\r\n+        buf[len++] = static_cast<char>(0xc0 | (ch >> 6));\r\n+        buf[len++] = static_cast<char>(0x80 | (ch & 0x3f));\r\n+    }\r\n+    else\r\n+    {\r\n+        buf[len++] = static_cast<char>(0xe0 | (ch >> 12));\r\n+        buf[len++] = static_cast<char>(0x80 | ((ch >> 6) & 0x3f));\r\n+        buf[len++] = static_cast<char>(0x80 | (ch & 0x3f));\r\n+    }\r\n+\r\n+    _io->_back.append(buf, len);\r\n+}\r\n+\r\n+void VtIo::Writer::WriteUCS2StripControlChars(wchar_t ch) const\r\n+{\r\n+    if (ch < 0x20)\r\n+    {\r\n+        static constexpr wchar_t lut[] = {\r\n+            // clang-format off\r\n+            L' ', L'\u263a', L'\u263b', L'\u2665', L'\u2666', L'\u2663', L'\u2660', L'\u2022', L'\u25d8', L'\u25cb', L'\u25d9', L'\u2642', L'\u2640', L'\u266a', L'\u266b', L'\u263c',\r\n+            L'\u25ba', L'\u25c4', L'\u2195', L'\u203c', L'\u00b6', L'\u00a7', L'\u25ac', L'\u21a8', L'\u2191', L'\u2193', L'\u2192', L'\u2190', L'\u221f', L'\u2194', L'\u25b2', L'\u25bc',\r\n+            // clang-format on\r\n+        };\r\n+        ch = lut[ch];\r\n+    }\r\n+    else if (ch == 0x7F)\r\n+    {\r\n+        ch = L'\u2302';\r\n+    }\r\n+    else if (ch > 0x7F && ch < 0xA0)\r\n+    {\r\n+        ch = L'?';\r\n+    }\r\n+\r\n+    WriteUCS2(ch);\r\n+}\r\n+\r\n+// CUP: Cursor Position\r\n+void VtIo::Writer::WriteCUP(til::point position) const\r\n+{\r\n+    fmt::format_to(std::back_inserter(_io->_back), FMT_COMPILE(\"\\x1b[{};{}H\"), position.y + 1, position.x + 1);\r\n+}\r\n+\r\n+// DECTCEM: Text Cursor Enable\r\n+void VtIo::Writer::WriteDECTCEM(bool enabled) const\r\n+{\r\n+    char buf[] = \"\\x1b[?25h\";\r\n+    buf[std::size(buf) - 2] = enabled ? 'h' : 'l';\r\n+    _io->_back.append(&buf[0], std::size(buf) - 1);\r\n+}\r\n+\r\n+// SGR 1006: SGR Extended Mouse Mode\r\n+void VtIo::Writer::WriteSGR1006(bool enabled) const\r\n+{\r\n+    char buf[] = \"\\x1b[?1003;1006h\";\r\n+    buf[std::size(buf) - 2] = enabled ? 'h' : 'l';\r\n+    _io->_back.append(&buf[0], std::size(buf) - 1);\r\n+}\r\n+\r\n+// DECAWM: Autowrap Mode\r\n+void VtIo::Writer::WriteDECAWM(bool enabled) const\r\n+{\r\n+    char buf[] = \"\\x1b[?7h\";\r\n+    buf[std::size(buf) - 2] = enabled ? 'h' : 'l';\r\n+    _io->_back.append(&buf[0], std::size(buf) - 1);\r\n+}\r\n+\r\n+// ASB: Alternate Screen Buffer\r\n+void VtIo::Writer::WriteASB(bool enabled) const\r\n+{\r\n+    char buf[] = \"\\x1b[?1049h\";\r\n+    buf[std::size(buf) - 2] = enabled ? 'h' : 'l';\r\n+    _io->_back.append(&buf[0], std::size(buf) - 1);\r\n+}\r\n+\r\n+void VtIo::Writer::WriteAttributes(const TextAttribute& attributes) const\r\n+{\r\n+    FormatAttributes(_io->_back, attributes);\r\n+}\r\n+\r\n+void VtIo::Writer::WriteInfos(til::point target, std::span<const CHAR_INFO> infos) const\r\n+{\r\n+    const auto beg = infos.begin();\r\n+    const auto end = infos.end();\r\n+    const auto last = end - 1;\r\n+    WORD attributes = 0xffff;\r\n+\r\n+    WriteCUP(target);\r\n+\r\n+    for (auto it = beg; it != end; ++it)\r\n+    {\r\n+        const auto& ci = *it;\r\n+        auto ch = ci.Char.UnicodeChar;\r\n+        auto wide = WI_IsAnyFlagSet(ci.Attributes, COMMON_LVB_LEADING_BYTE | COMMON_LVB_TRAILING_BYTE);\r\n+\r\n+        if (wide)\r\n+        {\r\n+            if (WI_IsAnyFlagSet(ci.Attributes, COMMON_LVB_LEADING_BYTE))\r\n+            {\r\n+                if (it == last)\r\n+                {\r\n+                    // The leading half of a wide glyph won't fit into the last remaining column.\r\n+                    // --> Replace it with a space.\r\n+                    ch = L' ';\r\n+                    wide = false;\r\n+                }\r\n+            }\r\n+            else\r\n+            {\r\n+                if (it == beg)\r\n+                {\r\n+                    // The trailing half of a wide glyph won't fit into the first column. It's incomplete.\r\n+                    // --> Replace it with a space.\r\n+                    ch = L' ';\r\n+                    wide = false;\r\n+                }\r\n+                else\r\n+                {\r\n+                    // Trailing halves of glyphs are ignored within the run. We only emit the leading half.\r\n+                    continue;\r\n+                }\r\n+            }\r\n+        }\r\n+\r\n+        if (attributes != ci.Attributes)\r\n+        {\r\n+            attributes = ci.Attributes;\r\n+            WriteAttributes(TextAttribute{ attributes });\r\n+        }\r\n+\r\n+        int repeat = 1;\r\n+        if (wide && (til::is_surrogate(ch) || IsControlCharacter(ch)))\r\n+        {\r\n+            // Control characters, U+FFFD, etc. are narrow characters, so if the caller\r\n+            // asked for a wide glyph we need to repeat the replacement character twice.\r\n+            repeat++;\r\n+        }\r\n+\r\n+        do\r\n+        {\r\n+            WriteUCS2StripControlChars(ch);\r\n+        } while (--repeat);\r\n+    }\r\n+}\r\ndiff --git a/src/host/VtIo.hpp b/src/host/VtIo.hpp\nindex e56566d2e3b..a2b23de33aa 100644\n--- a/src/host/VtIo.hpp\n+++ b/src/host/VtIo.hpp\n@@ -3,77 +3,101 @@\n \r\n #pragma once\r\n \r\n-#include \"../renderer/vt/vtrenderer.hpp\"\r\n #include \"VtInputThread.hpp\"\r\n #include \"PtySignalInputThread.hpp\"\r\n \r\n class ConsoleArguments;\r\n \r\n-namespace Microsoft::Console::Render\r\n-{\r\n-    class VtEngine;\r\n-}\r\n-\r\n namespace Microsoft::Console::VirtualTerminal\r\n {\r\n     class VtIo\r\n     {\r\n     public:\r\n+        struct Writer\r\n+        {\r\n+            Writer() = default;\r\n+            Writer(VtIo* io) noexcept;\r\n+\r\n+            ~Writer() noexcept;\r\n+\r\n+            Writer(const Writer&) = delete;\r\n+            Writer& operator=(const Writer&) = delete;\r\n+            Writer(Writer&& other) noexcept;\r\n+            Writer& operator=(Writer&& other) noexcept;\r\n+\r\n+            explicit operator bool() const noexcept;\r\n+\r\n+            void Submit();\r\n+\r\n+            void BackupCursor() const;\r\n+            void WriteUTF8(std::string_view str) const;\r\n+            void WriteUTF16(std::wstring_view str) const;\r\n+            void WriteUTF16TranslateCRLF(std::wstring_view str) const;\r\n+            void WriteUTF16StripControlChars(std::wstring_view str) const;\r\n+            void WriteUCS2(wchar_t ch) const;\r\n+            void WriteUCS2StripControlChars(wchar_t ch) const;\r\n+            void WriteCUP(til::point position) const;\r\n+            void WriteDECTCEM(bool enabled) const;\r\n+            void WriteSGR1006(bool enabled) const;\r\n+            void WriteDECAWM(bool enabled) const;\r\n+            void WriteASB(bool enabled) const;\r\n+            void WriteAttributes(const TextAttribute& attributes) const;\r\n+            void WriteInfos(til::point target, std::span<const CHAR_INFO> infos) const;\r\n+\r\n+        private:\r\n+            VtIo* _io = nullptr;\r\n+        };\r\n+\r\n+        friend struct Writer;\r\n+\r\n         static void FormatAttributes(std::string& target, const TextAttribute& attributes);\r\n         static void FormatAttributes(std::wstring& target, const TextAttribute& attributes);\r\n \r\n-        VtIo();\r\n-\r\n         [[nodiscard]] HRESULT Initialize(const ConsoleArguments* const pArgs);\r\n-\r\n         [[nodiscard]] HRESULT CreateAndStartSignalThread() noexcept;\r\n         [[nodiscard]] HRESULT CreateIoHandlers() noexcept;\r\n \r\n         bool IsUsingVt() const;\r\n-\r\n         [[nodiscard]] HRESULT StartIfNeeded();\r\n \r\n         [[nodiscard]] HRESULT SuppressResizeRepaint();\r\n         [[nodiscard]] HRESULT SetCursorPosition(const til::point coordCursor);\r\n         [[nodiscard]] HRESULT SwitchScreenBuffer(const bool useAltBuffer);\r\n         void SendCloseEvent();\r\n-\r\n-        void CloseInput();\r\n-        void CloseOutput();\r\n-\r\n-        void CorkRenderer(bool corked) const noexcept;\r\n-\r\n-#ifdef UNIT_TESTING\r\n-        void EnableConptyModeForTests(std::unique_ptr<Microsoft::Console::Render::VtEngine> vtRenderEngine, const bool resizeQuirk = false);\r\n-#endif\r\n-\r\n-        bool IsResizeQuirkEnabled() const;\r\n-\r\n-        [[nodiscard]] HRESULT ManuallyClearScrollback() const noexcept;\r\n-        [[nodiscard]] HRESULT RequestMouseMode(bool enable) const noexcept;\r\n-\r\n         void CreatePseudoWindow();\r\n-        void SetWindowVisibility(bool showOrHide) noexcept;\r\n+        Writer GetWriter() noexcept;\r\n \r\n     private:\r\n+        [[nodiscard]] HRESULT _Initialize(const HANDLE InHandle, const HANDLE OutHandle, _In_opt_ const HANDLE SignalHandle);\r\n+\r\n+        void _uncork();\r\n+        void _flushNow();\r\n+\r\n         // After CreateIoHandlers is called, these will be invalid.\r\n         wil::unique_hfile _hInput;\r\n         wil::unique_hfile _hOutput;\r\n         // After CreateAndStartSignalThread is called, this will be invalid.\r\n         wil::unique_hfile _hSignal;\r\n \r\n-        bool _initialized;\r\n-\r\n-        bool _lookingForCursorPosition;\r\n-\r\n-        bool _resizeQuirk{ false };\r\n-        bool _closeEventSent{ false };\r\n-\r\n-        std::unique_ptr<Microsoft::Console::Render::VtEngine> _pVtRenderEngine;\r\n         std::unique_ptr<Microsoft::Console::VtInputThread> _pVtInputThread;\r\n         std::unique_ptr<Microsoft::Console::PtySignalInputThread> _pPtySignalInputThread;\r\n \r\n-        [[nodiscard]] HRESULT _Initialize(const HANDLE InHandle, const HANDLE OutHandle, _In_opt_ const HANDLE SignalHandle);\r\n+        // We use two buffers: A front and a back buffer. The front buffer is the one we're currently\r\n+        // sending to the terminal (it's being \"presented\" = it's on the \"front\" & \"visible\").\r\n+        // The back buffer is the one we're concurrently writing to.\r\n+        std::string _front;\r\n+        std::string _back;\r\n+        OVERLAPPED* _overlapped = nullptr;\r\n+        OVERLAPPED _overlappedBuf{};\r\n+        wil::unique_event _overlappedEvent;\r\n+        bool _overlappedPending = false;\r\n+        bool _writerRestoreCursor = false;\r\n+        bool _writerTainted = false;\r\n+\r\n+        bool _initialized = false;\r\n+        bool _lookingForCursorPosition = false;\r\n+        bool _closeEventSent = false;\r\n+        int _corked = 0;\r\n \r\n #ifdef UNIT_TESTING\r\n         friend class VtIoTests;\r\ndiff --git a/src/host/_output.cpp b/src/host/_output.cpp\nindex 063091c1708..94272c9090a 100644\n--- a/src/host/_output.cpp\n+++ b/src/host/_output.cpp\n@@ -74,6 +74,7 @@ static FillConsoleResult FillConsoleImpl(SCREEN_INFORMATION& screenInfo, FillCon\n     LockConsole();\r\n     const auto unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n \r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n     auto& screenBuffer = screenInfo.GetActiveBuffer();\r\n     const auto bufferSize = screenBuffer.GetBufferSize();\r\n     FillConsoleResult result;\r\n@@ -83,6 +84,122 @@ static FillConsoleResult FillConsoleImpl(SCREEN_INFORMATION& screenInfo, FillCon\n         return {};\r\n     }\r\n \r\n+    if (auto writer = gci.GetVtWriterForBuffer(&screenInfo))\r\n+    {\r\n+        writer.BackupCursor();\r\n+\r\n+        const auto h = bufferSize.Height();\r\n+        const auto w = bufferSize.Width();\r\n+        auto y = startingCoordinate.y;\r\n+        auto input = static_cast<const uint16_t*>(data);\r\n+        size_t inputPos = 0;\r\n+        til::small_vector<CHAR_INFO, 1024> infoBuffer;\r\n+        Viewport unused;\r\n+\r\n+        infoBuffer.resize(gsl::narrow_cast<size_t>(w));\r\n+\r\n+        while (y < h && inputPos < lengthToWrite)\r\n+        {\r\n+            const auto beg = y == startingCoordinate.y ? startingCoordinate.x : 0;\r\n+            const auto columnsAvailable = w - beg;\r\n+            til::CoordType columns = 0;\r\n+\r\n+            const auto readViewport = Viewport::FromInclusive({ beg, y, w - 1, y });\r\n+            THROW_IF_FAILED(ReadConsoleOutputWImplHelper(screenInfo, infoBuffer, readViewport, unused));\r\n+\r\n+            switch (mode)\r\n+            {\r\n+            case FillConsoleMode::WriteAttribute:\r\n+                for (; columns < columnsAvailable && inputPos < lengthToWrite; ++columns, ++inputPos)\r\n+                {\r\n+                    infoBuffer[columns].Attributes = input[inputPos];\r\n+                }\r\n+                break;\r\n+            case FillConsoleMode::FillAttribute:\r\n+                for (const auto attr = input[0]; columns < columnsAvailable && inputPos < lengthToWrite; ++columns, ++inputPos)\r\n+                {\r\n+                    infoBuffer[columns].Attributes = attr;\r\n+                }\r\n+                break;\r\n+            case FillConsoleMode::WriteCharacter:\r\n+                for (; columns < columnsAvailable && inputPos < lengthToWrite; ++inputPos)\r\n+                {\r\n+                    const auto ch = input[inputPos];\r\n+                    if (ch >= 0x80 && IsGlyphFullWidth(ch))\r\n+                    {\r\n+                        // If the wide glyph doesn't fit into the last column, pad it with whitespace.\r\n+                        if ((columns + 1) >= columnsAvailable)\r\n+                        {\r\n+                            auto& lead = infoBuffer[columns++];\r\n+                            lead.Char.UnicodeChar = L' ';\r\n+                            lead.Attributes = lead.Attributes & ~(COMMON_LVB_LEADING_BYTE | COMMON_LVB_TRAILING_BYTE);\r\n+                            break;\r\n+                        }\r\n+\r\n+                        auto& lead = infoBuffer[columns++];\r\n+                        lead.Char.UnicodeChar = ch;\r\n+                        lead.Attributes = lead.Attributes & ~COMMON_LVB_TRAILING_BYTE | COMMON_LVB_LEADING_BYTE;\r\n+\r\n+                        auto& trail = infoBuffer[columns++];\r\n+                        trail.Char.UnicodeChar = ch;\r\n+                        trail.Attributes = trail.Attributes & ~COMMON_LVB_LEADING_BYTE | COMMON_LVB_TRAILING_BYTE;\r\n+                    }\r\n+                    else\r\n+                    {\r\n+                        auto& lead = infoBuffer[columns++];\r\n+                        lead.Char.UnicodeChar = ch;\r\n+                        lead.Attributes = lead.Attributes & ~(COMMON_LVB_LEADING_BYTE | COMMON_LVB_TRAILING_BYTE);\r\n+                    }\r\n+                }\r\n+                break;\r\n+            case FillConsoleMode::FillCharacter:\r\n+                // Identical to WriteCharacter above, but with the if() and for() swapped.\r\n+                if (const auto ch = input[0]; ch >= 0x80 && IsGlyphFullWidth(ch))\r\n+                {\r\n+                    for (; columns < columnsAvailable && inputPos < lengthToWrite; ++inputPos)\r\n+                    {\r\n+                        // If the wide glyph doesn't fit into the last column, pad it with whitespace.\r\n+                        if ((columns + 1) >= columnsAvailable)\r\n+                        {\r\n+                            auto& lead = infoBuffer[columns++];\r\n+                            lead.Char.UnicodeChar = L' ';\r\n+                            lead.Attributes = lead.Attributes & ~(COMMON_LVB_LEADING_BYTE | COMMON_LVB_TRAILING_BYTE);\r\n+                            break;\r\n+                        }\r\n+\r\n+                        auto& lead = infoBuffer[columns++];\r\n+                        lead.Char.UnicodeChar = ch;\r\n+                        lead.Attributes = lead.Attributes & ~COMMON_LVB_TRAILING_BYTE | COMMON_LVB_LEADING_BYTE;\r\n+\r\n+                        auto& trail = infoBuffer[columns++];\r\n+                        trail.Char.UnicodeChar = ch;\r\n+                        trail.Attributes = trail.Attributes & ~COMMON_LVB_LEADING_BYTE | COMMON_LVB_TRAILING_BYTE;\r\n+                    }\r\n+                }\r\n+                else\r\n+                {\r\n+                    for (; columns < columnsAvailable && inputPos < lengthToWrite; ++inputPos)\r\n+                    {\r\n+                        auto& lead = infoBuffer[columns++];\r\n+                        lead.Char.UnicodeChar = ch;\r\n+                        lead.Attributes = lead.Attributes & ~(COMMON_LVB_LEADING_BYTE | COMMON_LVB_TRAILING_BYTE);\r\n+                    }\r\n+                }\r\n+                break;\r\n+            }\r\n+\r\n+            const auto writeViewport = Viewport::FromInclusive({ beg, y, beg + columns - 1, y });\r\n+            THROW_IF_FAILED(WriteConsoleOutputWImplHelper(screenInfo, infoBuffer, w, writeViewport, unused));\r\n+\r\n+            y += 1;\r\n+            result.cellsModified += columns;\r\n+        }\r\n+\r\n+        result.lengthRead = inputPos;\r\n+\r\n+        writer.Submit();\r\n+    }\r\n+    else\r\n     {\r\n         // Technically we could always pass `data` as `uint16_t*`, because `wchar_t` is guaranteed to be 16 bits large.\r\n         // However, OutputCellIterator is terrifyingly unsafe code and so we don't do that.\r\n@@ -261,13 +378,37 @@ static FillConsoleResult FillConsoleImpl(SCREEN_INFORMATION& screenInfo, FillCon\n                                                                   size_t& cellsModified,\r\n                                                                   const bool enablePowershellShim) noexcept\r\n {\r\n-    UNREFERENCED_PARAMETER(enablePowershellShim);\r\n-\r\n     try\r\n     {\r\n         LockConsole();\r\n         const auto unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n \r\n+        // GH#3126 - This is a shim for powershell's `Clear-Host` function. In\r\n+        // the vintage console, `Clear-Host` is supposed to clear the entire\r\n+        // buffer. In conpty however, there's no difference between the viewport\r\n+        // and the entirety of the buffer. We're going to see if this API call\r\n+        // exactly matched the way we expect powershell to call it. If it does,\r\n+        // then let's manually emit a ^[[3J to the connected terminal, so that\r\n+        // their entire buffer will be cleared as well.\r\n+        if (enablePowershellShim)\r\n+        {\r\n+            auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+            if (const auto writer = gci.GetVtWriterForBuffer(&OutContext))\r\n+            {\r\n+                const auto currentBufferDimensions{ OutContext.GetBufferSize().Dimensions() };\r\n+                const auto wroteWholeBuffer = lengthToWrite == (currentBufferDimensions.area<size_t>());\r\n+                const auto startedAtOrigin = startingCoordinate == til::point{ 0, 0 };\r\n+                const auto wroteSpaces = attribute == (FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED);\r\n+\r\n+                if (wroteWholeBuffer && startedAtOrigin && wroteSpaces)\r\n+                {\r\n+                    // PowerShell has previously called FillConsoleOutputCharacterW() which triggered a call to WriteClearScreen().\r\n+                    cellsModified = lengthToWrite;\r\n+                    return S_OK;\r\n+                }\r\n+            }\r\n+        }\r\n+\r\n         cellsModified = FillConsoleImpl(OutContext, FillConsoleMode::FillAttribute, &attribute, lengthToWrite, startingCoordinate).cellsModified;\r\n         return S_OK;\r\n     }\r\n@@ -299,8 +440,6 @@ static FillConsoleResult FillConsoleImpl(SCREEN_INFORMATION& screenInfo, FillCon\n         LockConsole();\r\n         const auto unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n \r\n-        cellsModified = FillConsoleImpl(OutContext, FillConsoleMode::FillCharacter, &character, lengthToWrite, startingCoordinate).lengthRead;\r\n-\r\n         // GH#3126 - This is a shim for powershell's `Clear-Host` function. In\r\n         // the vintage console, `Clear-Host` is supposed to clear the entire\r\n         // buffer. In conpty however, there's no difference between the viewport\r\n@@ -311,7 +450,7 @@ static FillConsoleResult FillConsoleImpl(SCREEN_INFORMATION& screenInfo, FillCon\n         if (enablePowershellShim)\r\n         {\r\n             auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-            if (gci.IsInVtIoMode())\r\n+            if (auto writer = gci.GetVtWriterForBuffer(&OutContext))\r\n             {\r\n                 const auto currentBufferDimensions{ OutContext.GetBufferSize().Dimensions() };\r\n                 const auto wroteWholeBuffer = lengthToWrite == (currentBufferDimensions.area<size_t>());\r\n@@ -320,14 +459,15 @@ static FillConsoleResult FillConsoleImpl(SCREEN_INFORMATION& screenInfo, FillCon\n \r\n                 if (wroteWholeBuffer && startedAtOrigin && wroteSpaces)\r\n                 {\r\n-                    // It's important that we flush the renderer at this point so we don't\r\n-                    // have any pending output rendered after the scrollback is cleared.\r\n-                    ServiceLocator::LocateGlobals().pRender->TriggerFlush(false);\r\n-                    return gci.GetVtIo()->ManuallyClearScrollback();\r\n+                    WriteClearScreen(OutContext);\r\n+                    writer.Submit();\r\n+                    cellsModified = lengthToWrite;\r\n+                    return S_OK;\r\n                 }\r\n             }\r\n         }\r\n \r\n+        cellsModified = FillConsoleImpl(OutContext, FillConsoleMode::FillCharacter, &character, lengthToWrite, startingCoordinate).lengthRead;\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\ndiff --git a/src/host/_stream.cpp b/src/host/_stream.cpp\nindex 5679557ea84..9c3d3378a80 100644\n--- a/src/host/_stream.cpp\n+++ b/src/host/_stream.cpp\n@@ -14,6 +14,7 @@\n #include \"dbcs.h\"\r\n #include \"handle.h\"\r\n #include \"misc.h\"\r\n+#include \"VtIo.hpp\"\r\n \r\n #include \"../types/inc/convert.hpp\"\r\n #include \"../types/inc/GlyphWidth.hpp\"\r\n@@ -21,12 +22,14 @@\n \r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n \r\n-#pragma hdrstop\r\n using namespace Microsoft::Console::Types;\r\n+using namespace Microsoft::Console::VirtualTerminal;\r\n using Microsoft::Console::Interactivity::ServiceLocator;\r\n-using Microsoft::Console::VirtualTerminal::StateMachine;\r\n-// Used by WriteCharsLegacy.\r\n-#define IS_GLYPH_CHAR(wch) (((wch) >= L' ') && ((wch) != 0x007F))\r\n+\r\n+constexpr bool controlCharPredicate(wchar_t wch)\r\n+{\r\n+    return wch < L' ' || wch == 0x007F;\r\n+}\r\n \r\n // Routine Description:\r\n // - This routine updates the cursor position.  Its input is the non-special\r\n@@ -109,11 +112,12 @@ static void AdjustCursorPosition(SCREEN_INFORMATION& screenInfo, _In_ til::point\n }\r\n \r\n // As the name implies, this writes text without processing its control characters.\r\n-void _writeCharsLegacyUnprocessed(SCREEN_INFORMATION& screenInfo, const std::wstring_view& text, til::CoordType* psScrollY)\r\n+static bool _writeCharsLegacyUnprocessed(SCREEN_INFORMATION& screenInfo, const std::wstring_view& text, til::CoordType* psScrollY)\r\n {\r\n     const auto wrapAtEOL = WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT);\r\n     const auto hasAccessibilityEventing = screenInfo.HasAccessibilityEventing();\r\n     auto& textBuffer = screenInfo.GetTextBuffer();\r\n+    bool wrapped = false;\r\n \r\n     RowWriteState state{\r\n         .text = text,\r\n@@ -127,8 +131,9 @@ void _writeCharsLegacyUnprocessed(SCREEN_INFORMATION& screenInfo, const std::wst\n         state.columnBegin = cursorPosition.x;\r\n         textBuffer.Replace(cursorPosition.y, textBuffer.GetCurrentAttributes(), state);\r\n         cursorPosition.x = state.columnEnd;\r\n+        wrapped = wrapAtEOL && state.columnEnd >= state.columnLimit;\r\n \r\n-        if (wrapAtEOL && state.columnEnd >= state.columnLimit)\r\n+        if (wrapped)\r\n         {\r\n             textBuffer.SetWrapForced(cursorPosition.y, true);\r\n         }\r\n@@ -140,6 +145,8 @@ void _writeCharsLegacyUnprocessed(SCREEN_INFORMATION& screenInfo, const std::wst\n \r\n         AdjustCursorPosition(screenInfo, cursorPosition, psScrollY);\r\n     }\r\n+\r\n+    return wrapped;\r\n }\r\n \r\n // This routine writes a string to the screen while handling control characters.\r\n@@ -153,15 +160,16 @@ void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& t\n     const auto width = textBuffer.GetSize().Width();\r\n     auto& cursor = textBuffer.GetCursor();\r\n     const auto wrapAtEOL = WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT);\r\n-    auto it = text.begin();\r\n+    const auto beg = text.begin();\r\n     const auto end = text.end();\r\n+    auto it = beg;\r\n+\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    auto writer = gci.GetVtWriterForBuffer(&screenInfo);\r\n \r\n-    // In VT mode, when you have a 120-column terminal you can write 120 columns without the cursor wrapping.\r\n-    // Whenever the cursor is in that 120th column IsDelayedEOLWrap() will return true. I'm not sure why the VT parts\r\n-    // of the code base store this as a boolean. It's also unclear why we handle this here. The intention is likely\r\n-    // so that when we exit VT mode and receive a write a potentially stored delayed wrap would still be handled.\r\n-    // The way this code does it however isn't correct since it handles it like the old console APIs would and\r\n-    // so writing a newline while being delay wrapped will print 2 newlines.\r\n+    // If we enter this if condition, then someone wrote text in VT mode and now switched to non-VT mode.\r\n+    // Since the Console APIs don't support delayed EOL wrapping, we need to first put the cursor back\r\n+    // to a position that the Console APIs expect (= not delayed).\r\n     if (cursor.IsDelayedEOLWrap() && wrapAtEOL)\r\n     {\r\n         auto pos = cursor.GetPosition();\r\n@@ -172,6 +180,11 @@ void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& t\n             pos.x = 0;\r\n             pos.y++;\r\n             AdjustCursorPosition(screenInfo, pos, psScrollY);\r\n+\r\n+            if (writer)\r\n+            {\r\n+                writer.WriteUTF8(\"\\r\\n\");\r\n+            }\r\n         }\r\n     }\r\n \r\n@@ -179,79 +192,141 @@ void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& t\n     // If it's not set, we can just straight up give everything to WriteCharsLegacyUnprocessed.\r\n     if (WI_IsFlagClear(screenInfo.OutputMode, ENABLE_PROCESSED_OUTPUT))\r\n     {\r\n-        _writeCharsLegacyUnprocessed(screenInfo, { it, end }, psScrollY);\r\n-        it = end;\r\n+        const auto lastCharWrapped = _writeCharsLegacyUnprocessed(screenInfo, text, psScrollY);\r\n+\r\n+        if (writer)\r\n+        {\r\n+            // We're asked to produce VT output, but also to behave as if these control characters aren't control characters.\r\n+            // So, to make it work, we simply replace all the control characters with whitespace.\r\n+            writer.WriteUTF16StripControlChars(text);\r\n+            if (lastCharWrapped)\r\n+            {\r\n+                writer.WriteUTF8(\"\\r\\n\");\r\n+            }\r\n+            writer.Submit();\r\n+        }\r\n+\r\n+        return;\r\n     }\r\n \r\n     while (it != end)\r\n     {\r\n-        const auto nextControlChar = std::find_if(it, end, [](const auto& wch) { return !IS_GLYPH_CHAR(wch); });\r\n+        const auto nextControlChar = std::find_if(it, end, controlCharPredicate);\r\n         if (nextControlChar != it)\r\n         {\r\n-            _writeCharsLegacyUnprocessed(screenInfo, { it, nextControlChar }, psScrollY);\r\n+            const std::wstring_view chunk{ it, nextControlChar };\r\n+            const auto lastCharWrapped = _writeCharsLegacyUnprocessed(screenInfo, chunk, psScrollY);\r\n             it = nextControlChar;\r\n+\r\n+            if (writer)\r\n+            {\r\n+                writer.WriteUTF16(chunk);\r\n+                if (lastCharWrapped)\r\n+                {\r\n+                    writer.WriteUTF8(\"\\r\\n\");\r\n+                }\r\n+            }\r\n         }\r\n \r\n-        for (; it != end && !IS_GLYPH_CHAR(*it); ++it)\r\n+        if (it == end)\r\n         {\r\n-            switch (*it)\r\n+            break;\r\n+        }\r\n+\r\n+        do\r\n+        {\r\n+            auto wch = *it;\r\n+            auto lastCharWrapped = false;\r\n+\r\n+            switch (wch)\r\n             {\r\n             case UNICODE_NULL:\r\n-                _writeCharsLegacyUnprocessed(screenInfo, { &tabSpaces[0], 1 }, psScrollY);\r\n-                continue;\r\n+            {\r\n+                lastCharWrapped = _writeCharsLegacyUnprocessed(screenInfo, { &tabSpaces[0], 1 }, psScrollY);\r\n+                wch = L' ';\r\n+                break;\r\n+            }\r\n             case UNICODE_BELL:\r\n+            {\r\n                 std::ignore = screenInfo.SendNotifyBeep();\r\n-                continue;\r\n+                break;\r\n+            }\r\n             case UNICODE_BACKSPACE:\r\n             {\r\n                 auto pos = cursor.GetPosition();\r\n                 pos.x = textBuffer.GetRowByOffset(pos.y).NavigateToPrevious(pos.x);\r\n                 AdjustCursorPosition(screenInfo, pos, psScrollY);\r\n-                continue;\r\n+                break;\r\n             }\r\n             case UNICODE_TAB:\r\n             {\r\n                 const auto pos = cursor.GetPosition();\r\n                 const auto remaining = width - pos.x;\r\n                 const auto tabCount = gsl::narrow_cast<size_t>(std::min(remaining, 8 - (pos.x & 7)));\r\n-                _writeCharsLegacyUnprocessed(screenInfo, { &tabSpaces[0], tabCount }, psScrollY);\r\n-                continue;\r\n+                lastCharWrapped = _writeCharsLegacyUnprocessed(screenInfo, { &tabSpaces[0], tabCount }, psScrollY);\r\n+                break;\r\n             }\r\n             case UNICODE_LINEFEED:\r\n             {\r\n                 auto pos = cursor.GetPosition();\r\n-                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN))\r\n+                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN) && pos.x != 0)\r\n                 {\r\n                     pos.x = 0;\r\n+                    // This causes the current \\n to be replaced with a \\r\\n in the ConPTY VT output.\r\n+                    wch = 0;\r\n+                    lastCharWrapped = true;\r\n                 }\r\n \r\n                 textBuffer.GetMutableRowByOffset(pos.y).SetWrapForced(false);\r\n                 pos.y = pos.y + 1;\r\n                 AdjustCursorPosition(screenInfo, pos, psScrollY);\r\n-                continue;\r\n+                break;\r\n             }\r\n             case UNICODE_CARRIAGERETURN:\r\n             {\r\n                 auto pos = cursor.GetPosition();\r\n                 pos.x = 0;\r\n                 AdjustCursorPosition(screenInfo, pos, psScrollY);\r\n-                continue;\r\n+                break;\r\n             }\r\n             default:\r\n+            {\r\n+                // As a special favor to incompetent apps that attempt to display control chars,\r\n+                // convert to corresponding OEM Glyph Chars\r\n+                const auto cp = ServiceLocator::LocateGlobals().getConsoleInformation().OutputCP;\r\n+                const auto ch = gsl::narrow_cast<char>(wch);\r\n+                const auto result = MultiByteToWideChar(cp, MB_USEGLYPHCHARS, &ch, 1, &wch, 1);\r\n+                if (result != 1)\r\n+                {\r\n+                    wch = 0;\r\n+                }\r\n+                if (wch)\r\n+                {\r\n+                    lastCharWrapped = _writeCharsLegacyUnprocessed(screenInfo, { &wch, 1 }, psScrollY);\r\n+                }\r\n                 break;\r\n             }\r\n+            }\r\n \r\n-            // As a special favor to incompetent apps that attempt to display control chars,\r\n-            // convert to corresponding OEM Glyph Chars\r\n-            const auto cp = ServiceLocator::LocateGlobals().getConsoleInformation().OutputCP;\r\n-            const auto ch = gsl::narrow_cast<char>(*it);\r\n-            wchar_t wch = 0;\r\n-            const auto result = MultiByteToWideChar(cp, MB_USEGLYPHCHARS, &ch, 1, &wch, 1);\r\n-            if (result == 1)\r\n+            if (writer)\r\n             {\r\n-                _writeCharsLegacyUnprocessed(screenInfo, { &wch, 1 }, psScrollY);\r\n+                if (wch)\r\n+                {\r\n+                    writer.WriteUCS2(wch);\r\n+                }\r\n+                if (lastCharWrapped)\r\n+                {\r\n+                    writer.WriteUTF8(\"\\r\\n\");\r\n+                }\r\n             }\r\n-        }\r\n+\r\n+            ++it;\r\n+        } while (it != end && controlCharPredicate(*it));\r\n+    }\r\n+\r\n+    if (writer)\r\n+    {\r\n+        writer.Submit();\r\n     }\r\n }\r\n \r\n@@ -259,7 +334,58 @@ void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& t\n // This wrapper around StateMachine exists so that we can add the necessary ConPTY transformations.\r\n void WriteCharsVT(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str)\r\n {\r\n-    screenInfo.GetStateMachine().ProcessString(str);\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    auto& stateMachine = screenInfo.GetStateMachine();\r\n+    // When switch between the main and alt-buffer SCREEN_INFORMATION::GetActiveBuffer()\r\n+    // may change, so get the VtIo reference now, just in case.\r\n+    auto writer = gci.GetVtWriterForBuffer(&screenInfo);\r\n+\r\n+    stateMachine.ProcessString(str);\r\n+\r\n+    if (writer)\r\n+    {\r\n+        const auto& injections = stateMachine.GetInjections();\r\n+        size_t offset = 0;\r\n+\r\n+        const auto write = [&](size_t beg, size_t end) {\r\n+            const auto chunk = til::safe_slice_abs(str, beg, end);\r\n+            if (WI_IsFlagSet(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN))\r\n+            {\r\n+                writer.WriteUTF16(chunk);\r\n+            }\r\n+            else\r\n+            {\r\n+                writer.WriteUTF16TranslateCRLF(chunk);\r\n+            }\r\n+        };\r\n+\r\n+        for (const auto& injection : injections)\r\n+        {\r\n+            write(offset, injection.offset);\r\n+            offset = injection.offset;\r\n+\r\n+            static constexpr std::array<std::string_view, 2> mapping{ {\r\n+                { \"\\x1b[?1004h\\x1b[?9001h\" }, // RIS: Focus Event Mode + Win32 Input Mode\r\n+                { \"\\033[?1004h\" } // DECSET_FOCUS: Focus Event Mode\r\n+            } };\r\n+\r\n+            writer.WriteUTF8(mapping[static_cast<size_t>(injection.type)]);\r\n+        }\r\n+\r\n+        write(offset, std::wstring_view::npos);\r\n+        writer.Submit();\r\n+    }\r\n+}\r\n+\r\n+// Erases all contents of the given screenInfo, including the current screen and scrollback.\r\n+void WriteClearScreen(SCREEN_INFORMATION& screenInfo)\r\n+{\r\n+    WriteCharsVT(\r\n+        screenInfo,\r\n+        L\"\\x1b[H\" // CUP to home\r\n+        L\"\\x1b[2J\" // Erase in Display: clear the screen\r\n+        L\"\\x1b[3J\" // Erase in Display: clear the scrollback buffer\r\n+    );\r\n }\r\n \r\n // Routine Description:\r\n@@ -284,7 +410,7 @@ void WriteCharsVT(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str)\n                                       std::unique_ptr<WriteData>& waiter)\r\n try\r\n {\r\n-    const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n     if (WI_IsAnyFlagSet(gci.Flags, (CONSOLE_SUSPENDED | CONSOLE_SELECTING | CONSOLE_SCROLLBAR_TRACKING)))\r\n     {\r\n         waiter = std::make_unique<WriteData>(screenInfo,\r\n@@ -295,25 +421,16 @@ try\n         return CONSOLE_STATUS_WAIT;\r\n     }\r\n \r\n-    const auto vtIo = ServiceLocator::LocateGlobals().getConsoleInformation().GetVtIo();\r\n     const auto restoreVtQuirk = wil::scope_exit([&]() {\r\n         if (requiresVtQuirk)\r\n         {\r\n             screenInfo.ResetIgnoreLegacyEquivalentVTAttributes();\r\n         }\r\n-        if (vtIo->IsUsingVt())\r\n-        {\r\n-            vtIo->CorkRenderer(false);\r\n-        }\r\n     });\r\n     if (requiresVtQuirk)\r\n     {\r\n         screenInfo.SetIgnoreLegacyEquivalentVTAttributes();\r\n     }\r\n-    if (vtIo->IsUsingVt())\r\n-    {\r\n-        vtIo->CorkRenderer(true);\r\n-    }\r\n \r\n     const std::wstring_view str{ pwchBuffer, *pcbBuffer / sizeof(WCHAR) };\r\n \r\n@@ -323,7 +440,7 @@ try\n     }\r\n     else\r\n     {\r\n-        screenInfo.GetStateMachine().ProcessString(str);\r\n+        WriteCharsVT(screenInfo, str);\r\n     }\r\n \r\n     return STATUS_SUCCESS;\r\ndiff --git a/src/host/_stream.h b/src/host/_stream.h\nindex 3897abf22fb..351b9173018 100644\n--- a/src/host/_stream.h\n+++ b/src/host/_stream.h\n@@ -21,6 +21,7 @@ Revision History:\n \r\n void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str, til::CoordType* psScrollY);\r\n void WriteCharsVT(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str);\r\n+void WriteClearScreen(SCREEN_INFORMATION& screenInfo);\r\n \r\n // NOTE: console lock must be held when calling this routine\r\n // String has been translated to unicode at this point.\r\ndiff --git a/src/host/consoleInformation.cpp b/src/host/consoleInformation.cpp\nindex 12e8c5e5b55..3051e00a153 100644\n--- a/src/host/consoleInformation.cpp\n+++ b/src/host/consoleInformation.cpp\n@@ -118,12 +118,22 @@ ULONG CONSOLE_INFORMATION::GetCSRecursionCount() const noexcept\n     return Status;\r\n }\r\n \r\n-VtIo* CONSOLE_INFORMATION::GetVtIo()\r\n+VtIo* CONSOLE_INFORMATION::GetVtIo() noexcept\r\n {\r\n     return &_vtIo;\r\n }\r\n \r\n-bool CONSOLE_INFORMATION::IsInVtIoMode() const\r\n+VtIo::Writer CONSOLE_INFORMATION::GetVtWriter() noexcept\r\n+{\r\n+    return _vtIo.IsUsingVt() ? _vtIo.GetWriter() : VtIo::Writer{};\r\n+}\r\n+\r\n+VtIo::Writer CONSOLE_INFORMATION::GetVtWriterForBuffer(const SCREEN_INFORMATION* context) noexcept\r\n+{\r\n+    return _vtIo.IsUsingVt() && (pCurrentScreenBuffer == context || pCurrentScreenBuffer == context->GetAltBuffer()) ? _vtIo.GetWriter() : VtIo::Writer{};\r\n+}\r\n+\r\n+bool CONSOLE_INFORMATION::IsInVtIoMode() const noexcept\r\n {\r\n     return _vtIo.IsUsingVt();\r\n }\r\n@@ -215,20 +225,6 @@ InputBuffer* const CONSOLE_INFORMATION::GetActiveInputBuffer() const\n void CONSOLE_INFORMATION::SetTitle(const std::wstring_view newTitle)\r\n {\r\n     _Title = std::wstring{ newTitle.begin(), newTitle.end() };\r\n-\r\n-    // Sanitize the input if we're in pty mode. No control chars - this string\r\n-    //      will get emitted back to the TTY in a VT sequence, and we don't want\r\n-    //      to embed control characters in that string. Note that we can't use\r\n-    //      IsInVtIoMode for this test, because the VT I/O thread won't have\r\n-    //      been created when the title is first set during startup.\r\n-    if (ServiceLocator::LocateGlobals().launchArgs.InConptyMode())\r\n-    {\r\n-        _Title.erase(std::remove_if(_Title.begin(), _Title.end(), [](auto ch) {\r\n-                         return ch < UNICODE_SPACE || (ch > UNICODE_DEL && ch < UNICODE_NBSP);\r\n-                     }),\r\n-                     _Title.end());\r\n-    }\r\n-\r\n     _TitleAndPrefix = _Prefix + _Title;\r\n \r\n     auto* const pRender = ServiceLocator::LocateGlobals().pRender;\r\ndiff --git a/src/host/directio.cpp b/src/host/directio.cpp\nindex e9338efd096..442236cf424 100644\n--- a/src/host/directio.cpp\n+++ b/src/host/directio.cpp\n@@ -598,6 +598,9 @@ CATCH_RETURN();\n             return E_INVALIDARG;\r\n         }\r\n \r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        auto writer = gci.GetVtWriterForBuffer(&context);\r\n+\r\n         for (til::CoordType y = clippedRectangle.Top(); y <= clippedRectangle.BottomInclusive(); y++)\r\n         {\r\n             const auto charInfos = buffer.subspan(totalOffset, width);\r\n@@ -606,6 +609,11 @@ CATCH_RETURN();\n             // Make the iterator and write to the target position.\r\n             storageBuffer.Write(OutputCellIterator(charInfos), target);\r\n \r\n+            if (writer)\r\n+            {\r\n+                writer.WriteInfos(target, charInfos);\r\n+            }\r\n+\r\n             totalOffset += bufferStride;\r\n         }\r\n \r\n@@ -615,6 +623,11 @@ CATCH_RETURN();\n         // Since we've managed to write part of the request, return the clamped part that we actually used.\r\n         writtenRectangle = clippedRectangle;\r\n \r\n+        if (writer)\r\n+        {\r\n+            writer.Submit();\r\n+        }\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n@@ -631,12 +644,23 @@ CATCH_RETURN();\n     try\r\n     {\r\n         auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        auto writer = gci.GetVtWriterForBuffer(&context);\r\n+\r\n+        if (writer)\r\n+        {\r\n+            writer.BackupCursor();\r\n+        }\r\n \r\n         const auto codepage = gci.OutputCP;\r\n         LOG_IF_FAILED(_ConvertCellsToWInplace(codepage, buffer, requestRectangle));\r\n \r\n         RETURN_IF_FAILED(WriteConsoleOutputWImplHelper(context, buffer, requestRectangle.Width(), requestRectangle, writtenRectangle));\r\n \r\n+        if (writer)\r\n+        {\r\n+            writer.Submit();\r\n+        }\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n@@ -652,6 +676,14 @@ CATCH_RETURN();\n \r\n     try\r\n     {\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        auto writer = gci.GetVtWriterForBuffer(&context);\r\n+\r\n+        if (writer)\r\n+        {\r\n+            writer.BackupCursor();\r\n+        }\r\n+\r\n         if (!context.GetActiveBuffer().GetCurrentFont().IsTrueTypeFont())\r\n         {\r\n             // For compatibility reasons, we must maintain the behavior that munges the data if we are writing while a raster font is enabled.\r\n@@ -664,6 +696,11 @@ CATCH_RETURN();\n             RETURN_IF_FAILED(WriteConsoleOutputWImplHelper(context, buffer, requestRectangle.Width(), requestRectangle, writtenRectangle));\r\n         }\r\n \r\n+        if (writer)\r\n+        {\r\n+            writer.Submit();\r\n+        }\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\ndiff --git a/src/host/exe/Host.EXE.vcxproj b/src/host/exe/Host.EXE.vcxproj\nindex 6de848979aa..0bc466b5488 100644\n--- a/src/host/exe/Host.EXE.vcxproj\n+++ b/src/host/exe/Host.EXE.vcxproj\n@@ -50,9 +50,6 @@\n     <ProjectReference Include=\"..\\..\\renderer\\gdi\\lib\\gdi.vcxproj\">\r\n       <Project>{1c959542-bac2-4e55-9a6d-13251914cbb9}</Project>\r\n     </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\renderer\\vt\\lib\\vt.vcxproj\">\r\n-      <Project>{990f2657-8580-4828-943f-5dd657d11842}</Project>\r\n-    </ProjectReference>\r\n     <ProjectReference Include=\"..\\..\\server\\lib\\server.vcxproj\">\r\n       <Project>{18d09a24-8240-42d6-8cb6-236eee820262}</Project>\r\n     </ProjectReference>\r\ndiff --git a/src/host/ft_fuzzer/Host.FuzzWrapper.vcxproj b/src/host/ft_fuzzer/Host.FuzzWrapper.vcxproj\nindex 6e5fb985efe..9b9cc60bb5c 100644\n--- a/src/host/ft_fuzzer/Host.FuzzWrapper.vcxproj\n+++ b/src/host/ft_fuzzer/Host.FuzzWrapper.vcxproj\n@@ -45,9 +45,6 @@\n     <ProjectReference Include=\"..\\..\\renderer\\gdi\\lib\\gdi.vcxproj\">\r\n       <Project>{1c959542-bac2-4e55-9a6d-13251914cbb9}</Project>\r\n     </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\renderer\\vt\\lib\\vt.vcxproj\">\r\n-      <Project>{990f2657-8580-4828-943f-5dd657d11842}</Project>\r\n-    </ProjectReference>\r\n     <ProjectReference Include=\"..\\..\\server\\lib\\server.vcxproj\">\r\n       <Project>{18d09a24-8240-42d6-8cb6-236eee820262}</Project>\r\n     </ProjectReference>\r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex 3595da335cf..42ea0885517 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -2,24 +2,20 @@\n // Licensed under the MIT license.\r\n \r\n #include \"precomp.h\"\r\n-\r\n #include \"getset.h\"\r\n \r\n-#include \"_output.h\"\r\n-#include \"_stream.h\"\r\n-#include \"output.h\"\r\n-#include \"dbcs.h\"\r\n+#include \"ApiRoutines.h\"\r\n+#include \"directio.h\"\r\n #include \"handle.h\"\r\n #include \"misc.h\"\r\n-#include \"cmdline.h\"\r\n+#include \"output.h\"\r\n+#include \"_output.h\"\r\n+#include \"_stream.h\"\r\n \r\n+#include \"../interactivity/inc/ServiceLocator.hpp\"\r\n #include \"../types/inc/convert.hpp\"\r\n #include \"../types/inc/viewport.hpp\"\r\n \r\n-#include \"ApiRoutines.h\"\r\n-\r\n-#include \"../interactivity/inc/ServiceLocator.hpp\"\r\n-\r\n #pragma hdrstop\r\n \r\n // The following mask is used to test for valid text attributes.\r\n@@ -367,19 +363,27 @@ void ApiRoutines::GetNumberOfConsoleMouseButtonsImpl(ULONG& buttons) noexcept\n             WI_ClearFlag(gci.Flags, CONSOLE_USE_PRIVATE_FLAGS);\r\n         }\r\n \r\n-        if (gci.IsInVtIoMode())\r\n+        if (auto writer = gci.GetVtWriter())\r\n         {\r\n+            auto oldMode = context.InputMode;\r\n+            auto newMode = mode;\r\n+\r\n             // Mouse input should be received when mouse mode is on and quick edit mode is off\r\n             // (for more information regarding the quirks of mouse mode and why/how it relates\r\n             //  to quick edit mode, see GH#9970)\r\n             const auto newQuickEditMode{ WI_IsFlagSet(gci.Flags, CONSOLE_QUICK_EDIT_MODE) };\r\n-            const auto oldMouseMode{ !oldQuickEditMode && WI_IsFlagSet(context.InputMode, ENABLE_MOUSE_INPUT) };\r\n-            const auto newMouseMode{ !newQuickEditMode && WI_IsFlagSet(mode, ENABLE_MOUSE_INPUT) };\r\n+            WI_ClearFlagIf(oldMode, ENABLE_MOUSE_INPUT, oldQuickEditMode);\r\n+            WI_ClearFlagIf(newMode, ENABLE_MOUSE_INPUT, newQuickEditMode);\r\n \r\n-            if (oldMouseMode != newMouseMode)\r\n+            if (const auto diff = oldMode ^ newMode)\r\n             {\r\n-                LOG_IF_FAILED(gci.GetVtIo()->RequestMouseMode(newMouseMode));\r\n+                if (WI_IsFlagSet(diff, ENABLE_MOUSE_INPUT))\r\n+                {\r\n+                    writer.WriteSGR1006(WI_IsFlagSet(newMode, ENABLE_MOUSE_INPUT));\r\n+                }\r\n             }\r\n+\r\n+            writer.Submit();\r\n         }\r\n \r\n         context.InputMode = mode;\r\n@@ -416,7 +420,6 @@ void ApiRoutines::GetNumberOfConsoleMouseButtonsImpl(ULONG& buttons) noexcept\n {\r\n     try\r\n     {\r\n-        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n \r\n@@ -426,6 +429,7 @@ void ApiRoutines::GetNumberOfConsoleMouseButtonsImpl(ULONG& buttons) noexcept\n         auto& screenInfo = context.GetActiveBuffer();\r\n         const auto dwOldMode = screenInfo.OutputMode;\r\n         const auto dwNewMode = mode;\r\n+        const auto diff = dwOldMode ^ dwNewMode;\r\n \r\n         screenInfo.OutputMode = dwNewMode;\r\n \r\n@@ -437,19 +441,26 @@ void ApiRoutines::GetNumberOfConsoleMouseButtonsImpl(ULONG& buttons) noexcept\n             screenInfo.GetStateMachine().ResetState();\r\n         }\r\n \r\n-        // if we changed rendering modes then redraw the output buffer,\r\n-        // but only do this if we're not in conpty mode.\r\n-        if (!gci.IsInVtIoMode() &&\r\n-            (WI_IsFlagSet(dwNewMode, ENABLE_VIRTUAL_TERMINAL_PROCESSING) != WI_IsFlagSet(dwOldMode, ENABLE_VIRTUAL_TERMINAL_PROCESSING) ||\r\n-             WI_IsFlagSet(dwNewMode, ENABLE_LVB_GRID_WORLDWIDE) != WI_IsFlagSet(dwOldMode, ENABLE_LVB_GRID_WORLDWIDE)))\r\n+        // if we changed rendering modes then redraw the output buffer.\r\n+        if (WI_IsAnyFlagSet(diff, ENABLE_VIRTUAL_TERMINAL_PROCESSING | ENABLE_LVB_GRID_WORLDWIDE))\r\n         {\r\n-            auto* pRender = ServiceLocator::LocateGlobals().pRender;\r\n-            if (pRender)\r\n+            if (const auto pRender = ServiceLocator::LocateGlobals().pRender)\r\n             {\r\n                 pRender->TriggerRedrawAll();\r\n             }\r\n         }\r\n \r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        if (auto writer = gci.GetVtWriterForBuffer(&context))\r\n+        {\r\n+            if (WI_IsFlagSet(diff, ENABLE_WRAP_AT_EOL_OUTPUT))\r\n+            {\r\n+                writer.WriteDECAWM(WI_IsFlagSet(dwNewMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n+            }\r\n+\r\n+            writer.Submit();\r\n+        }\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n@@ -466,6 +477,61 @@ void ApiRoutines::SetConsoleActiveScreenBufferImpl(SCREEN_INFORMATION& newContex\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n \r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+\r\n+        if (&newContext.GetActiveBuffer() == &gci.GetActiveOutputBuffer())\r\n+        {\r\n+            return;\r\n+        }\r\n+\r\n+        if (auto writer = gci.GetVtWriter())\r\n+        {\r\n+            const auto viewport = gci.GetActiveOutputBuffer().GetBufferSize();\r\n+            const auto size = viewport.Dimensions();\r\n+            const auto area = static_cast<size_t>(viewport.Width() * viewport.Height());\r\n+\r\n+            auto& main = newContext.GetMainBuffer();\r\n+            auto& alt = newContext.GetActiveBuffer();\r\n+            const auto hasAltBuffer = &alt != &main;\r\n+\r\n+            // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n+            THROW_IF_NTSTATUS_FAILED(main.ResizeTraditional(size));\r\n+            main.SetViewportSize(&size);\r\n+            if (hasAltBuffer)\r\n+            {\r\n+                THROW_IF_NTSTATUS_FAILED(alt.ResizeTraditional(size));\r\n+                alt.SetViewportSize(&size);\r\n+            }\r\n+\r\n+            Viewport read;\r\n+            til::small_vector<CHAR_INFO, 1024> infos;\r\n+            infos.resize(area, CHAR_INFO{ L' ', FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED });\r\n+\r\n+            const auto dumpScreenInfo = [&](SCREEN_INFORMATION& screenInfo) {\r\n+                THROW_IF_FAILED(ReadConsoleOutputWImpl(screenInfo, infos, viewport, read));\r\n+                for (til::CoordType i = 0; i < size.height; i++)\r\n+                {\r\n+                    writer.WriteInfos({ 0, i }, { infos.begin() + i * size.width, static_cast<size_t>(size.width) });\r\n+                }\r\n+\r\n+                writer.WriteCUP(screenInfo.GetTextBuffer().GetCursor().GetPosition());\r\n+                writer.WriteAttributes(screenInfo.GetAttributes());\r\n+                writer.WriteDECTCEM(screenInfo.GetTextBuffer().GetCursor().IsVisible());\r\n+                writer.WriteDECAWM(WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n+            };\r\n+\r\n+            writer.WriteASB(false);\r\n+            dumpScreenInfo(main);\r\n+\r\n+            if (hasAltBuffer)\r\n+            {\r\n+                writer.WriteASB(true);\r\n+                dumpScreenInfo(alt);\r\n+            }\r\n+\r\n+            writer.Submit();\r\n+        }\r\n+\r\n         SetActiveScreenBuffer(newContext.GetActiveBuffer());\r\n     }\r\n     CATCH_LOG();\r\n@@ -565,6 +631,8 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n             cursor.SetPosition(clampedCursorPosition);\r\n         }\r\n \r\n+        // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n@@ -621,7 +689,7 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n         // Only do this if we actually changed the value of the palette though -\r\n         // this API gets called all the time to change all sorts of things, but\r\n         // not necessarily the palette.\r\n-        if (changedOneTableEntry && !gci.IsInVtIoMode())\r\n+        if (changedOneTableEntry)\r\n         {\r\n             if (auto* pRender{ ServiceLocator::LocateGlobals().pRender })\r\n             {\r\n@@ -681,6 +749,8 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n             cursor.SetPosition(clampedCursorPosition);\r\n         }\r\n \r\n+        // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n@@ -713,7 +783,11 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n \r\n         // MSFT: 15813316 - Try to use this SetCursorPosition call to inherit the cursor position.\r\n         auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-        RETURN_IF_FAILED(gci.GetVtIo()->SetCursorPosition(position));\r\n+        if (auto writer = gci.GetVtWriterForBuffer(&context))\r\n+        {\r\n+            writer.WriteCUP(position);\r\n+            writer.Submit();\r\n+        }\r\n \r\n         RETURN_IF_NTSTATUS_FAILED(buffer.SetCursorPosition(position, true));\r\n \r\n@@ -789,6 +863,13 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n \r\n         context.SetCursorInformation(size, isVisible);\r\n \r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        if (auto writer = gci.GetVtWriterForBuffer(&context))\r\n+        {\r\n+            writer.WriteDECTCEM(isVisible);\r\n+            writer.Submit();\r\n+        }\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n@@ -854,14 +935,7 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n             context.PostUpdateWindowSize();\r\n \r\n             // Use WriteToScreen to invalidate the viewport with the renderer.\r\n-            // GH#3490 - If we're in conpty mode, don't invalidate the entire\r\n-            // viewport. In conpty mode, the VtEngine will later decide what\r\n-            // part of the buffer actually needs to be re-sent to the terminal.\r\n-            if (!(g.getConsoleInformation().IsInVtIoMode() &&\r\n-                  g.getConsoleInformation().GetVtIo()->IsResizeQuirkEnabled()))\r\n-            {\r\n-                WriteToScreen(context, context.GetViewport());\r\n-            }\r\n+            WriteToScreen(context, context.GetViewport());\r\n         }\r\n         return S_OK;\r\n     }\r\n@@ -913,8 +987,8 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n                                                                   const til::inclusive_rect& source,\r\n                                                                   const til::point target,\r\n                                                                   std::optional<til::inclusive_rect> clip,\r\n-                                                                  const wchar_t fillCharacter,\r\n-                                                                  const WORD fillAttribute,\r\n+                                                                  wchar_t fillCharacter,\r\n+                                                                  WORD fillAttribute,\r\n                                                                   const bool enableCmdShim) noexcept\r\n {\r\n     try\r\n@@ -922,44 +996,73 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n \r\n-        auto& buffer = context.GetActiveBuffer();\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        if (auto writer = gci.GetVtWriterForBuffer(&context))\r\n+        {\r\n+            auto& buffer = context.GetActiveBuffer();\r\n \r\n-        TextAttribute useThisAttr(fillAttribute);\r\n-        ScrollRegion(buffer, source, clip, target, fillCharacter, useThisAttr);\r\n+            // However, if the character is null and we were given a null attribute (represented as legacy 0),\r\n+            // then we'll just fill with spaces and whatever the buffer's default colors are.\r\n+            if (fillCharacter == UNICODE_NULL && fillAttribute == 0)\r\n+            {\r\n+                fillCharacter = UNICODE_SPACE;\r\n+                fillAttribute = buffer.GetAttributes().GetLegacyAttributes();\r\n+            }\r\n \r\n-        auto hr = S_OK;\r\n+            // GH#3126 - This is a shim for cmd's `cls` function. In the\r\n+            // legacy console, `cls` is supposed to clear the entire buffer. In\r\n+            // conpty however, there's no difference between the viewport and the\r\n+            // entirety of the buffer. We're going to see if this API call exactly\r\n+            // matched the way we expect cmd to call it. If it does, then\r\n+            // let's manually emit a Full Reset (RIS).\r\n+            const auto bufferSize = buffer.GetBufferSize();\r\n+            if (enableCmdShim &&\r\n+                source.left <= 0 && source.top <= 0 &&\r\n+                source.right >= bufferSize.RightInclusive() && source.bottom >= bufferSize.BottomInclusive() &&\r\n+                target.x == 0 && target.y <= -bufferSize.BottomExclusive() &&\r\n+                !clip &&\r\n+                fillCharacter == UNICODE_SPACE && fillAttribute == buffer.GetAttributes().GetLegacyAttributes())\r\n+            {\r\n+                WriteClearScreen(context);\r\n+                writer.Submit();\r\n+                return S_OK;\r\n+            }\r\n \r\n-        // GH#3126 - This is a shim for cmd's `cls` function. In the\r\n-        // legacy console, `cls` is supposed to clear the entire buffer. In\r\n-        // conpty however, there's no difference between the viewport and the\r\n-        // entirety of the buffer. We're going to see if this API call exactly\r\n-        // matched the way we expect cmd to call it. If it does, then\r\n-        // let's manually emit a ^[[3J to the connected terminal, so that their\r\n-        // entire buffer will be cleared as well.\r\n-        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-        if (enableCmdShim && gci.IsInVtIoMode())\r\n-        {\r\n-            const auto currentBufferDimensions = buffer.GetBufferSize().Dimensions();\r\n-            const auto sourceIsWholeBuffer = (source.top == 0) &&\r\n-                                             (source.left == 0) &&\r\n-                                             (source.right == currentBufferDimensions.width) &&\r\n-                                             (source.bottom == currentBufferDimensions.height);\r\n-            const auto targetIsNegativeBufferHeight = (target.x == 0) &&\r\n-                                                      (target.y == -currentBufferDimensions.height);\r\n-            const auto noClipProvided = clip == std::nullopt;\r\n-            const auto fillIsBlank = (fillCharacter == UNICODE_SPACE) &&\r\n-                                     (fillAttribute == buffer.GetAttributes().GetLegacyAttributes());\r\n-\r\n-            if (sourceIsWholeBuffer && targetIsNegativeBufferHeight && noClipProvided && fillIsBlank)\r\n+            const auto clipViewport = clip ? Viewport::FromInclusive(*clip) : bufferSize;\r\n+            const auto sourceViewport = Viewport::FromInclusive(source);\r\n+            Viewport readViewport;\r\n+            Viewport writtenViewport;\r\n+\r\n+            const auto w = std::max(0, sourceViewport.Width());\r\n+            const auto h = std::max(0, sourceViewport.Height());\r\n+            const auto a = static_cast<size_t>(w * h);\r\n+            if (a == 0)\r\n             {\r\n-                // It's important that we flush the renderer at this point so we don't\r\n-                // have any pending output rendered after the scrollback is cleared.\r\n-                ServiceLocator::LocateGlobals().pRender->TriggerFlush(false);\r\n-                hr = gci.GetVtIo()->ManuallyClearScrollback();\r\n+                return S_OK;\r\n             }\r\n+\r\n+            til::small_vector<CHAR_INFO, 1024> backup;\r\n+            til::small_vector<CHAR_INFO, 1024> fill;\r\n+\r\n+            backup.resize(a, CHAR_INFO{ fillCharacter, fillAttribute });\r\n+            fill.resize(a, CHAR_INFO{ fillCharacter, fillAttribute });\r\n+\r\n+            writer.BackupCursor();\r\n+\r\n+            RETURN_IF_FAILED(ReadConsoleOutputWImplHelper(context, backup, sourceViewport, readViewport));\r\n+            RETURN_IF_FAILED(WriteConsoleOutputWImplHelper(context, fill, w, sourceViewport.Clamp(clipViewport), writtenViewport));\r\n+            RETURN_IF_FAILED(WriteConsoleOutputWImplHelper(context, backup, w, Viewport::FromDimensions(target, readViewport.Dimensions()).Clamp(clipViewport), writtenViewport));\r\n+\r\n+            writer.Submit();\r\n+        }\r\n+        else\r\n+        {\r\n+            auto& buffer = context.GetActiveBuffer();\r\n+            TextAttribute useThisAttr(fillAttribute);\r\n+            ScrollRegion(buffer, source, clip, target, fillCharacter, useThisAttr);\r\n         }\r\n \r\n-        return hr;\r\n+        return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n }\r\n@@ -984,6 +1087,13 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n         const TextAttribute attr{ attribute };\r\n         context.SetAttributes(attr);\r\n \r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        if (auto writer = gci.GetVtWriterForBuffer(&context))\r\n+        {\r\n+            writer.WriteAttributes(attr);\r\n+            writer.Submit();\r\n+        }\r\n+\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n@@ -1103,7 +1213,6 @@ void ApiRoutines::GetConsoleWindowImpl(HWND& hwnd) noexcept\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n         const IConsoleWindow* pWindow = ServiceLocator::LocateConsoleWindow();\r\n-        const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         if (pWindow != nullptr)\r\n         {\r\n             hwnd = pWindow->GetWindowHandle();\r\n@@ -1115,6 +1224,7 @@ void ApiRoutines::GetConsoleWindowImpl(HWND& hwnd) noexcept\n             //      doesn't actually do anything, but is a unique HWND to this\r\n             //      console, so that they know that this console is in fact a real\r\n             //      console window.\r\n+            auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n             if (gci.IsInVtIoMode())\r\n             {\r\n                 hwnd = ServiceLocator::LocatePseudoWindow();\r\n@@ -1516,6 +1626,16 @@ void ApiRoutines::GetConsoleDisplayModeImpl(ULONG& flags) noexcept\n     LockConsole();\r\n     auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n \r\n-    ServiceLocator::LocateGlobals().getConsoleInformation().SetTitle(title);\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    gci.SetTitle(title);\r\n+\r\n+    if (auto writer = gci.GetVtWriter())\r\n+    {\r\n+        writer.WriteUTF8(\"\\x1b]0;\");\r\n+        writer.WriteUTF16StripControlChars(title);\r\n+        writer.WriteUTF8(\"\\x7\");\r\n+        writer.Submit();\r\n+    }\r\n+\r\n     return S_OK;\r\n }\r\ndiff --git a/src/host/globals.cpp b/src/host/globals.cpp\nindex d1bbb4f297b..9505d490bc1 100644\n--- a/src/host/globals.cpp\n+++ b/src/host/globals.cpp\n@@ -25,19 +25,3 @@ bool Globals::IsHeadless() const\n {\r\n     return launchArgs.IsHeadless();\r\n }\r\n-\r\n-#ifdef UNIT_TESTING\r\n-// Method Description:\r\n-// - This is a test helper method. It can be used to trick us into responding\r\n-//   true to `IsHeadless`, which will cause the console host to act in conpty\r\n-//   mode.\r\n-// Arguments:\r\n-// - vtRenderEngine: a VT renderer that our VtIo should use as the vt engine during these tests\r\n-// Return Value:\r\n-// - <none>\r\n-void Globals::EnableConptyModeForTests(std::unique_ptr<Microsoft::Console::Render::VtEngine> vtRenderEngine, const bool resizeQuirk)\r\n-{\r\n-    launchArgs.EnableConptyModeForTests();\r\n-    getConsoleInformation().GetVtIo()->EnableConptyModeForTests(std::move(vtRenderEngine), resizeQuirk);\r\n-}\r\n-#endif\r\ndiff --git a/src/host/globals.h b/src/host/globals.h\nindex 812bf059c41..1fbb9da808d 100644\n--- a/src/host/globals.h\n+++ b/src/host/globals.h\n@@ -76,10 +76,6 @@ class Globals\n     wil::unique_threadpool_wait handoffInboxConsoleExitWait;\r\n     bool defaultTerminalMarkerCheckRequired = false;\r\n \r\n-#ifdef UNIT_TESTING\r\n-    void EnableConptyModeForTests(std::unique_ptr<Microsoft::Console::Render::VtEngine> vtRenderEngine, const bool resizeQuirk = false);\r\n-#endif\r\n-\r\n private:\r\n     CONSOLE_INFORMATION ciConsoleInformation;\r\n     ApiRoutines defaultApiRoutines;\r\ndiff --git a/src/host/inputBuffer.hpp b/src/host/inputBuffer.hpp\nindex 653f04e36f1..05d604b7e47 100644\n--- a/src/host/inputBuffer.hpp\n+++ b/src/host/inputBuffer.hpp\n@@ -15,7 +15,6 @@\n namespace Microsoft::Console::Render\r\n {\r\n     class Renderer;\r\n-    class VtEngine;\r\n }\r\n \r\n class InputBuffer final : public ConsoleObjectHeader\r\ndiff --git a/src/host/outputStream.cpp b/src/host/outputStream.cpp\nindex 59b81b40e1d..a719f7a63c6 100644\n--- a/src/host/outputStream.cpp\n+++ b/src/host/outputStream.cpp\n@@ -33,6 +33,14 @@ ConhostInternalGetSet::ConhostInternalGetSet(_In_ IIoProvider& io) :\n // - <none>\r\n void ConhostInternalGetSet::ReturnResponse(const std::wstring_view response)\r\n {\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+\r\n+    // ConPTY should not respond to requests. That's the job of the terminal.\r\n+    if (gci.IsInVtIoMode())\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n     // TODO GH#4954 During the input refactor we may want to add a \"priority\" input list\r\n     // to make sure that \"response\" input is spooled directly into the application.\r\n     // We switched this to an append (vs. a prepend) to fix GH#1637, a bug where two CPR\r\n@@ -202,7 +210,7 @@ CursorType ConhostInternalGetSet::GetUserDefaultCursorStyle() const\n // - <none>\r\n void ConhostInternalGetSet::ShowWindow(bool showOrHide)\r\n {\r\n-    const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n     const auto hwnd = gci.IsInVtIoMode() ? ServiceLocator::LocatePseudoWindow() : ServiceLocator::LocateConsoleWindow()->GetWindowHandle();\r\n \r\n     // GH#13301 - When we send this ShowWindow message, if we send it to the\r\n@@ -279,11 +287,17 @@ void ConhostInternalGetSet::SetWorkingDirectory(const std::wstring_view /*uri*/)\n // - true if successful. false otherwise.\r\n void ConhostInternalGetSet::PlayMidiNote(const int noteNumber, const int velocity, const std::chrono::microseconds duration)\r\n {\r\n+    const auto window = ServiceLocator::LocateConsoleWindow();\r\n+    if (!window)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n     // Unlock the console, so the UI doesn't hang while we're busy.\r\n     UnlockConsole();\r\n \r\n     // This call will block for the duration, unless shutdown early.\r\n-    const auto windowHandle = ServiceLocator::LocateConsoleWindow()->GetWindowHandle();\r\n+    const auto windowHandle = window->GetWindowHandle();\r\n     auto& midiAudio = ServiceLocator::LocateGlobals().getConsoleInformation().GetMidiAudio();\r\n     midiAudio.PlayNote(windowHandle, noteNumber, velocity, std::chrono::duration_cast<std::chrono::milliseconds>(duration));\r\n \r\n@@ -332,11 +346,9 @@ bool ConhostInternalGetSet::ResizeWindow(const til::CoordType sColumns, const ti\n     }\r\n \r\n     // If the cursor row is now past the bottom of the viewport, we'll have to\r\n-    // move the viewport down to bring it back into view. However, we don't want\r\n-    // to do this in pty mode, because the conpty resize operation is dependent\r\n-    // on the viewport *not* being adjusted.\r\n+    // move the viewport down to bring it back into view.\r\n     const auto cursorOverflow = csbiex.dwCursorPosition.Y - newViewport.BottomInclusive();\r\n-    if (cursorOverflow > 0 && !IsConsolePty())\r\n+    if (cursorOverflow > 0)\r\n     {\r\n         newViewport = Viewport::Offset(newViewport, { 0, cursorOverflow });\r\n     }\r\n@@ -353,17 +365,6 @@ bool ConhostInternalGetSet::ResizeWindow(const til::CoordType sColumns, const ti\n     return true;\r\n }\r\n \r\n-// Routine Description:\r\n-// - Checks if the console host is acting as a pty.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - true if we're in pty mode.\r\n-bool ConhostInternalGetSet::IsConsolePty() const\r\n-{\r\n-    return ServiceLocator::LocateGlobals().getConsoleInformation().IsInVtIoMode();\r\n-}\r\n-\r\n // Routine Description:\r\n // - Checks if the InputBuffer is willing to accept VT Input directly\r\n //   IsVtInputEnabled is an internal-only \"API\" call that the vt commands can execute,\r\ndiff --git a/src/host/outputStream.hpp b/src/host/outputStream.hpp\nindex 9f083f60625..866a6f643dc 100644\n--- a/src/host/outputStream.hpp\n+++ b/src/host/outputStream.hpp\n@@ -62,7 +62,6 @@ class ConhostInternalGetSet final : public Microsoft::Console::VirtualTerminal::\n     void SetWorkingDirectory(const std::wstring_view uri) override;\r\n     void PlayMidiNote(const int noteNumber, const int velocity, const std::chrono::microseconds duration) override;\r\n \r\n-    bool IsConsolePty() const override;\r\n     bool IsVtInputEnabled() const override;\r\n \r\n     void NotifyAccessibilityChange(const til::rect& changedRect) override;\r\ndiff --git a/src/host/screenInfo.cpp b/src/host/screenInfo.cpp\nindex f383bff4755..0084dc5bced 100644\n--- a/src/host/screenInfo.cpp\n+++ b/src/host/screenInfo.cpp\n@@ -1200,20 +1200,7 @@ void SCREEN_INFORMATION::_InternalSetViewportSize(const til::size* const pcoordS\n     _viewport = newViewport;\r\n     Tracing::s_TraceWindowViewport(_viewport);\r\n \r\n-    // In Conpty mode, call TriggerScroll here without params. By not providing\r\n-    // params, the renderer will make sure to update the VtEngine with the\r\n-    // updated viewport size. If we don't do this, the engine can get into a\r\n-    // torn state on this frame.\r\n-    //\r\n-    // Without this statement, the engine won't be told about the new view size\r\n-    // till the start of the next frame. If any other text gets output before\r\n-    // that frame starts, there's a very real chance that it'll cause errors as\r\n-    // the engine tries to invalidate those regions.\r\n     auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-    if (gci.IsInVtIoMode() && ServiceLocator::LocateGlobals().pRender)\r\n-    {\r\n-        ServiceLocator::LocateGlobals().pRender->TriggerScroll();\r\n-    }\r\n     if (gci.HasPendingCookedRead())\r\n     {\r\n         gci.CookedReadData().RedrawAfterResize();\r\n@@ -1761,6 +1748,11 @@ const SCREEN_INFORMATION& SCREEN_INFORMATION::GetMainBuffer() const\n     return *this;\r\n }\r\n \r\n+const SCREEN_INFORMATION* SCREEN_INFORMATION::GetAltBuffer() const noexcept\r\n+{\r\n+    return _psiAlternateBuffer;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Instantiates a new buffer to be used as an alternate buffer. This buffer\r\n //     does not have a driver handle associated with it and shares a state\r\n@@ -1901,15 +1893,6 @@ void SCREEN_INFORMATION::_handleDeferredResize(SCREEN_INFORMATION& siMain)\n             s_RemoveScreenBuffer(psiOldAltBuffer); // this will also delete the old alt buffer\r\n         }\r\n \r\n-        // GH#381: When we switch into the alt buffer:\r\n-        //  * flush the current frame, to clear out anything that we prepared for this buffer.\r\n-        //  * Emit a ?1049h/l to the remote side, to let them know that we've switched buffers.\r\n-        if (gci.IsInVtIoMode() && ServiceLocator::LocateGlobals().pRender)\r\n-        {\r\n-            ServiceLocator::LocateGlobals().pRender->TriggerFlush(false);\r\n-            LOG_IF_FAILED(gci.GetVtIo()->SwitchScreenBuffer(true));\r\n-        }\r\n-\r\n         ::SetActiveScreenBuffer(*psiNewAltBuffer);\r\n \r\n         // Kind of a hack until we have proper signal channels: If the client app wants window size events, send one for\r\n@@ -1937,15 +1920,6 @@ void SCREEN_INFORMATION::UseMainScreenBuffer()\n     {\r\n         _handleDeferredResize(*psiMain);\r\n \r\n-        // GH#381: When we switch into the main buffer:\r\n-        //  * flush the current frame, to clear out anything that we prepared for this buffer.\r\n-        //  * Emit a ?1049h/l to the remote side, to let them know that we've switched buffers.\r\n-        if (gci.IsInVtIoMode() && ServiceLocator::LocateGlobals().pRender)\r\n-        {\r\n-            ServiceLocator::LocateGlobals().pRender->TriggerFlush(false);\r\n-            LOG_IF_FAILED(gci.GetVtIo()->SwitchScreenBuffer(false));\r\n-        }\r\n-\r\n         ::SetActiveScreenBuffer(*psiMain);\r\n         psiMain->UpdateScrollBars(); // The alt had disabled scrollbars, re-enable them\r\n \r\n@@ -1994,7 +1968,7 @@ bool SCREEN_INFORMATION::_IsAltBuffer() const\n // - true iff this buffer has a main buffer.\r\n bool SCREEN_INFORMATION::_IsInPtyMode() const\r\n {\r\n-    const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n     return _IsAltBuffer() || gci.IsInVtIoMode();\r\n }\r\n \r\n@@ -2084,8 +2058,6 @@ void SCREEN_INFORMATION::SetPopupAttributes(const TextAttribute& popupAttributes\n void SCREEN_INFORMATION::SetDefaultAttributes(const TextAttribute& attributes,\r\n                                               const TextAttribute& popupAttributes)\r\n {\r\n-    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-\r\n     const auto oldPrimaryAttributes = GetAttributes();\r\n     const auto oldPopupAttributes = GetPopupAttributes();\r\n \r\n@@ -2101,10 +2073,7 @@ void SCREEN_INFORMATION::SetDefaultAttributes(const TextAttribute& attributes,\n     // Force repaint of entire viewport, unless we're in conpty mode. In that\r\n     // case, we don't really need to force a redraw of the entire screen just\r\n     // because the text attributes changed.\r\n-    if (!(gci.IsInVtIoMode()))\r\n-    {\r\n-        _textBuffer->TriggerRedrawAll();\r\n-    }\r\n+    _textBuffer->TriggerRedrawAll();\r\n \r\n     // If we're an alt buffer, also update our main buffer.\r\n     if (_psiMainBuffer)\r\n@@ -2200,32 +2169,6 @@ void SCREEN_INFORMATION::SetViewport(const Viewport& newViewport,\n     return S_OK;\r\n }\r\n \r\n-// Method Description:\r\n-// - Sets up the Output state machine to be in pty mode. Sequences it doesn't\r\n-//      understand will be written to the pTtyConnection passed in here.\r\n-// Arguments:\r\n-// - pTtyConnection: This is a TerminalOutputConnection that we can write the\r\n-//      sequence we didn't understand to.\r\n-// Return Value:\r\n-// - <none>\r\n-void SCREEN_INFORMATION::SetTerminalConnection(_In_ VtEngine* const pTtyConnection)\r\n-{\r\n-    auto& engine = reinterpret_cast<OutputStateMachineEngine&>(_stateMachine->Engine());\r\n-    if (pTtyConnection)\r\n-    {\r\n-        engine.SetTerminalConnection(pTtyConnection,\r\n-                                     [&stateMachine = *_stateMachine]() -> bool {\r\n-                                         ServiceLocator::LocateGlobals().pRender->NotifyPaintFrame();\r\n-                                         return stateMachine.FlushToTerminal();\r\n-                                     });\r\n-    }\r\n-    else\r\n-    {\r\n-        engine.SetTerminalConnection(nullptr,\r\n-                                     nullptr);\r\n-    }\r\n-}\r\n-\r\n // Routine Description:\r\n // - Writes cells to the output buffer at the cursor position.\r\n // Arguments:\r\ndiff --git a/src/host/screenInfo.hpp b/src/host/screenInfo.hpp\nindex bf2d5e29fd6..7f0b9357a14 100644\n--- a/src/host/screenInfo.hpp\n+++ b/src/host/screenInfo.hpp\n@@ -47,14 +47,6 @@ Revision History:\n #include \"../types/inc/Viewport.hpp\"\r\n class ConversionAreaInfo; // forward decl window. circular reference\r\n \r\n-// fwdecl unittest classes\r\n-#ifdef UNIT_TESTING\r\n-namespace TerminalCoreUnitTests\r\n-{\r\n-    class ConptyRoundtripTests;\r\n-};\r\n-#endif\r\n-\r\n class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console::IIoProvider\r\n {\r\n public:\r\n@@ -199,7 +191,7 @@ class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console\n \r\n     SCREEN_INFORMATION& GetMainBuffer();\r\n     const SCREEN_INFORMATION& GetMainBuffer() const;\r\n-\r\n+    const SCREEN_INFORMATION* GetAltBuffer() const noexcept;\r\n     SCREEN_INFORMATION& GetActiveBuffer();\r\n     const SCREEN_INFORMATION& GetActiveBuffer() const;\r\n \r\n@@ -213,8 +205,6 @@ class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console\n \r\n     [[nodiscard]] HRESULT ClearBuffer();\r\n \r\n-    void SetTerminalConnection(_In_ Microsoft::Console::Render::VtEngine* const pTtyConnection);\r\n-\r\n     void UpdateBottom();\r\n \r\n     FontInfo& GetCurrentFont() noexcept;\r\n@@ -226,6 +216,9 @@ class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console\n     void SetIgnoreLegacyEquivalentVTAttributes() noexcept;\r\n     void ResetIgnoreLegacyEquivalentVTAttributes() noexcept;\r\n \r\n+    [[nodiscard]] NTSTATUS ResizeWithReflow(const til::size coordnewScreenSize);\r\n+    [[nodiscard]] NTSTATUS ResizeTraditional(const til::size coordNewScreenSize);\r\n+\r\n private:\r\n     SCREEN_INFORMATION(_In_ Microsoft::Console::Interactivity::IWindowMetrics* pMetrics,\r\n                        _In_ Microsoft::Console::Interactivity::IAccessibilityNotifier* pNotifier,\r\n@@ -249,9 +242,6 @@ class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console\n                                                _Out_ bool* const pfIsHorizontalVisible,\r\n                                                _Out_ bool* const pfIsVerticalVisible);\r\n \r\n-    [[nodiscard]] NTSTATUS ResizeWithReflow(const til::size coordnewScreenSize);\r\n-    [[nodiscard]] NTSTATUS ResizeTraditional(const til::size coordNewScreenSize);\r\n-\r\n     [[nodiscard]] NTSTATUS _InitializeOutputStateMachine();\r\n     void _FreeOutputStateMachine();\r\n \r\n@@ -297,7 +287,5 @@ class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console\n     friend class TextBufferIteratorTests;\r\n     friend class ScreenBufferTests;\r\n     friend class CommonState;\r\n-    friend class ConptyOutputTests;\r\n-    friend class TerminalCoreUnitTests::ConptyRoundtripTests;\r\n #endif\r\n };\r\ndiff --git a/src/host/server.h b/src/host/server.h\nindex 0cf24ef42ff..1e14a94b731 100644\n--- a/src/host/server.h\n+++ b/src/host/server.h\n@@ -103,7 +103,10 @@ class CONSOLE_INFORMATION :\n     bool IsConsoleLocked() const noexcept;\r\n     ULONG GetCSRecursionCount() const noexcept;\r\n \r\n-    Microsoft::Console::VirtualTerminal::VtIo* GetVtIo();\r\n+    Microsoft::Console::VirtualTerminal::VtIo* GetVtIo() noexcept;\r\n+    Microsoft::Console::VirtualTerminal::VtIo::Writer GetVtWriter() noexcept;\r\n+    Microsoft::Console::VirtualTerminal::VtIo::Writer GetVtWriterForBuffer(const SCREEN_INFORMATION* context) noexcept;\r\n+    bool IsInVtIoMode() const noexcept;\r\n \r\n     SCREEN_INFORMATION& GetActiveOutputBuffer() override;\r\n     const SCREEN_INFORMATION& GetActiveOutputBuffer() const override;\r\n@@ -112,7 +115,6 @@ class CONSOLE_INFORMATION :\n \r\n     InputBuffer* const GetActiveInputBuffer() const override;\r\n \r\n-    bool IsInVtIoMode() const;\r\n     bool HasPendingCookedRead() const noexcept;\r\n     bool HasPendingPopup() const noexcept;\r\n     const COOKED_READ_DATA& CookedReadData() const noexcept;\r\ndiff --git a/src/host/srvinit.cpp b/src/host/srvinit.cpp\nindex 8be3b28f486..5b10705a631 100644\n--- a/src/host/srvinit.cpp\n+++ b/src/host/srvinit.cpp\n@@ -574,7 +574,7 @@ try\n \r\n     // GH#13211 - Make sure the terminal obeys the resizing quirk. Otherwise,\r\n     // defterm connections to the Terminal are going to have weird resizing.\r\n-    const auto commandLine = fmt::format(FMT_COMPILE(L\" --headless --resizeQuirk --signal {:#x}\"),\r\n+    const auto commandLine = fmt::format(FMT_COMPILE(L\" --headless --signal {:#x}\"),\r\n                                          (int64_t)signalPipeOurSide.release());\r\n \r\n     ConsoleArguments consoleArgs(commandLine, inPipeOurSide.release(), outPipeOurSide.release());\r\n@@ -841,24 +841,25 @@ PWSTR TranslateConsoleTitle(_In_ PCWSTR pwszConsoleTitle, const BOOL fUnexpand,\n     // No matter what, create a renderer.\r\n     try\r\n     {\r\n-        g.pRender = nullptr;\r\n-\r\n-        auto renderThread = std::make_unique<RenderThread>();\r\n-        // stash a local pointer to the thread here -\r\n-        // We're going to give ownership of the thread to the Renderer,\r\n-        //      but the thread also need to be told who its renderer is,\r\n-        //      and we can't do that until the renderer is constructed.\r\n-        auto* const localPointerToThread = renderThread.get();\r\n-\r\n-        g.pRender = new Renderer(gci.GetRenderSettings(), &gci.renderData, nullptr, 0, std::move(renderThread));\r\n-\r\n-        THROW_IF_FAILED(localPointerToThread->Initialize(g.pRender));\r\n-\r\n-        // Set up the renderer to be used to calculate the width of a glyph,\r\n-        //      should we be unable to figure out its width another way.\r\n-        CodepointWidthDetector::Singleton().SetFallbackMethod([](const std::wstring_view& glyph) {\r\n-            return ServiceLocator::LocateGlobals().pRender->IsGlyphWideByFont(glyph);\r\n-        });\r\n+        if (!gci.IsInVtIoMode())\r\n+        {\r\n+            auto renderThread = std::make_unique<RenderThread>();\r\n+            // stash a local pointer to the thread here -\r\n+            // We're going to give ownership of the thread to the Renderer,\r\n+            //      but the thread also need to be told who its renderer is,\r\n+            //      and we can't do that until the renderer is constructed.\r\n+            auto* const localPointerToThread = renderThread.get();\r\n+\r\n+            g.pRender = new Renderer(gci.GetRenderSettings(), &gci.renderData, nullptr, 0, std::move(renderThread));\r\n+\r\n+            THROW_IF_FAILED(localPointerToThread->Initialize(g.pRender));\r\n+\r\n+            // Set up the renderer to be used to calculate the width of a glyph,\r\n+            //      should we be unable to figure out its width another way.\r\n+            CodepointWidthDetector::Singleton().SetFallbackMethod([](const std::wstring_view& glyph) {\r\n+                return ServiceLocator::LocateGlobals().pRender->IsGlyphWideByFont(glyph);\r\n+            });\r\n+        }\r\n     }\r\n     catch (...)\r\n     {\r\n@@ -876,7 +877,10 @@ PWSTR TranslateConsoleTitle(_In_ PCWSTR pwszConsoleTitle, const BOOL fUnexpand,\n     }\r\n \r\n     // Allow the renderer to paint once the rest of the console is hooked up.\r\n-    g.pRender->EnablePainting();\r\n+    if (g.pRender)\r\n+    {\r\n+        g.pRender->EnablePainting();\r\n+    }\r\n \r\n     if (SUCCEEDED_NTSTATUS(Status) && ConsoleConnectionDeservesVisibleWindow(p))\r\n     {\r\ndiff --git a/src/host/ut_host/ConptyOutputTests.cpp b/src/host/ut_host/ConptyOutputTests.cpp\ndeleted file mode 100644\nindex f4e5d4b2c7e..00000000000\n--- a/src/host/ut_host/ConptyOutputTests.cpp\n+++ /dev/null\n@@ -1,465 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-#include <wextestclass.h>\r\n-#include \"../../inc/consoletaeftemplates.hpp\"\r\n-#include \"../../types/inc/Viewport.hpp\"\r\n-\r\n-#include \"../../renderer/base/Renderer.hpp\"\r\n-#include \"../../renderer/vt/Xterm256Engine.hpp\"\r\n-#include \"../../renderer/vt/XtermEngine.hpp\"\r\n-#include \"../Settings.hpp\"\r\n-\r\n-#include \"CommonState.hpp\"\r\n-\r\n-using namespace WEX::Common;\r\n-using namespace WEX::Logging;\r\n-using namespace WEX::TestExecution;\r\n-using namespace Microsoft::Console::Types;\r\n-using namespace Microsoft::Console::Interactivity;\r\n-using namespace Microsoft::Console::VirtualTerminal;\r\n-\r\n-using namespace Microsoft::Console;\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-class ConptyOutputTests\r\n-{\r\n-    // !!! DANGER: Many tests in this class expect the Terminal and Host buffers\r\n-    // to be 80x32. If you change these, you'll probably inadvertently break a\r\n-    // bunch of tests !!!\r\n-    static const til::CoordType TerminalViewWidth = 80;\r\n-    static const til::CoordType TerminalViewHeight = 32;\r\n-\r\n-    // This test class is to write some things into the PTY and then check that\r\n-    // the rendering that is coming out of the VT-sequence generator is exactly\r\n-    // as we expect it to be.\r\n-    BEGIN_TEST_CLASS(ConptyOutputTests)\r\n-        TEST_CLASS_PROPERTY(L\"IsolationLevel\", L\"Class\")\r\n-    END_TEST_CLASS()\r\n-\r\n-    TEST_CLASS_SETUP(ClassSetup)\r\n-    {\r\n-        m_state = std::make_unique<CommonState>();\r\n-\r\n-        m_state->InitEvents();\r\n-        m_state->PrepareGlobalInputBuffer();\r\n-        m_state->PrepareGlobalScreenBuffer(TerminalViewWidth, TerminalViewHeight, TerminalViewWidth, TerminalViewHeight);\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_CLASS_CLEANUP(ClassCleanup)\r\n-    {\r\n-        m_state->CleanupGlobalScreenBuffer();\r\n-        m_state->CleanupGlobalInputBuffer();\r\n-\r\n-        m_state.release();\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_METHOD_SETUP(MethodSetup)\r\n-    {\r\n-        // Set up some sane defaults\r\n-        auto& g = ServiceLocator::LocateGlobals();\r\n-        auto& gci = g.getConsoleInformation();\r\n-        gci.SetColorTableEntry(TextColor::DEFAULT_FOREGROUND, INVALID_COLOR);\r\n-        gci.SetColorTableEntry(TextColor::DEFAULT_BACKGROUND, INVALID_COLOR);\r\n-        gci.SetFillAttribute(0x07); // DARK_WHITE on DARK_BLACK\r\n-        gci.CalculateDefaultColorIndices();\r\n-\r\n-        g.pRender = new Renderer(gci.GetRenderSettings(), &gci.renderData, nullptr, 0, nullptr);\r\n-\r\n-        m_state->PrepareNewTextBufferInfo(true, TerminalViewWidth, TerminalViewHeight);\r\n-        auto& currentBuffer = gci.GetActiveOutputBuffer();\r\n-        // Make sure a test hasn't left us in the alt buffer on accident\r\n-        VERIFY_IS_FALSE(currentBuffer._IsAltBuffer());\r\n-        VERIFY_SUCCEEDED(currentBuffer.SetViewportOrigin(true, { 0, 0 }, true));\r\n-        VERIFY_ARE_EQUAL(til::point{}, currentBuffer.GetTextBuffer().GetCursor().GetPosition());\r\n-\r\n-        // Set up an xterm-256 renderer for conpty\r\n-        auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-        auto initialViewport = currentBuffer.GetViewport();\r\n-\r\n-        auto vtRenderEngine = std::make_unique<Xterm256Engine>(std::move(hFile),\r\n-                                                               initialViewport);\r\n-        auto pfn = std::bind(&ConptyOutputTests::_writeCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-        vtRenderEngine->SetTestCallback(pfn);\r\n-\r\n-        g.pRender->AddRenderEngine(vtRenderEngine.get());\r\n-        gci.GetActiveOutputBuffer().SetTerminalConnection(vtRenderEngine.get());\r\n-\r\n-        expectedOutput.clear();\r\n-\r\n-        // Manually set the console into conpty mode. We're not actually going\r\n-        // to set up the pipes for conpty, but we want the console to behave\r\n-        // like it would in conpty mode.\r\n-        g.EnableConptyModeForTests(std::move(vtRenderEngine));\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_METHOD_CLEANUP(MethodCleanup)\r\n-    {\r\n-        m_state->CleanupNewTextBufferInfo();\r\n-\r\n-        auto& g = ServiceLocator::LocateGlobals();\r\n-        delete g.pRender;\r\n-\r\n-        VERIFY_ARE_EQUAL(0u, expectedOutput.size(), L\"Tests should drain all the output they push into the expected output buffer.\");\r\n-\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_METHOD(ConptyOutputTestCanary);\r\n-    TEST_METHOD(SimpleWriteOutputTest);\r\n-    TEST_METHOD(WriteTwoLinesUsesNewline);\r\n-    TEST_METHOD(WriteAFewSimpleLines);\r\n-    TEST_METHOD(InvalidateUntilOneBeforeEnd);\r\n-    TEST_METHOD(SetConsoleTitleWithControlChars);\r\n-    TEST_METHOD(IncludeBackgroundColorChangesInFirstFrame);\r\n-    TEST_METHOD(MoveCursorAfterWrapForced);\r\n-\r\n-private:\r\n-    bool _writeCallback(const char* const pch, const size_t cch);\r\n-    void _flushFirstFrame();\r\n-    std::deque<std::string> expectedOutput;\r\n-    std::unique_ptr<CommonState> m_state;\r\n-};\r\n-\r\n-bool ConptyOutputTests::_writeCallback(const char* const pch, const size_t cch)\r\n-{\r\n-    // Since rendering happens on a background thread that doesn't have the exception handler on it\r\n-    // we need to rely on VERIFY's return codes instead of exceptions.\r\n-    const WEX::TestExecution::DisableVerifyExceptions disableExceptionsScope;\r\n-\r\n-    auto actualString = std::string(pch, cch);\r\n-    RETURN_BOOL_IF_FALSE(VERIFY_IS_GREATER_THAN(expectedOutput.size(),\r\n-                                                static_cast<size_t>(0),\r\n-                                                NoThrowString().Format(L\"writing=\\\"%hs\\\", expecting %u strings\", actualString.c_str(), expectedOutput.size())));\r\n-\r\n-    auto first = expectedOutput.front();\r\n-    expectedOutput.pop_front();\r\n-\r\n-    Log::Comment(NoThrowString().Format(L\"Expected =\\t\\\"%hs\\\"\", first.c_str()));\r\n-    Log::Comment(NoThrowString().Format(L\"Actual =\\t\\\"%hs\\\"\", actualString.c_str()));\r\n-\r\n-    RETURN_BOOL_IF_FALSE(VERIFY_ARE_EQUAL(first.length(), cch));\r\n-    RETURN_BOOL_IF_FALSE(VERIFY_ARE_EQUAL(first, actualString));\r\n-\r\n-    return true;\r\n-}\r\n-\r\n-void ConptyOutputTests::_flushFirstFrame()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[2J\");\r\n-    expectedOutput.push_back(\"\\x1b[m\");\r\n-    expectedOutput.push_back(\"\\x1b[H\"); // Go Home\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-// Function Description:\r\n-// - Helper function to validate that a number of characters in a row are all\r\n-//   the same. Validates that the next end-start characters are all equal to the\r\n-//   provided string. Will move the provided iterator as it validates. The\r\n-//   caller should ensure that `iter` starts where they would like to validate.\r\n-// Arguments:\r\n-// - expectedChar: The character (or characters) we're expecting\r\n-// - iter: a iterator pointing to the cell we'd like to start validating at.\r\n-// - start: the first index in the range we'd like to validate\r\n-// - end: the last index in the range we'd like to validate\r\n-// Return Value:\r\n-// - <none>\r\n-void _verifySpanOfText(const wchar_t* const expectedChar,\r\n-                       TextBufferCellIterator& iter,\r\n-                       const int start,\r\n-                       const int end)\r\n-{\r\n-    for (auto x = start; x < end; x++)\r\n-    {\r\n-        SetVerifyOutput settings(VerifyOutputSettings::LogOnlyFailures);\r\n-        if (iter->Chars() != expectedChar)\r\n-        {\r\n-            Log::Comment(NoThrowString().Format(L\"character [%d] was mismatched\", x));\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expectedChar, (iter++)->Chars());\r\n-    }\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Successfully validated %d characters were '%s'\", end - start, expectedChar));\r\n-}\r\n-\r\n-void ConptyOutputTests::ConptyOutputTestCanary()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"This is a simple test to make sure that everything is working as expected.\"));\r\n-\r\n-    _flushFirstFrame();\r\n-}\r\n-\r\n-void ConptyOutputTests::SimpleWriteOutputTest()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write some simple output, and make sure it gets rendered largely \"\r\n-        L\"unmodified to the terminal\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    expectedOutput.push_back(\"Hello World\");\r\n-    sm.ProcessString(L\"Hello World\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyOutputTests::WriteTwoLinesUsesNewline()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write two lines of output. We should use \\r\\n to move the cursor\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto& tb = si.GetTextBuffer();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    sm.ProcessString(L\"AAA\");\r\n-    sm.ProcessString(L\"\\x1b[2;1H\");\r\n-    sm.ProcessString(L\"BBB\");\r\n-\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 0, 0 });\r\n-        VERIFY_ARE_EQUAL(L\"A\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"A\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"A\", (iter++)->Chars());\r\n-    }\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 0, 1 });\r\n-        VERIFY_ARE_EQUAL(L\"B\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"B\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"B\", (iter++)->Chars());\r\n-    }\r\n-\r\n-    expectedOutput.push_back(\"AAA\");\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    expectedOutput.push_back(\"BBB\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyOutputTests::WriteAFewSimpleLines()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Write more lines of output. We should use \\r\\n to move the cursor\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto& tb = si.GetTextBuffer();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    sm.ProcessString(L\"AAA\\n\");\r\n-    sm.ProcessString(L\"BBB\\n\");\r\n-    sm.ProcessString(L\"\\n\");\r\n-    sm.ProcessString(L\"CCC\");\r\n-\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 0, 0 });\r\n-        VERIFY_ARE_EQUAL(L\"A\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"A\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"A\", (iter++)->Chars());\r\n-    }\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 0, 1 });\r\n-        VERIFY_ARE_EQUAL(L\"B\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"B\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"B\", (iter++)->Chars());\r\n-    }\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 0, 2 });\r\n-        VERIFY_ARE_EQUAL(L\" \", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\" \", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\" \", (iter++)->Chars());\r\n-    }\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 0, 3 });\r\n-        VERIFY_ARE_EQUAL(L\"C\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"C\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"C\", (iter++)->Chars());\r\n-    }\r\n-\r\n-    expectedOutput.push_back(\"AAA\");\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    expectedOutput.push_back(\"BBB\");\r\n-    // Jump down to the fourth line because emitting spaces didn't do anything\r\n-    // and we will skip to emitting the CCC segment.\r\n-    expectedOutput.push_back(\"\\x1b[4;1H\");\r\n-    expectedOutput.push_back(\"CCC\");\r\n-\r\n-    // Cursor goes back on.\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyOutputTests::InvalidateUntilOneBeforeEnd()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Make sure we don't use EL and wipe out the last column of text\"));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-    auto& tb = si.GetTextBuffer();\r\n-\r\n-    _flushFirstFrame();\r\n-\r\n-    // Move the cursor to width-15, draw 15 characters\r\n-    sm.ProcessString(L\"\\x1b[1;66H\");\r\n-    sm.ProcessString(L\"ABCDEFGHIJKLMNO\");\r\n-\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 78, 0 });\r\n-        VERIFY_ARE_EQUAL(L\"N\", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"O\", (iter++)->Chars());\r\n-    }\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[65C\");\r\n-    expectedOutput.push_back(\"ABCDEFGHIJKLMNO\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // overstrike the first with X and the middle 8 with spaces\r\n-    sm.ProcessString(L\"\\x1b[1;66H\");\r\n-    //                 ABCDEFGHIJKLMNO\r\n-    sm.ProcessString(L\"X             \");\r\n-\r\n-    {\r\n-        auto iter = tb.GetCellDataAt({ 78, 0 });\r\n-        VERIFY_ARE_EQUAL(L\" \", (iter++)->Chars());\r\n-        VERIFY_ARE_EQUAL(L\"O\", (iter++)->Chars());\r\n-    }\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[1;66H\");\r\n-    expectedOutput.push_back(\"X\"); // sequence optimizer should choose ECH here\r\n-    expectedOutput.push_back(\"\\x1b[13X\");\r\n-    expectedOutput.push_back(\"\\x1b[13C\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyOutputTests::SetConsoleTitleWithControlChars()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:control\", L\"{0x00, 0x0A, 0x1B, 0x80, 0x9B, 0x9C}\")\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    int control;\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"control\", control));\r\n-\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"SetConsoleTitle with a control character (0x%02X) embedded in the text\", control));\r\n-\r\n-    std::wstringstream titleText;\r\n-    titleText << L\"Hello \" << wchar_t(control) << L\"World!\";\r\n-    g.getConsoleInformation().SetTitle(titleText.str());\r\n-\r\n-    // This is the standard init sequences for the first frame.\r\n-    expectedOutput.push_back(\"\\x1b[2J\");\r\n-    expectedOutput.push_back(\"\\x1b[m\");\r\n-    expectedOutput.push_back(\"\\x1b[H\");\r\n-\r\n-    // The title change is propagated as an OSC 0 sequence.\r\n-    // Control characters are stripped, so it's always \"Hello World\".\r\n-    expectedOutput.push_back(\"\\x1b]0;Hello World!\\a\");\r\n-\r\n-    // This is also part of the standard init sequence.\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyOutputTests::IncludeBackgroundColorChangesInFirstFrame()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    sm.ProcessString(L\"\\x1b[41mRun 1     \\x1b[42mRun 2     \\x1b[43mRun 3     \\x1b[m\");\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[2J\"); // standard init sequence for the first frame\r\n-    expectedOutput.push_back(\"\\x1b[m\"); // standard init sequence for the first frame\r\n-    expectedOutput.push_back(\"\\x1b[41m\");\r\n-    expectedOutput.push_back(\"\\x1b[H\"); // standard init sequence for the first frame\r\n-    expectedOutput.push_back(\"Run 1     \");\r\n-    expectedOutput.push_back(\"\\x1b[42m\");\r\n-    expectedOutput.push_back(\"Run 2     \");\r\n-    expectedOutput.push_back(\"\\x1b[43m\");\r\n-    expectedOutput.push_back(\"Run 3     \");\r\n-\r\n-    // This is also part of the standard init sequence.\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\n-\r\n-void ConptyOutputTests::MoveCursorAfterWrapForced()\r\n-{\r\n-    auto& g = ServiceLocator::LocateGlobals();\r\n-    auto& renderer = *g.pRender;\r\n-    auto& gci = g.getConsoleInformation();\r\n-    auto& si = gci.GetActiveOutputBuffer();\r\n-    auto& sm = si.GetStateMachine();\r\n-\r\n-    // We write a character in the rightmost column to trigger the _wrapForced\r\n-    // flag. Technically this is a bug, but it's how things currently work.\r\n-    sm.ProcessString(L\"\\x1b[1;999H*\");\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[2J\"); // standard init sequence for the first frame\r\n-    expectedOutput.push_back(\"\\x1b[m\"); // standard init sequence for the first frame\r\n-    expectedOutput.push_back(\"\\x1b[1;80H\");\r\n-    expectedOutput.push_back(\"*\");\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-\r\n-    // Position the cursor on line 2, and fill line 1 with A's.\r\n-    sm.ProcessString(L\"\\x1b[2H\");\r\n-    sm.ProcessString(L\"\\033[65;1;1;1;999$x\");\r\n-\r\n-    expectedOutput.push_back(\"\\x1b[H\");\r\n-    expectedOutput.push_back(\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\");\r\n-\r\n-    // The cursor must be explicitly moved to line 2 at the end of the frame.\r\n-    // Although that may technically already be the next output location, we\r\n-    // still need the cursor to be shown in that position when the frame ends.\r\n-    expectedOutput.push_back(\"\\r\\n\");\r\n-    expectedOutput.push_back(\"\\x1b[?25h\");\r\n-\r\n-    VERIFY_SUCCEEDED(renderer.PaintFrame());\r\n-}\r\ndiff --git a/src/host/ut_host/Host.UnitTests.vcxproj b/src/host/ut_host/Host.UnitTests.vcxproj\nindex 89d7e2a65e0..18ea1768ff0 100644\n--- a/src/host/ut_host/Host.UnitTests.vcxproj\n+++ b/src/host/ut_host/Host.UnitTests.vcxproj\n@@ -30,8 +30,6 @@\n     <ClCompile Include=\"InputBufferTests.cpp\" />\r\n     <ClCompile Include=\"ViewportTests.cpp\" />\r\n     <ClCompile Include=\"VtIoTests.cpp\" />\r\n-    <ClCompile Include=\"VtRendererTests.cpp\" />\r\n-    <ClCompile Include=\"ConptyOutputTests.cpp\" />\r\n     <ClCompile Include=\"..\\precomp.cpp\">\r\n       <PrecompiledHeader>Create</PrecompiledHeader>\r\n     </ClCompile>\r\n@@ -46,9 +44,6 @@\n     <ProjectReference Include=\"..\\..\\renderer\\atlas\\atlas.vcxproj\">\r\n       <Project>{8222900C-8B6C-452A-91AC-BE95DB04B95F}</Project>\r\n     </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\renderer\\vt\\ut_lib\\vt.unittest.vcxproj\">\r\n-      <Project>{990F2657-8580-4828-943F-5DD657D11843}</Project>\r\n-    </ProjectReference>\r\n     <ProjectReference Include=\"..\\..\\interactivity\\base\\lib\\InteractivityBase.vcxproj\">\r\n       <Project>{06ec74cb-9a12-429c-b551-8562ec964846}</Project>\r\n     </ProjectReference>\r\ndiff --git a/src/host/ut_host/Host.UnitTests.vcxproj.filters b/src/host/ut_host/Host.UnitTests.vcxproj.filters\nindex 9c946aa560f..45e9e7de3ae 100644\n--- a/src/host/ut_host/Host.UnitTests.vcxproj.filters\n+++ b/src/host/ut_host/Host.UnitTests.vcxproj.filters\n@@ -57,9 +57,6 @@\n     <ClCompile Include=\"VtIoTests.cpp\">\r\n       <Filter>Source Files</Filter>\r\n     </ClCompile>\r\n-    <ClCompile Include=\"VtRendererTests.cpp\">\r\n-      <Filter>Source Files</Filter>\r\n-    </ClCompile>\r\n     <ClCompile Include=\"AliasTests.cpp\">\r\n       <Filter>Source Files</Filter>\r\n     </ClCompile>\r\n@@ -81,9 +78,6 @@\n     <ClCompile Include=\"ObjectTests.cpp\">\r\n       <Filter>Source Files</Filter>\r\n     </ClCompile>\r\n-    <ClCompile Include=\"ConptyOutputTests.cpp\">\r\n-      <Filter>Source Files</Filter>\r\n-    </ClCompile>\r\n   </ItemGroup>\r\n   <ItemGroup>\r\n     <ClInclude Include=\"UnicodeLiteral.hpp\">\r\ndiff --git a/src/host/ut_host/ScreenBufferTests.cpp b/src/host/ut_host/ScreenBufferTests.cpp\nindex 2e802dc2472..a4a57e53f5e 100644\n--- a/src/host/ut_host/ScreenBufferTests.cpp\n+++ b/src/host/ut_host/ScreenBufferTests.cpp\n@@ -17,7 +17,6 @@\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n #include \"../../inc/conattrs.hpp\"\r\n #include \"../../types/inc/Viewport.hpp\"\r\n-#include \"../../renderer/vt/Xterm256Engine.hpp\"\r\n \r\n #include \"../../inc/TestUtils.h\"\r\n \r\n@@ -7931,11 +7930,9 @@ void ScreenBufferTests::TestReflowBiggerLongLineWithColor()\n void ScreenBufferTests::TestDeferredMainBufferResize()\r\n {\r\n     BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:inConpty\", L\"{false, true}\")\r\n         TEST_METHOD_PROPERTY(L\"Data:reEnterAltBuffer\", L\"{false, true}\")\r\n     END_TEST_METHOD_PROPERTIES();\r\n \r\n-    INIT_TEST_PROPERTY(bool, inConpty, L\"Should we pretend to be in conpty mode?\");\r\n     INIT_TEST_PROPERTY(bool, reEnterAltBuffer, L\"Should we re-enter the alt buffer when we're already in it?\");\r\n \r\n     // A test for https://github.com/microsoft/terminal/pull/12719#discussion_r834860330\r\n@@ -7946,31 +7943,6 @@ void ScreenBufferTests::TestDeferredMainBufferResize()\n     gci.LockConsole(); // Lock must be taken to manipulate buffer.\r\n     auto unlock = wil::scope_exit([&] { gci.UnlockConsole(); });\r\n \r\n-    // HUGELY cribbed from ConptyRoundtripTests::MethodSetup. This fakes the\r\n-    // console into thinking that it's in ConPTY mode. Yes, we need all this\r\n-    // just to get gci.IsInVtIoMode() to return true. The screen buffer gates\r\n-    // all sorts of internal checks on that.\r\n-    //\r\n-    // This could theoretically be a helper if other tests need it.\r\n-    if (inConpty)\r\n-    {\r\n-        Log::Comment(L\"Set up ConPTY\");\r\n-\r\n-        auto& currentBuffer = gci.GetActiveOutputBuffer();\r\n-        // Set up an xterm-256 renderer for conpty\r\n-        wil::unique_hfile hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-        auto initialViewport = currentBuffer.GetViewport();\r\n-        auto vtRenderEngine = std::make_unique<Microsoft::Console::Render::Xterm256Engine>(std::move(hFile),\r\n-                                                                                           initialViewport);\r\n-        // We don't care about the output, so let it just drain to the void.\r\n-        vtRenderEngine->SetTestCallback([](auto&&, auto&&) -> bool { return true; });\r\n-        gci.GetActiveOutputBuffer().SetTerminalConnection(vtRenderEngine.get());\r\n-        // Manually set the console into conpty mode. We're not actually going\r\n-        // to set up the pipes for conpty, but we want the console to behave\r\n-        // like it would in conpty mode.\r\n-        ServiceLocator::LocateGlobals().EnableConptyModeForTests(std::move(vtRenderEngine));\r\n-    }\r\n-\r\n     auto* siMain = &gci.GetActiveOutputBuffer();\r\n     auto& stateMachine = siMain->GetStateMachine();\r\n \r\ndiff --git a/src/host/ut_host/VtIoTests.cpp b/src/host/ut_host/VtIoTests.cpp\nindex 89d7bac3815..1a6085b498c 100644\n--- a/src/host/ut_host/VtIoTests.cpp\n+++ b/src/host/ut_host/VtIoTests.cpp\n@@ -2,432 +2,588 @@\n // Licensed under the MIT license.\r\n \r\n #include \"precomp.h\"\r\n-#include <wextestclass.h>\r\n-#include \"../../inc/consoletaeftemplates.hpp\"\r\n-#include \"../../types/inc/Viewport.hpp\"\r\n \r\n-#include \"../VtIo.hpp\"\r\n-#include \"../../interactivity/inc/ServiceLocator.hpp\"\r\n-#include \"../../renderer/base/Renderer.hpp\"\r\n-#include \"../../renderer/vt/Xterm256Engine.hpp\"\r\n-#include \"../../renderer/vt/XtermEngine.hpp\"\r\n+#include \"CommonState.hpp\"\r\n \r\n using namespace WEX::Common;\r\n using namespace WEX::Logging;\r\n using namespace WEX::TestExecution;\r\n-using namespace Microsoft::Console::Interactivity;\r\n-\r\n-class Microsoft::Console::VirtualTerminal::VtIoTests\r\n-{\r\n-    BEGIN_TEST_CLASS(VtIoTests)\r\n-        TEST_CLASS_PROPERTY(L\"IsolationLevel\", L\"Class\")\r\n-    END_TEST_CLASS()\r\n-\r\n-    // General Tests:\r\n-    TEST_METHOD(NoOpStartTest);\r\n-\r\n-    TEST_METHOD(DtorTestJustEngine);\r\n-    TEST_METHOD(DtorTestDeleteVtio);\r\n-    TEST_METHOD(DtorTestStackAlloc);\r\n-    TEST_METHOD(DtorTestStackAllocMany);\r\n-\r\n-    TEST_METHOD(RendererDtorAndThread);\r\n-\r\n-    TEST_METHOD(BasicAnonymousPipeOpeningWithSignalChannelTest);\r\n-};\r\n \r\n+using namespace Microsoft::Console::Interactivity;\r\n using namespace Microsoft::Console;\r\n using namespace Microsoft::Console::VirtualTerminal;\r\n using namespace Microsoft::Console::Render;\r\n using namespace Microsoft::Console::Types;\r\n \r\n-void VtIoTests::NoOpStartTest()\r\n-{\r\n-    VtIo vtio;\r\n-    VERIFY_IS_FALSE(vtio.IsUsingVt());\r\n-\r\n-    Log::Comment(L\"Verify we succeed at StartIfNeeded even if we weren't initialized\");\r\n-    VERIFY_SUCCEEDED(vtio.StartIfNeeded());\r\n-}\r\n+static constexpr WORD red = FOREGROUND_RED | BACKGROUND_GREEN;\r\n+static constexpr WORD blu = FOREGROUND_BLUE | BACKGROUND_GREEN;\r\n \r\n-Viewport SetUpViewport()\r\n+constexpr CHAR_INFO ci_red(wchar_t ch) noexcept\r\n {\r\n-    til::inclusive_rect view;\r\n-    view.top = view.left = 0;\r\n-    view.bottom = 31;\r\n-    view.right = 79;\r\n-\r\n-    return Viewport::FromInclusive(view);\r\n-}\r\n-\r\n-void VtIoTests::DtorTestJustEngine()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"This test is going to instantiate a bunch of VtIos in different \\n\"\r\n-        L\"scenarios to see if something causes a weird cleanup.\\n\"\r\n-        L\"It's here because of the strange nature of VtEngine having members\\n\"\r\n-        L\"that are only defined in UNIT_TESTING\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"New some engines and delete them\"));\r\n-    for (auto i = 0; i < 25; ++i)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"New/Delete loop #%d\", i));\r\n-\r\n-        wil::unique_hfile hOutputFile;\r\n-        hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-        auto pRenderer256 = new Xterm256Engine(std::move(hOutputFile), SetUpViewport());\r\n-        Log::Comment(NoThrowString().Format(L\"Made Xterm256Engine\"));\r\n-        delete pRenderer256;\r\n-        Log::Comment(NoThrowString().Format(L\"Deleted.\"));\r\n-\r\n-        hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-\r\n-        auto pRenderEngineXterm = new XtermEngine(std::move(hOutputFile), SetUpViewport(), false);\r\n-        Log::Comment(NoThrowString().Format(L\"Made XtermEngine\"));\r\n-        delete pRenderEngineXterm;\r\n-        Log::Comment(NoThrowString().Format(L\"Deleted.\"));\r\n-\r\n-        hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-\r\n-        auto pRenderEngineXtermAscii = new XtermEngine(std::move(hOutputFile), SetUpViewport(), true);\r\n-        Log::Comment(NoThrowString().Format(L\"Made XtermEngine\"));\r\n-        delete pRenderEngineXtermAscii;\r\n-        Log::Comment(NoThrowString().Format(L\"Deleted.\"));\r\n-    }\r\n+    return { ch, red };\r\n }\r\n \r\n-void VtIoTests::DtorTestDeleteVtio()\r\n+constexpr CHAR_INFO ci_blu(wchar_t ch) noexcept\r\n {\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"This test is going to instantiate a bunch of VtIos in different \\n\"\r\n-        L\"scenarios to see if something causes a weird cleanup.\\n\"\r\n-        L\"It's here because of the strange nature of VtEngine having members\\n\"\r\n-        L\"that are only defined in UNIT_TESTING\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"New some engines and delete them\"));\r\n-    for (auto i = 0; i < 25; ++i)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"New/Delete loop #%d\", i));\r\n-\r\n-        auto hOutputFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-\r\n-        hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-\r\n-        auto vtio = new VtIo();\r\n-        Log::Comment(NoThrowString().Format(L\"Made VtIo\"));\r\n-        vtio->_pVtRenderEngine = std::make_unique<Xterm256Engine>(std::move(hOutputFile),\r\n-                                                                  SetUpViewport());\r\n-        Log::Comment(NoThrowString().Format(L\"Made Xterm256Engine\"));\r\n-        delete vtio;\r\n-        Log::Comment(NoThrowString().Format(L\"Deleted.\"));\r\n-\r\n-        hOutputFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-        vtio = new VtIo();\r\n-        Log::Comment(NoThrowString().Format(L\"Made VtIo\"));\r\n-        vtio->_pVtRenderEngine = std::make_unique<XtermEngine>(std::move(hOutputFile),\r\n-                                                               SetUpViewport(),\r\n-                                                               false);\r\n-        Log::Comment(NoThrowString().Format(L\"Made XtermEngine\"));\r\n-        delete vtio;\r\n-        Log::Comment(NoThrowString().Format(L\"Deleted.\"));\r\n-\r\n-        hOutputFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-        vtio = new VtIo();\r\n-        Log::Comment(NoThrowString().Format(L\"Made VtIo\"));\r\n-        vtio->_pVtRenderEngine = std::make_unique<XtermEngine>(std::move(hOutputFile),\r\n-                                                               SetUpViewport(),\r\n-                                                               true);\r\n-        Log::Comment(NoThrowString().Format(L\"Made XtermEngine\"));\r\n-        delete vtio;\r\n-        Log::Comment(NoThrowString().Format(L\"Deleted.\"));\r\n-    }\r\n+    return { ch, blu };\r\n }\r\n \r\n-void VtIoTests::DtorTestStackAlloc()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"This test is going to instantiate a bunch of VtIos in different \\n\"\r\n-        L\"scenarios to see if something causes a weird cleanup.\\n\"\r\n-        L\"It's here because of the strange nature of VtEngine having members\\n\"\r\n-        L\"that are only defined in UNIT_TESTING\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"make some engines and let them fall out of scope\"));\r\n-    for (auto i = 0; i < 25; ++i)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Scope Exit Auto cleanup #%d\", i));\r\n-\r\n-        wil::unique_hfile hOutputFile;\r\n-\r\n-        hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-        {\r\n-            VtIo vtio;\r\n-            vtio._pVtRenderEngine = std::make_unique<Xterm256Engine>(std::move(hOutputFile),\r\n-                                                                     SetUpViewport());\r\n-        }\r\n-\r\n-        hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-        {\r\n-            VtIo vtio;\r\n-            vtio._pVtRenderEngine = std::make_unique<XtermEngine>(std::move(hOutputFile),\r\n-                                                                  SetUpViewport(),\r\n-                                                                  false);\r\n-        }\r\n-\r\n-        hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-        {\r\n-            VtIo vtio;\r\n-            vtio._pVtRenderEngine = std::make_unique<XtermEngine>(std::move(hOutputFile),\r\n-                                                                  SetUpViewport(),\r\n-                                                                  true);\r\n-        }\r\n-    }\r\n-}\r\n-\r\n-void VtIoTests::DtorTestStackAllocMany()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"This test is going to instantiate a bunch of VtIos in different \\n\"\r\n-        L\"scenarios to see if something causes a weird cleanup.\\n\"\r\n-        L\"It's here because of the strange nature of VtEngine having members\\n\"\r\n-        L\"that are only defined in UNIT_TESTING\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Try an make a whole bunch all at once, and have them all fall out of scope at once.\"));\r\n-    for (auto i = 0; i < 25; ++i)\r\n-    {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Multiple engines, one scope loop #%d\", i));\r\n-\r\n-        wil::unique_hfile hOutputFile;\r\n-        {\r\n-            hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-            VtIo vtio1;\r\n-            vtio1._pVtRenderEngine = std::make_unique<Xterm256Engine>(std::move(hOutputFile),\r\n-                                                                      SetUpViewport());\r\n-\r\n-            hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-            VtIo vtio2;\r\n-            vtio2._pVtRenderEngine = std::make_unique<XtermEngine>(std::move(hOutputFile),\r\n-                                                                   SetUpViewport(),\r\n-                                                                   false);\r\n-\r\n-            hOutputFile.reset(INVALID_HANDLE_VALUE);\r\n-            VtIo vtio3;\r\n-            vtio3._pVtRenderEngine = std::make_unique<XtermEngine>(std::move(hOutputFile),\r\n-                                                                   SetUpViewport(),\r\n-                                                                   true);\r\n-        }\r\n-    }\r\n-}\r\n+#define cup(y, x) \"\\x1b[\" #y \";\" #x \"H\" // CUP: Cursor Position\r\n+#define decawm(h) \"\\x1b[?7\" #h // DECAWM: Autowrap Mode\r\n+#define decsc() \"\\x1b\\x37\" // DECSC: DEC Save Cursor (+ attributes)\r\n+#define decrc() \"\\x1b\\x38\" // DECRC: DEC Restore Cursor (+ attributes)\r\n+\r\n+// The escape sequences that ci_red() / ci_blu() result in.\r\n+#define sgr_red(s) \"\\x1b[0;31;42m\" s\r\n+#define sgr_blu(s) \"\\x1b[0;34;42m\" s\r\n+// What the default attributes `FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED` result in.\r\n+#define sgr_rst() \"\\x1b[0m\"\r\n+\r\n+static constexpr std::wstring_view s_initialContentVT{\r\n+    // clang-format off\r\n+    L\"\"\r\n+    sgr_red(\"AB\") sgr_blu(\"ab\") sgr_red(\"CD\") sgr_blu(\"cd\") \"\\r\\n\"\r\n+    sgr_red(\"EF\") sgr_blu(\"ef\") sgr_red(\"GH\") sgr_blu(\"gh\") \"\\r\\n\"\r\n+    sgr_blu(\"ij\") sgr_red(\"IJ\") sgr_blu(\"kl\") sgr_red(\"KL\") \"\\r\\n\"\r\n+    sgr_blu(\"mn\") sgr_red(\"MN\") sgr_blu(\"op\") sgr_red(\"OP\")\r\n+    // clang-format on\r\n+};\r\n \r\n-class MockRenderData : public IRenderData\r\n+class ::Microsoft::Console::VirtualTerminal::VtIoTests\r\n {\r\n-public:\r\n-    Microsoft::Console::Types::Viewport GetViewport() noexcept override\r\n-    {\r\n-        return Microsoft::Console::Types::Viewport{};\r\n-    }\r\n-\r\n-    til::point GetTextBufferEndPosition() const noexcept override\r\n-    {\r\n-        return {};\r\n-    }\r\n-\r\n-    TextBuffer& GetTextBuffer() const noexcept override\r\n-    {\r\n-        FAIL_FAST_HR(E_NOTIMPL);\r\n-    }\r\n-\r\n-    const FontInfo& GetFontInfo() const noexcept override\r\n-    {\r\n-        FAIL_FAST_HR(E_NOTIMPL);\r\n-    }\r\n-\r\n-    std::vector<Microsoft::Console::Types::Viewport> GetSelectionRects() noexcept override\r\n-    {\r\n-        return std::vector<Microsoft::Console::Types::Viewport>{};\r\n-    }\r\n+    BEGIN_TEST_CLASS(VtIoTests)\r\n+        TEST_CLASS_PROPERTY(L\"IsolationLevel\", L\"Class\")\r\n+    END_TEST_CLASS()\r\n \r\n-    void LockConsole() noexcept override\r\n-    {\r\n-    }\r\n+    CommonState commonState;\r\n+    ApiRoutines routines;\r\n+    SCREEN_INFORMATION* screenInfo = nullptr;\r\n+    wil::unique_hfile rx;\r\n+    char rxBuf[4096];\r\n \r\n-    void UnlockConsole() noexcept override\r\n+    std::string_view readOutput() noexcept\r\n     {\r\n+        DWORD read = 0;\r\n+        ReadFile(rx.get(), &rxBuf[0], sizeof(rxBuf), &read, nullptr);\r\n+        return { &rxBuf[0], read };\r\n     }\r\n \r\n-    std::pair<COLORREF, COLORREF> GetAttributeColors(const TextAttribute& /*attr*/) const noexcept override\r\n+    void setupInitialContents() const\r\n     {\r\n-        return std::make_pair(COLORREF{}, COLORREF{});\r\n+        auto& sm = screenInfo->GetStateMachine();\r\n+        sm.ProcessString(L\"\\033c\");\r\n+        sm.ProcessString(s_initialContentVT);\r\n+        sm.ProcessString(L\"\\x1b[H\" sgr_rst());\r\n     }\r\n \r\n-    til::point GetCursorPosition() const noexcept override\r\n+    void resetContents() const\r\n     {\r\n-        return {};\r\n+        auto& sm = screenInfo->GetStateMachine();\r\n+        sm.ProcessString(L\"\\033c\");\r\n     }\r\n \r\n-    bool IsCursorVisible() const noexcept override\r\n+    TEST_CLASS_SETUP(ClassSetup)\r\n     {\r\n-        return false;\r\n-    }\r\n+        wil::unique_hfile tx;\r\n+        //std::tie(tx, rx) = createOverlappedPipe(16 * 1024);\r\n+        THROW_IF_WIN32_BOOL_FALSE(CreatePipe(rx.addressof(), tx.addressof(), nullptr, 16 * 1024));\r\n \r\n-    bool IsCursorOn() const noexcept override\r\n-    {\r\n-        return false;\r\n-    }\r\n+        DWORD mode = PIPE_READMODE_BYTE | PIPE_NOWAIT;\r\n+        THROW_IF_WIN32_BOOL_FALSE(SetNamedPipeHandleState(rx.get(), &mode, nullptr, nullptr));\r\n \r\n-    ULONG GetCursorHeight() const noexcept override\r\n-    {\r\n-        return 42ul;\r\n-    }\r\n+        commonState.PrepareGlobalInputBuffer();\r\n+        commonState.PrepareGlobalScreenBuffer(8, 4, 8, 4);\r\n \r\n-    CursorType GetCursorStyle() const noexcept override\r\n-    {\r\n-        return CursorType::FullBox;\r\n-    }\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        THROW_IF_FAILED(gci.GetVtIo()->_Initialize(nullptr, tx.release(), nullptr));\r\n \r\n-    ULONG GetCursorPixelWidth() const noexcept override\r\n-    {\r\n-        return 12ul;\r\n+        screenInfo = &gci.GetActiveOutputBuffer();\r\n+        return true;\r\n     }\r\n \r\n-    bool IsCursorDoubleWidth() const override\r\n+    TEST_METHOD(SetConsoleCursorPosition)\r\n     {\r\n-        return false;\r\n-    }\r\n+        THROW_IF_FAILED(routines.SetConsoleCursorPositionImpl(*screenInfo, { 2, 3 }));\r\n+        THROW_IF_FAILED(routines.SetConsoleCursorPositionImpl(*screenInfo, { 0, 0 }));\r\n+        THROW_IF_FAILED(routines.SetConsoleCursorPositionImpl(*screenInfo, { 7, 3 }));\r\n+        THROW_IF_FAILED(routines.SetConsoleCursorPositionImpl(*screenInfo, { 3, 2 }));\r\n \r\n-    const bool IsGridLineDrawingAllowed() noexcept override\r\n-    {\r\n-        return false;\r\n+        const auto expected = cup(4, 3) cup(1, 1) cup(4, 8) cup(3, 4);\r\n+        const auto actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\n \r\n-    const std::wstring_view GetConsoleTitle() const noexcept override\r\n+    TEST_METHOD(SetConsoleOutputMode)\r\n     {\r\n-        return std::wstring_view{};\r\n-    }\r\n+        const auto initialMode = screenInfo->OutputMode;\r\n+        const auto cleanup = wil::scope_exit([=]() {\r\n+            screenInfo->OutputMode = initialMode;\r\n+        });\r\n \r\n-    const bool IsSelectionActive() const override\r\n-    {\r\n-        return false;\r\n-    }\r\n+        screenInfo->OutputMode = 0;\r\n \r\n-    const bool IsBlockSelection() const noexcept override\r\n-    {\r\n-        return false;\r\n-    }\r\n+        THROW_IF_FAILED(routines.SetConsoleOutputModeImpl(*screenInfo, ENABLE_PROCESSED_OUTPUT | ENABLE_WRAP_AT_EOL_OUTPUT | ENABLE_VIRTUAL_TERMINAL_PROCESSING | DISABLE_NEWLINE_AUTO_RETURN | ENABLE_LVB_GRID_WORLDWIDE)); // DECAWM \u2714\ufe0f\r\n+        THROW_IF_FAILED(routines.SetConsoleOutputModeImpl(*screenInfo, ENABLE_PROCESSED_OUTPUT | DISABLE_NEWLINE_AUTO_RETURN | ENABLE_LVB_GRID_WORLDWIDE)); // DECAWM \u2716\ufe0f\r\n+        THROW_IF_FAILED(routines.SetConsoleOutputModeImpl(*screenInfo, 0)); // DECAWM \u2716\ufe0f\r\n+        THROW_IF_FAILED(routines.SetConsoleOutputModeImpl(*screenInfo, ENABLE_PROCESSED_OUTPUT | ENABLE_WRAP_AT_EOL_OUTPUT | DISABLE_NEWLINE_AUTO_RETURN | ENABLE_LVB_GRID_WORLDWIDE)); // DECAWM \u2714\ufe0f\r\n \r\n-    void ClearSelection() override\r\n-    {\r\n+        const auto expected =\r\n+            decawm(h) // DECAWM \u2714\ufe0f\r\n+            decawm(l) // DECAWM \u2716\ufe0f\r\n+            decawm(h); // DECAWM \u2714\ufe0f\r\n+        const auto actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\n \r\n-    void SelectNewRegion(const til::point /*coordStart*/, const til::point /*coordEnd*/) override\r\n+    TEST_METHOD(SetConsoleTitleW)\r\n     {\r\n-    }\r\n+        std::string_view expected;\r\n+        std::string_view actual;\r\n \r\n-    std::span<const til::point_span> GetSearchHighlights() const noexcept override\r\n-    {\r\n-        return {};\r\n-    }\r\n+        THROW_IF_FAILED(routines.SetConsoleTitleWImpl(\r\n+            L\"foobar\"));\r\n+        expected = \"\\x1b]0;foobar\\a\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-    const til::point_span* GetSearchHighlightFocused() const noexcept override\r\n-    {\r\n-        return nullptr;\r\n-    }\r\n+        THROW_IF_FAILED(routines.SetConsoleTitleWImpl(\r\n+            L\"foo\"\r\n+            \"\\u0001\\u001f\"\r\n+            \"bar\"));\r\n+        expected = \"\\x1b]0;foo\u263a\u25bcbar\\a\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-    const til::point GetSelectionAnchor() const noexcept\r\n-    {\r\n-        return {};\r\n+        THROW_IF_FAILED(routines.SetConsoleTitleWImpl(\r\n+            L\"foo\"\r\n+            \"\\u0001\\u001f\"\r\n+            \"bar\"\r\n+            \"\\u007f\\u009f\"));\r\n+        expected = \"\\x1b]0;foo\u263a\u25bcbar\u2302?\\a\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\n \r\n-    const til::point GetSelectionEnd() const noexcept\r\n+    TEST_METHOD(SetConsoleCursorInfo)\r\n     {\r\n-        return {};\r\n-    }\r\n+        THROW_IF_FAILED(routines.SetConsoleCursorInfoImpl(*screenInfo, 25, false));\r\n+        THROW_IF_FAILED(routines.SetConsoleCursorInfoImpl(*screenInfo, 25, true));\r\n \r\n-    const bool IsUiaDataInitialized() const noexcept\r\n-    {\r\n-        return true;\r\n+        const auto expected = \"\\x1b[?25l\"\r\n+                              \"\\x1b[?25h\";\r\n+        const auto actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\n \r\n-    const std::wstring GetHyperlinkUri(uint16_t /*id*/) const\r\n+    TEST_METHOD(SetConsoleTextAttribute)\r\n     {\r\n-        return {};\r\n-    }\r\n+        for (WORD i = 0; i < 16; i++)\r\n+        {\r\n+            THROW_IF_FAILED(routines.SetConsoleTextAttributeImpl(*screenInfo, i | BACKGROUND_RED));\r\n+        }\r\n \r\n-    const std::wstring GetHyperlinkCustomId(uint16_t /*id*/) const\r\n-    {\r\n-        return {};\r\n-    }\r\n+        for (WORD i = 0; i < 16; i++)\r\n+        {\r\n+            THROW_IF_FAILED(routines.SetConsoleTextAttributeImpl(*screenInfo, i << 4 | FOREGROUND_RED));\r\n+        }\r\n \r\n-    const std::vector<size_t> GetPatternId(const til::point /*location*/) const\r\n-    {\r\n-        return {};\r\n+        THROW_IF_FAILED(routines.SetConsoleTextAttributeImpl(*screenInfo, FOREGROUND_BLUE | FOREGROUND_RED | FOREGROUND_INTENSITY | BACKGROUND_GREEN | COMMON_LVB_REVERSE_VIDEO));\r\n+        THROW_IF_FAILED(routines.SetConsoleTextAttributeImpl(*screenInfo, FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED | COMMON_LVB_REVERSE_VIDEO));\r\n+\r\n+        const auto expected =\r\n+            // 16 foreground colors\r\n+            \"\\x1b[0;30;41m\"\r\n+            \"\\x1b[0;34;41m\"\r\n+            \"\\x1b[0;32;41m\"\r\n+            \"\\x1b[0;36;41m\"\r\n+            \"\\x1b[0;31;41m\"\r\n+            \"\\x1b[0;35;41m\"\r\n+            \"\\x1b[0;33;41m\"\r\n+            \"\\x1b[0;41m\" // <-- default foreground (FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED)\r\n+            \"\\x1b[0;90;41m\"\r\n+            \"\\x1b[0;94;41m\"\r\n+            \"\\x1b[0;92;41m\"\r\n+            \"\\x1b[0;96;41m\"\r\n+            \"\\x1b[0;91;41m\"\r\n+            \"\\x1b[0;95;41m\"\r\n+            \"\\x1b[0;93;41m\"\r\n+            \"\\x1b[0;97;41m\"\r\n+            // 16 background colors\r\n+            \"\\x1b[0;31m\" // <-- default background (0)\r\n+            \"\\x1b[0;31;44m\"\r\n+            \"\\x1b[0;31;42m\"\r\n+            \"\\x1b[0;31;46m\"\r\n+            \"\\x1b[0;31;41m\"\r\n+            \"\\x1b[0;31;45m\"\r\n+            \"\\x1b[0;31;43m\"\r\n+            \"\\x1b[0;31;47m\"\r\n+            \"\\x1b[0;31;100m\"\r\n+            \"\\x1b[0;31;104m\"\r\n+            \"\\x1b[0;31;102m\"\r\n+            \"\\x1b[0;31;106m\"\r\n+            \"\\x1b[0;31;101m\"\r\n+            \"\\x1b[0;31;105m\"\r\n+            \"\\x1b[0;31;103m\"\r\n+            \"\\x1b[0;31;107m\"\r\n+            // The remaining two calls\r\n+            \"\\x1b[0;7;95;42m\"\r\n+            \"\\x1b[0;7m\";\r\n+        const auto actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+    }\r\n+\r\n+    TEST_METHOD(WriteConsoleW)\r\n+    {\r\n+        resetContents();\r\n+\r\n+        size_t written;\r\n+        std::unique_ptr<IWaitRoutine> waiter;\r\n+        std::string_view expected;\r\n+        std::string_view actual;\r\n+\r\n+        THROW_IF_FAILED(routines.WriteConsoleWImpl(*screenInfo, L\"\", written, false, waiter));\r\n+        expected = \"\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Force-wrap because we write up to the last column.\r\n+        THROW_IF_FAILED(routines.WriteConsoleWImpl(*screenInfo, L\"aaaaaaaa\", written, false, waiter));\r\n+        expected = \"aaaaaaaa\\r\\n\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Force-wrap because we write up to the last column, but this time with a tab.\r\n+        THROW_IF_FAILED(routines.WriteConsoleWImpl(*screenInfo, L\"a\\t\\r\\nb\", written, false, waiter));\r\n+        expected = \"a\\t\\r\\n\\r\\nb\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+    }\r\n+\r\n+    TEST_METHOD(WriteConsoleOutputW)\r\n+    {\r\n+        resetContents();\r\n+\r\n+        std::array payload{ ci_red('a'), ci_red('b'), ci_blu('A'), ci_blu('B') };\r\n+        const auto target = Viewport::FromDimensions({ 1, 1 }, { 4, 1 });\r\n+        Viewport written;\r\n+        THROW_IF_FAILED(routines.WriteConsoleOutputWImpl(*screenInfo, payload, target, written));\r\n+\r\n+        const auto expected = decsc() cup(2, 2) sgr_red(\"ab\") sgr_blu(\"AB\") decrc();\r\n+        const auto actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+    }\r\n+\r\n+    TEST_METHOD(WriteConsoleOutputAttribute)\r\n+    {\r\n+        setupInitialContents();\r\n+\r\n+        static constexpr std::array payload{ red, blu, red, blu };\r\n+        static constexpr til::point target{ 6, 1 };\r\n+        size_t written;\r\n+        THROW_IF_FAILED(routines.WriteConsoleOutputAttributeImpl(*screenInfo, payload, target, written));\r\n+\r\n+        const auto expected =\r\n+            decsc() //\r\n+            cup(2, 7) sgr_red(\"g\") sgr_blu(\"h\") //\r\n+            cup(3, 1) sgr_red(\"i\") sgr_blu(\"j\") //\r\n+            decrc();\r\n+        const auto actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+    }\r\n+\r\n+    TEST_METHOD(WriteConsoleOutputCharacterW)\r\n+    {\r\n+        setupInitialContents();\r\n+\r\n+        size_t written = 0;\r\n+        std::string_view expected;\r\n+        std::string_view actual;\r\n+\r\n+        THROW_IF_FAILED(routines.WriteConsoleOutputCharacterWImpl(*screenInfo, L\"foobar\", { 5, 1 }, written));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(2, 6) sgr_red(\"f\") sgr_blu(\"oo\") //\r\n+            cup(3, 1) sgr_blu(\"ba\") sgr_red(\"r\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(6u, written);\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing past the end of the buffer.\r\n+        THROW_IF_FAILED(routines.WriteConsoleOutputCharacterWImpl(*screenInfo, L\"foobar\", { 5, 3 }, written));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(4, 6) sgr_blu(\"f\") sgr_red(\"oo\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(3u, written);\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing 3 wide chars while intersecting the last column.\r\n+        THROW_IF_FAILED(routines.WriteConsoleOutputCharacterWImpl(*screenInfo, L\"\u2728\u2705\u274c\", { 5, 1 }, written));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(2, 6) sgr_red(\"\u2728\") sgr_blu(\" \") //\r\n+            cup(3, 1) sgr_blu(\"\u2705\") sgr_red(\"\u274c\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(3u, written);\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+    }\r\n+\r\n+    TEST_METHOD(FillConsoleOutputAttribute)\r\n+    {\r\n+        setupInitialContents();\r\n+\r\n+        size_t cellsModified = 0;\r\n+        std::string_view expected;\r\n+        std::string_view actual;\r\n+\r\n+        // Writing nothing should produce nothing.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputAttributeImpl(*screenInfo, red, 0, {}, cellsModified));\r\n+        expected = \"\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(0u, cellsModified);\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing at the start of a line.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputAttributeImpl(*screenInfo, red, 3, { 0, 0 }, cellsModified));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(1, 1) sgr_red(\"ABa\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(3u, cellsModified);\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing at the end of a line.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputAttributeImpl(*screenInfo, red, 3, { 5, 0 }, cellsModified));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(1, 6) sgr_red(\"Dcd\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(3u, cellsModified);\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing across 2 lines.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputAttributeImpl(*screenInfo, blu, 8, { 4, 1 }, cellsModified));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(2, 5) sgr_blu(\"GHgh\") //\r\n+            cup(3, 1) sgr_blu(\"ijIJ\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(8u, cellsModified);\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+    }\r\n+\r\n+    TEST_METHOD(FillConsoleOutputCharacterW)\r\n+    {\r\n+        setupInitialContents();\r\n+\r\n+        size_t cellsModified = 0;\r\n+        std::string_view expected;\r\n+        std::string_view actual;\r\n+\r\n+        // Writing nothing should produce nothing.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputCharacterWImpl(*screenInfo, L'a', 0, {}, cellsModified));\r\n+        expected = \"\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing at the start of a line.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputCharacterWImpl(*screenInfo, L'a', 3, { 0, 0 }, cellsModified));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(1, 1) sgr_red(\"aa\") sgr_blu(\"a\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing at the end of a line.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputCharacterWImpl(*screenInfo, L'b', 3, { 5, 0 }, cellsModified));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(1, 6) sgr_red(\"b\") sgr_blu(\"bb\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing across 2 lines.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputCharacterWImpl(*screenInfo, L'c', 8, { 4, 1 }, cellsModified));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(2, 5) sgr_red(\"cc\") sgr_blu(\"cc\") //\r\n+            cup(3, 1) sgr_blu(\"cc\") sgr_red(\"cc\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Writing 3 wide chars while intersecting the last column.\r\n+        THROW_IF_FAILED(routines.FillConsoleOutputCharacterWImpl(*screenInfo, L'\u2728', 3, { 5, 1 }, cellsModified));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(2, 6) sgr_red(\"\u2728\") sgr_blu(\" \") //\r\n+            cup(3, 1) sgr_blu(\"\u2728\") sgr_red(\"\u2728\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+    }\r\n+\r\n+    TEST_METHOD(ScrollConsoleScreenBufferW)\r\n+    {\r\n+        std::string_view expected;\r\n+        std::string_view actual;\r\n+\r\n+        setupInitialContents();\r\n+\r\n+        // Scrolling from nowhere to somewhere are no-ops and should not emit anything.\r\n+        THROW_IF_FAILED(routines.ScrollConsoleScreenBufferWImpl(*screenInfo, { 0, 0, -1, -1 }, {}, std::nullopt, L' ', 0, false));\r\n+        THROW_IF_FAILED(routines.ScrollConsoleScreenBufferWImpl(*screenInfo, { -10, -10, -9, -9 }, {}, std::nullopt, L' ', 0, false));\r\n+        expected = \"\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Scrolling from somewhere to nowhere should clear the area.\r\n+        THROW_IF_FAILED(routines.ScrollConsoleScreenBufferWImpl(*screenInfo, { 0, 0, 1, 1 }, { 10, 10 }, std::nullopt, L' ', red, false));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(1, 1) sgr_red(\"  \") //\r\n+            cup(2, 1) sgr_red(\"  \") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // cmd uses ScrollConsoleScreenBuffer to clear the buffer contents and that gets translated to a clear screen sequence.\r\n+        THROW_IF_FAILED(routines.ScrollConsoleScreenBufferWImpl(*screenInfo, { 0, 0, 7, 3 }, { 0, -4 }, std::nullopt, 0, 0, true));\r\n+        expected = \"\\x1b[H\\x1b[2J\\x1b[3J\";\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        //\r\n+        //   A   B   a   b   C   D   c   d\r\n+        //\r\n+        //   E   F   e   f   G   H   g   h\r\n+        //\r\n+        //   i   j   I   J   k   l   K   L\r\n+        //\r\n+        //   m   n   M   N   o   p   O   P\r\n+        //\r\n+        setupInitialContents();\r\n+\r\n+        // Scrolling from somewhere to somewhere.\r\n+        //\r\n+        //     +-------+\r\n+        //   A | Z   Z | b   C   D   c   d\r\n+        //     |  src  |\r\n+        //   E | Z   Z | f   G   H   g   h\r\n+        //     +-------+       +-------+\r\n+        //   i   j   I   J   k | B   a | L\r\n+        //                     |  dst  |\r\n+        //   m   n   M   N   o | F   e | P\r\n+        //                     +-------+\r\n+        THROW_IF_FAILED(routines.ScrollConsoleScreenBufferWImpl(*screenInfo, { 1, 0, 2, 1 }, { 5, 2 }, std::nullopt, L'Z', red, false));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(1, 2) sgr_red(\"ZZ\") //\r\n+            cup(2, 2) sgr_red(\"ZZ\") //\r\n+            cup(3, 6) sgr_red(\"B\") sgr_blu(\"a\") //\r\n+            cup(4, 6) sgr_red(\"F\") sgr_blu(\"e\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Same, but with a partially out-of-bounds target and clip rect. Clip rects affect both\r\n+        // the source area that gets filled and the target area that gets a copy of the source contents.\r\n+        //\r\n+        //   A   Z   Z   b   C   D   c   d\r\n+        // +---+~~~~~~~~~~~~~~~~~~~~~~~+\r\n+        // | E $ z   z | f   G   H   g $ h\r\n+        // |   $ src   |           +---$-------+\r\n+        // | i $ z   z | J   k   B | E $ L     |\r\n+        // +---$-------+           |   $ dst   |\r\n+        //   m $ n   M   N   o   F | i $ P     |\r\n+        //     +~~~~~~~~~~~~~~~~~~~~~~~+-------+\r\n+        //            clip rect\r\n+        THROW_IF_FAILED(routines.ScrollConsoleScreenBufferWImpl(*screenInfo, { 0, 1, 2, 2 }, { 6, 2 }, til::inclusive_rect{ 1, 1, 6, 3 }, L'z', blu, false));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(2, 2) sgr_blu(\"zz\") //\r\n+            cup(3, 2) sgr_blu(\"zz\") //\r\n+            cup(3, 7) sgr_red(\"E\") //\r\n+            cup(4, 7) sgr_blu(\"i\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        // Same, but with a partially out-of-bounds source.\r\n+        // The boundaries of the buffer act as a clip rect for reading and so only 2 cells get copied.\r\n+        //\r\n+        //                             +-------+\r\n+        //   A   Z   Z   b   C   D   c | Y     |\r\n+        //                             |  src  |\r\n+        //   E   z   z   f   G   H   g | Y     |\r\n+        //                 +---+       +-------+\r\n+        //   i   z   z   J | d | B   E   L\r\n+        //                 |dst|\r\n+        //   m   n   M   N | h | F   i   P\r\n+        //                 +---+\r\n+        THROW_IF_FAILED(routines.ScrollConsoleScreenBufferWImpl(*screenInfo, { 7, 0, 8, 1 }, { 4, 2 }, std::nullopt, L'Y', red, false));\r\n+        expected =\r\n+            decsc() //\r\n+            cup(1, 8) sgr_red(\"Y\") //\r\n+            cup(2, 8) sgr_red(\"Y\") //\r\n+            cup(3, 5) sgr_blu(\"d\") //\r\n+            cup(4, 5) sgr_blu(\"h\") //\r\n+            decrc();\r\n+        actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n+\r\n+        static constexpr std::array<CHAR_INFO, 8 * 4> expectedContents{ {\r\n+            // clang-format off\r\n+            ci_red('A'), ci_red('Z'), ci_red('Z'), ci_blu('b'), ci_red('C'), ci_red('D'), ci_blu('c'), ci_red('Y'),\r\n+            ci_red('E'), ci_blu('z'), ci_blu('z'), ci_blu('f'), ci_red('G'), ci_red('H'), ci_blu('g'), ci_red('Y'),\r\n+            ci_blu('i'), ci_blu('z'), ci_blu('z'), ci_red('J'), ci_blu('d'), ci_red('B'), ci_red('E'), ci_red('L'),\r\n+            ci_blu('m'), ci_blu('n'), ci_red('M'), ci_red('N'), ci_blu('h'), ci_red('F'), ci_blu('i'), ci_red('P'),\r\n+            // clang-format on\r\n+        } };\r\n+        std::array<CHAR_INFO, 8 * 4> actualContents{};\r\n+        Viewport actualContentsRead;\r\n+        THROW_IF_FAILED(routines.ReadConsoleOutputWImpl(*screenInfo, actualContents, Viewport::FromDimensions({}, { 8, 4 }), actualContentsRead));\r\n+        VERIFY_IS_TRUE(memcmp(expectedContents.data(), actualContents.data(), sizeof(actualContents)) == 0);\r\n+    }\r\n+\r\n+    TEST_METHOD(SetConsoleActiveScreenBuffer)\r\n+    {\r\n+        SCREEN_INFORMATION* screenInfoAlt;\r\n+\r\n+        VERIFY_NT_SUCCESS(SCREEN_INFORMATION::CreateInstance(\r\n+            screenInfo->GetViewport().Dimensions(),\r\n+            screenInfo->GetCurrentFont(),\r\n+            screenInfo->GetBufferSize().Dimensions(),\r\n+            screenInfo->GetAttributes(),\r\n+            screenInfo->GetPopupAttributes(),\r\n+            screenInfo->GetTextBuffer().GetCursor().GetSize(),\r\n+            &screenInfoAlt));\r\n+\r\n+        routines.SetConsoleActiveScreenBufferImpl(*screenInfoAlt);\r\n+        setupInitialContents();\r\n+        THROW_IF_FAILED(routines.SetConsoleOutputModeImpl(*screenInfoAlt, ENABLE_PROCESSED_OUTPUT | ENABLE_WRAP_AT_EOL_OUTPUT | ENABLE_VIRTUAL_TERMINAL_PROCESSING));\r\n+        readOutput();\r\n+\r\n+        routines.SetConsoleActiveScreenBufferImpl(*screenInfo);\r\n+\r\n+        const auto expected =\r\n+            \"\\x1b[?1049l\" // ASB (Alternate Screen Buffer)\r\n+            cup(1, 1) sgr_red(\"AB\") sgr_blu(\"ab\") sgr_red(\"CD\") sgr_blu(\"cd\") //\r\n+            cup(2, 1) sgr_red(\"EF\") sgr_blu(\"ef\") sgr_red(\"GH\") sgr_blu(\"gh\") //\r\n+            cup(3, 1) sgr_blu(\"ij\") sgr_red(\"IJ\") sgr_blu(\"kl\") sgr_red(\"KL\") //\r\n+            cup(4, 1) sgr_blu(\"mn\") sgr_red(\"MN\") sgr_blu(\"op\") sgr_red(\"OP\") //\r\n+            cup(1, 1) sgr_rst() //\r\n+            \"\\x1b[?25h\" // DECTCEM (Text Cursor Enable)\r\n+            \"\\x1b[?7h\"; // DECAWM (Autowrap Mode)\r\n+        const auto actual = readOutput();\r\n+        VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\n };\r\n-\r\n-void VtIoTests::RendererDtorAndThread()\r\n-{\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Test deleting a Renderer a bunch of times\"));\r\n-\r\n-    for (auto i = 0; i < 16; ++i)\r\n-    {\r\n-        auto data = std::make_unique<MockRenderData>();\r\n-        auto thread = std::make_unique<Microsoft::Console::Render::RenderThread>();\r\n-        auto* pThread = thread.get();\r\n-        auto pRenderer = std::make_unique<Microsoft::Console::Render::Renderer>(RenderSettings{}, data.get(), nullptr, 0, std::move(thread));\r\n-        VERIFY_SUCCEEDED(pThread->Initialize(pRenderer.get()));\r\n-        // Sleep for a hot sec to make sure the thread starts before we enable painting\r\n-        // If you don't, the thread might wait on the paint enabled event AFTER\r\n-        // EnablePainting gets called, and if that happens, then the thread will\r\n-        // never get destructed. This will only ever happen in the vstest test runner,\r\n-        // which is what CI uses.\r\n-        /*Sleep(500);*/\r\n-\r\n-        pThread->EnablePainting();\r\n-        pRenderer->TriggerTeardown();\r\n-        pRenderer.reset();\r\n-    }\r\n-}\r\n-\r\n-void VtIoTests::BasicAnonymousPipeOpeningWithSignalChannelTest()\r\n-{\r\n-    Log::Comment(L\"Test using anonymous pipes for the input and adding a signal channel.\");\r\n-\r\n-    Log::Comment(L\"\\tcreating pipes\");\r\n-\r\n-    wil::unique_handle inPipeReadSide;\r\n-    wil::unique_handle inPipeWriteSide;\r\n-    wil::unique_handle outPipeReadSide;\r\n-    wil::unique_handle outPipeWriteSide;\r\n-    wil::unique_handle signalPipeReadSide;\r\n-    wil::unique_handle signalPipeWriteSide;\r\n-\r\n-    VERIFY_WIN32_BOOL_SUCCEEDED(CreatePipe(&inPipeReadSide, &inPipeWriteSide, nullptr, 0), L\"Create anonymous in pipe.\");\r\n-    VERIFY_WIN32_BOOL_SUCCEEDED(CreatePipe(&outPipeReadSide, &outPipeWriteSide, nullptr, 0), L\"Create anonymous out pipe.\");\r\n-    VERIFY_WIN32_BOOL_SUCCEEDED(CreatePipe(&signalPipeReadSide, &signalPipeWriteSide, nullptr, 0), L\"Create anonymous signal pipe.\");\r\n-\r\n-    Log::Comment(L\"\\tinitializing vtio\");\r\n-\r\n-    // CreateIoHandlers() assert()s on IsConsoleLocked() to guard against a race condition.\r\n-    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-    gci.LockConsole();\r\n-    const auto cleanup = wil::scope_exit([&]() {\r\n-        gci.UnlockConsole();\r\n-    });\r\n-\r\n-    VtIo vtio;\r\n-    VERIFY_IS_FALSE(vtio.IsUsingVt());\r\n-    VERIFY_ARE_EQUAL(nullptr, vtio._pPtySignalInputThread);\r\n-    VERIFY_SUCCEEDED(vtio._Initialize(inPipeReadSide.release(), outPipeWriteSide.release(), signalPipeReadSide.release()));\r\n-    VERIFY_SUCCEEDED(vtio.CreateAndStartSignalThread());\r\n-    VERIFY_SUCCEEDED(vtio.CreateIoHandlers());\r\n-    VERIFY_IS_TRUE(vtio.IsUsingVt());\r\n-    VERIFY_ARE_NOT_EQUAL(nullptr, vtio._pPtySignalInputThread);\r\n-}\r\ndiff --git a/src/host/ut_host/VtRendererTests.cpp b/src/host/ut_host/VtRendererTests.cpp\ndeleted file mode 100644\nindex 279012e71fe..00000000000\n--- a/src/host/ut_host/VtRendererTests.cpp\n+++ /dev/null\n@@ -1,1757 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-#include <wextestclass.h>\r\n-#include \"../../inc/consoletaeftemplates.hpp\"\r\n-#include \"../../types/inc/Viewport.hpp\"\r\n-\r\n-#include \"../../terminal/adapter/DispatchTypes.hpp\"\r\n-#include \"../host/RenderData.hpp\"\r\n-#include \"../../renderer/vt/Xterm256Engine.hpp\"\r\n-#include \"../../renderer/vt/XtermEngine.hpp\"\r\n-#include \"../Settings.hpp\"\r\n-\r\n-using namespace WEX::Common;\r\n-using namespace WEX::Logging;\r\n-using namespace WEX::TestExecution;\r\n-\r\n-namespace Microsoft\r\n-{\r\n-    namespace Console\r\n-    {\r\n-        namespace Render\r\n-        {\r\n-            class VtRendererTest;\r\n-        };\r\n-    };\r\n-};\r\n-using namespace Microsoft::Console;\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-using namespace Microsoft::Console::VirtualTerminal::DispatchTypes;\r\n-\r\n-static const std::string CLEAR_SCREEN = \"\\x1b[2J\";\r\n-static const std::string CURSOR_HOME = \"\\x1b[H\";\r\n-// Sometimes when we're expecting the renderengine to not write anything,\r\n-// we'll add this to the expected input, and manually write this to the callback\r\n-// to make sure nothing else gets written.\r\n-// We don't use null because that will confuse the VERIFY macros re: string length.\r\n-const char* const EMPTY_CALLBACK_SENTINEL = \"\\xff\";\r\n-\r\n-class Microsoft::Console::Render::VtRendererTest\r\n-{\r\n-    TEST_CLASS(VtRendererTest);\r\n-\r\n-    TEST_CLASS_SETUP(ClassSetup)\r\n-    {\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_CLASS_CLEANUP(ClassCleanup)\r\n-    {\r\n-        return true;\r\n-    }\r\n-\r\n-    TEST_METHOD_SETUP(MethodSetup)\r\n-    {\r\n-        qExpectedInput.clear();\r\n-        return true;\r\n-    }\r\n-\r\n-    // Defining a TEST_METHOD_CLEANUP seemed to break x86 test pass. Not sure why,\r\n-    //  something about the clipboard tests and\r\n-    //  YOU_CAN_ONLY_DESIGNATE_ONE_CLASS_METHOD_TO_BE_A_TEST_METHOD_SETUP_METHOD\r\n-    // It's probably more correct to leave it out anyways.\r\n-\r\n-    TEST_METHOD(VtSequenceHelperTests);\r\n-\r\n-    TEST_METHOD(Xterm256TestInvalidate);\r\n-    TEST_METHOD(Xterm256TestColors);\r\n-    TEST_METHOD(Xterm256TestITUColors);\r\n-    TEST_METHOD(Xterm256TestCursor);\r\n-    TEST_METHOD(Xterm256TestExtendedAttributes);\r\n-    TEST_METHOD(Xterm256TestAttributesAcrossReset);\r\n-    TEST_METHOD(Xterm256TestDoublyUnderlinedResetBeforeSettingStyle);\r\n-\r\n-    TEST_METHOD(XtermTestInvalidate);\r\n-    TEST_METHOD(XtermTestColors);\r\n-    TEST_METHOD(XtermTestCursor);\r\n-    TEST_METHOD(XtermTestAttributesAcrossReset);\r\n-\r\n-    TEST_METHOD(FormattedString);\r\n-\r\n-    TEST_METHOD(TestWrapping);\r\n-\r\n-    TEST_METHOD(TestResize);\r\n-\r\n-    TEST_METHOD(TestCursorVisibility);\r\n-\r\n-    void Test16Colors(VtEngine* engine);\r\n-\r\n-    std::deque<std::string> qExpectedInput;\r\n-    bool WriteCallback(const char* const pch, const size_t cch);\r\n-    void TestPaint(VtEngine& engine, std::function<void()> pfn);\r\n-    Viewport SetUpViewport();\r\n-\r\n-    void VerifyFirstPaint(VtEngine& engine)\r\n-    {\r\n-        // Verify the first BeginPaint emits a clear and go home\r\n-        qExpectedInput.push_back(\"\\x1b[2J\");\r\n-        // Verify the first EndPaint sets the cursor state\r\n-        qExpectedInput.push_back(\"\\x1b[?25l\");\r\n-        VERIFY_IS_TRUE(engine._firstPaint);\r\n-        TestPaint(engine, [&]() {\r\n-            VERIFY_IS_FALSE(engine._firstPaint);\r\n-        });\r\n-    }\r\n-\r\n-    void VerifyExpectedInputsDrained()\r\n-    {\r\n-        if (!qExpectedInput.empty())\r\n-        {\r\n-            for (const auto& exp : qExpectedInput)\r\n-            {\r\n-                Log::Error(NoThrowString().Format(L\"EXPECTED INPUT NEVER RECEIVED: %hs\", exp.c_str()));\r\n-            }\r\n-            VERIFY_FAIL(L\"there should be no remaining un-drained expected input\");\r\n-        }\r\n-    }\r\n-};\r\n-\r\n-Viewport VtRendererTest::SetUpViewport()\r\n-{\r\n-    til::inclusive_rect view;\r\n-    view.top = view.left = 0;\r\n-    view.bottom = 31;\r\n-    view.right = 79;\r\n-\r\n-    return Viewport::FromInclusive(view);\r\n-}\r\n-\r\n-bool VtRendererTest::WriteCallback(const char* const pch, const size_t cch)\r\n-{\r\n-    auto actualString = std::string(pch, cch);\r\n-    VERIFY_IS_GREATER_THAN(qExpectedInput.size(),\r\n-                           static_cast<size_t>(0),\r\n-                           NoThrowString().Format(L\"writing=\\\"%hs\\\", expecting %u strings\", actualString.c_str(), qExpectedInput.size()));\r\n-\r\n-    auto first = qExpectedInput.front();\r\n-    qExpectedInput.pop_front();\r\n-\r\n-    Log::Comment(NoThrowString().Format(L\"Expected =\\t\\\"%hs\\\"\", first.c_str()));\r\n-    Log::Comment(NoThrowString().Format(L\"Actual =\\t\\\"%hs\\\"\", actualString.c_str()));\r\n-\r\n-    VERIFY_ARE_EQUAL(first.length(), cch);\r\n-    VERIFY_ARE_EQUAL(first, actualString);\r\n-\r\n-    return true;\r\n-}\r\n-\r\n-// Function Description:\r\n-// - Small helper to do a series of testing wrapped by StartPaint/EndPaint calls\r\n-// Arguments:\r\n-// - engine: the engine to operate on\r\n-// - pfn: A function pointer to some test code to run.\r\n-// Return Value:\r\n-// - <none>\r\n-void VtRendererTest::TestPaint(VtEngine& engine, std::function<void()> pfn)\r\n-{\r\n-    VERIFY_SUCCEEDED(engine.StartPaint());\r\n-    pfn();\r\n-    VERIFY_SUCCEEDED(engine.EndPaint());\r\n-}\r\n-\r\n-void VtRendererTest::VtSequenceHelperTests()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[?12l\");\r\n-    VERIFY_SUCCEEDED(engine->_StopCursorBlinking());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[?12h\");\r\n-    VERIFY_SUCCEEDED(engine->_StartCursorBlinking());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[?25l\");\r\n-    VERIFY_SUCCEEDED(engine->_HideCursor());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[?25h\");\r\n-    VERIFY_SUCCEEDED(engine->_ShowCursor());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[K\");\r\n-    VERIFY_SUCCEEDED(engine->_EraseLine());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[M\");\r\n-    VERIFY_SUCCEEDED(engine->_DeleteLine(1));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[2M\");\r\n-    VERIFY_SUCCEEDED(engine->_DeleteLine(2));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[L\");\r\n-    VERIFY_SUCCEEDED(engine->_InsertLine(1));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[2L\");\r\n-    VERIFY_SUCCEEDED(engine->_InsertLine(2));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[2X\");\r\n-    VERIFY_SUCCEEDED(engine->_EraseCharacter(2));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[2;3H\");\r\n-    VERIFY_SUCCEEDED(engine->_CursorPosition({ 2, 1 }));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[1;1H\");\r\n-    VERIFY_SUCCEEDED(engine->_CursorPosition({ 0, 0 }));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[H\");\r\n-    VERIFY_SUCCEEDED(engine->_CursorHome());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[8;32;80t\");\r\n-    VERIFY_SUCCEEDED(engine->_ResizeWindow(80, 32));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[2J\");\r\n-    VERIFY_SUCCEEDED(engine->_ClearScreen());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[10C\");\r\n-    VERIFY_SUCCEEDED(engine->_CursorForward(10));\r\n-}\r\n-\r\n-void VtRendererTest::Xterm256TestInvalidate()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    const auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Make sure that invalidating all invalidates the whole viewport.\"));\r\n-    VERIFY_SUCCEEDED(engine->InvalidateAll());\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_TRUE(engine->_invalidMap.all());\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Make sure that invalidating anything only invalidates that portion\"));\r\n-    til::rect invalid = { 1, 1, 2, 2 };\r\n-    VERIFY_SUCCEEDED(engine->Invalidate(&invalid));\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_TRUE(engine->_invalidMap.one());\r\n-        VERIFY_ARE_EQUAL(invalid, *(engine->_invalidMap.begin()));\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Make sure that scrolling only invalidates part of the viewport, and sends the right sequences\"));\r\n-    til::point scrollDelta = { 0, 1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled one down, only top line is invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.bottom = 1;\r\n-\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(1u, runs.size());\r\n-        VERIFY_ARE_EQUAL(invalid, runs.front());\r\n-        qExpectedInput.push_back(\"\\x1b[H\"); // Go Home\r\n-        qExpectedInput.push_back(\"\\x1b[L\"); // insert a line\r\n-\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, 3 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled three down, only top 3 lines are invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.bottom = 3;\r\n-\r\n-        // we should have 3 runs and build a rectangle out of them\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(3u, runs.size());\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // verify the rect matches the invalid one.\r\n-        VERIFY_ARE_EQUAL(invalid, invalidRect);\r\n-        // We would expect a CUP here, but the cursor is already at the home position\r\n-        qExpectedInput.push_back(\"\\x1b[3L\"); // insert 3 lines\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, -1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled one up, only bottom line is invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.top = invalid.bottom - 1;\r\n-\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(1u, runs.size());\r\n-        VERIFY_ARE_EQUAL(invalid, runs.front());\r\n-\r\n-        qExpectedInput.push_back(\"\\x1b[32;1H\"); // Bottom of buffer\r\n-        qExpectedInput.push_back(\"\\n\"); // Scroll down once\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, -3 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled three up, only bottom 3 lines are invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.top = invalid.bottom - 3;\r\n-\r\n-        // we should have 3 runs and build a rectangle out of them\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(3u, runs.size());\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // verify the rect matches the invalid one.\r\n-        VERIFY_ARE_EQUAL(invalid, invalidRect);\r\n-\r\n-        // We would expect a CUP here, but we're already at the bottom from the last call.\r\n-        qExpectedInput.push_back(\"\\n\\n\\n\"); // Scroll down three times\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Multiple scrolls are coalesced\"));\r\n-\r\n-    scrollDelta = { 0, 1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    scrollDelta = { 0, 2 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled three down, only top 3 lines are invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.bottom = 3;\r\n-\r\n-        // we should have 3 runs and build a rectangle out of them\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(3u, runs.size());\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // verify the rect matches the invalid one.\r\n-        VERIFY_ARE_EQUAL(invalid, invalidRect);\r\n-\r\n-        qExpectedInput.push_back(\"\\x1b[H\"); // Go to home\r\n-        qExpectedInput.push_back(\"\\x1b[3L\"); // insert 3 lines\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, 1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    Log::Comment(engine->_invalidMap.to_string().c_str());\r\n-\r\n-    scrollDelta = { 0, -1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    Log::Comment(engine->_invalidMap.to_string().c_str());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[2J\");\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled one down and one up, nothing should change ----\"\r\n-            L\" But it still does for now MSFT:14169294\"));\r\n-\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // only the bottom line should be dirty.\r\n-        // When we scrolled down, the bitmap looked like this:\r\n-        // 1111\r\n-        // 0000\r\n-        // 0000\r\n-        // 0000\r\n-        // And then we scrolled up and the top line fell off and a bottom\r\n-        // line was filled in like this:\r\n-        // 0000\r\n-        // 0000\r\n-        // 0000\r\n-        // 1111\r\n-        const til::rect expected{ til::point{ view.Left(), view.BottomInclusive() }, til::size{ view.Width(), 1 } };\r\n-        VERIFY_ARE_EQUAL(expected, invalidRect);\r\n-\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::Xterm256TestColors()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-    RenderSettings renderSettings;\r\n-    RenderData renderData;\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Test changing the text attributes\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Begin by setting some test values - FG,BG = (1,2,3), (4,5,6) to start. \"\r\n-        L\"These values were picked for ease of formatting raw COLORREF values.\"));\r\n-    qExpectedInput.push_back(\"\\x1b[38;2;1;2;3m\");\r\n-    qExpectedInput.push_back(\"\\x1b[48;2;5;6;7m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({ 0x00030201, 0x00070605 },\r\n-                                                  renderSettings,\r\n-                                                  &renderData,\r\n-                                                  false,\r\n-                                                  false));\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[48;2;7;8;9m\");\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({ 0x00030201, 0x00090807 },\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[38;2;10;11;12m\");\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({ 0x000c0b0a, 0x00090807 },\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Make sure that color setting persists across EndPaint/StartPaint\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({ 0x000c0b0a, 0x00090807 },\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1); // This will make sure nothing was written to the callback\r\n-    });\r\n-\r\n-    // Now also do the body of the 16color test as well.\r\n-    // However, instead of using a closest match ANSI color, we can reproduce\r\n-    // the exact RGB or 256-color index value stored in the TextAttribute.\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Begin by setting the default colors\"));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({},\r\n-                                                  renderSettings,\r\n-                                                  &renderData,\r\n-                                                  false,\r\n-                                                  false));\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        TextAttribute textAttributes;\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG----\"));\r\n-        textAttributes.SetIndexedBackground(TextColor::DARK_RED);\r\n-        qExpectedInput.push_back(\"\\x1b[41m\"); // Background DARK_RED\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG----\"));\r\n-        textAttributes.SetIndexedForeground(TextColor::DARK_WHITE);\r\n-        qExpectedInput.push_back(\"\\x1b[37m\"); // Foreground DARK_WHITE\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG to an RGB value----\"));\r\n-        textAttributes.SetBackground(RGB(19, 161, 14));\r\n-        qExpectedInput.push_back(\"\\x1b[48;2;19;161;14m\"); // Background RGB(19,161,14)\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG to an RGB value----\"));\r\n-        textAttributes.SetForeground(RGB(193, 156, 0));\r\n-        qExpectedInput.push_back(\"\\x1b[38;2;193;156;0m\"); // Foreground RGB(193,156,0)\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG to the 'Default' background----\"));\r\n-        textAttributes.SetDefaultBackground();\r\n-        qExpectedInput.push_back(\"\\x1b[49m\"); // Background default\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG to a 256-color index----\"));\r\n-        textAttributes.SetIndexedForeground256(TextColor::DARK_WHITE);\r\n-        qExpectedInput.push_back(\"\\x1b[38;5;7m\"); // Foreground DARK_WHITE (256-Color Index)\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG to a 256-color index----\"));\r\n-        textAttributes.SetIndexedBackground256(TextColor::DARK_RED);\r\n-        qExpectedInput.push_back(\"\\x1b[48;5;1m\"); // Background DARK_RED (256-Color Index)\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG to the 'Default' foreground----\"));\r\n-        textAttributes.SetDefaultForeground();\r\n-        qExpectedInput.push_back(\"\\x1b[39m\"); // Background default\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Back to defaults----\"));\r\n-        textAttributes = {};\r\n-        qExpectedInput.push_back(\"\\x1b[m\");\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Make sure that color setting persists across EndPaint/StartPaint\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({},\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1); // This will make sure nothing was written to the callback\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::Xterm256TestITUColors()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-    RenderSettings renderSettings;\r\n-    RenderData renderData;\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Test changing the text attributes\"));\r\n-\r\n-    // Internally _lastTextAttributes starts with a fg and bg set to INVALID_COLOR(s),\r\n-    // and initializing textAttributes with the default colors will output \"\\e[39m\\e[49m\"\r\n-    // in the beginning.\r\n-    auto textAttributes = TextAttribute{};\r\n-    qExpectedInput.push_back(\"\\x1b[39m\");\r\n-    qExpectedInput.push_back(\"\\x1b[49m\");\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Begin by setting some test values - UL = (1,2,3) to start. \"\r\n-        L\"This value is picked for ease of formatting raw COLORREF values.\"));\r\n-    qExpectedInput.push_back(\"\\x1b[58:2::1:2:3m\");\r\n-    textAttributes.SetUnderlineColor(RGB(1, 2, 3));\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                  renderSettings,\r\n-                                                  &renderData,\r\n-                                                  false,\r\n-                                                  false));\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change the color----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[58:2::7:8:9m\");\r\n-        textAttributes.SetUnderlineColor(RGB(7, 8, 9));\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Make sure that color setting persists across EndPaint/StartPaint\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1); // This will make sure nothing was written to the callback\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change the UL color to a 256-color index----\"));\r\n-        textAttributes.SetUnderlineColor(TextColor{ TextColor::DARK_RED, true });\r\n-        qExpectedInput.push_back(\"\\x1b[58:5:1m\");\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        // to test the sequence for the default underline color, temporarily modify fg and bg to be something else.\r\n-        textAttributes.SetForeground(RGB(9, 10, 11));\r\n-        qExpectedInput.push_back(\"\\x1b[38;2;9;10;11m\");\r\n-        textAttributes.SetBackground(RGB(5, 6, 7));\r\n-        qExpectedInput.push_back(\"\\x1b[48;2;5;6;7m\");\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the UL color to the 'Default'----\"));\r\n-        textAttributes.SetDefaultUnderlineColor();\r\n-        qExpectedInput.push_back(\"\\x1b[59m\");\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Back to defaults (all colors)----\"));\r\n-        textAttributes = {};\r\n-        qExpectedInput.push_back(\"\\x1b[m\");\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Make sure that color setting persists across EndPaint/StartPaint\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({},\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1); // This will make sure nothing was written to the callback\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::Xterm256TestCursor()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Test moving the cursor around. Every sequence should have both params to CUP explicitly.\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        qExpectedInput.push_back(\"\\x1b[2;2H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 1, 1 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Only move Y coord----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[31;2H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 1, 30 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Only move X coord----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[29C\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 30, 30 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Sending the same move sends nothing----\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 30, 30 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----moving home sends a simple sequence----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 0 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move into the line to test some other sequences----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[7C\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 7, 0 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move down one line (x stays the same)----\"));\r\n-        qExpectedInput.push_back(\"\\n\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 7, 1 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move to the start of the next line----\"));\r\n-        qExpectedInput.push_back(\"\\r\\n\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 2 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move into the line to test some other sequences----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[2;8H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 7, 1 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move to the start of this line (y stays the same)----\"));\r\n-        qExpectedInput.push_back(\"\\r\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 1 }));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Sending the same move across paint calls sends nothing.\"\r\n-            L\"The cursor's last \\\"real\\\" position was 0,0\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 1 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Paint some text at 0,0, then try moving the cursor to where it currently is.\"));\r\n-        qExpectedInput.push_back(\"\\x1b[1C\");\r\n-        qExpectedInput.push_back(\"asdfghjkl\");\r\n-\r\n-        const auto line = L\"asdfghjkl\";\r\n-        const unsigned char rgWidths[] = { 1, 1, 1, 1, 1, 1, 1, 1, 1 };\r\n-\r\n-        std::vector<Cluster> clusters;\r\n-        for (size_t i = 0; i < wcslen(line); i++)\r\n-        {\r\n-            clusters.emplace_back(std::wstring_view{ &line[i], 1 }, static_cast<til::CoordType>(rgWidths[i]));\r\n-        }\r\n-\r\n-        VERIFY_SUCCEEDED(engine->PaintBufferLine({ clusters.data(), clusters.size() }, { 1, 1 }, false, false));\r\n-\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 10, 1 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-    });\r\n-\r\n-    // Note that only PaintBufferLine updates the \"Real\" cursor position, which\r\n-    //  the cursor is moved back to at the end of each paint\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Sending the same move across paint calls sends nothing.\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 10, 1 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::Xterm256TestExtendedAttributes()\r\n-{\r\n-    // Run this test for each and every possible combination of states.\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:faint\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:underlined\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:doublyUnderlined\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:italics\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:blink\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:invisible\", L\"{false, true}\")\r\n-        TEST_METHOD_PROPERTY(L\"Data:crossedOut\", L\"{false, true}\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    bool faint, underlined, doublyUnderlined, italics, blink, invisible, crossedOut;\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"faint\", faint));\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"underlined\", underlined));\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"doublyUnderlined\", doublyUnderlined));\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"italics\", italics));\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"blink\", blink));\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"invisible\", invisible));\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"crossedOut\", crossedOut));\r\n-\r\n-    TextAttribute desiredAttrs;\r\n-    std::vector<std::string> onSequences, offSequences;\r\n-\r\n-    // Collect up a VT sequence to set the state given the method properties\r\n-    if (faint)\r\n-    {\r\n-        desiredAttrs.SetFaint(true);\r\n-        onSequences.push_back(\"\\x1b[2m\");\r\n-        offSequences.push_back(\"\\x1b[22m\");\r\n-    }\r\n-\r\n-    // underlined and doublyUnderlined are mutually exclusive\r\n-    if (underlined)\r\n-    {\r\n-        desiredAttrs.SetUnderlineStyle(UnderlineStyle::DashedUnderlined);\r\n-        onSequences.push_back(\"\\x1b[4:5m\");\r\n-        offSequences.push_back(\"\\x1b[24m\");\r\n-    }\r\n-    else if (doublyUnderlined)\r\n-    {\r\n-        desiredAttrs.SetUnderlineStyle(UnderlineStyle::DoublyUnderlined);\r\n-        onSequences.push_back(\"\\x1b[21m\");\r\n-        offSequences.push_back(\"\\x1b[24m\");\r\n-    }\r\n-\r\n-    if (italics)\r\n-    {\r\n-        desiredAttrs.SetItalic(true);\r\n-        onSequences.push_back(\"\\x1b[3m\");\r\n-        offSequences.push_back(\"\\x1b[23m\");\r\n-    }\r\n-    if (blink)\r\n-    {\r\n-        desiredAttrs.SetBlinking(true);\r\n-        onSequences.push_back(\"\\x1b[5m\");\r\n-        offSequences.push_back(\"\\x1b[25m\");\r\n-    }\r\n-    if (invisible)\r\n-    {\r\n-        desiredAttrs.SetInvisible(true);\r\n-        onSequences.push_back(\"\\x1b[8m\");\r\n-        offSequences.push_back(\"\\x1b[28m\");\r\n-    }\r\n-    if (crossedOut)\r\n-    {\r\n-        desiredAttrs.SetCrossedOut(true);\r\n-        onSequences.push_back(\"\\x1b[9m\");\r\n-        offSequences.push_back(\"\\x1b[29m\");\r\n-    }\r\n-\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Test changing the text attributes\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"----Turn the extended attributes on----\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        // Merge the \"on\" sequences into expected input.\r\n-        std::copy(onSequences.cbegin(), onSequences.cend(), std::back_inserter(qExpectedInput));\r\n-        VERIFY_SUCCEEDED(engine->_UpdateExtendedAttrs(desiredAttrs));\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"----Turn the extended attributes off----\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        std::copy(offSequences.cbegin(), offSequences.cend(), std::back_inserter(qExpectedInput));\r\n-        VERIFY_SUCCEEDED(engine->_UpdateExtendedAttrs({}));\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"----Turn the extended attributes back on----\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        std::copy(onSequences.cbegin(), onSequences.cend(), std::back_inserter(qExpectedInput));\r\n-        VERIFY_SUCCEEDED(engine->_UpdateExtendedAttrs(desiredAttrs));\r\n-    });\r\n-\r\n-    VerifyExpectedInputsDrained();\r\n-}\r\n-\r\n-void VtRendererTest::Xterm256TestAttributesAcrossReset()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:renditionAttribute\", L\"{1, 2, 3, 4, 5, 7, 8, 9, 21, 53}\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    int renditionAttribute;\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"renditionAttribute\", renditionAttribute));\r\n-\r\n-    std::stringstream renditionSequence;\r\n-    // test underline with curly underlined\r\n-    if (renditionAttribute == 4)\r\n-    {\r\n-        renditionSequence << \"\\x1b[4:3m\";\r\n-    }\r\n-    else\r\n-    {\r\n-        renditionSequence << \"\\x1b[\" << renditionAttribute << \"m\";\r\n-    }\r\n-\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-    RenderSettings renderSettings;\r\n-    RenderData renderData;\r\n-\r\n-    Log::Comment(L\"Make sure rendition attributes are retained when colors are reset\");\r\n-\r\n-    Log::Comment(L\"----Start With All Attributes Reset----\");\r\n-    TextAttribute textAttributes = {};\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    switch (renditionAttribute)\r\n-    {\r\n-    case GraphicsOptions::Intense:\r\n-        Log::Comment(L\"----Set Intense Attribute----\");\r\n-        textAttributes.SetIntense(true);\r\n-        break;\r\n-    case GraphicsOptions::RGBColorOrFaint:\r\n-        Log::Comment(L\"----Set Faint Attribute----\");\r\n-        textAttributes.SetFaint(true);\r\n-        break;\r\n-    case GraphicsOptions::Italics:\r\n-        Log::Comment(L\"----Set Italics Attribute----\");\r\n-        textAttributes.SetItalic(true);\r\n-        break;\r\n-    case GraphicsOptions::Underline:\r\n-        Log::Comment(L\"----Set Underline Attribute----\");\r\n-        textAttributes.SetUnderlineStyle(UnderlineStyle::CurlyUnderlined);\r\n-        break;\r\n-    case GraphicsOptions::DoublyUnderlined:\r\n-        Log::Comment(L\"----Set Doubly Underlined Attribute----\");\r\n-        textAttributes.SetUnderlineStyle(UnderlineStyle::DoublyUnderlined);\r\n-        break;\r\n-    case GraphicsOptions::Overline:\r\n-        Log::Comment(L\"----Set Overline Attribute----\");\r\n-        textAttributes.SetOverlined(true);\r\n-        break;\r\n-    case GraphicsOptions::BlinkOrXterm256Index:\r\n-        Log::Comment(L\"----Set Blink Attribute----\");\r\n-        textAttributes.SetBlinking(true);\r\n-        break;\r\n-    case GraphicsOptions::Negative:\r\n-        Log::Comment(L\"----Set Negative Attribute----\");\r\n-        textAttributes.SetReverseVideo(true);\r\n-        break;\r\n-    case GraphicsOptions::Invisible:\r\n-        Log::Comment(L\"----Set Invisible Attribute----\");\r\n-        textAttributes.SetInvisible(true);\r\n-        break;\r\n-    case GraphicsOptions::CrossedOut:\r\n-        Log::Comment(L\"----Set Crossed Out Attribute----\");\r\n-        textAttributes.SetCrossedOut(true);\r\n-        break;\r\n-    }\r\n-    qExpectedInput.push_back(renditionSequence.str());\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Set Green Foreground----\");\r\n-    textAttributes.SetIndexedForeground(TextColor::DARK_GREEN);\r\n-    qExpectedInput.push_back(\"\\x1b[32m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Reset Default Foreground and Retain Rendition----\");\r\n-    textAttributes.SetDefaultForeground();\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    qExpectedInput.push_back(renditionSequence.str());\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Set Green Background----\");\r\n-    textAttributes.SetIndexedBackground(TextColor::DARK_GREEN);\r\n-    qExpectedInput.push_back(\"\\x1b[42m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Reset Default Background and Retain Rendition----\");\r\n-    textAttributes.SetDefaultBackground();\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    qExpectedInput.push_back(renditionSequence.str());\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    VerifyExpectedInputsDrained();\r\n-}\r\n-\r\n-void VtRendererTest::Xterm256TestDoublyUnderlinedResetBeforeSettingStyle()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto attrs = TextAttribute{};\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"----Testing Doubly underlined is properly reset before applying the new underline style----\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"----Set Doubly Underlined----\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        attrs.SetUnderlineStyle(UnderlineStyle::DoublyUnderlined);\r\n-        qExpectedInput.push_back(\"\\x1b[21m\");\r\n-        VERIFY_SUCCEEDED(engine->_UpdateExtendedAttrs(attrs));\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"----Set Underline To Any Other Style----\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        attrs.SetUnderlineStyle(UnderlineStyle::CurlyUnderlined);\r\n-        qExpectedInput.push_back(\"\\x1b[24m\");\r\n-        qExpectedInput.push_back(\"\\x1b[4:3m\");\r\n-        VERIFY_SUCCEEDED(engine->_UpdateExtendedAttrs(attrs));\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"----Remove The Underline----\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        attrs.SetUnderlineStyle(UnderlineStyle::NoUnderline);\r\n-        qExpectedInput.push_back(\"\\x1b[24m\");\r\n-        VERIFY_SUCCEEDED(engine->_UpdateExtendedAttrs(attrs));\r\n-    });\r\n-\r\n-    VerifyExpectedInputsDrained();\r\n-}\r\n-\r\n-void VtRendererTest::XtermTestInvalidate()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<XtermEngine>(std::move(hFile), SetUpViewport(), false);\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Make sure that invalidating all invalidates the whole viewport.\"));\r\n-    VERIFY_SUCCEEDED(engine->InvalidateAll());\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_TRUE(engine->_invalidMap.all());\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Make sure that invalidating anything only invalidates that portion\"));\r\n-    til::rect invalid = { 1, 1, 2, 2 };\r\n-    VERIFY_SUCCEEDED(engine->Invalidate(&invalid));\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_TRUE(engine->_invalidMap.one());\r\n-        VERIFY_ARE_EQUAL(invalid, *(engine->_invalidMap.begin()));\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Make sure that scrolling only invalidates part of the viewport, and sends the right sequences\"));\r\n-    til::point scrollDelta = { 0, 1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled one down, only top line is invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.bottom = 1;\r\n-\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(1u, runs.size());\r\n-        VERIFY_ARE_EQUAL(invalid, runs.front());\r\n-\r\n-        qExpectedInput.push_back(\"\\x1b[H\"); // Go Home\r\n-        qExpectedInput.push_back(\"\\x1b[L\"); // insert a line\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, 3 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled three down, only top 3 lines are invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.bottom = 3;\r\n-\r\n-        // we should have 3 runs and build a rectangle out of them\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(3u, runs.size());\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // verify the rect matches the invalid one.\r\n-        VERIFY_ARE_EQUAL(invalid, invalidRect);\r\n-        // We would expect a CUP here, but the cursor is already at the home position\r\n-        qExpectedInput.push_back(\"\\x1b[3L\"); // insert 3 lines\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, -1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled one up, only bottom line is invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.top = invalid.bottom - 1;\r\n-\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(1u, runs.size());\r\n-        VERIFY_ARE_EQUAL(invalid, runs.front());\r\n-\r\n-        qExpectedInput.push_back(\"\\x1b[32;1H\"); // Bottom of buffer\r\n-        qExpectedInput.push_back(\"\\n\"); // Scroll down once\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, -3 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled three up, only bottom 3 lines are invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.top = invalid.bottom - 3;\r\n-\r\n-        // we should have 3 runs and build a rectangle out of them\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(3u, runs.size());\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // verify the rect matches the invalid one.\r\n-        VERIFY_ARE_EQUAL(invalid, invalidRect);\r\n-\r\n-        // We would expect a CUP here, but we're already at the bottom from the last call.\r\n-        qExpectedInput.push_back(\"\\n\\n\\n\"); // Scroll down three times\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Multiple scrolls are coalesced\"));\r\n-\r\n-    scrollDelta = { 0, 1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    scrollDelta = { 0, 2 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled three down, only top 3 lines are invalid. ----\"));\r\n-        invalid = view.ToExclusive();\r\n-        invalid.bottom = 3;\r\n-\r\n-        // we should have 3 runs and build a rectangle out of them\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        VERIFY_ARE_EQUAL(3u, runs.size());\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // verify the rect matches the invalid one.\r\n-        VERIFY_ARE_EQUAL(invalid, invalidRect);\r\n-\r\n-        qExpectedInput.push_back(\"\\x1b[H\"); // Go to home\r\n-        qExpectedInput.push_back(\"\\x1b[3L\"); // insert 3 lines\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-\r\n-    scrollDelta = { 0, 1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    Log::Comment(engine->_invalidMap.to_string().c_str());\r\n-\r\n-    scrollDelta = { 0, -1 };\r\n-    VERIFY_SUCCEEDED(engine->InvalidateScroll(&scrollDelta));\r\n-    Log::Comment(engine->_invalidMap.to_string().c_str());\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[2J\");\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"---- Scrolled one down and one up, nothing should change ----\"\r\n-            L\" But it still does for now MSFT:14169294\"));\r\n-\r\n-        const auto runs = engine->_invalidMap.runs();\r\n-        auto invalidRect = runs.front();\r\n-        for (size_t i = 1; i < runs.size(); ++i)\r\n-        {\r\n-            invalidRect |= runs[i];\r\n-        }\r\n-\r\n-        // only the bottom line should be dirty.\r\n-        // When we scrolled down, the bitmap looked like this:\r\n-        // 1111\r\n-        // 0000\r\n-        // 0000\r\n-        // 0000\r\n-        // And then we scrolled up and the top line fell off and a bottom\r\n-        // line was filled in like this:\r\n-        // 0000\r\n-        // 0000\r\n-        // 0000\r\n-        // 1111\r\n-        const til::rect expected{ til::point{ view.Left(), view.BottomInclusive() }, til::size{ view.Width(), 1 } };\r\n-        VERIFY_ARE_EQUAL(expected, invalidRect);\r\n-\r\n-        VERIFY_SUCCEEDED(engine->ScrollFrame());\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::XtermTestColors()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<XtermEngine>(std::move(hFile), SetUpViewport(), false);\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-    RenderSettings renderSettings;\r\n-    RenderData renderData;\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Test changing the text attributes\"));\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Begin by setting the default colors\"));\r\n-\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({},\r\n-                                                  renderSettings,\r\n-                                                  &renderData,\r\n-                                                  false,\r\n-                                                  false));\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        TextAttribute textAttributes;\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG----\"));\r\n-        textAttributes.SetIndexedBackground(TextColor::DARK_RED);\r\n-        qExpectedInput.push_back(\"\\x1b[41m\"); // Background DARK_RED\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG----\"));\r\n-        textAttributes.SetIndexedForeground(TextColor::DARK_WHITE);\r\n-        qExpectedInput.push_back(\"\\x1b[37m\"); // Foreground DARK_WHITE\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG to an RGB value----\"));\r\n-        textAttributes.SetBackground(RGB(19, 161, 14));\r\n-        qExpectedInput.push_back(\"\\x1b[42m\"); // Background DARK_GREEN\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG to an RGB value----\"));\r\n-        textAttributes.SetForeground(RGB(193, 156, 0));\r\n-        qExpectedInput.push_back(\"\\x1b[33m\"); // Foreground DARK_YELLOW\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG to the 'Default' background----\"));\r\n-        textAttributes.SetDefaultBackground();\r\n-        qExpectedInput.push_back(\"\\x1b[m\"); // Both foreground and background default\r\n-        qExpectedInput.push_back(\"\\x1b[33m\"); // Reapply foreground DARK_YELLOW\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG to a 256-color index----\"));\r\n-        textAttributes.SetIndexedForeground256(TextColor::DARK_WHITE);\r\n-        qExpectedInput.push_back(\"\\x1b[37m\"); // Foreground DARK_WHITE\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the BG to a 256-color index----\"));\r\n-        textAttributes.SetIndexedBackground256(TextColor::DARK_RED);\r\n-        qExpectedInput.push_back(\"\\x1b[41m\"); // Background DARK_RED\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Change only the FG to the 'Default' foreground----\"));\r\n-        textAttributes.SetDefaultForeground();\r\n-        qExpectedInput.push_back(\"\\x1b[m\"); // Both foreground and background default\r\n-        qExpectedInput.push_back(\"\\x1b[41m\"); // Reapply background DARK_RED\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Back to defaults----\"));\r\n-        textAttributes = {};\r\n-        qExpectedInput.push_back(\"\\x1b[m\");\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes,\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Make sure that color setting persists across EndPaint/StartPaint\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes({},\r\n-                                                      renderSettings,\r\n-                                                      &renderData,\r\n-                                                      false,\r\n-                                                      false));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1); // This will make sure nothing was written to the callback\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::XtermTestCursor()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<XtermEngine>(std::move(hFile), SetUpViewport(), false);\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    Log::Comment(NoThrowString().Format(\r\n-        L\"Test moving the cursor around. Every sequence should have both params to CUP explicitly.\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        qExpectedInput.push_back(\"\\x1b[2;2H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 1, 1 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Only move Y coord----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[31;2H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 1, 30 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Only move X coord----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[29C\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 30, 30 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----Sending the same move sends nothing----\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 30, 30 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----moving home sends a simple sequence----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 0 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move into the line to test some other sequences----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[7C\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 7, 0 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move down one line (x stays the same)----\"));\r\n-        qExpectedInput.push_back(\"\\n\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 7, 1 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move to the start of the next line----\"));\r\n-        qExpectedInput.push_back(\"\\r\\n\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 2 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move into the line to test some other sequences----\"));\r\n-        qExpectedInput.push_back(\"\\x1b[2;8H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 7, 1 }));\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"----move to the start of this line (y stays the same)----\"));\r\n-        qExpectedInput.push_back(\"\\r\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 1 }));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Sending the same move across paint calls sends nothing.\"\r\n-            L\"The cursor's last \\\"real\\\" position was 0,0\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 1 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Paint some text at 0,0, then try moving the cursor to where it currently is.\"));\r\n-        qExpectedInput.push_back(\"\\x1b[1C\");\r\n-        qExpectedInput.push_back(\"asdfghjkl\");\r\n-\r\n-        const auto line = L\"asdfghjkl\";\r\n-        const unsigned char rgWidths[] = { 1, 1, 1, 1, 1, 1, 1, 1, 1 };\r\n-\r\n-        std::vector<Cluster> clusters;\r\n-        for (size_t i = 0; i < wcslen(line); i++)\r\n-        {\r\n-            clusters.emplace_back(std::wstring_view{ &line[i], 1 }, static_cast<til::CoordType>(rgWidths[i]));\r\n-        }\r\n-\r\n-        VERIFY_SUCCEEDED(engine->PaintBufferLine({ clusters.data(), clusters.size() }, { 1, 1 }, false, false));\r\n-\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 10, 1 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-    });\r\n-\r\n-    // Note that only PaintBufferLine updates the \"Real\" cursor position, which\r\n-    //  the cursor is moved back to at the end of each paint\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Sending the same move across paint calls sends nothing.\"));\r\n-        qExpectedInput.push_back(EMPTY_CALLBACK_SENTINEL);\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 10, 1 }));\r\n-        WriteCallback(EMPTY_CALLBACK_SENTINEL, 1);\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::XtermTestAttributesAcrossReset()\r\n-{\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"Data:renditionAttribute\", L\"{1, 4, 7}\")\r\n-    END_TEST_METHOD_PROPERTIES()\r\n-\r\n-    int renditionAttribute;\r\n-    VERIFY_SUCCEEDED(TestData::TryGetValue(L\"renditionAttribute\", renditionAttribute));\r\n-\r\n-    std::stringstream renditionSequence;\r\n-    renditionSequence << \"\\x1b[\" << renditionAttribute << \"m\";\r\n-\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<XtermEngine>(std::move(hFile), SetUpViewport(), false);\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-    RenderSettings renderSettings;\r\n-    RenderData renderData;\r\n-\r\n-    Log::Comment(L\"Make sure rendition attributes are retained when colors are reset\");\r\n-\r\n-    Log::Comment(L\"----Start With All Attributes Reset----\");\r\n-    TextAttribute textAttributes = {};\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    switch (renditionAttribute)\r\n-    {\r\n-    case GraphicsOptions::Intense:\r\n-        Log::Comment(L\"----Set Intense Attribute----\");\r\n-        textAttributes.SetIntense(true);\r\n-        break;\r\n-    case GraphicsOptions::Underline:\r\n-        Log::Comment(L\"----Set Underline Attribute----\");\r\n-        textAttributes.SetUnderlineStyle(UnderlineStyle::SinglyUnderlined);\r\n-        break;\r\n-    case GraphicsOptions::Negative:\r\n-        Log::Comment(L\"----Set Negative Attribute----\");\r\n-        textAttributes.SetReverseVideo(true);\r\n-        break;\r\n-    }\r\n-    qExpectedInput.push_back(renditionSequence.str());\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Set Green Foreground----\");\r\n-    textAttributes.SetIndexedForeground(TextColor::DARK_GREEN);\r\n-    qExpectedInput.push_back(\"\\x1b[32m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Reset Default Foreground and Retain Rendition----\");\r\n-    textAttributes.SetDefaultForeground();\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    qExpectedInput.push_back(renditionSequence.str());\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Set Green Background----\");\r\n-    textAttributes.SetIndexedBackground(TextColor::DARK_GREEN);\r\n-    qExpectedInput.push_back(\"\\x1b[42m\");\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    Log::Comment(L\"----Reset Default Background and Retain Rendition----\");\r\n-    textAttributes.SetDefaultBackground();\r\n-    qExpectedInput.push_back(\"\\x1b[m\");\r\n-    qExpectedInput.push_back(renditionSequence.str());\r\n-    VERIFY_SUCCEEDED(engine->UpdateDrawingBrushes(textAttributes, renderSettings, &renderData, false, false));\r\n-\r\n-    VerifyExpectedInputsDrained();\r\n-}\r\n-\r\n-void VtRendererTest::TestWrapping()\r\n-{\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), SetUpViewport());\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    VerifyFirstPaint(*engine);\r\n-\r\n-    auto view = SetUpViewport();\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Make sure the cursor is at 0,0\"));\r\n-        qExpectedInput.push_back(\"\\x1b[H\");\r\n-        VERIFY_SUCCEEDED(engine->_MoveCursor({ 0, 0 }));\r\n-    });\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        Log::Comment(NoThrowString().Format(\r\n-            L\"Painting a line that wrapped, then painting another line, and \"\r\n-            L\"making sure we don't manually move the cursor between those paints.\"));\r\n-        qExpectedInput.push_back(\"asdfghjkl\");\r\n-        // TODO: Undoing this behavior due to 18123777. Will come back in MSFT:16485846\r\n-        qExpectedInput.push_back(\"\\r\\n\");\r\n-        qExpectedInput.push_back(\"zxcvbnm,.\");\r\n-\r\n-        const auto line1 = L\"asdfghjkl\";\r\n-        const auto line2 = L\"zxcvbnm,.\";\r\n-        const unsigned char rgWidths[] = { 1, 1, 1, 1, 1, 1, 1, 1, 1 };\r\n-\r\n-        std::vector<Cluster> clusters1;\r\n-        for (size_t i = 0; i < wcslen(line1); i++)\r\n-        {\r\n-            clusters1.emplace_back(std::wstring_view{ &line1[i], 1 }, static_cast<til::CoordType>(rgWidths[i]));\r\n-        }\r\n-        std::vector<Cluster> clusters2;\r\n-        for (size_t i = 0; i < wcslen(line2); i++)\r\n-        {\r\n-            clusters2.emplace_back(std::wstring_view{ &line2[i], 1 }, static_cast<til::CoordType>(rgWidths[i]));\r\n-        }\r\n-\r\n-        VERIFY_SUCCEEDED(engine->PaintBufferLine({ clusters1.data(), clusters1.size() }, { 0, 0 }, false, false));\r\n-        VERIFY_SUCCEEDED(engine->PaintBufferLine({ clusters2.data(), clusters2.size() }, { 0, 1 }, false, false));\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::TestResize()\r\n-{\r\n-    auto view = SetUpViewport();\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), view);\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    // Verify the first BeginPaint emits a clear and go home\r\n-    qExpectedInput.push_back(\"\\x1b[2J\");\r\n-    // Verify the first EndPaint sets the cursor state\r\n-    qExpectedInput.push_back(\"\\x1b[?25l\");\r\n-    VERIFY_IS_TRUE(engine->_firstPaint);\r\n-    VERIFY_IS_TRUE(engine->_suppressResizeRepaint);\r\n-\r\n-    // The renderer (in Renderer@_PaintFrameForEngine..._CheckViewportAndScroll)\r\n-    //      will manually call UpdateViewport once before actually painting the\r\n-    //      first frame. Replicate that behavior here\r\n-    VERIFY_SUCCEEDED(engine->UpdateViewport(view.ToInclusive()));\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_FALSE(engine->_firstPaint);\r\n-        VERIFY_IS_FALSE(engine->_suppressResizeRepaint);\r\n-    });\r\n-\r\n-    // Resize the viewport to 120x30\r\n-    // Everything should be invalidated, and a resize message sent.\r\n-    const auto newView = Viewport::FromDimensions({ 0, 0 }, { 120, 30 });\r\n-    qExpectedInput.push_back(\"\\x1b[8;30;120t\");\r\n-\r\n-    VERIFY_SUCCEEDED(engine->UpdateViewport(newView.ToInclusive()));\r\n-\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_TRUE(engine->_invalidMap.all());\r\n-        VERIFY_IS_FALSE(engine->_firstPaint);\r\n-        VERIFY_IS_FALSE(engine->_suppressResizeRepaint);\r\n-    });\r\n-}\r\n-\r\n-void VtRendererTest::TestCursorVisibility()\r\n-{\r\n-    auto view = SetUpViewport();\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), view);\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    til::point origin{ 0, 0 };\r\n-\r\n-    VERIFY_ARE_NOT_EQUAL(origin, engine->_lastText);\r\n-\r\n-    CursorOptions options{};\r\n-    options.coordCursor = origin;\r\n-\r\n-    // Frame 1: Paint the cursor at the home position. At the end of the frame,\r\n-    // the cursor should be on. Because we're moving the cursor with CUP, we\r\n-    // need to disable the cursor during this frame.\r\n-    qExpectedInput.push_back(\"\\x1b[2J\");\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_FALSE(engine->_nextCursorIsVisible);\r\n-        VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-\r\n-        Log::Comment(NoThrowString().Format(L\"Make sure the cursor is at 0,0\"));\r\n-        qExpectedInput.push_back(\"\\x1b[H\");\r\n-        VERIFY_SUCCEEDED(engine->PaintCursor(options));\r\n-\r\n-        VERIFY_IS_TRUE(engine->_nextCursorIsVisible);\r\n-        VERIFY_IS_TRUE(engine->_needToDisableCursor);\r\n-\r\n-        // GH#12401:\r\n-        // The other tests verify that the cursor is explicitly hidden on the\r\n-        // first frame (VerifyFirstPaint). This test on the other hand does\r\n-        // the opposite by calling PaintCursor() during the first paint cycle.\r\n-        qExpectedInput.push_back(\"\\x1b[?25h\");\r\n-    });\r\n-\r\n-    VERIFY_IS_TRUE(engine->_nextCursorIsVisible);\r\n-    VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-\r\n-    // Frame 2: Paint the cursor again at the home position. At the end of the\r\n-    // frame, the cursor should be on, the same as before. We aren't moving the\r\n-    // cursor during this frame, so _needToDisableCursor will stay false.\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_FALSE(engine->_nextCursorIsVisible);\r\n-        VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-\r\n-        Log::Comment(NoThrowString().Format(L\"If we just paint the cursor again at the same position, the cursor should not need to be disabled\"));\r\n-        VERIFY_SUCCEEDED(engine->PaintCursor(options));\r\n-\r\n-        VERIFY_IS_TRUE(engine->_nextCursorIsVisible);\r\n-        VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-    });\r\n-\r\n-    VERIFY_IS_TRUE(engine->_nextCursorIsVisible);\r\n-    VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-\r\n-    // Frame 3: Paint the cursor at 2,2. At the end of the frame, the cursor\r\n-    // should be on, the same as before. Because we're moving the cursor with\r\n-    // CUP, we need to disable the cursor during this frame.\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_FALSE(engine->_nextCursorIsVisible);\r\n-        VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-\r\n-        Log::Comment(NoThrowString().Format(L\"Move the cursor to 2,2\"));\r\n-        qExpectedInput.push_back(\"\\x1b[3;3H\");\r\n-\r\n-        options.coordCursor = { 2, 2 };\r\n-\r\n-        VERIFY_SUCCEEDED(engine->PaintCursor(options));\r\n-\r\n-        VERIFY_IS_TRUE(engine->_nextCursorIsVisible);\r\n-        VERIFY_IS_TRUE(engine->_needToDisableCursor);\r\n-\r\n-        // Because _needToDisableCursor is true, we'll insert a ?25l at the\r\n-        // start of the frame. Unfortunately, we can't test to make sure that\r\n-        // it's there, but we can ensure that the matching ?25h is printed:\r\n-        qExpectedInput.push_back(\"\\x1b[?25h\");\r\n-    });\r\n-\r\n-    VERIFY_IS_TRUE(engine->_nextCursorIsVisible);\r\n-    VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-\r\n-    // Frame 4: Don't paint the cursor. At the end of the frame, the cursor\r\n-    // should be off.\r\n-    Log::Comment(NoThrowString().Format(L\"Painting without calling PaintCursor will hide the cursor\"));\r\n-    TestPaint(*engine, [&]() {\r\n-        VERIFY_IS_FALSE(engine->_nextCursorIsVisible);\r\n-        VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-\r\n-        qExpectedInput.push_back(\"\\x1b[?25l\");\r\n-    });\r\n-\r\n-    VERIFY_IS_FALSE(engine->_nextCursorIsVisible);\r\n-    VERIFY_IS_FALSE(engine->_needToDisableCursor);\r\n-}\r\n-\r\n-void VtRendererTest::FormattedString()\r\n-{\r\n-    // This test works with a static cache variable that\r\n-    // can be affected by other tests\r\n-    BEGIN_TEST_METHOD_PROPERTIES()\r\n-        TEST_METHOD_PROPERTY(L\"IsolationLevel\", L\"Method\")\r\n-    END_TEST_METHOD_PROPERTIES();\r\n-\r\n-    static const auto format = FMT_COMPILE(\"\\x1b[{}m\");\r\n-    const auto value = 12;\r\n-\r\n-    auto view = SetUpViewport();\r\n-    auto hFile = wil::unique_hfile(INVALID_HANDLE_VALUE);\r\n-    auto engine = std::make_unique<Xterm256Engine>(std::move(hFile), view);\r\n-    auto pfn = std::bind(&VtRendererTest::WriteCallback, this, std::placeholders::_1, std::placeholders::_2);\r\n-    engine->SetTestCallback(pfn);\r\n-\r\n-    Log::Comment(L\"1.) Write it once. It should resize itself.\");\r\n-    qExpectedInput.push_back(\"\\x1b[12m\");\r\n-    VERIFY_SUCCEEDED(engine->_WriteFormatted(format, value));\r\n-\r\n-    Log::Comment(L\"2.) Write the same thing again, should be fine.\");\r\n-    qExpectedInput.push_back(\"\\x1b[12m\");\r\n-    VERIFY_SUCCEEDED(engine->_WriteFormatted(format, value));\r\n-\r\n-    Log::Comment(L\"3.) Now write something huge. Should resize itself and still be fine.\");\r\n-    static const auto bigFormat = FMT_COMPILE(\"\\x1b[28;3;{};{};{}m\");\r\n-    const auto bigValue = 500;\r\n-    qExpectedInput.push_back(\"\\x1b[28;3;500;500;500m\");\r\n-    VERIFY_SUCCEEDED(engine->_WriteFormatted(bigFormat, bigValue, bigValue, bigValue));\r\n-}\r\ndiff --git a/src/host/ut_host/sources b/src/host/ut_host/sources\nindex 799bb24a949..bb87492fd19 100644\n--- a/src/host/ut_host/sources\n+++ b/src/host/ut_host/sources\n@@ -31,8 +31,6 @@ SOURCES = \\\n     TitleTests.cpp \\\r\n     InputBufferTests.cpp \\\r\n     VtIoTests.cpp \\\r\n-    VtRendererTests.cpp \\\r\n-    ConptyOutputTests.cpp \\\r\n     ViewportTests.cpp \\\r\n     ConsoleArgumentsTests.cpp \\\r\n     ObjectTests.cpp \\\r\ndiff --git a/src/inc/LibraryIncludes.h b/src/inc/LibraryIncludes.h\nindex 4dc9f6b21e8..41b74ccab93 100644\n--- a/src/inc/LibraryIncludes.h\n+++ b/src/inc/LibraryIncludes.h\n@@ -82,16 +82,6 @@\n #define ENABLE_INTSAFE_SIGNED_FUNCTIONS\r\n #include <intsafe.h>\r\n \r\n-// LibPopCnt - Fast C/C++ bit population count library (on bits in an array)\r\n-#include <libpopcnt.h>\r\n-\r\n-// Dynamic Bitset (optional dependency on LibPopCnt for perf at bit counting)\r\n-// Variable-size compressed-storage header-only bit flag storage library.\r\n-#pragma warning(push)\r\n-#pragma warning(disable:4702) // unreachable code\r\n-#include <dynamic_bitset.hpp>\r\n-#pragma warning(pop)\r\n-\r\n // {fmt}, a C++20-compatible formatting library\r\n #include <fmt/format.h>\r\n #include <fmt/compile.h>\r\ndiff --git a/src/inc/conpty-static.h b/src/inc/conpty-static.h\nindex d05ab56e8d3..875470b1575 100644\n--- a/src/inc/conpty-static.h\n+++ b/src/inc/conpty-static.h\n@@ -27,9 +27,6 @@\n #ifndef PSEUDOCONSOLE_INHERIT_CURSOR\r\n #define PSEUDOCONSOLE_INHERIT_CURSOR (0x1)\r\n #endif\r\n-#ifndef PSEUDOCONSOLE_RESIZE_QUIRK\r\n-#define PSEUDOCONSOLE_RESIZE_QUIRK (0x2)\r\n-#endif\r\n #ifndef PSEUDOCONSOLE_GLYPH_WIDTH__MASK\r\n #define PSEUDOCONSOLE_GLYPH_WIDTH__MASK 0x18\r\n #define PSEUDOCONSOLE_GLYPH_WIDTH_GRAPHEMES 0x08\r\ndiff --git a/src/inc/til.h b/src/inc/til.h\nindex eb781634fe2..dd60656a90f 100644\n--- a/src/inc/til.h\n+++ b/src/inc/til.h\n@@ -15,11 +15,11 @@\n #define _TIL_INLINEPREFIX __declspec(noinline) inline\r\n \r\n #include \"til/at.h\"\r\n-#include \"til/bitmap.h\"\r\n #include \"til/coalesce.h\"\r\n #include \"til/color.h\"\r\n #include \"til/enumset.h\"\r\n #include \"til/pmr.h\"\r\n+#include \"til/rect.h\"\r\n #include \"til/string.h\"\r\n #include \"til/type_traits.h\"\r\n #include \"til/u8u16convert.h\"\r\ndiff --git a/src/inc/til/bitmap.h b/src/inc/til/bitmap.h\ndeleted file mode 100644\nindex 686369ade95..00000000000\n--- a/src/inc/til/bitmap.h\n+++ /dev/null\n@@ -1,593 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#pragma once\r\n-\r\n-#include \"rect.h\"\r\n-\r\n-#ifdef UNIT_TESTING\r\n-class BitmapTests;\r\n-#endif\r\n-\r\n-namespace til // Terminal Implementation Library. Also: \"Today I Learned\"\r\n-{\r\n-    namespace details\r\n-    {\r\n-        template<typename Allocator>\r\n-        class _bitmap_const_iterator\r\n-        {\r\n-        public:\r\n-            using iterator_category = std::input_iterator_tag;\r\n-            using value_type = const til::rect;\r\n-            using difference_type = ptrdiff_t;\r\n-            using pointer = const til::rect*;\r\n-            using reference = const til::rect&;\r\n-\r\n-            _bitmap_const_iterator(const dynamic_bitset<size_t, Allocator>& values, til::rect rc, ptrdiff_t pos) :\r\n-                _values(values),\r\n-                _rc(rc),\r\n-                _pos(pos),\r\n-                _end(rc.size().area())\r\n-            {\r\n-                _calculateArea();\r\n-            }\r\n-\r\n-            _bitmap_const_iterator& operator++()\r\n-            {\r\n-                _pos = _nextPos;\r\n-                _calculateArea();\r\n-                return (*this);\r\n-            }\r\n-\r\n-            _bitmap_const_iterator operator++(int)\r\n-            {\r\n-                const auto prev = *this;\r\n-                ++*this;\r\n-                return prev;\r\n-            }\r\n-\r\n-            constexpr bool operator==(const _bitmap_const_iterator& other) const noexcept\r\n-            {\r\n-                return _pos == other._pos && _values == other._values;\r\n-            }\r\n-\r\n-            constexpr bool operator!=(const _bitmap_const_iterator& other) const noexcept\r\n-            {\r\n-                return !(*this == other);\r\n-            }\r\n-\r\n-            constexpr bool operator<(const _bitmap_const_iterator& other) const noexcept\r\n-            {\r\n-                return _pos < other._pos;\r\n-            }\r\n-\r\n-            constexpr bool operator>(const _bitmap_const_iterator& other) const noexcept\r\n-            {\r\n-                return _pos > other._pos;\r\n-            }\r\n-\r\n-            constexpr reference operator*() const noexcept\r\n-            {\r\n-                return _run;\r\n-            }\r\n-\r\n-            constexpr pointer operator->() const noexcept\r\n-            {\r\n-                return &_run;\r\n-            }\r\n-\r\n-        private:\r\n-            const dynamic_bitset<size_t, Allocator>& _values;\r\n-            const til::rect _rc;\r\n-            size_t _pos;\r\n-            size_t _nextPos;\r\n-            const size_t _end;\r\n-            til::rect _run;\r\n-\r\n-            // Update _run to contain the next rectangle of consecutively set bits within this bitmap.\r\n-            // _calculateArea may be called repeatedly to yield all those rectangles.\r\n-            void _calculateArea()\r\n-            {\r\n-                // The following logic first finds the next set bit in this bitmap and the next unset bit past that.\r\n-                // The area in between those positions are thus all set bits and will end up being the next _run.\r\n-\r\n-                // dynamic_bitset allows you to quickly find the next set bit using find_next(prev),\r\n-                // where \"prev\" is the position _past_ which should be searched (i.e. excluding position \"prev\").\r\n-                // If _pos is still 0, we thus need to use the counterpart find_first().\r\n-                _nextPos = _pos == 0 ? _values.find_first() : _values.find_next(_pos - 1);\r\n-\r\n-                // If we haven't reached the end yet...\r\n-                if (_nextPos < _end)\r\n-                {\r\n-                    // pos is now at the first on bit.\r\n-                    // If no next set bit can be found, npos is returned, which is SIZE_T_MAX.\r\n-                    // saturated_cast can ensure that this will be converted to CoordType's max (which is greater than _end).\r\n-                    const auto runStart = _rc.point_at(base::saturated_cast<CoordType>(_nextPos));\r\n-\r\n-                    // We'll only count up until the end of this row.\r\n-                    // a run can be a max of one row tall.\r\n-                    const size_t rowEndIndex = _rc.index_of<size_t>(til::point(_rc.right - 1, runStart.y)) + 1;\r\n-\r\n-                    // Find the length for the rectangle.\r\n-                    size_t runLength = 0;\r\n-\r\n-                    // We have at least 1 so start with a do/while.\r\n-                    do\r\n-                    {\r\n-                        ++_nextPos;\r\n-                        ++runLength;\r\n-                    } while (_nextPos < rowEndIndex && _values[_nextPos]);\r\n-                    // Keep going until we reach end of row, end of the buffer, or the next bit is off.\r\n-\r\n-                    // Assemble and store that run.\r\n-                    _run = til::rect{ runStart, til::size{ base::saturated_cast<CoordType>(runLength), 1 } };\r\n-                }\r\n-                else\r\n-                {\r\n-                    // If we reached the end _nextPos may be >= _end (potentially even PTRDIFF_T_MAX).\r\n-                    // ---> Mark the end of the iterator by updating the state with _end.\r\n-                    _pos = _end;\r\n-                    _nextPos = _end;\r\n-                    _run = til::rect{};\r\n-                }\r\n-            }\r\n-        };\r\n-\r\n-        template<typename Allocator = std::allocator<size_t>>\r\n-        class bitmap\r\n-        {\r\n-        public:\r\n-            using allocator_type = Allocator;\r\n-            using const_iterator = details::_bitmap_const_iterator<allocator_type>;\r\n-\r\n-        private:\r\n-            using run_allocator_type = typename std::allocator_traits<allocator_type>::template rebind_alloc<til::rect>;\r\n-\r\n-        public:\r\n-            explicit bitmap(const allocator_type& allocator) noexcept :\r\n-                _alloc{ allocator },\r\n-                _sz{},\r\n-                _rc{},\r\n-                _bits{ _alloc },\r\n-                _runs{ _alloc }\r\n-            {\r\n-            }\r\n-\r\n-            bitmap() noexcept :\r\n-                bitmap(allocator_type{})\r\n-            {\r\n-            }\r\n-\r\n-            bitmap(til::size sz) :\r\n-                bitmap(sz, false, allocator_type{})\r\n-            {\r\n-            }\r\n-\r\n-            bitmap(til::size sz, const allocator_type& allocator) :\r\n-                bitmap(sz, false, allocator)\r\n-            {\r\n-            }\r\n-\r\n-            bitmap(til::size sz, bool fill, const allocator_type& allocator) :\r\n-                _alloc{ allocator },\r\n-                _sz(sz),\r\n-                _rc(sz),\r\n-                _bits(_sz.area(), fill ? std::numeric_limits<unsigned long long>::max() : 0, _alloc),\r\n-                _runs{ _alloc }\r\n-            {\r\n-            }\r\n-\r\n-            bitmap(til::size sz, bool fill) :\r\n-                bitmap(sz, fill, allocator_type{})\r\n-            {\r\n-            }\r\n-\r\n-            bitmap(const bitmap& other) :\r\n-                _alloc{ std::allocator_traits<allocator_type>::select_on_container_copy_construction(other._alloc) },\r\n-                _sz{ other._sz },\r\n-                _rc{ other._rc },\r\n-                _bits{ other._bits },\r\n-                _runs{ other._runs }\r\n-            {\r\n-                // copy constructor is required to call select_on_container_copy\r\n-            }\r\n-\r\n-            bitmap& operator=(const bitmap& other)\r\n-            {\r\n-                if constexpr (std::allocator_traits<allocator_type>::propagate_on_container_copy_assignment::value)\r\n-                {\r\n-                    _alloc = other._alloc;\r\n-                }\r\n-                _sz = other._sz;\r\n-                _rc = other._rc;\r\n-                _bits = other._bits;\r\n-                _runs = other._runs;\r\n-                return *this;\r\n-            }\r\n-\r\n-            bitmap(bitmap&& other) noexcept :\r\n-                _alloc{ std::move(other._alloc) },\r\n-                _sz{ std::move(other._sz) },\r\n-                _rc{ std::move(other._rc) },\r\n-                _bits{ std::move(other._bits) },\r\n-                _runs{ std::move(other._runs) }\r\n-            {\r\n-            }\r\n-\r\n-            bitmap& operator=(bitmap&& other) noexcept\r\n-            {\r\n-                if constexpr (std::allocator_traits<allocator_type>::propagate_on_container_move_assignment::value)\r\n-                {\r\n-                    _alloc = std::move(other._alloc);\r\n-                }\r\n-                _bits = std::move(other._bits);\r\n-                _runs = std::move(other._runs);\r\n-                _sz = std::move(other._sz);\r\n-                _rc = std::move(other._rc);\r\n-                return *this;\r\n-            }\r\n-\r\n-            ~bitmap() {}\r\n-\r\n-            void swap(bitmap& other)\r\n-            {\r\n-                if constexpr (std::allocator_traits<allocator_type>::propagate_on_container_swap::value)\r\n-                {\r\n-                    std::swap(_alloc, other._alloc);\r\n-                }\r\n-                std::swap(_bits, other._bits);\r\n-                std::swap(_runs, other._runs);\r\n-                std::swap(_sz, other._sz);\r\n-                std::swap(_rc, other._rc);\r\n-            }\r\n-\r\n-            constexpr bool operator==(const bitmap& other) const noexcept\r\n-            {\r\n-                return _sz == other._sz &&\r\n-                       _rc == other._rc &&\r\n-                       _bits == other._bits;\r\n-                // _runs excluded because it's a cache of generated state.\r\n-            }\r\n-\r\n-            constexpr bool operator!=(const bitmap& other) const noexcept\r\n-            {\r\n-                return !(*this == other);\r\n-            }\r\n-\r\n-            const_iterator begin() const\r\n-            {\r\n-                return const_iterator(_bits, til::rect{ _sz }, 0);\r\n-            }\r\n-\r\n-            const_iterator end() const\r\n-            {\r\n-                return const_iterator(_bits, til::rect{ _sz }, _sz.area());\r\n-            }\r\n-\r\n-            const std::span<const til::rect> runs() const\r\n-            {\r\n-                // If we don't have cached runs, rebuild.\r\n-                if (!_runs.has_value())\r\n-                {\r\n-                    _runs.emplace(begin(), end());\r\n-                }\r\n-\r\n-                // Return the runs.\r\n-                return _runs.value();\r\n-            }\r\n-\r\n-            // optional fill the uncovered area with bits.\r\n-            void translate(const til::point delta, bool fill = false)\r\n-            {\r\n-                if (delta.x == 0)\r\n-                {\r\n-                    // fast path by using bit shifting\r\n-                    translate_y(delta.y, fill);\r\n-                    return;\r\n-                }\r\n-\r\n-                // FUTURE: PERF: GH #4015: This could use in-place walk semantics instead of a temporary.\r\n-                bitmap<allocator_type> other{ _sz, _alloc };\r\n-\r\n-                for (auto run : *this)\r\n-                {\r\n-                    // Offset by the delta\r\n-                    run += delta;\r\n-\r\n-                    // Intersect with the bounds of our bitmap area\r\n-                    // as part of it could have slid out of bounds.\r\n-                    run &= _rc;\r\n-\r\n-                    // Set it into the new bitmap.\r\n-                    other.set(run);\r\n-                }\r\n-\r\n-                // If we were asked to fill... find the uncovered region.\r\n-                if (fill)\r\n-                {\r\n-                    // Original Rect of As.\r\n-                    //\r\n-                    // X <-- origin\r\n-                    // A A A A\r\n-                    // A A A A\r\n-                    // A A A A\r\n-                    // A A A A\r\n-                    const auto originalRect = _rc;\r\n-\r\n-                    // If Delta = (2, 2)\r\n-                    // Translated Rect of Bs.\r\n-                    //\r\n-                    // X <-- origin\r\n-                    //\r\n-                    //\r\n-                    //     B B B B\r\n-                    //     B B B B\r\n-                    //     B B B B\r\n-                    //     B B B B\r\n-                    const auto translatedRect = _rc + delta;\r\n-\r\n-                    // Subtract the B from the A one to see what wasn't filled by the move.\r\n-                    // C is the overlap of A and B:\r\n-                    //\r\n-                    // X <-- origin\r\n-                    // A A A A                     1 1 1 1\r\n-                    // A A A A                     1 1 1 1\r\n-                    // A A C C B B     subtract    2 2\r\n-                    // A A C C B B    --------->   2 2\r\n-                    //     B B B B      A - B\r\n-                    //     B B B B\r\n-                    //\r\n-                    // 1 and 2 are the spaces to fill that are \"uncovered\".\r\n-                    const auto fillRects = originalRect - translatedRect;\r\n-                    for (const auto& f : fillRects)\r\n-                    {\r\n-                        other.set(f);\r\n-                    }\r\n-                }\r\n-\r\n-                // Swap us with the temporary one.\r\n-                std::swap(other, *this);\r\n-            }\r\n-\r\n-            void set(const til::point pt)\r\n-            {\r\n-                if (_rc.contains(pt))\r\n-                {\r\n-                    _runs.reset(); // reset cached runs on any non-const method\r\n-                    _bits.set(_rc.index_of(pt));\r\n-                }\r\n-            }\r\n-\r\n-            void set(til::rect rc)\r\n-            {\r\n-                _runs.reset(); // reset cached runs on any non-const method\r\n-\r\n-                rc &= _rc;\r\n-\r\n-                const auto width = rc.width();\r\n-                const auto stride = _rc.width();\r\n-                auto idx = _rc.index_of({ rc.left, rc.top });\r\n-\r\n-                for (auto row = rc.top; row < rc.bottom; ++row, idx += stride)\r\n-                {\r\n-                    _bits.set(idx, width, true);\r\n-                }\r\n-            }\r\n-\r\n-            void set_all() noexcept\r\n-            {\r\n-                _runs.reset(); // reset cached runs on any non-const method\r\n-                _bits.set();\r\n-            }\r\n-\r\n-            void reset_all() noexcept\r\n-            {\r\n-                _runs.reset(); // reset cached runs on any non-const method\r\n-                _bits.reset();\r\n-            }\r\n-\r\n-            // True if we resized. False if it was the same size as before.\r\n-            // Set fill if you want the new region (on growing) to be marked dirty.\r\n-            bool resize(til::size size, bool fill = false)\r\n-            {\r\n-                _runs.reset(); // reset cached runs on any non-const method\r\n-\r\n-                // Don't resize if it's not different\r\n-                if (_sz != size)\r\n-                {\r\n-                    // Make a new bitmap for the other side, empty initially.\r\n-                    bitmap<allocator_type> newMap{ size, false, _alloc };\r\n-\r\n-                    // Copy any regions that overlap from this map to the new one.\r\n-                    // Just iterate our runs...\r\n-                    for (const auto& run : *this)\r\n-                    {\r\n-                        // intersect them with the new map\r\n-                        // so we don't attempt to set bits that fit outside\r\n-                        // the new one.\r\n-                        const auto intersect = run & newMap._rc;\r\n-\r\n-                        // and if there is still anything left, set them.\r\n-                        if (!intersect.empty())\r\n-                        {\r\n-                            newMap.set(intersect);\r\n-                        }\r\n-                    }\r\n-\r\n-                    // Then, if we were requested to fill the new space on growing,\r\n-                    // find the space in the new rectangle that wasn't in the old\r\n-                    // and fill it up.\r\n-                    if (fill)\r\n-                    {\r\n-                        // A subtraction will yield anything in the new that isn't\r\n-                        // a part of the old.\r\n-                        const auto newAreas = newMap._rc - _rc;\r\n-                        for (const auto& area : newAreas)\r\n-                        {\r\n-                            newMap.set(area);\r\n-                        }\r\n-                    }\r\n-\r\n-                    // Swap and return.\r\n-                    std::swap(newMap, *this);\r\n-\r\n-                    return true;\r\n-                }\r\n-                else\r\n-                {\r\n-                    return false;\r\n-                }\r\n-            }\r\n-\r\n-            constexpr bool one() const noexcept\r\n-            {\r\n-                return _bits.count() == 1;\r\n-            }\r\n-\r\n-            constexpr bool any() const noexcept\r\n-            {\r\n-                return !none();\r\n-            }\r\n-\r\n-            constexpr bool none() const noexcept\r\n-            {\r\n-                return _bits.none();\r\n-            }\r\n-\r\n-            constexpr bool all() const noexcept\r\n-            {\r\n-                return _bits.all();\r\n-            }\r\n-\r\n-            constexpr til::size size() const noexcept\r\n-            {\r\n-                return _sz;\r\n-            }\r\n-\r\n-            std::wstring to_string() const\r\n-            {\r\n-                auto str = fmt::format(FMT_COMPILE(L\"Bitmap of size {} contains the following dirty regions:\\nRuns:\"), _sz.to_string());\r\n-                for (auto& item : *this)\r\n-                {\r\n-                    fmt::format_to(std::back_inserter(str), FMT_COMPILE(L\"\\n\\t- {}\"), item.to_string());\r\n-                }\r\n-                return str;\r\n-            }\r\n-\r\n-        private:\r\n-            void translate_y(ptrdiff_t delta_y, bool fill)\r\n-            {\r\n-                if (delta_y == 0)\r\n-                {\r\n-                    return;\r\n-                }\r\n-\r\n-                const auto bitShift = delta_y * _sz.width;\r\n-\r\n-#pragma warning(push)\r\n-                // we can't depend on GSL here, so we use static_cast for explicit narrowing\r\n-#pragma warning(disable : 26472)\r\n-                const auto newBits = static_cast<size_t>(std::abs(bitShift));\r\n-#pragma warning(pop)\r\n-                const bool isLeftShift = bitShift > 0;\r\n-\r\n-                if (newBits >= _bits.size())\r\n-                {\r\n-                    if (fill)\r\n-                    {\r\n-                        set_all();\r\n-                    }\r\n-                    else\r\n-                    {\r\n-                        reset_all();\r\n-                    }\r\n-                    return;\r\n-                }\r\n-\r\n-                if (isLeftShift)\r\n-                {\r\n-                    // This operator doesn't modify the size of `_bits`: the\r\n-                    // new bits are set to 0.\r\n-                    _bits <<= newBits;\r\n-                }\r\n-                else\r\n-                {\r\n-                    _bits >>= newBits;\r\n-                }\r\n-\r\n-                if (fill)\r\n-                {\r\n-                    if (isLeftShift)\r\n-                    {\r\n-                        _bits.set(0, newBits, true);\r\n-                    }\r\n-                    else\r\n-                    {\r\n-                        _bits.set(_bits.size() - newBits, newBits, true);\r\n-                    }\r\n-                }\r\n-\r\n-                _runs.reset(); // reset cached runs on any non-const method\r\n-            }\r\n-\r\n-            allocator_type _alloc;\r\n-            til::size _sz;\r\n-            til::rect _rc;\r\n-            dynamic_bitset<size_t, allocator_type> _bits;\r\n-\r\n-            mutable std::optional<std::vector<til::rect, run_allocator_type>> _runs;\r\n-\r\n-#ifdef UNIT_TESTING\r\n-            friend class ::BitmapTests;\r\n-#endif\r\n-        };\r\n-\r\n-    }\r\n-\r\n-    using bitmap = ::til::details::bitmap<>;\r\n-\r\n-    namespace pmr\r\n-    {\r\n-        using bitmap = ::til::details::bitmap<std::pmr::polymorphic_allocator<size_t>>;\r\n-    }\r\n-}\r\n-\r\n-#ifdef __WEX_COMMON_H__\r\n-namespace WEX::TestExecution\r\n-{\r\n-    template<typename T>\r\n-    class VerifyOutputTraits<::til::details::bitmap<T>>\r\n-    {\r\n-    public:\r\n-        static WEX::Common::NoThrowString ToString(const ::til::details::bitmap<T>& rect)\r\n-        {\r\n-            return WEX::Common::NoThrowString(rect.to_string().c_str());\r\n-        }\r\n-    };\r\n-\r\n-    template<typename T>\r\n-    class VerifyCompareTraits<::til::details::bitmap<T>, ::til::details::bitmap<T>>\r\n-    {\r\n-    public:\r\n-        static bool AreEqual(const ::til::details::bitmap<T>& expected, const ::til::details::bitmap<T>& actual) noexcept\r\n-        {\r\n-            return expected == actual;\r\n-        }\r\n-\r\n-        static bool AreSame(const ::til::details::bitmap<T>& expected, const ::til::details::bitmap<T>& actual) noexcept\r\n-        {\r\n-            return &expected == &actual;\r\n-        }\r\n-\r\n-        static bool IsLessThan(const ::til::details::bitmap<T>& expectedLess, const ::til::details::bitmap<T>& expectedGreater) = delete;\r\n-\r\n-        static bool IsGreaterThan(const ::til::details::bitmap<T>& expectedGreater, const ::til::details::bitmap<T>& expectedLess) = delete;\r\n-\r\n-        static bool IsNull(const ::til::details::bitmap<T>& object) noexcept\r\n-        {\r\n-            return object == til::details::bitmap<T>{};\r\n-        }\r\n-    };\r\n-\r\n-};\r\n-#endif\r\ndiff --git a/src/interactivity/base/InteractivityFactory.cpp b/src/interactivity/base/InteractivityFactory.cpp\nindex fe8fc55cd8c..d13f915ff59 100644\n--- a/src/interactivity/base/InteractivityFactory.cpp\n+++ b/src/interactivity/base/InteractivityFactory.cpp\n@@ -497,9 +497,12 @@ void InteractivityFactory::_WritePseudoWindowCallback(bool showOrHide)\n     // this message, if it's already minimized. If the window is maximized a\r\n     // restore will restore-down the window instead.\r\n     auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-    if (const auto io = gci.GetVtIo())\r\n+    if (auto writer = gci.GetVtWriter())\r\n     {\r\n-        io->SetWindowVisibility(showOrHide);\r\n+        char buf[] = \"\\x1b[1t\";\r\n+        buf[2] = showOrHide ? '1' : '2';\r\n+        writer.WriteUTF8(buf);\r\n+        writer.Submit();\r\n     }\r\n }\r\n \r\ndiff --git a/src/interactivity/base/ServiceLocator.cpp b/src/interactivity/base/ServiceLocator.cpp\nindex 59000001622..f73182e8a58 100644\n--- a/src/interactivity/base/ServiceLocator.cpp\n+++ b/src/interactivity/base/ServiceLocator.cpp\n@@ -67,15 +67,6 @@ void ServiceLocator::RundownAndExit(const HRESULT hr)\n         Sleep(INFINITE);\r\n     }\r\n \r\n-    // MSFT:15506250\r\n-    // In VT I/O Mode, a client application might die before we've rendered\r\n-    //      the last bit of text they've emitted. So give the VtRenderer one\r\n-    //      last chance to paint before it is killed.\r\n-    if (s_globals.pRender)\r\n-    {\r\n-        s_globals.pRender->TriggerTeardown();\r\n-    }\r\n-\r\n     // MSFT:40226902 - HOTFIX shutdown on OneCore, by leaking the renderer, thereby\r\n     // reducing the change for existing race conditions to turn into deadlocks.\r\n #ifndef NDEBUG\r\ndiff --git a/src/interactivity/onecore/BgfxEngine.cpp b/src/interactivity/onecore/BgfxEngine.cpp\nindex d508603d5f9..5d08e320ea5 100644\n--- a/src/interactivity/onecore/BgfxEngine.cpp\n+++ b/src/interactivity/onecore/BgfxEngine.cpp\n@@ -63,12 +63,6 @@ BgfxEngine::BgfxEngine(PVOID SharedViewBase, LONG DisplayHeight, LONG DisplayWid\n     return S_OK;\r\n }\r\n \r\n-[[nodiscard]] HRESULT BgfxEngine::PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    *pForcePaint = false;\r\n-    return S_FALSE;\r\n-}\r\n-\r\n [[nodiscard]] HRESULT BgfxEngine::StartPaint() noexcept\r\n {\r\n     return S_OK;\r\ndiff --git a/src/interactivity/onecore/BgfxEngine.hpp b/src/interactivity/onecore/BgfxEngine.hpp\nindex e9759ce0306..1d72dd0aaf1 100644\n--- a/src/interactivity/onecore/BgfxEngine.hpp\n+++ b/src/interactivity/onecore/BgfxEngine.hpp\n@@ -38,7 +38,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT InvalidateSelection(const std::vector<til::rect>& rectangles) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateScroll(const til::point* pcoordDelta) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateAll() noexcept override;\r\n-        [[nodiscard]] HRESULT PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept override;\r\n \r\n         [[nodiscard]] HRESULT StartPaint() noexcept override;\r\n         [[nodiscard]] HRESULT EndPaint() noexcept override;\r\ndiff --git a/src/interactivity/win32/ut_interactivity_win32/Interactivity.Win32.UnitTests.vcxproj b/src/interactivity/win32/ut_interactivity_win32/Interactivity.Win32.UnitTests.vcxproj\nindex 9f354048194..c610884be63 100644\n--- a/src/interactivity/win32/ut_interactivity_win32/Interactivity.Win32.UnitTests.vcxproj\n+++ b/src/interactivity/win32/ut_interactivity_win32/Interactivity.Win32.UnitTests.vcxproj\n@@ -26,9 +26,6 @@\n     <ProjectReference Include=\"..\\..\\..\\renderer\\atlas\\atlas.vcxproj\">\r\n       <Project>{8222900C-8B6C-452A-91AC-BE95DB04B95F}</Project>\r\n     </ProjectReference>\r\n-    <ProjectReference Include=\"..\\..\\..\\renderer\\vt\\lib\\vt.vcxproj\">\r\n-      <Project>{990f2657-8580-4828-943f-5dd657d11842}</Project>\r\n-    </ProjectReference>\r\n     <ProjectReference Include=\"..\\..\\..\\types\\lib\\types.vcxproj\">\r\n       <Project>{18d09a24-8240-42d6-8cb6-236eee820263}</Project>\r\n     </ProjectReference>\r\ndiff --git a/src/interactivity/win32/windowio.cpp b/src/interactivity/win32/windowio.cpp\nindex 261ed4a80c8..5afd66b9ce2 100644\n--- a/src/interactivity/win32/windowio.cpp\n+++ b/src/interactivity/win32/windowio.cpp\n@@ -935,7 +935,11 @@ DWORD WINAPI ConsoleInputThreadProcWin32(LPVOID /*lpParameter*/)\n         // VtIo's CreatePseudoWindow, which will make sure that the window is\r\n         // successfully created with the owner configured when the window is\r\n         // first created. See GH#13066 for details.\r\n-        ServiceLocator::LocateGlobals().getConsoleInformation().GetVtIo()->CreatePseudoWindow();\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        if (gci.IsInVtIoMode())\r\n+        {\r\n+            gci.GetVtIo()->CreatePseudoWindow();\r\n+        }\r\n \r\n         // Register the pseudoconsole window as being owned by the root process.\r\n         const auto pseudoWindow = ServiceLocator::LocatePseudoWindow();\r\ndiff --git a/src/project.inc b/src/project.inc\nindex 0b7115efcf0..1d86343d9c6 100644\n--- a/src/project.inc\n+++ b/src/project.inc\n@@ -49,8 +49,6 @@ INCLUDES= \\\n     $(INCLUDES); \\\r\n     $(CONSOLE_SRC_PATH)\\inc; \\\r\n     $(CONSOLE_SRC_PATH)\\..\\..\\inc; \\\r\n-    $(CONSOLE_SRC_PATH)\\..\\oss\\dynamic_bitset; \\\r\n-    $(CONSOLE_SRC_PATH)\\..\\oss\\libpopcnt; \\\r\n     $(CONSOLE_SRC_PATH)\\..\\oss\\chromium; \\\r\n     $(CONSOLE_SRC_PATH)\\..\\oss\\fmt\\include; \\\r\n     $(CONSOLE_SRC_PATH)\\..\\oss\\interval_tree; \\\r\ndiff --git a/src/renderer/atlas/AtlasEngine.api.cpp b/src/renderer/atlas/AtlasEngine.api.cpp\nindex 17e7d2f8a5e..3be016a0a60 100644\n--- a/src/renderer/atlas/AtlasEngine.api.cpp\n+++ b/src/renderer/atlas/AtlasEngine.api.cpp\n@@ -160,13 +160,6 @@ constexpr HRESULT vec2_narrow(U x, U y, vec2<T>& out) noexcept\n     return S_OK;\r\n }\r\n \r\n-[[nodiscard]] HRESULT AtlasEngine::InvalidateFlush(_In_ const bool /*circled*/, _Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    RETURN_HR_IF_NULL(E_INVALIDARG, pForcePaint);\r\n-    *pForcePaint = false;\r\n-    return S_OK;\r\n-}\r\n-\r\n [[nodiscard]] HRESULT AtlasEngine::InvalidateTitle(const std::wstring_view proposedTitle) noexcept\r\n {\r\n     _api.invalidatedTitle = true;\r\ndiff --git a/src/renderer/atlas/AtlasEngine.cpp b/src/renderer/atlas/AtlasEngine.cpp\nindex 277d3818dc2..50889781966 100644\n--- a/src/renderer/atlas/AtlasEngine.cpp\n+++ b/src/renderer/atlas/AtlasEngine.cpp\n@@ -282,13 +282,6 @@ try\n }\r\n CATCH_RETURN()\r\n \r\n-[[nodiscard]] HRESULT AtlasEngine::PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    RETURN_HR_IF_NULL(E_INVALIDARG, pForcePaint);\r\n-    *pForcePaint = false;\r\n-    return S_OK;\r\n-}\r\n-\r\n [[nodiscard]] HRESULT AtlasEngine::ScrollFrame() noexcept\r\n {\r\n     return S_OK;\r\ndiff --git a/src/renderer/atlas/AtlasEngine.h b/src/renderer/atlas/AtlasEngine.h\nindex 135d0e692a9..68c0ca8e01b 100644\n--- a/src/renderer/atlas/AtlasEngine.h\n+++ b/src/renderer/atlas/AtlasEngine.h\n@@ -27,7 +27,6 @@ namespace Microsoft::Console::Render::Atlas\n         [[nodiscard]] bool RequiresContinuousRedraw() noexcept override;\r\n         void WaitUntilCanRender() noexcept override;\r\n         [[nodiscard]] HRESULT Present() noexcept override;\r\n-        [[nodiscard]] HRESULT PrepareForTeardown(_Out_ bool* pForcePaint) noexcept override;\r\n         [[nodiscard]] HRESULT ScrollFrame() noexcept override;\r\n         [[nodiscard]] HRESULT Invalidate(const til::rect* psrRegion) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateCursor(const til::rect* psrRegion) noexcept override;\r\n@@ -36,7 +35,6 @@ namespace Microsoft::Console::Render::Atlas\n         [[nodiscard]] HRESULT InvalidateHighlight(std::span<const til::point_span> highlights, const TextBuffer& buffer) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateScroll(const til::point* pcoordDelta) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateAll() noexcept override;\r\n-        [[nodiscard]] HRESULT InvalidateFlush(_In_ const bool circled, _Out_ bool* const pForcePaint) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateTitle(std::wstring_view proposedTitle) noexcept override;\r\n         [[nodiscard]] HRESULT NotifyNewText(const std::wstring_view newText) noexcept override;\r\n         [[nodiscard]] HRESULT PrepareRenderInfo(RenderFrameInfo info) noexcept override;\r\ndiff --git a/src/renderer/atlas/pch.h b/src/renderer/atlas/pch.h\nindex 36a2f2143c5..f06a26c4946 100644\n--- a/src/renderer/atlas/pch.h\n+++ b/src/renderer/atlas/pch.h\n@@ -36,13 +36,6 @@\n #include <wil/stl.h>\r\n #include <wil/win32_helpers.h>\r\n \r\n-// Dynamic Bitset (optional dependency on LibPopCnt for perf at bit counting)\r\n-// Variable-size compressed-storage header-only bit flag storage library.\r\n-#pragma warning(push)\r\n-#pragma warning(disable : 4702) // unreachable code\r\n-#include <dynamic_bitset.hpp>\r\n-#pragma warning(pop)\r\n-\r\n // Chromium Numerics (safe math)\r\n #pragma warning(push)\r\n #pragma warning(disable : 4100) // '...': unreferenced formal parameter\r\ndiff --git a/src/renderer/base/RenderEngineBase.cpp b/src/renderer/base/RenderEngineBase.cpp\nindex dfc54432f22..cfa00b13cd0 100644\n--- a/src/renderer/base/RenderEngineBase.cpp\n+++ b/src/renderer/base/RenderEngineBase.cpp\n@@ -92,19 +92,3 @@ void RenderEngineBase::WaitUntilCanRender() noexcept\n void RenderEngineBase::UpdateHyperlinkHoveredId(const uint16_t /*hoveredId*/) noexcept\r\n {\r\n }\r\n-\r\n-// Routine Description:\r\n-// - Notifies us that we're about to circle the buffer, giving us a chance to\r\n-//   force a repaint before the buffer contents are lost.\r\n-// - The default implementation of flush, is to do nothing for most renderers.\r\n-// Arguments:\r\n-// - circled - ignored\r\n-// - pForcePaint - Always filled with false\r\n-// Return Value:\r\n-// - S_FALSE because we don't use this.\r\n-[[nodiscard]] HRESULT RenderEngineBase::InvalidateFlush(_In_ const bool /*circled*/, _Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    RETURN_HR_IF_NULL(E_INVALIDARG, pForcePaint);\r\n-    *pForcePaint = false;\r\n-    return S_FALSE;\r\n-}\r\ndiff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex 8192404b9bc..3c8ff115bc5 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -316,26 +316,6 @@ void Renderer::TriggerTeardown() noexcept\n {\r\n     // We need to shut down the paint thread on teardown.\r\n     _pThread->WaitForPaintCompletionAndDisable(INFINITE);\r\n-\r\n-    auto repaint = false;\r\n-\r\n-    // Then walk through and do one final paint on the caller's thread.\r\n-    FOREACH_ENGINE(pEngine)\r\n-    {\r\n-        auto fEngineRequestsRepaint = false;\r\n-        auto hr = pEngine->PrepareForTeardown(&fEngineRequestsRepaint);\r\n-        LOG_IF_FAILED(hr);\r\n-\r\n-        repaint |= SUCCEEDED(hr) && fEngineRequestsRepaint;\r\n-    }\r\n-\r\n-    // BODGY: The only time repaint is true is when VtEngine is used.\r\n-    // Coincidentally VtEngine always runs alone, so if repaint is true, there's only a single engine\r\n-    // to repaint anyways and there's no danger is accidentally repainting an engine that didn't want to.\r\n-    if (repaint)\r\n-    {\r\n-        LOG_IF_FAILED(_PaintFrame());\r\n-    }\r\n }\r\n \r\n // Routine Description:\r\n@@ -486,38 +466,6 @@ void Renderer::TriggerScroll(const til::point* const pcoordDelta)\n     NotifyPaintFrame();\r\n }\r\n \r\n-// Routine Description:\r\n-// - Called when the text buffer is about to circle its backing buffer.\r\n-//      A renderer might want to get painted before that happens.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - <none>\r\n-void Renderer::TriggerFlush(const bool circling)\r\n-{\r\n-    const auto rects = _GetSelectionRects();\r\n-    auto repaint = false;\r\n-\r\n-    FOREACH_ENGINE(pEngine)\r\n-    {\r\n-        auto fEngineRequestsRepaint = false;\r\n-        auto hr = pEngine->InvalidateFlush(circling, &fEngineRequestsRepaint);\r\n-        LOG_IF_FAILED(hr);\r\n-\r\n-        LOG_IF_FAILED(pEngine->InvalidateSelection(rects));\r\n-\r\n-        repaint |= SUCCEEDED(hr) && fEngineRequestsRepaint;\r\n-    }\r\n-\r\n-    // BODGY: The only time repaint is true is when VtEngine is used.\r\n-    // Coincidentally VtEngine always runs alone, so if repaint is true, there's only a single engine\r\n-    // to repaint anyways and there's no danger is accidentally repainting an engine that didn't want to.\r\n-    if (repaint)\r\n-    {\r\n-        LOG_IF_FAILED(_PaintFrame());\r\n-    }\r\n-}\r\n-\r\n // Routine Description:\r\n // - Called when the title of the console window has changed. Indicates that we\r\n //      should update the title on the next frame.\r\ndiff --git a/src/renderer/base/renderer.hpp b/src/renderer/base/renderer.hpp\nindex 8c4308c5a87..aed9789caff 100644\n--- a/src/renderer/base/renderer.hpp\n+++ b/src/renderer/base/renderer.hpp\n@@ -23,14 +23,6 @@ Author(s):\n \r\n #include \"../../buffer/out/textBuffer.hpp\"\r\n \r\n-// fwdecl unittest classes\r\n-#ifdef UNIT_TESTING\r\n-namespace TerminalCoreUnitTests\r\n-{\r\n-    class ConptyRoundtripTests;\r\n-};\r\n-#endif\r\n-\r\n namespace Microsoft::Console::Render\r\n {\r\n     class Renderer\r\n@@ -60,7 +52,6 @@ namespace Microsoft::Console::Render\n         void TriggerScroll();\r\n         void TriggerScroll(const til::point* const pcoordDelta);\r\n \r\n-        void TriggerFlush(const bool circling);\r\n         void TriggerTitleChange();\r\n \r\n         void TriggerNewTextNotification(const std::wstring_view newText);\r\n@@ -146,10 +137,5 @@ namespace Microsoft::Console::Render\n         std::function<void()> _pfnRendererEnteredErrorState;\r\n         bool _destructing = false;\r\n         bool _forceUpdateViewport = false;\r\n-\r\n-#ifdef UNIT_TESTING\r\n-        friend class ConptyOutputTests;\r\n-        friend class TerminalCoreUnitTests::ConptyRoundtripTests;\r\n-#endif\r\n     };\r\n }\r\ndiff --git a/src/renderer/dirs b/src/renderer/dirs\nindex 65488397e89..1b3b1ee6c59 100644\n--- a/src/renderer/dirs\n+++ b/src/renderer/dirs\n@@ -2,4 +2,3 @@ DIRS= \\\n      base \\\r\n      gdi \\\r\n      wddmcon \\\r\n-     vt \\\r\ndiff --git a/src/renderer/gdi/gdirenderer.hpp b/src/renderer/gdi/gdirenderer.hpp\nindex 48eec99a920..750226a8797 100644\n--- a/src/renderer/gdi/gdirenderer.hpp\n+++ b/src/renderer/gdi/gdirenderer.hpp\n@@ -33,7 +33,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT Invalidate(const til::rect* const psrRegion) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateCursor(const til::rect* const psrRegion) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateAll() noexcept override;\r\n-        [[nodiscard]] HRESULT PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept override;\r\n \r\n         [[nodiscard]] HRESULT StartPaint() noexcept override;\r\n         [[nodiscard]] HRESULT EndPaint() noexcept override;\r\ndiff --git a/src/renderer/gdi/invalidate.cpp b/src/renderer/gdi/invalidate.cpp\nindex ce2616be604..094335af029 100644\n--- a/src/renderer/gdi/invalidate.cpp\n+++ b/src/renderer/gdi/invalidate.cpp\n@@ -100,21 +100,6 @@ HRESULT GdiEngine::InvalidateAll() noexcept\n     RETURN_HR(InvalidateSystem(&rc));\r\n }\r\n \r\n-// Method Description:\r\n-// - Notifies us that we're about to be torn down. This gives us a last chance\r\n-//      to force a repaint before the buffer contents are lost. The GDI renderer\r\n-//      doesn't care if we lose text - we're only painting visible text anyways,\r\n-//      so we return false.\r\n-// Arguments:\r\n-// - Receives a bool indicating if we should force the repaint.\r\n-// Return Value:\r\n-// - S_FALSE - we succeeded, but the result was false.\r\n-HRESULT GdiEngine::PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    *pForcePaint = false;\r\n-    return S_FALSE;\r\n-}\r\n-\r\n // Routine Description:\r\n // - Helper to combine the given rectangle into the invalid region to be updated on the next paint\r\n // Arguments:\r\ndiff --git a/src/renderer/inc/IRenderEngine.hpp b/src/renderer/inc/IRenderEngine.hpp\nindex cdbcd774855..5a25c977855 100644\n--- a/src/renderer/inc/IRenderEngine.hpp\n+++ b/src/renderer/inc/IRenderEngine.hpp\n@@ -62,7 +62,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] virtual bool RequiresContinuousRedraw() noexcept = 0;\r\n         virtual void WaitUntilCanRender() noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT Present() noexcept = 0;\r\n-        [[nodiscard]] virtual HRESULT PrepareForTeardown(_Out_ bool* pForcePaint) noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT ScrollFrame() noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT Invalidate(const til::rect* psrRegion) noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT InvalidateCursor(const til::rect* psrRegion) noexcept = 0;\r\n@@ -71,7 +70,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] virtual HRESULT InvalidateHighlight(std::span<const til::point_span> highlights, const TextBuffer& buffer) noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT InvalidateScroll(const til::point* pcoordDelta) noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT InvalidateAll() noexcept = 0;\r\n-        [[nodiscard]] virtual HRESULT InvalidateFlush(_In_ const bool circled, _Out_ bool* const pForcePaint) noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT InvalidateTitle(std::wstring_view proposedTitle) noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT NotifyNewText(const std::wstring_view newText) noexcept = 0;\r\n         [[nodiscard]] virtual HRESULT PrepareRenderInfo(RenderFrameInfo info) noexcept = 0;\r\ndiff --git a/src/renderer/inc/RenderEngineBase.hpp b/src/renderer/inc/RenderEngineBase.hpp\nindex 2794fcf98da..5a7454a2a6a 100644\n--- a/src/renderer/inc/RenderEngineBase.hpp\n+++ b/src/renderer/inc/RenderEngineBase.hpp\n@@ -48,8 +48,6 @@ namespace Microsoft::Console::Render\n \r\n         [[nodiscard]] bool RequiresContinuousRedraw() noexcept override;\r\n \r\n-        [[nodiscard]] HRESULT InvalidateFlush(_In_ const bool circled, _Out_ bool* const pForcePaint) noexcept override;\r\n-\r\n         void WaitUntilCanRender() noexcept override;\r\n         void UpdateHyperlinkHoveredId(const uint16_t hoveredId) noexcept override;\r\n \r\ndiff --git a/src/renderer/uia/UiaRenderer.cpp b/src/renderer/uia/UiaRenderer.cpp\nindex d1e72fbd0eb..0143a8e7b4b 100644\n--- a/src/renderer/uia/UiaRenderer.cpp\n+++ b/src/renderer/uia/UiaRenderer.cpp\n@@ -191,20 +191,6 @@ try\n }\r\n CATCH_LOG_RETURN_HR(E_FAIL);\r\n \r\n-// Routine Description:\r\n-// - This is unused by this renderer.\r\n-// Arguments:\r\n-// - pForcePaint - always filled with false.\r\n-// Return Value:\r\n-// - S_FALSE because this is unused.\r\n-[[nodiscard]] HRESULT UiaEngine::PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    RETURN_HR_IF_NULL(E_INVALIDARG, pForcePaint);\r\n-\r\n-    *pForcePaint = false;\r\n-    return S_FALSE;\r\n-}\r\n-\r\n // Routine Description:\r\n // - Prepares internal structures for a painting operation.\r\n // Arguments:\r\ndiff --git a/src/renderer/uia/UiaRenderer.hpp b/src/renderer/uia/UiaRenderer.hpp\nindex 3fd069f425a..0f7d5f1afb6 100644\n--- a/src/renderer/uia/UiaRenderer.hpp\n+++ b/src/renderer/uia/UiaRenderer.hpp\n@@ -38,7 +38,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT EndPaint() noexcept override;\r\n         void WaitUntilCanRender() noexcept override;\r\n         [[nodiscard]] HRESULT Present() noexcept override;\r\n-        [[nodiscard]] HRESULT PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept override;\r\n         [[nodiscard]] HRESULT ScrollFrame() noexcept override;\r\n         [[nodiscard]] HRESULT Invalidate(const til::rect* const psrRegion) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateCursor(const til::rect* const psrRegion) noexcept override;\r\ndiff --git a/src/renderer/vt/VtSequences.cpp b/src/renderer/vt/VtSequences.cpp\ndeleted file mode 100644\nindex 612d3c06d06..00000000000\n--- a/src/renderer/vt/VtSequences.cpp\n+++ /dev/null\n@@ -1,527 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-#include \"vtrenderer.hpp\"\r\n-\r\n-#include \"../renderer/base/renderer.hpp\"\r\n-#include \"../../inc/conattrs.hpp\"\r\n-\r\n-#pragma hdrstop\r\n-using namespace Microsoft::Console::Render;\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to stop the cursor from blinking.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_StopCursorBlinking() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[?12l\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to start the cursor blinking. If it's\r\n-//      hidden, this won't also show it.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_StartCursorBlinking() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[?12h\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to hide the cursor.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_HideCursor() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[?25l\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to show the cursor.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_ShowCursor() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[?25h\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to erase the remainder of the line starting\r\n-//      from the cursor position.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_EraseLine() noexcept\r\n-{\r\n-    // The default no-param action of erase line is erase to the right.\r\n-    // telnet client doesn't understand the parameterized version,\r\n-    // so emit the implicit sequence instead.\r\n-    return _Write(\"\\x1b[K\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to either insert or delete a number of lines\r\n-//      into the buffer at the current cursor location.\r\n-//   Delete/insert Character removes/adds N characters from/to the buffer, and\r\n-//      shifts the remaining chars in the row to the left/right, while Erase\r\n-//      Character replaces N characters with spaces, and leaves the rest\r\n-//      untouched.\r\n-// Arguments:\r\n-// - chars: a number of characters to erase (by overwriting with space)\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_EraseCharacter(const til::CoordType chars) noexcept\r\n-{\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[{}X\"), chars);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Moves the cursor forward (right) a number of characters.\r\n-// Arguments:\r\n-// - chars: a number of characters to move cursor right by.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_CursorForward(const til::CoordType chars) noexcept\r\n-{\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[{}C\"), chars);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to erase the remainder of the line starting\r\n-//      from the cursor position.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_ClearScreen() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[2J\");\r\n-}\r\n-\r\n-[[nodiscard]] HRESULT VtEngine::_ClearScrollback() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[3J\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to either insert or delete a number of lines\r\n-//      into the buffer at the current cursor location.\r\n-// Arguments:\r\n-// - sLines: a number of lines to insert or delete\r\n-// - fInsertLine: true iff we should insert the lines, false to delete them.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_InsertDeleteLine(const til::CoordType sLines, const bool fInsertLine) noexcept\r\n-{\r\n-    if (sLines <= 0)\r\n-    {\r\n-        return S_OK;\r\n-    }\r\n-    if (sLines == 1)\r\n-    {\r\n-        return _Write(fInsertLine ? \"\\x1b[L\" : \"\\x1b[M\");\r\n-    }\r\n-\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[{}{}\"), sLines, fInsertLine ? 'L' : 'M');\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to delete a number of lines into the buffer\r\n-//      at the current cursor location.\r\n-// Arguments:\r\n-// - sLines: a number of lines to insert\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_DeleteLine(const til::CoordType sLines) noexcept\r\n-{\r\n-    return _InsertDeleteLine(sLines, false);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to insert a number of lines into the buffer\r\n-//      at the current cursor location.\r\n-// Arguments:\r\n-// - sLines: a number of lines to insert\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_InsertLine(const til::CoordType sLines) noexcept\r\n-{\r\n-    return _InsertDeleteLine(sLines, true);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to move the cursor to the specified\r\n-//      coordinate position. The input coord should be in console coordinates,\r\n-//      where origin=(0,0).\r\n-// Arguments:\r\n-// - coord: Console coordinates to move the cursor to.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_CursorPosition(const til::point coord) noexcept\r\n-{\r\n-    // VT coords start at 1,1\r\n-    auto coordVt = coord;\r\n-    coordVt.x++;\r\n-    coordVt.y++;\r\n-\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[{};{}H\"), coordVt.y, coordVt.x);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to move the cursor to the origin.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_CursorHome() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[H\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current text attributes to the default.\r\n-// Arguments:\r\n-// <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsDefault() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current text attributes to an\r\n-//      indexed color from the 16-color table.\r\n-// Arguments:\r\n-// - index: color table index to emit as a VT sequence\r\n-// - fIsForeground: true if we should emit the foreground sequence, false for background\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsRendition16Color(const BYTE index,\r\n-                                                             const bool fIsForeground) noexcept\r\n-{\r\n-    // Always check using the foreground flags, because the bg flags constants\r\n-    //  are a higher byte\r\n-    // Foreground sequences are in [30,37] U [90,97]\r\n-    // Background sequences are in [40,47] U [100,107]\r\n-    // The \"dark\" sequences are in the first 7 values, the bright sequences in the second set.\r\n-    // Note that text brightness and intensity are different in VT. Intensity is\r\n-    //      handled by _SetIntense. Here, we can emit either bright or\r\n-    //      dark colors. For conhost as a terminal, it can't draw bold\r\n-    //      characters, so it displays \"intense\" as bright, and in fact most\r\n-    //      terminals display the bright color when displaying intense text.\r\n-    // By specifying the intensity and brightness separately, we'll make sure the\r\n-    //      terminal has an accurate representation of our buffer.\r\n-    const auto prefix = WI_IsFlagSet(index, FOREGROUND_INTENSITY) ? (fIsForeground ? 90 : 100) : (fIsForeground ? 30 : 40);\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[{}m\"), prefix + (index & 7));\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current text attributes to an\r\n-//      indexed color from the 256-color table.\r\n-// Arguments:\r\n-// - index: color table index to emit as a VT sequence\r\n-// - fIsForeground: true if we should emit the foreground sequence, false for background\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsRendition256Color(const BYTE index,\r\n-                                                              const bool fIsForeground) noexcept\r\n-{\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[{}8;5;{}m\"), fIsForeground ? '3' : '4', index);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current underline color to an\r\n-//   indexed color from the 256-color table.\r\n-// - Uses sub parameters.\r\n-// Arguments:\r\n-// - index: color table index to emit as a VT sequence\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsRenditionUnderline256Color(const BYTE index) noexcept\r\n-{\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[58:5:{}m\"), index);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current text attributes to an\r\n-//      RGB color.\r\n-// Arguments:\r\n-// - color: The color to emit a VT sequence for\r\n-// - fIsForeground: true if we should emit the foreground sequence, false for background\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsRenditionRGBColor(const COLORREF color,\r\n-                                                              const bool fIsForeground) noexcept\r\n-{\r\n-    const auto r = GetRValue(color);\r\n-    const auto g = GetGValue(color);\r\n-    const auto b = GetBValue(color);\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[{}8;2;{};{};{}m\"), fIsForeground ? '3' : '4', r, g, b);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current underline color to an\r\n-//   RGB color.\r\n-// - Uses sub parameters.\r\n-// Arguments:\r\n-// - color: The color to emit a VT sequence for.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsRenditionUnderlineRGBColor(const COLORREF color) noexcept\r\n-{\r\n-    const auto r = GetRValue(color);\r\n-    const auto g = GetGValue(color);\r\n-    const auto b = GetBValue(color);\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[58:2::{}:{}:{}m\"), r, g, b);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current text attributes to the\r\n-//      default foreground or background. Does not affect the intensity of text.\r\n-// Arguments:\r\n-// - fIsForeground: true if we should emit the foreground sequence, false for background\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsRenditionDefaultColor(const bool fIsForeground) noexcept\r\n-{\r\n-    return _Write(fIsForeground ? (\"\\x1b[39m\") : (\"\\x1b[49m\"));\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the current underline color to the\r\n-//   default color.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetGraphicsRenditionUnderlineDefaultColor() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[59m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the terminal's window size.\r\n-// Arguments:\r\n-// - sWidth: number of columns the terminal should display\r\n-// - sHeight: number of rows the terminal should display\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_ResizeWindow(const til::CoordType sWidth, const til::CoordType sHeight) noexcept\r\n-{\r\n-    if (sWidth < 0 || sHeight < 0)\r\n-    {\r\n-        return E_INVALIDARG;\r\n-    }\r\n-\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b[8;{};{}t\"), sHeight, sWidth);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to request the end terminal to tell us the\r\n-//      cursor position. The terminal will reply back on the vt input handle.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_RequestCursor() noexcept\r\n-{\r\n-    return _Write(\"\\x1b[6n\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the terminal's title string\r\n-// Arguments:\r\n-// - title: string to use as the new title of the window.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_ChangeTitle(_In_ const std::string& title) noexcept\r\n-{\r\n-    return _WriteFormatted(FMT_COMPILE(\"\\x1b]0;{}\\x7\"), title);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the intensity of the following text.\r\n-// Arguments:\r\n-// - isIntense: If true, we'll make the text intense. Otherwise we'll remove the intensity.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetIntense(const bool isIntense) noexcept\r\n-{\r\n-    return _Write(isIntense ? \"\\x1b[1m\" : \"\\x1b[22m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the faintness of the following text.\r\n-// Arguments:\r\n-// - isFaint: If true, we'll make the text faint. Otherwise we'll remove the faintness.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetFaint(const bool isFaint) noexcept\r\n-{\r\n-    return _Write(isFaint ? \"\\x1b[2m\" : \"\\x1b[22m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the extended underline styling of the following text.\r\n-// - Uses backward compatible SGR 4 (without sub parameter) and SGR 21 for single and doubly underline.\r\n-// Arguments:\r\n-// - style: underline style to use.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetUnderlineExtended(const UnderlineStyle style) noexcept\r\n-{\r\n-    switch (style)\r\n-    {\r\n-    case UnderlineStyle::NoUnderline:\r\n-        return _SetUnderlined(false);\r\n-    case UnderlineStyle::SinglyUnderlined:\r\n-        return _SetUnderlined(true);\r\n-    case UnderlineStyle::DoublyUnderlined:\r\n-        return _Write(\"\\x1b[21m\");\r\n-    case UnderlineStyle::CurlyUnderlined:\r\n-        return _Write(\"\\x1b[4:3m\");\r\n-    case UnderlineStyle::DottedUnderlined:\r\n-        return _Write(\"\\x1b[4:4m\");\r\n-    case UnderlineStyle::DashedUnderlined:\r\n-        return _Write(\"\\x1b[4:5m\");\r\n-    default:\r\n-        return _SetUnderlined(true); // treat unknown style as singly underlined\r\n-    }\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the underline of the following text.\r\n-// Arguments:\r\n-// - isUnderlined: If true, we'll underline the text. Otherwise we'll remove the underline.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetUnderlined(const bool isUnderlined) noexcept\r\n-{\r\n-    return _Write(isUnderlined ? \"\\x1b[4m\" : \"\\x1b[24m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the overline of the following text.\r\n-// Arguments:\r\n-// - isOverlined: If true, we'll overline the text. Otherwise we'll remove the overline.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetOverlined(const bool isOverlined) noexcept\r\n-{\r\n-    return _Write(isOverlined ? \"\\x1b[53m\" : \"\\x1b[55m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the italics of the following text.\r\n-// Arguments:\r\n-// - isItalic: If true, we'll italicize the text. Otherwise we'll remove the italics.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetItalic(const bool isItalic) noexcept\r\n-{\r\n-    return _Write(isItalic ? \"\\x1b[3m\" : \"\\x1b[23m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the blinking of the following text.\r\n-// Arguments:\r\n-// - isBlinking: If true, we'll start the text blinking. Otherwise we'll stop the blinking.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetBlinking(const bool isBlinking) noexcept\r\n-{\r\n-    return _Write(isBlinking ? \"\\x1b[5m\" : \"\\x1b[25m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the visibility of the following text.\r\n-// Arguments:\r\n-// - isInvisible: If true, we'll make the text invisible. Otherwise we'll make it visible.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetInvisible(const bool isInvisible) noexcept\r\n-{\r\n-    return _Write(isInvisible ? \"\\x1b[8m\" : \"\\x1b[28m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the crossed out state of the following text.\r\n-// Arguments:\r\n-// - isCrossedOut: If true, we'll cross out the text. Otherwise we'll stop crossing out.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetCrossedOut(const bool isCrossedOut) noexcept\r\n-{\r\n-    return _Write(isCrossedOut ? \"\\x1b[9m\" : \"\\x1b[29m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to change the reversed state of the following text.\r\n-// Arguments:\r\n-// - isReversed: If true, we'll reverse the text. Otherwise we'll remove the reversed state.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetReverseVideo(const bool isReversed) noexcept\r\n-{\r\n-    return _Write(isReversed ? \"\\x1b[7m\" : \"\\x1b[27m\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Send a sequence to the connected terminal to switch to the alternate or main screen buffer.\r\n-// Arguments:\r\n-// - useAltBuffer: if true, switch to the alt buffer, otherwise to the main buffer.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SwitchScreenBuffer(const bool useAltBuffer) noexcept\r\n-{\r\n-    return _Write(useAltBuffer ? \"\\x1b[?1049h\" : \"\\x1b[?1049l\");\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to add a hyperlink to the terminal buffer\r\n-// Arguments:\r\n-// - The hyperlink URI\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_SetHyperlink(const std::wstring_view& uri, const std::wstring_view& customId, const uint16_t& numberId) noexcept\r\n-{\r\n-    // Opening OSC8 sequence\r\n-    if (customId.empty())\r\n-    {\r\n-        // This is the case of auto-assigned IDs:\r\n-        // send the auto-assigned ID, prefixed with the PID of this session\r\n-        // (we do this so different conpty sessions do not overwrite each other's hyperlinks)\r\n-        const auto sessionID = GetCurrentProcessId();\r\n-        const auto uriStr = til::u16u8(uri);\r\n-        return _WriteFormatted(FMT_COMPILE(\"\\x1b]8;id={}-{};{}\\x1b\\\\\"), sessionID, numberId, uriStr);\r\n-    }\r\n-    else\r\n-    {\r\n-        // This is the case of user-defined IDs:\r\n-        // send the user-defined ID, prefixed with a \"u\"\r\n-        // (we do this so no application can accidentally override a user defined ID)\r\n-        const auto uriStr = til::u16u8(uri);\r\n-        const auto customIdStr = til::u16u8(customId);\r\n-        return _WriteFormatted(FMT_COMPILE(\"\\x1b]8;id=u-{};{}\\x1b\\\\\"), customIdStr, uriStr);\r\n-    }\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Formats and writes a sequence to end a hyperlink to the terminal buffer\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_EndHyperlink() noexcept\r\n-{\r\n-    // Closing OSC8 sequence\r\n-    return _Write(\"\\x1b]8;;\\x1b\\\\\");\r\n-}\r\ndiff --git a/src/renderer/vt/Xterm256Engine.cpp b/src/renderer/vt/Xterm256Engine.cpp\ndeleted file mode 100644\nindex 7527db3dee7..00000000000\n--- a/src/renderer/vt/Xterm256Engine.cpp\n+++ /dev/null\n@@ -1,185 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-#include \"Xterm256Engine.hpp\"\r\n-#pragma hdrstop\r\n-using namespace Microsoft::Console;\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-Xterm256Engine::Xterm256Engine(_In_ wil::unique_hfile hPipe,\r\n-                               const Viewport initialViewport) :\r\n-    XtermEngine(std::move(hPipe), initialViewport, false)\r\n-{\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Write a VT sequence to change the current colors of text. Writes true RGB\r\n-//      color sequences.\r\n-// Arguments:\r\n-// - textAttributes - Text attributes to use for the colors and character rendition\r\n-// - renderSettings - The color table and modes required for rendering\r\n-// - pData - The interface to console data structures required for rendering\r\n-// - usingSoftFont - Whether we're rendering characters from a soft font\r\n-// - isSettingDefaultBrushes: indicates if we should change the background color of\r\n-//      the window. Unused for VT\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT Xterm256Engine::UpdateDrawingBrushes(const TextAttribute& textAttributes,\r\n-                                                           const RenderSettings& /*renderSettings*/,\r\n-                                                           const gsl::not_null<IRenderData*> pData,\r\n-                                                           const bool usingSoftFont,\r\n-                                                           const bool isSettingDefaultBrushes) noexcept\r\n-{\r\n-    RETURN_HR_IF(S_FALSE, _passthrough && isSettingDefaultBrushes);\r\n-\r\n-    RETURN_IF_FAILED(VtEngine::_RgbUpdateDrawingBrushes(textAttributes));\r\n-\r\n-    RETURN_IF_FAILED(_UpdateHyperlinkAttr(textAttributes, pData));\r\n-\r\n-    // If we're using a soft font, it should have already been mapped into the\r\n-    // G1 table, so we just need to switch between G0 and G1 when turning the\r\n-    // soft font on and off. We don't want to do this when setting the default\r\n-    // brushes, though, because that could result in an unnecessary G0 switch\r\n-    // at the start of every frame.\r\n-    if (usingSoftFont != _usingSoftFont && !isSettingDefaultBrushes)\r\n-    {\r\n-        RETURN_IF_FAILED(_Write(usingSoftFont ? \"\\x0E\" : \"\\x0F\"));\r\n-        _usingSoftFont = usingSoftFont;\r\n-    }\r\n-\r\n-    // Only do extended attributes in xterm-256color, as to not break telnet.exe.\r\n-    return _UpdateExtendedAttrs(textAttributes);\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Write a VT sequence to update the character rendition attributes.\r\n-// Arguments:\r\n-// - textAttributes - text attributes (intense, italic, underline, etc.) to use.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT Xterm256Engine::_UpdateExtendedAttrs(const TextAttribute& textAttributes) noexcept\r\n-{\r\n-    // Turning off Intense and Faint must be handled at the same time,\r\n-    // since there is only one sequence that resets both of them.\r\n-    const auto intenseTurnedOff = !textAttributes.IsIntense() && _lastTextAttributes.IsIntense();\r\n-    const auto faintTurnedOff = !textAttributes.IsFaint() && _lastTextAttributes.IsFaint();\r\n-    if (intenseTurnedOff || faintTurnedOff)\r\n-    {\r\n-        RETURN_IF_FAILED(_SetIntense(false));\r\n-        _lastTextAttributes.SetIntense(false);\r\n-        _lastTextAttributes.SetFaint(false);\r\n-    }\r\n-\r\n-    // Once we've handled the cases where they need to be turned off,\r\n-    // we can then check if either should be turned back on again.\r\n-    if (textAttributes.IsIntense() && !_lastTextAttributes.IsIntense())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetIntense(true));\r\n-        _lastTextAttributes.SetIntense(true);\r\n-    }\r\n-    if (textAttributes.IsFaint() && !_lastTextAttributes.IsFaint())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetFaint(true));\r\n-        _lastTextAttributes.SetFaint(true);\r\n-    }\r\n-\r\n-    // We check the singly, doubly underlined and extended styling together,\r\n-    // since only one of them can be active at a time.\r\n-    const auto ulStyle = textAttributes.GetUnderlineStyle();\r\n-    const auto lastUlStyle = _lastTextAttributes.GetUnderlineStyle();\r\n-    if (ulStyle != lastUlStyle)\r\n-    {\r\n-        // Reset doubly underlined if it was previously set. Avoids an edge case\r\n-        // where a pty client tracks doubly underlined and singly underlined separately,\r\n-        // and setting single underlined would leave the text doubly underlined\r\n-        // because it was never turned-off.\r\n-        if (lastUlStyle == UnderlineStyle::DoublyUnderlined && ulStyle != UnderlineStyle::NoUnderline)\r\n-        {\r\n-            RETURN_IF_FAILED(_SetUnderlined(false));\r\n-        }\r\n-        RETURN_IF_FAILED(_SetUnderlineExtended(ulStyle));\r\n-        _lastTextAttributes.SetUnderlineStyle(ulStyle);\r\n-    }\r\n-\r\n-    if (textAttributes.IsOverlined() != _lastTextAttributes.IsOverlined())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetOverlined(textAttributes.IsOverlined()));\r\n-        _lastTextAttributes.SetOverlined(textAttributes.IsOverlined());\r\n-    }\r\n-\r\n-    if (textAttributes.IsItalic() != _lastTextAttributes.IsItalic())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetItalic(textAttributes.IsItalic()));\r\n-        _lastTextAttributes.SetItalic(textAttributes.IsItalic());\r\n-    }\r\n-\r\n-    if (textAttributes.IsBlinking() != _lastTextAttributes.IsBlinking())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetBlinking(textAttributes.IsBlinking()));\r\n-        _lastTextAttributes.SetBlinking(textAttributes.IsBlinking());\r\n-    }\r\n-\r\n-    if (textAttributes.IsInvisible() != _lastTextAttributes.IsInvisible())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetInvisible(textAttributes.IsInvisible()));\r\n-        _lastTextAttributes.SetInvisible(textAttributes.IsInvisible());\r\n-    }\r\n-\r\n-    if (textAttributes.IsCrossedOut() != _lastTextAttributes.IsCrossedOut())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetCrossedOut(textAttributes.IsCrossedOut()));\r\n-        _lastTextAttributes.SetCrossedOut(textAttributes.IsCrossedOut());\r\n-    }\r\n-\r\n-    if (textAttributes.IsReverseVideo() != _lastTextAttributes.IsReverseVideo())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetReverseVideo(textAttributes.IsReverseVideo()));\r\n-        _lastTextAttributes.SetReverseVideo(textAttributes.IsReverseVideo());\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Write a VT sequence to start/stop a hyperlink\r\n-// Arguments:\r\n-// - textAttributes - Text attributes to use for the hyperlink ID\r\n-// - pData - The interface to console data structures required for rendering\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-HRESULT Microsoft::Console::Render::Xterm256Engine::_UpdateHyperlinkAttr(const TextAttribute& textAttributes,\r\n-                                                                         const gsl::not_null<IRenderData*> pData) noexcept\r\n-{\r\n-    if (textAttributes.GetHyperlinkId() != _lastTextAttributes.GetHyperlinkId())\r\n-    {\r\n-        if (textAttributes.IsHyperlink())\r\n-        {\r\n-            const auto id = textAttributes.GetHyperlinkId();\r\n-            const auto customId = pData->GetHyperlinkCustomId(id);\r\n-            RETURN_IF_FAILED(_SetHyperlink(pData->GetHyperlinkUri(id), customId, id));\r\n-        }\r\n-        else\r\n-        {\r\n-            RETURN_IF_FAILED(_EndHyperlink());\r\n-        }\r\n-        _lastTextAttributes.SetHyperlinkId(textAttributes.GetHyperlinkId());\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Manually emit a \"Erase Scrollback\" sequence to the connected terminal. We\r\n-//   need to do this in certain cases that we've identified where we believe the\r\n-//   client wanted the entire terminal buffer cleared, not just the viewport.\r\n-//   For more information, see GH#3126.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we wrote the sequences successfully, otherwise an appropriate HRESULT\r\n-[[nodiscard]] HRESULT Xterm256Engine::ManuallyClearScrollback() noexcept\r\n-{\r\n-    return _ClearScrollback();\r\n-}\r\ndiff --git a/src/renderer/vt/Xterm256Engine.hpp b/src/renderer/vt/Xterm256Engine.hpp\ndeleted file mode 100644\nindex 5c8cde61831..00000000000\n--- a/src/renderer/vt/Xterm256Engine.hpp\n+++ /dev/null\n@@ -1,49 +0,0 @@\n-/*++\r\n-Copyright (c) Microsoft Corporation\r\n-Licensed under the MIT license.\r\n-\r\n-Module Name:\r\n-- Xterm256Engine.hpp\r\n-\r\n-Abstract:\r\n-- This is the definition of the VT specific implementation of the renderer.\r\n-    This is the xterm-256color implementation, which supports advanced sequences such as\r\n-    inserting and deleting lines, and true rgb color.\r\n-\r\n-Author(s):\r\n-- Mike Griese (migrie) 01-Sept-2017\r\n---*/\r\n-\r\n-#pragma once\r\n-\r\n-#include \"XtermEngine.hpp\"\r\n-\r\n-namespace Microsoft::Console::Render\r\n-{\r\n-    class Xterm256Engine : public XtermEngine\r\n-    {\r\n-    public:\r\n-        Xterm256Engine(_In_ wil::unique_hfile hPipe,\r\n-                       const Microsoft::Console::Types::Viewport initialViewport);\r\n-\r\n-        virtual ~Xterm256Engine() override = default;\r\n-\r\n-        [[nodiscard]] HRESULT UpdateDrawingBrushes(const TextAttribute& textAttributes,\r\n-                                                   const RenderSettings& renderSettings,\r\n-                                                   const gsl::not_null<IRenderData*> pData,\r\n-                                                   const bool usingSoftFont,\r\n-                                                   const bool isSettingDefaultBrushes) noexcept override;\r\n-\r\n-        [[nodiscard]] HRESULT ManuallyClearScrollback() noexcept override;\r\n-\r\n-    private:\r\n-        [[nodiscard]] HRESULT _UpdateExtendedAttrs(const TextAttribute& textAttributes) noexcept;\r\n-        [[nodiscard]] HRESULT _UpdateHyperlinkAttr(const TextAttribute& textAttributes,\r\n-                                                   const gsl::not_null<IRenderData*> pData) noexcept;\r\n-\r\n-#ifdef UNIT_TESTING\r\n-        friend class VtRendererTest;\r\n-        friend class ConptyOutputTests;\r\n-#endif\r\n-    };\r\n-}\r\ndiff --git a/src/renderer/vt/XtermEngine.cpp b/src/renderer/vt/XtermEngine.cpp\ndeleted file mode 100644\nindex 0dc9c8384e4..00000000000\n--- a/src/renderer/vt/XtermEngine.cpp\n+++ /dev/null\n@@ -1,576 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-#include \"XtermEngine.hpp\"\r\n-#include \"../../types/inc/convert.hpp\"\r\n-#pragma hdrstop\r\n-using namespace Microsoft::Console;\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-XtermEngine::XtermEngine(_In_ wil::unique_hfile hPipe,\r\n-                         const Viewport initialViewport,\r\n-                         const bool fUseAsciiOnly) :\r\n-    VtEngine(std::move(hPipe), initialViewport),\r\n-    _fUseAsciiOnly(fUseAsciiOnly),\r\n-    _needToDisableCursor(false),\r\n-    // GH#12401: Ensure a DECTCEM cursor show/hide sequence\r\n-    // is emitted on the first frame no matter what.\r\n-    _lastCursorIsVisible(Tribool::Invalid),\r\n-    _nextCursorIsVisible(true)\r\n-{\r\n-    // Set out initial cursor position to -1, -1. This will force our initial\r\n-    //      paint to manually move the cursor to 0, 0, not just ignore it.\r\n-    _lastText = VtEngine::INVALID_COORDS;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Prepares internal structures for a painting operation. Turns the cursor\r\n-//      off, so we don't see it flashing all over the client's screen as we\r\n-//      paint the new contents.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we started to paint. S_FALSE if we didn't need to paint. HRESULT\r\n-//      error code if painting didn't start successfully, or we failed to write\r\n-//      the pipe.\r\n-[[nodiscard]] HRESULT XtermEngine::StartPaint() noexcept\r\n-{\r\n-    const auto hr = VtEngine::StartPaint();\r\n-    if (hr != S_OK)\r\n-    {\r\n-        // If _noFlushOnEnd was set, and we didn't return early, it would usually\r\n-        // have been reset in the EndPaint call. But since that's not going to\r\n-        // happen now, we need to reset it here, otherwise we may mistakenly skip\r\n-        // the flush on the next frame.\r\n-        if (!_noFlushOnEnd)\r\n-        {\r\n-            _Flush();\r\n-        }\r\n-        _noFlushOnEnd = false;\r\n-        return hr;\r\n-    }\r\n-\r\n-    _trace.TraceLastText(_lastText);\r\n-\r\n-    // Prep us to think that the cursor is not visible this frame. If it _is_\r\n-    // visible, then PaintCursor will be called, and we'll set this to true\r\n-    // during the frame.\r\n-    _nextCursorIsVisible = false;\r\n-    _startOfFrameBufferIndex = _buffer.size();\r\n-\r\n-    // Do not perform synchronization clearing in passthrough mode.\r\n-    // In passthrough, the terminal leads and we follow what it is\r\n-    // handling from the client application.\r\n-    // (This is in contrast to full PTY mode where WE, the ConPTY, lead and\r\n-    //  it follows our state.)\r\n-    if (_passthrough)\r\n-    {\r\n-        _firstPaint = false;\r\n-    }\r\n-\r\n-    if (_firstPaint)\r\n-    {\r\n-        // MSFT:17815688\r\n-        // If the caller requested to inherit the cursor, we shouldn't\r\n-        //      clear the screen on the first paint. Otherwise, we'll clear\r\n-        //      the screen on the first paint, just to make sure that the\r\n-        //      terminal's state is consistent with what we'll be rendering.\r\n-        RETURN_IF_FAILED(_ClearScreen());\r\n-        _clearedAllThisFrame = true;\r\n-        _firstPaint = false;\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - EndPaint helper to perform the final rendering steps. Turn the cursor back\r\n-//      on.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT XtermEngine::EndPaint() noexcept\r\n-{\r\n-    // If during the frame we determined that the cursor needed to be disabled,\r\n-    //      then insert a cursor off at the start of the buffer, and re-enable\r\n-    //      the cursor here.\r\n-    if (_needToDisableCursor)\r\n-    {\r\n-        // If the cursor was previously visible, let's hide it for this frame,\r\n-        // by prepending a cursor off.\r\n-        if (_lastCursorIsVisible != Tribool::False)\r\n-        {\r\n-            _buffer.insert(_startOfFrameBufferIndex, \"\\x1b[?25l\");\r\n-            _lastCursorIsVisible = Tribool::False;\r\n-        }\r\n-        // If the cursor was NOT previously visible, then that's fine! we don't\r\n-        // need to worry, it's already off.\r\n-    }\r\n-\r\n-    if (_lastCursorIsVisible != static_cast<Tribool>(_nextCursorIsVisible))\r\n-    {\r\n-        RETURN_IF_FAILED(_nextCursorIsVisible ? _ShowCursor() : _HideCursor());\r\n-        _lastCursorIsVisible = static_cast<Tribool>(_nextCursorIsVisible);\r\n-    }\r\n-\r\n-    RETURN_IF_FAILED(VtEngine::EndPaint());\r\n-\r\n-    _needToDisableCursor = false;\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Write a VT sequence to change the current colors of text. Only writes\r\n-//      16-color attributes.\r\n-// Arguments:\r\n-// - textAttributes - Text attributes to use for the colors and character rendition\r\n-// - renderSettings - The color table and modes required for rendering\r\n-// - pData - The interface to console data structures required for rendering\r\n-// - usingSoftFont - Whether we're rendering characters from a soft font\r\n-// - isSettingDefaultBrushes: indicates if we should change the background color of\r\n-//      the window. Unused for VT\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT XtermEngine::UpdateDrawingBrushes(const TextAttribute& textAttributes,\r\n-                                                        const RenderSettings& /*renderSettings*/,\r\n-                                                        const gsl::not_null<IRenderData*> /*pData*/,\r\n-                                                        const bool /*usingSoftFont*/,\r\n-                                                        const bool /*isSettingDefaultBrushes*/) noexcept\r\n-{\r\n-    // The base xterm mode only knows about 16 colors\r\n-    RETURN_IF_FAILED(VtEngine::_16ColorUpdateDrawingBrushes(textAttributes));\r\n-\r\n-    // And the only supported meta attributes are reverse video and underline\r\n-    if (textAttributes.IsReverseVideo() != _lastTextAttributes.IsReverseVideo())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetReverseVideo(textAttributes.IsReverseVideo()));\r\n-        _lastTextAttributes.SetReverseVideo(textAttributes.IsReverseVideo());\r\n-    }\r\n-    if (textAttributes.IsUnderlined() != _lastTextAttributes.IsUnderlined())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetUnderlined(textAttributes.IsUnderlined()));\r\n-        _lastTextAttributes.SetUnderlineStyle(textAttributes.GetUnderlineStyle());\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Draws the cursor on the screen\r\n-// Arguments:\r\n-// - options - Options that affect the presentation of the cursor\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT XtermEngine::PaintCursor(const CursorOptions& options) noexcept\r\n-{\r\n-    // PaintCursor is only called when the cursor is in fact visible in a single\r\n-    // frame. When this is called, mark _nextCursorIsVisible as true. At the end\r\n-    // of the frame, we'll decide to either turn the cursor on or not, based\r\n-    // upon the previous state.\r\n-\r\n-    // When this method is not called during a frame, it's because the cursor\r\n-    // was not visible. In that case, at the end of the frame,\r\n-    // _nextCursorIsVisible will still be false (from when we set it during\r\n-    // StartPaint)\r\n-    _nextCursorIsVisible = true;\r\n-\r\n-    // If we did a delayed EOL wrap because we actually wrapped the line here,\r\n-    // then don't PaintCursor. When we're at the EOL because we've wrapped, our\r\n-    // internal _lastText thinks the cursor is on the cell just past the right\r\n-    // of the viewport (ex { 120, 0 }). However, conhost thinks the cursor is\r\n-    // actually on the last cell of the row. So it'll tell us to paint the\r\n-    // cursor at { 119, 0 }. If we do that movement, then we'll break line\r\n-    // wrapping.\r\n-    // See GH#5113, GH#1245, GH#357\r\n-    const auto nextCursorPosition = options.coordCursor;\r\n-    // Only skip this paint when we think the cursor is in the cell\r\n-    // immediately off the edge of the terminal, and the actual cursor is in\r\n-    // the last cell of the row. We're in a deferred wrap, but the host\r\n-    // thinks the cursor is actually in-frame.\r\n-    // See ConptyRoundtripTests::DontWrapMoveCursorInSingleFrame\r\n-    const auto cursorIsInDeferredWrap = (nextCursorPosition.x == _lastText.x - 1) && (nextCursorPosition.y == _lastText.y);\r\n-    // If all three of these conditions are true, then:\r\n-    //   * cursorIsInDeferredWrap: The cursor is in a position where the line\r\n-    //     filled the last cell of the row, but the host tried to paint it in\r\n-    //     the last cell anyways\r\n-    //      - GH#5691 - If we're painting the frame because we circled the\r\n-    //        buffer, then the cursor might still be in the position it was\r\n-    //        before the text was written to the buffer to cause the buffer to\r\n-    //        circle. In that case, then we DON'T want to paint the cursor here\r\n-    //        either, because it'll cause us to manually break this line. That's\r\n-    //        okay though, the frame will be painted again, after the circling\r\n-    //        is complete.\r\n-    //   * _delayedEolWrap && _wrappedRow.has_value(): We think we've deferred\r\n-    //     the wrap of a line.\r\n-    // If they're all true, DON'T manually paint the cursor this frame.\r\n-    if (!((cursorIsInDeferredWrap || _circled) && _delayedEolWrap && _wrappedRow.has_value()))\r\n-    {\r\n-        return VtEngine::PaintCursor(options);\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Write a VT sequence to move the cursor to the specified coordinates. We\r\n-//      also store the last place we left the cursor for future optimizations.\r\n-//  If the cursor only needs to go to the origin, only write the home sequence.\r\n-//  If the new cursor is only down one line from the current, only write a newline\r\n-//  If the new cursor is only down one line and at the start of the line, write\r\n-//      a carriage return.\r\n-//  Otherwise just write the whole sequence for moving it.\r\n-// Arguments:\r\n-// - coord: location to move the cursor to.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT XtermEngine::_MoveCursor(const til::point coord) noexcept\r\n-{\r\n-    auto hr = S_OK;\r\n-    const auto originalPos = _lastText;\r\n-    _trace.TraceMoveCursor(_lastText, coord);\r\n-    if (coord.x != _lastText.x || coord.y != _lastText.y)\r\n-    {\r\n-        if (coord.x == 0 && coord.y == 0)\r\n-        {\r\n-            _needToDisableCursor = true;\r\n-            hr = _CursorHome();\r\n-        }\r\n-        else if (_resized && _resizeQuirk)\r\n-        {\r\n-            hr = _CursorPosition(coord);\r\n-        }\r\n-        else if (coord.x == 0 && coord.y == (_lastText.y + 1))\r\n-        {\r\n-            // Down one line, at the start of the line.\r\n-\r\n-            // If the previous line wrapped, then the cursor is already at this\r\n-            //      position, we just don't know it yet. Don't emit anything.\r\n-            auto previousLineWrapped = false;\r\n-            if (_wrappedRow.has_value())\r\n-            {\r\n-                previousLineWrapped = coord.y == _wrappedRow.value() + 1;\r\n-            }\r\n-\r\n-            if (previousLineWrapped)\r\n-            {\r\n-                _trace.TraceWrapped();\r\n-                hr = S_OK;\r\n-            }\r\n-            else\r\n-            {\r\n-                std::string seq = \"\\r\\n\";\r\n-                hr = _Write(seq);\r\n-            }\r\n-        }\r\n-        else if (_delayedEolWrap)\r\n-        {\r\n-            // GH#1245, GH#357 - If we were in the delayed EOL wrap state, make\r\n-            // sure to _manually_ position the cursor now, with a full CUP\r\n-            // sequence, don't try and be clever with \\b or \\r or other control\r\n-            // sequences. Different terminals (conhost, gnome-terminal, wt) all\r\n-            // behave differently with how the cursor behaves at an end of line.\r\n-            // This is the only solution that works in all of them, and also\r\n-            // works wrapped lines emitted by conpty.\r\n-            //\r\n-            // Make sure to do this _after_ the possible \\r\\n branch above,\r\n-            // otherwise we might accidentally break wrapped lines (GH#405)\r\n-            hr = _CursorPosition(coord);\r\n-        }\r\n-        else if (coord.x == 0 && coord.y == _lastText.y)\r\n-        {\r\n-            // Start of this line\r\n-            std::string seq = \"\\r\";\r\n-            hr = _Write(seq);\r\n-        }\r\n-        else if (coord.x == _lastText.x && coord.y == (_lastText.y + 1))\r\n-        {\r\n-            // Down one line, same X position\r\n-            std::string seq = \"\\n\";\r\n-            hr = _Write(seq);\r\n-        }\r\n-        else if (coord.x == (_lastText.x - 1) && coord.y == (_lastText.y))\r\n-        {\r\n-            // Back one char, same Y position\r\n-            std::string seq = \"\\b\";\r\n-            hr = _Write(seq);\r\n-        }\r\n-        else if (coord.y == _lastText.y && coord.x > _lastText.x)\r\n-        {\r\n-            // Same line, forward some distance\r\n-            auto distance = coord.x - _lastText.x;\r\n-            hr = _CursorForward(distance);\r\n-        }\r\n-        else\r\n-        {\r\n-            _needToDisableCursor = true;\r\n-            hr = _CursorPosition(coord);\r\n-        }\r\n-\r\n-        if (SUCCEEDED(hr))\r\n-        {\r\n-            _lastText = coord;\r\n-        }\r\n-    }\r\n-\r\n-    _deferredCursorPos = INVALID_COORDS;\r\n-\r\n-    _wrappedRow = std::nullopt;\r\n-    _delayedEolWrap = false;\r\n-\r\n-    return hr;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Scrolls the existing data on the in-memory frame by the scroll region\r\n-//      deltas we have collectively received through the Invalidate methods\r\n-//      since the last time this was called.\r\n-//  Move the cursor to the origin, and insert or delete rows as appropriate.\r\n-//      The inserted rows will be blank, but marked invalid by InvalidateScroll,\r\n-//      so they will later be written by PaintBufferLine.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT XtermEngine::ScrollFrame() noexcept\r\n-try\r\n-{\r\n-    _trace.TraceScrollFrame(_scrollDelta);\r\n-\r\n-    if (_scrollDelta.x != 0)\r\n-    {\r\n-        // No easy way to shift left-right. Everything needs repainting.\r\n-        return InvalidateAll();\r\n-    }\r\n-    if (_scrollDelta.y == 0)\r\n-    {\r\n-        // There's nothing to do here. Do nothing.\r\n-        return S_OK;\r\n-    }\r\n-\r\n-    const auto dy = _scrollDelta.y;\r\n-    const auto absDy = abs(dy);\r\n-\r\n-    // Save the old wrap state here. We're going to clear it so that\r\n-    // _MoveCursor will definitely move us to the right position. We'll\r\n-    // restore the state afterwards.\r\n-    const auto oldWrappedRow = _wrappedRow;\r\n-    const auto oldDelayedEolWrap = _delayedEolWrap;\r\n-    _delayedEolWrap = false;\r\n-    _wrappedRow = std::nullopt;\r\n-\r\n-    if (dy < 0)\r\n-    {\r\n-        // TODO GH#5228 - We could optimize this by only doing this newline work\r\n-        // when there's more invalid than just the bottom line. If only the\r\n-        // bottom line is invalid, then the next thing the Renderer is going to\r\n-        // tell us to do is print the new line at the bottom of the viewport,\r\n-        // and _MoveCursor will automatically give us the newline we want.\r\n-        // When that's implemented, we'll probably want to make sure to add a\r\n-        //   _lastText.y += dy;\r\n-        // statement here.\r\n-\r\n-        // Move the cursor to the bottom of the current viewport\r\n-        const auto bottom = _lastViewport.BottomInclusive();\r\n-        RETURN_IF_FAILED(_MoveCursor({ 0, bottom }));\r\n-        // Emit some number of newlines to create space in the buffer.\r\n-        RETURN_IF_FAILED(_Write(std::string(absDy, '\\n')));\r\n-    }\r\n-    else if (dy > 0)\r\n-    {\r\n-        // If we've scrolled _down_, then move the cursor to the top of the\r\n-        // buffer, and insert some newlines using the InsertLines VT sequence\r\n-        RETURN_IF_FAILED(_MoveCursor({ 0, 0 }));\r\n-        RETURN_IF_FAILED(_InsertLine(absDy));\r\n-    }\r\n-\r\n-    // Restore our wrap state.\r\n-    _wrappedRow = oldWrappedRow;\r\n-    _delayedEolWrap = oldDelayedEolWrap;\r\n-\r\n-    // Shift our internal tracker of the last text position according to how\r\n-    // much we've scrolled. If we manually scroll the buffer right now, by\r\n-    // moving the cursor to the bottom row of the viewport and emitting a\r\n-    // newline, we'll cause any wrapped lines to get broken.\r\n-    //\r\n-    // Instead, we'll just update our internal tracker of where the buffer\r\n-    // contents are. On this frame, we'll then still move the cursor correctly\r\n-    // relative to the new frame contents. To do this, we'll shift our\r\n-    // coordinates we're tracking, like the row that we wrapped on and the\r\n-    // position we think we left the cursor.\r\n-    //\r\n-    // See GH#5113\r\n-    _trace.TraceLastText(_lastText);\r\n-    if (_wrappedRow.has_value())\r\n-    {\r\n-        _wrappedRow.value() += dy;\r\n-        _trace.TraceSetWrapped(_wrappedRow.value());\r\n-    }\r\n-\r\n-    if (_delayedEolWrap && _wrappedRow.has_value())\r\n-    {\r\n-        // If we wrapped the last line, and we're in the middle of painting it,\r\n-        // then the newline we did above just manually broke the line. What\r\n-        // we're doing here is a hack: we're going to manually re-invalidate the\r\n-        // last character of the wrapped row. When the PaintBufferLine calls\r\n-        // come back through, we'll paint this last character again, causing us\r\n-        // to get into the wrapped state once again. This is the only way to\r\n-        // ensure that if a line was wrapped, and we painted the first line in\r\n-        // one frame, and the second line in another frame that included other\r\n-        // changes _above_ the wrapped line, that we maintain the wrap state in\r\n-        // the Terminal.\r\n-        const til::rect lastCellOfWrappedRow{\r\n-            til::point{ _lastViewport.RightInclusive(), _wrappedRow.value() },\r\n-            til::size{ 1, 1 }\r\n-        };\r\n-        _trace.TraceInvalidate(lastCellOfWrappedRow);\r\n-        _invalidMap.set(lastCellOfWrappedRow);\r\n-    }\r\n-\r\n-    // If the entire viewport was invalidated this frame, don't mark the bottom\r\n-    // line as new. There are cases where this can cause visual artifacts - see\r\n-    // GH#5039 and ConptyRoundtripTests::ClearHostTrickeryTest\r\n-    const auto allInvalidated = _invalidMap.all();\r\n-    _newBottomLine = !allInvalidated;\r\n-\r\n-    // GH#5502 - keep track of the BG color we had when we emitted this new\r\n-    // bottom line. If the color changes by the time we get to printing that\r\n-    // line, we'll need to make sure that we don't do any optimizations like\r\n-    // _removing spaces_, because the background color of the spaces will be\r\n-    // important information to send to the connected Terminal.\r\n-    if (_newBottomLine)\r\n-    {\r\n-        _newBottomLineBG = _lastTextAttributes.GetBackground();\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-CATCH_RETURN();\r\n-\r\n-// Routine Description:\r\n-// - Notifies us that the console is attempting to scroll the existing screen\r\n-//      area. Add the top or bottom rows to the invalid region, and update the\r\n-//      total scroll delta accumulated this frame.\r\n-// Arguments:\r\n-// - pcoordDelta - Pointer to character dimension (til::point) of the distance the\r\n-//      console would like us to move while scrolling.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for safemath failure\r\n-[[nodiscard]] HRESULT XtermEngine::InvalidateScroll(const til::point* const pcoordDelta) noexcept\r\n-try\r\n-{\r\n-    const auto delta{ *pcoordDelta };\r\n-\r\n-    if (delta != til::point{ 0, 0 })\r\n-    {\r\n-        _trace.TraceInvalidateScroll(delta);\r\n-\r\n-        // Scroll the current offset and invalidate the revealed area\r\n-        _invalidMap.translate(delta, true);\r\n-\r\n-        _scrollDelta += delta;\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-CATCH_RETURN();\r\n-\r\n-// Routine Description:\r\n-// - Draws one line of the buffer to the screen. Writes the characters to the\r\n-//      pipe, encoded in UTF-8 or ASCII only, depending on the VtIoMode.\r\n-//      (See descriptions of both implementations for details.)\r\n-// Arguments:\r\n-// - clusters - text and column counts for each piece of text.\r\n-// - coord - character coordinate target to render within viewport\r\n-// - trimLeft - This specifies whether to trim one character width off the left\r\n-//      side of the output. Used for drawing the right-half only of a\r\n-//      double-wide character.\r\n-// - lineWrapped: true if this run we're painting is the end of a line that\r\n-//   wrapped. If we're not painting the last column of a wrapped line, then this\r\n-//   will be false.\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT XtermEngine::PaintBufferLine(const std::span<const Cluster> clusters,\r\n-                                                   const til::point coord,\r\n-                                                   const bool /*trimLeft*/,\r\n-                                                   const bool lineWrapped) noexcept\r\n-{\r\n-    return _fUseAsciiOnly ?\r\n-               VtEngine::_PaintAsciiBufferLine(clusters, coord) :\r\n-               VtEngine::_PaintUtf8BufferLine(clusters, coord, lineWrapped);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Wrapper for _Write. Write either an ascii-only, or a\r\n-//      proper utf-8 string, depending on our mode.\r\n-// Arguments:\r\n-// - wstr - wstring of text to be written\r\n-// - flush - set to true if the string should be flushed immediately\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from either conversion or writing pipe.\r\n-[[nodiscard]] HRESULT XtermEngine::WriteTerminalW(const std::wstring_view wstr, const bool flush) noexcept\r\n-{\r\n-    RETURN_IF_FAILED(_fUseAsciiOnly ?\r\n-                         VtEngine::_WriteTerminalAscii(wstr) :\r\n-                         VtEngine::_WriteTerminalUtf8(wstr));\r\n-    // GH#4106, GH#2011, GH#13710 - WriteTerminalW is only ever called by the\r\n-    // StateMachine, when we've encountered a string we don't understand. When\r\n-    // this happens, we will trigger a new frame in the renderer, and\r\n-    // immediately buffer this wstr (representing the sequence we didn't\r\n-    // understand). We won't immediately _Flush to the terminal - that might\r\n-    // cause flickering (where we've buffered some state but not the whole\r\n-    // \"frame\" as specified by the app). We'll just immediately buffer this\r\n-    // sequence, and flush it when the render thread comes around to paint the\r\n-    // frame normally, unless a flush has been explicitly requested.\r\n-    if (flush)\r\n-    {\r\n-        _flushImpl();\r\n-    }\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Sends a command to set the terminal's window to visible or hidden\r\n-// Arguments:\r\n-// - showOrHide - True if show; false if hide.\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from either conversion or writing pipe.\r\n-[[nodiscard]] HRESULT XtermEngine::SetWindowVisibility(const bool showOrHide) noexcept\r\n-{\r\n-    if (showOrHide)\r\n-    {\r\n-        RETURN_IF_FAILED(_Write(\"\\x1b[1t\"));\r\n-    }\r\n-    else\r\n-    {\r\n-        RETURN_IF_FAILED(_Write(\"\\x1b[2t\"));\r\n-    }\r\n-    _Flush();\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Updates the window's title string. Emits the VT sequence to SetWindowTitle.\r\n-// Arguments:\r\n-// - newTitle: the new string to use for the title of the window\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT XtermEngine::_DoUpdateTitle(const std::wstring_view newTitle) noexcept\r\n-{\r\n-    // inbox telnet uses xterm-ascii as its mode. If we're in ascii mode, don't\r\n-    //      do anything, to maintain compatibility.\r\n-    if (_fUseAsciiOnly)\r\n-    {\r\n-        return S_OK;\r\n-    }\r\n-\r\n-    try\r\n-    {\r\n-        const auto converted = ConvertToA(CP_UTF8, newTitle);\r\n-        return VtEngine::_ChangeTitle(converted);\r\n-    }\r\n-    CATCH_RETURN();\r\n-}\r\ndiff --git a/src/renderer/vt/XtermEngine.hpp b/src/renderer/vt/XtermEngine.hpp\ndeleted file mode 100644\nindex 7449fb3e38b..00000000000\n--- a/src/renderer/vt/XtermEngine.hpp\n+++ /dev/null\n@@ -1,82 +0,0 @@\n-/*++\r\n-Copyright (c) Microsoft Corporation\r\n-Licensed under the MIT license.\r\n-\r\n-Module Name:\r\n-- XtermEngine.hpp\r\n-\r\n-Abstract:\r\n-- This is the definition of the VT specific implementation of the renderer.\r\n-    This is the xterm implementation, which supports advanced sequences such as\r\n-    inserting and deleting lines, but only 16 colors.\r\n-\r\n-    This engine supports both xterm and xterm-ascii VT modes.\r\n-    The difference being that xterm-ascii will render any characters above 0x7f\r\n-        as '?', in order to support older legacy tools.\r\n-\r\n-Author(s):\r\n-- Mike Griese (migrie) 01-Sept-2017\r\n---*/\r\n-\r\n-#pragma once\r\n-\r\n-#include \"vtrenderer.hpp\"\r\n-\r\n-namespace Microsoft::Console::Render\r\n-{\r\n-    class XtermEngine : public VtEngine\r\n-    {\r\n-    public:\r\n-        XtermEngine(_In_ wil::unique_hfile hPipe,\r\n-                    const Microsoft::Console::Types::Viewport initialViewport,\r\n-                    const bool fUseAsciiOnly);\r\n-\r\n-        virtual ~XtermEngine() override = default;\r\n-\r\n-        [[nodiscard]] HRESULT StartPaint() noexcept override;\r\n-        [[nodiscard]] HRESULT EndPaint() noexcept override;\r\n-\r\n-        [[nodiscard]] HRESULT PaintCursor(const CursorOptions& options) noexcept override;\r\n-\r\n-        [[nodiscard]] virtual HRESULT UpdateDrawingBrushes(const TextAttribute& textAttributes,\r\n-                                                           const RenderSettings& renderSettings,\r\n-                                                           const gsl::not_null<IRenderData*> pData,\r\n-                                                           const bool usingSoftFont,\r\n-                                                           const bool isSettingDefaultBrushes) noexcept override;\r\n-        [[nodiscard]] HRESULT PaintBufferLine(const std::span<const Cluster> clusters,\r\n-                                              const til::point coord,\r\n-                                              const bool trimLeft,\r\n-                                              const bool lineWrapped) noexcept override;\r\n-        [[nodiscard]] HRESULT ScrollFrame() noexcept override;\r\n-\r\n-        [[nodiscard]] HRESULT InvalidateScroll(const til::point* const pcoordDelta) noexcept override;\r\n-\r\n-        [[nodiscard]] HRESULT WriteTerminalW(const std::wstring_view str, const bool flush) noexcept override;\r\n-\r\n-        [[nodiscard]] HRESULT SetWindowVisibility(const bool showOrHide) noexcept override;\r\n-\r\n-    protected:\r\n-        // I'm using a non-class enum here, so that the values\r\n-        // are trivially convertible and comparable to bool.\r\n-        enum class Tribool : uint8_t\r\n-        {\r\n-            False = 0,\r\n-            True,\r\n-            Invalid,\r\n-        };\r\n-\r\n-        const bool _fUseAsciiOnly;\r\n-        bool _needToDisableCursor;\r\n-        Tribool _lastCursorIsVisible;\r\n-        bool _nextCursorIsVisible;\r\n-\r\n-        [[nodiscard]] HRESULT _MoveCursor(const til::point coord) noexcept override;\r\n-\r\n-        [[nodiscard]] HRESULT _DoUpdateTitle(const std::wstring_view newTitle) noexcept override;\r\n-\r\n-#ifdef UNIT_TESTING\r\n-        friend class VtRendererTest;\r\n-        friend class ConptyOutputTests;\r\n-#endif\r\n-    };\r\n-}\r\ndiff --git a/src/renderer/vt/dirs b/src/renderer/vt/dirs\ndeleted file mode 100644\nindex 4d3cf932b5e..00000000000\n--- a/src/renderer/vt/dirs\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-DIRS= \\\r\n-     lib \\\r\n-     ut_lib \\\r\ndiff --git a/src/renderer/vt/invalidate.cpp b/src/renderer/vt/invalidate.cpp\ndeleted file mode 100644\nindex d67ca839437..00000000000\n--- a/src/renderer/vt/invalidate.cpp\n+++ /dev/null\n@@ -1,144 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-\r\n-#include \"vtrenderer.hpp\"\r\n-\r\n-using namespace Microsoft::Console::Types;\r\n-#pragma hdrstop\r\n-\r\n-using namespace Microsoft::Console::Render;\r\n-\r\n-// Routine Description:\r\n-// - Notifies us that the system has requested a particular pixel area of the\r\n-//      client rectangle should be redrawn. (On WM_PAINT)\r\n-//  For VT, this doesn't mean anything. So do nothing.\r\n-// Arguments:\r\n-// - prcDirtyClient - Pointer to pixel area (til::rect) of client region the system\r\n-//      believes is dirty\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::InvalidateSystem(const til::rect* const /*prcDirtyClient*/) noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Notifies us that the console has changed the selection region and would\r\n-//      like it updated\r\n-// Arguments:\r\n-// - rectangles - Vector of rectangles to draw, line by line\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::InvalidateSelection(const std::vector<til::rect>& /*rectangles*/) noexcept\r\n-{\r\n-    // Selection shouldn't be handled bt the VT Renderer Host, it should be\r\n-    //      handled by the client.\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Notifies us that the console has changed the character region specified.\r\n-// - NOTE: This typically triggers on cursor or text buffer changes\r\n-// Arguments:\r\n-// - psrRegion - Character region (til::rect) that has been changed\r\n-// Return Value:\r\n-// - S_OK, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::Invalidate(const til::rect* const psrRegion) noexcept\r\n-try\r\n-{\r\n-    _trace.TraceInvalidate(*psrRegion);\r\n-    _invalidMap.set(*psrRegion);\r\n-    return S_OK;\r\n-}\r\n-CATCH_RETURN();\r\n-\r\n-// Routine Description:\r\n-// - Notifies us that the console has changed the position of the cursor.\r\n-// Arguments:\r\n-// - psrRegion - the region covered by the cursor\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::InvalidateCursor(const til::rect* const psrRegion) noexcept\r\n-{\r\n-    // If we just inherited the cursor, we're going to get an InvalidateCursor\r\n-    //      for both where the old cursor was, and where the new cursor is\r\n-    //      (the inherited location). (See Cursor.cpp:Cursor::SetPosition)\r\n-    // We should ignore the first one, but after that, if the client application\r\n-    //      is moving the cursor around in the viewport, move our virtual top\r\n-    //      up to meet their changes.\r\n-    if (!_skipCursor && _virtualTop > psrRegion->top)\r\n-    {\r\n-        _virtualTop = psrRegion->top;\r\n-    }\r\n-    _skipCursor = false;\r\n-\r\n-    _cursorMoved = psrRegion->origin() != _lastCursorOrigin;\r\n-    _lastCursorOrigin = psrRegion->origin();\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Notifies to repaint everything.\r\n-// - NOTE: Use sparingly. Only use when something that could affect the entire\r\n-//      frame simultaneously occurs.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::InvalidateAll() noexcept\r\n-try\r\n-{\r\n-    _trace.TraceInvalidateAll(_lastViewport.ToOrigin().ToExclusive());\r\n-    _invalidMap.set_all();\r\n-    return S_OK;\r\n-}\r\n-CATCH_RETURN();\r\n-\r\n-// Method Description:\r\n-// - Notifies us that we're about to circle the buffer, giving us a chance to\r\n-//      force a repaint before the buffer contents are lost. The VT renderer\r\n-//      needs to be able to render all text before it's lost, so we return true.\r\n-// Arguments:\r\n-// - Receives a bool indicating if we should force the repaint.\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::InvalidateFlush(_In_ const bool circled, _Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    *pForcePaint = true;\r\n-\r\n-    // Keep track of the fact that we circled, we'll need to do some work on\r\n-    //      end paint to specifically handle this.\r\n-    _circled = circled;\r\n-\r\n-    // If we flushed for any reason other than circling (i.e, a sequence that we\r\n-    // didn't understand), we don't need to push the buffer out on EndPaint.\r\n-    _noFlushOnEnd = !circled;\r\n-\r\n-    _trace.TraceTriggerCircling(*pForcePaint);\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Notifies us that we're about to be torn down. This gives us a last chance\r\n-//      to force a repaint before the buffer contents are lost. The VT renderer\r\n-//      needs to be able to render all text before it's lost, so we return true.\r\n-// Arguments:\r\n-// - Receives a bool indicating if we should force the repaint.\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    // This must be kept in sync with RequestWin32Input().\r\n-    // It ensures that we disable the modes that we requested on startup.\r\n-    // Linux shells for instance don't understand the win32-input-mode 9001.\r\n-    //\r\n-    // This can be here, instead of being appended at the end of this final rendering pass,\r\n-    // because these two states happen to have no influence on the caller's VT parsing.\r\n-    std::ignore = _Write(\"\\033[?9001l\\033[?1004l\");\r\n-\r\n-    *pForcePaint = true;\r\n-    return S_OK;\r\n-}\r\ndiff --git a/src/renderer/vt/lib/sources b/src/renderer/vt/lib/sources\ndeleted file mode 100644\nindex b2783896d4f..00000000000\n--- a/src/renderer/vt/lib/sources\n+++ /dev/null\n@@ -1,8 +0,0 @@\n-!include ..\\sources.inc\r\n-\r\n-# -------------------------------------\r\n-# Program Information\r\n-# -------------------------------------\r\n-\r\n-TARGETNAME              = ConRenderVt\r\n-TARGETTYPE              = LIBRARY\r\ndiff --git a/src/renderer/vt/lib/sources.dep b/src/renderer/vt/lib/sources.dep\ndeleted file mode 100644\nindex bc61c95c6b0..00000000000\n--- a/src/renderer/vt/lib/sources.dep\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-BUILD_PASS1_CONSUMES= \\\r\n-    onecore\\windows\\vcpkg|PASS1 \\\r\n-\r\ndiff --git a/src/renderer/vt/lib/vt.vcxproj b/src/renderer/vt/lib/vt.vcxproj\ndeleted file mode 100644\nindex 37598326831..00000000000\n--- a/src/renderer/vt/lib/vt.vcxproj\n+++ /dev/null\n@@ -1,18 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n-<Project DefaultTargets=\"Build\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n-  <PropertyGroup>\r\n-    <ProjectGuid>{990F2657-8580-4828-943F-5DD657D11842}</ProjectGuid>\r\n-    <Keyword>Win32Proj</Keyword>\r\n-    <RootNamespace>vt</RootNamespace>\r\n-    <ProjectName>RendererVt</ProjectName>\r\n-    <TargetName>ConRenderVt</TargetName>\r\n-    <ConfigurationType>StaticLibrary</ConfigurationType>\r\n-  </PropertyGroup>\r\n-  <Import Project=\"$(SolutionDir)src\\common.build.pre.props\"/>\r\n-  <Import Project=\"$(SolutionDir)src\\common.nugetversions.props\"/>\r\n-  <!-- DONT ADD NEW FILES HERE, ADD THEM TO vt-renderer-common.vcxitems -->\r\n-  <Import Project=\"$(SolutionDir)src\\renderer\\vt\\vt-renderer-common.vcxitems\" />\r\n-  <!-- Careful reordering these. Some default props (contained in these files) are order sensitive. -->\r\n-  <Import Project=\"$(SolutionDir)src\\common.build.post.props\"/>\r\n-  <Import Project=\"$(SolutionDir)src\\common.nugetversions.targets\"/>\r\n-</Project>\r\ndiff --git a/src/renderer/vt/lib/vt.vcxproj.filters b/src/renderer/vt/lib/vt.vcxproj.filters\ndeleted file mode 100644\nindex 31413c8a323..00000000000\n--- a/src/renderer/vt/lib/vt.vcxproj.filters\n+++ /dev/null\n@@ -1,42 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n-<Project ToolsVersion=\"4.0\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n-  <ItemGroup>\r\n-    <Filter Include=\"Source Files\">\r\n-      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>\r\n-      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>\r\n-    </Filter>\r\n-    <Filter Include=\"Header Files\">\r\n-      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>\r\n-      <Extensions>h;hh;hpp;hxx;hm;inl;inc;xsd</Extensions>\r\n-    </Filter>\r\n-    <Filter Include=\"Resource Files\">\r\n-      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>\r\n-      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>\r\n-    </Filter>\r\n-  </ItemGroup>\r\n-  <ItemGroup>\r\n-    <ClCompile Include=\"..\\invalidate.cpp\">\r\n-      <Filter>Source Files</Filter>\r\n-    </ClCompile>\r\n-    <ClCompile Include=\"..\\math.cpp\">\r\n-      <Filter>Source Files</Filter>\r\n-    </ClCompile>\r\n-    <ClCompile Include=\"..\\paint.cpp\">\r\n-      <Filter>Source Files</Filter>\r\n-    </ClCompile>\r\n-    <ClCompile Include=\"..\\state.cpp\">\r\n-      <Filter>Source Files</Filter>\r\n-    </ClCompile>\r\n-    <ClCompile Include=\"..\\precomp.cpp\">\r\n-      <Filter>Source Files</Filter>\r\n-    </ClCompile>\r\n-  </ItemGroup>\r\n-  <ItemGroup>\r\n-    <ClInclude Include=\"..\\gdirenderer.hpp\">\r\n-      <Filter>Header Files</Filter>\r\n-    </ClInclude>\r\n-    <ClInclude Include=\"..\\precomp.h\">\r\n-      <Filter>Header Files</Filter>\r\n-    </ClInclude>\r\n-  </ItemGroup>\r\n-</Project>\n\\ No newline at end of file\ndiff --git a/src/renderer/vt/math.cpp b/src/renderer/vt/math.cpp\ndeleted file mode 100644\nindex 354ca0e9925..00000000000\n--- a/src/renderer/vt/math.cpp\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-\r\n-#include \"vtrenderer.hpp\"\r\n-\r\n-#pragma hdrstop\r\n-\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-// Routine Description:\r\n-// - Gets the size in characters of the current dirty portion of the frame.\r\n-// Arguments:\r\n-// - area - The character dimensions of the current dirty area of the frame.\r\n-//          This is an Inclusive rect.\r\n-// Return Value:\r\n-// - S_OK.\r\n-[[nodiscard]] HRESULT VtEngine::GetDirtyArea(std::span<const til::rect>& area) noexcept\r\n-{\r\n-    area = _invalidMap.runs();\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Uses the currently selected font to determine how wide the given character will be when rendered.\r\n-// - NOTE: Only supports determining half-width/full-width status for CJK-type languages (e.g. is it 1 character wide or 2. a.k.a. is it a rectangle or square.)\r\n-// Arguments:\r\n-// - glyph - utf16 encoded codepoint to check\r\n-// - pResult - receives return value, True if it is full-width (2 wide). False if it is half-width (1 wide).\r\n-// Return Value:\r\n-// - S_FALSE: This is unsupported by the VT Renderer and should use another engine's value.\r\n-[[nodiscard]] HRESULT VtEngine::IsGlyphWideByFont(const std::wstring_view /*glyph*/, _Out_ bool* const pResult) noexcept\r\n-{\r\n-    *pResult = false;\r\n-    return S_FALSE;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Performs a \"CombineRect\" with the \"OR\" operation.\r\n-// - Basically extends the existing rect outward to also encompass the passed-in region.\r\n-// Arguments:\r\n-// - pRectExisting - Expand this rectangle to encompass the add rect.\r\n-// - pRectToOr - Add this rectangle to the existing one.\r\n-// Return Value:\r\n-// - <none>\r\n-void VtEngine::_OrRect(_Inout_ til::inclusive_rect* const pRectExisting, const til::inclusive_rect* const pRectToOr) const\r\n-{\r\n-    pRectExisting->left = std::min(pRectExisting->left, pRectToOr->left);\r\n-    pRectExisting->top = std::min(pRectExisting->top, pRectToOr->top);\r\n-    pRectExisting->right = std::max(pRectExisting->right, pRectToOr->right);\r\n-    pRectExisting->bottom = std::max(pRectExisting->bottom, pRectToOr->bottom);\r\n-}\r\ndiff --git a/src/renderer/vt/paint.cpp b/src/renderer/vt/paint.cpp\ndeleted file mode 100644\nindex 69985b27eec..00000000000\n--- a/src/renderer/vt/paint.cpp\n+++ /dev/null\n@@ -1,722 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-\r\n-#include \"vtrenderer.hpp\"\r\n-#include \"../../inc/conattrs.hpp\"\r\n-#include \"../../types/inc/convert.hpp\"\r\n-\r\n-#pragma hdrstop\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-// Routine Description:\r\n-// - Prepares internal structures for a painting operation.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we started to paint. S_FALSE if we didn't need to paint.\r\n-//      HRESULT error code if painting didn't start successfully.\r\n-[[nodiscard]] HRESULT VtEngine::StartPaint() noexcept\r\n-{\r\n-    // When unit testing, there may be no pipe, but we still need to paint.\r\n-    if (!_hFile)\r\n-    {\r\n-        return S_OK;\r\n-    }\r\n-\r\n-    // If we're using line renditions, and this is a full screen paint, we can\r\n-    // potentially stop using them at the end of this frame.\r\n-    _stopUsingLineRenditions = _usingLineRenditions && _AllIsInvalid();\r\n-\r\n-    // If there's nothing to do, we won't need to paint.\r\n-    auto somethingToDo = _invalidMap.any() ||\r\n-                         _scrollDelta != til::point{ 0, 0 } ||\r\n-                         _cursorMoved ||\r\n-                         _titleChanged;\r\n-\r\n-    _trace.TraceStartPaint(!somethingToDo,\r\n-                           _invalidMap,\r\n-                           _lastViewport.ToExclusive(),\r\n-                           _scrollDelta,\r\n-                           _cursorMoved,\r\n-                           _wrappedRow);\r\n-\r\n-    return somethingToDo ? S_OK : S_FALSE;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - EndPaint helper to perform the final cleanup after painting. If we\r\n-//      returned S_FALSE from StartPaint, there's no guarantee this was called.\r\n-//      That's okay however, EndPaint only zeros structs that would be zero if\r\n-//      StartPaint returns S_FALSE.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::EndPaint() noexcept\r\n-{\r\n-    _trace.TraceEndPaint();\r\n-\r\n-    _invalidMap.reset_all();\r\n-\r\n-    _scrollDelta = { 0, 0 };\r\n-    _clearedAllThisFrame = false;\r\n-    _cursorMoved = false;\r\n-    _firstPaint = false;\r\n-    _skipCursor = false;\r\n-    _resized = false;\r\n-    // If we've circled the buffer this frame, move our virtual top upwards.\r\n-    // We do this at the END of the frame, so that during the paint, we still\r\n-    //      use the original virtual top.\r\n-    if (_circled)\r\n-    {\r\n-        if (_virtualTop > 0)\r\n-        {\r\n-            _virtualTop--;\r\n-        }\r\n-    }\r\n-    _circled = false;\r\n-\r\n-    // If _stopUsingLineRenditions is still true at the end of the frame, that\r\n-    // means we've refreshed the entire viewport with every line being single\r\n-    // width, so we can safely stop using them from now on.\r\n-    if (_stopUsingLineRenditions)\r\n-    {\r\n-        _usingLineRenditions = false;\r\n-    }\r\n-\r\n-    // If we deferred a cursor movement during the frame, make sure we put the\r\n-    //      cursor in the right place before we end the frame.\r\n-    if (_deferredCursorPos != INVALID_COORDS)\r\n-    {\r\n-        RETURN_IF_FAILED(_MoveCursor(_deferredCursorPos));\r\n-    }\r\n-\r\n-    // If this frame was triggered because we encountered a VT sequence which\r\n-    // required the buffered state to get printed, we don't want to flush this\r\n-    // frame to the pipe. That might result in us rendering half the output of a\r\n-    // particular frame (as emitted by the client).\r\n-    //\r\n-    // Instead, we'll leave this frame in _buffer, and just keep appending to\r\n-    // it as needed.\r\n-    if (!_noFlushOnEnd)\r\n-    {\r\n-        _Flush();\r\n-    }\r\n-\r\n-    _noFlushOnEnd = false;\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Used to perform longer running presentation steps outside the lock so the\r\n-//      other threads can continue.\r\n-// - Not currently used by VtEngine.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_FALSE since we do nothing.\r\n-[[nodiscard]] HRESULT VtEngine::Present() noexcept\r\n-{\r\n-    return S_FALSE;\r\n-}\r\n-\r\n-[[nodiscard]] HRESULT VtEngine::ResetLineTransform() noexcept\r\n-{\r\n-    return S_FALSE;\r\n-}\r\n-\r\n-[[nodiscard]] HRESULT VtEngine::PrepareLineTransform(const LineRendition lineRendition,\r\n-                                                     const til::CoordType targetRow,\r\n-                                                     const til::CoordType /*viewportLeft*/) noexcept\r\n-{\r\n-    // We don't want to waste bandwidth writing out line rendition attributes\r\n-    // until we know they're in use. But once they are in use, we have to keep\r\n-    // applying them on every line until we know they definitely aren't being\r\n-    // used anymore (we check that at the end of any fullscreen paint).\r\n-    if (lineRendition != LineRendition::SingleWidth)\r\n-    {\r\n-        _stopUsingLineRenditions = false;\r\n-        _usingLineRenditions = true;\r\n-    }\r\n-    // One simple optimization is that we can skip sending the line attributes\r\n-    // when we're writing out a single character, which should preclude there\r\n-    // being a rendition switch.\r\n-    if (_usingLineRenditions && !_invalidMap.one())\r\n-    {\r\n-        RETURN_IF_FAILED(_MoveCursor({ _lastText.x, targetRow }));\r\n-        switch (lineRendition)\r\n-        {\r\n-        case LineRendition::SingleWidth:\r\n-            return _Write(\"\\x1b#5\");\r\n-        case LineRendition::DoubleWidth:\r\n-            return _Write(\"\\x1b#6\");\r\n-        case LineRendition::DoubleHeightTop:\r\n-            return _Write(\"\\x1b#3\");\r\n-        case LineRendition::DoubleHeightBottom:\r\n-            return _Write(\"\\x1b#4\");\r\n-        }\r\n-    }\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Paints the background of the invalid area of the frame.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::PaintBackground() noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Draws one line of the buffer to the screen. Writes the characters to the\r\n-//      pipe. If the characters are outside the ASCII range (0-0x7f), then\r\n-//      instead writes a '?'\r\n-// Arguments:\r\n-// - clusters - text and column count data to be written\r\n-// - trimLeft - This specifies whether to trim one character width off the left\r\n-//      side of the output. Used for drawing the right-half only of a\r\n-//      double-wide character.\r\n-// - lineWrapped: true if this run we're painting is the end of a line that\r\n-//   wrapped. If we're not painting the last column of a wrapped line, then this\r\n-//   will be false.\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::PaintBufferLine(const std::span<const Cluster> clusters,\r\n-                                                const til::point coord,\r\n-                                                const bool /*trimLeft*/,\r\n-                                                const bool /*lineWrapped*/) noexcept\r\n-{\r\n-    return VtEngine::_PaintAsciiBufferLine(clusters, coord);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Draws up to one line worth of grid lines on top of characters.\r\n-// Arguments:\r\n-// - lines - Enum defining which edges of the rectangle to draw\r\n-// - gridlineColor - The color to use for drawing the gridlines.\r\n-// - underlineColor - The color to use for drawing the underlines.\r\n-// - cchLine - How many characters we should draw the grid lines along (left to right in a row)\r\n-// - coordTarget - The starting X/Y position of the first character to draw on.\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::PaintBufferGridLines(const GridLineSet /*lines*/,\r\n-                                                     const COLORREF /*gridlineColor*/,\r\n-                                                     const COLORREF /*underlineColor*/,\r\n-                                                     const size_t /*cchLine*/,\r\n-                                                     const til::point /*coordTarget*/) noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Draws the cursor on the screen\r\n-// Arguments:\r\n-// - options - Options that affect the presentation of the cursor\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::PaintCursor(const CursorOptions& options) noexcept\r\n-{\r\n-    _trace.TracePaintCursor(options.coordCursor);\r\n-\r\n-    // GH#17270: If the wrappedRow field is set, and the target cursor position\r\n-    // is at the start of the next row, it's expected that any subsequent output\r\n-    // would already be written to that location, so the _MoveCursor method may\r\n-    // decide it doesn't need to do anything. In this case, though, we're not\r\n-    // writing anything else, so the cursor will end up in the wrong location at\r\n-    // the end of the frame. Clearing the wrappedRow field fixes that.\r\n-    _wrappedRow = std::nullopt;\r\n-    _trace.TraceClearWrapped();\r\n-\r\n-    // MSFT:15933349 - Send the terminal the updated cursor information, if it's changed.\r\n-    LOG_IF_FAILED(_MoveCursor(options.coordCursor));\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-//  - Inverts the selected region on the current screen buffer.\r\n-//  - Reads the selected area, selection mode, and active screen buffer\r\n-//    from the global properties and dispatches a GDI invert on the selected text area.\r\n-//  Because the selection is the responsibility of the terminal, and not the\r\n-//      host, render nothing.\r\n-// Arguments:\r\n-//  - rect - Rectangle to invert or highlight to make the selection area\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::PaintSelection(const til::rect& /*rect*/) noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Write a VT sequence to change the current colors of text. Writes true RGB\r\n-//      color sequences.\r\n-// Arguments:\r\n-// - textAttributes: Text attributes to use for the colors.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_RgbUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept\r\n-{\r\n-    const auto fg = textAttributes.GetForeground();\r\n-    const auto bg = textAttributes.GetBackground();\r\n-    const auto ul = textAttributes.GetUnderlineColor();\r\n-    auto lastFg = _lastTextAttributes.GetForeground();\r\n-    auto lastBg = _lastTextAttributes.GetBackground();\r\n-    auto lastUl = _lastTextAttributes.GetUnderlineColor();\r\n-\r\n-    // If the FG, BG and UL should be the defaults, emit an SGR reset.\r\n-    if (fg.IsDefault() && bg.IsDefault() && ul.IsDefault() && !(lastFg.IsDefault() && lastBg.IsDefault() && lastUl.IsDefault()))\r\n-    {\r\n-        // SGR Reset will clear all attributes (except hyperlink ID) - which means\r\n-        // we cannot reset _lastTextAttributes by simply doing\r\n-        // _lastTextAttributes = {};\r\n-        // because we want to retain the last hyperlink ID\r\n-        RETURN_IF_FAILED(_SetGraphicsDefault());\r\n-        _lastTextAttributes.SetDefaultBackground();\r\n-        _lastTextAttributes.SetDefaultForeground();\r\n-        _lastTextAttributes.SetDefaultUnderlineColor();\r\n-        _lastTextAttributes.SetDefaultRenditionAttributes();\r\n-        lastFg = {};\r\n-        lastBg = {};\r\n-        lastUl = {};\r\n-    }\r\n-\r\n-    if (fg != lastFg)\r\n-    {\r\n-        if (fg.IsDefault())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRenditionDefaultColor(true));\r\n-        }\r\n-        else if (fg.IsIndex16())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRendition16Color(fg.GetIndex(), true));\r\n-        }\r\n-        else if (fg.IsIndex256())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRendition256Color(fg.GetIndex(), true));\r\n-        }\r\n-        else if (fg.IsRgb())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRenditionRGBColor(fg.GetRGB(), true));\r\n-        }\r\n-        _lastTextAttributes.SetForeground(fg);\r\n-    }\r\n-\r\n-    if (bg != lastBg)\r\n-    {\r\n-        if (bg.IsDefault())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRenditionDefaultColor(false));\r\n-        }\r\n-        else if (bg.IsIndex16())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRendition16Color(bg.GetIndex(), false));\r\n-        }\r\n-        else if (bg.IsIndex256())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRendition256Color(bg.GetIndex(), false));\r\n-        }\r\n-        else if (bg.IsRgb())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRenditionRGBColor(bg.GetRGB(), false));\r\n-        }\r\n-        _lastTextAttributes.SetBackground(bg);\r\n-    }\r\n-\r\n-    if (ul != lastUl)\r\n-    {\r\n-        if (ul.IsDefault())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRenditionUnderlineDefaultColor());\r\n-        }\r\n-        else if (ul.IsIndex16()) // underline can't be 16 color\r\n-        {\r\n-            /* do nothing */\r\n-        }\r\n-        else if (ul.IsIndex256())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRenditionUnderline256Color(ul.GetIndex()));\r\n-        }\r\n-        else if (ul.IsRgb())\r\n-        {\r\n-            RETURN_IF_FAILED(_SetGraphicsRenditionUnderlineRGBColor(ul.GetRGB()));\r\n-        }\r\n-        _lastTextAttributes.SetUnderlineColor(ul);\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Write a VT sequence to change the current colors of text. It will try to\r\n-//      find ANSI colors that are nearest to the input colors, and write those\r\n-//      indices to the pipe.\r\n-// Arguments:\r\n-// - textAttributes: Text attributes to use for the colors.\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-[[nodiscard]] HRESULT VtEngine::_16ColorUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept\r\n-{\r\n-    const auto fg = textAttributes.GetForeground();\r\n-    const auto bg = textAttributes.GetBackground();\r\n-    auto lastFg = _lastTextAttributes.GetForeground();\r\n-    auto lastBg = _lastTextAttributes.GetBackground();\r\n-\r\n-    // If either FG or BG have changed to default, emit a SGR reset.\r\n-    // We can't reset FG and BG to default individually.\r\n-    if ((fg.IsDefault() && !lastFg.IsDefault()) || (bg.IsDefault() && !lastBg.IsDefault()))\r\n-    {\r\n-        // SGR Reset will clear all attributes (except hyperlink ID) - which means\r\n-        // we cannot reset _lastTextAttributes by simply doing\r\n-        // _lastTextAttributes = {};\r\n-        // because we want to retain the last hyperlink ID\r\n-        RETURN_IF_FAILED(_SetGraphicsDefault());\r\n-        _lastTextAttributes.SetDefaultBackground();\r\n-        _lastTextAttributes.SetDefaultForeground();\r\n-        _lastTextAttributes.SetDefaultRenditionAttributes();\r\n-        lastFg = {};\r\n-        lastBg = {};\r\n-    }\r\n-\r\n-    // We use the legacy color calculations to generate an approximation of the\r\n-    // colors in the Windows 16-color table, but we need to transpose those\r\n-    // values to obtain an index in an ANSI-compatible order.\r\n-    auto fgIndex = TextColor::TransposeLegacyIndex(fg.GetLegacyIndex(0));\r\n-    auto bgIndex = TextColor::TransposeLegacyIndex(bg.GetLegacyIndex(0));\r\n-\r\n-    // If the intense attribute is set, and the foreground can be brightened, then do so.\r\n-    const auto brighten = textAttributes.IsIntense() && fg.CanBeBrightened();\r\n-    fgIndex |= (brighten ? FOREGROUND_INTENSITY : 0);\r\n-\r\n-    // To actually render bright colors, though, we need to use SGR intense.\r\n-    const auto needIntense = fgIndex > 7;\r\n-    if (needIntense != _lastTextAttributes.IsIntense())\r\n-    {\r\n-        RETURN_IF_FAILED(_SetIntense(needIntense));\r\n-        _lastTextAttributes.SetIntense(needIntense);\r\n-    }\r\n-\r\n-    // After which we drop the high bits, since only colors 0 to 7 are supported.\r\n-\r\n-    fgIndex &= 7;\r\n-    bgIndex &= 7;\r\n-\r\n-    if (!fg.IsDefault() && (lastFg.IsDefault() || fgIndex != lastFg.GetIndex()))\r\n-    {\r\n-        RETURN_IF_FAILED(_SetGraphicsRendition16Color(fgIndex, true));\r\n-        _lastTextAttributes.SetIndexedForeground(fgIndex);\r\n-    }\r\n-\r\n-    if (!bg.IsDefault() && (lastBg.IsDefault() || bgIndex != lastBg.GetIndex()))\r\n-    {\r\n-        RETURN_IF_FAILED(_SetGraphicsRendition16Color(bgIndex, false));\r\n-        _lastTextAttributes.SetIndexedBackground(bgIndex);\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Draws one line of the buffer to the screen. Writes the characters to the\r\n-//      pipe. If the characters are outside the ASCII range (0-0x7f), then\r\n-//      instead writes a '?'.\r\n-//   This is needed because the Windows internal telnet client implementation\r\n-//      doesn't know how to handle >ASCII characters. The old telnetd would\r\n-//      just replace them with '?' characters. If we render the >ASCII\r\n-//      characters to telnet, it will likely end up drawing them wrong, which\r\n-//      will make the client appear buggy and broken.\r\n-// Arguments:\r\n-// - clusters - text and column width data to be written\r\n-// - coord - character coordinate target to render within viewport\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::_PaintAsciiBufferLine(const std::span<const Cluster> clusters,\r\n-                                                      const til::point coord) noexcept\r\n-{\r\n-    try\r\n-    {\r\n-        RETURN_IF_FAILED(_MoveCursor(coord));\r\n-\r\n-        _bufferLine.clear();\r\n-        _bufferLine.reserve(clusters.size());\r\n-\r\n-        til::CoordType totalWidth = 0;\r\n-        for (const auto& cluster : clusters)\r\n-        {\r\n-            _bufferLine.append(cluster.GetText());\r\n-            totalWidth += cluster.GetColumns();\r\n-        }\r\n-\r\n-        RETURN_IF_FAILED(VtEngine::_WriteTerminalAscii(_bufferLine));\r\n-\r\n-        // Update our internal tracker of the cursor's position\r\n-        _lastText.x += totalWidth;\r\n-\r\n-        return S_OK;\r\n-    }\r\n-    CATCH_RETURN();\r\n-}\r\n-\r\n-// Routine Description:\r\n-// - Draws one line of the buffer to the screen. Writes the characters to the\r\n-//      pipe, encoded in UTF-8.\r\n-// Arguments:\r\n-// - clusters - text and column widths to be written\r\n-// - coord - character coordinate target to render within viewport\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::_PaintUtf8BufferLine(const std::span<const Cluster> clusters,\r\n-                                                     const til::point coord,\r\n-                                                     const bool lineWrapped) noexcept\r\n-{\r\n-    if (coord.y < _virtualTop)\r\n-    {\r\n-        return S_OK;\r\n-    }\r\n-\r\n-    _bufferLine.clear();\r\n-    _bufferLine.reserve(clusters.size());\r\n-    til::CoordType totalWidth = 0;\r\n-    for (const auto& cluster : clusters)\r\n-    {\r\n-        _bufferLine.append(cluster.GetText());\r\n-        totalWidth += cluster.GetColumns();\r\n-    }\r\n-\r\n-    // If any of the values in the buffer are C0 or C1 controls, we need to\r\n-    // convert them to printable codepoints, otherwise they'll end up being\r\n-    // evaluated as control characters by the receiving terminal. We use the\r\n-    // DOS 437 code page for the C0 controls and DEL, and just a `?` for the\r\n-    // C1 controls, since that's what you would most likely have seen in the\r\n-    // legacy v1 console with raster fonts.\r\n-    const auto cchLine = _bufferLine.size();\r\n-    std::for_each_n(_bufferLine.begin(), cchLine, [](auto& ch) {\r\n-        static constexpr std::wstring_view C0Glyphs = L\" \u263a\u263b\u2665\u2666\u2663\u2660\u2022\u25d8\u25cb\u25d9\u2642\u2640\u266a\u266b\u263c\u25ba\u25c4\u2195\u203c\u00b6\u00a7\u25ac\u21a8\u2191\u2193\u2192\u2190\u221f\u2194\u25b2\u25bc\";\r\n-        if (ch < C0Glyphs.size())\r\n-        {\r\n-            ch = til::at(C0Glyphs, ch);\r\n-        }\r\n-        else if (ch >= L'\\u007F' && ch < L'\\u00A0')\r\n-        {\r\n-            ch = (ch == L'\\u007F' ? L'\u2302' : L'?');\r\n-        }\r\n-    });\r\n-\r\n-    const auto spaceIndex = _bufferLine.find_last_not_of(L' ');\r\n-    const auto foundNonspace = spaceIndex != decltype(_bufferLine)::npos;\r\n-    const auto nonSpaceLength = foundNonspace ? spaceIndex + 1 : 0;\r\n-\r\n-    // Examples:\r\n-    // - \"  \":\r\n-    //      cch = 2, spaceIndex = 0, foundNonSpace = false\r\n-    //      cch-nonSpaceLength = 2\r\n-    // - \"A \"\r\n-    //      cch = 2, spaceIndex = 0, foundNonSpace = true\r\n-    //      cch-nonSpaceLength = 1\r\n-    // - \"AA\"\r\n-    //      cch = 2, spaceIndex = 1, foundNonSpace = true\r\n-    //      cch-nonSpaceLength = 0\r\n-    const auto numSpaces = gsl::narrow_cast<til::CoordType>(cchLine - nonSpaceLength);\r\n-\r\n-    // Optimizations:\r\n-    // If there are lots of spaces at the end of the line, we can try to Erase\r\n-    //      Character that number of spaces, then move the cursor forward (to\r\n-    //      where it would be if we had written the spaces)\r\n-    // An erase character and move right sequence is 8 chars, and possibly 10\r\n-    //      (if there are at least 10 spaces, 2 digits to print)\r\n-    // ESC [ %d X ESC [ %d C\r\n-    // ESC [ %d %d X ESC [ %d %d C\r\n-    // So we need at least 9 spaces for the optimized sequence to make sense.\r\n-    // Also, if we already erased the entire display this frame, then\r\n-    //    don't do ANYTHING with erasing at all.\r\n-\r\n-    // Note: We're only doing these optimizations along the UTF-8 path, because\r\n-    // the inbox telnet client doesn't understand the Erase Character sequence,\r\n-    // and it uses xterm-ascii. This ensures that xterm and -256color consumers\r\n-    // get the enhancements, and telnet isn't broken.\r\n-    //\r\n-    // GH#13229: ECH and EL don't fill the space with visual attributes like\r\n-    // underline, reverse video, hyperlinks, etc. If these spaces had those\r\n-    // attrs, then don't try and optimize them out.\r\n-    const auto optimalToUseECH = numSpaces > ERASE_CHARACTER_STRING_LENGTH;\r\n-    const auto useEraseChar = (optimalToUseECH) &&\r\n-                              (!_newBottomLine) &&\r\n-                              (!_clearedAllThisFrame) &&\r\n-                              (!_lastTextAttributes.HasAnyVisualAttributes());\r\n-    const auto printingBottomLine = coord.y == _lastViewport.BottomInclusive();\r\n-\r\n-    // GH#5502 - If the background color of the \"new bottom line\" is different\r\n-    // than when we emitted the line, we can't optimize out the spaces from it.\r\n-    // We'll still need to emit those spaces, so that the connected terminal\r\n-    // will have the same background color on those blank cells.\r\n-    const auto bgMatched = _newBottomLineBG.has_value() ? (_newBottomLineBG.value() == _lastTextAttributes.GetBackground()) : true;\r\n-\r\n-    // If we're not using erase char, but we did erase all at the start of the\r\n-    // frame, don't add spaces at the end.\r\n-    //\r\n-    // GH#5161: Only removeSpaces when we're in the _newBottomLine state and the\r\n-    // line we're trying to print right now _actually is the bottom line_\r\n-    //\r\n-    // GH#5291: DON'T remove spaces when the row wrapped. We might need those\r\n-    // spaces to preserve the wrap state of this line, or the cursor position.\r\n-    // For example, vim.exe uses \"~    \"... to clear the line, and then leaves\r\n-    // the lines _wrapped_. It doesn't care to manually break the lines, but if\r\n-    // we trimmed the spaces off here, we'd print all the \"~\"s one after another\r\n-    // on the same line.\r\n-    static const TextAttribute defaultAttrs{};\r\n-    const auto removeSpaces = !lineWrapped && (useEraseChar // we determined earlier that ECH is optimal\r\n-                                               || (_clearedAllThisFrame && _lastTextAttributes == defaultAttrs) // OR we cleared the last frame to the default attributes (specifically)\r\n-                                               || (_newBottomLine && printingBottomLine && bgMatched)); // OR we just scrolled a new line onto the bottom of the screen with the correct attributes\r\n-    const auto cchActual = removeSpaces ? nonSpaceLength : cchLine;\r\n-\r\n-    const auto columnsActual = removeSpaces ?\r\n-                                   (totalWidth - numSpaces) :\r\n-                                   totalWidth;\r\n-\r\n-    if (cchActual == 0)\r\n-    {\r\n-        // If the previous row wrapped, but this line is empty, then we actually\r\n-        // do want to move the cursor down. Otherwise, we'll possibly end up\r\n-        // accidentally erasing the last character from the previous line, as\r\n-        // the cursor is still waiting on that character for the next character\r\n-        // to follow it.\r\n-        //\r\n-        // GH#5839 - If we've emitted a wrapped row, because the cursor is\r\n-        // sitting just past the last cell of the previous row, if we execute a\r\n-        // EraseCharacter or EraseLine here, then the row won't actually get\r\n-        // cleared here. This logic is important to make sure that the cursor is\r\n-        // in the right position before we do that.\r\n-\r\n-        _wrappedRow = std::nullopt;\r\n-        _trace.TraceClearWrapped();\r\n-    }\r\n-\r\n-    // Move the cursor to the start of this run.\r\n-    RETURN_IF_FAILED(_MoveCursor(coord));\r\n-\r\n-    // Write the actual text string. If we're using a soft font, the character\r\n-    // set should have already been selected, so we just need to map our internal\r\n-    // representation back to ASCII (handled by the _WriteTerminalDrcs method).\r\n-    if (_usingSoftFont) [[unlikely]]\r\n-    {\r\n-        RETURN_IF_FAILED(VtEngine::_WriteTerminalDrcs({ _bufferLine.data(), cchActual }));\r\n-    }\r\n-    else\r\n-    {\r\n-        RETURN_IF_FAILED(VtEngine::_WriteTerminalUtf8({ _bufferLine.data(), cchActual }));\r\n-    }\r\n-\r\n-    // GH#4415, GH#5181\r\n-    // If the renderer told us that this was a wrapped line, then mark\r\n-    // that we've wrapped this line. The next time we attempt to move the\r\n-    // cursor, if we're trying to move it to the start of the next line,\r\n-    // we'll remember that this line was wrapped, and not manually break the\r\n-    // line.\r\n-    if (lineWrapped)\r\n-    {\r\n-        _wrappedRow = coord.y;\r\n-        _trace.TraceSetWrapped(coord.y);\r\n-    }\r\n-\r\n-    // Update our internal tracker of the cursor's position.\r\n-    // See MSFT:20266233 (which is also GH#357)\r\n-    // If the cursor is at the rightmost column of the terminal, and we write a\r\n-    //      space, the cursor won't actually move to the next cell (which would\r\n-    //      be {0, _lastText.y++}). The cursor will stay visibly in that last\r\n-    //      cell until then next character is output.\r\n-    // If in that case, we increment the cursor position here (such that the X\r\n-    //      position would be one past the right of the terminal), when we come\r\n-    //      back through to MoveCursor in the last PaintCursor of the frame,\r\n-    //      we'll determine that we need to emit a \\b to put the cursor in the\r\n-    //      right position. This is wrong, and will cause us to move the cursor\r\n-    //      back one character more than we wanted.\r\n-    //\r\n-    // GH#1245: This needs to be RightExclusive, _not_ inclusive. Otherwise, we\r\n-    // won't update our internal cursor position tracker correctly at the last\r\n-    // character of the row.\r\n-    if (_lastText.x < _lastViewport.RightExclusive())\r\n-    {\r\n-        _lastText.x += columnsActual;\r\n-    }\r\n-    // GH#1245: If we wrote the exactly last char of the row, then we're in the\r\n-    // \"delayed EOL wrap\" state. Different terminals (conhost, gnome-terminal,\r\n-    // wt) all behave differently with how the cursor behaves at an end of line.\r\n-    // Mark that we're in the delayed EOL wrap state - we don't want to be\r\n-    // clever about how we move the cursor in this state, since different\r\n-    // terminals will handle a backspace differently in this state.\r\n-    if (_lastText.x >= _lastViewport.RightInclusive())\r\n-    {\r\n-        _delayedEolWrap = true;\r\n-    }\r\n-\r\n-    if (useEraseChar)\r\n-    {\r\n-        // ECH doesn't actually move the cursor itself. However, we think that\r\n-        //   the cursor *should* be at the end of the area we just erased. Stash\r\n-        //   that position as our new deferred position. If we don't move the\r\n-        //   cursor somewhere else before the end of the frame, we'll move the\r\n-        //   cursor to the deferred position at the end of the frame, or right\r\n-        //   before we need to print new text.\r\n-        _deferredCursorPos = { _lastText.x + numSpaces, _lastText.y };\r\n-\r\n-        if (_deferredCursorPos.x <= _lastViewport.RightInclusive())\r\n-        {\r\n-            RETURN_IF_FAILED(_EraseCharacter(numSpaces));\r\n-        }\r\n-        // If we're past the end of the row (i.e. in the \"delayed EOL wrap\"\r\n-        // state), then there is no need to erase the rest of line. In fact\r\n-        // if we did output an EL sequence at this point, it could reset the\r\n-        // \"delayed EOL wrap\" state, breaking subsequent output.\r\n-        else if (_lastText.x <= _lastViewport.RightInclusive())\r\n-        {\r\n-            RETURN_IF_FAILED(_EraseLine());\r\n-        }\r\n-    }\r\n-    else if (_newBottomLine && printingBottomLine)\r\n-    {\r\n-        // If we're on a new line, then we don't need to erase the line. The\r\n-        //      line is already empty.\r\n-        if (optimalToUseECH)\r\n-        {\r\n-            _deferredCursorPos = { _lastText.x + numSpaces, _lastText.y };\r\n-        }\r\n-        else if (numSpaces > 0 && removeSpaces) // if we deleted the spaces... re-add them\r\n-        {\r\n-            // TODO GH#5430 - Determine why and when we would do this.\r\n-            auto spaces = std::wstring(numSpaces, L' ');\r\n-            RETURN_IF_FAILED(VtEngine::_WriteTerminalUtf8(spaces));\r\n-\r\n-            _lastText.x += numSpaces;\r\n-        }\r\n-    }\r\n-\r\n-    // If we printed to the bottom line, and we previously thought that this was\r\n-    // a new bottom line, it certainly isn't new any longer.\r\n-    if (printingBottomLine)\r\n-    {\r\n-        _newBottomLine = false;\r\n-        _newBottomLineBG = std::nullopt;\r\n-    }\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Updates the window's title string. Emits the VT sequence to SetWindowTitle.\r\n-//      Because wintelnet does not understand these sequences by default, we\r\n-//      don't do anything by default. Other modes can implement if they support\r\n-//      the sequence.\r\n-// Arguments:\r\n-// - newTitle: the new string to use for the title of the window\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::_DoUpdateTitle(const std::wstring_view /*newTitle*/) noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\ndiff --git a/src/renderer/vt/precomp.cpp b/src/renderer/vt/precomp.cpp\ndeleted file mode 100644\nindex c51e9b31b2f..00000000000\n--- a/src/renderer/vt/precomp.cpp\n+++ /dev/null\n@@ -1,4 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\ndiff --git a/src/renderer/vt/precomp.h b/src/renderer/vt/precomp.h\ndeleted file mode 100644\nindex b560c6e0ebc..00000000000\n--- a/src/renderer/vt/precomp.h\n+++ /dev/null\n@@ -1,33 +0,0 @@\n-/*++\r\n-Copyright (c) Microsoft Corporation\r\n-Licensed under the MIT license.\r\n-\r\n-Module Name:\r\n-- precomp.h\r\n-\r\n-Abstract:\r\n-- Contains external headers to include in the precompile phase of console build process.\r\n-- Avoid including internal project headers. Instead include them only in the classes that need them (helps with test project building).\r\n---*/\r\n-\r\n-#include <cwchar>\r\n-#include <sal.h>\r\n-\r\n-// This includes support libraries from the CRT, STL, WIL, and GSL\r\n-#include \"LibraryIncludes.h\"\r\n-\r\n-#include <windows.h>\r\n-#include <windowsx.h>\r\n-\r\n-#if defined(DEBUG) || defined(_DEBUG) || defined(DBG)\r\n-#define WHEN_DBG(x) x\r\n-#else\r\n-#define WHEN_DBG(x)\r\n-#endif\r\n-\r\n-// SafeMath\r\n-#pragma prefast(push)\r\n-#pragma prefast(disable : 26071, \"Range violation in Intsafe. Not ours.\")\r\n-#define ENABLE_INTSAFE_SIGNED_FUNCTIONS // Only unsigned intsafe math/casts available without this def\r\n-#include <intsafe.h>\r\n-#pragma prefast(pop)\r\ndiff --git a/src/renderer/vt/sources.inc b/src/renderer/vt/sources.inc\ndeleted file mode 100644\nindex cad591f35f8..00000000000\n--- a/src/renderer/vt/sources.inc\n+++ /dev/null\n@@ -1,38 +0,0 @@\n-!include ..\\..\\..\\project.inc\r\n-\r\n-# -------------------------------------\r\n-# Windows Console\r\n-# - Console Renderer for VT\r\n-# -------------------------------------\r\n-\r\n-# This module provides a rendering engine implementation that\r\n-# renders the display to an outgoing VT stream.\r\n-\r\n-# -------------------------------------\r\n-# Build System Settings\r\n-# -------------------------------------\r\n-\r\n-# Code in the OneCore depot automatically excludes default Win32 libraries.\r\n-\r\n-# -------------------------------------\r\n-# Sources, Headers, and Libraries\r\n-# -------------------------------------\r\n-\r\n-PRECOMPILED_CXX         = 1\r\n-PRECOMPILED_INCLUDE     = ..\\precomp.h\r\n-\r\n-SOURCES = \\\r\n-    ..\\invalidate.cpp \\\r\n-    ..\\math.cpp \\\r\n-    ..\\paint.cpp \\\r\n-    ..\\state.cpp \\\r\n-    ..\\tracing.cpp \\\r\n-    ..\\XtermEngine.cpp \\\r\n-    ..\\Xterm256Engine.cpp \\\r\n-    ..\\VtSequences.cpp \\\r\n-\r\n-INCLUDES = \\\r\n-    $(INCLUDES); \\\r\n-    ..; \\\r\n-    ..\\..\\..\\inc; \\\r\n-    $(MINWIN_INTERNAL_PRIV_SDK_INC_PATH_L); \\\r\ndiff --git a/src/renderer/vt/state.cpp b/src/renderer/vt/state.cpp\ndeleted file mode 100644\nindex f192536e3e6..00000000000\n--- a/src/renderer/vt/state.cpp\n+++ /dev/null\n@@ -1,554 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-#include \"vtrenderer.hpp\"\r\n-#include \"../../inc/conattrs.hpp\"\r\n-#include \"../../host/VtIo.hpp\"\r\n-\r\n-// For _vcprintf\r\n-#include <conio.h>\r\n-#include <cstdarg>\r\n-\r\n-#pragma hdrstop\r\n-\r\n-using namespace Microsoft::Console;\r\n-using namespace Microsoft::Console::Render;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-constexpr til::point VtEngine::INVALID_COORDS = { -1, -1 };\r\n-\r\n-// Routine Description:\r\n-// - Creates a new VT-based rendering engine\r\n-// - NOTE: Will throw if initialization failure. Caller must catch.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - An instance of a Renderer.\r\n-VtEngine::VtEngine(_In_ wil::unique_hfile pipe,\r\n-                   const Viewport initialViewport) :\r\n-    RenderEngineBase(),\r\n-    _hFile(std::move(pipe)),\r\n-    _usingLineRenditions(false),\r\n-    _stopUsingLineRenditions(false),\r\n-    _usingSoftFont(false),\r\n-    _lastTextAttributes(INVALID_COLOR, INVALID_COLOR, INVALID_COLOR),\r\n-    _lastViewport(initialViewport),\r\n-    _pool(til::pmr::get_default_resource()),\r\n-    _invalidMap(initialViewport.Dimensions(), false, &_pool),\r\n-    _scrollDelta(0, 0),\r\n-    _clearedAllThisFrame(false),\r\n-    _cursorMoved(false),\r\n-    _resized(false),\r\n-    _suppressResizeRepaint(true),\r\n-    _virtualTop(0),\r\n-    _circled(false),\r\n-    _firstPaint(true),\r\n-    _skipCursor(false),\r\n-    _terminalOwner{ nullptr },\r\n-    _newBottomLine{ false },\r\n-    _deferredCursorPos{ INVALID_COORDS },\r\n-    _trace{},\r\n-    _bufferLine{},\r\n-    _buffer{},\r\n-    _formatBuffer{},\r\n-    _conversionBuffer{},\r\n-    _pfnSetLookingForDSR{}\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    // When unit testing, we can instantiate a VtEngine without a pipe.\r\n-    THROW_HR_IF(E_HANDLE, !_hFile);\r\n-#else\r\n-    // member is only defined when UNIT_TESTING is.\r\n-    _usingTestCallback = false;\r\n-#endif\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Writes a fill of characters to our file handle (repeat of same character over and over)\r\n-[[nodiscard]] HRESULT VtEngine::_WriteFill(const size_t n, const char c) noexcept\r\n-try\r\n-{\r\n-    _trace.TraceStringFill(n, c);\r\n-#ifdef UNIT_TESTING\r\n-    if (_usingTestCallback)\r\n-    {\r\n-        const std::string str(n, c);\r\n-        // Try to get the last error. If that wasn't set, then the test probably\r\n-        // doesn't set last error. No matter. We'll just return with E_FAIL\r\n-        // then. This is a unit test, we don't particularly care.\r\n-        const auto succeeded = _pfnTestCallback(str.data(), str.size());\r\n-        auto hr = E_FAIL;\r\n-        if (!succeeded)\r\n-        {\r\n-            const auto err = ::GetLastError();\r\n-            // If there wasn't an error in GLE, just use E_FAIL\r\n-            hr = SUCCEEDED_WIN32(err) ? hr : HRESULT_FROM_WIN32(err);\r\n-        }\r\n-        return succeeded ? S_OK : hr;\r\n-    }\r\n-#endif\r\n-\r\n-    // TODO GH10001: Replace me with REP\r\n-    _buffer.append(n, c);\r\n-    return S_OK;\r\n-}\r\n-CATCH_RETURN();\r\n-\r\n-// Method Description:\r\n-// - Writes the characters to our file handle. If we're building the unit tests,\r\n-//      we can instead write to the test callback, in order to avoid needing to\r\n-//      set up pipes and threads for unit tests.\r\n-// Arguments:\r\n-// - str: The buffer to write to the pipe. Might have nulls in it.\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::_Write(std::string_view const str) noexcept\r\n-{\r\n-    _trace.TraceString(str);\r\n-#ifdef UNIT_TESTING\r\n-    if (_usingTestCallback)\r\n-    {\r\n-        // Try to get the last error. If that wasn't set, then the test probably\r\n-        // doesn't set last error. No matter. We'll just return with E_FAIL\r\n-        // then. This is a unit test, we don't particularly care.\r\n-        const auto succeeded = _pfnTestCallback(str.data(), str.size());\r\n-        auto hr = E_FAIL;\r\n-        if (!succeeded)\r\n-        {\r\n-            const auto err = ::GetLastError();\r\n-            // If there wasn't an error in GLE, just use E_FAIL\r\n-            hr = SUCCEEDED_WIN32(err) ? hr : HRESULT_FROM_WIN32(err);\r\n-        }\r\n-        return succeeded ? S_OK : hr;\r\n-    }\r\n-#endif\r\n-\r\n-    try\r\n-    {\r\n-        _buffer.append(str);\r\n-\r\n-        return S_OK;\r\n-    }\r\n-    CATCH_RETURN();\r\n-}\r\n-\r\n-void VtEngine::_Flush() noexcept\r\n-{\r\n-    if (_buffer.empty())\r\n-    {\r\n-        return;\r\n-    }\r\n-\r\n-    if (!_corked)\r\n-    {\r\n-        _flushImpl();\r\n-        return;\r\n-    }\r\n-\r\n-    // Defer the flush until someone calls Cork(false).\r\n-    _flushRequested = true;\r\n-}\r\n-\r\n-// _corked is often true and separating _flushImpl() out allows _flush() to be inlined.\r\n-void VtEngine::_flushImpl() noexcept\r\n-{\r\n-    if (_hFile)\r\n-    {\r\n-        const auto fSuccess = WriteFile(_hFile.get(), _buffer.data(), gsl::narrow_cast<DWORD>(_buffer.size()), nullptr, nullptr);\r\n-        _buffer.clear();\r\n-        _startOfFrameBufferIndex = 0;\r\n-        if (!fSuccess)\r\n-        {\r\n-            LOG_LAST_ERROR();\r\n-            _hFile.reset();\r\n-            if (_terminalOwner)\r\n-            {\r\n-                _terminalOwner->CloseOutput();\r\n-            }\r\n-        }\r\n-    }\r\n-}\r\n-\r\n-// The name of this method is an analogy to TCP_CORK. It instructs\r\n-// the VT renderer to stop flushing its buffer to the output pipe.\r\n-// Don't forget to uncork it!\r\n-void VtEngine::Cork(bool corked) noexcept\r\n-{\r\n-    _corked = corked;\r\n-\r\n-    // Now do the deferred flush from a previous call to _Flush().\r\n-    if (!corked && _flushRequested)\r\n-    {\r\n-        _flushRequested = false;\r\n-        _flushImpl();\r\n-    }\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Wrapper for _Write.\r\n-[[nodiscard]] HRESULT VtEngine::WriteTerminalUtf8(const std::string_view str) noexcept\r\n-{\r\n-    return _Write(str);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Writes a wstring to the tty, encoded as full utf-8. This is one\r\n-//      implementation of the WriteTerminalW method.\r\n-// Arguments:\r\n-// - wstr - wstring of text to be written\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from either conversion or writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::_WriteTerminalUtf8(const std::wstring_view wstr) noexcept\r\n-{\r\n-    RETURN_IF_FAILED(til::u16u8(wstr, _conversionBuffer));\r\n-    return _Write(_conversionBuffer);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Writes a wstring to the tty, encoded as \"utf-8\" where characters that are\r\n-//      outside the ASCII range are encoded as '?'\r\n-//   This mainly exists to maintain compatibility with the inbox telnet client.\r\n-//   This is one implementation of the WriteTerminalW method.\r\n-// Arguments:\r\n-// - wstr - wstring of text to be written\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::_WriteTerminalAscii(const std::wstring_view wstr) noexcept\r\n-{\r\n-    std::string needed;\r\n-    needed.reserve(wstr.size());\r\n-\r\n-    for (const auto& wch : wstr)\r\n-    {\r\n-        // We're explicitly replacing characters outside ASCII with a ? because\r\n-        //      that's what telnet wants.\r\n-        needed.push_back((wch > L'\\x7f') ? '?' : static_cast<char>(wch));\r\n-    }\r\n-\r\n-    return _Write(needed);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Writes a wstring to the tty when the characters are from the DRCS soft font.\r\n-//       It is assumed that the character set has already been designated in the\r\n-//       client terminal, so we just need to re-map our internal representation\r\n-//       of the characters into ASCII.\r\n-// Arguments:\r\n-// - wstr - wstring of text to be written\r\n-// Return Value:\r\n-// - S_OK or suitable HRESULT error from writing pipe.\r\n-[[nodiscard]] HRESULT VtEngine::_WriteTerminalDrcs(const std::wstring_view wstr) noexcept\r\n-{\r\n-    std::string needed;\r\n-    needed.reserve(wstr.size());\r\n-\r\n-    for (const auto& wch : wstr)\r\n-    {\r\n-        // Our DRCS characters use the range U+EF20 to U+EF7F from the Unicode\r\n-        // Private Use Area. To map them back to ASCII we just mask with 7F.\r\n-        needed.push_back(wch & 0x7F);\r\n-    }\r\n-\r\n-    return _Write(needed);\r\n-}\r\n-\r\n-// Method Description:\r\n-// - This method will update the active font on the current device context\r\n-//      Does nothing for vt, the font is handed by the terminal.\r\n-// Arguments:\r\n-// - FontDesired - reference to font information we should use while instantiating a font.\r\n-// - Font - reference to font information where the chosen font information will be populated.\r\n-// Return Value:\r\n-// - HRESULT S_OK\r\n-[[nodiscard]] HRESULT VtEngine::UpdateFont(const FontInfoDesired& /*pfiFontDesired*/,\r\n-                                           _Out_ FontInfo& /*pfiFont*/) noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - This method will modify the DPI we're using for scaling calculations.\r\n-//      Does nothing for vt, the dpi is handed by the terminal.\r\n-// Arguments:\r\n-// - iDpi - The Dots Per Inch to use for scaling. We will use this relative to\r\n-//      the system default DPI defined in Windows headers as a constant.\r\n-// Return Value:\r\n-// - HRESULT S_OK\r\n-[[nodiscard]] HRESULT VtEngine::UpdateDpi(const int /*iDpi*/) noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - This method will update our internal reference for how big the viewport is.\r\n-//      If the viewport has changed size, then we'll need to send an update to\r\n-//      the terminal.\r\n-// Arguments:\r\n-// - srNewViewport - The bounds of the new viewport.\r\n-// Return Value:\r\n-// - HRESULT S_OK\r\n-[[nodiscard]] HRESULT VtEngine::UpdateViewport(const til::inclusive_rect& srNewViewport) noexcept\r\n-{\r\n-    auto hr = S_OK;\r\n-    const auto newView = Viewport::FromInclusive(srNewViewport);\r\n-    const auto oldSize = _lastViewport.Dimensions();\r\n-    const auto newSize = newView.Dimensions();\r\n-\r\n-    if (oldSize != newSize)\r\n-    {\r\n-        // Don't emit a resize event if we've requested it be suppressed\r\n-        if (!_suppressResizeRepaint)\r\n-        {\r\n-            hr = _ResizeWindow(newSize.width, newSize.height);\r\n-        }\r\n-\r\n-        if (_resizeQuirk)\r\n-        {\r\n-            // GH#3490 - When the viewport width changed, don't do anything extra here.\r\n-            // If the buffer had areas that were invalid due to the resize, then the\r\n-            // buffer will have triggered its own invalidations for what it knows is\r\n-            // invalid. Previously, we'd invalidate everything if the width changed,\r\n-            // because we couldn't be sure if lines were reflowed.\r\n-            _invalidMap.resize(newSize);\r\n-        }\r\n-        else\r\n-        {\r\n-            if (SUCCEEDED(hr))\r\n-            {\r\n-                _invalidMap.resize(newSize, true); // resize while filling in new space with repaint requests.\r\n-\r\n-                // Viewport is smaller now - just update it all.\r\n-                if (oldSize.height > newSize.height || oldSize.width > newSize.width)\r\n-                {\r\n-                    hr = InvalidateAll();\r\n-                }\r\n-            }\r\n-        }\r\n-\r\n-        _resized = true;\r\n-    }\r\n-\r\n-    // See MSFT:19408543\r\n-    // Always clear the suppression request, even if the new size was the same\r\n-    //      as the last size. We're always going to get a UpdateViewport call\r\n-    //      for our first frame. However, we start with _suppressResizeRepaint set,\r\n-    //      to prevent that first UpdateViewport call from emitting our size.\r\n-    // If we only clear the flag when the new viewport is different, this can\r\n-    //      lead to the first _actual_ resize being suppressed.\r\n-    _suppressResizeRepaint = false;\r\n-    _lastViewport = newView;\r\n-\r\n-    return hr;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - This method will figure out what the new font should be given the starting font information and a DPI.\r\n-// - When the final font is determined, the FontInfo structure given will be updated with the actual resulting font chosen as the nearest match.\r\n-// - NOTE: It is left up to the underling rendering system to choose the nearest font. Please ask for the font dimensions if they are required using the interface. Do not use the size you requested with this structure.\r\n-// - If the intent is to immediately turn around and use this font, pass the optional handle parameter and use it immediately.\r\n-//      Does nothing for vt, the font is handed by the terminal.\r\n-// Arguments:\r\n-// - FontDesired - reference to font information we should use while instantiating a font.\r\n-// - Font - reference to font information where the chosen font information will be populated.\r\n-// - iDpi - The DPI we will have when rendering\r\n-// Return Value:\r\n-// - S_FALSE: This is unsupported by the VT Renderer and should use another engine's value.\r\n-[[nodiscard]] HRESULT VtEngine::GetProposedFont(const FontInfoDesired& /*pfiFontDesired*/,\r\n-                                                _Out_ FontInfo& /*pfiFont*/,\r\n-                                                const int /*iDpi*/) noexcept\r\n-{\r\n-    return S_FALSE;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Retrieves the current pixel size of the font we have selected for drawing.\r\n-// Arguments:\r\n-// - pFontSize - receives the current X by Y size of the font.\r\n-// Return Value:\r\n-// - S_FALSE: This is unsupported by the VT Renderer and should use another engine's value.\r\n-[[nodiscard]] HRESULT VtEngine::GetFontSize(_Out_ til::size* const pFontSize) noexcept\r\n-{\r\n-    *pFontSize = { 1, 1 };\r\n-    return S_FALSE;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Sets the test callback for this instance. Instead of rendering to a pipe,\r\n-//      this instance will instead render to a callback for testing.\r\n-// Arguments:\r\n-// - pfn: a callback to call instead of writing to the pipe.\r\n-// Return Value:\r\n-// - <none>\r\n-void VtEngine::SetTestCallback(_In_ std::function<bool(const char* const, size_t const)> pfn)\r\n-{\r\n-#ifdef UNIT_TESTING\r\n-\r\n-    _pfnTestCallback = pfn;\r\n-    _usingTestCallback = true;\r\n-\r\n-#else\r\n-    THROW_HR(E_FAIL);\r\n-#endif\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Returns true if the entire viewport has been invalidated. That signals we\r\n-//      should use a VT Clear Screen sequence as an optimization.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - true if the entire viewport has been invalidated\r\n-bool VtEngine::_AllIsInvalid() const\r\n-{\r\n-    return _invalidMap.all();\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Prevent the renderer from emitting output on the next resize. This prevents\r\n-//      the host from echoing a resize to the terminal that requested it.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::SuppressResizeRepaint() noexcept\r\n-{\r\n-    _suppressResizeRepaint = true;\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - \"Inherit\" the cursor at the given position. We won't need to move it\r\n-//      anywhere, so update where we last thought the cursor was.\r\n-//  Also update our \"virtual top\", indicating where should clip all updates to\r\n-//      (we don't want to paint the empty region above the inherited cursor).\r\n-//  Also ignore the next InvalidateCursor call.\r\n-// Arguments:\r\n-// - coordCursor: The cursor position to inherit from.\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT VtEngine::InheritCursor(const til::point coordCursor) noexcept\r\n-{\r\n-    _virtualTop = coordCursor.y;\r\n-    _lastText = coordCursor;\r\n-    _skipCursor = true;\r\n-    // Prevent us from clearing the entire viewport on the first paint\r\n-    _firstPaint = false;\r\n-    return S_OK;\r\n-}\r\n-\r\n-void VtEngine::SetTerminalOwner(Microsoft::Console::VirtualTerminal::VtIo* const terminalOwner)\r\n-{\r\n-    _terminalOwner = terminalOwner;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - sends a sequence to request the end terminal to tell us the\r\n-//      cursor position. The terminal will reply back on the vt input handle.\r\n-//   Flushes the buffer as well, to make sure the request is sent to the terminal.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-HRESULT VtEngine::RequestCursor() noexcept\r\n-{\r\n-    RETURN_IF_FAILED(_RequestCursor());\r\n-    _Flush();\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Sends a notification through to the `VtInputThread` that it should\r\n-//   watch for and capture the response from a DSR message we're about to send.\r\n-//   This is typically `RequestCursor` at the time of writing this, but in theory\r\n-//   could be another DSR as well.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if all goes well. Invalid state error if no notification function is installed.\r\n-//   (see `SetLookingForDSRCallback` to install one.)\r\n-[[nodiscard]] HRESULT VtEngine::_ListenForDSR() noexcept\r\n-{\r\n-    RETURN_HR_IF(HRESULT_FROM_WIN32(ERROR_INVALID_STATE), !_pfnSetLookingForDSR);\r\n-    _pfnSetLookingForDSR(true);\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Configure the renderer for the resize quirk. This changes the behavior of\r\n-//   conpty to _not_ InvalidateAll the entire viewport on a resize operation.\r\n-//   This is used by the Windows Terminal, because it is prepared to be\r\n-//   connected to a conpty, and handles its own buffer specifically for a\r\n-//   conpty scenario.\r\n-// - See also: GH#3490, #4354, #4741\r\n-// Arguments:\r\n-// - resizeQuirk - True to turn on the quirk. False otherwise.\r\n-// Return Value:\r\n-// - true iff we were started with the `--resizeQuirk` flag enabled.\r\n-void VtEngine::SetResizeQuirk(const bool resizeQuirk)\r\n-{\r\n-    _resizeQuirk = resizeQuirk;\r\n-}\r\n-\r\n-void VtEngine::SetLookingForDSRCallback(std::function<void(bool)> pfnLooking) noexcept\r\n-{\r\n-    _pfnSetLookingForDSR = pfnLooking;\r\n-}\r\n-\r\n-void VtEngine::SetTerminalCursorTextPosition(const til::point cursor) noexcept\r\n-{\r\n-    _lastText = cursor;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Manually emit a \"Erase Scrollback\" sequence to the connected terminal. We\r\n-//   need to do this in certain cases that we've identified where we believe the\r\n-//   client wanted the entire terminal buffer cleared, not just the viewport.\r\n-//   For more information, see GH#3126.\r\n-// - This is unimplemented in the win-telnet, xterm-ascii renderers - inbox\r\n-//   telnet.exe doesn't know how to handle a ^[[3J. This _is_ implemented in the\r\n-//   Xterm256Engine.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we wrote the sequences successfully, otherwise an appropriate HRESULT\r\n-[[nodiscard]] HRESULT VtEngine::ManuallyClearScrollback() noexcept\r\n-{\r\n-    return S_OK;\r\n-}\r\n-\r\n-// Method Description:\r\n-// - Send a sequence to the connected terminal to request win32-input-mode from\r\n-//   them. This will enable the connected terminal to send us full INPUT_RECORDs\r\n-//   as input. If the terminal doesn't understand this sequence, it'll just\r\n-//   ignore it.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK if we succeeded, else an appropriate HRESULT for failing to allocate or write.\r\n-HRESULT VtEngine::RequestWin32Input() noexcept\r\n-{\r\n-    // On startup we request the modes we require for optimal functioning\r\n-    // (namely win32 input mode and focus event mode).\r\n-    //\r\n-    // It's important that any additional modes set here are also mirrored in\r\n-    // the AdaptDispatch::HardReset method, since that needs to re-enable them\r\n-    // in the connected terminal after passing through an RIS sequence.\r\n-    RETURN_IF_FAILED(_Write(\"\\033[?9001h\\033[?1004h\"));\r\n-    _Flush();\r\n-    return S_OK;\r\n-}\r\n-\r\n-HRESULT VtEngine::SwitchScreenBuffer(const bool useAltBuffer) noexcept\r\n-{\r\n-    RETURN_IF_FAILED(_SwitchScreenBuffer(useAltBuffer));\r\n-    _Flush();\r\n-    return S_OK;\r\n-}\r\n-\r\n-HRESULT VtEngine::RequestMouseMode(const bool enable) noexcept\r\n-{\r\n-    const auto status = _WriteFormatted(FMT_COMPILE(\"\\x1b[?1003;1006{}\"), enable ? 'h' : 'l');\r\n-    _Flush();\r\n-    return status;\r\n-}\r\ndiff --git a/src/renderer/vt/tracing.cpp b/src/renderer/vt/tracing.cpp\ndeleted file mode 100644\nindex 21f2bc67094..00000000000\n--- a/src/renderer/vt/tracing.cpp\n+++ /dev/null\n@@ -1,356 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-#include \"tracing.hpp\"\r\n-#include <sstream>\r\n-\r\n-TRACELOGGING_DEFINE_PROVIDER(g_hConsoleVtRendererTraceProvider,\r\n-                             \"Microsoft.Windows.Console.Render.VtEngine\",\r\n-                             // tl:{c9ba2a95-d3ca-5e19-2bd6-776a0910cb9d}\r\n-                             (0xc9ba2a95, 0xd3ca, 0x5e19, 0x2b, 0xd6, 0x77, 0x6a, 0x09, 0x10, 0xcb, 0x9d),\r\n-                             TraceLoggingOptionMicrosoftTelemetry());\r\n-\r\n-using namespace Microsoft::Console::VirtualTerminal;\r\n-using namespace Microsoft::Console::Types;\r\n-\r\n-RenderTracing::RenderTracing()\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    TraceLoggingRegister(g_hConsoleVtRendererTraceProvider);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-RenderTracing::~RenderTracing()\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    TraceLoggingUnregister(g_hConsoleVtRendererTraceProvider);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-// Function Description:\r\n-// - Convert the string to only have printable characters in it. Control\r\n-//      characters are converted to hat notation, spaces are converted to \"SPC\"\r\n-//      (to be able to see them at the end of a string), and DEL is written as\r\n-//      \"\\x7f\".\r\n-// Arguments:\r\n-// - inString: The string to convert\r\n-// Return Value:\r\n-// - a string with only printable characters in it.\r\n-std::string toPrintableString(const std::string_view& inString)\r\n-{\r\n-    std::string retval = \"\";\r\n-    for (size_t i = 0; i < inString.length(); i++)\r\n-    {\r\n-        unsigned char c = inString[i];\r\n-        if (c < '\\x20')\r\n-        {\r\n-            retval += \"^\";\r\n-            char actual = (c + 0x40);\r\n-            retval += std::string(1, actual);\r\n-        }\r\n-        else if (c == '\\x7f')\r\n-        {\r\n-            retval += \"\\\\x7f\";\r\n-        }\r\n-        else if (c == '\\x20')\r\n-        {\r\n-            retval += \"SPC\";\r\n-        }\r\n-        else\r\n-        {\r\n-            retval += std::string(1, c);\r\n-        }\r\n-    }\r\n-    return retval;\r\n-}\r\n-void RenderTracing::TraceStringFill(const size_t n, const char c) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceStringFill\",\r\n-                          TraceLoggingUInt64(gsl::narrow_cast<uint64_t>(n)),\r\n-                          TraceLoggingChar(c),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(n);\r\n-    UNREFERENCED_PARAMETER(c);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-void RenderTracing::TraceString(const std::string_view& instr) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto _seq = toPrintableString(instr);\r\n-        const auto seq = _seq.c_str();\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceString\",\r\n-                          TraceLoggingUtf8String(seq),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(instr);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceInvalidate(const til::rect& invalidRect) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto invalidatedStr = invalidRect.to_string();\r\n-        const auto invalidated = invalidatedStr.c_str();\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceInvalidate\",\r\n-                          TraceLoggingWideString(invalidated),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(invalidRect);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceInvalidateAll(const til::rect& viewport) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto invalidatedStr = viewport.to_string();\r\n-        const auto invalidatedAll = invalidatedStr.c_str();\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceInvalidateAll\",\r\n-                          TraceLoggingWideString(invalidatedAll),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(viewport);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceTriggerCircling(const bool newFrame) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                      \"VtEngine_TraceTriggerCircling\",\r\n-                      TraceLoggingBool(newFrame),\r\n-                      TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                      TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-#else\r\n-    UNREFERENCED_PARAMETER(newFrame);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceInvalidateScroll(const til::point scroll) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto scrollDeltaStr = scroll.to_string();\r\n-        const auto scrollDelta = scrollDeltaStr.c_str();\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceInvalidateScroll\",\r\n-                          TraceLoggingWideString(scrollDelta),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(scroll);\r\n-#endif\r\n-}\r\n-\r\n-void RenderTracing::TraceStartPaint(const bool quickReturn,\r\n-                                    const til::pmr::bitmap& invalidMap,\r\n-                                    const til::rect& lastViewport,\r\n-                                    const til::point scrollDelt,\r\n-                                    const bool cursorMoved,\r\n-                                    const std::optional<til::CoordType>& wrappedRow) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto invalidatedStr = invalidMap.to_string();\r\n-        const auto invalidated = invalidatedStr.c_str();\r\n-        const auto lastViewStr = lastViewport.to_string();\r\n-        const auto lastView = lastViewStr.c_str();\r\n-        const auto scrollDeltaStr = scrollDelt.to_string();\r\n-        const auto scrollDelta = scrollDeltaStr.c_str();\r\n-        if (wrappedRow.has_value())\r\n-        {\r\n-            TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                              \"VtEngine_TraceStartPaint\",\r\n-                              TraceLoggingBool(quickReturn),\r\n-                              TraceLoggingWideString(invalidated),\r\n-                              TraceLoggingWideString(lastView),\r\n-                              TraceLoggingWideString(scrollDelta),\r\n-                              TraceLoggingBool(cursorMoved),\r\n-                              TraceLoggingValue(wrappedRow.value()),\r\n-                              TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                              TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-        }\r\n-        else\r\n-        {\r\n-            TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                              \"VtEngine_TraceStartPaint\",\r\n-                              TraceLoggingBool(quickReturn),\r\n-                              TraceLoggingWideString(invalidated),\r\n-                              TraceLoggingWideString(lastView),\r\n-                              TraceLoggingWideString(scrollDelta),\r\n-                              TraceLoggingBool(cursorMoved),\r\n-                              TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                              TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-        }\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(quickReturn);\r\n-    UNREFERENCED_PARAMETER(invalidMap);\r\n-    UNREFERENCED_PARAMETER(lastViewport);\r\n-    UNREFERENCED_PARAMETER(scrollDelt);\r\n-    UNREFERENCED_PARAMETER(cursorMoved);\r\n-    UNREFERENCED_PARAMETER(wrappedRow);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceEndPaint() const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                      \"VtEngine_TraceEndPaint\",\r\n-                      TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                      TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-#else\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceLastText(const til::point lastTextPos) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto lastTextStr = lastTextPos.to_string();\r\n-        const auto lastText = lastTextStr.c_str();\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceLastText\",\r\n-                          TraceLoggingWideString(lastText),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(lastTextPos);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceScrollFrame(const til::point scrollDeltaPos) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto scrollDeltaStr = scrollDeltaPos.to_string();\r\n-        const auto scrollDelta = scrollDeltaStr.c_str();\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceScrollFrame\",\r\n-                          TraceLoggingWideString(scrollDelta),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(scrollDeltaPos);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceMoveCursor(const til::point lastTextPos, const til::point cursor) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto lastTextStr = lastTextPos.to_string();\r\n-        const auto lastText = lastTextStr.c_str();\r\n-\r\n-        const auto cursorStr = cursor.to_string();\r\n-        const auto cursorPos = cursorStr.c_str();\r\n-\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceMoveCursor\",\r\n-                          TraceLoggingWideString(lastText),\r\n-                          TraceLoggingWideString(cursorPos),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(lastTextPos);\r\n-    UNREFERENCED_PARAMETER(cursor);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceWrapped() const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto* const msg = \"Wrapped instead of \\\\r\\\\n\";\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceWrapped\",\r\n-                          TraceLoggingString(msg),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceSetWrapped(const til::CoordType wrappedRow) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceSetWrapped\",\r\n-                          TraceLoggingValue(wrappedRow),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(wrappedRow);\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TraceClearWrapped() const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto* const msg = \"Cleared wrap state\";\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TraceClearWrapped\",\r\n-                          TraceLoggingString(msg),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-#endif // UNIT_TESTING\r\n-}\r\n-\r\n-void RenderTracing::TracePaintCursor(const til::point coordCursor) const\r\n-{\r\n-#ifndef UNIT_TESTING\r\n-    if (TraceLoggingProviderEnabled(g_hConsoleVtRendererTraceProvider, WINEVENT_LEVEL_VERBOSE, TIL_KEYWORD_TRACE))\r\n-    {\r\n-        const auto cursorPosString = coordCursor.to_string();\r\n-        const auto cursorPos = cursorPosString.c_str();\r\n-        TraceLoggingWrite(g_hConsoleVtRendererTraceProvider,\r\n-                          \"VtEngine_TracePaintCursor\",\r\n-                          TraceLoggingWideString(cursorPos),\r\n-                          TraceLoggingLevel(WINEVENT_LEVEL_VERBOSE),\r\n-                          TraceLoggingKeyword(TIL_KEYWORD_TRACE));\r\n-    }\r\n-#else\r\n-    UNREFERENCED_PARAMETER(coordCursor);\r\n-#endif // UNIT_TESTING\r\n-}\r\ndiff --git a/src/renderer/vt/tracing.hpp b/src/renderer/vt/tracing.hpp\ndeleted file mode 100644\nindex 78515df7d48..00000000000\n--- a/src/renderer/vt/tracing.hpp\n+++ /dev/null\n@@ -1,50 +0,0 @@\n-/*++\r\n-Copyright (c) Microsoft Corporation\r\n-Licensed under the MIT license.\r\n-\r\n-Module Name:\r\n-- tracing.hpp\r\n-\r\n-Abstract:\r\n-- This module is used for recording tracing/debugging information to the telemetry ETW channel\r\n---*/\r\n-\r\n-#pragma once\r\n-#include <string>\r\n-#include <windows.h>\r\n-#include <winmeta.h>\r\n-#include <TraceLoggingProvider.h>\r\n-#include <telemetry/ProjectTelemetry.h>\r\n-#include \"../../types/inc/Viewport.hpp\"\r\n-\r\n-TRACELOGGING_DECLARE_PROVIDER(g_hConsoleVtRendererTraceProvider);\r\n-\r\n-namespace Microsoft::Console::VirtualTerminal\r\n-{\r\n-    class RenderTracing final\r\n-    {\r\n-    public:\r\n-        RenderTracing();\r\n-        ~RenderTracing();\r\n-        void TraceStringFill(const size_t n, const char c) const;\r\n-        void TraceString(const std::string_view& str) const;\r\n-        void TraceInvalidate(const til::rect& view) const;\r\n-        void TraceLastText(const til::point lastText) const;\r\n-        void TraceScrollFrame(const til::point scrollDelta) const;\r\n-        void TraceMoveCursor(const til::point lastText, const til::point cursor) const;\r\n-        void TraceSetWrapped(const til::CoordType wrappedRow) const;\r\n-        void TraceClearWrapped() const;\r\n-        void TraceWrapped() const;\r\n-        void TracePaintCursor(const til::point coordCursor) const;\r\n-        void TraceInvalidateAll(const til::rect& view) const;\r\n-        void TraceTriggerCircling(const bool newFrame) const;\r\n-        void TraceInvalidateScroll(const til::point scroll) const;\r\n-        void TraceStartPaint(const bool quickReturn,\r\n-                             const til::pmr::bitmap& invalidMap,\r\n-                             const til::rect& lastViewport,\r\n-                             const til::point scrollDelta,\r\n-                             const bool cursorMoved,\r\n-                             const std::optional<til::CoordType>& wrappedRow) const;\r\n-        void TraceEndPaint() const;\r\n-    };\r\n-}\r\ndiff --git a/src/renderer/vt/ut_lib/sources b/src/renderer/vt/ut_lib/sources\ndeleted file mode 100644\nindex f4017cca2e4..00000000000\n--- a/src/renderer/vt/ut_lib/sources\n+++ /dev/null\n@@ -1,20 +0,0 @@\n-!include ..\\sources.inc\r\n-\r\n-# -------------------------------------\r\n-# Program Information\r\n-# -------------------------------------\r\n-\r\n-TARGETNAME              = ConRenderVt.Unittest\r\n-TARGETTYPE              = LIBRARY\r\n-\r\n-TEST_CODE               = 1\r\n-\r\n-# -------------------------------------\r\n-# Preprocessor Settings\r\n-# -------------------------------------\r\n-\r\n-C_DEFINES               = $(C_DEFINES) -DINLINE_TEST_METHOD_MARKUP -DUNIT_TESTING\r\n-\r\n-INCLUDES = \\\r\n-    $(INCLUDES); \\\r\n-    $(ONECORESDKTOOLS_INTERNAL_INC_PATH_L)\\wextest\\cue; \\\r\ndiff --git a/src/renderer/vt/ut_lib/sources.dep b/src/renderer/vt/ut_lib/sources.dep\ndeleted file mode 100644\nindex bc61c95c6b0..00000000000\n--- a/src/renderer/vt/ut_lib/sources.dep\n+++ /dev/null\n@@ -1,3 +0,0 @@\n-BUILD_PASS1_CONSUMES= \\\r\n-    onecore\\windows\\vcpkg|PASS1 \\\r\n-\r\ndiff --git a/src/renderer/vt/vt-renderer-common.vcxitems b/src/renderer/vt/vt-renderer-common.vcxitems\ndeleted file mode 100644\nindex f4bea3242db..00000000000\n--- a/src/renderer/vt/vt-renderer-common.vcxitems\n+++ /dev/null\n@@ -1,29 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n-<Project DefaultTargets=\"Build\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n-  <!--\r\n-    Contains all the files for the VtRenderer Project.\r\n-    They need to be consumed by two different projects - lib/vt.vcxproj and\r\n-    ut_lib/vt-unittesting.vcxproj so that the tests can build a version of the\r\n-    lib with -DUNIT_TESTING\r\n-   -->\r\n-  <ItemGroup>\r\n-    <ClCompile Include=\"..\\invalidate.cpp\" />\r\n-    <ClCompile Include=\"..\\math.cpp\" />\r\n-    <ClCompile Include=\"..\\paint.cpp\" />\r\n-    <ClCompile Include=\"..\\precomp.cpp\">\r\n-      <PrecompiledHeader>Create</PrecompiledHeader>\r\n-    </ClCompile>\r\n-    <ClCompile Include=\"..\\state.cpp\" />\r\n-    <ClCompile Include=\"..\\tracing.cpp\" />\r\n-    <ClCompile Include=\"..\\VtSequences.cpp\" />\r\n-    <ClCompile Include=\"..\\XtermEngine.cpp\" />\r\n-    <ClCompile Include=\"..\\Xterm256Engine.cpp\" />\r\n-  </ItemGroup>\r\n-  <ItemGroup>\r\n-    <ClInclude Include=\"..\\precomp.h\" />\r\n-    <ClInclude Include=\"..\\tracing.hpp\" />\r\n-    <ClInclude Include=\"..\\vtrenderer.hpp\" />\r\n-    <ClInclude Include=\"..\\XtermEngine.hpp\" />\r\n-    <ClInclude Include=\"..\\Xterm256Engine.hpp\" />\r\n-  </ItemGroup>\r\n-</Project>\r\ndiff --git a/src/renderer/vt/vtrenderer.hpp b/src/renderer/vt/vtrenderer.hpp\ndeleted file mode 100644\nindex 2641614b32d..00000000000\n--- a/src/renderer/vt/vtrenderer.hpp\n+++ /dev/null\n@@ -1,246 +0,0 @@\n-/*++\r\n-Copyright (c) Microsoft Corporation\r\n-Licensed under the MIT license.\r\n-\r\n-Module Name:\r\n-- VtRenderer.hpp\r\n-\r\n-Abstract:\r\n-- This is the definition of the VT specific implementation of the renderer.\r\n-\r\n-Author(s):\r\n-- Michael Niksa (MiNiksa) 24-Jul-2017\r\n-- Mike Griese (migrie) 01-Sept-2017\r\n---*/\r\n-\r\n-#pragma once\r\n-\r\n-#include \"../inc/RenderEngineBase.hpp\"\r\n-#include \"../../types/inc/Viewport.hpp\"\r\n-#include \"tracing.hpp\"\r\n-#include <string>\r\n-#include <functional>\r\n-\r\n-// fwdecl unittest classes\r\n-#ifdef UNIT_TESTING\r\n-namespace TerminalCoreUnitTests\r\n-{\r\n-    class ConptyRoundtripTests;\r\n-};\r\n-class ScreenBufferTests;\r\n-#endif\r\n-\r\n-namespace Microsoft::Console::VirtualTerminal\r\n-{\r\n-    class VtIo;\r\n-}\r\n-\r\n-namespace Microsoft::Console::Render\r\n-{\r\n-    class VtEngine : public RenderEngineBase\r\n-    {\r\n-    public:\r\n-        // See _PaintUtf8BufferLine for explanation of this value.\r\n-        static const size_t ERASE_CHARACTER_STRING_LENGTH = 8;\r\n-        static const til::point INVALID_COORDS;\r\n-\r\n-        VtEngine(_In_ wil::unique_hfile hPipe,\r\n-                 const Microsoft::Console::Types::Viewport initialViewport);\r\n-\r\n-        // IRenderEngine\r\n-        [[nodiscard]] HRESULT StartPaint() noexcept override;\r\n-        [[nodiscard]] HRESULT EndPaint() noexcept override;\r\n-        [[nodiscard]] HRESULT Present() noexcept override;\r\n-        [[nodiscard]] HRESULT PrepareForTeardown(_Out_ bool* pForcePaint) noexcept override;\r\n-        [[nodiscard]] HRESULT Invalidate(const til::rect* psrRegion) noexcept override;\r\n-        [[nodiscard]] HRESULT InvalidateCursor(const til::rect* psrRegion) noexcept override;\r\n-        [[nodiscard]] HRESULT InvalidateSystem(const til::rect* prcDirtyClient) noexcept override;\r\n-        [[nodiscard]] HRESULT InvalidateSelection(const std::vector<til::rect>& rectangles) noexcept override;\r\n-        [[nodiscard]] HRESULT InvalidateAll() noexcept override;\r\n-        [[nodiscard]] HRESULT InvalidateFlush(_In_ const bool circled, _Out_ bool* const pForcePaint) noexcept override;\r\n-        [[nodiscard]] HRESULT ResetLineTransform() noexcept override;\r\n-        [[nodiscard]] HRESULT PrepareLineTransform(const LineRendition lineRendition, const til::CoordType targetRow, const til::CoordType viewportLeft) noexcept override;\r\n-        [[nodiscard]] HRESULT PaintBackground() noexcept override;\r\n-        [[nodiscard]] HRESULT PaintBufferLine(std::span<const Cluster> clusters, til::point coord, bool fTrimLeft, bool lineWrapped) noexcept override;\r\n-        [[nodiscard]] HRESULT PaintBufferGridLines(const GridLineSet lines, const COLORREF gridlineColor, const COLORREF underlineColor, const size_t cchLine, const til::point coordTarget) noexcept override;\r\n-        [[nodiscard]] HRESULT PaintSelection(const til::rect& rect) noexcept override;\r\n-        [[nodiscard]] HRESULT PaintCursor(const CursorOptions& options) noexcept override;\r\n-        [[nodiscard]] HRESULT UpdateFont(const FontInfoDesired& FontInfoDesired, _Out_ FontInfo& FontInfo) noexcept override;\r\n-        [[nodiscard]] HRESULT UpdateDpi(int iDpi) noexcept override;\r\n-        [[nodiscard]] HRESULT UpdateViewport(const til::inclusive_rect& srNewViewport) noexcept override;\r\n-        [[nodiscard]] HRESULT GetProposedFont(const FontInfoDesired& FontInfoDesired, _Out_ FontInfo& FontInfo, int iDpi) noexcept override;\r\n-        [[nodiscard]] HRESULT GetDirtyArea(std::span<const til::rect>& area) noexcept override;\r\n-        [[nodiscard]] HRESULT GetFontSize(_Out_ til::size* pFontSize) noexcept override;\r\n-        [[nodiscard]] HRESULT IsGlyphWideByFont(std::wstring_view glyph, _Out_ bool* pResult) noexcept override;\r\n-\r\n-        // VtEngine\r\n-        [[nodiscard]] HRESULT SuppressResizeRepaint() noexcept;\r\n-        [[nodiscard]] HRESULT RequestCursor() noexcept;\r\n-        [[nodiscard]] HRESULT InheritCursor(const til::point coordCursor) noexcept;\r\n-        [[nodiscard]] HRESULT WriteTerminalUtf8(const std::string_view str) noexcept;\r\n-        [[nodiscard]] virtual HRESULT WriteTerminalW(const std::wstring_view str, const bool flush = false) noexcept = 0;\r\n-        void SetTerminalOwner(Microsoft::Console::VirtualTerminal::VtIo* const terminalOwner);\r\n-        void SetResizeQuirk(const bool resizeQuirk);\r\n-        void SetLookingForDSRCallback(std::function<void(bool)> pfnLooking) noexcept;\r\n-        void SetTerminalCursorTextPosition(const til::point coordCursor) noexcept;\r\n-        [[nodiscard]] virtual HRESULT ManuallyClearScrollback() noexcept;\r\n-        [[nodiscard]] HRESULT RequestWin32Input() noexcept;\r\n-        [[nodiscard]] virtual HRESULT SetWindowVisibility(const bool showOrHide) noexcept = 0;\r\n-        [[nodiscard]] HRESULT SwitchScreenBuffer(const bool useAltBuffer) noexcept;\r\n-        [[nodiscard]] HRESULT RequestMouseMode(bool enable) noexcept;\r\n-        void Cork(bool corked) noexcept;\r\n-\r\n-    protected:\r\n-        wil::unique_hfile _hFile;\r\n-        std::string _buffer;\r\n-        size_t _startOfFrameBufferIndex = 0;\r\n-\r\n-        std::string _formatBuffer;\r\n-        std::string _conversionBuffer;\r\n-\r\n-        bool _usingLineRenditions;\r\n-        bool _stopUsingLineRenditions;\r\n-        bool _usingSoftFont;\r\n-        TextAttribute _lastTextAttributes;\r\n-\r\n-        std::function<void(bool)> _pfnSetLookingForDSR;\r\n-\r\n-        Microsoft::Console::Types::Viewport _lastViewport;\r\n-\r\n-        std::pmr::unsynchronized_pool_resource _pool;\r\n-        til::pmr::bitmap _invalidMap;\r\n-\r\n-        til::point _lastText;\r\n-        til::point _lastCursorOrigin;\r\n-        til::point _scrollDelta;\r\n-\r\n-        bool _clearedAllThisFrame;\r\n-        bool _cursorMoved;\r\n-        bool _resized;\r\n-\r\n-        bool _suppressResizeRepaint;\r\n-\r\n-        til::CoordType _virtualTop;\r\n-        bool _circled;\r\n-        bool _firstPaint;\r\n-        bool _skipCursor;\r\n-        bool _newBottomLine;\r\n-        til::point _deferredCursorPos;\r\n-\r\n-        Microsoft::Console::VirtualTerminal::VtIo* _terminalOwner;\r\n-\r\n-        Microsoft::Console::VirtualTerminal::RenderTracing _trace;\r\n-\r\n-        std::optional<til::CoordType> _wrappedRow{ std::nullopt };\r\n-\r\n-        bool _delayedEolWrap{ false };\r\n-\r\n-        bool _resizeQuirk{ false };\r\n-        bool _passthrough{ false };\r\n-        bool _noFlushOnEnd{ false };\r\n-        bool _corked{ false };\r\n-        bool _flushRequested{ false };\r\n-        std::optional<TextColor> _newBottomLineBG{ std::nullopt };\r\n-\r\n-        [[nodiscard]] HRESULT _WriteFill(const size_t n, const char c) noexcept;\r\n-        [[nodiscard]] HRESULT _Write(std::string_view const str) noexcept;\r\n-        void _Flush() noexcept;\r\n-        void _flushImpl() noexcept;\r\n-\r\n-        template<typename S, typename... Args>\r\n-        [[nodiscard]] HRESULT _WriteFormatted(S&& format, Args&&... args)\r\n-        try\r\n-        {\r\n-            fmt::basic_memory_buffer<char, 64> buf;\r\n-            fmt::format_to(std::back_inserter(buf), std::forward<S>(format), std::forward<Args>(args)...);\r\n-            return _Write({ buf.data(), buf.size() });\r\n-        }\r\n-        CATCH_RETURN()\r\n-\r\n-        void _OrRect(_Inout_ til::inclusive_rect* const pRectExisting, const til::inclusive_rect* const pRectToOr) const;\r\n-        bool _AllIsInvalid() const;\r\n-\r\n-        [[nodiscard]] HRESULT _StopCursorBlinking() noexcept;\r\n-        [[nodiscard]] HRESULT _StartCursorBlinking() noexcept;\r\n-        [[nodiscard]] HRESULT _HideCursor() noexcept;\r\n-        [[nodiscard]] HRESULT _ShowCursor() noexcept;\r\n-        [[nodiscard]] HRESULT _EraseLine() noexcept;\r\n-        [[nodiscard]] HRESULT _InsertDeleteLine(const til::CoordType sLines, const bool fInsertLine) noexcept;\r\n-        [[nodiscard]] HRESULT _DeleteLine(const til::CoordType sLines) noexcept;\r\n-        [[nodiscard]] HRESULT _InsertLine(const til::CoordType sLines) noexcept;\r\n-        [[nodiscard]] HRESULT _CursorForward(const til::CoordType chars) noexcept;\r\n-        [[nodiscard]] HRESULT _EraseCharacter(const til::CoordType chars) noexcept;\r\n-        [[nodiscard]] HRESULT _CursorPosition(const til::point coord) noexcept;\r\n-        [[nodiscard]] HRESULT _CursorHome() noexcept;\r\n-        [[nodiscard]] HRESULT _ClearScreen() noexcept;\r\n-        [[nodiscard]] HRESULT _ClearScrollback() noexcept;\r\n-        [[nodiscard]] HRESULT _ChangeTitle(const std::string& title) noexcept;\r\n-        [[nodiscard]] HRESULT _SetGraphicsRendition16Color(const BYTE index,\r\n-                                                           const bool fIsForeground) noexcept;\r\n-        [[nodiscard]] HRESULT _SetGraphicsRendition256Color(const BYTE index,\r\n-                                                            const bool fIsForeground) noexcept;\r\n-        [[nodiscard]] HRESULT _SetGraphicsRenditionRGBColor(const COLORREF color,\r\n-                                                            const bool fIsForeground) noexcept;\r\n-        [[nodiscard]] HRESULT _SetGraphicsRenditionDefaultColor(const bool fIsForeground) noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _SetGraphicsRenditionUnderline256Color(const BYTE index) noexcept;\r\n-        [[nodiscard]] HRESULT _SetGraphicsRenditionUnderlineRGBColor(const COLORREF color) noexcept;\r\n-        [[nodiscard]] HRESULT _SetGraphicsRenditionUnderlineDefaultColor() noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _SetGraphicsDefault() noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _ResizeWindow(const til::CoordType sWidth, const til::CoordType sHeight) noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _SetIntense(const bool isIntense) noexcept;\r\n-        [[nodiscard]] HRESULT _SetFaint(const bool isFaint) noexcept;\r\n-        [[nodiscard]] HRESULT _SetUnderlined(const bool isUnderlined) noexcept;\r\n-        [[nodiscard]] HRESULT _SetUnderlineExtended(const UnderlineStyle style) noexcept;\r\n-        [[nodiscard]] HRESULT _SetOverlined(const bool isOverlined) noexcept;\r\n-        [[nodiscard]] HRESULT _SetItalic(const bool isItalic) noexcept;\r\n-        [[nodiscard]] HRESULT _SetBlinking(const bool isBlinking) noexcept;\r\n-        [[nodiscard]] HRESULT _SetInvisible(const bool isInvisible) noexcept;\r\n-        [[nodiscard]] HRESULT _SetCrossedOut(const bool isCrossedOut) noexcept;\r\n-        [[nodiscard]] HRESULT _SetReverseVideo(const bool isReversed) noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _SetHyperlink(const std::wstring_view& uri, const std::wstring_view& customId, const uint16_t& numberId) noexcept;\r\n-        [[nodiscard]] HRESULT _EndHyperlink() noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _RequestCursor() noexcept;\r\n-        [[nodiscard]] HRESULT _ListenForDSR() noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _SwitchScreenBuffer(const bool useAltBuffer) noexcept;\r\n-\r\n-        [[nodiscard]] virtual HRESULT _MoveCursor(const til::point coord) noexcept = 0;\r\n-        [[nodiscard]] HRESULT _RgbUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n-        [[nodiscard]] HRESULT _16ColorUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n-\r\n-        // buffer space for these two functions to build their lines\r\n-        // so they don't have to alloc/free in a tight loop\r\n-        std::wstring _bufferLine;\r\n-        [[nodiscard]] HRESULT _PaintUtf8BufferLine(const std::span<const Cluster> clusters,\r\n-                                                   const til::point coord,\r\n-                                                   const bool lineWrapped) noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _PaintAsciiBufferLine(const std::span<const Cluster> clusters,\r\n-                                                    const til::point coord) noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _WriteTerminalUtf8(const std::wstring_view str) noexcept;\r\n-        [[nodiscard]] HRESULT _WriteTerminalAscii(const std::wstring_view str) noexcept;\r\n-        [[nodiscard]] HRESULT _WriteTerminalDrcs(const std::wstring_view str) noexcept;\r\n-\r\n-        [[nodiscard]] HRESULT _DoUpdateTitle(const std::wstring_view newTitle) noexcept override;\r\n-\r\n-        /////////////////////////// Unit Testing Helpers ///////////////////////////\r\n-#ifdef UNIT_TESTING\r\n-        std::function<bool(const char* const, size_t const)> _pfnTestCallback;\r\n-        bool _usingTestCallback;\r\n-\r\n-        friend class VtRendererTest;\r\n-        friend class ConptyOutputTests;\r\n-        friend class ScreenBufferTests;\r\n-        friend class TerminalCoreUnitTests::ConptyRoundtripTests;\r\n-#endif\r\n-\r\n-        void SetTestCallback(_In_ std::function<bool(const char* const, size_t const)> pfn);\r\n-    };\r\n-}\r\ndiff --git a/src/renderer/wddmcon/WddmConRenderer.cpp b/src/renderer/wddmcon/WddmConRenderer.cpp\nindex fda8ae6c21b..605f0a6973d 100644\n--- a/src/renderer/wddmcon/WddmConRenderer.cpp\n+++ b/src/renderer/wddmcon/WddmConRenderer.cpp\n@@ -196,12 +196,6 @@ CATCH_RETURN()\n     return S_OK;\r\n }\r\n \r\n-[[nodiscard]] HRESULT WddmConEngine::PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept\r\n-{\r\n-    *pForcePaint = false;\r\n-    return S_FALSE;\r\n-}\r\n-\r\n [[nodiscard]] HRESULT WddmConEngine::StartPaint() noexcept\r\n try\r\n {\r\ndiff --git a/src/renderer/wddmcon/WddmConRenderer.hpp b/src/renderer/wddmcon/WddmConRenderer.hpp\nindex 1110c870782..79b874fd775 100644\n--- a/src/renderer/wddmcon/WddmConRenderer.hpp\n+++ b/src/renderer/wddmcon/WddmConRenderer.hpp\n@@ -31,7 +31,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT InvalidateSelection(const std::vector<til::rect>& rectangles) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateScroll(const til::point* const pcoordDelta) noexcept override;\r\n         [[nodiscard]] HRESULT InvalidateAll() noexcept override;\r\n-        [[nodiscard]] HRESULT PrepareForTeardown(_Out_ bool* const pForcePaint) noexcept override;\r\n \r\n         [[nodiscard]] HRESULT StartPaint() noexcept override;\r\n         [[nodiscard]] HRESULT EndPaint() noexcept override;\r\ndiff --git a/src/server/IoDispatchers.cpp b/src/server/IoDispatchers.cpp\nindex 664e8ebab85..da082157569 100644\n--- a/src/server/IoDispatchers.cpp\n+++ b/src/server/IoDispatchers.cpp\n@@ -5,23 +5,17 @@\n \r\n #include \"IoDispatchers.h\"\r\n \r\n-#include \"ApiSorter.h\"\r\n+#include <telemetry/ProjectTelemetry.h>\r\n \r\n-#include \"../host/conserv.h\"\r\n-#include \"../host/conwinuserrefs.h\"\r\n+#include \"ApiSorter.h\"\r\n+#include \"IConsoleHandoff.h\"\r\n #include \"../host/directio.h\"\r\n #include \"../host/handle.h\"\r\n #include \"../host/srvinit.h\"\r\n-\r\n #include \"../interactivity/base/HostSignalInputThread.hpp\"\r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n \r\n-#include \"../types/inc/utils.hpp\"\r\n-\r\n-#include \"IConsoleHandoff.h\"\r\n-\r\n using namespace Microsoft::Console::Interactivity;\r\n-using namespace Microsoft::Console::Utils;\r\n \r\n // From ntstatus.h, which we cannot include without causing a bunch of other conflicts. So we just include the one code we need.\r\n //\r\ndiff --git a/src/terminal/adapter/ITerminalApi.hpp b/src/terminal/adapter/ITerminalApi.hpp\nindex c3978b406f7..0cb900626fc 100644\n--- a/src/terminal/adapter/ITerminalApi.hpp\n+++ b/src/terminal/adapter/ITerminalApi.hpp\n@@ -82,7 +82,6 @@ namespace Microsoft::Console::VirtualTerminal\n         virtual void PlayMidiNote(const int noteNumber, const int velocity, const std::chrono::microseconds duration) = 0;\r\n \r\n         virtual bool ResizeWindow(const til::CoordType width, const til::CoordType height) = 0;\r\n-        virtual bool IsConsolePty() const = 0;\r\n \r\n         virtual void NotifyAccessibilityChange(const til::rect& changedRect) = 0;\r\n         virtual void NotifyBufferRotation(const int delta) = 0;\r\ndiff --git a/src/terminal/adapter/InteractDispatch.cpp b/src/terminal/adapter/InteractDispatch.cpp\nindex a102368ec5b..09329eb6647 100644\n--- a/src/terminal/adapter/InteractDispatch.cpp\n+++ b/src/terminal/adapter/InteractDispatch.cpp\n@@ -113,11 +113,7 @@ bool InteractDispatch::WindowManipulation(const DispatchTypes::WindowManipulatio\n     case DispatchTypes::WindowManipulationType::ResizeWindowInCharacters:\r\n         // TODO:GH#1765 We should introduce a better `ResizeConpty` function to\r\n         // ConhostInternalGetSet, that specifically handles a conpty resize.\r\n-        if (_api.ResizeWindow(parameter2.value_or(0), parameter1.value_or(0)))\r\n-        {\r\n-            auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-            THROW_IF_FAILED(gci.GetVtIo()->SuppressResizeRepaint());\r\n-        }\r\n+        _api.ResizeWindow(parameter2.value_or(0), parameter1.value_or(0));\r\n         return true;\r\n     default:\r\n         return false;\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 9806eb46b41..68cd77bfc47 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1538,8 +1538,7 @@ bool AdaptDispatch::DeviceAttributes()\n     // level of 1. The subsequent parameters identify the supported feature\n     // extensions.\n     //\n-    // 1 = 132 column mode (ConHost only)\n-    // 4 = Sixel Graphics (ConHost only)\n+    // 4 = Sixel Graphics\n     // 6 = Selective erase\n     // 7 = Soft fonts\n     // 14 = 8-bit interface architecture\n@@ -1551,14 +1550,7 @@ bool AdaptDispatch::DeviceAttributes()\n     // 32 = Text macros\n     // 42 = ISO Latin-2 character set\n \n-    if (_api.IsConsolePty())\n-    {\n-        _api.ReturnResponse(L\"\\x1b[?61;6;7;14;21;22;23;24;28;32;42c\");\n-    }\n-    else\n-    {\n-        _api.ReturnResponse(L\"\\x1b[?61;1;4;6;7;14;21;22;23;24;28;32;42c\");\n-    }\n+    _api.ReturnResponse(L\"\\x1b[?61;4;6;7;14;21;22;23;24;28;32;42c\");\n     return true;\n }\n \n@@ -1853,7 +1845,7 @@ bool AdaptDispatch::RequestDisplayedExtent()\n void AdaptDispatch::_SetColumnMode(const bool enable)\n {\n     // Only proceed if DECCOLM is allowed. Return true, as this is technically a successful handling.\n-    if (_modes.test(Mode::AllowDECCOLM) && !_api.IsConsolePty())\n+    if (_modes.test(Mode::AllowDECCOLM))\n     {\n         const auto page = _pages.VisiblePage();\n         const auto pageHeight = page.Height();\n@@ -1893,23 +1885,6 @@ void AdaptDispatch::_SetAlternateScreenBufferMode(const bool enable)\n     }\n }\n \n-// Routine Description:\n-// - Determines whether we need to pass through input mode requests.\n-//   If we're a conpty, AND WE'RE IN VT INPUT MODE, always pass input mode requests\n-//   The VT Input mode check is to work around ssh.exe v7.7, which uses VT\n-//   output, but not Input.\n-//   The original comment said, \"Once the conpty supports these types of input,\n-//   this check can be removed. See GH#4911\". Unfortunately, time has shown\n-//   us that SSH 7.7 _also_ requests mouse input and that can have a user interface\n-//   impact on the actual connected terminal. We can't remove this check,\n-//   because SSH <=7.7 is out in the wild on all versions of Windows <=2004.\n-// Return Value:\n-// - True if we should pass through. False otherwise.\n-bool AdaptDispatch::_PassThroughInputModes()\n-{\n-    return _api.IsConsolePty() && _api.IsVtInputEnabled();\n-}\n-\n // Routine Description:\n // - Support routine for routing mode parameters to be set/reset as flags\n // Arguments:\n@@ -1935,7 +1910,7 @@ bool AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n         return true;\n     case DispatchTypes::ModeParams::DECCKM_CursorKeysMode:\n         _terminalInput.SetInputMode(TerminalInput::Mode::CursorKey, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::DECANM_AnsiMode:\n         return SetAnsiMode(enable);\n     case DispatchTypes::ModeParams::DECCOLM_SetNumberOfColumns:\n@@ -1943,11 +1918,6 @@ bool AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n         return true;\n     case DispatchTypes::ModeParams::DECSCNM_ScreenMode:\n         _renderSettings.SetRenderMode(RenderSettings::Mode::ScreenReversed, enable);\n-        // No need to force a redraw in pty mode.\n-        if (_api.IsConsolePty())\n-        {\n-            return false;\n-        }\n         if (_renderer)\n         {\n             _renderer->TriggerRedrawAll();\n@@ -1968,10 +1938,10 @@ bool AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n         return true;\n     case DispatchTypes::ModeParams::DECARM_AutoRepeatMode:\n         _terminalInput.SetInputMode(TerminalInput::Mode::AutoRepeat, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::ATT610_StartCursorBlink:\n         _pages.ActivePage().Cursor().SetBlinkingAllowed(enable);\n-        return !_api.IsConsolePty();\n+        return true;\n     case DispatchTypes::ModeParams::DECTCEM_TextCursorEnableMode:\n         _pages.ActivePage().Cursor().SetIsVisible(enable);\n         return true;\n@@ -1987,10 +1957,10 @@ bool AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n         return true;\n     case DispatchTypes::ModeParams::DECNKM_NumericKeypadMode:\n         _terminalInput.SetInputMode(TerminalInput::Mode::Keypad, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::DECBKM_BackarrowKeyMode:\n         _terminalInput.SetInputMode(TerminalInput::Mode::BackarrowKey, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::DECLRMM_LeftRightMarginMode:\n         _modes.set(Mode::AllowDECSLRM, enable);\n         _DoSetLeftRightScrollingMargins(0, 0);\n@@ -2013,33 +1983,32 @@ bool AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n         return true;\n     case DispatchTypes::ModeParams::VT200_MOUSE_MODE:\n         _terminalInput.SetInputMode(TerminalInput::Mode::DefaultMouseTracking, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::BUTTON_EVENT_MOUSE_MODE:\n         _terminalInput.SetInputMode(TerminalInput::Mode::ButtonEventMouseTracking, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::ANY_EVENT_MOUSE_MODE:\n         _terminalInput.SetInputMode(TerminalInput::Mode::AnyEventMouseTracking, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::UTF8_EXTENDED_MODE:\n         _terminalInput.SetInputMode(TerminalInput::Mode::Utf8MouseEncoding, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::SGR_EXTENDED_MODE:\n         _terminalInput.SetInputMode(TerminalInput::Mode::SgrMouseEncoding, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::FOCUS_EVENT_MODE:\n         _terminalInput.SetInputMode(TerminalInput::Mode::FocusEvent, enable);\n-        // GH#12799 - If the app requested that we disable focus events, DON'T pass\n-        // that through. ConPTY would _always_ like to know about focus events.\n-        return !_PassThroughInputModes() || !enable;\n+        _api.GetStateMachine().InjectSequence(InjectionType::DECSET_FOCUS);\n+        return true;\n     case DispatchTypes::ModeParams::ALTERNATE_SCROLL:\n         _terminalInput.SetInputMode(TerminalInput::Mode::AlternateScroll, enable);\n-        return !_PassThroughInputModes();\n+        return true;\n     case DispatchTypes::ModeParams::ASB_AlternateScreenBuffer:\n         _SetAlternateScreenBufferMode(enable);\n         return true;\n     case DispatchTypes::ModeParams::XTERM_BracketedPasteMode:\n         _api.SetSystemMode(ITerminalApi::Mode::BracketedPaste, enable);\n-        return !_api.IsConsolePty();\n+        return true;\n     case DispatchTypes::ModeParams::GCM_GraphemeClusterMode:\n         return true;\n     case DispatchTypes::ModeParams::W32IM_Win32InputMode:\n@@ -2113,11 +2082,7 @@ bool AdaptDispatch::RequestMode(const DispatchTypes::ModeParams param)\n         state = mapTemp(_api.GetStateMachine().GetParserMode(StateMachine::Mode::Ansi));\n         break;\n     case DispatchTypes::ModeParams::DECCOLM_SetNumberOfColumns:\n-        // DECCOLM is not supported in conpty mode\n-        if (!_api.IsConsolePty())\n-        {\n-            state = mapTemp(_modes.test(Mode::Column));\n-        }\n+        state = mapTemp(_modes.test(Mode::Column));\n         break;\n     case DispatchTypes::ModeParams::DECSCNM_ScreenMode:\n         state = mapTemp(_renderSettings.GetRenderMode(RenderSettings::Mode::ScreenReversed));\n@@ -2138,11 +2103,7 @@ bool AdaptDispatch::RequestMode(const DispatchTypes::ModeParams param)\n         state = mapTemp(_pages.ActivePage().Cursor().IsVisible());\n         break;\n     case DispatchTypes::ModeParams::XTERM_EnableDECCOLMSupport:\n-        // DECCOLM is not supported in conpty mode\n-        if (!_api.IsConsolePty())\n-        {\n-            state = mapTemp(_modes.test(Mode::AllowDECCOLM));\n-        }\n+        state = mapTemp(_modes.test(Mode::AllowDECCOLM));\n         break;\n     case DispatchTypes::ModeParams::DECPCCM_PageCursorCouplingMode:\n         state = mapTemp(_modes.test(Mode::PageCursorCoupling));\n@@ -2217,10 +2178,10 @@ bool AdaptDispatch::RequestMode(const DispatchTypes::ModeParams param)\n // - applicationMode - set to true to enable Application Mode Input, false for Numeric Mode Input.\n // Return Value:\n // - True if handled successfully. False otherwise.\n-bool AdaptDispatch::SetKeypadMode(const bool fApplicationMode)\n+bool AdaptDispatch::SetKeypadMode(const bool fApplicationMode) noexcept\n {\n     _terminalInput.SetInputMode(TerminalInput::Mode::Keypad, fApplicationMode);\n-    return !_PassThroughInputModes();\n+    return true;\n }\n \n // Routine Description:\n@@ -3178,7 +3139,7 @@ bool AdaptDispatch::SoftReset()\n         _sixelParser->SoftReset();\n     }\n \n-    return !_api.IsConsolePty();\n+    return true;\n }\n \n //Routine Description:\n@@ -3280,20 +3241,7 @@ bool AdaptDispatch::HardReset()\n         _macroBuffer = nullptr;\n     }\n \n-    // If we're in a conpty, we need flush this RIS sequence to the connected\n-    // terminal application, but we also need to follow that up with a DECSET\n-    // sequence to re-enable the modes that we require (namely win32 input mode\n-    // and focus event mode). It's important that this is kept in sync with the\n-    // VtEngine::RequestWin32Input method which requests the modes on startup.\n-    if (_api.IsConsolePty())\n-    {\n-        auto& stateMachine = _api.GetStateMachine();\n-        if (stateMachine.FlushToTerminal())\n-        {\n-            auto& engine = stateMachine.Engine();\n-            engine.ActionPassThroughString(L\"\\033[?9001h\\033[?1004h\");\n-        }\n-    }\n+    _api.GetStateMachine().InjectSequence(InjectionType::RIS);\n     return true;\n }\n \n@@ -3353,11 +3301,7 @@ bool AdaptDispatch::_EraseScrollback()\n     cursor.SetYPosition(row - page.Top());\n     cursor.SetHasMoved(true);\n \n-    // GH#2715 - If this succeeded, but we're in a conpty, return `false` to\n-    // make the state machine propagate this ED sequence to the connected\n-    // terminal application. While we're in conpty mode, we don't really\n-    // have a scrollback, but the attached terminal might.\n-    return !_api.IsConsolePty();\n+    return true;\n }\n \n //Routine Description:\n@@ -3379,7 +3323,6 @@ bool AdaptDispatch::_EraseAll()\n     const auto pageHeight = page.Height();\n     const auto bufferHeight = page.BufferHeight();\n     auto& textBuffer = page.Buffer();\n-    const auto inPtyMode = _api.IsConsolePty();\n \n     // Stash away the current position of the cursor within the page.\n     // We'll need to restore the cursor to that same relative position, after\n@@ -3406,10 +3349,7 @@ bool AdaptDispatch::_EraseAll()\n         // We don't want to trigger a scroll in pty mode, because we're going to\n         // pass through the ED sequence anyway, and this will just result in the\n         // buffer being scrolled up by two pages instead of one.\n-        if (!inPtyMode)\n-        {\n-            textBuffer.TriggerScroll({ 0, -delta });\n-        }\n+        textBuffer.TriggerScroll({ 0, -delta });\n     }\n     // Move the viewport if necessary.\n     if (newPageTop != page.Top())\n@@ -3427,15 +3367,7 @@ bool AdaptDispatch::_EraseAll()\n     // Also reset the line rendition for the erased rows.\n     textBuffer.ResetLineRenditionRange(newPageTop, newPageBottom);\n \n-    // GH#5683 - If this succeeded, but we're in a conpty, return `false` to\n-    // make the state machine propagate this ED sequence to the connected\n-    // terminal application. While we're in conpty mode, when the client\n-    // requests a Erase All operation, we need to manually tell the\n-    // connected terminal to do the same thing, so that the terminal will\n-    // move it's own buffer contents into the scrollback. But this only\n-    // applies if we're in the active buffer, since this should have no\n-    // visible effect for an inactive buffer.\n-    return !(inPtyMode && textBuffer.IsActiveBuffer());\n+    return true;\n }\n \n //Routine Description:\n@@ -3492,9 +3424,7 @@ bool AdaptDispatch::SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle)\n     cursor.SetType(actualType);\n     cursor.SetBlinkingAllowed(fEnableBlinking);\n \n-    // If we're a conpty, always return false, so that this cursor state will be\n-    // sent to the connected terminal\n-    return !_api.IsConsolePty();\n+    return true;\n }\n \n // Method Description:\n@@ -3517,12 +3447,6 @@ bool AdaptDispatch::SetCursorColor(const COLORREF cursorColor)\n // - True if handled successfully. False otherwise.\n bool AdaptDispatch::SetClipboard(const wil::zwstring_view content)\n {\n-    // Return false to forward the operation to the hosting terminal,\n-    // since ConPTY can't handle this itself.\n-    if (_api.IsConsolePty())\n-    {\n-        return false;\n-    }\n     _api.CopyToClipboard(content);\n     return true;\n }\n@@ -3538,15 +3462,6 @@ bool AdaptDispatch::SetColorTableEntry(const size_t tableIndex, const DWORD dwCo\n {\n     _renderSettings.SetColorTableEntry(tableIndex, dwColor);\n \n-    // If we're a conpty, always return false, so that we send the updated color\n-    //      value to the terminal. Still handle the sequence so apps that use\n-    //      the API or VT to query the values of the color table still read the\n-    //      correct color.\n-    if (_api.IsConsolePty())\n-    {\n-        return false;\n-    }\n-\n     if (_renderer)\n     {\n         // If we're updating the background color, we need to let the renderer\n@@ -3613,12 +3528,6 @@ bool AdaptDispatch::AssignColor(const DispatchTypes::ColorItem item, const VTInt\n         return false;\n     }\n \n-    // No need to force a redraw in pty mode.\n-    if (_api.IsConsolePty())\n-    {\n-        return false;\n-    }\n-\n     if (_renderer)\n     {\n         const auto backgroundChanged = item == DispatchTypes::ColorItem::NormalText;\n@@ -3727,13 +3636,6 @@ bool AdaptDispatch::EndHyperlink()\n // - True if handled successfully. False otherwise.\n bool AdaptDispatch::DoConEmuAction(const std::wstring_view string)\n {\n-    // Return false to forward the operation to the hosting terminal,\n-    // since ConPTY can't handle this itself.\n-    if (_api.IsConsolePty())\n-    {\n-        return false;\n-    }\n-\n     constexpr size_t TaskbarMaxState{ 4 };\n     constexpr size_t TaskbarMaxProgress{ 100 };\n \n@@ -3835,14 +3737,6 @@ bool AdaptDispatch::DoConEmuAction(const std::wstring_view string)\n // - false in conhost, true for the SetMark action, otherwise false.\n bool AdaptDispatch::DoITerm2Action(const std::wstring_view string)\n {\n-    const auto isConPty = _api.IsConsolePty();\n-    if (isConPty && _renderer)\n-    {\n-        // Flush the frame manually, to make sure marks end up on the right\n-        // line, like the alt buffer sequence.\n-        _renderer->TriggerFlush(false);\n-    }\n-\n     if constexpr (!Feature_ScrollbarMarks::IsEnabled())\n     {\n         return false;\n@@ -3864,7 +3758,7 @@ bool AdaptDispatch::DoITerm2Action(const std::wstring_view string)\n         handled = true;\n     }\n \n-    return handled && !isConPty;\n+    return handled;\n }\n \n // Method Description:\n@@ -3879,14 +3773,6 @@ bool AdaptDispatch::DoITerm2Action(const std::wstring_view string)\n // - false in conhost, true for the SetMark action, otherwise false.\n bool AdaptDispatch::DoFinalTermAction(const std::wstring_view string)\n {\n-    const auto isConPty = _api.IsConsolePty();\n-    if (isConPty && _renderer)\n-    {\n-        // Flush the frame manually, to make sure marks end up on the right\n-        // line, like the alt buffer sequence.\n-        _renderer->TriggerFlush(false);\n-    }\n-\n     if constexpr (!Feature_ScrollbarMarks::IsEnabled())\n     {\n         return false;\n@@ -3955,7 +3841,7 @@ bool AdaptDispatch::DoFinalTermAction(const std::wstring_view string)\n     // simple state machine here to track the most recently emitted mark from\n     // this set of sequences, and which sequence was emitted last, so we can\n     // modify the state of that mark as we go.\n-    return handled && !isConPty;\n+    return handled;\n }\n // Method Description:\n // - Performs a VsCode action\n@@ -3970,14 +3856,6 @@ bool AdaptDispatch::DoFinalTermAction(const std::wstring_view string)\n // - false in conhost, true for the SetMark action, otherwise false.\n bool AdaptDispatch::DoVsCodeAction(const std::wstring_view string)\n {\n-    // This is not implemented in conhost.\n-    if (_api.IsConsolePty() && _renderer)\n-    {\n-        // Flush the frame manually to make sure this action happens at the right time.\n-        _renderer->TriggerFlush(false);\n-        return false;\n-    }\n-\n     if constexpr (!Feature_ShellCompletions::IsEnabled())\n     {\n         return false;\n@@ -4052,14 +3930,6 @@ bool AdaptDispatch::DoVsCodeAction(const std::wstring_view string)\n // - false in conhost, true for the CmdNotFound action, otherwise false.\n bool AdaptDispatch::DoWTAction(const std::wstring_view string)\n {\n-    // This is not implemented in conhost.\n-    if (_api.IsConsolePty())\n-    {\n-        // Flush the frame manually to make sure this action happens at the right time.\n-        _renderer->TriggerFlush(false);\n-        return false;\n-    }\n-\n     const auto parts = Utils::SplitString(string, L';');\n \n     if (parts.size() < 1)\n@@ -4151,19 +4021,7 @@ ITermDispatch::StringHandler AdaptDispatch::DownloadDRCS(const VTInt fontNumber,\n         return nullptr;\n     }\n \n-    // If we're a conpty, we create a special passthrough handler that will\n-    // forward the DECDLD sequence to the conpty terminal with a hard-coded ID.\n-    // That ID is also pre-mapped into the G1 table, so the VT engine can just\n-    // switch to G1 when it needs to output any DRCS characters. But note that\n-    // we still need to process the DECDLD sequence locally, so the character\n-    // set translation is correctly handled on the host side.\n-    const auto conptyPassthrough = _api.IsConsolePty() ? _CreateDrcsPassthroughHandler(charsetSize) : nullptr;\n-\n     return [=](const auto ch) {\n-        if (conptyPassthrough)\n-        {\n-            conptyPassthrough(ch);\n-        }\n         // We pass the data string straight through to the font buffer class\n         // until we receive an ESC, indicating the end of the string. At that\n         // point we can finalize the buffer, and if valid, update the renderer\n@@ -4197,46 +4055,6 @@ ITermDispatch::StringHandler AdaptDispatch::DownloadDRCS(const VTInt fontNumber,\n     };\n }\n \n-// Routine Description:\n-// - Helper method to create a string handler that can be used to pass through\n-//   DECDLD sequences when in conpty mode. This patches the original sequence\n-//   with a hard-coded character set ID, and pre-maps that ID into the G1 table.\n-// Arguments:\n-// - <none>\n-// Return value:\n-// - a function to receive the data or nullptr if the initial flush fails\n-ITermDispatch::StringHandler AdaptDispatch::_CreateDrcsPassthroughHandler(const DispatchTypes::CharsetSize charsetSize)\n-{\n-    const auto defaultPassthrough = _CreatePassthroughHandler();\n-    if (defaultPassthrough)\n-    {\n-        auto& engine = _api.GetStateMachine().Engine();\n-        return [=, &engine, gotId = false](const auto ch) mutable {\n-            // The character set ID is contained in the first characters of the\n-            // sequence, so we just ignore that initial content until we receive\n-            // a \"final\" character (i.e. in range 30 to 7E). At that point we\n-            // pass through a hard-coded ID of \"@\".\n-            if (!gotId)\n-            {\n-                if (ch >= 0x30 && ch <= 0x7E)\n-                {\n-                    gotId = true;\n-                    defaultPassthrough('@');\n-                }\n-            }\n-            else if (!defaultPassthrough(ch))\n-            {\n-                // Once the DECDLD sequence is finished, we also output an SCS\n-                // sequence to map the character set into the G1 table.\n-                const auto charset96 = charsetSize == DispatchTypes::CharsetSize::Size96;\n-                engine.ActionPassThroughString(charset96 ? L\"\\033-@\" : L\"\\033)@\");\n-            }\n-            return true;\n-        };\n-    }\n-    return nullptr;\n-}\n-\n // Method Description:\n // - DECRQUPSS - Request the user-preference supplemental character set.\n // Arguments:\n@@ -4367,13 +4185,6 @@ ITermDispatch::StringHandler AdaptDispatch::RestoreTerminalState(const DispatchT\n // - a function to parse the report data.\n ITermDispatch::StringHandler AdaptDispatch::_RestoreColorTable()\n {\n-    // If we're a conpty, we create a passthrough string handler to forward the\n-    // color report to the connected terminal.\n-    if (_api.IsConsolePty())\n-    {\n-        return _CreatePassthroughHandler();\n-    }\n-\n     return [this, parameter = VTInt{}, parameters = std::vector<VTParameter>{}](const auto ch) mutable {\n         if (ch >= L'0' && ch <= L'9')\n         {\n@@ -5049,15 +4860,6 @@ ITermDispatch::StringHandler AdaptDispatch::_RestoreTabStops()\n // - True if handled successfully. False otherwise.\n bool AdaptDispatch::PlaySounds(const VTParameters parameters)\n {\n-    // If we're a conpty, we return false so the command will be passed on\n-    // to the connected terminal. But we need to flush the current frame\n-    // first, otherwise the visual output will lag behind the sound.\n-    if (_api.IsConsolePty() && _renderer)\n-    {\n-        _renderer->TriggerFlush(false);\n-        return false;\n-    }\n-\n     // First parameter is the volume, in the range 0 to 7. We multiply by\n     // 127 / 7 to obtain an equivalent MIDI velocity in the range 0 to 127.\n     const auto velocity = std::min(parameters.at(0).value_or(0), 7) * 127 / 7;\n@@ -5076,51 +4878,3 @@ bool AdaptDispatch::PlaySounds(const VTParameters parameters)\n         return true;\n     });\n }\n-\n-// Routine Description:\n-// - Helper method to create a string handler that can be used to pass through\n-//   DCS sequences when in conpty mode.\n-// Arguments:\n-// - <none>\n-// Return value:\n-// - a function to receive the data or nullptr if the initial flush fails\n-ITermDispatch::StringHandler AdaptDispatch::_CreatePassthroughHandler()\n-{\n-    // Before we pass through any more data, we need to flush the current frame\n-    // first, otherwise it can end up arriving out of sync.\n-    if (_renderer)\n-    {\n-        _renderer->TriggerFlush(false);\n-    }\n-\n-    // Then we need to flush the sequence introducer and parameters that have\n-    // already been parsed by the state machine.\n-    auto& stateMachine = _api.GetStateMachine();\n-    if (stateMachine.FlushToTerminal())\n-    {\n-        // And finally we create a StringHandler to receive the rest of the\n-        // sequence data, and pass it through to the connected terminal.\n-        auto& engine = stateMachine.Engine();\n-        return [&, buffer = std::wstring{}](const auto ch) mutable {\n-            // To make things more efficient, we buffer the string data before\n-            // passing it through, only flushing if the buffer gets too large,\n-            // or we're dealing with the last character in the current output\n-            // fragment, or we've reached the end of the string.\n-            const auto endOfString = ch == AsciiChars::ESC;\n-            buffer += ch;\n-            if (buffer.length() >= 4096 || stateMachine.IsProcessingLastCharacter() || endOfString)\n-            {\n-                // The end of the string is signaled with an escape, but for it\n-                // to be a valid string terminator we need to add a backslash.\n-                if (endOfString)\n-                {\n-                    buffer += L'\\\\';\n-                }\n-                engine.ActionPassThroughString(buffer, true);\n-                buffer.clear();\n-            }\n-            return !endOfString;\n-        };\n-    }\n-    return nullptr;\n-}\ndiff --git a/src/terminal/adapter/adaptDispatch.hpp b/src/terminal/adapter/adaptDispatch.hpp\nindex d4e46c6feeb..c7a913e2bf7 100644\n--- a/src/terminal/adapter/adaptDispatch.hpp\n+++ b/src/terminal/adapter/adaptDispatch.hpp\n@@ -95,7 +95,7 @@ namespace Microsoft::Console::VirtualTerminal\n         bool SetMode(const DispatchTypes::ModeParams param) override; // SM, DECSET\n         bool ResetMode(const DispatchTypes::ModeParams param) override; // RM, DECRST\n         bool RequestMode(const DispatchTypes::ModeParams param) override; // DECRQM\n-        bool SetKeypadMode(const bool applicationMode) override; // DECKPAM, DECKPNM\n+        bool SetKeypadMode(const bool applicationMode) noexcept override; // DECKPAM, DECKPNM\n         bool SetAnsiMode(const bool ansiMode) override; // DECANM\n         bool SetTopBottomScrollingMargins(const VTInt topMargin,\n                                           const VTInt bottomMargin) override; // DECSTBM\n@@ -265,7 +265,6 @@ namespace Microsoft::Console::VirtualTerminal\n \n         void _SetColumnMode(const bool enable);\n         void _SetAlternateScreenBufferMode(const bool enable);\n-        bool _PassThroughInputModes();\n         bool _ModeParamsHelper(const DispatchTypes::ModeParams param, const bool enable);\n \n         void _ClearSingleTabStop();\n@@ -286,9 +285,6 @@ namespace Microsoft::Console::VirtualTerminal\n         void _ReportTabStops();\n         StringHandler _RestoreTabStops();\n \n-        StringHandler _CreateDrcsPassthroughHandler(const DispatchTypes::CharsetSize charsetSize);\n-        StringHandler _CreatePassthroughHandler();\n-\n         std::vector<uint8_t> _tabStopColumns;\n         bool _initDefaultTabStops = true;\n \ndiff --git a/src/terminal/adapter/ut_adapter/adapterTest.cpp b/src/terminal/adapter/ut_adapter/adapterTest.cpp\nindex da5a7c93cb2..ca44278b96e 100644\n--- a/src/terminal/adapter/ut_adapter/adapterTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/adapterTest.cpp\n@@ -195,12 +195,6 @@ class TestGetSet final : public ITerminalApi\n         Log::Comment(L\"PlayMidiNote MOCK called...\");\r\n     }\r\n \r\n-    bool IsConsolePty() const override\r\n-    {\r\n-        Log::Comment(L\"IsConsolePty MOCK called...\");\r\n-        return _isPty;\r\n-    }\r\n-\r\n     void NotifyAccessibilityChange(const til::rect& /*changedRect*/) override\r\n     {\r\n         Log::Comment(L\"NotifyAccessibilityChange MOCK called...\");\r\n@@ -1710,7 +1704,7 @@ class AdapterTest\n         _testGetSet->PrepData();\r\n         VERIFY_IS_TRUE(_pDispatch->DeviceAttributes());\r\n \r\n-        auto pwszExpectedResponse = L\"\\x1b[?61;1;4;6;7;14;21;22;23;24;28;32;42c\";\r\n+        auto pwszExpectedResponse = L\"\\x1b[?61;4;6;7;14;21;22;23;24;28;32;42c\";\r\n         _testGetSet->ValidateInputEvent(pwszExpectedResponse);\r\n \r\n         Log::Comment(L\"Test 2: Verify failure when ReturnResponse doesn't work.\");\r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.cpp b/src/terminal/parser/OutputStateMachineEngine.cpp\nindex 0c12c5e9b1f..82576afd542 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.cpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.cpp\n@@ -4,11 +4,12 @@\n #include \"precomp.h\"\r\n #include \"OutputStateMachineEngine.hpp\"\r\n \r\n+#include <conattrs.hpp>\r\n+\r\n #include \"ascii.hpp\"\r\n #include \"base64.hpp\"\r\n #include \"stateMachine.hpp\"\r\n #include \"../../types/inc/utils.hpp\"\r\n-#include \"../renderer/vt/vtrenderer.hpp\"\r\n \r\n using namespace Microsoft::Console;\r\n using namespace Microsoft::Console::VirtualTerminal;\r\n@@ -16,8 +17,6 @@ using namespace Microsoft::Console::VirtualTerminal;\n // takes ownership of pDispatch\r\n OutputStateMachineEngine::OutputStateMachineEngine(std::unique_ptr<ITermDispatch> pDispatch) :\r\n     _dispatch(std::move(pDispatch)),\r\n-    _pfnFlushToTerminal(nullptr),\r\n-    _pTtyConnection(nullptr),\r\n     _lastPrintedChar(AsciiChars::NUL)\r\n {\r\n     THROW_HR_IF_NULL(E_INVALIDARG, _dispatch.get());\r\n@@ -56,12 +55,6 @@ bool OutputStateMachineEngine::ActionExecute(const wchar_t wch)\n         break;\r\n     case AsciiChars::BEL:\r\n         _dispatch->WarningBell();\r\n-        // microsoft/terminal#2952\r\n-        // If we're attached to a terminal, let's also pass the BEL through.\r\n-        if (_pfnFlushToTerminal != nullptr)\r\n-        {\r\n-            _pfnFlushToTerminal();\r\n-        }\r\n         break;\r\n     case AsciiChars::BS:\r\n         _dispatch->CursorBackward(1);\r\n@@ -183,18 +176,9 @@ bool OutputStateMachineEngine::ActionPrintString(const std::wstring_view string)\n // - flush - set to true if the string should be flushed immediately.\r\n // Return Value:\r\n // - true iff we successfully dispatched the sequence.\r\n-bool OutputStateMachineEngine::ActionPassThroughString(const std::wstring_view string, const bool flush)\r\n+bool OutputStateMachineEngine::ActionPassThroughString(const std::wstring_view /*string*/, const bool /*flush*/) noexcept\r\n {\r\n-    auto success = true;\r\n-    if (_pTtyConnection != nullptr)\r\n-    {\r\n-        const auto hr = _pTtyConnection->WriteTerminalW(string, flush);\r\n-        LOG_IF_FAILED(hr);\r\n-        success = SUCCEEDED(hr);\r\n-    }\r\n-    // If there's not a TTY connection, our previous behavior was to eat the string.\r\n-\r\n-    return success;\r\n+    return true;\r\n }\r\n \r\n // Routine Description:\r\n@@ -335,13 +319,6 @@ bool OutputStateMachineEngine::ActionEscDispatch(const VTID id)\n         }\r\n     }\r\n \r\n-    // If we were unable to process the string, and there's a TTY attached to us,\r\n-    //      trigger the state machine to flush the string to the terminal.\r\n-    if (_pfnFlushToTerminal != nullptr && !success)\r\n-    {\r\n-        success = _pfnFlushToTerminal();\r\n-    }\r\n-\r\n     _ClearLastChar();\r\n \r\n     return success;\r\n@@ -693,13 +670,6 @@ bool OutputStateMachineEngine::ActionCsiDispatch(const VTID id, const VTParamete\n         break;\r\n     }\r\n \r\n-    // If we were unable to process the string, and there's a TTY attached to us,\r\n-    //      trigger the state machine to flush the string to the terminal.\r\n-    if (_pfnFlushToTerminal != nullptr && !success)\r\n-    {\r\n-        success = _pfnFlushToTerminal();\r\n-    }\r\n-\r\n     _ClearLastChar();\r\n \r\n     return success;\r\n@@ -929,13 +899,6 @@ bool OutputStateMachineEngine::ActionOscDispatch(const size_t parameter, const s\n         break;\r\n     }\r\n \r\n-    // If we were unable to process the string, and there's a TTY attached to us,\r\n-    //      trigger the state machine to flush the string to the terminal.\r\n-    if (_pfnFlushToTerminal != nullptr && !success)\r\n-    {\r\n-        success = _pfnFlushToTerminal();\r\n-    }\r\n-\r\n     _ClearLastChar();\r\n \r\n     return success;\r\n@@ -1093,26 +1056,6 @@ bool OutputStateMachineEngine::_GetOscSetColor(const std::wstring_view string,\n     return rgbs.size() > 0;\r\n }\r\n \r\n-// Method Description:\r\n-// - Sets us up to have another terminal acting as the tty instead of conhost.\r\n-//      We'll set a couple members, and if they aren't null, when we get a\r\n-//      sequence we don't understand, we'll pass it along to the terminal\r\n-//      instead of eating it ourselves.\r\n-// Arguments:\r\n-// - pTtyConnection: This is a TerminalOutputConnection that we can write the\r\n-//      sequence we didn't understand to.\r\n-// - pfnFlushToTerminal: This is a callback to the underlying state machine to\r\n-//      trigger it to call ActionPassThroughString with whatever sequence it's\r\n-//      currently processing.\r\n-// Return Value:\r\n-// - <none>\r\n-void OutputStateMachineEngine::SetTerminalConnection(Render::VtEngine* const pTtyConnection,\r\n-                                                     std::function<bool()> pfnFlushToTerminal)\r\n-{\r\n-    this->_pTtyConnection = pTtyConnection;\r\n-    this->_pfnFlushToTerminal = pfnFlushToTerminal;\r\n-}\r\n-\r\n // Routine Description:\r\n // - Parse OscSetClipboard parameters with the format `Pc;Pd`. Currently the first parameter `Pc` is\r\n // ignored. The second parameter `Pd` should be a valid base64 string or character `?`.\r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.hpp b/src/terminal/parser/OutputStateMachineEngine.hpp\nindex 68097473995..5be20ae2513 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.hpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.hpp\n@@ -15,11 +15,6 @@ Module Name:\n #include \"../adapter/termDispatch.hpp\"\r\n #include \"IStateMachineEngine.hpp\"\r\n \r\n-namespace Microsoft::Console::Render\r\n-{\r\n-    class VtEngine;\r\n-}\r\n-\r\n namespace Microsoft::Console::VirtualTerminal\r\n {\r\n     class OutputStateMachineEngine : public IStateMachineEngine\r\n@@ -38,7 +33,7 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         bool ActionPrintString(const std::wstring_view string) override;\r\n \r\n-        bool ActionPassThroughString(const std::wstring_view string, const bool flush) override;\r\n+        bool ActionPassThroughString(const std::wstring_view string, const bool flush) noexcept override;\r\n \r\n         bool ActionEscDispatch(const VTID id) override;\r\n \r\n@@ -56,16 +51,11 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         bool ActionSs3Dispatch(const wchar_t wch, const VTParameters parameters) noexcept override;\r\n \r\n-        void SetTerminalConnection(Microsoft::Console::Render::VtEngine* const pTtyConnection,\r\n-                                   std::function<bool()> pfnFlushToTerminal);\r\n-\r\n         const ITermDispatch& Dispatch() const noexcept;\r\n         ITermDispatch& Dispatch() noexcept;\r\n \r\n     private:\r\n         std::unique_ptr<ITermDispatch> _dispatch;\r\n-        Microsoft::Console::Render::VtEngine* _pTtyConnection;\r\n-        std::function<bool()> _pfnFlushToTerminal;\r\n         wchar_t _lastPrintedChar;\r\n \r\n         enum EscActionCodes : uint64_t\r\ndiff --git a/src/terminal/parser/ft_fuzzer/sources b/src/terminal/parser/ft_fuzzer/sources\nindex 6ac8fbbb39a..a8c508a25dc 100644\n--- a/src/terminal/parser/ft_fuzzer/sources\n+++ b/src/terminal/parser/ft_fuzzer/sources\n@@ -67,8 +67,6 @@ SOURCES = \\\n \r\n INCLUDES = \\\r\n     ..\\..\\..\\inc; \\\r\n-    $(CONSOLE_SRC_PATH)\\..\\oss\\dynamic_bitset; \\\r\n-    $(CONSOLE_SRC_PATH)\\..\\oss\\libpopcnt; \\\r\n     $(CONSOLE_SRC_PATH)\\..\\oss\\chromium; \\\r\n     $(CONSOLE_SRC_PATH)\\..\\oss\\fmt\\include; \\\r\n     $(CONSOLE_SRC_PATH)\\..\\oss\\interval_tree; \\\r\ndiff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 23bc83ecc81..07918e902bc 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -1859,7 +1859,7 @@ void StateMachine::ProcessCharacter(const wchar_t wch)\n         // code points that get translated as C1 controls when that is not their\r\n         // intended use. In order to avoid them triggering unintentional escape\r\n         // sequences, we ignore these characters by default.\r\n-        if (_parserMode.any(Mode::AcceptC1, Mode::AlwaysAcceptC1))\r\n+        if (_parserMode.test(Mode::AcceptC1))\r\n         {\r\n             ProcessCharacter(AsciiChars::ESC);\r\n             ProcessCharacter(_c1To7Bit(wch));\r\n@@ -1978,6 +1978,7 @@ void StateMachine::ProcessString(const std::wstring_view string)\n     _currentString = string;\r\n     _runOffset = 0;\r\n     _runSize = 0;\r\n+    _injections.clear();\r\n \r\n     if (_state != VTStates::Ground)\r\n     {\r\n@@ -2098,6 +2099,16 @@ bool StateMachine::IsProcessingLastCharacter() const noexcept\n     return _processingLastCharacter;\r\n }\r\n \r\n+void StateMachine::InjectSequence(const InjectionType type)\r\n+{\r\n+    _injections.emplace_back(type, _runOffset + _runSize);\r\n+}\r\n+\r\n+const til::small_vector<Injection, 8>& StateMachine::GetInjections() const noexcept\r\n+{\r\n+    return _injections;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Registers a function that will be called once the current CSI action is\r\n //   complete and the state machine has returned to the ground state.\r\ndiff --git a/src/terminal/parser/stateMachine.hpp b/src/terminal/parser/stateMachine.hpp\nindex 245e25fefa6..b74b9d3d474 100644\n--- a/src/terminal/parser/stateMachine.hpp\n+++ b/src/terminal/parser/stateMachine.hpp\n@@ -37,6 +37,18 @@ namespace Microsoft::Console::VirtualTerminal\n     // the their indexes.\r\n     static_assert(MAX_PARAMETER_COUNT * MAX_SUBPARAMETER_COUNT <= 256);\r\n \r\n+    enum class InjectionType : size_t\r\n+    {\r\n+        RIS,\r\n+        DECSET_FOCUS,\r\n+    };\r\n+\r\n+    struct Injection\r\n+    {\r\n+        InjectionType type;\r\n+        size_t offset;\r\n+    };\r\n+\r\n     class StateMachine final\r\n     {\r\n #ifdef UNIT_TESTING\r\n@@ -55,7 +67,6 @@ namespace Microsoft::Console::VirtualTerminal\n         enum class Mode : size_t\r\n         {\r\n             AcceptC1,\r\n-            AlwaysAcceptC1,\r\n             Ansi,\r\n         };\r\n \r\n@@ -66,10 +77,11 @@ namespace Microsoft::Console::VirtualTerminal\n         void ProcessString(const std::wstring_view string);\r\n         bool IsProcessingLastCharacter() const noexcept;\r\n \r\n-        void OnCsiComplete(const std::function<void()> callback);\r\n+        void InjectSequence(InjectionType type);\r\n+        const til::small_vector<Injection, 8>& GetInjections() const noexcept;\r\n \r\n+        void OnCsiComplete(const std::function<void()> callback);\r\n         void ResetState() noexcept;\r\n-\r\n         bool FlushToTerminal();\r\n \r\n         const IStateMachineEngine& Engine() const noexcept;\r\n@@ -212,6 +224,7 @@ namespace Microsoft::Console::VirtualTerminal\n         IStateMachineEngine::StringHandler _dcsStringHandler;\r\n \r\n         std::optional<std::wstring> _cachedSequence;\r\n+        til::small_vector<Injection, 8> _injections;\r\n \r\n         // This is tracked per state machine instance so that separate calls to Process*\r\n         //   can start and finish a sequence.\r\ndiff --git a/src/til/ut_til/BitmapTests.cpp b/src/til/ut_til/BitmapTests.cpp\ndeleted file mode 100644\nindex b17bf0fff4e..00000000000\n--- a/src/til/ut_til/BitmapTests.cpp\n+++ /dev/null\n@@ -1,1095 +0,0 @@\n-// Copyright (c) Microsoft Corporation.\r\n-// Licensed under the MIT license.\r\n-\r\n-#include \"precomp.h\"\r\n-\r\n-#include \"til/bitmap.h\"\r\n-\r\n-using namespace WEX::Common;\r\n-using namespace WEX::Logging;\r\n-using namespace WEX::TestExecution;\r\n-\r\n-class BitmapTests\r\n-{\r\n-    TEST_CLASS(BitmapTests);\r\n-\r\n-    template<typename T>\r\n-    void _checkBits(const til::rect& bitsOn,\r\n-                    const til::details::bitmap<T>& map)\r\n-    {\r\n-        _checkBits(std::vector<til::rect>{ bitsOn }, map);\r\n-    }\r\n-\r\n-    template<typename T>\r\n-    void _checkBits(const std::vector<til::rect>& bitsOn,\r\n-                    const til::details::bitmap<T>& map)\r\n-    {\r\n-        Log::Comment(L\"Check all bits in map.\");\r\n-        // For every point in the map...\r\n-        for (const auto pt : map._rc)\r\n-        {\r\n-            // If any of the rectangles we were given contains this point, we expect it should be on.\r\n-            const auto expected = std::any_of(bitsOn.cbegin(), bitsOn.cend(), [&pt](auto bitRect) { return bitRect.contains(pt); });\r\n-\r\n-            // Get the actual bit out of the map.\r\n-            const auto actual = map._bits[map._rc.index_of(pt)];\r\n-\r\n-            // Do it this way and not with equality so you can see it in output.\r\n-            if (expected)\r\n-            {\r\n-                VERIFY_IS_TRUE(actual);\r\n-            }\r\n-            else\r\n-            {\r\n-                VERIFY_IS_FALSE(actual);\r\n-            }\r\n-        }\r\n-    }\r\n-\r\n-    TEST_METHOD(DefaultConstruct)\r\n-    {\r\n-        const til::bitmap bitmap;\r\n-        const til::size expectedSize{ 0, 0 };\r\n-        const til::rect expectedRect{ 0, 0, 0, 0 };\r\n-        VERIFY_ARE_EQUAL(expectedSize, bitmap._sz);\r\n-        VERIFY_ARE_EQUAL(expectedRect, bitmap._rc);\r\n-        VERIFY_ARE_EQUAL(0u, bitmap._bits.size());\r\n-\r\n-        // The find will go from begin to end in the bits looking for a \"true\".\r\n-        // It should miss so the result should be \"cend\" and turn out true here.\r\n-        VERIFY_IS_TRUE(bitmap._bits.none());\r\n-    }\r\n-\r\n-    TEST_METHOD(SizeConstruct)\r\n-    {\r\n-        const til::size expectedSize{ 5, 10 };\r\n-        const til::rect expectedRect{ 0, 0, 5, 10 };\r\n-        const til::bitmap bitmap{ expectedSize };\r\n-        VERIFY_ARE_EQUAL(expectedSize, bitmap._sz);\r\n-        VERIFY_ARE_EQUAL(expectedRect, bitmap._rc);\r\n-        VERIFY_ARE_EQUAL(50u, bitmap._bits.size());\r\n-\r\n-        // The find will go from begin to end in the bits looking for a \"true\".\r\n-        // It should miss so the result should be \"cend\" and turn out true here.\r\n-        VERIFY_IS_TRUE(bitmap._bits.none());\r\n-    }\r\n-\r\n-    TEST_METHOD(SizeConstructWithFill)\r\n-    {\r\n-        BEGIN_TEST_METHOD_PROPERTIES()\r\n-            TEST_METHOD_PROPERTY(L\"Data:fill\", L\"{true, false}\")\r\n-        END_TEST_METHOD_PROPERTIES()\r\n-\r\n-        bool fill;\r\n-        VERIFY_SUCCEEDED_RETURN(TestData::TryGetValue(L\"fill\", fill));\r\n-\r\n-        const til::size expectedSize{ 5, 10 };\r\n-        const til::rect expectedRect{ 0, 0, 5, 10 };\r\n-        const til::bitmap bitmap{ expectedSize, fill };\r\n-        VERIFY_ARE_EQUAL(expectedSize, bitmap._sz);\r\n-        VERIFY_ARE_EQUAL(expectedRect, bitmap._rc);\r\n-        VERIFY_ARE_EQUAL(50u, bitmap._bits.size());\r\n-\r\n-        if (!fill)\r\n-        {\r\n-            VERIFY_IS_TRUE(bitmap._bits.none());\r\n-        }\r\n-        else\r\n-        {\r\n-            VERIFY_IS_TRUE(bitmap._bits.all());\r\n-        }\r\n-    }\r\n-\r\n-    TEST_METHOD(Equality)\r\n-    {\r\n-        Log::Comment(L\"0.) Defaults are equal\");\r\n-        {\r\n-            const til::bitmap one;\r\n-            const til::bitmap two;\r\n-            VERIFY_IS_TRUE(one == two);\r\n-        }\r\n-\r\n-        Log::Comment(L\"1.) Different sizes are unequal\");\r\n-        {\r\n-            const til::bitmap one{ til::size{ 2, 2 } };\r\n-            const til::bitmap two{ til::size{ 3, 3 } };\r\n-            VERIFY_IS_FALSE(one == two);\r\n-        }\r\n-\r\n-        Log::Comment(L\"2.) Same bits set are equal\");\r\n-        {\r\n-            til::bitmap one{ til::size{ 2, 2 } };\r\n-            til::bitmap two{ til::size{ 2, 2 } };\r\n-            one.set(til::point{ 0, 1 });\r\n-            one.set(til::point{ 1, 0 });\r\n-            two.set(til::point{ 0, 1 });\r\n-            two.set(til::point{ 1, 0 });\r\n-            VERIFY_IS_TRUE(one == two);\r\n-        }\r\n-\r\n-        Log::Comment(L\"3.) Different bits set are not equal\");\r\n-        {\r\n-            til::bitmap one{ til::size{ 2, 2 } };\r\n-            til::bitmap two{ til::size{ 2, 2 } };\r\n-            one.set(til::point{ 0, 1 });\r\n-            two.set(til::point{ 1, 0 });\r\n-            VERIFY_IS_FALSE(one == two);\r\n-        }\r\n-    }\r\n-\r\n-    TEST_METHOD(Inequality)\r\n-    {\r\n-        Log::Comment(L\"0.) Defaults are equal\");\r\n-        {\r\n-            const til::bitmap one;\r\n-            const til::bitmap two;\r\n-            VERIFY_IS_FALSE(one != two);\r\n-        }\r\n-\r\n-        Log::Comment(L\"1.) Different sizes are unequal\");\r\n-        {\r\n-            const til::bitmap one{ til::size{ 2, 2 } };\r\n-            const til::bitmap two{ til::size{ 3, 3 } };\r\n-            VERIFY_IS_TRUE(one != two);\r\n-        }\r\n-\r\n-        Log::Comment(L\"2.) Same bits set are equal\");\r\n-        {\r\n-            til::bitmap one{ til::size{ 2, 2 } };\r\n-            til::bitmap two{ til::size{ 2, 2 } };\r\n-            one.set(til::point{ 0, 1 });\r\n-            one.set(til::point{ 1, 0 });\r\n-            two.set(til::point{ 0, 1 });\r\n-            two.set(til::point{ 1, 0 });\r\n-            VERIFY_IS_FALSE(one != two);\r\n-        }\r\n-\r\n-        Log::Comment(L\"3.) Different bits set are not equal\");\r\n-        {\r\n-            til::bitmap one{ til::size{ 2, 2 } };\r\n-            til::bitmap two{ til::size{ 2, 2 } };\r\n-            one.set(til::point{ 0, 1 });\r\n-            two.set(til::point{ 1, 0 });\r\n-            VERIFY_IS_TRUE(one != two);\r\n-        }\r\n-    }\r\n-\r\n-    TEST_METHOD(Translate)\r\n-    {\r\n-        const til::size mapSize{ 4, 4 };\r\n-        til::bitmap map{ mapSize };\r\n-\r\n-        // set the middle four bits of the map.\r\n-        // 0 0 0 0\r\n-        // 0 1 1 0\r\n-        // 0 1 1 0\r\n-        // 0 0 0 0\r\n-        map.set(til::rect{ til::point{ 1, 1 }, til::size{ 2, 2 } });\r\n-\r\n-        Log::Comment(L\"1.) Move down and right\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // |\r\n-            // v\r\n-            // |\r\n-            // v --> -->\r\n-            const til::point delta{ 2, 2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0         0 0 0 0          0 0 0 0\r\n-            // 0 1 1 0         0 0 0 0          0 0 0 0\r\n-            // 0 1 1 0 v  -->  0 0 0 0   -->    0 0 0 0\r\n-            // 0 0 0 0 v       0 1 1 0          0 0 0 1\r\n-            //                     ->->\r\n-            expected.set(til::point{ 3, 3 });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"2.) Move down\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // |\r\n-            // v\r\n-            // |\r\n-            // v\r\n-            const til::point delta{ 0, 2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0         0 0 0 0\r\n-            // 0 1 1 0         0 0 0 0\r\n-            // 0 1 1 0 v  -->  0 0 0 0\r\n-            // 0 0 0 0 v       0 1 1 0\r\n-            expected.set(til::rect{ til::point{ 1, 3 }, til::size{ 2, 1 } });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"3.) Move down and left\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // |\r\n-            // v\r\n-            // |\r\n-            // v <-- <--\r\n-            const til::point delta{ -2, 2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0         0 0 0 0          0 0 0 0\r\n-            // 0 1 1 0         0 0 0 0          0 0 0 0\r\n-            // 0 1 1 0 v  -->  0 0 0 0   -->    0 0 0 0\r\n-            // 0 0 0 0 v       0 1 1 0          1 0 0 0\r\n-            //                 <-<-\r\n-            expected.set(til::point{ 0, 3 });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"4.) Move left\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // <-- <--\r\n-            const til::point delta{ -2, 0 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0         0 0 0 0\r\n-            // 0 1 1 0         1 0 0 0\r\n-            // 0 1 1 0    -->  1 0 0 0\r\n-            // 0 0 0 0         0 0 0 0\r\n-            // <--<--\r\n-            expected.set(til::rect{ til::point{ 0, 1 }, til::size{ 1, 2 } });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"5.) Move up and left\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // ^\r\n-            // |\r\n-            // ^\r\n-            // | <-- <--\r\n-            const til::point delta{ -2, -2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0 ^       0 1 1 0          1 0 0 0\r\n-            // 0 1 1 0 ^       0 0 0 0          0 0 0 0\r\n-            // 0 1 1 0    -->  0 0 0 0   -->    0 0 0 0\r\n-            // 0 0 0 0         0 0 0 0          0 0 0 0\r\n-            //                 <-<-\r\n-            expected.set(til::point{ 0, 0 });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"6.) Move up\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // ^\r\n-            // |\r\n-            // ^\r\n-            // |\r\n-            const til::point delta{ 0, -2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0 ^       0 1 1 0\r\n-            // 0 1 1 0 ^       0 0 0 0\r\n-            // 0 1 1 0    -->  0 0 0 0\r\n-            // 0 0 0 0         0 0 0 0\r\n-            expected.set(til::rect{ til::point{ 1, 0 }, til::size{ 2, 1 } });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"7.) Move up and right\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // ^\r\n-            // |\r\n-            // ^\r\n-            // | --> -->\r\n-            const til::point delta{ 2, -2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0 ^       0 1 1 0          0 0 0 1\r\n-            // 0 1 1 0 ^       0 0 0 0          0 0 0 0\r\n-            // 0 1 1 0    -->  0 0 0 0   -->    0 0 0 0\r\n-            // 0 0 0 0         0 0 0 0          0 0 0 0\r\n-            //                     ->->\r\n-            expected.set(til::point{ 3, 0 });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"8.) Move right\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // --> -->\r\n-            const til::point delta{ 2, 0 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:\r\n-            // 0 0 0 0         0 0 0 0\r\n-            // 0 1 1 0         0 0 0 1\r\n-            // 0 1 1 0    -->  0 0 0 1\r\n-            // 0 0 0 0         0 0 0 0\r\n-            //     ->->\r\n-            expected.set(til::rect{ til::point{ 3, 1 }, til::size{ 1, 2 } });\r\n-\r\n-            actual.translate(delta);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-    }\r\n-\r\n-    TEST_METHOD(TranslateWithFill)\r\n-    {\r\n-        const til::size mapSize{ 4, 4 };\r\n-        til::bitmap map{ mapSize };\r\n-\r\n-        // set the middle four bits of the map.\r\n-        // 0 0 0 0\r\n-        // 0 1 1 0\r\n-        // 0 1 1 0\r\n-        // 0 0 0 0\r\n-        map.set(til::rect{ til::point{ 1, 1 }, til::size{ 2, 2 } });\r\n-\r\n-        Log::Comment(L\"1.) Move down and right\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // |\r\n-            // v\r\n-            // |\r\n-            // v --> -->\r\n-            const til::point delta{ 2, 2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected: (F is filling uncovered value)\r\n-            // 0 0 0 0         F F F F          F F F F\r\n-            // 0 1 1 0         F F F F          F F F F\r\n-            // 0 1 1 0 v  -->  0 0 0 0   -->    F F 0 0\r\n-            // 0 0 0 0 v       0 1 1 0          F F 0 1\r\n-            //                     ->->\r\n-            expected.set(til::rect{ til::point{ 0, 0 }, til::size{ 4, 2 } });\r\n-            expected.set(til::rect{ til::point{ 0, 2 }, til::size{ 2, 2 } });\r\n-            expected.set(til::point{ 3, 3 });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"2.) Move down\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // |\r\n-            // v\r\n-            // |\r\n-            // v\r\n-            const til::point delta{ 0, 2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected: (F is filling uncovered value)\r\n-            // 0 0 0 0         F F F F\r\n-            // 0 1 1 0         F F F F\r\n-            // 0 1 1 0 v  -->  0 0 0 0\r\n-            // 0 0 0 0 v       0 1 1 0\r\n-            expected.set(til::rect{ til::point{ 0, 0 }, til::size{ 4, 2 } });\r\n-            expected.set(til::rect{ til::point{ 1, 3 }, til::size{ 2, 1 } });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"3.) Move down and left\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // |\r\n-            // v\r\n-            // |\r\n-            // v <-- <--\r\n-            const til::point delta{ -2, 2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected: (F is filling uncovered value)\r\n-            // 0 0 0 0         F F F F          F F F F\r\n-            // 0 1 1 0         F F F F          F F F F\r\n-            // 0 1 1 0 v  -->  0 0 0 0   -->    0 0 F F\r\n-            // 0 0 0 0 v       0 1 1 0          1 0 F F\r\n-            //                 <-<-\r\n-            expected.set(til::rect{ til::point{ 0, 0 }, til::size{ 4, 2 } });\r\n-            expected.set(til::rect{ til::point{ 2, 2 }, til::size{ 2, 2 } });\r\n-            expected.set(til::point{ 0, 3 });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"4.) Move left\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // <-- <--\r\n-            const til::point delta{ -2, 0 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected: (F is filling uncovered value)\r\n-            // 0 0 0 0         0 0 F F\r\n-            // 0 1 1 0         1 0 F F\r\n-            // 0 1 1 0    -->  1 0 F F\r\n-            // 0 0 0 0         0 0 F F\r\n-            // <--<--\r\n-            expected.set(til::rect{ til::point{ 2, 0 }, til::size{ 2, 4 } });\r\n-            expected.set(til::rect{ til::point{ 0, 1 }, til::size{ 1, 2 } });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"5.) Move up and left\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // ^\r\n-            // |\r\n-            // ^\r\n-            // | <-- <--\r\n-            const til::point delta{ -2, -2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected: (F is filling uncovered value)\r\n-            // 0 0 0 0 ^       0 1 1 0          1 0 F F\r\n-            // 0 1 1 0 ^       0 0 0 0          0 0 F F\r\n-            // 0 1 1 0    -->  F F F F   -->    F F F F\r\n-            // 0 0 0 0         F F F F          F F F F\r\n-            //                 <-<-\r\n-            expected.set(til::rect{ til::point{ 2, 0 }, til::size{ 2, 2 } });\r\n-            expected.set(til::rect{ til::point{ 0, 2 }, til::size{ 4, 2 } });\r\n-            expected.set(til::point{ 0, 0 });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"6.) Move up\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // ^\r\n-            // |\r\n-            // ^\r\n-            // |\r\n-            const til::point delta{ 0, -2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected: (F is filling uncovered value)\r\n-            // 0 0 0 0 ^       0 1 1 0\r\n-            // 0 1 1 0 ^       0 0 0 0\r\n-            // 0 1 1 0    -->  F F F F\r\n-            // 0 0 0 0         F F F F\r\n-            expected.set(til::rect{ til::point{ 1, 0 }, til::size{ 2, 1 } });\r\n-            expected.set(til::rect{ til::point{ 0, 2 }, til::size{ 4, 2 } });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"7.) Move up and right\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // ^\r\n-            // |\r\n-            // ^\r\n-            // | --> -->\r\n-            const til::point delta{ 2, -2 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected: (F is filling uncovered value)\r\n-            // 0 0 0 0 ^       0 1 1 0          F F 0 1\r\n-            // 0 1 1 0 ^       0 0 0 0          F F 0 0\r\n-            // 0 1 1 0    -->  F F F F   -->    F F F F\r\n-            // 0 0 0 0         F F F F          F F F F\r\n-            //                     ->->\r\n-            expected.set(til::point{ 3, 0 });\r\n-            expected.set(til::rect{ til::point{ 0, 2 }, til::size{ 4, 2 } });\r\n-            expected.set(til::rect{ til::point{ 0, 0 }, til::size{ 2, 2 } });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-\r\n-        Log::Comment(L\"8.) Move right\");\r\n-        {\r\n-            auto actual = map;\r\n-            // Move all contents\r\n-            // --> -->\r\n-            const til::point delta{ 2, 0 };\r\n-\r\n-            til::bitmap expected{ mapSize };\r\n-            // Expected:  (F is filling uncovered value)\r\n-            // 0 0 0 0         F F 0 0\r\n-            // 0 1 1 0         F F 0 1\r\n-            // 0 1 1 0    -->  F F 0 1\r\n-            // 0 0 0 0         F F 0 0\r\n-            //     ->->\r\n-            expected.set(til::rect{ til::point{ 3, 1 }, til::size{ 1, 2 } });\r\n-            expected.set(til::rect{ til::point{ 0, 0 }, til::size{ 2, 4 } });\r\n-\r\n-            actual.translate(delta, true);\r\n-\r\n-            VERIFY_ARE_EQUAL(expected, actual);\r\n-        }\r\n-    }\r\n-\r\n-    TEST_METHOD(SetReset)\r\n-    {\r\n-        const til::size sz{ 4, 4 };\r\n-        til::bitmap bitmap{ sz };\r\n-\r\n-        // Every bit should be false.\r\n-        Log::Comment(L\"All bits false on creation.\");\r\n-        VERIFY_IS_TRUE(bitmap._bits.none());\r\n-\r\n-        const til::point point{ 2, 2 };\r\n-        bitmap.set(point);\r\n-\r\n-        std::vector<til::rect> expectedSet;\r\n-        expectedSet.emplace_back(til::rect{ 2, 2, 3, 3 });\r\n-\r\n-        // Run through every bit. Only the one we set should be true.\r\n-        Log::Comment(L\"Only the bit we set should be true.\");\r\n-        _checkBits(expectedSet, bitmap);\r\n-\r\n-        Log::Comment(L\"Setting all should mean they're all true.\");\r\n-        bitmap.set_all();\r\n-\r\n-        expectedSet.clear();\r\n-        expectedSet.emplace_back(til::rect{ bitmap._rc });\r\n-        _checkBits(expectedSet, bitmap);\r\n-\r\n-        Log::Comment(L\"Now reset them all.\");\r\n-        bitmap.reset_all();\r\n-\r\n-        expectedSet.clear();\r\n-        _checkBits(expectedSet, bitmap);\r\n-\r\n-        til::rect totalZone{ sz };\r\n-        Log::Comment(L\"Set a rectangle of bits and test they went on.\");\r\n-        // 0 0 0 0       |1 1|0 0\r\n-        // 0 0 0 0  --\\  |1 1|0 0\r\n-        // 0 0 0 0  --/  |1 1|0 0\r\n-        // 0 0 0 0        0 0 0 0\r\n-        til::rect setZone{ til::point{ 0, 0 }, til::size{ 2, 3 } };\r\n-        bitmap.set(setZone);\r\n-\r\n-        expectedSet.clear();\r\n-        expectedSet.emplace_back(setZone);\r\n-        _checkBits(expectedSet, bitmap);\r\n-\r\n-        Log::Comment(L\"Reset all.\");\r\n-        bitmap.reset_all();\r\n-\r\n-        expectedSet.clear();\r\n-        _checkBits(expectedSet, bitmap);\r\n-    }\r\n-\r\n-    TEST_METHOD(SetResetOutOfBounds)\r\n-    {\r\n-        til::bitmap map{ til::size{ 4, 4 } };\r\n-        Log::Comment(L\"1.) SetPoint out of bounds.\");\r\n-        map.set(til::point{ 10, 10 });\r\n-\r\n-        Log::Comment(L\"2.) SetRectangle out of bounds.\");\r\n-        map.set(til::rect{ til::point{ 2, 2 }, til::size{ 10, 10 } });\r\n-\r\n-        const auto runs = map.runs();\r\n-        VERIFY_ARE_EQUAL(2u, runs.size());\r\n-        VERIFY_ARE_EQUAL(til::rect(2, 2, 4, 3), runs[0]);\r\n-        VERIFY_ARE_EQUAL(til::rect(2, 3, 4, 4), runs[1]);\r\n-    }\r\n-\r\n-    TEST_METHOD(Resize)\r\n-    {\r\n-        Log::Comment(L\"Set up a bitmap with every location flagged.\");\r\n-        const til::size originalSize{ 2, 2 };\r\n-        til::bitmap bitmap{ originalSize, true };\r\n-\r\n-        std::vector<til::rect> expectedFillRects;\r\n-\r\n-        // 1 1\r\n-        // 1 1\r\n-        expectedFillRects.emplace_back(til::rect{ originalSize });\r\n-        _checkBits(expectedFillRects, bitmap);\r\n-\r\n-        Log::Comment(L\"Attempt resize to the same size.\");\r\n-        VERIFY_IS_FALSE(bitmap.resize(originalSize));\r\n-\r\n-        // 1 1\r\n-        // 1 1\r\n-        _checkBits(expectedFillRects, bitmap);\r\n-\r\n-        Log::Comment(L\"Attempt resize to a new size where both dimensions grow and we didn't ask for fill.\");\r\n-        VERIFY_IS_TRUE(bitmap.resize(til::size{ 3, 3 }));\r\n-\r\n-        // 1 1 0\r\n-        // 1 1 0\r\n-        // 0 0 0\r\n-        _checkBits(expectedFillRects, bitmap);\r\n-\r\n-        Log::Comment(L\"Set a bit out in the new space and check it.\");\r\n-        const til::point spaceBit{ 1, 2 };\r\n-        expectedFillRects.emplace_back(til::rect{ 1, 2, 2, 3 });\r\n-        bitmap.set(spaceBit);\r\n-\r\n-        // 1 1 0\r\n-        // 1 1 0\r\n-        // 0 1 0\r\n-        _checkBits(expectedFillRects, bitmap);\r\n-\r\n-        Log::Comment(L\"Grow vertically and shrink horizontally at the same time. Fill any new space.\");\r\n-        expectedFillRects.emplace_back(til::rect{ til::point{ 0, 3 }, til::size{ 2, 1 } });\r\n-        bitmap.resize(til::size{ 2, 4 }, true);\r\n-\r\n-        // 1 1\r\n-        // 1 1\r\n-        // 0 1\r\n-        // 1 1\r\n-        _checkBits(expectedFillRects, bitmap);\r\n-    }\r\n-\r\n-    TEST_METHOD(One)\r\n-    {\r\n-        Log::Comment(L\"When created, it should be not be one.\");\r\n-        til::bitmap bitmap{ til::size{ 2, 2 } };\r\n-        VERIFY_IS_FALSE(bitmap.one());\r\n-\r\n-        Log::Comment(L\"When a single point is set, it should be one.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_TRUE(bitmap.one());\r\n-\r\n-        Log::Comment(L\"Setting the same point again, should still be one.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_TRUE(bitmap.one());\r\n-\r\n-        Log::Comment(L\"Setting another point, it should no longer be one.\");\r\n-        bitmap.set(til::point{ 0, 0 });\r\n-        VERIFY_IS_FALSE(bitmap.one());\r\n-\r\n-        Log::Comment(L\"Clearing it, still not one.\");\r\n-        bitmap.reset_all();\r\n-        VERIFY_IS_FALSE(bitmap.one());\r\n-\r\n-        Log::Comment(L\"Set one point, one again.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_TRUE(bitmap.one());\r\n-\r\n-        Log::Comment(L\"And setting all will no longer be one again.\");\r\n-        bitmap.set_all();\r\n-        VERIFY_IS_FALSE(bitmap.one());\r\n-    }\r\n-\r\n-    TEST_METHOD(Any)\r\n-    {\r\n-        Log::Comment(L\"When created, it should be not be any.\");\r\n-        til::bitmap bitmap{ til::size{ 2, 2 } };\r\n-        VERIFY_IS_FALSE(bitmap.any());\r\n-\r\n-        Log::Comment(L\"When a single point is set, it should be any.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_TRUE(bitmap.any());\r\n-\r\n-        Log::Comment(L\"Setting the same point again, should still be any.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_TRUE(bitmap.any());\r\n-\r\n-        Log::Comment(L\"Setting another point, it should still be any.\");\r\n-        bitmap.set(til::point{ 0, 0 });\r\n-        VERIFY_IS_TRUE(bitmap.any());\r\n-\r\n-        Log::Comment(L\"Clearing it, no longer any.\");\r\n-        bitmap.reset_all();\r\n-        VERIFY_IS_FALSE(bitmap.any());\r\n-\r\n-        Log::Comment(L\"Set one point, one again, it's any.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_TRUE(bitmap.any());\r\n-\r\n-        Log::Comment(L\"And setting all will be any as well.\");\r\n-        bitmap.set_all();\r\n-        VERIFY_IS_TRUE(bitmap.any());\r\n-    }\r\n-\r\n-    TEST_METHOD(None)\r\n-    {\r\n-        Log::Comment(L\"When created, it should be none.\");\r\n-        til::bitmap bitmap{ til::size{ 2, 2 } };\r\n-        VERIFY_IS_TRUE(bitmap.none());\r\n-\r\n-        Log::Comment(L\"When it is modified with a set, it should no longer be none.\");\r\n-        bitmap.set(til::point{ 0, 0 });\r\n-        VERIFY_IS_FALSE(bitmap.none());\r\n-\r\n-        Log::Comment(L\"Resetting all, it will report none again.\");\r\n-        bitmap.reset_all();\r\n-        VERIFY_IS_TRUE(bitmap.none());\r\n-\r\n-        Log::Comment(L\"And setting all will no longer be none again.\");\r\n-        bitmap.set_all();\r\n-        VERIFY_IS_FALSE(bitmap.none());\r\n-    }\r\n-\r\n-    TEST_METHOD(All)\r\n-    {\r\n-        Log::Comment(L\"When created, it should be not be all.\");\r\n-        til::bitmap bitmap{ til::size{ 2, 2 } };\r\n-        VERIFY_IS_FALSE(bitmap.all());\r\n-\r\n-        Log::Comment(L\"When a single point is set, it should not be all.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_FALSE(bitmap.all());\r\n-\r\n-        Log::Comment(L\"Setting the same point again, should still not be all.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_FALSE(bitmap.all());\r\n-\r\n-        Log::Comment(L\"Setting another point, it should still not be all.\");\r\n-        bitmap.set(til::point{ 0, 0 });\r\n-        VERIFY_IS_FALSE(bitmap.all());\r\n-\r\n-        Log::Comment(L\"Clearing it, still not all.\");\r\n-        bitmap.reset_all();\r\n-        VERIFY_IS_FALSE(bitmap.all());\r\n-\r\n-        Log::Comment(L\"Set one point, one again, not all.\");\r\n-        bitmap.set(til::point{ 1, 0 });\r\n-        VERIFY_IS_FALSE(bitmap.all());\r\n-\r\n-        Log::Comment(L\"And setting all will finally be all.\");\r\n-        bitmap.set_all();\r\n-        VERIFY_IS_TRUE(bitmap.all());\r\n-\r\n-        Log::Comment(L\"Clearing it, back to not all.\");\r\n-        bitmap.reset_all();\r\n-        VERIFY_IS_FALSE(bitmap.all());\r\n-    }\r\n-\r\n-    TEST_METHOD(Size)\r\n-    {\r\n-        til::size sz{ 5, 10 };\r\n-        til::bitmap map{ sz };\r\n-\r\n-        VERIFY_ARE_EQUAL(sz, map.size());\r\n-    }\r\n-\r\n-    TEST_METHOD(Runs)\r\n-    {\r\n-        // This map --> Those runs\r\n-        // 1 1 0 1      A A _ B\r\n-        // 1 0 1 1      C _ D D\r\n-        // 0 0 1 0      _ _ E _\r\n-        // 0 1 1 0      _ F F _\r\n-        Log::Comment(L\"Set up a bitmap with some runs.\");\r\n-\r\n-        til::bitmap map{ til::size{ 4, 4 }, false };\r\n-\r\n-        // 0 0 0 0     |1 1|0 0\r\n-        // 0 0 0 0      0 0 0 0\r\n-        // 0 0 0 0 -->  0 0 0 0\r\n-        // 0 0 0 0      0 0 0 0\r\n-        map.set(til::rect{ til::point{ 0, 0 }, til::size{ 2, 1 } });\r\n-\r\n-        // 1 1 0 0     1 1 0 0\r\n-        // 0 0 0 0     0 0|1|0\r\n-        // 0 0 0 0 --> 0 0|1|0\r\n-        // 0 0 0 0     0 0|1|0\r\n-        map.set(til::rect{ til::point{ 2, 1 }, til::size{ 1, 3 } });\r\n-\r\n-        // 1 1 0 0     1 1 0|1|\r\n-        // 0 0 1 0     0 0 1|1|\r\n-        // 0 0 1 0 --> 0 0 1 0\r\n-        // 0 0 1 0     0 0 1 0\r\n-        map.set(til::rect{ til::point{ 3, 0 }, til::size{ 1, 2 } });\r\n-\r\n-        // 1 1 0 1     1 1 0 1\r\n-        // 0 0 1 1    |1|0 1 1\r\n-        // 0 0 1 0 --> 0 0 1 0\r\n-        // 0 0 1 0     0 0 1 0\r\n-        map.set(til::point{ 0, 1 });\r\n-\r\n-        // 1 1 0 1     1 1 0 1\r\n-        // 1 0 1 1     1 0 1 1\r\n-        // 0 0 1 0 --> 0 0 1 0\r\n-        // 0 0 1 0     0|1|1 0\r\n-        map.set(til::point{ 1, 3 });\r\n-\r\n-        Log::Comment(L\"Building the expected run rectangles.\");\r\n-\r\n-        // Reminder, we're making 6 rectangle runs A-F like this:\r\n-        // A A _ B\r\n-        // C _ D D\r\n-        // _ _ E _\r\n-        // _ F F _\r\n-        std::vector<til::rect> expected;\r\n-        expected.push_back(til::rect{ til::point{ 0, 0 }, til::size{ 2, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 3, 0 }, til::size{ 1, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 1 }, til::size{ 1, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 2, 1 }, til::size{ 2, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 2, 2 }, til::size{ 1, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 1, 3 }, til::size{ 2, 1 } });\r\n-\r\n-        Log::Comment(L\"Run the iterator and collect the runs.\");\r\n-        std::vector<til::rect> actual;\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-\r\n-        Log::Comment(L\"Verify they match what we expected.\");\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Clear the map and iterate and make sure we get no results.\");\r\n-        map.reset_all();\r\n-\r\n-        expected.clear();\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-\r\n-        Log::Comment(L\"Verify they're empty.\");\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Set point and validate runs updated.\");\r\n-        const til::point setPoint{ 2, 2 };\r\n-        expected.push_back(til::rect{ 2, 2, 3, 3 });\r\n-        map.set(setPoint);\r\n-\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Set rectangle and validate runs updated.\");\r\n-        const til::rect setRect{ setPoint, til::size{ 2, 2 } };\r\n-        expected.clear();\r\n-        expected.push_back(til::rect{ til::point{ 2, 2 }, til::size{ 2, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 2, 3 }, til::size{ 2, 1 } });\r\n-        map.set(setRect);\r\n-\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Set all and validate runs updated.\");\r\n-        expected.clear();\r\n-        expected.push_back(til::rect{ til::point{ 0, 0 }, til::size{ 4, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 1 }, til::size{ 4, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 2 }, til::size{ 4, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 3 }, til::size{ 4, 1 } });\r\n-        map.set_all();\r\n-\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Resize and validate runs updated.\");\r\n-        const til::size newSize{ 3, 3 };\r\n-        expected.clear();\r\n-        expected.push_back(til::rect{ til::point{ 0, 0 }, til::size{ 3, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 1 }, til::size{ 3, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 2 }, til::size{ 3, 1 } });\r\n-        map.resize(newSize);\r\n-\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-    }\r\n-\r\n-    TEST_METHOD(RunsWithPmr)\r\n-    {\r\n-        // This is a copy of the above test, but with a pmr::bitmap.\r\n-        std::pmr::unsynchronized_pool_resource pool{ til::pmr::get_default_resource() };\r\n-\r\n-        // This map --> Those runs\r\n-        // 1 1 0 1      A A _ B\r\n-        // 1 0 1 1      C _ D D\r\n-        // 0 0 1 0      _ _ E _\r\n-        // 0 1 1 0      _ F F _\r\n-        Log::Comment(L\"Set up a PMR bitmap with some runs.\");\r\n-\r\n-        til::pmr::bitmap map{ til::size{ 4, 4 }, false, &pool };\r\n-\r\n-        // 0 0 0 0     |1 1|0 0\r\n-        // 0 0 0 0      0 0 0 0\r\n-        // 0 0 0 0 -->  0 0 0 0\r\n-        // 0 0 0 0      0 0 0 0\r\n-        map.set(til::rect{ til::point{ 0, 0 }, til::size{ 2, 1 } });\r\n-\r\n-        // 1 1 0 0     1 1 0 0\r\n-        // 0 0 0 0     0 0|1|0\r\n-        // 0 0 0 0 --> 0 0|1|0\r\n-        // 0 0 0 0     0 0|1|0\r\n-        map.set(til::rect{ til::point{ 2, 1 }, til::size{ 1, 3 } });\r\n-\r\n-        // 1 1 0 0     1 1 0|1|\r\n-        // 0 0 1 0     0 0 1|1|\r\n-        // 0 0 1 0 --> 0 0 1 0\r\n-        // 0 0 1 0     0 0 1 0\r\n-        map.set(til::rect{ til::point{ 3, 0 }, til::size{ 1, 2 } });\r\n-\r\n-        // 1 1 0 1     1 1 0 1\r\n-        // 0 0 1 1    |1|0 1 1\r\n-        // 0 0 1 0 --> 0 0 1 0\r\n-        // 0 0 1 0     0 0 1 0\r\n-        map.set(til::point{ 0, 1 });\r\n-\r\n-        // 1 1 0 1     1 1 0 1\r\n-        // 1 0 1 1     1 0 1 1\r\n-        // 0 0 1 0 --> 0 0 1 0\r\n-        // 0 0 1 0     0|1|1 0\r\n-        map.set(til::point{ 1, 3 });\r\n-\r\n-        Log::Comment(L\"Building the expected run rectangles.\");\r\n-\r\n-        // Reminder, we're making 6 rectangle runs A-F like this:\r\n-        // A A _ B\r\n-        // C _ D D\r\n-        // _ _ E _\r\n-        // _ F F _\r\n-        std::vector<til::rect> expected;\r\n-        expected.push_back(til::rect{ til::point{ 0, 0 }, til::size{ 2, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 3, 0 }, til::size{ 1, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 1 }, til::size{ 1, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 2, 1 }, til::size{ 2, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 2, 2 }, til::size{ 1, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 1, 3 }, til::size{ 2, 1 } });\r\n-\r\n-        Log::Comment(L\"Run the iterator and collect the runs.\");\r\n-        std::vector<til::rect> actual;\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-\r\n-        Log::Comment(L\"Verify they match what we expected.\");\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Clear the map and iterate and make sure we get no results.\");\r\n-        map.reset_all();\r\n-\r\n-        expected.clear();\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-\r\n-        Log::Comment(L\"Verify they're empty.\");\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Set point and validate runs updated.\");\r\n-        const til::point setPoint{ 2, 2 };\r\n-        expected.push_back(til::rect{ 2, 2, 3, 3 });\r\n-        map.set(setPoint);\r\n-\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Set rectangle and validate runs updated.\");\r\n-        const til::rect setRect{ setPoint, til::size{ 2, 2 } };\r\n-        expected.clear();\r\n-        expected.push_back(til::rect{ til::point{ 2, 2 }, til::size{ 2, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 2, 3 }, til::size{ 2, 1 } });\r\n-        map.set(setRect);\r\n-\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Set all and validate runs updated.\");\r\n-        expected.clear();\r\n-        expected.push_back(til::rect{ til::point{ 0, 0 }, til::size{ 4, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 1 }, til::size{ 4, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 2 }, til::size{ 4, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 3 }, til::size{ 4, 1 } });\r\n-        map.set_all();\r\n-\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-\r\n-        Log::Comment(L\"Resize and validate runs updated.\");\r\n-        const til::size newSize{ 3, 3 };\r\n-        expected.clear();\r\n-        expected.push_back(til::rect{ til::point{ 0, 0 }, til::size{ 3, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 1 }, til::size{ 3, 1 } });\r\n-        expected.push_back(til::rect{ til::point{ 0, 2 }, til::size{ 3, 1 } });\r\n-        map.resize(newSize);\r\n-\r\n-        actual.clear();\r\n-        for (auto run : map.runs())\r\n-        {\r\n-            actual.push_back(run);\r\n-        }\r\n-        VERIFY_ARE_EQUAL(expected, actual);\r\n-    }\r\n-};\r\ndiff --git a/src/til/ut_til/sources b/src/til/ut_til/sources\nindex 2e39e378a84..ec02bb53cb0 100644\n--- a/src/til/ut_til/sources\n+++ b/src/til/ut_til/sources\n@@ -15,7 +15,6 @@ DLLDEF                  =\n SOURCES = \\\r\n     $(SOURCES) \\\r\n     BaseTests.cpp \\\r\n-    BitmapTests.cpp \\\r\n     CoalesceTests.cpp \\\r\n     ColorTests.cpp \\\r\n     EnumSetTests.cpp \\\r\ndiff --git a/src/winconpty/winconpty.cpp b/src/winconpty/winconpty.cpp\nindex e3a915447a6..441d4d2639f 100644\n--- a/src/winconpty/winconpty.cpp\n+++ b/src/winconpty/winconpty.cpp\n@@ -136,7 +136,6 @@ HRESULT _CreatePseudoConsole(const HANDLE hToken,\n     // This is plenty of space to hold the formatted string\r\n     wchar_t cmd[MAX_PATH]{};\r\n     const BOOL bInheritCursor = (dwFlags & PSEUDOCONSOLE_INHERIT_CURSOR) == PSEUDOCONSOLE_INHERIT_CURSOR;\r\n-    const BOOL bResizeQuirk = (dwFlags & PSEUDOCONSOLE_RESIZE_QUIRK) == PSEUDOCONSOLE_RESIZE_QUIRK;\r\n \r\n     const wchar_t* textMeasurement;\r\n     switch (dwFlags & PSEUDOCONSOLE_GLYPH_WIDTH__MASK)\r\n@@ -157,10 +156,9 @@ HRESULT _CreatePseudoConsole(const HANDLE hToken,\n \r\n     swprintf_s(cmd,\r\n                MAX_PATH,\r\n-               L\"\\\"%s\\\" --headless %s%s%s--width %hd --height %hd --signal 0x%tx --server 0x%tx\",\r\n+               L\"\\\"%s\\\" --headless %s%s--width %hd --height %hd --signal 0x%tx --server 0x%tx\",\r\n                _ConsoleHostPath(),\r\n                bInheritCursor ? L\"--inheritcursor \" : L\"\",\r\n-               bResizeQuirk ? L\"--resizeQuirk \" : L\"\",\r\n                textMeasurement,\r\n                size.X,\r\n                size.Y,\r\ndiff --git a/src/winconpty/winconpty.h b/src/winconpty/winconpty.h\nindex bd1a6cd1909..11503a2494b 100644\n--- a/src/winconpty/winconpty.h\n+++ b/src/winconpty/winconpty.h\n@@ -52,9 +52,6 @@ typedef struct _PseudoConsole\n #ifndef PSEUDOCONSOLE_INHERIT_CURSOR\r\n #define PSEUDOCONSOLE_INHERIT_CURSOR (0x1)\r\n #endif\r\n-#ifndef PSEUDOCONSOLE_RESIZE_QUIRK\r\n-#define PSEUDOCONSOLE_RESIZE_QUIRK (0x2)\r\n-#endif\r\n #ifndef PSEUDOCONSOLE_GLYPH_WIDTH__MASK\r\n #define PSEUDOCONSOLE_GLYPH_WIDTH__MASK 0x18\r\n #define PSEUDOCONSOLE_GLYPH_WIDTH_GRAPHEMES 0x08\r\n", "test_patch": "diff --git a/src/renderer/vt/ut_lib/vt.unittest.vcxproj b/src/renderer/vt/ut_lib/vt.unittest.vcxproj\ndeleted file mode 100644\nindex e2aea923840..00000000000\n--- a/src/renderer/vt/ut_lib/vt.unittest.vcxproj\n+++ /dev/null\n@@ -1,19 +0,0 @@\n-<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n-<Project DefaultTargets=\"Build\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">\r\n-  <PropertyGroup>\r\n-    <ProjectGuid>{990F2657-8580-4828-943F-5DD657D11843}</ProjectGuid>\r\n-    <Keyword>Win32Proj</Keyword>\r\n-    <RootNamespace>vt.unittest</RootNamespace>\r\n-    <ProjectName>RendererVt.unittest</ProjectName>\r\n-    <TargetName>ConRenderVt.unittest</TargetName>\r\n-    <ConfigurationType>StaticLibrary</ConfigurationType>\r\n-  </PropertyGroup>\r\n-  <Import Project=\"$(SolutionDir)src\\common.build.pre.props\" />\r\n-  <Import Project=\"$(SolutionDir)src\\common.nugetversions.props\" />\r\n-  <Import Project=\"$(SolutionDir)src\\renderer\\vt\\vt-renderer-common.vcxitems\" />\r\n-  <!-- DONT ADD NEW FILES HERE, ADD THEM TO vt-renderer-common.vcxitems -->\r\n-  <!-- Careful reordering these. Some default props (contained in these files) are order sensitive. -->\r\n-  <Import Project=\"$(SolutionDir)src\\common.build.post.props\" />\r\n-  <Import Project=\"$(SolutionDir)src\\common.build.tests.props\" />\r\n-  <Import Project=\"$(SolutionDir)src\\common.nugetversions.targets\" />\r\n-</Project>\r\ndiff --git a/src/til/ut_til/til.unit.tests.vcxproj b/src/til/ut_til/til.unit.tests.vcxproj\nindex c4c2b87eefe..8219d1d98e7 100644\n--- a/src/til/ut_til/til.unit.tests.vcxproj\n+++ b/src/til/ut_til/til.unit.tests.vcxproj\n@@ -15,7 +15,6 @@\n       <PrecompiledHeader>Create</PrecompiledHeader>\r\n     </ClCompile>\r\n     <ClCompile Include=\"BaseTests.cpp\" />\r\n-    <ClCompile Include=\"BitmapTests.cpp\" />\r\n     <ClCompile Include=\"CoalesceTests.cpp\" />\r\n     <ClCompile Include=\"ColorTests.cpp\" />\r\n     <ClCompile Include=\"EnumSetTests.cpp\" />\r\n@@ -43,7 +42,6 @@\n     <ClInclude Include=\"..\\..\\inc\\til\\at.h\" />\r\n     <ClInclude Include=\"..\\..\\inc\\til\\atomic.h\" />\r\n     <ClInclude Include=\"..\\..\\inc\\til\\bit.h\" />\r\n-    <ClInclude Include=\"..\\..\\inc\\til\\bitmap.h\" />\r\n     <ClInclude Include=\"..\\..\\inc\\til\\bytes.h\" />\r\n     <ClInclude Include=\"..\\..\\inc\\til\\coalesce.h\" />\r\n     <ClInclude Include=\"..\\..\\inc\\til\\color.h\" />\r\ndiff --git a/src/til/ut_til/til.unit.tests.vcxproj.filters b/src/til/ut_til/til.unit.tests.vcxproj.filters\nindex 15928ddb533..b85b195c077 100644\n--- a/src/til/ut_til/til.unit.tests.vcxproj.filters\n+++ b/src/til/ut_til/til.unit.tests.vcxproj.filters\n@@ -6,7 +6,6 @@\n   <ItemGroup>\r\n     <ClCompile Include=\"..\\precomp.cpp\" />\r\n     <ClCompile Include=\"BaseTests.cpp\" />\r\n-    <ClCompile Include=\"BitmapTests.cpp\" />\r\n     <ClCompile Include=\"CoalesceTests.cpp\" />\r\n     <ClCompile Include=\"ColorTests.cpp\" />\r\n     <ClCompile Include=\"EnumSetTests.cpp\" />\r\n@@ -41,9 +40,6 @@\n     <ClInclude Include=\"..\\..\\inc\\til\\bit.h\">\r\n       <Filter>inc</Filter>\r\n     </ClInclude>\r\n-    <ClInclude Include=\"..\\..\\inc\\til\\bitmap.h\">\r\n-      <Filter>inc</Filter>\r\n-    </ClInclude>\r\n     <ClInclude Include=\"..\\..\\inc\\til\\coalesce.h\">\r\n       <Filter>inc</Filter>\r\n     </ClInclude>\r\n", "problem_statement": "ConPTY does not pass Device Control Strings (DCS) to 3rd-party terminals\n### Windows Terminal version\r\n\r\n1.19.11213.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.0\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nWe're thrilled by the release and development of ConPTY. We're hoping it can support our usage of Device Control Strings.\r\n\r\nFrom any 3rd-party terminal that wishes to \"speak ANSI\" using ConPTY, run any command that outputs a DCS escape sequence. (I'm using a locally built alacritty)\r\n\r\n```\r\nPowerShell 7.4.2\r\necho \"`eP <some data for terminal> `e\\\"\r\n```\r\n\r\nAlacritty does not receive the DCS.\r\n\r\n### Expected Behavior\r\n\r\nI expect DCS escape sequences to be output by ConPTY so that 3rd-party terminals may use this to implement more advanced features.\r\n\r\n### Context\r\n\r\nI work for Warp and we'd like to bring Warp Terminal to Windows. Warp depends heavily on DCS strings for its key features.\r\n\r\n### Alternatives Considered\r\n\r\nWe tried utilizing a custom OSC sequence instead. We notice that unhandled OSC gets [flushed to the terminal](https://github.com/microsoft/terminal/blob/e826203bb7e200f6f7029b6d8be68fb330c18735/src/terminal/parser/OutputStateMachineEngine.cpp#L924-L927). Although with this method Warp is able to receive these data as we'd like, the ordering is not preserved, i.e. if the shell outputs an OSC interleaved with text, when it is read out of ConPTY by the terminal, the OSC is not received in the same order in which it was produced. Warp does depend on that ordering, which is an invariant on UNIX PTYs.\r\n\r\nIt would be nice if DCS had similar logic where `_pfnFlushToTerminal` was called like it is for OSC, but where ordering is preserved.\r\n\r\n### Actual Behavior\r\n\r\nOnly DCS escape sequences that Windows Terminal recognizes are being dispatched. As we understand it, ConPTY is an interface intended to be used by 3rd-party terminals for optimal compatibility. Therefore, it makes sense to expand support for arbitrary DCS sequences that other terminals might depend on.\n", "hints_text": "Hi I'm an AI powered bot that finds similar issues based off the issue title.\n\nPlease view the issues below to see if they solve your problem, and if the issue describes your problem please consider closing this one and thumbs upping the other issue to help us prioritize it. Thank you!\n\n\n### Closed similar issues:\n- [ConPTY modifies escape sequences passed to process input (#12166)](https://github.com/microsoft/terminal/issues/12166),  similarity score: 0.76\n- [ConPTY not emitting OSC sequences longer than 256 characters (Windows 10) (#15551)](https://github.com/microsoft/terminal/issues/15551),  similarity score: 0.75\n\n> Note: You can give me feedback by thumbs upping or thumbs downing this comment.\nDid you use the system ConPTY API? Due to the lengthy release cycle of Windows that API is usually quite outdated. We're currently experimenting with shipping ConPTY as a nupkg. You can find a build here: https://terminalbuilds.blob.core.windows.net/builds/Microsoft.Windows.Console.ConPTY.1.19.240130002.nupkg\r\nThat's the same build that WezTerm uses. There was a discussion about it here: https://mas.to/@DHowett/111909543700190300\r\nThe .nupkg contains a prebuilt conpty.dll (= ConPTY client) as well as a v1.19 build of OpenConsole.exe (= ConPTY server).\r\n\r\nTo be fair, I haven't tried your repro, so my suggestion may be pointless. \ud83d\ude48 However, even if that nupkg doesn't fix the issue, you'd still need to use a bundled OpenConsole.exe version to receive an updated version later on.\r\n\r\nBut the good news is that I'm currently working on replacing the complex ConPTY setup we have. Afterwards it'll pass VT text from your shell, etc., 1:1 directly to the terminal. The bad news is that I am _currently_ working on it. If the above .nupkg doesn't work, and I'm not sure if you can share your timeline of shipping Warp on Windows publicly, but if it's still a while out, you could consider waiting for me to finish my work on that.\nHi @lhecker thanks for taking the time to respond! I'm another engineer at Warp, working with @acarl005.\r\n\r\n> Did you use the system ConPTY API?\r\n\r\nWe followed the instructions outlined in the Mastodon thread you linked but unfortunately using the newer ConPTY build does not solve the issue. Specifically, I still see that DCS strings are not getting sent from ConPTY and that the custom OSCs we use as an alternative are sent out of order.\r\n\r\n\r\n> However, even if that nupkg doesn't fix the issue, you'd still need to use a bundled OpenConsole.exe version to receive an updated version later on.\r\n\r\n\r\nNoted! We'll ship with these newer bundles instead of relying on the system API.\r\n\r\n\r\n> Afterwards it'll pass VT text from your shell, etc., 1:1 directly to the terminal.\r\n\r\n\r\nThis is exactly what we need, looking forward to this releasing! \ud83e\udd73 Many of the features we use would depend on this particular part of the PTY since we rely on it to implement many of our key features, like [blocks](https://docs.warp.dev/features/blocks). We can't meaningfully test most of the core functionality of Warp without this. Do you have a rough timeline (weeks/months/quarters) of when this might get shipped? Our intention is not to rush you but just to plan around it!\n> Do you have a rough timeline (weeks/months/quarters) of when this might get shipped?\r\n\r\nI think a month is a fair estimate for this. I don't think it'll take multiple months.\r\nI'm currently working on a prototype, as well as the design spec based on that. After the design has been approved, I'll have to finish implementing the more complex parts of ConPTY within the new architecture. But if my proposal is rejected, I'll happily implement a workaround for you anyway. \ud83d\ude42\n@lhecker Awesome! We're happy to hear someone is working on this. May I ask about order preservation in your planned implementation? As for Warp's requirements, we use DCS for things like delimiting our \"blocks\" and so ordering is an important for our case, e.g. if a process emits something like...\r\n\r\n```shell\r\necho \"some output `eP <some data for terminal> `e\\ some other output\"\r\n```\r\n\r\n...then we depend on `some output ESCP <some data for terminal> ESC\\ some other output` to come out of the PTY.\n@lhecker We'd also love to try out the prototype you are building, if you can easily share it! We can try it from a remote branch, a specific build, or anything else that's convenient.\n> May I ask about order preservation in your planned implementation?\r\n\r\nIf you have `ENABLE_VIRTUAL_TERMINAL_PROCESSING` enabled (I'm sure you do \ud83d\ude04), then the text will not be touched by ConPTY at all anymore. Warp will receive the VT output entirely unmodified. (It'll go through UTF-16 <> UTF-8 conversion, because our VT parser uses UTF-16, but I'm sure that's beside the point.)\r\n\r\n> We'd also love to try out the prototype you are building, if you can easily share it! We can try it from a remote branch, a specific build, or anything else that's convenient.\r\n\r\nI'm not at a point yet where you could rely on it, but my WIP branch is here: https://github.com/microsoft/terminal/tree/dev/lhecker/goodbye-vtengine\r\nIf you'd like to try it and need help building OpenConsole and conpty.dll, let me know.\r\n\r\nThe design spec is here: https://github.com/microsoft/terminal/blob/dev/lhecker/goodbye-vtengine/doc/specs/%2313000%20-%20In-process%20ConPTY.md\r\nThis issue and your problem will be solved after Step 1 in that design doc already, so you can ignore the rest if you'd like. (Although you're likely to benefit from the remaining 3 steps, since it would significantly improve your performance.) I do have to say again though that everything within the doc still needs to go through review, nothing is final, and the entire thing or parts of it may be scrapped if we find that it's impossible to achieve.\n@lhecker It sounds like this is essentially \"passthrough mode\", is that correct?\r\n\r\nPlease let us know if Warp engineers can help with this migration in any way. We would likely be able to commit at least one engineer to this effort to help get it launched. \n@alokedesai Not in the original sense.\r\n\r\n(Some more context for those who may not be super familiar with ConPTY's architecture:) ConPTY parses any VT output of any application and stores the results in a local buffer, so that later calls to the `ReadConsole*` family of functions can read that output back. This is for instance used by Far Manager to backup and restore the viewport contents.\r\n`VtRenderer` is currently used to \"render\" those buffer contents back to VT output. This is why the order of operations is lost: VT output gets parsed, thrown away, and then regenerated.\r\n\r\nPassthrough mode used to be the idea that we could stop parsing the VT output of any application that promises to only ever use VT and not call anything except for `Read/WriteFile` or `Read/WriteConsole` (= primitive text only). We would thus not need to transform any complex Console API calls and be able to pass the VT output directly through to the terminal. This would preserve the order of operations and increase performance, because output would not need to be parsed nor \"rendered\".\r\n\r\nMy upcoming proposal on the other hand is to always parse the output, despite the cost. I've improved the performance of our text buffer by >10x over the last 3 years so it's not as much of an issue anymore. My above branch for instance gets ~100MB/s with `cat` despite the double-parsing, which is not great, but also not terrible. This will allow us to always serve the `ReadConsole*` calls.\r\nNext, my idea is to transform complex console API calls like `WriteConsoleOutputCharacter` into a series of VT sequences directly (purely algorithmically right within the console API implementation).\r\nLastly, to help terminals not be bottlenecked by the double-parsing, I'm proposing a nano-COM API for ConPTY where it runs within your process, you give it access to your buffer, and it will provide you with a genuine 0-overhead console server in exchange. Windows Terminal would use such an in-process ConPTY without double-buffering, while something like `sshd` would continue to use a ConPTY that keeps a buffer (since `sshd` runs remotely).\n> (Some more context for those who may not be super familiar with ConPTY's architecture:) ConPTY parses any VT output of any application and stores the results in a local buffer, so that later calls to the ReadConsole* family of functions can read that output back. This is for instance used by Far Manager to backup and restore the viewport contents.\r\n> VtRenderer is currently used to \"render\" those buffer contents back to VT output. This is why the order of operations is lost: VT output gets parsed, thrown away, and then regenerated.\r\n> \r\n> Passthrough mode used to be the idea that we could stop parsing the VT output of any application that promises to only ever use VT and not call anything except for Read/WriteFile or Read/WriteConsole (= primitive text only). We would thus not need to transform any complex Console API calls and be able to pass the VT output directly through to the terminal. This would preserve the order of operations and increase performance, because output would not need to be parsed nor \"rendered\".\r\n> \r\n> \r\n\r\nGotcha, that makes sense. Agreed that an approach that still supports the traditional Console APIs is strictly better\r\n\r\n> My upcoming proposal on the other hand is to always parse the output, despite the cost. I've improved the performance of our text buffer by >10x over the last 3 years so it's not as much of an issue anymore. My above branch for instance gets ~100MB/s with cat despite the double-parsing, which is not great, but also not terrible. This will allow us to always serve the ReadConsole* calls.\r\n> Next, my idea is to transform complex console API calls like WriteConsoleOutputCharacter into a series of VT sequences directly (purely algorithmically right within the console API implementation).\r\n\r\nI see. So TLDR; whereas previously the `VTEngine` would asynchronously output escape sequences based on what changed in the output buffer we'll now synchronously parse the output, update the output buffer, and then forward all of the escape sequences to the backing terminal. Is that correct?\n@lhecker Really excited to see this happen, if Warp engineers can help out with this in anyway please let us know.\r\n\r\nThis seems like a massive rearchitecture of ConPTY and we would be able to contribute headcount if it would accelerate the process of launching this. \n> Is that correct?\r\n\r\nAs a tl;dr, absolutely!\r\n\r\n> This seems like a massive rearchitecture of ConPTY and we would be able to contribute headcount if it would accelerate the process of launching this.\r\n\r\nThanks! I'll definitely keep this in mind. \ud83d\ude42 For now, however, it needs to be approved by the team and probably also run by our division architects, because all 4 steps in the spec together are a _huge_ change that will likely take >1 year to complete.\r\n\r\nIf you're massively blocked by this issue, and if you have dev time to spare, you could consider hotfixing this issue yourself. I believe what you need is something like this:\r\nhttps://github.com/microsoft/terminal/blob/baba406a074e792dd4486f4239ac4b3292f95a60/src/terminal/adapter/adaptDispatch.cpp#L3762-L3767\r\n\r\nIf that's correct, then you then need to call out to `_dispatch` here:\r\nhttps://github.com/microsoft/terminal/blob/baba406a074e792dd4486f4239ac4b3292f95a60/src/terminal/parser/OutputStateMachineEngine.cpp#L717-L756\r\n\r\nand do the same `TriggerFlush`. I suspect that this will fix the issue.\nGreat thank you, we'll try that out! Will that suggested hotfix also solve the ordering problem? (My assumption is no but just confirming).\r\n\r\nAnd to clarify, is sending DCS to the terminal + fixing the ordering problems still something you expect to take 1 month? I assume productionizing the server and shipping it in windows are what would cause this to take 1 year+?\r\n\r\n\nJust FYI, I made a conscious decision _not_ to pass through unrecognised `DCS` sequences, precisely because they typically won't work, in the same way that unrecognised `OSC` sequences don't work. All we'll be doing is introducing another set of bug reports for third party terminals, who'll now think they have support for `DCS` sequences, but which will inevitably fail in unpredictable ways.\r\n\r\nIf you follow other terminal bug trackers, you can see the kind of problems this causes. And app devs are affected by the issue as well, because instead of a particular sequence simply not being supported on Windows, it _appears_ to work, but has subtle bugs. And they waste a whole lot of time trying to understand and work around those bugs, when it's really not something they can fix.\r\n\r\nSo if you want `DCS` support, and want it to actually work, I'd suggest you try and get `OSC` sequences to work reliably first (assuming you think that's feasible). Otherwise I think we'll just be making things worse for everyone by introduced broken `DCS` sequences into the mix.\r\n\r\nAnother option to consider would be adding a pass-through wrapper sequence like some multiplexers support (e.g. see the [tmux FAQ](https://github.com/tmux/tmux/wiki/FAQ#what-is-the-passthrough-escape-sequence-and-how-do-i-use-it)). After all, the current implementation of conpty is essentially a kind of multiplexer.\r\n\r\nBut really I think the best bet is to wait for lhecker's new architecture. If it turns out that isn't going to work, we can always revisit other options later.\n@lhecker What's the simplest way to build your prototype from [dev/lhecker/goodbye-vtengine](https://github.com/microsoft/terminal/tree/dev/lhecker/goodbye-vtengine)? I'm assuming that all I need is to successfully build `contpy.dll` and `OpenConsole.exe`.\r\n\r\nWhen I run the PowerShell function `Invoke-OpenConsoleBuild` from Windows Terminal I get a lot of errors, many of them related to tests. I assume that this is because it's trying to build every project that is present. (I imagine I don't need to refactor the test cases to get it to work).\r\n\r\nI am able to successfully get the `conpty.dll` file built by using Visual Studio and only checking some of the Projects that are have conpty in the name. How can I get `OpenConsole.exe` as well? What is the minimum set of projects I need to include to get what I need? I tried checking off all non-test related projects but I get the following errors:\r\n\r\n![image](https://github.com/microsoft/terminal/assets/40919306/95f09eec-6cf6-4c39-b461-178d7ef5fc0e)\r\n\r\nHappy to fix some of the smaller errors like type conversions or an incorrect number of arguments, but I figured I should check on what projects I actually need.\r\n\r\nHere's the Visual Studio `Build > Manage Configuration` modal I'm modifying:\r\n![image](https://github.com/microsoft/terminal/assets/40919306/a83cf738-e026-4c49-865c-80a8d515e7fe)\r\n\r\n\r\n\r\n\n@j4james By \"getting `OSCs` to work reliably\" do you mean ensuring they are sent to the terminal in an ordered way? \r\n\r\nIf so, very much agreed. We tried `OSC`s when we realized `DCS`s were swallowed by ConPTY and it didn't work because of the ordering issues. Regardless of which sequence we use, the biggest requirement we have is that we must be able to communicate from shell --> terminal in a synchronous way. \n> What's the simplest way to build your prototype from dev/lhecker/goodbye-vtengine?\r\n\r\nIt's a different branch but I did a quick screen recording for how I do it:\r\n\r\nhttps://github.com/microsoft/terminal/assets/2256941/6d204afe-fbaf-493c-8d28-b70bc0802f88\r\n\r\n> I tried checking off all non-test related projects but I get the following errors:\r\n\r\nWhen it comes to OpenConsole and conpty.dll: I just pushed a commit that fixes the build error. Instead of `return !inPtyMode;` it should've just said `return true;`.\n> By \"getting OSCs to work reliably\" do you mean ensuring they are sent to the terminal in an ordered way?\r\n\r\n@alokedesai That's one issue. Another problem is that the position of the cursor when you receive the sequence won't necessarily be the position of the cursor when it was sent, so you can't depend on that. And if you change the cursor position yourself in response to a passed-through sequence, that has the potential to misposition any subsequent output. Or if you produce any output yourself in response to a passed-through sequence, that will potentially be overwritten by the conpty renderer at a later stage.\r\n\r\nIn short, there are very few scenarios that can reliably work with a passed-through sequence if conhost isn't specifically designed to handle that sequence. As a rule of thumb, if you can't make it work in tmux, it's unlikely to work through conpty.\n@j4james @lhecker Thanks for the additional info.\r\n\r\nWarp blocks work by sending a custom DCS from shell --> terminal when a command starts and finishes executing (see a blog post about this [here](https://www.warp.dev/blog/how-warp-works)). \r\n\r\nWhenever a command finishes, we create a _new_ grid so that contents from each command are fully isolated from each other.\r\n\r\nGiven that background, I don't think a fork of ConPTY that adds support for a custom OSC (or DCS) would fix the issues we're seeing. This is because ConPTY would have to actually update its own internal data model to reflect the fact that Warp is going to create a new grid, which I think is impossible to do perfectly (but I may be overestimating the complexity of this).\r\n\r\nAssuming my understanding is correct (I'd love confirmation of that / whether there's an obvious solution I'm missing) I believe we _have_ to wait for changes outlined in step 1 of that design doc to land. Is ~1 month still accurate? \r\n\r\nHappy to Zoom about this if easier, I believe we chatted with some of your coworkers in the past (@DHowett and Carlos Zamora). \n> And if you change the cursor position yourself in response to a passed-through sequence, that has the potential to misposition any subsequent output\r\n\r\nYeah, by starting a new \"block\" we're basically starting a new grid, which sets the cursor position back to (0, 0). This puts us  out of sync with the console output buffer unfortunately. \nHi @lhecker, following up here one more time. I noticed that the original [design spec](https://github.com/microsoft/terminal/blob/dev/lhecker/goodbye-vtengine/doc/specs/%2313000%20-%20In-process%20ConPTY.md) you posted no longer exists. \r\n\r\nIs this something you're still working on? \n(Replied via e-mail!)\n(for everyone not on the mail thread (me too), the spec is in #17387)\nYep, exactly, the spec moved over to a PR now, while I continue to implement the new ConPTY. I'm currently working on a new \"cooked read\" implementation (= Windows' readline-like implementation for `scanf` and friends). The last remaining API I need to implement is `SetConsoleActiveScreenBuffer`, and afterwards I need to fix any remaining bugs. The good news is, we're definitely on track. But it's also not an easy change, so I'll unfortunately be largely unreachable for a while longer while I focus on completing this work.", "created_at": "2024-07-03 01:37:19", "merge_commit_sha": "450eec48de252a3a8d270bade847755ecbeb5a75", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17333", "base_commit": "13de7c668577ae270ce9528d6a895fd169ece7cc", "patch": "diff --git a/src/cascadia/TerminalApp/Pane.cpp b/src/cascadia/TerminalApp/Pane.cpp\nindex fd195d8d42a..899e67e14ec 100644\n--- a/src/cascadia/TerminalApp/Pane.cpp\n+++ b/src/cascadia/TerminalApp/Pane.cpp\n@@ -467,7 +467,7 @@ std::shared_ptr<Pane> Pane::NextPane(const std::shared_ptr<Pane> targetPane)\n     std::shared_ptr<Pane> nextPane = nullptr;\r\n     auto foundTarget = false;\r\n \r\n-    auto foundNext = WalkTree([&](auto pane) {\r\n+    auto foundNext = WalkTree([&](const auto& pane) {\r\n         // If we are a parent pane we don't want to move to one of our children\r\n         if (foundTarget && targetPane->_HasChild(pane))\r\n         {\r\n@@ -985,6 +985,17 @@ void Pane::_ContentLostFocusHandler(const winrt::Windows::Foundation::IInspectab\n // - <none>\r\n void Pane::Close()\r\n {\r\n+    // Pane has two events, CloseRequested and Closed. CloseRequested is raised by the content asking to be closed,\r\n+    // but also by the window who owns the tab when it's closing. The event is then caught by the TerminalTab which\r\n+    // calls Close() which then raises the Closed event. Now, if this is the last pane in the window, this will result\r\n+    // in the window raising CloseRequested again which leads to infinite recursion, so we need to guard against that.\r\n+    // Ideally we would have just a single event in the future.\r\n+    if (_closed)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    _closed = true;\r\n     // Fire our Closed event to tell our parent that we should be removed.\r\n     Closed.raise(nullptr, nullptr);\r\n }\r\n@@ -1341,7 +1352,7 @@ std::shared_ptr<Pane> Pane::DetachPane(std::shared_ptr<Pane> pane)\n         detached->_ApplySplitDefinitions();\r\n \r\n         // Trigger the detached event on each child\r\n-        detached->WalkTree([](auto pane) {\r\n+        detached->WalkTree([](const auto& pane) {\r\n             pane->Detached.raise(pane);\r\n         });\r\n \r\n@@ -1542,7 +1553,7 @@ void Pane::_CloseChild(const bool closeFirst)\n         {\r\n             // update our path to our first remaining leaf\r\n             _parentChildPath = _firstChild;\r\n-            _firstChild->WalkTree([](auto p) {\r\n+            _firstChild->WalkTree([](const auto& p) {\r\n                 if (p->_IsLeaf())\r\n                 {\r\n                     return true;\r\n@@ -2398,7 +2409,7 @@ void Pane::Id(uint32_t id) noexcept\n bool Pane::FocusPane(const uint32_t id)\r\n {\r\n     // Always clear the parent child path if we are focusing a leaf\r\n-    return WalkTree([=](auto p) {\r\n+    return WalkTree([=](const auto& p) {\r\n         p->_parentChildPath.reset();\r\n         if (p->_id == id)\r\n         {\r\n@@ -2421,7 +2432,7 @@ bool Pane::FocusPane(const uint32_t id)\n // - true if focus was set\r\n bool Pane::FocusPane(const std::shared_ptr<Pane> pane)\r\n {\r\n-    return WalkTree([&](auto p) {\r\n+    return WalkTree([&](const auto& p) {\r\n         if (p == pane)\r\n         {\r\n             p->_Focus();\r\ndiff --git a/src/cascadia/TerminalApp/Pane.h b/src/cascadia/TerminalApp/Pane.h\nindex f25a7b0834a..86757ad36f9 100644\n--- a/src/cascadia/TerminalApp/Pane.h\n+++ b/src/cascadia/TerminalApp/Pane.h\n@@ -248,7 +248,7 @@ class Pane : public std::enable_shared_from_this<Pane>\n \r\n     std::optional<uint32_t> _id;\r\n     std::weak_ptr<Pane> _parentChildPath{};\r\n-\r\n+    bool _closed{ false };\r\n     bool _lastActive{ false };\r\n     winrt::event_token _firstClosedToken{ 0 };\r\n     winrt::event_token _secondClosedToken{ 0 };\r\ndiff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 3053d746df2..8ef5a36584e 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -739,7 +739,7 @@ namespace winrt::TerminalApp::implementation\n             }\r\n \r\n             // Clean read-only mode to prevent additional prompt if closing the pane triggers closing of a hosting tab\r\n-            pane->WalkTree([](auto p) {\r\n+            pane->WalkTree([](const auto& p) {\r\n                 if (const auto control{ p->GetTerminalControl() })\r\n                 {\r\n                     if (control.ReadOnly())\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex ca86bb80a37..54a3e4efe09 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -3810,7 +3810,7 @@ namespace winrt::TerminalApp::implementation\n             // recipe for disaster. We won't ever open up a tab in this window.\n             newTerminalArgs.Elevate(false);\n             const auto newPane = _MakePane(newTerminalArgs, nullptr, connection);\n-            newPane->WalkTree([](auto pane) {\n+            newPane->WalkTree([](const auto& pane) {\n                 pane->FinalizeConfigurationGivenDefault();\n             });\n             _CreateNewTabFromPane(newPane);\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.cpp b/src/cascadia/TerminalApp/TerminalTab.cpp\nindex d3e52d4037d..6e1be17e38b 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.cpp\n+++ b/src/cascadia/TerminalApp/TerminalTab.cpp\n@@ -41,7 +41,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         auto firstId = _nextPaneId;\r\n \r\n-        _rootPane->WalkTree([&](std::shared_ptr<Pane> pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             // update the IDs on each pane\r\n             if (pane->_IsLeaf())\r\n             {\r\n@@ -203,7 +203,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         ASSERT_UI_THREAD();\r\n \r\n-        _rootPane->WalkTree([&](std::shared_ptr<Pane> pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             // Attach event handlers to each new pane\r\n             _AttachEventHandlersToPane(pane);\r\n             if (auto content = pane->GetContent())\r\n@@ -275,7 +275,7 @@ namespace winrt::TerminalApp::implementation\n         _UpdateHeaderControlMaxWidth();\r\n \r\n         // Update the settings on all our panes.\r\n-        _rootPane->WalkTree([&](auto pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             pane->UpdateSettings(settings);\r\n             return false;\r\n         });\r\n@@ -534,7 +534,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         // Add the new event handlers to the new pane(s)\r\n         // and update their ids.\r\n-        pane->WalkTree([&](auto p) {\r\n+        pane->WalkTree([&](const auto& p) {\r\n             _AttachEventHandlersToPane(p);\r\n             if (p->_IsLeaf())\r\n             {\r\n@@ -624,7 +624,7 @@ namespace winrt::TerminalApp::implementation\n         // manually.\r\n         _rootPane->Closed(_rootClosedToken);\r\n         auto p = _rootPane;\r\n-        p->WalkTree([](auto pane) {\r\n+        p->WalkTree([](const auto& pane) {\r\n             pane->Detached.raise(pane);\r\n         });\r\n \r\n@@ -650,7 +650,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         // Add the new event handlers to the new pane(s)\r\n         // and update their ids.\r\n-        pane->WalkTree([&](auto p) {\r\n+        pane->WalkTree([&](const auto& p) {\r\n             _AttachEventHandlersToPane(p);\r\n             if (p->_IsLeaf())\r\n             {\r\n@@ -949,26 +949,20 @@ namespace winrt::TerminalApp::implementation\n \r\n         events.CloseRequested = content.CloseRequested(\r\n             winrt::auto_revoke,\r\n-            [dispatcher, weakThis](auto sender, auto&&) -> winrt::fire_and_forget {\r\n-                // Don't forget! this ^^^^^^^^ sender can't be a reference, this is a async callback.\r\n-\r\n-                // The lambda lives in the `std::function`-style container owned by `control`. That is, when the\r\n-                // `control` gets destroyed the lambda struct also gets destroyed. In other words, we need to\r\n-                // copy `weakThis` onto the stack, because that's the only thing that gets captured in coroutines.\r\n-                // See: https://devblogs.microsoft.com/oldnewthing/20211103-00/?p=105870\r\n-                const auto weakThisCopy = weakThis;\r\n-                co_await wil::resume_foreground(dispatcher);\r\n-                // Check if Tab's lifetime has expired\r\n-                if (auto tab{ weakThisCopy.get() })\r\n+            [this](auto&& sender, auto&&) {\r\n+                if (const auto content{ sender.try_as<TerminalApp::IPaneContent>() })\r\n                 {\r\n-                    if (const auto content{ sender.try_as<TerminalApp::IPaneContent>() })\r\n+                    // Calling Close() while walking the tree is not safe, because Close() mutates the tree.\r\n+                    const auto pane = _rootPane->_FindPane([&](const auto& p) -> std::shared_ptr<Pane> {\r\n+                        if (p->GetContent() == content)\r\n+                        {\r\n+                            return p;\r\n+                        }\r\n+                        return {};\r\n+                    });\r\n+                    if (pane)\r\n                     {\r\n-                        tab->_rootPane->WalkTree([content](std::shared_ptr<Pane> pane) {\r\n-                            if (pane->GetContent() == content)\r\n-                            {\r\n-                                pane->Close();\r\n-                            }\r\n-                        });\r\n+                        pane->Close();\r\n                     }\r\n                 }\r\n             });\r\n", "test_patch": "", "problem_statement": "Terminal crashes when closing any other pane than the last\n### Windows Terminal version\r\n\r\n1.21.1272.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.3593\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nopen terminal. split horizontally twice. change to middle pane. CTRL-D -- crash.\r\n\r\ni have mouse tracking turned on if relevant\r\n\r\n![term-crash](https://github.com/microsoft/terminal/assets/46322585/fbb48d78-ecf0-4ced-8d41-5995c179b7ce)\r\n\r\n\r\n### Expected Behavior\r\n\r\nobviously, no crash :)\r\n\r\n### Actual Behavior\r\n\r\nit crashes and takes \"a long time\" to start\n", "hints_text": "Hi I'm an AI powered bot that finds similar issues based off the issue title.\n\nPlease view the issues below to see if they solve your problem, and if the issue describes your problem please consider closing this one and thumbs upping the other issue to help us prioritize it. Thank you!\n\n\n### Closed similar issues:\n- [terminal crashes when closing a tab after opening a new tab (#1666)](https://github.com/microsoft/terminal/issues/1666),  similarity score: 0.77\n- [Ctrl+D Enter in powershell after closing wsl bash tab with Ctrl+D crashes the terminal. (#2981)](https://github.com/microsoft/terminal/issues/2981),  similarity score: 0.76\n\n> Note: You can give me feedback by thumbs upping or thumbs downing this comment.\nIt seems to be anything that's not the 'last' pane. I just tried it again and successfully closed the bottom (third) pane\r\n\r\n![term-crash2](https://github.com/microsoft/terminal/assets/46322585/26387ec3-212e-4f1a-aee6-7a4f79c68a32)\r\n\r\n\nHappens when using powershell too (not ubuntu). I actually LIKE the change to use the active (not default) profile but I need to be able to close the panes :D", "created_at": "2024-05-29 13:39:14", "merge_commit_sha": "baba406a074e792dd4486f4239ac4b3292f95a60", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17221", "base_commit": "49e4eea60f737b46b8aeda505f4693df8a9d44a6", "patch": "diff --git a/src/cascadia/TerminalSettingsModel/Command.cpp b/src/cascadia/TerminalSettingsModel/Command.cpp\nindex a32ed4efa79..70f63091a1f 100644\n--- a/src/cascadia/TerminalSettingsModel/Command.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Command.cpp\n@@ -690,7 +690,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         auto data = winrt::to_string(json);\r\n \r\n         std::string errs;\r\n-        static std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n+        std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n         Json::Value root;\r\n         if (!reader->parse(data.data(), data.data() + data.size(), &root, &errs))\r\n         {\r\n", "test_patch": "", "problem_statement": "Quickly invoking PowerShell menu completion multiple times crashes Terminal\n### Windows Terminal version\n\n49e4eea60f737b46b8aeda505f4693df8a9d44a6\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Enable experimental shell completion menu (`\"experimental.enableShellCompletionMenu\": true`)\r\n2. Quickly invoke shell completion multiple times, so that Terminal tries to parse JSON with completion data at the same time from multiple threads in one of the following ways:\r\n   - Terminal versions from 432dfcc4902d1a8393217a5f529d07e65182a3f8 to 6d0342f0bb31bf245843411c6781d6d5399ff651:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938 \r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times\r\n     4. Press any character key - because of #17204 this will send the completions generated in _c._ at the same time\r\n   - Terminal versions 0b76c51ba10c81ba4213ba98cf88f2abdf91b15e and newer or older than 432dfcc4902d1a8393217a5f529d07e65182a3f8:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938, but instead of\r\n        ```ps\r\n        $result += $completions.CompletionMatches | ConvertTo-Json -Compress\r\n        ```\r\n        append a large JSON string to `$result`. It doesn't have to be a valid shell completion data, but it should be a valid JSON. 7.6M characters is large enough to reproduce the bug on my computer and probably every other PC without trying to be fast.\r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times. Depending on your CPU and the JSON size it may or may not have to be done quickly.\n\n### Expected Behavior\n\nCompletion menu is shown or nothing happens\n\n### Actual Behavior\n\nTerminal crashes or throws an exception or some kind of invalid memory access error, because `JSON::CharReader` in `Command::ParsePowerShellMenuComplete` is `static` and shared between threads:\r\n\r\nhttps://github.com/microsoft/terminal/blob/49e4eea60f737b46b8aeda505f4693df8a9d44a6/src/cascadia/TerminalSettingsModel/Command.cpp#L693\r\n\r\nReproduction in one of the versions affected by #17204:\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/693c214e-dbb2-47af-bb73-3b2a3f3efac9\r\n\r\nReproduction in other Terminal versions and demonstration of a possible fix (no menu is shown, because of the huge JSON, but the Terminal doesn't crash):\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/72dc5cb2-dd77-4f1f-a4dc-722f419a53e5\r\n\r\n\n", "hints_text": "", "created_at": "2024-05-08 23:06:17", "merge_commit_sha": "44516ad7cffef1996cabc5bf7435937ee32ba51d", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-16953", "base_commit": "26e63203741909ee8ac00e4c6ec658884560df17", "patch": "diff --git a/src/cascadia/TerminalSettingsModel/defaults.json b/src/cascadia/TerminalSettingsModel/defaults.json\nindex 360f37afaad..ae8ed369ff6 100644\n--- a/src/cascadia/TerminalSettingsModel/defaults.json\n+++ b/src/cascadia/TerminalSettingsModel/defaults.json\n@@ -281,6 +281,75 @@\n             \"brightPurple\": \"#AD7FA8\",\r\n             \"brightCyan\": \"#34E2E2\",\r\n             \"brightWhite\": \"#EEEEEC\"\r\n+        },\r\n+        {\r\n+            \"name\": \"Dark+\",\r\n+            \"foreground\": \"#cccccc\",\r\n+            \"background\": \"#1e1e1e\",\r\n+            \"cursorColor\": \"#808080\",\r\n+            \"selectionBackground\": \"#ffffff\",\r\n+            \"black\": \"#000000\",\r\n+            \"red\": \"#cd3131\",\r\n+            \"green\": \"#0dbc79\",\r\n+            \"yellow\": \"#e5e510\",\r\n+            \"blue\": \"#2472c8\",\r\n+            \"purple\": \"#bc3fbc\",\r\n+            \"cyan\": \"#11a8cd\",\r\n+            \"white\": \"#e5e5e5\",\r\n+            \"brightBlack\": \"#666666\",\r\n+            \"brightRed\": \"#f14c4c\",\r\n+            \"brightGreen\": \"#23d18b\",\r\n+            \"brightYellow\": \"#f5f543\",\r\n+            \"brightBlue\": \"#3b8eea\",\r\n+            \"brightPurple\": \"#d670d6\",\r\n+            \"brightCyan\": \"#29b8db\",\r\n+            \"brightWhite\": \"#e5e5e5\"\r\n+        },\r\n+        {\r\n+            \"background\": \"#000000\",\r\n+            \"black\": \"#000000\",\r\n+            \"blue\": \"#0000AA\",\r\n+            \"brightBlack\": \"#555555\",\r\n+            \"brightBlue\": \"#5555FF\",\r\n+            \"brightCyan\": \"#55FFFF\",\r\n+            \"brightGreen\": \"#55FF55\",\r\n+            \"brightPurple\": \"#FF55FF\",\r\n+            \"brightRed\": \"#FF5555\",\r\n+            \"brightWhite\": \"#FFFFFF\",\r\n+            \"brightYellow\": \"#FFFF55\",\r\n+            \"cursorColor\": \"#00AA00\",\r\n+            \"cyan\": \"#00AAAA\",\r\n+            \"foreground\": \"#AAAAAA\",\r\n+            \"green\": \"#00AA00\",\r\n+            \"name\": \"CGA\",\r\n+            \"purple\": \"#AA00AA\",\r\n+            \"red\": \"#AA0000\",\r\n+            \"selectionBackground\": \"#FFFFFF\",\r\n+            \"white\": \"#AAAAAA\",\r\n+            \"yellow\": \"#AA5500\"\r\n+        },\r\n+        {\r\n+            \"background\": \"#000000\",\r\n+            \"black\": \"#000000\",\r\n+            \"blue\": \"#0000AA\",\r\n+            \"brightBlack\": \"#555555\",\r\n+            \"brightBlue\": \"#5555FF\",\r\n+            \"brightCyan\": \"#55FFFF\",\r\n+            \"brightGreen\": \"#55FF55\",\r\n+            \"brightPurple\": \"#FF55FF\",\r\n+            \"brightRed\": \"#FF5555\",\r\n+            \"brightWhite\": \"#FFFFFF\",\r\n+            \"brightYellow\": \"#FFFF55\",\r\n+            \"cursorColor\": \"#00AA00\",\r\n+            \"cyan\": \"#00AAAA\",\r\n+            \"foreground\": \"#AAAAAA\",\r\n+            \"green\": \"#00AA00\",\r\n+            \"name\": \"IBM 5153\",\r\n+            \"purple\": \"#AA00AA\",\r\n+            \"red\": \"#AA0000\",\r\n+            \"selectionBackground\": \"#FFFFFF\",\r\n+            \"white\": \"#AAAAAA\",\r\n+            \"yellow\": \"#C47E00\"\r\n         }\r\n     ],\r\n     \"themes\": [\r\n", "test_patch": "", "problem_statement": "Add color scheme for EGA (the \"16 color ANSI\" palette)\n# Description of the new feature/enhancement\r\nThe 16 color standard EGA palette used on PCs back in the day was a very defining look (and still in use today for the correct look of DOS CLI/TUI programs and ANSI art etc), and I think it should definitely be a default colorscheme that comes with Windows Terminal.\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nAdd a default color scheme (call it \"EGA\" or \"ANSI\" or \"MS-DOS\" or whatever):\r\n\r\n```json\r\n{\r\n    \"background\": \"#000000\",\r\n    \"black\": \"#000000\",\r\n    \"blue\": \"#0000AA\",\r\n    \"brightBlack\": \"#555555\",\r\n    \"brightBlue\": \"#5555FF\",\r\n    \"brightCyan\": \"#55FFFF\",\r\n    \"brightGreen\": \"#55FF55\",\r\n    \"brightPurple\": \"#FF55FF\",\r\n    \"brightRed\": \"#FF5555\",\r\n    \"brightWhite\": \"#FFFFFF\",\r\n    \"brightYellow\": \"#FFFF55\",\r\n    \"cursorColor\": \"#00AA00\",\r\n    \"cyan\": \"#00AAAA\",\r\n    \"foreground\": \"#AAAAAA\",\r\n    \"green\": \"#00AA00\",\r\n    \"name\": \"16 Color ANSI\",\r\n    \"purple\": \"#AA00AA\",\r\n    \"red\": \"#AA0000\",\r\n    \"selectionBackground\": \"#FFFFFF\",\r\n    \"white\": \"#AAAAAA\",\r\n    \"yellow\": \"#AA5500\"\r\n}\r\n```\n", "hints_text": "Vintage left, 16 Color ANSI right.\r\n\r\n![image](https://github.com/microsoft/terminal/assets/18356694/e138753e-be37-4e64-a5a8-c72d8d4e03ce)\r\n\r\n\r\nIf anything, this falls under the same category as #6176 - blocked till #12800 lands\nFor tracking, here's a comment that's pretty relevant: https://github.com/microsoft/terminal/issues/7388#issuecomment-683329150\n@zadjii-msft Note the dark yellow / brown colors.\r\nYou actually need both, because the original CGA adapter used a 4-bit digital (TTL) RGBI interface to the monitor.\r\nIBM 5153 and other high-end monitors would handle dark yellow with a special circuit to reduce its green component and turn the `nasty yellow` into the `pleasing brown`.\r\nMost old-style ANSI-art expect the brown, but the Windows console probably needed to be compatible with 16-colors graphics mode and use the dark yellow instead, so both variants have decades of real-world use.\n@PhMajerus would you have a specific proposal for different names for these schemes? \r\n\r\nI think this page: https://int10h.org/blog/2022/06/ibm-5153-color-true-cga-palette/ is talking about the same effect you're describing. Based on the yellows, I'm thinking:\r\n* `#AA5500` is \"CGA\"\r\n* `#C47E00` is \"IBM 5153\"", "created_at": "2024-03-27 15:51:24", "merge_commit_sha": "68955d1ddbccf06c8f42e1c6c306ede1d3e7e157", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
