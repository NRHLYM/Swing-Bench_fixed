{"problem_statement": "stats_mysql_commands_counters table doesn't address the new source replica terminology commands in MYSQL 8.0, 8.4+\nProxySQL needs to consider the new mysql source/replica terminology commands wherever applicable. MySQL 8.4+ no longer recognize the old master/slave terminology commands.\r\n\r\nAFAICS the below three stats in stats_mysql_commands_counters table needs to be updated to consider the new terminology commands:\r\nCHANGE_MASTER (shall consider CHANGE REPLICATION SOURCE)\r\nRESET_MASTER (shall consider RESET BINARY LOGS AND GTIDS)\r\nRESET_SLAVE (shall consider RESET REPLICA)\r\n\r\nProxySQL version : 2.7.1\r\nOS version: centos 9\r\n\r\nSteps to reproduce:\r\n1. Setup proxysql with at least one backend mysql 8.4+ server correctly configured. \r\n2. Configure the mysql user in proxysql, ensure that the user with necessary privileges exists on mysql 8.4+ server.\r\n3. Open proxysql connection via the user configured.\r\n4. Execute [CHANGE MASTER](https://dev.mysql.com/doc/refman/8.0/en/change-master-to.html) command with right syntax as per mysql 8.0, the query errors out as syntax ERROR but the stats_mysql_commands_counters table will increase the count for CHANGE_MASTER.\r\n5. Execute [CHANGE REPLICATION SOURCE](https://dev.mysql.com/doc/refman/8.4/en/change-replication-source-to.html) command with right syntax, the query executes successfully on server but no effect in CHANGE_MASTER counter.\r\n\r\nSame behavior for RESET_MASTER and RESET_SLAVE\r\n\r\nFix:\r\nRename CHANGE_MASTER, RESET_MASTER and RESET_SLAVE  to CHANGE_REPLICATION_SOURCE, RESET_BINARY_LOGS_AND_GTIDS  and RESET_REPLICA respectively and when server is 8.4+ then consider only the new terminology commands as old terminology commands are invalid and when the version is lower then 8.4 then consider both the new and old terminology commands.\r\n\r\n\n", "patch": "diff --git a/Makefile b/Makefile\nindex 094d7008f..c7bdbd966 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -372,6 +372,17 @@ clean:\n \tcd test/deps && ${MAKE} clean\n \trm -f pkgroot || true\n \n+.PHONY: cleandeps\n+cleandeps:\n+\tcd deps && ${MAKE} cleanall\n+\tcd lib && ${MAKE} clean\n+\tcd src && ${MAKE} clean\n+\n+.PHONY: cleandev\n+cleandev:\n+\tcd lib && ${MAKE} clean\n+\tcd src && ${MAKE} clean\n+\n .PHONY: cleanall\n cleanall:\n \tcd deps && ${MAKE} cleanall\ndiff --git a/include/proxysql_structs.h b/include/proxysql_structs.h\nindex 2450e8a82..5927ce81d 100644\n--- a/include/proxysql_structs.h\n+++ b/include/proxysql_structs.h\n@@ -487,6 +487,7 @@ enum MYSQL_COM_QUERY_command {\n \tMYSQL_COM_QUERY_BEGIN,\n \tMYSQL_COM_QUERY_CALL,\n \tMYSQL_COM_QUERY_CHANGE_MASTER,\n+\tMYSQL_COM_QUERY_CHANGE_REPLICATION_SOURCE,\n \tMYSQL_COM_QUERY_COMMIT,\n \tMYSQL_COM_QUERY_CREATE_DATABASE,\n \tMYSQL_COM_QUERY_CREATE_INDEX,\n@@ -518,7 +519,9 @@ enum MYSQL_COM_QUERY_command {\n \tMYSQL_COM_QUERY_RELEASE_SAVEPOINT,\n \tMYSQL_COM_QUERY_RENAME_TABLE,\n \tMYSQL_COM_QUERY_RESET_MASTER,\n+\tMYSQL_COM_QUERY_RESET_BINARY_LOGS_AND_GTIDS,\n \tMYSQL_COM_QUERY_RESET_SLAVE,\n+\tMYSQL_COM_QUERY_RESET_REPLICA,\n \tMYSQL_COM_QUERY_REPLACE,\n \tMYSQL_COM_QUERY_REVOKE,\n \tMYSQL_COM_QUERY_ROLLBACK,\ndiff --git a/lib/ClickHouse_Server.cpp b/lib/ClickHouse_Server.cpp\nindex f8b005e5f..5f90568b0 100644\n--- a/lib/ClickHouse_Server.cpp\n+++ b/lib/ClickHouse_Server.cpp\n@@ -1146,6 +1146,8 @@ void ClickHouse_Server_session_handler(MySQL_Session* sess, void *_pa, PtrSize_t\n \t\t\t||\n \t\t\t(strncasecmp(\"SHOW SLAVE STATUS\",query_no_space,17)==0)\n \t\t\t||\n+\t\t\t(strncasecmp(\"SHOW REPLICA STATUS\",query_no_space,19)==0)\n+\t\t\t||\n \t\t\t(strncasecmp(\"SHOW MASTER LOGS\",query_no_space,16)==0)\n \t\t) {\n \t\t\tGloClickHouseServer->send_MySQL_ERR(&sess->client_myds->myprot, (char *)\"Access Denied\");\ndiff --git a/lib/MySQL_Monitor.cpp b/lib/MySQL_Monitor.cpp\nindex 4b8b83144..579a4006f 100644\n--- a/lib/MySQL_Monitor.cpp\n+++ b/lib/MySQL_Monitor.cpp\n@@ -683,8 +683,12 @@ void MySQL_Monitor_State_Data::init_async() {\n \tcase MON_REPLICATION_LAG:\n \t\tasync_state_machine_ = ASYNC_QUERY_START;\n #ifdef TEST_REPLICATIONLAG\n-\t\tquery_ = \"SELECT SLAVE STATUS \"; // replaced SHOW with SELECT to avoid breaking simulator logic\n-\t\tquery_ += std::string(hostname) + \":\" + std::to_string(port);\n+\t\t// Simulator syntax allows 'SELECT <REPLICA|SLAVE> STATUS'\n+\t\t{\n+\t\t\tconst std::string REPLICA { mysql_get_server_version(mysql) < 80023 ? \"SLAVE\" : \"REPLICA\" };\n+\t\t\tquery_ = \"SELECT \" + REPLICA + \" STATUS \";\n+\t\t\tquery_ += std::string(hostname) + \":\" + std::to_string(port);\n+\t\t}\n #else\n \t\tif (mysql_thread___monitor_replication_lag_use_percona_heartbeat && \n \t\t\tmysql_thread___monitor_replication_lag_use_percona_heartbeat[0] != '\\0') {\n@@ -692,7 +696,11 @@ void MySQL_Monitor_State_Data::init_async() {\n \t\t\tquery_ = \"SELECT MAX(ROUND(TIMESTAMPDIFF(MICROSECOND, ts, SYSDATE(6))/1000000)) AS Seconds_Behind_Master FROM \";\n \t\t\tquery_ += mysql_thread___monitor_replication_lag_use_percona_heartbeat;\n \t\t} else {\n-\t\t\tquery_ = \"SHOW SLAVE STATUS\";\n+\t\t\tif (mysql_get_server_version(mysql) < 80023) {\n+\t\t\t\tquery_ = \"SHOW SLAVE STATUS\";\n+\t\t\t} else {\n+\t\t\t\tquery_ = \"SHOW REPLICA STATUS\";\n+\t\t\t}\n \t\t}\n #endif\n \t\ttask_timeout_ = mysql_thread___monitor_replication_lag_timeout;\n@@ -2694,9 +2702,11 @@ void * monitor_replication_lag_thread(void *arg) {\n \n #ifdef TEST_REPLICATIONLAG\n \t{\n-\t\tstd::string s = \"SELECT SLAVE STATUS \"; // replaced SHOW with SELECT to avoid breaking simulator logic\n-\t\ts += std::string(mmsd->hostname) + \":\" + std::to_string(mmsd->port);\n-\t\tmmsd->async_exit_status = mysql_query_start(&mmsd->interr, mmsd->mysql, s.c_str());\n+\t\tconst string REPLICA { mysql_get_server_version(mmsd->mysql) < 80023 ? \"SLAVE\" : \"REPLICA\" };\n+\t\tconst string SELECT {\n+\t\t\t\"SELECT \" + REPLICA + \" STATUS \" + string(mmsd->hostname) + \":\" + std::to_string(mmsd->port)\n+\t\t};\n+\t\tmmsd->async_exit_status = mysql_query_start(&mmsd->interr, mmsd->mysql, SELECT.c_str());\n \t}\n #else\n \tif (percona_heartbeat_table) {\n@@ -2711,7 +2721,10 @@ void * monitor_replication_lag_thread(void *arg) {\n \t\t}\n \t}\n \tif (use_percona_heartbeat == false) {\n-\t\tmmsd->async_exit_status=mysql_query_start(&mmsd->interr,mmsd->mysql,\"SHOW SLAVE STATUS\");\n+\t\tconst char* query {\n+\t\t\tmysql_get_server_version(mmsd->mysql) < 80023 ? \"SHOW SLAVE STATUS\" : \"SHOW REPLICA STATUS\"\n+\t\t};\n+\t\tmmsd->async_exit_status=mysql_query_start(&mmsd->interr,mmsd->mysql, query);\n \t}\n #endif // TEST_REPLICATIONLAG\n \twhile (mmsd->async_exit_status) {\n@@ -2819,7 +2832,10 @@ void * monitor_replication_lag_thread(void *arg) {\n \t\t\t\t\t{\n \t\t\t\t\t\tfor(k = 0; k < num_fields; k++) {\n \t\t\t\t\t\t\tif (fields[k].name) {\n-\t\t\t\t\t\t\t\tif (strcmp(\"Seconds_Behind_Master\", fields[k].name)==0) {\n+\t\t\t\t\t\t\t\tif (\n+\t\t\t\t\t\t\t\t\tstrcmp(\"Seconds_Behind_Master\", fields[k].name)==0\n+\t\t\t\t\t\t\t\t\t|| strcmp(\"Seconds_Behind_Source\", fields[k].name)==0\n+\t\t\t\t\t\t\t\t) {\n \t\t\t\t\t\t\t\t\tj=k;\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t}\n@@ -7909,7 +7925,10 @@ bool MySQL_Monitor::monitor_replication_lag_process_ready_tasks(const std::vecto\n \t\t\t{\n \t\t\t\tfor (k = 0; k < num_fields; k++) {\n \t\t\t\t\tif (fields[k].name) {\n-\t\t\t\t\t\tif (strcmp(\"Seconds_Behind_Master\", fields[k].name) == 0) {\n+\t\t\t\t\t\tif (\n+\t\t\t\t\t\t\tstrcmp(\"Seconds_Behind_Master\", fields[k].name)==0\n+\t\t\t\t\t\t\t|| strcmp(\"Seconds_Behind_Source\", fields[k].name)==0\n+\t\t\t\t\t\t) {\n \t\t\t\t\t\t\tj = k;\n \t\t\t\t\t\t}\n \t\t\t\t\t}\ndiff --git a/lib/MySQL_Query_Processor.cpp b/lib/MySQL_Query_Processor.cpp\nindex 561fd3084..b81f8650e 100644\n--- a/lib/MySQL_Query_Processor.cpp\n+++ b/lib/MySQL_Query_Processor.cpp\n@@ -24,6 +24,7 @@ static char* commands_counters_desc[MYSQL_COM_QUERY___NONE] = {\n \t[MYSQL_COM_QUERY_BEGIN] = (char*)\"BEGIN\",\n \t[MYSQL_COM_QUERY_CALL] = (char*)\"CALL\",\n \t[MYSQL_COM_QUERY_CHANGE_MASTER] = (char*)\"CHANGE_MASTER\",\n+\t[MYSQL_COM_QUERY_CHANGE_REPLICATION_SOURCE] = (char*)\"MYSQL_COM_QUERY_CHANGE_REPLICATION_SOURCE\",\n \t[MYSQL_COM_QUERY_COMMIT] = (char*)\"COMMIT\",\n \t[MYSQL_COM_QUERY_CREATE_DATABASE] = (char*)\"CREATE_DATABASE\",\n \t[MYSQL_COM_QUERY_CREATE_INDEX] = (char*)\"CREATE_INDEX\",\n@@ -55,7 +56,9 @@ static char* commands_counters_desc[MYSQL_COM_QUERY___NONE] = {\n \t[MYSQL_COM_QUERY_RELEASE_SAVEPOINT] = (char*)\"RELEASE_SAVEPOINT\",\n \t[MYSQL_COM_QUERY_RENAME_TABLE] = (char*)\"RENAME_TABLE\",\n \t[MYSQL_COM_QUERY_RESET_MASTER] = (char*)\"RESET_MASTER\",\n+\t[MYSQL_COM_QUERY_RESET_BINARY_LOGS_AND_GTIDS] = (char*)\"RESET_BINARY_LOGS_AND_GTIDS\",\n \t[MYSQL_COM_QUERY_RESET_SLAVE] = (char*)\"RESET_SLAVE\",\n+\t[MYSQL_COM_QUERY_RESET_REPLICA] = (char*)\"RESET_REPLICA\",\n \t[MYSQL_COM_QUERY_REPLACE] = (char*)\"REPLACE\",\n \t[MYSQL_COM_QUERY_REVOKE] = (char*)\"REVOKE\",\n \t[MYSQL_COM_QUERY_ROLLBACK] = (char*)\"ROLLBACK\",\n@@ -263,6 +266,10 @@ enum MYSQL_COM_QUERY_command MySQL_Query_Processor::query_parser_command_type(SQ\n \t\t\t\tret = MYSQL_COM_QUERY_CHANGE_MASTER;\n \t\t\t\tbreak;\n \t\t\t}\n+\t\t\tif (!strcasecmp(\"REPLICATION\", token)) {\n+\t\t\t\tret = MYSQL_COM_QUERY_CHANGE_REPLICATION_SOURCE;\n+\t\t\t\tbreak;\n+\t\t\t}\n \t\t\tbreak;\n \t\t}\n \t\tif (!strcasecmp(\"COMMIT\", token)) { // COMMIT\n@@ -442,10 +449,18 @@ enum MYSQL_COM_QUERY_command MySQL_Query_Processor::query_parser_command_type(SQ\n \t\t\t\tret = MYSQL_COM_QUERY_RESET_MASTER;\n \t\t\t\tbreak;\n \t\t\t}\n+\t\t\tif (!strcasecmp(\"BINARY\", token)) {\n+\t\t\t\tret = MYSQL_COM_QUERY_RESET_BINARY_LOGS_AND_GTIDS;\n+\t\t\t\tbreak;\n+\t\t\t}\n \t\t\tif (!strcasecmp(\"SLAVE\", token)) {\n \t\t\t\tret = MYSQL_COM_QUERY_RESET_SLAVE;\n \t\t\t\tbreak;\n \t\t\t}\n+\t\t\tif (!strcasecmp(\"REPLICA\", token)) {\n+\t\t\t\tret = MYSQL_COM_QUERY_RESET_REPLICA;\n+\t\t\t\tbreak;\n+\t\t\t}\n \t\t\tbreak;\n \t\t}\n \t\tif (!strcasecmp(\"REVOKE\", token)) { // REVOKE\ndiff --git a/src/SQLite3_Server.cpp b/src/SQLite3_Server.cpp\nindex da0949520..f283f454d 100644\n--- a/src/SQLite3_Server.cpp\n+++ b/src/SQLite3_Server.cpp\n@@ -871,7 +871,13 @@ void SQLite3_Server_session_handler(MySQL_Session* sess, void *_pa, PtrSize_t *p\n \t\t\t}\n #endif // TEST_READONLY\n #ifdef TEST_REPLICATIONLAG\n-\t\t\tif (strncasecmp(\"SELECT SLAVE STATUS \", query_no_space, strlen(\"SELECT SLAVE STATUS \")) == 0) {\n+\t\t\tif (\n+\t\t\t\tstrncasecmp(\"SELECT SLAVE STATUS \", query_no_space, strlen(\"SELECT SLAVE STATUS \")) == 0\n+\t\t\t\t|| strncasecmp(\"SELECT REPLICA STATUS \", query_no_space, strlen(\"SELECT REPLICA STATUS \")) == 0\n+\t\t\t) {\n+\t\t\t\tuint64_t addr_offset {\n+\t\t\t\t\tstrstr(query_no_space, \"REPLICA\") ?  strlen(\"SELECT REPLICA STATUS \") : strlen(\"SELECT SLAVE STATUS \")\n+\t\t\t\t};\n \t\t\t\tif (strlen(query_no_space) > strlen(\"SELECT SLAVE STATUS \") + 5) {\n \t\t\t\t\tpthread_mutex_lock(&GloSQLite3Server->test_replicationlag_mutex);\n \t\t\t\t\t// the current test doesn't try to simulate failures, therefore it will return immediately\n@@ -879,17 +885,15 @@ void SQLite3_Server_session_handler(MySQL_Session* sess, void *_pa, PtrSize_t *p\n \t\t\t\t\t\t// probably never initialized\n \t\t\t\t\t\tGloSQLite3Server->load_replicationlag_table(sess);\n \t\t\t\t\t}\n-\t\t\t\t\tconst int* rc = GloSQLite3Server->replicationlag_test_value(query_no_space + strlen(\"SELECT SLAVE STATUS \"));\n+\t\t\t\t\tconst int* rc = GloSQLite3Server->replicationlag_test_value(query_no_space + addr_offset);\n \t\t\t\t\tfree(query);\n-\t\t\t\t\tif (rc == nullptr) {\n-\t\t\t\t\t\tconst char* a = (char*)\"SELECT null as Seconds_Behind_Master\";\n-\t\t\t\t\t\tquery = (char*)malloc(strlen(a) + 2);\n-\t\t\t\t\t\tsprintf(query, a);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tconst char* a = (char*)\"SELECT %d as Seconds_Behind_Master\";\n-\t\t\t\t\t\tquery = (char*)malloc(strlen(a) + 2);\n-\t\t\t\t\t\tsprintf(query, a, *rc);\n-\t\t\t\t\t}\n+\n+\t\t\t\t\tstring SELECT { \"SELECT \" + (rc ? std::to_string(*rc) : string { \"null\" }) + \" AS \" };\n+\t\t\t\t\tSELECT += strstr(query_no_space, \"REPLICA\") ? \"Seconds_Behind_Source\" : \"Seconds_Behind_Master\";\n+\n+\t\t\t\t\tquery = static_cast<char*>(malloc(SELECT.size() + 1));\n+\t\t\t\t\tsprintf(query, SELECT.c_str());\n+\n \t\t\t\t\tpthread_mutex_unlock(&GloSQLite3Server->test_replicationlag_mutex);\n \t\t\t\t}\n \t\t\t}\n", "instance_id": "sysown__proxysql-4908", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: ProxySQL needs to update its handling of MySQL commands to account for the new source/replica terminology introduced in MySQL 8.4+. The goal is to update the `stats_mysql_commands_counters` table to reflect the new commands (`CHANGE REPLICATION SOURCE`, `RESET BINARY LOGS AND GTIDS`, `RESET REPLICA`) while maintaining compatibility with older MySQL versions. The steps to reproduce the issue are provided, and the expected fix is outlined. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly address how to handle version detection logic in a robust way or specify edge cases like mixed MySQL versions in a cluster. Additionally, while the fix suggests renaming counters, it does not clarify how to handle potential backward compatibility for tools or scripts relying on the old counter names. These minor gaps prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes spans multiple files (`proxysql_structs.h`, `MySQL_Query_Processor.cpp`, `MySQL_Monitor.cpp`, etc.), requiring modifications to enums, command parsing logic, and version-specific query handling. This indicates a need to understand interactions between different parts of the ProxySQL codebase, such as how commands are tracked and how MySQL version information influences behavior. Second, the number of technical concepts involved includes parsing SQL queries, handling MySQL version compatibility, and updating internal data structures, which are moderately complex but not overly advanced. Third, the problem requires handling edge cases like differing MySQL versions (pre-8.4 vs. 8.4+) and ensuring that both old and new terminology are supported appropriately based on the server version. While the changes do not appear to impact the core architecture significantly, they do require careful attention to detail to avoid breaking existing functionality. Overall, this problem is not trivial but does not reach the level of hard or very hard due to the absence of deep architectural refactoring or highly complex algorithms. A score of 0.55 reflects this medium difficulty, leaning slightly higher due to the multi-file changes and version compatibility considerations.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.55}
{"problem_statement": "Wrong web browser opened when clicking links\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.3.0\n\n### What operating system(s) are you using?\n\nUbuntu\n\n### Operating System Version\n\n24.04\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nLinks open in the configured default browser\n\n### Actual Behavior\n\nLinks open in Chrome/Chromium instead, regardless of the configured default browser\n\n### Testcase Gist URL\n\nhttps://gist.github.com/Viicos/d77af018be1b7b27294a74c378731992\n\n### Additional Information\n\nThis is a re-open of https://github.com/electron/electron/issues/42611 (by @bittylicious) after @viicos was so kind to add a repro gist (adding a gist was an absolute requirement by the Electron team on the original issue).\n\nThe original issue already well pointed out that this issue seems to be new with Ubuntu 24 and wasn't present on 22.\n\nWorkarounds presented in in the original issue:\n\n* Uninstalling all chrome/chromium (then e.g. a firefox will be correctly opened)\n* Adding the following to `~/.local/share/applications/mimeapps.list`\n\n```\n[Default Applications]\nx-scheme-handler/http=firefox_firefox.desktop\nx-scheme-handler/https=firefox_firefox.desktop\n```\n\nThere are some additional details available in the original issue.\n", "patch": "diff --git a/shell/common/platform_util_linux.cc b/shell/common/platform_util_linux.cc\nindex 125b4d037a474..9dd491945548f 100644\n--- a/shell/common/platform_util_linux.cc\n+++ b/shell/common/platform_util_linux.cc\n@@ -15,6 +15,7 @@\n \n #include \"base/cancelable_callback.h\"\n #include \"base/containers/contains.h\"\n+#include \"base/containers/map_util.h\"\n #include \"base/environment.h\"\n #include \"base/files/file_util.h\"\n #include \"base/files/scoped_file.h\"\n@@ -58,6 +59,8 @@ const char kFreedesktopPortalName[] = \"org.freedesktop.portal.Desktop\";\n const char kFreedesktopPortalPath[] = \"/org/freedesktop/portal/desktop\";\n const char kFreedesktopPortalOpenURI[] = \"org.freedesktop.portal.OpenURI\";\n \n+const char kOriginalXdgCurrentDesktopEnvVar[] = \"ORIGINAL_XDG_CURRENT_DESKTOP\";\n+\n const char kMethodOpenDirectory[] = \"OpenDirectory\";\n \n class ShowItemHelper {\n@@ -282,6 +285,12 @@ bool XDGUtil(const std::vector<std::string>& argv,\n     base::nix::CreateLaunchOptionsWithXdgActivation(base::BindOnce(\n         [](base::RepeatingClosure quit_loop, base::LaunchOptions* options_out,\n            base::LaunchOptions options) {\n+          // Correct the XDG_CURRENT_DESKTOP environment variable before calling\n+          // XDG, in case it was changed for compatibility.\n+          if (const auto* orig = base::FindOrNull(\n+                  options.environment, kOriginalXdgCurrentDesktopEnvVar))\n+            options.environment.emplace(base::nix::kXdgCurrentDesktopEnvVar,\n+                                        *orig);\n           *options_out = std::move(options);\n           std::move(quit_loop).Run();\n         },\n", "instance_id": "electron__electron-45310", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: links in an Electron application are opening in Chrome/Chromium instead of the configured default browser on Ubuntu 24.04. It provides context about the operating system, Electron version, expected and actual behavior, and even includes a test case gist and references to a previous issue for additional details. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether this issue occurs in all Electron applications or specific ones, nor does it detail the exact conditions under which the issue manifests (e.g., specific types of links or configurations). Additionally, while workarounds are provided, there is no mention of specific edge cases or constraints that might need to be considered in a solution. Overall, the statement is valid and clear but lacks some minor details that could aid in fully understanding the scope and potential complexities.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change is relatively narrow, confined to a single file (`platform_util_linux.cc`) with a small diff (adding logic to handle an environment variable). This suggests a focused modification rather than a broad architectural change. However, the change requires understanding specific technical concepts, such as the Linux XDG (Cross-Desktop Group) specifications and how environment variables like `XDG_CURRENT_DESKTOP` influence desktop behavior in Ubuntu. Additionally, it involves interacting with Electron's platform utilities, which may require familiarity with the codebase's structure and the implications of modifying environment variables at runtime. The problem does not appear to introduce significant edge cases or complex error handling beyond ensuring the environment variable is correctly set, though care must be taken to avoid unintended side effects on other desktop environments or configurations. Overall, this problem requires a moderate level of expertise in Linux desktop integration and Electron's internals, but it does not demand deep architectural changes or advanced domain-specific knowledge, placing it at a difficulty of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.45}
{"problem_statement": "RGBA DDS files with a non-power of two resolution  and mipmaps fail to be read\n### Tested versions\n\nReproducible in 4.5-dev1\n\n### System information\n\nGodot v4.5.dev1 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2060 (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i9-9900KF CPU @ 3.60GHz (16 threads)\n\n### Issue description\n\nAttempting to load a dds file with the RGBA8 format, mipmaps, and a non-power of 2 size will result in a failure between the expected and actual file size, and so the file will fail to load. \n\n### Steps to reproduce\n\nOpen the attached project and read the error message printed when dds_120_with_mipmaps.dds is clicked on.\n\n### Minimal reproduction project (MRP)\n\n[dds_mipmap_test.zip](https://github.com/user-attachments/files/19642255/dds_mipmap_test.zip)\n", "patch": "diff --git a/modules/dds/texture_loader_dds.cpp b/modules/dds/texture_loader_dds.cpp\nindex 1fd7e5170557..c360dd8892ba 100644\n--- a/modules/dds/texture_loader_dds.cpp\n+++ b/modules/dds/texture_loader_dds.cpp\n@@ -165,8 +165,8 @@ static Ref<Image> _dds_load_layer(Ref<FileAccess> p_file, DDSFormat p_dds_format\n \t\tuint32_t size = p_width * p_height * info.block_size;\n \n \t\tfor (uint32_t i = 1; i < p_mipmaps; i++) {\n-\t\t\tw = (w + 1) >> 1;\n-\t\t\th = (h + 1) >> 1;\n+\t\t\tw = MAX(1u, w >> 1);\n+\t\t\th = MAX(1u, h >> 1);\n \t\t\tsize += w * h * info.block_size;\n \t\t}\n \n", "instance_id": "godotengine__godot-105193", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear, providing a specific issue description about failing to load RGBA DDS files with non-power of two resolutions and mipmaps. It includes the tested version, system information, steps to reproduce, and a minimal reproduction project, which are helpful for understanding the context and verifying the issue. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or constraints for non-power of two resolutions with mipmaps, nor does it mention specific edge cases beyond the general failure to load. Additionally, the error message or exact failure point (beyond \"expected vs. actual file size\") is not detailed in the description, requiring the user to refer to the reproduction project. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). The issue involves a specific bug in the mipmap size calculation for non-power of two resolutions in DDS file loading, and the provided code change is minimal, altering just two lines in a single file (texture_loader_dds.cpp). The fix replaces a simple right-shift operation with a clamped version using MAX to prevent dimensions from becoming zero, which is a straightforward logic adjustment. The scope of the change is limited to a single function and does not impact the broader architecture or require understanding complex interactions across the codebase. The technical concepts involved are basic: understanding mipmap level calculations and handling non-power of two dimensions, which are common in graphics programming but do not require advanced knowledge. While edge cases (e.g., very small resolutions or specific mipmap counts) might exist, they are not explicitly mentioned in the problem statement, and the fix appears to handle the primary issue without additional error handling complexity. Overall, this is a simple bug fix requiring minimal effort and understanding, justifying a difficulty score of 0.25.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.25}
{"problem_statement": "`bvec` uniform default values aren't propagated to the inspector\n### Tested versions\n\n- Reproducible in: 4.3.stable, 4.4.1.stable, 4.5.dev [97241ffea]\n\n### System information\n\nUbuntu 22.04\n\n### Issue description\n\nin a `.gdshader`:\n\n```\nuniform bvec4 b4 = bvec4(true, true, true, true);\n```\n\nIn the inspector, only x is checked, and the underlying value is just a `bool` that's `true`.\n\n![Image](https://github.com/user-attachments/assets/b5424731-1ec6-4af8-9002-fb0a0341334f)\n\nEditing the value from the inspector here seems to work fine, but changing it back manually to `bvec4(true, false, false, false)` still shows the arrow to revert back to the default value. In this state, the underlying value is properly an `int`.\n\n![Image](https://github.com/user-attachments/assets/534ca3f7-5b75-4c92-8af0-ddefe54f767d)\n\nThe same applies to `bvec2` and `bvec3`.\n\n### Steps to reproduce\n\nCreate a `uniform bvec` in a .gdshader file:\n\n```\nuniform bvec4 b4 = bvec4(true, true, true, true);\n```\n\nAttach it to a shader material, and check its value in the inspector.\n\n### Minimal reproduction project (MRP)\n\n[bvec.zip](https://github.com/user-attachments/files/19543767/bvec.zip)\n", "patch": "diff --git a/servers/rendering/shader_language.cpp b/servers/rendering/shader_language.cpp\nindex 6748689b2e8e..fa8d5a946848 100644\n--- a/servers/rendering/shader_language.cpp\n+++ b/servers/rendering/shader_language.cpp\n@@ -4222,7 +4222,7 @@ Variant ShaderLanguage::constant_value_to_variant(const Vector<Scalar> &p_value,\n \t\t\t\t\t}\n \t\t\t\t\tvalue = Variant(array);\n \t\t\t\t} else {\n-\t\t\t\t\tvalue = Variant(p_value[0].boolean);\n+\t\t\t\t\tvalue = Variant(p_value[0].sint | (p_value[1].sint << 1));\n \t\t\t\t}\n \t\t\t\tbreak;\n \t\t\tcase ShaderLanguage::TYPE_BVEC3:\n@@ -4235,7 +4235,7 @@ Variant ShaderLanguage::constant_value_to_variant(const Vector<Scalar> &p_value,\n \t\t\t\t\t}\n \t\t\t\t\tvalue = Variant(array);\n \t\t\t\t} else {\n-\t\t\t\t\tvalue = Variant(p_value[0].boolean);\n+\t\t\t\t\tvalue = Variant(p_value[0].sint | (p_value[1].sint << 1) | (p_value[2].sint << 2));\n \t\t\t\t}\n \t\t\t\tbreak;\n \t\t\tcase ShaderLanguage::TYPE_BVEC4:\n@@ -4248,7 +4248,7 @@ Variant ShaderLanguage::constant_value_to_variant(const Vector<Scalar> &p_value,\n \t\t\t\t\t}\n \t\t\t\t\tvalue = Variant(array);\n \t\t\t\t} else {\n-\t\t\t\t\tvalue = Variant(p_value[0].boolean);\n+\t\t\t\t\tvalue = Variant(p_value[0].sint | (p_value[1].sint << 1) | (p_value[2].sint << 2) | (p_value[3].sint << 3));\n \t\t\t\t}\n \t\t\t\tbreak;\n \t\t\tcase ShaderLanguage::TYPE_INT:\n", "instance_id": "godotengine__godot-104880", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue with `bvec` uniform default values not being correctly propagated to the inspector in a shader context. It provides specific examples (e.g., `bvec4` initialization), steps to reproduce, system information, and even visual evidence through images. Additionally, a minimal reproduction project is included, which aids in understanding the issue. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior for all `bvec` types in the inspector (e.g., how the underlying value should be represented for each component), and it lacks clarity on whether this issue affects other shader uniform types or is strictly limited to `bvec2`, `bvec3`, and `bvec4`. Edge cases, such as mixed boolean values or interactions with other shader features, are not fully explored in the description. Thus, while the problem is valid and mostly clear, these minor missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code changes is limited to a single file (`shader_language.cpp`) and specifically to a small section of the code handling the conversion of `bvec` types to `Variant` values. The modification itself is straightforward, involving bit-shifting operations to encode multiple boolean values into a single integer, which is a relatively simple logic change. Second, the technical concepts required are minimal: basic understanding of bitwise operations and familiarity with the shader language implementation in the codebase. No advanced algorithms, design patterns, or domain-specific knowledge beyond shader uniforms are necessary. Third, the impact on the overall architecture is negligible, as this is a localized fix without broader implications for other modules. Finally, while the problem statement does not explicitly mention edge cases, the code changes implicitly handle all components of `bvec2`, `bvec3`, and `bvec4`, and no complex error handling is required beyond the existing logic. The score of 0.35 reflects that while the task is easy, it does require a basic understanding of the shader data representation and a small degree of precision to ensure the bit-shifting logic is correct for all vector components.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.35}
{"problem_statement": " OptionButton dropdown not properly inheriting scale of parent CanvasLayer in 4.3\n### Tested versions\r\n\r\n- Reproducible in: 4.3.stable\r\n\r\n### System information\r\n\r\nApple - Apple M1 Pro Godot Engine v4.3.stable.official.77dcf97d8 API 4.1 Metal\r\n\r\n### Issue description\r\n\r\nThis is a duplicate of issue #94247 only that I am able to reproduce the same bug in v4.3\r\n\r\n### Steps to reproduce\r\n\r\nIncrease or reduce the scale of the parent Control node, the OptionButton dropdown won't inherit the scale.\r\n\r\n![Screenshot 2024-10-30 at 11 25 03](https://github.com/user-attachments/assets/eaa250cd-11e4-4f72-a0d8-120b75a3a976)\r\n![Screenshot 2024-10-30 at 11 24 43](https://github.com/user-attachments/assets/198c5a15-f48b-496d-968b-3bfd3a69a880)\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[bug-report.zip](https://github.com/user-attachments/files/17575562/bug-report.zip)\n", "patch": "diff --git a/scene/gui/popup_menu.cpp b/scene/gui/popup_menu.cpp\nindex dadb7e8ceb31..2baaa580c0c8 100644\n--- a/scene/gui/popup_menu.cpp\n+++ b/scene/gui/popup_menu.cpp\n@@ -3036,14 +3036,18 @@ void PopupMenu::popup(const Rect2i &p_bounds) {\n \n \t\tmoved = Vector2();\n \t\tpopup_time_msec = OS::get_singleton()->get_ticks_msec();\n-\t\tif (!is_embedded()) {\n-\t\t\tfloat win_scale = get_parent_visible_window()->get_content_scale_factor();\n-\t\t\tset_content_scale_factor(win_scale);\n-\t\t\tSize2 minsize = get_contents_minimum_size() * win_scale;\n-\t\t\tminsize.height = Math::ceil(minsize.height); // Ensures enough height at fractional content scales to prevent the v_scroll_bar from showing.\n-\t\t\tset_min_size(minsize); // `height` is truncated here by the cast to Size2i for Window.min_size.\n-\t\t\tset_size(Vector2(0, 0)); // Shrinkwraps to min size.\n-\t\t}\n+\n+\t\tSize2 scale = get_parent_viewport()->get_popup_base_transform().get_scale();\n+\t\tCanvasItem *c = Object::cast_to<CanvasItem>(get_parent());\n+\t\tif (c) {\n+\t\t\tscale *= c->get_global_transform_with_canvas().get_scale();\n+\t\t}\n+\t\treal_t popup_scale = MIN(scale.x, scale.y);\n+\t\tset_content_scale_factor(popup_scale);\n+\t\tSize2 minsize = get_contents_minimum_size() * popup_scale;\n+\t\tminsize.height = Math::ceil(minsize.height); // Ensures enough height at fractional content scales to prevent the v_scroll_bar from showing.\n+\t\tset_min_size(minsize); // `height` is truncated here by the cast to Size2i for Window.min_size.\n+\t\tset_size(Vector2(0, 0)); // Shrinkwraps to min size.\n \t\tPopup::popup(p_bounds);\n \t}\n }\ndiff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex 9ecdc25c76d4..f031a72a542b 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -4092,7 +4092,9 @@ bool Tree::edit_selected(bool p_force_edit) {\n \t\treturn false;\n \t}\n \n-\treal_t popup_scale = popup_editor->is_embedded() ? 1.0 : popup_editor->get_parent_visible_window()->get_content_scale_factor();\n+\tSize2 scale = popup_editor->get_parent_viewport()->get_popup_base_transform().get_scale() * get_global_transform_with_canvas().get_scale();\n+\treal_t popup_scale = MIN(scale.x, scale.y);\n+\n \tRect2 rect = _get_item_focus_rect(s);\n \trect.position *= popup_scale;\n \tpopup_edited_item = s;\ndiff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex 56703372ee0e..7eadfea0b79e 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -1562,20 +1562,19 @@ void Viewport::_gui_show_tooltip() {\n \tif (!window) { // Not embedded.\n \t\twindow = gui.tooltip_popup->get_parent_visible_window();\n \t}\n-\tfloat win_scale = window->content_scale_factor;\n+\tSize2 scale = get_popup_base_transform().get_scale();\n+\treal_t popup_scale = MIN(scale.x, scale.y);\n \tPoint2 tooltip_offset = GLOBAL_GET(\"display/mouse_cursor/tooltip_position_offset\");\n-\tif (!gui.tooltip_popup->is_embedded()) {\n-\t\ttooltip_offset *= win_scale;\n-\t}\n+\ttooltip_offset *= popup_scale;\n \tRect2 r(gui.tooltip_pos + tooltip_offset, gui.tooltip_popup->get_contents_minimum_size());\n \tRect2i vr;\n \tif (gui.tooltip_popup->is_embedded()) {\n \t\tvr = gui.tooltip_popup->get_embedder()->get_visible_rect();\n \t} else {\n-\t\tpanel->content_scale_factor = win_scale;\n-\t\tr.size *= win_scale;\n \t\tvr = window->get_usable_parent_rect();\n \t}\n+\tpanel->content_scale_factor = popup_scale;\n+\tr.size *= popup_scale;\n \tr.size = r.size.ceil();\n \tr.size = r.size.min(panel->get_max_size());\n \n", "instance_id": "godotengine__godot-104399", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `OptionButton` dropdown does not inherit the scale of its parent `CanvasLayer` in Godot Engine version 4.3. It provides context by referencing a duplicate issue, includes steps to reproduce, system information, and visual evidence via screenshots. Additionally, a minimal reproduction project (MRP) is provided, which aids in understanding the problem. However, the statement lacks explicit details about expected behavior (e.g., how the scale inheritance should work), specific constraints, or edge cases to consider. While the issue is reproducible and the goal is implied (fix the scale inheritance), these missing details prevent it from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" range (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`popup_menu.cpp`, `tree.cpp`, and `viewport.cpp`) within the Godot Engine, a complex and large codebase, requiring an understanding of how different GUI components interact. The changes involve modifying the logic for scale inheritance, which necessitates a deep understanding of Godot's rendering and transformation systems, specifically how `CanvasItem`, `Viewport`, and `Popup` components handle scaling and transformations. \n\nSecond, the technical concepts involved are moderately advanced, including knowledge of 2D transformations (e.g., `get_global_transform_with_canvas()`, `get_popup_base_transform()`), GUI rendering logic, and the interplay between embedded and non-embedded popups. The developer must also understand how content scaling affects minimum sizes and visible rectangles, which adds to the complexity.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes suggest potential challenges, such as ensuring consistent behavior across different viewport configurations, handling fractional scaling, and avoiding visual artifacts (e.g., scrollbars appearing unexpectedly). The modifications also impact core GUI functionality, which could have broader implications on other components, requiring careful testing.\n\nFinally, the amount of code change is relatively small, but the impact is significant due to the critical nature of the affected systems. Solving this requires not just coding but also a nuanced understanding of Godot's architecture. A score of 0.65 reflects the need for deep codebase familiarity and careful handling of GUI scaling logic, placing it on the lower end of the \"Hard\" category, as it does not involve system-level redesign or extremely intricate algorithms.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.65}
{"problem_statement": "Tree's folding arrow and relationship lines move to 2nd column.\n### Tested versions\n\nv4.3stable\nv4.4stable\nv4.5dev\n\n### System information\n\nWindows10\n\n### Issue description\n\nUse `set_column_clip_content(0,true)`  on a Tree. Then narrow the first column. Folding arrow and ralationship lines will move to 2nd column.\n\n![Image](https://github.com/user-attachments/assets/2d16f424-2410-48f0-b449-deaa9d0de7fc)\n\n![Image](https://github.com/user-attachments/assets/32f1a880-0bad-4ce0-bfef-39d153b3aa05)\n\n### Steps to reproduce\n\n1. Create a Tree.\n2. Create Items.\n3. Use `set_column_clip_content(0,true)`\n4. Narrow the first column.\n\n### Minimal reproduction project (MRP)\n\n[MoveTo2ndColMRP.zip](https://github.com/user-attachments/files/19266410/MoveTo2ndColMRP.zip)\n", "patch": "diff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex 04d8970c9c91..35d091cdfc06 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -2601,14 +2601,27 @@ int Tree::draw_item(const Point2i &p_pos, const Point2 &p_draw_ofs, const Size2\n \t\t\t\tarrow = theme_cache.arrow;\n \t\t\t}\n \n-\t\t\tPoint2 apos = p_pos + Point2i(0, (label_h - arrow->get_height()) / 2) - theme_cache.offset + p_draw_ofs;\n-\t\t\tapos.x += theme_cache.item_margin - arrow->get_width();\n+\t\t\tSize2 arrow_full_size = arrow->get_size();\n \n-\t\t\tif (rtl) {\n-\t\t\t\tapos.x = get_size().width - apos.x - arrow->get_width();\n+\t\t\tPoint2 apos = p_pos + Point2i(0, (label_h - arrow_full_size.height) / 2) - theme_cache.offset + p_draw_ofs;\n+\t\t\tapos.x += theme_cache.item_margin - arrow_full_size.width;\n+\n+\t\t\tSize2 arrow_draw_size = arrow_full_size;\n+\t\t\tint out_width = p_pos.x + theme_cache.item_margin - get_column_width(0);\n+\t\t\tif (out_width > 0) {\n+\t\t\t\tarrow_draw_size.width -= out_width;\n \t\t\t}\n \n-\t\t\tarrow->draw(ci, apos);\n+\t\t\tif (arrow_draw_size.width > 0) {\n+\t\t\t\tPoint2 src_pos = Point2();\n+\t\t\t\tif (rtl) {\n+\t\t\t\t\tapos.x = get_size().width - apos.x - arrow_draw_size.width;\n+\t\t\t\t\tsrc_pos = Point2(arrow_full_size.width - arrow_draw_size.width, 0);\n+\t\t\t\t}\n+\t\t\t\tRect2 arrow_rect = Rect2(apos, arrow_draw_size);\n+\t\t\t\tRect2 arrow_src_rect = Rect2(src_pos, arrow_draw_size);\n+\t\t\t\tarrow->draw_rect_region(ci, arrow_rect, arrow_src_rect);\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -2637,20 +2650,22 @@ int Tree::draw_item(const Point2i &p_pos, const Point2 &p_draw_ofs, const Size2\n \n \t\t\t// Draw relationship lines.\n \t\t\tif (theme_cache.draw_relationship_lines > 0 && (!hide_root || c->parent != root) && c->is_visible_in_tree()) {\n-\t\t\t\tint root_ofs = children_pos.x + ((p_item->disable_folding || hide_folding) ? theme_cache.h_separation : theme_cache.item_margin);\n \t\t\t\tint parent_ofs = p_pos.x + theme_cache.item_margin;\n-\t\t\t\tPoint2i root_pos = Point2i(root_ofs, children_pos.y + child_self_height / 2) - theme_cache.offset + p_draw_ofs;\n+\t\t\t\tPoint2i parent_pos = Point2i(parent_ofs - theme_cache.arrow->get_width() / 2, p_pos.y + label_h / 2 + theme_cache.arrow->get_height() / 2) - theme_cache.offset + p_draw_ofs;\n \n+\t\t\t\tint root_ofs = children_pos.x + ((p_item->disable_folding || hide_folding) ? theme_cache.h_separation : theme_cache.item_margin);\n+\t\t\t\tPoint2i root_pos = Point2i(root_ofs, children_pos.y + child_self_height / 2) - theme_cache.offset + p_draw_ofs;\n \t\t\t\tif (c->get_visible_child_count() > 0) {\n \t\t\t\t\troot_pos -= Point2i(theme_cache.arrow->get_width(), 0);\n \t\t\t\t}\n+\t\t\t\troot_pos.x = MIN(root_pos.x, get_column_width(0) + p_draw_ofs.x);\n+\n+\t\t\t\tbool is_no_space = root_pos.x <= parent_pos.x;\n \n \t\t\t\tfloat line_width = theme_cache.relationship_line_width * Math::round(theme_cache.base_scale);\n \t\t\t\tfloat parent_line_width = theme_cache.parent_hl_line_width * Math::round(theme_cache.base_scale);\n \t\t\t\tfloat children_line_width = theme_cache.children_hl_line_width * Math::round(theme_cache.base_scale);\n \n-\t\t\t\tPoint2i parent_pos = Point2i(parent_ofs - theme_cache.arrow->get_width() / 2, p_pos.y + label_h / 2 + theme_cache.arrow->get_height() / 2) - theme_cache.offset + p_draw_ofs;\n-\n \t\t\t\tint more_prev_ofs = 0;\n \n \t\t\t\tif (root_pos.y + line_width >= 0) {\n@@ -2662,10 +2677,12 @@ int Tree::draw_item(const Point2i &p_pos, const Point2 &p_draw_ofs, const Size2\n \t\t\t\t\t// Order of parts on this bend: the horizontal line first, then the vertical line.\n \t\t\t\t\tif (_is_branch_selected(c)) {\n \t\t\t\t\t\t// If this item or one of its children is selected, we draw the line using parent highlight style.\n-\t\t\t\t\t\tif (htotal >= 0) {\n-\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(parent_line_width / 2), root_pos.y), theme_cache.parent_hl_line_color, parent_line_width);\n+\t\t\t\t\t\tif (!is_no_space) {\n+\t\t\t\t\t\t\tif (htotal >= 0) {\n+\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(parent_line_width / 2), root_pos.y), theme_cache.parent_hl_line_color, parent_line_width);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(parent_line_width / 2)), Point2i(parent_pos.x, prev_hl_ofs), theme_cache.parent_hl_line_color, parent_line_width);\n \t\t\t\t\t\t}\n-\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(parent_line_width / 2)), Point2i(parent_pos.x, prev_hl_ofs), theme_cache.parent_hl_line_color, parent_line_width);\n \n \t\t\t\t\t\tmore_prev_ofs = theme_cache.parent_hl_line_margin;\n \t\t\t\t\t\tprev_hl_ofs = root_pos.y + Math::floor(parent_line_width / 2);\n@@ -2673,33 +2690,41 @@ int Tree::draw_item(const Point2i &p_pos, const Point2 &p_draw_ofs, const Size2\n \t\t\t\t\t\t// If parent item is selected (but this item is not), we draw the line using children highlight style.\n \t\t\t\t\t\t// Siblings of the selected branch can be drawn with a slight offset and their vertical line must appear as highlighted.\n \t\t\t\t\t\tif (_is_sibling_branch_selected(c)) {\n-\t\t\t\t\t\t\tif (htotal >= 0) {\n-\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(parent_line_width / 2), root_pos.y), theme_cache.children_hl_line_color, children_line_width);\n+\t\t\t\t\t\t\tif (!is_no_space) {\n+\t\t\t\t\t\t\t\tif (htotal >= 0) {\n+\t\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(parent_line_width / 2), root_pos.y), theme_cache.children_hl_line_color, children_line_width);\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(parent_line_width / 2)), Point2i(parent_pos.x, prev_hl_ofs), theme_cache.parent_hl_line_color, parent_line_width);\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(parent_line_width / 2)), Point2i(parent_pos.x, prev_hl_ofs), theme_cache.parent_hl_line_color, parent_line_width);\n \n \t\t\t\t\t\t\tprev_hl_ofs = root_pos.y + Math::floor(parent_line_width / 2);\n \t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tif (htotal >= 0) {\n-\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(children_line_width / 2), root_pos.y), theme_cache.children_hl_line_color, children_line_width);\n+\t\t\t\t\t\t\tif (!is_no_space) {\n+\t\t\t\t\t\t\t\tif (htotal >= 0) {\n+\t\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(children_line_width / 2), root_pos.y), theme_cache.children_hl_line_color, children_line_width);\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(children_line_width / 2)), Point2i(parent_pos.x, prev_ofs + Math::floor(children_line_width / 2)), theme_cache.children_hl_line_color, children_line_width);\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(children_line_width / 2)), Point2i(parent_pos.x, prev_ofs + Math::floor(children_line_width / 2)), theme_cache.children_hl_line_color, children_line_width);\n \t\t\t\t\t\t}\n \t\t\t\t\t} else {\n \t\t\t\t\t\t// If nothing of the above is true, we draw the line using normal style.\n \t\t\t\t\t\t// Siblings of the selected branch can be drawn with a slight offset and their vertical line must appear as highlighted.\n \t\t\t\t\t\tif (_is_sibling_branch_selected(c)) {\n-\t\t\t\t\t\t\tif (htotal >= 0) {\n-\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + theme_cache.parent_hl_line_margin, root_pos.y), theme_cache.relationship_line_color, line_width);\n+\t\t\t\t\t\t\tif (!is_no_space) {\n+\t\t\t\t\t\t\t\tif (htotal >= 0) {\n+\t\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + theme_cache.parent_hl_line_margin, root_pos.y), theme_cache.relationship_line_color, line_width);\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(parent_line_width / 2)), Point2i(parent_pos.x, prev_hl_ofs), theme_cache.parent_hl_line_color, parent_line_width);\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(parent_line_width / 2)), Point2i(parent_pos.x, prev_hl_ofs), theme_cache.parent_hl_line_color, parent_line_width);\n \n \t\t\t\t\t\t\tprev_hl_ofs = root_pos.y + Math::floor(parent_line_width / 2);\n \t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tif (htotal >= 0) {\n-\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(line_width / 2), root_pos.y), theme_cache.relationship_line_color, line_width);\n+\t\t\t\t\t\t\tif (!is_no_space) {\n+\t\t\t\t\t\t\t\tif (htotal >= 0) {\n+\t\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, root_pos, Point2i(parent_pos.x + Math::floor(line_width / 2), root_pos.y), theme_cache.relationship_line_color, line_width);\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(line_width / 2)), Point2i(parent_pos.x, prev_ofs + Math::floor(line_width / 2)), theme_cache.relationship_line_color, line_width);\n \t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_line(ci, Point2i(parent_pos.x, root_pos.y + Math::floor(line_width / 2)), Point2i(parent_pos.x, prev_ofs + Math::floor(line_width / 2)), theme_cache.relationship_line_color, line_width);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n", "instance_id": "godotengine__godot-104201", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when using `set_column_clip_content(0, true)` on a Tree and narrowing the first column, the folding arrow and relationship lines move to the second column, which appears to be unintended behavior. The statement includes steps to reproduce, system information, tested versions, and even a minimal reproduction project (MRP) with images to illustrate the issue. However, there are minor ambiguities and missing details. For instance, the desired behavior is not explicitly stated\u2014should the arrows and lines remain in the first column despite clipping, or is there another expected outcome? Additionally, edge cases or specific constraints (e.g., behavior with different column widths or RTL layouts) are not mentioned. While the issue is understandable, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is limited to a single file (`tree.cpp`) and specifically to the rendering logic of the Tree GUI component, which reduces the complexity of navigating a large codebase. However, the changes themselves are non-trivial, involving modifications to the drawing logic for arrows and relationship lines, including handling clipping and RTL (right-to-left) layouts. The code changes require understanding graphical rendering concepts (e.g., canvas item drawing, region-based rendering with `draw_rect_region`), coordinate calculations, and conditional logic for visibility and positioning. Additionally, the problem involves handling edge cases such as column width constraints and ensuring proper alignment of visual elements, as seen in the logic to adjust drawing based on available space (`is_no_space` checks). While the changes do not impact the broader system architecture, they demand a solid grasp of the specific rendering subsystem and careful attention to detail to avoid introducing new visual bugs. Therefore, I rate this as a medium difficulty problem (0.55), as it requires understanding multiple concepts and making moderately complex modifications, but it does not necessitate deep architectural changes or advanced domain-specific knowledge beyond GUI rendering.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.55}
{"problem_statement": "AudioEffectPitchShift cancels out other AudioEffects\n### Tested versions\n\nIssue is found in Godot 4.4\nTested in Godot 4.3 and bug cannot be reproduced\n\n\n\n\n\n\n\n\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7435HS (16 threads)\n\n### Issue description\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nwhen using pitch shift effect in any bus channel, if any other effects are added then pitch shift cancels out the other effects. If they are on the same bus then there is no audio. If effects are separate i.e pitch shift on master bus and other effects on other buses then audio is heard but other effects are cancelled out and their \"effect\" is not heard.\n\n\n\n\n### Steps to reproduce\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nUsing AudioEffectPitchShift on the master bus - works ok\nAdd another effect to the master bus - no audio when play()\nUncheck AudioEffectPitchShift in master bus - audio ok when play()\n\nCreate bus channel, route AudioStreamPlayer2D to new bus,\nmove other effect to new master bus, \nAudioEffectPitchShift remains in master bus - audio is now heard but other effects are cancelled out by AudioEffectPitchShift\nUncheck AudioEffectPitchShift in master bus - new bus effects work again\n\n### Minimal reproduction project (MRP)\n\n[EffectBug.zip](https://github.com/user-attachments/files/19212952/EffectBug.zip)\nAudioEffectPitchShift cancels out other AudioEffects\n### Tested versions\n\nIssue is found in Godot 4.4\nTested in Godot 4.3 and bug cannot be reproduced\n\n\n\n\n\n\n\n\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7435HS (16 threads)\n\n### Issue description\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nwhen using pitch shift effect in any bus channel, if any other effects are added then pitch shift cancels out the other effects. If they are on the same bus then there is no audio. If effects are separate i.e pitch shift on master bus and other effects on other buses then audio is heard but other effects are cancelled out and their \"effect\" is not heard.\n\n\n\n\n### Steps to reproduce\n\nPlaying an audio file from AudioStreamPlayer2D. \n\nUsing AudioEffectPitchShift on the master bus - works ok\nAdd another effect to the master bus - no audio when play()\nUncheck AudioEffectPitchShift in master bus - audio ok when play()\n\nCreate bus channel, route AudioStreamPlayer2D to new bus,\nmove other effect to new master bus, \nAudioEffectPitchShift remains in master bus - audio is now heard but other effects are cancelled out by AudioEffectPitchShift\nUncheck AudioEffectPitchShift in master bus - new bus effects work again\n\n### Minimal reproduction project (MRP)\n\n[EffectBug.zip](https://github.com/user-attachments/files/19212952/EffectBug.zip)\n", "patch": "diff --git a/servers/audio/effects/audio_effect_pitch_shift.cpp b/servers/audio/effects/audio_effect_pitch_shift.cpp\nindex 89273d744b8a..1fba20983c03 100644\n--- a/servers/audio/effects/audio_effect_pitch_shift.cpp\n+++ b/servers/audio/effects/audio_effect_pitch_shift.cpp\n@@ -288,6 +288,9 @@ void SMBPitchShift::smbFft(float *fftBuffer, long fftFrameSize, long sign)\n void AudioEffectPitchShiftInstance::process(const AudioFrame *p_src_frames, AudioFrame *p_dst_frames, int p_frame_count) {\n \t// Avoid distortion by skipping processing if pitch_scale is 1.0.\n \tif (Math::is_equal_approx(base->pitch_scale, 1.0f)) {\n+\t\tfor (int i = 0; i < p_frame_count; i++) {\n+\t\t\tp_dst_frames[i] = p_src_frames[i];\n+\t\t}\n \t\treturn;\n \t}\n \n", "instance_id": "godotengine__godot-104090", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the AudioEffectPitchShift in Godot 4.4, where it cancels out other audio effects when used on the same or different buses. The description includes specific steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which aids in understanding the problem context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., how multiple effects should interact) or provide specific examples of other effects being canceled out (e.g., reverb, delay). Additionally, there are no mentions of edge cases or constraints related to audio processing parameters. While the issue is reproducible and the goal is implied (fix the interaction between AudioEffectPitchShift and other effects), the lack of detailed expected outcomes and edge case specifications prevents it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem is rated as easy (0.25) based on the provided code changes and the scope of the issue. Let's break it down by the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided diff shows a minimal change in a single file (`audio_effect_pitch_shift.cpp`), specifically in the `process` method of `AudioEffectPitchShiftInstance`. The modification is a simple addition of a loop to copy input frames to output frames when the pitch scale is 1.0, effectively bypassing pitch shift processing. This change is localized and does not impact other parts of the codebase or the system's architecture. The amount of code change is very small (just a few lines).\n\n2. **Number of Technical Concepts:** Solving this specific issue, as per the provided diff, requires basic understanding of audio processing logic (e.g., frame-by-frame processing) and C++ syntax. No advanced language features, complex algorithms, design patterns, or domain-specific knowledge beyond basic audio effect processing are needed for this fix. However, understanding the broader context of audio effect chaining in Godot might require slightly more knowledge, but the provided solution does not demand it.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not mention specific edge cases or error conditions, and the code change does not introduce or modify error handling logic. The fix is straightforward and does not appear to address complex scenarios (e.g., varying audio formats, buffer overflows, or performance issues with large frame counts). While there might be unaddressed edge cases in the broader issue of effect interaction, the provided solution is narrowly focused and simple.\n\n4. **Overall Complexity:** The provided fix is a basic bug fix that addresses a specific condition (pitch scale of 1.0) without delving into the deeper issue of why AudioEffectPitchShift cancels out other effects. If the task were to fully resolve the interaction issue across buses and effects, the difficulty would likely increase to medium or hard (0.4-0.6), requiring understanding of Godot's audio pipeline and effect chaining logic. However, based on the given code change, the task is a simple modification to avoid unnecessary processing, making it an easy problem.\n\nIn summary, the difficulty is low because the code change is minimal, localized, and requires only basic understanding of the relevant code logic. It does not involve complex modifications, architectural changes, or significant edge case handling in the provided context.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.25}
{"problem_statement": "Accessing `TEXTURE_PIXEL_SIZE` in a light() function leads to shader compilation errors\n### Tested versions\n\n- Reproducible in Godot 4.4-stable.\n- Reproducible in Godot 4.4-rc1.\n- Reproducible in Godot 4.4-dev3.\n- Not reproducible in Godot 4.3-stable.\n- Not reproducible in Godot 4.4-dev1.\n- Not reproducible in Godot 4.4-dev2.\n\nBisection result: a657ea42f1e656695f502a0e5f50ea9e0e041c3e is the first bad commit.\n\n### System information\n\nGodot v4.4.stable (cc10aa775) - Arch Linux #1 SMP PREEMPT_DYNAMIC Thu, 27 Feb 2025 18:09:44 +0000 on Wayland - Wayland display driver, Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Laptop GPU - 11th Gen Intel(R) Core(TM) i7-11800H @ 2.30GHz (16 threads)\n\n### Issue description\n\nAfter opening our project in Godot 4.4, I noticed shader errors printed connected to our light shader code. I narrowed it down to using `TEXTURE_PIXEL_SIZE` in a light() function within a canvas item shader. Related shaders also stopped working.\n\n[godot.log](https://github.com/user-attachments/files/19078527/godot.log)\n\n### Steps to reproduce\n\nAttach this shader to a canvas item node:\n```shader\nshader_type canvas_item;\n\nvoid light() {\n\tvec2 something = TEXTURE_PIXEL_SIZE;\n}\n\n```\n\n### Minimal reproduction project (MRP)\n\n[reproduction.zip](https://github.com/user-attachments/files/19078540/reproduction.zip)\n", "patch": "diff --git a/servers/rendering/renderer_rd/shaders/canvas.glsl b/servers/rendering/renderer_rd/shaders/canvas.glsl\nindex 48420e06c9bf..e2d9086a5de5 100644\n--- a/servers/rendering/renderer_rd/shaders/canvas.glsl\n+++ b/servers/rendering/renderer_rd/shaders/canvas.glsl\n@@ -306,6 +306,7 @@ vec4 light_compute(\n \t\tvec2 screen_uv,\n \t\tvec2 uv,\n \t\tvec4 color, bool is_directional) {\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \tvec4 light = vec4(0.0);\n \tvec3 light_direction = vec3(0.0);\n \n", "instance_id": "godotengine__godot-103617", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: accessing `TEXTURE_PIXEL_SIZE` in a `light()` function within a canvas item shader causes compilation errors in Godot 4.4. It provides specific version information, system details, steps to reproduce, and a minimal reproduction project, which are helpful for understanding the context and replicating the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly clarify why `TEXTURE_PIXEL_SIZE` causes errors (e.g., whether it's a bug in the engine, a change in API, or a restriction in the shader language). Additionally, the expected behavior or desired outcome (e.g., whether the fix should allow `TEXTURE_PIXEL_SIZE` usage or provide an alternative) is not specified. Constraints or limitations in the shader environment are also not detailed, which could be critical for a complete understanding. Overall, while the issue is well-documented with reproduction steps, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change appears limited, as the provided diff modifies a single line in a shader file (`canvas.glsl`) by adding a reference to `InstanceData`. However, the impact of this change requires understanding the broader context of the Godot engine's rendering pipeline and shader system, which suggests a moderate level of complexity in terms of codebase interaction. Second, the technical concepts involved include knowledge of GLSL (shader programming), Godot's rendering architecture, and potentially the specific changes introduced in the problematic commit (identified via bisection). These concepts are not trivial but are within the grasp of someone with intermediate experience in graphics programming. Third, the problem likely involves edge cases related to shader compatibility across different Godot versions and hardware configurations (as evidenced by the system information and version-specific reproducibility), though these are not explicitly detailed in the statement. Finally, the fix's impact on the system's architecture seems minimal based on the diff, but debugging shader compilation errors often requires iterative testing and a nuanced understanding of the rendering context. Overall, this problem requires a moderate depth of knowledge and effort, balancing between understanding specific technical domains and making targeted changes, hence a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.45}
{"problem_statement": "Mbed TLS error when exporting with PCK encryption (musl libc)\n### Tested versions\n\n- Reproducible in: 4.4-beta1 and later\n- Not reproducible in: 4.3-stable\n\n### System information\n\nAlpine Linux - musl libc - gcc - Godot 4.4.rc2 - AMD GPU\n\n### Issue description\n\nI have compiled both the editor and the export templates in my system (Alpine Linux with musl libc and GCC) as usual, with my encryption key exported.\nWhen I try to export the game with the PCK encryption enabled, fails at 20% with the following errors:\n\n```\nERROR:  failed\n  ! mbedtls_ctr_drbg_seed returned an error -52.\n   at: init (core/crypto/crypto_core.cpp:73)\nERROR: Failed to initialize random number generator.\n   at: open_and_parse (core/io/file_access_encrypted.cpp:52)\nERROR: Condition \"err != OK\" is true. Returning: ERR_SKIP\n   at: _save_pack_file (editor/export/editor_export_platform.cpp:304)\nERROR: Save PCK: Failed to export project files.\n   at: add_message (editor/export/editor_export_platform.h:243)\n```\n\nIt works OK if I use the same compiled templates in the official 4.4-rc2 release running on my steam deck (GLIBC), so I think that the issue is in my compiled editor, not in the templates.\n\n### Steps to reproduce\n\nI've compiled the editor and templates with the following commands under Alpine Linux (musl libc) using GCC:\n\n```\n# Editor\nscons platform=linuxbsd arch=x86_64 production=yes lto=none\n\n# Templates (export the encryption key here)\nscons platform=windows target=template_debug arch=x86_64 production=yes lto=none\nscons platform=windows target=template_release arch=x86_64 production=yes lto=none\n```\n\n### Minimal reproduction project (MRP)\n\nnone\n", "patch": "diff --git a/core/io/file_access_encrypted.cpp b/core/io/file_access_encrypted.cpp\nindex f2749157b3d0..f3d89a66971f 100644\n--- a/core/io/file_access_encrypted.cpp\n+++ b/core/io/file_access_encrypted.cpp\n@@ -30,9 +30,17 @@\n \n #include \"file_access_encrypted.h\"\n \n-#include \"core/crypto/crypto_core.h\"\n #include \"core/variant/variant.h\"\n \n+CryptoCore::RandomGenerator *FileAccessEncrypted::_fae_static_rng = nullptr;\n+\n+void FileAccessEncrypted::deinitialize() {\n+\tif (_fae_static_rng) {\n+\t\tmemdelete(_fae_static_rng);\n+\t\t_fae_static_rng = nullptr;\n+\t}\n+}\n+\n Error FileAccessEncrypted::open_and_parse(Ref<FileAccess> p_base, const Vector<uint8_t> &p_key, Mode p_mode, bool p_with_magic, const Vector<uint8_t> &p_iv) {\n \tERR_FAIL_COND_V_MSG(file.is_valid(), ERR_ALREADY_IN_USE, vformat(\"Can't open file while another file from path '%s' is open.\", file->get_path_absolute()));\n \tERR_FAIL_COND_V(p_key.size() != 32, ERR_INVALID_PARAMETER);\n@@ -48,9 +56,15 @@ Error FileAccessEncrypted::open_and_parse(Ref<FileAccess> p_base, const Vector<u\n \t\tkey = p_key;\n \t\tif (p_iv.is_empty()) {\n \t\t\tiv.resize(16);\n-\t\t\tCryptoCore::RandomGenerator rng;\n-\t\t\tERR_FAIL_COND_V_MSG(rng.init(), FAILED, \"Failed to initialize random number generator.\");\n-\t\t\tError err = rng.get_random_bytes(iv.ptrw(), 16);\n+\t\t\tif (unlikely(!_fae_static_rng)) {\n+\t\t\t\t_fae_static_rng = memnew(CryptoCore::RandomGenerator);\n+\t\t\t\tif (_fae_static_rng->init() != OK) {\n+\t\t\t\t\tmemdelete(_fae_static_rng);\n+\t\t\t\t\t_fae_static_rng = nullptr;\n+\t\t\t\t\tERR_FAIL_V_MSG(FAILED, \"Failed to initialize random number generator.\");\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tError err = _fae_static_rng->get_random_bytes(iv.ptrw(), 16);\n \t\t\tERR_FAIL_COND_V(err != OK, err);\n \t\t} else {\n \t\t\tERR_FAIL_COND_V(p_iv.size() != 16, ERR_INVALID_PARAMETER);\ndiff --git a/core/io/file_access_encrypted.h b/core/io/file_access_encrypted.h\nindex 570955b78352..a1bc0f09dcf6 100644\n--- a/core/io/file_access_encrypted.h\n+++ b/core/io/file_access_encrypted.h\n@@ -31,6 +31,7 @@\n #ifndef FILE_ACCESS_ENCRYPTED_H\n #define FILE_ACCESS_ENCRYPTED_H\n \n+#include \"core/crypto/crypto_core.h\"\n #include \"core/io/file_access.h\"\n \n #define ENCRYPTED_HEADER_MAGIC 0x43454447\n@@ -57,6 +58,8 @@ class FileAccessEncrypted : public FileAccess {\n \n \tvoid _close();\n \n+\tstatic CryptoCore::RandomGenerator *_fae_static_rng;\n+\n public:\n \tError open_and_parse(Ref<FileAccess> p_base, const Vector<uint8_t> &p_key, Mode p_mode, bool p_with_magic = true, const Vector<uint8_t> &p_iv = Vector<uint8_t>());\n \tError open_and_parse_password(Ref<FileAccess> p_base, const String &p_key, Mode p_mode);\n@@ -97,6 +100,8 @@ class FileAccessEncrypted : public FileAccess {\n \n \tvirtual void close() override;\n \n+\tstatic void deinitialize();\n+\n \tFileAccessEncrypted() {}\n \t~FileAccessEncrypted();\n };\ndiff --git a/core/register_core_types.cpp b/core/register_core_types.cpp\nindex 568694bdf4d0..d58097920d91 100644\n--- a/core/register_core_types.cpp\n+++ b/core/register_core_types.cpp\n@@ -45,6 +45,7 @@\n #include \"core/io/config_file.h\"\n #include \"core/io/dir_access.h\"\n #include \"core/io/dtls_server.h\"\n+#include \"core/io/file_access_encrypted.h\"\n #include \"core/io/http_client.h\"\n #include \"core/io/image_loader.h\"\n #include \"core/io/json.h\"\n@@ -455,5 +456,7 @@ void unregister_core_types() {\n \tCoreStringNames::free();\n \tStringName::cleanup();\n \n+\tFileAccessEncrypted::deinitialize();\n+\n \tOS::get_singleton()->benchmark_end_measure(\"Core\", \"Unregister Types\");\n }\n", "instance_id": "godotengine__godot-103415", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an error occurs during PCK encryption export in Godot 4.4-beta1 and later versions when compiled on Alpine Linux with musl libc. It provides specific error messages, system information, and steps to reproduce the issue, which helps in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or constraints beyond the error logs, nor does it mention specific edge cases or conditions under which the error might vary. Additionally, there is no minimal reproduction project (MRP) provided, which could have clarified the exact setup or conditions leading to the issue. While the issue is tied to musl libc and encryption, the root cause or hypothesis (e.g., specific mbedtls behavior on musl) is not detailed, leaving some room for interpretation. Overall, the statement is valid and mostly clear but lacks comprehensive details on edge cases or a precise root cause analysis.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes, while limited to a few files (`file_access_encrypted.cpp`, `file_access_encrypted.h`, and `register_core_types.cpp`), involves critical modifications to the encryption and random number generation logic in the Godot engine. The changes introduce a static random number generator with proper initialization and cleanup, which requires understanding the lifecycle of static resources and their implications on the system. Second, the technical concepts involved include knowledge of C++ memory management (`memnew` and `memdelete`), encryption libraries (likely mbedtls, as hinted by the error), and random number generation (`CryptoCore::RandomGenerator`). Additionally, the issue is tied to platform-specific behavior (musl libc vs. glibc), which adds a layer of complexity in debugging and ensuring compatibility. Third, while edge cases are not explicitly mentioned in the problem statement, the code changes suggest potential issues with initialization failures or concurrent access to the static RNG, requiring careful error handling. Finally, the impact of these changes is significant as they affect a core functionality (file encryption during export), and any misstep could introduce security vulnerabilities or crashes. This problem requires a deep understanding of the Godot codebase, C++ best practices, and platform-specific nuances, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.65}
{"problem_statement": "Godot 3 project to Godot 4 conversion failed but nothing is displayed to the user\n### Tested versions\n\nTested in 4.4.dev7 only.\n\n### System information\n\nGodot v4.4.dev7 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated GeForce GTX 780M - Intel(R) Core(TM) i7-4700HQ CPU @ 2.40GHz (8 threads)\n\n### Issue description\n\nI tried to convert [this project](https://github.com/adcomp/Godot3_2D_Island_OpenSimplexNoise) to Godot 4 and it failed whatever option picked (full project or project file only).\nThe project conversion window shows **nothing at all**.\n\nAlthough, in log, there are these:\n\n> Starting conversion.\nERROR: Class \"IPUnix\" does not exist in Godot 4, so it cannot be used in the conversion.\n   at: test_array_names (editor/project_converter_3_to_4.cpp:1172)\nERROR: Found function which is used in the converter, but it cannot be found in Godot 4. Rename this element or remove its entry if it's obsolete.\n   at: test_array_names (editor/project_converter_3_to_4.cpp:1222)\nERROR: Cannot start converting due to problems with data in arrays.\n   at: convert (editor/project_converter_3_to_4.cpp:334)\n\nThe error message regarding _IPUnix_ class is weird cause it is even not used in the project.\nAnd this project is pretty small (one scene and one script), nothing fancy and just a few old stuff which have been modified like _export_ and _getset_ syntax, _lock/unlock_ functions of Image object no longer needed/available.\n\n### Steps to reproduce\n\nDownload and convert the project given in the issue description.\nNo errors shown to the user.\nProject list remain as it was before and the project doesn't appear in the list.\n\n### Minimal reproduction project (MRP)\n\n[this project](https://github.com/adcomp/Godot3_2D_Island_OpenSimplexNoise)\n", "patch": "diff --git a/editor/renames_map_3_to_4.cpp b/editor/renames_map_3_to_4.cpp\nindex ca5d3cbf2ab7..278d57d73a6f 100644\n--- a/editor/renames_map_3_to_4.cpp\n+++ b/editor/renames_map_3_to_4.cpp\n@@ -1523,7 +1523,6 @@ const char *RenamesMap3To4::class_renames[][2] = {\n \t{ \"GradientTexture\", \"GradientTexture2D\" },\n \t{ \"HeightMapShape\", \"HeightMapShape3D\" },\n \t{ \"HingeJoint\", \"HingeJoint3D\" },\n-\t{ \"IP_Unix\", \"IPUnix\" },\n \t{ \"ImmediateGeometry\", \"ImmediateMesh\" },\n \t{ \"ImmediateGeometry3D\", \"ImmediateMesh\" },\n \t{ \"InterpolatedCamera\", \"Camera3D\" },\n", "instance_id": "godotengine__godot-102922", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Godot 3 to Godot 4 project conversion fails without displaying any error messages to the user, despite errors being logged in the background. It provides specific details such as the tested version (Godot 4.4.dev7), system information, steps to reproduce, and a minimal reproduction project (MRP). The logs included in the description also point to specific errors related to a class rename (\"IP_Unix\") and issues with data in arrays. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly define the expected behavior of the conversion tool (e.g., what should be displayed to the user on failure), nor does it clarify whether the issue is purely UI-related or tied to deeper conversion logic failures. Additionally, edge cases or specific constraints about the project structure that might cause this issue are not mentioned. Overall, while the issue is well-documented for reproduction, these minor missing details reduce the clarity slightly.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, involving the removal of a single entry (\"IP_Unix\") from a class rename map in a single file (`editor/renames_map_3_to_4.cpp`). This suggests that the fix is localized and does not require extensive modifications across multiple files or modules. There is no indication that this change impacts the broader system architecture or requires deep understanding of interactions between different parts of the Godot engine codebase.\n\n2. **Technical Concepts Involved**: The change requires basic familiarity with the Godot engine's project conversion mechanism and the purpose of the rename map, which is used to handle class name changes between versions. No advanced language features, complex algorithms, or design patterns are involved. The task is essentially a simple data update in a configuration-like structure, which is straightforward for anyone with basic experience in C++ (the language used in the Godot engine codebase).\n\n3. **Edge Cases and Error Handling**: The problem statement and logs mention errors related to the \"IP_Unix\" class and issues with data in arrays, but the provided code change does not address error handling or UI feedback directly. It only removes an obsolete or incorrect rename entry. While the broader issue (lack of user feedback during conversion failure) might involve additional work, the specific code change provided is not concerned with edge cases or complex error handling logic.\n\n4. **Overall Complexity**: The task appears to be a simple bug fix related to an outdated or incorrect entry in a rename map, which is causing the conversion process to fail. The minimal code change and the lack of need for deep architectural understanding or advanced technical knowledge make this a relatively easy problem to solve. However, it is slightly above \"Very Easy\" (0.0-0.2) because it requires some contextual understanding of the Godot engine's conversion process and the purpose of the rename map.\n\nIn summary, this problem is easy to address with the provided code change, requiring only a basic understanding of the relevant codebase section and a small, localized modification. The difficulty score of 0.25 reflects this simplicity while acknowledging the need for minimal domain-specific knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.25}
{"problem_statement": "Fix FBX ASCII files that have embedded textures with ufbx update\n### Tested versions\n\n- Reproducable in https://github.com/godotengine/godot/commit/394508d26dcf1b7a9362453f9009c07d969f1a7e\n\n### System information\n\nGodot v4.4.beta unknown - macOS Sequoia (15.3.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 Pro (Apple8) - Apple M2 Pro (12 threads)\n\n### Issue description\n\nUpdate from upstream ufbx developer @bqqbarbhg \n\ncommit 963b87ec4390fcae35f2bb197216fddd5b8eccf2 tag v0.17.0 fixes an actual (but quite rare) issue with FBX ASCII files that have embedded textures\n\nThe task is to update the ufbx library in Godot which is a copy, paste and update legal information.\n\n### Steps to reproduce\n\n- Download case from https://github.com/ufbx/ufbx/issues/177\n- Import with ufbx\n- Does not match expectations\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/drywolf/ufbx_base64_decode_bugfix\n\n", "patch": "diff --git a/modules/fbx/fbx_document.cpp b/modules/fbx/fbx_document.cpp\nindex d6c304d0564a..e62639ee58bd 100644\n--- a/modules/fbx/fbx_document.cpp\n+++ b/modules/fbx/fbx_document.cpp\n@@ -251,18 +251,16 @@ static bool _thread_pool_init_fn(void *user, ufbx_thread_pool_context ctx, const\n \treturn true;\n }\n \n-static bool _thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count) {\n+static void _thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count) {\n \tThreadPoolFBX *pool = (ThreadPoolFBX *)user;\n \tThreadPoolFBX::Group &pool_group = pool->groups[group];\n \tpool_group.start_index = start_index;\n \tpool_group.task_id = pool->pool->add_native_group_task(_thread_pool_task, &pool_group, (int)count, -1, true, \"ufbx\");\n-\treturn true;\n }\n \n-static bool _thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index) {\n+static void _thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index) {\n \tThreadPoolFBX *pool = (ThreadPoolFBX *)user;\n \tpool->pool->wait_for_group_task_completion(pool->groups[group].task_id);\n-\treturn true;\n }\n \n String FBXDocument::_gen_unique_name(HashSet<String> &unique_names, const String &p_name) {\ndiff --git a/thirdparty/README.md b/thirdparty/README.md\nindex 309508fc4e80..237c8fc904da 100644\n--- a/thirdparty/README.md\n+++ b/thirdparty/README.md\n@@ -976,7 +976,7 @@ Patches:\n ## ufbx\n \n - Upstream: https://github.com/ufbx/ufbx\n-- Version: 0.15.0 (24eea6f40929fe0f679b7950def378edb003afdb, 2024)\n+- Version: 0.17.1 (6ca5309972f03625e6990f3084ff4c1cc55a09b6, 2025)\n - License: MIT\n \n Files extracted from upstream source:\ndiff --git a/thirdparty/ufbx/ufbx.c b/thirdparty/ufbx/ufbx.c\nindex 77bd3dea623f..0e6f13d2f513 100644\n--- a/thirdparty/ufbx/ufbx.c\n+++ b/thirdparty/ufbx/ufbx.c\n@@ -600,7 +600,7 @@ extern \"C\" {\n \t#endif\n #endif\n \n-#if !defined(UFBX_STANDARD_C) && !defined(UFBX_NO_SSE) && (defined(_MSC_VER) && defined(_M_X64) && !defined(_M_ARM64EC)) || ((defined(__GNUC__) || defined(__clang__)) && defined(__x86_64__)) || defined(UFBX_USE_SSE)\n+#if defined(UFBX_USE_SSE) || (!defined(UFBX_STANDARD_C) && !defined(UFBX_NO_SSE) && ((defined(_MSC_VER) && defined(_M_X64) && !defined(_M_ARM64EC)) || ((defined(__GNUC__) || defined(__clang__)) && defined(__x86_64__))))\n \t#define UFBXI_HAS_SSE 1\n \t#include <xmmintrin.h>\n \t#include <emmintrin.h>\n@@ -830,7 +830,7 @@ ufbx_static_assert(sizeof_f64, sizeof(double) == 8);\n \n // -- Version\n \n-#define UFBX_SOURCE_VERSION ufbx_pack_version(0, 15, 0)\n+#define UFBX_SOURCE_VERSION ufbx_pack_version(0, 17, 1)\n ufbx_abi_data_def const uint32_t ufbx_source_version = UFBX_SOURCE_VERSION;\n \n ufbx_static_assert(source_header_version, UFBX_SOURCE_VERSION/1000u == UFBX_HEADER_VERSION/1000u);\n@@ -968,7 +968,7 @@ ufbx_static_assert(source_header_version, UFBX_SOURCE_VERSION/1000u == UFBX_HEAD\n \t#define ufbxi_regression_assert(cond) (void)0\n #endif\n \n-#if defined(UFBX_REGRESSION) || defined(UFBX_DEV)\n+#if defined(UFBX_REGRESSION) || defined(UFBX_DEV) || defined(UFBX_UBSAN)\n \t#define ufbxi_dev_assert(cond) ufbx_assert(cond)\n #else\n \t#define ufbxi_dev_assert(cond) (void)0\n@@ -1400,7 +1400,7 @@ static ufbxi_noinline void ufbxi_bigint_shift_left(ufbxi_bigint *bigint, uint32_\n \tbigint->length += words + (b.limbs[b.length - 1] >> 1 >> bits_down != 0 ? 1 : 0);\n \tb.limbs[b.length] = 0;\n \tif (b.length <= 3 && words <= 3) {\n-\t\tufbxi_bigint_limb l0 = ufbxi_maybe_uninit(b.length >= 0, b.limbs[0], ~0u);\n+\t\tufbxi_bigint_limb l0 = b.limbs[0];\n \t\tufbxi_bigint_limb l1 = ufbxi_maybe_uninit(b.length >= 1, b.limbs[1], ~0u);\n \t\tufbxi_bigint_limb l2 = ufbxi_maybe_uninit(b.length >= 2, b.limbs[2], ~0u);\n \t\tb.limbs[0] = 0;\n@@ -1491,6 +1491,7 @@ static ufbxi_noinline double ufbxi_parse_double(const char *str, size_t max_leng\n \t\t\t\tdigits = digits * 10 + (uint64_t)(c - '0');\n \t\t\t\tnum_digits++;\n \t\t\t\tif (num_digits >= 18) {\n+\t\t\t\t\tufbxi_dev_assert(num_digits < ufbxi_arraycount(ufbxi_pow5_tab));\n \t\t\t\t\tufbxi_bigint_mad(&big_mantissa, ufbxi_pow5_tab[num_digits] << num_digits, digits);\n \t\t\t\t\tdigits = 0;\n \t\t\t\t\tnum_digits = 0;\n@@ -1553,6 +1554,7 @@ static ufbxi_noinline double ufbxi_parse_double(const char *str, size_t max_leng\n \t\tbig_mantissa.length = (digits >> 32u) ? 2 : digits ? 1 : 0;\n \t\tif (big_mantissa.length == 0) return negative ? -0.0 : 0.0;\n \t} else {\n+\t\tufbxi_dev_assert(num_digits < ufbxi_arraycount(ufbxi_pow5_tab));\n \t\tufbxi_bigint_mad(&big_mantissa, ufbxi_pow5_tab[num_digits] << num_digits, digits);\n \t}\n \n@@ -6438,6 +6440,8 @@ typedef struct {\n \tbool parse_threaded;\n \tufbxi_thread_pool thread_pool;\n \n+\tuint8_t *base64_table;\n+\n } ufbxi_context;\n \n static ufbxi_noinline int ufbxi_fail_imp(ufbxi_context *uc, const char *cond, const char *func, uint32_t line)\n@@ -10009,6 +10013,66 @@ ufbxi_nodiscard static ufbxi_noinline int ufbxi_ascii_read_float_array(ufbxi_con\n \treturn 1;\n }\n \n+ufbxi_noinline static int ufbxi_setup_base64(ufbxi_context *uc)\n+{\n+\tuint8_t *table = ufbxi_push(&uc->tmp, uint8_t, 256);\n+\tufbxi_check(table);\n+\tuc->base64_table = table;\n+\n+\tmemset(table, 0x80, 256);\n+\tufbxi_nounroll for (char c = 'A'; c <= 'Z'; c++) table[(size_t)c] = (uint8_t)(c - 'A');\n+\tufbxi_nounroll for (char c = 'a'; c <= 'z'; c++) table[(size_t)c] = (uint8_t)(26 + (c - 'a'));\n+\tufbxi_nounroll for (char c = '0'; c <= '9'; c++) table[(size_t)c] = (uint8_t)(52 + (c - '0'));\n+\ttable[(size_t)'+'] = 62;\n+\ttable[(size_t)'/'] = 63;\n+\ttable[(size_t)'='] = 0x40;\n+\n+\treturn 1;\n+}\n+\n+ufbxi_noinline static int ufbxi_decode_base64(ufbxi_context *uc, ufbx_string *p_result, const char *src, size_t src_length, bool *p_failed)\n+{\n+\tif (!uc->base64_table) ufbxi_check(ufbxi_setup_base64(uc));\n+\n+\tuint8_t *table = uc->base64_table;\n+\tuint32_t error_mask = 0, pad_error = 0;\n+\n+\tchar *p = (char*)p_result->data;\n+\tfor (size_t i = 0; i + 4 <= src_length; i += 4) {\n+\t\tuint32_t a = table[(size_t)(uint8_t)src[i + 0]];\n+\t\tuint32_t b = table[(size_t)(uint8_t)src[i + 1]];\n+\t\tuint32_t c = table[(size_t)(uint8_t)src[i + 2]];\n+\t\tuint32_t d = table[(size_t)(uint8_t)src[i + 3]];\n+\t\tpad_error = error_mask;\n+\t\terror_mask |= a | b | c | d;\n+\n+\t\tp[0] = (char)(uint8_t)(a << 2 | b >> 4);\n+\t\tp[1] = (char)(uint8_t)(b << 4 | c >> 2);\n+\t\tp[2] = (char)(uint8_t)(c << 6 | d);\n+\t\tp += 3;\n+\t}\n+\n+\tif (src_length >= 4) {\n+\t\tconst char *end = src + src_length - 4;\n+\t\tuint32_t padding = 0;\n+\t\tpadding |= end[0] == '=' ? 0x8 : 0x0;\n+\t\tpadding |= end[1] == '=' ? 0x4 : 0x0;\n+\t\tpadding |= end[2] == '=' ? 0x2 : 0x0;\n+\t\tpadding |= end[3] == '=' ? 0x1 : 0x0;\n+\t\tif (padding <= 0x1) p -= padding; // \"xxx=\" or \"xxxx\"\n+\t\telse if (padding == 0x3) p -= 2;  // \"xx==\"\n+\t\telse pad_error |= 0x40;           // anything else\n+\t}\n+\n+\tif (((error_mask & 0x80) != 0 || (pad_error & 0x40) != 0 || src_length % 4 != 0) && !*p_failed) {\n+\t\tufbxi_check(ufbxi_warnf(UFBX_WARNING_BAD_BASE64_CONTENT, \"Ignored bad base64 embedded content\"));\n+\t\t*p_failed = true;\n+\t}\n+\n+\tp_result->length = ufbxi_to_size(p - p_result->data);\n+\treturn 1;\n+}\n+\n // Recursion limited by check at the start\n ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *uc, uint32_t depth, ufbxi_parse_state parent_state, bool *p_end, ufbxi_buf *tmp_buf, bool recursive)\n \tufbxi_recursive_function(int, ufbxi_ascii_parse_node, (uc, depth, parent_state, p_end, tmp_buf, recursive), UFBXI_MAX_NODE_DEPTH + 1,\n@@ -10054,6 +10118,7 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *\n \tint arr_type = 0;\n \tufbxi_buf *arr_buf = NULL;\n \tsize_t arr_elem_size = 0;\n+\tbool arr_error = false;\n \n \t// Check if the values of the node we're parsing currently should be\n \t// treated as an array.\n@@ -10134,13 +10199,16 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *\n \t\t\t\t\tbool raw = arr_type == 's';\n \t\t\t\t\tufbx_string *v = ufbxi_push(&uc->tmp_stack, ufbx_string, 1);\n \t\t\t\t\tufbxi_check(v);\n-\t\t\t\t\tv->data = tok->str_data;\n-\t\t\t\t\tv->length = tok->str_len;\n \t\t\t\t\tif (arr_type == 'C') {\n \t\t\t\t\t\tufbxi_buf *buf = uc->opts.retain_dom ? &uc->result : tmp_buf;\n-\t\t\t\t\t\tv->data = ufbxi_push_copy(buf, char, v->length, v->data);\n+\t\t\t\t\t\tsize_t capacity = tok->str_len / 4 * 3 + 3;\n+\t\t\t\t\t\tv->data = ufbxi_push(buf, char, capacity);\n \t\t\t\t\t\tufbxi_check(v->data);\n+\t\t\t\t\t\tufbxi_check(ufbxi_decode_base64(uc, v, tok->str_data, tok->str_len, &arr_error));\n+\t\t\t\t\t\tufbx_assert(v->length <= capacity);\n \t\t\t\t\t} else {\n+\t\t\t\t\t\tv->data = tok->str_data;\n+\t\t\t\t\t\tv->length = tok->str_len;\n \t\t\t\t\t\tufbxi_check(ufbxi_push_string_place_str(&uc->string_pool, v, raw));\n \t\t\t\t\t}\n \t\t\t\t} else {\n@@ -10324,6 +10392,10 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_ascii_parse_node(ufbxi_context *\n \t\t\t\tif (num_values > 0) {\n \t\t\t\t\tufbxi_pop_size(&uc->tmp_stack, arr_elem_size, num_values, arr_data, false);\n \t\t\t\t}\n+\t\t\t} else if (arr_error) {\n+\t\t\t\tufbxi_pop_size(&uc->tmp_stack, arr_elem_size, num_values, NULL, false);\n+\t\t\t\tnum_values = 0;\n+\t\t\t\tarr_data = (void*)ufbxi_zero_size_buffer;\n \t\t\t} else {\n \t\t\t\tarr_data = ufbxi_push_pop_size(arr_buf, &uc->tmp_stack, arr_elem_size, num_values);\n \t\t\t}\n@@ -11454,28 +11526,6 @@ ufbxi_nodiscard static ufbxi_noinline int ufbxi_load_maps(ufbxi_context *uc)\n \n // -- Reading the parsed data\n \n-ufbxi_noinline static void ufbxi_decode_base64(char *dst, const char *src, size_t src_length)\n-{\n-\tuint8_t table[256] = { 0 };\n-\tfor (char c = 'A'; c <= 'Z'; c++) table[(size_t)c] = (uint8_t)(c - 'A');\n-\tfor (char c = 'a'; c <= 'z'; c++) table[(size_t)c] = (uint8_t)(26 + (c - 'a'));\n-\tfor (char c = '0'; c <= '9'; c++) table[(size_t)c] = (uint8_t)(52 + (c - '0'));\n-\ttable[(size_t)'+'] = 62;\n-\ttable[(size_t)'/'] = 63;\n-\n-\tfor (size_t i = 0; i + 4 <= src_length; i += 4) {\n-\t\tuint32_t a = table[(size_t)(uint8_t)src[i + 0]];\n-\t\tuint32_t b = table[(size_t)(uint8_t)src[i + 1]];\n-\t\tuint32_t c = table[(size_t)(uint8_t)src[i + 2]];\n-\t\tuint32_t d = table[(size_t)(uint8_t)src[i + 3]];\n-\n-\t\tdst[0] = (char)(uint8_t)(a << 2 | b >> 4);\n-\t\tdst[1] = (char)(uint8_t)(b << 4 | c >> 2);\n-\t\tdst[2] = (char)(uint8_t)(c << 6 | d);\n-\t\tdst += 3;\n-\t}\n-}\n-\n ufbxi_nodiscard ufbxi_noinline static int ufbxi_read_embedded_blob(ufbxi_context *uc, ufbx_blob *dst_blob, ufbxi_node *node)\n {\n \tif (!node) return 1;\n@@ -11485,15 +11535,15 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_read_embedded_blob(ufbxi_context\n \t\tufbx_string content;\n \t\tsize_t num_parts = content_arr->size;\n \t\tufbx_string *parts = (ufbx_string*)content_arr->data;\n-\t\tif (num_parts == 1) {\n+\n+\t\tif (num_parts == 1 && !uc->from_ascii) {\n \t\t\tcontent = parts[0];\n \t\t} else {\n \t\t\tsize_t total_size = 0;\n \t\t\tufbxi_for(ufbx_string, part, parts, num_parts) {\n \t\t\t\ttotal_size += part->length;\n \t\t\t}\n-\t\t\tufbxi_buf *dst_buf = uc->from_ascii ? &uc->tmp_parse : &uc->result;\n-\t\t\tchar *dst = ufbxi_push(dst_buf, char, total_size);\n+\t\t\tchar *dst = ufbxi_push(&uc->result, char, total_size);\n \t\t\tufbxi_check(dst);\n \t\t\tcontent.data = dst;\n \t\t\tcontent.length = total_size;\n@@ -11503,23 +11553,8 @@ ufbxi_nodiscard ufbxi_noinline static int ufbxi_read_embedded_blob(ufbxi_context\n \t\t\t}\n \t\t}\n \n-\t\tif (uc->from_ascii) {\n-\t\t\tif (content.length % 4 == 0) {\n-\t\t\t\tsize_t padding = 0;\n-\t\t\t\twhile (padding < 2 && padding < content.length && content.data[content.length - 1 - padding] == '=') {\n-\t\t\t\t\tpadding++;\n-\t\t\t\t}\n-\n-\t\t\t\tdst_blob->size = content.length / 4 * 3 - padding;\n-\t\t\t\tdst_blob->data = ufbxi_push(&uc->result, char, dst_blob->size + 3);\n-\t\t\t\tufbxi_check(dst_blob->data);\n-\n-\t\t\t\tufbxi_decode_base64((char*)dst_blob->data, content.data, content.length);\n-\t\t\t}\n-\t\t} else {\n-\t\t\tdst_blob->data = content.data;\n-\t\t\tdst_blob->size = content.length;\n-\t\t}\n+\t\tdst_blob->data = content.data;\n+\t\tdst_blob->size = content.length;\n \t}\n \n \treturn 1;\ndiff --git a/thirdparty/ufbx/ufbx.h b/thirdparty/ufbx/ufbx.h\nindex 1fc9a103655b..8cd336fe776f 100644\n--- a/thirdparty/ufbx/ufbx.h\n+++ b/thirdparty/ufbx/ufbx.h\n@@ -267,7 +267,7 @@ struct ufbx_converter { };\n // `ufbx_source_version` contains the version of the corresponding source file.\n // HINT: The version can be compared numerically to the result of `ufbx_pack_version()`,\n // for example `#if UFBX_VERSION >= ufbx_pack_version(0, 12, 0)`.\n-#define UFBX_HEADER_VERSION ufbx_pack_version(0, 15, 0)\n+#define UFBX_HEADER_VERSION ufbx_pack_version(0, 17, 1)\n #define UFBX_VERSION UFBX_HEADER_VERSION\n \n // -- Basic types\n@@ -1354,7 +1354,7 @@ struct ufbx_mesh {\n \t// The winding of the faces has been reversed.\n \tbool reversed_winding;\n \n-\t// Normals have been generated instead of evalauted.\n+\t// Normals have been generated instead of evaluated.\n \t// Either from missing normals (via `ufbx_load_opts.generate_missing_normals`), skinning,\n \t// tessellation, or subdivision.\n \tbool generated_normals;\n@@ -1566,7 +1566,7 @@ struct ufbx_camera {\n \t// Projection mode (perspective/orthographic).\n \tufbx_projection_mode projection_mode;\n \n-\t// If set to `true`, `resolution` reprensents actual pixel values, otherwise\n+\t// If set to `true`, `resolution` represents actual pixel values, otherwise\n \t// it's only useful for its aspect ratio.\n \tbool resolution_is_pixels;\n \n@@ -3509,6 +3509,9 @@ typedef enum ufbx_warning_type UFBX_ENUM_REPR {\n \t// HINT: You can use `ufbx_unicode_error_handling` to adjust behavior.\n \tUFBX_WARNING_BAD_UNICODE,\n \n+\t// Invalid base64-encoded embedded content ignored.\n+\tUFBX_WARNING_BAD_BASE64_CONTENT,\n+\n \t// Non-node element connected to root.\n \tUFBX_WARNING_BAD_ELEMENT_CONNECTED_TO_ROOT,\n \n@@ -4085,7 +4088,8 @@ typedef struct ufbx_open_memory_opts {\n \tuint32_t _end_zero;\n } ufbx_open_memory_opts;\n \n-// Detailed error stack frame\n+// Detailed error stack frame.\n+// NOTE: You must compile `ufbx.c` with `UFBX_ENABLE_ERROR_STACK` to enable the error stack.\n typedef struct ufbx_error_frame {\n \tuint32_t source_line;\n \tufbx_string function;\n@@ -4183,30 +4187,48 @@ UFBX_ENUM_TYPE(ufbx_error_type, UFBX_ERROR_TYPE, UFBX_ERROR_DUPLICATE_OVERRIDE);\n // Error description with detailed stack trace\n // HINT: You can use `ufbx_format_error()` for formatting the error\n typedef struct ufbx_error {\n+\n+\t// Type of the error, or `UFBX_ERROR_NONE` if successful.\n \tufbx_error_type type;\n+\n+\t// Description of the error type.\n \tufbx_string description;\n+\n+\t// Internal error stack.\n+\t// NOTE: You must compile `ufbx.c` with `UFBX_ENABLE_ERROR_STACK` to enable the error stack.\n \tuint32_t stack_size;\n \tufbx_error_frame stack[UFBX_ERROR_STACK_MAX_DEPTH];\n+\n+\t// Additional error information, such as missing file filename.\n+\t// `info` is a NULL-terminated UTF-8 string containing `info_length` bytes, excluding the trailing `'\\0'`.\n \tsize_t info_length;\n \tchar info[UFBX_ERROR_INFO_LENGTH];\n+\n } ufbx_error;\n \n // -- Progress callbacks\n \n+// Loading progress information.\n typedef struct ufbx_progress {\n \tuint64_t bytes_read;\n \tuint64_t bytes_total;\n } ufbx_progress;\n \n+// Progress result returned from `ufbx_progress_fn()` callback.\n+// Determines whether ufbx should continue or abort the loading.\n typedef enum ufbx_progress_result UFBX_ENUM_REPR {\n+\n+\t// Continue loading the file.\n \tUFBX_PROGRESS_CONTINUE = 0x100,\n+\n+\t// Cancel loading and fail with `UFBX_ERROR_CANCELLED`.\n \tUFBX_PROGRESS_CANCEL = 0x200,\n \n \tUFBX_ENUM_FORCE_WIDTH(UFBX_PROGRESS_RESULT)\n } ufbx_progress_result;\n \n-// Called periodically with the current progress\n-// Return `false` to cancel further processing\n+// Called periodically with the current progress.\n+// Return `UFBX_PROGRESS_CANCEL` to cancel further processing.\n typedef ufbx_progress_result ufbx_progress_fn(void *user, const ufbx_progress *progress);\n \n typedef struct ufbx_progress_cb {\n@@ -4509,33 +4531,71 @@ typedef struct ufbx_baked_anim {\n } ufbx_baked_anim;\n \n // -- Thread API\n-//\n-// NOTE: This API is still experimental and may change.\n-// Documentation is currently missing on purpose.\n \n+// Internal thread pool handle.\n+// Passed to `ufbx_thread_pool_run_task()` from an user thread to run ufbx tasks.\n+// HINT: This context can store a user pointer via `ufbx_thread_pool_set_user_ptr()`.\n typedef uintptr_t ufbx_thread_pool_context;\n \n+// Thread pool creation information from ufbx.\n typedef struct ufbx_thread_pool_info {\n \tuint32_t max_concurrent_tasks;\n } ufbx_thread_pool_info;\n \n+// Initialize the thread pool.\n+// Return `true` on success.\n typedef bool ufbx_thread_pool_init_fn(void *user, ufbx_thread_pool_context ctx, const ufbx_thread_pool_info *info);\n-typedef bool ufbx_thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count);\n-typedef bool ufbx_thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index);\n+\n+// Run tasks `count` tasks in threads.\n+// You must call `ufbx_thread_pool_run_task()` with indices `[start_index, start_index + count)`.\n+// The threads are launched in batches indicated by `group`, see `UFBX_THREAD_GROUP_COUNT` for more information.\n+// Ideally, you should run all the task indices in parallel within each `ufbx_thread_pool_run_fn()` call.\n+typedef void ufbx_thread_pool_run_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t start_index, uint32_t count);\n+\n+// Wait for previous tasks spawned in `ufbx_thread_pool_run_fn()` to finish.\n+// `group` specifies the batch to wait for, `max_index` contains `start_index + count` from that group instance.\n+typedef void ufbx_thread_pool_wait_fn(void *user, ufbx_thread_pool_context ctx, uint32_t group, uint32_t max_index);\n+\n+// Free the thread pool.\n typedef void ufbx_thread_pool_free_fn(void *user, ufbx_thread_pool_context ctx);\n \n+// Thread pool interface.\n+// See functions above for more information.\n+//\n+// Hypothetical example of calls, where `UFBX_THREAD_GROUP_COUNT=2` for simplicity:\n+//\n+//   run_fn(group=0, start_index=0, count=4)   -> t0 := threaded { ufbx_thread_pool_run_task(0..3) }\n+//   run_fn(group=1, start_index=4, count=10)  -> t1 := threaded { ufbx_thread_pool_run_task(4..10) }\n+//   wait_fn(group=0, max_index=4)             -> wait_threads(t0)\n+//   run_fn(group=0, start_index=10, count=15) -> t0 := threaded { ufbx_thread_pool_run_task(10..14) }\n+//   wait_fn(group=1, max_index=10)            -> wait_threads(t1)\n+//   wait_fn(group=0, max_index=15)            -> wait_threads(t0)\n+//\n typedef struct ufbx_thread_pool {\n-\tufbx_thread_pool_init_fn *init_fn;\n-\tufbx_thread_pool_run_fn *run_fn;\n-\tufbx_thread_pool_wait_fn *wait_fn;\n-\tufbx_thread_pool_free_fn *free_fn;\n+\tufbx_thread_pool_init_fn *init_fn; // < Optional\n+\tufbx_thread_pool_run_fn *run_fn;   // < Required\n+\tufbx_thread_pool_wait_fn *wait_fn; // < Required\n+\tufbx_thread_pool_free_fn *free_fn; // < Optional\n \tvoid *user;\n } ufbx_thread_pool;\n \n+// Thread pool options.\n typedef struct ufbx_thread_opts {\n+\n+\t// Thread pool interface.\n+\t// HINT: You can use `extra/ufbx_os.h` to provide a thread pool.\n \tufbx_thread_pool pool;\n+\n+\t// Maximum of tasks to have in-flight.\n+\t// Default: 2048\n \tsize_t num_tasks;\n+\n+\t// Maximum amount of memory to use for batched threaded processing.\n+\t// Default: 32MB\n+\t// NOTE: The actual used memory usage might be higher, if there are individual tasks\n+\t// that rqeuire a high amount of memory.\n \tsize_t memory_limit;\n+\n } ufbx_thread_opts;\n \n // -- Main API\n@@ -5202,7 +5262,7 @@ ufbx_abi ufbx_string ufbx_find_string(const ufbx_props *props, const char *name,\n ufbx_abi ufbx_blob ufbx_find_blob_len(const ufbx_props *props, const char *name, size_t name_len, ufbx_blob def);\n ufbx_abi ufbx_blob ufbx_find_blob(const ufbx_props *props, const char *name, ufbx_blob def);\n \n-// Find property in `props` with concatendated `parts[num_parts]`.\n+// Find property in `props` with concatenated `parts[num_parts]`.\n ufbx_abi ufbx_prop *ufbx_find_prop_concat(const ufbx_props *props, const ufbx_string *parts, size_t num_parts);\n \n // Get an element connected to a property.\n", "instance_id": "godotengine__godot-102538", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in its intent to update the ufbx library within the Godot engine to version 0.17.1 to fix a rare issue with FBX ASCII files containing embedded textures. It provides context about the issue, references to the upstream commit, and steps to reproduce the problem. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not explicitly detail the expected behavior after the update (beyond \"does not match expectations\"), nor does it specify potential risks or compatibility issues with the update. Additionally, while a minimal reproduction project is provided, there are no explicit test cases or expected outputs to validate the fix. Constraints or potential side effects of updating the library are also not mentioned, which could be critical for such a third-party dependency update. Overall, the statement is valid and mostly clear but lacks some finer details and thoroughness in edge case documentation or post-update validation steps.", "difficulty_explanation": "The difficulty of this task falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The task primarily involves updating the ufbx library to a newer version (v0.17.1) within the Godot engine. The code changes provided show modifications across a few files (`fbx_document.cpp`, `README.md`, `ufbx.c`, and `ufbx.h`), but the bulk of the changes are within the third-party library code itself, which appears to be a direct replacement or update from the upstream source. The changes in `fbx_document.cpp` are minimal, adjusting function signatures for compatibility with the updated library. The task does not seem to impact the broader system architecture significantly, as it is mostly a library update with localized integration adjustments. The amount of code change is moderate but largely mechanical (e.g., version number updates, copying new library code).\n\n2. **Clarity and Complexity of Problem Description**: As noted in the clarity score, the problem is mostly clear but lacks some specifics. This slightly increases the difficulty as the developer may need to infer or investigate the exact impact of the update or validate the fix against the referenced issue.\n\n3. **Number of Technical Concepts**: The task requires understanding of C/C++ (given the codebase), third-party library integration, and potentially some domain knowledge of FBX file formats and texture embedding. Specific changes in `ufbx.c` involve base64 decoding logic and handling of embedded content, which requires a basic understanding of data encoding and parsing. Additionally, there are minor threading API adjustments (e.g., changing return types from `bool` to `void` in thread pool functions), which require familiarity with the library's threading model. However, these concepts are not overly complex for a developer with moderate experience in systems programming.\n\n4. **Edge Cases and Error Handling**: The updated library code introduces new error handling for base64 decoding (e.g., `UFBX_WARNING_BAD_BASE64_CONTENT`), which suggests attention to edge cases like invalid base64 content. However, the problem statement does not explicitly call out additional edge cases or error conditions beyond the primary issue with embedded textures in FBX ASCII files. The code changes handle these cases within the library, reducing the burden on the integrator to some extent, though validation of these edge cases might be necessary.\n\nOverall, this task is relatively straightforward for a developer familiar with integrating third-party libraries and performing version updates. It requires understanding some specific logic (e.g., base64 decoding improvements) and ensuring compatibility with the existing codebase, but it does not involve deep architectural changes or highly complex problem-solving. The score of 0.35 reflects an \"Easy\" task with a slight increase due to the need for validation and potential minor integration challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.35}
{"problem_statement": "LightmapGI appears too saturated with static colored lights since 4.4.beta1\n### Tested versions\n\n- Reproducible in: 4.4.beta1, 4.4.beta2\n- Not reproducible in: 4.3.stable, 4.4.dev7\n\n### System information\n\nGodot v4.4.beta (cb460ad42) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (nvidia; 565.77) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nLightmaps appear too saturated when baking colored lights that have the **Static** global illumination mode:\n\n### 4.3.stable up to 4.4.dev7\n\n![Image](https://github.com/user-attachments/assets/f8ec7300-2107-42e7-88b2-1ae85f3f1f90)\n\n### 4.4.beta1 onwards\n\n![Image](https://github.com/user-attachments/assets/8cf1fae6-1200-4368-b8c1-88da0375cf6f)\n\nThis affects both directional and non-directional lightmaps, regardless of their texture's compression mode (i.e. it's not caused by VRAM compression). Maybe a sRGB/linear conversion is missing somewhere?\n\nI bisected the regression to cb460ad421977082fa987fcc90ac1d6b63cd0376. cc @Geometror \n\n### Steps to reproduce\n\n- Bake lightmaps with colored lights that have the **Static** global illumination mode.\n\n### Minimal reproduction project (MRP)\n\n[test_lightmap_directional_compress.zip](https://github.com/user-attachments/files/16882023/test_lightmap_directional_compress.zip)\n\nLightmapGI nodes are in `static.tscn` and `static_directional.tscn`.\n", "patch": "diff --git a/modules/lightmapper_rd/lm_compute.glsl b/modules/lightmapper_rd/lm_compute.glsl\nindex ea7044c57109..9c05b42e8e72 100644\n--- a/modules/lightmapper_rd/lm_compute.glsl\n+++ b/modules/lightmapper_rd/lm_compute.glsl\n@@ -648,7 +648,7 @@ void trace_direct_light(vec3 p_position, vec3 p_normal, uint p_light_index, bool\n \t}\n \n \tr_shadow = penumbra;\n-\tr_light = light_data.color * light_data.energy * attenuation * penumbra * penumbra_color;\n+\tr_light = light_data.energy * attenuation * penumbra * penumbra_color;\n }\n \n #endif\n", "instance_id": "godotengine__godot-102424", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: lightmaps appear too saturated when baking colored lights with the \"Static\" global illumination mode in specific versions of the Godot engine (4.4.beta1 onwards). It provides useful context such as the affected versions, system information, visual comparisons via images, steps to reproduce, and a minimal reproduction project (MRP). Additionally, the regression is bisected to a specific commit, which is helpful for debugging. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"too saturated\" means in technical terms (e.g., is it a color space conversion issue, a multiplication factor, or something else?). While it suggests a possible cause (\"Maybe a sRGB/linear conversion is missing\"), it lacks specificity on the expected behavior or the exact nature of the fix. Edge cases or specific constraints (e.g., does this affect all light types equally, or are there specific configurations that exacerbate the issue?) are also not detailed. Overall, the statement is clear enough to understand the issue and start investigating, but it leaves some room for interpretation.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) for several reasons. First, the scope of the code change is minimal, as shown in the diff: it involves a single line modification in a GLSL shader file (`lm_compute.glsl`), removing the multiplication of `light_data.color` from the computation of `r_light`. This suggests the fix is straightforward, likely addressing an over-application of color in the light calculation. Second, the technical concepts required to solve this are relatively basic for someone familiar with graphics programming: understanding shader logic, light calculations, and possibly color space handling (e.g., sRGB vs. linear). However, it does require some domain-specific knowledge of the Godot engine's lightmapping system and how static lights are processed, which adds a slight layer of complexity. Third, the problem does not appear to impact the broader architecture of the codebase, as the change is isolated to a single computation in a shader. Fourth, edge cases and error handling do not seem to be a significant concern based on the problem statement or the code change, though there might be implicit considerations (e.g., ensuring the change doesn't break other light types or configurations). Overall, while the problem requires some understanding of graphics programming and the specific codebase, the fix itself is simple and localized, making it an easy-to-moderate task for a developer with relevant experience.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.35}
{"problem_statement": "\"Unhandled XServer error\" is printed every time the project is stopped when running from the editor with game embedding\n### Tested versions\n\n- Reproducible in: 4.4.beta b15b24b08\n- Not reproducible in: 4.4.beta1\n\n### System information\n\nGodot v4.4.beta (b15b24b08) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (nvidia; 565.77) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\n\"Unhandled XServer error\" is printed every time the project is stopped when running from the editor with game embedding:\n\n```\nERROR: Unhandled XServer error: BadWindow (invalid Window parameter)\n   Major opcode of failed request: 25\n   Serial number of failed request: 0\n   Current serial number in output stream: 53707\n   at: default_window_error_handler (platform/linuxbsd/x11/display_server_x11.cpp:1180)\n```\n\nSome notes: \n\n- This occurs regardless of the game embedding type (within the editor or as a floating window), as long as game embedding is used.\n- This does not occur when running the project without the editor, or with game window embedding disabled.\n- There appears to be no negative consequences to this error, but it's annoying to see in the Output panel regardless.\n- This only occurs when quitting by pressing <kbd>F8</kbd>. Pressing <kbd>Alt + F4</kbd>, pressing the window manager's close button at the top of the window (for the floating window).\n- **However**, if you press <kbd>Alt + F4</kbd> with the game window embedded in the editor (not floating) and the game window is focused, the error will also occur. This also occurs if you use `xkill` and target the running project window.\n\n### Steps to reproduce\n\n- Create a new project, add any node and run it with game window embedding enabled.\n- Stop the project by pressing <kbd>F8</kbd>.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex b1945eb47a2e..3a8d6ff6c584 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -5853,16 +5853,20 @@ Error DisplayServerX11::remove_embedded_process(OS::ProcessID p_pid) {\n \t// Handle bad window errors silently because just in case the embedded window was closed.\n \tint (*oldHandler)(Display *, XErrorEvent *) = XSetErrorHandler(&bad_window_error_handler);\n \n-\t// Send the message to gracefully close the window.\n-\tXEvent ev;\n-\tmemset(&ev, 0, sizeof(ev));\n-\tev.xclient.type = ClientMessage;\n-\tev.xclient.window = ep->process_window;\n-\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n-\tev.xclient.format = 32;\n-\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n-\tev.xclient.data.l[1] = CurrentTime;\n-\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\t// Check if the window is still valid.\n+\tXWindowAttributes attr;\n+\tif (XGetWindowAttributes(x11_display, ep->process_window, &attr)) {\n+\t\t// Send the message to gracefully close the window.\n+\t\tXEvent ev;\n+\t\tmemset(&ev, 0, sizeof(ev));\n+\t\tev.xclient.type = ClientMessage;\n+\t\tev.xclient.window = ep->process_window;\n+\t\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n+\t\tev.xclient.format = 32;\n+\t\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n+\t\tev.xclient.data.l[1] = CurrentTime;\n+\t\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\t}\n \n \t// Restore default error handler.\n \tXSetErrorHandler(oldHandler);\n", "instance_id": "godotengine__godot-102045", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the specific error message (\"Unhandled XServer error: BadWindow\"), the conditions under which it occurs (e.g., stopping the project with game embedding enabled using F8), and the environments where it is reproducible (Godot v4.4.beta). It also includes steps to reproduce the issue and specifies when the error does not occur, which helps narrow down the context. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or resolution (e.g., should the error be suppressed, or is there an underlying issue to fix?). Additionally, while it mentions no negative consequences, it lacks clarity on whether this is purely a cosmetic issue or if there are subtle impacts not yet identified. Edge cases are partially covered (e.g., different ways to close the window), but not exhaustively analyzed. Overall, it is clear enough to understand the issue but misses some precision in defining the goal of the fix.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is limited to a single file (`display_server_x11.cpp`) and a specific function (`remove_embedded_process`), with a small and focused modification (adding a check for window validity before sending a close message). This does not impact the broader system architecture or require changes across multiple modules. Second, the technical concepts involved are relatively straightforward: understanding X11 window management (specifically `XGetWindowAttributes` and `XSendEvent`), basic error handling in the X11 context, and C++ syntax. These concepts are not overly complex for someone with moderate experience in systems programming or Linux graphics APIs. Third, the problem does not introduce significant edge cases beyond what is already handled by the error handler setup in the code, and the change itself is a simple guard condition to prevent the error from being triggered. However, it does require some domain-specific knowledge of X11, which slightly elevates the difficulty above \"Very Easy.\" Overall, this is a manageable bug fix that requires understanding a specific part of the codebase and applying a targeted solution, justifying a score of 0.35.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.35}
{"problem_statement": "[Web] `Input.mouse_mode` returns wrong value\n### Tested versions\n\n- Reproducible in v4.4.dev4.official [36e6207bb]\n- Reproducible in v4.4.dev7.official [46c8f8c5c]\n- Not reproducible in v4.4.dev3.official [f4af8201b]\n\n### System information\n\nGodot v4.4.dev4 - CachyOS Linux #1 SMP PREEMPT_DYNAMIC Thu, 19 Dec 2024 21:23:18 +0000 on Wayland - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (nvidia; 565.77) - Intel(R) Core(TM) i7-9700K CPU @ 3.60GHz (8 threads), Web export tested under Firefox 133.0.3 (64-bit)\n\n### Issue description\n\nIn **web exports** `Input.mouse_mode` sometimes returns `MouseMode.MOUSE_MODE_VISIBLE` despite setting it to `MouseMode.MOUSE_MODE_CAPTURED` and behaving like it is captured.\n\n### Steps to reproduce\n\n1. open \"Window Management\" from [official demo projects](https://github.com/godotengine/godot-demo-projects/tree/master/misc/window_management)\n2. add web export, run the project in browser (Remote Debug)\n3. click on the MOUSE_MODE_CAPTURED button or press <kbd>F3</kbd>\n4. Extra hints should appear below all the MouseModes buttons:\n\n> ESC: Deactivate MOUSE_MODE_CAPTURED\n> W, S: Move forward, backward\n> A, D: Strafe left, right\n\nAt least they do in v4.4.dev3 but not in v4.4.dev4 anymore since the condition `Input.get_mouse_mode() == Input.MOUSE_MODE_CAPTURED` evaluates to `false`.\n\nThere is a case, when this evaluates to `true`:\n1. run the project in browser anew or refresh the page\n2. click somewhere inside the window, on the cube for example\n3. press <kbd>F3</kbd>, <kbd>F1</kbd>, <kbd>F3</kbd> in that order.\n4. Notice extra hints being shown also in `v4.4.dev4` or `v4.4.dev7`\n \n\n### Minimal reproduction project (MRP)\n\n\"Window Management\" official demo project (https://github.com/godotengine/godot-demo-projects/tree/master/misc/window_management)\n", "patch": "diff --git a/core/input/input.cpp b/core/input/input.cpp\nindex 4413c426cf09..b705968b87ed 100644\n--- a/core/input/input.cpp\n+++ b/core/input/input.cpp\n@@ -77,6 +77,10 @@ Input *Input::singleton = nullptr;\n \n void (*Input::set_mouse_mode_func)(Input::MouseMode) = nullptr;\n Input::MouseMode (*Input::get_mouse_mode_func)() = nullptr;\n+void (*Input::set_mouse_mode_override_func)(Input::MouseMode) = nullptr;\n+Input::MouseMode (*Input::get_mouse_mode_override_func)() = nullptr;\n+void (*Input::set_mouse_mode_override_enabled_func)(bool) = nullptr;\n+bool (*Input::is_mouse_mode_override_enabled_func)() = nullptr;\n void (*Input::warp_mouse_func)(const Vector2 &p_position) = nullptr;\n Input::CursorShape (*Input::get_current_cursor_shape_func)() = nullptr;\n void (*Input::set_custom_mouse_cursor_func)(const Ref<Resource> &, Input::CursorShape, const Vector2 &) = nullptr;\n@@ -86,51 +90,29 @@ Input *Input::get_singleton() {\n }\n \n void Input::set_mouse_mode(MouseMode p_mode) {\n-\tERR_FAIL_INDEX((int)p_mode, 5);\n-\n-\tif (p_mode == mouse_mode) {\n-\t\treturn;\n-\t}\n-\n-\t// Allow to be set even if overridden, to see if the platform allows the mode.\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n \tset_mouse_mode_func(p_mode);\n-\tmouse_mode = get_mouse_mode_func();\n-\n-\tif (mouse_mode_override_enabled) {\n-\t\tset_mouse_mode_func(mouse_mode_override);\n-\t}\n }\n \n Input::MouseMode Input::get_mouse_mode() const {\n-\treturn mouse_mode;\n+\treturn get_mouse_mode_func();\n }\n \n-void Input::set_mouse_mode_override_enabled(bool p_enabled) {\n-\tif (p_enabled == mouse_mode_override_enabled) {\n-\t\treturn;\n-\t}\n-\n-\tmouse_mode_override_enabled = p_enabled;\n-\n-\tif (p_enabled) {\n-\t\tset_mouse_mode_func(mouse_mode_override);\n-\t\tmouse_mode_override = get_mouse_mode_func();\n-\t} else {\n-\t\tset_mouse_mode_func(mouse_mode);\n-\t}\n+void Input::set_mouse_mode_override(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tset_mouse_mode_override_func(p_mode);\n }\n \n-void Input::set_mouse_mode_override(MouseMode p_mode) {\n-\tERR_FAIL_INDEX((int)p_mode, 5);\n+Input::MouseMode Input::get_mouse_mode_override() const {\n+\treturn get_mouse_mode_override_func();\n+}\n \n-\tif (p_mode == mouse_mode_override) {\n-\t\treturn;\n-\t}\n+void Input::set_mouse_mode_override_enabled(bool p_override_enabled) {\n+\tset_mouse_mode_override_enabled_func(p_override_enabled);\n+}\n \n-\tif (mouse_mode_override_enabled) {\n-\t\tset_mouse_mode_func(p_mode);\n-\t\tmouse_mode_override = get_mouse_mode_func();\n-\t}\n+bool Input::is_mouse_mode_override_enabled() {\n+\treturn is_mouse_mode_override_enabled_func();\n }\n \n void Input::_bind_methods() {\n@@ -199,6 +181,7 @@ void Input::_bind_methods() {\n \tBIND_ENUM_CONSTANT(MOUSE_MODE_CAPTURED);\n \tBIND_ENUM_CONSTANT(MOUSE_MODE_CONFINED);\n \tBIND_ENUM_CONSTANT(MOUSE_MODE_CONFINED_HIDDEN);\n+\tBIND_ENUM_CONSTANT(MOUSE_MODE_MAX);\n \n \tBIND_ENUM_CONSTANT(CURSOR_ARROW);\n \tBIND_ENUM_CONSTANT(CURSOR_IBEAM);\ndiff --git a/core/input/input.h b/core/input/input.h\nindex 6893c4b997b4..bbe185de3cbc 100644\n--- a/core/input/input.h\n+++ b/core/input/input.h\n@@ -47,12 +47,14 @@ class Input : public Object {\n \tstatic constexpr uint64_t MAX_EVENT = 32;\n \n public:\n+\t// Keep synced with \"DisplayServer::MouseMode\" enum.\n \tenum MouseMode {\n \t\tMOUSE_MODE_VISIBLE,\n \t\tMOUSE_MODE_HIDDEN,\n \t\tMOUSE_MODE_CAPTURED,\n \t\tMOUSE_MODE_CONFINED,\n \t\tMOUSE_MODE_CONFINED_HIDDEN,\n+\t\tMOUSE_MODE_MAX,\n \t};\n \n #undef CursorShape\n@@ -105,10 +107,6 @@ class Input : public Object {\n \tbool legacy_just_pressed_behavior = false;\n \tbool disable_input = false;\n \n-\tMouseMode mouse_mode = MOUSE_MODE_VISIBLE;\n-\tbool mouse_mode_override_enabled = false;\n-\tMouseMode mouse_mode_override = MOUSE_MODE_VISIBLE;\n-\n \tstruct ActionState {\n \t\tuint64_t pressed_physics_frame = UINT64_MAX;\n \t\tuint64_t pressed_process_frame = UINT64_MAX;\n@@ -268,6 +266,10 @@ class Input : public Object {\n \n \tstatic void (*set_mouse_mode_func)(MouseMode);\n \tstatic MouseMode (*get_mouse_mode_func)();\n+\tstatic void (*set_mouse_mode_override_func)(MouseMode);\n+\tstatic MouseMode (*get_mouse_mode_override_func)();\n+\tstatic void (*set_mouse_mode_override_enabled_func)(bool);\n+\tstatic bool (*is_mouse_mode_override_enabled_func)();\n \tstatic void (*warp_mouse_func)(const Vector2 &p_position);\n \n \tstatic CursorShape (*get_current_cursor_shape_func)();\n@@ -286,8 +288,10 @@ class Input : public Object {\n public:\n \tvoid set_mouse_mode(MouseMode p_mode);\n \tMouseMode get_mouse_mode() const;\n-\tvoid set_mouse_mode_override_enabled(bool p_enabled);\n \tvoid set_mouse_mode_override(MouseMode p_mode);\n+\tMouseMode get_mouse_mode_override() const;\n+\tvoid set_mouse_mode_override_enabled(bool p_override_enabled);\n+\tbool is_mouse_mode_override_enabled();\n \n #ifdef TOOLS_ENABLED\n \tvoid get_argument_options(const StringName &p_function, int p_idx, List<String> *r_options) const override;\ndiff --git a/doc/classes/DisplayServer.xml b/doc/classes/DisplayServer.xml\nindex 8c9855fa9180..6089f85bc774 100644\n--- a/doc/classes/DisplayServer.xml\n+++ b/doc/classes/DisplayServer.xml\n@@ -1968,6 +1968,9 @@\n \t\t<constant name=\"MOUSE_MODE_CONFINED_HIDDEN\" value=\"4\" enum=\"MouseMode\">\n \t\t\tConfines the mouse cursor to the game window, and make it hidden.\n \t\t</constant>\n+\t\t<constant name=\"MOUSE_MODE_MAX\" value=\"5\" enum=\"MouseMode\">\n+\t\t\tMax value of the [enum MouseMode].\n+\t\t</constant>\n \t\t<constant name=\"SCREEN_WITH_MOUSE_FOCUS\" value=\"-4\">\n \t\t\tRepresents the screen containing the mouse pointer.\n \t\t\t[b]Note:[/b] On Linux (Wayland), this constant always represents the screen at index [code]0[/code].\ndiff --git a/doc/classes/Input.xml b/doc/classes/Input.xml\nindex 2e12015e5f98..e0d8be915778 100644\n--- a/doc/classes/Input.xml\n+++ b/doc/classes/Input.xml\n@@ -464,6 +464,9 @@\n \t\t<constant name=\"MOUSE_MODE_CONFINED_HIDDEN\" value=\"4\" enum=\"MouseMode\">\n \t\t\tConfines the mouse cursor to the game window, and make it hidden.\n \t\t</constant>\n+\t\t<constant name=\"MOUSE_MODE_MAX\" value=\"5\" enum=\"MouseMode\">\n+\t\t\tMax value of the [enum MouseMode].\n+\t\t</constant>\n \t\t<constant name=\"CURSOR_ARROW\" value=\"0\" enum=\"CursorShape\">\n \t\t\tArrow cursor. Standard, default pointing cursor.\n \t\t</constant>\ndiff --git a/platform/android/display_server_android.cpp b/platform/android/display_server_android.cpp\nindex 06973f289c5c..f8d960f2b701 100644\n--- a/platform/android/display_server_android.cpp\n+++ b/platform/android/display_server_android.cpp\n@@ -771,33 +771,68 @@ void DisplayServerAndroid::process_gyroscope(const Vector3 &p_gyroscope) {\n \tInput::get_singleton()->set_gyroscope(p_gyroscope);\n }\n \n-void DisplayServerAndroid::mouse_set_mode(MouseMode p_mode) {\n+void DisplayServerAndroid::_mouse_update_mode() {\n+\tMouseMode wanted_mouse_mode = mouse_mode_override_enabled\n+\t\t\t? mouse_mode_override\n+\t\t\t: mouse_mode_base;\n+\n \tif (!OS_Android::get_singleton()->get_godot_java()->get_godot_view()->can_update_pointer_icon() || !OS_Android::get_singleton()->get_godot_java()->get_godot_view()->can_capture_pointer()) {\n \t\treturn;\n \t}\n-\tif (mouse_mode == p_mode) {\n+\tif (mouse_mode == wanted_mouse_mode) {\n \t\treturn;\n \t}\n \n-\tif (p_mode == MouseMode::MOUSE_MODE_HIDDEN) {\n+\tif (wanted_mouse_mode == MouseMode::MOUSE_MODE_HIDDEN) {\n \t\tOS_Android::get_singleton()->get_godot_java()->get_godot_view()->set_pointer_icon(CURSOR_TYPE_NULL);\n \t} else {\n \t\tcursor_set_shape(cursor_shape);\n \t}\n \n-\tif (p_mode == MouseMode::MOUSE_MODE_CAPTURED) {\n+\tif (wanted_mouse_mode == MouseMode::MOUSE_MODE_CAPTURED) {\n \t\tOS_Android::get_singleton()->get_godot_java()->get_godot_view()->request_pointer_capture();\n \t} else {\n \t\tOS_Android::get_singleton()->get_godot_java()->get_godot_view()->release_pointer_capture();\n \t}\n \n-\tmouse_mode = p_mode;\n+\tmouse_mode = wanted_mouse_mode;\n+}\n+\n+void DisplayServerAndroid::mouse_set_mode(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_base) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_base = p_mode;\n+\t_mouse_update_mode();\n }\n \n DisplayServer::MouseMode DisplayServerAndroid::mouse_get_mode() const {\n \treturn mouse_mode;\n }\n \n+void DisplayServerAndroid::mouse_set_mode_override(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_override) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n+DisplayServer::MouseMode DisplayServerAndroid::mouse_get_mode_override() const {\n+\treturn mouse_mode_override;\n+}\n+\n+void DisplayServerAndroid::mouse_set_mode_override_enabled(bool p_override_enabled) {\n+\tmouse_mode_override_enabled = p_override_enabled;\n+\t_mouse_update_mode();\n+}\n+\n+bool DisplayServerAndroid::mouse_is_mode_override_enabled() const {\n+\treturn mouse_mode_override_enabled;\n+}\n+\n Point2i DisplayServerAndroid::mouse_get_position() const {\n \treturn Input::get_singleton()->get_mouse_position();\n }\ndiff --git a/platform/android/display_server_android.h b/platform/android/display_server_android.h\nindex 0d2caa07b7c7..587d8731a10f 100644\n--- a/platform/android/display_server_android.h\n+++ b/platform/android/display_server_android.h\n@@ -66,6 +66,10 @@ class DisplayServerAndroid : public DisplayServer {\n \t};\n \tconst int CURSOR_TYPE_NULL = 0;\n \tMouseMode mouse_mode = MouseMode::MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_base = MouseMode::MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_override = MouseMode::MOUSE_MODE_VISIBLE;\n+\tbool mouse_mode_override_enabled = false;\n+\tvoid _mouse_update_mode();\n \n \tbool keep_screen_on;\n \tbool swap_buffers_flag;\n@@ -228,6 +232,10 @@ class DisplayServerAndroid : public DisplayServer {\n \n \tvirtual void mouse_set_mode(MouseMode p_mode) override;\n \tvirtual MouseMode mouse_get_mode() const override;\n+\tvirtual void mouse_set_mode_override(MouseMode p_mode) override;\n+\tvirtual MouseMode mouse_get_mode_override() const override;\n+\tvirtual void mouse_set_mode_override_enabled(bool p_override_enabled) override;\n+\tvirtual bool mouse_is_mode_override_enabled() const override;\n \n \tstatic DisplayServer *create_func(const String &p_rendering_driver, WindowMode p_mode, DisplayServer::VSyncMode p_vsync_mode, uint32_t p_flags, const Vector2i *p_position, const Vector2i &p_resolution, int p_screen, Context p_context, int64_t p_parent_window, Error &r_error);\n \tstatic Vector<String> get_rendering_drivers_func();\ndiff --git a/platform/linuxbsd/wayland/display_server_wayland.cpp b/platform/linuxbsd/wayland/display_server_wayland.cpp\nindex 532eaa6bcf49..19123875b2cb 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.cpp\n+++ b/platform/linuxbsd/wayland/display_server_wayland.cpp\n@@ -325,20 +325,24 @@ void DisplayServerWayland::beep() const {\n \twayland_thread.beep();\n }\n \n-void DisplayServerWayland::mouse_set_mode(MouseMode p_mode) {\n-\tif (p_mode == mouse_mode) {\n+void DisplayServerWayland::_mouse_update_mode() {\n+\tMouseMode wanted_mouse_mode = mouse_mode_override_enabled\n+\t\t\t? mouse_mode_override\n+\t\t\t: mouse_mode_base;\n+\n+\tif (wanted_mouse_mode == mouse_mode) {\n \t\treturn;\n \t}\n \n \tMutexLock mutex_lock(wayland_thread.mutex);\n \n-\tbool show_cursor = (p_mode == MOUSE_MODE_VISIBLE || p_mode == MOUSE_MODE_CONFINED);\n+\tbool show_cursor = (wanted_mouse_mode == MOUSE_MODE_VISIBLE || wanted_mouse_mode == MOUSE_MODE_CONFINED);\n \n \twayland_thread.cursor_set_visible(show_cursor);\n \n \tWaylandThread::PointerConstraint constraint = WaylandThread::PointerConstraint::NONE;\n \n-\tswitch (p_mode) {\n+\tswitch (wanted_mouse_mode) {\n \t\tcase DisplayServer::MOUSE_MODE_CAPTURED: {\n \t\t\tconstraint = WaylandThread::PointerConstraint::LOCKED;\n \t\t} break;\n@@ -354,13 +358,47 @@ void DisplayServerWayland::mouse_set_mode(MouseMode p_mode) {\n \n \twayland_thread.pointer_set_constraint(constraint);\n \n-\tmouse_mode = p_mode;\n+\tmouse_mode = wanted_mouse_mode;\n+}\n+\n+void DisplayServerWayland::mouse_set_mode(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_base) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_base = p_mode;\n+\t_mouse_update_mode();\n }\n \n DisplayServerWayland::MouseMode DisplayServerWayland::mouse_get_mode() const {\n \treturn mouse_mode;\n }\n \n+void DisplayServerWayland::mouse_set_mode_override(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_override) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n+DisplayServerWayland::MouseMode DisplayServerWayland::mouse_get_mode_override() const {\n+\treturn mouse_mode_override;\n+}\n+\n+void DisplayServerWayland::mouse_set_mode_override_enabled(bool p_override_enabled) {\n+\tif (p_override_enabled == mouse_mode_override_enabled) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override_enabled = p_override_enabled;\n+\t_mouse_update_mode();\n+}\n+\n+bool DisplayServerWayland::mouse_is_mode_override_enabled() const {\n+\treturn mouse_mode_override_enabled;\n+}\n+\n // NOTE: This is hacked together (and not guaranteed to work in the first place)\n // as for some reason the there's no proper way to ask the compositor to warp\n // the pointer, although, at the time of writing, there's a proposal for a\ndiff --git a/platform/linuxbsd/wayland/display_server_wayland.h b/platform/linuxbsd/wayland/display_server_wayland.h\nindex 8c3bac9c7e3b..97a07194a6ab 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.h\n+++ b/platform/linuxbsd/wayland/display_server_wayland.h\n@@ -113,6 +113,10 @@ class DisplayServerWayland : public DisplayServer {\n \n \tCursorShape cursor_shape = CURSOR_ARROW;\n \tDisplayServer::MouseMode mouse_mode = DisplayServer::MOUSE_MODE_VISIBLE;\n+\tDisplayServer::MouseMode mouse_mode_base = MOUSE_MODE_VISIBLE;\n+\tDisplayServer::MouseMode mouse_mode_override = MOUSE_MODE_VISIBLE;\n+\tbool mouse_mode_override_enabled = false;\n+\tvoid _mouse_update_mode();\n \n \tHashMap<CursorShape, CustomCursor> custom_cursors;\n \n@@ -191,6 +195,10 @@ class DisplayServerWayland : public DisplayServer {\n \n \tvirtual void mouse_set_mode(MouseMode p_mode) override;\n \tvirtual MouseMode mouse_get_mode() const override;\n+\tvirtual void mouse_set_mode_override(MouseMode p_mode) override;\n+\tvirtual MouseMode mouse_get_mode_override() const override;\n+\tvirtual void mouse_set_mode_override_enabled(bool p_override_enabled) override;\n+\tvirtual bool mouse_is_mode_override_enabled() const override;\n \n \tvirtual void warp_mouse(const Point2i &p_to) override;\n \tvirtual Point2i mouse_get_position() const override;\ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex b1945eb47a2e..9dbf4dda597d 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -417,10 +417,14 @@ void DisplayServerX11::beep() const {\n \tXBell(x11_display, 0);\n }\n \n-void DisplayServerX11::mouse_set_mode(MouseMode p_mode) {\n+void DisplayServerX11::_mouse_update_mode() {\n \t_THREAD_SAFE_METHOD_\n \n-\tif (p_mode == mouse_mode) {\n+\tMouseMode wanted_mouse_mode = mouse_mode_override_enabled\n+\t\t\t? mouse_mode_override\n+\t\t\t: mouse_mode_base;\n+\n+\tif (wanted_mouse_mode == mouse_mode) {\n \t\treturn;\n \t}\n \n@@ -429,7 +433,7 @@ void DisplayServerX11::mouse_set_mode(MouseMode p_mode) {\n \t}\n \n \t// The only modes that show a cursor are VISIBLE and CONFINED\n-\tbool show_cursor = (p_mode == MOUSE_MODE_VISIBLE || p_mode == MOUSE_MODE_CONFINED);\n+\tbool show_cursor = (wanted_mouse_mode == MOUSE_MODE_VISIBLE || wanted_mouse_mode == MOUSE_MODE_CONFINED);\n \tbool previously_shown = (mouse_mode == MOUSE_MODE_VISIBLE || mouse_mode == MOUSE_MODE_CONFINED);\n \n \tif (show_cursor && !previously_shown) {\n@@ -450,7 +454,7 @@ void DisplayServerX11::mouse_set_mode(MouseMode p_mode) {\n \t\t\tXDefineCursor(x11_display, E.value.x11_window, null_cursor); // hide cursor\n \t\t}\n \t}\n-\tmouse_mode = p_mode;\n+\tmouse_mode = wanted_mouse_mode;\n \n \tif (mouse_mode == MOUSE_MODE_CAPTURED || mouse_mode == MOUSE_MODE_CONFINED || mouse_mode == MOUSE_MODE_CONFINED_HIDDEN) {\n \t\t//flush pending motion events\n@@ -484,10 +488,44 @@ void DisplayServerX11::mouse_set_mode(MouseMode p_mode) {\n \tXFlush(x11_display);\n }\n \n+void DisplayServerX11::mouse_set_mode(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_base) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_base = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n DisplayServerX11::MouseMode DisplayServerX11::mouse_get_mode() const {\n \treturn mouse_mode;\n }\n \n+void DisplayServerX11::mouse_set_mode_override(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_override) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n+DisplayServerX11::MouseMode DisplayServerX11::mouse_get_mode_override() const {\n+\treturn mouse_mode_override;\n+}\n+\n+void DisplayServerX11::mouse_set_mode_override_enabled(bool p_override_enabled) {\n+\tif (p_override_enabled == mouse_mode_override_enabled) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override_enabled = p_override_enabled;\n+\t_mouse_update_mode();\n+}\n+\n+bool DisplayServerX11::mouse_is_mode_override_enabled() const {\n+\treturn mouse_mode_override_enabled;\n+}\n+\n void DisplayServerX11::warp_mouse(const Point2i &p_position) {\n \t_THREAD_SAFE_METHOD_\n \ndiff --git a/platform/linuxbsd/x11/display_server_x11.h b/platform/linuxbsd/x11/display_server_x11.h\nindex e0a84db4b627..166b2cb57b5c 100644\n--- a/platform/linuxbsd/x11/display_server_x11.h\n+++ b/platform/linuxbsd/x11/display_server_x11.h\n@@ -297,6 +297,11 @@ class DisplayServerX11 : public DisplayServer {\n \tvoid _flush_mouse_motion();\n \n \tMouseMode mouse_mode = MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_base = MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_override = MOUSE_MODE_VISIBLE;\n+\tbool mouse_mode_override_enabled = false;\n+\tvoid _mouse_update_mode();\n+\n \tPoint2i center;\n \n \tvoid _handle_key_event(WindowID p_window, XKeyEvent *p_event, LocalVector<XEvent> &p_events, uint32_t &p_event_index, bool p_echo = false);\n@@ -424,6 +429,10 @@ class DisplayServerX11 : public DisplayServer {\n \n \tvirtual void mouse_set_mode(MouseMode p_mode) override;\n \tvirtual MouseMode mouse_get_mode() const override;\n+\tvirtual void mouse_set_mode_override(MouseMode p_mode) override;\n+\tvirtual MouseMode mouse_get_mode_override() const override;\n+\tvirtual void mouse_set_mode_override_enabled(bool p_override_enabled) override;\n+\tvirtual bool mouse_is_mode_override_enabled() const override;\n \n \tvirtual void warp_mouse(const Point2i &p_position) override;\n \tvirtual Point2i mouse_get_position() const override;\ndiff --git a/platform/macos/display_server_macos.h b/platform/macos/display_server_macos.h\nindex 32ab1fc478de..eb536f9894c3 100644\n--- a/platform/macos/display_server_macos.h\n+++ b/platform/macos/display_server_macos.h\n@@ -169,6 +169,10 @@ class DisplayServerMacOS : public DisplayServer {\n \n \tCGEventSourceRef event_source;\n \tMouseMode mouse_mode = MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_base = MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_override = MOUSE_MODE_VISIBLE;\n+\tbool mouse_mode_override_enabled = false;\n+\tvoid _mouse_update_mode();\n \n \tbool drop_events = false;\n \tbool in_dispatch_input_event = false;\n@@ -306,6 +310,10 @@ class DisplayServerMacOS : public DisplayServer {\n \n \tvirtual void mouse_set_mode(MouseMode p_mode) override;\n \tvirtual MouseMode mouse_get_mode() const override;\n+\tvirtual void mouse_set_mode_override(MouseMode p_mode) override;\n+\tvirtual MouseMode mouse_get_mode_override() const override;\n+\tvirtual void mouse_set_mode_override_enabled(bool p_override_enabled) override;\n+\tvirtual bool mouse_is_mode_override_enabled() const override;\n \n \tbool update_mouse_wrap(WindowData &p_wd, NSPoint &r_delta, NSPoint &r_mpos, NSTimeInterval p_timestamp);\n \tvirtual void warp_mouse(const Point2i &p_position) override;\ndiff --git a/platform/macos/display_server_macos.mm b/platform/macos/display_server_macos.mm\nindex 174e28310ef1..dd351bcad793 100644\n--- a/platform/macos/display_server_macos.mm\n+++ b/platform/macos/display_server_macos.mm\n@@ -1264,10 +1264,14 @@\n \treturn OK;\n }\n \n-void DisplayServerMacOS::mouse_set_mode(MouseMode p_mode) {\n+void DisplayServerMacOS::_mouse_update_mode() {\n \t_THREAD_SAFE_METHOD_\n \n-\tif (p_mode == mouse_mode) {\n+\tMouseMode wanted_mouse_mode = mouse_mode_override_enabled\n+\t\t\t? mouse_mode_override\n+\t\t\t: mouse_mode_base;\n+\n+\tif (wanted_mouse_mode == mouse_mode) {\n \t\treturn;\n \t}\n \n@@ -1277,7 +1281,7 @@\n \t}\n \tWindowData &wd = windows[window_id];\n \n-\tbool show_cursor = (p_mode == MOUSE_MODE_VISIBLE || p_mode == MOUSE_MODE_CONFINED);\n+\tbool show_cursor = (wanted_mouse_mode == MOUSE_MODE_VISIBLE || wanted_mouse_mode == MOUSE_MODE_CONFINED);\n \tbool previously_shown = (mouse_mode == MOUSE_MODE_VISIBLE || mouse_mode == MOUSE_MODE_CONFINED);\n \n \tif (show_cursor && !previously_shown) {\n@@ -1285,7 +1289,7 @@\n \t\tmouse_enter_window(window_id);\n \t}\n \n-\tif (p_mode == MOUSE_MODE_CAPTURED) {\n+\tif (wanted_mouse_mode == MOUSE_MODE_CAPTURED) {\n \t\t// Apple Docs state that the display parameter is not used.\n \t\t// \"This parameter is not used. By default, you may pass kCGDirectMainDisplay.\"\n \t\t// https://developer.apple.com/library/mac/documentation/graphicsimaging/reference/Quartz_Services_Ref/Reference/reference.html\n@@ -1299,17 +1303,17 @@\n \t\tNSPoint pointOnScreen = [[wd.window_view window] convertRectToScreen:pointInWindowRect].origin;\n \t\tCGPoint lMouseWarpPos = { pointOnScreen.x, CGDisplayBounds(CGMainDisplayID()).size.height - pointOnScreen.y };\n \t\tCGWarpMouseCursorPosition(lMouseWarpPos);\n-\t} else if (p_mode == MOUSE_MODE_HIDDEN) {\n+\t} else if (wanted_mouse_mode == MOUSE_MODE_HIDDEN) {\n \t\tif (previously_shown) {\n \t\t\tCGDisplayHideCursor(kCGDirectMainDisplay);\n \t\t}\n \t\t[wd.window_object setMovable:YES];\n \t\tCGAssociateMouseAndMouseCursorPosition(true);\n-\t} else if (p_mode == MOUSE_MODE_CONFINED) {\n+\t} else if (wanted_mouse_mode == MOUSE_MODE_CONFINED) {\n \t\tCGDisplayShowCursor(kCGDirectMainDisplay);\n \t\t[wd.window_object setMovable:NO];\n \t\tCGAssociateMouseAndMouseCursorPosition(false);\n-\t} else if (p_mode == MOUSE_MODE_CONFINED_HIDDEN) {\n+\t} else if (wanted_mouse_mode == MOUSE_MODE_CONFINED_HIDDEN) {\n \t\tif (previously_shown) {\n \t\t\tCGDisplayHideCursor(kCGDirectMainDisplay);\n \t\t}\n@@ -1324,17 +1328,51 @@\n \tlast_warp = [[NSProcessInfo processInfo] systemUptime];\n \tignore_warp = true;\n \twarp_events.clear();\n-\tmouse_mode = p_mode;\n+\tmouse_mode = wanted_mouse_mode;\n \n \tif (show_cursor) {\n \t\tcursor_update_shape();\n \t}\n }\n \n+void DisplayServerMacOS::mouse_set_mode(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_base) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_base = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n DisplayServer::MouseMode DisplayServerMacOS::mouse_get_mode() const {\n \treturn mouse_mode;\n }\n \n+void DisplayServerMacOS::mouse_set_mode_override(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_override) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n+DisplayServer::MouseMode DisplayServerMacOS::mouse_get_mode_override() const {\n+\treturn mouse_mode_override;\n+}\n+\n+void DisplayServerMacOS::mouse_set_mode_override_enabled(bool p_override_enabled) {\n+\tif (p_override_enabled == mouse_mode_override_enabled) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override_enabled = p_override_enabled;\n+\t_mouse_update_mode();\n+}\n+\n+bool DisplayServerMacOS::mouse_is_mode_override_enabled() const {\n+\treturn mouse_mode_override_enabled;\n+}\n+\n bool DisplayServerMacOS::update_mouse_wrap(WindowData &p_wd, NSPoint &r_delta, NSPoint &r_mpos, NSTimeInterval p_timestamp) {\n \t_THREAD_SAFE_METHOD_\n \ndiff --git a/platform/web/display_server_web.cpp b/platform/web/display_server_web.cpp\nindex 8b4a733a0889..89cc6339d28b 100644\n--- a/platform/web/display_server_web.cpp\n+++ b/platform/web/display_server_web.cpp\n@@ -550,26 +550,39 @@ void DisplayServerWeb::cursor_set_custom_image(const Ref<Resource> &p_cursor, Cu\n }\n \n // Mouse mode\n-void DisplayServerWeb::mouse_set_mode(MouseMode p_mode) {\n-\tERR_FAIL_COND_MSG(p_mode == MOUSE_MODE_CONFINED || p_mode == MOUSE_MODE_CONFINED_HIDDEN, \"MOUSE_MODE_CONFINED is not supported for the Web platform.\");\n-\tif (p_mode == mouse_get_mode()) {\n+void DisplayServerWeb::_mouse_update_mode() {\n+\tMouseMode wanted_mouse_mode = mouse_mode_override_enabled\n+\t\t\t? mouse_mode_override\n+\t\t\t: mouse_mode_base;\n+\n+\tERR_FAIL_COND_MSG(wanted_mouse_mode == MOUSE_MODE_CONFINED || wanted_mouse_mode == MOUSE_MODE_CONFINED_HIDDEN, \"MOUSE_MODE_CONFINED is not supported for the Web platform.\");\n+\tif (wanted_mouse_mode == mouse_get_mode()) {\n \t\treturn;\n \t}\n \n-\tif (p_mode == MOUSE_MODE_VISIBLE) {\n+\tif (wanted_mouse_mode == MOUSE_MODE_VISIBLE) {\n \t\tgodot_js_display_cursor_set_visible(1);\n \t\tgodot_js_display_cursor_lock_set(0);\n \n-\t} else if (p_mode == MOUSE_MODE_HIDDEN) {\n+\t} else if (wanted_mouse_mode == MOUSE_MODE_HIDDEN) {\n \t\tgodot_js_display_cursor_set_visible(0);\n \t\tgodot_js_display_cursor_lock_set(0);\n \n-\t} else if (p_mode == MOUSE_MODE_CAPTURED) {\n+\t} else if (wanted_mouse_mode == MOUSE_MODE_CAPTURED) {\n \t\tgodot_js_display_cursor_set_visible(1);\n \t\tgodot_js_display_cursor_lock_set(1);\n \t}\n }\n \n+void DisplayServerWeb::mouse_set_mode(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_base) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_base = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n DisplayServer::MouseMode DisplayServerWeb::mouse_get_mode() const {\n \tif (godot_js_display_cursor_is_hidden()) {\n \t\treturn MOUSE_MODE_HIDDEN;\n@@ -581,6 +594,31 @@ DisplayServer::MouseMode DisplayServerWeb::mouse_get_mode() const {\n \treturn MOUSE_MODE_VISIBLE;\n }\n \n+void DisplayServerWeb::mouse_set_mode_override(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_override) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n+DisplayServer::MouseMode DisplayServerWeb::mouse_get_mode_override() const {\n+\treturn mouse_mode_override;\n+}\n+\n+void DisplayServerWeb::mouse_set_mode_override_enabled(bool p_override_enabled) {\n+\tif (p_override_enabled == mouse_mode_override_enabled) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override_enabled = p_override_enabled;\n+\t_mouse_update_mode();\n+}\n+\n+bool DisplayServerWeb::mouse_is_mode_override_enabled() const {\n+\treturn mouse_mode_override_enabled;\n+}\n+\n Point2i DisplayServerWeb::mouse_get_position() const {\n \treturn Input::get_singleton()->get_mouse_position();\n }\ndiff --git a/platform/web/display_server_web.h b/platform/web/display_server_web.h\nindex de0eb93238cc..2d0d13c19a30 100644\n--- a/platform/web/display_server_web.h\n+++ b/platform/web/display_server_web.h\n@@ -106,6 +106,11 @@ class DisplayServerWeb : public DisplayServer {\n \tbool tts = false;\n \tNativeMenu *native_menu = nullptr;\n \n+\tMouseMode mouse_mode_base = MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_override = MOUSE_MODE_VISIBLE;\n+\tbool mouse_mode_override_enabled = false;\n+\tvoid _mouse_update_mode();\n+\n \t// utilities\n \tstatic void dom2godot_mod(Ref<InputEventWithModifiers> ev, int p_mod, Key p_keycode);\n \tstatic const char *godot2dom_cursor(DisplayServer::CursorShape p_shape);\n@@ -184,6 +189,11 @@ class DisplayServerWeb : public DisplayServer {\n \t// mouse\n \tvirtual void mouse_set_mode(MouseMode p_mode) override;\n \tvirtual MouseMode mouse_get_mode() const override;\n+\tvirtual void mouse_set_mode_override(MouseMode p_mode) override;\n+\tvirtual MouseMode mouse_get_mode_override() const override;\n+\tvirtual void mouse_set_mode_override_enabled(bool p_override_enabled) override;\n+\tvirtual bool mouse_is_mode_override_enabled() const override;\n+\n \tvirtual Point2i mouse_get_position() const override;\n \n \t// ime\ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex 1d3a6f0ca4f2..ab91b2398d9f 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -796,23 +796,61 @@ void DisplayServerWindows::beep() const {\n \tMessageBeep(MB_OK);\n }\n \n-void DisplayServerWindows::mouse_set_mode(MouseMode p_mode) {\n+void DisplayServerWindows::_mouse_update_mode() {\n \t_THREAD_SAFE_METHOD_\n \n-\tif (mouse_mode == p_mode) {\n+\tMouseMode wanted_mouse_mode = mouse_mode_override_enabled\n+\t\t\t? mouse_mode_override\n+\t\t\t: mouse_mode_base;\n+\n+\tif (mouse_mode == wanted_mouse_mode) {\n \t\t// Already in the same mode; do nothing.\n \t\treturn;\n \t}\n \n-\tmouse_mode = p_mode;\n+\tmouse_mode = wanted_mouse_mode;\n \n-\t_set_mouse_mode_impl(p_mode);\n+\t_set_mouse_mode_impl(wanted_mouse_mode);\n+}\n+\n+void DisplayServerWindows::mouse_set_mode(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_base) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_base = p_mode;\n+\t_mouse_update_mode();\n }\n \n DisplayServer::MouseMode DisplayServerWindows::mouse_get_mode() const {\n \treturn mouse_mode;\n }\n \n+void DisplayServerWindows::mouse_set_mode_override(MouseMode p_mode) {\n+\tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n+\tif (p_mode == mouse_mode_override) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override = p_mode;\n+\t_mouse_update_mode();\n+}\n+\n+DisplayServer::MouseMode DisplayServerWindows::mouse_get_mode_override() const {\n+\treturn mouse_mode_override;\n+}\n+\n+void DisplayServerWindows::mouse_set_mode_override_enabled(bool p_override_enabled) {\n+\tif (p_override_enabled == mouse_mode_override_enabled) {\n+\t\treturn;\n+\t}\n+\tmouse_mode_override_enabled = p_override_enabled;\n+\t_mouse_update_mode();\n+}\n+\n+bool DisplayServerWindows::mouse_is_mode_override_enabled() const {\n+\treturn mouse_mode_override_enabled;\n+}\n+\n void DisplayServerWindows::warp_mouse(const Point2i &p_position) {\n \t_THREAD_SAFE_METHOD_\n \ndiff --git a/platform/windows/display_server_windows.h b/platform/windows/display_server_windows.h\nindex b85394366e87..71de7a73769e 100644\n--- a/platform/windows/display_server_windows.h\n+++ b/platform/windows/display_server_windows.h\n@@ -620,6 +620,10 @@ class DisplayServerWindows : public DisplayServer {\n \tvoid _get_window_style(bool p_main_window, bool p_initialized, bool p_fullscreen, bool p_multiwindow_fs, bool p_borderless, bool p_resizable, bool p_minimized, bool p_maximized, bool p_maximized_fs, bool p_no_activate_focus, bool p_embed_child, DWORD &r_style, DWORD &r_style_ex);\n \n \tMouseMode mouse_mode;\n+\tMouseMode mouse_mode_base = MOUSE_MODE_VISIBLE;\n+\tMouseMode mouse_mode_override = MOUSE_MODE_VISIBLE;\n+\tbool mouse_mode_override_enabled = false;\n+\tvoid _mouse_update_mode();\n \tint restore_mouse_trails = 0;\n \n \tbool use_raw_input = false;\n@@ -715,6 +719,10 @@ class DisplayServerWindows : public DisplayServer {\n \n \tvirtual void mouse_set_mode(MouseMode p_mode) override;\n \tvirtual MouseMode mouse_get_mode() const override;\n+\tvirtual void mouse_set_mode_override(MouseMode p_mode) override;\n+\tvirtual MouseMode mouse_get_mode_override() const override;\n+\tvirtual void mouse_set_mode_override_enabled(bool p_override_enabled) override;\n+\tvirtual bool mouse_is_mode_override_enabled() const override;\n \n \tvirtual void warp_mouse(const Point2i &p_position) override;\n \tvirtual Point2i mouse_get_position() const override;\ndiff --git a/servers/display_server.cpp b/servers/display_server.cpp\nindex dc3402bdf88b..bf3d428420a7 100644\n--- a/servers/display_server.cpp\n+++ b/servers/display_server.cpp\n@@ -501,6 +501,22 @@ DisplayServer::MouseMode DisplayServer::mouse_get_mode() const {\n \treturn MOUSE_MODE_VISIBLE;\n }\n \n+void DisplayServer::mouse_set_mode_override(MouseMode p_mode) {\n+\tWARN_PRINT(\"Mouse is not supported by this display server.\");\n+}\n+\n+DisplayServer::MouseMode DisplayServer::mouse_get_mode_override() const {\n+\treturn MOUSE_MODE_VISIBLE;\n+}\n+\n+void DisplayServer::mouse_set_mode_override_enabled(bool p_override_enabled) {\n+\tWARN_PRINT(\"Mouse is not supported by this display server.\");\n+}\n+\n+bool DisplayServer::mouse_is_mode_override_enabled() const {\n+\treturn false;\n+}\n+\n void DisplayServer::warp_mouse(const Point2i &p_position) {\n }\n \n@@ -1098,6 +1114,7 @@ void DisplayServer::_bind_methods() {\n \tBIND_ENUM_CONSTANT(MOUSE_MODE_CAPTURED);\n \tBIND_ENUM_CONSTANT(MOUSE_MODE_CONFINED);\n \tBIND_ENUM_CONSTANT(MOUSE_MODE_CONFINED_HIDDEN);\n+\tBIND_ENUM_CONSTANT(MOUSE_MODE_MAX);\n \n \tBIND_CONSTANT(SCREEN_WITH_MOUSE_FOCUS);\n \tBIND_CONSTANT(SCREEN_WITH_KEYBOARD_FOCUS);\n@@ -1266,6 +1283,22 @@ Input::MouseMode DisplayServer::_input_get_mouse_mode() {\n \treturn Input::MouseMode(singleton->mouse_get_mode());\n }\n \n+void DisplayServer::_input_set_mouse_mode_override(Input::MouseMode p_mode) {\n+\tsingleton->mouse_set_mode_override(MouseMode(p_mode));\n+}\n+\n+Input::MouseMode DisplayServer::_input_get_mouse_mode_override() {\n+\treturn Input::MouseMode(singleton->mouse_get_mode_override());\n+}\n+\n+void DisplayServer::_input_set_mouse_mode_override_enabled(bool p_enabled) {\n+\tsingleton->mouse_set_mode_override_enabled(p_enabled);\n+}\n+\n+bool DisplayServer::_input_is_mouse_mode_override_enabled() {\n+\treturn singleton->mouse_is_mode_override_enabled();\n+}\n+\n void DisplayServer::_input_warp(const Vector2 &p_to_pos) {\n \tsingleton->warp_mouse(p_to_pos);\n }\n@@ -1347,6 +1380,10 @@ DisplayServer::DisplayServer() {\n \tsingleton = this;\n \tInput::set_mouse_mode_func = _input_set_mouse_mode;\n \tInput::get_mouse_mode_func = _input_get_mouse_mode;\n+\tInput::set_mouse_mode_override_func = _input_set_mouse_mode_override;\n+\tInput::get_mouse_mode_override_func = _input_get_mouse_mode_override;\n+\tInput::set_mouse_mode_override_enabled_func = _input_set_mouse_mode_override_enabled;\n+\tInput::is_mouse_mode_override_enabled_func = _input_is_mouse_mode_override_enabled;\n \tInput::warp_mouse_func = _input_warp;\n \tInput::get_current_cursor_shape_func = _input_get_current_cursor_shape;\n \tInput::set_custom_mouse_cursor_func = _input_set_custom_mouse_cursor_func;\ndiff --git a/servers/display_server.h b/servers/display_server.h\nindex 562c2bf5abe0..30bb533a5d39 100644\n--- a/servers/display_server.h\n+++ b/servers/display_server.h\n@@ -98,6 +98,10 @@ class DisplayServer : public Object {\n private:\n \tstatic void _input_set_mouse_mode(Input::MouseMode p_mode);\n \tstatic Input::MouseMode _input_get_mouse_mode();\n+\tstatic void _input_set_mouse_mode_override(Input::MouseMode p_mode);\n+\tstatic Input::MouseMode _input_get_mouse_mode_override();\n+\tstatic void _input_set_mouse_mode_override_enabled(bool p_enabled);\n+\tstatic bool _input_is_mouse_mode_override_enabled();\n \tstatic void _input_warp(const Vector2 &p_to_pos);\n \tstatic Input::CursorShape _input_get_current_cursor_shape();\n \tstatic void _input_set_custom_mouse_cursor_func(const Ref<Resource> &, Input::CursorShape, const Vector2 &p_hotspot);\n@@ -275,15 +279,20 @@ class DisplayServer : public Object {\n \tstatic void set_early_window_clear_color_override(bool p_enabled, Color p_color = Color(0, 0, 0, 0));\n \n \tenum MouseMode {\n-\t\tMOUSE_MODE_VISIBLE,\n-\t\tMOUSE_MODE_HIDDEN,\n-\t\tMOUSE_MODE_CAPTURED,\n-\t\tMOUSE_MODE_CONFINED,\n-\t\tMOUSE_MODE_CONFINED_HIDDEN,\n+\t\tMOUSE_MODE_VISIBLE = Input::MOUSE_MODE_VISIBLE,\n+\t\tMOUSE_MODE_HIDDEN = Input::MOUSE_MODE_HIDDEN,\n+\t\tMOUSE_MODE_CAPTURED = Input::MOUSE_MODE_CAPTURED,\n+\t\tMOUSE_MODE_CONFINED = Input::MOUSE_MODE_CONFINED,\n+\t\tMOUSE_MODE_CONFINED_HIDDEN = Input::MOUSE_MODE_CONFINED_HIDDEN,\n+\t\tMOUSE_MODE_MAX = Input::MOUSE_MODE_MAX,\n \t};\n \n \tvirtual void mouse_set_mode(MouseMode p_mode);\n \tvirtual MouseMode mouse_get_mode() const;\n+\tvirtual void mouse_set_mode_override(MouseMode p_mode);\n+\tvirtual MouseMode mouse_get_mode_override() const;\n+\tvirtual void mouse_set_mode_override_enabled(bool p_override_enabled);\n+\tvirtual bool mouse_is_mode_override_enabled() const;\n \n \tvirtual void warp_mouse(const Point2i &p_position);\n \tvirtual Point2i mouse_get_position() const;\ndiff --git a/servers/display_server_headless.h b/servers/display_server_headless.h\nindex 12c174ae2b05..7bd8cbf07520 100644\n--- a/servers/display_server_headless.h\n+++ b/servers/display_server_headless.h\n@@ -170,6 +170,8 @@ class DisplayServerHeadless : public DisplayServer {\n \tvoid tts_stop() override {}\n \n \tvoid mouse_set_mode(MouseMode p_mode) override {}\n+\tvoid mouse_set_mode_override(MouseMode p_mode) override {}\n+\tvoid mouse_set_mode_override_enabled(bool p_override_enabled) override {}\n \tPoint2i mouse_get_position() const override { return Point2i(); }\n \tvoid clipboard_set(const String &p_text) override {}\n \tvoid clipboard_set_primary(const String &p_text) override {}\n", "instance_id": "godotengine__godot-101924", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear and provides a detailed description of the issue, including the specific versions of the software where the bug is reproducible, the system information, and the steps to reproduce the issue. It also references a minimal reproduction project (MRP) and describes the expected versus actual behavior of `Input.mouse_mode` in web exports. However, there are minor ambiguities: the problem statement does not explicitly discuss potential edge cases beyond the described reproduction steps, nor does it clarify the root cause or expected behavior in all scenarios (e.g., whether this issue affects other platforms or specific browser configurations). Additionally, while the steps to reproduce are detailed, they lack a broader context about why the issue occurs or what specific part of the codebase might be responsible. Thus, while the problem is valid and mostly clear, these minor missing details prevent it from being comprehensive.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.65, placing it in the \"Hard\" category. Here's the reasoning based on the evaluation factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem statement is mostly clear, the underlying issue involves subtle behavior in web exports of a game engine (Godot), specifically with mouse mode handling. Understanding why `Input.mouse_mode` returns an incorrect value despite the mode being set requires diving into platform-specific behavior (web platform) and the interaction between the engine's input system and the browser's pointer lock API. This adds a layer of complexity beyond a straightforward bug fix.\n\n2. **Scope and Depth of Code Changes**: The code changes provided are extensive, affecting multiple files across different platforms (Android, Linux/Wayland, X11, macOS, Windows, Web) and core components of the Godot engine (`Input` and `DisplayServer` classes). The modifications involve refactoring how mouse mode is managed, introducing an override mechanism, and ensuring consistency across platforms. This is not a localized change but a systemic update to a core feature, impacting the interaction between high-level input handling and low-level platform-specific implementations. The amount of code change is significant, with new functions, state variables, and logic added to handle base and override mouse modes.\n\n3. **Number of Technical Concepts to Understand**: Solving this problem requires familiarity with several technical concepts:\n   - **Godot Engine Architecture**: Understanding the relationship between `Input` and `DisplayServer`, and how input states are managed.\n   - **Platform-Specific Input Handling**: Knowledge of how mouse mode (e.g., captured, hidden) is implemented on different platforms, especially the web platform using JavaScript bindings (`godot_js_display_cursor_lock_set`).\n   - **Pointer Lock API (Web)**: Specific to the web export issue, understanding browser APIs for pointer locking and visibility.\n   - **State Management**: Handling multiple states (base mode, override mode, override enabled) and ensuring consistency.\n   - **Thread Safety**: Some changes (e.g., in Windows and macOS) are marked as thread-safe, requiring awareness of concurrency issues.\n   These concepts are moderately to highly complex, especially when combined with cross-platform considerations.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases beyond the reproduction steps, but the code changes suggest several implicit considerations:\n   - Ensuring that override modes do not conflict with base modes across different platforms.\n   - Handling unsupported modes (e.g., `MOUSE_MODE_CONFINED` on the web platform, as seen in the error message).\n   - Managing state transitions (e.g., enabling/disabling overrides) without introducing inconsistencies or race conditions.\n   - Platform-specific quirks, such as Wayland's limitations or browser-specific behaviors with pointer lock.\n   The code changes add error checking (e.g., `ERR_FAIL_INDEX`) and refactor state management to address these issues, indicating a need for careful handling of edge cases.\n\nOverall, this problem requires a deep understanding of the Godot engine's input system, cross-platform development, and web-specific input handling. The changes impact core functionality and necessitate careful consideration of state consistency and platform differences. While not at the extreme end of difficulty (e.g., requiring novel algorithms or system-level redesign), it is a challenging task that demands significant expertise and attention to detail, justifying a score of 0.65.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.65}
{"problem_statement": " Lookup Symbol shortcut cannot be specified in the Editor shortcut settings\n### Tested versions\n\nRepro in 4.2\n\n### System information\n\nmacOS Sonoma non-mono version\n\n### Issue description\n\n\" Lookup Symbol\" shortcut cannot be specified in the Editor shortcut settings, and I think it's probably just being overlooked. So I could use my preferred shortcut to look at the definition. It's supported in all major IDEs and I'm not the only one needing this in Godot: https://www.reddit.com/r/godot/comments/150ej30/shortcut_for_go_to_definitionlook_up_symbol/\r\n\n\n### Steps to reproduce\n\nGo to Editor > Editor Settings > shortcuts and search for Lookup Symbol and nothing shows\n\n### Minimal reproduction project (MRP)\n\nNA\n", "patch": "diff --git a/editor/plugins/script_text_editor.cpp b/editor/plugins/script_text_editor.cpp\nindex ece9616b69b2..b7712c4a532d 100644\n--- a/editor/plugins/script_text_editor.cpp\n+++ b/editor/plugins/script_text_editor.cpp\n@@ -2337,7 +2337,7 @@ void ScriptTextEditor::_make_context_menu(bool p_selection, bool p_color, bool p\n \tif (p_color || p_open_docs || p_goto_definition) {\n \t\tcontext_menu->add_separator();\n \t\tif (p_open_docs) {\n-\t\t\tcontext_menu->add_item(TTR(\"Lookup Symbol\"), LOOKUP_SYMBOL);\n+\t\t\tcontext_menu->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_symbol\"), LOOKUP_SYMBOL);\n \t\t}\n \t\tif (p_color) {\n \t\t\tcontext_menu->add_item(TTR(\"Pick Color\"), EDIT_PICK_COLOR);\n@@ -2491,6 +2491,7 @@ void ScriptTextEditor::_enable_code_editor() {\n \tedit_hb->add_child(goto_menu);\n \tgoto_menu->get_popup()->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_function\"), SEARCH_LOCATE_FUNCTION);\n \tgoto_menu->get_popup()->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_line\"), SEARCH_GOTO_LINE);\n+\tgoto_menu->get_popup()->add_shortcut(ED_GET_SHORTCUT(\"script_text_editor/goto_symbol\"), LOOKUP_SYMBOL);\n \tgoto_menu->get_popup()->add_separator();\n \n \tgoto_menu->get_popup()->add_submenu_node_item(TTR(\"Bookmarks\"), bookmarks_menu);\n@@ -2675,6 +2676,7 @@ void ScriptTextEditor::register_editor() {\n \tED_SHORTCUT_OVERRIDE(\"script_text_editor/goto_function\", \"macos\", KeyModifierMask::CTRL | KeyModifierMask::META | Key::J);\n \n \tED_SHORTCUT(\"script_text_editor/goto_line\", TTRC(\"Go to Line...\"), KeyModifierMask::CMD_OR_CTRL | Key::L);\n+\tED_SHORTCUT(\"script_text_editor/goto_symbol\", TTRC(\"Lookup Symbol\"));\n \n \tED_SHORTCUT(\"script_text_editor/toggle_breakpoint\", TTRC(\"Toggle Breakpoint\"), Key::F9);\n \tED_SHORTCUT_OVERRIDE(\"script_text_editor/toggle_breakpoint\", \"macos\", KeyModifierMask::META | KeyModifierMask::SHIFT | Key::B);\n", "instance_id": "godotengine__godot-101565", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the \"Lookup Symbol\" shortcut is not available in the Editor shortcut settings of the Godot engine, and the user wishes to configure it. The goal is evident (enable shortcut configuration for \"Lookup Symbol\"), and the steps to reproduce are provided. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"Lookup Symbol\" does (though it can be inferred as a \"go to definition\" feature from context and the Reddit link). Additionally, there are no specific requirements or constraints mentioned regarding how the shortcut should be implemented or if there are any platform-specific considerations beyond macOS. Edge cases or potential conflicts with existing shortcuts are also not addressed. Despite these minor gaps, the intent and issue are understandable, especially when paired with the code changes, which provide further context.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are minimal and localized to a single file (`script_text_editor.cpp`). The modifications involve adding or updating shortcut definitions and associating them with existing functionality (e.g., `LOOKUP_SYMBOL`). The changes are straightforward, consisting of a few lines to register a new shortcut and update context menus. There is no impact on the broader system architecture or interactions with other modules, as this is purely an enhancement to the editor's UI functionality.\n\n2. **Number of Technical Concepts:** The solution requires basic familiarity with the Godot engine's editor codebase, specifically how shortcuts are defined and registered using macros like `ED_SHORTCUT` and `ED_GET_SHORTCUT`. No advanced language features, complex algorithms, or design patterns are involved. The concepts are limited to understanding UI event handling and shortcut mapping, which are relatively simple for a developer with moderate experience.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not mention any specific edge cases, and the code changes do not introduce new error handling logic. Potential edge cases, such as shortcut conflicts or platform-specific behavior, are not addressed in the diff, but they do not appear critical for the basic implementation. The simplicity of the change suggests that edge cases are minimal or can be handled in future iterations if needed.\n\n4. **Overall Complexity:** The task is a small feature addition that does not require deep understanding of the codebase beyond the editor's shortcut system. It is a typical bug fix or minor enhancement that a developer with basic to intermediate skills in C++ and familiarity with the Godot engine could handle without significant effort.\n\nGiven these factors, a difficulty score of 0.25 reflects the ease of the task, requiring only simple modifications and basic understanding of the relevant code area.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.25}
{"problem_statement": "Cannot export project when $HOME is readonly\n### Tested versions\n\n- Tested on Godot 4.3-stable [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - NixOS #1-NixOS SMP PREEMPT_DYNAMIC Wed Aug 14 11:59:04 UTC 2024 - Wayland - Vulkan (Forward+) - integrated Intel(R) HD Graphics 4600 (HSW GT2) - Intel(R) Core(TM) i5-4210M CPU @ 2.60GHz (4 Threads)\n\n### Issue description\n\nWhen $HOME is readonly or otherwise invalid (e.g /var/empty, /dev/null) exporting a project fails.\r\nCommand ran `godot --headless --export-debug \"Linux\"`\r\n\r\nThis matters for CI builds where build users may set $HOME to /var/empty to avoid using the root user.\n\n### Steps to reproduce\n\nCreate the default Linux export template\r\nSet $HOME to a readonly/invalid path (/var/empty, /dev/null both tested to fail)\r\nExecute `godot --headless --export-debug \"Linux\"`\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/export/codesign.cpp b/editor/export/codesign.cpp\nindex cc53068d4812..f02895fadf1c 100644\n--- a/editor/export/codesign.cpp\n+++ b/editor/export/codesign.cpp\n@@ -214,7 +214,7 @@ bool CodeSignCodeResources::add_nested_file(const String &p_root, const String &\n \n \tVector<String> files_to_add;\n \tif (LipO::is_lipo(p_exepath)) {\n-\t\tString tmp_path_name = EditorPaths::get_singleton()->get_cache_dir().path_join(\"_lipo\");\n+\t\tString tmp_path_name = EditorPaths::get_singleton()->get_temp_dir().path_join(\"_lipo\");\n \t\tError err = da->make_dir_recursive(tmp_path_name);\n \t\tERR_FAIL_COND_V_MSG(err != OK, false, vformat(\"CodeSign/CodeResources: Failed to create \\\"%s\\\" subfolder.\", tmp_path_name));\n \t\tLipO lip;\n@@ -1248,7 +1248,7 @@ Error CodeSign::_codesign_file(bool p_use_hardened_runtime, bool p_force, const\n \tVector<String> files_to_sign;\n \tif (LipO::is_lipo(main_exe)) {\n \t\tprint_verbose(vformat(\"CodeSign: Executable is fat, extracting...\"));\n-\t\tString tmp_path_name = EditorPaths::get_singleton()->get_cache_dir().path_join(\"_lipo\");\n+\t\tString tmp_path_name = EditorPaths::get_singleton()->get_temp_dir().path_join(\"_lipo\");\n \t\tError err = da->make_dir_recursive(tmp_path_name);\n \t\tif (err != OK) {\n \t\t\tr_error_msg = vformat(TTR(\"Failed to create \\\"%s\\\" subfolder.\"), tmp_path_name);\ndiff --git a/editor/export/editor_export_platform.cpp b/editor/export/editor_export_platform.cpp\nindex 72fa20f6716b..cb496fc9f09e 100644\n--- a/editor/export/editor_export_platform.cpp\n+++ b/editor/export/editor_export_platform.cpp\n@@ -1528,7 +1528,7 @@ Error EditorExportPlatform::export_project_files(const Ref<EditorExportPreset> &\n \t}\n \n \tString config_file = \"project.binary\";\n-\tString engine_cfb = EditorPaths::get_singleton()->get_cache_dir().path_join(\"tmp\" + config_file);\n+\tString engine_cfb = EditorPaths::get_singleton()->get_temp_dir().path_join(\"tmp\" + config_file);\n \tProjectSettings::get_singleton()->save_custom(engine_cfb, custom_map, custom_list);\n \tVector<uint8_t> data = FileAccess::get_file_as_bytes(engine_cfb);\n \tDirAccess::remove_file_or_error(engine_cfb);\n@@ -1832,9 +1832,9 @@ Error EditorExportPlatform::save_pack(const Ref<EditorExportPreset> &p_preset, b\n \n \t// Create the temporary export directory if it doesn't exist.\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n-\tda->make_dir_recursive(EditorPaths::get_singleton()->get_cache_dir());\n+\tda->make_dir_recursive(EditorPaths::get_singleton()->get_temp_dir());\n \n-\tString tmppath = EditorPaths::get_singleton()->get_cache_dir().path_join(\"packtmp\");\n+\tString tmppath = EditorPaths::get_singleton()->get_temp_dir().path_join(\"packtmp\");\n \tRef<FileAccess> ftmp = FileAccess::open(tmppath, FileAccess::WRITE);\n \tif (ftmp.is_null()) {\n \t\tadd_message(EXPORT_MESSAGE_ERROR, TTR(\"Save PCK\"), vformat(TTR(\"Cannot create file \\\"%s\\\".\"), tmppath));\n@@ -2094,7 +2094,7 @@ Error EditorExportPlatform::save_zip(const Ref<EditorExportPreset> &p_preset, bo\n \t\tp_save_func = _save_zip_file;\n \t}\n \n-\tString tmppath = EditorPaths::get_singleton()->get_cache_dir().path_join(\"packtmp\");\n+\tString tmppath = EditorPaths::get_singleton()->get_temp_dir().path_join(\"packtmp\");\n \n \tRef<FileAccess> io_fa;\n \tzlib_filefunc_def io = zipio_create_io(&io_fa);\ndiff --git a/platform/android/export/export_plugin.cpp b/platform/android/export/export_plugin.cpp\nindex 293044a8fa0c..cc0f75802b5f 100644\n--- a/platform/android/export/export_plugin.cpp\n+++ b/platform/android/export/export_plugin.cpp\n@@ -2085,7 +2085,7 @@ Error EditorExportPlatformAndroid::run(const Ref<EditorExportPreset> &p_preset,\n \t\tp_debug_flags.set_flag(DEBUG_FLAG_REMOTE_DEBUG_LOCALHOST);\n \t}\n \n-\tString tmp_export_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"tmpexport.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n+\tString tmp_export_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"tmpexport.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n \n #define CLEANUP_AND_RETURN(m_err)                         \\\n \t{                                                     \\\n@@ -3445,7 +3445,7 @@ Error EditorExportPlatformAndroid::export_project_helper(const Ref<EditorExportP\n \tRef<FileAccess> io2_fa;\n \tzlib_filefunc_def io2 = zipio_create_io(&io2_fa);\n \n-\tString tmp_unaligned_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"tmpexport-unaligned.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n+\tString tmp_unaligned_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"tmpexport-unaligned.\" + uitos(OS::get_singleton()->get_unix_time()) + \".apk\");\n \n #define CLEANUP_AND_RETURN(m_err)                            \\\n \t{                                                        \\\ndiff --git a/platform/ios/export/export_plugin.cpp b/platform/ios/export/export_plugin.cpp\nindex 742127a10e18..667c883e386a 100644\n--- a/platform/ios/export/export_plugin.cpp\n+++ b/platform/ios/export/export_plugin.cpp\n@@ -2433,7 +2433,7 @@ Error EditorExportPlatformIOS::_export_project_helper(const Ref<EditorExportPres\n \tif (p_preset->get(\"application/generate_simulator_library_if_missing\").operator bool()) {\n \t\tString sim_lib_path = dest_dir + String(binary_name + \".xcframework\").path_join(\"ios-arm64_x86_64-simulator\").path_join(\"libgodot.a\");\n \t\tString dev_lib_path = dest_dir + String(binary_name + \".xcframework\").path_join(\"ios-arm64\").path_join(\"libgodot.a\");\n-\t\tString tmp_lib_path = EditorPaths::get_singleton()->get_cache_dir().path_join(binary_name + \"_lipo_\");\n+\t\tString tmp_lib_path = EditorPaths::get_singleton()->get_temp_dir().path_join(binary_name + \"_lipo_\");\n \t\tuint32_t cputype = 0;\n \t\tuint32_t cpusubtype = 0;\n \t\tif (!_archive_has_arm64(sim_lib_path, &cputype, &cpusubtype) && _archive_has_arm64(dev_lib_path) && FileAccess::exists(dev_lib_path)) {\n@@ -3111,19 +3111,19 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \tString id = \"tmpexport.\" + uitos(OS::get_singleton()->get_unix_time());\n \n \tRef<DirAccess> filesystem_da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n-\tERR_FAIL_COND_V_MSG(filesystem_da.is_null(), ERR_CANT_CREATE, \"Cannot create DirAccess for path '\" + EditorPaths::get_singleton()->get_cache_dir() + \"'.\");\n-\tfilesystem_da->make_dir_recursive(EditorPaths::get_singleton()->get_cache_dir().path_join(id));\n-\tString tmp_export_path = EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.ipa\");\n-\n-#define CLEANUP_AND_RETURN(m_err)                                                                           \\\n-\t{                                                                                                       \\\n-\t\tif (filesystem_da->change_dir(EditorPaths::get_singleton()->get_cache_dir().path_join(id)) == OK) { \\\n-\t\t\tfilesystem_da->erase_contents_recursive();                                                      \\\n-\t\t\tfilesystem_da->change_dir(\"..\");                                                                \\\n-\t\t\tfilesystem_da->remove(id);                                                                      \\\n-\t\t}                                                                                                   \\\n-\t\treturn m_err;                                                                                       \\\n-\t}                                                                                                       \\\n+\tERR_FAIL_COND_V_MSG(filesystem_da.is_null(), ERR_CANT_CREATE, \"Cannot create DirAccess for path '\" + EditorPaths::get_singleton()->get_temp_dir() + \"'.\");\n+\tfilesystem_da->make_dir_recursive(EditorPaths::get_singleton()->get_temp_dir().path_join(id));\n+\tString tmp_export_path = EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.ipa\");\n+\n+#define CLEANUP_AND_RETURN(m_err)                                                                          \\\n+\t{                                                                                                      \\\n+\t\tif (filesystem_da->change_dir(EditorPaths::get_singleton()->get_temp_dir().path_join(id)) == OK) { \\\n+\t\t\tfilesystem_da->erase_contents_recursive();                                                     \\\n+\t\t\tfilesystem_da->change_dir(\"..\");                                                               \\\n+\t\t\tfilesystem_da->remove(id);                                                                     \\\n+\t\t}                                                                                                  \\\n+\t\treturn m_err;                                                                                      \\\n+\t}                                                                                                      \\\n \t((void)0)\n \n \tDevice dev = devices[p_device];\n@@ -3193,7 +3193,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\targs.push_back(\"simctl\");\n \t\t\targs.push_back(\"install\");\n \t\t\targs.push_back(dev.id);\n-\t\t\targs.push_back(EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n+\t\t\targs.push_back(EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n \n \t\t\tString log;\n \t\t\tint ec;\n@@ -3246,7 +3246,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\targs.push_back(dev.id);\n \t\t\targs.push_back(\"--justlaunch\");\n \t\t\targs.push_back(\"--bundle\");\n-\t\t\targs.push_back(EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n+\t\t\targs.push_back(EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n \t\t\tString app_args;\n \t\t\tfor (const String &E : cmd_args_list) {\n \t\t\t\tapp_args += E + \" \";\n@@ -3285,7 +3285,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\targs.push_back(\"app\");\n \t\t\targs.push_back(\"-d\");\n \t\t\targs.push_back(dev.id);\n-\t\t\targs.push_back(EditorPaths::get_singleton()->get_cache_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n+\t\t\targs.push_back(EditorPaths::get_singleton()->get_temp_dir().path_join(id).path_join(\"export.xcarchive/Products/Applications/export.app\"));\n \n \t\t\tString log;\n \t\t\tint ec;\ndiff --git a/platform/linuxbsd/export/export_plugin.cpp b/platform/linuxbsd/export/export_plugin.cpp\nindex 7cd77dd5937c..9362aee5e4cf 100644\n--- a/platform/linuxbsd/export/export_plugin.cpp\n+++ b/platform/linuxbsd/export/export_plugin.cpp\n@@ -88,7 +88,7 @@ Error EditorExportPlatformLinuxBSD::export_project(const Ref<EditorExportPreset>\n \n \t// Setup temp folder.\n \tString path = p_path;\n-\tString tmp_dir_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name);\n+\tString tmp_dir_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name);\n \n \tRef<DirAccess> tmp_app_dir = DirAccess::create_for_path(tmp_dir_path);\n \tif (export_as_zip) {\n@@ -468,7 +468,7 @@ Error EditorExportPlatformLinuxBSD::run(const Ref<EditorExportPreset> &p_preset,\n \n \tEditorProgress ep(\"run\", TTR(\"Running...\"), 5);\n \n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"linuxbsd\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"linuxbsd\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\ndiff --git a/platform/macos/export/export_plugin.cpp b/platform/macos/export/export_plugin.cpp\nindex b9f9d8d613a8..d795adbe33b2 100644\n--- a/platform/macos/export/export_plugin.cpp\n+++ b/platform/macos/export/export_plugin.cpp\n@@ -1592,7 +1592,7 @@ Error EditorExportPlatformMacOS::export_project(const Ref<EditorExportPreset> &p\n \t\ttmp_app_path_name = p_path;\n \t\tscr_path = p_path.get_basename() + \".command\";\n \t} else {\n-\t\ttmp_base_path_name = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name);\n+\t\ttmp_base_path_name = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name);\n \t\ttmp_app_path_name = tmp_base_path_name.path_join(tmp_app_dir_name);\n \t\tscr_path = tmp_base_path_name.path_join(pkg_name + \".command\");\n \t}\n@@ -1987,9 +1987,9 @@ Error EditorExportPlatformMacOS::export_project(const Ref<EditorExportPreset> &p\n \n \t\tbool sandbox = p_preset->get(\"codesign/entitlements/app_sandbox/enabled\");\n \t\tString ent_path = p_preset->get(\"codesign/entitlements/custom_file\");\n-\t\tString hlp_ent_path = sandbox ? EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name + \"_helper.entitlements\") : ent_path;\n+\t\tString hlp_ent_path = sandbox ? EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name + \"_helper.entitlements\") : ent_path;\n \t\tif (sign_enabled && (ent_path.is_empty())) {\n-\t\t\tent_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name + \".entitlements\");\n+\t\t\tent_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name + \".entitlements\");\n \n \t\t\tRef<FileAccess> ent_f = FileAccess::open(ent_path, FileAccess::WRITE);\n \t\t\tif (ent_f.is_valid()) {\n@@ -2269,7 +2269,7 @@ Error EditorExportPlatformMacOS::export_project(const Ref<EditorExportPreset> &p\n \t\t} else if (export_format == \"app\" && noto_enabled) {\n \t\t\t// Create temporary ZIP.\n \t\t\tif (err == OK) {\n-\t\t\t\tnoto_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name + \".zip\");\n+\t\t\t\tnoto_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name + \".zip\");\n \n \t\t\t\tif (ep.step(TTR(\"Making ZIP\"), 3)) {\n \t\t\t\t\treturn ERR_SKIP;\n@@ -2554,7 +2554,7 @@ Error EditorExportPlatformMacOS::run(const Ref<EditorExportPreset> &p_preset, in\n \n \tEditorProgress ep(\"run\", TTR(\"Running...\"), 5);\n \n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"macos\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"macos\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\ndiff --git a/platform/web/export/editor_http_server.cpp b/platform/web/export/editor_http_server.cpp\nindex 9cf862eb1ed1..26b9a626db05 100644\n--- a/platform/web/export/editor_http_server.cpp\n+++ b/platform/web/export/editor_http_server.cpp\n@@ -86,7 +86,7 @@ void EditorHTTPServer::_send_response() {\n \n \tconst String req_file = path.get_file();\n \tconst String req_ext = path.get_extension();\n-\tconst String cache_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"web\");\n+\tconst String cache_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"web\");\n \tconst String filepath = cache_path.path_join(req_file);\n \n \tif (!mimes.has(req_ext) || !FileAccess::exists(filepath)) {\ndiff --git a/platform/web/export/export_plugin.cpp b/platform/web/export/export_plugin.cpp\nindex 9e60a76fdc2c..9d212d81ffe9 100644\n--- a/platform/web/export/export_plugin.cpp\n+++ b/platform/web/export/export_plugin.cpp\n@@ -817,7 +817,7 @@ Error EditorExportPlatformWeb::run(const Ref<EditorExportPreset> &p_preset, int\n }\n \n Error EditorExportPlatformWeb::_export_project(const Ref<EditorExportPreset> &p_preset, int p_debug_flags) {\n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"web\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"web\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\ndiff --git a/platform/windows/export/export_plugin.cpp b/platform/windows/export/export_plugin.cpp\nindex 8d3f4bb26911..65fbc59310fb 100644\n--- a/platform/windows/export/export_plugin.cpp\n+++ b/platform/windows/export/export_plugin.cpp\n@@ -257,7 +257,7 @@ Error EditorExportPlatformWindows::export_project(const Ref<EditorExportPreset>\n \n \t// Setup temp folder.\n \tString path = p_path;\n-\tString tmp_dir_path = EditorPaths::get_singleton()->get_cache_dir().path_join(pkg_name);\n+\tString tmp_dir_path = EditorPaths::get_singleton()->get_temp_dir().path_join(pkg_name);\n \tRef<DirAccess> tmp_app_dir = DirAccess::create_for_path(tmp_dir_path);\n \tif (export_as_zip) {\n \t\tif (tmp_app_dir.is_null()) {\n@@ -501,7 +501,7 @@ Error EditorExportPlatformWindows::_rcedit_add_data(const Ref<EditorExportPreset\n \t\t}\n \t}\n \n-\tString tmp_icon_path = EditorPaths::get_singleton()->get_cache_dir().path_join(\"_rcedit.ico\");\n+\tString tmp_icon_path = EditorPaths::get_singleton()->get_temp_dir().path_join(\"_rcedit.ico\");\n \tif (!icon_path.is_empty()) {\n \t\tif (_process_icon(p_preset, icon_path, tmp_icon_path) != OK) {\n \t\t\tadd_message(EXPORT_MESSAGE_WARNING, TTR(\"Resources Modification\"), vformat(TTR(\"Invalid icon file \\\"%s\\\".\"), icon_path));\n@@ -1004,7 +1004,7 @@ Error EditorExportPlatformWindows::run(const Ref<EditorExportPreset> &p_preset,\n \n \tEditorProgress ep(\"run\", TTR(\"Running...\"), 5);\n \n-\tconst String dest = EditorPaths::get_singleton()->get_cache_dir().path_join(\"windows\");\n+\tconst String dest = EditorPaths::get_singleton()->get_temp_dir().path_join(\"windows\");\n \tRef<DirAccess> da = DirAccess::create(DirAccess::ACCESS_FILESYSTEM);\n \tif (!da->dir_exists(dest)) {\n \t\tError err = da->make_dir_recursive(dest);\n", "instance_id": "godotengine__godot-100150", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: exporting a project in Godot fails when the $HOME directory is readonly or invalid (e.g., set to /var/empty or /dev/null), which is particularly relevant for CI builds. It provides specific steps to reproduce the issue, including the command used and the environment setup, as well as the context of why this matters (CI builds avoiding root user). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the expected behavior or desired outcome (e.g., should Godot use a different directory when $HOME is invalid?). Additionally, it lacks details on specific error messages or logs that could help in understanding the failure mode. Edge cases beyond readonly/invalid $HOME paths are not discussed, and there are no examples of what a successful export should look like under these conditions. Despite these minor gaps, the issue is valid and the goal is reasonably inferable from the context and code changes (switching from cache_dir to temp_dir).", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are widespread across multiple files (spanning editor export functionality for various platforms like Linux, macOS, Windows, Android, iOS, and Web), but the nature of the change is consistent and straightforward\u2014replacing calls to `EditorPaths::get_singleton()->get_cache_dir()` with `EditorPaths::get_singleton()->get_temp_dir()`. This does not impact the system's architecture or require deep understanding of interactions between modules. The changes are essentially a find-and-replace operation with minimal logic modification, affecting temporary file path generation but not core functionality. The overall amount of code change is moderate due to the number of files, but the complexity per change is low.\n\n2. **Number of Technical Concepts**: The solution requires basic understanding of file system paths and directory access in the context of the Godot engine's `EditorPaths` singleton. No advanced language features, complex algorithms, design patterns, or domain-specific knowledge beyond basic file I/O are needed. The concept of switching from a cache directory (likely tied to $HOME) to a temporary directory (likely more resilient to readonly $HOME) is simple and does not involve intricate logic.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention additional edge cases beyond readonly or invalid $HOME paths, and the code changes do not introduce new error handling logic. The existing error handling (e.g., checking if directories can be created or files can be accessed) remains unchanged in behavior, only the path used is updated. There is no indication of complex edge cases requiring special attention in the provided diff.\n\n4. **Overall Complexity**: While the changes touch multiple platform-specific export plugins, the uniformity of the fix (changing the directory source) and the lack of need for deep architectural understanding or performance optimization make this a relatively easy task. A developer with basic familiarity with the Godot codebase or similar systems could implement this change without significant challenges.\n\nThus, a difficulty score of 0.30 reflects the simplicity of the logic and concepts involved, balanced by the moderate scope of files affected. It requires understanding some code logic and making simple modifications across several locations, fitting well within the \"Easy\" category.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.3}
{"problem_statement": "build: `cmake --install` fails if only select targets are built\nNoticed this when going to update the [lighting docs](https://github.com/ElementsProject/lightning/blob/master/doc/getting-started/getting-started/installation.md), porting what they do using Autotools. i.e:\n```bash\n./autogen.sh\n./configure\nmake src/bitcoind src/bitcoin-cli\nmake install\n```\n\nIf you attempt the same with master:\n```bash\ncmake -B build\ncmake --build build --target bitcoind bitcoin-cli\ncmake --install build\n-- Install configuration: \"RelWithDebInfo\"\nCMake Error at build/src/test/cmake_install.cmake:57 (file):\n  file INSTALL cannot find \"/root/ci_scratch/build/src/test/test_bitcoin\": No\n  such file or directory.\nCall Stack (most recent call first):\n  build/src/cmake_install.cmake:77 (include)\n  build/cmake_install.cmake:57 (include)\n```\n\nThe output of `cmake --build build --target list_install_components` just prints (if configured with the kernel):\n```bash\ncmake --build build --target list_install_components \n> Available install components are: \"Kernel\" \"Unspecified\"\n```\nso it seems like component based install either isn't yet possible, or the names are not easily discoverable.\n\nOtherwise, I don't think we should fail to install because we can't find a binary the user didn't want.\n", "patch": "diff --git a/cmake/module/InstallBinaryComponent.cmake b/cmake/module/InstallBinaryComponent.cmake\nnew file mode 100644\nindex 0000000000000..c7b2ed9ae6a48\n--- /dev/null\n+++ b/cmake/module/InstallBinaryComponent.cmake\n@@ -0,0 +1,26 @@\n+# Copyright (c) 2025-present The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or https://opensource.org/license/mit/.\n+\n+include_guard(GLOBAL)\n+include(GNUInstallDirs)\n+\n+function(install_binary_component component)\n+  cmake_parse_arguments(PARSE_ARGV 1\n+    IC                # prefix\n+    \"HAS_MANPAGE\"     # options\n+    \"\"                # one_value_keywords\n+    \"\"                # multi_value_keywords\n+  )\n+  set(target_name ${component})\n+  install(TARGETS ${target_name}\n+    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n+    COMPONENT ${component}\n+  )\n+  if(INSTALL_MAN AND IC_HAS_MANPAGE)\n+    install(FILES ${PROJECT_SOURCE_DIR}/doc/man/${target_name}.1\n+      DESTINATION ${CMAKE_INSTALL_MANDIR}/man1\n+      COMPONENT ${component}\n+    )\n+  endif()\n+endfunction()\ndiff --git a/cmake/module/Maintenance.cmake b/cmake/module/Maintenance.cmake\nindex 61251d24397b3..bc3868184bf4c 100644\n--- a/cmake/module/Maintenance.cmake\n+++ b/cmake/module/Maintenance.cmake\n@@ -103,7 +103,7 @@ function(add_macos_deploy_target)\n \n     add_custom_command(\n       OUTPUT ${PROJECT_BINARY_DIR}/${macos_app}/Contents/MacOS/Bitcoin-Qt\n-      COMMAND ${CMAKE_COMMAND} --install ${PROJECT_BINARY_DIR} --config $<CONFIG> --component GUI --prefix ${macos_app}/Contents/MacOS --strip\n+      COMMAND ${CMAKE_COMMAND} --install ${PROJECT_BINARY_DIR} --config $<CONFIG> --component bitcoin-qt --prefix ${macos_app}/Contents/MacOS --strip\n       COMMAND ${CMAKE_COMMAND} -E rename ${macos_app}/Contents/MacOS/bin/$<TARGET_FILE_NAME:bitcoin-qt> ${macos_app}/Contents/MacOS/Bitcoin-Qt\n       COMMAND ${CMAKE_COMMAND} -E rm -rf ${macos_app}/Contents/MacOS/bin\n       VERBATIM\ndiff --git a/src/CMakeLists.txt b/src/CMakeLists.txt\nindex 8c42359d2d550..07544f59cfa04 100644\n--- a/src/CMakeLists.txt\n+++ b/src/CMakeLists.txt\n@@ -2,7 +2,6 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or https://opensource.org/license/mit/.\n \n-include(GNUInstallDirs)\n include(AddWindowsResources)\n \n configure_file(${PROJECT_SOURCE_DIR}/cmake/bitcoin-build-config.h.in bitcoin-build-config.h USE_SOURCE_PERMISSIONS @ONLY)\n@@ -170,8 +169,8 @@ target_link_libraries(bitcoin_common\n     $<$<PLATFORM_ID:Windows>:ws2_32>\n )\n \n+include(InstallBinaryComponent)\n \n-set(installable_targets)\n if(ENABLE_WALLET)\n   add_subdirectory(wallet)\n \n@@ -189,7 +188,7 @@ if(ENABLE_WALLET)\n       bitcoin_util\n       Boost::headers\n     )\n-    list(APPEND installable_targets bitcoin-wallet)\n+    install_binary_component(bitcoin-wallet HAS_MANPAGE)\n   endif()\n endif()\n \n@@ -318,7 +317,7 @@ if(BUILD_DAEMON)\n     bitcoin_node\n     $<TARGET_NAME_IF_EXISTS:bitcoin_wallet>\n   )\n-  list(APPEND installable_targets bitcoind)\n+  install_binary_component(bitcoind HAS_MANPAGE)\n endif()\n if(WITH_MULTIPROCESS AND BUILD_DAEMON)\n   add_executable(bitcoin-node\n@@ -331,7 +330,7 @@ if(WITH_MULTIPROCESS AND BUILD_DAEMON)\n     bitcoin_ipc\n     $<TARGET_NAME_IF_EXISTS:bitcoin_wallet>\n   )\n-  list(APPEND installable_targets bitcoin-node)\n+  install_binary_component(bitcoin-node)\n endif()\n \n if(WITH_MULTIPROCESS AND BUILD_TESTS)\n@@ -374,7 +373,7 @@ if(BUILD_CLI)\n     libevent::core\n     libevent::extra\n   )\n-  list(APPEND installable_targets bitcoin-cli)\n+  install_binary_component(bitcoin-cli HAS_MANPAGE)\n endif()\n \n \n@@ -387,7 +386,7 @@ if(BUILD_TX)\n     bitcoin_util\n     univalue\n   )\n-  list(APPEND installable_targets bitcoin-tx)\n+  install_binary_component(bitcoin-tx HAS_MANPAGE)\n endif()\n \n \n@@ -399,7 +398,7 @@ if(BUILD_UTIL)\n     bitcoin_common\n     bitcoin_util\n   )\n-  list(APPEND installable_targets bitcoin-util)\n+  install_binary_component(bitcoin-util HAS_MANPAGE)\n endif()\n \n \n@@ -445,17 +444,3 @@ endif()\n if(BUILD_FUZZ_BINARY)\n   add_subdirectory(test/fuzz)\n endif()\n-\n-\n-install(TARGETS ${installable_targets}\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-)\n-unset(installable_targets)\n-\n-if(INSTALL_MAN)\n-  # TODO: these stubs are no longer needed. man pages should be generated at install time.\n-  install(DIRECTORY ../doc/man/\n-    DESTINATION ${CMAKE_INSTALL_MANDIR}/man1\n-    FILES_MATCHING PATTERN *.1\n-  )\n-endif()\ndiff --git a/src/bench/CMakeLists.txt b/src/bench/CMakeLists.txt\nindex c55bbb1e05f8a..43b0dcdabe6c6 100644\n--- a/src/bench/CMakeLists.txt\n+++ b/src/bench/CMakeLists.txt\n@@ -81,6 +81,4 @@ add_test(NAME bench_sanity_check_high_priority\n   COMMAND bench_bitcoin -sanity-check -priority-level=high\n )\n \n-install(TARGETS bench_bitcoin\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-)\n+install_binary_component(bench_bitcoin)\ndiff --git a/src/kernel/CMakeLists.txt b/src/kernel/CMakeLists.txt\nindex 2e07ba042a40a..9dae4b88111e6 100644\n--- a/src/kernel/CMakeLists.txt\n+++ b/src/kernel/CMakeLists.txt\n@@ -2,6 +2,8 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or https://opensource.org/license/mit/.\n \n+include(GNUInstallDirs)\n+\n # TODO: libbitcoinkernel is a work in progress consensus engine\n #       library, as more and more modules are decoupled from the\n #       consensus engine, this list will shrink to only those\n@@ -121,24 +123,23 @@ if(NOT BUILD_SHARED_LIBS)\n   set(all_kernel_static_link_libs \"\")\n   get_target_static_link_libs(bitcoinkernel all_kernel_static_link_libs)\n \n-  install(TARGETS ${all_kernel_static_link_libs} ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT Kernel)\n+  install(TARGETS ${all_kernel_static_link_libs} ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT bitcoinkernel)\n   list(TRANSFORM all_kernel_static_link_libs PREPEND \"-l\")\n   # LIBS_PRIVATE is substituted in the pkg-config file.\n   list(JOIN all_kernel_static_link_libs \" \" LIBS_PRIVATE)\n endif()\n \n configure_file(${PROJECT_SOURCE_DIR}/libbitcoinkernel.pc.in ${PROJECT_BINARY_DIR}/libbitcoinkernel.pc @ONLY)\n-install(FILES ${PROJECT_BINARY_DIR}/libbitcoinkernel.pc DESTINATION \"${CMAKE_INSTALL_LIBDIR}/pkgconfig\" COMPONENT Kernel)\n+install(FILES ${PROJECT_BINARY_DIR}/libbitcoinkernel.pc DESTINATION \"${CMAKE_INSTALL_LIBDIR}/pkgconfig\" COMPONENT bitcoinkernel)\n \n-include(GNUInstallDirs)\n install(TARGETS bitcoinkernel\n   RUNTIME\n     DESTINATION ${CMAKE_INSTALL_BINDIR}\n-    COMPONENT Kernel\n+    COMPONENT bitcoinkernel\n   LIBRARY\n     DESTINATION ${CMAKE_INSTALL_LIBDIR}\n-    COMPONENT Kernel\n+    COMPONENT bitcoinkernel\n   ARCHIVE\n     DESTINATION ${CMAKE_INSTALL_LIBDIR}\n-    COMPONENT Kernel\n+    COMPONENT bitcoinkernel\n )\ndiff --git a/src/qt/CMakeLists.txt b/src/qt/CMakeLists.txt\nindex a1f39037f220b..7fbbd81c415ae 100644\n--- a/src/qt/CMakeLists.txt\n+++ b/src/qt/CMakeLists.txt\n@@ -236,7 +236,7 @@ target_link_libraries(bitcoin-qt\n )\n \n import_plugins(bitcoin-qt)\n-set(installable_targets bitcoin-qt)\n+install_binary_component(bitcoin-qt HAS_MANPAGE)\n if(WIN32)\n   set_target_properties(bitcoin-qt PROPERTIES WIN32_EXECUTABLE TRUE)\n endif()\n@@ -253,17 +253,12 @@ if(WITH_MULTIPROCESS)\n     bitcoin_ipc\n   )\n   import_plugins(bitcoin-gui)\n-  list(APPEND installable_targets bitcoin-gui)\n+  install_binary_component(bitcoin-gui)\n   if(WIN32)\n     set_target_properties(bitcoin-gui PROPERTIES WIN32_EXECUTABLE TRUE)\n   endif()\n endif()\n \n-install(TARGETS ${installable_targets}\n-  RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}\n-  COMPONENT GUI\n-)\n-\n if(BUILD_GUI_TESTS)\n   add_subdirectory(test)\n endif()\n", "instance_id": "bitcoin__bitcoin-31844", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `cmake --install` command fails when only specific targets are built, due to missing binaries or components that weren't requested by the user. It provides a concrete example with command sequences and error output, which helps in understanding the problem context. However, there are minor ambiguities and missing details. For instance, it does not explicitly define the expected behavior (e.g., should `cmake --install` only install the built targets, or is there a broader component-based installation strategy expected?). Additionally, the statement mentions that component-based installation might not be possible or discoverable, but it lacks specifics on whether the goal is to enable such functionality or simply to prevent installation failures. Constraints or desired outcomes for edge cases (e.g., what happens if no targets are built) are also not specified. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, as they span multiple files (`CMakeLists.txt` in various subdirectories and a new `InstallBinaryComponent.cmake` module) and involve modifying the build system logic, which is a critical part of the codebase. Understanding and modifying CMake configurations requires a deep knowledge of build system internals, including target installation, component grouping, and conditional logic for features like manpage installation. Second, the technical concepts involved are moderately complex, including familiarity with CMake's component-based installation, GNUInstallDirs, and custom function definitions for modularizing installation logic. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest the need to handle scenarios like optional builds (e.g., wallet, GUI) and conditional installations (e.g., manpages), which adds to the complexity of ensuring robustness. Finally, the changes impact the build system's architecture by introducing a reusable installation component mechanism, which requires careful consideration to avoid breaking existing workflows or introducing regressions in different build configurations. While not at the extreme end of difficulty (e.g., requiring advanced domain-specific knowledge like consensus protocols), this problem demands a solid understanding of build systems and careful implementation across multiple parts of the codebase, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.65}
{"problem_statement": "fuzz: wallet_bdb_parser: implicit-signed-integer-truncation wallet/migrate.cpp:554:35 \nFull error:\r\n\r\n```\r\nwallet/migrate.cpp:554:35: runtime error: implicit conversion from type 'int64_t' (aka 'long') of value -1 (64-bit, signed) to type 'uint32_t' (aka 'unsigned int') changed the value to 4294967295 (32-bit, unsigned)\r\n```\r\n\r\nThe code:\r\n\r\n```cpp\r\nuint32_t expected_last_page = (size / page_size) - 1;\r\n```\r\n\r\nThis may lead to a fuzz runtime error when `(size / page_size)` is `0`. I don't think this can lead to issues for real users, because it can only happen with corrupt files and the next line should throw `\"Last page number could not fit in file\"`, or in the case where `outer_meta.last_page` is corrupt as well, and equal to `4294967295`, the following read should fail and throw.\n", "patch": "diff --git a/src/wallet/migrate.cpp b/src/wallet/migrate.cpp\nindex 09254a76ad89a..d7d8577374346 100644\n--- a/src/wallet/migrate.cpp\n+++ b/src/wallet/migrate.cpp\n@@ -551,7 +551,7 @@ void BerkeleyRODatabase::Open()\n     // }\n \n     // Check the last page number\n-    uint32_t expected_last_page = (size / page_size) - 1;\n+    uint32_t expected_last_page{uint32_t((size / page_size) - 1)};\n     if (outer_meta.last_page != expected_last_page) {\n         throw std::runtime_error(\"Last page number could not fit in file\");\n     }\n", "instance_id": "bitcoin__bitcoin-30248", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: an implicit signed-to-unsigned integer truncation error during a fuzz test in the `wallet/migrate.cpp` file. It provides the specific line of code causing the issue, the error message, and a brief explanation of why this might not affect real users (due to expected exceptions for corrupt files). However, there are minor ambiguities. The statement does not explicitly define the expected behavior or constraints for valid input (e.g., minimum file size or page size values). Additionally, while it mentions that this issue likely only occurs with corrupt files, it does not provide detailed context about the surrounding codebase or the purpose of the `expected_last_page` calculation, which could be critical for a complete understanding. Overall, the problem is valid and mostly clear, but it lacks some minor contextual details and explicit handling instructions for edge cases.", "difficulty_explanation": "The difficulty of this problem is very low, falling in the 0.0-0.2 range. The issue is a straightforward type casting problem that can be resolved with a simple code modification\u2014adding an explicit cast to `uint32_t` as shown in the diff. The scope of the change is minimal, affecting only a single line in one file (`wallet/migrate.cpp`), with no impact on the broader codebase or system architecture. The technical concepts involved are basic: understanding integer type casting and potential truncation issues in C++, which are fundamental for any developer with moderate experience in the language. No complex algorithms, design patterns, or domain-specific knowledge are required. Regarding edge cases, the problem statement suggests that real-world impact is unlikely due to existing error handling (throwing an exception for corrupt files), and the code change does not introduce or modify any error handling logic. Overall, this is a very easy fix requiring minimal effort and understanding.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.15}
{"problem_statement": "Possible savings in `dumptxoutset` serialization format (~20%)\n**Is your feature request related to a problem? Please describe.**\r\n\r\nSize of the serialized UTXO set\r\n\r\n**Describe the solution you'd like**\r\n\r\nThe serialization format of the serialized UTXO set from `dumptxoutset` is a list of `(COutPoint, Coin)`.\r\n\r\nHowever, many out points refer to the same transaction so we can group by `Txid` with:\r\n`list(Txid, list((vout,Coin))`\r\n\r\nSince the cursor is already iterating through sorted `Txid` this doesn't add complexity to the serialization code.\r\n\r\nConsidering the UTXO at height 745995:\r\n```\r\nserialized_size: ~5.3Gb\r\ntotal_elements: 83_082_178\r\nuniques_txids: 49_517_483\r\nbytes_lost: total_elements // due to the additional byte for the length of the inner list\r\nbytes_savings: (total_elements-unique_txids)*32 - bytes_lost ~= 1Gb\r\n```\r\n\r\n**Describe alternatives you've considered**\r\n\r\nAdditional bytes could be saved by leveraging the duplications in scripts (address reuse). However, this is not considered worthy because the format would lose the streaming property and also because we don't want to optimize on something which is not recommended.\r\n\r\nThe byte lost for expressing the length of the inner list could be optimized with a special byte containing both the length of the list and the first vout, since usually both vout and this value are very small they should fit on a single byte most of the time having a fallback for edge cases.\r\n\r\n**Additional context**\r\n\r\nTagging @jamesob author of https://github.com/bitcoin/bitcoin/pull/16899\r\nassumeutxo summary https://github.com/bitcoin/bitcoin/pull/15606\r\n\n", "patch": "diff --git a/src/kernel/chainparams.cpp b/src/kernel/chainparams.cpp\nindex 26c261eba2725..de142cd2c9189 100644\n--- a/src/kernel/chainparams.cpp\n+++ b/src/kernel/chainparams.cpp\n@@ -542,3 +542,33 @@ std::unique_ptr<const CChainParams> CChainParams::TestNet()\n {\n     return std::make_unique<const CTestNetParams>();\n }\n+\n+std::vector<int> CChainParams::GetAvailableSnapshotHeights() const\n+{\n+    std::vector<int> heights;\n+    heights.reserve(m_assumeutxo_data.size());\n+\n+    for (const auto& data : m_assumeutxo_data) {\n+        heights.emplace_back(data.height);\n+    }\n+    return heights;\n+}\n+\n+std::optional<ChainType> GetNetworkForMagic(MessageStartChars& message)\n+{\n+    const auto mainnet_msg = CChainParams::Main()->MessageStart();\n+    const auto testnet_msg = CChainParams::TestNet()->MessageStart();\n+    const auto regtest_msg = CChainParams::RegTest({})->MessageStart();\n+    const auto signet_msg = CChainParams::SigNet({})->MessageStart();\n+\n+    if (std::equal(message.begin(), message.end(), mainnet_msg.data())) {\n+        return ChainType::MAIN;\n+    } else if (std::equal(message.begin(), message.end(), testnet_msg.data())) {\n+        return ChainType::TESTNET;\n+    } else if (std::equal(message.begin(), message.end(), regtest_msg.data())) {\n+        return ChainType::REGTEST;\n+    } else if (std::equal(message.begin(), message.end(), signet_msg.data())) {\n+        return ChainType::SIGNET;\n+    }\n+    return std::nullopt;\n+}\ndiff --git a/src/kernel/chainparams.h b/src/kernel/chainparams.h\nindex 7a5539bc71c54..f396c1b42caee 100644\n--- a/src/kernel/chainparams.h\n+++ b/src/kernel/chainparams.h\n@@ -93,6 +93,7 @@ class CChainParams\n     const Consensus::Params& GetConsensus() const { return consensus; }\n     const MessageStartChars& MessageStart() const { return pchMessageStart; }\n     uint16_t GetDefaultPort() const { return nDefaultPort; }\n+    std::vector<int> GetAvailableSnapshotHeights() const;\n \n     const CBlock& GenesisBlock() const { return genesis; }\n     /** Default value for -checkmempool and -checkblockindex argument */\n@@ -183,4 +184,6 @@ class CChainParams\n     ChainTxData chainTxData;\n };\n \n+std::optional<ChainType> GetNetworkForMagic(MessageStartChars& pchMessageStart);\n+\n #endif // BITCOIN_KERNEL_CHAINPARAMS_H\ndiff --git a/src/node/utxo_snapshot.h b/src/node/utxo_snapshot.h\nindex 1160bb55f0762..256a4a601d32f 100644\n--- a/src/node/utxo_snapshot.h\n+++ b/src/node/utxo_snapshot.h\n@@ -6,16 +6,22 @@\n #ifndef BITCOIN_NODE_UTXO_SNAPSHOT_H\n #define BITCOIN_NODE_UTXO_SNAPSHOT_H\n \n+#include <chainparams.h>\n+#include <kernel/chainparams.h>\n #include <kernel/cs_main.h>\n #include <serialize.h>\n #include <sync.h>\n #include <uint256.h>\n+#include <util/chaintype.h>\n #include <util/fs.h>\n \n #include <cstdint>\n #include <optional>\n #include <string_view>\n \n+// UTXO set snapshot magic bytes\n+static constexpr std::array<uint8_t, 5> SNAPSHOT_MAGIC_BYTES = {'u', 't', 'x', 'o', 0xff};\n+\n class Chainstate;\n \n namespace node {\n@@ -23,10 +29,14 @@ namespace node {\n //! assumeutxo Chainstate can be constructed.\n class SnapshotMetadata\n {\n+    const uint16_t m_version{1};\n+    const std::set<uint16_t> m_supported_versions{1};\n public:\n     //! The hash of the block that reflects the tip of the chain for the\n     //! UTXO set contained in this snapshot.\n     uint256 m_base_blockhash;\n+    uint32_t m_base_blockheight;\n+\n \n     //! The number of coins in the UTXO set contained in this snapshot. Used\n     //! during snapshot load to estimate progress of UTXO set reconstruction.\n@@ -35,11 +45,55 @@ class SnapshotMetadata\n     SnapshotMetadata() { }\n     SnapshotMetadata(\n         const uint256& base_blockhash,\n+        const int base_blockheight,\n         uint64_t coins_count) :\n             m_base_blockhash(base_blockhash),\n+            m_base_blockheight(base_blockheight),\n             m_coins_count(coins_count) { }\n \n-    SERIALIZE_METHODS(SnapshotMetadata, obj) { READWRITE(obj.m_base_blockhash, obj.m_coins_count); }\n+    template <typename Stream>\n+    inline void Serialize(Stream& s) const {\n+        s << SNAPSHOT_MAGIC_BYTES;\n+        s << m_version;\n+        s << Params().MessageStart();\n+        s << m_base_blockheight;\n+        s << m_base_blockhash;\n+        s << m_coins_count;\n+    }\n+\n+    template <typename Stream>\n+    inline void Unserialize(Stream& s) {\n+        // Read the snapshot magic bytes\n+        std::array<uint8_t, SNAPSHOT_MAGIC_BYTES.size()> snapshot_magic;\n+        s >> snapshot_magic;\n+        if (snapshot_magic != SNAPSHOT_MAGIC_BYTES) {\n+            throw std::ios_base::failure(\"Invalid UTXO set snapshot magic bytes. Please check if this is indeed a snapshot file or if you are using an outdated snapshot format.\");\n+        }\n+\n+        // Read the version\n+        uint16_t version;\n+        s >> version;\n+        if (m_supported_versions.find(version) == m_supported_versions.end()) {\n+            throw std::ios_base::failure(strprintf(\"Version of snapshot %s does not match any of the supported versions.\", version));\n+        }\n+\n+        // Read the network magic (pchMessageStart)\n+        MessageStartChars message;\n+        s >> message;\n+        if (!std::equal(message.begin(), message.end(), Params().MessageStart().data())) {\n+            auto metadata_network = GetNetworkForMagic(message);\n+            if (metadata_network) {\n+                std::string network_string{ChainTypeToString(metadata_network.value())};\n+                throw std::ios_base::failure(strprintf(\"The network of the snapshot (%s) does not match the network of this node (%s).\", network_string, Params().GetChainTypeString()));\n+            } else {\n+                throw std::ios_base::failure(\"This snapshot has been created for an unrecognized network. This could be a custom signet, a new testnet or possibly caused by data corruption.\");\n+            }\n+        }\n+\n+        s >> m_base_blockheight;\n+        s >> m_base_blockhash;\n+        s >> m_coins_count;\n+    }\n };\n \n //! The file in the snapshot chainstate dir which stores the base blockhash. This is\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex eed004806a83b..f429826fcbe44 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -34,6 +34,7 @@\n #include <rpc/server_util.h>\n #include <rpc/util.h>\n #include <script/descriptor.h>\n+#include <serialize.h>\n #include <streams.h>\n #include <sync.h>\n #include <txdb.h>\n@@ -2690,29 +2691,60 @@ UniValue CreateUTXOSnapshot(\n         tip->nHeight, tip->GetBlockHash().ToString(),\n         fs::PathToString(path), fs::PathToString(temppath)));\n \n-    SnapshotMetadata metadata{tip->GetBlockHash(), maybe_stats->coins_count};\n+    SnapshotMetadata metadata{tip->GetBlockHash(), tip->nHeight, maybe_stats->coins_count};\n \n     afile << metadata;\n \n     COutPoint key;\n+    Txid last_hash;\n     Coin coin;\n     unsigned int iter{0};\n+    size_t written_coins_count{0};\n+    std::vector<std::pair<uint32_t, Coin>> coins;\n+\n+    // To reduce space the serialization format of the snapshot avoids\n+    // duplication of tx hashes. The code takes advantage of the guarantee by\n+    // leveldb that keys are lexicographically sorted.\n+    // In the coins vector we collect all coins that belong to a certain tx hash\n+    // (key.hash) and when we have them all (key.hash != last_hash) we write\n+    // them to file using the below lambda function.\n+    // See also https://github.com/bitcoin/bitcoin/issues/25675\n+    auto write_coins_to_file = [&](AutoFile& afile, const Txid& last_hash, const std::vector<std::pair<uint32_t, Coin>>& coins, size_t& written_coins_count) {\n+        afile << last_hash;\n+        WriteCompactSize(afile, coins.size());\n+        for (const auto& [n, coin] : coins) {\n+            WriteCompactSize(afile, n);\n+            afile << coin;\n+            ++written_coins_count;\n+        }\n+    };\n \n+    pcursor->GetKey(key);\n+    last_hash = key.hash;\n     while (pcursor->Valid()) {\n         if (iter % 5000 == 0) node.rpc_interruption_point();\n         ++iter;\n         if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n-            afile << key;\n-            afile << coin;\n+            if (key.hash != last_hash) {\n+                write_coins_to_file(afile, last_hash, coins, written_coins_count);\n+                last_hash = key.hash;\n+                coins.clear();\n+            }\n+            coins.emplace_back(key.n, coin);\n         }\n-\n         pcursor->Next();\n     }\n \n+    if (!coins.empty()) {\n+        write_coins_to_file(afile, last_hash, coins, written_coins_count);\n+    }\n+\n+    CHECK_NONFATAL(written_coins_count == maybe_stats->coins_count);\n+\n     afile.fclose();\n \n     UniValue result(UniValue::VOBJ);\n-    result.pushKV(\"coins_written\", maybe_stats->coins_count);\n+    result.pushKV(\"coins_written\", written_coins_count);\n     result.pushKV(\"base_hash\", tip->GetBlockHash().ToString());\n     result.pushKV(\"base_height\", tip->nHeight);\n     result.pushKV(\"path\", path.utf8string());\n@@ -2772,12 +2804,22 @@ static RPCHelpMan loadtxoutset()\n     }\n \n     SnapshotMetadata metadata;\n-    afile >> metadata;\n+    try {\n+        afile >> metadata;\n+    } catch (const std::ios_base::failure& e) {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, strprintf(\"Unable to parse metadata: %s\", e.what()));\n+    }\n \n     uint256 base_blockhash = metadata.m_base_blockhash;\n+    int base_blockheight = metadata.m_base_blockheight;\n     if (!chainman.GetParams().AssumeutxoForBlockhash(base_blockhash).has_value()) {\n+        auto available_heights = chainman.GetParams().GetAvailableSnapshotHeights();\n+        std::string heights_formatted = Join(available_heights, \", \", [&](const auto& i) { return ToString(i); });\n         throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to load UTXO snapshot, \"\n-            \"assumeutxo block hash in snapshot metadata not recognized (%s)\", base_blockhash.ToString()));\n+            \"assumeutxo block hash in snapshot metadata not recognized (hash: %s, height: %s). The following snapshot heights are available: %s.\",\n+            base_blockhash.ToString(),\n+            base_blockheight,\n+            heights_formatted));\n     }\n     CBlockIndex* snapshot_start_block = WITH_LOCK(::cs_main,\n             return chainman.m_blockman.LookupBlockIndex(base_blockhash));\ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex f57851b4f7e01..e6199e5cf96f0 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -5660,69 +5660,81 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n         return false;\n     }\n \n-    COutPoint outpoint;\n-    Coin coin;\n     const uint64_t coins_count = metadata.m_coins_count;\n     uint64_t coins_left = metadata.m_coins_count;\n \n-    LogPrintf(\"[snapshot] loading coins from snapshot %s\\n\", base_blockhash.ToString());\n+    LogPrintf(\"[snapshot] loading %d coins from snapshot %s\\n\", coins_left, base_blockhash.ToString());\n     int64_t coins_processed{0};\n \n     while (coins_left > 0) {\n         try {\n-            coins_file >> outpoint;\n-            coins_file >> coin;\n-        } catch (const std::ios_base::failure&) {\n-            LogPrintf(\"[snapshot] bad snapshot format or truncated snapshot after deserializing %d coins\\n\",\n-                      coins_count - coins_left);\n-            return false;\n-        }\n-        if (coin.nHeight > base_height ||\n-            outpoint.n >= std::numeric_limits<decltype(outpoint.n)>::max() // Avoid integer wrap-around in coinstats.cpp:ApplyHash\n-        ) {\n-            LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins\\n\",\n-                      coins_count - coins_left);\n-            return false;\n-        }\n-        if (!MoneyRange(coin.out.nValue)) {\n-            LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins - bad tx out value\\n\",\n-                      coins_count - coins_left);\n-            return false;\n-        }\n+            Txid txid;\n+            coins_file >> txid;\n+            size_t coins_per_txid{0};\n+            coins_per_txid = ReadCompactSize(coins_file);\n+\n+            if (coins_per_txid > coins_left) {\n+                LogPrintf(\"[snapshot] mismatch in coins count in snapshot metadata and actual snapshot data\\n\");\n+                return false;\n+            }\n \n-        coins_cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            for (size_t i = 0; i < coins_per_txid; i++) {\n+                COutPoint outpoint;\n+                Coin coin;\n+                outpoint.n = static_cast<uint32_t>(ReadCompactSize(coins_file));\n+                outpoint.hash = txid;\n+                coins_file >> coin;\n+                if (coin.nHeight > base_height ||\n+                    outpoint.n >= std::numeric_limits<decltype(outpoint.n)>::max() // Avoid integer wrap-around in coinstats.cpp:ApplyHash\n+                ) {\n+                    LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins\\n\",\n+                              coins_count - coins_left);\n+                    return false;\n+                }\n+                if (!MoneyRange(coin.out.nValue)) {\n+                    LogPrintf(\"[snapshot] bad snapshot data after deserializing %d coins - bad tx out value\\n\",\n+                              coins_count - coins_left);\n+                    return false;\n+                }\n+                coins_cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n \n-        --coins_left;\n-        ++coins_processed;\n+                --coins_left;\n+                ++coins_processed;\n \n-        if (coins_processed % 1000000 == 0) {\n-            LogPrintf(\"[snapshot] %d coins loaded (%.2f%%, %.2f MB)\\n\",\n-                coins_processed,\n-                static_cast<float>(coins_processed) * 100 / static_cast<float>(coins_count),\n-                coins_cache.DynamicMemoryUsage() / (1000 * 1000));\n-        }\n+                if (coins_processed % 1000000 == 0) {\n+                    LogPrintf(\"[snapshot] %d coins loaded (%.2f%%, %.2f MB)\\n\",\n+                        coins_processed,\n+                        static_cast<float>(coins_processed) * 100 / static_cast<float>(coins_count),\n+                        coins_cache.DynamicMemoryUsage() / (1000 * 1000));\n+                }\n \n-        // Batch write and flush (if we need to) every so often.\n-        //\n-        // If our average Coin size is roughly 41 bytes, checking every 120,000 coins\n-        // means <5MB of memory imprecision.\n-        if (coins_processed % 120000 == 0) {\n-            if (m_interrupt) {\n-                return false;\n-            }\n+                // Batch write and flush (if we need to) every so often.\n+                //\n+                // If our average Coin size is roughly 41 bytes, checking every 120,000 coins\n+                // means <5MB of memory imprecision.\n+                if (coins_processed % 120000 == 0) {\n+                    if (m_interrupt) {\n+                        return false;\n+                    }\n \n-            const auto snapshot_cache_state = WITH_LOCK(::cs_main,\n-                return snapshot_chainstate.GetCoinsCacheSizeState());\n+                    const auto snapshot_cache_state = WITH_LOCK(::cs_main,\n+                        return snapshot_chainstate.GetCoinsCacheSizeState());\n \n-            if (snapshot_cache_state >= CoinsCacheSizeState::CRITICAL) {\n-                // This is a hack - we don't know what the actual best block is, but that\n-                // doesn't matter for the purposes of flushing the cache here. We'll set this\n-                // to its correct value (`base_blockhash`) below after the coins are loaded.\n-                coins_cache.SetBestBlock(GetRandHash());\n+                    if (snapshot_cache_state >= CoinsCacheSizeState::CRITICAL) {\n+                        // This is a hack - we don't know what the actual best block is, but that\n+                        // doesn't matter for the purposes of flushing the cache here. We'll set this\n+                        // to its correct value (`base_blockhash`) below after the coins are loaded.\n+                        coins_cache.SetBestBlock(GetRandHash());\n \n-                // No need to acquire cs_main since this chainstate isn't being used yet.\n-                FlushSnapshotToDisk(coins_cache, /*snapshot_loaded=*/false);\n+                        // No need to acquire cs_main since this chainstate isn't being used yet.\n+                        FlushSnapshotToDisk(coins_cache, /*snapshot_loaded=*/false);\n+                    }\n+                }\n             }\n+        } catch (const std::ios_base::failure&) {\n+            LogPrintf(\"[snapshot] bad snapshot format or truncated snapshot after deserializing %d coins\\n\",\n+                      coins_processed);\n+            return false;\n         }\n     }\n \n@@ -5735,7 +5747,8 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     bool out_of_coins{false};\n     try {\n-        coins_file >> outpoint;\n+        Txid txid;\n+        coins_file >> txid;\n     } catch (const std::ios_base::failure&) {\n         // We expect an exception since we should be out of coins.\n         out_of_coins = true;\ndiff --git a/src/validation.h b/src/validation.h\nindex 28b045fe80cab..ea6b6cad7e26a 100644\n--- a/src/validation.h\n+++ b/src/validation.h\n@@ -885,6 +885,12 @@ class ChainstateManager\n     CBlockIndex* m_best_invalid GUARDED_BY(::cs_main){nullptr};\n \n     //! Internal helper for ActivateSnapshot().\n+    //!\n+    //! De-serialization of a snapshot that is created with\n+    //! CreateUTXOSnapshot() in rpc/blockchain.cpp.\n+    //! To reduce space the serialization format of the snapshot avoids\n+    //! duplication of tx hashes. The code takes advantage of the guarantee by\n+    //! leveldb that keys are lexicographically sorted.\n     [[nodiscard]] bool PopulateAndValidateSnapshot(\n         Chainstate& snapshot_chainstate,\n         AutoFile& coins_file,\n", "instance_id": "bitcoin__bitcoin-29612", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the goal of optimizing the serialization format of the UTXO set in the `dumptxoutset` function to save space by grouping outputs by transaction ID (`Txid`). It provides a high-level idea of the solution, some quantitative analysis of potential savings (~20% or ~1GB at a specific block height), and mentions alternatives considered. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the exact input and output formats for the new serialization structure beyond a conceptual description. Additionally, while it mentions that the change does not add complexity due to sorted iteration, it lacks specifics on potential edge cases (e.g., handling very large numbers of outputs per transaction) or performance implications during serialization/deserialization. Constraints on the data (e.g., maximum size of inner lists) are also not fully specified. Overall, the intent and approach are clear, but some finer details are left to interpretation or require inference from the code changes.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`rpc/blockchain.cpp`, `validation.cpp`, `node/utxo_snapshot.h`, etc.) and involves modifications to critical components of the Bitcoin Core codebase, such as UTXO snapshot serialization and deserialization logic. This requires a deep understanding of the existing architecture, particularly how UTXO sets are managed and persisted. Second, the technical concepts involved include serialization formats, compact size encoding (`WriteCompactSize`/`ReadCompactSize`), and leveraging LevelDB's lexicographical ordering for optimization, which are moderately advanced topics in C++. Additionally, the problem touches on domain-specific knowledge of Bitcoin's UTXO model and the `assumeutxo` feature, adding to the complexity. Third, the changes impact error handling and validation logic (e.g., checking for mismatches in coin counts, handling deserialization failures), requiring careful consideration of edge cases like corrupted snapshots or mismatched network types. While the problem does not involve a complete architectural overhaul or extremely intricate algorithms, it demands a solid grasp of the codebase's internals and careful implementation to avoid introducing bugs in a critical system component. The difficulty is not at the highest end (0.8-1.0) because the core idea (grouping by `Txid`) is conceptually straightforward, and the provided code changes mitigate some of the implementation burden. However, the need for precision and the potential impact on system reliability push it above medium difficulty.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.65}
{"problem_statement": "Can't cycle through command history using the down-arrow\n### Windows Terminal version\n\n1.21.2911.0\n\n### Windows build number\n\n10.0.22631.4391\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nI used to be able to run\n\n```\n> echo 1\n1\n> echo 2\n2\n> echo 3\n3\n```\nand then press UP ARROW three times to repeat `echo 1` and then DOWN ARROW to cycle through `echo 2`, `echo 3`, `echo 1`, etc. Now the first DOWN ARROW does nothing.\n\nI think both Command Prompt and PowerShell had this behavior. I do know I used that pattern of cycling through the history for Command Prompt quite frequently, but now I find that I must press UP ARROW three times each time I want to cycle through the last three commands. It would be nice to have the old behavior back.\n\nI haven't found any documentation or bug reports that addresses this issue. Thanks in advance for your help.\n\n### Expected Behavior\n\nAfter pressing UP ARROW three times and ENTER to execute the third command back in history, I expected pressing DOWN ARROW followed by ENTER to execute each of the past 3 commands in sequence ad infinitum.\n\n\n### Actual Behavior\n\nAfter pressing UP ARROW three times and ENTER to execute the third command back in history, pressing DOWN ARROW does nothing. No previous command is recalled from history.\n", "patch": "diff --git a/src/host/settings.cpp b/src/host/settings.cpp\nindex 746bd91564f..4650fbf9eb1 100644\n--- a/src/host/settings.cpp\n+++ b/src/host/settings.cpp\n@@ -36,7 +36,7 @@ Settings::Settings() :\n     _bAutoPosition(true),\r\n     _uHistoryBufferSize(DEFAULT_NUMBER_OF_COMMANDS),\r\n     _uNumberOfHistoryBuffers(DEFAULT_NUMBER_OF_BUFFERS),\r\n-    _bHistoryNoDup(true),\r\n+    _bHistoryNoDup(false),\r\n     // ColorTable initialized below\r\n     _uCodePage(ServiceLocator::LocateGlobals().uiOEMCP),\r\n     _uScrollScale(1),\r\n@@ -110,7 +110,7 @@ void Settings::ApplyDesktopSpecificDefaults()\n     _bQuickEdit = TRUE;\r\n     _uHistoryBufferSize = 50;\r\n     _uNumberOfHistoryBuffers = 4;\r\n-    _bHistoryNoDup = true;\r\n+    _bHistoryNoDup = FALSE;\r\n \r\n     _renderSettings.ResetColorTable();\r\n \r\ndiff --git a/src/propsheet/registry.cpp b/src/propsheet/registry.cpp\nindex 3a7283e080e..64d392aa76d 100644\n--- a/src/propsheet/registry.cpp\n+++ b/src/propsheet/registry.cpp\n@@ -79,7 +79,7 @@ VOID InitRegistryValues(\n     pStateInfo->CursorSize = 25;\r\n     pStateInfo->HistoryBufferSize = 25;\r\n     pStateInfo->NumberOfHistoryBuffers = 4;\r\n-    pStateInfo->HistoryNoDup = 1;\r\n+    pStateInfo->HistoryNoDup = 0;\r\n \r\n     // clang-format off\r\n     if (pStateInfo->fIsV2Console)\r\n", "instance_id": "microsoft__terminal-18229", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inability to cycle through command history using the down-arrow key in Windows Terminal, which previously worked as expected. The user provides a specific example of the workflow (running commands and navigating history with up and down arrows) and clearly states the expected versus actual behavior. However, there are minor ambiguities and missing details. For instance, the problem does not specify whether this issue affects all terminal profiles or only specific shells (e.g., Command Prompt or PowerShell), nor does it mention any relevant settings or configurations that might influence the behavior. Additionally, edge cases or specific conditions under which the issue occurs are not addressed. Despite these minor gaps, the core issue is well-articulated with a reproducible example, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as reflected by the score of 0.15. Analyzing the provided code changes, the solution involves a straightforward modification of a single boolean flag (`_bHistoryNoDup`) across a few configuration files (`settings.cpp` and `registry.cpp`). This change appears to toggle a setting related to duplicate history entries, which likely influences how history navigation behaves. The scope of the change is minimal, affecting only initialization values in a couple of places without requiring deep understanding of the broader codebase or complex interactions between modules. No advanced technical concepts, algorithms, or domain-specific knowledge are needed beyond basic familiarity with C++ syntax and configuration settings. There are no apparent edge cases or error handling requirements introduced by this change, as it is a simple toggle of a default value. The problem falls into the \"Very Easy\" category (0.0-0.2), as it requires only a basic code modification with minimal impact on the system's architecture or logic.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.15}
{"problem_statement": "Reset title sequences have stopped working in Windows Termial\n### Windows Terminal version\n\nCommit f93347ed4bbeea0d9e663f2069994d9e2d069f10\n\n### Windows build number\n\n10.0.19045.4780\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a WSL bash shell in a recent build of Windows Terminal (I suspect it needs to be 450eec48de252a3a8d270bade847755ecbeb5a75 or later).\r\n2. Make sure your shell isn't configured to set the title itself.\r\n3. Set the title with an OSC 0 sequence: `printf \"\\e]0;Test\\e\\\\\"`\r\n4. Note that the title has changed.\r\n5. Reset the title with a blank OSC 0 sequence: `printf \"\\e]0\\e\\\\\"`\n\n### Expected Behavior\n\nThe title should be reset to its starting value. This works correctly in Terminal Preview and also in current builds of OpenConsole.\n\n### Actual Behavior\n\nThe title is just set to a blank value. The same problem occurs with the `DECSWT` title sequence too.\n", "patch": "diff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 9f51aadf00d..ffd9ec72af0 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -86,7 +86,7 @@ void Terminal::SetWindowTitle(const std::wstring_view title)\n     _assertLocked();\r\n     if (!_suppressApplicationTitle)\r\n     {\r\n-        _title.emplace(title);\r\n+        _title.emplace(title.empty() ? _startingTitle : title);\r\n         _pfnTitleChanged(_title.value());\r\n     }\r\n }\r\n", "instance_id": "microsoft__terminal-17802", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear, providing a detailed description of the issue with steps to reproduce, expected behavior, and actual behavior. It specifies the context (Windows Terminal, specific commits, and WSL bash shell) and the exact sequences (OSC 0 and DECSWT) that fail to reset the title as expected. However, there are minor ambiguities: it does not explicitly define what the \"starting value\" of the title should be in all scenarios (e.g., whether it depends on shell configuration or other factors), and it lacks mention of potential edge cases or constraints (e.g., behavior with non-empty titles or mixed sequences). Additionally, while the issue is tied to specific commits, the root cause or affected components are not hinted at in the description, requiring some inference from the code changes. Overall, it is clear enough to understand the goal but misses some finer details.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling in the easy range (0.2-0.4). The issue involves a specific bug in the title reset functionality of Windows Terminal, and the provided code change is minimal, confined to a single line in a single file (TerminalApi.cpp). The fix modifies the logic in the `SetWindowTitle` function to revert to a `_startingTitle` when an empty title is provided, which is a straightforward conditional update. The scope of the change is narrow, impacting only the title-setting behavior without affecting broader system architecture or requiring cross-module modifications. The technical concepts involved are basic: understanding of string handling in C++ and familiarity with the terminal's title management logic. No complex algorithms, design patterns, or domain-specific knowledge beyond terminal escape sequences are required. Edge cases seem minimal based on the problem statement and code change, as the fix handles the primary case of an empty title reset without introducing new error handling or performance concerns. Overall, this is a simple bug fix that requires minimal effort and understanding of the codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": 2, "human_difficulty": 0.25}
