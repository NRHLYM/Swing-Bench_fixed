{"repo": "doctest/doctest", "instance_id": "doctest__doctest-878", "base_commit": "35a540d01395117c733125aa7d1781b37b40d077", "patch": "diff --git a/examples/all_features/CMakeLists.txt b/examples/all_features/CMakeLists.txt\nindex 19436c549..47ee019b0 100644\n--- a/examples/all_features/CMakeLists.txt\n+++ b/examples/all_features/CMakeLists.txt\n@@ -63,7 +63,7 @@ if(NOT MINGW AND NOT DEFINED DOCTEST_THREAD_LOCAL)\n     doctest_add_test(NO_OUTPUT NAME concurrency.cpp ${common_args} -sf=*concurrency.cpp -d) # duration: there is no output anyway\n endif()\n \n-doctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp.cpp )\n+doctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp )\n doctest_add_test(NO_OUTPUT NAME bitfields.cpp ${common_args} -sf=*bitfields.cpp )\n doctest_add_test(NO_OUTPUT NAME namespace1.cpp ${common_args} -sf=*namespace1.cpp )\n doctest_add_test(NO_OUTPUT NAME namespace2.cpp ${common_args} -sf=*namespace2.cpp )\n", "test_patch": "", "problem_statement": "Typo in examples/all_features/CMakeLists.txt\n## Description\r\n\r\nThere is probably a copy&paste error in:\r\nhttps://github.com/doctest/doctest/blob/35a540d01395117c733125aa7d1781b37b40d077/examples/all_features/CMakeLists.txt#L66\r\n```\r\ndoctest_add_test(NO_OUTPUT NAME bitfield_packed_struct.cpp ${common_args} -sf=*bitfield_packed_struct.cpp.cpp )\r\n                                                                                                         ^^^^\r\n```\r\nSee the double `.cpp`?\n", "hints_text": "", "created_at": "2024-11-27 10:41:45", "merge_commit_sha": "90f4e3144b25008b2942d612106900d6e1db57e1", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["ci (ubuntu-latest, clang, 14)", ".github/workflows/main.yml"], ["sanitizers (integer)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 5.0)", ".github/workflows/main.yml"], ["ci-msvs (ClangCl, Win32, Release)", ".github/workflows/main.yml"], ["ci (macOS-latest, gcc, 11)", ".github/workflows/main.yml"], ["ci-msvs (v143, Win32, Release)", ".github/workflows/main.yml"], ["sanitizers (thread)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 4.8)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, cl)", ".github/workflows/main.yml"], ["clang-tidy", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 12)", ".github/workflows/main.yml"], ["ci-msvs (v142, Win32, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 6.0)", ".github/workflows/main.yml"], ["sanitizers (address)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 9)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, gcc, 8)", ".github/workflows/main.yml"], ["ci (ubuntu-20.04, clang, 11)", ".github/workflows/main.yml"], ["sanitizers (undefined)", ".github/workflows/main.yml"], ["ci-msvs (v141, x64, Release)", ".github/workflows/main.yml"], ["sanitizers (safe-stack)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Release)", ".github/workflows/main.yml"], ["ci (ubuntu-latest, gcc, 9)", ".github/workflows/main.yml"], ["ci-msvs (v140, Win32, Debug)", ".github/workflows/main.yml"], ["ci (macOS-latest, xcode, 13.2.1)", ".github/workflows/main.yml"], ["ci-msvs (v140, x64, Release)", ".github/workflows/main.yml"], ["ci-msvs (v143, x64, Release)", ".github/workflows/main.yml"], ["ci-min-gw (Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 3.7)", ".github/workflows/main.yml"], ["sanitizers (implicit-conversion)", ".github/workflows/main.yml"], ["ci-msvs (v141, Win32, Debug)", ".github/workflows/main.yml"], ["ci (ubuntu-18.04, clang, 7)", ".github/workflows/main.yml"], ["ci-msvs (v142, x64, Debug)", ".github/workflows/main.yml"], ["ci (windows-2019, clang)", ".github/workflows/main.yml"]]}
{"repo": "swig/swig", "instance_id": "swig__swig-3159", "base_commit": "4167b0275adc574f86914e42fb5ef9639b2b25a5", "patch": "diff --git a/.github/workflows/linux.yml b/.github/workflows/linux.yml\nindex 02aa3f0681..a7e8f84d96 100644\n--- a/.github/workflows/linux.yml\n+++ b/.github/workflows/linux.yml\n@@ -132,6 +132,9 @@ jobs:\n         - SWIGLANG: python\n           VER: '3.13t' # no-gil testing\n           CSTD: gnu99\n+        - SWIGLANG: python\n+          VER: '3.14'\n+          CSTD: gnu99\n         - SWIGLANG: python\n           PY2: 2\n           SWIG_FEATURES: -builtin\ndiff --git a/Doc/Manual/Python.html b/Doc/Manual/Python.html\nindex 23587e5dbc..01fc449a68 100644\n--- a/Doc/Manual/Python.html\n+++ b/Doc/Manual/Python.html\n@@ -6552,7 +6552,7 @@ <H4><a name=\"Python_package_search_both_package_modules\">33.11.6.1 Both modules\n \n <p>\n In this configuration, the pure Python module, foo.py, tries to load the C/C++ module, _foo, from the same package foo.py is\n-located in.  The package name is determined from the <tt>__package__</tt>\n+located in.  The package name is determined from the <tt>__spec__.parent</tt> (or <tt>__package__</tt> before Python 3.4)\n attribute if available, see <a href=\"https://www.python.org/dev/peps/pep-0366/\">PEP 366</a>. Otherwise it is derived from the <tt>__name__</tt>\n attribute given to foo.py by the Python loader that imported foo.py.\n The interface file for this configuration would contain:\n@@ -6675,7 +6675,7 @@ <H4><a name=\"Python_custom_module_import\">33.11.6.4 More on customizing the modu\n \n <div class=\"targetlang\">\n <pre>\n-if __package__ or '.' in __name__:\n+if getattr(__spec__, \"parent\", None) or '.' in __name__:\n     from . import _foo\n else:\n     import _foo\n@@ -6760,7 +6760,7 @@ <H4><a name=\"Python_custom_module_import\">33.11.6.4 More on customizing the modu\n \n <div class=\"targetlang\">\n <pre>\n-if __package__ or '.' in __name__:\n+if getattr(__spec__, \"parent\", None) or '.' in __name__:\n     from ._foo import *\n else:\n     from _foo import *\ndiff --git a/Source/Modules/python.cxx b/Source/Modules/python.cxx\nindex 86daf131c8..3070a94fac 100644\n--- a/Source/Modules/python.cxx\n+++ b/Source/Modules/python.cxx\n@@ -703,20 +703,22 @@ class PYTHON:public Language {\n \t * onwards (implicit relative imports raised a DeprecationWarning in 2.6,\n \t * and fail in 2.7 onwards).\n \t *\n-\t * First check for __package__ which is available from 2.6 onwards, see PEP366.\n+\t * First check for __spec__.parent which is available from 3.4 onwards,\n+\t * see https://docs.python.org/3/reference/import.html#spec. If not,\n+\t * check for __package__, which was set before 3.14.\n \t * Next try determine the shadow wrapper's package based on the __name__ it\n \t * was given by the importer that loaded it.\n \t * If the module is in a package, load the low-level C/C++ module from the\n \t * same package, otherwise load it as a global module.\n \t */\n         Printv(default_import_code, \"# Import the low-level C/C++ module\\n\", NULL);\n-        Printv(default_import_code, \"if __package__ or \\\".\\\" in __name__:\\n\", NULL);\n+        Printv(default_import_code, \"if getattr(globals().get(\\\"__spec__\\\"), \\\"parent\\\", None) or globals().get(\\\"__package__\\\") or \\\".\\\" in __name__:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from . import \", module, \"\\n\", NULL);\n         Printv(default_import_code, \"else:\\n\", NULL);\n         Printv(default_import_code, tab4, \"import \", module, \"\\n\", NULL);\n       } else {\n         Printv(default_import_code, \"# Pull in all the attributes from the low-level C/C++ module\\n\", NULL);\n-        Printv(default_import_code, \"if __package__ or \\\".\\\" in __name__:\\n\", NULL);\n+        Printv(default_import_code, \"if getattr(globals().get(\\\"__spec__\\\"), \\\"parent\\\", None) or globals().get(\\\"__package__\\\") or \\\".\\\" in __name__:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from .\", module, \" import *\\n\", NULL);\n         Printv(default_import_code, \"else:\\n\", NULL);\n         Printv(default_import_code, tab4, \"from \", module, \" import *\\n\", NULL);\n@@ -4372,6 +4374,11 @@ class PYTHON:public Language {\n     Printv(f, \"#if PY_VERSION_HEX >= 0x030b0000\\n\", NIL);\n     printSlot(f, getSlot(n, \"feature:python:_ht_tpname\"), \"_ht_tpname\", \"char *\");\n \n+    // void *ht_token;\n+    Printv(f, \"#if PY_VERSION_HEX >= 0x030e0000\\n\", NIL);\n+    printSlot(f, getSlot(n, \"feature:python:ht_token\"), \"ht_token\", \"void *\");\n+    Printv(f, \"#endif\\n\", NIL);\n+\n     // struct _specialization_cache _spec_cache;\n     Printf(f, \"  {\\n\");\n     printSlot(f, getSlot(n, \"feature:python:getitem\"), \"getitem\", \"PyObject *\");\n", "test_patch": "diff --git a/Examples/test-suite/python/python_annotations_variable_c_runme.py b/Examples/test-suite/python/python_annotations_variable_c_runme.py\nindex 153852d05e..d1f359bbbd 100644\n--- a/Examples/test-suite/python/python_annotations_variable_c_runme.py\n+++ b/Examples/test-suite/python/python_annotations_variable_c_runme.py\n@@ -1,4 +1,17 @@\n import sys\n+import inspect\n+\n+\n+def get_annotations(cls):\n+    # Python >=3.14 removed the __annotations__ attribute\n+    # retrieve it via inspect (see also annotationlib)\n+    if hasattr(inspect, \"get_annotations\"):\n+        # Python >=3.10\n+        return inspect.get_annotations(cls)\n+    else:\n+        # Python <3.10\n+        return getattr(cls, \"__annotations__\", {})\n+\n \n # Variable annotations for properties is only supported in python-3.6 and later (PEP 526)\n if sys.version_info[0:2] >= (3, 6):\n@@ -8,17 +21,14 @@\n     annotations_supported = not(is_python_builtin() or is_python_fastproxy())\n \n     if annotations_supported:\n-        ts = TemplateShort()\n-        anno = ts.__annotations__\n+        anno = get_annotations(TemplateShort)\n         if anno != {'member_variable': 'int'}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n \n-        ts = StructWithVar()\n-        anno = ts.__annotations__\n+        anno = get_annotations(StructWithVar)\n         if anno != {'member_variable': 'int'}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n \n-        ts = StructWithVarNotAnnotated()\n-        if getattr(ts, \"__annotations__\", None) != None:\n-            anno = ts.__annotations__\n+        anno = get_annotations(StructWithVarNotAnnotated)\n+        if anno != {}:\n             raise RuntimeError(\"annotations mismatch: {}\".format(anno))\n", "problem_statement": "__package__ will cease being set/used  in Python 3.15\nThe files generated by SWIG depend on `__package__` being present, but Python 3.14 will removing this in favor of `__spec__.parent`. The 3.13 release notes https://docs.python.org/3.13/whatsnew/3.13.html#pending-removal-in-python-3-14 say:\r\n\r\n> [importlib](https://docs.python.org/3.13/library/importlib.html#module-importlib): `__package__` and `__cached__` will cease to be set or taken into consideration by the import system ([gh-97879](https://github.com/python/cpython/issues/97879)).\r\n\r\nBoth could be checked, or just `__spec__.parent` - I can verify that works back to 3.6, which is the oldest Python I had to check.\n", "hints_text": "Python 3.3 is the oldest SWIG currently supports and seems to lack `__spec__` entirely:\r\n\r\n```\r\nPython 3.3.5 (default, Mar 22 2014, 13:24:53) \r\n[GCC 4.8.2] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information. \r\n>>> dir(__spec__)\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\nNameError: name '__spec__' is not defined\r\n>>> \r\n```\nAdded in 3.4: https://docs.python.org/3/reference/import.html#spec__\nFWIW I think it would be fine to set 3.4 as the minimum required version, I think nobody uses anything less than 3.6 or maybe even later any more by now.\n3.3 is _really_ old, by the way, and never was well supported - throughout 3.3's support window, 2.x was dramatically more popular. 3.5 was the first version with heavy use. Personally, 3.6 is still a _really_ old version of Python and a fine minimum; 3.6 is the oldest version you can build for via manylinux, for example. 3.8 is the oldest officially supported version of Python these days.\nNo arguments from me, but you'll need to convince wsfulton...\nFWIW, I'd argue for the minimum Python3 version being 3.5 since that's the oldest we've actually been testing in CI since github dropped their ubuntu-18.04 image over a year ago.\r\n\r\nRequiring CI testing for a version of a target language aligns with our requirements for supporting a target language version at all, and both seem reasonable requirements since without automated testing we won't detect breakages, and expecting developers to test by hand seems like the burden falling in the wrong place.  If someone wants to keep support for an older version, they get to sort out CI coverage for that version (by using packages from a PPA or using a prebuilt version or running the job in a docker image or whatever).\nSupporting the latest version of python is more important than supporting older versions. It's easy enough to put in version specific code though. I agree with @ojwb though, that ideally we test the versions we state we support. I'm still using 3.6 though in places, and I doubt I am not the only one.\r\n\r\n> Both could be checked, or just `__spec__.parent` - I can verify that works back to 3.6, which is the oldest Python I had to check\r\n\r\nI don't see any `__spec__.parent` until python 3.13, eg for for 3.12:\r\n```\r\n$ python3.12\r\nPython 3.12.4 (main, Jun  8 2024, 18:29:57) [GCC 11.4.0] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> dir(__spec__)\r\n['__bool__', '__class__', '__delattr__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__']\r\n>>> \r\n```\r\nNo parent, but there is in 3.13:\r\n```\r\n$ python3.13\r\nPython 3.13.0b3 (main, Jul  8 2024, 01:23:25) [GCC 11.4.0] on linux\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> dir(__spec__)\r\n['__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__weakref__', '_cached', '_set_fileattr', '_uninitialized_submodules', 'cached', 'has_location', 'loader', 'loader_state', 'name', 'origin', 'parent', 'submodule_search_locations']\r\n>>> \r\n```\r\nHow did you determine it works all the way back to python-3.6?\r\n\r\nAdding @mromberg, who has done most of the advanced package support, for Python for comment.\nIt has to be in a file, the interpreter doesn\u2019t have a `__spec__` until 3.13 (and only the new Python-based REPL).\n> Supporting the latest version of python is more important than supporting older versions. It's easy enough to put in version specific code though. I agree with @ojwb though, that ideally we test the versions we state we support. I'm still using 3.6 though in places, and I doubt I am not the only one.\r\n\r\nWe still have CI testing for 3.6 (and 3.5) so enforcing a requirement for a version to be testable in CI wouldn't require dropping 3.6 at this point anyway.  It's only 3.3 and 3.4 that we claim to support without having any CI coverage to back that up (so unless anyone has been regularly manually testing with these older versions, really all we can say is that we haven't knowingly done anything that stops SWIG working Python 3.3 and 3.4, which to me isn't very reassuring either as a user or as a maintainer).\nLooks like 3.14 will likely be released in just over a year, so we should aim to fix this for SWIG 4.4.0.\nNote: it's important to support this at least by RC 1, since that's when CPython is ABI stable and packages are supposed to start shipping. The \".0\" release is when normal users are supposed to start using it, packages should already have been built for 3.14. It would be a very good idea to support it by beta 1, as that's when most packages start experimenting with support.\r\n\r\nAlphas are produced starting in October or so, and are available on GHA for _early_ testing. Anything can change, though.\r\nBeta phase starts in May. This is fairly stable (feature freeze), _small_ chance of ABI changes though.\r\nRC starts in August.\r\nFinal is October.\r\n\r\nI believe more people will be using 3.14.0a1 than 3.3 and 3.4 combined, if that's helpful. Yesterday, pip was downloaded 10 times for 3.3 and 495 times for 3.4. For comparison, for 3.14, pip was downloaded 260 times, and that's just people building CPython from source. For 3.13, it was downloaded 12,609 (0.12%) times, which is slightly higher than 3.5's 11,389 (0.11%) times. The most popular Python version, 3.11, downloaded pip 2,605,209 times (25.2%).\r\n\r\nSo removing 3.3 and 3.4 removes 0.00% of Python users (who download pip, since that's the package I chose for a metric).\r\n\r\nHere's the [download numbers](https://pypistats.org/packages/swig) for the pip `swig` package, by the way, which was downloaded 0 times for 3.3, 3.4, and 3.5:\r\n\r\n![Screenshot 2024-09-19 at 12 48 16\u202fAM](https://github.com/user-attachments/assets/65cd1757-ebb6-47e1-afae-7e9a9e2df90b)\r\n\r\nIf you scroll back a week or two, you can find one download for 3.5, on 9-9-2024.\r\n\r\n\nWe need an easy way to install python-3.14 with the `__package__` removal implemented to test in order to take this forward. Any news on 3.14 being ready for testing this would be good to know here. A patch with a proposed fix wouldn't go amiss either!\n@henryiii SWIG is a volunteer project - if you want something to happen (and especially if you want it to happen in a particular time scale) the best way to achieve that is to submit a clean patch.  If you're wanting to get a patch in 4.3.0, then you have about a week before it gets released (which is a timeline driven primarily by the Python 3.13 release date).\r\n\r\n(Even adding it to the 4.4 milestone doesn't guarantee it'll get done for 4.4.0, but it does at least ensure we don't forget about the issue completely.)\r\n\r\nI don't **think** there's much argument against hard dropping support for 3.3 and 3.4 at this point if keeping it is blocking 3.14 support, though I'm not 100% clear on @wsfulton's position on this.  If he's wanting to keep conditional version-specific code for 3.3 and 3.4 that may make the task significantly harder because we don't have CI testing to tell us such code actually works.\n> 3.3 is _really_ old, by the way, and never was well supported - throughout 3.3's support window, 2.x was dramatically more popular. 3.5 was the first version with heavy use. Personally, 3.6 is still a _really_ old version of Python and a fine minimum; 3.6 is the oldest version you can build for via manylinux, for example. 3.8 is the oldest officially supported version of Python these days.\r\n\r\n3.6 is still part of SUSE Linux Enterprise Server 15, and it will be part of it for a long time (unfortunately, I am the maintainer).\nOh, sorry, missed this. This would be a lot easier if something like 3.5+ or 3.6+ became the minimum supported version, which I assume you'd not want on a short timescale anyway. It seem like 4.4 or later would be fine, as long as it's in by the beta series of 3.14, which is next year, something like March IIRC.\r\n\r\n> 3.6 is still part of SUSE Linux Enterprise Server 15\r\n\r\nDo people expect the latest version of SWIG to work with 3.6, though? All the rest of the core libraries for Python require 3.7+ or 3.8+ (and 3.8 is now EoL, so soon it will be 3.9+). I think it's fine to expect to need old versions of software on old OSs. Though from what I remember above even 3.5+ would be just fine for this specific thing.\r\n\r\nFYI, you can't get older versions of Python (<3.8) via setup-python in GHA on macos-latest or ubuntu-latest. Apple Silicon support started in 3.8 and they didn't bother to build EoL Pythons for ubuntu-24.04.\nI wasn't submitting a patch since I didn't want to raise the min version of Python, that seem like a project consensus type of a thing. Should I make a patch that just doesn't support <3.5 for this, then?\nMaking the minimum supported version as 3.5 doesn't seem an unreasonable compromise in order to add support for 3.14. Please submit your patch to support 3.5 and later and I'll take a look.\nOn Wed Oct 30, 2024 at 7:30 PM CET, Henry Schreiner wrote:\r\n>> 3.6 is still part of SUSE Linux Enterprise Server 15\r\n>\r\n> Do people expect the latest version of SWIG to work with 3.6, though? All the rest of the core libraries for Python require 3.7+ or 3.8+ (and 3.8 is now EoL, so soon it will be 3.9+). I think it\u2019s fine to expect to need old versions of software on old OSs. Though from what I remember above even 3.5+ would be just fine for this specific thing.\r\n\r\nI didn\u2019t mean that. Certainly we discourage users of our enterprise systems to use recent versions of software packages we provide in the system, moreover using most recent swig on the ancient system is beyond recklessness. However, as I believe SLE\u2019s Python 3.6 is probably one of the oldest supported Pythons in the production use (I am not sure RHEL, but I think they don\u2019t carry anything that ancient any more), it could be just one milestone where to stop with increasing the version of Python you support.\r\n\nManylinux also still supports 3.6 for a bit longer also (and because of that, it's still pretty easy to test on 3.6).", "created_at": "2025-04-10 17:59:12", "merge_commit_sha": "c8bedcc66163513ca3cc204e7b9b3388a44d26c2", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["java 8 gcc", ".github/workflows/windows.yml"], ["python  3.13   gcc  gnu99", ".github/workflows/linux.yml"], ["csharp     gcc", ".github/workflows/linux.yml"], ["scilab  2024.1.0   gcc", ".github/workflows/linux.yml"], ["python  3.13t   gcc  gnu99", ".github/workflows/linux.yml"], ["guile     gcc c++14", ".github/workflows/linux.yml"], ["java 8 msvc", ".github/workflows/windows.yml"], ["ruby  3.1   gcc c++11", ".github/workflows/linux.yml"], ["none     gcc", ".github/workflows/linux.yml"], ["ruby  3.3   gcc c++11", ".github/workflows/linux.yml"], ["csharp  gcc windows-2019", ".github/workflows/windows.yml"], ["csharp     gcc c++14", ".github/workflows/linux.yml"], ["none     clang", ".github/workflows/linux.yml"], ["ruby 3.1.6 msvc  no-test", ".github/workflows/windows.yml"], ["octave     gcc13 c++17", ".github/workflows/linux.yml"], ["scilab  2023.1.0   gcc", ".github/workflows/linux.yml"], ["d  2.103.1   gcc c++17", ".github/workflows/linux.yml"], ["none     gcc10", ".github/workflows/linux.yml"], ["csharp  gcc", ".github/workflows/windows.yml"], ["scilab  5.5.2   gcc", ".github/workflows/linux.yml"], ["python    -builtin -O gcc", ".github/workflows/linux.yml"], ["php  8.1   gcc", ".github/workflows/linux.yml"], ["octave     gcc c++11", ".github/workflows/linux.yml"], ["perl5     gcc c++14", ".github/workflows/linux.yml"], ["go  1.24   gcc  gnu99", ".github/workflows/linux.yml"], ["ocaml     gcc13 c++17   (can fail)", ".github/workflows/linux.yml"], ["java     gcc13 c++17", ".github/workflows/linux.yml"], ["python  3.13  -builtin gcc", ".github/workflows/linux.yml"], ["none     gcc11", ".github/workflows/linux.yml"], ["d  gdmd   gcc c++11", ".github/workflows/linux.yml"], ["r     gcc c++14", ".github/workflows/linux.yml"], ["php     gcc13 c++17 gnu17", ".github/workflows/linux.yml"], ["php  8.3   gcc", ".github/workflows/linux.yml"], ["java     gcc c++11", ".github/workflows/linux.yml"], ["javascript v8 7.8   gcc c++14 c++14", ".github/workflows/linux.yml"], ["php     gcc c++14 gnu11", ".github/workflows/linux.yml"], ["ruby  2.1   gcc", ".github/workflows/linux.yml"], ["ruby  gcc  no-test", ".github/workflows/windows.yml"], ["python  3.14   gcc  gnu99", ".github/workflows/linux.yml"], ["none     gcc9 c++98 c99", ".github/workflows/linux.yml"], ["perl5     gcc c++11", ".github/workflows/linux.yml"], ["perl5     gcc13 c++17", ".github/workflows/linux.yml"], ["r     gcc c++11", ".github/workflows/linux.yml"], ["python     gcc13 c++17", ".github/workflows/linux.yml"], ["none     gcc12", ".github/workflows/linux.yml"], ["ruby     gcc c++11", ".github/workflows/linux.yml"], ["go  1.20   gcc c++14 gnu11", ".github/workflows/linux.yml"], ["none     gcc13", ".github/workflows/linux.yml"], ["guile     gcc13 c++17", ".github/workflows/linux.yml"], ["ruby  3.2   gcc c++11", ".github/workflows/linux.yml"], ["tcl     gcc c++14", ".github/workflows/linux.yml"], ["python  3.10   gcc", ".github/workflows/linux.yml"], ["c     gcc c++11", ".github/workflows/linux.yml"], ["ruby  2.3   gcc", ".github/workflows/linux.yml"], ["lua     gcc c++11", ".github/workflows/linux.yml"], ["ruby     gcc c++14", ".github/workflows/linux.yml"], ["javascript napi 20   gcc13 c++17", ".github/workflows/linux.yml"], ["python  3.9   gcc", ".github/workflows/linux.yml"], ["python     gcc13 c++20", ".github/workflows/linux.yml"], ["lua     gcc13 c++17", ".github/workflows/linux.yml"], ["java     gcc c++14", ".github/workflows/linux.yml"], ["csharp     gcc13 c++17", ".github/workflows/linux.yml"], ["CMake VS 17 2022", ".github/workflows/windows-cmake.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-14667", "base_commit": "5003be4b4a8e63bf1815d2e4663e6aba480afe3a", "patch": "diff --git a/FirebaseFunctions/CHANGELOG.md b/FirebaseFunctions/CHANGELOG.md\nindex f244f3f58e8..3c5253793be 100644\n--- a/FirebaseFunctions/CHANGELOG.md\n+++ b/FirebaseFunctions/CHANGELOG.md\n@@ -1,3 +1,7 @@\n+# Unreleased\n+- [fixed] Fix regression from 11.6.0 where `HTTPSCallable` did not invoke\n+  completion block on main thread (#14653).\n+\n # 11.10.0\n - [added] Streaming callable functions are now supported.\n \ndiff --git a/FirebaseFunctions/Sources/HTTPSCallable.swift b/FirebaseFunctions/Sources/HTTPSCallable.swift\nindex b423ac4195a..671a7b67dce 100644\n--- a/FirebaseFunctions/Sources/HTTPSCallable.swift\n+++ b/FirebaseFunctions/Sources/HTTPSCallable.swift\n@@ -76,15 +76,15 @@ open class HTTPSCallable: NSObject {\n   ///   - data: Parameters to pass to the trigger.\n   ///   - completion: The block to call when the HTTPS request has completed.\n   @objc(callWithObject:completion:) open func call(_ data: Any? = nil,\n-                                                   completion: @escaping (HTTPSCallableResult?,\n+                                                   completion: @escaping @MainActor (HTTPSCallableResult?,\n                                                                           Error?) -> Void) {\n     if #available(iOS 13, macCatalyst 13, macOS 10.15, tvOS 13, watchOS 7, *) {\n       Task {\n         do {\n           let result = try await call(data)\n-          completion(result, nil)\n+          await completion(result, nil)\n         } catch {\n-          completion(nil, error)\n+          await completion(nil, error)\n         }\n       }\n     } else {\n@@ -98,9 +98,13 @@ open class HTTPSCallable: NSObject {\n       ) { result in\n         switch result {\n         case let .success(callableResult):\n-          completion(callableResult, nil)\n+          DispatchQueue.main.async {\n+            completion(callableResult, nil)\n+          }\n         case let .failure(error):\n-          completion(nil, error)\n+          DispatchQueue.main.async {\n+            completion(nil, error)\n+          }\n         }\n       }\n     }\ndiff --git a/FirebaseFunctions/Tests/Integration/IntegrationTests.swift b/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\nindex 878cec1c9a0..0fa9c21e862 100644\n--- a/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\n+++ b/FirebaseFunctions/Tests/Integration/IntegrationTests.swift\n@@ -867,6 +867,38 @@ class IntegrationTests: XCTestCase {\n       XCTAssertEqual(response, expected)\n     }\n   }\n+\n+  func testFunctionsReturnsOnMainThread() {\n+    let expectation = expectation(description: #function)\n+    functions.httpsCallable(\n+      \"scalarTest\",\n+      requestAs: Int16.self,\n+      responseAs: Int.self\n+    ).call(17) { result in\n+      guard case .success = result else {\n+        return XCTFail(\"Unexpected failure.\")\n+      }\n+      XCTAssert(Thread.isMainThread)\n+      expectation.fulfill()\n+    }\n+    waitForExpectations(timeout: 5)\n+  }\n+\n+  func testFunctionsThrowsOnMainThread() {\n+    let expectation = expectation(description: #function)\n+    functions.httpsCallable(\n+      \"httpErrorTest\",\n+      requestAs: [Int].self,\n+      responseAs: Int.self\n+    ).call([]) { result in\n+      guard case .failure = result else {\n+        return XCTFail(\"Unexpected failure.\")\n+      }\n+      XCTAssert(Thread.isMainThread)\n+      expectation.fulfill()\n+    }\n+    waitForExpectations(timeout: 5)\n+  }\n }\n \n // MARK: - Streaming\ndiff --git a/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m b/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\nindex 124f2eb9044..1d3f88981ee 100644\n--- a/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\n+++ b/FirebaseFunctions/Tests/ObjCIntegration/FIRIntegrationTests.m\n@@ -290,4 +290,28 @@ - (void)testTimeout {\n   [self waitForExpectations:@[ expectation ] timeout:10];\n }\n \n+- (void)testFunctionsReturnsOnMainThread {\n+  XCTestExpectation *expectation = [[XCTestExpectation alloc] init];\n+  FIRHTTPSCallable *function = [_functions HTTPSCallableWithName:@\"scalarTest\"];\n+  [function callWithObject:@17\n+                completion:^(FIRHTTPSCallableResult *_Nullable result, NSError *_Nullable error) {\n+                  XCTAssert(NSThread.isMainThread);\n+                  XCTAssertNotNil(result);\n+                  [expectation fulfill];\n+                }];\n+  [self waitForExpectations:@[ expectation ] timeout:10];\n+}\n+\n+- (void)testFunctionErrorsOnMainThread {\n+  XCTestExpectation *expectation = [[XCTestExpectation alloc] init];\n+  FIRHTTPSCallable *function = [_functions HTTPSCallableWithName:@\"httpErrorTest\"];\n+  [function callWithObject:@{}\n+                completion:^(FIRHTTPSCallableResult *_Nullable result, NSError *_Nullable error) {\n+                  XCTAssert(NSThread.isMainThread);\n+                  XCTAssertNotNil(error);\n+                  [expectation fulfill];\n+                }];\n+  [self waitForExpectations:@[ expectation ] timeout:10];\n+}\n+\n @end\ndiff --git a/FirebaseFunctions/Tests/Unit/FunctionsTests.swift b/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\nindex 476fe116853..255b2785451 100644\n--- a/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\n+++ b/FirebaseFunctions/Tests/Unit/FunctionsTests.swift\n@@ -290,7 +290,7 @@ class FunctionsTests: XCTestCase {\n         }\n \n         XCTAssertEqual(error as NSError, networkError)\n-\n+        XCTAssert(Thread.isMainThread)\n         completionExpectation.fulfill()\n       }\n \n", "test_patch": "", "problem_statement": "HTTPSCallable does not invoke completion blocks on the main thread\n### Description\n\nIssue: `HTTPSCallable`'s `callWithObject:completion` does not invoke the completion block on the main thread.\n\nRegression: This appears to be a regression from #14085.\n\n### Reproducing the issue\n\n1. Create an HTTPSCallable function.\n2. Invoke it with `callWithObject:completion`\n\nExpected results: observe that the completion block is called on the main thread.\nActual results: the completion block is called on a background thread.\n\n### Firebase SDK Version\n\n11.11.1\n\n### Xcode Version\n\n16.2\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nFunctions\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\n\n```\n\n### If using Swift Package Manager, the project's Package.resolved\n\n_No response_\n\n### If using CocoaPods, the project's Podfile.lock\n\n_No response_\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.\ncc @ncooke3 @yakovmanshin \nSeems like an unintended consequence of that old change.\n\nOn the other hand, as I was refactoring some Functions components last year, it never occurred to me that calling completion handlers on the main thread was even as little as an *informal* convention\u2014more like a fortunate coincidence. In practice, I wouldn\u2019t rely on this behavior in client code; though, of course, some sort of harmonization would be welcome (so far there\u2019s only [one method](https://github.com/firebase/firebase-ios-sdk/blob/main/FirebaseFunctions/Sources/Functions.swift#L462-L502) in the entire module that explicitly schedules completions on the main thread).\n@bdaz, as a workaround until a fix is released, you could use the previous release or wrap the contents of your callback in `DispatchQueue.main.async {}`", "created_at": "2025-04-07 16:19:10", "merge_commit_sha": "5113cfd4f952fe29a28414b0b25bdae92a076dbd", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["spm-source", ".github/workflows/firestore.yml"], ["danger", ".github/workflows/danger.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["abtesting_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary", ".github/workflows/firestore.yml"], ["dynamiclinks_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-integration (macos-14, Xcode_15.4)", ".github/workflows/functions.yml"], ["specs_checking", ".github/workflows/prerelease.yml"], ["pod-lib-lint (macos, macos-15, Xcode_16.2)", ".github/workflows/functions.yml"], ["spm-unit (macos-13, Xcode_15.2, iOS)", ".github/workflows/functions.yml"], ["cmake-prod-db", ".github/workflows/firestore.yml"], ["storage_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["cmake", ".github/workflows/firestore.yml"], ["changes", ".github/workflows/firestore.yml"], ["spm-unit (macos-15, Xcode_16.2, tvOS)", ".github/workflows/functions.yml"], ["spm-unit (macos-15, Xcode_16.2, watchOS)", ".github/workflows/functions.yml"], ["update_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["pod-lib-lint (tvos, macos-15, Xcode_16.2)", ".github/workflows/functions.yml"], ["spm-unit (macos-15, Xcode_16.2, visionOS)", ".github/workflows/functions.yml"]]}
{"repo": "firebase/firebase-ios-sdk", "instance_id": "firebase__firebase-ios-sdk-13176", "base_commit": "04f04917927da92f8f09e51df89328271def076c", "patch": "diff --git a/FirebaseMessaging/CHANGELOG.md b/FirebaseMessaging/CHANGELOG.md\nindex 29aa94a6057..d04f3da27c2 100644\n--- a/FirebaseMessaging/CHANGELOG.md\n+++ b/FirebaseMessaging/CHANGELOG.md\n@@ -1,3 +1,6 @@\n+# Unreleased\n+- [fixed] Fixed the APS Environment key on visionOS. (#13173)\n+\n # 10.29.0\n - [fixed] Renamed \"initWithFileName\" internal method that was causing submission issues for some\n   users. (#13134).\ndiff --git a/FirebaseMessaging/Sources/FIRMessagingUtilities.m b/FirebaseMessaging/Sources/FIRMessagingUtilities.m\nindex 2d9bddb5187..212cdf7208d 100644\n--- a/FirebaseMessaging/Sources/FIRMessagingUtilities.m\n+++ b/FirebaseMessaging/Sources/FIRMessagingUtilities.m\n@@ -28,12 +28,16 @@\n \n static NSString *const kFIRMessagingWatchKitExtensionPoint = @\"com.apple.watchkit\";\n \n-#if TARGET_OS_IOS || TARGET_OS_TV || TARGET_OS_WATCH\n-static NSString *const kEntitlementsAPSEnvironmentKey = @\"Entitlements.aps-environment\";\n-#else\n+#if TARGET_OS_OSX\n+// macOS uses a different entitlement key than the rest of Apple's platforms:\n+// https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_developer_aps-environment\n static NSString *const kEntitlementsAPSEnvironmentKey =\n     @\"Entitlements.com.apple.developer.aps-environment\";\n-#endif\n+#else\n+// Entitlement key for all non-macOS platforms:\n+// https://developer.apple.com/documentation/bundleresources/entitlements/aps-environment\n+static NSString *const kEntitlementsAPSEnvironmentKey = @\"Entitlements.aps-environment\";\n+#endif  // TARGET_OS_OSX\n static NSString *const kAPSEnvironmentDevelopmentValue = @\"development\";\n \n #pragma mark - URL Helpers\n", "test_patch": "", "problem_statement": "Firebase Cloud Messaging not working with visionOS\n### Description\n\nI have configured remote notifications for my cross-platform SwiftUI app, everything functions correctly and I'm receiving notifications on iOS devices but receive apns errors when launching on visionOS. \r\n\r\nERROR:\r\n10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\r\n\r\nI do successfully received the device token from fcm. These errors do not occur on iOS. I have also tested this on a clean project and had the same results.\n\n### Reproducing the issue\n\nUsing standing setup for a SwiftUI app will produce the errors when targeting visionOS\r\n\r\n`import SwiftUI\r\nimport FirebaseCore\r\nimport FirebaseMessaging\r\n\r\nclass AppDelegate: NSObject, UIApplicationDelegate, MessagingDelegate, UNUserNotificationCenterDelegate {\r\n    \r\n    func application(_ application: UIApplication,\r\n                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil) -> Bool {\r\n        application.registerForRemoteNotifications()\r\n        registerForPushNotifications(application: application)\r\n        \r\n        FirebaseApp.configure()\r\n        Messaging.messaging().delegate = self\r\n        return true\r\n    }\r\n    \r\n    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {\r\n        let tokenParts = deviceToken.map { data in String(format: \"%02.2hhx\", data) }\r\n        let token = tokenParts.joined()\r\n        print(\"Device Token: \\(token)\")\r\n        Messaging.messaging().apnsToken = deviceToken\r\n    }\r\n    \r\n    func registerForPushNotifications(application: UIApplication) {\r\n        UNUserNotificationCenter.current().delegate = self\r\n        let authOptions: UNAuthorizationOptions = [.alert, .badge, .sound]\r\n      \r\n        UNUserNotificationCenter.current().requestAuthorization(options: authOptions) { granted, error in\r\n            if let error = error {\r\n                print(\"Failed to request authorization: \\(error.localizedDescription)\")\r\n                return\r\n            }\r\n            guard granted else { return }\r\n            DispatchQueue.main.async {\r\n                application.registerForRemoteNotifications()\r\n            }\r\n        }\r\n    }\r\n    \r\n    func userNotificationCenter(_ center: UNUserNotificationCenter,\r\n                                willPresent notification: UNNotification,\r\n                                withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {\r\n   \r\n        completionHandler([.banner, .badge, .sound])\r\n    }\r\n    \r\n    func userNotificationCenter(_ center: UNUserNotificationCenter,\r\n                                didReceive response: UNNotificationResponse,\r\n                                withCompletionHandler completionHandler: @escaping () -> Void) {\r\n        let userInfo = response.notification.request.content.userInfo\r\n        completionHandler()\r\n    }\r\n    \r\n    func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {\r\n        print(\"Token: \\(fcmToken)\")\r\n    }\r\n}\r\n\r\n@main\r\nstruct NotificationsApp: App {\r\n    \r\n    @UIApplicationDelegateAdaptor(AppDelegate.self) var delegate\r\n    var body: some Scene {\r\n        WindowGroup {\r\n            ContentView()\r\n        }\r\n\r\n        ImmersiveSpace(id: \"ImmersiveSpace\") {\r\n            ImmersiveView()\r\n        }\r\n    }\r\n}`\n\n### Firebase SDK Version\n\n10.28.0\n\n### Xcode Version\n\n15.2\n\n### Installation Method\n\nSwift Package Manager\n\n### Firebase Product(s)\n\nMessaging\n\n### Targeted Platforms\n\niOS, visionOS\n\n### Relevant Log Output\n\n```shell\n10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\r\n\r\n<Error>: 10.28.0 - [FirebaseMessaging][I-FCM023014] No aps-environment set. If testing on a device APNS is not correctly configured. Please recheck your provisioning profiles. If testing on a simulator this is fine since APNS doesn't work on the simulator.\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "hints_text": "I couldn't figure out how to label this issue, so I've labeled it for a human to triage. Hang tight.", "created_at": "2024-06-24 20:30:36", "merge_commit_sha": "5ef8265cfa3c262dd3f65cf12639fe8b3ecf50f5", "environment_setup_commit": "", "version": "", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["messaging-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint-abtesting", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-dynamiclinks (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, macos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["messaging-watchos-standalone-sample-build-test", ".github/workflows/messaging.yml"], ["database_quickstart", ".github/workflows/prerelease.yml"], ["remoteconfig_quickstart", ".github/workflows/prerelease.yml"], ["spm-binary-cron", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-storage", ".github/workflows/health-metrics-presubmit.yml"], ["crashlytics_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-firestore", ".github/workflows/health-metrics-presubmit.yml"], ["spm (tvOS, macos-13)", ".github/workflows/messaging.yml"], ["spm (catalyst, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-remoteconfig", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-remoteconfig (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["sanitizers-ubuntu", ".github/workflows/firestore.yml"], ["spm (iOS, macos-13)", ".github/workflows/messaging.yml"], ["quickstart-ftl-cron-only", ".github/workflows/messaging.yml"], ["pod-lib-lint-database (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["quickstart (macos-13, Xcode_15.2)", ".github/workflows/messaging.yml"], ["catalyst", ".github/workflows/messaging.yml"], ["messaging_quickstart", ".github/workflows/prerelease.yml"], ["auth_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint-database", ".github/workflows/health-metrics-presubmit.yml"], ["sanitizers-mac", ".github/workflows/firestore.yml"], ["pod-lib-lint", ".github/workflows/firestore.yml"], ["spm (tvOS, macos-14)", ".github/workflows/messaging.yml"], ["firestore_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-13)", ".github/workflows/messaging.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, ios, macos-14)", ".github/workflows/messaging.yml"], ["pod-lib-lint-inappmessaging", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, watchos --skip-tests, macos-14)", ".github/workflows/messaging.yml"], ["changes", ".github/workflows/firestore.yml"], ["buildup_SpecsTesting_repo", ".github/workflows/prerelease.yml"], ["messaging-integration-tests", ".github/workflows/messaging.yml"], ["performance_quickstart", ".github/workflows/prerelease.yml"], ["pod-lib-lint-firestore (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["check", ".github/workflows/check.yml"], ["Check changed files", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint-storage (iOS)", ".github/workflows/health-metrics-presubmit.yml"], ["pod-lib-lint (FirebaseMessaging.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"], ["buildup_SpecsTesting_repo_FirebaseCore", ".github/workflows/prerelease.yml"], ["check-firestore-internal-public-headers", ".github/workflows/firestore.yml"], ["pod-lib-lint (FirebaseMessagingInterop.podspec, tvos, macos-13)", ".github/workflows/messaging.yml"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-45187", "base_commit": "19ee4464c211a0cef3bc5070fbd7b8bd0d5c3c7d", "patch": "diff --git a/shell/browser/api/electron_api_session.cc b/shell/browser/api/electron_api_session.cc\nindex e72a309caa9e5..ae705c4fa5e67 100644\n--- a/shell/browser/api/electron_api_session.cc\n+++ b/shell/browser/api/electron_api_session.cc\n@@ -160,7 +160,8 @@ uint32_t GetQuotaMask(const std::vector<std::string>& quota_types) {\n   return quota_mask;\n }\n \n-constexpr BrowsingDataRemover::DataType kClearDataTypeAll = ~0ULL;\n+constexpr BrowsingDataRemover::DataType kClearDataTypeAll =\n+    ~0ULL & ~BrowsingDataRemover::DATA_TYPE_AVOID_CLOSING_CONNECTIONS;\n constexpr BrowsingDataRemover::OriginType kClearOriginTypeAll =\n     BrowsingDataRemover::ORIGIN_TYPE_UNPROTECTED_WEB |\n     BrowsingDataRemover::ORIGIN_TYPE_PROTECTED_WEB;\n", "test_patch": "", "problem_statement": "`avoidClosingConnections` option on `session.clearData()` doesn't work without `dataTypes`\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n34.0.0-beta.6\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS Sequoia 15.1.1\n\n### What arch are you using?\n\narm64 (including Apple Silicon)\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\n`avoidClosingConnections` is `false` by default (as the [docs](https://www.electronjs.org/docs/latest/api/session#sescleardataoptions) say), even when `dataTypes` is not set.\n\n### Actual Behavior\n\n`avoidClosingConnections` only takes effect when `dataTypes` is set.\n\nIf `dataTypes` is not set, `session.clearData()` behaves as if `avoidClosingConnections` was set to `true` (no matter what its actual value is).\n\n**Code:**\n\nThe data type mask is set to `~0ULL` here (i.e. `111111...`): https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1312\n\n`avoidClosingConnections` will try to set a bit in the data type mask to 1 here: https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1325-L1330\n\nThis only takes effect if `dataTypes` is set here: https://github.com/electron/electron/blob/9f1e23c405847c2773231347b7604731741b0034/shell/browser/api/electron_api_session.cc#L1320-L1323\n\nOtherwise, that bit is already 1.\n\n**Changes necessary:**\n\n* Either fix the default behavior (preferred).\n* Or update the docs.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/9fcc98d6a6a69f935d365df7ea741276\n\n### Additional Information\n\nI do not use this function in my code without specifying `dataTypes`, so I do not care much if this is fixed. I just noticed it while reading the code. If it doesn't get fixed, we should update the docs though.\n", "hints_text": "", "created_at": "2025-01-13 20:21:30", "merge_commit_sha": "6f7999ad0d09c7076f1878ba6e327b354425735e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['test (mas, 2)', '.github/workflows/build.yml']", "['checkout-linux', '.github/workflows/build.yml']"], ["['test (mas, 1)', '.github/workflows/build.yml']", "['build', '.github/workflows/build.yml']"], ["['Validate PR Title', '.github/workflows/semantic.yml']", "['test (linux, 3)', '.github/workflows/build.yml']"], ["['Lint', '.github/workflows/build.yml']", "['test (linux, 1)', '.github/workflows/build.yml']"], ["['setup', '.github/workflows/build.yml']", "['checkout-windows', '.github/workflows/build.yml']"], ["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['test (darwin, 1)', '.github/workflows/build.yml']"]]}
{"repo": "electron/electron", "instance_id": "electron__electron-42275", "base_commit": "3ffa35dc8d1cfe54a3343c51958c6e9f3d70ace3", "patch": "diff --git a/docs/api/structures/web-preferences.md b/docs/api/structures/web-preferences.md\nindex 9c6a3ecc8fc8c..044cd2b2270b1 100644\n--- a/docs/api/structures/web-preferences.md\n+++ b/docs/api/structures/web-preferences.md\n@@ -143,6 +143,7 @@\n   contain the layout of the document\u2014without requiring scrolling. Enabling\n   this will cause the `preferred-size-changed` event to be emitted on the\n   `WebContents` when the preferred size changes. Default is `false`.\n+* `transparent` boolean (optional) - Whether to enable background transparency for the guest page. Default is `true`. **Note:** The guest page's text and background colors are derived from the [color scheme](https://developer.mozilla.org/en-US/docs/Web/CSS/color-scheme) of its root element. When transparency is enabled, the text color will still change accordingly but the background will remain transparent.\n \n [chrome-content-scripts]: https://developer.chrome.com/extensions/content_scripts#execution-environment\n [runtime-enabled-features]: https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/renderer/platform/runtime_enabled_features.json5\ndiff --git a/docs/api/webview-tag.md b/docs/api/webview-tag.md\nindex 99e740eb39a9c..14103680f7f4e 100644\n--- a/docs/api/webview-tag.md\n+++ b/docs/api/webview-tag.md\n@@ -221,9 +221,7 @@ windows. Popups are disabled by default.\n ```\n \n A `string` which is a comma separated list of strings which specifies the web preferences to be set on the webview.\n-The full list of supported preference strings can be found in [BrowserWindow](browser-window.md#new-browserwindowoptions). In addition, webview supports the following preferences:\n-\n-* `transparent` boolean (optional) - Whether to enable background transparency for the guest page. Default is `true`. **Note:** The guest page's text and background colors are derived from the [color scheme](https://developer.mozilla.org/en-US/docs/Web/CSS/color-scheme) of its root element. When transparency is enabled, the text color will still change accordingly but the background will remain transparent.\n+The full list of supported preference strings can be found in [BrowserWindow](browser-window.md#new-browserwindowoptions).\n \n The string follows the same format as the features string in `window.open`.\n A name by itself is given a `true` boolean value.\n", "test_patch": "", "problem_statement": "[Bug]: `WebviewTag.webpreferences` has wrong type\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n30.0.6\r\n\r\n### What operating system are you using?\r\n\r\nmacOS\r\n\r\n### Operating System Version\r\n\r\nSonoma 14.4.1\r\n\r\n### What arch are you using?\r\n\r\narm64 (including Apple Silicon)\r\n\r\n### Last Known Working Electron version\r\n\r\n29.4.0\r\n\r\n### Expected Behavior\r\n\r\nCan assign `\"contextIsolation=false, nodeintegration=true\"` and other valid strings to `WebviewTag.webpreferences`. The type of `WebviewTag.webpreferences` should be `string`.\r\n\r\n### Actual Behavior\r\n\r\n```\r\nerror TS2322: Type '\"contextIsolation=false\"' is not assignable to type '\"transparent\"'\r\n```\r\n\r\n`WebviewTag.webpreferences` has type `'transparent'`.\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\n* Broken in #40301\n", "hints_text": "", "created_at": "2024-05-25 04:19:17", "merge_commit_sha": "6423968dc56ce40259ed4a90744dbb9368dffd4e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['deprecation-review/complete label added', '.github/workflows/pull-request-labeled.yml']", "['backport/requested label added', '.github/workflows/pull-request-labeled.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104208", "base_commit": "0028fd625e2c5b202e204bc12828cbca043213d3", "patch": "diff --git a/platform/windows/SCsub b/platform/windows/SCsub\nindex 1ddefb9c331f..284b43d55de7 100644\n--- a/platform/windows/SCsub\n+++ b/platform/windows/SCsub\n@@ -124,7 +124,7 @@ if env[\"d3d12\"]:\n             Copy(\"$TARGET\", \"$SOURCE\"),\n         )\n \n-if not os.getenv(\"VCINSTALLDIR\"):\n+if not env.msvc:\n     if env[\"debug_symbols\"]:\n         env.AddPostAction(prog, env.Run(platform_windows_builders.make_debug_mingw))\n         if env[\"windows_subsystem\"] == \"gui\":\n", "test_patch": "", "problem_statement": "[Buildsystem] Builds fail with MSVC with separate build symbols\n### Tested versions\n\n- Reproducible in master [0028fd625e2c5b202e204bc12828cbca043213d3]\n- Not reproducible in master [b5bdb88062a31a982c8f3bf4b820188edd53c6c5]\n- Bisected down to #103864 [45053520216b70d5669587b55e6b3d98df201c3d]\n\n### System information\n\nGodot v4.4.stable - Windows 10.0.26100 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2080 (NVIDIA; 32.0.15.7247) - AMD Ryzen 7 3800XT 8-Core Processor (16 Threads)\n\n### Issue description\n\nWhen attempting to build Godot, I'm getting the following error when generating the executable:\n```\nStarting build...\ncmd /c chcp 65001>nul && scons dev_build=yes separate_debug_symbols=yes tests=yes compiledb=yes d3d12=yes\nscons: Reading SConscript files ...\nAutomatically detected platform: windows\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\nBuilding for platform \"windows\", architecture \"x86_64\", target \"editor\".\nINFO: Developer build, with debug optimization level and debug symbols (unless overridden).\nChecking for C header file mntent.h... (cached) no\nscons: done reading SConscript files.\nscons: Building targets ...\nLinking Program bin\\godot.windows.editor.dev.x86_64.exe ...\nGenerating compile_commands.json ...\nGenerating bin\\godot.windows.editor.dev.x86_64.exe ...\nscons: *** [bin\\godot.windows.editor.dev.x86_64.exe] KeyError : 'OBJCOPY'\nTraceback (most recent call last):\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 2677, in __getitem__\n    return self.__dict__['overrides'][key]\nKeyError: 'OBJCOPY'\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Action.py\", line 1434, in execute\n    result = self.execfunction(target=target, source=rsources, env=env)\n  File \"C:\\Users\\kilau\\Development\\godot_dev\\godot4\\platform\\windows\\platform_windows_builders.py\", line 10, in make_debug_mingw\n    os.system(\"{0} --only-keep-debug {1} {1}.debugsymbols\".format(env[\"OBJCOPY\"], dst))\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 2681, in __getitem__\n    return self.__dict__['__subject'].__getitem__(key)\n  File \"C:\\Users\\kilau\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\SCons\\Environment.py\", line 603, in __getitem__\n    return self._dict[key]\nKeyError: 'OBJCOPY'\nscons: building terminated because of errors.\nINFO: Time elapsed: 00:00:20.14 \n```\n\n### Steps to reproduce\n\nRun `scons dev_build=yes separate_debug_symbols=yes tests=yes compiledb=yes` on a system with MSVC.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "Ran a bisect and narrowed down the regression to #103864 \nThis issue can be worked around by running SCons within the `x64 Native Tools Command Prompt for VS 2022` console.\n\nFor VSCode, this can be setup by adding to your `tasks.json` file:\n``` json\n\"windows\": {\n        \"options\": {\n            \"shell\": {\n                \"executable\": \"cmd.exe\",\n                \"args\": [\n                    \"/C\",\n                    \"\\\"C:\\\\Program Files\\\\Microsoft Visual Studio\\\\2022\\\\Community\\\\VC\\\\Auxiliary\\\\Build\\\\vcvars64.bat\\\"\",\n                    \"&&\"\n                ]\n            }\n        }\n    }\n```\n\nThen, change any build actions to type `shell`.\n\nProcess is documented here: https://code.visualstudio.com/docs/cpp/config-msvc#_run-vs-code-outside-the-developer-command-prompt", "created_at": "2025-03-15 23:17:51", "merge_commit_sha": "2dc6da6336c3c38871730d1eded5190ebbfa51c4", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ clang-cl (target=editor, tests=yes, use_llvm=yes)', '.github/workflows/runner.yml']", "['Code style, file formatting, and docs', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor with ThreadSanitizer (target=editor, tests=yes, dev_build=yes, use_tsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']", "['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-104019", "base_commit": "30b0aadab65fcafb9a160dba2c9abfd005bb62a5", "patch": "diff --git a/.github/actions/godot-cpp-build/action.yml b/.github/actions/godot-cpp-build/action.yml\nindex 7667527246ed..1046f09470e9 100644\n--- a/.github/actions/godot-cpp-build/action.yml\n+++ b/.github/actions/godot-cpp-build/action.yml\n@@ -1,9 +1,6 @@\n name: Build godot-cpp\n description: Build godot-cpp with the provided options.\n \n-env:\n-  GODOT_CPP_BRANCH: 4.4\n-\n inputs:\n   bin:\n     description: Path to the Godot binary.\n@@ -16,6 +13,10 @@ inputs:\n     description: The SCons cache path.\n     default: ${{ github.workspace }}/.scons_cache/\n     type: string\n+  godot-cpp-branch:\n+    description: The godot-cpp branch.\n+    default: master\n+    type: string\n \n runs:\n   using: composite\n@@ -25,7 +26,7 @@ runs:\n       with:\n         submodules: recursive\n         repository: godotengine/godot-cpp\n-        ref: ${{ env.GODOT_CPP_BRANCH }}\n+        ref: ${{ inputs.godot-cpp-branch }}\n         path: godot-cpp\n \n     - name: Extract API\ndiff --git a/.github/workflows/android_builds.yml b/.github/workflows/android_builds.yml\nindex f1c721fb6382..865f826bc0f3 100644\n--- a/.github/workflows/android_builds.yml\n+++ b/.github/workflows/android_builds.yml\n@@ -62,8 +62,8 @@ jobs:\n       - name: Download pre-built Android Swappy Frame Pacing Library\n         uses: dsaltares/fetch-gh-release-asset@1.1.2\n         with:\n-          repo: darksylinc/godot-swappy\n-          version: tags/v2023.3.0.0\n+          repo: godotengine/godot-swappy\n+          version: tags/from-source-2025-01-31\n           file: godot-swappy.7z\n           target: swappy/godot-swappy.7z\n \ndiff --git a/.github/workflows/linux_builds.yml b/.github/workflows/linux_builds.yml\nindex 44aefc77a73b..1cb9637cee50 100644\n--- a/.github/workflows/linux_builds.yml\n+++ b/.github/workflows/linux_builds.yml\n@@ -6,6 +6,7 @@ on:\n env:\n   # Used for the cache key. Add version suffix to force clean build.\n   GODOT_BASE_BRANCH: 4.4\n+  GODOT_CPP_BRANCH: 4.4\n   SCONSFLAGS: verbose=yes warnings=extra werror=yes module_text_server_fb_enabled=yes strict_checks=yes\n   DOTNET_NOLOGO: true\n   DOTNET_CLI_TELEMETRY_OPTOUT: true\n@@ -174,6 +175,7 @@ jobs:\n         with:\n           bin: ${{ matrix.bin }}\n           scons-flags: target=template_debug dev_build=yes verbose=yes\n+          godot-cpp-branch: ${{ env.GODOT_CPP_BRANCH }}\n \n       - name: Save Godot build cache\n         uses: ./.github/actions/godot-cache-save\ndiff --git a/.gitignore b/.gitignore\nindex 2c3bf742ba2e..8adc7b786c63 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -263,6 +263,11 @@ bld/\n !thirdparty/**/arm/\n !thirdparty/**/arm64/\n \n+thirdparty/swappy-frame-pacing/arm64-v8a/abi.json\n+thirdparty/swappy-frame-pacing/armeabi-v7a/abi.json\n+thirdparty/swappy-frame-pacing/x86/abi.json\n+thirdparty/swappy-frame-pacing/x86_64/abi.json\n+\n # Visual Studio 2015/2017 cache/options directory\n .vs/\n \ndiff --git a/core/object/worker_thread_pool.cpp b/core/object/worker_thread_pool.cpp\nindex 08903d61964d..d9ff30576794 100644\n--- a/core/object/worker_thread_pool.cpp\n+++ b/core/object/worker_thread_pool.cpp\n@@ -37,6 +37,8 @@\n \n WorkerThreadPool::Task *const WorkerThreadPool::ThreadData::YIELDING = (Task *)1;\n \n+HashMap<StringName, WorkerThreadPool *> WorkerThreadPool::named_pools;\n+\n void WorkerThreadPool::Task::free_template_userdata() {\n \tERR_FAIL_NULL(template_userdata);\n \tERR_FAIL_NULL(native_func_userdata);\n@@ -184,25 +186,25 @@ void WorkerThreadPool::_thread_function(void *p_user) {\n \twhile (true) {\n \t\tTask *task_to_process = nullptr;\n \t\t{\n-\t\t\tMutexLock lock(singleton->task_mutex);\n+\t\t\tMutexLock lock(thread_data->pool->task_mutex);\n \n-\t\t\tbool exit = singleton->_handle_runlevel(thread_data, lock);\n+\t\t\tbool exit = thread_data->pool->_handle_runlevel(thread_data, lock);\n \t\t\tif (unlikely(exit)) {\n \t\t\t\tbreak;\n \t\t\t}\n \n \t\t\tthread_data->signaled = false;\n \n-\t\t\tif (singleton->task_queue.first()) {\n-\t\t\t\ttask_to_process = singleton->task_queue.first()->self();\n-\t\t\t\tsingleton->task_queue.remove(singleton->task_queue.first());\n+\t\t\tif (thread_data->pool->task_queue.first()) {\n+\t\t\t\ttask_to_process = thread_data->pool->task_queue.first()->self();\n+\t\t\t\tthread_data->pool->task_queue.remove(thread_data->pool->task_queue.first());\n \t\t\t} else {\n \t\t\t\tthread_data->cond_var.wait(lock);\n \t\t\t}\n \t\t}\n \n \t\tif (task_to_process) {\n-\t\t\tsingleton->_process_task(task_to_process);\n+\t\t\tthread_data->pool->_process_task(task_to_process);\n \t\t}\n \t}\n }\n@@ -497,7 +499,7 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (singleton->task_queue.first()) {\n+\t\t\tif (p_caller_pool_thread->pool->task_queue.first()) {\n \t\t\t\ttask_to_process = task_queue.first()->self();\n \t\t\t\ttask_queue.remove(task_queue.first());\n \t\t\t}\n@@ -505,7 +507,9 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\tif (!task_to_process) {\n \t\t\t\tp_caller_pool_thread->awaited_task = p_task;\n \n-\t\t\t\t_unlock_unlockable_mutexes();\n+\t\t\t\tif (this == singleton) {\n+\t\t\t\t\t_unlock_unlockable_mutexes();\n+\t\t\t\t}\n \t\t\t\trelock_unlockables = true;\n \n \t\t\t\tp_caller_pool_thread->cond_var.wait(lock);\n@@ -514,7 +518,7 @@ void WorkerThreadPool::_wait_collaboratively(ThreadData *p_caller_pool_thread, T\n \t\t\t}\n \t\t}\n \n-\t\tif (relock_unlockables) {\n+\t\tif (relock_unlockables && this == singleton) {\n \t\t\t_lock_unlockable_mutexes();\n \t\t}\n \n@@ -690,9 +694,13 @@ void WorkerThreadPool::wait_for_group_task_completion(GroupID p_group) {\n \t{\n \t\tGroup *group = *groupp;\n \n-\t\t_unlock_unlockable_mutexes();\n+\t\tif (this == singleton) {\n+\t\t\t_unlock_unlockable_mutexes();\n+\t\t}\n \t\tgroup->done_semaphore.wait();\n-\t\t_lock_unlockable_mutexes();\n+\t\tif (this == singleton) {\n+\t\t\t_lock_unlockable_mutexes();\n+\t\t}\n \n \t\tuint32_t max_users = group->tasks_used + 1; // Add 1 because the thread waiting for it is also user. Read before to avoid another thread freeing task after increment.\n \t\tuint32_t finished_users = group->finished.increment(); // fetch happens before inc, so increment later.\n@@ -709,15 +717,15 @@ void WorkerThreadPool::wait_for_group_task_completion(GroupID p_group) {\n #endif\n }\n \n-int WorkerThreadPool::get_thread_index() {\n+int WorkerThreadPool::get_thread_index() const {\n \tThread::ID tid = Thread::get_caller_id();\n-\treturn singleton->thread_ids.has(tid) ? singleton->thread_ids[tid] : -1;\n+\treturn thread_ids.has(tid) ? thread_ids[tid] : -1;\n }\n \n-WorkerThreadPool::TaskID WorkerThreadPool::get_caller_task_id() {\n+WorkerThreadPool::TaskID WorkerThreadPool::get_caller_task_id() const {\n \tint th_index = get_thread_index();\n-\tif (th_index != -1 && singleton->threads[th_index].current_task) {\n-\t\treturn singleton->threads[th_index].current_task->self;\n+\tif (th_index != -1 && threads[th_index].current_task) {\n+\t\treturn threads[th_index].current_task->self;\n \t} else {\n \t\treturn INVALID_TASK_ID;\n \t}\n@@ -766,6 +774,7 @@ void WorkerThreadPool::init(int p_thread_count, float p_low_priority_task_ratio)\n \n \tfor (uint32_t i = 0; i < threads.size(); i++) {\n \t\tthreads[i].index = i;\n+\t\tthreads[i].pool = this;\n \t\tthreads[i].thread.start(&WorkerThreadPool::_thread_function, &threads[i]);\n \t\tthread_ids.insert(threads[i].thread.get_id(), i);\n \t}\n@@ -832,10 +841,33 @@ void WorkerThreadPool::_bind_methods() {\n \tClassDB::bind_method(D_METHOD(\"wait_for_group_task_completion\", \"group_id\"), &WorkerThreadPool::wait_for_group_task_completion);\n }\n \n-WorkerThreadPool::WorkerThreadPool() {\n-\tsingleton = this;\n+WorkerThreadPool *WorkerThreadPool::get_named_pool(const StringName &p_name) {\n+\tWorkerThreadPool **pool_ptr = named_pools.getptr(p_name);\n+\tif (pool_ptr) {\n+\t\treturn *pool_ptr;\n+\t} else {\n+\t\tWorkerThreadPool *pool = memnew(WorkerThreadPool(false));\n+\t\tpool->init();\n+\t\tnamed_pools[p_name] = pool;\n+\t\treturn pool;\n+\t}\n+}\n+\n+WorkerThreadPool::WorkerThreadPool(bool p_singleton) {\n+\tif (p_singleton) {\n+\t\tsingleton = this;\n+\t}\n }\n \n WorkerThreadPool::~WorkerThreadPool() {\n \tfinish();\n+\n+\tif (this == singleton) {\n+\t\tsingleton = nullptr;\n+\t\tfor (KeyValue<StringName, WorkerThreadPool *> &E : named_pools) {\n+\t\t\tE.value->finish();\n+\t\t\tmemdelete(E.value);\n+\t\t}\n+\t\tnamed_pools.clear();\n+\t}\n }\ndiff --git a/core/object/worker_thread_pool.h b/core/object/worker_thread_pool.h\nindex 58e86e3e48eb..76332ec8a3d3 100644\n--- a/core/object/worker_thread_pool.h\n+++ b/core/object/worker_thread_pool.h\n@@ -119,6 +119,7 @@ class WorkerThreadPool : public Object {\n \t\tTask *current_task = nullptr;\n \t\tTask *awaited_task = nullptr; // Null if not awaiting the condition variable, or special value (YIELDING).\n \t\tConditionVariable cond_var;\n+\t\tWorkerThreadPool *pool = nullptr;\n \n \t\tThreadData() :\n \t\t\t\tsignaled(false),\n@@ -166,6 +167,8 @@ class WorkerThreadPool : public Object {\n \n \tuint64_t last_task = 1;\n \n+\tstatic HashMap<StringName, WorkerThreadPool *> named_pools;\n+\n \tstatic void _thread_function(void *p_user);\n \n \tvoid _process_task(Task *task);\n@@ -266,9 +269,12 @@ class WorkerThreadPool : public Object {\n #endif\n \t}\n \n+\t// Note: Do not use this unless you know what you are doing, and it is absolutely necessary. Main thread pool (`get_singleton()`) should be preferred instead.\n+\tstatic WorkerThreadPool *get_named_pool(const StringName &p_name);\n+\n \tstatic WorkerThreadPool *get_singleton() { return singleton; }\n-\tstatic int get_thread_index();\n-\tstatic TaskID get_caller_task_id();\n+\tint get_thread_index() const;\n+\tTaskID get_caller_task_id() const;\n \n #ifdef THREADS_ENABLED\n \t_ALWAYS_INLINE_ static uint32_t thread_enter_unlock_allowance_zone(const MutexLock<BinaryMutex> &p_lock) { return _thread_enter_unlock_allowance_zone(p_lock._get_lock()); }\n@@ -285,7 +291,7 @@ class WorkerThreadPool : public Object {\n \tvoid init(int p_thread_count = -1, float p_low_priority_task_ratio = 0.3);\n \tvoid exit_languages_threads();\n \tvoid finish();\n-\tWorkerThreadPool();\n+\tWorkerThreadPool(bool p_singleton = true);\n \t~WorkerThreadPool();\n };\n \ndiff --git a/core/os/os.h b/core/os/os.h\nindex e0ec320e32ba..c8ac5c8eac7a 100644\n--- a/core/os/os.h\n+++ b/core/os/os.h\n@@ -362,9 +362,9 @@ class OS {\n \t// This is invoked by the GDExtensionManager after loading GDExtensions specified by the project.\n \tvirtual void load_platform_gdextensions() const {}\n \n-\t// Windows only. Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n-\tvirtual bool _test_create_rendering_device_and_gl() const { return true; }\n-\tvirtual bool _test_create_rendering_device() const { return true; }\n+\t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const { return true; }\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const { return true; }\n \n \tOS();\n \tvirtual ~OS();\ndiff --git a/core/variant/callable.cpp b/core/variant/callable.cpp\nindex 402dc6823c0a..0603ea273253 100644\n--- a/core/variant/callable.cpp\n+++ b/core/variant/callable.cpp\n@@ -188,7 +188,7 @@ int Callable::get_argument_count(bool *r_is_valid) const {\n \tif (is_custom()) {\n \t\tbool valid = false;\n \t\treturn custom->get_argument_count(r_is_valid ? *r_is_valid : valid);\n-\t} else if (!is_null()) {\n+\t} else if (is_valid()) {\n \t\treturn get_object()->get_method_argument_count(method, r_is_valid);\n \t} else {\n \t\tif (r_is_valid) {\ndiff --git a/doc/classes/LineEdit.xml b/doc/classes/LineEdit.xml\nindex c6cdacb6ec25..879b179dbfef 100644\n--- a/doc/classes/LineEdit.xml\n+++ b/doc/classes/LineEdit.xml\n@@ -252,7 +252,7 @@\n \t\t\tThe caret's column position inside the [LineEdit]. When set, the text may scroll to accommodate it.\n \t\t</member>\n \t\t<member name=\"caret_force_displayed\" type=\"bool\" setter=\"set_caret_force_displayed\" getter=\"is_caret_force_displayed\" default=\"false\">\n-\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if focus is lost.\n+\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if not editing or focus is lost.\n \t\t</member>\n \t\t<member name=\"caret_mid_grapheme\" type=\"bool\" setter=\"set_caret_mid_grapheme_enabled\" getter=\"is_caret_mid_grapheme_enabled\" default=\"false\">\n \t\t\tAllow moving caret, selecting and removing the individual composite character components.\ndiff --git a/doc/classes/NativeMenu.xml b/doc/classes/NativeMenu.xml\nindex 6081d7afc51e..5eaec56e7ec9 100644\n--- a/doc/classes/NativeMenu.xml\n+++ b/doc/classes/NativeMenu.xml\n@@ -374,7 +374,7 @@\n \t\t\t<param index=\"0\" name=\"rid\" type=\"RID\" />\n \t\t\t<description>\n \t\t\t\tReturns global menu open callback.\n-\t\t\t\tb]Note:[/b] This method is implemented only on macOS.\n+\t\t\t\t[b]Note:[/b] This method is implemented only on macOS.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"get_size\" qualifiers=\"const\">\ndiff --git a/doc/classes/RDTextureView.xml b/doc/classes/RDTextureView.xml\nindex bd8102d5531d..2e03ee44aab4 100644\n--- a/doc/classes/RDTextureView.xml\n+++ b/doc/classes/RDTextureView.xml\n@@ -9,7 +9,7 @@\n \t<tutorials>\n \t</tutorials>\n \t<members>\n-\t\t<member name=\"format_override\" type=\"int\" setter=\"set_format_override\" getter=\"get_format_override\" enum=\"RenderingDevice.DataFormat\" default=\"218\">\n+\t\t<member name=\"format_override\" type=\"int\" setter=\"set_format_override\" getter=\"get_format_override\" enum=\"RenderingDevice.DataFormat\" default=\"232\">\n \t\t\tOptional override for the data format to return sampled values in. The corresponding [RDTextureFormat] must have had this added as a shareable format. The default value of [constant RenderingDevice.DATA_FORMAT_MAX] does not override the format.\n \t\t</member>\n \t\t<member name=\"swizzle_a\" type=\"int\" setter=\"set_swizzle_a\" getter=\"get_swizzle_a\" enum=\"RenderingDevice.TextureSwizzle\" default=\"6\">\ndiff --git a/doc/classes/RDVertexAttribute.xml b/doc/classes/RDVertexAttribute.xml\nindex 364b82526b6c..04e4bb53a045 100644\n--- a/doc/classes/RDVertexAttribute.xml\n+++ b/doc/classes/RDVertexAttribute.xml\n@@ -9,7 +9,7 @@\n \t<tutorials>\n \t</tutorials>\n \t<members>\n-\t\t<member name=\"format\" type=\"int\" setter=\"set_format\" getter=\"get_format\" enum=\"RenderingDevice.DataFormat\" default=\"218\">\n+\t\t<member name=\"format\" type=\"int\" setter=\"set_format\" getter=\"get_format\" enum=\"RenderingDevice.DataFormat\" default=\"232\">\n \t\t\tThe way that this attribute's data is interpreted when sent to a shader.\n \t\t</member>\n \t\t<member name=\"frequency\" type=\"int\" setter=\"set_frequency\" getter=\"get_frequency\" enum=\"RenderingDevice.VertexFrequency\" default=\"0\">\ndiff --git a/doc/classes/RenderingDevice.xml b/doc/classes/RenderingDevice.xml\nindex 8db0272c75bf..2fc0e485447c 100644\n--- a/doc/classes/RenderingDevice.xml\n+++ b/doc/classes/RenderingDevice.xml\n@@ -1871,7 +1871,35 @@\n \t\t<constant name=\"DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM\" value=\"217\" enum=\"DataFormat\">\n \t\t\t16-bit-per-channel unsigned floating-point green/blue/red channel data with normalized value, plus 6 unused bits after each channel. Stored across 3 separate planes (green + blue + red). Values are in the [code][0.0, 1.0][/code] range.\n \t\t</constant>\n-\t\t<constant name=\"DATA_FORMAT_MAX\" value=\"218\" enum=\"DataFormat\">\n+\t\t<constant name=\"DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK\" value=\"218\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK\" value=\"219\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK\" value=\"220\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK\" value=\"221\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK\" value=\"222\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK\" value=\"223\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK\" value=\"224\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK\" value=\"225\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK\" value=\"226\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK\" value=\"227\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK\" value=\"228\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK\" value=\"229\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK\" value=\"230\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK\" value=\"231\" enum=\"DataFormat\">\n+\t\t</constant>\n+\t\t<constant name=\"DATA_FORMAT_MAX\" value=\"232\" enum=\"DataFormat\">\n \t\t\tRepresents the size of the [enum DataFormat] enum.\n \t\t</constant>\n \t\t<constant name=\"BARRIER_MASK_VERTEX\" value=\"1\" enum=\"BarrierMask\" is_bitfield=\"true\">\ndiff --git a/drivers/apple/joypad_apple.h b/drivers/apple/joypad_apple.h\nindex 909648e253dd..d89707c03d75 100644\n--- a/drivers/apple/joypad_apple.h\n+++ b/drivers/apple/joypad_apple.h\n@@ -43,6 +43,7 @@ struct GameController {\n \tRumbleContext *rumble_context API_AVAILABLE(macos(11.0), ios(14.0), tvos(14.0)) = nil;\n \tNSInteger ff_effect_timestamp = 0;\n \tbool force_feedback = false;\n+\tbool nintendo_button_layout = false;\n \n \tGameController(int p_joy_id, GCController *p_controller);\n \t~GameController();\ndiff --git a/drivers/apple/joypad_apple.mm b/drivers/apple/joypad_apple.mm\nindex 148ec4cb2718..e14fc96a2841 100644\n--- a/drivers/apple/joypad_apple.mm\n+++ b/drivers/apple/joypad_apple.mm\n@@ -144,6 +144,12 @@ void play_strong_pattern(CHHapticPattern *p_pattern) {\n \t\t}\n \t}\n \n+\tif (@available(macOS 10.15, iOS 13.0, tvOS 13.0, *)) {\n+\t\tif ([controller.productCategory isEqualToString:@\"Switch Pro Controller\"] || [controller.productCategory isEqualToString:@\"Nintendo Switch Joy-Con (L/R)\"]) {\n+\t\t\tnintendo_button_layout = true;\n+\t\t}\n+\t}\n+\n \tint l_joy_id = joy_id;\n \n \tauto BUTTON = [l_joy_id](JoyButton p_button) {\n@@ -155,10 +161,18 @@ void play_strong_pattern(CHHapticPattern *p_pattern) {\n \tif (controller.extendedGamepad != nil) {\n \t\tGCExtendedGamepad *gamepad = controller.extendedGamepad;\n \n-\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::A);\n-\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::B);\n-\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::X);\n-\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\tif (nintendo_button_layout) {\n+\t\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::B);\n+\t\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::A);\n+\t\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::X);\n+\t\t} else {\n+\t\t\tgamepad.buttonA.pressedChangedHandler = BUTTON(JoyButton::A);\n+\t\t\tgamepad.buttonB.pressedChangedHandler = BUTTON(JoyButton::B);\n+\t\t\tgamepad.buttonX.pressedChangedHandler = BUTTON(JoyButton::X);\n+\t\t\tgamepad.buttonY.pressedChangedHandler = BUTTON(JoyButton::Y);\n+\t\t}\n+\n \t\tgamepad.leftShoulder.pressedChangedHandler = BUTTON(JoyButton::LEFT_SHOULDER);\n \t\tgamepad.rightShoulder.pressedChangedHandler = BUTTON(JoyButton::RIGHT_SHOULDER);\n \t\tgamepad.dpad.up.pressedChangedHandler = BUTTON(JoyButton::DPAD_UP);\ndiff --git a/drivers/d3d12/rendering_device_driver_d3d12.cpp b/drivers/d3d12/rendering_device_driver_d3d12.cpp\nindex 29b36f140551..f5772f2e3024 100644\n--- a/drivers/d3d12/rendering_device_driver_d3d12.cpp\n+++ b/drivers/d3d12/rendering_device_driver_d3d12.cpp\n@@ -332,6 +332,20 @@ const RenderingDeviceDriverD3D12::D3D12Format RenderingDeviceDriverD3D12::RD_TO_\n \t/* DATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM */ {},\n \t/* DATA_FORMAT_G16_B16R16_2PLANE_422_UNORM */ {},\n \t/* DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM */ {},\n+\t/* DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK*/ {},\n+\t/* DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK */ {},\n+\t/* DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK */ {},\n };\n \n Error RenderingDeviceDriverD3D12::DescriptorsHeap::allocate(ID3D12Device *p_device, D3D12_DESCRIPTOR_HEAP_TYPE p_type, uint32_t p_descriptor_count, bool p_for_gpu) {\ndiff --git a/drivers/gles3/effects/copy_effects.cpp b/drivers/gles3/effects/copy_effects.cpp\nindex 47ca832bd7ab..4d74a4996b9f 100644\n--- a/drivers/gles3/effects/copy_effects.cpp\n+++ b/drivers/gles3/effects/copy_effects.cpp\n@@ -243,7 +243,7 @@ void CopyEffects::gaussian_blur(GLuint p_source_texture, int p_mipmap_count, con\n \n \t\tglBindTexture(GL_TEXTURE_2D, p_source_texture);\n \t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_BASE_LEVEL, i - 1);\n-\t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAX_LEVEL, i - 1);\n+\t\tglTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAX_LEVEL, i);\n \t\tglFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, p_source_texture, i);\n #ifdef DEV_ENABLED\n \t\tGLenum status = glCheckFramebufferStatus(GL_FRAMEBUFFER);\ndiff --git a/drivers/gles3/rasterizer_canvas_gles3.cpp b/drivers/gles3/rasterizer_canvas_gles3.cpp\nindex 0ca013abd1a0..441636cd26db 100644\n--- a/drivers/gles3/rasterizer_canvas_gles3.cpp\n+++ b/drivers/gles3/rasterizer_canvas_gles3.cpp\n@@ -1152,6 +1152,12 @@ void RasterizerCanvasGLES3::_record_item_commands(const Item *p_item, RID p_rend\n \t\t\t\t\t// Reset base data.\n \t\t\t\t\t_update_transform_2d_to_mat2x3(base_transform * draw_transform, state.instance_data_array[r_index].world);\n \t\t\t\t\t_prepare_canvas_texture(state.canvas_instance_batches[state.current_batch_index].tex, state.canvas_instance_batches[state.current_batch_index].filter, state.canvas_instance_batches[state.current_batch_index].repeat, r_index, texpixel_size);\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[0] = lights[0];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[1] = lights[1];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[2] = lights[2];\n+\t\t\t\t\tstate.instance_data_array[r_index].lights[3] = lights[3];\n+\t\t\t\t\tstate.instance_data_array[r_index].flags = base_flags;\n+\t\t\t\t\tstate.instance_data_array[r_index].instance_uniforms_ofs = p_item->instance_allocated_shader_uniforms_offset;\n \n \t\t\t\t\tfor (uint32_t j = 0; j < 3; j++) {\n \t\t\t\t\t\tint offset = j == 0 ? 0 : 1;\ndiff --git a/drivers/gles3/storage/particles_storage.cpp b/drivers/gles3/storage/particles_storage.cpp\nindex 73d7e340d2a8..599412c5b2de 100644\n--- a/drivers/gles3/storage/particles_storage.cpp\n+++ b/drivers/gles3/storage/particles_storage.cpp\n@@ -513,7 +513,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tGLES3::TextureStorage *texture_storage = GLES3::TextureStorage::get_singleton();\n \tGLES3::MaterialStorage *material_storage = GLES3::MaterialStorage::get_singleton();\n \n-\tdouble new_phase = Math::fmod(p_particles->phase + (p_delta / p_particles->lifetime) * p_particles->speed_scale, 1.0);\n+\tdouble new_phase = Math::fmod(p_particles->phase + (p_delta / p_particles->lifetime), 1.0);\n \n \t//update current frame\n \tParticlesFrameParams frame_params;\n@@ -534,7 +534,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tp_particles->phase = new_phase;\n \n \tframe_params.time = RSG::rasterizer->get_total_time();\n-\tframe_params.delta = p_delta * p_particles->speed_scale;\n+\tframe_params.delta = p_delta;\n \tframe_params.random_seed = p_particles->random_seed;\n \tframe_params.explosiveness = p_particles->explosiveness;\n \tframe_params.randomness = p_particles->randomness;\n@@ -1097,8 +1097,6 @@ void ParticlesStorage::update_particles() {\n \t\t\tfixed_fps = particles->fixed_fps;\n \t\t}\n \n-\t\tbool zero_time_scale = Engine::get_singleton()->get_time_scale() <= 0.0;\n-\n \t\tif (particles->clear && particles->pre_process_time > 0.0) {\n \t\t\tdouble frame_time;\n \t\t\tif (fixed_fps > 0) {\n@@ -1115,37 +1113,27 @@ void ParticlesStorage::update_particles() {\n \t\t\t}\n \t\t}\n \n+\t\tdouble time_scale = MAX(particles->speed_scale, 0.0);\n+\n \t\tif (fixed_fps > 0) {\n-\t\t\tdouble frame_time;\n-\t\t\tdouble decr;\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\tframe_time = 0.0;\n-\t\t\t\tdecr = 1.0 / fixed_fps;\n-\t\t\t} else {\n-\t\t\t\tframe_time = 1.0 / fixed_fps;\n-\t\t\t\tdecr = frame_time;\n-\t\t\t}\n+\t\t\tdouble frame_time = 1.0 / fixed_fps;\n \t\t\tdouble delta = RSG::rasterizer->get_frame_delta_time();\n \t\t\tif (delta > 0.1) { //avoid recursive stalls if fps goes below 10\n \t\t\t\tdelta = 0.1;\n \t\t\t} else if (delta <= 0.0) { //unlikely but..\n \t\t\t\tdelta = 0.001;\n \t\t\t}\n-\t\t\tdouble todo = particles->frame_remainder + delta;\n+\t\t\tdouble todo = particles->frame_remainder + delta * time_scale;\n \n \t\t\twhile (todo >= frame_time) {\n \t\t\t\t_particles_process(particles, frame_time);\n-\t\t\t\ttodo -= decr;\n+\t\t\t\ttodo -= frame_time;\n \t\t\t}\n \n \t\t\tparticles->frame_remainder = todo;\n \n \t\t} else {\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\t_particles_process(particles, 0.0);\n-\t\t\t} else {\n-\t\t\t\t_particles_process(particles, RSG::rasterizer->get_frame_delta_time());\n-\t\t\t}\n+\t\t\t_particles_process(particles, RSG::rasterizer->get_frame_delta_time() * time_scale);\n \t\t}\n \n \t\tif (particles->request_process_time > 0.0) {\ndiff --git a/drivers/metal/pixel_formats.mm b/drivers/metal/pixel_formats.mm\nindex c9226590b169..c784faa8397b 100644\n--- a/drivers/metal/pixel_formats.mm\n+++ b/drivers/metal/pixel_formats.mm\n@@ -493,32 +493,46 @@ void clear(T *p_val, size_t p_count = 1) {\n \taddDataFormatDesc(EAC_R11G11_SNORM_BLOCK, EAC_RG11Snorm, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \n \taddDataFormatDesc(ASTC_4x4_UNORM_BLOCK, ASTC_4x4_LDR, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n+\taddDataFormatDesc(ASTC_4x4_SFLOAT_BLOCK, ASTC_4x4_HDR, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_4x4_SRGB_BLOCK, ASTC_4x4_sRGB, Invalid, Invalid, Invalid, 4, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x4_UNORM_BLOCK, ASTC_5x4_LDR, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n+\taddDataFormatDesc(ASTC_5x4_SFLOAT_BLOCK, ASTC_5x4_HDR, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x4_SRGB_BLOCK, ASTC_5x4_sRGB, Invalid, Invalid, Invalid, 5, 4, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x5_UNORM_BLOCK, ASTC_5x5_LDR, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_5x5_SFLOAT_BLOCK, ASTC_5x5_HDR, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_5x5_SRGB_BLOCK, ASTC_5x5_sRGB, Invalid, Invalid, Invalid, 5, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x5_UNORM_BLOCK, ASTC_6x5_LDR, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_6x5_SFLOAT_BLOCK, ASTC_6x5_HDR, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x5_SRGB_BLOCK, ASTC_6x5_sRGB, Invalid, Invalid, Invalid, 6, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x6_UNORM_BLOCK, ASTC_6x6_LDR, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_6x6_SFLOAT_BLOCK, ASTC_6x6_HDR, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_6x6_SRGB_BLOCK, ASTC_6x6_sRGB, Invalid, Invalid, Invalid, 6, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x5_UNORM_BLOCK, ASTC_8x5_LDR, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x5_SFLOAT_BLOCK, ASTC_8x5_HDR, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x5_SRGB_BLOCK, ASTC_8x5_sRGB, Invalid, Invalid, Invalid, 8, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x6_UNORM_BLOCK, ASTC_8x6_LDR, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x6_SFLOAT_BLOCK, ASTC_8x6_HDR, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x6_SRGB_BLOCK, ASTC_8x6_sRGB, Invalid, Invalid, Invalid, 8, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x8_UNORM_BLOCK, ASTC_8x8_LDR, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n+\taddDataFormatDesc(ASTC_8x8_SFLOAT_BLOCK, ASTC_8x8_HDR, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_8x8_SRGB_BLOCK, ASTC_8x8_sRGB, Invalid, Invalid, Invalid, 8, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x5_UNORM_BLOCK, ASTC_10x5_LDR, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x5_SFLOAT_BLOCK, ASTC_10x5_HDR, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x5_SRGB_BLOCK, ASTC_10x5_sRGB, Invalid, Invalid, Invalid, 10, 5, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x6_UNORM_BLOCK, ASTC_10x6_LDR, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x6_SFLOAT_BLOCK, ASTC_10x6_HDR, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x6_SRGB_BLOCK, ASTC_10x6_sRGB, Invalid, Invalid, Invalid, 10, 6, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x8_UNORM_BLOCK, ASTC_10x8_LDR, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x8_SFLOAT_BLOCK, ASTC_10x8_HDR, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x8_SRGB_BLOCK, ASTC_10x8_sRGB, Invalid, Invalid, Invalid, 10, 8, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x10_UNORM_BLOCK, ASTC_10x10_LDR, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n+\taddDataFormatDesc(ASTC_10x10_SFLOAT_BLOCK, ASTC_10x10_HDR, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_10x10_SRGB_BLOCK, ASTC_10x10_sRGB, Invalid, Invalid, Invalid, 10, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x10_UNORM_BLOCK, ASTC_12x10_LDR, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n+\taddDataFormatDesc(ASTC_12x10_SFLOAT_BLOCK, ASTC_12x10_HDR, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x10_SRGB_BLOCK, ASTC_12x10_sRGB, Invalid, Invalid, Invalid, 12, 10, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x12_UNORM_BLOCK, ASTC_12x12_LDR, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n+\taddDataFormatDesc(ASTC_12x12_SFLOAT_BLOCK, ASTC_12x12_HDR, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n \taddDataFormatDesc(ASTC_12x12_SRGB_BLOCK, ASTC_12x12_sRGB, Invalid, Invalid, Invalid, 12, 12, 16, Compressed);\n \n \taddDfFormatDescChromaSubsampling(G8B8G8R8_422_UNORM, GBGR422, 1, 8, 2, 1, 4);\ndiff --git a/drivers/vulkan/rendering_device_driver_vulkan.cpp b/drivers/vulkan/rendering_device_driver_vulkan.cpp\nindex ae15191dd429..9c50c845a70b 100644\n--- a/drivers/vulkan/rendering_device_driver_vulkan.cpp\n+++ b/drivers/vulkan/rendering_device_driver_vulkan.cpp\n@@ -276,6 +276,20 @@ static const VkFormat RD_TO_VK_FORMAT[RDD::DATA_FORMAT_MAX] = {\n \tVK_FORMAT_G16_B16_R16_3PLANE_422_UNORM,\n \tVK_FORMAT_G16_B16R16_2PLANE_422_UNORM,\n \tVK_FORMAT_G16_B16_R16_3PLANE_444_UNORM,\n+\tVK_FORMAT_ASTC_4x4_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_5x4_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_5x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_6x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_6x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_8x8_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x5_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x6_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x8_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_10x10_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_12x10_SFLOAT_BLOCK,\n+\tVK_FORMAT_ASTC_12x12_SFLOAT_BLOCK,\n };\n \n static VkImageLayout RD_TO_VK_LAYOUT[RDD::TEXTURE_LAYOUT_MAX] = {\n@@ -514,6 +528,7 @@ Error RenderingDeviceDriverVulkan::_initialize_device_extensions() {\n \t_register_requested_device_extension(VK_EXT_SUBGROUP_SIZE_CONTROL_EXTENSION_NAME, false);\n \t_register_requested_device_extension(VK_EXT_ASTC_DECODE_MODE_EXTENSION_NAME, false);\n \t_register_requested_device_extension(VK_KHR_BUFFER_DEVICE_ADDRESS_EXTENSION_NAME, false);\n+\t_register_requested_device_extension(VK_EXT_TEXTURE_COMPRESSION_ASTC_HDR_EXTENSION_NAME, false);\n \n \tif (Engine::get_singleton()->is_generate_spirv_debug_info_enabled()) {\n \t\t_register_requested_device_extension(VK_KHR_SHADER_NON_SEMANTIC_INFO_EXTENSION_NAME, true);\n@@ -1547,6 +1562,10 @@ RDD::BufferID RenderingDeviceDriverVulkan::buffer_create(uint64_t p_size, BitFie\n \t\t} break;\n \t\tcase MEMORY_ALLOCATION_TYPE_GPU: {\n \t\t\tvma_usage = VMA_MEMORY_USAGE_AUTO_PREFER_DEVICE;\n+\t\t\tif (!Engine::get_singleton()->is_extra_gpu_memory_tracking_enabled()) {\n+\t\t\t\t// We must set it right now or else vmaFindMemoryTypeIndexForBufferInfo will use wrong parameters.\n+\t\t\t\talloc_create_info.usage = vma_usage;\n+\t\t\t}\n \t\t\talloc_create_info.preferredFlags = VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT;\n \t\t\tif (p_size <= SMALL_ALLOCATION_MAX_SIZE) {\n \t\t\t\tuint32_t mem_type_index = 0;\n@@ -2140,6 +2159,10 @@ void RenderingDeviceDriverVulkan::texture_unmap(TextureID p_texture) {\n }\n \n BitField<RDD::TextureUsageBits> RenderingDeviceDriverVulkan::texture_get_usages_supported_by_format(DataFormat p_format, bool p_cpu_readable) {\n+\tif (p_format >= DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK && p_format <= DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK && !enabled_device_extension_names.has(VK_EXT_TEXTURE_COMPRESSION_ASTC_HDR_EXTENSION_NAME)) {\n+\t\t// Formats that were introduced later with extensions must not reach vkGetPhysicalDeviceFormatProperties if the extension isn't available. This means it's not supported.\n+\t\treturn 0;\n+\t}\n \tVkFormatProperties properties = {};\n \tvkGetPhysicalDeviceFormatProperties(physical_device, RD_TO_VK_FORMAT[p_format], &properties);\n \ndiff --git a/drivers/windows/file_access_windows.cpp b/drivers/windows/file_access_windows.cpp\nindex a8e2a6859bc3..6835b510df73 100644\n--- a/drivers/windows/file_access_windows.cpp\n+++ b/drivers/windows/file_access_windows.cpp\n@@ -418,7 +418,7 @@ uint64_t FileAccessWindows::_get_modified_time(const String &p_file) {\n \t\tfile = file.substr(0, file.length() - 1);\n \t}\n \n-\tHANDLE handle = CreateFileW((LPCWSTR)(file.utf16().get_data()), GENERIC_READ, FILE_SHARE_READ, nullptr, OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS, nullptr);\n+\tHANDLE handle = CreateFileW((LPCWSTR)(file.utf16().get_data()), FILE_READ_ATTRIBUTES, FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE, nullptr, OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS, nullptr);\n \n \tif (handle != INVALID_HANDLE_VALUE) {\n \t\tFILETIME ft_create, ft_write;\ndiff --git a/editor/animation_track_editor.cpp b/editor/animation_track_editor.cpp\nindex dbb23d6f17a6..bb51c16f37b5 100644\n--- a/editor/animation_track_editor.cpp\n+++ b/editor/animation_track_editor.cpp\n@@ -5088,7 +5088,7 @@ void AnimationTrackEditor::_update_nearest_fps_label() {\n \t\tnearest_fps_label->hide();\n \t} else {\n \t\tnearest_fps_label->show();\n-\t\tnearest_fps_label->set_text(\"Nearest FPS: \" + itos(nearest_fps));\n+\t\tnearest_fps_label->set_text(vformat(TTR(\"Nearest FPS: %d\"), nearest_fps));\n \t}\n }\n \n@@ -7688,6 +7688,7 @@ AnimationTrackEditor::AnimationTrackEditor() {\n \tfps_compat->connect(SceneStringName(toggled), callable_mp(this, &AnimationTrackEditor::_update_fps_compat_mode));\n \n \tnearest_fps_label = memnew(Label);\n+\tnearest_fps_label->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \tbottom_hf->add_child(nearest_fps_label);\n \n \tstep = memnew(EditorSpinSlider);\ndiff --git a/editor/connections_dialog.cpp b/editor/connections_dialog.cpp\nindex dca43411e10b..5081be0d2d94 100644\n--- a/editor/connections_dialog.cpp\n+++ b/editor/connections_dialog.cpp\n@@ -453,7 +453,13 @@ void ConnectDialog::_update_ok_enabled() {\n }\n \n void ConnectDialog::_update_warning_label() {\n-\tRef<Script> scr = source->get_node(dst_path)->get_script();\n+\tNode *dst = source->get_node(dst_path);\n+\tif (dst == nullptr) {\n+\t\twarning_label->set_visible(false);\n+\t\treturn;\n+\t}\n+\n+\tRef<Script> scr = dst->get_script();\n \tif (scr.is_null()) {\n \t\twarning_label->set_visible(false);\n \t\treturn;\n@@ -865,9 +871,8 @@ ConnectDialog::ConnectDialog() {\n \thbc_method->add_child(dst_method);\n \tregister_text_enter(dst_method);\n \n-\topen_method_tree = memnew(Button);\n+\topen_method_tree = memnew(Button(TTRC(\"Pick\")));\n \thbc_method->add_child(open_method_tree);\n-\topen_method_tree->set_text(\"Pick\");\n \topen_method_tree->connect(SceneStringName(pressed), callable_mp(this, &ConnectDialog::_open_method_popup));\n \n \tadvanced = memnew(CheckButton(TTR(\"Advanced\")));\ndiff --git a/editor/debugger/debug_adapter/debug_adapter_protocol.cpp b/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\nindex ba4c078d7ed5..00ae9dca7ebb 100644\n--- a/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\n+++ b/editor/debugger/debug_adapter/debug_adapter_protocol.cpp\n@@ -1032,6 +1032,7 @@ void DebugAdapterProtocol::on_debug_paused() {\n void DebugAdapterProtocol::on_debug_stopped() {\n \tnotify_exited();\n \tnotify_terminated();\n+\treset_ids();\n }\n \n void DebugAdapterProtocol::on_debug_output(const String &p_message, int p_type) {\ndiff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 58b02ed2b8a1..87a7433e8cb9 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -3440,6 +3440,8 @@ void EditorInspector::update_tree() {\n \t\t// Recreate the category vbox if it was reset.\n \t\tif (category_vbox == nullptr) {\n \t\t\tcategory_vbox = memnew(VBoxContainer);\n+\t\t\tint separation = get_theme_constant(SNAME(\"v_separation\"), SNAME(\"EditorInspector\"));\n+\t\t\tcategory_vbox->add_theme_constant_override(SNAME(\"separation\"), separation);\n \t\t\tcategory_vbox->hide();\n \t\t\tmain_vbox->add_child(category_vbox);\n \t\t}\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 6b725240f9e2..2261b14acbe3 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -1207,7 +1207,7 @@ void EditorNode::_sources_changed(bool p_exist) {\n \t\t}\n \n \t\t// Start preview thread now that it's safe.\n-\t\tif (!singleton->cmdline_export_mode) {\n+\t\tif (!singleton->cmdline_mode) {\n \t\t\tEditorResourcePreview::get_singleton()->start();\n \t\t}\n \n@@ -1807,7 +1807,7 @@ void EditorNode::_save_scene_with_preview(String p_file, int p_idx) {\n \tsave_scene_progress->step(TTR(\"Saving Scene\"), 4);\n \t_save_scene(p_file, p_idx);\n \n-\tif (!singleton->cmdline_export_mode) {\n+\tif (!singleton->cmdline_mode) {\n \t\tEditorResourcePreview::get_singleton()->check_for_invalidation(p_file);\n \t}\n \n@@ -1867,6 +1867,7 @@ int EditorNode::_save_external_resources(bool p_also_save_external_data) {\n \t\tres->set_edited(false);\n \t}\n \n+\tbool script_was_saved = false;\n \tfor (const String &E : edited_resources) {\n \t\tRef<Resource> res = ResourceCache::get_ref(E);\n \t\tif (res.is_null()) {\n@@ -1876,10 +1877,18 @@ int EditorNode::_save_external_resources(bool p_also_save_external_data) {\n \t\tif (ps.is_valid()) {\n \t\t\tcontinue; // Do not save PackedScenes, this will mess up the editor.\n \t\t}\n+\t\tif (!script_was_saved) {\n+\t\t\tRef<Script> scr = res;\n+\t\t\tscript_was_saved = scr.is_valid();\n+\t\t}\n \t\tResourceSaver::save(res, res->get_path(), flg);\n \t\tsaved++;\n \t}\n \n+\tif (script_was_saved) {\n+\t\tScriptEditor::get_singleton()->update_script_times();\n+\t}\n+\n \tif (p_also_save_external_data) {\n \t\tfor (int i = 0; i < editor_data.get_editor_plugin_count(); i++) {\n \t\t\tEditorPlugin *plugin = editor_data.get_editor_plugin(i);\n@@ -4944,7 +4953,7 @@ bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringNa\n void EditorNode::progress_add_task(const String &p_task, const String &p_label, int p_steps, bool p_can_cancel) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": begin: \" + p_label + \" steps: \" + itos(p_steps));\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->add_task(p_task, p_label, p_steps, p_can_cancel);\n@@ -4954,7 +4963,7 @@ void EditorNode::progress_add_task(const String &p_task, const String &p_label,\n bool EditorNode::progress_task_step(const String &p_task, const String &p_state, int p_step, bool p_force_refresh) {\n \tif (!singleton) {\n \t\treturn false;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(\"\\t\" + p_task + \": step \" + itos(p_step) + \": \" + p_state);\n \t\treturn false;\n \t} else if (singleton->progress_dialog) {\n@@ -4967,7 +4976,7 @@ bool EditorNode::progress_task_step(const String &p_task, const String &p_state,\n void EditorNode::progress_end_task(const String &p_task) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": end\");\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->end_task(p_task);\n@@ -5220,7 +5229,7 @@ Error EditorNode::export_preset(const String &p_preset, const String &p_path, bo\n \texport_defer.android_build_template = p_android_build_template;\n \texport_defer.patch = p_patch;\n \texport_defer.patches = p_patches;\n-\tcmdline_export_mode = true;\n+\tcmdline_mode = true;\n \treturn OK;\n }\n \n@@ -6848,7 +6857,10 @@ EditorNode::EditorNode() {\n \tDEV_ASSERT(!singleton);\n \tsingleton = this;\n \n-\tset_translation_domain(\"godot.editor\");\n+\t// Detecting headless mode, that means the editor is running in command line.\n+\tif (!DisplayServer::get_singleton()->window_can_draw()) {\n+\t\tcmdline_mode = true;\n+\t}\n \n \tResource::_get_local_scene_func = _resource_get_edited_scene;\n \ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex de3af997473a..63788e645f30 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -419,7 +419,7 @@ class EditorNode : public Node {\n \tbool script_distraction_free = false;\n \n \tbool changing_scene = false;\n-\tbool cmdline_export_mode = false;\n+\tbool cmdline_mode = false;\n \tbool convert_old = false;\n \tbool immediate_dialog_confirmed = false;\n \tbool opening_prev = false;\ndiff --git a/editor/export/project_export.cpp b/editor/export/project_export.cpp\nindex 5b93a1a17ec7..0982520acd58 100644\n--- a/editor/export/project_export.cpp\n+++ b/editor/export/project_export.cpp\n@@ -1746,11 +1746,13 @@ ProjectExportDialog::ProjectExportDialog() {\n \texport_error = memnew(Label);\n \tmain_vb->add_child(export_error);\n \texport_error->hide();\n+\texport_error->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_error->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"error_color\"), EditorStringName(Editor)));\n \n \texport_warning = memnew(Label);\n \tmain_vb->add_child(export_warning);\n \texport_warning->hide();\n+\texport_warning->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_warning->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"warning_color\"), EditorStringName(Editor)));\n \n \texport_templates_error = memnew(HBoxContainer);\n@@ -1759,6 +1761,7 @@ ProjectExportDialog::ProjectExportDialog() {\n \n \tLabel *export_error2 = memnew(Label);\n \texport_templates_error->add_child(export_error2);\n+\texport_error2->set_text_overrun_behavior(TextServer::OVERRUN_TRIM_WORD_ELLIPSIS);\n \texport_error2->add_theme_color_override(SceneStringName(font_color), EditorNode::get_singleton()->get_editor_theme()->get_color(SNAME(\"error_color\"), EditorStringName(Editor)));\n \texport_error2->set_text(String::utf8(\"\u2022  \") + TTR(\"Export templates for this platform are missing:\") + \" \");\n \ndiff --git a/editor/plugins/polygon_3d_editor_plugin.cpp b/editor/plugins/polygon_3d_editor_plugin.cpp\nindex 9d7567f2528a..f07ce22127c3 100644\n--- a/editor/plugins/polygon_3d_editor_plugin.cpp\n+++ b/editor/plugins/polygon_3d_editor_plugin.cpp\n@@ -560,6 +560,7 @@ Polygon3DEditor::Polygon3DEditor() {\n \tline_material->set_flag(StandardMaterial3D::FLAG_ALBEDO_FROM_VERTEX_COLOR, true);\n \tline_material->set_flag(StandardMaterial3D::FLAG_SRGB_VERTEX_COLOR, true);\n \tline_material->set_flag(StandardMaterial3D::FLAG_DISABLE_FOG, true);\n+\tline_material->set_flag(StandardMaterial3D::FLAG_DISABLE_DEPTH_TEST, true);\n \tline_material->set_albedo(Color(1, 1, 1));\n \n \thandle_material.instantiate();\n@@ -569,6 +570,7 @@ Polygon3DEditor::Polygon3DEditor() {\n \thandle_material->set_flag(StandardMaterial3D::FLAG_ALBEDO_FROM_VERTEX_COLOR, true);\n \thandle_material->set_flag(StandardMaterial3D::FLAG_SRGB_VERTEX_COLOR, true);\n \thandle_material->set_flag(StandardMaterial3D::FLAG_DISABLE_FOG, true);\n+\thandle_material->set_flag(StandardMaterial3D::FLAG_DISABLE_DEPTH_TEST, true);\n \tRef<Texture2D> handle = EditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"Editor3DHandle\"), EditorStringName(EditorIcons));\n \thandle_material->set_point_size(handle->get_width());\n \thandle_material->set_texture(StandardMaterial3D::TEXTURE_ALBEDO, handle);\ndiff --git a/editor/plugins/script_editor_plugin.cpp b/editor/plugins/script_editor_plugin.cpp\nindex af7812abe806..45b921fad613 100644\n--- a/editor/plugins/script_editor_plugin.cpp\n+++ b/editor/plugins/script_editor_plugin.cpp\n@@ -2817,6 +2817,15 @@ void ScriptEditor::save_all_scripts() {\n \t_update_script_names();\n }\n \n+void ScriptEditor::update_script_times() {\n+\tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n+\t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n+\t\tif (se) {\n+\t\t\tse->edited_file_data.last_modified_time = FileAccess::get_modified_time(se->edited_file_data.path);\n+\t\t}\n+\t}\n+}\n+\n void ScriptEditor::apply_scripts() const {\n \tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n \t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n@@ -4205,6 +4214,7 @@ ScriptEditor::ScriptEditor(WindowWrapper *p_wrapper) {\n \toverview_vbox->add_child(buttons_hbox);\n \n \tfilename = memnew(Label);\n+\tfilename->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \tfilename->set_clip_text(true);\n \tfilename->set_h_size_flags(SIZE_EXPAND_FILL);\n \tfilename->set_vertical_alignment(VERTICAL_ALIGNMENT_CENTER);\ndiff --git a/editor/plugins/script_editor_plugin.h b/editor/plugins/script_editor_plugin.h\nindex 02e0529a7cf6..30198f1cb1c6 100644\n--- a/editor/plugins/script_editor_plugin.h\n+++ b/editor/plugins/script_editor_plugin.h\n@@ -569,6 +569,7 @@ class ScriptEditor : public PanelContainer {\n \tPackedStringArray get_unsaved_scripts() const;\n \tvoid save_current_script();\n \tvoid save_all_scripts();\n+\tvoid update_script_times();\n \n \tvoid set_window_layout(Ref<ConfigFile> p_layout);\n \tvoid get_window_layout(Ref<ConfigFile> p_layout);\ndiff --git a/editor/plugins/visual_shader_editor_plugin.cpp b/editor/plugins/visual_shader_editor_plugin.cpp\nindex b8af4603e80f..516ef516154c 100644\n--- a/editor/plugins/visual_shader_editor_plugin.cpp\n+++ b/editor/plugins/visual_shader_editor_plugin.cpp\n@@ -7623,12 +7623,15 @@ class VisualShaderNodePluginInputEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_input_select_item\"), input, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_input_select_item\"), input, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeInput> &p_input) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tinput = p_input;\n+\n \t\tRef<Texture2D> type_icon[] = {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"float\"), EditorStringName(EditorIcons)),\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"int\"), EditorStringName(EditorIcons)),\n@@ -7641,13 +7644,16 @@ class VisualShaderNodePluginInputEditor : public OptionButton {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"ImageTexture\"), EditorStringName(EditorIcons)),\n \t\t};\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n+\n \t\tint to_select = -1;\n \t\tfor (int i = 0; i < input->get_input_index_count(); i++) {\n \t\t\tif (input->get_input_name() == input->get_input_index_name(i)) {\n \t\t\t\tto_select = i + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[input->get_input_index_type(i)], input->get_input_index_name(i));\n+\t\t\tset_item_metadata(-1, input->get_input_index_name(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -7672,10 +7678,12 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_varying_select_item\"), varying, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_varying_select_item\"), varying, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeVarying> &p_varying, VisualShader::Type p_type) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tvarying = p_varying;\n \n@@ -7692,7 +7700,8 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \n \t\tbool is_getter = Ref<VisualShaderNodeVaryingGetter>(p_varying.ptr()).is_valid();\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n \n \t\tint to_select = -1;\n \t\tfor (int i = 0, j = 0; i < varying->get_varyings_count(); i++) {\n@@ -7726,6 +7735,7 @@ class VisualShaderNodePluginVaryingEditor : public OptionButton {\n \t\t\t\tto_select = i - j + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[varying->get_varying_type_by_index(i)], varying->get_varying_name_by_index(i));\n+\t\t\tset_item_metadata(-1, varying->get_varying_name_by_index(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -7752,10 +7762,12 @@ class VisualShaderNodePluginParameterRefEditor : public OptionButton {\n \t}\n \n \tvoid _item_selected(int p_item) {\n-\t\teditor->call_deferred(SNAME(\"_parameter_ref_select_item\"), parameter_ref, get_item_text(p_item));\n+\t\teditor->call_deferred(SNAME(\"_parameter_ref_select_item\"), parameter_ref, get_item_metadata(p_item));\n \t}\n \n \tvoid setup(VisualShaderEditor *p_editor, const Ref<VisualShaderNodeParameterRef> &p_parameter_ref) {\n+\t\tset_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n+\n \t\teditor = p_editor;\n \t\tparameter_ref = p_parameter_ref;\n \n@@ -7772,13 +7784,16 @@ class VisualShaderNodePluginParameterRefEditor : public OptionButton {\n \t\t\tEditorNode::get_singleton()->get_editor_theme()->get_icon(SNAME(\"ImageTexture\"), EditorStringName(EditorIcons)),\n \t\t};\n \n-\t\tadd_item(\"[None]\");\n+\t\tadd_item(TTR(\"[None]\"));\n+\t\tset_item_metadata(-1, \"[None]\");\n+\n \t\tint to_select = -1;\n \t\tfor (int i = 0; i < p_parameter_ref->get_parameters_count(); i++) {\n \t\t\tif (p_parameter_ref->get_parameter_name() == p_parameter_ref->get_parameter_name_by_index(i)) {\n \t\t\t\tto_select = i + 1;\n \t\t\t}\n \t\t\tadd_icon_item(type_icon[p_parameter_ref->get_parameter_type_by_index(i)], p_parameter_ref->get_parameter_name_by_index(i));\n+\t\t\tset_item_metadata(-1, p_parameter_ref->get_parameter_name_by_index(i));\n \t\t}\n \n \t\tif (to_select >= 0) {\n@@ -8126,6 +8141,7 @@ void EditorPropertyVisualShaderMode::set_option_button_clip(bool p_enable) {\n \n EditorPropertyVisualShaderMode::EditorPropertyVisualShaderMode() {\n \toptions = memnew(OptionButton);\n+\toptions->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \toptions->set_clip_text(true);\n \tadd_child(options);\n \tadd_focusable(options);\ndiff --git a/editor/project_manager.cpp b/editor/project_manager.cpp\nindex c3bd3acf775f..19bcfe8bc516 100644\n--- a/editor/project_manager.cpp\n+++ b/editor/project_manager.cpp\n@@ -1162,8 +1162,6 @@ void ProjectManager::_titlebar_resized() {\n ProjectManager::ProjectManager(bool p_custom_res) {\n \tsingleton = this;\n \n-\tset_translation_domain(\"godot.editor\");\n-\n \t// Turn off some servers we aren't going to be using in the Project Manager.\n \tNavigationServer3D::get_singleton()->set_active(false);\n \tPhysicsServer3D::get_singleton()->set_active(false);\ndiff --git a/editor/project_manager/project_list.cpp b/editor/project_manager/project_list.cpp\nindex b96e40b0b73e..7eeb2f8460a2 100644\n--- a/editor/project_manager/project_list.cpp\n+++ b/editor/project_manager/project_list.cpp\n@@ -68,10 +68,13 @@ void ProjectListItemControl::_notification(int p_what) {\n \t\t\tproject_unsupported_features->set_texture(get_editor_theme_icon(SNAME(\"NodeWarning\")));\n \n \t\t\tfavorite_button->set_texture_normal(get_editor_theme_icon(SNAME(\"Favorites\")));\n+\n \t\t\tif (project_is_missing) {\n \t\t\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"FileBroken\")));\n+#if !defined(ANDROID_ENABLED) && !defined(WEB_ENABLED)\n \t\t\t} else {\n \t\t\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n+#endif\n \t\t\t}\n \t\t} break;\n \n@@ -190,9 +193,6 @@ void ProjectListItemControl::set_is_favorite(bool p_favorite) {\n }\n \n void ProjectListItemControl::set_is_missing(bool p_missing) {\n-\tif (project_is_missing == p_missing) {\n-\t\treturn;\n-\t}\n \tproject_is_missing = p_missing;\n \n \tif (project_is_missing) {\n@@ -201,10 +201,8 @@ void ProjectListItemControl::set_is_missing(bool p_missing) {\n \t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"FileBroken\")));\n \t\texplore_button->set_tooltip_text(TTR(\"Error: Project is missing on the filesystem.\"));\n \t} else {\n-\t\tproject_icon->set_modulate(Color(1, 1, 1, 1.0));\n-\n-\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n #if !defined(ANDROID_ENABLED) && !defined(WEB_ENABLED)\n+\t\texplore_button->set_button_icon(get_editor_theme_icon(SNAME(\"Load\")));\n \t\texplore_button->set_tooltip_text(TTR(\"Show in File Manager\"));\n #else\n \t\t// Opening the system file manager is not supported on the Android and web editors.\ndiff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex 267d35f99458..1390d8256e08 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -4268,7 +4268,7 @@ List<Node *> SceneTreeDock::paste_nodes(bool p_paste_as_sibling) {\n \t\t\t// and added to the node_clipboard_edited_scene_owned list.\n \t\t\tif (d != dup && E2.key->get_owner() == nullptr) {\n \t\t\t\tif (node_clipboard_edited_scene_owned.find(const_cast<Node *>(E2.key))) {\n-\t\t\t\t\tur->add_do_method(d, \"set_owner\", edited_scene);\n+\t\t\t\t\tur->add_do_method(d, \"set_owner\", owner);\n \t\t\t\t}\n \t\t\t}\n \t\t}\ndiff --git a/main/main.cpp b/main/main.cpp\nindex 10064b350376..9a1ab8771245 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -979,7 +979,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \tString project_path = \".\";\n \tbool upwards = false;\n \tString debug_uri = \"\";\n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \tbool test_rd_creation = false;\n \tbool test_rd_support = false;\n #endif\n@@ -1671,7 +1671,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \t\t} else if (arg == \"--debug-stringnames\") {\n \t\t\tStringName::set_debug_stringnames(true);\n #endif\n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \t\t} else if (arg == \"--test-rd-support\") {\n \t\t\ttest_rd_support = true;\n \t\t} else if (arg == \"--test-rd-creation\") {\n@@ -1880,12 +1880,12 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n #endif\n \t}\n \n-#if defined(TOOLS_ENABLED) && defined(WINDOWS_ENABLED)\n+#if defined(TOOLS_ENABLED) && (defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED))\n \tif (test_rd_support) {\n \t\t// Test Rendering Device creation and exit.\n \n \t\tOS::get_singleton()->set_crash_handler_silent();\n-\t\tif (OS::get_singleton()->_test_create_rendering_device()) {\n+\t\tif (OS::get_singleton()->_test_create_rendering_device(display_driver)) {\n \t\t\texit_err = ERR_HELP;\n \t\t} else {\n \t\t\texit_err = ERR_UNAVAILABLE;\n@@ -1895,7 +1895,7 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \t\t// Test OpenGL context and Rendering Device simultaneous creation and exit.\n \n \t\tOS::get_singleton()->set_crash_handler_silent();\n-\t\tif (OS::get_singleton()->_test_create_rendering_device_and_gl()) {\n+\t\tif (OS::get_singleton()->_test_create_rendering_device_and_gl(display_driver)) {\n \t\t\texit_err = ERR_HELP;\n \t\t} else {\n \t\t\texit_err = ERR_UNAVAILABLE;\n@@ -4115,6 +4115,7 @@ int Main::start() {\n \t\tif (editor) {\n \t\t\tOS::get_singleton()->benchmark_begin_measure(\"Startup\", \"Editor\");\n \n+\t\t\tsml->get_root()->set_translation_domain(\"godot.editor\");\n \t\t\tif (editor_pseudolocalization) {\n \t\t\t\ttranslation_server->get_editor_domain()->set_pseudolocalization_enabled(true);\n \t\t\t}\n@@ -4312,6 +4313,7 @@ int Main::start() {\n \t\t\tOS::get_singleton()->benchmark_begin_measure(\"Startup\", \"Project Manager\");\n \t\t\tEngine::get_singleton()->set_editor_hint(true);\n \n+\t\t\tsml->get_root()->set_translation_domain(\"godot.editor\");\n \t\t\tif (editor_pseudolocalization) {\n \t\t\t\ttranslation_server->get_editor_domain()->set_pseudolocalization_enabled(true);\n \t\t\t}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.cpp b/modules/jolt_physics/misc/jolt_math_funcs.cpp\nnew file mode 100644\nindex 000000000000..b0ef5f45747d\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.cpp\n@@ -0,0 +1,70 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.cpp                                                   */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+/*\n+Adapted to Godot from the Jolt Physics library.\n+*/\n+\n+/*\n+Copyright 2021 Jorrit Rouwe\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in\n+the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\n+the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR\n+A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n+ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n+*/\n+\n+#include \"jolt_math_funcs.h\"\n+\n+void JoltMath::decompose(Basis &p_basis, Vector3 &r_scale) {\n+\tVector3 x = p_basis.get_column(Vector3::AXIS_X);\n+\tVector3 y = p_basis.get_column(Vector3::AXIS_Y);\n+\tVector3 z = p_basis.get_column(Vector3::AXIS_Z);\n+\n+\tconst real_t x_dot_x = x.dot(x);\n+\ty -= x * (y.dot(x) / x_dot_x);\n+\tz -= x * (z.dot(x) / x_dot_x);\n+\tconst real_t y_dot_y = y.dot(y);\n+\tz -= y * (z.dot(y) / y_dot_y);\n+\tconst real_t z_dot_z = z.dot(z);\n+\n+\tconst real_t det = x.cross(y).dot(z);\n+\n+\tr_scale = SIGN(det) * Vector3(Math::sqrt(x_dot_x), Math::sqrt(y_dot_y), Math::sqrt(z_dot_z));\n+\n+\tp_basis.set_column(Vector3::AXIS_X, x / r_scale.x);\n+\tp_basis.set_column(Vector3::AXIS_Y, y / r_scale.y);\n+\tp_basis.set_column(Vector3::AXIS_Z, z / r_scale.z);\n+}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.h b/modules/jolt_physics/misc/jolt_math_funcs.h\nnew file mode 100644\nindex 000000000000..ba2d290ac77c\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.h\n@@ -0,0 +1,59 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.h                                                     */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef JOLT_MATH_FUNCS_H\n+#define JOLT_MATH_FUNCS_H\n+\n+#include \"core/math/transform_3d.h\"\n+\n+class JoltMath {\n+public:\n+\t// Note that `p_basis` is mutated to be right-handed orthonormal.\n+\tstatic void decompose(Basis &p_basis, Vector3 &r_scale);\n+\n+\t// Note that `p_transform` is mutated to be right-handed orthonormal.\n+\tstatic _FORCE_INLINE_ void decompose(Transform3D &p_transform, Vector3 &r_scale) {\n+\t\tdecompose(p_transform.basis, r_scale);\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Basis &p_basis, Basis &r_new_basis, Vector3 &r_scale) {\n+\t\tBasis new_basis = p_basis;\n+\t\tdecompose(new_basis, r_scale);\n+\t\tr_new_basis = new_basis;\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Transform3D &p_transform, Transform3D &r_new_transform, Vector3 &r_scale) {\n+\t\tTransform3D new_transform;\n+\t\tdecompose(new_transform, r_scale);\n+\t\tr_new_transform = new_transform;\n+\t}\n+};\n+\n+#endif // JOLT_MATH_FUNCS_H\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex b0a9ffd62225..0a2693ddb634 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -31,6 +31,7 @@\n #include \"jolt_area_3d.h\"\n \n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -370,7 +371,8 @@ void JoltArea3D::set_default_area(bool p_value) {\n void JoltArea3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to area '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -378,8 +380,6 @@ void JoltArea3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex ac2b37470ef1..5bc3aee1bce7 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../joints/jolt_joint_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -543,7 +544,8 @@ JoltBody3D::~JoltBody3D() {\n void JoltBody3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to physics body '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -551,8 +553,6 @@ void JoltBody3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex bfe77e008d59..f32ddad0d469 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_shaped_object_3d.h\"\n \n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_custom_double_sided_shape.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n@@ -347,7 +348,10 @@ void JoltShapedObject3D::commit_shapes(bool p_optimize_compound) {\n void JoltShapedObject3D::add_shape(JoltShape3D *p_shape, Transform3D p_transform, bool p_disabled) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed when adding shape at index %d to physics body '%s'.\", shapes.size(), to_string()));\n \n-\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform.orthonormalized(), p_transform.basis.get_scale(), p_disabled));\n+\tVector3 shape_scale;\n+\tJoltMath::decompose(p_transform, shape_scale);\n+\n+\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform, shape_scale, p_disabled));\n \n \t_shapes_changed();\n }\n@@ -430,8 +434,8 @@ void JoltShapedObject3D::set_shape_transform(int p_index, Transform3D p_transfor\n \tERR_FAIL_INDEX(p_index, (int)shapes.size());\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, \"Failed to correctly set transform for shape at index %d in body '%s'.\");\n \n-\tVector3 new_scale = p_transform.basis.get_scale();\n-\tp_transform.basis.orthonormalize();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \tJoltShapeInstance3D &shape = shapes[p_index];\n \ndiff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex 3852e42d51f2..d7a4afec57ba 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../objects/jolt_area_3d.h\"\n #include \"../objects/jolt_body_3d.h\"\n@@ -288,11 +289,10 @@ bool JoltPhysicsDirectSpaceState3D::_body_motion_cast(const JoltBody3D &p_body,\n \t\tconst Transform3D transform_com_local = transform_local.translated_local(com_scaled);\n \t\tTransform3D transform_com = body_transform * transform_com_local;\n \n-\t\tVector3 scale = transform_com.basis.get_scale();\n+\t\tVector3 scale;\n+\t\tJoltMath::decompose(transform_com, scale);\n \t\tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"body_test_motion was passed an invalid transform along with body '%s'. This results in invalid scaling for shape at index %d.\");\n \n-\t\ttransform_com.basis.orthonormalize();\n-\n \t\treal_t shape_safe_fraction = 1.0;\n \t\treal_t shape_unsafe_fraction = 1.0;\n \n@@ -590,11 +590,10 @@ int JoltPhysicsDirectSpaceState3D::intersect_shape(const ShapeParameters &p_para\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"intersect_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"intersect_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -647,11 +646,10 @@ bool JoltPhysicsDirectSpaceState3D::cast_motion(const ShapeParameters &p_paramet\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tTransform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -684,11 +682,10 @@ bool JoltPhysicsDirectSpaceState3D::collide_shape(const ShapeParameters &p_param\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"collide_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"collide_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -754,11 +751,10 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -890,8 +886,8 @@ bool JoltPhysicsDirectSpaceState3D::body_test_motion(const JoltBody3D &p_body, c\n \tTransform3D transform = p_parameters.from;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, vformat(\"body_test_motion (maybe from move_and_slide?) was passed an invalid transform along with body '%s'.\", p_body.to_string()));\n \n-\tVector3 scale = transform.basis.get_scale();\n-\ttransform.basis.orthonormalize();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \n \tspace->try_optimize();\n \ndiff --git a/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs b/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\nindex 7a07e0a97539..22420e2b63ca 100644\n--- a/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\n+++ b/modules/mono/editor/GodotTools/GodotTools.ProjectEditor/ProjectUtils.cs\n@@ -191,6 +191,13 @@ private static void EnsureTargetFrameworkMatchesMinimumRequirement(MSBuildProjec\n                 // Otherwise, it can be removed.\n                 if (mainTfmVersion > minTfmVersion)\n                 {\n+                    var propertyTfmVersion = NuGetFramework.Parse(property.Value).Version;\n+                    if (propertyTfmVersion == minTfmVersion)\n+                    {\n+                        // The 'TargetFramework' property already matches the minimum version.\n+                        continue;\n+                    }\n+\n                     property.Value = minTfmValue;\n                 }\n                 else\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\nindex dda776fee5f5..cb180f9a8b3f 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/InteropStructs.cs\n@@ -455,6 +455,12 @@ public readonly IntPtr Object\n             get => _data._m_obj_data.obj;\n         }\n \n+        public readonly ulong ObjectId\n+        {\n+            [MethodImpl(MethodImplOptions.AggressiveInlining)]\n+            get => _data._m_obj_data.id;\n+        }\n+\n         public void Dispose()\n         {\n             switch (Type)\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\nindex a48e60a30f60..9e5df0fa5c31 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/VariantUtils.cs\n@@ -485,7 +485,14 @@ public static Rid ConvertToRid(in godot_variant p_var)\n                 NativeFuncs.godotsharp_variant_as_rid(p_var);\n \n         public static IntPtr ConvertToGodotObjectPtr(in godot_variant p_var)\n-            => p_var.Type == Variant.Type.Object ? p_var.Object : IntPtr.Zero;\n+        {\n+            if (p_var.Type != Variant.Type.Object || p_var.ObjectId == 0)\n+            {\n+                return IntPtr.Zero;\n+            }\n+\n+            return NativeFuncs.godotsharp_instance_from_id(p_var.ObjectId);\n+        }\n \n         [MethodImpl(MethodImplOptions.AggressiveInlining)]\n         public static GodotObject ConvertToGodotObject(in godot_variant p_var)\ndiff --git a/modules/multiplayer/editor/editor_network_profiler.cpp b/modules/multiplayer/editor/editor_network_profiler.cpp\nindex 1f9444ed72b7..5a2611added9 100644\n--- a/modules/multiplayer/editor/editor_network_profiler.cpp\n+++ b/modules/multiplayer/editor/editor_network_profiler.cpp\n@@ -35,6 +35,7 @@\n #include \"editor/gui/editor_run_bar.h\"\n #include \"editor/themes/editor_scale.h\"\n #include \"scene/gui/check_box.h\"\n+#include \"scene/gui/flow_container.h\"\n \n void EditorNetworkProfiler::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"enable_profiling\", PropertyInfo(Variant::BOOL, \"enable\")));\n@@ -297,30 +298,37 @@ bool EditorNetworkProfiler::is_profiling() {\n }\n \n EditorNetworkProfiler::EditorNetworkProfiler() {\n-\tHBoxContainer *hb = memnew(HBoxContainer);\n-\thb->add_theme_constant_override(\"separation\", 8 * EDSCALE);\n-\tadd_child(hb);\n+\tFlowContainer *container = memnew(FlowContainer);\n+\tcontainer->add_theme_constant_override(SNAME(\"h_separation\"), 8 * EDSCALE);\n+\tcontainer->add_theme_constant_override(SNAME(\"v_separation\"), 2 * EDSCALE);\n+\tadd_child(container);\n \n \tactivate = memnew(Button);\n \tactivate->set_toggle_mode(true);\n \tactivate->set_text(TTR(\"Start\"));\n \tactivate->set_disabled(true);\n \tactivate->connect(SceneStringName(pressed), callable_mp(this, &EditorNetworkProfiler::_activate_pressed));\n-\thb->add_child(activate);\n+\tcontainer->add_child(activate);\n \n \tclear_button = memnew(Button);\n \tclear_button->set_text(TTR(\"Clear\"));\n \tclear_button->set_disabled(true);\n \tclear_button->connect(SceneStringName(pressed), callable_mp(this, &EditorNetworkProfiler::_clear_pressed));\n-\thb->add_child(clear_button);\n+\tcontainer->add_child(clear_button);\n \n \tCheckBox *autostart_checkbox = memnew(CheckBox);\n \tautostart_checkbox->set_text(TTR(\"Autostart\"));\n \tautostart_checkbox->set_pressed(EditorSettings::get_singleton()->get_project_metadata(\"debug_options\", \"autostart_network_profiler\", false));\n \tautostart_checkbox->connect(SceneStringName(toggled), callable_mp(this, &EditorNetworkProfiler::_autostart_toggled));\n-\thb->add_child(autostart_checkbox);\n+\tcontainer->add_child(autostart_checkbox);\n+\n+\tControl *c = memnew(Control);\n+\tc->set_h_size_flags(SIZE_EXPAND_FILL);\n+\tcontainer->add_child(c);\n \n-\thb->add_spacer();\n+\tHBoxContainer *hb = memnew(HBoxContainer);\n+\thb->add_theme_constant_override(SNAME(\"separation\"), 8 * EDSCALE);\n+\tcontainer->add_child(hb);\n \n \tLabel *lb = memnew(Label);\n \t// TRANSLATORS: This is the label for the network profiler's incoming bandwidth.\n@@ -359,7 +367,7 @@ EditorNetworkProfiler::EditorNetworkProfiler() {\n \n \t// RPC\n \tcounters_display = memnew(Tree);\n-\tcounters_display->set_custom_minimum_size(Size2(320, 0) * EDSCALE);\n+\tcounters_display->set_custom_minimum_size(Size2(280, 0) * EDSCALE);\n \tcounters_display->set_v_size_flags(SIZE_EXPAND_FILL);\n \tcounters_display->set_h_size_flags(SIZE_EXPAND_FILL);\n \tcounters_display->set_hide_folding(true);\n@@ -382,7 +390,7 @@ EditorNetworkProfiler::EditorNetworkProfiler() {\n \n \t// Replication\n \treplication_display = memnew(Tree);\n-\treplication_display->set_custom_minimum_size(Size2(320, 0) * EDSCALE);\n+\treplication_display->set_custom_minimum_size(Size2(280, 0) * EDSCALE);\n \treplication_display->set_v_size_flags(SIZE_EXPAND_FILL);\n \treplication_display->set_h_size_flags(SIZE_EXPAND_FILL);\n \treplication_display->set_hide_folding(true);\ndiff --git a/modules/openxr/extensions/platform/openxr_opengl_extension.cpp b/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\nindex c4a05220115b..08b3afb0192e 100644\n--- a/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\n+++ b/modules/openxr/extensions/platform/openxr_opengl_extension.cpp\n@@ -141,7 +141,12 @@ XrGraphicsBindingEGLMNDX OpenXROpenGLExtension::graphics_binding_egl;\n #endif\n \n void *OpenXROpenGLExtension::set_session_create_and_get_next_pointer(void *p_next_pointer) {\n-\tXrVersion desired_version = XR_MAKE_VERSION(3, 3, 0);\n+\tGLint gl_version_major = 0;\n+\tGLint gl_version_minor = 0;\n+\tglGetIntegerv(GL_MAJOR_VERSION, &gl_version_major);\n+\tglGetIntegerv(GL_MINOR_VERSION, &gl_version_minor);\n+\n+\tXrVersion desired_version = XR_MAKE_VERSION(gl_version_major, gl_version_minor, 0);\n \n \tif (!check_graphics_api_support(desired_version)) {\n \t\tprint_line(\"OpenXR: Trying to initialize with OpenGL anyway...\");\ndiff --git a/modules/openxr/register_types.cpp b/modules/openxr/register_types.cpp\nindex 69c119d069e3..785de3d6210b 100644\n--- a/modules/openxr/register_types.cpp\n+++ b/modules/openxr/register_types.cpp\n@@ -225,10 +225,16 @@ void initialize_openxr_module(ModuleInitializationLevel p_level) {\n \t\t}\n \n #ifdef TOOLS_ENABLED\n+\t\t// Register as \"editor\", not \"core\".\n+\t\tClassDB::APIType prev_api = ClassDB::get_current_api();\n+\t\tClassDB::set_current_api(ClassDB::API_EDITOR);\n+\n \t\tGDREGISTER_ABSTRACT_CLASS(OpenXRInteractionProfileEditorBase);\n \t\tGDREGISTER_CLASS(OpenXRInteractionProfileEditor);\n \t\tGDREGISTER_CLASS(OpenXRBindingModifierEditor);\n \n+\t\tClassDB::set_current_api(prev_api);\n+\n \t\tEditorNode::add_init_callback(_editor_init);\n #endif\n \t}\ndiff --git a/modules/text_server_adv/text_server_adv.cpp b/modules/text_server_adv/text_server_adv.cpp\nindex 52a61cd92446..71bded1ff1d5 100644\n--- a/modules/text_server_adv/text_server_adv.cpp\n+++ b/modules/text_server_adv/text_server_adv.cpp\n@@ -1318,11 +1318,12 @@ _FORCE_INLINE_ bool TextServerAdvanced::_ensure_glyph(FontAdvanced *p_font_data,\n \t\t\t} break;\n \t\t}\n \n+\t\tFT_GlyphSlot slot = fd->face->glyph;\n+\t\tbool from_svg = (slot->format == FT_GLYPH_FORMAT_SVG); // Need to check before FT_Render_Glyph as it will change format to bitmap.\n \t\tif (!outline) {\n \t\t\tif (!p_font_data->msdf) {\n-\t\t\t\terror = FT_Render_Glyph(fd->face->glyph, aa_mode);\n+\t\t\t\terror = FT_Render_Glyph(slot, aa_mode);\n \t\t\t}\n-\t\t\tFT_GlyphSlot slot = fd->face->glyph;\n \t\t\tif (!error) {\n \t\t\t\tif (p_font_data->msdf) {\n #ifdef MODULE_MSDFGEN_ENABLED\n@@ -1363,6 +1364,7 @@ _FORCE_INLINE_ bool TextServerAdvanced::_ensure_glyph(FontAdvanced *p_font_data,\n \t\tcleanup_stroker:\n \t\t\tFT_Stroker_Done(stroker);\n \t\t}\n+\t\tgl.from_svg = from_svg;\n \t\tE = fd->glyph_map.insert(p_glyph, gl);\n \t\tr_glyph = E->value;\n \t\treturn gl.found;\n@@ -3312,6 +3314,10 @@ RID TextServerAdvanced::_font_get_glyph_texture_rid(const RID &p_font_rid, const\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -3360,6 +3366,10 @@ Size2 TextServerAdvanced::_font_get_glyph_texture_size(const RID &p_font_rid, co\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -3798,7 +3808,7 @@ void TextServerAdvanced::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\tif (fgl.texture_idx != -1) {\n \t\t\tColor modulate = p_color;\n #ifdef MODULE_FREETYPE_ENABLED\n-\t\t\tif (ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n+\t\t\tif (!fgl.from_svg && ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n \t\t\t\tmodulate.r = modulate.g = modulate.b = 1.0;\n \t\t\t}\n #endif\n@@ -3806,6 +3816,10 @@ void TextServerAdvanced::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t\t}\n \t\t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\t\timg->generate_mipmaps();\ndiff --git a/modules/text_server_adv/text_server_adv.h b/modules/text_server_adv/text_server_adv.h\nindex 6561667e80e6..981cb277f70d 100644\n--- a/modules/text_server_adv/text_server_adv.h\n+++ b/modules/text_server_adv/text_server_adv.h\n@@ -272,6 +272,7 @@ class TextServerAdvanced : public TextServerExtension {\n \t\tRect2 rect;\n \t\tRect2 uv_rect;\n \t\tVector2 advance;\n+\t\tbool from_svg = false;\n \t};\n \n \tstruct FontForSizeAdvanced {\ndiff --git a/modules/text_server_fb/text_server_fb.cpp b/modules/text_server_fb/text_server_fb.cpp\nindex 8ca81368436f..c70f5e00d113 100644\n--- a/modules/text_server_fb/text_server_fb.cpp\n+++ b/modules/text_server_fb/text_server_fb.cpp\n@@ -741,11 +741,12 @@ _FORCE_INLINE_ bool TextServerFallback::_ensure_glyph(FontFallback *p_font_data,\n \t\t\t} break;\n \t\t}\n \n+\t\tFT_GlyphSlot slot = fd->face->glyph;\n+\t\tbool from_svg = (slot->format == FT_GLYPH_FORMAT_SVG); // Need to check before FT_Render_Glyph as it will change format to bitmap.\n \t\tif (!outline) {\n \t\t\tif (!p_font_data->msdf) {\n-\t\t\t\terror = FT_Render_Glyph(fd->face->glyph, aa_mode);\n+\t\t\t\terror = FT_Render_Glyph(slot, aa_mode);\n \t\t\t}\n-\t\t\tFT_GlyphSlot slot = fd->face->glyph;\n \t\t\tif (!error) {\n \t\t\t\tif (p_font_data->msdf) {\n #ifdef MODULE_MSDFGEN_ENABLED\n@@ -786,6 +787,7 @@ _FORCE_INLINE_ bool TextServerFallback::_ensure_glyph(FontFallback *p_font_data,\n \t\tcleanup_stroker:\n \t\t\tFT_Stroker_Done(stroker);\n \t\t}\n+\t\tgl.from_svg = from_svg;\n \t\tE = fd->glyph_map.insert(p_glyph, gl);\n \t\tr_glyph = E->value;\n \t\treturn gl.found;\n@@ -2290,6 +2292,10 @@ RID TextServerFallback::_font_get_glyph_texture_rid(const RID &p_font_rid, const\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -2338,6 +2344,10 @@ Size2 TextServerFallback::_font_get_glyph_texture_size(const RID &p_font_rid, co\n \t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t}\n \t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\timg->generate_mipmaps();\n@@ -2729,7 +2739,7 @@ void TextServerFallback::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\tif (fgl.texture_idx != -1) {\n \t\t\tColor modulate = p_color;\n #ifdef MODULE_FREETYPE_ENABLED\n-\t\t\tif (ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n+\t\t\tif (!fgl.from_svg && ffsd->face && ffsd->textures[fgl.texture_idx].image.is_valid() && (ffsd->textures[fgl.texture_idx].image->get_format() == Image::FORMAT_RGBA8) && !lcd_aa && !fd->msdf) {\n \t\t\t\tmodulate.r = modulate.g = modulate.b = 1.0;\n \t\t\t}\n #endif\n@@ -2737,6 +2747,10 @@ void TextServerFallback::_font_draw_glyph(const RID &p_font_rid, const RID &p_ca\n \t\t\t\tif (ffsd->textures[fgl.texture_idx].dirty) {\n \t\t\t\t\tShelfPackTexture &tex = ffsd->textures.write[fgl.texture_idx];\n \t\t\t\t\tRef<Image> img = tex.image;\n+\t\t\t\t\tif (fgl.from_svg) {\n+\t\t\t\t\t\t// Same as the \"fix alpha border\" process option when importing SVGs\n+\t\t\t\t\t\timg->fix_alpha_edges();\n+\t\t\t\t\t}\n \t\t\t\t\tif (fd->mipmaps && !img->has_mipmaps()) {\n \t\t\t\t\t\timg = tex.image->duplicate();\n \t\t\t\t\t\timg->generate_mipmaps();\ndiff --git a/modules/text_server_fb/text_server_fb.h b/modules/text_server_fb/text_server_fb.h\nindex b66f7189bee0..3338a8a62b1b 100644\n--- a/modules/text_server_fb/text_server_fb.h\n+++ b/modules/text_server_fb/text_server_fb.h\n@@ -219,6 +219,7 @@ class TextServerFallback : public TextServerExtension {\n \t\tRect2 rect;\n \t\tRect2 uv_rect;\n \t\tVector2 advance;\n+\t\tbool from_svg = false;\n \t};\n \n \tstruct FontForSizeFallback {\ndiff --git a/platform/android/README.md b/platform/android/README.md\nindex 01eb9c03a664..4a08bb524180 100644\n--- a/platform/android/README.md\n+++ b/platform/android/README.md\n@@ -12,7 +12,7 @@ using [Gradle](https://gradle.org/) as a build system.\n \n ## Artwork license\n \n-[`logo.png`](logo.png) and [`run_icon.png`](run_icon.png) are licensed under\n+[`logo.svg`](export/logo.svg) and [`run_icon.svg`](export/run_icon.svg) are licensed under\n [Creative Commons Attribution 3.0 Unported](https://developer.android.com/distribute/marketing-tools/brand-guidelines#android_robot)\n per the Android logo usage guidelines:\n \ndiff --git a/platform/android/android_input_handler.cpp b/platform/android/android_input_handler.cpp\nindex 9a5af7a349dd..859f4c3c1b3e 100644\n--- a/platform/android/android_input_handler.cpp\n+++ b/platform/android/android_input_handler.cpp\n@@ -337,7 +337,7 @@ void AndroidInputHandler::process_mouse_event(int p_event_action, int p_event_an\n \t\t} break;\n \n \t\tcase AMOTION_EVENT_ACTION_MOVE: {\n-\t\t\tif (!mouse_event_info.valid) {\n+\t\t\tif (!p_source_mouse_relative && !mouse_event_info.valid) {\n \t\t\t\treturn;\n \t\t\t}\n \ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 571cfd9819c0..cac7c3f48d4e 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -187,7 +187,7 @@ def configure(env: \"SConsEnvironment\"):\n     has_swappy = detect_swappy()\n     if not has_swappy:\n         print_warning(\n-            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/darksylinc/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n+            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/godotengine/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n             + \" thirdparty/swappy-frame-pacing/arm64-v8a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/armeabi-v7a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/x86/libswappy_static.a\\n\"\ndiff --git a/platform/android/java/app/AndroidManifest.xml b/platform/android/java/app/AndroidManifest.xml\nindex 60ce75fd16e2..1d59d15d560f 100644\n--- a/platform/android/java/app/AndroidManifest.xml\n+++ b/platform/android/java/app/AndroidManifest.xml\n@@ -46,7 +46,7 @@\n             android:excludeFromRecents=\"false\"\n             android:exported=\"true\"\n             android:screenOrientation=\"landscape\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:resizeableActivity=\"false\"\n             tools:ignore=\"UnusedAttribute\" >\n \ndiff --git a/platform/android/java/editor/src/main/AndroidManifest.xml b/platform/android/java/editor/src/main/AndroidManifest.xml\nindex a1971554bf7d..b136e348b2c7 100644\n--- a/platform/android/java/editor/src/main/AndroidManifest.xml\n+++ b/platform/android/java/editor/src/main/AndroidManifest.xml\n@@ -41,7 +41,7 @@\n \n         <activity\n             android:name=\".GodotEditor\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"true\"\n             android:icon=\"@mipmap/themed_icon\"\n             android:launchMode=\"singleTask\"\n@@ -59,7 +59,7 @@\n         </activity>\n         <activity\n             android:name=\".GodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -74,7 +74,7 @@\n         </activity>\n         <activity\n             android:name=\".embed.EmbeddedGodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -87,7 +87,7 @@\n             android:screenOrientation=\"userLandscape\" />\n         <activity\n             android:name=\".GodotXRGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:process=\":GodotXRGame\"\n             android:launchMode=\"singleTask\"\n             android:icon=\"@mipmap/ic_play_window\"\ndiff --git a/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java b/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\nindex 6f036c15a32a..d9d1cedc6a0f 100644\n--- a/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\n+++ b/platform/android/java/lib/src/org/godotengine/godot/input/GodotInputHandler.java\n@@ -59,6 +59,7 @@\n import java.util.Collections;\n import java.util.HashSet;\n import java.util.Set;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /**\n  * Handles input related events for the {@link GodotRenderView} view.\n@@ -83,7 +84,7 @@ public class GodotInputHandler implements InputManager.InputDeviceListener, Sens\n \t/**\n \t * Used to decide whether mouse capture can be enabled.\n \t */\n-\tprivate int lastSeenToolType = MotionEvent.TOOL_TYPE_UNKNOWN;\n+\tprivate AtomicInteger lastSeenToolType = new AtomicInteger(MotionEvent.TOOL_TYPE_UNKNOWN);\n \n \tprivate int rotaryInputAxis = ROTARY_INPUT_VERTICAL_AXIS;\n \n@@ -149,7 +150,8 @@ private boolean isKeyEventGameDevice(int source) {\n \t}\n \n \tpublic boolean canCapturePointer() {\n-\t\treturn lastSeenToolType == MotionEvent.TOOL_TYPE_MOUSE;\n+\t\treturn lastSeenToolType.get() == MotionEvent.TOOL_TYPE_MOUSE ||\n+\t\t\t\tlastSeenToolType.get() == MotionEvent.TOOL_TYPE_UNKNOWN;\n \t}\n \n \tpublic void onPointerCaptureChange(boolean hasCapture) {\n@@ -210,7 +212,7 @@ public boolean onKeyDown(final int keyCode, KeyEvent event) {\n \t}\n \n \tpublic boolean onTouchEvent(final MotionEvent event) {\n-\t\tlastSeenToolType = getEventToolType(event);\n+\t\tlastSeenToolType.set(getEventToolType(event));\n \n \t\tthis.scaleGestureDetector.onTouchEvent(event);\n \t\tif (this.gestureDetector.onTouchEvent(event)) {\n@@ -236,7 +238,7 @@ public boolean onTouchEvent(final MotionEvent event) {\n \t}\n \n \tpublic boolean onGenericMotionEvent(MotionEvent event) {\n-\t\tlastSeenToolType = getEventToolType(event);\n+\t\tlastSeenToolType.set(getEventToolType(event));\n \n \t\tif (event.isFromSource(InputDevice.SOURCE_JOYSTICK) && event.getActionMasked() == MotionEvent.ACTION_MOVE) {\n \t\t\t// Check if the device exists\ndiff --git a/platform/android/java_class_wrapper.cpp b/platform/android/java_class_wrapper.cpp\nindex c19196ae8713..4980258d9898 100644\n--- a/platform/android/java_class_wrapper.cpp\n+++ b/platform/android/java_class_wrapper.cpp\n@@ -108,18 +108,21 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\t\t}\n \t\t\t\t} break;\n \t\t\t\tcase ARG_TYPE_CLASS: {\n-\t\t\t\t\tif (p_args[i]->get_type() != Variant::OBJECT && p_args[i]->get_type() != Variant::NIL) {\n+\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n+\t\t\t\t\tif (cn.begins_with(\"L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\t\tcn = cn.substr(1, cn.length() - 2);\n+\t\t\t\t\t}\n+\t\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\") {\n+\t\t\t\t\t\tif (p_args[i]->get_type() != Variant::DICTIONARY) {\n+\t\t\t\t\t\t\targ_expected = Variant::DICTIONARY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::OBJECT && p_args[i]->get_type() != Variant::NIL) {\n \t\t\t\t\t\targ_expected = Variant::OBJECT;\n \t\t\t\t\t} else {\n \t\t\t\t\t\tRef<RefCounted> ref = *p_args[i];\n \t\t\t\t\t\tif (ref.is_valid()) {\n \t\t\t\t\t\t\tif (Object::cast_to<JavaObject>(ref.ptr())) {\n \t\t\t\t\t\t\t\tRef<JavaObject> jo = ref;\n-\t\t\t\t\t\t\t\t//could be faster\n-\t\t\t\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n-\t\t\t\t\t\t\t\tif (cn.begins_with(\"L\") && cn.ends_with(\";\")) {\n-\t\t\t\t\t\t\t\t\tcn = cn.substr(1, cn.length() - 2);\n-\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n \t\t\t\t\t\t\t\tif (!c || !env->IsInstanceOf(jo->instance, c)) {\n \t\t\t\t\t\t\t\t\targ_expected = Variant::OBJECT;\n@@ -132,6 +135,116 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BOOLEAN: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::BOOL) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n+\t\t\t\t\tif (p_args[i]->get_type() != Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::PACKED_BYTE_ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::INT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::INT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_INT64_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::FLOAT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_FLOAT32_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::FLOAT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_FLOAT64_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING:\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::STRING) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else if (p_args[i]->get_type() != Variant::PACKED_STRING_ARRAY) {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CALLABLE: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::CALLABLE) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n+\t\t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n+\t\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\t\tif (arr.is_typed() && arr.get_typed_builtin() != Variant::OBJECT) {\n+\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tString cn = E.param_sigs[i].operator String();\n+\t\t\t\t\t\t\tif (cn.begins_with(\"[L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\t\t\t\tcn = cn.substr(2, cn.length() - 3);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n+\t\t\t\t\t\t\tif (c) {\n+\t\t\t\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\t\t\t\tRef<JavaObject> jo = arr[j];\n+\t\t\t\t\t\t\t\t\tif (jo.is_valid()) {\n+\t\t\t\t\t\t\t\t\t\tif (!env->IsInstanceOf(jo->instance, c)) {\n+\t\t\t\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targ_expected = Variant::ARRAY;\n+\t\t\t\t\t}\n+\t\t\t\t} break;\n \t\t\t\tdefault: {\n \t\t\t\t\tif (p_args[i]->get_type() != Variant::ARRAY) {\n \t\t\t\t\t\targ_expected = Variant::ARRAY;\n@@ -287,13 +400,16 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\tto_free.push_back(jcallable);\n \t\t\t} break;\n \t\t\tcase ARG_TYPE_CLASS: {\n-\t\t\t\tRef<JavaObject> jo = *p_args[i];\n-\t\t\t\tif (jo.is_valid()) {\n-\t\t\t\t\targv[i].l = jo->instance;\n+\t\t\t\tif (p_args[i]->get_type() == Variant::DICTIONARY) {\n+\t\t\t\t\targv[i].l = _variant_to_jvalue(env, Variant::DICTIONARY, p_args[i]).obj;\n \t\t\t\t} else {\n-\t\t\t\t\targv[i].l = nullptr; //I hope this works\n+\t\t\t\t\tRef<JavaObject> jo = *p_args[i];\n+\t\t\t\t\tif (jo.is_valid()) {\n+\t\t\t\t\t\targv[i].l = jo->instance;\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\targv[i].l = nullptr; //I hope this works\n+\t\t\t\t\t}\n \t\t\t\t}\n-\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BOOLEAN: {\n \t\t\t\tArray arr = *p_args[i];\n@@ -307,90 +423,171 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjbyteArray a = env->NewByteArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjbyte val = arr[j];\n-\t\t\t\t\tenv->SetByteArrayRegion(a, j, 1, &val);\n+\t\t\t\tjbyteArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewByteArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjbyte val = arr[j];\n+\t\t\t\t\t\tenv->SetByteArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\tPackedByteArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewByteArray(arr.size());\n+\t\t\t\t\tenv->SetByteArrayRegion(a, 0, arr.size(), (const jbyte *)arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjcharArray a = env->NewCharArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjchar val = arr[j];\n-\t\t\t\t\tenv->SetCharArrayRegion(a, j, 1, &val);\n+\t\t\t\tjcharArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewCharArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjchar val = arr[j];\n+\t\t\t\t\t\tenv->SetCharArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_BYTE_ARRAY) {\n+\t\t\t\t\tPackedByteArray arr = *p_args[i];\n+\t\t\t\t\t// The data is expected to be UTF-16 encoded, so the length is half the size of the byte array.\n+\t\t\t\t\tint size = arr.size() / 2;\n+\t\t\t\t\ta = env->NewCharArray(size);\n+\t\t\t\t\tenv->SetCharArrayRegion(a, 0, size, (const jchar *)arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjshortArray a = env->NewShortArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjshort val = arr[j];\n-\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\tjshortArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewShortArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjshort val = arr[j];\n+\t\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\tPackedInt32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewShortArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjshort val = arr[j];\n+\t\t\t\t\t\tenv->SetShortArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjintArray a = env->NewIntArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjint val = arr[j];\n-\t\t\t\t\tenv->SetIntArrayRegion(a, j, 1, &val);\n+\t\t\t\tjintArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewIntArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjint val = arr[j];\n+\t\t\t\t\t\tenv->SetIntArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT32_ARRAY) {\n+\t\t\t\t\tPackedInt32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewIntArray(arr.size());\n+\t\t\t\t\tenv->SetIntArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjlongArray a = env->NewLongArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjlong val = (int64_t)arr[j];\n-\t\t\t\t\tenv->SetLongArrayRegion(a, j, 1, &val);\n+\t\t\t\tjlongArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewLongArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjlong val = (int64_t)arr[j];\n+\t\t\t\t\t\tenv->SetLongArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_INT64_ARRAY) {\n+\t\t\t\t\tPackedInt64Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewLongArray(arr.size());\n+\t\t\t\t\tenv->SetLongArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjfloatArray a = env->NewFloatArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjfloat val = arr[j];\n-\t\t\t\t\tenv->SetFloatArrayRegion(a, j, 1, &val);\n+\t\t\t\tjfloatArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewFloatArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjfloat val = arr[j];\n+\t\t\t\t\t\tenv->SetFloatArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_FLOAT32_ARRAY) {\n+\t\t\t\t\tPackedFloat32Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewFloatArray(arr.size());\n+\t\t\t\t\tenv->SetFloatArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjdoubleArray a = env->NewDoubleArray(arr.size());\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tjdouble val = arr[j];\n-\t\t\t\t\tenv->SetDoubleArrayRegion(a, j, 1, &val);\n+\t\t\t\tjdoubleArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewDoubleArray(arr.size());\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tjdouble val = arr[j];\n+\t\t\t\t\t\tenv->SetDoubleArrayRegion(a, j, 1, &val);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_FLOAT64_ARRAY) {\n+\t\t\t\t\tPackedFloat64Array arr = *p_args[i];\n+\t\t\t\t\ta = env->NewDoubleArray(arr.size());\n+\t\t\t\t\tenv->SetDoubleArrayRegion(a, 0, arr.size(), arr.ptr());\n \t\t\t\t}\n+\n \t\t\t\targv[i].l = a;\n \t\t\t\tto_free.push_back(a);\n \n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING:\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n-\t\t\t\tArray arr = *p_args[i];\n-\t\t\t\tjobjectArray a = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n-\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n-\t\t\t\t\tString s = arr[j];\n-\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n-\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n-\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\tjobjectArray a = nullptr;\n+\n+\t\t\t\tif (p_args[i]->get_type() == Variant::ARRAY) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tString s = arr[j];\n+\t\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n+\t\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n+\t\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\t\t}\n+\t\t\t\t} else if (p_args[i]->get_type() == Variant::PACKED_STRING_ARRAY) {\n+\t\t\t\t\tPackedStringArray arr = *p_args[i];\n+\t\t\t\t\ta = env->NewObjectArray(arr.size(), env->FindClass(\"java/lang/String\"), nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tString s = arr[j];\n+\t\t\t\t\t\tjstring jStr = env->NewStringUTF(s.utf8().get_data());\n+\t\t\t\t\t\tenv->SetObjectArrayElement(a, j, jStr);\n+\t\t\t\t\t\tto_free.push_back(jStr);\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\targv[i].l = a;\n@@ -410,7 +607,22 @@ bool JavaClass::_call_method(JavaObject *p_instance, const StringName &p_method,\n \t\t\t\tto_free.push_back(jarr);\n \t\t\t} break;\n \t\t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n-\t\t\t\targv[i].l = nullptr;\n+\t\t\t\tString cn = method->param_sigs[i].operator String();\n+\t\t\t\tif (cn.begins_with(\"[L\") && cn.ends_with(\";\")) {\n+\t\t\t\t\tcn = cn.substr(2, cn.length() - 3);\n+\t\t\t\t}\n+\t\t\t\tjclass c = env->FindClass(cn.utf8().get_data());\n+\t\t\t\tif (c) {\n+\t\t\t\t\tArray arr = *p_args[i];\n+\t\t\t\t\tjobjectArray jarr = env->NewObjectArray(arr.size(), c, nullptr);\n+\t\t\t\t\tfor (int j = 0; j < arr.size(); j++) {\n+\t\t\t\t\t\tRef<JavaObject> jo = arr[j];\n+\t\t\t\t\t\tenv->SetObjectArrayElement(jarr, j, jo->instance);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\targv[i].l = jarr;\n+\t\t\t\t\tto_free.push_back(jarr);\n+\t\t\t\t}\n \t\t\t} break;\n \t\t}\n \t}\n@@ -865,8 +1077,13 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tenv->DeleteLocalRef(java_class);\n \n \t\t\tif (java_class_wrapped.is_valid()) {\n-\t\t\t\tRef<JavaObject> ret = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n-\t\t\t\tvar = ret;\n+\t\t\t\tString cn = java_class_wrapped->get_java_class_name();\n+\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\" || cn == \"java.util.HashMap\") {\n+\t\t\t\t\tvar = _jobject_to_variant(env, obj);\n+\t\t\t\t} else {\n+\t\t\t\t\tRef<JavaObject> ret = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n+\t\t\t\t\tvar = ret;\n+\t\t\t\t}\n \t\t\t\treturn true;\n \t\t\t}\n \n@@ -881,11 +1098,12 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjboolean val;\n-\t\t\t\tenv->GetBooleanArrayRegion((jbooleanArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n+\t\t\t\tenv->GetBooleanArrayRegion((jbooleanArray)arr, i, 1, &val);\n+\t\t\t\tret[i] = (bool)val;\n \t\t\t}\n \n \t\t\tvar = ret;\n@@ -893,106 +1111,85 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjbyte val;\n-\t\t\t\tenv->GetByteArrayRegion((jbyteArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetByteArrayRegion((jbyteArray)arr, 0, count, (int8_t *)ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjchar val;\n-\t\t\t\tenv->GetCharArrayRegion((jcharArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\t// Char arrays are UTF-16 encoded, so it's double the length.\n+\t\t\tret.resize(count * 2);\n+\t\t\tenv->GetCharArrayRegion((jcharArray)arr, 0, count, (jchar *)ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjshort val;\n-\t\t\t\tenv->GetShortArrayRegion((jshortArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n+\t\t\t\tenv->GetShortArrayRegion((jshortArray)arr, i, 1, &val);\n+\t\t\t\tptr[i] = val;\n \t\t\t}\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjint val;\n-\t\t\t\tenv->GetIntArrayRegion((jintArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetIntArrayRegion((jintArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjlong val;\n-\t\t\t\tenv->GetLongArrayRegion((jlongArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back((int64_t)val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetLongArrayRegion((jlongArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjfloat val;\n-\t\t\t\tenv->GetFloatArrayRegion((jfloatArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetFloatArrayRegion((jfloatArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n-\n-\t\t\tfor (int i = 0; i < count; i++) {\n-\t\t\t\tjdouble val;\n-\t\t\t\tenv->GetDoubleArrayRegion((jdoubleArray)arr, 0, 1, &val);\n-\t\t\t\tret.push_back(val);\n-\t\t\t}\n+\t\t\tret.resize(count);\n+\t\t\tenv->GetDoubleArrayRegion((jdoubleArray)arr, 0, count, ret.ptrw());\n \n \t\t\tvar = ret;\n \t\t\treturn true;\n@@ -1002,14 +1199,13 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tbool val = env->CallBooleanMethod(o, JavaClassWrapper::singleton->Boolean_booleanValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tret[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1019,18 +1215,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_BYTE: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tuint8_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallByteMethod(o, JavaClassWrapper::singleton->Byte_byteValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = (uint8_t)val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1039,18 +1237,22 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_CHAR: {\n-\t\t\tArray ret;\n+\t\t\tPackedByteArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\t// Char arrays are UTF-16 encoded, so it's double the length.\n+\t\t\tret.resize(count * 2);\n \n+\t\t\tjchar *ptr = (jchar *)ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tcount = i;\n+\t\t\t\t\tbreak;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallCharMethod(o, JavaClassWrapper::singleton->Character_characterValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = (jchar)val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1059,18 +1261,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_SHORT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallShortMethod(o, JavaClassWrapper::singleton->Short_shortValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1079,18 +1283,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_INT: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint32_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint val = env->CallIntMethod(o, JavaClassWrapper::singleton->Integer_integerValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1099,18 +1305,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_LONG: {\n-\t\t\tArray ret;\n+\t\t\tPackedInt64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tint64_t *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0;\n \t\t\t\t} else {\n \t\t\t\t\tint64_t val = env->CallLongMethod(o, JavaClassWrapper::singleton->Long_longValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1119,18 +1327,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_FLOAT: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat32Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tfloat *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0.0;\n \t\t\t\t} else {\n \t\t\t\t\tfloat val = env->CallFloatMethod(o, JavaClassWrapper::singleton->Float_floatValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1139,18 +1349,20 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_NUMBER_CLASS_BIT | ARG_ARRAY_BIT | ARG_TYPE_DOUBLE: {\n-\t\t\tArray ret;\n+\t\t\tPackedFloat64Array ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tdouble *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n \t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n+\t\t\t\t\tptr[i] = 0.0;\n \t\t\t\t} else {\n \t\t\t\t\tdouble val = env->CallDoubleMethod(o, JavaClassWrapper::singleton->Double_doubleValue);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1160,18 +1372,18 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t} break;\n \n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_STRING: {\n-\t\t\tArray ret;\n+\t\t\tPackedStringArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tString *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tString val = jstring_to_string((jstring)o, env);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1180,18 +1392,18 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CHARSEQUENCE: {\n-\t\t\tArray ret;\n+\t\t\tPackedStringArray ret;\n \t\t\tjobjectArray arr = (jobjectArray)obj;\n \n \t\t\tint count = env->GetArrayLength(arr);\n+\t\t\tret.resize(count);\n \n+\t\t\tString *ptr = ret.ptrw();\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(arr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tString val = charsequence_to_string(env, o);\n-\t\t\t\t\tret.push_back(val);\n+\t\t\t\t\tptr[i] = val;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1203,13 +1415,12 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\tArray ret;\n \t\t\tjobjectArray jarr = (jobjectArray)obj;\n \t\t\tint count = env->GetArrayLength(jarr);\n+\t\t\tret.resize(count);\n \t\t\tfor (int i = 0; i < count; i++) {\n \t\t\t\tjobject o = env->GetObjectArrayElement(jarr, i);\n-\t\t\t\tif (!o) {\n-\t\t\t\t\tret.push_back(Variant());\n-\t\t\t\t} else {\n+\t\t\t\tif (o) {\n \t\t\t\t\tCallable callable = jcallable_to_callable(env, o);\n-\t\t\t\t\tret.push_back(callable);\n+\t\t\t\t\tret[i] = callable;\n \t\t\t\t}\n \t\t\t\tenv->DeleteLocalRef(o);\n \t\t\t}\n@@ -1218,6 +1429,32 @@ bool JavaClass::_convert_object_to_variant(JNIEnv *env, jobject obj, Variant &va\n \t\t\treturn true;\n \t\t} break;\n \t\tcase ARG_ARRAY_BIT | ARG_TYPE_CLASS: {\n+\t\t\tArray ret;\n+\t\t\tjobjectArray jarr = (jobjectArray)obj;\n+\t\t\tint count = env->GetArrayLength(jarr);\n+\t\t\tret.resize(count);\n+\t\t\tfor (int i = 0; i < count; i++) {\n+\t\t\t\tjobject obj = env->GetObjectArrayElement(jarr, i);\n+\t\t\t\tif (obj) {\n+\t\t\t\t\tjclass java_class = env->GetObjectClass(obj);\n+\t\t\t\t\tRef<JavaClass> java_class_wrapped = JavaClassWrapper::singleton->wrap_jclass(java_class);\n+\t\t\t\t\tenv->DeleteLocalRef(java_class);\n+\n+\t\t\t\t\tif (java_class_wrapped.is_valid()) {\n+\t\t\t\t\t\tString cn = java_class_wrapped->get_java_class_name();\n+\t\t\t\t\t\tif (cn == \"org/godotengine/godot/Dictionary\" || cn == \"java.util.HashMap\") {\n+\t\t\t\t\t\t\tret[i] = _jobject_to_variant(env, obj);\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tRef<JavaObject> java_obj_wrapped = Ref<JavaObject>(memnew(JavaObject(java_class_wrapped, obj)));\n+\t\t\t\t\t\t\tret[i] = java_obj_wrapped;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tenv->DeleteLocalRef(obj);\n+\t\t\t}\n+\n+\t\t\tvar = ret;\n+\t\t\treturn true;\n \t\t} break;\n \t}\n \ndiff --git a/platform/android/java_godot_lib_jni.cpp b/platform/android/java_godot_lib_jni.cpp\nindex 054c809c6e3f..0bb78bb9d974 100644\n--- a/platform/android/java_godot_lib_jni.cpp\n+++ b/platform/android/java_godot_lib_jni.cpp\n@@ -49,6 +49,7 @@\n #include \"core/config/project_settings.h\"\n #include \"core/input/input.h\"\n #include \"main/main.h\"\n+#include \"servers/rendering_server.h\"\n \n #ifndef _3D_DISABLED\n #include \"servers/xr_server.h\"\ndiff --git a/platform/ios/export/export_plugin.cpp b/platform/ios/export/export_plugin.cpp\nindex 84bf722d14f4..7ca7dc1ac675 100644\n--- a/platform/ios/export/export_plugin.cpp\n+++ b/platform/ios/export/export_plugin.cpp\n@@ -2735,6 +2735,42 @@ void EditorExportPlatformIOS::_check_for_changes_poll_thread(void *ud) {\n \t\t\t}\n \t\t}\n \n+\t\t// Enum devices (via Xcode).\n+\t\tif (ea->has_runnable_preset.is_set() && _check_xcode_install() && (FileAccess::exists(\"/usr/bin/xcrun\") || FileAccess::exists(\"/bin/xcrun\"))) {\n+\t\t\tString devices;\n+\t\t\tList<String> args;\n+\t\t\targs.push_back(\"devicectl\");\n+\t\t\targs.push_back(\"list\");\n+\t\t\targs.push_back(\"devices\");\n+\t\t\targs.push_back(\"-j\");\n+\t\t\targs.push_back(\"-\");\n+\t\t\targs.push_back(\"-q\");\n+\t\t\tint ec = 0;\n+\t\t\tError err = OS::get_singleton()->execute(\"xcrun\", args, &devices, &ec, true);\n+\t\t\tif (err == OK && ec == 0) {\n+\t\t\t\tRef<JSON> json;\n+\t\t\t\tjson.instantiate();\n+\t\t\t\terr = json->parse(devices);\n+\t\t\t\tif (err == OK) {\n+\t\t\t\t\tconst Dictionary &data = json->get_data();\n+\t\t\t\t\tconst Dictionary &result = data[\"result\"];\n+\t\t\t\t\tconst Array &devices = result[\"devices\"];\n+\t\t\t\t\tfor (int i = 0; i < devices.size(); i++) {\n+\t\t\t\t\t\tconst Dictionary &device_info = devices[i];\n+\t\t\t\t\t\tconst Dictionary &conn_props = device_info[\"connectionProperties\"];\n+\t\t\t\t\t\tconst Dictionary &dev_props = device_info[\"deviceProperties\"];\n+\t\t\t\t\t\tif (conn_props[\"pairingState\"] == \"paired\" && dev_props[\"developerModeStatus\"] == \"enabled\") {\n+\t\t\t\t\t\t\tDevice nd;\n+\t\t\t\t\t\t\tnd.id = device_info[\"identifier\"];\n+\t\t\t\t\t\t\tnd.name = dev_props[\"name\"].operator String() + \" (devicectl, \" + ((conn_props[\"transportType\"] == \"localNetwork\") ? \"network\" : \"wired\") + \")\";\n+\t\t\t\t\t\t\tnd.wifi = conn_props[\"transportType\"] == \"localNetwork\";\n+\t\t\t\t\t\t\tldevices.push_back(nd);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n \t\t// Update device list.\n \t\t{\n \t\t\tMutexLock lock(ea->device_lock);\n@@ -2922,7 +2958,7 @@ Error EditorExportPlatformIOS::run(const Ref<EditorExportPreset> &p_preset, int\n \t\t\t}\n \t\t}\n \t} else {\n-\t\t// Deploy and run on real device.\n+\t\t// Deploy and run on real device (via Xcode).\n \t\tif (ep.step(\"Installing to device...\", 3)) {\n \t\t\tCLEANUP_AND_RETURN(ERR_SKIP);\n \t\t} else {\ndiff --git a/platform/linuxbsd/README.md b/platform/linuxbsd/README.md\nindex c4f287cc6c8c..e1a95324ad50 100644\n--- a/platform/linuxbsd/README.md\n+++ b/platform/linuxbsd/README.md\n@@ -14,7 +14,7 @@ used by this platform.\n \n ## Artwork license\n \n-[`logo.png`](logo.png) is derived from the [Linux logo](https://isc.tamu.edu/~lewing/linux/):\n+[`logo.svg`](export/logo.svg) is derived from the [Linux logo](https://isc.tamu.edu/~lewing/linux/):\n \n > Permission to use and/or modify this image is granted provided you acknowledge me\n > <lewing@isc.tamu.edu> and [The GIMP](https://isc.tamu.edu/~lewing/gimp/)\ndiff --git a/platform/linuxbsd/os_linuxbsd.cpp b/platform/linuxbsd/os_linuxbsd.cpp\nindex 9fba97d552a0..466841d747f9 100644\n--- a/platform/linuxbsd/os_linuxbsd.cpp\n+++ b/platform/linuxbsd/os_linuxbsd.cpp\n@@ -37,10 +37,12 @@\n #include \"servers/rendering_server.h\"\n \n #ifdef X11_ENABLED\n+#include \"x11/detect_prime_x11.h\"\n #include \"x11/display_server_x11.h\"\n #endif\n \n #ifdef WAYLAND_ENABLED\n+#include \"wayland/detect_prime_egl.h\"\n #include \"wayland/display_server_wayland.h\"\n #endif\n \n@@ -49,6 +51,22 @@\n #include \"modules/regex/regex.h\"\n #endif\n \n+#if defined(RD_ENABLED)\n+#include \"servers/rendering/rendering_device.h\"\n+#endif\n+\n+#if defined(VULKAN_ENABLED)\n+#ifdef X11_ENABLED\n+#include \"x11/rendering_context_driver_vulkan_x11.h\"\n+#endif\n+#ifdef WAYLAND_ENABLED\n+#include \"wayland/rendering_context_driver_vulkan_wayland.h\"\n+#endif\n+#endif\n+#if defined(GLES3_ENABLED)\n+#include \"drivers/gles3/rasterizer_gles3.h\"\n+#endif\n+\n #include <dlfcn.h>\n #include <stdio.h>\n #include <stdlib.h>\n@@ -1180,6 +1198,73 @@ String OS_LinuxBSD::get_system_ca_certificates() {\n \treturn f->get_as_text();\n }\n \n+bool OS_LinuxBSD::_test_create_rendering_device(const String &p_display_driver) const {\n+\t// Tests Rendering Device creation.\n+\n+\tbool ok = false;\n+#if defined(RD_ENABLED)\n+\tError err;\n+\tRenderingContextDriver *rcd = nullptr;\n+\n+#if defined(VULKAN_ENABLED)\n+#ifdef X11_ENABLED\n+\tif (p_display_driver == \"x11\" || p_display_driver.is_empty()) {\n+\t\trcd = memnew(RenderingContextDriverVulkanX11);\n+\t}\n+#endif\n+#ifdef WAYLAND_ENABLED\n+\tif (p_display_driver == \"wayland\") {\n+\t\trcd = memnew(RenderingContextDriverVulkanWayland);\n+\t}\n+#endif\n+#endif\n+\tif (rcd != nullptr) {\n+\t\terr = rcd->initialize();\n+\t\tif (err == OK) {\n+\t\t\tRenderingDevice *rd = memnew(RenderingDevice);\n+\t\t\terr = rd->initialize(rcd);\n+\t\t\tmemdelete(rd);\n+\t\t\trd = nullptr;\n+\t\t\tif (err == OK) {\n+\t\t\t\tok = true;\n+\t\t\t}\n+\t\t}\n+\t\tmemdelete(rcd);\n+\t\trcd = nullptr;\n+\t}\n+#endif\n+\treturn ok;\n+}\n+\n+bool OS_LinuxBSD::_test_create_rendering_device_and_gl(const String &p_display_driver) const {\n+\t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some drivers.\n+\n+#ifdef GLES3_ENABLED\n+#ifdef X11_ENABLED\n+\tif (p_display_driver == \"x11\" || p_display_driver.is_empty()) {\n+#ifdef SOWRAP_ENABLED\n+\t\tif (initialize_xlib(0) != 0) {\n+\t\t\treturn false;\n+\t\t}\n+#endif\n+\t\tDetectPrimeX11::create_context();\n+\t}\n+#endif\n+#ifdef WAYLAND_ENABLED\n+\tif (p_display_driver == \"wayland\") {\n+#ifdef SOWRAP_ENABLED\n+\t\tif (initialize_wayland_egl(0) != 0) {\n+\t\t\treturn false;\n+\t\t}\n+#endif\n+\t\tDetectPrimeEGL::create_context(EGL_PLATFORM_WAYLAND_KHR);\n+\t}\n+#endif\n+\tRasterizerGLES3::make_current(true);\n+#endif\n+\treturn _test_create_rendering_device(p_display_driver);\n+}\n+\n OS_LinuxBSD::OS_LinuxBSD() {\n \tmain_loop = nullptr;\n \ndiff --git a/platform/linuxbsd/os_linuxbsd.h b/platform/linuxbsd/os_linuxbsd.h\nindex 9084061eb96c..92e57304f3c3 100644\n--- a/platform/linuxbsd/os_linuxbsd.h\n+++ b/platform/linuxbsd/os_linuxbsd.h\n@@ -138,6 +138,9 @@ class OS_LinuxBSD : public OS_Unix {\n \n \tvirtual String get_system_ca_certificates() override;\n \n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const override;\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const override;\n+\n \tOS_LinuxBSD();\n \t~OS_LinuxBSD();\n };\ndiff --git a/platform/linuxbsd/wayland/detect_prime_egl.h b/platform/linuxbsd/wayland/detect_prime_egl.h\nindex 3391e020d8b2..eff5d8a2918d 100644\n--- a/platform/linuxbsd/wayland/detect_prime_egl.h\n+++ b/platform/linuxbsd/wayland/detect_prime_egl.h\n@@ -77,9 +77,9 @@ class DetectPrimeEGL {\n \t\t{ nullptr, 0 }\n \t};\n \n+public:\n \tstatic void create_context(EGLenum p_platform_enum);\n \n-public:\n \tstatic int detect_prime(EGLenum p_platform_enum);\n };\n \ndiff --git a/platform/linuxbsd/x11/detect_prime_x11.cpp b/platform/linuxbsd/x11/detect_prime_x11.cpp\nindex c2cb02b93781..5ec5a53b989c 100644\n--- a/platform/linuxbsd/x11/detect_prime_x11.cpp\n+++ b/platform/linuxbsd/x11/detect_prime_x11.cpp\n@@ -60,25 +60,23 @@ typedef GLXContext (*GLXCREATECONTEXTATTRIBSARBPROC)(Display *, GLXFBConfig, GLX\n // To prevent shadowing warnings\n #undef glGetString\n \n-struct vendor {\n-\tconst char *glxvendor = nullptr;\n-\tint priority = 0;\n-};\n-\n-vendor vendormap[] = {\n-\t{ \"Advanced Micro Devices, Inc.\", 30 },\n-\t{ \"AMD\", 30 },\n-\t{ \"NVIDIA Corporation\", 30 },\n-\t{ \"X.Org\", 30 },\n-\t{ \"Intel Open Source Technology Center\", 20 },\n-\t{ \"Intel\", 20 },\n-\t{ \"nouveau\", 10 },\n-\t{ \"Mesa Project\", 0 },\n-\t{ nullptr, 0 }\n-};\n+int silent_error_handler(Display *display, XErrorEvent *error) {\n+\tstatic char message[1024];\n+\tXGetErrorText(display, error->error_code, message, sizeof(message));\n+\tprint_verbose(vformat(\"XServer error: %s\"\n+\t\t\t\t\t\t  \"\\n   Major opcode of failed request: %d\"\n+\t\t\t\t\t\t  \"\\n   Serial number of failed request: %d\"\n+\t\t\t\t\t\t  \"\\n   Current serial number in output stream: %d\",\n+\t\t\tString::utf8(message), (uint64_t)error->request_code, (uint64_t)error->minor_code, (uint64_t)error->serial));\n+\n+\tquick_exit(1);\n+\treturn 0;\n+}\n \n // Runs inside a child. Exiting will not quit the engine.\n-void create_context() {\n+void DetectPrimeX11::create_context() {\n+\tXSetErrorHandler(&silent_error_handler);\n+\n \tDisplay *x11_display = XOpenDisplay(nullptr);\n \tWindow x11_window;\n \tGLXContext glx_context;\n@@ -137,20 +135,7 @@ void create_context() {\n \tXFree(vi);\n }\n \n-int silent_error_handler(Display *display, XErrorEvent *error) {\n-\tstatic char message[1024];\n-\tXGetErrorText(display, error->error_code, message, sizeof(message));\n-\tprint_verbose(vformat(\"XServer error: %s\"\n-\t\t\t\t\t\t  \"\\n   Major opcode of failed request: %d\"\n-\t\t\t\t\t\t  \"\\n   Serial number of failed request: %d\"\n-\t\t\t\t\t\t  \"\\n   Current serial number in output stream: %d\",\n-\t\t\tString::utf8(message), (uint64_t)error->request_code, (uint64_t)error->minor_code, (uint64_t)error->serial));\n-\n-\tquick_exit(1);\n-\treturn 0;\n-}\n-\n-int detect_prime() {\n+int DetectPrimeX11::detect_prime() {\n \tpid_t p;\n \tint priorities[2] = {};\n \tString vendors[2];\n@@ -202,7 +187,6 @@ int detect_prime() {\n \t\t\t// cleaning up these processes, and fork() makes a copy\n \t\t\t// of all globals.\n \t\t\tCoreGlobals::leak_reporting_enabled = false;\n-\t\t\tXSetErrorHandler(&silent_error_handler);\n \n \t\t\tchar string[201];\n \n@@ -253,7 +237,7 @@ int detect_prime() {\n \t}\n \n \tfor (int i = 1; i >= 0; --i) {\n-\t\tvendor *v = vendormap;\n+\t\tconst Vendor *v = vendor_map;\n \t\twhile (v->glxvendor) {\n \t\t\tif (v->glxvendor == vendors[i]) {\n \t\t\t\tpriorities[i] = v->priority;\ndiff --git a/platform/linuxbsd/x11/detect_prime_x11.h b/platform/linuxbsd/x11/detect_prime_x11.h\nindex 62fe42602678..c8da79bf9221 100644\n--- a/platform/linuxbsd/x11/detect_prime_x11.h\n+++ b/platform/linuxbsd/x11/detect_prime_x11.h\n@@ -33,7 +33,30 @@\n \n #if defined(X11_ENABLED) && defined(GLES3_ENABLED)\n \n-int detect_prime();\n+class DetectPrimeX11 {\n+private:\n+\tstruct Vendor {\n+\t\tconst char *glxvendor = nullptr;\n+\t\tint priority = 0;\n+\t};\n+\n+\tstatic constexpr Vendor vendor_map[] = {\n+\t\t{ \"Advanced Micro Devices, Inc.\", 30 },\n+\t\t{ \"AMD\", 30 },\n+\t\t{ \"NVIDIA Corporation\", 30 },\n+\t\t{ \"X.Org\", 30 },\n+\t\t{ \"Intel Open Source Technology Center\", 20 },\n+\t\t{ \"Intel\", 20 },\n+\t\t{ \"nouveau\", 10 },\n+\t\t{ \"Mesa Project\", 0 },\n+\t\t{ nullptr, 0 }\n+\t};\n+\n+public:\n+\tstatic void create_context();\n+\n+\tstatic int detect_prime();\n+};\n \n #endif // X11_ENABLED && GLES3_ENABLED\n \ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex 26c94bf25cf1..56277d85c960 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -2563,7 +2563,8 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\tAtom *atoms = (Atom *)data;\n \t\tAtom wm_act_max_horz;\n \t\tAtom wm_act_max_vert;\n-\t\tif (strcmp(p_atom_name, \"_NET_WM_STATE\") == 0) {\n+\t\tbool checking_state = strcmp(p_atom_name, \"_NET_WM_STATE\") == 0;\n+\t\tif (checking_state) {\n \t\t\twm_act_max_horz = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_HORZ\", False);\n \t\t\twm_act_max_vert = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_VERT\", False);\n \t\t} else {\n@@ -2581,9 +2582,16 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\t\t\tfound_wm_act_max_vert = true;\n \t\t\t}\n \n-\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n-\t\t\t\tretval = true;\n-\t\t\t\tbreak;\n+\t\t\tif (checking_state) {\n+\t\t\t\tif (found_wm_act_max_horz && found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \n@@ -6844,7 +6852,7 @@ DisplayServerX11::DisplayServerX11(const String &p_rendering_driver, WindowMode\n \n \t\t\tif (use_prime == -1) {\n \t\t\t\tprint_verbose(\"Detecting GPUs, set DRI_PRIME in the environment to override GPU detection logic.\");\n-\t\t\t\tuse_prime = detect_prime();\n+\t\t\t\tuse_prime = DetectPrimeX11::detect_prime();\n \t\t\t}\n \n \t\t\tif (use_prime) {\ndiff --git a/platform/web/README.md b/platform/web/README.md\nindex 906eb508fecd..eac2c7fe8e17 100644\n--- a/platform/web/README.md\n+++ b/platform/web/README.md\n@@ -17,6 +17,6 @@ this platform such as the html shell (web page).\n \n ## Artwork license\n \n-[`logo.png`](logo.png) and [`run_icon.png`](run_icon.png) are licensed under\n+[`logo.svg`](export/logo.svg) and [`run_icon.svg`](export/run_icon.svg) are licensed under\n [Creative Commons Attribution 3.0 Unported](https://www.w3.org/html/logo/faq.html#how-licenced)\n per the HTML5 logo usage guidelines.\ndiff --git a/platform/windows/os_windows.cpp b/platform/windows/os_windows.cpp\nindex 7ef3de2dd79c..b0ec6852af2e 100644\n--- a/platform/windows/os_windows.cpp\n+++ b/platform/windows/os_windows.cpp\n@@ -2340,18 +2340,26 @@ void OS_Windows::add_frame_delay(bool p_can_draw) {\n \t\ttarget_ticks += dynamic_delay;\n \t\tuint64_t current_ticks = get_ticks_usec();\n \n-\t\tif (target_ticks > current_ticks + delay_resolution) {\n-\t\t\tuint64_t delay_time = target_ticks - current_ticks - delay_resolution;\n-\t\t\t// Make sure we always sleep for a multiple of delay_resolution to avoid overshooting.\n-\t\t\t// Refer to: https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep#remarks\n-\t\t\tdelay_time = (delay_time / delay_resolution) * delay_resolution;\n-\t\t\tif (delay_time > 0) {\n-\t\t\t\tdelay_usec(delay_time);\n+\t\tif (!is_in_low_processor_usage_mode()) {\n+\t\t\tif (target_ticks > current_ticks + delay_resolution) {\n+\t\t\t\tuint64_t delay_time = target_ticks - current_ticks - delay_resolution;\n+\t\t\t\t// Make sure we always sleep for a multiple of delay_resolution to avoid overshooting.\n+\t\t\t\t// Refer to: https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep#remarks\n+\t\t\t\tdelay_time = (delay_time / delay_resolution) * delay_resolution;\n+\t\t\t\tif (delay_time > 0) {\n+\t\t\t\t\tdelay_usec(delay_time);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t// Busy wait for the remainder of time.\n+\t\t\twhile (get_ticks_usec() < target_ticks) {\n+\t\t\t\tYieldProcessor();\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Use a more relaxed approach for low processor usage mode.\n+\t\t\t// This has worse frame pacing but is more power efficient.\n+\t\t\tif (current_ticks < target_ticks) {\n+\t\t\t\tdelay_usec(target_ticks - current_ticks);\n \t\t\t}\n-\t\t}\n-\t\t// Busy wait for the remainder of time.\n-\t\twhile (get_ticks_usec() < target_ticks) {\n-\t\t\tYieldProcessor();\n \t\t}\n \n \t\tcurrent_ticks = get_ticks_usec();\n@@ -2359,7 +2367,7 @@ void OS_Windows::add_frame_delay(bool p_can_draw) {\n \t}\n }\n \n-bool OS_Windows::_test_create_rendering_device() const {\n+bool OS_Windows::_test_create_rendering_device(const String &p_display_driver) const {\n \t// Tests Rendering Device creation.\n \n \tbool ok = false;\n@@ -2394,7 +2402,7 @@ bool OS_Windows::_test_create_rendering_device() const {\n \treturn ok;\n }\n \n-bool OS_Windows::_test_create_rendering_device_and_gl() const {\n+bool OS_Windows::_test_create_rendering_device_and_gl(const String &p_display_driver) const {\n \t// Tests OpenGL context and Rendering Device simultaneous creation. This function is expected to crash on some NVIDIA drivers.\n \n \tWNDCLASSEXW wc_probe;\n@@ -2438,7 +2446,7 @@ bool OS_Windows::_test_create_rendering_device_and_gl() const {\n \t}\n \n \tif (ok) {\n-\t\tok = _test_create_rendering_device();\n+\t\tok = _test_create_rendering_device(p_display_driver);\n \t}\n \n #ifdef GLES3_ENABLED\ndiff --git a/platform/windows/os_windows.h b/platform/windows/os_windows.h\nindex c46d86a650ef..d9b8233e511e 100644\n--- a/platform/windows/os_windows.h\n+++ b/platform/windows/os_windows.h\n@@ -252,8 +252,8 @@ class OS_Windows : public OS {\n \n \tvoid set_main_window(HWND p_main_window) { main_window = p_main_window; }\n \n-\tvirtual bool _test_create_rendering_device_and_gl() const override;\n-\tvirtual bool _test_create_rendering_device() const override;\n+\tvirtual bool _test_create_rendering_device_and_gl(const String &p_display_driver) const override;\n+\tvirtual bool _test_create_rendering_device(const String &p_display_driver) const override;\n \n \tHINSTANCE get_hinstance() { return hInstance; }\n \tOS_Windows(HINSTANCE _hInstance);\ndiff --git a/scene/2d/cpu_particles_2d.cpp b/scene/2d/cpu_particles_2d.cpp\nindex 279bb8ff3d95..b77003509786 100644\n--- a/scene/2d/cpu_particles_2d.cpp\n+++ b/scene/2d/cpu_particles_2d.cpp\n@@ -1194,8 +1194,6 @@ void CPUParticles2D::_notification(int p_what) {\n \n \t\t\t_refresh_interpolation_state();\n \n-\t\t\tset_physics_process_internal(emitting && _interpolation_data.interpolated_follow);\n-\n \t\t\t// If we are interpolated following, then reset physics interpolation\n \t\t\t// when first appearing. This won't be called by canvas item, as in the\n \t\t\t// following mode, is_physics_interpolated() is actually FALSE.\ndiff --git a/scene/3d/navigation_link_3d.cpp b/scene/3d/navigation_link_3d.cpp\nindex 8f9b7a60b513..dc518ee45256 100644\n--- a/scene/3d/navigation_link_3d.cpp\n+++ b/scene/3d/navigation_link_3d.cpp\n@@ -262,6 +262,12 @@ void NavigationLink3D::_notification(int p_what) {\n \t\tcase NOTIFICATION_EXIT_TREE: {\n \t\t\t_link_exit_navigation_map();\n \t\t} break;\n+\n+#ifdef DEBUG_ENABLED\n+\t\tcase NOTIFICATION_VISIBILITY_CHANGED: {\n+\t\t\t_update_debug_mesh();\n+\t\t} break;\n+#endif // DEBUG_ENABLED\n \t}\n }\n \ndiff --git a/scene/3d/voxelizer.cpp b/scene/3d/voxelizer.cpp\nindex 711b265bb641..a4c36deabdec 100644\n--- a/scene/3d/voxelizer.cpp\n+++ b/scene/3d/voxelizer.cpp\n@@ -399,6 +399,9 @@ int Voxelizer::get_bake_steps(Ref<Mesh> &p_mesh) const {\n Voxelizer::BakeResult Voxelizer::plot_mesh(const Transform3D &p_xform, Ref<Mesh> &p_mesh, const Vector<Ref<Material>> &p_materials, const Ref<Material> &p_override_material, BakeStepFunc p_bake_step_func) {\n \tERR_FAIL_COND_V_MSG(!p_xform.is_finite(), BAKE_RESULT_INVALID_PARAMETER, \"Invalid mesh bake transform.\");\n \n+\t// Precalculate for transforming vertex normals\n+\tBasis normal_xform = p_xform.basis.inverse().transposed();\n+\n \tint bake_total = get_bake_steps(p_mesh), bake_current = 0;\n \n \tfor (int i = 0; i < p_mesh->get_surface_count(); i++) {\n@@ -463,7 +466,7 @@ Voxelizer::BakeResult Voxelizer::plot_mesh(const Transform3D &p_xform, Ref<Mesh>\n \n \t\t\t\tif (nr) {\n \t\t\t\t\tfor (int k = 0; k < 3; k++) {\n-\t\t\t\t\t\tnormal[k] = nr[ir[j * 3 + k]];\n+\t\t\t\t\t\tnormal[k] = normal_xform.xform(nr[ir[j * 3 + k]]).normalized();\n \t\t\t\t\t}\n \t\t\t\t}\n \ndiff --git a/scene/animation/animation_blend_space_1d.cpp b/scene/animation/animation_blend_space_1d.cpp\nindex 4716a8fcec3d..acbc892d478f 100644\n--- a/scene/animation/animation_blend_space_1d.cpp\n+++ b/scene/animation/animation_blend_space_1d.cpp\n@@ -380,7 +380,13 @@ AnimationNode::NodeTimeInfo AnimationNodeBlendSpace1D::_process(const AnimationM\n \t\t\t\tRef<AnimationNodeAnimation> na_c = static_cast<Ref<AnimationNodeAnimation>>(blend_points[cur_closest].node);\n \t\t\t\tRef<AnimationNodeAnimation> na_n = static_cast<Ref<AnimationNodeAnimation>>(blend_points[new_closest].node);\n \t\t\t\tif (na_c.is_valid() && na_n.is_valid()) {\n+\t\t\t\t\tna_n->process_state = process_state;\n+\t\t\t\t\tna_c->process_state = process_state;\n+\n \t\t\t\t\tna_n->set_backward(na_c->is_backward());\n+\n+\t\t\t\t\tna_n = nullptr;\n+\t\t\t\t\tna_c = nullptr;\n \t\t\t\t}\n \t\t\t\t// See how much animation remains.\n \t\t\t\tpi.seeked = false;\ndiff --git a/scene/animation/animation_blend_space_2d.cpp b/scene/animation/animation_blend_space_2d.cpp\nindex 7399fea31719..ee1d4121d595 100644\n--- a/scene/animation/animation_blend_space_2d.cpp\n+++ b/scene/animation/animation_blend_space_2d.cpp\n@@ -557,7 +557,13 @@ AnimationNode::NodeTimeInfo AnimationNodeBlendSpace2D::_process(const AnimationM\n \t\t\t\tRef<AnimationNodeAnimation> na_c = static_cast<Ref<AnimationNodeAnimation>>(blend_points[cur_closest].node);\n \t\t\t\tRef<AnimationNodeAnimation> na_n = static_cast<Ref<AnimationNodeAnimation>>(blend_points[new_closest].node);\n \t\t\t\tif (na_c.is_valid() && na_n.is_valid()) {\n+\t\t\t\t\tna_n->process_state = process_state;\n+\t\t\t\t\tna_c->process_state = process_state;\n+\n \t\t\t\t\tna_n->set_backward(na_c->is_backward());\n+\n+\t\t\t\t\tna_n = nullptr;\n+\t\t\t\t\tna_c = nullptr;\n \t\t\t\t}\n \t\t\t\t// See how much animation remains.\n \t\t\t\tpi.seeked = false;\ndiff --git a/scene/debugger/scene_debugger.cpp b/scene/debugger/scene_debugger.cpp\nindex c620c5fd5c80..6b4a00f61719 100644\n--- a/scene/debugger/scene_debugger.cpp\n+++ b/scene/debugger/scene_debugger.cpp\n@@ -1362,7 +1362,7 @@ void RuntimeNodeSelect::_root_window_input(const Ref<InputEvent> &p_event) {\n \n \tif (camera_override) {\n \t\tif (node_select_type == NODE_TYPE_2D) {\n-\t\t\tif (panner->gui_input(p_event, Rect2(Vector2(), root->get_size()))) {\n+\t\t\tif (panner->gui_input(p_event, Rect2(Vector2(), root->get_visible_rect().get_size()))) {\n \t\t\t\treturn;\n \t\t\t}\n \t\t} else if (node_select_type == NODE_TYPE_3D) {\n@@ -1821,8 +1821,9 @@ void RuntimeNodeSelect::_find_canvas_items_at_pos(const Point2 &p_pos, Node *p_n\n }\n \n void RuntimeNodeSelect::_pan_callback(Vector2 p_scroll_vec, Ref<InputEvent> p_event) {\n-\tview_2d_offset.x -= p_scroll_vec.x / view_2d_zoom;\n-\tview_2d_offset.y -= p_scroll_vec.y / view_2d_zoom;\n+\tVector2 scroll = SceneTree::get_singleton()->get_root()->get_screen_transform().affine_inverse().xform(p_scroll_vec);\n+\tview_2d_offset.x -= scroll.x / view_2d_zoom;\n+\tview_2d_offset.y -= scroll.y / view_2d_zoom;\n \n \t_update_view_2d();\n }\ndiff --git a/scene/gui/color_picker.cpp b/scene/gui/color_picker.cpp\nindex aab7c37bbb5e..a5348ad3b290 100644\n--- a/scene/gui/color_picker.cpp\n+++ b/scene/gui/color_picker.cpp\n@@ -2374,7 +2374,7 @@ ColorPicker::ColorPicker() {\n \tswatches_vbc->add_child(palette_box);\n \n \tbtn_preset = memnew(Button);\n-\tbtn_preset->set_text(\"Swatches\");\n+\tbtn_preset->set_text(ETR(\"Swatches\"));\n \tbtn_preset->set_flat(true);\n \tbtn_preset->set_toggle_mode(true);\n \tbtn_preset->set_focus_mode(FOCUS_NONE);\ndiff --git a/scene/gui/line_edit.cpp b/scene/gui/line_edit.cpp\nindex 969e2fd3a35c..f4d66d5a281d 100644\n--- a/scene/gui/line_edit.cpp\n+++ b/scene/gui/line_edit.cpp\n@@ -1733,7 +1733,7 @@ void LineEdit::_validate_caret_can_draw() {\n \t\tdraw_caret = true;\n \t\tcaret_blink_timer = 0.0;\n \t}\n-\tcaret_can_draw = editing && (window_has_focus || (menu && menu->has_focus())) && (has_focus() || caret_force_displayed);\n+\tcaret_can_draw = (caret_force_displayed && !is_part_of_edited_scene()) || (editing && (window_has_focus || (menu && menu->has_focus())) && has_focus());\n }\n \n void LineEdit::delete_char() {\ndiff --git a/scene/gui/spin_box.cpp b/scene/gui/spin_box.cpp\nindex e2e6f076781a..c77fda1ac805 100644\n--- a/scene/gui/spin_box.cpp\n+++ b/scene/gui/spin_box.cpp\n@@ -63,20 +63,39 @@ void SpinBox::_update_text(bool p_only_update_if_value_changed) {\n \t\t\tvalue += \" \" + suffix;\n \t\t}\n \t}\n+\n+\tif (!accepted && update_on_text_changed && !line_edit->get_text().replace(\",\", \".\").contains_char('.')) {\n+\t\tvalue = String::num(get_value(), 0);\n+\t}\n+\n \tline_edit->set_text_with_selection(value);\n }\n \n void SpinBox::_text_submitted(const String &p_string) {\n \tif (p_string.is_empty()) {\n-\t\t_update_text();\n \t\treturn;\n \t}\n \n+\tString text = p_string;\n+\n+\tif (update_on_text_changed) {\n+\t\t// Convert commas ',' to dots '.' for French/German etc. keyboard layouts.\n+\t\ttext = p_string.replace(\",\", \".\");\n+\n+\t\tif (!text.begins_with(\".\") && p_string.ends_with(\".\")) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tif (text.begins_with(\".\")) {\n+\t\t\tline_edit->set_text(\"0.\");\n+\t\t\tline_edit->set_caret_column(line_edit->get_text().length());\n+\t\t\treturn;\n+\t\t}\n+\t}\n+\n \tRef<Expression> expr;\n \texpr.instantiate();\n \n-\t// Convert commas ',' to dots '.' for French/German etc. keyboard layouts.\n-\tString text = p_string.replace(\",\", \".\");\n \ttext = text.replace(\";\", \",\");\n \ttext = TS->parse_number(text);\n \t// Ignore the prefix and suffix in the expression.\n@@ -107,12 +126,17 @@ void SpinBox::_text_submitted(const String &p_string) {\n }\n \n void SpinBox::_text_changed(const String &p_string) {\n+\taccepted = false;\n \tint cursor_pos = line_edit->get_caret_column();\n \n \t_text_submitted(p_string);\n \n+\tString text = p_string.replace(\",\", \".\");\n+\n \t// Line edit 'set_text' method resets the cursor position so we need to undo that.\n-\tline_edit->set_caret_column(cursor_pos);\n+\tif (update_on_text_changed && !text.begins_with(\".\")) {\n+\t\tline_edit->set_caret_column(cursor_pos);\n+\t}\n }\n \n LineEdit *SpinBox::get_line_edit() {\n@@ -192,6 +216,7 @@ void SpinBox::gui_input(const Ref<InputEvent> &p_event) {\n \tif (mb.is_valid() && mb->is_pressed()) {\n \t\tswitch (mb->get_button_index()) {\n \t\t\tcase MouseButton::LEFT: {\n+\t\t\t\taccepted = true;\n \t\t\t\tline_edit->grab_focus();\n \n \t\t\t\tif (mouse_on_up_button || mouse_on_down_button) {\n@@ -291,9 +316,12 @@ void SpinBox::_line_edit_editing_toggled(bool p_toggled_on) {\n \t\t\tline_edit->select_all();\n \t\t}\n \t} else {\n+\t\taccepted = true;\n+\n \t\tif (Input::get_singleton()->is_action_pressed(\"ui_cancel\") || line_edit->get_text().is_empty()) {\n \t\t\t_update_text(); // Revert text if editing was canceled.\n \t\t} else {\n+\t\t\tline_edit->set_text(line_edit->get_text().trim_suffix(\".\").trim_suffix(\",\"));\n \t\t\t_update_text(true); // Update text in case value was changed this frame (e.g. on `focus_exited`).\n \t\t\t_text_submitted(line_edit->get_text());\n \t\t}\ndiff --git a/scene/gui/spin_box.h b/scene/gui/spin_box.h\nindex 79076d3f4692..dcc1f73eb9a2 100644\n--- a/scene/gui/spin_box.h\n+++ b/scene/gui/spin_box.h\n@@ -40,6 +40,7 @@ class SpinBox : public Range {\n \n \tLineEdit *line_edit = nullptr;\n \tbool update_on_text_changed = false;\n+\tbool accepted = true;\n \n \tstruct SizingCache {\n \t\tint buttons_block_width = 0;\ndiff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex ad2202315008..887d4eaf00f1 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -6081,7 +6081,7 @@ void TextEdit::adjust_viewport_to_caret(int p_caret) {\n \t\tset_line_as_last_visible(cur_line, cur_wrap);\n \t}\n \n-\t_adjust_viewport_to_caret_horizontally(p_caret);\n+\t_adjust_viewport_to_caret_horizontally(p_caret, false);\n }\n \n void TextEdit::center_viewport_to_caret(int p_caret) {\n@@ -8186,7 +8186,7 @@ void TextEdit::_scroll_lines_down() {\n \tmerge_overlapping_carets();\n }\n \n-void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret) {\n+void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret, bool p_maximize_selection) {\n \tif (get_line_wrapping_mode() != LineWrappingMode::LINE_WRAPPING_NONE) {\n \t\tfirst_visible_col = 0;\n \t\th_scroll->set_value(first_visible_col);\n@@ -8220,7 +8220,7 @@ void TextEdit::_adjust_viewport_to_caret_horizontally(int p_caret) {\n \t\tint ime_end_column = get_caret_column(p_caret) + (ime_selection.y > 0 ? ime_selection.x + ime_selection.y : ime_text.length());\n \t\tcaret_end_pos = _get_column_x_offset_for_line(ime_end_column, get_caret_line(p_caret), ime_end_column);\n \t\tprioritize_end = false;\n-\t} else if (has_selection(p_caret) && get_selection_from_line(p_caret) == get_selection_to_line(p_caret)) {\n+\t} else if (p_maximize_selection && has_selection(p_caret) && get_selection_from_line(p_caret) == get_selection_to_line(p_caret)) {\n \t\t// Use selection if it is on one line.\n \t\tcaret_start_pos = _get_column_x_offset_for_line(get_selection_from_column(p_caret), get_caret_line(p_caret), get_selection_from_column(p_caret));\n \t\tcaret_end_pos = _get_column_x_offset_for_line(get_selection_to_column(p_caret), get_caret_line(p_caret), get_selection_to_column(p_caret));\ndiff --git a/scene/gui/text_edit.h b/scene/gui/text_edit.h\nindex 21c8781e2648..b8d78283403d 100644\n--- a/scene/gui/text_edit.h\n+++ b/scene/gui/text_edit.h\n@@ -539,7 +539,7 @@ class TextEdit : public Control {\n \tvoid _scroll_lines_up();\n \tvoid _scroll_lines_down();\n \n-\tvoid _adjust_viewport_to_caret_horizontally(int p_caret = 0);\n+\tvoid _adjust_viewport_to_caret_horizontally(int p_caret = 0, bool p_maximize_selection = true);\n \n \t// Minimap.\n \tbool draw_minimap = false;\ndiff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex cd6c51de4b2d..dc14294ea05b 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -3506,7 +3506,7 @@ void Tree::gui_input(const Ref<InputEvent> &p_event) {\n \tRef<InputEventKey> k = p_event;\n \n \tbool is_command = k.is_valid() && k->is_command_or_control_pressed();\n-\tif (p_event->is_action(\"ui_right\") && p_event->is_pressed()) {\n+\tif (p_event->is_action(cache.rtl ? \"ui_left\" : \"ui_right\") && p_event->is_pressed()) {\n \t\tif (!cursor_can_exit_tree) {\n \t\t\taccept_event();\n \t\t}\n@@ -3524,7 +3524,7 @@ void Tree::gui_input(const Ref<InputEvent> &p_event) {\n \t\t} else {\n \t\t\t_go_down();\n \t\t}\n-\t} else if (p_event->is_action(\"ui_left\") && p_event->is_pressed()) {\n+\t} else if (p_event->is_action(cache.rtl ? \"ui_right\" : \"ui_left\") && p_event->is_pressed()) {\n \t\tif (!cursor_can_exit_tree) {\n \t\t\taccept_event();\n \t\t}\n@@ -4107,13 +4107,18 @@ bool Tree::edit_selected(bool p_force_edit) {\n \t\t// \"floor()\" centers vertically.\n \t\tVector2 ofs(0, Math::floor((MAX(line_editor->get_minimum_size().height, rect.size.height - value_editor_height) - rect.size.height) / 2));\n \n-\t\tpopup_rect.position = get_screen_position() + rect.position - ofs;\n-\t\tpopup_rect.size = rect.size;\n-\n \t\t// Account for icon.\n \t\tSize2 icon_size = _get_cell_icon_size(c) * popup_scale;\n-\t\tpopup_rect.position.x += icon_size.x;\n-\t\tpopup_rect.size.x -= icon_size.x;\n+\n+\t\tpopup_rect.size = rect.size;\n+\t\tpopup_rect.size.x -= icon_size.x + theme_cache.h_separation;\n+\n+\t\tpopup_rect.position = rect.position - ofs;\n+\t\tpopup_rect.position.x += icon_size.x + theme_cache.h_separation;\n+\t\tif (cache.rtl) {\n+\t\t\tpopup_rect.position.x = get_size().width - popup_rect.position.x - popup_rect.size.x;\n+\t\t}\n+\t\tpopup_rect.position += get_screen_position();\n \n \t\tline_editor->clear();\n \t\tline_editor->set_text(c.mode == TreeItem::CELL_MODE_STRING ? c.text : String::num(c.val, Math::range_step_decimals(c.step)));\ndiff --git a/scene/gui/video_stream_player.cpp b/scene/gui/video_stream_player.cpp\nindex fa965179a4d4..eb6aff27dc92 100644\n--- a/scene/gui/video_stream_player.cpp\n+++ b/scene/gui/video_stream_player.cpp\n@@ -136,6 +136,7 @@ void VideoStreamPlayer::_notification(int p_notification) {\n \t\t} break;\n \n \t\tcase NOTIFICATION_EXIT_TREE: {\n+\t\t\tstop();\n \t\t\tAudioServer::get_singleton()->remove_mix_callback(_mix_audios, this);\n \t\t} break;\n \ndiff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex d0054baeff25..f7fd1a2c5a7e 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -1509,6 +1509,7 @@ void Viewport::_gui_show_tooltip() {\n \t// This way, the custom tooltip from `ConnectionsDockTree` can create\n \t// its own tooltip without conflicting with the default one, even an empty tooltip.\n \tif (base_tooltip && !base_tooltip->is_visible()) {\n+\t\tmemdelete(base_tooltip);\n \t\treturn;\n \t}\n \n@@ -1546,6 +1547,8 @@ void Viewport::_gui_show_tooltip() {\n \tpanel->set_flag(Window::FLAG_POPUP, false);\n \tpanel->set_flag(Window::FLAG_MOUSE_PASSTHROUGH, true);\n \tpanel->set_wrap_controls(true);\n+\tpanel->set_default_canvas_item_texture_filter(get_default_canvas_item_texture_filter());\n+\tpanel->set_default_canvas_item_texture_repeat(get_default_canvas_item_texture_repeat());\n \tpanel->add_child(base_tooltip);\n \tpanel->gui_parent = this;\n \ndiff --git a/scene/resources/curve.cpp b/scene/resources/curve.cpp\nindex e982e4d13575..de68737b8c93 100644\n--- a/scene/resources/curve.cpp\n+++ b/scene/resources/curve.cpp\n@@ -56,7 +56,7 @@ void Curve::set_point_count(int p_count) {\n \tnotify_property_list_changed();\n }\n \n-int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_tangent, TangentMode p_left_mode, TangentMode p_right_mode) {\n+int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_tangent, TangentMode p_left_mode, TangentMode p_right_mode, bool p_mark_dirty) {\n \t// Add a point and preserve order.\n \n \t// Points must remain within the given value and domain ranges.\n@@ -99,7 +99,9 @@ int Curve::_add_point(Vector2 p_position, real_t p_left_tangent, real_t p_right_\n \n \tupdate_auto_tangents(ret);\n \n-\tmark_dirty();\n+\tif (p_mark_dirty) {\n+\t\tmark_dirty();\n+\t}\n \n \treturn ret;\n }\n@@ -221,10 +223,12 @@ Curve::TangentMode Curve::get_point_right_mode(int p_index) const {\n \treturn _points[p_index].right_mode;\n }\n \n-void Curve::_remove_point(int p_index) {\n+void Curve::_remove_point(int p_index, bool p_mark_dirty) {\n \tERR_FAIL_UNSIGNED_INDEX((uint32_t)p_index, _points.size());\n \t_points.remove_at(p_index);\n-\tmark_dirty();\n+\tif (p_mark_dirty) {\n+\t\tmark_dirty();\n+\t}\n }\n \n void Curve::remove_point(int p_index) {\n@@ -252,16 +256,13 @@ void Curve::set_point_value(int p_index, real_t p_position) {\n int Curve::set_point_offset(int p_index, real_t p_offset) {\n \tERR_FAIL_UNSIGNED_INDEX_V((uint32_t)p_index, _points.size(), -1);\n \tPoint p = _points[p_index];\n-\t_remove_point(p_index);\n-\tint i = _add_point(Vector2(p_offset, p.position.y));\n-\t_points[i].left_tangent = p.left_tangent;\n-\t_points[i].right_tangent = p.right_tangent;\n-\t_points[i].left_mode = p.left_mode;\n-\t_points[i].right_mode = p.right_mode;\n+\t_remove_point(p_index, false);\n+\tint i = _add_point(Vector2(p_offset, p.position.y), p.left_tangent, p.right_tangent, p.left_mode, p.right_mode, false);\n \tif (p_index != i) {\n \t\tupdate_auto_tangents(p_index);\n \t}\n \tupdate_auto_tangents(i);\n+\tmark_dirty();\n \treturn i;\n }\n \ndiff --git a/scene/resources/curve.h b/scene/resources/curve.h\nindex fb774e879dff..16ce75198455 100644\n--- a/scene/resources/curve.h\n+++ b/scene/resources/curve.h\n@@ -77,15 +77,15 @@ class Curve : public Resource {\n \tvoid set_point_count(int p_count);\n \n \tint add_point(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE);\n \tint add_point_no_update(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE);\n \tvoid remove_point(int p_index);\n \tvoid clear_points();\n \n@@ -127,10 +127,10 @@ class Curve : public Resource {\n \tTangentMode get_point_left_mode(int p_index) const;\n \tTangentMode get_point_right_mode(int p_index) const;\n \n-\tvoid update_auto_tangents(int i);\n+\tvoid update_auto_tangents(int p_index);\n \n \tArray get_data() const;\n-\tvoid set_data(Array input);\n+\tvoid set_data(Array p_input);\n \n \tvoid bake();\n \tvoid _bake() const;\n@@ -150,11 +150,12 @@ class Curve : public Resource {\n private:\n \tvoid mark_dirty();\n \tint _add_point(Vector2 p_position,\n-\t\t\treal_t left_tangent = 0,\n-\t\t\treal_t right_tangent = 0,\n-\t\t\tTangentMode left_mode = TANGENT_FREE,\n-\t\t\tTangentMode right_mode = TANGENT_FREE);\n-\tvoid _remove_point(int p_index);\n+\t\t\treal_t p_left_tangent = 0,\n+\t\t\treal_t p_right_tangent = 0,\n+\t\t\tTangentMode p_left_mode = TANGENT_FREE,\n+\t\t\tTangentMode p_right_mode = TANGENT_FREE,\n+\t\t\tbool p_mark_dirty = true);\n+\tvoid _remove_point(int p_index, bool p_mark_dirty = true);\n \n \tLocalVector<Point> _points;\n \tmutable bool _baked_cache_dirty = false;\ndiff --git a/scene/resources/packed_scene.cpp b/scene/resources/packed_scene.cpp\nindex 7f170e0085ec..e550a5beff90 100644\n--- a/scene/resources/packed_scene.cpp\n+++ b/scene/resources/packed_scene.cpp\n@@ -328,7 +328,7 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \n \t\t\t\t\t\tDeferredNodePathProperties dnp;\n \t\t\t\t\t\tdnp.value = props[nprops[j].value];\n-\t\t\t\t\t\tdnp.base = node;\n+\t\t\t\t\t\tdnp.base = node->get_instance_id();\n \t\t\t\t\t\tdnp.property = snames[name_idx];\n \t\t\t\t\t\tdeferred_node_paths.push_back(dnp);\n \t\t\t\t\t\tcontinue;\n@@ -521,25 +521,27 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \n \tfor (const DeferredNodePathProperties &dnp : deferred_node_paths) {\n \t\t// Replace properties stored as NodePaths with actual Nodes.\n+\t\tNode *base = Object::cast_to<Node>(ObjectDB::get_instance(dnp.base));\n+\t\tERR_CONTINUE_EDMSG(!base, vformat(\"Failed to set deferred property '%s' as the base node disappeared.\", dnp.property));\n \t\tif (dnp.value.get_type() == Variant::ARRAY) {\n \t\t\tArray paths = dnp.value;\n \n \t\t\tbool valid;\n-\t\t\tArray array = dnp.base->get(dnp.property, &valid);\n-\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, dnp.base->get_name()));\n+\t\t\tArray array = base->get(dnp.property, &valid);\n+\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, base->get_name()));\n \t\t\tarray = array.duplicate();\n \n \t\t\tarray.resize(paths.size());\n \t\t\tfor (int i = 0; i < array.size(); i++) {\n-\t\t\t\tarray.set(i, dnp.base->get_node_or_null(paths[i]));\n+\t\t\t\tarray.set(i, base->get_node_or_null(paths[i]));\n \t\t\t}\n-\t\t\tdnp.base->set(dnp.property, array);\n+\t\t\tbase->set(dnp.property, array);\n \t\t} else if (dnp.value.get_type() == Variant::DICTIONARY) {\n \t\t\tDictionary paths = dnp.value;\n \n \t\t\tbool valid;\n-\t\t\tDictionary dict = dnp.base->get(dnp.property, &valid);\n-\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, dnp.base->get_name()));\n+\t\t\tDictionary dict = base->get(dnp.property, &valid);\n+\t\t\tERR_CONTINUE_EDMSG(!valid, vformat(\"Failed to get property '%s' from node '%s'.\", dnp.property, base->get_name()));\n \t\t\tdict = dict.duplicate();\n \t\t\tbool convert_key = dict.get_typed_key_builtin() == Variant::OBJECT &&\n \t\t\t\t\tClassDB::is_parent_class(dict.get_typed_key_class_name(), \"Node\");\n@@ -549,17 +551,17 @@ Node *SceneState::instantiate(GenEditState p_edit_state) const {\n \t\t\tfor (int i = 0; i < paths.size(); i++) {\n \t\t\t\tVariant key = paths.get_key_at_index(i);\n \t\t\t\tif (convert_key) {\n-\t\t\t\t\tkey = dnp.base->get_node_or_null(key);\n+\t\t\t\t\tkey = base->get_node_or_null(key);\n \t\t\t\t}\n \t\t\t\tVariant value = paths.get_value_at_index(i);\n \t\t\t\tif (convert_value) {\n-\t\t\t\t\tvalue = dnp.base->get_node_or_null(value);\n+\t\t\t\t\tvalue = base->get_node_or_null(value);\n \t\t\t\t}\n \t\t\t\tdict[key] = value;\n \t\t\t}\n-\t\t\tdnp.base->set(dnp.property, dict);\n+\t\t\tbase->set(dnp.property, dict);\n \t\t} else {\n-\t\t\tdnp.base->set(dnp.property, dnp.base->get_node_or_null(dnp.value));\n+\t\t\tbase->set(dnp.property, base->get_node_or_null(dnp.value));\n \t\t}\n \t}\n \ndiff --git a/scene/resources/packed_scene.h b/scene/resources/packed_scene.h\nindex 9f8088910f18..ee2bba2f2088 100644\n--- a/scene/resources/packed_scene.h\n+++ b/scene/resources/packed_scene.h\n@@ -70,7 +70,7 @@ class SceneState : public RefCounted {\n \t};\n \n \tstruct DeferredNodePathProperties {\n-\t\tNode *base = nullptr;\n+\t\tObjectID base;\n \t\tStringName property;\n \t\tVariant value;\n \t};\ndiff --git a/scene/resources/particle_process_material.cpp b/scene/resources/particle_process_material.cpp\nindex 2c54564ff7b3..dd6e659e0612 100644\n--- a/scene/resources/particle_process_material.cpp\n+++ b/scene/resources/particle_process_material.cpp\n@@ -1034,7 +1034,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t\t\tcode += \"\t{\\n\";\n \t\t}\n \t\tcode += \"\t\tfloat vel_mag = length(VELOCITY);\\n\";\n-\t\tcode += \"\t\tfloat vel_infl = clamp(dynamic_params.turb_influence * turbulence_influence, 0.0, 1.0);\\n\";\n+\t\tcode += \"\t\tfloat vel_infl = clamp(dynamic_params.turb_influence * turbulence_influence, 0.0, 1.0) * (DELTA <= 0.0 ? 0.0 : 1.0);\\n\";\n \t\tcode += \"\t\tVELOCITY = mix(VELOCITY, normalize(noise_direction) * vel_mag * (1.0 + (1.0 - vel_infl) * 0.2), vel_infl);\\n\";\n \t\tcode += \"\t\tvel_mag = length(controlled_displacement);\\n\";\n \t\tcode += \"\t\tcontrolled_displacement = mix(controlled_displacement, normalize(noise_direction) * vel_mag * (1.0 + (1.0 - vel_infl) * 0.2), vel_infl);\\n\";\n@@ -1121,9 +1121,16 @@ void ParticleProcessMaterial::_update_shader() {\n \t\tcode += \"\t\tparams.scale *= texture(scale_over_velocity_curve, vec2(0.0)).rgb;\\n\";\n \t\tcode += \"\t}\\n\";\n \t}\n-\tcode += \"\tTRANSFORM[0].xyz *= sign(params.scale.x) * max(abs(params.scale.x), 0.001);\\n\";\n-\tcode += \"\tTRANSFORM[1].xyz *= sign(params.scale.y) * max(abs(params.scale.y), 0.001);\\n\";\n-\tcode += \"\tTRANSFORM[2].xyz *= sign(params.scale.z) * max(abs(params.scale.z), 0.001);\\n\";\n+\t// A scale of 0 results in no emission at some emission amounts (including 3 and 6).\n+\t// `sign(scale)` is unsuitable, because sign(0) returns 0, nullifying the minimum value.\n+\t// The following evaluates to 1 when scale is 0, falling back to a positive minimum value.\n+\tcode += \"\tfloat scale_sign_x = params.scale.x < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_sign_y = params.scale.y < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_sign_z = params.scale.z < 0.0 ? -1.0 : 1.0;\\n\";\n+\tcode += \"\tfloat scale_minimum = 0.001;\\n\";\n+\tcode += \"\tTRANSFORM[0].xyz *= scale_sign_x * max(abs(params.scale.x), scale_minimum);\\n\";\n+\tcode += \"\tTRANSFORM[1].xyz *= scale_sign_y * max(abs(params.scale.y), scale_minimum);\\n\";\n+\tcode += \"\tTRANSFORM[2].xyz *= scale_sign_z * max(abs(params.scale.z), scale_minimum);\\n\";\n \tcode += \"\\n\";\n \tcode += \"\tCUSTOM.z = params.animation_offset + lifetime_percent * params.animation_speed;\\n\\n\";\n \ndiff --git a/scene/theme/default_theme.cpp b/scene/theme/default_theme.cpp\nindex 5ae1e9baa37d..06fe298668f3 100644\n--- a/scene/theme/default_theme.cpp\n+++ b/scene/theme/default_theme.cpp\n@@ -91,6 +91,8 @@ static Ref<ImageTexture> generate_icon(int p_index) {\n \n \tError err = ImageLoaderSVG::create_image_from_string(img, default_theme_icons_sources[p_index], scale, upsample, HashMap<Color, Color>());\n \tERR_FAIL_COND_V_MSG(err != OK, Ref<ImageTexture>(), \"Failed generating icon, unsupported or invalid SVG data in default theme.\");\n+\n+\timg->fix_alpha_edges();\n #else\n \t// If the SVG module is disabled, we can't really display the UI well, but at least we won't crash.\n \t// 16 pixels is used as it's the most common base size for Godot icons.\ndiff --git a/servers/display_server.cpp b/servers/display_server.cpp\nindex c9399d9c65f8..87300bd8b6a2 100644\n--- a/servers/display_server.cpp\n+++ b/servers/display_server.cpp\n@@ -1331,10 +1331,14 @@ bool DisplayServer::is_rendering_device_supported() {\n \n \tError err;\n \n-#ifdef WINDOWS_ENABLED\n-\t// On some NVIDIA drivers combining OpenGL and RenderingDevice can result in crash, offload the check to the subprocess.\n+#if defined(WINDOWS_ENABLED) || defined(LINUXBSD_ENABLED)\n+\t// On some drivers combining OpenGL and RenderingDevice can result in crash, offload the check to the subprocess.\n \tList<String> arguments;\n \targuments.push_back(\"--test-rd-support\");\n+\tif (get_singleton()) {\n+\t\targuments.push_back(\"--display-driver\");\n+\t\targuments.push_back(get_singleton()->get_name().to_lower());\n+\t}\n \n \tString pipe;\n \tint exitcode = 0;\ndiff --git a/servers/rendering/renderer_rd/effects/luminance.cpp b/servers/rendering/renderer_rd/effects/luminance.cpp\nindex 4727e8fd9a9c..ab3ddb67b33b 100644\n--- a/servers/rendering/renderer_rd/effects/luminance.cpp\n+++ b/servers/rendering/renderer_rd/effects/luminance.cpp\n@@ -102,9 +102,10 @@ void Luminance::LuminanceBuffers::configure(RenderSceneBuffersRD *p_render_buffe\n \t\t\ttf.usage_bits = RD::TEXTURE_USAGE_COLOR_ATTACHMENT_BIT | RD::TEXTURE_USAGE_SAMPLING_BIT;\n \t\t} else {\n \t\t\ttf.usage_bits = RD::TEXTURE_USAGE_STORAGE_BIT;\n-\t\t\tif (final) {\n-\t\t\t\ttf.usage_bits |= RD::TEXTURE_USAGE_SAMPLING_BIT;\n-\t\t\t}\n+\t\t}\n+\n+\t\tif (final) {\n+\t\t\ttf.usage_bits |= RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_COPY_TO_BIT;\n \t\t}\n \n \t\tRID texture = RD::get_singleton()->texture_create(tf, RD::TextureView());\n@@ -112,6 +113,7 @@ void Luminance::LuminanceBuffers::configure(RenderSceneBuffersRD *p_render_buffe\n \n \t\tif (final) {\n \t\t\tcurrent = RD::get_singleton()->texture_create(tf, RD::TextureView());\n+\t\t\tRD::get_singleton()->texture_clear(current, Color(0.0, 0.0, 0.0), 0u, 1u, 0u, 1u);\n \t\t\tbreak;\n \t\t}\n \t}\ndiff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 5cea736eeb15..eebc6358ff62 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -1837,7 +1837,7 @@ RendererCanvasRenderRD::RendererCanvasRenderRD() {\n \t\tactions.base_varying_index = 5;\n \n \t\tactions.global_buffer_array_variable = \"global_shader_uniforms.data\";\n-\t\tactions.instance_uniform_index_variable = \"draw_data.instance_uniforms_ofs\";\n+\t\tactions.instance_uniform_index_variable = \"instances.data[instance_index].instance_uniforms_ofs\";\n \n \t\tshader.compiler.initialize(actions);\n \t}\ndiff --git a/servers/rendering/renderer_rd/shader_rd.cpp b/servers/rendering/renderer_rd/shader_rd.cpp\nindex cbdbe151c82f..ed9428a6a351 100644\n--- a/servers/rendering/renderer_rd/shader_rd.cpp\n+++ b/servers/rendering/renderer_rd/shader_rd.cpp\n@@ -555,7 +555,7 @@ void ShaderRD::_compile_version_start(Version *p_version, int p_group) {\n \tcompile_data.version = p_version;\n \tcompile_data.group = p_group;\n \n-\tWorkerThreadPool::GroupID group_task = WorkerThreadPool::get_singleton()->add_template_group_task(this, &ShaderRD::_compile_variant, compile_data, group_to_variant_map[p_group].size(), -1, true, SNAME(\"ShaderCompilation\"));\n+\tWorkerThreadPool::GroupID group_task = WorkerThreadPool::get_named_pool(SNAME(\"ShaderCompilationPool\"))->add_template_group_task(this, &ShaderRD::_compile_variant, compile_data, group_to_variant_map[p_group].size(), -1, true, SNAME(\"ShaderCompilation\"));\n \tp_version->group_compilation_tasks.write[p_group] = group_task;\n }\n \n@@ -563,9 +563,8 @@ void ShaderRD::_compile_version_end(Version *p_version, int p_group) {\n \tif (p_version->group_compilation_tasks.size() <= p_group || p_version->group_compilation_tasks[p_group] == 0) {\n \t\treturn;\n \t}\n-\n \tWorkerThreadPool::GroupID group_task = p_version->group_compilation_tasks[p_group];\n-\tWorkerThreadPool::get_singleton()->wait_for_group_task_completion(group_task);\n+\tWorkerThreadPool::get_named_pool(SNAME(\"ShaderCompilationPool\"))->wait_for_group_task_completion(group_task);\n \tp_version->group_compilation_tasks.write[p_group] = 0;\n \n \tbool all_valid = true;\ndiff --git a/servers/rendering/renderer_rd/shaders/canvas.glsl b/servers/rendering/renderer_rd/shaders/canvas.glsl\nindex c1510a11ca08..e2d9086a5de5 100644\n--- a/servers/rendering/renderer_rd/shaders/canvas.glsl\n+++ b/servers/rendering/renderer_rd/shaders/canvas.glsl\n@@ -48,6 +48,8 @@ layout(set = 1, binding = 0, std140) uniform MaterialUniforms {\n /* clang-format on */\n #endif\n \n+uint instance_index;\n+\n #GLOBALS\n \n #ifdef USE_ATTRIBUTES\n@@ -66,9 +68,9 @@ void main() {\n #endif\n \n #ifdef USE_ATTRIBUTES\n-\tuint instance_index = params.base_instance_index;\n+\tinstance_index = params.base_instance_index;\n #else\n-\tuint instance_index = gl_InstanceIndex + params.base_instance_index;\n+\tinstance_index = gl_InstanceIndex + params.base_instance_index;\n \tinstance_index_interp = instance_index;\n #endif // USE_ATTRIBUTES\n \tconst InstanceData draw_data = instances.data[instance_index];\n@@ -240,7 +242,7 @@ void main() {\n #include \"canvas_uniforms_inc.glsl\"\n \n #ifndef USE_ATTRIBUTES\n-layout(location = 4) in flat uint instance_index;\n+layout(location = 4) in flat uint instance_index_interp;\n #endif // USE_ATTRIBUTES\n \n layout(location = 0) in vec2 uv_interp;\n@@ -287,6 +289,8 @@ vec2 sdf_to_screen_uv(vec2 p_sdf) {\n \treturn p_sdf * canvas_data.sdf_to_screen;\n }\n \n+uint instance_index;\n+\n #GLOBALS\n \n #ifdef LIGHT_CODE_USED\n@@ -302,6 +306,7 @@ vec4 light_compute(\n \t\tvec2 screen_uv,\n \t\tvec2 uv,\n \t\tvec4 color, bool is_directional) {\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \tvec4 light = vec4(0.0);\n \tvec3 light_direction = vec3(0.0);\n \n@@ -461,10 +466,11 @@ void main() {\n \tvec2 vertex = vertex_interp;\n \n #ifdef USE_ATTRIBUTES\n-\tconst InstanceData draw_data = instances.data[params.base_instance_index];\n+\tinstance_index = params.base_instance_index;\n #else\n-\tconst InstanceData draw_data = instances.data[instance_index];\n+\tinstance_index = instance_index_interp;\n #endif // USE_ATTRIBUTES\n+\tconst InstanceData draw_data = instances.data[instance_index];\n \n #if !defined(USE_ATTRIBUTES) && !defined(USE_PRIMITIVE)\n \ndiff --git a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\nindex d82ffed646a0..6924f11e346c 100644\n--- a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n@@ -814,7 +814,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \t\tp_particles->particles_material_uniform_set = RD::get_singleton()->uniform_set_create(uniforms, particles_shader.default_shader_rd, 1);\n \t}\n \n-\tdouble new_phase = Math::fmod((double)p_particles->phase + (p_delta / p_particles->lifetime) * p_particles->speed_scale, 1.0);\n+\tdouble new_phase = Math::fmod((double)p_particles->phase + (p_delta / p_particles->lifetime), 1.0);\n \n \t//move back history (if there is any)\n \tfor (uint32_t i = p_particles->frame_history.size() - 1; i > 0; i--) {\n@@ -839,7 +839,7 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \tp_particles->phase = new_phase;\n \n \tframe_params.time = RendererCompositorRD::get_singleton()->get_total_time();\n-\tframe_params.delta = p_delta * p_particles->speed_scale;\n+\tframe_params.delta = p_delta;\n \tframe_params.random_seed = p_particles->random_seed;\n \tframe_params.explosiveness = p_particles->explosiveness;\n \tframe_params.randomness = p_particles->randomness;\n@@ -1158,6 +1158,10 @@ void ParticlesStorage::_particles_process(Particles *p_particles, double p_delta\n \t\t//fill the trail params\n \t\tfor (uint32_t i = 0; i < p_particles->trail_params.size(); i++) {\n \t\t\tuint32_t src_idx = i * p_particles->frame_history.size() / p_particles->trail_params.size();\n+\t\t\tif (p_particles->speed_scale <= 0.0) {\n+\t\t\t\t// Stop trails.\n+\t\t\t\tsrc_idx = 0;\n+\t\t\t}\n \t\t\tp_particles->trail_params[i] = p_particles->frame_history[src_idx];\n \t\t}\n \t} else {\n@@ -1529,7 +1533,6 @@ void ParticlesStorage::update_particles() {\n \t\t\t}\n \t\t}\n \n-\t\tbool zero_time_scale = Engine::get_singleton()->get_time_scale() <= 0.0;\n \t\tdouble todo = particles->request_process_time;\n \t\tif (particles->clear) {\n \t\t\ttodo += particles->pre_process_time;\n@@ -1554,37 +1557,26 @@ void ParticlesStorage::update_particles() {\n \t\t\tparticles->speed_scale = tmp_scale;\n \t\t}\n \n+\t\tdouble time_scale = MAX(particles->speed_scale, 0.0);\n+\n \t\tif (fixed_fps > 0) {\n-\t\t\tdouble frame_time;\n-\t\t\tdouble decr;\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\tframe_time = 0.0;\n-\t\t\t\tdecr = 1.0 / fixed_fps;\n-\t\t\t} else {\n-\t\t\t\tframe_time = 1.0 / fixed_fps;\n-\t\t\t\tdecr = frame_time;\n-\t\t\t}\n+\t\t\tdouble frame_time = 1.0 / fixed_fps;\n \t\t\tdouble delta = RendererCompositorRD::get_singleton()->get_frame_delta_time();\n \t\t\tif (delta > 0.1) { //avoid recursive stalls if fps goes below 10\n \t\t\t\tdelta = 0.1;\n \t\t\t} else if (delta <= 0.0) { //unlikely but..\n \t\t\t\tdelta = 0.001;\n \t\t\t}\n-\t\t\ttodo = particles->frame_remainder + delta;\n+\t\t\ttodo = particles->frame_remainder + delta * time_scale;\n \n \t\t\twhile (todo >= frame_time || particles->clear) {\n \t\t\t\t_particles_process(particles, frame_time);\n-\t\t\t\ttodo -= decr;\n+\t\t\t\ttodo -= frame_time;\n \t\t\t}\n \n \t\t\tparticles->frame_remainder = todo;\n-\n \t\t} else {\n-\t\t\tif (zero_time_scale) {\n-\t\t\t\t_particles_process(particles, 0.0);\n-\t\t\t} else {\n-\t\t\t\t_particles_process(particles, RendererCompositorRD::get_singleton()->get_frame_delta_time());\n-\t\t\t}\n+\t\t\t_particles_process(particles, RendererCompositorRD::get_singleton()->get_frame_delta_time() * time_scale);\n \t\t}\n \n \t\t// Ensure that memory is initialized (the code above should ensure that _particles_process is always called at least once upon clearing).\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\nindex 02b28473951e..6808ebb06376 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n@@ -1275,15 +1275,21 @@ RID TextureStorage::texture_create_from_native_handle(RS::TextureType p_type, Im\n \t\t\tbreak;\n \n \t\tcase Image::FORMAT_ASTC_4x4:\n-\t\tcase Image::FORMAT_ASTC_4x4_HDR:\n \t\t\tformat = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n \t\t\tbreak;\n \n+\t\tcase Image::FORMAT_ASTC_4x4_HDR:\n+\t\t\tformat = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\tbreak;\n+\n \t\tcase Image::FORMAT_ASTC_8x8:\n-\t\tcase Image::FORMAT_ASTC_8x8_HDR:\n \t\t\tformat = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n \t\t\tbreak;\n \n+\t\tcase Image::FORMAT_ASTC_8x8_HDR:\n+\t\t\tformat = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\tbreak;\n+\n \t\tdefault:\n \t\t\t// Arbitrary fallback.\n \t\t\tformat = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n@@ -2197,24 +2203,16 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_ZERO;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_ONE;\n \t\t} break;\n-\t\tcase Image::FORMAT_ASTC_4x4:\n-\t\tcase Image::FORMAT_ASTC_4x4_HDR: {\n+\t\tcase Image::FORMAT_ASTC_4x4: {\n \t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n \t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_4x4) {\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n-\t\t\t\t}\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n \t\t\t} else {\n \t\t\t\t//not supported, reconvert\n \t\t\t\timage->decompress();\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_4x4) {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n-\t\t\t\t} else {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n-\t\t\t\t}\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n+\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n \t\t\t}\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n@@ -2222,24 +2220,31 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n \t\t} break; // astc 4x4\n-\t\tcase Image::FORMAT_ASTC_8x8:\n-\t\tcase Image::FORMAT_ASTC_8x8_HDR: {\n+\t\tcase Image::FORMAT_ASTC_4x4_HDR: {\n+\t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\t} else {\n+\t\t\t\t//not supported, reconvert\n+\t\t\t\timage->decompress();\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n+\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n+\t\t\t}\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n+\n+\t\t} break; // astc 4x4 HDR\n+\t\tcase Image::FORMAT_ASTC_8x8: {\n \t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n \t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_8x8) {\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n-\t\t\t\t}\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n \t\t\t} else {\n \t\t\t\t//not supported, reconvert\n \t\t\t\timage->decompress();\n-\t\t\t\tif (p_image->get_format() == Image::FORMAT_ASTC_8x8) {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n-\t\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n-\t\t\t\t} else {\n-\t\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n-\t\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n-\t\t\t\t}\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R8G8B8A8_UNORM;\n+\t\t\t\tr_format.format_srgb = RD::DATA_FORMAT_R8G8B8A8_SRGB;\n+\t\t\t\timage->convert(Image::FORMAT_RGBA8);\n \t\t\t}\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n@@ -2247,6 +2252,21 @@ Ref<Image> TextureStorage::_validate_texture_format(const Ref<Image> &p_image, T\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n \t\t} break; // astc 8x8\n+\t\tcase Image::FORMAT_ASTC_8x8_HDR: {\n+\t\t\tif (RD::get_singleton()->texture_is_format_supported_for_usage(RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK, RD::TEXTURE_USAGE_SAMPLING_BIT | RD::TEXTURE_USAGE_CAN_UPDATE_BIT)) {\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\t} else {\n+\t\t\t\t//not supported, reconvert\n+\t\t\t\timage->decompress();\n+\t\t\t\tr_format.format = RD::DATA_FORMAT_R16G16B16A16_SFLOAT;\n+\t\t\t\timage->convert(Image::FORMAT_RGBAH);\n+\t\t\t}\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n+\n+\t\t} break; // astc 8x8 HDR\n \n \t\tdefault: {\n \t\t}\n@@ -2589,7 +2609,7 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break;\n \t\tcase RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK: {\n-\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4_HDR;\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4;\n \t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_4x4_UNORM_BLOCK;\n \t\t\tr_format.rd_format_srgb = RD::DATA_FORMAT_ASTC_4x4_SRGB_BLOCK;\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n@@ -2597,6 +2617,14 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \n+\t\t} break;\n+\t\tcase RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK: {\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_4x4_HDR;\n+\t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK;\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break; // astc 4x4\n \t\tcase RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK: {\n \t\t\t// Q: Do we do as we do below, just create the sRGB variant?\n@@ -2608,14 +2636,21 @@ void TextureStorage::_texture_format_from_rd(RD::DataFormat p_rd_format, Texture\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break;\n \t\tcase RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK: {\n-\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8_HDR;\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8;\n \t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_8x8_UNORM_BLOCK;\n \t\t\tr_format.rd_format_srgb = RD::DATA_FORMAT_ASTC_8x8_SRGB_BLOCK;\n \t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n \t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n \t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n \t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n-\n+\t\t} break;\n+\t\tcase RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n+\t\t\tr_format.image_format = Image::FORMAT_ASTC_8x8_HDR;\n+\t\t\tr_format.rd_format = RD::DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK;\n+\t\t\tr_format.swizzle_r = RD::TEXTURE_SWIZZLE_R;\n+\t\t\tr_format.swizzle_g = RD::TEXTURE_SWIZZLE_G;\n+\t\t\tr_format.swizzle_b = RD::TEXTURE_SWIZZLE_B;\n+\t\t\tr_format.swizzle_a = RD::TEXTURE_SWIZZLE_A;\n \t\t} break; // astc 8x8\n \n \t\tdefault: {\ndiff --git a/servers/rendering/renderer_viewport.cpp b/servers/rendering/renderer_viewport.cpp\nindex b816ca7a8ab2..3bbc05b62545 100644\n--- a/servers/rendering/renderer_viewport.cpp\n+++ b/servers/rendering/renderer_viewport.cpp\n@@ -141,12 +141,22 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_OFF;\n \t\t\t}\n \n-\t\t\t// Verify MetalFX upscaling support.\n-\t\t\tif (\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) ||\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL))) {\n-\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported in the current renderer. Falling back to bilinear 3D resolution scaling.\");\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) {\n+\t\t\t\tif (RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\t\t// Prefer MetalFX spatial if it is supported, which will be much more efficient than FSR2,\n+\t\t\t\t\t// as the hardware already will struggle with FSR2.\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling is not supported by the current renderer or hardware. Falling back to MetalFX Spatial scaling.\");\n+\t\t\t\t} else {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported by the current renderer or hardware. Falling back to FSR 2 scaling.\");\n+\t\t\t\t}\n+\t\t\t\tscaling_type = RS::scaling_3d_mode_type(scaling_3d_mode);\n+\t\t\t}\n+\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR;\n+\t\t\t\tWARN_PRINT_ONCE(\"MetalFX spatial upscaling is not supported by the current renderer or hardware. Falling back to FSR scaling.\");\n \t\t\t}\n \n \t\t\tRS::ViewportMSAA msaa_3d = p_viewport->msaa_3d;\n@@ -156,11 +166,9 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tdouble min_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MIN_SCALE) / 1000'000.0;\n \t\t\t\tdouble max_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MAX_SCALE) / 1000'000.0;\n \t\t\t\tif ((double)scaling_3d_scale < min_scale || (double)scaling_3d_scale > max_scale) {\n-\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to bilinear 3D resolution scaling.\", min_scale, max_scale));\n-\t\t\t\t}\n-\n-\t\t\t\tif (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to FSR 2 3D resolution scaling.\", min_scale, max_scale));\n+\t\t\t\t} else if (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n \t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling does not support 3D MSAA. Disabling 3D MSAA internally.\");\n \t\t\t\t\tmsaa_3d = RS::VIEWPORT_MSAA_DISABLED;\n \t\t\t\t}\n@@ -170,7 +178,7 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\tbool use_taa = p_viewport->use_taa;\n \n \t\t\tif (scaling_3d_is_not_bilinear && (scaling_3d_scale >= (1.0 + EPSILON))) {\n-\t\t\t\t// FSR is not designed for downsampling.\n+\t\t\t\t// FSR and MetalFX is not designed for downsampling.\n \t\t\t\t// Fall back to bilinear scaling.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 3D resolution scaling is not designed for downsampling. Falling back to bilinear 3D resolution scaling.\");\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n@@ -184,8 +192,8 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t}\n \n \t\t\tif (use_taa && (scaling_type == RS::VIEWPORT_SCALING_3D_TYPE_TEMPORAL)) {\n-\t\t\t\t// FSR2 can't be used with TAA.\n-\t\t\t\t// Turn it off and prefer using FSR2.\n+\t\t\t\t// Temporal upscalers can't be used with TAA.\n+\t\t\t\t// Turn it off and prefer using the temporal upscaler.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 2 or MetalFX Temporal is not compatible with TAA. Disabling TAA internally.\");\n \t\t\t\tuse_taa = false;\n \t\t\t}\ndiff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9a3e4fd9d7fa..cf6cbf187132 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -7680,6 +7680,20 @@ void RenderingDevice::_bind_methods() {\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16R16_2PLANE_422_UNORM);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK);\n+\tBIND_ENUM_CONSTANT(DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK);\n \tBIND_ENUM_CONSTANT(DATA_FORMAT_MAX);\n \n #ifndef DISABLE_DEPRECATED\ndiff --git a/servers/rendering/rendering_device_commons.cpp b/servers/rendering/rendering_device_commons.cpp\nindex 03fad5493a01..a11ffe57dd15 100644\n--- a/servers/rendering/rendering_device_commons.cpp\n+++ b/servers/rendering/rendering_device_commons.cpp\n@@ -253,6 +253,20 @@ const char *const RenderingDeviceCommons::FORMAT_NAMES[DATA_FORMAT_MAX] = {\n \t\"G16_B16_R16_3Plane_422_Unorm\",\n \t\"G16_B16R16_2Plane_422_Unorm\",\n \t\"G16_B16_R16_3Plane_444_Unorm\",\n+\t\"Astc_4X4_Sfloat_Block\",\n+\t\"Astc_5X4_Sfloat_Block\",\n+\t\"Astc_5X5_Sfloat_Block\",\n+\t\"Astc_6X5_Sfloat_Block\",\n+\t\"Astc_6X6_Sfloat_Block\",\n+\t\"Astc_8X5_Sfloat_Block\",\n+\t\"Astc_8X6_Sfloat_Block\",\n+\t\"Astc_8X8_Sfloat_Block\",\n+\t\"Astc_10X5_Sfloat_Block\",\n+\t\"Astc_10X6_Sfloat_Block\",\n+\t\"Astc_10X8_Sfloat_Block\",\n+\t\"Astc_10X10_Sfloat_Block\",\n+\t\"Astc_12X10_Sfloat_Block\",\n+\t\"Astc_12X12_Sfloat_Block\",\n };\n \n /*****************/\n@@ -477,6 +491,20 @@ uint32_t RenderingDeviceCommons::get_image_format_pixel_size(DataFormat p_format\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\treturn 1;\n \t\tcase DATA_FORMAT_G8B8G8R8_422_UNORM:\n \t\tcase DATA_FORMAT_B8G8R8G8_422_UNORM:\n@@ -554,42 +582,56 @@ void RenderingDeviceCommons::get_compressed_image_format_block_dimensions(DataFo\n \t\tcase DATA_FORMAT_EAC_R11G11_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_EAC_R11G11_SNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_4x4_UNORM_BLOCK: // Again, not sure about astc.\n-\t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK: {\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_5x4_UNORM_BLOCK: // Unsupported\n \t\tcase DATA_FORMAT_ASTC_5x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_UNORM_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK: {\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n \t\t\tr_w = 8;\n \t\t\tr_h = 8;\n \t\t} break;\n \t\tcase DATA_FORMAT_ASTC_10x5_UNORM_BLOCK: // Unsupported\n \t\tcase DATA_FORMAT_ASTC_10x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\tr_w = 4;\n \t\t\tr_h = 4;\n \t\t\treturn;\n@@ -642,32 +684,46 @@ uint32_t RenderingDeviceCommons::get_compressed_image_format_block_byte_size(Dat\n \t\t\treturn 16;\n \t\tcase DATA_FORMAT_ASTC_4x4_UNORM_BLOCK: // Again, not sure about astc.\n \t\tcase DATA_FORMAT_ASTC_4x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x4_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x4_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_5x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_6x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x5_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x5_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x6_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x8_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_10x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x10_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_UNORM_BLOCK:\n \t\tcase DATA_FORMAT_ASTC_12x12_SRGB_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK:\n \t\t\treturn 16;\n \t\tdefault: {\n \t\t}\n@@ -691,7 +747,8 @@ uint32_t RenderingDeviceCommons::get_compressed_image_format_pixel_rshift(DataFo\n \t\tcase DATA_FORMAT_EAC_R11_SNORM_BLOCK:\n \t\t\treturn 1;\n \t\tcase DATA_FORMAT_ASTC_8x8_SRGB_BLOCK:\n-\t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK: {\n+\t\tcase DATA_FORMAT_ASTC_8x8_UNORM_BLOCK:\n+\t\tcase DATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK: {\n \t\t\treturn 2;\n \t\t}\n \t\tdefault: {\ndiff --git a/servers/rendering/rendering_device_commons.h b/servers/rendering/rendering_device_commons.h\nindex aa8beed35785..796e3c2b66c6 100644\n--- a/servers/rendering/rendering_device_commons.h\n+++ b/servers/rendering/rendering_device_commons.h\n@@ -270,6 +270,20 @@ class RenderingDeviceCommons : public Object {\n \t\tDATA_FORMAT_G16_B16_R16_3PLANE_422_UNORM,\n \t\tDATA_FORMAT_G16_B16R16_2PLANE_422_UNORM,\n \t\tDATA_FORMAT_G16_B16_R16_3PLANE_444_UNORM,\n+\t\tDATA_FORMAT_ASTC_4x4_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_5x4_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_5x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_6x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_6x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_8x8_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x5_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x6_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x8_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_10x10_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_12x10_SFLOAT_BLOCK, // HDR variant.\n+\t\tDATA_FORMAT_ASTC_12x12_SFLOAT_BLOCK, // HDR variant.\n \t\tDATA_FORMAT_MAX,\n \t};\n \ndiff --git a/servers/rendering/shader_language.cpp b/servers/rendering/shader_language.cpp\nindex 59adb53b7866..66a43684a52a 100644\n--- a/servers/rendering/shader_language.cpp\n+++ b/servers/rendering/shader_language.cpp\n@@ -1342,7 +1342,7 @@ void ShaderLanguage::_parse_used_identifier(const StringName &p_identifier, Iden\n \t\t\tbreak;\n \t\tcase IdentifierType::IDENTIFIER_VARYING:\n \t\t\tif (HAS_WARNING(ShaderWarning::UNUSED_VARYING_FLAG) && used_varyings.has(p_identifier)) {\n-\t\t\t\tif (shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_VERTEX && shader->varyings[p_identifier].stage != ShaderNode::Varying::STAGE_FRAGMENT) {\n+\t\t\t\tif (shader->varyings[p_identifier].stage == ShaderNode::Varying::STAGE_UNKNOWN) {\n \t\t\t\t\tused_varyings[p_identifier].used = true;\n \t\t\t\t}\n \t\t\t}\n@@ -6510,6 +6510,27 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t_set_error(RTR(\"Expected constant expression.\"));\n \t\t\t\t\t\treturn nullptr;\n \t\t\t\t\t}\n+\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n+\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n+\t\t\t\t\t\treturn nullptr;\n+\t\t\t\t\t}\n+#ifdef DEBUG_ENABLED\n+\t\t\t\t\tif (check_warnings) {\n+\t\t\t\t\t\tStringName func_name;\n+\t\t\t\t\t\tBlockNode *b = p_block;\n+\n+\t\t\t\t\t\twhile (b) {\n+\t\t\t\t\t\t\tif (b->parent_function) {\n+\t\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n+\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\tb = b->parent_block;\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n+\n+\t\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n+\t\t\t\t\t}\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (ident_type == IDENTIFIER_VARYING) {\n \t\t\t\t\t\tTkPos prev_pos = _get_tkpos();\n \t\t\t\t\t\tToken next_token = _get_token();\n@@ -6542,11 +6563,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-\n-\t\t\t\t\tif (ident_type == IDENTIFIER_FUNCTION) {\n-\t\t\t\t\t\t_set_error(vformat(RTR(\"Can't use function as identifier: '%s'.\"), String(identifier)));\n-\t\t\t\t\t\treturn nullptr;\n-\t\t\t\t\t}\n #ifdef DEBUG_ENABLED\n \t\t\t\t\tif (check_position_write && ident_type == IDENTIFIER_BUILTIN_VAR) {\n \t\t\t\t\t\tif (String(identifier) == \"POSITION\") {\n@@ -6564,7 +6580,7 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\t\t\t_set_tkpos(prev_pos);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n-#endif\n+#endif // DEBUG_ENABLED\n \t\t\t\t\tif (is_const) {\n \t\t\t\t\t\tlast_type = IDENTIFIER_CONSTANT;\n \t\t\t\t\t} else {\n@@ -6656,23 +6672,6 @@ ShaderLanguage::Node *ShaderLanguage::_parse_expression(BlockNode *p_block, cons\n \t\t\t\t\tvarname->is_local = is_local;\n \t\t\t\t\texpr = varname;\n \t\t\t\t}\n-#ifdef DEBUG_ENABLED\n-\t\t\t\tif (check_warnings) {\n-\t\t\t\t\tStringName func_name;\n-\t\t\t\t\tBlockNode *b = p_block;\n-\n-\t\t\t\t\twhile (b) {\n-\t\t\t\t\t\tif (b->parent_function) {\n-\t\t\t\t\t\t\tfunc_name = b->parent_function->name;\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tb = b->parent_block;\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\n-\t\t\t\t\t_parse_used_identifier(identifier, ident_type, func_name);\n-\t\t\t\t}\n-#endif // DEBUG_ENABLED\n \t\t\t}\n \t\t} else if (tk.type == TK_OP_ADD) {\n \t\t\tcontinue; //this one does nothing\ndiff --git a/thirdparty/misc/yuv2rgb.h b/thirdparty/misc/yuv2rgb.h\nindex d8f7fd6de2d0..e8ccd427d027 100644\n--- a/thirdparty/misc/yuv2rgb.h\n+++ b/thirdparty/misc/yuv2rgb.h\n@@ -30,6 +30,7 @@ ship it.\n  * 2. At some point or another the code relied on the byte order of a uint32_t, this has been fixed\n  * 3. Output has been reordered to struct { uint8_t r, g, b, a; } precisely in accordance with the function names\n  * 4. Removing unused 'dither' parameter\n+ * 5. Fix last line not being converted (and therefore was transparent)\n  */\n \n #ifndef YUV2RGB_H\n@@ -848,7 +849,6 @@ static void yuv422_2_rgb8888(uint8_t  *dst_ptr,\n \t\t      int32_t   uv_span,\n \t\t      int32_t   dst_span)\n {\n-    height -= 1;\n     while (height > 0)\n     {\n \theight -= width<<16;\n@@ -1020,7 +1020,6 @@ static void yuv444_2_rgb8888(uint8_t  *dst_ptr,\n \t\t      int32_t   uv_span,\n \t\t      int32_t   dst_span)\n {\n-    height -= 1;\n     while (height > 0)\n     {\n \theight -= width<<16;\ndiff --git a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\nindex d29ac01af384..25ce813968f7 100644\n--- a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n+++ b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n@@ -31,11 +31,12 @@\n \n // There are separate versions for each GameSDK component that use this format:\n #define ANDROID_GAMESDK_PACKED_VERSION(MAJOR, MINOR, BUGFIX) \\\n-    ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n+  ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n // Accessors\n #define ANDROID_GAMESDK_MAJOR_VERSION(PACKED) ((PACKED) >> 16)\n #define ANDROID_GAMESDK_MINOR_VERSION(PACKED) (((PACKED) >> 8) & 0xff)\n #define ANDROID_GAMESDK_BUGFIX_VERSION(PACKED) ((PACKED) & 0xff)\n \n-#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX, GIT) \\\n-#MAJOR \".\" #MINOR \".\" #BUGFIX \".\" #GIT\n+#define AGDK_STRINGIFY(NUMBER) #NUMBER\n+#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX) \\\n+  AGDK_STRINGIFY(MAJOR) \".\" AGDK_STRINGIFY(MINOR) \".\" AGDK_STRINGIFY(BUGFIX)\ndiff --git a/thirdparty/swappy-frame-pacing/swappyVk.h b/thirdparty/swappy-frame-pacing/swappyVk.h\nindex 020683cbc43c..654fcbf4a4a7 100644\n--- a/thirdparty/swappy-frame-pacing/swappyVk.h\n+++ b/thirdparty/swappy-frame-pacing/swappyVk.h\n@@ -281,30 +281,30 @@ void SwappyVk_uninjectTracer(const SwappyTracer* tracer);\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyVkFunctionProvider {\n-    /**\n-     * @brief Callback to initialize the function provider.\n-     *\n-     * This function is called by Swappy before any functions are requested.\n-     * E.g. so you can call dlopen on the Vulkan library.\n-     */\n-    bool (*init)();\n-\n-    /**\n-     * @brief Callback to get the address of a function.\n-     *\n-     * This function is called by Swappy to get the address of a Vulkan\n-     * function.\n-     * @param name The null-terminated name of the function.\n-     */\n-    void* (*getProcAddr)(const char* name);\n-\n-    /**\n-     * @brief Callback to close any resources owned by the function provider.\n-     *\n-     * This function is called by Swappy when no more functions will be\n-     * requested, e.g. so you can call dlclose on the Vulkan library.\n-     */\n-    void (*close)();\n+  /**\n+   * @brief Callback to initialize the function provider.\n+   *\n+   * This function is called by Swappy before any functions are requested.\n+   * E.g. so you can call dlopen on the Vulkan library.\n+   */\n+  bool (*init)();\n+\n+  /**\n+   * @brief Callback to get the address of a function.\n+   *\n+   * This function is called by Swappy to get the address of a Vulkan\n+   * function.\n+   * @param name The null-terminated name of the function.\n+   */\n+  void* (*getProcAddr)(const char* name);\n+\n+  /**\n+   * @brief Callback to close any resources owned by the function provider.\n+   *\n+   * This function is called by Swappy when no more functions will be\n+   * requested, e.g. so you can call dlclose on the Vulkan library.\n+   */\n+  void (*close)();\n } SwappyVkFunctionProvider;\n \n /**\n@@ -384,7 +384,8 @@ void SwappyVk_enableStats(VkSwapchainKHR swapchain, bool enabled);\n \n  * @see SwappyVk_enableStats.\n  */\n-void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t image);\n+void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain,\n+                               uint32_t image);\n \n /**\n  * @brief Returns the stats collected, if statistics collection was toggled on.\n@@ -396,11 +397,11 @@ void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t\n  * conditions.\n  *\n  * @param[in]  swapchain   - The swapchain for which stats are being queried.\n- * @param      swappyStats - Pointer to a SwappyStats that will be populated with\n- *                             the collected stats. Cannot be NULL.\n+ * @param      swappyStats - Pointer to a SwappyStats that will be populated\n+ * with the collected stats. Cannot be NULL.\n  * @see SwappyStats\n  */\n-void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n+void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats* swappyStats);\n \n /**\n  * @brief Clears the frame statistics collected so far.\n@@ -413,6 +414,58 @@ void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n  */\n void SwappyVk_clearStats(VkSwapchainKHR swapchain);\n \n+/**\n+ * @brief Reset the swappy pacing mechanism\n+ *\n+ * In cases where the frame timing history is irrelevant (for example during\n+ * scene/level transitions or after loading screens), calling this would\n+ * remove all the history for frame pacing. Calling this entry point\n+ * would reset the frame rate to the initial state at the end of the current\n+ * frame. Then swappy would just pace as normal with fresh state from next\n+ * frame. There are no error conditions associated with this call.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which frame pacing is reset.\n+ */\n+void SwappyVk_resetFramePacing(VkSwapchainKHR swapchain);\n+\n+/**\n+ * @brief Enable/Disable the swappy pacing mechanism\n+ *\n+ * By default frame pacing is enabled when swappy is used, however it can be\n+ * disabled at runtime by calling `SwappyVk_enableFramePacing(swapchain,\n+ * false)`. When the frame pacing is disabled, ::SwappyVk_enableBlockingWait\n+ * will control whether\n+ * ::SwappyVk_queuePresent will return immediately, or will block until the\n+ * previous frame's GPU work is completed. All enabling/disabling effects take\n+ * place from next frame. Once disabled, `SwappyVk_enableFramePacing(swapchain,\n+ * true)` will enable frame pacing again with a fresh frame time state -\n+ * equivalent of calling ::SwappyVk_resetFramePacing().\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, enables frame pacing otherwise disables it\n+ */\n+void SwappyVk_enableFramePacing(VkSwapchainKHR swapchain, bool enable);\n+\n+/**\n+ * @brief Enable/Disable blocking wait when frame-pacing is disabled\n+ *\n+ * By default ::SwappyVk_queuePresent will do a blocking wait until previous\n+ * frame's GPU work is completed. However when frame pacing is disabled, calling\n+ * `SwappyVk_enableBlockingWait(swapchain, false)` will ensure that\n+ * ::SwappyVk_queuePresent returns without waiting for previous frame's GPU\n+ * work. This behaviour impacts the GPU time returned in the\n+ * ::SwappyPostWaitCallback callback. If the last frame's GPU work is done by\n+ * the time ::SwappyVk_queuePresent for this frame is called, then the previous\n+ * frame's GPU time will be returned otherwise `-1` will be delivered in the\n+ * callback for the frame. This setting has no impact when frame pacing is\n+ * enabled.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, ::SwappyVk_queuePresent will block until\n+ * the previous frame's GPU work is complete.\n+ */\n+void SwappyVk_enableBlockingWait(VkSwapchainKHR swapchain, bool enable);\n+\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\ndiff --git a/thirdparty/swappy-frame-pacing/swappy_common.h b/thirdparty/swappy-frame-pacing/swappy_common.h\nindex b711ca910fb3..acceb4243df6 100644\n--- a/thirdparty/swappy-frame-pacing/swappy_common.h\n+++ b/thirdparty/swappy-frame-pacing/swappy_common.h\n@@ -48,22 +48,22 @@\n \n // Internal macros to track Swappy version, do not use directly.\n #define SWAPPY_MAJOR_VERSION 2\n-#define SWAPPY_MINOR_VERSION 0\n+#define SWAPPY_MINOR_VERSION 2\n #define SWAPPY_BUGFIX_VERSION 0\n-#define SWAPPY_PACKED_VERSION                                                  \\\n-    ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n-                                   SWAPPY_BUGFIX_VERSION)\n+#define SWAPPY_PACKED_VERSION                                                \\\n+  ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n+                                 SWAPPY_BUGFIX_VERSION)\n \n // Internal macros to generate a symbol to track Swappy version, do not use\n // directly.\n #define SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n+  PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n #define SWAPPY_VERSION_CONCAT(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n-#define SWAPPY_VERSION_SYMBOL                                          \\\n-    SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n-                          SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n-                          AGDK_GIT_COMMIT)\n+  SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n+#define SWAPPY_VERSION_SYMBOL                                        \\\n+  SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n+                        SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n+                        AGDK_GIT_COMMIT)\n \n // Define this to 1 to enable all logging from Swappy, by default it is\n // disabled in a release build and enabled in a debug build.\n@@ -83,29 +83,29 @@ typedef uint64_t SwappyThreadId;\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyThreadFunctions {\n-    /** @brief Thread start callback.\n-     *\n-     * This function is called by Swappy to start thread_func on a new thread.\n-     * @param user_data A value to be passed the thread function.\n-     * If the thread was started, this function should set the thread_id and\n-     * return 0. If the thread was not started, this function should return a\n-     * non-zero value.\n-     */\n-    int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n-                 void* user_data);\n-\n-    /** @brief Thread join callback.\n-     *\n-     * This function is called by Swappy to join the thread with given id.\n-     */\n-    void (*join)(SwappyThreadId thread_id);\n-\n-    /** @brief Thread joinable callback.\n-     *\n-     * This function is called by Swappy to discover whether the thread with the\n-     * given id is joinable.\n-     */\n-    bool (*joinable)(SwappyThreadId thread_id);\n+  /** @brief Thread start callback.\n+   *\n+   * This function is called by Swappy to start thread_func on a new thread.\n+   * @param user_data A value to be passed the thread function.\n+   * If the thread was started, this function should set the thread_id and\n+   * return 0. If the thread was not started, this function should return a\n+   * non-zero value.\n+   */\n+  int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n+               void* user_data);\n+\n+  /** @brief Thread join callback.\n+   *\n+   * This function is called by Swappy to join the thread with given id.\n+   */\n+  void (*join)(SwappyThreadId thread_id);\n+\n+  /** @brief Thread joinable callback.\n+   *\n+   * This function is called by Swappy to discover whether the thread with the\n+   * given id is joinable.\n+   */\n+  bool (*joinable)(SwappyThreadId thread_id);\n } SwappyThreadFunctions;\n \n #ifdef __cplusplus\n@@ -138,47 +138,46 @@ const char* Swappy_versionString();\n  * ::SwappyGL_enableStats or ::SwappyVk_enableStats.\n  */\n typedef struct SwappyStats {\n-    /** @brief Total frames swapped by swappy */\n-    uint64_t totalFrames;\n-\n-    /** @brief Histogram of the number of screen refreshes a frame waited in the\n-     * compositor queue after rendering was completed.\n-     *\n-     * For example:\n-     *     if a frame waited 2 refresh periods in the compositor queue after\n-     * rendering was done, the frame will be counted in idleFrames[2]\n-     */\n-    uint64_t idleFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * requested presentation time and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the requested\n-     * timestamp swappy set, the frame will be counted in lateFrames[2]\n-     */\n-    uint64_t lateFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between two\n-     * consecutive frames\n-     *\n-     * For example:\n-     *     if frame N was presented 2 refresh periods after frame N-1\n-     *     frame N will be counted in offsetFromPreviousFrame[2]\n-     */\n-    uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * call to Swappy_recordFrameStart and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the call to\n-     * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n-     */\n-    uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n+  /** @brief Total frames swapped by swappy */\n+  uint64_t totalFrames;\n+\n+  /** @brief Histogram of the number of screen refreshes a frame waited in the\n+   * compositor queue after rendering was completed.\n+   *\n+   * For example:\n+   *     if a frame waited 2 refresh periods in the compositor queue after\n+   * rendering was done, the frame will be counted in idleFrames[2]\n+   */\n+  uint64_t idleFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * requested presentation time and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the requested\n+   * timestamp swappy set, the frame will be counted in lateFrames[2]\n+   */\n+  uint64_t lateFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between two\n+   * consecutive frames\n+   *\n+   * For example:\n+   *     if frame N was presented 2 refresh periods after frame N-1\n+   *     frame N will be counted in offsetFromPreviousFrame[2]\n+   */\n+  uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * call to Swappy_recordFrameStart and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the call to\n+   * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n+   */\n+  uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n } SwappyStats;\n \n-\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\n@@ -236,43 +235,43 @@ typedef void (*SwappySwapIntervalChangedCallback)(void*);\n  * Injection of these is optional.\n  */\n typedef struct SwappyTracer {\n-    /**\n-     * Callback called before waiting to queue the frame to the composer.\n-     */\n-    SwappyPreWaitCallback preWait;\n-\n-    /**\n-     * Callback called after wait to queue the frame to the composer is done.\n-     */\n-    SwappyPostWaitCallback postWait;\n-\n-    /**\n-     * Callback called before calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPreSwapBuffersCallback preSwapBuffers;\n-\n-    /**\n-     * Callback called after calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPostSwapBuffersCallback postSwapBuffers;\n-\n-    /**\n-     * Callback called at the start of a frame.\n-     */\n-    SwappyStartFrameCallback startFrame;\n-\n-    /**\n-     * Pointer to some arbitrary data that will be passed as the first argument\n-     * of callbacks.\n-     */\n-    void* userData;\n-\n-    /**\n-     * Callback called when the swap interval was changed.\n-     */\n-    SwappySwapIntervalChangedCallback swapIntervalChanged;\n+  /**\n+   * Callback called before waiting to queue the frame to the composer.\n+   */\n+  SwappyPreWaitCallback preWait;\n+\n+  /**\n+   * Callback called after wait to queue the frame to the composer is done.\n+   */\n+  SwappyPostWaitCallback postWait;\n+\n+  /**\n+   * Callback called before calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPreSwapBuffersCallback preSwapBuffers;\n+\n+  /**\n+   * Callback called after calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPostSwapBuffersCallback postSwapBuffers;\n+\n+  /**\n+   * Callback called at the start of a frame.\n+   */\n+  SwappyStartFrameCallback startFrame;\n+\n+  /**\n+   * Pointer to some arbitrary data that will be passed as the first argument\n+   * of callbacks.\n+   */\n+  void* userData;\n+\n+  /**\n+   * Callback called when the swap interval was changed.\n+   */\n+  SwappySwapIntervalChangedCallback swapIntervalChanged;\n } SwappyTracer;\n \n /** @} */\n", "test_patch": "diff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\nindex abeadbe5eedd..6b4f1b6e8350 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_inferred.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim := $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\nindex d11f81e98537..4b8b001528e9 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_typed.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim: AnimationPlayer = $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd b/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\nindex 4ddfd21ac60f..fb3fe915fd41 100644\n--- a/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\n+++ b/modules/gdscript/tests/scripts/completion/argument_options/play_untyped.gd\n@@ -1,3 +1,5 @@\n+extends Node\n+\n @onready var anim = $AnimationPlayer\n \n func test():\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd b/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\nindex dc7cc9955410..5586317938ee 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/literal/dollar.gd\n@@ -1,5 +1,5 @@\n extends Node\n \n func a():\n-    %AnimationPlayer.\u27a1\n+    $UniqueAnimationPlayer.\u27a1\n     pass\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd b/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\nindex 5586317938ee..dc7cc9955410 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/literal/percent.gd\n@@ -1,5 +1,5 @@\n extends Node\n \n func a():\n-    $UniqueAnimationPlayer.\u27a1\n+    %AnimationPlayer.\u27a1\n     pass\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered/local_infered.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred/local_inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/class_local_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/class_local_inferred_scene.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/local_infered_scene/native_local_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/local_inferred_scene/native_local_inferred_scene.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered/member_infered.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred/member_inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\nsimilarity index 66%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\nindex 402fd1d275de..877ac442a91f 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/class_member_infered_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/class_member_inferred_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test := $A\n+@onready var test := $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.cfg b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.cfg\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\nsimilarity index 55%\nrename from modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd\nrename to modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\nindex 97b288334ed4..0b511e4c72c9 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_infered_scene/native_member_infered_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_inferred_scene/native_member_inferred_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test := $AnimationPlayer\n+@onready var test := $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\nindex 6188a6e843c0..0dad242872f0 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_scene/class_member_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test = $A\n+@onready var test = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\nindex 80b49439532c..43e6c3bc78f0 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_scene/native_member_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test = $AnimationPlayer\n+@onready var test = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\nindex 7f2cb4e8cc73..f4a0c6d7cec9 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene/native_member_typehint_scene.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: AnimationPlayer = $AnimationPlayer\n+@onready var test: AnimationPlayer = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\nindex aac450be9f2b..5df4c0ec4c9d 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/class_member_typehint_scene_broad.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Node = $A\n+@onready var test: Node = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\nindex 9eb10e49339f..991449d728a5 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_broad/native_member_typehint_scene_broad.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Node = $AnimationPlayer\n+@onready var test: Node = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\nindex ff8214c46329..a3cdece9561a 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/class_member_typehint_scene_incompatible.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Area2D = $A\n+@onready var test: Area2D = $A\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\nindex 30cd7d6a21a3..b0c99d4e16a6 100644\n--- a/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\n+++ b/modules/gdscript/tests/scripts/completion/get_node/member_typehint_scene_incompatible/native_member_typehint_scene_incompatible.gd\n@@ -1,6 +1,6 @@\n extends Node\n \n-var test: Area2D = $AnimationPlayer\n+@onready var test: Area2D = $AnimationPlayer\n \n func a():\n     test.\u27a1\ndiff --git a/modules/gdscript/tests/scripts/completion/types/local/infered.cfg b/modules/gdscript/tests/scripts/completion/types/local/inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/local/infered.cfg\nrename to modules/gdscript/tests/scripts/completion/types/local/inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/types/local/infered.gd b/modules/gdscript/tests/scripts/completion/types/local/inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/local/infered.gd\nrename to modules/gdscript/tests/scripts/completion/types/local/inferred.gd\ndiff --git a/modules/gdscript/tests/scripts/completion/types/member/infered.cfg b/modules/gdscript/tests/scripts/completion/types/member/inferred.cfg\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/member/infered.cfg\nrename to modules/gdscript/tests/scripts/completion/types/member/inferred.cfg\ndiff --git a/modules/gdscript/tests/scripts/completion/types/member/infered.gd b/modules/gdscript/tests/scripts/completion/types/member/inferred.gd\nsimilarity index 100%\nrename from modules/gdscript/tests/scripts/completion/types/member/infered.gd\nrename to modules/gdscript/tests/scripts/completion/types/member/inferred.gd\ndiff --git a/modules/gdscript/tests/test_completion.h b/modules/gdscript/tests/test_completion.h\nindex 844c2675e3ea..95201190131d 100644\n--- a/modules/gdscript/tests/test_completion.h\n+++ b/modules/gdscript/tests/test_completion.h\n@@ -161,6 +161,8 @@ static void test_directory(const String &p_dir) {\n \t\t\t\towner = scene->get_node(conf.get_value(\"input\", \"node_path\", \".\"));\n \t\t\t}\n \n+\t\t\t// The only requirement is for the script to be parsable, warnings and errors from the analyzer might happen and completion should still work.\n+\t\t\tERR_PRINT_OFF;\n \t\t\tif (owner != nullptr) {\n \t\t\t\t// Remove the line which contains the sentinel char, to get a valid script.\n \t\t\t\tRef<GDScript> scr;\n@@ -184,6 +186,8 @@ static void test_directory(const String &p_dir) {\n \t\t\t}\n \n \t\t\tGDScriptLanguage::get_singleton()->complete_code(code, res_path, owner, &options, forced, call_hint);\n+\t\t\tERR_PRINT_ON;\n+\n \t\t\tString contains_excluded;\n \t\t\tfor (ScriptLanguage::CodeCompletionOption &option : options) {\n \t\t\t\tfor (const Dictionary &E : exclude) {\ndiff --git a/tests/core/templates/test_a_hash_map.h b/tests/core/templates/test_a_hash_map.h\nindex 4fa6d3bca41c..6e60addc6046 100644\n--- a/tests/core/templates/test_a_hash_map.h\n+++ b/tests/core/templates/test_a_hash_map.h\n@@ -235,9 +235,13 @@ TEST_CASE(\"[AHashMap] Insert, iterate and remove many elements\") {\n TEST_CASE(\"[AHashMap] Insert, iterate and remove many strings\") {\n \tconst int elem_max = 432;\n \tAHashMap<String, String> map;\n+\n+\t// To not print WARNING: Excessive collision count (NN), is the right hash function being used?\n+\tERR_PRINT_OFF;\n \tfor (int i = 0; i < elem_max; i++) {\n \t\tmap.insert(itos(i), itos(i));\n \t}\n+\tERR_PRINT_ON;\n \n \t//insert order should have been kept\n \tint idx = 0;\ndiff --git a/tests/scene/test_code_edit.h b/tests/scene/test_code_edit.h\nindex 1c85d3e41c36..de55fc709603 100644\n--- a/tests/scene/test_code_edit.h\n+++ b/tests/scene/test_code_edit.h\n@@ -4492,7 +4492,8 @@ TEST_CASE(\"[SceneTree][CodeEdit] symbol lookup\") {\n \n \t\tPoint2 caret_pos = code_edit->get_caret_draw_pos();\n \t\tcaret_pos.x += 60;\n-\t\tSEND_GUI_MOUSE_BUTTON_EVENT(caret_pos, MouseButton::NONE, 0, Key::NONE);\n+\n+\t\tSEND_GUI_MOUSE_MOTION_EVENT(caret_pos, MouseButtonMask::NONE, Key::NONE);\n \t\tCHECK(code_edit->get_text_for_symbol_lookup() == \"this is s\" + String::chr(0xFFFF) + \"ome text\");\n \n \t\tSIGNAL_WATCH(code_edit, \"symbol_validate\");\ndiff --git a/tests/scene/test_text_edit.h b/tests/scene/test_text_edit.h\nindex d7192def6212..aa7a9bb23c40 100644\n--- a/tests/scene/test_text_edit.h\n+++ b/tests/scene/test_text_edit.h\n@@ -8014,6 +8014,8 @@ TEST_CASE(\"[SceneTree][TextEdit] gutters\") {\n \tSIGNAL_WATCH(text_edit, \"gutter_removed\");\n \n \tSUBCASE(\"[TextEdit] gutter add and remove\") {\n+\t\ttext_edit->set_text(\"test1\\ntest2\\ntest3\\ntest4\");\n+\n \t\ttext_edit->add_gutter();\n \t\tCHECK(text_edit->get_gutter_count() == 1);\n \t\tCHECK(text_edit->get_gutter_width(0) == 24);\ndiff --git a/tests/test_main.cpp b/tests/test_main.cpp\nindex c12e92708177..2d8f2c769155 100644\n--- a/tests/test_main.cpp\n+++ b/tests/test_main.cpp\n@@ -306,7 +306,7 @@ struct GodotTestCaseListener : public doctest::IReporter {\n \t\t\t// So we have to do this for each test case. Also make sure there is\n \t\t\t// no residual theme from something else.\n \t\t\tThemeDB::get_singleton()->finalize_theme();\n-\t\t\tThemeDB::get_singleton()->initialize_theme_noproject();\n+\t\t\tThemeDB::get_singleton()->initialize_theme();\n \n #ifndef _3D_DISABLED\n \t\t\tphysics_server_3d = PhysicsServer3DManager::get_singleton()->new_default_server();\n", "problem_statement": "Gray line at the bottom of scaled VideoStreamPlayer\n### Tested versions\n\nGodot Engine v4.2.1.stable.official.b09f793f5 - https://godotengine.org\r\n\r\n\n\n### System information\n\nLinux; Vulkan API 1.3.255 - Forward+ - Using Vulkan Device #0: AMD - AMD Radeon RX 5600 XT (RADV NAVI10)  \n\n### Issue description\n\nWhen have a VideoStreamPlayer that's scaled down (in my case, to 50%), when the video plays, it shows a gray line at the bottom.  The gray line is not visible when I play the video at 1:1 scale.\r\n\r\nI don't think this is the same as #62752 -- first, I think my video doesn't have any overscan since its resolution is a multiple of 16, and second, it doesn't manifest as duplication but as a grey line.\r\n\r\n![gray-line](https://github.com/godotengine/godot/assets/77003/13a89274-61ea-4d83-a44f-52dc807e4e7f)\r\n\r\nWeirdly, it seems to depend on some tiny details of the video file.  I have one video file which experiences it, and one that doesn't even though both are the same resolution, frame rate, etc.  The one with the line is made by:\r\n`ffmpeg -r 30  -pattern_type sequence -i out/cat-%06d.png    -map 0:v  -y  cat.ogv`\r\nThe one without is made by:\r\n`theora_png2theora -k 30 -f 30 out/cat-%06d.png -o cat2.ogv`\r\n\r\nUnfortunately, as you can see, the second one produces a video with the wrong color (and I have to run it through ffmpeg anyway to get the audio added; to save you from having to hear my awful voice acting looping over and over, I didn't add the audio to either of the clips in the repro project).  \n\n### Steps to reproduce\n\nThe attached sample code reproduces this issue.  I have a VideoStreamPlayer which is scaled (in this case, the root node is scaled, because that pretty closely matches my actual project).   There are actually two players, to demonstrate that the effect depends on some weird detail of the actual video; the one on the left is the one with the problem (the color mismatch on the right is Theora's fault not Godot's).\n\n### Minimal reproduction project (MRP)\n\n[white-line.zip](https://github.com/godotengine/godot/files/14086142/white-line.zip)\r\n\nMetalFX Temporal upscaling fallback on non-supported rendering drivers does not disable TAA jitter (or fallback to FSR2)\n### Tested versions\n\n- Reproducible in: 4.4.stable\n- MetalFX is not available before 4.4.\n\n### System information\n\nGodot v4.4.stable (4c311cbee) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4090 (nvidia; 570.86.16) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nWhen attempting to use MetalFX Temporal upscaling on an unsupported rendering driver, the TAA jitter is still active despite not being needed with bilinear scaling. MetalFX Spatial upscaling doesn't have this issue, as it doesn't engage TAA jitter in the first place due to its purely spatial nature.\n\nAlternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\ncc @stuartcarnie \n\nhttps://github.com/user-attachments/assets/bde8cd82-63ba-4f82-ba59-0be8e46ea63c\n\n### Steps to reproduce\n\n- Create a project using the Forward+ rendering method.\n- Set the root viewport's 3D scaling mode to MetalFX Temporal using a script on a platform/renderer that doesn't support MetalFX upscaling (Windows, Linux, or macOS when using MoltenVK):\n```gdscript\nfunc _ready() -> void:\n    get_window().scaling_3d_mode = Viewport.SCALING_3D_MODE_METALFX_TEMPORAL\n```\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/godotengine/tps-demo/pull/196\n*Change the check in the demo's code from `== \"metal\"` to `!= \"metal` to test this on unsupported drivers. I suggest using the Ultra Performance scaling mode so the issue is more noticeable.*\n", "hints_text": "I've fixed #62752 and this still happens so I don't think they're related at all.\nIt only happens when texture filter is set to linear. Setting the filter to nearest removes the gray line.\n\nIt's weird that it happens only in one of the videos but the background color is different so that might be the reason.\nVideo on the left with the gray line:\n\n```\n\u276f ffprobe cat.ogv                                                                                  \nInput #0, ogg, from 'cat.ogv':\n  Duration: 00:00:05.73, start: 0.000000, bitrate: 216 kb/s\n  Stream #0:0: Video: theora, yuv444p, 256x256 [SAR 1:1 DAR 1:1], 30 tbr, 30 tbn\n      Metadata:\n        encoder         : Lavc60.31.102 libtheora\n```\n\nVideo on the right (which renders correctly in Godot):\n\n```\n\u276f ffprobe cat2.ogv\n[ogg @ 0x559083ead180] Broken file, keyframe not correctly marked.\nInput #0, ogg, from 'cat2.ogv':\n  Duration: 00:00:05.77, start: 0.000000, bitrate: 65 kb/s\n  Stream #0:0: Video: theora, yuv420p, 256x256, 30 tbr, 30 tbn\n```\n", "created_at": "2025-03-12 12:00:24", "merge_commit_sha": "cc77c02d4756e9cf52637450dec6173c25a391c2", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103424", "base_commit": "9f68a816599412c56a4626dd6c47244ebc65ed1f", "patch": "diff --git a/scene/gui/tree.cpp b/scene/gui/tree.cpp\nindex cd6c51de4b2d..9a2c24473381 100644\n--- a/scene/gui/tree.cpp\n+++ b/scene/gui/tree.cpp\n@@ -2177,7 +2177,7 @@ int Tree::draw_item(const Point2i &p_pos, const Point2 &p_draw_ofs, const Size2\n \t\t\t\t}\n \t\t\t}\n \n-\t\t\tif (!rtl && p_item->cells[i].buttons.size()) {\n+\t\t\tif (!p_item->cells[i].buttons.is_empty()) {\n \t\t\t\tint buttons_width = 0;\n \t\t\t\tfor (int j = p_item->cells[i].buttons.size() - 1; j >= 0; j--) {\n \t\t\t\t\tRef<Texture2D> button_texture = p_item->cells[i].buttons[j].texture;\n", "test_patch": "", "problem_statement": "Tree buttons don't behave the same in Right to Left\n### Tested versions\n\nGodot v4.4.beta1\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nIf tree i set to Right to Left layout direction the buttons in a column doesn't behave the same as in Left to Right direction when scrolling horizontally.\n\nScene tree in editor in LtR:\n\nhttps://github.com/user-attachments/assets/f6c079ad-a05b-4ad0-baeb-ef7c52e05ad6\n\nButtons doesn't move (just a little bit, https://github.com/godotengine/godot/issues/100645) when tree is scrolled. \n\nUsing RtL:\n\nhttps://github.com/user-attachments/assets/eae1bcb4-db75-4500-850c-81e74967ebe5\n\nSee how the buttons doesn't stay visible.\n\n### Steps to reproduce\n\nChange editor to a language with RtL language.\nOpen a scene with nodes in the scene tree\nChange the horizontal scroll position\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-03-01 07:27:42", "merge_commit_sha": "1ef52d80773d29be0279f13bc60e33c577972e1f", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-103105", "base_commit": "8ed125b42908d0d46d3b8967e3a3bc03f809b3af", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 0da2dceb5f4d..b4897bcd48f9 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -95,9 +95,11 @@ void EmbeddedProcess::set_keep_aspect(bool p_keep_aspect) {\n \t}\n }\n \n-Rect2i EmbeddedProcess::_get_global_embedded_window_rect() {\n-\tRect2i control_rect = get_global_rect();\n-\tcontrol_rect = Rect2i(control_rect.position + margin_top_left, (control_rect.size - get_margins_size()).maxi(1));\n+Rect2i EmbeddedProcess::get_adjusted_embedded_window_rect(Rect2i p_rect) {\n+\tRect2i control_rect = Rect2i(p_rect.position + margin_top_left, (p_rect.size - get_margins_size()).maxi(1));\n+\tif (window) {\n+\t\tcontrol_rect.position += window->get_position();\n+\t}\n \tif (window_size != Size2i()) {\n \t\tRect2i desired_rect = Rect2i();\n \t\tif (!keep_aspect && control_rect.size.x >= window_size.x && control_rect.size.y >= window_size.y) {\n@@ -116,12 +118,7 @@ Rect2i EmbeddedProcess::_get_global_embedded_window_rect() {\n }\n \n Rect2i EmbeddedProcess::get_screen_embedded_window_rect() {\n-\tRect2i rect = _get_global_embedded_window_rect();\n-\tif (window) {\n-\t\trect.position += window->get_position();\n-\t}\n-\n-\treturn rect;\n+\treturn get_adjusted_embedded_window_rect(get_global_rect());\n }\n \n int EmbeddedProcess::get_margin_size(Side p_side) const {\ndiff --git a/editor/plugins/embedded_process.h b/editor/plugins/embedded_process.h\nindex 55988be3f0b4..298424b0c553 100644\n--- a/editor/plugins/embedded_process.h\n+++ b/editor/plugins/embedded_process.h\n@@ -83,6 +83,7 @@ class EmbeddedProcess : public Control {\n \tvoid set_keep_aspect(bool p_keep_aspect);\n \tvoid queue_update_embedded_process();\n \n+\tRect2i get_adjusted_embedded_window_rect(Rect2i p_rect);\n \tRect2i get_screen_embedded_window_rect();\n \tint get_margin_size(Side p_side) const;\n \tSize2 get_margins_size();\ndiff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 6318bf6d1645..30c558e0bd5d 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -812,10 +812,28 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \t_update_embed_window_size();\n \tRect2i rect = embedded_process->get_screen_embedded_window_rect();\n \n+\t// On the first startup, the global rect of the embedded process control is invalid because it was\n+\t// never displayed. We will calculated it manually.\n+\tif (!window_wrapper->get_window_enabled() && rect.size.y < embedded_process->get_custom_minimum_size().y) {\n+\t\tSize2 old_min_size = embedded_process->get_custom_minimum_size();\n+\t\tembedded_process->set_custom_minimum_size(Size2i());\n+\n+\t\tControl *container = EditorNode::get_singleton()->get_editor_main_screen()->get_control();\n+\t\trect = container->get_global_rect();\n+\n+\t\tSize2 wrapped_min_size = window_wrapper->get_minimum_size();\n+\t\trect.position.y += wrapped_min_size.y;\n+\t\trect.size.y -= wrapped_min_size.y;\n+\n+\t\trect = embedded_process->get_adjusted_embedded_window_rect(rect);\n+\n+\t\tembedded_process->set_custom_minimum_size(old_min_size);\n+\t}\n+\n \t// When using the floating window, we need to force the position and size from the\n \t// editor/project settings, because the get_screen_embedded_window_rect of the\n \t// embedded_process will be updated only on the next frame.\n-\tif (p_idx == 0 && window_wrapper->get_window_enabled()) {\n+\tif (window_wrapper->get_window_enabled()) {\n \t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n \t\tif (placement.position != Point2i(INT_MAX, INT_MAX)) {\n \t\t\trect.position = placement.position;\n", "test_patch": "", "problem_statement": "Embedded Game window wrong first startup location and size\n### Tested versions\n\nReproductible since Godot 4.4 beta 4\nNot reprodictible in Godot 4.4 beta 3\n\n### System information\n\nGodot v4.4.rc (8ed125b42) - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 32.0.15.7216) - 11th Gen Intel(R) Core(TM) i5-11600KF @ 3.90GHz (12 threads)\n\n### Issue description\n\nWhen the game is started and the game is embedded inside the editor without the floating window and if the Game View tab was not accessed, the location and the size of the embedded game is wrong at the first startup of the game.\n\nhttps://github.com/user-attachments/assets/f3623b5f-65c0-42ab-8422-b19c5e4dc2cc\n\n### Steps to reproduce\n\n- Open the editor, set embedding at true and floating window at false\n- Go to another tab then Game View\n- Close the editor\n- Reopen a project in the editor\n- Start the game without going to the Game View\n- You will see the game for a split second really small and not correctly positionned on startup\n\n### Minimal reproduction project (MRP)\n\nAny project\n", "hints_text": "", "created_at": "2025-02-21 01:31:26", "merge_commit_sha": "ba47acab0a74de766b5a63cfb49547e4d75d4de5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102677", "base_commit": "296de7da830fa03425edf544427543087817e649", "patch": "diff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 172d6e547118..6da4d24e7256 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -3299,6 +3299,8 @@ void RendererCanvasRenderRD::_prepare_batch_texture_info(RID p_texture, TextureS\n \n RendererCanvasRenderRD::~RendererCanvasRenderRD() {\n \tRendererRD::MaterialStorage *material_storage = RendererRD::MaterialStorage::get_singleton();\n+\tRendererRD::TextureStorage *texture_storage = RendererRD::TextureStorage::get_singleton();\n+\n \t//canvas state\n \n \tmaterial_storage->material_free(default_canvas_group_material);\n@@ -3346,7 +3348,9 @@ RendererCanvasRenderRD::~RendererCanvasRenderRD() {\n \t\t}\n \t}\n \n-\tRendererRD::TextureStorage::get_singleton()->canvas_texture_free(default_canvas_texture);\n+\t// Disable the callback, as we're tearing everything down\n+\ttexture_storage->canvas_texture_set_invalidation_callback(default_canvas_texture, nullptr, nullptr);\n+\ttexture_storage->canvas_texture_free(default_canvas_texture);\n \t//pipelines don't need freeing, they are all gone after shaders are gone\n \n \tmemdelete(shader.default_version_data);\n", "test_patch": "", "problem_statement": "\"Attempted to free invalid ID\" errors are printed when exiting a project run with Debug Canvas Item Redraw\n### Tested versions\n\n- Reproducible in: 4.4.beta2, 4.4.beta2\n- Not reproducible in: 4.3.stable, 4.4.beta1\n\n### System information\n\nGodot v4.4.beta (36d90c73a) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (nvidia; 565.77) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nRunning the MRP with `--debug-canvas-item-redraw` will result in the following on exit:\n\n```\nERROR: Attempted to free invalid ID: 4509715660816\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\nERROR: Attempted to free invalid ID: 4526895530004\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\nERROR: Attempted to free invalid ID: 4539780431895\n   at: _free_internal (./servers/rendering/rendering_device.cpp:6106)\n```\n\nThe invalid IDs are the usually same on every run (in this particular project), especially the first one. No further information about this is printed when using `--verbose`.\n\nThe feature still works correctly, so it's not a big issue but we should still aim to fix it.\n\nI've bisected this to https://github.com/godotengine/godot/pull/101931. cc @stuartcarnie \n\n### Steps to reproduce\n\n- Add a CheckButton node.\n- With the editor being run from a terminal (so you can see all errors on exit), enable **Debug > Visible Canvas Item Redraw** or run the project with `--debug-canvas-item-redraw` when using Forward+ or Mobile.\n- Exit the project and notice errors being printed in the terminal.\n\n### Minimal reproduction project (MRP)\n\n[test_debug_canvas_item_redraw.zip](https://github.com/user-attachments/files/18739163/test_debug_canvas_item_redraw.zip)\n", "hints_text": "", "created_at": "2025-02-10 21:18:34", "merge_commit_sha": "cfe0fd62d03bf58104dcda98f0db7d26326f0ba7", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102530", "base_commit": "3f56b3b23916ff54a1715cb8444304ce3c50283d", "patch": "diff --git a/editor/debugger/script_editor_debugger.cpp b/editor/debugger/script_editor_debugger.cpp\nindex 1363fca3c2c9..c4242f7dff60 100644\n--- a/editor/debugger/script_editor_debugger.cpp\n+++ b/editor/debugger/script_editor_debugger.cpp\n@@ -543,7 +543,7 @@ void ScriptEditorDebugger::_parse_message(const String &p_msg, uint64_t p_thread\n \t\ttime_vals.push_back(oe.sec);\n \t\ttime_vals.push_back(oe.msec);\n \t\tbool e;\n-\t\tString time = String(\"%d:%02d:%02d:%04d\").sprintf(time_vals, &e);\n+\t\tString time = String(\"%d:%02d:%02d:%03d\").sprintf(time_vals, &e);\n \n \t\t// Rest of the error data.\n \t\tbool source_is_project_file = oe.source_file.begins_with(\"res://\");\n", "test_patch": "", "problem_statement": "push_warning/error show a leading 0 in the timestamp for the milliseconds\n### Tested versions\n\n- v4.4.beta.gentoo [a013481b0]\n\n### System information\n\nLinux Gentoo Wayland\n\n### Issue description\n\nI was doing some good-ol' push_warning() debugging of my project and I was getting confused why some warnings were suddenly delayed by 900 msec. As it turns out, the Editor prints an additional zero when printing the timestamp.\n\nObserved behaviour:\n```\nW 0:00:00:0990   main.gd:10 @ ticker(): TICK 37\nW 0:00:01:0007   main.gd:10 @ ticker(): TICK 38\n```\n\nExpected behaviour:\n```\nW 0:00:00:990   main.gd:10 @ ticker(): TICK 37\nW 0:00:01:007   main.gd:10 @ ticker(): TICK 38\n```\n\nThe most likely culprit for this is in : `ScriptEditorDebugger::_parse_message` with the offending line being `String time = String(\"%d:%02d:%02d:%04d\").sprintf(time_vals, &e);`\n\n\n### Steps to reproduce\n\nDo a bunch of push_warnings and/or push_errors and observe the millisecond field in the timestamp.\n\n### Minimal reproduction project (MRP)\n\n* Create a new scene\n* Attach the following script and run the scene\n\n```gdscript\nextends Node\n\nfunc _ready() -> void:\n\tticker()\n\nfunc ticker() -> void:\n\tfor i in range(1, 100):\n\t\tpush_warning('TICK ', i)\n\t\tpush_error('TICK ', i)\n\t\tawait get_tree().physics_frame\n\n\tget_tree().quit()\n```\n", "hints_text": "This is also present in all previous 4.x versions, introduced in:\n* https://github.com/godotengine/godot/pull/36244\n\nBack before 4.0\n\nSimple to solve by returning to the previous format of `\"%d:%02d:%02d:%03d\"`", "created_at": "2025-02-07 13:04:26", "merge_commit_sha": "fc8ec5a4cabd786b425ec48eb17e699b2ae83144", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Template w/ Mono, debug (target=template_debug, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102312", "base_commit": "1586c5674bbafe1d7f4bd457d446f132b475890c", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex d96ee851374e..6cc54ab34c97 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -230,6 +230,8 @@ void GameView::_instance_starting(int p_idx, List<String> &r_arguments) {\n \t\twindow_wrapper->set_window_title(appname);\n \n \t\t_show_update_window_wrapper();\n+\n+\t\tembedded_process->grab_focus();\n \t}\n \n \t_update_arguments_for_instance(p_idx, r_arguments);\n", "test_patch": "", "problem_statement": "Floating game window doesn't get focus when launched\n### Tested versions\n\nGodot v4.4.beta2\n\n### System information\n\nFedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nFloating game window doesn't get focus when launched. \nThe editor behind still has focus so if you have script open you will accidentally edit the script.\n\nhttps://github.com/user-attachments/assets/5b4bea64-89b8-4f38-954b-770208a80159\n\nIn 4.4.beta1 the game window has focus correctly first time you launch it, but after that it behaves same as beta2\n\n### Steps to reproduce\n\nHave script open \nLaunch scene\nPress some buttons\nSwitch back to the script and see that you have typed in the script\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "hints_text": "", "created_at": "2025-02-02 02:18:03", "merge_commit_sha": "bbf29a537f3d2875bba4304b1543d4bf0278b6d9", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-102163", "base_commit": "a013481b0911e59cc3f3dea7ebb732450c3e1460", "patch": "diff --git a/platform/web/js/libs/audio.position.worklet.js b/platform/web/js/libs/audio.position.worklet.js\nindex bf3ac4ae2d23..7dbeb8a0adde 100644\n--- a/platform/web/js/libs/audio.position.worklet.js\n+++ b/platform/web/js/libs/audio.position.worklet.js\n@@ -28,10 +28,20 @@\n /* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n /**************************************************************************/\n \n+const POST_THRESHOLD_S = 0.1;\n+\n class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n-\tconstructor() {\n-\t\tsuper();\n+\tconstructor(...args) {\n+\t\tsuper(...args);\n+\t\tthis.lastPostTime = currentTime;\n \t\tthis.position = 0;\n+\n+\t\tthis.port.onmessage = (event) => {\n+\t\t\tif (event?.data?.type === 'clear') {\n+\t\t\t\tthis.lastPostTime = currentTime;\n+\t\t\t\tthis.position = 0;\n+\t\t\t}\n+\t\t};\n \t}\n \n \tprocess(inputs, _outputs, _parameters) {\n@@ -39,10 +49,15 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\t\tconst input = inputs[0];\n \t\t\tif (input.length > 0) {\n \t\t\t\tthis.position += input[0].length;\n-\t\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n-\t\t\t\treturn true;\n \t\t\t}\n \t\t}\n+\n+\t\t// Posting messages is expensive. Let's limit the number of posts.\n+\t\tif (currentTime - this.lastPostTime > POST_THRESHOLD_S) {\n+\t\t\tthis.lastPostTime = currentTime;\n+\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n+\t\t}\n+\n \t\treturn true;\n \t}\n }\ndiff --git a/platform/web/js/libs/library_godot_audio.js b/platform/web/js/libs/library_godot_audio.js\nindex 0c83e3587d84..c5fa7d5f0fad 100644\n--- a/platform/web/js/libs/library_godot_audio.js\n+++ b/platform/web/js/libs/library_godot_audio.js\n@@ -460,7 +460,11 @@ class SampleNode {\n \t\tconst sampleNodeBus = this.getSampleNodeBus(bus);\n \t\tsampleNodeBus.setVolume(options.volume);\n \n-\t\tthis.connectPositionWorklet(options.start);\n+\t\tthis.connectPositionWorklet(options.start).catch((err) => {\n+\t\t\tconst newErr = new Error('Failed to create PositionWorklet.');\n+\t\t\tnewErr.cause = err;\n+\t\t\tGodotRuntime.error(newErr);\n+\t\t});\n \t}\n \n \t/**\n@@ -612,44 +616,34 @@ class SampleNode {\n \t * Sets up and connects the source to the GodotPositionReportingProcessor\n \t * If the worklet module is not loaded in, it will be added\n \t */\n-\tconnectPositionWorklet(start) {\n-\t\ttry {\n-\t\t\tthis._positionWorklet = this.createPositionWorklet();\n-\t\t\tthis._source.connect(this._positionWorklet);\n-\t\t\tif (start) {\n-\t\t\t\tthis.start();\n-\t\t\t}\n-\t\t} catch (error) {\n-\t\t\tif (error?.name !== 'InvalidStateError') {\n-\t\t\t\tthrow error;\n-\t\t\t}\n-\t\t\tconst path = GodotConfig.locate_file('godot.audio.position.worklet.js');\n-\t\t\tGodotAudio.ctx.audioWorklet\n-\t\t\t\t.addModule(path)\n-\t\t\t\t.then(() => {\n-\t\t\t\t\tif (!this.isCanceled) {\n-\t\t\t\t\t\tthis._positionWorklet = this.createPositionWorklet();\n-\t\t\t\t\t\tthis._source.connect(this._positionWorklet);\n-\t\t\t\t\t\tif (start) {\n-\t\t\t\t\t\t\tthis.start();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}).catch((addModuleError) => {\n-\t\t\t\t\tGodotRuntime.error('Failed to create PositionWorklet.', addModuleError);\n-\t\t\t\t});\n+\tasync connectPositionWorklet(start) {\n+\t\tawait GodotAudio.audioPositionWorkletPromise;\n+\t\tif (this.isCanceled) {\n+\t\t\treturn;\n+\t\t}\n+\t\tthis.getPositionWorklet();\n+\t\tthis._source.connect(this._positionWorklet);\n+\t\tif (start) {\n+\t\t\tthis.start();\n \t\t}\n \t}\n \n \t/**\n-\t * Creates the AudioWorkletProcessor used to track playback position.\n-\t * @returns {AudioWorkletNode}\n+\t * Get a AudioWorkletProcessor from the pool, or create one if no processor is available.\n \t */\n-\tcreatePositionWorklet() {\n-\t\tconst worklet = new AudioWorkletNode(\n-\t\t\tGodotAudio.ctx,\n-\t\t\t'godot-position-reporting-processor'\n-\t\t);\n-\t\tworklet.port.onmessage = (event) => {\n+\tgetPositionWorklet() {\n+\t\tif (this._positionWorklet != null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tif (GodotAudio.audioPositionWorkletPool.length == 0) {\n+\t\t\tthis._positionWorklet = new AudioWorkletNode(\n+\t\t\t\tGodotAudio.ctx,\n+\t\t\t\t'godot-position-reporting-processor'\n+\t\t\t);\n+\t\t} else {\n+\t\t\tthis._positionWorklet = GodotAudio.audioPositionWorkletPool.pop();\n+\t\t}\n+\t\tthis._positionWorklet.port.onmessage = (event) => {\n \t\t\tswitch (event.data['type']) {\n \t\t\tcase 'position':\n \t\t\t\tthis._playbackPosition = (parseInt(event.data.data, 10) / this.getSample().sampleRate) + this.offset;\n@@ -658,7 +652,6 @@ class SampleNode {\n \t\t\t\t// Do nothing.\n \t\t\t}\n \t\t};\n-\t\treturn worklet;\n \t}\n \n \t/**\n@@ -688,6 +681,8 @@ class SampleNode {\n \t\tif (this._positionWorklet) {\n \t\t\tthis._positionWorklet.disconnect();\n \t\t\tthis._positionWorklet.port.onmessage = null;\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n+\t\t\tGodotAudio.audioPositionWorkletPool.push(this._positionWorklet);\n \t\t\tthis._positionWorklet = null;\n \t\t}\n \n@@ -731,7 +726,10 @@ class SampleNode {\n \t\tconst pauseTime = this.isPaused\n \t\t\t? this.pauseTime\n \t\t\t: 0;\n-\t\tthis.connectPositionWorklet();\n+\t\tif (this._positionWorklet != null) {\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n+\t\t\tthis._source.connect(this._positionWorklet);\n+\t\t}\n \t\tthis._source.start(this.startTime, this.offset + pauseTime);\n \t\tthis.isStarted = true;\n \t}\n@@ -1199,6 +1197,10 @@ const _GodotAudio = {\n \t\tdriver: null,\n \t\tinterval: 0,\n \n+\t\t/** @type {Promise} */\n+\t\taudioPositionWorkletPromise: null,\n+\t\taudioPositionWorkletPool: [],\n+\n \t\t/**\n \t\t * Converts linear volume to Db.\n \t\t * @param {number} linear Linear value to convert.\n@@ -1265,6 +1267,10 @@ const _GodotAudio = {\n \t\t\t\tonlatencyupdate(computed_latency);\n \t\t\t}, 1000);\n \t\t\tGodotOS.atexit(GodotAudio.close_async);\n+\n+\t\t\tconst path = GodotConfig.locate_file('godot.audio.position.worklet.js');\n+\t\t\tGodotAudio.audioPositionWorkletPromise = ctx.audioWorklet.addModule(path);\n+\n \t\t\treturn ctx.destination.channelCount;\n \t\t},\n \n", "test_patch": "", "problem_statement": "v4.4 Sound quickly regresses on the Web: freezes, noises, crackles\n### Tested versions\n\nReproducible in: v4.4.dev3.official [f4af8201b], v4.4.dev2, v4.4.dev1\r\nNot reproducible in: v4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.4.dev3 - Windows 10.0.19045 - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - GeForce GT 740M - Intel(R) Core(TM) i5-3317U CPU @ 1.70GHz (4 threads)\n\n### Issue description\n\nOn the Web over time, the sound begins to freeze, break and crackle terribly. The heavier the stage and the weaker the hardware on which the game is launched, the faster it happens. For example, the sounds in the game I created start to freeze after a minute on a modern computer. On a weak laptop almost immediately. And immediately on a phone. Also, in remote debugging, this degradation of sounds occurs more slowly than when exporting a project.\r\n\r\nI tried different solutions, but they all didn't work. Because of this, I had to move the whole project to version 4.3 and that solved the problem.\r\n\r\nSo at the moment version 4.4 is not playable on web platforms. At least for me.\r\n\r\nFor testing I created separate projects for 4.4 and 4.3. with a minimum number of objects just so that there is at least some load on the engine.\n\n### Steps to reproduce\n\nRun the project in remote debugging on the Web.\r\nWait a few minutes (depending on your hardware). My sound began to degrade sharply at the 3rd minute.\r\nIf you want, try to run the same project on version 4.3. You won't find any such problems, no matter how much you play.\n\n### Minimal reproduction project (MRP)\n\n[audiotest-4.4.zip](https://github.com/user-attachments/files/17602861/audiotest-4.4.zip)\r\n\r\n[audiotest-4.3.zip](https://github.com/user-attachments/files/17602859/audiotest-4.3.zip)\r\n\n", "hints_text": "I confirm the problem. It is played on Linux in Chrome and FireFox browsers.\nI also confirm the issue. Here is my (work-in-progress) project exported from two different Godot versions:\n\n- [Froge 4.3](https://rburing.itch.io/froge-4-3?secret=LEGEJVXHEuaHXoqmv2zlZ0u1SU) (exported from Godot 4.3-stable)\n- [Froge 4.4](https://rburing.itch.io/froge-4-4?secret=ZnPD765il6PkacENN3CyUeStyU) (exported from Godot 4.4-beta1)\n\nStart the game and wait about 2 minutes (the exact time may depend on your device).\n\nThe looped music (an .ogg file played by an AudioStreamPlayer) starts to stutter, crackle, and slow down.\n\nTested on Firefox on Linux.\n\nI can provide the project source upon request.\n\ncc @adamscott \nI've narrowed down the issue, it started on 4.4-dev1. For completeness: [Froge 4.4-dev1](https://rburing.itch.io/froge-4-4-dev1?secret=N7HUGjKguo20JFpm36RWKGrpotM).\n\nMy guess is that maybe it has something to do with looping and floating point precision.\n\nEdit: Probably related to\n\n- https://github.com/godotengine/godot/pull/95197\n\n", "created_at": "2025-01-29 22:04:30", "merge_commit_sha": "a7e5469155defaceb4dfa223fec0fa46b73ad40e", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-101726", "base_commit": "b15b24b087e792335d919fd83055f50f276fbe22", "patch": "diff --git a/SConstruct b/SConstruct\nindex 94bef048a072..8f8f329f233d 100644\n--- a/SConstruct\n+++ b/SConstruct\n@@ -107,22 +107,11 @@ for x in sorted(glob.glob(\"platform/*\")):\n     sys.path.remove(tmppath)\n     sys.modules.pop(\"detect\")\n \n-custom_tools = [\"default\"]\n-\n-platform_arg = ARGUMENTS.get(\"platform\", ARGUMENTS.get(\"p\", False))\n-\n-if platform_arg == \"android\":\n-    custom_tools = [\"clang\", \"clang++\", \"as\", \"ar\", \"link\"]\n-elif platform_arg == \"web\":\n-    # Use generic POSIX build toolchain for Emscripten.\n-    custom_tools = [\"cc\", \"c++\", \"ar\", \"link\", \"textfile\", \"zip\"]\n-elif os.name == \"nt\" and methods.get_cmdline_bool(\"use_mingw\", False):\n-    custom_tools = [\"mingw\"]\n-\n # We let SCons build its default ENV as it includes OS-specific things which we don't\n-# want to have to pull in manually.\n+# want to have to pull in manually. However we enforce no \"tools\", which we register\n+# further down after parsing our platform-specific configuration.\n # Then we prepend PATH to make it take precedence, while preserving SCons' own entries.\n-env = Environment(tools=custom_tools)\n+env = Environment(tools=[])\n env.PrependENVPath(\"PATH\", os.getenv(\"PATH\"))\n env.PrependENVPath(\"PKG_CONFIG_PATH\", os.getenv(\"PKG_CONFIG_PATH\"))\n if \"TERM\" in os.environ:  # Used for colored output.\n@@ -168,11 +157,7 @@ if profile:\n opts = Variables(customs, ARGUMENTS)\n \n # Target build options\n-if env.scons_version >= (4, 3):\n-    opts.Add([\"platform\", \"p\"], \"Target platform (%s)\" % \"|\".join(platform_list), \"\")\n-else:\n-    opts.Add(\"platform\", \"Target platform (%s)\" % \"|\".join(platform_list), \"\")\n-    opts.Add(\"p\", \"Alias for 'platform'\", \"\")\n+opts.Add(([\"platform\", \"p\"], \"Target platform (%s)\" % \"|\".join(platform_list), \"\"))\n opts.Add(EnumVariable(\"target\", \"Compilation target\", \"editor\", (\"editor\", \"template_release\", \"template_debug\")))\n opts.Add(EnumVariable(\"arch\", \"CPU architecture\", \"auto\", [\"auto\"] + architectures, architecture_aliases))\n opts.Add(BoolVariable(\"dev_build\", \"Developer build with dev-only debugging code (DEV_ENABLED)\", False))\n@@ -312,10 +297,7 @@ if env[\"import_env_vars\"]:\n \n # Platform selection: validate input, and add options.\n \n-if env.scons_version < (4, 3) and not env[\"platform\"]:\n-    env[\"platform\"] = env[\"p\"]\n-\n-if env[\"platform\"] == \"\":\n+if not env[\"platform\"]:\n     # Missing `platform` argument, try to detect platform automatically\n     if (\n         sys.platform.startswith(\"linux\")\n@@ -330,7 +312,7 @@ if env[\"platform\"] == \"\":\n     elif sys.platform == \"win32\":\n         env[\"platform\"] = \"windows\"\n \n-    if env[\"platform\"] != \"\":\n+    if env[\"platform\"]:\n         print(f'Automatically detected platform: {env[\"platform\"]}')\n \n # Deprecated aliases kept for compatibility.\n@@ -352,7 +334,7 @@ if env[\"platform\"] not in platform_list:\n \n     if env[\"platform\"] == \"list\":\n         print(text)\n-    elif env[\"platform\"] == \"\":\n+    elif not env[\"platform\"]:\n         print_error(\"Could not detect platform automatically.\\n\" + text)\n     else:\n         print_error(f'Invalid target platform \"{env[\"platform\"]}\".\\n' + text)\n@@ -434,6 +416,23 @@ env.modules_detected = modules_detected\n opts.Update(env, {**ARGUMENTS, **env.Dictionary()})\n Help(opts.GenerateHelpText(env))\n \n+\n+# FIXME: Tool assignment happening at this stage is a direct consequence of getting the platform logic AFTER the SCons\n+# environment was already been constructed. Fixing this would require a broader refactor where all options are setup\n+# ahead of time with native validator/converter functions.\n+tmppath = \"./platform/\" + env[\"platform\"]\n+sys.path.insert(0, tmppath)\n+import detect\n+\n+custom_tools = [\"default\"]\n+try:  # Platform custom tools are optional\n+    custom_tools = detect.get_tools(env)\n+except AttributeError:\n+    pass\n+for tool in custom_tools:\n+    env.Tool(tool)\n+\n+\n # add default include paths\n \n env.Prepend(CPPPATH=[\"#\"])\n@@ -515,10 +514,6 @@ if not env[\"deprecated\"]:\n if env[\"precision\"] == \"double\":\n     env.Append(CPPDEFINES=[\"REAL_T_IS_DOUBLE\"])\n \n-tmppath = \"./platform/\" + env[\"platform\"]\n-sys.path.insert(0, tmppath)\n-import detect\n-\n # Default num_jobs to local cpu count if not user specified.\n # SCons has a peculiarity where user-specified options won't be overridden\n # by SetOption, so we can rely on this to know if we should use our default.\n@@ -587,7 +582,7 @@ if env[\"dev_mode\"]:\n if env[\"production\"]:\n     env[\"use_static_cpp\"] = methods.get_cmdline_bool(\"use_static_cpp\", True)\n     env[\"debug_symbols\"] = methods.get_cmdline_bool(\"debug_symbols\", False)\n-    if platform_arg == \"android\":\n+    if env[\"platform\"] == \"android\":\n         env[\"swappy\"] = methods.get_cmdline_bool(\"swappy\", True)\n     # LTO \"auto\" means we handle the preferred option in each platform detect.py.\n     env[\"lto\"] = ARGUMENTS.get(\"lto\", \"auto\")\ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 03a208391cf3..571cfd9819c0 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -19,6 +19,10 @@ def can_build():\n     return os.path.exists(get_env_android_sdk_root())\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    return [\"clang\", \"clang++\", \"as\", \"ar\", \"link\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable\n \ndiff --git a/platform/web/detect.py b/platform/web/detect.py\nindex 87315a405f27..9b9234480408 100644\n--- a/platform/web/detect.py\n+++ b/platform/web/detect.py\n@@ -28,6 +28,11 @@ def can_build():\n     return WhereIs(\"emcc\") is not None\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    # Use generic POSIX build toolchain for Emscripten.\n+    return [\"cc\", \"c++\", \"ar\", \"link\", \"textfile\", \"zip\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable\n \ndiff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 943de74a3e9d..db65bb64a7b5 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -155,6 +155,13 @@ def detect_build_env_arch():\n     return \"\"\n \n \n+def get_tools(env: \"SConsEnvironment\"):\n+    if os.name != \"nt\" or env[\"use_mingw\"]:\n+        return [\"mingw\"]\n+    else:\n+        return [\"default\"]\n+\n+\n def get_opts():\n     from SCons.Variables import BoolVariable, EnumVariable\n \n@@ -326,10 +333,6 @@ def setup_mingw(env: \"SConsEnvironment\"):\n         print_error(\"No valid compilers found, use MINGW_PREFIX environment variable to set MinGW path.\")\n         sys.exit(255)\n \n-    env.Tool(\"mingw\")\n-    env.AppendUnique(CCFLAGS=env.get(\"ccflags\", \"\").split())\n-    env.AppendUnique(RCFLAGS=env.get(\"rcflags\", \"\").split())\n-\n     print(\"Using MinGW, arch %s\" % (env[\"arch\"]))\n \n \n", "test_patch": "", "problem_statement": "SCons detect configure removes LINKFLAGS added beforehand (eg. command line)\n### Tested versions\n\nReproducible: Master\nNot Reproducible: 4.3\n\n### System information\n\nGodot v4.4.dev (bb2225753) - Windows 11 (build 22631) - Multi-window, 3 monitors - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 4070 (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 3700X 8-Core Processor (16 threads)\n\n### Issue description\n\nHey,\n\nbuilding with SCons on Master does not respect linkflags in the command line anymore (4.3 is not a problem).\nThats the build command I use:\n```scons dev_build=yes use_mingw=yes use_llvm=yes dev_mode=yes compiledb=yes linkflags=\"-Wl,-pdb=\" ccflags=\"-g -gcodeview\"```\nAnd it does not add the linkflags anymore.\n\nI could narrow it down to https://github.com/godotengine/godot/blob/1aaf20b1f1f3ab59f04db74b166540327a3f1f90/SConstruct#L616\nAdding a linkflag parameter before is ignored and after not.\nAs this was already there in 4.3, I cannot exactly tell what brought up the behavior in the current master.\n\n\n\n\n### Steps to reproduce\n\nAdd ```env.Append(LINKFLAGS=[\"-Whatever\"])``` before: https://github.com/godotengine/godot/blob/1aaf20b1f1f3ab59f04db74b166540327a3f1f90/SConstruct#L616\nIt is removed.\nAdd ```env.Append(LINKFLAGS=[\"-Whatever\"])``` after the line and it is added.\n\n### Minimal reproduction project (MRP)\n\n---\n", "hints_text": "Confirmed, that's a regression from #98105.\n\nThe `env.Tool(\"mingw\")` added in this PR in the setup function resets flags, and then it just manually reparses 2 of the potential user-defined flags but not `linkflags`.\n\nI'd question whether this change was necessary, this PR seems to add a number of hacks. (Not that it wasn't hacky before, but at least those were battle-tested hacks :P)", "created_at": "2025-01-17 23:15:25", "merge_commit_sha": "46434b0f2ee25f036ce36a7c928438b766ce1fc5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100983", "base_commit": "2582793d408ade0b6ed42f913ae33e7da5fb9184", "patch": "diff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex 50ee2699a244..eccd7c385478 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -59,6 +59,26 @@ JPH::ObjectLayer JoltArea3D::_get_object_layer() const {\n \treturn space->map_to_object_layer(_get_broad_phase_layer(), collision_layer, collision_mask);\n }\n \n+bool JoltArea3D::_has_pending_events() const {\n+\tif (body_monitor_callback.is_valid()) {\n+\t\tfor (const KeyValue<JPH::BodyID, Overlap> &E : bodies_by_id) {\n+\t\t\tif (!E.value.pending_added.is_empty() || !E.value.pending_removed.is_empty()) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (area_monitor_callback.is_valid()) {\n+\t\tfor (const KeyValue<JPH::BodyID, Overlap> &E : areas_by_id) {\n+\t\t\tif (!E.value.pending_added.is_empty() || !E.value.pending_removed.is_empty()) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\treturn false;\n+}\n+\n void JoltArea3D::_add_to_space() {\n \tjolt_shape = build_shape();\n \n@@ -90,6 +110,18 @@ void JoltArea3D::_add_to_space() {\n \tjolt_settings = nullptr;\n }\n \n+void JoltArea3D::_enqueue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->enqueue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n+void JoltArea3D::_dequeue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->dequeue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n void JoltArea3D::_add_shape_pair(Overlap &p_overlap, const JPH::BodyID &p_body_id, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id) {\n \tconst JoltReadableBody3D other_jolt_body = space->read_body(p_body_id);\n \tconst JoltShapedObject3D *other_object = other_jolt_body.as_shaped();\n@@ -270,6 +302,8 @@ void JoltArea3D::_space_changing() {\n \t\t_force_bodies_exited(true);\n \t\t_force_areas_exited(true);\n \t}\n+\n+\t_dequeue_call_queries();\n }\n \n void JoltArea3D::_space_changed() {\n@@ -304,7 +338,8 @@ void JoltArea3D::_gravity_changed() {\n }\n \n JoltArea3D::JoltArea3D() :\n-\t\tJoltShapedObject3D(OBJECT_TYPE_AREA) {\n+\t\tJoltShapedObject3D(OBJECT_TYPE_AREA),\n+\t\tcall_queries_element(this) {\n }\n \n bool JoltArea3D::is_default_area() const {\n@@ -659,7 +694,13 @@ void JoltArea3D::area_exited(const JPH::BodyID &p_body_id) {\n \toverlap->shape_pairs.clear();\n }\n \n-void JoltArea3D::call_queries(JPH::Body &p_jolt_body) {\n+void JoltArea3D::call_queries() {\n \t_flush_events(bodies_by_id, body_monitor_callback);\n \t_flush_events(areas_by_id, area_monitor_callback);\n }\n+\n+void JoltArea3D::post_step(float p_step, JPH::Body &p_jolt_body) {\n+\tif (_has_pending_events()) {\n+\t\t_enqueue_call_queries();\n+\t}\n+}\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.h b/modules/jolt_physics/objects/jolt_area_3d.h\nindex d151a7d05ad3..18410c34cfc2 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.h\n+++ b/modules/jolt_physics/objects/jolt_area_3d.h\n@@ -89,6 +89,8 @@ class JoltArea3D final : public JoltShapedObject3D {\n \n \ttypedef HashMap<JPH::BodyID, Overlap, BodyIDHasher> OverlapsById;\n \n+\tSelfList<JoltArea3D> call_queries_element;\n+\n \tOverlapsById bodies_by_id;\n \tOverlapsById areas_by_id;\n \n@@ -115,8 +117,13 @@ class JoltArea3D final : public JoltShapedObject3D {\n \n \tvirtual JPH::EMotionType _get_motion_type() const override { return JPH::EMotionType::Kinematic; }\n \n+\tbool _has_pending_events() const;\n+\n \tvirtual void _add_to_space() override;\n \n+\tvoid _enqueue_call_queries();\n+\tvoid _dequeue_call_queries();\n+\n \tvoid _add_shape_pair(Overlap &p_overlap, const JPH::BodyID &p_body_id, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id);\n \tbool _remove_shape_pair(Overlap &p_overlap, const JPH::SubShapeID &p_other_shape_id, const JPH::SubShapeID &p_self_shape_id);\n \n@@ -217,10 +224,12 @@ class JoltArea3D final : public JoltShapedObject3D {\n \tvoid body_exited(const JPH::BodyID &p_body_id, bool p_notify = true);\n \tvoid area_exited(const JPH::BodyID &p_body_id);\n \n-\tvoid call_queries(JPH::Body &p_jolt_body);\n+\tvoid call_queries();\n \n \tvirtual bool has_custom_center_of_mass() const override { return false; }\n \tvirtual Vector3 get_center_of_mass_custom() const override { return Vector3(); }\n+\n+\tvirtual void post_step(float p_step, JPH::Body &p_jolt_body) override;\n };\n \n #endif // JOLT_AREA_3D_H\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex 59ba42c6ca91..3768dc8d0a9c 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -128,6 +128,7 @@ void JoltBody3D::_add_to_space() {\n \tjolt_settings->mAllowDynamicOrKinematic = true;\n \tjolt_settings->mCollideKinematicVsNonDynamic = reports_all_kinematic_contacts();\n \tjolt_settings->mUseManifoldReduction = !reports_contacts();\n+\tjolt_settings->mAllowSleeping = is_sleep_actually_allowed();\n \tjolt_settings->mLinearDamping = 0.0f;\n \tjolt_settings->mAngularDamping = 0.0f;\n \tjolt_settings->mMaxLinearVelocity = JoltProjectSettings::get_max_linear_velocity();\n@@ -153,11 +154,19 @@ void JoltBody3D::_add_to_space() {\n \tjolt_settings = nullptr;\n }\n \n-void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n-\tif (!p_jolt_body.IsActive()) {\n-\t\treturn;\n+void JoltBody3D::_enqueue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->enqueue_call_queries(&call_queries_element);\n+\t}\n+}\n+\n+void JoltBody3D::_dequeue_call_queries() {\n+\tif (space != nullptr) {\n+\t\tspace->dequeue_call_queries(&call_queries_element);\n \t}\n+}\n \n+void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n \t_update_gravity(p_jolt_body);\n \n \tif (!custom_integrator) {\n@@ -182,8 +191,6 @@ void JoltBody3D::_integrate_forces(float p_step, JPH::Body &p_jolt_body) {\n \t\tp_jolt_body.AddForce(to_jolt(constant_force));\n \t\tp_jolt_body.AddTorque(to_jolt(constant_torque));\n \t}\n-\n-\tsync_state = true;\n }\n \n void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n@@ -201,27 +208,19 @@ void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \t}\n \n \tp_jolt_body.MoveKinematic(new_position, new_rotation, p_step);\n-\n-\tsync_state = true;\n-}\n-\n-void JoltBody3D::_pre_step_static(float p_step, JPH::Body &p_jolt_body) {\n-\t// Nothing to do.\n }\n \n void JoltBody3D::_pre_step_rigid(float p_step, JPH::Body &p_jolt_body) {\n \t_integrate_forces(p_step, p_jolt_body);\n+\t_enqueue_call_queries();\n }\n \n void JoltBody3D::_pre_step_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \t_update_gravity(p_jolt_body);\n-\n \t_move_kinematic(p_step, p_jolt_body);\n \n \tif (reports_contacts()) {\n-\t\t// This seems to emulate the behavior of Godot Physics, where kinematic bodies are set as active (and thereby\n-\t\t// have their state synchronized on every step) only if its max reported contacts is non-zero.\n-\t\tsync_state = true;\n+\t\t_enqueue_call_queries();\n \t}\n }\n \n@@ -428,6 +427,20 @@ void JoltBody3D::_update_possible_kinematic_contacts() {\n \t}\n }\n \n+void JoltBody3D::_update_sleep_allowed() {\n+\tconst bool value = is_sleep_actually_allowed();\n+\n+\tif (!in_space()) {\n+\t\tjolt_settings->mAllowSleeping = value;\n+\t\treturn;\n+\t}\n+\n+\tconst JoltWritableBody3D body = space->write_body(jolt_id);\n+\tERR_FAIL_COND(body.is_invalid());\n+\n+\tbody->SetAllowSleeping(value);\n+}\n+\n void JoltBody3D::_destroy_joint_constraints() {\n \tfor (JoltJoint3D *joint : joints) {\n \t\tjoint->destroy();\n@@ -460,6 +473,7 @@ void JoltBody3D::_mode_changed() {\n \t_update_object_layer();\n \t_update_kinematic_transform();\n \t_update_mass_properties();\n+\t_update_sleep_allowed();\n \twake_up();\n }\n \n@@ -478,6 +492,7 @@ void JoltBody3D::_space_changing() {\n \n \t_destroy_joint_constraints();\n \t_exit_all_areas();\n+\t_dequeue_call_queries();\n }\n \n void JoltBody3D::_space_changed() {\n@@ -486,9 +501,8 @@ void JoltBody3D::_space_changed() {\n \t_update_kinematic_transform();\n \t_update_group_filter();\n \t_update_joint_constraints();\n+\t_update_sleep_allowed();\n \t_areas_changed();\n-\n-\tsync_state = false;\n }\n \n void JoltBody3D::_areas_changed() {\n@@ -519,11 +533,18 @@ void JoltBody3D::_axis_lock_changed() {\n \n void JoltBody3D::_contact_reporting_changed() {\n \t_update_possible_kinematic_contacts();\n+\t_update_sleep_allowed();\n+\twake_up();\n+}\n+\n+void JoltBody3D::_sleep_allowed_changed() {\n+\t_update_sleep_allowed();\n \twake_up();\n }\n \n JoltBody3D::JoltBody3D() :\n-\t\tJoltShapedObject3D(OBJECT_TYPE_BODY) {\n+\t\tJoltShapedObject3D(OBJECT_TYPE_BODY),\n+\t\tcall_queries_element(this) {\n }\n \n JoltBody3D::~JoltBody3D() {\n@@ -573,7 +594,7 @@ Variant JoltBody3D::get_state(PhysicsServer3D::BodyState p_state) const {\n \t\t\treturn is_sleeping();\n \t\t}\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\treturn can_sleep();\n+\t\t\treturn is_sleep_allowed();\n \t\t}\n \t\tdefault: {\n \t\t\tERR_FAIL_V_MSG(Variant(), vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -596,7 +617,7 @@ void JoltBody3D::set_state(PhysicsServer3D::BodyState p_state, const Variant &p_\n \t\t\tset_is_sleeping(p_value);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\tset_can_sleep(p_value);\n+\t\t\tset_is_sleep_allowed(p_value);\n \t\t} break;\n \t\tdefault: {\n \t\t\tERR_FAIL_MSG(vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -712,6 +733,10 @@ bool JoltBody3D::is_sleeping() const {\n \treturn !body->IsActive();\n }\n \n+bool JoltBody3D::is_sleep_actually_allowed() const {\n+\treturn sleep_allowed && !(is_kinematic() && reports_contacts());\n+}\n+\n void JoltBody3D::set_is_sleeping(bool p_enabled) {\n \tif (!in_space()) {\n \t\tsleep_initially = p_enabled;\n@@ -727,27 +752,14 @@ void JoltBody3D::set_is_sleeping(bool p_enabled) {\n \t}\n }\n \n-bool JoltBody3D::can_sleep() const {\n-\tif (!in_space()) {\n-\t\treturn jolt_settings->mAllowSleeping;\n-\t}\n-\n-\tconst JoltReadableBody3D body = space->read_body(jolt_id);\n-\tERR_FAIL_COND_V(body.is_invalid(), false);\n-\n-\treturn body->GetAllowSleeping();\n-}\n-\n-void JoltBody3D::set_can_sleep(bool p_enabled) {\n-\tif (!in_space()) {\n-\t\tjolt_settings->mAllowSleeping = p_enabled;\n+void JoltBody3D::set_is_sleep_allowed(bool p_enabled) {\n+\tif (sleep_allowed == p_enabled) {\n \t\treturn;\n \t}\n \n-\tconst JoltWritableBody3D body = space->write_body(jolt_id);\n-\tERR_FAIL_COND(body.is_invalid());\n+\tsleep_allowed = p_enabled;\n \n-\tbody->SetAllowSleeping(p_enabled);\n+\t_sleep_allowed_changed();\n }\n \n Basis JoltBody3D::get_principal_inertia_axes() const {\n@@ -1187,11 +1199,7 @@ void JoltBody3D::remove_joint(JoltJoint3D *p_joint) {\n \t_joints_changed();\n }\n \n-void JoltBody3D::call_queries(JPH::Body &p_jolt_body) {\n-\tif (!sync_state) {\n-\t\treturn;\n-\t}\n-\n+void JoltBody3D::call_queries() {\n \tif (custom_integration_callback.is_valid()) {\n \t\tconst Variant direct_state_variant = get_direct_state();\n \t\tconst Variant *args[2] = { &direct_state_variant, &custom_integration_userdata };\n@@ -1218,8 +1226,6 @@ void JoltBody3D::call_queries(JPH::Body &p_jolt_body) {\n \t\t\tERR_PRINT_ONCE(vformat(\"Failed to call state synchronization callback for '%s'. It returned the following error: '%s'.\", to_string(), Variant::get_callable_error_text(state_sync_callback, args, 1, ce)));\n \t\t}\n \t}\n-\n-\tsync_state = false;\n }\n \n void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n@@ -1227,7 +1233,7 @@ void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n \n \tswitch (mode) {\n \t\tcase PhysicsServer3D::BODY_MODE_STATIC: {\n-\t\t\t_pre_step_static(p_step, p_jolt_body);\n+\t\t\t// Will never happen.\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID:\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID_LINEAR: {\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.h b/modules/jolt_physics/objects/jolt_body_3d.h\nindex dc1e258bec86..8e5a149437a3 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_body_3d.h\n@@ -57,6 +57,8 @@ class JoltBody3D final : public JoltShapedObject3D {\n \t};\n \n private:\n+\tSelfList<JoltBody3D> call_queries_element;\n+\n \tLocalVector<RID> exceptions;\n \tLocalVector<Contact> contacts;\n \tLocalVector<JoltArea3D *> areas;\n@@ -96,7 +98,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tuint32_t locked_axes = 0;\n \n-\tbool sync_state = false;\n+\tbool sleep_allowed = true;\n \tbool sleep_initially = false;\n \tbool custom_center_of_mass = false;\n \tbool custom_integrator = false;\n@@ -108,11 +110,13 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvirtual void _add_to_space() override;\n \n+\tvoid _enqueue_call_queries();\n+\tvoid _dequeue_call_queries();\n+\n \tvoid _integrate_forces(float p_step, JPH::Body &p_jolt_body);\n \n \tvoid _move_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n-\tvoid _pre_step_static(float p_step, JPH::Body &p_jolt_body);\n \tvoid _pre_step_rigid(float p_step, JPH::Body &p_jolt_body);\n \tvoid _pre_step_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n@@ -128,6 +132,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid _update_group_filter();\n \tvoid _update_joint_constraints();\n \tvoid _update_possible_kinematic_contacts();\n+\tvoid _update_sleep_allowed();\n \n \tvoid _destroy_joint_constraints();\n \n@@ -144,6 +149,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid _exceptions_changed();\n \tvoid _axis_lock_changed();\n \tvoid _contact_reporting_changed();\n+\tvoid _sleep_allowed_changed();\n \n public:\n \tJoltBody3D();\n@@ -175,8 +181,9 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid put_to_sleep() { set_is_sleeping(true); }\n \tvoid wake_up() { set_is_sleeping(false); }\n \n-\tbool can_sleep() const;\n-\tvoid set_can_sleep(bool p_enabled);\n+\tbool is_sleep_allowed() const { return sleep_allowed; }\n+\tbool is_sleep_actually_allowed() const;\n+\tvoid set_is_sleep_allowed(bool p_enabled);\n \n \tBasis get_principal_inertia_axes() const;\n \tVector3 get_inverse_inertia() const;\n@@ -238,7 +245,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \tvoid add_joint(JoltJoint3D *p_joint);\n \tvoid remove_joint(JoltJoint3D *p_joint);\n \n-\tvoid call_queries(JPH::Body &p_jolt_body);\n+\tvoid call_queries();\n \n \tvirtual void pre_step(float p_step, JPH::Body &p_jolt_body) override;\n \ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex 9c83718fb6e6..577e8157a53d 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -160,13 +160,14 @@ void JoltShapedObject3D::_update_shape() {\n \tconst JoltWritableBody3D body = space->write_body(jolt_id);\n \tERR_FAIL_COND(body.is_invalid());\n \n-\tprevious_jolt_shape = jolt_shape;\n-\tjolt_shape = build_shape();\n-\n-\tif (jolt_shape == previous_jolt_shape) {\n+\tJPH::ShapeRefC new_shape = build_shape();\n+\tif (new_shape == jolt_shape) {\n \t\treturn;\n \t}\n \n+\tprevious_jolt_shape = jolt_shape;\n+\tjolt_shape = new_shape;\n+\n \tspace->get_body_iface().SetShape(jolt_id, jolt_shape, false, JPH::EActivation::DontActivate);\n \n \t_shapes_built();\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\nindex c9e834fd42e2..281591af9a6c 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n@@ -438,7 +438,7 @@ void JoltSoftBody3D::set_is_sleeping(bool p_enabled) {\n \t}\n }\n \n-bool JoltSoftBody3D::can_sleep() const {\n+bool JoltSoftBody3D::is_sleep_allowed() const {\n \tif (!in_space()) {\n \t\treturn true;\n \t}\n@@ -449,7 +449,7 @@ bool JoltSoftBody3D::can_sleep() const {\n \treturn body->GetAllowSleeping();\n }\n \n-void JoltSoftBody3D::set_can_sleep(bool p_enabled) {\n+void JoltSoftBody3D::set_is_sleep_allowed(bool p_enabled) {\n \tif (!in_space()) {\n \t\treturn;\n \t}\n@@ -532,7 +532,7 @@ Variant JoltSoftBody3D::get_state(PhysicsServer3D::BodyState p_state) const {\n \t\t\treturn is_sleeping();\n \t\t}\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\treturn can_sleep();\n+\t\t\treturn is_sleep_allowed();\n \t\t}\n \t\tdefault: {\n \t\t\tERR_FAIL_V_MSG(Variant(), vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\n@@ -555,7 +555,7 @@ void JoltSoftBody3D::set_state(PhysicsServer3D::BodyState p_state, const Variant\n \t\t\tset_is_sleeping(p_value);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_STATE_CAN_SLEEP: {\n-\t\t\tset_can_sleep(p_value);\n+\t\t\tset_is_sleep_allowed(p_value);\n \t\t} break;\n \t\tdefault: {\n \t\t\tERR_FAIL_MSG(vformat(\"Unhandled body state: '%d'. This should not happen. Please report this.\", p_state));\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.h b/modules/jolt_physics/objects/jolt_soft_body_3d.h\nindex 45e8be2e7bf4..f236310f6c69 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.h\n@@ -124,8 +124,8 @@ class JoltSoftBody3D final : public JoltObject3D {\n \tbool is_sleeping() const;\n \tvoid set_is_sleeping(bool p_enabled);\n \n-\tbool can_sleep() const;\n-\tvoid set_can_sleep(bool p_enabled);\n+\tbool is_sleep_allowed() const;\n+\tvoid set_is_sleep_allowed(bool p_enabled);\n \n \tvoid put_to_sleep() { set_is_sleeping(true); }\n \tvoid wake_up() { set_is_sleeping(false); }\ndiff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\nindex 85cf08d4c921..85a29a244bdd 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n@@ -86,10 +86,6 @@ void JoltContactListener3D::OnSoftBodyContactAdded(const JPH::Body &p_soft_body,\n \n #endif\n \n-bool JoltContactListener3D::_is_listening_for(const JPH::Body &p_body) const {\n-\treturn listening_for.has(p_body.GetID());\n-}\n-\n bool JoltContactListener3D::_try_override_collision_response(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings) {\n \tif (p_jolt_body1.IsSensor() || p_jolt_body2.IsSensor()) {\n \t\treturn false;\n@@ -178,16 +174,19 @@ bool JoltContactListener3D::_try_apply_surface_velocities(const JPH::Body &p_jol\n \treturn true;\n }\n \n-bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings) {\n-\tif (p_body1.IsSensor() || p_body2.IsSensor()) {\n+bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings) {\n+\tif (p_jolt_body1.IsSensor() || p_jolt_body2.IsSensor()) {\n \t\treturn false;\n \t}\n \n-\tif (!_is_listening_for(p_body1) && !_is_listening_for(p_body2)) {\n+\tconst JoltBody3D *body1 = reinterpret_cast<JoltBody3D *>(p_jolt_body1.GetUserData());\n+\tconst JoltBody3D *body2 = reinterpret_cast<JoltBody3D *>(p_jolt_body2.GetUserData());\n+\n+\tif (!body1->reports_contacts() && !body2->reports_contacts()) {\n \t\treturn false;\n \t}\n \n-\tconst JPH::SubShapeIDPair shape_pair(p_body1.GetID(), p_manifold.mSubShapeID1, p_body2.GetID(), p_manifold.mSubShapeID2);\n+\tconst JPH::SubShapeIDPair shape_pair(p_jolt_body1.GetID(), p_manifold.mSubShapeID1, p_jolt_body2.GetID(), p_manifold.mSubShapeID2);\n \n \tManifold &manifold = [&]() -> Manifold & {\n \t\tconst MutexLock write_lock(write_mutex);\n@@ -201,8 +200,7 @@ bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JP\n \tmanifold.depth = p_manifold.mPenetrationDepth;\n \n \tJPH::CollisionEstimationResult collision;\n-\n-\tJPH::EstimateCollisionResponse(p_body1, p_body2, p_manifold, collision, p_settings.mCombinedFriction, p_settings.mCombinedRestitution, JoltProjectSettings::get_bounce_velocity_threshold(), 5);\n+\tJPH::EstimateCollisionResponse(p_jolt_body1, p_jolt_body2, p_manifold, collision, p_settings.mCombinedFriction, p_settings.mCombinedRestitution, JoltProjectSettings::get_bounce_velocity_threshold(), 5);\n \n \tfor (JPH::uint i = 0; i < contact_count; ++i) {\n \t\tconst JPH::RVec3 relative_point1 = JPH::RVec3(p_manifold.mRelativeContactPointsOn1[i]);\n@@ -211,8 +209,8 @@ bool JoltContactListener3D::_try_add_contacts(const JPH::Body &p_body1, const JP\n \t\tconst JPH::RVec3 world_point1 = p_manifold.mBaseOffset + relative_point1;\n \t\tconst JPH::RVec3 world_point2 = p_manifold.mBaseOffset + relative_point2;\n \n-\t\tconst JPH::Vec3 velocity1 = p_body1.GetPointVelocity(world_point1);\n-\t\tconst JPH::Vec3 velocity2 = p_body2.GetPointVelocity(world_point2);\n+\t\tconst JPH::Vec3 velocity1 = p_jolt_body1.GetPointVelocity(world_point1);\n+\t\tconst JPH::Vec3 velocity2 = p_jolt_body2.GetPointVelocity(world_point2);\n \n \t\tconst JPH::CollisionEstimationResult::Impulse &impulse = collision.mImpulses[i];\n \n@@ -532,13 +530,7 @@ void JoltContactListener3D::_flush_area_exits() {\n \tarea_exits.clear();\n }\n \n-void JoltContactListener3D::listen_for(JoltShapedObject3D *p_object) {\n-\tlistening_for.insert(p_object->get_jolt_id());\n-}\n-\n void JoltContactListener3D::pre_step() {\n-\tlistening_for.clear();\n-\n #ifdef DEBUG_ENABLED\n \tdebug_contact_count = 0;\n #endif\ndiff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.h b/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\nindex 26136abd83ac..41b3c9ef3bb2 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.h\n@@ -85,7 +85,6 @@ class JoltContactListener3D final\n \t};\n \n \tHashMap<JPH::SubShapeIDPair, Manifold, ShapePairHasher> manifolds_by_shape_pair;\n-\tHashSet<JPH::BodyID, BodyIDHasher> listening_for;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_overlaps;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_enters;\n \tHashSet<JPH::SubShapeIDPair, ShapePairHasher> area_exits;\n@@ -107,12 +106,10 @@ class JoltContactListener3D final\n \tvirtual void OnSoftBodyContactAdded(const JPH::Body &p_soft_body, const JPH::SoftBodyManifold &p_manifold) override;\n #endif\n \n-\tbool _is_listening_for(const JPH::Body &p_body) const;\n-\n \tbool _try_override_collision_response(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings);\n \tbool _try_override_collision_response(const JPH::Body &p_jolt_soft_body, const JPH::Body &p_jolt_other_body, JPH::SoftBodyContactSettings &p_settings);\n \tbool _try_apply_surface_velocities(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, JPH::ContactSettings &p_settings);\n-\tbool _try_add_contacts(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings);\n+\tbool _try_add_contacts(const JPH::Body &p_jolt_body1, const JPH::Body &p_jolt_body2, const JPH::ContactManifold &p_manifold, JPH::ContactSettings &p_settings);\n \tbool _try_evaluate_area_overlap(const JPH::Body &p_body1, const JPH::Body &p_body2, const JPH::ContactManifold &p_manifold);\n \tbool _try_remove_contacts(const JPH::SubShapeIDPair &p_shape_pair);\n \tbool _try_remove_area_overlap(const JPH::SubShapeIDPair &p_shape_pair);\n@@ -131,8 +128,6 @@ class JoltContactListener3D final\n \texplicit JoltContactListener3D(JoltSpace3D *p_space) :\n \t\t\tspace(p_space) {}\n \n-\tvoid listen_for(JoltShapedObject3D *p_object);\n-\n \tvoid pre_step();\n \tvoid post_step();\n \ndiff --git a/modules/jolt_physics/spaces/jolt_space_3d.cpp b/modules/jolt_physics/spaces/jolt_space_3d.cpp\nindex 57d813df2b95..78bdf778f554 100644\n--- a/modules/jolt_physics/spaces/jolt_space_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_space_3d.cpp\n@@ -63,55 +63,36 @@ constexpr double DEFAULT_SOLVER_ITERATIONS = 8;\n } // namespace\n \n void JoltSpace3D::_pre_step(float p_step) {\n-\tbody_accessor.acquire_all();\n-\n \tcontact_listener->pre_step();\n \n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSoftBody()) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n-\t\t\tJoltShapedObject3D *object = reinterpret_cast<JoltShapedObject3D *>(jolt_body->GetUserData());\n-\n-\t\t\tobject->pre_step(p_step, *jolt_body);\n+\tconst JPH::BodyLockInterface &lock_iface = get_lock_iface();\n+\tconst JPH::BodyID *active_rigid_bodies = physics_system->GetActiveBodiesUnsafe(JPH::EBodyType::RigidBody);\n+\tconst JPH::uint32 active_rigid_body_count = physics_system->GetNumActiveBodies(JPH::EBodyType::RigidBody);\n \n-\t\t\tif (object->reports_contacts()) {\n-\t\t\t\tcontact_listener->listen_for(object);\n-\t\t\t}\n-\t\t}\n+\tfor (JPH::uint32 i = 0; i < active_rigid_body_count; i++) {\n+\t\tJPH::Body *jolt_body = lock_iface.TryGetBody(active_rigid_bodies[i]);\n+\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\t\tobject->pre_step(p_step, *jolt_body);\n \t}\n-\n-\tbody_accessor.release();\n }\n \n void JoltSpace3D::_post_step(float p_step) {\n-\tbody_accessor.acquire_all();\n-\n \tcontact_listener->post_step();\n \n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSoftBody()) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n+\t// WARNING: The list of active bodies may have changed between `pre_step` and `post_step`.\n \n-\t\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\tconst JPH::BodyLockInterface &lock_iface = get_lock_iface();\n+\tconst JPH::BodyID *active_rigid_bodies = physics_system->GetActiveBodiesUnsafe(JPH::EBodyType::RigidBody);\n+\tconst JPH::uint32 active_rigid_body_count = physics_system->GetNumActiveBodies(JPH::EBodyType::RigidBody);\n \n-\t\t\tobject->post_step(p_step, *jolt_body);\n-\t\t}\n+\tfor (JPH::uint32 i = 0; i < active_rigid_body_count; i++) {\n+\t\tJPH::Body *jolt_body = lock_iface.TryGetBody(active_rigid_bodies[i]);\n+\t\tJoltObject3D *object = reinterpret_cast<JoltObject3D *>(jolt_body->GetUserData());\n+\t\tobject->post_step(p_step, *jolt_body);\n \t}\n-\n-\tbody_accessor.release();\n }\n \n JoltSpace3D::JoltSpace3D(JPH::JobSystem *p_job_system) :\n-\t\tbody_accessor(this),\n \t\tjob_system(p_job_system),\n \t\ttemp_allocator(new JoltTempAllocator()),\n \t\tlayers(new JoltLayers()),\n@@ -208,44 +189,21 @@ void JoltSpace3D::step(float p_step) {\n \t_post_step(p_step);\n \n \tbodies_added_since_optimizing = 0;\n-\thas_stepped = true;\n \tstepping = false;\n }\n \n void JoltSpace3D::call_queries() {\n-\tif (!has_stepped) {\n-\t\t// We need to skip the first invocation of this method, because there will be pending notifications that need to\n-\t\t// be flushed first, which can cause weird conflicts with things like `_integrate_forces`. This happens to also\n-\t\t// emulate the behavior of Godot Physics, where (active) collision objects must register to have `call_queries`\n-\t\t// invoked, which they don't do until the physics step, which happens after this.\n-\t\t//\n-\t\t// TODO: This would be better solved by just doing what Godot Physics does with `GodotSpace*D::active_list`.\n-\t\treturn;\n-\t}\n-\n-\tbody_accessor.acquire_all();\n-\n-\tconst int body_count = body_accessor.get_count();\n-\n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (!jolt_body->IsSensor() && !jolt_body->IsSoftBody()) {\n-\t\t\t\tJoltBody3D *body = reinterpret_cast<JoltBody3D *>(jolt_body->GetUserData());\n-\t\t\t\tbody->call_queries(*jolt_body);\n-\t\t\t}\n-\t\t}\n+\twhile (body_call_queries_list.first()) {\n+\t\tJoltBody3D *body = body_call_queries_list.first()->self();\n+\t\tbody_call_queries_list.remove(body_call_queries_list.first());\n+\t\tbody->call_queries();\n \t}\n \n-\tfor (int i = 0; i < body_count; ++i) {\n-\t\tif (JPH::Body *jolt_body = body_accessor.try_get(i)) {\n-\t\t\tif (jolt_body->IsSensor()) {\n-\t\t\t\tJoltArea3D *area = reinterpret_cast<JoltArea3D *>(jolt_body->GetUserData());\n-\t\t\t\tarea->call_queries(*jolt_body);\n-\t\t\t}\n-\t\t}\n+\twhile (area_call_queries_list.first()) {\n+\t\tJoltArea3D *body = area_call_queries_list.first()->self();\n+\t\tarea_call_queries_list.remove(area_call_queries_list.first());\n+\t\tbody->call_queries();\n \t}\n-\n-\tbody_accessor.release();\n }\n \n double JoltSpace3D::get_param(PhysicsServer3D::SpaceParameter p_param) const {\n@@ -445,6 +403,30 @@ void JoltSpace3D::try_optimize() {\n \tbodies_added_since_optimizing = 0;\n }\n \n+void JoltSpace3D::enqueue_call_queries(SelfList<JoltBody3D> *p_body) {\n+\tif (!p_body->in_list()) {\n+\t\tbody_call_queries_list.add(p_body);\n+\t}\n+}\n+\n+void JoltSpace3D::enqueue_call_queries(SelfList<JoltArea3D> *p_area) {\n+\tif (!p_area->in_list()) {\n+\t\tarea_call_queries_list.add(p_area);\n+\t}\n+}\n+\n+void JoltSpace3D::dequeue_call_queries(SelfList<JoltBody3D> *p_body) {\n+\tif (p_body->in_list()) {\n+\t\tbody_call_queries_list.remove(p_body);\n+\t}\n+}\n+\n+void JoltSpace3D::dequeue_call_queries(SelfList<JoltArea3D> *p_area) {\n+\tif (p_area->in_list()) {\n+\t\tarea_call_queries_list.remove(p_area);\n+\t}\n+}\n+\n void JoltSpace3D::add_joint(JPH::Constraint *p_jolt_ref) {\n \tphysics_system->AddConstraint(p_jolt_ref);\n }\ndiff --git a/modules/jolt_physics/spaces/jolt_space_3d.h b/modules/jolt_physics/spaces/jolt_space_3d.h\nindex eb666644eae6..989df9a49853 100644\n--- a/modules/jolt_physics/spaces/jolt_space_3d.h\n+++ b/modules/jolt_physics/spaces/jolt_space_3d.h\n@@ -48,6 +48,7 @@\n #include <stdint.h>\n \n class JoltArea3D;\n+class JoltBody3D;\n class JoltContactListener3D;\n class JoltJoint3D;\n class JoltLayers;\n@@ -55,7 +56,8 @@ class JoltObject3D;\n class JoltPhysicsDirectSpaceState3D;\n \n class JoltSpace3D {\n-\tJoltBodyWriter3D body_accessor;\n+\tSelfList<JoltBody3D>::List body_call_queries_list;\n+\tSelfList<JoltArea3D>::List area_call_queries_list;\n \n \tRID rid;\n \n@@ -73,7 +75,6 @@ class JoltSpace3D {\n \n \tbool active = false;\n \tbool stepping = false;\n-\tbool has_stepped = false;\n \n \tvoid _pre_step(float p_step);\n \tvoid _post_step(float p_step);\n@@ -132,6 +133,11 @@ class JoltSpace3D {\n \n \tvoid try_optimize();\n \n+\tvoid enqueue_call_queries(SelfList<JoltBody3D> *p_body);\n+\tvoid enqueue_call_queries(SelfList<JoltArea3D> *p_area);\n+\tvoid dequeue_call_queries(SelfList<JoltBody3D> *p_body);\n+\tvoid dequeue_call_queries(SelfList<JoltArea3D> *p_area);\n+\n \tvoid add_joint(JPH::Constraint *p_jolt_ref);\n \tvoid add_joint(JoltJoint3D *p_joint);\n \tvoid remove_joint(JPH::Constraint *p_jolt_ref);\n", "test_patch": "", "problem_statement": "`RigidBody3D` frozen as kinematic doesn't always report contacts with Jolt Physics\n### Tested versions\n\nReproducible in: 4.4.dev [a7a2a12bfd1c34057f158f4510841bcc766a9348]\n\n### System information\n\nWindows 11 (10.0.26100)\n\n### Issue description\n\nThis is an issue introduced by #100533.\n\nIn short, a `RigidBody3D` frozen with `FREEZE_MODE_KINEMATIC` and `contact_monitor` enabled (along with a non-zero `max_contacts_reported`) is currently only able to report contacts when moving.\n\nThis differs from Godot Physics, where contacts are reported regardless if such a body is stationary or moving.\n\nThe reason for this is that #100533 made it so contacts are only reported for active/awake bodies. The problem with this is that kinematic bodies are only considered to be active/awake for the physics step after having moved, which meant that you'd have to be moving the kinematic body in order for contacts to be reported for it.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Run the main scene.\n- Note how no contact is reported in the Output window until the capsule starts moving.\n- Switch physics engine to `GodotPhysics3D`.\n- Note how contacts are reported right as the box falls on top of the capsule.\n\n### Minimal reproduction project (MRP)\n\n[jolt-kinematic-contacts.zip](https://github.com/user-attachments/files/18219118/jolt-kinematic-contacts.zip)\n`RigidBody3D` frozen as kinematic doesn't always report contacts with Jolt Physics\n### Tested versions\n\nReproducible in: 4.4.dev [a7a2a12bfd1c34057f158f4510841bcc766a9348]\n\n### System information\n\nWindows 11 (10.0.26100)\n\n### Issue description\n\nThis is an issue introduced by #100533.\n\nIn short, a `RigidBody3D` frozen with `FREEZE_MODE_KINEMATIC` and `contact_monitor` enabled (along with a non-zero `max_contacts_reported`) is currently only able to report contacts when moving.\n\nThis differs from Godot Physics, where contacts are reported regardless if such a body is stationary or moving.\n\nThe reason for this is that #100533 made it so contacts are only reported for active/awake bodies. The problem with this is that kinematic bodies are only considered to be active/awake for the physics step after having moved, which meant that you'd have to be moving the kinematic body in order for contacts to be reported for it.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Run the main scene.\n- Note how no contact is reported in the Output window until the capsule starts moving.\n- Switch physics engine to `GodotPhysics3D`.\n- Note how contacts are reported right as the box falls on top of the capsule.\n\n### Minimal reproduction project (MRP)\n\n[jolt-kinematic-contacts.zip](https://github.com/user-attachments/files/18219118/jolt-kinematic-contacts.zip)\n", "hints_text": "\n", "created_at": "2024-12-31 17:45:41", "merge_commit_sha": "1f2d535f78a323fdd7471053af2be3fcaeed4158", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "godotengine/godot", "instance_id": "godotengine__godot-100792", "base_commit": "0f95e9f8e665cedaa5aace5f6f86de2b4b5a8c60", "patch": "diff --git a/doc/classes/EditorScenePostImportPlugin.xml b/doc/classes/EditorScenePostImportPlugin.xml\nindex 0004ec65c646..ddcbb757ad32 100644\n--- a/doc/classes/EditorScenePostImportPlugin.xml\n+++ b/doc/classes/EditorScenePostImportPlugin.xml\n@@ -71,6 +71,7 @@\n \t\t\t<param index=\"0\" name=\"scene\" type=\"Node\" />\n \t\t\t<description>\n \t\t\t\tPre Process the scene. This function is called right after the scene format loader loaded the scene and no changes have been made.\n+\t\t\t\tPre process may be used to adjust internal import options in the [code]\"nodes\"[/code], [code]\"meshes\"[/code], [code]\"animations\"[/code] or [code]\"materials\"[/code] keys inside [code]get_option_value(\"_subresources\")[/code].\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"add_import_option\">\ndiff --git a/editor/import/3d/resource_importer_scene.cpp b/editor/import/3d/resource_importer_scene.cpp\nindex 695c12150df3..fe9e58014197 100644\n--- a/editor/import/3d/resource_importer_scene.cpp\n+++ b/editor/import/3d/resource_importer_scene.cpp\n@@ -2934,38 +2934,22 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \n \tDictionary subresources = p_options[\"_subresources\"];\n \n-\tDictionary node_data;\n-\tif (subresources.has(\"nodes\")) {\n-\t\tnode_data = subresources[\"nodes\"];\n-\t}\n-\n-\tDictionary material_data;\n-\tif (subresources.has(\"materials\")) {\n-\t\tmaterial_data = subresources[\"materials\"];\n-\t}\n-\n-\tDictionary animation_data;\n-\tif (subresources.has(\"animations\")) {\n-\t\tanimation_data = subresources[\"animations\"];\n-\t}\n-\n-\tDictionary mesh_data;\n-\tif (subresources.has(\"meshes\")) {\n-\t\tmesh_data = subresources[\"meshes\"];\n-\t}\n-\n \tError err = OK;\n \n \t// Check whether any of the meshes or animations have nonexistent save paths\n \t// and if they do, fail the import immediately.\n-\terr = _check_resource_save_paths(mesh_data);\n-\tif (err != OK) {\n-\t\treturn err;\n+\tif (subresources.has(\"meshes\")) {\n+\t\terr = _check_resource_save_paths(subresources[\"meshes\"]);\n+\t\tif (err != OK) {\n+\t\t\treturn err;\n+\t\t}\n \t}\n \n-\terr = _check_resource_save_paths(animation_data);\n-\tif (err != OK) {\n-\t\treturn err;\n+\tif (subresources.has(\"animations\")) {\n+\t\terr = _check_resource_save_paths(subresources[\"animations\"]);\n+\t\tif (err != OK) {\n+\t\t\treturn err;\n+\t\t}\n \t}\n \n \tList<String> missing_deps; // for now, not much will be done with this\n@@ -3005,6 +2989,27 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \t\tpost_importer_plugins.write[i]->pre_process(scene, p_options);\n \t}\n \n+\t// data in _subresources may be modified by pre_process(), so wait until now to check.\n+\tDictionary node_data;\n+\tif (subresources.has(\"nodes\")) {\n+\t\tnode_data = subresources[\"nodes\"];\n+\t}\n+\n+\tDictionary material_data;\n+\tif (subresources.has(\"materials\")) {\n+\t\tmaterial_data = subresources[\"materials\"];\n+\t}\n+\n+\tDictionary animation_data;\n+\tif (subresources.has(\"animations\")) {\n+\t\tanimation_data = subresources[\"animations\"];\n+\t}\n+\n+\tDictionary mesh_data;\n+\tif (subresources.has(\"meshes\")) {\n+\t\tmesh_data = subresources[\"meshes\"];\n+\t}\n+\n \tfloat fps = 30;\n \tif (p_options.has(SNAME(\"animation/fps\"))) {\n \t\tfps = (float)p_options[SNAME(\"animation/fps\")];\n", "test_patch": "", "problem_statement": "Unable to assign Skeleton with Import Script\n### Tested versions\r\n\r\n- Reproducible in all 4.x versions.\r\n\r\n### System information\r\n\r\nGodot v4.3.rc3.mono - Linux Mint 22 (Wilma) - X11 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4060 Ti (nvidia; 535.183.01) - AMD Ryzen 7 5700X 8-Core Processor (16 Threads)\r\n\r\n### Issue description\r\n\r\nThe ConfigFile class set_value method erases key/value pair when value is set to null (this is per class docs for ConfigFile.set_value). However, some files such as .glb.import files have required keys stored with explicit values for some options.\r\n\r\nThere is already the method erase_section() and erase_section_key(), and we need the ability to write null values to key/value pairs.\r\n\r\nExample for when we need to be able to write an explicit null:\r\n```\r\n[params]\r\n\r\n{_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"rest_pose/external_animation_library\": null,\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nIf this value is not set, then the entire PATH:Armature/Skeleton3D node is over written by the engine on the next import.\r\nThus an entry to set skeleton  ex. {\"nodes\" : {\"PATH:Armature/Skeleton3D\": {\"retarget/bone_map\": Resource(\"res://bone_map.tres\")}}} will also be erased and unset.\r\n\r\nTo justification that a change is needed:\r\n\r\nIf one copies and pastes a correct but partial entry, the editor will erase the incomplete entry upon next import...example:\r\n```\r\n_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nbecomes:\r\n`_subresources={}`\r\n\r\n\r\n\r\n\r\nIf one copies and pastes the complete correct node entry with the required null value, the editor is fine.  example:\r\n```\r\n_subresources={\r\n\"nodes\": {\r\n\"PATH:Armature/Skeleton3D\": {\r\n\"rest_pose/external_animation_library\": null,\r\n\"retarget/bone_map\": Resource(\"res://explosive_bone_map.tres\")\r\n}\r\n}\r\n}\r\n```\r\n\r\nTherefore one must conclude that the Class used to read and write configuration files such as .import files, should be able to write key/value pairs that include explicit null values.\r\n\r\nThere is already the method erase_section() and erase_section_key(), and we need the ability to write null values to key/value pairs.\r\n\r\n### Steps to reproduce\r\n\r\n\r\n```\r\n@tool # Needed so it runs in editor.\r\nextends EditorScenePostImport\r\n\r\nvar config = ConfigFile.new()\r\n\r\nfunc _post_import(scene):\r\n\tset_skeleton()\r\n\r\nfunc set_skeleton() -> void:\r\n\tvar bone_map : BoneMap = load(\"res://explosive_bone_map.tres\")\r\n\tconfig.load(\"res://relax.glb.import\")\r\n\tvar rest_pose_node : Dictionary\r\n\trest_pose_node = {\"nodes\" : {\"PATH:Armature/Skeleton3D\": {\"rest_post/external_animation_library\": null}}}\r\n\tconfig.set_value(\"params\", \"_subresources\", rest_pose_node)\r\n\tconfig.save(\"res://relax.glb.import\")\r\n\r\n```\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[Animation Test.zip](https://github.com/user-attachments/files/16593811/Animation.Test.zip)\r\n\r\nEDIT: I said FBX by mistake up above, I corrected that to GLB....I am not sure if that's important or not...I would expect the import file behavior to be the same for either.\n", "hints_text": "The FBX code should be changed instead to accept a missing `rest_pose/external_animation_library`.\r\n\r\nChanging the way ConfigFile behaves would break compat.\n@lyuma Could look into this.\nSo there are two things going on here:\r\n\r\nOne is that there's a stray null in the .import file. I have a PR which should fix this, but the null doesn't do anything and so this is a purely cosmetic fix: I don't think this issue is a release blocker.\r\n\r\nThe second problem relates to the discussion from #95413, where I advised use of ConfigFile (typoed as ConfigMap) for modifying the .import file. The issue is that the config file likely will be overwritten after the import finishes, and hence it is not possible to modify the .import from within a PostImport script (or PostImportPlugin) in the way the MRP is doing.\r\n\r\nUnfortunately I'm not aware of a clean way to do what that MRP is trying to do. In my code, I run a script which modifies the .import files specifically when an import is not currently happening, then trigger a reimport after. There's definitely a big API gap here.\r\n\r\nI don't have a suggestion on how to fix the MRP to work correctly, but the closest thing I can think to suggest is run the code outside the import (perhaps in a call_deferred) and then run reimport_files on EditorFileSystem. Make sure to avoid an infinite loop, since the reimport_files will run the script again.\nThank you Lyuma.\r\n\r\nyeah, ok....doing it outside of the import process kind of defeats the point. I was trying to automate all necessary configurations and modifications to an animation library during the import process because this stuff gets written to the res file in the .godot/import folder, the setting the bones up was the last piece of this particular puzzle to fully automate it.\r\n\r\nEDIT: Another thought, I wonder if I could run a tool script that will set the import script up prior to import? Then I could just trigger an import and the skeleton could already be in place before that happens.\r\n\r\nEDIT2: OK, that checks out ... I replicated that workflow manually by cutting the import script configuration item and the _subresources configuration with an external text editor, saving the file, then letting godot reimport and resetting those 2 settings back to default. Then, I pasted those lines back in to the file from the external text editor, saved the file, and triggered another import....Godot set the skeleton and ran the import script with intended results.\r\n\r\nVery kludgy, but it works for now, so thanks\r\n\n> doing it outside of the import process kind of defeats the point\r\n\r\nYeah I agree the usecase of changing settings during import makes sense. I'll try and see if there's a way we can improve the APIs in 4.4 to account for this. Though either way, `EditorScenePostImport` is too late because it literally is the last thing that runs.... so the way your script was written still would have to be changed.\r\n\r\nIn my opinion, `EditorScenePostImportPlugin`, and other such plugins that happen earlier in the import flow, would ideally have a way to adjust import options on the fly without doing a reimport. This is something I hope to make possible in 4.4\n> > doing it outside of the import process kind of defeats the point\r\n> \r\n> Yeah I agree the usecase of changing settings during import makes sense. I'll try and see if there's a way we can improve the APIs in 4.4 to account for this. Though either way, `EditorScenePostImport` is too late because it literally is the last thing that runs.... so the way your script was written still would have to be changed.\r\n> \r\n> In my opinion, `EditorScenePostImportPlugin`, and other such plugins that happen earlier in the import flow, would ideally have a way to adjust import options on the fly without doing a reimport. This is something I hope to make possible in 4.4\r\n\r\nHi Lyuma,\r\nHave you had a chance to look into this? I don't see anything in the PRs that addresses it, but maybe I am just missing it. I am still hoping to fully automate this process so I am not doing it by hand 1600+ times.\r\n\r\nThanks,\r\nScot\r\n\n> > This is something I hope to make possible in 4.4\n> \nBeen fighting with stress and I haven't gotten anywhere near progressing on my ambitious priorities that I put down for 4.4 (I work on Godot as a volunteer).\n\nIf you want to increase the chance that I make this before the 4.4 feature freeze, could you propose some ideas for your dream API to change .import options during import? Like an extra function in post import plugin? Having some direction would help me focus.\n> > This is something I hope to make possible in 4.4\r\n> Been fighting with stress and I haven't gotten anywhere near progressing on my ambitious priorities that I put down for 4.4 (I work on Godot as a volunteer). If you want to increase the chance that I make this before the 4.4 feature freeze, could you propose some ideas for your dream API to change .import options during import? Like an extra function in post import plugin? Having some direction would help me focus.\r\n\r\nLyuma, sorry you are dealing with stress. That really sucks, thank you for what you are able to accomplish. Being the lead dev (whether in name or action) on a section of the engine I am sure has a cost to you.\r\n\r\nReally the most important thing to me is the ability to assign a skeleton from script. The way it is now, I have to manually import the asset (model or animation), assign the skeleton through the UI, reimport, and THEN assign the import script and reimport again.\r\n\r\nBest case be ability to import through script only\r\n\r\nBUT \r\n\r\nIt would already be much better if I could simply assign the skeleton within the script so I don't have so many manual operations per asset (i.e. import, assign script, reimport  (3 ops) vs.  import, open, assign skeleton, reimport, assign script, reimport (6 ops). That alone would cut the work of importing thousands of assets in half.\r\n\r\nThank you for all the hard work you do. \nFrom reading the Godot code, I did find out that you can actually call `get_option_value()` from the `_pre_process` method of EditorScenePostImportPlugin with the argument `_subresources`, and that will return a Dictionary which allows you to modify settings such as the BoneMap of the Armature/Skeleton3D node, without actually needing to modify .import before import. If it were better documented, I think this is pretty reasonable solution.\n\nYou do need to be careful of course when modifying such settings, and having the user go through this instead of having a convenient API will reduce the chance that someone does this unintentionally and makes a mistake, so I would be curious if this gets you unstuck.\n\nThat said, I came here to see if I could improve Godot's APIs.\n\nSo the two things I'm trying to decide between are:\n\n1. To make the options dict mutable (the EditorFileSystem code actually writes the .import file afterwards, so there's no technical reason that it needs to be passed as `const` to the importers.\n\nI do worry there is more of a stylistic reason not to do this: it feels a bit late to modify import options, while the file is already in the process of being imported, particularly the global options since many of them take effect before even the `pre_process` method of `EditorScenePostImportPlugin`. So making it too easy for users to accidentally edit the import options (if the options dictionary is mutable), could lead to inadvertent corruption of the .import settings. It also means we could get into conflicts between plugins since the order things get modified might matter. It just doesn't feel good to rush this into 4.4\n\n2. Add a callback in EditorFileSystem before import, but after assigning the default project settings, so the import settings can be changed. The problem is, I don't think this helps your situation. I think the `_pre_process` is the perfect place to do this, since then you have access to the Node tree and you know which node is the skeleton and so on.\n\nBut if you want to set a setting like `nodes/import_as_skeleton_bones` (which is often useful when importing animation files, for example), that cannot be done from a post-import plugin, since that option is consumed by the GLTF import code. For this type of option, the ability to adjust import settings from EditorFileSystem might be helpful. The main problem I have here is it might imply building a whole plugin system, for a relatively niche usecase: the desired settings are not the default, but you only know the filename and nothing else, how would it know what settings to write to the .import file before the import begins, without knowing more context about the file.\n\nAnyway, maybe I'm just making an excuse to not work on this API for 4.4. But I am really curious if the EditorScenePostImportPlugin idea I had with _subresources works for you, since that would solve most of the problems:\n\n```gd\nextends EditorScenePostImportPlugin\n\nfunc _pre_process(scene: Node):\n\tsubresources = get_option_value(\"_subresources\")\n\tif not subresources.has(\"nodes\"):\n\t\tsubresources[\"nodes\"] = {}\n\n\tvar bone_map : BoneMap = load(\"res://explosive_bone_map.tres\")\n\n\t# Possibly do some recursive search on scene to determine the actual Skeleton3D node. Sometimes it is not inside Armature.\n\tnode_path = \"Armature/Skeleton3D\"\n\tif not subresources[\"nodes\"].has(\"PATH:\" + node_path):\n\t\tsubresources[\"nodes\"][\"PATH:\" + node_path] = {}\n\t\t# Set it in the if statement to allow the user to override after the first import.\n\t\tsubresources[\"nodes\"][\"PATH:\" + node_path][\"retarget/bone_map\"] = bone_map\n```\n\nOoh I think I see the problem... resource_importer_scene.cpp pre-caches the nodes dictionary and fails if it was not assigned to begin with...\n```cpp\n\tDictionary subresources = p_options[\"_subresources\"];\n\n\tDictionary node_data;\n\tif (subresources.has(\"nodes\")) {\n\t\tnode_data = subresources[\"nodes\"];\n\t}\n\n\tDictionary material_data;\n\tif (subresources.has(\"materials\")) {\n\t\tmaterial_data = subresources[\"materials\"];\n\t}\n\n\tDictionary animation_data;\n\tif (subresources.has(\"animations\")) {\n\t\tanimation_data = subresources[\"animations\"];\n\t}\n\n\tDictionary mesh_data;\n\tif (subresources.has(\"meshes\")) {\n\t\tmesh_data = subresources[\"meshes\"];\n\t}\n```\nI think we should simply move these if statements after the _pre_process function, and that's something I should be able to change for Godot 4.4", "created_at": "2024-12-24 15:38:27", "merge_commit_sha": "a7d84fa022334da4e198affc0fe3cd79e8becce5", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Template arm64 (target=template_release, arch=arm64)', '.github/workflows/runner.yml']", "['Template (target=template_release, tests=yes)', '.github/workflows/runner.yml']"], ["['Editor w/ Mono (target=editor)', '.github/workflows/runner.yml']", "['Editor with clang sanitizers (target=editor, tests=yes, dev_build=yes, use_asan=yes, use_ubsan=yes, use_llvm=yes, linker=lld)', '.github/workflows/runner.yml']"], ["['Template w/o threads (target=template_release, threads=no)', '.github/workflows/runner.yml']", "['Template (target=template_release)', '.github/workflows/runner.yml']"], ["['Editor (target=editor, tests=yes)', '.github/workflows/runner.yml']", "['Editor with doubles and GCC sanitizers (target=editor, tests=yes, dev_build=yes, scu_build=yes, precision=double, use_asan=yes, use_ubsan=yes, linker=gold)', '.github/workflows/runner.yml']"], ["['Template w/ Mono (target=template_release, tests=yes)', '.github/workflows/runner.yml']", "['Editor (target=editor)', '.github/workflows/runner.yml']"]]}
{"repo": "bitcoin/bitcoin", "instance_id": "bitcoin__bitcoin-30147", "base_commit": "323b0acfcb9380ce4b3c12a3d0b341d7bb3bfe08", "patch": "diff --git a/contrib/verify-binaries/README.md b/contrib/verify-binaries/README.md\nindex 04d683e69b559..0f3e16a5bc9d3 100644\n--- a/contrib/verify-binaries/README.md\n+++ b/contrib/verify-binaries/README.md\n@@ -50,6 +50,7 @@ Get JSON output and don't prompt for user input (no auto key import):\n \n ```sh\n ./contrib/verify-binaries/verify.py --json pub 22.0-x86\n+./contrib/verify-binaries/verify.py --json pub 23.0-rc5-linux-gnu\n ```\n \n Rely only on local GPG state and manually specified keys, while requiring a\n@@ -57,14 +58,15 @@ threshold of at least 10 trusted signatures:\n ```sh\n ./contrib/verify-binaries/verify.py \\\n     --trusted-keys 74E2DEF5D77260B98BC19438099BAD163C70FBFA,9D3CC86A72F8494342EA5FD10A41BDC3F4FAFF1C \\\n-    --min-good-sigs 10 pub 22.0-x86\n+    --min-good-sigs 10 pub 22.0-linux\n ```\n \n-If you only want to download the binaries for a certain platform, add the corresponding suffix, e.g.:\n+If you only want to download the binaries for a certain architecture and/or platform, add the corresponding suffix, e.g.:\n \n ```sh\n-./contrib/verify-binaries/verify.py pub 24.0.1-darwin\n-./contrib/verify-binaries/verify.py pub 23.1-rc1-win64\n+./contrib/verify-binaries/verify.py pub 25.2-x86_64-linux\n+./contrib/verify-binaries/verify.py pub 24.1-rc1-darwin\n+./contrib/verify-binaries/verify.py pub 27.0-win64-setup.exe\n ```\n \n If you do not want to keep the downloaded binaries, specify the cleanup option.\ndiff --git a/contrib/verify-binaries/verify.py b/contrib/verify-binaries/verify.py\nindex 12e6e10d8a4de..6c07b36c9d8cd 100755\n--- a/contrib/verify-binaries/verify.py\n+++ b/contrib/verify-binaries/verify.py\n@@ -97,23 +97,17 @@ def bool_from_env(key, default=False) -> bool:\n \n \n VERSION_FORMAT = \"<major>.<minor>[.<patch>][-rc[0-9]][-platform]\"\n-VERSION_EXAMPLE = \"22.0-x86_64 or 23.1-rc1-darwin\"\n+VERSION_EXAMPLE = \"22.0 or 23.1-rc1-darwin.dmg or 27.0-x86_64-linux-gnu\"\n \n def parse_version_string(version_str):\n-    parts = version_str.split('-')\n-    version_base = parts[0]\n-    version_rc = \"\"\n-    version_os = \"\"\n-    if len(parts) == 2:  # \"<version>-rcN\" or \"version-platform\"\n-        if \"rc\" in parts[1]:\n-            version_rc = parts[1]\n-        else:\n-            version_os = parts[1]\n-    elif len(parts) == 3:  # \"<version>-rcN-platform\"\n-        version_rc = parts[1]\n-        version_os = parts[2]\n+    # \"<version>[-rcN][-platform]\"\n+    version_base, _, platform = version_str.partition('-')\n+    rc = \"\"\n+    if platform.startswith(\"rc\"): # \"<version>-rcN[-platform]\"\n+        rc, _, platform = platform.partition('-')\n+    # else \"<version>\" or \"<version>-platform\"\n \n-    return version_base, version_rc, version_os\n+    return version_base, rc, platform\n \n \n def download_with_wget(remote_file, local_file):\n@@ -514,7 +508,9 @@ def cleanup():\n     # Extract hashes and filenames\n     hashes_to_verify = parse_sums_file(SUMS_FILENAME, [os_filter])\n     if not hashes_to_verify:\n-        log.error(\"no files matched the platform specified\")\n+        available_versions = [\"-\".join(line[1].split(\"-\")[2:]) for line in parse_sums_file(SUMS_FILENAME, [])]\n+        closest_match = difflib.get_close_matches(os_filter, available_versions, cutoff=0, n=1)[0]\n+        log.error(f\"No files matched the platform specified. Did you mean: {closest_match}\")\n         return ReturnCode.NO_BINARIES_MATCH\n \n     # remove binaries that are known not to be hosted by bitcoincore.org\n", "test_patch": "diff --git a/contrib/verify-binaries/test.py b/contrib/verify-binaries/test.py\nindex 22d718ece334a..875606ec22678 100755\n--- a/contrib/verify-binaries/test.py\n+++ b/contrib/verify-binaries/test.py\n@@ -12,6 +12,21 @@ def main():\n     expect_code(run_verify(\"\", \"pub\", '0.32.awefa.12f9h'), 11, \"Malformed version should fail\")\n     expect_code(run_verify('--min-good-sigs 20', \"pub\", \"22.0\"), 9, \"--min-good-sigs 20 should fail\")\n \n+    print(\"- testing verification (22.0-x86_64-linux-gnu.tar.gz)\", flush=True)\n+    _220_x86_64_linux_gnu = run_verify(\"--json\", \"pub\", \"22.0-x86_64-linux-gnu.tar.gz\")\n+    try:\n+        result = json.loads(_220_x86_64_linux_gnu.stdout.decode())\n+    except Exception:\n+        print(\"failed on 22.0-x86_64-linux-gnu.tar.gz --json:\")\n+        print_process_failure(_220_x86_64_linux_gnu)\n+        raise\n+\n+    expect_code(_220_x86_64_linux_gnu, 0, \"22.0-x86_64-linux-gnu.tar.gz should succeed\")\n+    v = result['verified_binaries']\n+    assert result['good_trusted_sigs']\n+    assert len(v) == 1\n+    assert v['bitcoin-22.0-x86_64-linux-gnu.tar.gz'] == '59ebd25dd82a51638b7a6bb914586201e67db67b919b2a1ff08925a7936d1b16'\n+\n     print(\"- testing verification (22.0)\", flush=True)\n     _220 = run_verify(\"--json\", \"pub\", \"22.0\")\n     try:\n", "problem_statement": "bug: verify-binaries/verify.py incorrectly parses version string; gives error or downloads wrong files\n### Current behaviour\r\n\r\nWhen I run:\r\n`./verify.py pub 27.0-x86_64-linux-gnu` instead of downloading the version I told it, it downloads every version in the SHA256SUMS file starting with the first.\r\n\r\nThe `version_os` and (also `version_rc`) are completely ignored which causes wrong files to download when an -rcN is intended.\r\n\r\nWhen I attempt to work around and give it a 1 dash string such as\r\n`./verify.py pub 27.0-x86_64` it will start with bitcoin-27.0-x86_64-apple-darwin which is not useful if I only needed bitcoin-27.0-x86_64-linux-gnu.\r\n\r\nUpdate: it will also parse `\"27.0-aarch64\"` wrong. Setting `rc_version=\"aarch64\"` which causes no file found errors. But this is a valid string.\r\n\r\n### Expected behaviour\r\n\r\nI expected it to only download bitcoin-27.0-x86_64-linux-gnu.tar.gz when I run `./verify.py pub 27.0-x86_64-linux-gnu`.\r\nI expected `rc_version` to be set to the `-rcN` release candidate number as per the comments and documentation.\r\n\r\n### Steps to reproduce\r\n\r\nFollow the instructions in the README.md \r\n> If you only want to download the binaries for a certain platform, add the corresponding suffix, e.g.:\r\n\r\nBut instead of the examples, give it a platform suffix with any dashes and it will ignore the requested platform.\r\nOr give \"<version>-aarch64\" and aarch64 it will be interpreted as a release candidate number causing errors.\r\n\r\n### Relevant log output\r\n\r\n```\r\n./verify.py pub 27.0-x86_64-linux-gnu\r\n[INFO] got file https://bitcoincore.org/bin/bitcoin-core-27.0/SHA256SUMS.asc as SHA256SUMS.asc\r\n[WARNING] https://bitcoin.org failed to provide file (https://bitcoin.org/bin/bitcoin-core-27.0/SHA256SUMS.asc). Continuing based solely upon https://bitcoincore.org.\r\n[INFO] got file https://bitcoincore.org/bin/bitcoin-core-27.0/SHA256SUMS as SHA256SUMS\r\n[WARNING] https://bitcoin.org failed to provide file (https://bitcoin.org/bin/bitcoin-core-27.0/SHA256SUMS). Continuing based solely upon https://bitcoincore.org.\r\n[INFO] got 3 good signatures\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('1E4AED62986CD25D', 'Wladimir J. van der Laan <laanwj@protonmail.com>', trusted=False, status='')\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('17565732E08E5E41', 'Ava Chow <me@achow101.com>', trusted=False, status='')\r\n[INFO] GOOD SIGNATURE (untrusted): SigData('3152347D07DA627C', 'Stephan Oeste (it) <it@oeste.de>', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('410108112E7EA81F', 'hebasto@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('C2371D91CB716EA7', 'sebastian.falbesoner@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('E7E2984B6289C93A', 'pinheadmz@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('2EEB9F5CC09526C1', 'fanquake@gmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('F62711DBDCA8AE56', 'kvaciral@protonmail.com', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('57FF9BDBCC301009', '', trusted=False, status='')\r\n[WARNING] UNKNOWN SIGNATURE: SigData('8E4256593F177720', 'gugger@gmail.com', trusted=False, status='')\r\n[INFO] removing *-unsigned binaries (bitcoin-27.0-arm64-apple-darwin-unsigned.tar.gz, bitcoin-27.0-arm64-apple-darwin-unsigned.zip, bitcoin-27.0-x86_64-apple-darwin-unsigned.tar.gz, bitcoin-27.0-x86_64-apple-darwin-unsigned.zip, bitcoin-27.0-win64-setup-unsigned.exe, bitcoin-27.0-win64-unsigned.tar.gz) from verification since https://bitcoincore.org does not host *-unsigned binaries\r\n[INFO] removing *-debug binaries (bitcoin-27.0-aarch64-linux-gnu-debug.tar.gz, bitcoin-27.0-arm-linux-gnueabihf-debug.tar.gz, bitcoin-27.0-powerpc64-linux-gnu-debug.tar.gz, bitcoin-27.0-powerpc64le-linux-gnu-debug.tar.gz, bitcoin-27.0-riscv64-linux-gnu-debug.tar.gz, bitcoin-27.0-x86_64-linux-gnu-debug.tar.gz, bitcoin-27.0-win64-debug.zip) from verification since https://bitcoincore.org does not host *-debug binaries\r\n[INFO] removing *-codesignatures binaries (bitcoin-27.0-codesignatures-27.0.tar.gz) from verification since https://bitcoincore.org does not host *-codesignatures binaries\r\n[INFO] downloading bitcoin-27.0-aarch64-linux-gnu.tar.gz to /tmp/bitcoin_verify_binaries.27.0-x86_64-linux-gnu\r\n```\r\n\r\n```\r\namnesia@amnesia:~/.local/share/bitcoin-core$ ./verify.py pub 27.0-aarch64\r\n[ERROR] couldn't fetch file (https://bitcoincore.org/bin/bitcoin-core-27.0/test.aarch64/SHA256SUMS.asc). Have you specified the version number in the following format?\r\n<major>.<minor>[.<patch>][-rc[0-9]][-platform] (example: 22.0-x86_64 or 23.1-rc1-darwin)\r\nwget output:\r\n  --2024-05-21 12:28:08--  https://bitcoincore.org/bin/bitcoin-core-27.0/test.aarch64/SHA256SUMS.asc\r\n  Resolving bitcoincore.org (bitcoincore.org)... 198.251.83.116\r\n  Connecting to bitcoincore.org (bitcoincore.org)|198.251.83.116|:443... connected.\r\n  HTTP request sent, awaiting response... 404 Not Found\r\n  2024-05-21 12:28:14 ERROR 404: Not Found.\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\ngit clone\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nmaster / 27.0\r\n\r\n### Operating system and version\r\n\r\nDebian 12\r\n\r\n### Machine specifications\r\n\r\nVM, 4GB RAM, virtIO SSD, wired\n", "hints_text": "I would like to be assigned to this issue and will send a PR in an hour.", "created_at": "2024-05-21 17:18:00", "merge_commit_sha": "2cd7c6bd939e4e37b00b5b822b62eb933f720dc6", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Win64 native, VS 2022', '.github/workflows/ci.yml']", "['macOS 13 native, x86_64, no depends, sqlite only, gui', '.github/workflows/ci.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17993", "base_commit": "489a0f082d16e0ed5fe40f31eaf08ea7aeaf0838", "patch": "diff --git a/src/cascadia/QueryExtension/ExtensionPalette.cpp b/src/cascadia/QueryExtension/ExtensionPalette.cpp\nindex 61657a7810a..bfae56125be 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.cpp\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.cpp\n@@ -382,6 +382,7 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n         const auto key = e.OriginalKey();\n         const auto coreWindow = CoreWindow::GetForCurrentThread();\n         const auto ctrlDown = WI_IsFlagSet(coreWindow.GetKeyState(winrt::Windows::System::VirtualKey::Control), CoreVirtualKeyStates::Down);\n+        const auto shiftDown = WI_IsFlagSet(coreWindow.GetKeyState(winrt::Windows::System::VirtualKey::Shift), CoreVirtualKeyStates::Down);\n \n         if (key == VirtualKey::Escape)\n         {\n@@ -393,7 +394,7 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n \n             e.Handled(true);\n         }\n-        else if (key == VirtualKey::Enter)\n+        else if (key == VirtualKey::Enter && !shiftDown)\n         {\n             if (const auto& textBox = e.OriginalSource().try_as<TextBox>())\n             {\ndiff --git a/src/cascadia/QueryExtension/ExtensionPalette.xaml b/src/cascadia/QueryExtension/ExtensionPalette.xaml\nindex 2f807a86e4a..f6f3dce09ff 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.xaml\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.xaml\n@@ -392,6 +392,7 @@\n                      Height=\"100\"\r\n                      Margin=\"16,0,16,4\"\r\n                      Padding=\"18,8,8,8\"\r\n+                     AcceptsReturn=\"True\"\r\n                      IsSpellCheckEnabled=\"False\"\r\n                      PlaceholderText=\"{x:Bind QueryBoxPlaceholderText}\"\r\n                      Text=\"\"\r\n", "test_patch": "", "problem_statement": "[Terminal Chat] Shift+Enter should add a newline in the textbox\nI pressed \"Shift+Enter\" expecting a newline and accidentally submitted my query.\r\n\r\nWith the text box being so large, it feels like \"Shift+Enter\" should be accepted to add newlines.\r\n\r\nI _think_ this is an easy fix. We might just have to use this property: https://learn.microsoft.com/en-us/uwp/api/windows.ui.xaml.controls.textbox.acceptsreturn?view=winrt-26100#windows-ui-xaml-controls-textbox-acceptsreturn\n", "hints_text": "", "created_at": "2024-10-03 21:08:14", "merge_commit_sha": "c989f86ad61d357deb43bb20983cec5c179880da", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
{"repo": "microsoft/terminal", "instance_id": "microsoft__terminal-17738", "base_commit": "9b21b78feea9ff0a0b9ff2c8fa4b4aa5602d3889", "patch": "diff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 07918e902bc..0eebe1308c9 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -2029,6 +2029,7 @@ void StateMachine::ProcessString(const std::wstring_view string)\n     if (_state != VTStates::Ground)\r\n     {\r\n         const auto run = _CurrentRun();\r\n+        auto cacheUnusedRun = true;\r\n \r\n         // One of the \"weird things\" in VT input is the case of something like\r\n         // <kbd>alt+[</kbd>. In VT, that's encoded as `\\x1b[`. However, that's\r\n@@ -2066,15 +2067,22 @@ void StateMachine::ProcessString(const std::wstring_view string)\n                     _ActionEscDispatch(run.back());\r\n                 }\r\n                 _EnterGround();\r\n+                // No need to cache the run, since we've dealt with it now.\r\n+                cacheUnusedRun = false;\r\n             }\r\n         }\r\n-        else if (_state != VTStates::SosPmApcString && _state != VTStates::DcsPassThrough && _state != VTStates::DcsIgnore)\r\n+        else if (_state == VTStates::SosPmApcString || _state == VTStates::DcsPassThrough || _state == VTStates::DcsIgnore)\r\n         {\r\n-            // If the engine doesn't require flushing at the end of the string, we\r\n-            // want to cache the partial sequence in case we have to flush the whole\r\n-            // thing to the terminal later. There is no need to do this if we've\r\n-            // reached one of the string processing states, though, since that data\r\n+            // There is no need to cache the run if we've reached one of the\r\n+            // string processing states in the output engine, since that data\r\n             // will be dealt with as soon as it is received.\r\n+            cacheUnusedRun = false;\r\n+        }\r\n+\r\n+        // If the run hasn't been dealt with in one of the cases above, we cache\r\n+        // the partial sequence in case we have to flush the whole thing later.\r\n+        if (cacheUnusedRun)\r\n+        {\r\n             if (!_cachedSequence)\r\n             {\r\n                 _cachedSequence.emplace(std::wstring{});\r\n", "test_patch": "", "problem_statement": "Pasting specific texts into vim (WSL) breaks some keys\n### Windows Terminal version\r\n\r\n1.20.10303.0 and 1.19.10302.0\r\n\r\n### Windows build number\r\n\r\n10.0.22621.0\r\n\r\n### Other Software\r\n\r\nvim 9.1.31 in WSL\r\nnvim v0.9.5 in WSL\r\n\r\n### Steps to reproduce\r\n\r\n1. Open vim in WSL using Terminal 1.20.10303.0 or 1.19.10302.0. **Version 1.18.10301.0 is unaffected.**\r\n2. Enter insert mode by pressing i.\r\n3. Paste in the following text with right click or shift+insert: https://gist.githubusercontent.com/csdivad/8c1069a35b52fb806ee8e4484b38f1f3/raw/37616af9daee626df6e7065059de5d5d87d8c9ec/test.txt\r\n\r\nThis input is a base64 encoded chunk of Lorem Ipsum.\r\nThe issue only happens with specific inputs. I encountered it first when pasting another base64 encoded text, but that had sensitive data in it.\r\nThen I played around with `dd if=lorem.txt bs=1 count=... | base64 -w 180` until I found a configuration that also triggered the issue.\r\n\r\n### Expected Behavior\r\n\r\nEscape, backspace and Function keys works properly after the paste.\r\nOnly the pasted text appears in the editor.\r\n\r\n### Actual Behavior\r\n\r\nYou are now stuck in editing mode. Esc, backspace and other keys are now sending weird escape sequences.\r\nAfter the last character a `1~` appears. Pressing esc inserts `^[`, pressing backspace inserts `^?`.\n", "hints_text": "Git bisect suggests that this broke in revision efbfb12145da959f74c368cdfc92f7892ce724d5. I'm not sure why though.\r\n\r\n@csdivad I think you should be able to escape from this state in vim by pressing <kbd>Ctrl</kbd>+<kbd>C</kbd>.\nI have a little more information now. It looks like the bracketed paste sequences are getting corrupted somehow. The paste starts with the opening sequence (`\\e[200~`), but only ends with part of the closing sequence (`1~`).\r\n\r\nAs a result, vim thinks you're still pasting content, so it won't process any command keys unless you manually terminate the paste. <kbd>Ctrl</kbd>+<kbd>C</kbd> is one way of doing that, but you could also enter the closing bracket sequence manually: <kbd>Esc</kbd> <kbd>[</kbd> <kbd>2</kbd> <kbd>0</kbd> <kbd>1</kbd> <kbd>~</kbd>.\r\n\r\nThe length of the paste seems to be a factor in the bug, because for every additional character I add to the pasted content, one more character is included in the closing bracket sequence, until it's sending the full sequence. At that point, additional content doesn't seem make any difference.\nI think I know why it's failing now. There's assumedly a 4096 byte buffer somewhere, and the pasted content along with the bracketed paste sequences adds up to just over 4096 bytes. As a result, the closing bracket sequence is cut off, and what we end up receiving in the initial packet is something like this:\r\n\r\n```\r\n\\e[200~ ... PASTED CONTENT ... \\e[20\r\n```\r\n\r\nWhen the parser gets to that last escape, we have [a heuristic](https://github.com/microsoft/terminal/blob/ef96e225da6b0df496390eed9fe31dc7e434a939/src/terminal/parser/stateMachine.cpp#L2155) that looks for a single escape, or a two byte Alt+key sequence, but this fits neither of those patterns, so it seems we just drop those characters!\r\n\r\nThen when the next packet arrives, we get the remaining characters for the closing bracket (`1~`), but since the start of the sequence has been lost, it's now just treated as plain text.\r\n\r\nThe more I think about, the more convinced I am that what we're doing here is completely wrong, but I don't know what the correct solution would be.\nhttps://github.com/microsoft/terminal/blob/ef96e225da6b0df496390eed9fe31dc7e434a939/src/terminal/parser/stateMachine.cpp#L2152-L2155\r\n\r\nI wonder if it's sufficient to *always* switch into a normal VT state machine mode once we've encountered a Win32 Input Mode sequence, e.g.:\r\n\r\n```\r\n        if (_isEngineForInput && !_engine->EncounteredWin32InputModeSequence())\r\n        {\r\n```\nCould we just amend the heuristic to also account for bracketed paste mode? Like, if we've started a bracketed paste, don't ever flush the state machine at the end of a write? Not sure how bad that would be.\nSorry, I think I've been misleading everyone. I've just been looking at this again, and I now realise that my initial understanding was wrong.\r\n\r\nWhen the first packet ends with half an escape sequence (the `\\e[20`), I thought it just dropped those characters, but that's not actually what's happening. They've already been parsed and are now \"preserved\" in the state machine, which is why it's not in the ground state. When the next packet arrives, it does actually continue parsing the sequence from where it left off, but that's the point when something goes wrong which I'm not sure I understand.\r\n\r\nIt gets to a point where it decides it should flush the content to the input queue. However, the only thing it can flush is what it has in the current buffer, which is the second half of the sequence. So I think that's how the first half ends up being dropped, and vim sees the second half of the sequence as additional pasted text.\r\n\r\nI think it's best I leave this to someone else to figure out, because I seem to be out of my depth here.\nAny update on this?\r\nThe issue is now present in the Store release (1.19.10573.0).\nI've just had this issue come up again in a different context (a VT query response that exceeded 4K), and I think I have a better understanding of what's going wrong now.\r\n\r\nAs I mentioned above:\r\n> It gets to a point where it decides it should flush the content to the input queue. However, the only thing it can flush is what it has in the current buffer, which is the second half of the sequence.\r\n\r\nBut the state machine already has a process for dealing with this. If you exit the state machine and you're not in the ground state, it can save the current run in the `_cachedSequence` field. Then if it needs to flush at a later point in time, it can combine the `_cachedSequence` with the latest run so you won't lose anything.\r\n\r\nThe problem is that this process is only applied to the output state machine. See here:\r\nhttps://github.com/microsoft/terminal/blob/0199ca33ddb4a02ca3549627d772ce6b330ed1ce/src/terminal/parser/stateMachine.cpp#L2073-L2084\r\n\r\nSo I think all we need to do is copy that chunk of code up a couple of lines into the `_isEngineForInput` branch and all will be good.\r\n\r\nI've done a basic test with this patch, and it seems to fix my problem as well as the vim pasting bug described in this issue. I don't know if there are any edge cases I'm missing though.", "created_at": "2024-08-18 21:52:55", "merge_commit_sha": "131728b17d50a81d0ecc0686589a2742b7742149", "environment_setup_commit": "", "version": "0.0", "FAIL_TO_PASS": [], "PASS_TO_PASS": [], "ci_name_list": [["['Report (PR)', '.github/workflows/spelling2.yml']", "['Spell checking', '.github/workflows/spelling2.yml']"]]}
