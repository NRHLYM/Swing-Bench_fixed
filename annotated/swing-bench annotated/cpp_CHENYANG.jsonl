{"problem_statement": "Pass vertex and index versions as arguments instead of having them as globals.\nHaving gEncodeVertexVersion and gEncodeIndexVersion as globals makes the meshoptimizer library difficult to use correctly in a multithreaded program, when some threads may be want to write with different versions.\n", "patch": "diff --git a/README.md b/README.md\nindex 9ea6ed923..985d14eff 100644\n--- a/README.md\n+++ b/README.md\n@@ -253,7 +253,7 @@ For optimal compression results, the values must be quantized to small integers.\n For single-precision floating-point data, it's recommended to use `meshopt_quantizeFloat` to remove entropy from the lower bits of the mantissa. Due to current limitations of the codec, the bit count needs to be 15 (23-8) for good results (7 can be used for more extreme compression).\n For normal or tangent vectors, using octahedral encoding is recommended over three components as it reduces redundancy. Similarly to other quantized values, consider using 10-12 bits per component instead of 16.\n \n-When data is bit packed, using v1 vertex codec (via `meshopt_encodeVertexVersion(1)`) and specifying compression level 3 (`meshopt_encodeVertexBufferLevel`) can improve the compression further by redistributing bits between components. Note that v1 vertex codec is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n+When data is bit packed, using v1 vertex codec and specifying compression level 3 (`meshopt_encodeVertexBufferLevel` with level 3 and version 1) can improve the compression further by redistributing bits between components. Note that v1 vertex codec (`meshopt_encodeVertexVersion(1)`) is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n \n To further leverage the inherent structure of some data, the preparation stage can use filters that encode and decode the data in a lossy manner. This is similar to quantization but can be used without having to change the shader code. After decoding, the filter transformation needs to be reversed. For native game engine pipelines, it is usually more optimal to carefully prequantize and pretransform the vertex data, but sometimes (for example when serializing data in glTF format) this is not a practical option and filters are more practical. This library provides three filters:\n \n@@ -618,7 +618,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_buildMeshletsFlex`\n - `meshopt_buildMeshletsSplit`\n - `meshopt_computeSphereBounds`*\n-- `meshopt_encodeVertexBufferLevel`*\n+- `meshopt_encodeVertexBufferLevel`\n - `meshopt_generateProvokingIndexBuffer`*\n - `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex a98c69461..a06a54f04 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -893,7 +893,7 @@ void encodeVertex(const Mesh& mesh, const char* pvn, int level = 2)\n \tdouble start = timestamp();\n \n \tstd::vector<unsigned char> vbuf(meshopt_encodeVertexBufferBound(mesh.vertices.size(), sizeof(PV)));\n-\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level));\n+\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level, -1));\n \n \tdouble middle = timestamp();\n \ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 84ba1a7ab..ef6c4a93f 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -304,8 +304,9 @@ MESHOPTIMIZER_API size_t meshopt_encodeVertexBufferBound(size_t vertex_count, si\n  * The default compression level implied by meshopt_encodeVertexBuffer is 2.\n  *\n  * level should be in the range [0, 3] with 0 being the fastest and 3 being the slowest and producing the best compression ratio.\n+ * version should be -1 to use the default version (specified via meshopt_encodeVertexVersion), or 0/1 to override the version; per above, level won't take effect if version is 0.\n  */\n-MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level);\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version);\n \n /**\n  * Set vertex encoder format version\ndiff --git a/src/vertexcodec.cpp b/src/vertexcodec.cpp\nindex 53cf9d753..847589b3d 100644\n--- a/src/vertexcodec.cpp\n+++ b/src/vertexcodec.cpp\n@@ -1643,13 +1643,16 @@ static unsigned int cpuid = getCpuFeatures();\n \n } // namespace meshopt\n \n-size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level)\n+size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version)\n {\n \tusing namespace meshopt;\n \n \tassert(vertex_size > 0 && vertex_size <= 256);\n \tassert(vertex_size % 4 == 0);\n \tassert(level >= 0 && level <= 9); // only a subset of this range is used right now\n+\tassert(version < 0 || unsigned(version) <= kDecodeVertexVersion);\n+\n+\tversion = version < 0 ? gEncodeVertexVersion : version;\n \n #if TRACE\n \tmemset(vertexstats, 0, sizeof(vertexstats));\n@@ -1663,8 +1666,6 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \tif (size_t(data_end - data) < 1)\n \t\treturn 0;\n \n-\tint version = gEncodeVertexVersion;\n-\n \t*data++ = (unsigned char)(kVertexHeader | version);\n \n \tunsigned char first_vertex[256] = {};\n@@ -1777,7 +1778,7 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \n size_t meshopt_encodeVertexBuffer(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size)\n {\n-\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel);\n+\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel, meshopt::gEncodeVertexVersion);\n }\n \n size_t meshopt_encodeVertexBufferBound(size_t vertex_count, size_t vertex_size)\ndiff --git a/tools/codecfuzz.cpp b/tools/codecfuzz.cpp\nindex 89bce2409..4992857e3 100644\n--- a/tools/codecfuzz.cpp\n+++ b/tools/codecfuzz.cpp\n@@ -26,12 +26,12 @@ void fuzzRoundtrip(const uint8_t* data, size_t size, size_t stride, int level)\n \tvoid* decoded = malloc(count * stride);\n \tassert(encoded && decoded);\n \n-\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level);\n+\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level, -1);\n \tassert(res > 0 && res <= bound);\n \n \t// encode again at the boundary to check for memory safety\n \t// this should produce the same output because encoder is deterministic\n-\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level);\n+\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level, -1);\n \tassert(rese == res);\n \n \tint rc = meshopt_decodeVertexBuffer(decoded, count, stride, static_cast<unsigned char*>(encoded) + bound - res, res);\n", "instance_id": "zeux__meshoptimizer-882", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in its intent: it aims to address a threading issue in the meshoptimizer library by passing vertex and index versions as arguments instead of using global variables. The goal is understandable, and the motivation (multithreading safety) is explicitly stated. However, the statement lacks critical details such as specific input/output expectations, constraints on the version values, or how the change should interact with existing functionality. Additionally, there are no examples or edge cases mentioned (e.g., what happens if an invalid version is passed?). While the code changes provide some context, the problem description itself could benefit from more specificity regarding the expected behavior and scope of the modification. Thus, it falls into the \"Mostly Clear\" category with minor details missing.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following analysis based on the provided factors:\n\n1. **Scope and Depth of Code Changes:** The changes are relatively localized, affecting a few files (`meshoptimizer.h`, `vertexcodec.cpp`, `demo/main.cpp`, `tools/codecfuzz.cpp`, and `README.md`). The modifications primarily involve adding a new parameter (`version`) to an existing function (`meshopt_encodeVertexBufferLevel`) and updating its usage across the codebase. The changes do not significantly impact the system's architecture, as they are more of a refactoring to improve thread safety rather than a fundamental redesign. The amount of code change is small, mostly involving parameter additions and minor logic updates.\n\n2. **Number of Technical Concepts:** The problem requires understanding basic C++ concepts such as function signatures, parameter passing, and global variables. It also involves a minor grasp of the meshoptimizer library's encoding mechanism (specifically vertex encoding versions). However, no advanced algorithms, design patterns, or domain-specific knowledge beyond basic library usage are needed. The concept of thread safety is mentioned, but the solution does not require implementing complex synchronization mechanisms\u2014just removing reliance on globals.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the code changes introduce a simple validation (`assert(version < 0 || unsigned(version) <= kDecodeVertexVersion)`) to handle invalid version inputs. The error handling added is minimal and straightforward, and no complex edge cases (e.g., performance implications in multithreaded environments) are addressed or required based on the provided diff.\n\n4. **Overall Complexity:** The task involves straightforward refactoring with a clear goal. It requires understanding the purpose of the `version` parameter and ensuring consistency across function calls, but it does not demand deep knowledge of the codebase or intricate logic. The changes are mechanical in nature\u2014adding a parameter and updating callsites\u2014making this a relatively simple modification for someone familiar with C++.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires understanding some code logic and making simple function modifications. It is slightly above the lower end of the easy range due to the need to ensure consistency across multiple files, but it does not approach medium difficulty as the changes are not complex or impactful enough.", "clarity_label": 1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Handle nicely `SET` failure with `ER_WRONG_ARGUMENTS` for `sql_generate_invisible_primary_key`\n## Description\r\n\r\nIf you are submitting a reproducible bug report, please provide:\r\n\r\n- [x] A clear description of the issue\r\n\r\nMySQL has changed how the setting `sql_generate_invisible_primary_key` is reported for `Galera`. For version `8.0.28-26.10` error was still `ER_UNKNOWN_SYSTEM_VARIABLE`, yet in newer versions like `8.0.34-26.15` error has changed to `ER_WRONG_ARGUMENTS`:\r\n\r\n```\r\nAnd the error reported by MySQL is now ERROR 1210 (HY000): Variable not supported in combination with Galera\r\n```\r\n\r\nSince this error is equivalent to the one previously reported as `ER_UNKNOWN_SYSTEM_VARIABLE`, we should identify it and handle it the same way we previously did.\r\n\r\n- [x] ProxySQL version\r\n\r\nDevelopment branch `2.x`.\r\n\r\n- [x] The steps to reproduce the issue\r\n\r\nCreate a `mysql` session against ProxySQL using `MySQL Galera` with server version `8.0.34-26.15`. Change the value for `sql_generate_invisible_primary_key` and perform a query. ProxySQL reports the following in the error log:\r\n\r\n```\r\n2024-07-17 11:17:02 MySQL_Session.cpp:2970:handler_again___status_SETTING_GENERIC_VARIABLE(): [WARNING] Error while setting sql_generate_invisible_primary_key to \"ON\" on 127.0.0.1:15307 hg 101 :  1210, Variable not supported in combination with Galera\r\n```\r\n\r\n## Fix\r\n\r\nProposed fix is bundled in PR #4588. \r\n\n", "patch": "diff --git a/include/MySQL_Variables.h b/include/MySQL_Variables.h\nindex 678d594a06..4d0aa5c8a9 100644\n--- a/include/MySQL_Variables.h\n+++ b/include/MySQL_Variables.h\n@@ -20,6 +20,7 @@ bool update_server_variable(MySQL_Session* session, int idx, int &_rc);\n bool verify_server_variable(MySQL_Session* session, int idx, uint32_t client_hash, uint32_t server_hash);\n bool verify_set_names(MySQL_Session* session);\n bool logbin_update_server_variable(MySQL_Session* session, int idx, int &_rc);\n+bool is_perm_track_err(int err, const char* varname);\n \n class MySQL_Variables {\n \tstatic verify_var verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/include/proxysql.h b/include/proxysql.h\nindex 90c881d414..8b6d1d4d50 100644\n--- a/include/proxysql.h\n+++ b/include/proxysql.h\n@@ -117,6 +117,10 @@ void proxy_info_(const char* msg, ...);\n #ifdef DEBUG\n void init_debug_struct();\n void init_debug_struct_from_cmdline();\n+/**\n+ * @brief Add a debug entry in the error log. To be used through 'proxy_debug' macro.\n+ * @details This function saves/restores the previous 'errno' value.\n+ */\n __attribute__((__format__ (__printf__, 7, 8)))\n void proxy_debug_func(enum debug_module, int, int, const char *, int, const char *, const char *, ...);\n void proxy_debug_get_filters(std::set<std::string>&);\ndiff --git a/include/proxysql_structs.h b/include/proxysql_structs.h\nindex f3d322305c..deac187de0 100644\n--- a/include/proxysql_structs.h\n+++ b/include/proxysql_structs.h\n@@ -277,6 +277,11 @@ typedef struct {\n \tchar * default_value;       // default value\n \tbool is_global_variable;\t// is it a global variable?\n } mysql_variable_st;\n+\n+typedef struct {\n+\tint err;\n+\tconst char* name;\n+} var_track_err_st;\n #endif\n \n enum mysql_data_stream_status {\n@@ -1218,10 +1223,9 @@ mysql_variable_st mysql_tracked_variables[] {\n \tsession_track_system_variables\n \tsession_track_transaction_info\n \t*/\n-\n-\n };\n #else\n extern mysql_variable_st mysql_tracked_variables[];\n+extern var_track_err_st perm_track_errs[];\n #endif // PROXYSQL_EXTERN\n #endif // MYSQL_TRACKED_VARIABLES\ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex ae306e36e4..b40d922539 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -2974,6 +2974,8 @@ bool MySQL_Session::handler_again___status_SETTING_GENERIC_VARIABLE(int *_rc, co\n \t\t\t\t\t(myerr == 1193) // variable is not found\n \t\t\t\t\t||\n \t\t\t\t\t(myerr == 1651) // Query cache is disabled\n+\t\t\t\t\t||\n+\t\t\t\t\t(is_perm_track_err(myerr, var_name)) // Special permitted tracking errors (~= '1193')\n \t\t\t\t) {\n \t\t\t\t\tint idx = SQL_NAME_LAST_HIGH_WM;\n \t\t\t\t\tfor (int i=0; i<SQL_NAME_LAST_HIGH_WM; i++) {\ndiff --git a/lib/MySQL_Variables.cpp b/lib/MySQL_Variables.cpp\nindex 6f5c1f0481..c0df467820 100644\n--- a/lib/MySQL_Variables.cpp\n+++ b/lib/MySQL_Variables.cpp\n@@ -9,6 +9,7 @@\n #endif\n \n #include <sstream>\n+#include \"mysqld_error.h\"\n \n \n static inline char is_digit(char c) {\n@@ -17,6 +18,23 @@ static inline char is_digit(char c) {\n \treturn 0;\n }\n \n+var_track_err_st perm_track_errs[] {\n+\t// ERROR 1210 (HY000): Variable not supported in combination with Galera:\n+\t// - Changed by MySQL, previously 'ER_UNKNOWN_SYSTEM_VARIABLE'\n+\t{ ER_WRONG_ARGUMENTS, \"sql_generate_invisible_primary_key\" }\n+};\n+\n+bool is_perm_track_err(int err, const char* varname) {\n+\tconst size_t count = sizeof(perm_track_errs) / sizeof(var_track_err_st);\n+\n+\tfor (size_t i = 0; i < count; i++) {\n+\t\tif (perm_track_errs[i].err == err && (strcasecmp(varname, perm_track_errs[i].name) == 0)) {\n+\t\t\treturn true;\n+\t\t}\n+\t}\n+\treturn false;\n+}\n+\n #include \"proxysql_find_charset.h\"\n \n verify_var MySQL_Variables::verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex a98d7669db..709ae3492b 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -153,7 +153,8 @@ static void BQE1(SQLite3DB *db, const vector<string>& tbs, const string& p1, con\n }\n \n \n-static int round_intv_to_time_interval(int& intv) {\n+static int round_intv_to_time_interval(const char* name, int _intv) {\n+\tint intv = _intv;\n \tif (intv > 300) {\n \t\tintv = 600;\n \t} else {\n@@ -181,6 +182,9 @@ static int round_intv_to_time_interval(int& intv) {\n \t\t\t}\n \t\t}\n \t}\n+\tif (intv != _intv) {\n+\t\tproxy_warning(\"Variable '%s' rounded to interval '%d'\\n\", name, intv);\n+\t}\n \treturn intv;\n }\n \n@@ -8686,7 +8690,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connection_pool\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connection_pool=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connection_pool=intv;\n \t\t\t\treturn true;\n@@ -8697,7 +8701,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connections\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connections=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connections=intv;\n \t\t\t\treturn true;\n@@ -8708,7 +8712,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_query_cache\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_query_cache=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_query_cache=intv;\n \t\t\t\treturn true;\n@@ -8729,7 +8733,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_cpu\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_cpu=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_cpu=intv;\n \t\t\t\treturn true;\n@@ -8741,7 +8745,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_memory\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_memory=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_memory=intv;\n \t\t\t\treturn true;\ndiff --git a/lib/debug.cpp b/lib/debug.cpp\nindex e4eda648f5..4f3755c9c0 100644\n--- a/lib/debug.cpp\n+++ b/lib/debug.cpp\n@@ -131,15 +131,22 @@ void proxy_debug_load_filters(std::set<std::string>& f) {\n \t//pthread_mutex_unlock(&debug_mutex);\n }\n \n+// REMINDER: This function should always save/restore 'errno', otherwise it could influence error handling.\n void proxy_debug_func(enum debug_module module, int verbosity, int thr, const char *__file, int __line, const char *__func, const char *fmt, ...) {\n+\tint saved_errno = errno;\n \tassert(module<PROXY_DEBUG_UNKNOWN);\n \tif (pretime == 0) { // never initialized\n \t\tpretime=realtime_time();\n \t}\n-\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity)\n+\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity) {\n+\t\terrno = saved_errno;\n \t\treturn;\n-\tif (filter_debug_entry(__file, __line, __func)) // check if the entry must be filtered\n+\t}\n+\t// check if the entry must be filtered\n+\tif (filter_debug_entry(__file, __line, __func)) {\n+\t\terrno = saved_errno;\n \t\treturn;\n+\t}\n \tchar origdebugbuff[DEBUG_MSG_MAXSIZE];\n \tchar debugbuff[DEBUG_MSG_MAXSIZE];\n \tchar longdebugbuff[DEBUG_MSG_MAXSIZE*8];\n@@ -243,6 +250,8 @@ void proxy_debug_func(enum debug_module module, int verbosity, int thr, const ch\n \tpthread_mutex_unlock(&debug_mutex);\n \tif (curtime != 0)\n \t\tpretime=curtime;\n+\n+\terrno = saved_errno;\n };\n #endif\n \ndiff --git a/lib/mysql_connection.cpp b/lib/mysql_connection.cpp\nindex 53b47cc7c4..8ae6a85f5c 100644\n--- a/lib/mysql_connection.cpp\n+++ b/lib/mysql_connection.cpp\n@@ -1252,6 +1252,14 @@ MDB_ASYNC_ST MySQL_Connection::handler(short event) {\n \t\t\t//if (parent->use_ssl) {\n \t\t\t{\n \t\t\t\t// mariadb client library disables NONBLOCK for SSL connections ... re-enable it!\n+\t\t\t\t// CONTEXT: This shouldn't be confused with the previous incompatibility that 'mariadbclient'\n+\t\t\t\t// had between the NONBLOCK flags and SSL connections, and that was reported and solved via\n+\t\t\t\t// CONC-320, our patch for this incompatibility was dropped on connector upgrade for v2.0.9.\n+\t\t\t\t// Setting the socket back to NONBLOCK is SAFE. This is because a connection can be used for\n+\t\t\t\t// BOTH blocking and not blocking calls, as described here:\n+\t\t\t\t// - https://mariadb.com/kb/en/using-the-non-blocking-library/#mixing-blocking-and-non-blocking-operation\n+\t\t\t\t// In case of SSL connections, it's still required to set the socket back to NONBLOCK prior to\n+\t\t\t\t// non-blockig calls.\n \t\t\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n \t\t\t\tint f=fcntl(mysql->net.fd, F_GETFL);\n #ifdef FD_CLOEXEC\ndiff --git a/lib/mysql_data_stream.cpp b/lib/mysql_data_stream.cpp\nindex 3ff6e5da44..a45e77dc93 100644\n--- a/lib/mysql_data_stream.cpp\n+++ b/lib/mysql_data_stream.cpp\n@@ -570,9 +570,7 @@ int MySQL_Data_Stream::read_from_net() {\n \n \tint r=0;\n \tint s=queue_available(queueIN);\n-\tif (encrypted) {\n-\t//\tproxy_info(\"Queue available of %d bytes\\n\", s);\n-\t}\n+\n \tif (encrypted == false) {\n \t\tif (pkts_recv) {\n \t\t\tr = recv(fd, queue_w_ptr(queueIN), s, 0);\n@@ -592,41 +590,24 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t}\n \t\t}\n \t} else { // encrypted == true\n-/*\n-\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\tint ret = SSL_do_handshake(ssl);\n-\t\t\tint ret2;\n-\t\t\tif (ret != 1) {\n-\t\t\t\t//ERR_print_errors_fp(stderr);\n-\t\t\t\tret2 = SSL_get_error(ssl, ret);\n-\t\t\t\tfprintf(stderr,\"%d\\n\",ret2);\n-\t\t\t}\n-\t\t\treturn 0;\n-\t\t} else {\n-\t\t\tr = SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t}\n-*/\n \t\tPROXY_TRACE();\n \t\tif (s < MY_SSL_BUFFER) {\n \t\t\treturn 0;\t// no enough space for reads\n \t\t}\n \t\tchar buf[MY_SSL_BUFFER];\n-\t\t//ssize_t n = read(fd, buf, sizeof(buf));\n-\t\tint n = recv(fd, buf, sizeof(buf), 0);\n-\t\t//proxy_info(\"SSL recv of %d bytes\\n\", n);\n-\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, n,  rbio_ssl->num_write , rbio_ssl->num_read);\n-\t\tif (n > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n-\t\t\t//on_read_cb(buf, (size_t)n);\n+\t\tint ssl_recv_bytes = recv(fd, buf, sizeof(buf), 0);\n+\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, ssl_recv_bytes,  rbio_ssl->num_write , rbio_ssl->num_read);\n \n+\t\tif (ssl_recv_bytes > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n \t\t\tchar buf2[MY_SSL_BUFFER];\n \t\t\tint n2;\n \t\t\tenum sslstatus status;\n \t\t\tchar *src = buf;\n-\t\t\tint len = n;\n+\t\t\tint len = ssl_recv_bytes;\n \t\t\twhile (len > 0) {\n \t\t\t\tn2 = BIO_write(rbio_ssl, src, len);\n \t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: write %d bytes into BIO %p, len=%d\\n\", sess, n2, rbio_ssl, len);\n-\t\t\t\t//proxy_info(\"BIO_write with len = %d and %d bytes\\n\", len , n2);\n+\n \t\t\t\tif (n2 <= 0) {\n \t\t\t\t\tshut_soft();\n \t\t\t\t\treturn -1;\n@@ -634,40 +615,29 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\tsrc += n2;\n \t\t\t\tlen -= n2;\n \t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished NOT completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\tif (do_ssl_handshake() == SSLSTATUS_FAIL) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished failed!!\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake failed   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\tshut_soft();\n \t\t\t\t\t\treturn -1;\n \t\t\t\t\t}\n \t\t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished yet NOT completed\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\treturn 0;\n \t\t\t\t\t}\n \t\t\t\t} else {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake finished   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t}\n \t\t\t}\n \t\t\tn2 = SSL_read (ssl, queue_w_ptr(queueIN), s);\n \t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from BIO %p into a buffer with %d bytes free\\n\", sess, n2, rbio_ssl, s);\n \t\t\tr = n2;\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n-\t\t\tif (n2 > 0) {\n-\t\t\t}\n-/*\n-\t\t\tdo {\n-\t\t\t\tn2 = SSL_read(ssl, buf2, sizeof(buf2));\n-\t\t\t\tif (n2 > 0) {\n-\t\t\t\t\t\n-\t\t\t\t}\n-\t\t\t} while (n > 0);\n-*/\n \t\t\tstatus = get_sslstatus(ssl, n2);\n-\t\t\t//proxy_info(\"SSL status = %d\\n\", status);\n+\n \t\t\tif (status == SSLSTATUS_WANT_IO) {\n \t\t\t\tdo {\n \t\t\t\t\tn2 = BIO_read(wbio_ssl, buf2, sizeof(buf2));\n-\t\t\t\t\t//proxy_info(\"BIO_read with %d bytes\\n\", n2);\n+\n \t\t\t\t\tif (n2 > 0) {\n           \t\t\t\tqueue_encrypted_bytes(buf2, n2);\n \t\t\t\t\t} else if (!BIO_should_retry(wbio_ssl)) {\n@@ -681,14 +651,18 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\treturn -1;\n \t\t\t}\n \t\t} else {\n-\t\t\tr = n;\n-\t\t\t//r += SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n+\t\t\t// Shutdown if we either received the EOF, or operation failed with non-retryable error.\n+\t\t\tif (ssl_recv_bytes==0 || (ssl_recv_bytes==-1 && errno != EINTR && errno != EAGAIN)) {\n+\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Received EOF, shutting down soft socket -- Session=%p, Datastream=%p\\n\", sess, this);\n+\t\t\t\tshut_soft();\n+\t\t\t\treturn -1;\n+\t\t\t}\n+\t\t\tr = ssl_recv_bytes;\n \t\t}\n \t}\n-//__exit_read_from_next:\n+\n \tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from fd %d into a buffer of %d bytes free\\n\", sess, r, fd, s);\n-\t//proxy_error(\"read %d bytes from fd %d into a buffer of %d bytes free\\n\", r, fd, s);\n+\n \tif (r < 1) {\n \t\tif (encrypted==false) {\n \t\t\tint myds_errno=errno;\n", "instance_id": "sysown__proxysql-4588", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: MySQL has changed the error code for the `sql_generate_invisible_primary_key` setting in newer versions when used with Galera, and ProxySQL needs to handle the new error code (`ER_WRONG_ARGUMENTS`) in the same way as the old one (`ER_UNKNOWN_SYSTEM_VARIABLE`). The description includes the context of the issue, the specific versions affected, the error message, and a reference to the proposed fix in a pull request. Steps to reproduce the issue are provided, which adds to the clarity. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or output after the fix (e.g., should the error be logged differently or suppressed entirely?), and it lacks details on potential edge cases or constraints (e.g., are there other variables or errors that might need similar handling?). Due to these minor missing details, I assign a clarity score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, primarily involving the addition of a new error handling mechanism in `MySQL_Session.cpp` and `MySQL_Variables.cpp`. A new structure `var_track_err_st` and a function `is_perm_track_err` are introduced to handle the specific error code for the variable in question. The changes span a few files (`MySQL_Variables.h`, `proxysql_structs.h`, `MySQL_Session.cpp`, `MySQL_Variables.cpp`), but they are straightforward and do not impact the broader system architecture. The amount of code change is small and focused.\n\n2. **Number of Technical Concepts**: Solving this requires a basic understanding of error handling in C++ and familiarity with MySQL error codes. The solution involves simple array-based lookup logic to match error codes with variable names, which is not conceptually complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond MySQL error handling are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code change handles a specific error for a specific variable, suggesting a narrow scope. There is no indication of complex edge cases (e.g., handling multiple variables or dynamic error codes), and the error handling logic added is minimal and straightforward.\n\n4. **Overall Complexity**: While the problem requires understanding the context of MySQL error codes and ProxySQL's session handling, the actual implementation is a simple extension of existing logic. The changes do not require deep knowledge of the codebase's architecture or significant refactoring. However, it is slightly more involved than a trivial fix (e.g., changing a constant) due to the need to integrate with existing error handling logic and ensure correctness for the specific variable.\n\nAdditionally, I note that the provided diff includes unrelated changes (e.g., debug logging improvements, SSL handling in `mysql_data_stream.cpp`, and variable rounding in `ProxySQL_Admin.cpp`). These are likely part of a larger pull request and not directly relevant to the described problem. I have focused my evaluation only on the changes related to handling `ER_WRONG_ARGUMENTS` for `sql_generate_invisible_primary_key`. Given the simplicity of the relevant changes and the limited scope, I assign a difficulty score of 0.35, towards the higher end of the \"Easy\" range due to the need for some contextual understanding of MySQL errors and ProxySQL internals.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "If a binlog task blocks the slave for a long period, the master may resume the increment replication from an incorrect  start position after timeout reconnection\n### Is this a regression?\r\n\r\nNo\r\n\r\n### Description\r\n\r\n**\u5728\u589e\u91cf\u540c\u6b65\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u67d0\u6761BinlogTask\u963b\u585e\u4e86Slave\u5f88\u957f\u65f6\u95f4\uff08\u8d85\u8fc720s\u7684\u8d85\u65f6\u65f6\u95f4\uff09\uff0c\u4f1a\u9020\u6210\u4e3b\u4ece\u65ad\u8054\uff0c\u5f53\u4e3b\u4ece\u518d\u6b21\u8bd5\u56fe\u91cd\u5efa\u8fde\u63a5\u65f6\uff0cSlave\u53ef\u80fd\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u9519\u8bef\u7684Binlog Start Point\u7ed9Master\u6765\u8fdb\u884c\u7eed\u4f20**\u3002\r\n\r\n**\u9488\u5bf9\u8fd9\u4e00Case\u7684\u5c55\u5f00\u63cf\u8ff0**:\r\n**\u573a\u666f**\uff1a\u5047\u8bbeSlave\u5728\u589e\u91cf\u540c\u6b65\u9636\u6bb5\uff0c\u53d1\u751f\u8d85\u65f6\u8f6c\u4e3a\u4e86TryConnect\u72b6\u6001\uff0c\u5728\u53d1\u51faTrySync\u8bf7\u6c42\u65f6\uff0c\u5982\u679c\u76f8\u5e94\u7684BinlogWorker\u6b63\u597d\u8fd8\u5728\u6267\u884c\u4e00\u4e2a\u4e0a\u6b21\u8fde\u63a5\u671f\u95f4\u7684Binlog\u4efb\u52a1\uff08\u5c06\u8be5Binlog\u4efb\u52a1\u5b9a\u4e49\u4e3a\u4efb\u52a1A) \u3002 \u90a3\u4e48\uff0c\u56e0\u4e3a\u4efb\u52a1A\u7684\u5b58\u5728\uff0cSlave\u662f\u5426\u53ef\u80fd\u4f1a\u53d1\u9001\u4e86\u4e0d\u6b63\u786e\u7684\u7eed\u4f20\u8d77\u59cbOffset\u7ed9Master \uff1f \u6362\u53e5\u8bdd\u8bf4\uff1a\u867d\u7136\u6700\u7ec8\u4efb\u52a1A\u4f1a\u5728Slave\u843d\u76d8\uff0c\u4f46\u662fSlave\u662f\u5426\u53ef\u80fd\u544a\u77e5\u4e86Master\u4ece\u4efb\u52a1A\uff08\u6240\u5bf9\u5e94\u7684Binlog\uff09\u5f00\u59cb\u7684\u4f4d\u7f6e\u53d1\u9001Binlog\uff0c\u5bfc\u81f4Master\u4f1a\u5c06\u4efb\u52a1A\u5bf9\u5e94\u7684Binlog\u518d\u53d1\u4e00\u6b21\uff0c\u4e14Slave\u4f1a\u6d88\u8d39\u4e24\u6b21\u4efb\u52a1A\u6240\u5bf9\u5e94\u7684Binlog \uff1f  \u5148\u505a\u56de\u7b54: \u4f1a\u51fa\u73b0\u8fd9\u79cd\u95ee\u9898\u3002\u5177\u4f53\u68b3\u7406\u5728\u4e0b\u9762\uff1a\r\n\r\n**\u80cc\u666f\u8865\u5145\u548c\u5b9a\u4e49**\uff1aTrySync\u8bf7\u6c42\u643a\u5e26\u7684offset(\u5b9a\u4e49\u4e3aoffset A)\u4e3b\u8981\u4f5c\u7528\u662f\u7ed9Master\u5224\u65ad\u662f\u5426\u80fd\u505a\u589e\u91cf\u540c\u6b65\uff0c\u771f\u6b63\u51b3\u5b9aMaster\u521d\u59cb\u5316\u53d1\u9001\u7a97\u53e3\u8d77\u59cb\u4f4d\u7f6e\uff08\u7eed\u4f20Binlog\u7684\u8d77\u59cb\u4f4d\u7f6e\uff09\u7684\uff0c\u662fslave\u5728\u6536\u5230TrySync\u7684Resp\u540e\u53d1\u51fa\u7684\u4e00\u6761\u7279\u6b8aBinlogACK (is_first_send=true)\uff0c\u8be5ACK\u7684offst start\u7b49\u4e8eend(\u5b9a\u4e49\u4e3aOffset B)\uff0c\u4e14\u8be5Offset B\u5c31\u662fslave\u5728\u53d1\u51fa\u8fd9\u6761\u7279\u6b8aAck\u65f6\u7684\u6700\u65b0\u843d\u76d8\u70b9\u3002\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u5176\u5b9eOffset B\u5e94\u8be5\u4f1a\u548cOffset A\u76f8\u540c\uff0c\u4f46\u662f\u5728Edge Case 1\u4e2d\uff0c\u7531\u4e8e\u53d1\u51faTrySync\u65f6\u4efb\u52a1A\u6b63\u5728\u6267\u884c\u4e14\u6700\u7ec8\u4f1a\u6267\u884c\u5b8c\u6bd5\uff0cOffset B\u7684\u6b63\u786e\u9884\u671f\u5e94\u5f53\u662f  Offset A + BinlogSizeOf(\u4efb\u52a1A), \u6216\u8005\u8bf4Binlog\u7684\u8d77\u59cb\u7eed\u4f20\u4f4d\u7f6e\u5e94\u8be5\u5c31\u5728\u4efb\u52a1A\u5bf9\u5e94\u7684Binlogs\u7684\u540e\u9762\u3002\r\n\r\n**\u73b0\u6709\u4ee3\u7801\u903b\u8f91\u4e2d**\uff1aOffset B\u53ef\u80fd\u4e0d\u4f1a\u7b49\u4e8e\u6b63\u786e\u9884\u671f\uff0c\u5047\u5982BinlogWork\u6267\u884c\u4efb\u52a1A\u6267\u884c\u4e86\u6bd4\u8f83\u4e45\uff0c\u800c\u5728\u4efb\u52a1A\u7684\u6267\u884c\u671f\u95f4Slave\u5b8c\u6210\u4e86\uff1aTrySync Req\u53d1\u9001 ->TrySync Resp\u5904\u7406->\u5728TrySync Resp\u7684\u5904\u7406\u51fd\u6570\u672b\u5c3e\u4f1a\u83b7\u53d6Slave\u6700\u65b0\u7684Binlog\u843d\u76d8\u70b9\uff08Offset B\uff09\uff0c\u53d1\u51fa\u7279\u6b8aBinlogAck(is_first_send=true)\u6765\u544a\u77e5Master\u4ece\u54ea\u91cc\u5f00\u59cb\u91cd\u53d1Binlog\u3002 \u5982\u679c\u5728\u83b7\u53d6Offset B\u7684\u65f6\u5019\uff0c\u4efb\u52a1A\u8fd8\u6ca1\u843d\u76d8\uff0c\u6216\u8005\u843d\u76d8\u4e86\u4f46\u662f\u8fd8\u6ca1\u6709\u5c06\u6700\u65b0\u7684offset\u66f4\u65b0\u5230version_\u5bf9\u8c61\u4e2d(Offset B\u5c31\u662f\u4eceversion_\u5bf9\u8c61\u4e2d\u53d6)\uff0c\u5c31\u4f1a\u5bfc\u81f4\u83b7\u53d6\u7684OffsetB\u5c31\u7b49\u4e8eOffset A(\u4f46\u6b63\u786e\u7684\u5e94\u8be5Offset B\u5e94\u8be5\u662f Offset A + Offset A + BinlogSizeOf(\u4efb\u52a1A))\uff0c\u4e8e\u662fMaster\u4f1a\u628a\u4efb\u52a1A\u6240\u5bf9\u5e94\u7684\u90a3\u6279Binlog\u518d\u53d1\u4e00\u904d\u3002\r\n\r\n**\u540e\u679c**\uff1aMaster\u4f1a\u628a\u4efb\u52a1A\u5185\u90e8\u7684BInlog\u518d\u53d1\u4e00\u6b21\uff0cSlave\u7b49\u4e8e\u6d88\u8d39\u4e862\u6279\u540c\u6837\u7684Binlog\uff0c\u4e00\u6b21\u662f\u5728\u4e0a\u4e00\u6b21Session\u7684\u672b\u5c3e\uff08\u963b\u585e\u7684\u90a3\u4e2a\u4efb\u52a1A\uff09\uff0c\u4e00\u6b21\u662f\u5728\u65b0Session\u7684\u7b2c\u4e00\u4e2aBinlog\u4efb\u52a1\u4e2d\u3002\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u4e14\u5728\u540c\u6b65\u6ca1\u6709\u6ede\u540e/\u5b8c\u5168\u540c\u6b65\u7684\u60c5\u51b5\u4e0b\uff0cSlave\u7684Binlog\u6587\u4ef6\u4f1a\u6bd4Master\u7684\u5bf9\u5e94BInlog\u6587\u4ef6\u957f\u4e00\u70b9\uff0c\u5728Slave\u5207\u8d70\u8fd9\u4e2aBinlog\u6587\u4ef6\u4e4b\u524d\u5982\u679c\u53d1\u751f\u4e86\u65ad\u70b9\u91cd\u8fde\uff0c\u4e3b\u4ece\u5efa\u8054\u53ef\u80fd\u4f1a\u62a5\u9519 binlog offset is not a start point of master, \u4f46\u662f\u5982\u679cslave\u5728\u5904\u4e8e\u8be5Binlog\u6587\u4ef6\u671f\u95f4\u5b8c\u5168\u6ca1\u6709\u65ad\u5f00\u8fc7\uff0c\u53ef\u80fd\u6d88\u8d39\u5230\u4e86\u7a97\u53e3\u672b\u5c3e\u65f6Master\u7aef\u4f1a\u62a5\u51fa\u5947\u602a\u7684SyncWin Corruption\u3002(\u53e6\u5916\uff0c\u5728\u7ebf\u4e0a\u5b9e\u4f8b\u7684\u4e3b\u4ece\u8d85\u65f6\u6545\u969c\u4e2d\uff0c\u786e\u5b9e\u4e5f\u51fa\u73b0\u8fc7binlog offset is not a start point of master)\r\n\r\n\r\n**During incremental synchronization, if a BinlogTask blocks the Slave for a long time (exceeding the 20-second timeout), when the Master and Slave attempt to reconnect, the Slave may provide an incorrect Binlog Start Point to the Master for resuming the process.**\r\n\r\n**Expanded description of this case**:\r\n**Scenario**: Suppose during the incremental synchronization phase, the Slave times out and switches to TryConnect state. When sending a TrySync request, if the corresponding BinlogWorker happens to still be executing a Binlog task from the previous connection period (let's define this Binlog task as Task A), then due to the existence of Task A, could the Slave possibly send an incorrect resumption starting Offset to the Master? In other words, even though Task A will eventually be written to the Slave\u2019s disk, could the Slave inform the Master to send the Binlog from the starting point of Task A, causing the Master to resend the Binlog corresponding to Task A and resulting in the Slave consuming the Binlog for Task A twice? The preliminary answer is: yes, this issue can occur. The detailed explanation is below:\r\n\r\n**Background and definition**: The offset carried by the TrySync request (defined as Offset A) primarily serves for the Master to determine whether incremental synchronization can be performed. The actual determination of the starting position of the Master\u2019s initial sending window (the starting position for resuming the Binlog) is done by a special BinlogACK (with is_first_send=true) sent by the Slave after receiving the TrySync response. The start of this ACK\u2019s offset is equal to the end (defined as Offset B), and this Offset B is the latest disk write point of the Slave when sending this special Ack. In most cases, Offset B should be the same as Offset A, but in Edge Case 1, since Task A is executing when the TrySync is sent and will eventually complete, the correct expectation for Offset B should be Offset A + BinlogSizeOf(Task A), or in other words, the starting position for resuming the Binlog should be right after the Binlogs corresponding to Task A.\r\n\r\n**In the current code logic**: Offset B may not equal the correct expectation. If the BinlogWork executing Task A takes a long time, and during the execution of Task A, the Slave completes: sending TrySync Req -> processing TrySync Resp -> obtaining the latest Binlog write point (Offset B) at the end of the TrySync Resp processing function, and sending a special BinlogAck (is_first_send=true) to inform the Master where to start resending the Binlog. If Task A has not been written to disk or the latest offset has not been updated to the version_ object (Offset B is taken from the version_ object) when obtaining Offset B, then the obtained Offset B will equal Offset A (but the correct Offset B should be Offset A + BinlogSizeOf(Task A)), thus causing the Master to resend the batch of Binlogs corresponding to Task A.\r\n\r\n**Consequence**: The Master will resend the Binlogs within Task A, causing the Slave to consume two batches of the same Binlog, once at the end of the last session (the blocking Task A) and once in the first Binlog task of the new session. This can lead to data inconsistency between the Master and Slave. Additionally, if there is no lag in synchronization or if synchronization is complete, the Slave\u2019s Binlog file may be slightly longer than the corresponding Binlog file on the Master. If a breakpoint reconnection occurs before the Slave switches from this Binlog file, the Master-Slave connection might report an error: binlog offset is not a start point of master. However, if the Slave never disconnects during this Binlog file, a strange SyncWin Corruption error might be reported on the Master side when the window reaches the end. (Furthermore, in the actual Master-Slave timeout failures in online instances, the binlog offset is not a start point of master error has indeed occurred.)\r\n\r\n\r\n### Please provide a link to a minimal reproduction of the bug\r\n\r\n_No response_\r\n\r\n### Screenshots or videos\r\n\r\n\r\n### Please provide the version you discovered this bug in (check about page for version information)\r\n\r\n_No response_\r\n\r\n### Anything else?\r\n\r\n_No response_\n", "patch": "diff --git a/conf/pika.conf b/conf/pika.conf\nindex 055208dae5..a99c30b30d 100644\n--- a/conf/pika.conf\n+++ b/conf/pika.conf\n@@ -34,10 +34,17 @@ slow-cmd-thread-pool-size : 1\n # Slow cmd list e.g. hgetall, mset\n slow-cmd-list :\n \n-# The number of sync-thread for data replication from master, those are the threads work on slave nodes\n-# and are used to execute commands sent from master node when replicating.\n+# The number of threads to write DB in slaveNode when replicating.\n+# It's preferable to set slave's sync-thread-num value close to master's thread-pool-size.\n sync-thread-num : 6\n \n+# The num of threads to write binlog in slaveNode when replicating,\n+# each DB cloud only bind to one sync-binlog-thread to write binlog in maximum\n+#[NOTICE] It's highly recommended to set sync-binlog-thread-num equal to conf item 'database'(then each DB cloud have a exclusive thread to write binlog),\n+# eg. if you use 8 DBs(databases_ is 8), sync-binlog-thread-num is preferable to be 8\n+# Valid range of sync-binlog-thread-num is [1, databases], the final value of it is Min(sync-binlog-thread-num, databases)\n+sync-binlog-thread-num : 1\n+\n # Directory to store log files of Pika, which contains multiple types of logs,\n # Including: INFO, WARNING, ERROR log, as well as binglog(write2fine) file which\n # is used for replication.\n@@ -101,6 +108,8 @@ instance-mode : classic\n # The default database id is DB 0. You can select a different one on\n # a per-connection by using SELECT. The db id range is [0, 'databases' value -1].\n # The value range of this parameter is [1, 8].\n+# [NOTICE] It's RECOMMENDED to set sync-binlog-thread-num equal to DB num(databases),\n+# if you've changed the value of databases, remember to check if the value of sync-binlog-thread-num is proper.\n databases : 1\n \n # The number of followers of a master. Only [0, 1, 2, 3, 4] is valid at present.\ndiff --git a/include/pika_conf.h b/include/pika_conf.h\nindex 2a5ed25212..e0cb81062d 100644\n--- a/include/pika_conf.h\n+++ b/include/pika_conf.h\n@@ -65,6 +65,10 @@ class PikaConf : public pstd::BaseConf {\n     std::shared_lock l(rwlock_);\n     return sync_thread_num_;\n   }\n+  int sync_binlog_thread_num() {\n+    std::shared_lock l(rwlock_);\n+    return sync_binlog_thread_num_;\n+  }\n   std::string log_path() {\n     std::shared_lock l(rwlock_);\n     return log_path_;\n@@ -793,6 +797,7 @@ class PikaConf : public pstd::BaseConf {\n   int slow_cmd_thread_pool_size_ = 0;\n   std::unordered_set<std::string> slow_cmd_set_;\n   int sync_thread_num_ = 0;\n+  int sync_binlog_thread_num_ = 0;\n   int expire_dump_days_ = 3;\n   int db_sync_speed_ = 0;\n   std::string slaveof_;\ndiff --git a/include/pika_define.h b/include/pika_define.h\nindex 4d6bf6a846..91ddffeb9f 100644\n--- a/include/pika_define.h\n+++ b/include/pika_define.h\n@@ -30,6 +30,8 @@\n #define PIKA_SERVER_ID_MAX 65535\n \n class PikaServer;\n+/* Global Const */\n+constexpr int MAX_DB_NUM = 8;\n \n /* Port shift */\n const int kPortShiftRSync = 1000;\ndiff --git a/include/pika_repl_client.h b/include/pika_repl_client.h\nindex aa20b83c78..49eb2c9b82 100644\n--- a/include/pika_repl_client.h\n+++ b/include/pika_repl_client.h\n@@ -65,6 +65,7 @@ class PikaReplClient {\n   pstd::Status Close(const std::string& ip, int port);\n \n   void Schedule(net::TaskFunc func, void* arg);\n+  void ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name);\n   void ScheduleWriteBinlogTask(const std::string& db_name, const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n@@ -80,13 +81,15 @@ class PikaReplClient {\n   pstd::Status SendRemoveSlaveNode(const std::string& ip, uint32_t port, const std::string& db_name, const std::string& local_ip);\n \n  private:\n-  size_t GetHashIndex(const std::string& key, bool upper_half);\n-  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(bg_workers_.size()); }\n+  size_t GetBinlogWorkerIndexByDBName(const std::string &db_name);\n+  size_t GetHashIndexByKey(const std::string& key);\n+  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(write_binlog_workers_.size()); }\n \n   std::unique_ptr<PikaReplClientThread> client_thread_;\n   int next_avail_ = 0;\n   std::hash<std::string> str_hash;\n-  std::vector<std::unique_ptr<PikaReplBgWorker>> bg_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_binlog_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_db_workers_;\n };\n \n #endif\ndiff --git a/include/pika_rm.h b/include/pika_rm.h\nindex 9cc0c5ef38..b3e310ddf4 100644\n--- a/include/pika_rm.h\n+++ b/include/pika_rm.h\n@@ -182,6 +182,7 @@ class PikaReplicaManager {\n                                const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n+  void ScheduleReplClientBGTaskByDBName(net::TaskFunc , void* arg, const std::string &db_name);\n   void ReplServerRemoveClientConn(int fd);\n   void ReplServerUpdateClientConnMap(const std::string& ip_port, int fd);\n \ndiff --git a/src/pika_admin.cc b/src/pika_admin.cc\nindex 6760ac247b..15d49cdbae 100644\n--- a/src/pika_admin.cc\n+++ b/src/pika_admin.cc\n@@ -942,6 +942,7 @@ void InfoCmd::InfoServer(std::string& info) {\n   tmp_stream << \"tcp_port:\" << g_pika_conf->port() << \"\\r\\n\";\n   tmp_stream << \"thread_num:\" << g_pika_conf->thread_num() << \"\\r\\n\";\n   tmp_stream << \"sync_thread_num:\" << g_pika_conf->sync_thread_num() << \"\\r\\n\";\n+  tmp_stream << \"sync_binlog_thread_num:\" << g_pika_conf->sync_binlog_thread_num() << \"\\r\\n\";\n   tmp_stream << \"uptime_in_seconds:\" << (current_time_s - g_pika_server->start_time_s()) << \"\\r\\n\";\n   tmp_stream << \"uptime_in_days:\" << (current_time_s / (24 * 3600) - g_pika_server->start_time_s() / (24 * 3600) + 1)\n              << \"\\r\\n\";\n@@ -1501,6 +1502,12 @@ void ConfigCmd::ConfigGet(std::string& ret) {\n     EncodeNumber(&config_body, g_pika_conf->sync_thread_num());\n   }\n \n+  if (pstd::stringmatch(pattern.data(), \"sync-binlog-thread-num\", 1) != 0) {\n+     elements += 2;\n+     EncodeString(&config_body, \"sync-binlog-thread-num\");\n+     EncodeNumber(&config_body, g_pika_conf->sync_binlog_thread_num());\n+    }\n+\n   if (pstd::stringmatch(pattern.data(), \"log-path\", 1) != 0) {\n     elements += 2;\n     EncodeString(&config_body, \"log-path\");\ndiff --git a/src/pika_conf.cc b/src/pika_conf.cc\nindex adc1b26d9f..e2e0d4f885 100644\n--- a/src/pika_conf.cc\n+++ b/src/pika_conf.cc\n@@ -176,7 +176,7 @@ int PikaConf::Load() {\n \n   if (classic_mode_.load()) {\n     GetConfInt(\"databases\", &databases_);\n-    if (databases_ < 1 || databases_ > 8) {\n+    if (databases_ < 1 || databases_ > MAX_DB_NUM) {\n       LOG(FATAL) << \"config databases error, limit [1 ~ 8], the actual is: \" << databases_;\n     }\n     for (int idx = 0; idx < databases_; ++idx) {\n@@ -185,6 +185,15 @@ int PikaConf::Load() {\n   }\n   default_db_ = db_structs_[0].db_name;\n \n+  // sync_binlog_thread_num_ must be set after the setting of databases_\n+  GetConfInt(\"sync-binlog-thread-num\", &sync_binlog_thread_num_);\n+  if (sync_binlog_thread_num_ <= 0) {\n+      sync_binlog_thread_num_ = databases_;\n+  } else {\n+      // final value is MIN(sync_binlog_thread_num, databases_)\n+      sync_binlog_thread_num_ = sync_binlog_thread_num_ > databases_ ?  databases_ : sync_binlog_thread_num_;\n+  }\n+\n   int tmp_replication_num = 0;\n   GetConfInt(\"replication-num\", &tmp_replication_num);\n   if (tmp_replication_num > 4 || tmp_replication_num < 0) {\ndiff --git a/src/pika_repl_client.cc b/src/pika_repl_client.cc\nindex 2754eb2f6e..352fbdf7e5 100644\n--- a/src/pika_repl_client.cc\n+++ b/src/pika_repl_client.cc\n@@ -27,8 +27,11 @@ extern std::unique_ptr<PikaReplicaManager> g_pika_rm;\n PikaReplClient::PikaReplClient(int cron_interval, int keepalive_timeout)  {\n   client_thread_ = std::make_unique<PikaReplClientThread>(cron_interval, keepalive_timeout);\n   client_thread_->set_thread_name(\"PikaReplClient\");\n-  for (int i = 0; i < 2 * g_pika_conf->sync_thread_num(); ++i) {\n-    bg_workers_.push_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  for (int i = 0; i < g_pika_conf->sync_binlog_thread_num(); i++) {\n+      write_binlog_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  }\n+  for (int i = 0; i < g_pika_conf->sync_thread_num(); ++i) {\n+    write_db_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n   }\n }\n \n@@ -43,49 +46,77 @@ int PikaReplClient::Start() {\n     LOG(FATAL) << \"Start ReplClient ClientThread Error: \" << res\n                << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n   }\n-  for (auto & bg_worker : bg_workers_) {\n-    res = bg_worker->StartThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    res = binlog_worker->StartThread();\n     if (res != net::kSuccess) {\n-      LOG(FATAL) << \"Start Pika Repl Worker Thread Error: \" << res\n+      LOG(FATAL) << \"Start Pika Repl Write Binlog Worker Thread Error: \" << res\n                  << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n     }\n   }\n+  for (auto & db_worker : write_db_workers_) {\n+        res = db_worker->StartThread();\n+        if (res != net::kSuccess) {\n+            LOG(FATAL) << \"Start Pika Repl Write DB Worker Thread Error: \" << res\n+                       << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n+        }\n+    }\n   return res;\n }\n \n int PikaReplClient::Stop() {\n   client_thread_->StopThread();\n-  for (auto & bg_worker : bg_workers_) {\n-    bg_worker->StopThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    binlog_worker->StopThread();\n+  }\n+  for (auto &db_worker: write_db_workers_) {\n+    db_worker->StopThread();\n   }\n   return 0;\n }\n \n void PikaReplClient::Schedule(net::TaskFunc func, void* arg) {\n-  bg_workers_[next_avail_]->Schedule(func, arg);\n+  write_binlog_workers_[next_avail_]->Schedule(func, arg);\n   UpdateNextAvail();\n }\n \n+void PikaReplClient::ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name) {\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  write_binlog_workers_[index]->Schedule(func, arg);\n+};\n+\n void PikaReplClient::ScheduleWriteBinlogTask(const std::string& db_name,\n                                              const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                              const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n-  size_t index = GetHashIndex(db_name, true);\n-  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, bg_workers_[index].get());\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, write_binlog_workers_[index].get());\n+  write_binlog_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n }\n \n void PikaReplClient::ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset,\n                                          const std::string& db_name) {\n   const PikaCmdArgsType& argv = cmd_ptr->argv();\n   std::string dispatch_key = argv.size() >= 2 ? argv[1] : argv[0];\n-  size_t index = GetHashIndex(dispatch_key, false);\n+  size_t index = GetHashIndexByKey(dispatch_key);\n   auto task_arg = new ReplClientWriteDBTaskArg(cmd_ptr, offset, db_name);\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+  write_db_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+}\n+\n+size_t PikaReplClient::GetBinlogWorkerIndexByDBName(const std::string &db_name) {\n+    char db_num_c = db_name.back();\n+    int32_t db_num = db_num_c - '0';\n+    //Valid range of db_num is [0, MAX_DB_NUM)\n+    if (db_num < 0 || db_num >= MAX_DB_NUM) {\n+        LOG(ERROR)\n+                << \"Corruption in consuming binlog: the last char of the db_name(extracted from binlog) is not a valid db num, the extracted db_num is \"\n+                << db_num_c << \" while write_binlog_workers.size() is \" << write_binlog_workers_.size();\n+        if (db_num < 0) { assert(false && \"db_num invalid, check if the db_name in the request is valid, also check the ERROR Log of Pika.\"); }\n+    }\n+    return db_num % write_binlog_workers_.size();\n }\n \n-size_t PikaReplClient::GetHashIndex(const std::string& key, bool upper_half) {\n-  size_t hash_base = bg_workers_.size() / 2;\n-  return (str_hash(key) % hash_base) + (upper_half ? 0 : hash_base);\n+size_t PikaReplClient::GetHashIndexByKey(const std::string& key) {\n+  size_t hash_base = write_db_workers_.size();\n+  return (str_hash(key) % hash_base);\n }\n \n Status PikaReplClient::Write(const std::string& ip, const int port, const std::string& msg) {\ndiff --git a/src/pika_repl_client_conn.cc b/src/pika_repl_client_conn.cc\nindex 672648d64d..6c8e001bf1 100644\n--- a/src/pika_repl_client_conn.cc\n+++ b/src/pika_repl_client_conn.cc\n@@ -63,9 +63,12 @@ int PikaReplClientConn::DealMessage() {\n       break;\n     }\n     case InnerMessage::kTrySync: {\n+      const std::string& db_name = response->try_sync().slot().db_name();\n+      //TrySync resp must contain db_name\n+      assert(!db_name.empty());\n       auto task_arg =\n           new ReplClientTaskArg(response, std::dynamic_pointer_cast<PikaReplClientConn>(shared_from_this()));\n-      g_pika_rm->ScheduleReplClientBGTask(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg));\n+      g_pika_rm->ScheduleReplClientBGTaskByDBName(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg), db_name);\n       break;\n     }\n     case InnerMessage::kBinlogSync: {\n@@ -193,7 +196,6 @@ void PikaReplClientConn::HandleTrySyncResponse(void* arg) {\n     LOG(WARNING) << \"TrySync Failed: \" << reply;\n     return;\n   }\n-\n   const InnerMessage::InnerResponse_TrySync& try_sync_response = response->try_sync();\n   const InnerMessage::Slot& db_response = try_sync_response.slot();\n   std::string db_name = db_response.db_name();\ndiff --git a/src/pika_rm.cc b/src/pika_rm.cc\nindex 3445e9fea6..a996463bc2 100644\n--- a/src/pika_rm.cc\n+++ b/src/pika_rm.cc\n@@ -659,6 +659,10 @@ void PikaReplicaManager::ScheduleReplClientBGTask(net::TaskFunc func, void* arg)\n   pika_repl_client_->Schedule(func, arg);\n }\n \n+void PikaReplicaManager::ScheduleReplClientBGTaskByDBName(net::TaskFunc func, void* arg, const std::string &db_name) {\n+  pika_repl_client_->ScheduleByDBName(func, arg, db_name);\n+}\n+\n void PikaReplicaManager::ScheduleWriteBinlogTask(const std::string& db,\n                                                  const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                                  const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n", "instance_id": "OpenAtomFoundation__pikiwidb-2638", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue related to incorrect Binlog Start Point during incremental synchronization in a master-slave replication scenario. It provides a detailed explanation of the problem, including the scenario, background, current code logic, and consequences of the bug (e.g., data inconsistency and potential errors during reconnection). The use of specific terms like Offset A, Offset B, and Task A, along with a step-by-step breakdown of the issue, helps in understanding the problem's context. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not explicitly define the expected behavior or solution approach, leaving it somewhat open-ended. Additionally, there are no examples of input/output or specific test cases to reproduce the issue, and the lack of a minimal reproduction link (as noted in the \"No response\" section) makes it harder to validate the problem independently. Lastly, while edge cases are mentioned (e.g., Task A not being written to disk in time), they are not exhaustively specified or accompanied by concrete scenarios. Thus, while the problem is valid and mostly clear, these minor gaps justify a score of 2 (Mostly Clear) rather than 3.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75, placing this problem in the \"Hard\" category (0.6-0.8), due to the following factors:\n\n1. **Clarity and Complexity of the Problem Description**: The problem involves a nuanced issue in a distributed system (master-slave replication) related to synchronization and binlog handling. Understanding the timing issues between TrySync requests, BinlogTask execution, and offset updates requires a deep grasp of replication mechanics and distributed system challenges, which inherently increases the difficulty.\n\n2. **Scope and Depth of Code Changes**: The provided code changes span multiple files (e.g., `pika_repl_client.cc`, `pika_conf.cc`, `pika_rm.cc`) and introduce significant modifications to the architecture of the replication system. The changes involve splitting worker threads into separate pools for binlog writing (`write_binlog_workers_`) and database writing (`write_db_workers_`), and introducing database-specific scheduling (`ScheduleByDBName`). This impacts multiple modules and requires understanding the interaction between configuration, threading, and task scheduling in the codebase. The amount of code change is moderate but non-trivial, and it affects core replication logic, which is critical to the system's architecture.\n\n3. **Number of Technical Concepts**: Solving this problem requires familiarity with several advanced concepts, including multi-threading (managing separate thread pools for binlog and DB operations), distributed systems (master-slave replication, binlog synchronization), and configuration management (adjusting thread counts based on database numbers). Additionally, the code changes involve C++-specific features like smart pointers (`std::unique_ptr`), thread scheduling, and hash-based task distribution. Understanding and modifying the replication logic also demands domain-specific knowledge of database replication and binlog handling, which adds to the complexity.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement explicitly mentions edge cases, such as a BinlogTask blocking for a long time and the resulting incorrect offset updates leading to duplicate binlog consumption. The code changes attempt to address this by ensuring database-specific thread allocation to prevent contention and ensure correct offset handling. However, implementing these changes requires careful consideration of additional edge cases, such as invalid database names or numbers (as seen in the error logging in `GetBinlogWorkerIndexByDBName`), and ensuring thread safety across the new worker pools. The error handling logic added in the code (e.g., assertions and logging for invalid DB numbers) indicates a need for robust validation, further increasing the complexity.\n\nOverall, this problem requires a deep understanding of the codebase's replication architecture, complex modifications across multiple files, and careful handling of edge cases related to timing and synchronization. While it does not reach the \"Very Hard\" category (0.8-1.0) due to the absence of extremely intricate algorithms or system-level redesigns (e.g., a new consensus protocol), it is still a challenging task that demands significant expertise in distributed systems and C++ programming. Hence, a score of 0.75 is appropriate.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Windows showSaveDialog invalid filename bug\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.0.0\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11 22H2 22621.4317\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\nNone\n\n### Expected Behavior\n\n1. Open the save dialog using dialog.showSaveDialog.\n2. Enter a file name containing illegal characters (e.g., 111*222).\n- Expected: The dialog correctly shows a warning that the file name is invalid due to the presence of illegal characters*.\n3. Remove the illegal characters* (e.g., change 111*222 to 111222).\n4. Attempt to save the file without adding an extension.\n- Expected: The dialog should now allow saving the file since all illegal characters have been removed, even if no file extension is added.\n\n### Actual Behavior\n\n1. Open the save dialog using dialog.showSaveDialog.\n2. Enter a file name containing illegal characters* (e.g., 111*222).\n- Actual: The dialog provides no error message or feedback.\n3. Remove the illegal characters* (e.g., change 111*222 to 111222).\n4. Attempt to save the file without adding an extension.\n- Actual: The dialog shows the file name as invalid, even though all illegal characters have been removed.\n5. Now, modify the file name to include a valid extension (e.g., 111222.xml).\n- Actual: The file saves successfully when an extension is added, indicating that the dialog behaves inconsistently by requiring an extension even for valid file names.\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nBelow is a minimal code example to reproduce the issue:\n\nSample Code:\n```\nconst fs = require('fs');\nconst { dialog } = require('electron');\n\nconst saveFileDialog = dialog.showSaveDialog({\n  title: '\u4fdd\u5b58 XML \u6587\u4ef6',\n  filters: [\n    { name: 'XML \u6587\u4ef6', extensions: ['xml'] }\n  ]\n});\n\nsaveFileDialog.then(result => {\n  if (!result.canceled) {\n    const filePath = result.filePath;\n    console.log(`\u6587\u4ef6\u5c06\u4fdd\u5b58\u5230: ${filePath}`);\n\n    // \u4f60\u8981\u4fdd\u5b58\u7684 XML \u5185\u5bb9\n    const xmlContent = `\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<root>\n  <item>\n    <name>\u793a\u4f8b\u6570\u636e</name>\n    <value>123</value>\n  </item>\n</root>`;\n\n    // \u5c06 XML \u5185\u5bb9\u5199\u5165\u6587\u4ef6\n    fs.writeFile(filePath, xmlContent, (err) => {\n      if (err) {\n        console.error('\u4fdd\u5b58\u6587\u4ef6\u65f6\u51fa\u9519:', err);\n      } else {\n        console.log('\u6587\u4ef6\u4fdd\u5b58\u6210\u529f!');\n      }\n    });\n  } else {\n    console.log('\u7528\u6237\u53d6\u6d88\u4e86\u4fdd\u5b58\u64cd\u4f5c');\n  }\n});\n\n```\nThis behavior only occurs in Electron applications, including those built using Electron, such as Visual Studio Code, QQ,WeChat PC (version 4.0) and other apps.\nHowever, Windows built-in applications like Notepad or third-party editors such as Notepad++ do not exhibit this behavior. In these apps, once illegal characters are removed from the file name, the modified name is accepted without requiring a file extension.\n\nThis inconsistency suggests that the showSaveDialog function in Electron has stricter handling or some kind of caching issue when validating file names, leading to unexpected behavior. This issue affects the user experience, as users are required to manually add file extensions even when they expect the file to save without one.\n\nThis issue seems to be related to or may have similarities with the following issue reported previously:\n[#25615 - SaveDialog doesn\u2019t allow saving a file with some extensions on Windows](https://github.com/electron/electron/issues/25615).\n\nBoth issues may indicate an underlying problem in how the dialog.showSaveDialog function interacts with Windows file system rules.\n\n![Image](https://github.com/user-attachments/assets/3f6bd0c9-5eeb-4642-9a97-1fb488ab573f)\n![Image](https://github.com/user-attachments/assets/297e7f88-d86e-430d-9267-8a41676952d2)\n![Image](https://github.com/user-attachments/assets/7ff1b07d-75a0-44fa-9920-728e4afbd125)\n![Image](https://github.com/user-attachments/assets/ef1b6db9-1ea7-4bd5-8737-9e589b3ee840)\n\n\n\n\n", "patch": "diff --git a/shell/browser/ui/file_dialog_win.cc b/shell/browser/ui/file_dialog_win.cc\nindex cfc8c6068c648..e142477ad0820 100644\n--- a/shell/browser/ui/file_dialog_win.cc\n+++ b/shell/browser/ui/file_dialog_win.cc\n@@ -144,10 +144,14 @@ static void ApplySettings(IFileDialog* dialog, const DialogSettings& settings) {\n   // We set file extension to the first none-wildcard extension to make\n   // sure the dialog will update file extension automatically.\n   for (size_t i = 0; i < filterspec.size(); ++i) {\n-    if (std::wstring(filterspec[i].pszSpec) != L\"*.*\") {\n+    std::wstring spec(filterspec[i].pszSpec);\n+    if (spec != L\"*.*\") {\n       // SetFileTypeIndex is regarded as one-based index.\n       dialog->SetFileTypeIndex(i + 1);\n-      dialog->SetDefaultExtension(filterspec[i].pszSpec);\n+      // \"*.jpg;*.png\" => \"*.jpg\"\n+      std::wstring first_spec = spec.substr(0, spec.find(L';'));\n+      // \"*.jpg\" => \"jpg\"\n+      dialog->SetDefaultExtension(first_spec.substr(2).c_str());\n       break;\n     }\n   }\n", "instance_id": "electron__electron-44296", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue with the `dialog.showSaveDialog` function in Electron on Windows. It outlines the expected and actual behavior with specific steps to reproduce the bug, including the handling of illegal characters and file extensions. The inclusion of sample code and references to related issues (e.g., #25615) adds to the clarity. Additionally, the problem statement is supported by images and mentions of affected applications, which helps in understanding the scope and impact. However, there are minor ambiguities: the statement does not fully specify whether the issue is tied to specific filter settings or dialog configurations beyond the provided sample code, and edge cases (e.g., behavior with different character sets or extremely long filenames) are not explicitly addressed. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes appears limited to a single file (`file_dialog_win.cc`) and a specific function related to setting default file extensions in the Windows file dialog. The provided diff shows a small, targeted modification (adjusting how the default extension is extracted and set), which does not suggest a broad impact on the system's architecture or multiple modules. However, the problem requires a moderate understanding of technical concepts, including the Windows COM API for file dialogs (`IFileDialog`), string manipulation in C++ (handling wide strings and parsing file extension patterns), and Electron's integration with native OS dialogs. Additionally, the developer must understand the nuances of Windows file naming rules and how they interact with Electron's dialog settings. While the edge cases mentioned in the problem statement (e.g., illegal characters, missing extensions) are not overly complex, implementing a robust solution may require careful testing to ensure consistent behavior across different user inputs and filter configurations. There are no significant performance or system-level considerations apparent in this fix. Overall, this problem requires a moderate level of expertise and effort, justifying a difficulty score of 0.45.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Decreasing nMaxIPs when learning from DNS seeds\nCurrently, our `nMaxIPs` when learning from DNS seeds is 256. @TheBlueMatt pointed out to me that if one of the seeds decided to actually return that many addresses, it would bias the addresses we add to `AddrMan` and consequently choose as our initial outbound peers. A quick `drill -t` of all the current seeds show that none yielded more than 26 results, meaning that if any of the seeds decided to return all 256 results (perhaps malicious ones), results from that seed would take over more than half of `AddrMan`.\r\n\r\nIf there were no TCP-fallback, this wouldn't be too much of a problem as at maximum we could fit around 31 IPs in a UDP packet. However, it seems that `glibc` [uses the TCP-fallback](https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1811471) by default, which would mean that obtaining 256 IPs is entirely possible.\n", "patch": "diff --git a/src/net.cpp b/src/net.cpp\nindex e388f05b037ad..3e959c187c2c7 100644\n--- a/src/net.cpp\n+++ b/src/net.cpp\n@@ -2256,7 +2256,11 @@ void CConnman::ThreadDNSAddressSeed()\n             if (!resolveSource.SetInternal(host)) {\n                 continue;\n             }\n-            unsigned int nMaxIPs = 256; // Limits number of IPs learned from a DNS seed\n+            // Limit number of IPs learned from a single DNS seed. This limit exists to prevent the results from\n+            // one DNS seed from dominating AddrMan. Note that the number of results from a UDP DNS query is\n+            // bounded to 33 already, but it is possible for it to use TCP where a larger number of results can be\n+            // returned.\n+            unsigned int nMaxIPs = 32;\n             const auto addresses{LookupHost(host, nMaxIPs, true)};\n             if (!addresses.empty()) {\n                 for (const CNetAddr& ip : addresses) {\n", "instance_id": "bitcoin__bitcoin-29850", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the current setting of `nMaxIPs` at 256 when learning from DNS seeds. It explains the potential risk of bias in `AddrMan` if a seed returns a large number of addresses, especially with TCP fallback allowing more results than UDP. The goal of reducing this risk is implied through the context and the code change. However, there are minor ambiguities: the statement does not explicitly define the desired outcome or constraints beyond the risk (e.g., why 32 was chosen as the new limit, or if there are specific performance or security thresholds to consider). Additionally, edge cases or potential side effects of this change are not discussed in the problem description. Overall, it is clear enough to understand the intent but lacks some finer details and explicit requirements.", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward modification of a single constant (`nMaxIPs`) from 256 to 32 in a specific part of the codebase (`net.cpp`). The scope of the change is minimal, affecting only one line in a single file, with no impact on the broader system architecture or interactions between modules. The technical concepts required are basic\u2014understanding the purpose of limiting DNS seed results and the difference between UDP and TCP in DNS queries, which are relatively simple networking concepts. No complex algorithms, design patterns, or domain-specific knowledge beyond basic networking are needed. Edge cases or error handling are not explicitly mentioned in the problem statement or required in the code change, as the modification is a simple value adjustment with a comment for clarity. Overall, this task falls into the \"very easy\" category, requiring only a basic code modification and minimal understanding of the surrounding context.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Settings]: In scan mode, Screen Reader users are not able to open 'Open JSON file' control.\n### Windows Terminal version\n\n1.12.3472.0\n\n### Windows build number\n\n10.0.22504.1010\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 22504.1010)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\nTool: Accessibility Insights for Windows Version 1.1.1741.1\n\n### Steps to reproduce\n\n**Repro Steps:**\r\n1. Open Windows Terminal.\r\n2. Open Settings page using 'Ctr+,'.\r\n3. Open Narrator using 'Win+Ctrl+ Enter' key. Turn ON Narrator scan mode using 'Caps lock + Space' key.\r\n4. Now navigate to 'Open JSON file' control and try to activate it then observe the issue.\r\n\r\n**User Experience:**\r\nScreen Reader users will be impacted here as they are not able to activate a control in scan mode which will not enhance the UX of those users.\r\n\r\n**Guideline Reference:**\r\nEN 301 549 V3.2.1: 11.5.2.12 Execution of available actions\r\n\r\n**Attachments:**\r\n[Uploading In scan mode, Screen Reader users are not able to open 'Open JSON file' control..zip\u2026]()\n\n### Expected Behavior\n\nIn scan mode, Screen Reader users should be able to open 'Open JSON file' control using 'Enter' key.\n\n### Actual Behavior\n\nIn scan mode, Screen Reader users are not able to open 'Open JSON file' control using 'Enter' key. Screen Reader Users is only able to open JSON file in Scan off mode.\n", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/MainPage.cpp b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\nindex 5daf396b72e..054c8480ccf 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n@@ -38,6 +38,7 @@ using namespace winrt::Windows::System;\n using namespace winrt::Windows::UI::Xaml::Controls;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static const std::wstring_view openJsonTag{ L\"OpenJson_Nav\" };\r\n static const std::wstring_view launchTag{ L\"Launch_Nav\" };\r\n static const std::wstring_view interactionTag{ L\"Interaction_Nav\" };\r\n static const std::wstring_view renderingTag{ L\"Rendering_Nav\" };\r\n@@ -324,6 +325,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \r\n             if (const auto navString = clickedItemContainer.Tag().try_as<hstring>())\r\n             {\r\n+                if (*navString == openJsonTag)\r\n+                {\r\n+                    const auto window = CoreWindow::GetForCurrentThread();\r\n+                    const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n+                    const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n+                    const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n+                                            WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n+                    const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n+                    OpenJson.raise(nullptr, target);\r\n+                    return;\r\n+                }\r\n                 _Navigate(*navString, BreadcrumbSubPage::None);\r\n             }\r\n             else if (const auto profile = clickedItemContainer.Tag().try_as<Editor::ProfileViewModel>())\r\n@@ -575,27 +587,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         }\r\n     }\r\n \r\n-    void MainPage::OpenJsonTapped(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& /*args*/)\r\n-    {\r\n-        const auto window = CoreWindow::GetForCurrentThread();\r\n-        const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n-        const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n-        const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n-                                WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n-\r\n-        const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-        OpenJson.raise(nullptr, target);\r\n-    }\r\n-\r\n-    void MainPage::OpenJsonKeyDown(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args)\r\n-    {\r\n-        if (args.Key() == VirtualKey::Enter || args.Key() == VirtualKey::Space)\r\n-        {\r\n-            const auto target = args.KeyStatus().IsMenuKeyDown ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-            OpenJson.raise(nullptr, target);\r\n-        }\r\n-    }\r\n-\r\n     void MainPage::SaveButton_Click(const IInspectable& /*sender*/, const RoutedEventArgs& /*args*/)\r\n     {\r\n         _settingsClone.LogSettingChanges(false);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.h b/src/cascadia/TerminalSettingsEditor/MainPage.h\nindex 81724effb11..582f8813b1d 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.h\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.h\n@@ -30,8 +30,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \n         void UpdateSettings(const Model::CascadiaSettings& settings);\n \n-        void OpenJsonKeyDown(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args);\n-        void OpenJsonTapped(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& args);\n         void SettingsNav_Loaded(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\n         void SettingsNav_ItemInvoked(const Microsoft::UI::Xaml::Controls::NavigationView& sender, const Microsoft::UI::Xaml::Controls::NavigationViewItemInvokedEventArgs& args);\n         void SaveButton_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.xaml b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\nindex 3a0773062aa..c6d36e8f200 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n@@ -171,8 +171,8 @@\n             <!--  The OpenJson item needs both Tapped and KeyDown handler  -->\r\n             <muxc:NavigationViewItem x:Name=\"OpenJsonNavItem\"\r\n                                      x:Uid=\"Nav_OpenJSON\"\r\n-                                     KeyDown=\"OpenJsonKeyDown\"\r\n-                                     Tapped=\"OpenJsonTapped\">\r\n+                                     SelectsOnInvoked=\"False\"\r\n+                                     Tag=\"OpenJson_Nav\">\r\n                 <muxc:NavigationViewItem.Icon>\r\n                     <FontIcon Glyph=\"&#xE713;\" />\r\n                 </muxc:NavigationViewItem.Icon>\r\n", "instance_id": "microsoft__terminal-18828", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Screen Reader users are unable to activate the 'Open JSON file' control in scan mode using the 'Enter' key in Windows Terminal. It provides detailed steps to reproduce the issue, the expected behavior, and the actual behavior, along with relevant context about the environment and accessibility guidelines. However, there are minor ambiguities, such as the lack of explicit mention of specific edge cases (e.g., behavior with other keys or in different modes beyond scan mode) and no detailed explanation of the underlying cause or expected solution approach. While the goal is clear, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the easy range (0.2-0.4) due to the following factors:\n1. **Scope and Depth of Code Changes:** The changes are localized to a few files (`MainPage.cpp`, `MainPage.h`, and `MainPage.xaml`) and involve modifying event handling logic for a specific UI control. The diff shows a moderate amount of code change, primarily moving and adapting existing logic for handling key events (e.g., detecting 'Enter' keypress) into a new context within the navigation item invocation. It does not impact the broader system architecture.\n2. **Technical Concepts Involved:** The solution requires understanding of Windows UI XAML framework, event handling (e.g., `Tapped`, `KeyDown`, and navigation item invocation), and basic keyboard state management (e.g., detecting Alt key states). These are relatively straightforward concepts for someone familiar with Windows application development or UI programming, though they do require specific knowledge of the WinRT and XAML APIs.\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention complex edge cases beyond the primary issue of scan mode activation. The code changes handle the basic requirement of detecting key states (e.g., Alt key for choosing between settings and defaults file), but no additional error handling or complex edge case logic is introduced.\n4. **Overall Complexity:** The task involves adapting existing logic to a new event context (NavigationView item invocation) rather than creating entirely new functionality. It requires understanding the intent behind the UI interaction but does not demand deep architectural changes or advanced algorithms.\nGiven these points, a score of 0.35 reflects an easy problem that requires some understanding of the codebase and UI event handling but is not particularly complex or far-reaching in impact.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Terminal Chat AI] Allow company wide disabling this feature \n<!-- \n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\n\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\n\nAll good? Then proceed!\n-->\n\n# Description of the new feature/enhancement\n\nSome companies don't allow the usage of AI features or software that has AI feature for privacy reasons. \n\nPlease implement a way to centrally force disable this feature.\n\n# Proposed technical implementation details (optional)\n\nThis can be a policy or HKLM registry value/setting that admins can use to easily disabled this feature for all users.\n\nThis setting should work for portable, store and manually installed versions and on all chanels.\n\n", "patch": "diff --git a/policies/WindowsTerminal.admx b/policies/WindowsTerminal.admx\nindex 48c36aec7eb..ccda3e0ffd7 100644\n--- a/policies/WindowsTerminal.admx\n+++ b/policies/WindowsTerminal.admx\n@@ -9,6 +9,7 @@\n   <supportedOn>\r\n     <definitions>\r\n       <definition name=\"SUPPORTED_WindowsTerminal_1_21\" displayName=\"$(string.SUPPORTED_WindowsTerminal_1_21)\" />\r\n+      <definition name=\"SUPPORTED_WindowsTerminalCanary_1_23\" displayName=\"$(string.SUPPORTED_WindowsTerminalCanary_1_23)\" />\r\n     </definitions>\r\n   </supportedOn>\r\n   <categories>\r\n@@ -24,5 +25,12 @@\n         <multiText id=\"DisabledProfileSources\" valueName=\"DisabledProfileSources\" required=\"true\" />\r\n       </elements>\r\n     </policy>\r\n+    <policy name=\"EnabledLMProviders\" class=\"Both\" displayName=\"$(string.EnabledLMProviders)\" explainText=\"$(string.EnabledLMProvidersText)\" presentation=\"$(presentation.EnabledLMProviders)\" key=\"Software\\Policies\\Microsoft\\Windows Terminal\">\r\n+      <parentCategory ref=\"WindowsTerminal\" />\r\n+      <supportedOn ref=\"SUPPORTED_WindowsTerminalCanary_1_23\" />\r\n+      <elements>\r\n+        <multiText id=\"EnabledLMProviders\" valueName=\"EnabledLMProviders\" required=\"false\" />\r\n+      </elements>\r\n+    </policy>\r\n   </policies>\r\n </policyDefinitions>\r\ndiff --git a/policies/en-US/WindowsTerminal.adml b/policies/en-US/WindowsTerminal.adml\nindex 5516292e123..089b4bdd7e2 100644\n--- a/policies/en-US/WindowsTerminal.adml\n+++ b/policies/en-US/WindowsTerminal.adml\n@@ -7,6 +7,7 @@\n     <stringTable>\r\n       <string id=\"WindowsTerminal\">Windows Terminal</string>\r\n       <string id=\"SUPPORTED_WindowsTerminal_1_21\">At least Windows Terminal 1.21</string>\r\n+      <string id=\"SUPPORTED_WindowsTerminalCanary_1_23\">At least Windows Terminal Canary 1.23</string>\r\n       <string id=\"DisabledProfileSources\">Disabled Profile Sources</string>\r\n       <string id=\"DisabledProfileSourcesText\">Profiles will not be generated from any sources listed here. Source names can be arbitrary strings. Potential candidates can be found as the \"source\" property on profile definitions in Windows Terminal's settings.json file.\r\n \r\n@@ -18,11 +19,25 @@ Common sources are:\n For instance, setting this policy to Windows.Terminal.Wsl will disable the builtin WSL integration of Windows Terminal.\r\n \r\n Note: Existing profiles will disappear from Windows Terminal after adding their source to this policy.</string>\r\n+      <string id=\"EnabledLMProviders\">Enabled Language Model/AI Providers</string>\r\n+      <string id=\"EnabledLMProvidersText\">The listed Language Models/AI Providers will be available for use in Terminal Chat.\r\n+\r\n+Enabling the policy but leaving the list empty disallows all providers and therefore disables the Terminal Chat feature completely.\r\n+\r\n+Common providers are:\r\n+- AzureOpenAI\r\n+- OpenAI\r\n+- GitHubCopilot\r\n+\r\n+For instance, setting this policy to GitHubCopilot will allow the use of GitHubCopilot in Terminal Chat.</string>\r\n     </stringTable>\r\n     <presentationTable>\r\n       <presentation id=\"DisabledProfileSources\">\r\n         <multiTextBox refId=\"DisabledProfileSources\">List of disabled sources (one per line)</multiTextBox>\r\n       </presentation>\r\n+      <presentation id=\"EnabledLMProviders\">\r\n+        <multiTextBox refId=\"EnabledLMProviders\">List of enabled Language Model/AI Providers (one per line)</multiTextBox>\r\n+      </presentation>\r\n     </presentationTable>\r\n   </resources>\r\n </policyDefinitionResources>\r\ndiff --git a/src/cascadia/QueryExtension/ExtensionPalette.cpp b/src/cascadia/QueryExtension/ExtensionPalette.cpp\nindex 29fec0e9c0d..9606a96d1ea 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.cpp\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.cpp\n@@ -99,16 +99,16 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n         _lmProvider = lmProvider;\n         _clearAndInitializeMessages(nullptr, nullptr);\n \n-        const auto brandingData = _lmProvider.BrandingData();\n-        const auto headerIconPath = brandingData.HeaderIconPath().empty() ? terminalChatLogoPath : brandingData.HeaderIconPath();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n+        const auto headerIconPath = (!brandingData || brandingData.HeaderIconPath().empty()) ? terminalChatLogoPath : brandingData.HeaderIconPath();\n         Windows::Foundation::Uri headerImageSourceUri{ headerIconPath };\n         Media::Imaging::BitmapImage headerImageSource{ headerImageSourceUri };\n         HeaderIcon().Source(headerImageSource);\n \n-        const auto headerText = brandingData.HeaderText().empty() ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n+        const auto headerText = (!brandingData || brandingData.HeaderText().empty()) ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n         QueryIntro().Text(headerText);\n \n-        const auto subheaderText = brandingData.SubheaderText().empty() ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n+        const auto subheaderText = (!brandingData || brandingData.SubheaderText().empty()) ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n         TitleSubheader().Text(subheaderText);\n     }\n \n@@ -234,9 +234,9 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n             }\n         }\n \n-        const auto brandingData = _lmProvider.BrandingData();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n         const auto responseAttribution = response.ResponseAttribution().empty() ? _ProfileName : response.ResponseAttribution();\n-        const auto badgeUriPath = _lmProvider ? brandingData.BadgeIconPath() : winrt::hstring{};\n+        const auto badgeUriPath = brandingData ? brandingData.BadgeIconPath() : L\"\";\n         const auto responseGroupedMessages = winrt::make<GroupedChatMessages>(time, false, winrt::single_threaded_vector(std::move(messageParts)), responseAttribution, badgeUriPath);\n         _messages.Append(responseGroupedMessages);\n \ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 36a2b20b5bf..1aeb8cb013e 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -662,18 +662,23 @@ namespace winrt::TerminalApp::implementation\n     void TerminalPage::_HandleToggleAIChat(const IInspectable& /*sender*/,\r\n                                            const ActionEventArgs& args)\r\n     {\r\n-        if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n-        {\r\n-            _loadQueryExtension();\r\n-            ExtensionPresenter().Visibility(Visibility::Visible);\r\n-            _extensionPalette.Visibility(Visibility::Visible);\r\n-        }\r\n-        else\r\n+        args.Handled(false);\r\n+        // only handle this if the feature is allowed\r\n+        if (WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All))\r\n         {\r\n-            _extensionPalette.Visibility(Visibility::Collapsed);\r\n-            ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n+            {\r\n+                _loadQueryExtension();\r\n+                ExtensionPresenter().Visibility(Visibility::Visible);\r\n+                _extensionPalette.Visibility(Visibility::Visible);\r\n+            }\r\n+            else\r\n+            {\r\n+                _extensionPalette.Visibility(Visibility::Collapsed);\r\n+                ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            }\r\n+            args.Handled(true);\r\n         }\r\n-        args.Handled(true);\r\n     }\r\n \r\n     void TerminalPage::_HandleSetColorScheme(const IInspectable& /*sender*/,\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex f17d32cdea5..fbb1d62c829 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,58 +989,61 @@ namespace winrt::TerminalApp::implementation\n                 _SetAcceleratorForMenuItem(commandPaletteFlyout, commandPaletteKeyChord);\n             }\n \n-            // Create the AI chat button.\n-            auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n-            AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n-            const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n-\n-            WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n-            Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n-\n-            // BODGY\n-            // Manually load this icon from an SVG path; it is ironically much more humane this way.\n-            // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n-            // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n-            {\n-                static constexpr wil::zwstring_view pathSVG{\n-                    L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n-                    \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n-                    \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n-                    \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n-                    \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n-                    \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n-                    \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n-                    \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n-                    \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n-                    \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n-                    \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n-                    \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n-                    \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n-                    \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n-                    \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n-                    \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n-                    \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n-                    \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n-                    \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n-                };\n-                try\n+            // Create the AI chat button if AI features are allowed\n+            if (WI_IsAnyFlagSet(_settings.GlobalSettings().AIInfo().AllowedLMProviders(), EnabledLMProviders::All))\n+            {\n+                auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n+                AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n+                const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n+\n+                WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n+                Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n+\n+                // BODGY\n+                // Manually load this icon from an SVG path; it is ironically much more humane this way.\n+                // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n+                // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n                 {\n-                    hstring hsPathSVG{ pathSVG };\n-                    auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n-                    WUX::Controls::PathIcon pathIcon;\n-                    pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n-                    AIChatFlyout.Icon(pathIcon);\n+                    static constexpr wil::zwstring_view pathSVG{\n+                        L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n+                        \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n+                        \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n+                        \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n+                        \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n+                        \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n+                        \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n+                        \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n+                        \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n+                        \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n+                        \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n+                        \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n+                        \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n+                        \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n+                        \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n+                        \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n+                        \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n+                        \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n+                        \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n+                    };\n+                    try\n+                    {\n+                        hstring hsPathSVG{ pathSVG };\n+                        auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n+                        WUX::Controls::PathIcon pathIcon;\n+                        pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n+                        AIChatFlyout.Icon(pathIcon);\n+                    }\n+                    CATCH_LOG();\n                 }\n-                CATCH_LOG();\n-            }\n \n-            AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n-            newTabFlyout.Items().Append(AIChatFlyout);\n+                AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n+                newTabFlyout.Items().Append(AIChatFlyout);\n \n-            const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n-            if (AIChatKeyChord)\n-            {\n-                _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n+                if (AIChatKeyChord)\n+                {\n+                    _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                }\n             }\n \n             // Create the about button.\n@@ -5755,31 +5758,34 @@ namespace winrt::TerminalApp::implementation\n             }\n         }\n \n-        // we now have a provider of the correct type, update that\n-        winrt::hstring newAuthValues = authValuesString;\n-        if (newAuthValues.empty())\n+        if (_lmProvider)\n         {\n-            Windows::Data::Json::JsonObject authValuesJson;\n-            const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n-            switch (providerType)\n+            // we now have a provider of the correct type, update that\n+            winrt::hstring newAuthValues = authValuesString;\n+            if (newAuthValues.empty())\n             {\n-            case LLMProvider::AzureOpenAI:\n-                authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::OpenAI:\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::GithubCopilot:\n-                newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n-                break;\n-            default:\n-                break;\n+                Windows::Data::Json::JsonObject authValuesJson;\n+                const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n+                switch (providerType)\n+                {\n+                case LLMProvider::AzureOpenAI:\n+                    authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::OpenAI:\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::GithubCopilot:\n+                    newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n+                    break;\n+                default:\n+                    break;\n+                }\n             }\n+            _lmProvider.SetAuthentication(newAuthValues);\n         }\n-        _lmProvider.SetAuthentication(newAuthValues);\n \n         if (_extensionPalette)\n         {\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettings.xaml b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\nindex 676071a0930..c99020d6b97 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n@@ -40,8 +40,9 @@\n                            Style=\"{StaticResource TextBlockSubHeaderStyle}\" />\r\n                 <!--  GitHub Copilot  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_GithubCopilot\"\r\n-                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\"\r\n-                                        Visibility=\"{x:Bind ViewModel.GithubCopilotFeatureEnabled}\">\r\n+                                        CurrentValue=\"{x:Bind ViewModel.GithubCopilotStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.GithubCopilotAllowed}\"\r\n+                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreGithubCopilotTokensSet, Mode=OneWay}\">\r\n                             <Grid.ColumnDefinitions>\r\n@@ -137,6 +138,8 @@\n                 </local:SettingContainer>\r\n                 <!--  Azure OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_AzureOpenAIKeyAndEndpoint\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.AzureOpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.AzureOpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreAzureOpenAIKeyAndEndpointSet, Mode=OneWay}\">\r\n@@ -261,6 +264,8 @@\n                 </local:SettingContainer>\r\n                 <!--  OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_OpenAIKey\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.OpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.OpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.IsOpenAIKeySet, Mode=OneWay}\">\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\nindex 85ac83dc138..9a7df4b771c 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n@@ -17,6 +17,8 @@ using namespace winrt::Windows::UI::Xaml::Controls;\n using namespace winrt::Microsoft::Terminal::Settings::Model;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static constexpr std::wstring_view lockGlyph{ L\"\\uE72E\" };\r\n+\r\n namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\r\n {\r\n     AISettingsViewModel::AISettingsViewModel(Model::CascadiaSettings settings) :\r\n@@ -38,7 +40,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIEndpoint(winrt::hstring endpoint)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIEndpoint(endpoint);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n     }\r\n \r\n     winrt::hstring AISettingsViewModel::AzureOpenAIKey()\r\n@@ -49,7 +51,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIKey(key);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::AzureOpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::AzureOpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::AzureOpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::AzureOpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsOpenAIKeySet()\r\n@@ -65,7 +77,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::OpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().OpenAIKey(key);\r\n-        _NotifyChanges(L\"IsOpenAIKeySet\");\r\n+        _NotifyChanges(L\"IsOpenAIKeySet\", L\"OpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::OpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::OpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::OpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::OpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::AzureOpenAIActive()\r\n@@ -78,8 +100,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::AzureOpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::OpenAIActive()\r\n@@ -92,8 +118,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::OpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::AreGithubCopilotTokensSet()\r\n@@ -109,7 +139,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::GithubCopilotAuthValues(winrt::hstring authValues)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().GithubCopilotAuthValues(authValues);\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::GithubCopilotActive()\r\n@@ -122,13 +152,22 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::GithubCopilot);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n-    bool AISettingsViewModel::GithubCopilotFeatureEnabled()\r\n+    bool AISettingsViewModel::GithubCopilotAllowed() const noexcept\r\n     {\r\n-        return Feature_GithubCopilot::IsEnabled();\r\n+        return Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::GithubCopilot);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::GithubCopilotStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::GithubCopilot);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsTerminalPackaged()\r\n@@ -152,6 +191,55 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::_OnGithubAuthCompleted(const winrt::hstring& message)\r\n     {\r\n         _githubCopilotAuthMessage = message;\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\", L\"GithubCopilotStatus\");\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::_getStatusHelper(const Model::LLMProvider provider)\r\n+    {\r\n+        bool allowed;\r\n+        bool active;\r\n+        bool loggedIn;\r\n+        switch (provider)\r\n+        {\r\n+        case LLMProvider::AzureOpenAI:\r\n+            allowed = AzureOpenAIAllowed();\r\n+            active = AzureOpenAIActive();\r\n+            loggedIn = AreAzureOpenAIKeyAndEndpointSet();\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            allowed = OpenAIAllowed();\r\n+            active = OpenAIActive();\r\n+            loggedIn = IsOpenAIKeySet();\r\n+            break;\r\n+        case LLMProvider::GithubCopilot:\r\n+            allowed = GithubCopilotAllowed();\r\n+            active = GithubCopilotActive();\r\n+            loggedIn = AreGithubCopilotTokensSet();\r\n+            break;\r\n+        default:\r\n+            return L\"\";\r\n+        }\r\n+\r\n+        if (!allowed)\r\n+        {\r\n+            // not allowed, display the lock glyph\r\n+            return winrt::hstring{ lockGlyph } + L\" \" + RS_(L\"AISettings_ProviderNotAllowed\");\r\n+        }\r\n+        else if (active && loggedIn)\r\n+        {\r\n+            // active provider and logged in\r\n+            return RS_(L\"AISettings_ActiveLoggedIn\");\r\n+        }\r\n+        else if (active)\r\n+        {\r\n+            // active provider, not logged in\r\n+            return RS_(L\"AISettings_Active\");\r\n+        }\r\n+        else if (loggedIn)\r\n+        {\r\n+            // logged in, not active provider\r\n+            return RS_(L\"AISettings_LoggedIn\");\r\n+        }\r\n+        return L\"\";\r\n     }\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\nindex 41e8e7379b5..a0822dc65a3 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n@@ -24,27 +24,34 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         void AzureOpenAIKey(winrt::hstring key);\r\n         bool AzureOpenAIActive();\r\n         void AzureOpenAIActive(bool active);\r\n+        bool AzureOpenAIAllowed() const noexcept;\r\n+        winrt::hstring AzureOpenAIStatus();\r\n \r\n         bool IsOpenAIKeySet();\r\n         winrt::hstring OpenAIKey();\r\n         void OpenAIKey(winrt::hstring key);\r\n         bool OpenAIActive();\r\n         void OpenAIActive(bool active);\r\n+        bool OpenAIAllowed() const noexcept;\r\n+        winrt::hstring OpenAIStatus();\r\n \r\n         bool AreGithubCopilotTokensSet();\r\n         winrt::hstring GithubCopilotAuthMessage();\r\n         void GithubCopilotAuthValues(winrt::hstring authValues);\r\n         bool GithubCopilotActive();\r\n         void GithubCopilotActive(bool active);\r\n-        bool GithubCopilotFeatureEnabled();\r\n+        bool GithubCopilotAllowed() const noexcept;\r\n         bool IsTerminalPackaged();\r\n         void InitiateGithubAuth_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& e);\r\n         til::typed_event<Windows::Foundation::IInspectable, Windows::Foundation::IInspectable> GithubAuthRequested;\r\n+        winrt::hstring GithubCopilotStatus();\r\n \r\n     private:\r\n         Model::CascadiaSettings _Settings;\r\n         winrt::hstring _githubCopilotAuthMessage;\r\n \r\n+        winrt::hstring _getStatusHelper(const winrt::Microsoft::Terminal::Settings::Model::LLMProvider provider);\r\n+\r\n         winrt::Microsoft::Terminal::Settings::Editor::MainPage::GithubAuthCompleted_revoker _githubAuthCompleteRevoker;\r\n \r\n         void _OnGithubAuthCompleted(const winrt::hstring& message);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\nindex 6a31438ae84..3844b549800 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n@@ -15,16 +15,21 @@ namespace Microsoft.Terminal.Settings.Editor\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         Boolean AzureOpenAIActive;\r\n+        Boolean AzureOpenAIAllowed { get; };\r\n+        String AzureOpenAIStatus { get; };\r\n \r\n         Boolean IsOpenAIKeySet { get; };\r\n         String OpenAIKey;\r\n         Boolean OpenAIActive;\r\n+        Boolean OpenAIAllowed { get; };\r\n+        String OpenAIStatus { get; };\r\n \r\n         Boolean AreGithubCopilotTokensSet { get; };\r\n         String GithubCopilotAuthMessage { get; };\r\n         void GithubCopilotAuthValues(String authValues);\r\n         Boolean GithubCopilotActive;\r\n-        Boolean GithubCopilotFeatureEnabled { get; };\r\n+        Boolean GithubCopilotAllowed { get; };\r\n+        String GithubCopilotStatus { get; };\r\n         Boolean IsTerminalPackaged { get; };\r\n \r\n         void InitiateGithubAuth_Click(IInspectable sender, Windows.UI.Xaml.RoutedEventArgs args);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex 61c71d8a176..1eb01d86b1e 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -792,6 +792,22 @@\n     <value>Awaiting authentication completion from browser...</value>\r\n     <comment>Text displayed after the user clicks the button to initiate the GitHub authentication flow in their browser.</comment>\r\n   </data>\r\n+  <data name=\"AISettings_Active\" xml:space=\"preserve\">\r\n+    <value>Active</value>\r\n+    <comment>Text displayed when the service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_LoggedIn\" xml:space=\"preserve\">\r\n+    <value>Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ActiveLoggedIn\" xml:space=\"preserve\">\r\n+    <value>Active, Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider and that service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ProviderNotAllowed\" xml:space=\"preserve\">\r\n+    <value>Disabled by your administrator</value>\r\n+    <comment>Text displayed when the service provider has been disabled by the administrator.</comment>\r\n+  </data>\r\n   <data name=\"AISettings_PortableModeDisclaimer.Text\" xml:space=\"preserve\">\r\n     <value>Unable to authenticate to GitHub in unpackaged mode. Please launch Terminal as a packaged application to authenticate.</value>\r\n     <comment>Text displayed to the user when Terminal is un unpackaged mode.</comment>\r\n@@ -2109,4 +2125,4 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+</root>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.cpp b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\nindex 7af8678a3b4..562592b05d0 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n@@ -19,6 +19,45 @@ static constexpr wil::zwstring_view PasswordVaultAIEndpoint = L\"TerminalAIEndpoi\n static constexpr wil::zwstring_view PasswordVaultOpenAIKey = L\"TerminalOpenAIKey\";\r\n static constexpr wil::zwstring_view PasswordVaultGithubCopilotAuthValues = L\"TerminalGithubCopilotAuthValues\";\r\n \r\n+// When new LM providers are added here, make sure you also update the admx/adml!\r\n+static constexpr wil::zwstring_view AzureOpenAIPolicyKey = L\"AzureOpenAI\";\r\n+static constexpr wil::zwstring_view OpenAIPolicyKey = L\"OpenAI\";\r\n+static constexpr wil::zwstring_view GitHubCopilotPolicyKey = L\"GitHubCopilot\";\r\n+\r\n+winrt::Microsoft::Terminal::Settings::Model::EnabledLMProviders AIConfig::AllowedLMProviders() noexcept\r\n+{\r\n+    Model::EnabledLMProviders enabledLMProviders{ Model::EnabledLMProviders::All };\r\n+    // get our allowed list of LM providers from the registry\r\n+    for (const auto key : { HKEY_LOCAL_MACHINE, HKEY_CURRENT_USER })\r\n+    {\r\n+        wchar_t buffer[512]; // \"640K ought to be enough for anyone\"\r\n+        DWORD bufferSize = sizeof(buffer);\r\n+        if (RegGetValueW(key, LR\"(Software\\Policies\\Microsoft\\Windows Terminal)\", L\"EnabledLMProviders\", RRF_RT_REG_MULTI_SZ, nullptr, buffer, &bufferSize) == 0)\r\n+        {\r\n+            WI_ClearAllFlags(enabledLMProviders, Model::EnabledLMProviders::All);\r\n+            for (auto p = buffer; *p;)\r\n+            {\r\n+                const std::wstring_view value{ p };\r\n+                if (value == AzureOpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::AzureOpenAI);\r\n+                }\r\n+                else if (value == OpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::OpenAI);\r\n+                }\r\n+                else if (value == GitHubCopilotPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::GithubCopilot);\r\n+                }\r\n+                p += value.size() + 1;\r\n+            }\r\n+            break;\r\n+        }\r\n+    }\r\n+    return enabledLMProviders;\r\n+}\r\n+\r\n winrt::com_ptr<AIConfig> AIConfig::CopyAIConfig(const AIConfig* source)\r\n {\r\n     auto aiConfig{ winrt::make_self<AIConfig>() };\r\n@@ -108,16 +147,36 @@ winrt::hstring AIConfig::GithubCopilotAuthValues()\n \r\n winrt::Microsoft::Terminal::Settings::Model::LLMProvider AIConfig::ActiveProvider()\r\n {\r\n+    const auto allowedLMProviders = AllowedLMProviders();\r\n     const auto val{ _getActiveProviderImpl() };\r\n     if (val)\r\n     {\r\n-        // an active provider was explicitly set, return that\r\n-        // special case: only allow github copilot if the feature is enabled\r\n-        if (*val == LLMProvider::GithubCopilot && !Feature_GithubCopilot::IsEnabled())\r\n+        const auto setProvider = *val;\r\n+        // an active provider was explicitly set, return that as long as it is allowed\r\n+        switch (setProvider)\r\n         {\r\n-            return LLMProvider{};\r\n+        case LLMProvider::GithubCopilot:\r\n+            if (Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::GithubCopilot))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::AzureOpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::AzureOpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::OpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        default:\r\n+            break;\r\n         }\r\n-        return *val;\r\n+        return LLMProvider{};\r\n     }\r\n     else if (!AzureOpenAIEndpoint().empty() && !AzureOpenAIKey().empty())\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.h b/src/cascadia/TerminalSettingsModel/AIConfig.h\nindex 5bcf5868af4..5d1cf9e1767 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.h\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.h\n@@ -33,6 +33,8 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         Json::Value ToJson() const;\r\n         void LayerJson(const Json::Value& json);\r\n \r\n+        static Model::EnabledLMProviders AllowedLMProviders() noexcept;\r\n+\r\n         // Key and endpoint storage\r\n         // These are not written to the json, they are stored in the Windows Security Storage Vault\r\n         winrt::hstring AzureOpenAIEndpoint() noexcept;\r\n@@ -58,6 +60,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         _BASE_INHERITABLE_SETTING(Model::AIConfig, std::optional<LLMProvider>, ActiveProvider);\r\n \r\n     private:\r\n+        Model::EnabledLMProviders _enabledLMProviders{ Model::EnabledLMProviders::All };\r\n         winrt::hstring _RetrieveCredential(const wil::zwstring_view credential);\r\n         void _SetCredential(const wil::zwstring_view credential, const winrt::hstring& value);\r\n         std::unordered_map<std::wstring, std::wstring> _credentialCache;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.idl b/src/cascadia/TerminalSettingsModel/AIConfig.idl\nindex e3f15435591..f4ee727eece 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.idl\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.idl\n@@ -7,17 +7,28 @@ namespace Microsoft.Terminal.Settings.Model\n {\r\n     enum LLMProvider\r\n     {\r\n+        None,\r\n         AzureOpenAI,\n         OpenAI,\r\n         GithubCopilot\n     };\r\n \r\n+    [flags] enum EnabledLMProviders\r\n+    {\r\n+        AzureOpenAI = 0x1,\r\n+        OpenAI = 0x2,\r\n+        GithubCopilot = 0x4,\r\n+        All = 0xffffffff\r\n+    };\r\n+\r\n     delegate void AzureOpenAISettingChangedHandler();\r\n     delegate void OpenAISettingChangedHandler();\r\n \r\n     [default_interface] runtimeclass AIConfig {\r\n         INHERITABLE_SETTING(LLMProvider, ActiveProvider);\r\n \r\n+        static EnabledLMProviders AllowedLMProviders { get; };\r\n+\r\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         static event AzureOpenAISettingChangedHandler AzureOpenAISettingChanged;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.cpp b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\nindex bebe9ac76bd..4a212aa4edd 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n@@ -348,11 +348,18 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n     // - Actions of the parents are overridden by the children\r\n     void ActionMap::_PopulateCumulativeActionMap(std::unordered_map<hstring, Model::Command>& actionMap)\r\n     {\r\n+        // special case: don't add any ToggleAIChat actions if the feature has been disabled\r\n+        // note: we only refuse to add these actions to the cumulative action map, that way we don't remove them from the user's settings file\r\n+        // this means that these actions won't show up in the command palette, but any keybindings/modifications/etc to them will persist\r\n+        const auto terminalChatDisabled = !WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All);\r\n         for (const auto& [cmdID, cmd] : _ActionMap)\r\n         {\r\n             if (!actionMap.contains(cmdID))\r\n             {\r\n-                actionMap.emplace(cmdID, cmd);\r\n+                if (!terminalChatDisabled || cmd.ActionAndArgs().Action() != ShortcutAction::ToggleAIChat)\r\n+                {\r\n+                    actionMap.emplace(cmdID, cmd);\r\n+                }\r\n             }\r\n         }\r\n \r\n", "instance_id": "microsoft__terminal-18095", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in its intent to implement a feature for centrally disabling the Terminal Chat AI functionality across a company. It specifies the goal of allowing administrators to disable the feature via a policy or registry setting and mentions compatibility with various installation types and channels. However, there are minor ambiguities and missing details. For instance, it does not explicitly define how the policy should interact with existing user configurations or whether there are specific security or logging requirements when the feature is disabled. Additionally, while the proposed technical implementation is mentioned (policy or HKLM registry value), it lacks specifics on expected behavior if the policy is partially set or misconfigured. There are no examples or detailed constraints provided, which could lead to assumptions during implementation. Overall, the statement is valid and clear in its primary objective but misses some finer details and edge case considerations.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files and modules, including policy definitions (ADMX/ADML files), UI components, settings management, and core application logic in a Windows Terminal codebase, likely written in C++. This requires understanding interactions between policy settings, registry values, and application behavior, as well as modifying both frontend and backend components. The changes involve a moderate amount of code, with significant updates to handle feature toggling based on policy settings and ensuring that UI elements (like the AI chat button) and functionality are conditionally available.\n\nTechnically, the problem requires familiarity with several concepts: Windows registry and group policy management (for implementing the disable feature), WinRT and XAML for UI modifications, and the specific architecture of the Windows Terminal application for integrating these changes without breaking existing functionality. The code changes also introduce conditional logic to check for allowed AI providers, which adds complexity in terms of state management and ensuring consistency across different parts of the application.\n\nEdge cases and error handling add to the difficulty. The problem does not explicitly mention edge cases, but the code changes suggest scenarios like partial policy configurations, conflicts between user settings and admin policies, or handling cases where the feature is disabled mid-session. These require careful consideration to avoid unexpected behavior or crashes, especially in a multi-user or enterprise environment. While the problem does not appear to impact the core architecture significantly or require advanced algorithms, the need to ensure robustness across different installation types (portable, store, manual) and channels increases the complexity.\n\nOverall, this task is not trivial but also not extremely challenging. It requires a solid understanding of the codebase and multiple technical domains, placing it in the medium difficulty range of 0.55. It is more complex than a simple bug fix or feature addition but does not reach the level of a major architectural refactor or highly specialized domain knowledge.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Search results steal focus and scroll when the buffer changes at all\n### Windows Terminal version\n\n1.21.1272.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n- Fill the buffer with enough text to make it scrollable (for example, using `Get-Random -Count 1000` in PowerShell),\r\n- search something in such a way that the last result is outside the view,\r\n- select a search result which is not the last (optinal),\r\n- type something in the prompt.\n\n### Expected Behavior\n\nWhile typing in the prompt nothing happen, the select result stays the same, and the view focus the prompt.\n\n### Actual Behavior\n\nWhen typing, the search appear to retrigger, and the focus goes to the last result, moving the prompt outside view.\n", "patch": "diff --git a/src/buffer/out/search.cpp b/src/buffer/out/search.cpp\nindex 31c7081b2b9..75143f047ca 100644\n--- a/src/buffer/out/search.cpp\n+++ b/src/buffer/out/search.cpp\n@@ -16,7 +16,7 @@ bool Search::IsStale(const Microsoft::Console::Render::IRenderData& renderData,\n            _lastMutationId != renderData.GetTextBuffer().GetLastMutationId();\r\n }\r\n \r\n-bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n+void Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n {\r\n     const auto& textBuffer = renderData.GetTextBuffer();\r\n \r\n@@ -30,15 +30,15 @@ bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const st\n     _results = std::move(result).value_or(std::vector<til::point_span>{});\r\n     _index = reverse ? gsl::narrow_cast<ptrdiff_t>(_results.size()) - 1 : 0;\r\n     _step = reverse ? -1 : 1;\r\n-    return true;\r\n-}\r\n \r\n-void Search::MoveToCurrentSelection()\r\n-{\r\n     if (_renderData->IsSelectionActive())\r\n     {\r\n         MoveToPoint(_renderData->GetTextBuffer().ScreenToBufferPosition(_renderData->GetSelectionAnchor()));\r\n     }\r\n+    else if (const auto span = _renderData->GetSearchHighlightFocused())\r\n+    {\r\n+        MoveToPoint(_step > 0 ? span->start : span->end);\r\n+    }\r\n }\r\n \r\n void Search::MoveToPoint(const til::point anchor) noexcept\r\ndiff --git a/src/buffer/out/search.h b/src/buffer/out/search.h\nindex 763b5d40c73..304de1ab889 100644\n--- a/src/buffer/out/search.h\n+++ b/src/buffer/out/search.h\n@@ -36,9 +36,8 @@ class Search final\n     Search() = default;\r\n \r\n     bool IsStale(const Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags) const noexcept;\r\n-    bool Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n+    void Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n \r\n-    void MoveToCurrentSelection();\r\n     void MoveToPoint(til::point anchor) noexcept;\r\n     void MovePastPoint(til::point anchor) noexcept;\r\n     void FindNext(bool reverse) noexcept;\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex cd4f5f58b81..5d379ba6c5e 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1697,38 +1697,41 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     SearchResults ControlCore::Search(SearchRequest request)\r\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n+\r\n         SearchFlag flags{};\r\n         WI_SetFlagIf(flags, SearchFlag::CaseInsensitive, !request.CaseSensitive);\r\n         WI_SetFlagIf(flags, SearchFlag::RegularExpression, request.RegularExpression);\r\n         const auto searchInvalidated = _searcher.IsStale(*_terminal.get(), request.Text, flags);\r\n \r\n-        if (searchInvalidated || !request.Reset)\r\n+        if (searchInvalidated || !request.ResetOnly)\r\n         {\r\n             std::vector<til::point_span> oldResults;\r\n+            til::point_span oldFocused;\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused())\r\n+            {\r\n+                oldFocused = *focused;\r\n+            }\r\n \r\n             if (searchInvalidated)\r\n             {\r\n                 oldResults = _searcher.ExtractResults();\r\n                 _searcher.Reset(*_terminal.get(), request.Text, flags, !request.GoForward);\r\n-\r\n-                if (SnapSearchResultToSelection())\r\n-                {\r\n-                    _searcher.MoveToCurrentSelection();\r\n-                    SnapSearchResultToSelection(false);\r\n-                }\r\n-\r\n                 _terminal->SetSearchHighlights(_searcher.Results());\r\n             }\r\n-            else\r\n+\r\n+            if (!request.ResetOnly)\r\n             {\r\n                 _searcher.FindNext(!request.GoForward);\r\n             }\r\n \r\n-            if (const auto idx = _searcher.CurrentMatch(); idx >= 0)\r\n+            _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(std::max<ptrdiff_t>(0, _searcher.CurrentMatch())));\r\n+            _renderer->TriggerSearchHighlight(oldResults);\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused(); focused && *focused != oldFocused)\r\n             {\r\n-                _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(idx), request.ScrollOffset);\r\n+                _terminal->ScrollToSearchHighlight(request.ScrollOffset);\r\n             }\r\n-            _renderer->TriggerSearchHighlight(oldResults);\r\n         }\r\n \r\n         int32_t totalMatches = 0;\r\n@@ -1756,27 +1759,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n         _terminal->SetSearchHighlights({});\r\n-        _terminal->SetSearchHighlightFocused({}, 0);\r\n+        _terminal->SetSearchHighlightFocused(0);\r\n         _renderer->TriggerSearchHighlight(_searcher.Results());\r\n         _searcher = {};\r\n     }\r\n \r\n-    // Method Description:\r\n-    // - Tells ControlCore to snap the current search result index to currently\r\n-    //   selected text if the search was started using it.\r\n-    void ControlCore::SnapSearchResultToSelection(bool shouldSnap) noexcept\r\n-    {\r\n-        _snapSearchResultToSelection = shouldSnap;\r\n-    }\r\n-\r\n-    // Method Description:\r\n-    // - Returns true, if we should snap the current search result index to\r\n-    //   the currently selected text after a new search is started, else false.\r\n-    bool ControlCore::SnapSearchResultToSelection() const noexcept\r\n-    {\r\n-        return _snapSearchResultToSelection;\r\n-    }\r\n-\r\n     void ControlCore::Close()\r\n     {\r\n         if (!_IsClosing())\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 9ac8e5450c3..2e9f2490d9d 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -228,8 +228,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         SearchResults Search(SearchRequest request);\r\n         const std::vector<til::point_span>& SearchResultRows() const noexcept;\r\n         void ClearSearch();\r\n-        void SnapSearchResultToSelection(bool snap) noexcept;\r\n-        bool SnapSearchResultToSelection() const noexcept;\r\n \r\n         void LeftClickOnTerminal(const til::point terminalPosition,\r\n                                  const int numberOfClicks,\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.idl b/src/cascadia/TerminalControl/ControlCore.idl\nindex 3be52269a89..ee1a4787e22 100644\n--- a/src/cascadia/TerminalControl/ControlCore.idl\n+++ b/src/cascadia/TerminalControl/ControlCore.idl\n@@ -55,7 +55,7 @@ namespace Microsoft.Terminal.Control\n         Boolean GoForward;\r\n         Boolean CaseSensitive;\r\n         Boolean RegularExpression;\r\n-        Boolean Reset;\r\n+        Boolean ResetOnly;\r\n         Int32 ScrollOffset;\r\n     };\r\n \r\n@@ -148,7 +148,6 @@ namespace Microsoft.Terminal.Control\n \r\n         SearchResults Search(SearchRequest request);\r\n         void ClearSearch();\r\n-        Boolean SnapSearchResultToSelection;\r\n \r\n         Microsoft.Terminal.Core.Color ForegroundColor { get; };\r\n         Microsoft.Terminal.Core.Color BackgroundColor { get; };\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 565ea02ccf6..5f981f89e65 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -576,7 +576,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // but since code paths differ, extra work is required to ensure correctness.\r\n                     if (!_core.HasMultiLineSelection())\r\n                     {\r\n-                        _core.SnapSearchResultToSelection(true);\r\n                         const auto selectedLine{ _core.SelectedText(true) };\r\n                         _searchBox->PopulateTextbox(selectedLine);\r\n                     }\r\n@@ -3844,7 +3843,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         const auto goForward = _searchBox->GoForward();\r\n         const auto caseSensitive = _searchBox->CaseSensitive();\r\n         const auto regularExpression = _searchBox->RegularExpression();\r\n-        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _calculateSearchScrollOffset() };\r\n+        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _searchScrollOffset };\r\n         _handleSearchResults(_core.Search(request));\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c5876e1497c..df24a3e8917 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1259,15 +1259,17 @@ void Terminal::SetSearchHighlights(const std::vector<til::point_span>& highlight\n // Method Description:\r\n // - Stores the focused search highlighted region in the terminal\r\n // - If the region isn't empty, it will be brought into view\r\n-void Terminal::SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset)\r\n+void Terminal::SetSearchHighlightFocused(const size_t focusedIdx) noexcept\r\n {\r\n     _assertLocked();\r\n     _searchHighlightFocused = focusedIdx;\r\n+}\r\n \r\n-    // bring the focused region into the view if the index is in valid range\r\n-    if (focusedIdx < _searchHighlights.size())\r\n+void Terminal::ScrollToSearchHighlight(til::CoordType searchScrollOffset)\r\n+{\r\n+    if (_searchHighlightFocused < _searchHighlights.size())\r\n     {\r\n-        const auto focused = til::at(_searchHighlights, focusedIdx);\r\n+        const auto focused = til::at(_searchHighlights, _searchHighlightFocused);\r\n         const auto adjustedStart = til::point{ focused.start.x, std::max(0, focused.start.y - searchScrollOffset) };\r\n         const auto adjustedEnd = til::point{ focused.end.x, std::max(0, focused.end.y - searchScrollOffset) };\r\n         _ScrollToPoints(adjustedStart, adjustedEnd);\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..d62a76b3bc8 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -234,7 +234,8 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetClearQuickFixCallback(std::function<void()> pfn) noexcept;\r\n     void SetWindowSizeChangedCallback(std::function<void(int32_t, int32_t)> pfn) noexcept;\r\n     void SetSearchHighlights(const std::vector<til::point_span>& highlights) noexcept;\r\n-    void SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset);\r\n+    void SetSearchHighlightFocused(size_t focusedIdx) noexcept;\r\n+    void ScrollToSearchHighlight(til::CoordType searchScrollOffset);\r\n \r\n     void BlinkCursor() noexcept;\r\n     void SetCursorOn(const bool isOn) noexcept;\r\ndiff --git a/src/interactivity/win32/find.cpp b/src/interactivity/win32/find.cpp\nindex 033918e3ae5..07996c47767 100644\n--- a/src/interactivity/win32/find.cpp\n+++ b/src/interactivity/win32/find.cpp\n@@ -57,7 +57,6 @@ INT_PTR CALLBACK FindDialogProc(HWND hWnd, UINT Message, WPARAM wParam, LPARAM l\n             if (searcher.IsStale(gci.renderData, lastFindString, flags))\r\n             {\r\n                 searcher.Reset(gci.renderData, lastFindString, flags, reverse);\r\n-                searcher.MoveToCurrentSelection();\r\n             }\r\n             else\r\n             {\r\n", "instance_id": "microsoft__terminal-17885", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: search results in Windows Terminal steal focus and scroll when the buffer changes (e.g., while typing in the prompt). It provides specific steps to reproduce the issue, expected behavior, and actual behavior, which helps in understanding the problem context. However, there are minor ambiguities and missing details. For instance, it does not explicitly define whether this behavior should be configurable or if there are specific conditions under which focus should or should not shift. Additionally, edge cases (e.g., behavior with empty buffers or no search results) are not mentioned, which could impact the solution's completeness. Overall, while the goal is clear, the lack of exhaustive constraints or edge case specifications prevents it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files (e.g., `search.cpp`, `ControlCore.cpp`, `Terminal.cpp`) and involves modifications to the interaction between search functionality, focus management, and rendering logic in the Windows Terminal codebase. This requires a solid understanding of the internal architecture, particularly how search results are tracked, highlighted, and interacted with during buffer updates. Second, the technical concepts involved include handling state management for search results, understanding rendering and focus logic, and modifying method signatures and behavior (e.g., changing `Reset` from returning a boolean to void, adjusting focus handling). While these concepts are not extraordinarily complex, they do require familiarity with the specific codebase and C++ intricacies like noexcept specifications and smart pointer usage. Third, the changes impact a moderate amount of code but do not appear to alter the system's core architecture significantly. Finally, potential edge cases (e.g., no search results, invalid indices, or concurrent buffer modifications) are not explicitly handled in the provided diff but may need consideration, adding a layer of complexity to ensure robustness. Overall, this problem requires a moderate level of expertise and effort, involving cross-file modifications and a good grasp of the terminal's search and rendering mechanisms, but it does not reach the level of a hard or very hard problem due to the absence of advanced algorithmic or system-level challenges.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Godot 4.4 silently closes when using OBS advanced scene switcher (detects active window). GameCapture Mode\n### Tested versions\n\n4.4 issue\n4.3 works fine\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2070 (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (16 threads)\n\n### Issue description\n\n4.4 Godot Crashes when tabbing into other windows using OBS Scene Switcher Plugin(which detects the current window and changes scene)\n\nI will temporarily go back to 4.3 which does not do this.\n\n I'm not sure what options in the editor have changed or if there are some options I can tick to help with this. I've tried many different options. I know the detection of windows isn't youre problem, but why did it work flawlessly in 4.3?\n\nIt only happens if im using GameCapture for Godot 4.4. I just dont want to stream my whole display monitor. I use the advanced scene switcher plugin to make devlogs. Switching scenes between my notes, editor, ect.\n\n\nNo errors. Just my Godot disappears and closes when I tab into other windows. It works fine if Godot isn't Game Capture. \n\nDid anything change in 4.4 for window detection and compatibility with OBS? Ive even tried setting godot 4.4 to single window mode.\n\n### Steps to reproduce\n\nOpen Godot 4.4,\n\nHave scene setup in game capture mode for Godot 4.4.\n\nUse Window Detection with another application ( OBS Automatic Scene Switcher)\n\nScenes automatically switch based on the active window.\n\nGodot crashes when tabbing into other windows.\n\nOpen Godot 4.3\n\nRepeat steps.\n\nGodot does not close/crash\n\n\n### Minimal reproduction project (MRP)\n\nHappens with any 4.4 project. Even brand new ones.\n\nUnable to replicate in 4.3\n", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex 441ba3141ef4..032d367bc18b 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -2517,24 +2517,38 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \tOS::get_singleton()->_allow_layered = GLOBAL_DEF_RST(\"display/window/per_pixel_transparency/allowed\", false);\n \n #ifdef TOOLS_ENABLED\n-\tif (editor || project_manager) {\n-\t\t// The editor and project manager always detect and use hiDPI if needed.\n-\t\tOS::get_singleton()->_allow_hidpi = true;\n-\t\t// Disable Vulkan overlays in editor, they cause various issues.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_MANGOHUD\", \"1\"); // GH-57403.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_RTSS_LAYER\", \"1\"); // GH-57937.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VKBASALT\", \"1\");\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_reshade_1\", \"1\"); // GH-70849.\n-\t\tOS::get_singleton()->set_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\", \"1\"); // GH-101480.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\", \"1\"); // GH-101480.\n-\t} else {\n-\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_MANGOHUD\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_RTSS_LAYER\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VKBASALT\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_reshade_1\");\n-\t\tOS::get_singleton()->unset_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\");\n+\t{\n+\t\t// Synced with https://github.com/baldurk/renderdoc/blob/2b01465c7/renderdoc/driver/vulkan/vk_layer.cpp#L118-L165\n+\t\tLocalVector<String> layers_to_disable = {\n+\t\t\t\"DISABLE_RTSS_LAYER\", // GH-57937.\n+\t\t\t\"DISABLE_VULKAN_OBS_CAPTURE\", // GH-103800.\n+\t\t\t\"DISABLE_VULKAN_OW_OBS_CAPTURE\", // GH-104154.\n+\t\t\t\"DISABLE_SAMPLE_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_GAMEPP_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_VK_LAYER_TENCENT_wegame_cross_overlay_1\", // GH-104154.\n+\t\t\t\"NODEVICE_SELECT\", // GH-104154.\n+\t\t\t\"VK_LAYER_bandicam_helper_DEBUG_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_bandicam_helper_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_reshade_1\", // GH-70849.\n+\t\t\t\"DISABLE_VK_LAYER_GPUOpen_GRS\", // GH-104154.\n+\t\t\t\"DISABLE_LAYER\", // GH-104154 (fpsmon).\n+\t\t\t\"DISABLE_MANGOHUD\", // GH-57403.\n+\t\t\t\"DISABLE_VKBASALT\",\n+\t\t};\n+\n+\t\tif (editor || project_manager) {\n+\t\t\t// The editor and project manager always detect and use hiDPI if needed.\n+\t\t\tOS::get_singleton()->_allow_hidpi = true;\n+\t\t\t// Disable Vulkan overlays in editor, they cause various issues.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->set_environment(layer_disable, \"1\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->unset_environment(layer_disable);\n+\t\t\t}\n+\t\t}\n \t}\n #endif\n \n", "instance_id": "godotengine__godot-104154", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Godot 4.4 crashes when used with OBS Advanced Scene Switcher in GameCapture mode, while Godot 4.3 works fine under the same conditions. The user provides detailed system information, steps to reproduce, and context about their setup (e.g., multi-window, Vulkan rendering, specific hardware). However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem statement does not specify if there are any error logs or crash dumps available, which could help pinpoint the root cause. Additionally, while the issue is reproducible with any project, there is no mention of specific configurations or settings in OBS or Godot that might influence the behavior beyond GameCapture mode and window detection. These missing details could be critical for a complete diagnosis, but the overall description is sufficient to understand the issue and its context.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes appears focused on a specific part of the codebase (main.cpp), specifically around Vulkan layer management and environment variable settings to disable certain overlays or capture layers that might interfere with tools like OBS. The provided diff shows a refactoring of how Vulkan layers are disabled or enabled based on whether the editor or project manager is active, with new layers added to address compatibility issues (e.g., \"DISABLE_VULKAN_OBS_CAPTURE\"). This indicates a moderate scope of change, confined to a single file but impacting a critical initialization path.\n\nSecond, the technical concepts involved are moderately complex. Solving this requires understanding Vulkan layers, environment variable manipulation, and how these interact with external tools like OBS for window detection and capture. It also necessitates familiarity with Godot's rendering and windowing system, particularly changes between versions 4.3 and 4.4, which might involve subtle differences in Vulkan handling or window management.\n\nThird, the problem likely involves edge cases related to specific hardware (e.g., NVIDIA GPUs), driver versions, or OBS configurations, though these are not fully detailed in the problem statement. The code change does not explicitly address error handling but focuses on preventing crashes by disabling problematic layers, suggesting an implicit handling of compatibility issues.\n\nFinally, while the change itself is not architecturally significant, diagnosing the root cause (why Godot 4.4 crashes with OBS while 4.3 does not) and ensuring the solution does not introduce regressions across different setups requires a deep understanding of the Godot engine's internals and third-party tool interactions. This pushes the difficulty beyond medium, as it involves non-trivial debugging and cross-version analysis, likely requiring experience with graphics APIs and system-level interactions. A score of 0.65 reflects the challenge of understanding and resolving a specific compatibility issue in a complex system without widespread architectural impact.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Build error when building for Android with `disable_3d=yes`\n### Tested versions\n\n- Reproducible in: 4.4-stable\n- Not reproducible in 4.3-stable and lower\n\n### System information\n\nArch Linux x86_64 6.13.5-arch1-1\n\n### Issue description\n\nGodot doesn't compile when using the `disable_3d=yes` option in scons\n\n```\nplatform/android/java_godot_lib_jni.cpp:478:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:478:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\n```\n\nTested in Arch Linux and Ubuntu 20.04. No difference.\nThis didn't happen on 4.3 version\nAfter some research it seems like this is connected to this commit: [28d1dcc](https://github.com/godotengine/godot/commit/28d1dccf6370a1754c9bd49b9e5ec3f15db1e535)\n\n### Steps to reproduce\n\n1. Download Godot source code and required build tools\n2. Compile the engine with command `scons platform=android arch=x86_64 disable_3d=yes`\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "patch": "diff --git a/platform/android/java_godot_lib_jni.cpp b/platform/android/java_godot_lib_jni.cpp\nindex 054c809c6e3f..0bb78bb9d974 100644\n--- a/platform/android/java_godot_lib_jni.cpp\n+++ b/platform/android/java_godot_lib_jni.cpp\n@@ -49,6 +49,7 @@\n #include \"core/config/project_settings.h\"\n #include \"core/input/input.h\"\n #include \"main/main.h\"\n+#include \"servers/rendering_server.h\"\n \n #ifndef _3D_DISABLED\n #include \"servers/xr_server.h\"\n", "instance_id": "godotengine__godot-103523", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a build error occurs when compiling Godot for Android with the `disable_3d=yes` option in version 4.4-stable, which did not occur in version 4.3-stable or lower. It provides specific error messages, the affected file, and a reference to a potentially related commit. Steps to reproduce the issue are also included, which adds to the clarity. However, there are minor ambiguities, such as the lack of explicit mention of the expected behavior or desired outcome (e.g., what should happen when `disable_3d=yes` is set). Additionally, edge cases or specific constraints related to the build configuration are not discussed. While the issue is well-documented with error logs and reproduction steps, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is minimal, involving a single file (`java_godot_lib_jni.cpp`) and a straightforward fix of adding a missing header file (`servers/rendering_server.h`) to resolve the compilation error. This indicates a basic issue of missing dependencies rather than complex logic or architectural changes. Second, the technical concepts required are relatively simple: understanding C++ compilation errors, header file inclusions, and conditional compilation macros (e.g., `_3D_DISABLED`). No advanced algorithms, design patterns, or domain-specific knowledge beyond basic C++ and build systems are needed. Third, the problem does not appear to involve complex edge cases or extensive error handling beyond resolving the immediate compilation issue. Finally, the impact is limited to a specific build configuration (`disable_3d=yes` for Android), and there is no indication of broader architectural or performance implications. Overall, this is a straightforward bug fix that requires minimal effort and understanding of the codebase, justifying a difficulty score of 0.25.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Wayland Cursor custom image doesn't update when using Image instead of Texture2D\n### Tested versions\n\n- v4.4.beta.gentoo [4ce466d7f]\n\n### System information\n\nLinux Gentoo using Wayland\n\n### Issue description\n\nWhen using the Wayland DisplayServer you can only update the custom mouse cursor once if you are using Image instead of Texture2D resources and the images have the same hotspot.\n\nThe function `Input.set_custom_mouse_cursor` claims that it is okay to use either an Image or a Texture2D as a custom cursor image. The caching code in `DisplayServerWayland::cursor_set_custom_image` checks for cursor reuse using \"get_rid()\" on the provided resource. Since an Image does not have a RID, any image will always enter the branch `// We have a cached cursor. Nice.`.\n\nBug is visible since #96647 was fixed, although the underlying bug was already older than that.\n\n### Workarounds\n* Use Texture2D instead of image resources - may cause undesired overhead to convert back to image\n* Reset the cursor in between - may cause cursor flickering\n* Move the hotspot locations to force a cache miss - unwanted extra work to make images suitable with different hotspots\n\n### Steps to reproduce\n\n* Force editor and game to use the Wayland display server\n* Make sure the referenced `img1` and `img2` are imported as Image and not as Texture.\n\n```gdscript\nInput.set_custom_mouse_cursor(img1, Input.CURSOR_ARROW)\n# Correctly shows img1 as the cursor\nInput.set_custom_mouse_cursor(img2, Input.CURSOR_ARROW)\n# Still shows img1 as the cursor\n```\n\n### Minimal reproduction project (MRP)\n\n[wayland-cursor-reproducer.zip](https://github.com/user-attachments/files/18510307/wayland-cursor-reproducer.zip)\n", "patch": "diff --git a/platform/linuxbsd/wayland/display_server_wayland.cpp b/platform/linuxbsd/wayland/display_server_wayland.cpp\nindex 532eaa6bcf49..f9b34ff043bf 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.cpp\n+++ b/platform/linuxbsd/wayland/display_server_wayland.cpp\n@@ -1033,7 +1033,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \t\tHashMap<CursorShape, CustomCursor>::Iterator cursor_c = custom_cursors.find(p_shape);\n \n \t\tif (cursor_c) {\n-\t\t\tif (cursor_c->value.rid == p_cursor->get_rid() && cursor_c->value.hotspot == p_hotspot) {\n+\t\t\tif (cursor_c->value.resource == p_cursor && cursor_c->value.hotspot == p_hotspot) {\n \t\t\t\t// We have a cached cursor. Nice.\n \t\t\t\twayland_thread.cursor_set_shape(p_shape);\n \t\t\t\treturn;\n@@ -1049,7 +1049,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \n \t\tCustomCursor &cursor = custom_cursors[p_shape];\n \n-\t\tcursor.rid = p_cursor->get_rid();\n+\t\tcursor.resource = p_cursor;\n \t\tcursor.hotspot = p_hotspot;\n \n \t\twayland_thread.cursor_shape_set_custom_image(p_shape, image, p_hotspot);\ndiff --git a/platform/linuxbsd/wayland/display_server_wayland.h b/platform/linuxbsd/wayland/display_server_wayland.h\nindex 8c3bac9c7e3b..43a8b01b3208 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.h\n+++ b/platform/linuxbsd/wayland/display_server_wayland.h\n@@ -101,7 +101,7 @@ class DisplayServerWayland : public DisplayServer {\n \t};\n \n \tstruct CustomCursor {\n-\t\tRID rid;\n+\t\tRef<Resource> resource;\n \t\tPoint2i hotspot;\n \t};\n \n", "instance_id": "godotengine__godot-101987", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the context (Wayland DisplayServer on Linux Gentoo), the specific bug (custom cursor not updating when using Image instead of Texture2D), and the conditions under which it occurs (same hotspot). It also includes steps to reproduce, a minimal reproduction project, and workarounds, which are helpful for understanding the problem. However, there are minor ambiguities: the problem statement does not explicitly define what constitutes a \"RID\" (Resource ID) or why Images lack it, which is critical to understanding the root cause of the caching issue. Additionally, while edge cases like hotspot differences are mentioned in workarounds, the statement does not fully clarify expected behavior for other potential edge cases (e.g., mixed usage of Image and Texture2D). Overall, it is clear enough to work on but lacks some technical depth in the explanation of underlying mechanisms.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are localized to a single class (`DisplayServerWayland`) in two files (`display_server_wayland.cpp` and `display_server_wayland.h`). The modification involves changing how cursor resources are cached and compared, replacing a `RID` (Resource ID) with a direct reference to the `Resource` object. The amount of code change is minimal (a few lines), and it does not impact the broader system architecture or require extensive refactoring.\n\n2. **Technical Concepts Involved**: Solving this requires a basic understanding of C++ (specifically, working with references and smart pointers like `Ref<Resource>`), familiarity with the Godot engine's resource management system, and a general understanding of Wayland's cursor handling. These concepts are not overly complex for someone with moderate experience in C++ or game engine development. No advanced algorithms, design patterns, or domain-specific knowledge beyond the Godot engine are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement and code changes do not explicitly address new edge cases or error handling beyond fixing the caching logic for Images. The change from `RID` to `Ref<Resource>` might implicitly handle comparison better, but no additional error checking or complex edge case logic is introduced in the provided diff. The workarounds mentioned (e.g., hotspot manipulation) suggest potential edge cases, but the fix itself does not tackle them directly.\n\n4. **Overall Complexity**: The bug fix is straightforward\u2014replacing an identifier-based comparison with a direct resource reference comparison. It requires understanding why `get_rid()` fails for Images (as they lack a RID), but this is a relatively simple logical deduction once the issue is identified. The impact is limited to cursor handling in Wayland, and there are no performance or scalability concerns evident in the change.\n\nGiven these points, a score of 0.35 reflects an \"Easy\" problem that requires understanding some specific codebase logic (Godot's resource system and Wayland cursor handling) and making a simple, targeted modification. It is slightly above the lower end of the range due to the need for domain-specific knowledge of Godot's internals, but it does not approach medium difficulty as the scope and complexity remain low.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Excessive error spam when a global script is not valid\n### Tested versions\n\n4.4 dev7\n\n### System information\n\nW10\n\n### Issue description\n\nIf you have a global script (with `class_name`) and it has an error, the error will be spammed occasionally when using editor. I observed it e.g. when opening CreateDialog to add a node (happens once), or every time you try to autocomplete something.\nhttps://github.com/user-attachments/assets/97e7b7f2-e148-42ee-a481-025a07a2d38f\nWhat's relevant though is that the error appears at all. It means the script is loaded and/or parsed needlessly *very often* and it probably applies to all global scripts. We should find a way to avoid that. The scripts should be parsed only after they change and use some cache whenever the editor needs something script-related.\n\n### Steps to reproduce\n\n1. Add a script with class name\n2. Introduce some parsing error, e.g. a random word wherever\n3. In another script, try autocompleting something\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/core/config/project_settings.cpp b/core/config/project_settings.cpp\nindex fdcd4f9b6064..a12b89683118 100644\n--- a/core/config/project_settings.cpp\n+++ b/core/config/project_settings.cpp\n@@ -1263,10 +1263,10 @@ void ProjectSettings::refresh_global_class_list() {\n \tArray script_classes = get_global_class_list();\n \tfor (int i = 0; i < script_classes.size(); i++) {\n \t\tDictionary c = script_classes[i];\n-\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\tcontinue;\n \t\t}\n-\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t}\n }\n \ndiff --git a/core/object/script_language.cpp b/core/object/script_language.cpp\nindex 4ef53dba1dff..33bf7ab48a0f 100644\n--- a/core/object/script_language.cpp\n+++ b/core/object/script_language.cpp\n@@ -269,10 +269,10 @@ void ScriptServer::init_languages() {\n \n \t\t\tfor (const Variant &script_class : script_classes) {\n \t\t\t\tDictionary c = script_class;\n-\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n-\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t\t}\n \t\t\tProjectSettings::get_singleton()->clear(\"_global_script_classes\");\n \t\t}\n@@ -281,10 +281,10 @@ void ScriptServer::init_languages() {\n \t\tArray script_classes = ProjectSettings::get_singleton()->get_global_class_list();\n \t\tfor (const Variant &script_class : script_classes) {\n \t\t\tDictionary c = script_class;\n-\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\tcontinue;\n \t\t\t}\n-\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t}\n \t}\n \n@@ -390,7 +390,7 @@ void ScriptServer::global_classes_clear() {\n \tinheriters_cache.clear();\n }\n \n-void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path) {\n+void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool) {\n \tERR_FAIL_COND_MSG(p_class == p_base || (global_classes.has(p_base) && get_global_class_native_base(p_base) == p_class), \"Cyclic inheritance in script class.\");\n \tGlobalScriptClass *existing = global_classes.getptr(p_class);\n \tif (existing) {\n@@ -399,6 +399,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\t\texisting->base = p_base;\n \t\t\texisting->path = p_path;\n \t\t\texisting->language = p_language;\n+\t\t\texisting->is_abstract = p_is_abstract;\n+\t\t\texisting->is_tool = p_is_tool;\n \t\t\tinheriters_cache_dirty = true;\n \t\t}\n \t} else {\n@@ -407,6 +409,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\tg.language = p_language;\n \t\tg.path = p_path;\n \t\tg.base = p_base;\n+\t\tg.is_abstract = p_is_abstract;\n+\t\tg.is_tool = p_is_tool;\n \t\tglobal_classes[p_class] = g;\n \t\tinheriters_cache_dirty = true;\n \t}\n@@ -480,6 +484,16 @@ StringName ScriptServer::get_global_class_native_base(const String &p_class) {\n \treturn base;\n }\n \n+bool ScriptServer::is_global_class_abstract(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_abstract;\n+}\n+\n+bool ScriptServer::is_global_class_tool(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_tool;\n+}\n+\n void ScriptServer::get_global_class_list(List<StringName> *r_global_classes) {\n \tList<StringName> classes;\n \tfor (const KeyValue<StringName, GlobalScriptClass> &E : global_classes) {\n@@ -507,12 +521,15 @@ void ScriptServer::save_global_classes() {\n \tget_global_class_list(&gc);\n \tArray gcarr;\n \tfor (const StringName &E : gc) {\n+\t\tconst GlobalScriptClass &global_class = global_classes[E];\n \t\tDictionary d;\n \t\td[\"class\"] = E;\n-\t\td[\"language\"] = global_classes[E].language;\n-\t\td[\"path\"] = global_classes[E].path;\n-\t\td[\"base\"] = global_classes[E].base;\n+\t\td[\"language\"] = global_class.language;\n+\t\td[\"path\"] = global_class.path;\n+\t\td[\"base\"] = global_class.base;\n \t\td[\"icon\"] = class_icons.get(E, \"\");\n+\t\td[\"is_abstract\"] = global_class.is_abstract;\n+\t\td[\"is_tool\"] = global_class.is_tool;\n \t\tgcarr.push_back(d);\n \t}\n \tProjectSettings::get_singleton()->store_global_class_list(gcarr);\ndiff --git a/core/object/script_language.h b/core/object/script_language.h\nindex 6ceeb4287512..8158d633ae14 100644\n--- a/core/object/script_language.h\n+++ b/core/object/script_language.h\n@@ -62,6 +62,8 @@ class ScriptServer {\n \t\tStringName language;\n \t\tString path;\n \t\tStringName base;\n+\t\tbool is_abstract = false;\n+\t\tbool is_tool = false;\n \t};\n \n \tstatic HashMap<StringName, GlobalScriptClass> global_classes;\n@@ -86,7 +88,7 @@ class ScriptServer {\n \tstatic void thread_exit();\n \n \tstatic void global_classes_clear();\n-\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path);\n+\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool);\n \tstatic void remove_global_class(const StringName &p_class);\n \tstatic void remove_global_class_by_path(const String &p_path);\n \tstatic bool is_global_class(const StringName &p_class);\n@@ -94,6 +96,8 @@ class ScriptServer {\n \tstatic String get_global_class_path(const String &p_class);\n \tstatic StringName get_global_class_base(const String &p_class);\n \tstatic StringName get_global_class_native_base(const String &p_class);\n+\tstatic bool is_global_class_abstract(const String &p_class);\n+\tstatic bool is_global_class_tool(const String &p_class);\n \tstatic void get_global_class_list(List<StringName> *r_global_classes);\n \tstatic void get_inheriters_list(const StringName &p_base_type, List<StringName> *r_classes);\n \tstatic void save_global_classes();\n@@ -443,7 +447,7 @@ class ScriptLanguage : public Object {\n \tvirtual void frame();\n \n \tvirtual bool handles_global_class_type(const String &p_type) const { return false; }\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const { return String(); }\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const { return String(); }\n \n \tvirtual ~ScriptLanguage() {}\n };\ndiff --git a/core/object/script_language_extension.h b/core/object/script_language_extension.h\nindex 09c395e71e8d..715ec43fb35a 100644\n--- a/core/object/script_language_extension.h\n+++ b/core/object/script_language_extension.h\n@@ -672,7 +672,7 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \n \tGDVIRTUAL1RC_REQUIRED(Dictionary, _get_global_class_name, const String &)\n \n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override {\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override {\n \t\tDictionary ret;\n \t\tGDVIRTUAL_CALL(_get_global_class_name, p_path, ret);\n \t\tif (!ret.has(\"name\")) {\n@@ -684,6 +684,12 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \t\tif (r_icon_path != nullptr && ret.has(\"icon_path\")) {\n \t\t\t*r_icon_path = ret[\"icon_path\"];\n \t\t}\n+\t\tif (r_is_abstract != nullptr && ret.has(\"is_abstract\")) {\n+\t\t\t*r_is_abstract = ret[\"is_abstract\"];\n+\t\t}\n+\t\tif (r_is_tool != nullptr && ret.has(\"is_tool\")) {\n+\t\t\t*r_is_tool = ret[\"is_tool\"];\n+\t\t}\n \t\treturn ret[\"name\"];\n \t}\n };\ndiff --git a/editor/connections_dialog.cpp b/editor/connections_dialog.cpp\nindex 429467d3403c..dca43411e10b 100644\n--- a/editor/connections_dialog.cpp\n+++ b/editor/connections_dialog.cpp\n@@ -1446,7 +1446,7 @@ void ConnectionsDock::update_tree() {\n \t\t\t\tdoc_class_name = String();\n \t\t\t}\n \n-\t\t\tclass_icon = editor_data.get_script_icon(script_base);\n+\t\t\tclass_icon = editor_data.get_script_icon(script_base->get_path());\n \t\t\tif (class_icon.is_null() && has_theme_icon(native_base, EditorStringName(EditorIcons))) {\n \t\t\t\tclass_icon = get_editor_theme_icon(native_base);\n \t\t\t}\ndiff --git a/editor/create_dialog.cpp b/editor/create_dialog.cpp\nindex 7f1670bcb648..5eebb1c492e5 100644\n--- a/editor/create_dialog.cpp\n+++ b/editor/create_dialog.cpp\n@@ -257,14 +257,9 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\tinherits = ClassDB::get_parent_class(p_type);\n \t\tinherited_type = TypeCategory::CPP_TYPE;\n \t} else {\n-\t\tif (p_type_category == TypeCategory::PATH_TYPE || ScriptServer::is_global_class(p_type)) {\n-\t\t\tRef<Script> scr;\n-\t\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n-\t\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n-\t\t\t\tscr = ResourceLoader::load(p_type, \"Script\");\n-\t\t\t} else {\n-\t\t\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_type);\n-\t\t\t}\n+\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n+\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n+\t\t\tRef<Script> scr = ResourceLoader::load(p_type, \"Script\");\n \t\t\tERR_FAIL_COND(scr.is_null());\n \n \t\t\tRef<Script> base = scr->get_base_script();\n@@ -286,6 +281,10 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\t\t\t\tinherited_type = TypeCategory::PATH_TYPE;\n \t\t\t\t}\n \t\t\t}\n+\t\t} else if (ScriptServer::is_global_class(p_type)) {\n+\t\t\tinherits = ScriptServer::get_global_class_base(p_type);\n+\t\t\tbool is_native_class = ClassDB::class_exists(inherits);\n+\t\t\tinherited_type = is_native_class ? TypeCategory::CPP_TYPE : TypeCategory::OTHER_TYPE;\n \t\t} else {\n \t\t\tinherits = custom_type_parents[p_type];\n \t\t\tif (ClassDB::class_exists(inherits)) {\n@@ -315,18 +314,14 @@ void CreateDialog::_configure_search_option_item(TreeItem *r_item, const StringN\n \t\tr_item->set_metadata(0, p_type);\n \t\tr_item->set_text(0, p_type);\n \n-\t\tString script_path = ScriptServer::get_global_class_path(p_type);\n-\t\tRef<Script> scr = ResourceLoader::load(script_path, \"Script\");\n-\n-\t\tERR_FAIL_COND(scr.is_null());\n-\t\tis_abstract = scr->is_abstract();\n+\t\tis_abstract = ScriptServer::is_global_class_abstract(p_type);\n \n \t\tString tooltip = TTR(\"Script path: %s\");\n-\t\tbool is_tool = scr->is_tool();\n+\t\tbool is_tool = ScriptServer::is_global_class_tool(p_type);\n \t\tif (is_tool) {\n \t\t\ttooltip = TTR(\"The script will run in the editor.\") + \"\\n\" + tooltip;\n \t\t}\n-\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, script_path));\n+\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, ScriptServer::get_global_class_path(p_type)));\n \t\tif (is_tool) {\n \t\t\tint button_index = r_item->get_button_count(0) - 1;\n \t\t\tr_item->set_button_color(0, button_index, get_theme_color(SNAME(\"accent_color\"), EditorStringName(Editor)));\ndiff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex 73af9f39a6f5..f31e6aba4169 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -983,20 +983,6 @@ bool EditorData::script_class_is_parent(const String &p_class, const String &p_i\n \treturn true;\n }\n \n-StringName EditorData::script_class_get_base(const String &p_class) const {\n-\tRef<Script> script = script_class_load_script(p_class);\n-\tif (script.is_null()) {\n-\t\treturn StringName();\n-\t}\n-\n-\tRef<Script> base_script = script->get_base_script();\n-\tif (base_script.is_null()) {\n-\t\treturn ScriptServer::get_global_class_base(p_class);\n-\t}\n-\n-\treturn script->get_language()->get_global_class_name(base_script->get_path());\n-}\n-\n Variant EditorData::script_class_instance(const String &p_class) {\n \tif (ScriptServer::is_global_class(p_class)) {\n \t\tRef<Script> script = script_class_load_script(p_class);\n@@ -1026,22 +1012,25 @@ void EditorData::script_class_set_icon_path(const String &p_class, const String\n \t_script_class_icon_paths[p_class] = p_icon_path;\n }\n \n-String EditorData::script_class_get_icon_path(const String &p_class) const {\n-\tif (!ScriptServer::is_global_class(p_class)) {\n-\t\treturn String();\n-\t}\n-\n+String EditorData::script_class_get_icon_path(const String &p_class, bool *r_valid) const {\n \tString current = p_class;\n-\tString ret = _script_class_icon_paths[current];\n-\twhile (ret.is_empty()) {\n-\t\tcurrent = script_class_get_base(current);\n+\twhile (true) {\n \t\tif (!ScriptServer::is_global_class(current)) {\n+\t\t\t// If the classnames chain has a native class ancestor, we're done with success.\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = ClassDB::class_exists(current);\n+\t\t\t}\n \t\t\treturn String();\n \t\t}\n-\t\tret = _script_class_icon_paths.has(current) ? _script_class_icon_paths[current] : String();\n+\t\tHashMap<StringName, String>::ConstIterator E = _script_class_icon_paths.find(current);\n+\t\tif ((bool)E) {\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = true;\n+\t\t\t}\n+\t\t\treturn E->value;\n+\t\t}\n+\t\tcurrent = ScriptServer::get_global_class_base(current);\n \t}\n-\n-\treturn ret;\n }\n \n StringName EditorData::script_class_get_name(const String &p_path) const {\n@@ -1126,28 +1115,42 @@ Ref<Texture2D> EditorData::_load_script_icon(const String &p_path) const {\n \treturn nullptr;\n }\n \n-Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n+Ref<Texture2D> EditorData::get_script_icon(const String &p_script_path) {\n \t// Take from the local cache, if available.\n-\tif (_script_icon_cache.has(p_script)) {\n+\tif (_script_icon_cache.has(p_script_path)) {\n \t\t// Can be an empty value if we can't resolve any icon for this script.\n \t\t// An empty value is still cached to avoid unnecessary attempts at resolving it again.\n-\t\treturn _script_icon_cache[p_script];\n+\t\treturn _script_icon_cache[p_script_path];\n+\t}\n+\n+\t// Fast path in case the whole hierarchy is made of global classes.\n+\tStringName class_name = script_class_get_name(p_script_path);\n+\t{\n+\t\tif (class_name != StringName()) {\n+\t\t\tbool icon_valid = false;\n+\t\t\tString icon_path = script_class_get_icon_path(class_name, &icon_valid);\n+\t\t\tif (icon_valid) {\n+\t\t\t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n+\t\t\t\t_script_icon_cache[p_script_path] = icon;\n+\t\t\t\treturn icon;\n+\t\t\t}\n+\t\t}\n \t}\n \n-\tRef<Script> base_scr = p_script;\n+\tRef<Script> base_scr = ResourceLoader::load(p_script_path, \"Script\");\n \twhile (base_scr.is_valid()) {\n \t\t// Check for scripted classes.\n \t\tString icon_path;\n-\t\tStringName class_name = script_class_get_name(base_scr->get_path());\n-\t\tif (base_scr->is_built_in() || class_name == StringName()) {\n+\t\tStringName base_class_name = script_class_get_name(base_scr->get_path());\n+\t\tif (base_scr->is_built_in() || base_class_name == StringName()) {\n \t\t\ticon_path = base_scr->get_class_icon_path();\n \t\t} else {\n-\t\t\ticon_path = script_class_get_icon_path(class_name);\n+\t\t\ticon_path = script_class_get_icon_path(base_class_name);\n \t\t}\n \n \t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n \t\tif (icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = icon;\n+\t\t\t_script_icon_cache[p_script_path] = icon;\n \t\t\treturn icon;\n \t\t}\n \n@@ -1155,7 +1158,7 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\t// TODO: Should probably be deprecated in 4.x\n \t\tconst EditorData::CustomType *ctype = get_custom_type_by_path(base_scr->get_path());\n \t\tif (ctype && ctype->icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = ctype->icon;\n+\t\t\t_script_icon_cache[p_script_path] = ctype->icon;\n \t\t\treturn ctype->icon;\n \t\t}\n \n@@ -1163,21 +1166,16 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\tbase_scr = base_scr->get_base_script();\n \t}\n \n-\t// No custom icon was found in the inheritance chain, so check the base\n-\t// class of the script instead.\n-\tString base_type;\n-\tp_script->get_language()->get_global_class_name(p_script->get_path(), &base_type);\n-\n \t// Check if the base type is an extension-defined type.\n-\tRef<Texture2D> ext_icon = extension_class_get_icon(base_type);\n+\tRef<Texture2D> ext_icon = extension_class_get_icon(class_name);\n \tif (ext_icon.is_valid()) {\n-\t\t_script_icon_cache[p_script] = ext_icon;\n+\t\t_script_icon_cache[p_script_path] = ext_icon;\n \t\treturn ext_icon;\n \t}\n \n \t// If no icon found, cache it as null.\n-\t_script_icon_cache[p_script] = Ref<Texture>();\n-\treturn nullptr;\n+\t_script_icon_cache[p_script_path] = Ref<Texture2D>();\n+\treturn Ref<Texture2D>();\n }\n \n void EditorData::clear_script_icon_cache() {\ndiff --git a/editor/editor_data.h b/editor/editor_data.h\nindex 5b49304c73f2..943c661b6b2e 100644\n--- a/editor/editor_data.h\n+++ b/editor/editor_data.h\n@@ -147,7 +147,7 @@ class EditorData {\n \n \tHashMap<StringName, String> _script_class_icon_paths;\n \tHashMap<String, StringName> _script_class_file_to_path;\n-\tHashMap<Ref<Script>, Ref<Texture>> _script_icon_cache;\n+\tHashMap<String, Ref<Texture>> _script_icon_cache;\n \n \tRef<Texture2D> _load_script_icon(const String &p_path) const;\n \n@@ -241,7 +241,6 @@ class EditorData {\n \tvoid notify_scene_saved(const String &p_path);\n \n \tbool script_class_is_parent(const String &p_class, const String &p_inherits);\n-\tStringName script_class_get_base(const String &p_class) const;\n \tVariant script_class_instance(const String &p_class);\n \n \tRef<Script> script_class_load_script(const String &p_class) const;\n@@ -249,7 +248,7 @@ class EditorData {\n \tStringName script_class_get_name(const String &p_path) const;\n \tvoid script_class_set_name(const String &p_path, const StringName &p_class);\n \n-\tString script_class_get_icon_path(const String &p_class) const;\n+\tString script_class_get_icon_path(const String &p_class, bool *r_valid = nullptr) const;\n \tvoid script_class_set_icon_path(const String &p_class, const String &p_icon_path);\n \tvoid script_class_clear_icon_paths() { _script_class_icon_paths.clear(); }\n \tvoid script_class_save_icon_paths();\n@@ -257,7 +256,7 @@ class EditorData {\n \n \tRef<Texture2D> extension_class_get_icon(const String &p_class) const;\n \n-\tRef<Texture2D> get_script_icon(const Ref<Script> &p_script);\n+\tRef<Texture2D> get_script_icon(const String &p_script_path);\n \tvoid clear_script_icon_cache();\n \n \tEditorData();\ndiff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex b8ce3ff65bf7..1db6c2a188e4 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -49,7 +49,7 @@\n \n EditorFileSystem *EditorFileSystem::singleton = nullptr;\n //the name is the version, to keep compatibility with different versions of Godot\n-#define CACHE_FILE_NAME \"filesystem_cache8\"\n+#define CACHE_FILE_NAME \"filesystem_cache10\"\n \n int EditorFileSystemDirectory::find_file_index(const String &p_file) const {\n \tfor (int i = 0; i < files.size(); i++) {\n@@ -166,19 +166,19 @@ uint64_t EditorFileSystemDirectory::get_file_import_modified_time(int p_idx) con\n }\n \n String EditorFileSystemDirectory::get_file_script_class_name(int p_idx) const {\n-\treturn files[p_idx]->script_class_name;\n+\treturn files[p_idx]->class_info.name;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_extends(int p_idx) const {\n-\treturn files[p_idx]->script_class_extends;\n+\treturn files[p_idx]->class_info.extends;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_icon_path(int p_idx) const {\n-\treturn files[p_idx]->script_class_icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n String EditorFileSystemDirectory::get_file_icon_path(int p_idx) const {\n-\treturn files[p_idx]->icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n StringName EditorFileSystemDirectory::get_file_type(int p_idx) const {\n@@ -303,13 +303,13 @@ void EditorFileSystem::_first_scan_process_scripts(const ScannedDirectory *p_sca\n \t\t\tconst String type = ResourceLoader::get_resource_type(path);\n \n \t\t\tif (ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n-\t\t\t\tString script_class_extends;\n-\t\t\t\tString script_class_icon_path;\n-\t\t\t\tString script_class_name = _get_global_script_class(type, path, &script_class_extends, &script_class_icon_path);\n-\t\t\t\t_register_global_class_script(path, path, type, script_class_name, script_class_extends, script_class_icon_path);\n+\t\t\t\tconst ScriptClassInfo &info = _get_global_script_class(type, path);\n+\t\t\t\tScriptClassInfoUpdate update(info);\n+\t\t\t\tupdate.type = type;\n+\t\t\t\t_register_global_class_script(path, path, update);\n \n-\t\t\t\tif (!script_class_name.is_empty()) {\n-\t\t\t\t\tp_existing_class_names.insert(script_class_name);\n+\t\t\t\tif (!info.name.is_empty()) {\n+\t\t\t\t\tp_existing_class_names.insert(info.name);\n \t\t\t\t}\n \t\t\t}\n \t\t}\n@@ -383,33 +383,25 @@ void EditorFileSystem::_scan_filesystem() {\n \t\t\t\t\tname = cpath.path_join(name);\n \n \t\t\t\t\tFileCache fc;\n-\t\t\t\t\tfc.type = split[1];\n-\t\t\t\t\tif (fc.type.contains_char('/')) {\n-\t\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n-\t\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n-\t\t\t\t\t}\n+\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n+\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n \t\t\t\t\tfc.uid = split[2].to_int();\n \t\t\t\t\tfc.modification_time = split[3].to_int();\n \t\t\t\t\tfc.import_modification_time = split[4].to_int();\n \t\t\t\t\tfc.import_valid = split[5].to_int() != 0;\n \t\t\t\t\tfc.import_group_file = split[6].strip_edges();\n-\t\t\t\t\tfc.script_class_name = split[7].get_slice(\"<>\", 0);\n-\t\t\t\t\tfc.script_class_extends = split[7].get_slice(\"<>\", 1);\n-\t\t\t\t\tfc.script_class_icon_path = split[7].get_slice(\"<>\", 2);\n-\t\t\t\t\tfc.import_md5 = split[7].get_slice(\"<>\", 3);\n-\t\t\t\t\tString dest_paths = split[7].get_slice(\"<>\", 4);\n-\t\t\t\t\tif (!dest_paths.is_empty()) {\n-\t\t\t\t\t\tfc.import_dest_paths = dest_paths.split(\"<*>\");\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tString deps = split[8].strip_edges();\n-\t\t\t\t\tif (deps.length()) {\n-\t\t\t\t\t\tVector<String> dp = deps.split(\"<>\");\n-\t\t\t\t\t\tfor (int i = 0; i < dp.size(); i++) {\n-\t\t\t\t\t\t\tconst String &path = dp[i];\n-\t\t\t\t\t\t\tfc.deps.push_back(path);\n-\t\t\t\t\t\t}\n+\t\t\t\t\t{\n+\t\t\t\t\t\tconst Vector<String> &slices = split[7].split(\"<>\");\n+\t\t\t\t\t\tERR_CONTINUE(slices.size() < 7);\n+\t\t\t\t\t\tfc.class_info.name = slices[0];\n+\t\t\t\t\t\tfc.class_info.extends = slices[1];\n+\t\t\t\t\t\tfc.class_info.icon_path = slices[2];\n+\t\t\t\t\t\tfc.class_info.is_abstract = slices[3].to_int();\n+\t\t\t\t\t\tfc.class_info.is_tool = slices[4].to_int();\n+\t\t\t\t\t\tfc.import_md5 = slices[5];\n+\t\t\t\t\t\tfc.import_dest_paths = slices[6].split(\"<*>\");\n \t\t\t\t\t}\n+\t\t\t\t\tfc.deps = split[8].strip_edges().split(\"<>\");\n \n \t\t\t\t\tfile_cache[name] = fc;\n \t\t\t\t}\n@@ -859,7 +851,7 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\t}\n \n \t\t\t\tif (ClassDB::is_parent_class(ia.new_file->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(new_file_path, ia.new_file->type, ia.new_file->script_class_name, ia.new_file->script_class_extends, ia.new_file->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(new_file_path, ScriptClassInfoUpdate::from_file_info(ia.new_file));\n \t\t\t\t}\n \t\t\t\tif (ia.new_file->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(new_file_path);\n@@ -870,9 +862,9 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString script_class_name = ia.dir->files[idx]->script_class_name;\n+\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), \"\", \"\", \"\", \"\");\n+\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n@@ -883,11 +875,11 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tia.dir->files.remove_at(idx);\n \n \t\t\t\t// Restore another script with the same global class name if it exists.\n-\t\t\t\tif (!script_class_name.is_empty()) {\n+\t\t\t\tif (!class_name.is_empty()) {\n \t\t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n-\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, script_class_name, old_fi);\n+\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, class_name, old_fi);\n \t\t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \n@@ -1161,10 +1153,8 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = fc->import_md5;\n \t\t\t\tfi->import_dest_paths = fc->import_dest_paths;\n \t\t\t\tfi->import_valid = fc->import_valid;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n \t\t\t\tfi->import_group_file = fc->import_group_file;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\t// Ensures backward compatibility when the project is loaded for the first time with the added import_md5\n \t\t\t\t// and import_dest_paths properties in the file cache.\n@@ -1202,7 +1192,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t} else {\n \t\t\t\t// Using get_resource_import_info() to prevent calling 3 times ResourceFormatImporter::_get_path_and_type.\n \t\t\t\tResourceFormatImporter::get_singleton()->get_resource_import_info(path, fi->type, fi->uid, fi->import_group_file);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->modified_time = 0;\n \t\t\t\tfi->import_modified_time = 0;\n \t\t\t\tfi->import_md5 = \"\";\n@@ -1227,22 +1217,20 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = \"\";\n \t\t\t\tfi->import_dest_paths = Vector<String>();\n \t\t\t\tfi->import_valid = true;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\tif (first_scan && ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n \t\t\t\t\tbool update_script = false;\n-\t\t\t\t\tString old_class_name = fi->script_class_name;\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n-\t\t\t\t\tif (old_class_name != fi->script_class_name) {\n+\t\t\t\t\tString old_class_name = fi->class_info.name;\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n+\t\t\t\t\tif (old_class_name != fi->class_info.name) {\n \t\t\t\t\t\tupdate_script = true;\n-\t\t\t\t\t} else if (!fi->script_class_name.is_empty() && (!ScriptServer::is_global_class(fi->script_class_name) || ScriptServer::get_global_class_path(fi->script_class_name) != path)) {\n+\t\t\t\t\t} else if (!fi->class_info.name.is_empty() && (!ScriptServer::is_global_class(fi->class_info.name) || ScriptServer::get_global_class_path(fi->class_info.name) != path)) {\n \t\t\t\t\t\t// This script has a class name but is not in the global class names or the path of the class has changed.\n \t\t\t\t\t\tupdate_script = true;\n \t\t\t\t\t}\n \t\t\t\t\tif (update_script) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t} else {\n@@ -1256,7 +1244,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t}\n \t\t\t\tfi->uid = ResourceLoader::get_resource_uid(path);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->deps = _get_dependencies(path);\n \t\t\t\tfi->modified_time = mt;\n \t\t\t\tfi->import_modified_time = 0;\n@@ -1267,7 +1255,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t// Files in dep_update_list are forced for rescan to update dependencies. They don't need other updates.\n \t\t\t\tif (!dep_update_list.has(path)) {\n \t\t\t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t\t_queue_update_scene_groups(path);\n@@ -1428,7 +1416,7 @@ void EditorFileSystem::_scan_fs_changes(EditorFileSystemDirectory *p_dir, ScanPr\n \t\t\t\t\tif (fi->type == \"\" && other_file_extensions.has(ext)) {\n \t\t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t\t}\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\t\tfi->import_valid = (fi->type == \"TextFile\" || fi->type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(path);\n \t\t\t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(path);\n \n@@ -1587,7 +1575,7 @@ void EditorFileSystem::_remove_invalid_global_class_names(const HashSet<String>\n \n String EditorFileSystem::_get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info) {\n \tfor (EditorFileSystemDirectory::FileInfo *fi : p_dir->files) {\n-\t\tif (fi->script_class_name == p_class_name) {\n+\t\tif (fi->class_info.name == p_class_name) {\n \t\t\tr_file_info = fi;\n \t\t\treturn p_dir->get_path().path_join(fi->file);\n \t\t}\n@@ -1768,7 +1756,7 @@ void EditorFileSystem::_save_filesystem_cache(EditorFileSystemDirectory *p_dir,\n \t\tcache_string.append(itos(file_info->import_modified_time));\n \t\tcache_string.append(itos(file_info->import_valid));\n \t\tcache_string.append(file_info->import_group_file);\n-\t\tcache_string.append(String(\"<>\").join({ file_info->script_class_name, file_info->script_class_extends, file_info->script_class_icon_path, file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n+\t\tcache_string.append(String(\"<>\").join({ file_info->class_info.name, file_info->class_info.extends, file_info->class_info.icon_path, itos(file_info->class_info.is_abstract), itos(file_info->class_info.is_tool), file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n \t\tcache_string.append(String(\"<>\").join(file_info->deps));\n \n \t\tp_file->store_line(String(\"::\").join(cache_string));\n@@ -1980,29 +1968,21 @@ Vector<String> EditorFileSystem::_get_dependencies(const String &p_path) {\n \treturn ret;\n }\n \n-String EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const {\n+EditorFileSystem::ScriptClassInfo EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path) const {\n+\tScriptClassInfo info;\n \tfor (int i = 0; i < ScriptServer::get_language_count(); i++) {\n \t\tif (ScriptServer::get_language(i)->handles_global_class_type(p_type)) {\n-\t\t\tString global_name;\n-\t\t\tString extends;\n-\t\t\tString icon_path;\n-\n-\t\t\tglobal_name = ScriptServer::get_language(i)->get_global_class_name(p_path, &extends, &icon_path);\n-\t\t\t*r_extends = extends;\n-\t\t\t*r_icon_path = icon_path;\n-\t\t\treturn global_name;\n+\t\t\tinfo.name = ScriptServer::get_language(i)->get_global_class_name(p_path, &info.extends, &info.icon_path, &info.is_abstract, &info.is_tool);\n \t\t}\n \t}\n-\t*r_extends = String();\n-\t*r_icon_path = String();\n-\treturn String();\n+\treturn info;\n }\n \n void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInfo *file_info) {\n \tString icon_path;\n \tif (file_info->resource_script_class != StringName()) {\n \t\ticon_path = EditorNode::get_editor_data().script_class_get_icon_path(file_info->resource_script_class);\n-\t} else if (file_info->script_class_icon_path.is_empty() && !file_info->deps.is_empty()) {\n+\t} else if (file_info->class_info.icon_path.is_empty() && !file_info->deps.is_empty()) {\n \t\tconst String &script_dep = file_info->deps[0]; // Assuming the first dependency is a script.\n \t\tconst String &script_path = script_dep.contains(\"::\") ? script_dep.get_slice(\"::\", 2) : script_dep;\n \t\tif (!script_path.is_empty()) {\n@@ -2014,7 +1994,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t\t\t\tint script_file;\n \t\t\t\t\tEditorFileSystemDirectory *efsd = find_file(script_path, &script_file);\n \t\t\t\t\tif (efsd) {\n-\t\t\t\t\t\ticon_path = efsd->files[script_file]->script_class_icon_path;\n+\t\t\t\t\t\ticon_path = efsd->files[script_file]->class_info.icon_path;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tfile_icon_cache.insert(script_path, icon_path);\n@@ -2029,7 +2009,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t}\n \t}\n \n-\tfile_info->icon_path = icon_path;\n+\tfile_info->class_info.icon_path = icon_path;\n }\n \n void EditorFileSystem::_update_files_icon_path(EditorFileSystemDirectory *edp) {\n@@ -2068,10 +2048,10 @@ void EditorFileSystem::_update_script_classes() {\n \t\t}\n \n \t\tint step_count = 0;\n-\t\tfor (const KeyValue<String, ScriptInfo> &E : update_script_paths) {\n-\t\t\t_register_global_class_script(E.key, E.key, E.value.type, E.value.script_class_name, E.value.script_class_extends, E.value.script_class_icon_path);\n+\t\tfor (const KeyValue<String, ScriptClassInfoUpdate> &E : update_script_paths) {\n+\t\t\t_register_global_class_script(E.key, E.key, E.value);\n \t\t\tif (ep) {\n-\t\t\t\tep->step(E.value.script_class_name, step_count++, false);\n+\t\t\t\tep->step(E.value.name, step_count++, false);\n \t\t\t}\n \t\t}\n \n@@ -2181,16 +2161,10 @@ void EditorFileSystem::_process_update_pending() {\n \t_update_pending_scene_groups();\n }\n \n-void EditorFileSystem::_queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update) {\n \tMutexLock update_script_lock(update_script_mutex);\n \n-\tScriptInfo si;\n-\tsi.type = p_type;\n-\tsi.script_class_name = p_script_class_name;\n-\tsi.script_class_extends = p_script_class_extends;\n-\tsi.script_class_icon_path = p_script_class_icon_path;\n-\tupdate_script_paths.insert(p_path, si);\n-\n+\tupdate_script_paths.insert(p_path, p_script_update);\n \tupdate_script_paths_documentation.insert(p_path);\n }\n \n@@ -2291,8 +2265,10 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (ClassDB::is_parent_class(fs->files[cpos]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(file, fs->files[cpos]->type, \"\", \"\", \"\");\n-\t\t\t\t\tif (!fs->files[cpos]->script_class_icon_path.is_empty()) {\n+\t\t\t\t\tScriptClassInfoUpdate update;\n+\t\t\t\t\tupdate.type = fs->files[cpos]->type;\n+\t\t\t\t\t_queue_update_script_class(file, update);\n+\t\t\t\t\tif (!fs->files[cpos]->class_info.icon_path.is_empty()) {\n \t\t\t\t\t\tupdate_files_icon_cache = true;\n \t\t\t\t\t}\n \t\t\t\t}\n@@ -2349,16 +2325,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t}\n \n \t\t\tEditorFileSystemDirectory::FileInfo *fi = fs->files[cpos];\n-\t\t\tconst String old_script_class_icon_path = fi->script_class_icon_path;\n-\t\t\tconst String old_class_name = fi->script_class_name;\n+\t\t\tconst String old_script_class_icon_path = fi->class_info.icon_path;\n+\t\t\tconst String old_class_name = fi->class_info.name;\n \t\t\tfi->type = type;\n \t\t\tfi->resource_script_class = script_class;\n \t\t\tfi->uid = uid;\n-\t\t\tfi->script_class_name = _get_global_script_class(type, file, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\tfi->class_info = _get_global_script_class(type, file);\n \t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(file);\n \t\t\tfi->modified_time = FileAccess::get_modified_time(file);\n \t\t\tfi->deps = _get_dependencies(file);\n-\t\t\tfi->import_valid = type == \"TextFile\" || type == \"OtherFile\" || ResourceLoader::is_import_valid(file);\n+\t\t\tfi->import_valid = (type == \"TextFile\" || type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(file);\n \n \t\t\tif (uid != ResourceUID::INVALID_ID) {\n \t\t\t\tif (ResourceUID::get_singleton()->has_id(uid)) {\n@@ -2384,7 +2360,7 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\tEditorResourcePreview::get_singleton()->check_for_invalidation(file);\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t_queue_update_script_class(file, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t_queue_update_script_class(file, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t}\n \t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t_queue_update_scene_groups(file);\n@@ -2392,16 +2368,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Resource\"))) {\n \t\t\t\tfiles_to_update_icon_path.push_back(fi);\n-\t\t\t} else if (old_script_class_icon_path != fi->script_class_icon_path) {\n+\t\t\t} else if (old_script_class_icon_path != fi->class_info.icon_path) {\n \t\t\t\tupdate_files_icon_cache = true;\n \t\t\t}\n \n \t\t\t// Restore another script as the global class name if multiple scripts had the same old class name.\n-\t\t\tif (!old_class_name.is_empty() && fi->script_class_name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n+\t\t\tif (!old_class_name.is_empty() && fi->class_info.name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n \t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n \t\t\t\tString old_file = _get_file_by_class_name(filesystem, old_class_name, old_fi);\n \t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t}\n \t\t\t}\n \t\t\tupdated = true;\n@@ -2435,16 +2411,16 @@ HashSet<String> EditorFileSystem::get_valid_extensions() const {\n \treturn valid_extensions;\n }\n \n-void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update) {\n \tScriptServer::remove_global_class_by_path(p_search_path); // First remove, just in case it changed\n \n-\tif (p_script_class_name.is_empty()) {\n+\tif (p_script_update.name.is_empty()) {\n \t\treturn;\n \t}\n \n \tString lang;\n \tfor (int j = 0; j < ScriptServer::get_language_count(); j++) {\n-\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_type)) {\n+\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_script_update.type)) {\n \t\t\tlang = ScriptServer::get_language(j)->get_name();\n \t\t\tbreak;\n \t\t}\n@@ -2453,9 +2429,9 @@ void EditorFileSystem::_register_global_class_script(const String &p_search_path\n \t\treturn; // No lang found that can handle this global class\n \t}\n \n-\tScriptServer::add_global_class(p_script_class_name, p_script_class_extends, lang, p_target_path);\n-\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_class_name, p_script_class_icon_path);\n-\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_class_name);\n+\tScriptServer::add_global_class(p_script_update.name, p_script_update.extends, lang, p_target_path, p_script_update.is_abstract, p_script_update.is_tool);\n+\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_update.name, p_script_update.icon_path);\n+\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_update.name);\n }\n \n void EditorFileSystem::register_global_class_script(const String &p_search_path, const String &p_target_path) {\n@@ -2463,7 +2439,7 @@ void EditorFileSystem::register_global_class_script(const String &p_search_path,\n \tEditorFileSystemDirectory *efsd = find_file(p_search_path, &index_file);\n \tif (efsd) {\n \t\tconst EditorFileSystemDirectory::FileInfo *fi = efsd->files[index_file];\n-\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, ScriptClassInfoUpdate::from_file_info(fi));\n \t} else {\n \t\tScriptServer::remove_global_class_by_path(p_search_path);\n \t}\ndiff --git a/editor/editor_file_system.h b/editor/editor_file_system.h\nindex 61041209a7fd..5b78b86a3f3f 100644\n--- a/editor/editor_file_system.h\n+++ b/editor/editor_file_system.h\n@@ -66,11 +66,15 @@ class EditorFileSystemDirectory : public Object {\n \t\tString import_group_file;\n \t\tVector<String> deps;\n \t\tbool verified = false; //used for checking changes\n-\t\t// These are for script resources only.\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n-\t\tString icon_path;\n+\t\t// This is for script resources only.\n+\t\tstruct ScriptClassInfo {\n+\t\t\tString name;\n+\t\t\tString extends;\n+\t\t\tString icon_path;\n+\t\t\tbool is_abstract = false;\n+\t\t\tbool is_tool = false;\n+\t\t};\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tVector<FileInfo *> files;\n@@ -203,9 +207,11 @@ class EditorFileSystem : public Node {\n \n \tstatic EditorFileSystem *singleton;\n \n+\tusing ScriptClassInfo = EditorFileSystemDirectory::FileInfo::ScriptClassInfo;\n+\n \t/* Used for reading the filesystem cache file */\n \tstruct FileCache {\n-\t\tString type;\n+\t\tStringName type;\n \t\tString resource_script_class;\n \t\tResourceUID::ID uid = ResourceUID::INVALID_ID;\n \t\tuint64_t modification_time = 0;\n@@ -215,9 +221,7 @@ class EditorFileSystem : public Node {\n \t\tVector<String> deps;\n \t\tbool import_valid = false;\n \t\tString import_group_file;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tHashMap<String, FileCache> file_cache;\n@@ -288,17 +292,27 @@ class EditorFileSystem : public Node {\n \t\t}\n \t};\n \n-\tstruct ScriptInfo {\n-\t\tString type;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\tstruct ScriptClassInfoUpdate : public ScriptClassInfo {\n+\t\tStringName type;\n+\t\tScriptClassInfoUpdate() = default;\n+\t\texplicit ScriptClassInfoUpdate(const ScriptClassInfo &p_info) :\n+\t\t\t\tScriptClassInfo(p_info) {}\n+\t\tstatic ScriptClassInfoUpdate from_file_info(const EditorFileSystemDirectory::FileInfo *p_fi) {\n+\t\t\tScriptClassInfoUpdate update;\n+\t\t\tupdate.type = p_fi->type;\n+\t\t\tupdate.name = p_fi->class_info.name;\n+\t\t\tupdate.extends = p_fi->class_info.extends;\n+\t\t\tupdate.icon_path = p_fi->class_info.icon_path;\n+\t\t\tupdate.is_abstract = p_fi->class_info.is_abstract;\n+\t\t\tupdate.is_tool = p_fi->class_info.is_tool;\n+\t\t\treturn update;\n+\t\t}\n \t};\n \n \tMutex update_script_mutex;\n-\tHashMap<String, ScriptInfo> update_script_paths;\n+\tHashMap<String, ScriptClassInfoUpdate> update_script_paths;\n \tHashSet<String> update_script_paths_documentation;\n-\tvoid _queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update);\n \tvoid _update_script_classes();\n \tvoid _update_script_documentation();\n \tvoid _process_update_pending();\n@@ -312,7 +326,7 @@ class EditorFileSystem : public Node {\n \tvoid _update_pending_scene_groups();\n \tvoid _get_all_scenes(EditorFileSystemDirectory *p_dir, HashSet<String> &r_list);\n \n-\tString _get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const;\n+\tScriptClassInfo _get_global_script_class(const String &p_type, const String &p_path) const;\n \n \tstatic Error _resource_import(const String &p_path);\n \tstatic Ref<Resource> _load_resource_on_startup(ResourceFormatImporter *p_importer, const String &p_path, Error *r_error, bool p_use_sub_threads, float *r_progress, ResourceFormatLoader::CacheMode p_cache_mode);\n@@ -359,7 +373,7 @@ class EditorFileSystem : public Node {\n \tvoid _remove_invalid_global_class_names(const HashSet<String> &p_existing_class_names);\n \tString _get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info);\n \n-\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update);\n \n protected:\n \tvoid _notification(int p_what);\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 4b7abdf2b072..3ada85d3de91 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -4805,13 +4805,13 @@ void EditorNode::_pick_main_scene_custom_action(const String &p_custom_action_na\n \t}\n }\n \n-Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback, bool p_fallback_script_to_theme) {\n+Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback, bool p_fallback_script_to_theme) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \tEditorData &ed = EditorNode::get_editor_data();\n \n \t// Check for a script icon first.\n-\tif (p_script.is_valid()) {\n-\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script);\n+\tif (!p_script_path.is_empty()) {\n+\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script_path);\n \t\tif (script_icon.is_valid()) {\n \t\t\treturn script_icon;\n \t\t}\n@@ -4819,14 +4819,15 @@ Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, cons\n \t\tif (p_fallback_script_to_theme) {\n \t\t\t// Look for the native base type in the editor theme. This is relevant for\n \t\t\t// scripts extending other scripts and for built-in classes.\n-\t\t\tString script_class_name = p_script->get_language()->get_global_class_name(p_script->get_path());\n \t\t\tString base_type;\n-\t\t\tif (script_class_name.is_empty()) {\n-\t\t\t\tbase_type = p_script->get_instance_base_type();\n+\t\t\tif (ScriptServer::is_global_class(p_class)) {\n+\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(p_class);\n \t\t\t} else {\n-\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(script_class_name);\n+\t\t\t\tRef<Script> scr = ResourceLoader::load(p_script_path, \"Script\");\n+\t\t\t\tif (scr.is_valid()) {\n+\t\t\t\t\tbase_type = scr->get_instance_base_type();\n+\t\t\t\t}\n \t\t\t}\n-\n \t\t\tif (theme.is_valid() && theme->has_icon(base_type, EditorStringName(EditorIcons))) {\n \t\t\t\treturn theme->get_icon(base_type, EditorStringName(EditorIcons));\n \t\t\t}\n@@ -4899,21 +4900,21 @@ Ref<Texture2D> EditorNode::get_object_icon(const Object *p_object, const String\n \tif (Object::cast_to<MultiNodeEdit>(p_object)) {\n \t\treturn get_class_icon(Object::cast_to<MultiNodeEdit>(p_object)->get_edited_class_name(), p_fallback);\n \t} else {\n-\t\treturn _get_class_or_script_icon(p_object->get_class(), scr, p_fallback);\n+\t\treturn _get_class_or_script_icon(p_object->get_class(), scr.is_valid() ? scr->get_path() : String(), p_fallback);\n \t}\n }\n \n Ref<Texture2D> EditorNode::get_class_icon(const String &p_class, const String &p_fallback) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \n-\tRef<Script> scr;\n+\tString script_path;\n \tif (ScriptServer::is_global_class(p_class)) {\n-\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_class);\n+\t\tscript_path = ScriptServer::get_global_class_path(p_class);\n \t} else if (ResourceLoader::exists(p_class)) { // If the script is not a class_name we check if the script resource exists.\n-\t\tscr = ResourceLoader::load(p_class);\n+\t\tscript_path = p_class;\n \t}\n \n-\treturn _get_class_or_script_icon(p_class, scr, p_fallback, true);\n+\treturn _get_class_or_script_icon(p_class, script_path, p_fallback, true);\n }\n \n bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringName &p_class) {\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex b77f6553fe96..2410996c948e 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -648,7 +648,7 @@ class EditorNode : public Node {\n \tvoid _feature_profile_changed();\n \tbool _is_class_editor_disabled_by_feature_profile(const StringName &p_class);\n \n-\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n+\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n \n \tvoid _pick_main_scene_custom_action(const String &p_custom_action_name);\n \ndiff --git a/modules/gdscript/gdscript.cpp b/modules/gdscript/gdscript.cpp\nindex db5a3b65ccb0..2383401630c4 100644\n--- a/modules/gdscript/gdscript.cpp\n+++ b/modules/gdscript/gdscript.cpp\n@@ -2831,7 +2831,7 @@ bool GDScriptLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == \"GDScript\";\n }\n \n-String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tError err;\n \tRef<FileAccess> f = FileAccess::open(p_path, FileAccess::READ, &err);\n \tif (err) {\n@@ -2932,6 +2932,12 @@ String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_b\n \tif (r_icon_path) {\n \t\t*r_icon_path = c->simplified_icon_path;\n \t}\n+\tif (r_is_abstract) {\n+\t\t*r_is_abstract = false;\n+\t}\n+\tif (r_is_tool) {\n+\t\t*r_is_tool = parser.is_tool();\n+\t}\n \treturn c->identifier != nullptr ? String(c->identifier->name) : String();\n }\n \ndiff --git a/modules/gdscript/gdscript.h b/modules/gdscript/gdscript.h\nindex ed04482f4811..9e96b8833496 100644\n--- a/modules/gdscript/gdscript.h\n+++ b/modules/gdscript/gdscript.h\n@@ -638,7 +638,7 @@ class GDScriptLanguage : public ScriptLanguage {\n \t/* GLOBAL CLASSES */\n \n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \tvoid add_orphan_subclass(const String &p_qualified_name, const ObjectID &p_subclass);\n \tRef<GDScript> get_orphan_subclass(const String &p_qualified_name);\ndiff --git a/modules/mono/csharp_script.cpp b/modules/mono/csharp_script.cpp\nindex e9a821c65a95..76c3ca3cb3eb 100644\n--- a/modules/mono/csharp_script.cpp\n+++ b/modules/mono/csharp_script.cpp\n@@ -445,9 +445,9 @@ bool CSharpLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == get_type();\n }\n \n-String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tString class_name;\n-\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, &class_name);\n+\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, r_is_abstract, r_is_tool, &class_name);\n \treturn class_name;\n }\n \ndiff --git a/modules/mono/csharp_script.h b/modules/mono/csharp_script.h\nindex 525357a4c413..4dfed135f861 100644\n--- a/modules/mono/csharp_script.h\n+++ b/modules/mono/csharp_script.h\n@@ -530,7 +530,7 @@ class CSharpLanguage : public ScriptLanguage {\n \n \t/* SCRIPT GLOBAL CLASS FUNCTIONS */\n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \t/* DEBUGGER FUNCTIONS */\n \tString debug_get_error() const override;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\nindex c7be0464b6c8..b0ff041fa49a 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n@@ -19,7 +19,7 @@ public unsafe struct ManagedCallbacks\n         public delegate* unmanaged<godot_string_name*, IntPtr, IntPtr> ScriptManagerBridge_CreateManagedForGodotObjectBinding;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_variant**, int, godot_bool> ScriptManagerBridge_CreateManagedForGodotObjectScriptInstance;\n         public delegate* unmanaged<IntPtr, godot_string_name*, void> ScriptManagerBridge_GetScriptNativeName;\n-        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n+        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_bool*, godot_bool*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n         public delegate* unmanaged<IntPtr, IntPtr, void> ScriptManagerBridge_SetGodotObjectPtr;\n         public delegate* unmanaged<IntPtr, godot_string_name*, godot_variant**, int, godot_bool*, void> ScriptManagerBridge_RaiseEventSignal;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_bool> ScriptManagerBridge_ScriptIsOrInherits;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\nindex e53f05f05825..a327b9cd354b 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n@@ -199,7 +199,7 @@ internal static unsafe void GetScriptNativeName(IntPtr scriptPtr, godot_string_n\n         }\n \n         [UnmanagedCallersOnly]\n-        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_string* outClassName)\n+        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_bool* outIsAbstract, godot_bool* outIsTool, godot_string* outClassName)\n         {\n             // This method must always return the outBaseType for every script, even if the script is\n             // not a global class. But if the script is not a global class it must return an empty\n@@ -254,6 +254,16 @@ internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_s\n                 }\n             }\n \n+            if (outIsAbstract != null)\n+            {\n+                *outIsAbstract = scriptType.IsAbstract.ToGodotBool();\n+            }\n+\n+            if (outIsTool != null)\n+            {\n+                *outIsTool = Attribute.IsDefined(scriptType, typeof(ToolAttribute)).ToGodotBool();\n+            }\n+\n             if (!IsGlobalClass(scriptType))\n             {\n                 // Scripts that are not global classes should not have a name.\ndiff --git a/modules/mono/mono_gd/gd_mono_cache.h b/modules/mono/mono_gd/gd_mono_cache.h\nindex 7c24f28b3a2a..f618921cd02b 100644\n--- a/modules/mono/mono_gd/gd_mono_cache.h\n+++ b/modules/mono/mono_gd/gd_mono_cache.h\n@@ -85,7 +85,7 @@ struct ManagedCallbacks {\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectBinding = GCHandleIntPtr(GD_CLR_STDCALL *)(const StringName *, Object *);\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectScriptInstance = bool(GD_CLR_STDCALL *)(const CSharpScript *, Object *, const Variant **, int32_t);\n \tusing FuncScriptManagerBridge_GetScriptNativeName = void(GD_CLR_STDCALL *)(const CSharpScript *, StringName *);\n-\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, String *);\n+\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, bool *, bool *, String *);\n \tusing FuncScriptManagerBridge_SetGodotObjectPtr = void(GD_CLR_STDCALL *)(GCHandleIntPtr, Object *);\n \tusing FuncScriptManagerBridge_RaiseEventSignal = void(GD_CLR_STDCALL *)(GCHandleIntPtr, const StringName *, const Variant **, int32_t, bool *);\n \tusing FuncScriptManagerBridge_ScriptIsOrInherits = bool(GD_CLR_STDCALL *)(const CSharpScript *, const CSharpScript *);\n", "instance_id": "godotengine__godot-101489", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue of excessive error spam when a global script contains an error in the editor. It specifies the context (global scripts with `class_name`), the observed behavior (error spam during editor interactions like autocompletion or node creation), and the desired improvement (avoid unnecessary parsing by using caching). Steps to reproduce are provided, which helps in understanding the issue. However, there are minor ambiguities: the statement lacks explicit mention of expected input/output formats for the solution, and it does not detail specific edge cases or constraints (e.g., performance impact of caching or handling of script dependencies). Additionally, the problem statement does not fully align with the provided code changes, as the changes seem to focus on extending global class properties (like `is_abstract` and `is_tool`) rather than directly addressing caching or error spam reduction. This discrepancy introduces some confusion about the intended solution scope.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple files and modules (e.g., `ScriptServer`, `EditorFileSystem`, `EditorData`, and language-specific implementations like GDScript and C#). This requires a deep understanding of the Godot engine's architecture, particularly how global scripts are managed, parsed, and integrated into the editor. Second, the changes involve multiple technical concepts, including script language extensions, editor data caching, file system interactions, and handling of script metadata (e.g., abstract and tool properties). Third, while the problem statement focuses on error spam, the code changes suggest a broader refactoring of how global class information is stored and accessed, which impacts the system's architecture and requires careful consideration of backward compatibility and performance. Finally, potential edge cases (e.g., handling invalid or cyclic script dependencies, ensuring cache consistency across editor sessions) and error handling modifications add to the complexity. A score of 0.65 reflects the need for a solid grasp of the codebase and the ability to navigate complex interactions, though it does not reach the \"Very Hard\" range as it does not involve advanced domain-specific algorithms or system-level redesigns.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "GPUParticles2D emission mask captures random color instead of pixel color\n### Tested versions\n\n- Reproducible in: v4.2.stable.mono.official [46dc27791]\n\n### System information\n\nGodot v4.2.stable.mono - Windows 10.0.22621 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 31.0.15.4629) - 13th Gen Intel(R) Core(TM) i5-13600KF (20 Threads)\n\n### Issue description\n\nEmission mask for GPUParticles2D captures colors incorrectly, instead of copying colors from place where particles spawned, it uses random color from mask texture\n\n### Steps to reproduce\n\n1. Create `GPUParticles2D` node\r\n2. Set `Amount` to 10000 to make it look more detailed\r\n3. Create `ParticlesProcessMaterial` for it\r\n4. Load emission mask for it, using some color texture and with options `Solid pixels` and `Capture Colors from Pixels` (`centered` doesn't matter)\r\n5. View result\n\n### Minimal reproduction project (MRP)\n\n[Bug.zip](https://github.com/godotengine/godot/files/14071691/Bug.zip)\r\n\n", "patch": "diff --git a/scene/resources/particle_process_material.cpp b/scene/resources/particle_process_material.cpp\nindex dd81b1c4380d..13bc02014b01 100644\n--- a/scene/resources/particle_process_material.cpp\n+++ b/scene/resources/particle_process_material.cpp\n@@ -523,6 +523,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tfloat animation_offset;\\n\";\n \tcode += \"\tfloat lifetime;\\n\";\n \tcode += \"\tvec4 color;\\n\";\n+\tcode += \"\tfloat emission_texture_position;\\n\";\n \tcode += \"};\\n\\n\";\n \n \tcode += \"struct DynamicsParameters {\\n\";\n@@ -579,11 +580,15 @@ void ParticleProcessMaterial::_update_shader() {\n \tif (color_initial_ramp.is_valid()) {\n \t\tcode += \"\tparams.color *= texture(color_initial_ramp, vec2(rand_from_seed(alt_seed)));\\n\";\n \t}\n-\tif (emission_color_texture.is_valid() && (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS)) {\n-\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n-\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n-\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n-\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n+\t\tcode += \"\tparams.emission_texture_position = rand_from_seed(alt_seed);\\n\";\n+\n+\t\tif (emission_color_texture.is_valid()) {\n+\t\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n+\t\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\t\t}\n \t}\n \tcode += \"}\\n\\n\";\n \n@@ -614,7 +619,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t}\n \tcode += \"}\\n\\n\";\n \n-\tcode += \"vec3 calculate_initial_position(inout uint alt_seed) {\\n\";\n+\tcode += \"vec3 calculate_initial_position(inout DisplayParameters params, inout uint alt_seed) {\\n\";\n \tcode += \"\tfloat pi = 3.14159;\\n\";\n \tcode += \"\tvec3 pos = vec3(0.0);\\n\";\n \tcode += \"\t{ // Emission shape.\\n\";\n@@ -639,7 +644,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t\tcode += \"\t\tpos = vec3(rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0) * emission_box_extents;\\n\";\n \t}\n \tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tcode += \"\t\tpos = texelFetch(emission_texture_points, emission_tex_ofs, 0).xyz;\\n\";\n@@ -860,7 +865,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\t\tTRANSFORM[2].xyz = vec3(0.0, 0.0, 1.0);\\n\";\n \tcode += \"\t}\\n\";\n \tcode += \"\tif (RESTART_POSITION) {\\n\";\n-\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(alt_seed);\\n\";\n+\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(params, alt_seed);\\n\";\n \tif (turbulence_enabled) {\n \t\tcode += \"\t\tfloat initial_turbulence_displacement = mix(turbulence_initial_displacement_min, turbulence_initial_displacement_max, rand_from_seed(alt_seed));\\n\";\n \t\tcode += \"\t\tvec3 noise_direction = get_noise_direction(TRANSFORM[3].xyz);\\n\";\n@@ -871,7 +876,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tif (RESTART_VELOCITY) {\\n\";\n \tcode += \"\t\tVELOCITY = get_random_direction_from_spread(alt_seed, spread) * dynamic_params.initial_velocity_multiplier;\\n\";\n \tif (emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tif (particle_flags[PARTICLE_FLAG_DISABLE_Z]) {\n", "instance_id": "godotengine__godot-101162", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the GPUParticles2D emission mask in the Godot engine, where it captures random colors instead of the pixel color from the mask texture at the particle spawn location. It provides specific steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior beyond \"copying colors from the place where particles spawned,\" leaving some room for interpretation about how the color mapping should precisely work. Additionally, edge cases or specific constraints (e.g., texture formats, performance implications) are not mentioned, which could be critical for a complete solution. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`particle_process_material.cpp`) and a specific part of the shader generation logic for particle emission in the Godot engine. The changes involve modifying how random values are used to select points from an emission texture to ensure consistent behavior for position and color sampling, which requires understanding the shader code generation process and the interaction between different parameters (e.g., `alt_seed`, `emission_texture_position`). \n\nSecond, the technical concepts involved include shader programming, texture sampling, random number generation in shaders, and the specific mechanics of Godot's particle system. These are moderately complex, especially for someone unfamiliar with graphics programming or Godot's internals, but they are not overly advanced for an experienced developer in this domain. \n\nThird, the code changes impact a critical visual feature (particle color emission), but they do not appear to affect the broader system architecture or require extensive refactoring. The amount of code changed is small, but the logic requires precision to avoid introducing new bugs, such as inconsistent particle behavior or performance issues due to repeated random calculations.\n\nFinally, while the problem statement does not explicitly mention edge cases, the nature of the fix (ens Ascertainable edge cases include scenarios where the emission texture might have varying dimensions or formats, or where the particle count (`Amount`) is extremely high, potentially affecting performance. The code changes do not explicitly add new error handling, but ensuring the random seed (`alt_seed`) behaves consistently across different shader invocations could be tricky and might require subtle adjustments to avoid synchronization issues.\n\nOverall, this problem requires a moderate level of expertise in graphics programming and a good understanding of Godot's particle system internals, along with careful handling of shader logic. It is not a trivial fix, but it is also not a deeply architectural or highly complex issue, placing it in the medium difficulty range at 0.55.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "4.4-dev6: Signals don't work in exported builds if .godot dir was created by dev6\n### Tested versions\n\n- Reproducible in: v4.4.dev6.official [1f47e4c4e]\n- Not reproducible in: v4.4.dev5.official [9e6098432]\n\n### System information\n\nGodot v4.4.dev6 - Ubuntu 24.04.1 LTS 24.04 on X11 - X11 display driver, Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1060 6GB (nvidia; 535.183.01) - Intel(R) Core(TM) i5-4570 CPU @ 3.20GHz (4 threads)\n\n### Issue description\n\nIn 4.4-dev6, _signals do not work, at all_ in exported builds. The signal handlers are never called. I have tried both built-in signals (such as clicking a button) and custom signals (calling `.emit()`).\n\nHowever, the circumstances are extremely weird. It is not tied to the Godot version you used to export, but rather, _the Godot version that created the `.godot` directory_.\n\nTo elaborate:\n* If you create a new project in 4.4-dev6, then export it, signals are broken.\n* If you create a project in 4.4-dev5, then upgrade to 4.4-dev6, then export, signals work.\n* However, if you delete the `.godot` directory, then re-open with 4.4-dev6, signals are broken.\n* But, if you then re-open the project (with the `.godot` dir created in dev6) in 4.4-dev5, and export, signals are still broken!\n\nSo this bug can manifest in 4.4-dev5 and earlier, but only if the `.godot` dir was created by dev6.\n\nI'm at a loss to explain this behaviour, but I have tested it extensively (on Linux), both on a \"real\" project and in a minimal repro. I have compared the \"good\" and \"bad\" `.godot` directories and can't see much that would distinguish them - the binary `.scn` files are different but you would expect those to regenerate every time you re-save the scene. And shader cache files are different, but you wouldn't expect that to affect something as unrelated as signals.\n\nAnd to be clear, everything works fine in the editor. It's only broken for exported builds.\n\nI have tested both the Linux native and Web exports, and the issue affects both.\n\n### Steps to reproduce\n\n1. Create a new project using 4.4-dev6.\n2. Create a new \"User Interface\" scene.\n3. Attach a script to the scene.\n4. Add a Button to the scene and give it some text.\n5. In the editor, connect the Button's `pressed()` signal up to a new method.\n6. Add the code `print('Button pressed')` to the signal handler. For good measure, also `$Button.text = 'Pressed'`.\n7. Run the project (setting the scene as the main scene) and verify that clicking the button prints \"Button pressed\" to the console and changes the button text.\n8. Project > Export and add a Linux native export, without changing any settings.\n9. Export Project. Ensure that \"Export With Debug\" is ticked.\n10. From the command line, run `New Game Project.x86_64`.\n11. Observe that clicking the button has no effect, neither printing to the console, nor changing the text.\n\nAs mentioned above, there are some very weird interactions if we change Godot versions:\n- Open the project in dev5 - it is still broken.\n- Delete the `.godot` dir and re-open in dev5 - it now works.\n- Open the project in dev6 - it still works.\n- Delete the `.godot` dir and re-open in dev6 - it is now broken again.\n\n### Minimal reproduction project (MRP)\n\n[signal-repro.zip](https://github.com/user-attachments/files/18038555/signal-repro.zip)\n\n", "patch": "diff --git a/core/object/object.h b/core/object/object.h\nindex da8e8d1b86ee..11b94a7fbf0a 100644\n--- a/core/object/object.h\n+++ b/core/object/object.h\n@@ -572,7 +572,7 @@ class Object {\n \t\tCONNECT_PERSIST = 2, // hint for scene to save this connection\n \t\tCONNECT_ONE_SHOT = 4,\n \t\tCONNECT_REFERENCE_COUNTED = 8,\n-\t\tCONNECT_INHERITED = 16, // Whether or not the connection is in an instance of a scene.\n+\t\tCONNECT_INHERITED = 16, // Used in editor builds.\n \t};\n \n \tstruct Connection {\ndiff --git a/scene/resources/packed_scene.cpp b/scene/resources/packed_scene.cpp\nindex 8b1cbdf488a5..d6748ed2e64f 100644\n--- a/scene/resources/packed_scene.cpp\n+++ b/scene/resources/packed_scene.cpp\n@@ -1060,12 +1060,6 @@ Error SceneState::_parse_connections(Node *p_owner, Node *p_node, HashMap<String\n \t\t\t\tcontinue;\n \t\t\t}\n \n-\t\t\t// Don't include signals that are from scene instances\n-\t\t\t// (they are already saved in the scenes themselves).\n-\t\t\tif (c.flags & CONNECT_INHERITED) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n \t\t\t// only connections that originate or end into main saved scene are saved\n \t\t\t// everything else is discarded\n \n", "instance_id": "godotengine__godot-100235", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear and provides a detailed description of the issue, including the specific Godot version affected (4.4-dev6), the nature of the bug (signals not working in exported builds), and the peculiar dependency on the version that created the `.godot` directory. It includes comprehensive steps to reproduce the issue, system information, and even a minimal reproduction project (MRP). The description of the issue's behavior across different versions and conditions is thorough, which aids in understanding the problem's scope. However, there are minor ambiguities that prevent a perfect score: the problem statement does not explicitly discuss potential causes or Ascend (a common issue in bug reports) or provide hints about where in the codebase the issue might lie (e.g., signal handling, export process, or project file management). Additionally, while edge cases are indirectly implied through the version-specific behavior, they are not explicitly outlined as specific test cases beyond the basic reproduction steps. Overall, the statement is clear enough to guide a developer toward diagnosing and fixing the issue, but it lacks some critical technical depth or hypotheses that could further clarify the root cause.\n", "difficulty_explanation": "\nThis problem falls into the \"Hard\" category due to several factors. First, the scope and depth of the issue are significant: the bug affects a core feature (signals) in exported builds, which likely involves understanding the interaction between multiple parts of the Godot engine, such as the scene serialization system (related to the `.godot` directory), signal handling mechanisms, and the export process. The provided code changes, while minimal (modifying a flag's comment and removing a condition in `packed_scene.cpp`), suggest that the fix requires a deep understanding of the engine's internals\u2014specifically, how connections are saved and loaded in packed scenes and the implications of the `CONNECT_INHERITED` flag. The changes impact two files (`object.h` and `packed_scene.cpp`), indicating a need to navigate and modify core components of the codebase, which often have far-reaching architectural implications.\n\nSecond, the number of technical concepts involved is substantial. Solving this requires familiarity with Godot's architecture, particularly scene management, signal systems, and the export pipeline. It also demands knowledge of C++ (the language Godot is written in), including how flags and bitwise operations are used for connection properties. Additionally, debugging version-specific issues tied to project directory metadata (`.godot`) suggests a need for domain-specific knowledge about Godot's project structure and file handling.\n\nThird, potential edge cases and error handling add to the difficulty. While the problem statement does not explicitly list edge cases beyond version interactions, the nature of the bug implies complex scenarios: signals failing in exported builds could involve various signal types (built-in and custom), different export targets (Linux and Web), and interactions between project files created by different engine versions. The fix must ensure that removing the `CONNECT_INHERITED` check does not introduce regressions or break other functionality, such as scene instance handling, which requires careful testing and validation.\n\nFinally, the difficulty is compounded by the fact that the bug manifests only in exported builds, not in the editor, which suggests a discrepancy between runtime environments that must be traced and resolved. This requires advanced debugging skills and potentially performance considerations if signal handling is a critical path in the engine. Overall, while the code change itself is small, the process of identifying the root cause, understanding the implications of the fix, and ensuring no side effects push this problem into the higher end of the difficulty spectrum at 0.75.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Double lock detected in `Warnings::GetMessages()`\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nRunning `bitcoin-qt -testnet` results in it eventually deadlocking due to a double lock in the warnings code.\n\n### Expected behaviour\n\nShould not double lock.\n\n### Steps to reproduce\n\n1. Build with `--enable-debug` (or define `DEBUG_LOCKORDER`\r\n2. Run `bitcoin-qt -testnet`, and either sync or reindex\r\n3. It will assert and crash on its own (without `DEBUG_LOCKORDER`, it will eventually hang)\n\n### Relevant log output\n\n\r\n```\r\n2024-07-05T23:22:12.212000Z [scheduler] [../../../src/qt/bitcoin.cpp:215] [DebugMessageHandler] [qt] GUI: ClientModel: NotifyAlertChanged\r\n2024-07-05T23:22:12.212029Z [scheduler] [../../../src/sync.cpp:129] [double_lock_detected] DOUBLE LOCK DETECTED\r\n2024-07-05T23:22:12.212052Z [scheduler] [../../../src/sync.cpp:130] [double_lock_detected] Lock order:\r\n2024-07-05T23:22:12.212072Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:31 (in thread 'scheduler')\r\n2024-07-05T23:22:12.212092Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler')\r\nAssertion failed: detected double lock for 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler'), details in debug log.\r\n```\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nbd5d1688b4311e21c0e0ff89a3ae02ef7d0543b8\n\n### Operating system and version\n\nArch\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/node/warnings.cpp b/src/node/warnings.cpp\nindex b99c845900abf..87389e472b934 100644\n--- a/src/node/warnings.cpp\n+++ b/src/node/warnings.cpp\n@@ -28,8 +28,7 @@ Warnings::Warnings()\n }\n bool Warnings::Set(warning_type id, bilingual_str message)\n {\n-    LOCK(m_mutex);\n-    const auto& [_, inserted]{m_warnings.insert({id, std::move(message)})};\n+    const auto& [_, inserted]{WITH_LOCK(m_mutex, return m_warnings.insert({id, std::move(message)}))};\n     if (inserted) uiInterface.NotifyAlertChanged();\n     return inserted;\n }\n", "instance_id": "bitcoin__bitcoin-30404", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: a double lock in the `Warnings::GetMessages()` function leading to a deadlock when running `bitcoin-qt -testnet`. It provides steps to reproduce the issue, relevant log output, and context about the environment (compiled from source, specific version, OS). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior beyond \"should not double lock,\" nor does it clarify the broader impact of the deadlock on the system or specify any constraints or edge cases to consider when fixing the issue. Additionally, while the log output points to the specific lines in the code, the statement lacks a detailed explanation of why the double lock occurs or the threading context leading to it. Overall, the problem is valid and mostly clear, but these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is minimal and confined to a single file (`warnings.cpp`) and a specific function. It replaces a manual `LOCK` macro with a `WITH_LOCK` macro, which is a straightforward modification to address the double lock issue. The change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is very small, essentially a one-line fix.\n\n2. **Number of Technical Concepts:** Solving this problem requires a basic understanding of threading and mutex locking in C++, specifically within the context of the Bitcoin Core codebase. Familiarity with the `LOCK` and `WITH_LOCK` macros (likely custom utilities for mutex management in the project) is necessary, but these are not overly complex concepts for someone with moderate experience in C++ and multithreaded programming. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic synchronization are required.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not mention specific edge cases or additional error handling requirements. The code change itself does not introduce new error handling logic; it simply adjusts the locking mechanism to prevent a deadlock. While deadlocks can be tricky to debug in general, the provided fix and the nature of the issue suggest that edge cases are not a significant concern in this particular solution.\n\n4. **Overall Complexity:** The issue is a bug fix related to thread synchronization, which is a common challenge in C++ programming but not inherently complex in this instance due to the localized and minimal nature of the change. The fix does not require deep understanding of the entire Bitcoin Core codebase or its architecture, as the problem is isolated to a specific locking issue in the warnings module.\n\nGiven these factors, the difficulty score of 0.25 reflects an easy problem that requires understanding some code logic (threading and mutex usage) and making a simple modification. It is slightly above the \"Very Easy\" range due to the need to understand the context of mutex locking and the project's custom macros, but it remains a straightforward fix for a developer with basic to intermediate C++ experience.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "\\n with ENABLE_PROCESSED_OUTPUT and without ENABLE_WRAP_AT_EOL_OUTPUT\n### Windows Terminal version\n\n1.22.2362\n\n### Windows build number\n\n10.0.19045\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nDisable ENABLE_WRAP_AT_EOL_OUTPUT, keep ENABLE_PROCESSED_OUTPUT enabled, write to the end of line, then insert \\n .  Traditionally the newline would operate as CRLF (processed output semantics) and start at the beginning of the following line.  Note this is Win32 semantics, VT semantics are different; in this sequence, VT support is not enabled.\n\nIn WT 1.22.x, this generates VT semantics.  Replacing \\n with \\r\\n works as expected.\n\n```\n#include <windows.h>\n\nint main(int argc, char * argv[])\n{\n    CONSOLE_SCREEN_BUFFER_INFO screenBufferInfo;\n    DWORD consoleWidth;\n    DWORD charIndex;\n    DWORD lineIndex;\n    DWORD charsWritten;\n    HANDLE consoleHandle;\n    LPSTR buffer;\n\n    consoleHandle = GetStdHandle(STD_OUTPUT_HANDLE);\n    GetConsoleScreenBufferInfo(consoleHandle, &screenBufferInfo);\n    consoleWidth = screenBufferInfo.dwSize.X;\n\n    //\n    //  Disable ENABLE_WRAP_AT_EOL_OUTPUT\n    //\n    SetConsoleMode(consoleHandle, ENABLE_PROCESSED_OUTPUT);\n    buffer = malloc(consoleWidth + 1);\n\n    for (lineIndex = 0; lineIndex < 3; lineIndex++) {\n        for (charIndex = 0; charIndex < consoleWidth; charIndex++) {\n            buffer[charIndex] = '1' + lineIndex;\n        }\n        WriteConsole(consoleHandle, buffer, consoleWidth, &charsWritten, NULL);\n        WriteConsole(consoleHandle, \"\\n\", 1, &charsWritten, NULL);\n    }\n\n    return 0;\n}\n```\n\n### Expected Behavior\n\nBehavior in WT 1.21, as well as Conhost, including OpenConsole from WT 1.22:\n\n![Image](https://github.com/user-attachments/assets/77fcdf2e-5693-4294-965c-08c7f5e3a1f8)\n\n### Actual Behavior\n\nBehavior in WT 1.22:\n\n![Image](https://github.com/user-attachments/assets/296a4a57-0c42-4c7b-bd65-6c165e28eb35)\n\n\n", "patch": "diff --git a/src/host/_stream.cpp b/src/host/_stream.cpp\nindex 85cadb1cfef..30901515402 100644\n--- a/src/host/_stream.cpp\n+++ b/src/host/_stream.cpp\n@@ -269,17 +269,26 @@ void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& t\n             case UNICODE_LINEFEED:\r\n             {\r\n                 auto pos = cursor.GetPosition();\r\n-                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN) && pos.x != 0)\r\n+\r\n+                // If DISABLE_NEWLINE_AUTO_RETURN is not set, any LF behaves like a CRLF.\r\n+                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN))\r\n                 {\r\n                     pos.x = 0;\r\n-                    // This causes the current \\n to be replaced with a \\r\\n in the ConPTY VT output.\r\n-                    wch = 0;\r\n-                    lastCharWrapped = true;\r\n+\r\n+                    // Setting wch=0 and lastCharWrapped=true will cause the code at the end\r\n+                    // of the loop to emit a CRLF. However, we only do this if the preceding\r\n+                    // character isn't already a CR. We don't want to emit CR CR LF after all.\r\n+                    if (it == beg || it[-1] != '\\r')\r\n+                    {\r\n+                        wch = 0;\r\n+                        lastCharWrapped = true;\r\n+                    }\r\n                 }\r\n \r\n                 textBuffer.GetMutableRowByOffset(pos.y).SetWrapForced(false);\r\n                 pos.y = pos.y + 1;\r\n                 AdjustCursorPosition(screenInfo, pos, psScrollY);\r\n+\r\n                 break;\r\n             }\r\n             case UNICODE_CARRIAGERETURN:\r\n", "instance_id": "microsoft__terminal-18781", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue with newline behavior in Windows Terminal version 1.22 when `ENABLE_WRAP_AT_EOL_OUTPUT` is disabled and `ENABLE_PROCESSED_OUTPUT` is enabled. It provides a reproducible code snippet, expected behavior, actual behavior, and visual aids (images) to illustrate the discrepancy. The goal is evident: to restore the traditional Win32 semantics for newline handling (CRLF behavior) instead of the current VT semantics. However, there are minor ambiguities. For instance, the problem statement does not explicitly discuss potential edge cases or constraints beyond the provided example (e.g., behavior with mixed CR/LF sequences or different console modes). Additionally, it lacks detailed context about the broader impact on other terminal features or configurations. While the issue is well-defined for the specific scenario, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively narrow, confined to a single file (`_stream.cpp`) and a specific function (`WriteCharsLegacy`). The diff shows a focused modification of around 10-15 lines, primarily adjusting the logic for handling newline characters (`UNICODE_LINEFEED`) to ensure CRLF behavior under specific conditions. This does not impact the broader system architecture significantly. Second, the technical concepts involved include understanding Windows console modes (`DISABLE_NEWLINE_AUTO_RETURN`, `ENABLE_PROCESSED_OUTPUT`), character encoding nuances (CRLF vs. LF), and the interaction between Win32 and VT semantics. These concepts are moderately complex but not overly advanced, requiring a solid grasp of low-level console I/O rather than intricate algorithms or design patterns. Third, the problem requires handling a specific edge case\u2014ensuring that a preceding CR does not result in duplicate CR emissions (as addressed in the code change)\u2014but the problem statement and diff do not suggest extensive additional edge cases or complex error handling beyond this. Overall, solving this requires understanding specific parts of the codebase and making targeted, logical modifications, fitting a medium difficulty level of 0.45.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "New window instances do not gain foreground rights\n### Windows Terminal version\n\n1.23.3471.0\n\n### Windows build number\n\n_No response_\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n* Set \"New instance behavior\" to \"Create a new window\"\n* Launch from the start menu (= first window, first tab)\n* Explicitly minimize\n* Launch from the start menu again\n\n### Expected Behavior\n\nNew window is in the foreground.\n\n### Actual Behavior\n\nNew window fails to gain foreground rights.\n", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 66bc375d0af..6c25d4c8ade 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -170,6 +170,14 @@ static wil::unique_mutex acquireMutexOrAttemptHandoff(const wchar_t* className,\n                 .cbData = gsl::narrow<DWORD>(payload.size()),\r\n                 .lpData = payload.data(),\r\n             };\r\n+\r\n+            // Allow the existing instance to gain foreground rights.\r\n+            DWORD processId = 0;\r\n+            if (GetWindowThreadProcessId(hwnd, &processId) && processId)\r\n+            {\r\n+                AllowSetForegroundWindow(processId);\r\n+            }\r\n+\r\n             if (SendMessageTimeoutW(hwnd, WM_COPYDATA, 0, reinterpret_cast<LPARAM>(&cds), SMTO_ABORTIFHUNG | SMTO_ERRORONEXIT, 5000, nullptr))\r\n             {\r\n                 return {};\r\n", "instance_id": "microsoft__terminal-18325", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: new window instances of Windows Terminal fail to gain foreground rights when launched under specific conditions (e.g., after minimizing the first window). The steps to reproduce, expected behavior, and actual behavior are provided, which helps in understanding the goal. However, there are minor ambiguities and missing details. For instance, the problem does not specify whether this behavior is consistent across different Windows versions or configurations, nor does it mention any specific constraints or edge cases (e.g., behavior with multiple monitors, user permissions, or other running applications). Additionally, there are no examples of logs or error messages that might provide deeper context. While the issue is valid and understandable, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is limited to a single file (`WindowEmperor.cpp`) and involves a small, targeted modification of adding a few lines of code to allow the existing instance to gain foreground rights using `AllowSetForegroundWindow`. This does not impact the broader system architecture or require changes across multiple modules. Second, the technical concepts involved are relatively straightforward: understanding Windows API calls (specifically `AllowSetForegroundWindow` and `GetWindowThreadProcessId`) and basic inter-process communication via `SendMessageTimeoutW`. These are not overly complex for someone familiar with Windows programming. Third, the problem does not explicitly mention edge cases or additional error handling requirements beyond the provided fix, and the code change itself does not introduce significant complexity in this regard. Overall, solving this issue requires understanding some code logic and making a simple modification, but it does not demand deep architectural knowledge or handling of intricate edge cases, justifying a score of 0.30.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Command History (F7) is added to when selected command from the list\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.4037\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a clean command prompt - nothing in the list in F7.\r\n2. Type in a command, e.g. \"dir\"\r\n3. Type in a second different command, e.g. \"dir D*\"\r\n4. Press F7 to see the command list - it will contain two commands. Select the first one from the list.\r\n5. Press F7 to see the command list again, it will now contain three commands. This is unexpected. \n\n### Expected Behavior\n\nSelecting the command from the command list was previously (in Windows 10 command prompt) the way you issued it to ensure it didn't get added to the history, thus allowing you to maintain a nice tidy command list.\n\n### Actual Behavior\n\nInstead it was added to the history.\n", "patch": "diff --git a/src/host/settings.cpp b/src/host/settings.cpp\nindex e2dd84b78e7..0df97dbd354 100644\n--- a/src/host/settings.cpp\n+++ b/src/host/settings.cpp\n@@ -36,7 +36,7 @@ Settings::Settings() :\n     _bAutoPosition(true),\r\n     _uHistoryBufferSize(DEFAULT_NUMBER_OF_COMMANDS),\r\n     _uNumberOfHistoryBuffers(DEFAULT_NUMBER_OF_BUFFERS),\r\n-    _bHistoryNoDup(false),\r\n+    _bHistoryNoDup(true),\r\n     // ColorTable initialized below\r\n     _uCodePage(ServiceLocator::LocateGlobals().uiOEMCP),\r\n     _uScrollScale(1),\r\n@@ -110,7 +110,7 @@ void Settings::ApplyDesktopSpecificDefaults()\n     _bQuickEdit = TRUE;\r\n     _uHistoryBufferSize = 50;\r\n     _uNumberOfHistoryBuffers = 4;\r\n-    _bHistoryNoDup = FALSE;\r\n+    _bHistoryNoDup = true;\r\n \r\n     _renderSettings.ResetColorTable();\r\n \r\ndiff --git a/src/propsheet/registry.cpp b/src/propsheet/registry.cpp\nindex 64d392aa76d..3a7283e080e 100644\n--- a/src/propsheet/registry.cpp\n+++ b/src/propsheet/registry.cpp\n@@ -79,7 +79,7 @@ VOID InitRegistryValues(\n     pStateInfo->CursorSize = 25;\r\n     pStateInfo->HistoryBufferSize = 25;\r\n     pStateInfo->NumberOfHistoryBuffers = 4;\r\n-    pStateInfo->HistoryNoDup = 0;\r\n+    pStateInfo->HistoryNoDup = 1;\r\n \r\n     // clang-format off\r\n     if (pStateInfo->fIsV2Console)\r\n", "instance_id": "microsoft__terminal-17852", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the command history feature in Windows Terminal. It provides a specific scenario (using F7 to view and select commands) and clearly states the expected behavior (selecting a command should not add it to history) versus the actual behavior (it gets added to history). Steps to reproduce are well-defined, and the context of the issue is provided with version numbers. However, there are minor ambiguities: the problem does not explicitly mention whether this behavior should apply to all command prompts or specific configurations, nor does it discuss potential edge cases (e.g., what happens if the history buffer is full, or if the same command is selected multiple times). Additionally, there are no examples of what a \"tidy command list\" means in terms of constraints or limits. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as the code changes provided are minimal and straightforward. The modification involves changing a single boolean flag (`_bHistoryNoDup`) from `false` to `true` in multiple places across two files (`settings.cpp` and `registry.cpp`). This change appears to enable a feature to prevent duplicate entries in the command history, directly addressing the reported issue. The scope of the change is limited to initialization values and does not require deep understanding of the codebase, complex logic, or interactions between modules. No advanced language features, algorithms, or design patterns are involved\u2014just a simple configuration tweak. There are no apparent edge cases or error handling requirements introduced by this change, as it is a static setting adjustment. The impact on the system's architecture is negligible. Therefore, I assign a difficulty score of 0.15, placing it in the \"Very Easy\" range (0.0-0.2), as it requires only basic code modification with minimal cognitive load.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "'unfocusedAppearance' option with any value including empty dictionary causes Windows Terminal to crash all instances when closing just one\n### Windows Terminal version\n\n1.20.11781\n\n### Windows build number\n\n10.0.22631.2861\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nSo after quite a bit of troubleshooting (including re-installing my entire Windows 11 OS), I've narrowed down the bug and can consistently replicate it.\n\n\n1. Add the `unfocusedAppearance` option in the `defaults` section of your Windows Terminal config, e.g.\n\n```\n   \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        ...\n    },\n```\n\n2. OR alternative use this full config (minimal example):\n\n```md\n{\n    \"$help\": \"https://aka.ms/terminal-documentation\",\n    \"$schema\": \"https://aka.ms/terminal-profiles-schema\",\n    \"actions\": \n    [\n        {\n            \"command\": \n            {\n                \"action\": \"copy\",\n                \"singleLine\": false\n            },\n            \"keys\": \"ctrl+c\"\n        },\n        {\n            \"command\": \"paste\",\n            \"keys\": \"ctrl+v\"\n        },\n        {\n            \"command\": \"find\",\n            \"keys\": \"ctrl+shift+f\"\n        },\n        {\n            \"command\": \n            {\n                \"action\": \"splitPane\",\n                \"split\": \"auto\",\n                \"splitMode\": \"duplicate\"\n            },\n            \"keys\": \"alt+shift+d\"\n        }\n    ],\n    \"copyFormatting\": \"none\",\n    \"copyOnSelect\": false,\n    \"defaultProfile\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n    \"newTabMenu\": \n    [\n        {\n            \"type\": \"remainingProfiles\"\n        }\n    ],\n    \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"opacity\": 90,\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        \"list\": \n        [\n            {\n                \"guid\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n                \"hidden\": false,\n                \"name\": \"Windows PowerShell\"\n            },\n            {\n                \"guid\": \"{0caa0dad-35be-5f56-a8ff-afceeeaa6101}\",\n                \"hidden\": false,\n                \"name\": \"Command Prompt\"\n            }\n        ]\n    },\n    \"schemes\": \n    [\n        {\n            \"background\": \"#0C0C0C\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#012456\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell Powershell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#282C34\",\n            \"black\": \"#282C34\",\n            \"blue\": \"#61AFEF\",\n            \"brightBlack\": \"#5A6374\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B6C2\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C678DD\",\n            \"brightRed\": \"#E06C75\",\n            \"brightWhite\": \"#DCDFE4\",\n            \"brightYellow\": \"#E5C07B\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#56B6C2\",\n            \"foreground\": \"#DCDFE4\",\n            \"green\": \"#98C379\",\n            \"name\": \"One Half Dark\",\n            \"purple\": \"#C678DD\",\n            \"red\": \"#E06C75\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#DCDFE4\",\n            \"yellow\": \"#E5C07B\"\n        },\n        {\n            \"background\": \"#FAFAFA\",\n            \"black\": \"#383A42\",\n            \"blue\": \"#0184BC\",\n            \"brightBlack\": \"#4F525D\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B5C1\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C577DD\",\n            \"brightRed\": \"#DF6C75\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#E4C07A\",\n            \"cursorColor\": \"#4F525D\",\n            \"cyan\": \"#0997B3\",\n            \"foreground\": \"#383A42\",\n            \"green\": \"#50A14F\",\n            \"name\": \"One Half Light\",\n            \"purple\": \"#A626A4\",\n            \"red\": \"#E45649\",\n            \"selectionBackground\": \"#4F525D\",\n            \"white\": \"#FAFAFA\",\n            \"yellow\": \"#C18301\"\n        },\n        {\n            \"background\": \"#002B36\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#839496\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Dark\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#FDF6E3\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#002B36\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#657B83\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Light\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#073642\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#D3D7CF\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Dark\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#FFFFFF\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#000000\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#555753\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Light\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#555753\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#000080\",\n            \"brightBlack\": \"#808080\",\n            \"brightBlue\": \"#0000FF\",\n            \"brightCyan\": \"#00FFFF\",\n            \"brightGreen\": \"#00FF00\",\n            \"brightPurple\": \"#FF00FF\",\n            \"brightRed\": \"#FF0000\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#FFFF00\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#008080\",\n            \"foreground\": \"#C0C0C0\",\n            \"green\": \"#008000\",\n            \"name\": \"Vintage\",\n            \"purple\": \"#800080\",\n            \"red\": \"#800000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#C0C0C0\",\n            \"yellow\": \"#808000\"\n        }\n    ],\n    \"themes\": []\n}\n```\n\n3. Now launch two instances of Windows Terminal.\n4. Using your mouse, press the 'x' button on the top-right of the first instance.\n5. The first instance will freeze a bit, crash, and cause both instances to shut.\n6. If you view Event Viewer logs, under Application logs, you will see that the application has indeed crashed with an ERROR.\n\nOther things to know:\n- Removing the `unfocusedAppearance` option fixes the issue (but you lose that feature).\n- The `unfocusedAppearance` use to work for me on older builds (I don't know which ones but I use to use this feature a lot).\n- Adding any options in the `unfocusedAppearance` still causes the crash.\n- Shutting any of the Windows Terminal using 'CTRL+W' shortcut avoids this crashing behaviour.\n\n### Expected Behavior\n\nWhen I shut a single instance of Windows Terminal, it should only shut that instance and not shut all other instances. This likely happens because the parent process crashes, killing all spawned windows terminal children.\n\n### Actual Behavior\n\nPressing the 'x' button causes all windows terminal instances to shut.\n", "patch": "diff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..8f8f9f0df66 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -717,11 +717,14 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         // terminal.\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _core.UpdateSettings(settings, unfocusedAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _core.UpdateSettings(settings, unfocusedAppearance);\r\n \r\n-        _UpdateSettingsFromUIThread();\r\n+            _UpdateSettingsFromUIThread();\r\n \r\n-        _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+            _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n@@ -730,10 +733,15 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - newAppearance: the new appearance to set\r\n     winrt::fire_and_forget TermControl::UpdateAppearance(IControlAppearance newAppearance)\r\n     {\r\n+        auto weakThis{ get_weak() };\r\n+\r\n         // Dispatch a call to the UI thread\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _UpdateAppearanceFromUIThread(newAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _UpdateAppearanceFromUIThread(newAppearance);\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n", "instance_id": "microsoft__terminal-17770", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `unfocusedAppearance` option in the Windows Terminal configuration causes all instances to crash when closing just one instance using the 'x' button. It provides detailed steps to reproduce the issue, including a minimal configuration example, and specifies the expected versus actual behavior. Additionally, it includes relevant context such as the Windows Terminal version, Windows build number, and observations about the crash behavior (e.g., Event Viewer logs and alternative closing methods like 'CTRL+W' not causing the issue). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether the crash occurs under specific conditions beyond the provided configuration (e.g., specific hardware or other software interactions). Edge cases related to different configuration values or system states are not fully explored, which could be critical for a comprehensive fix. Overall, while the problem is well-documented for reproduction, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code changes appears limited to a single file (`TermControl.cpp`) and involves modifications to specific methods (`UpdateSettings` and `UpdateAppearance`). The changes introduce weak reference checks (`weakThis.get()`) to prevent potential crashes due to object lifetime issues, suggesting a bug related to accessing invalid or destroyed objects during UI updates. This requires understanding C++ concepts such as smart pointers, object lifetime management, and asynchronous programming with `co_await` in the context of Windows Terminal's UI thread dispatching. While the code change itself is small (adding null checks), the difficulty lies in diagnosing the root cause of the crash, which likely involves understanding the interaction between the UI thread, terminal core settings, and appearance updates. The problem does not seem to impact the broader system architecture significantly, but it does require careful handling of potential edge cases, such as ensuring the weak reference check does not introduce new issues (e.g., skipped updates). Additionally, debugging crashes in a multi-instance application like Windows Terminal may involve analyzing stack traces or logs, which adds moderate complexity. Overall, this problem requires a solid understanding of C++ and the Windows Terminal codebase but does not appear to demand extensive refactoring or advanced domain-specific knowledge, placing it in the medium difficulty range of 0.4-0.6.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "ConPTY does not pass Device Control Strings (DCS) to 3rd-party terminals\n### Windows Terminal version\r\n\r\n1.19.11213.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.0\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nWe're thrilled by the release and development of ConPTY. We're hoping it can support our usage of Device Control Strings.\r\n\r\nFrom any 3rd-party terminal that wishes to \"speak ANSI\" using ConPTY, run any command that outputs a DCS escape sequence. (I'm using a locally built alacritty)\r\n\r\n```\r\nPowerShell 7.4.2\r\necho \"`eP <some data for terminal> `e\\\"\r\n```\r\n\r\nAlacritty does not receive the DCS.\r\n\r\n### Expected Behavior\r\n\r\nI expect DCS escape sequences to be output by ConPTY so that 3rd-party terminals may use this to implement more advanced features.\r\n\r\n### Context\r\n\r\nI work for Warp and we'd like to bring Warp Terminal to Windows. Warp depends heavily on DCS strings for its key features.\r\n\r\n### Alternatives Considered\r\n\r\nWe tried utilizing a custom OSC sequence instead. We notice that unhandled OSC gets [flushed to the terminal](https://github.com/microsoft/terminal/blob/e826203bb7e200f6f7029b6d8be68fb330c18735/src/terminal/parser/OutputStateMachineEngine.cpp#L924-L927). Although with this method Warp is able to receive these data as we'd like, the ordering is not preserved, i.e. if the shell outputs an OSC interleaved with text, when it is read out of ConPTY by the terminal, the OSC is not received in the same order in which it was produced. Warp does depend on that ordering, which is an invariant on UNIX PTYs.\r\n\r\nIt would be nice if DCS had similar logic where `_pfnFlushToTerminal` was called like it is for OSC, but where ordering is preserved.\r\n\r\n### Actual Behavior\r\n\r\nOnly DCS escape sequences that Windows Terminal recognizes are being dispatched. As we understand it, ConPTY is an interface intended to be used by 3rd-party terminals for optimal compatibility. Therefore, it makes sense to expand support for arbitrary DCS sequences that other terminals might depend on.\n", "patch": "", "instance_id": "microsoft__terminal-17510", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with ConPTY not passing Device Control Strings (DCS) to third-party terminals. It provides context about the expected behavior, actual behavior, and the importance of DCS for the requester's application (Warp Terminal). Steps to reproduce are included, along with a specific example of a command to test the issue. Additionally, alternatives considered (using OSC sequences) and their shortcomings are mentioned, which adds depth to the problem description. However, there are minor ambiguities and missing details. For instance, the problem does not explicitly define the full range of DCS sequences that need to be supported or provide detailed examples of the ordering issue with OSC sequences. Edge cases, such as malformed DCS sequences or performance implications of handling arbitrary DCS, are not addressed. Overall, while the goal and context are clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the change likely involves modifying the ConPTY layer within the Windows Terminal codebase, which is a critical component responsible for terminal emulation and communication with third-party terminals. This requires a deep understanding of the terminal's architecture, specifically how escape sequences (like DCS and OSC) are parsed and dispatched. The reference to specific lines of code in `OutputStateMachineEngine.cpp` suggests that the change may be localized to a specific module, but implementing a solution that preserves ordering while flushing unhandled DCS sequences to the terminal will require careful design to avoid breaking existing behavior. \n\nSecond, the technical concepts involved include low-level terminal emulation, ANSI escape sequence handling, and potentially threading or buffering mechanisms to maintain sequence ordering. This demands familiarity with Windows-specific APIs (like ConPTY), as well as domain-specific knowledge of terminal protocols, which are niche and complex.\n\nThird, edge cases and error handling are likely to be significant. The problem statement does not explicitly mention edge cases, but supporting arbitrary DCS sequences introduces risks such as handling malformed input, ensuring compatibility with various third-party terminals, and managing performance impacts of flushing large or frequent sequences. These considerations add to the complexity.\n\nFinally, while the exact code changes are not provided, the impact of modifying ConPTY could affect the broader system, as it is a foundational interface for terminal compatibility. Balancing the needs of third-party terminals like Warp with the existing behavior of Windows Terminal will require careful testing and validation. Given these factors, I rate the difficulty as 0.65, reflecting a hard problem that requires deep technical expertise and thoughtful implementation, though it may not reach the extreme complexity of system-level redesigns or highly intricate algorithms.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
