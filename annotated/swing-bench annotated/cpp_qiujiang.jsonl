{"problem_statement": "Knobs do not align with text labels\nIn my panel SVG generator [make_sapphire_svg.py](https://github.com/cosinekitty/sapphire/blob/main/util/make_sapphire_svg.py), I have a development command line option \"preview\". When present, the export panels get generated with a thin black outline circle where I think each knob should be.\n\nWhen I use this option, then build sapphire-plugins, then run Bitwig, I can see the knobs are not where I want them. The text labels appear to be exactly where I want them. The result is visual misalignment. The knobs should be horizontally centered directly beneath the center of their respective labels. Here is a screenshot that shows real knobs + my fake circles showing where they should be.\n\n![Image](https://github.com/user-attachments/assets/105d58d7-7078-43d0-837c-549145b91666)\n\nHere is a screenshot of the raw preview svg by itself, with no knobs rendered on top:\n\n![Image](https://github.com/user-attachments/assets/64e4a4ab-d818-4059-93d0-47a7a87e8c7b)\n", "patch": "diff --git a/src/shared/editor_interactions.h b/src/shared/editor_interactions.h\nindex ee26d0e..8667d96 100644\n--- a/src/shared/editor_interactions.h\n+++ b/src/shared/editor_interactions.h\n@@ -281,14 +281,15 @@ inline void set_control_position(juce::Component &control, float cx, float cy, f\n }\n template <typename Editor>\n std::unique_ptr<juce::Slider> makeLargeKnob(Editor *editor, const std::string &prefix,\n-                                            const std::string pos)\n+                                            const std::string pos,\n+                                            float extraDx = 0.f) // see #33\n {\n     auto r = Sapphire::FindComponent(prefix, pos);\n     auto cx = r.cx;\n     auto cy = r.cy;\n \n-    static constexpr float dx = 1.5;\n-    static constexpr float dy = 0.0;\n+    float dx = 1.5 - extraDx;\n+    float dy = 0.5;\n     auto kn = std::make_unique<juce::Slider>();\n     kn->setSliderStyle(juce::Slider::RotaryHorizontalVerticalDrag);\n     kn->setTextBoxStyle(juce::Slider::NoTextBox, true, 0, 0);\ndiff --git a/src/tube_unit/editor.cpp b/src/tube_unit/editor.cpp\nindex 9c6226f..9c4ffd5 100644\n--- a/src/tube_unit/editor.cpp\n+++ b/src/tube_unit/editor.cpp\n@@ -50,31 +50,32 @@ TubeUnitEditor::TubeUnitEditor(shared::audioToUIQueue_t &atou, shared::uiToAudio\n \n     const std::string modcode(\"tubeunit_export\");\n \n-    airflow = shared::makeLargeKnob(this, modcode, \"airflow_knob\");\n+    // see #33 for this 1.0\n+    airflow = shared::makeLargeKnob(this, modcode, \"airflow_knob\", 1.0);\n     shared::bindSlider(this, airflow, patchCopy.airflow);\n \n-    vortex = shared::makeLargeKnob(this, modcode, \"vortex_knob\");\n+    vortex = shared::makeLargeKnob(this, modcode, \"vortex_knob\", 1.0);\n     shared::bindSlider(this, vortex, patchCopy.vortex);\n \n-    width = shared::makeLargeKnob(this, modcode, \"width_knob\");\n+    width = shared::makeLargeKnob(this, modcode, \"width_knob\", 1.0);\n     shared::bindSlider(this, width, patchCopy.width);\n \n-    center = shared::makeLargeKnob(this, modcode, \"center_knob\");\n+    center = shared::makeLargeKnob(this, modcode, \"center_knob\", 1.0);\n     shared::bindSlider(this, center, patchCopy.center);\n \n-    decay = shared::makeLargeKnob(this, modcode, \"decay_knob\");\n+    decay = shared::makeLargeKnob(this, modcode, \"decay_knob\", 1.0);\n     shared::bindSlider(this, decay, patchCopy.decay);\n \n-    angle = shared::makeLargeKnob(this, modcode, \"angle_knob\");\n+    angle = shared::makeLargeKnob(this, modcode, \"angle_knob\", 1.0);\n     shared::bindSlider(this, angle, patchCopy.angle);\n \n-    root = shared::makeLargeKnob(this, modcode, \"root_knob\");\n+    root = shared::makeLargeKnob(this, modcode, \"root_knob\", 1.0);\n     shared::bindSlider(this, root, patchCopy.root);\n \n-    spring = shared::makeLargeKnob(this, modcode, \"spring_knob\");\n+    spring = shared::makeLargeKnob(this, modcode, \"spring_knob\", 1.0);\n     shared::bindSlider(this, spring, patchCopy.spring);\n \n-    mix = shared::makeLargeKnob(this, modcode, \"mix_knob\");\n+    mix = shared::makeLargeKnob(this, modcode, \"mix_knob\", 1.0);\n     shared::bindSlider(this, mix, patchCopy.mix);\n \n     auto dim = shared::getPanelDimensions(modcode, 2);\n", "instance_id": "baconpaul__sapphire-plugins-34", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the knobs in a generated SVG panel for a plugin are misaligned with their text labels, and the goal is to adjust their positions to be horizontally centered beneath the labels. The inclusion of screenshots and references to specific files (e.g., make_sapphire_svg.py) and command-line options (\"preview\") helps in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the exact coordinate system or scaling factors used in the SVG or the plugin rendering environment (e.g., Bitwig), which could affect the interpretation of \"centered beneath.\" Additionally, while the issue is visually demonstrated, there are no specific numerical values or constraints provided for the desired offset or alignment logic. Edge cases, such as varying label sizes or panel dimensions, are not mentioned. Thus, while the goal is clear, some minor details that could impact the solution are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following analysis across the specified factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are relatively localized, primarily affecting two files: `editor_interactions.h` and `editor.cpp`. The modifications involve adding a parameter (`extraDx`) to the `makeLargeKnob` function and adjusting the positioning logic with hardcoded offset values (`dx` and `dy`). The changes are applied consistently across multiple knob instances in the editor file, but they do not impact the broader system architecture or require extensive refactoring. The overall amount of code change is small, focusing on tweaking numerical offsets.\n\n2. **Number of Technical Concepts:** Solving this problem requires a basic understanding of GUI component positioning in the JUCE framework (used for audio plugin development), specifically how coordinates (`cx`, `cy`, `dx`, `dy`) are applied to place UI elements like sliders/knobs. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic UI layout logic are needed. Familiarity with C++ (function parameters, templates) is sufficient, and the concepts involved are straightforward for a developer with moderate experience.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, such as varying panel sizes, label widths, or rendering differences across environments (e.g., different DAWs beyond Bitwig). The code changes also do not introduce or modify error handling logic. While there might be implicit edge cases (e.g., ensuring the hardcoded offsets work across different resolutions or SVG scales), addressing them does not appear to be a primary concern in the provided diff, keeping the complexity low.\n\n4. **Overall Assessment:** The task involves understanding a small part of the codebase related to UI positioning and making simple modifications to adjust knob placement. It does not require deep architectural changes, complex logic, or advanced technical knowledge. The hardcoded nature of the solution (adjusting `dx` and `dy`) suggests a trial-and-error approach rather than a sophisticated algorithmic fix, further reducing the difficulty. A score of 0.30 reflects an \"Easy\" problem that requires minimal effort beyond tweaking values and understanding basic UI placement logic in JUCE.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "shell.showItemInFolder won't open Explorer if forward slashes are present in path\n* Electron version: 1.7.10\r\n* Operating system: Windows 10, build 1709\r\n\r\nIf a path contains forward slash(es) on Windows (e.g. `C:\\some\\app/index.html`), ~~showItemInFolder will open the containing directory but will not select the file.~~ In Electron 8.x and newer, showItemInFolder will not open an Explorer window at all if forward slashes are present in path.\r\n\r\n### How to reproduce\r\n\r\nhttps://github.com/YellowAfterlife/abug-electron-showItemInFolder-forward-slashes\r\n```js\r\nconst electron = require('electron')\r\nconst app = electron.app\r\nconst path = require('path')\r\napp.on('ready', () => {\r\n\tlet test = path.join(__dirname, 'index.html')\r\n\ttest = test.replace(/^(.+)\\\\(.+)$/, \"$1/$2\") // simulate a forward slash in path\r\n\tconsole.log(test)\r\n\tconsole.log(electron.shell.showItemInFolder(test))\r\n\tapp.quit()\r\n})\r\n```\r\n\r\nFrom what I've seen, no other shell functions show this kind of \"partial success\" behaviour while returning `true`.\n", "patch": "diff --git a/shell/common/platform_util_win.cc b/shell/common/platform_util_win.cc\nindex a2deae69bf112..43684fc9e0efa 100644\n--- a/shell/common/platform_util_win.cc\n+++ b/shell/common/platform_util_win.cc\n@@ -336,7 +336,8 @@ void ShowItemInFolder(const base::FilePath& full_path) {\n   base::ThreadPool::CreateCOMSTATaskRunner(\n       {base::MayBlock(), base::TaskPriority::USER_BLOCKING})\n       ->PostTask(FROM_HERE,\n-                 base::BindOnce(&ShowItemInFolderOnWorkerThread, full_path));\n+                 base::BindOnce(&ShowItemInFolderOnWorkerThread,\n+                                full_path.NormalizePathSeparators()));\n }\n \n void OpenPath(const base::FilePath& full_path, OpenCallback callback) {\n@@ -344,9 +345,11 @@ void OpenPath(const base::FilePath& full_path, OpenCallback callback) {\n \n   base::ThreadPool::CreateCOMSTATaskRunner(\n       {base::MayBlock(), base::TaskPriority::USER_BLOCKING})\n-      ->PostTaskAndReplyWithResult(FROM_HERE,\n-                                   base::BindOnce(&OpenPathOnThread, full_path),\n-                                   std::move(callback));\n+      ->PostTaskAndReplyWithResult(\n+          FROM_HERE,\n+          base::BindOnce(&OpenPathOnThread,\n+                         full_path.NormalizePathSeparators()),\n+          std::move(callback));\n }\n \n void OpenExternal(const GURL& url,\n", "instance_id": "electron__electron-41642", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `shell.showItemInFolder` function in Electron fails to open an Explorer window on Windows when the provided path contains forward slashes. It provides specific details such as the Electron version (1.7.10 and 8.x+), the operating system (Windows 10, build 1709), and a reproducible code snippet to demonstrate the issue. The goal of fixing this behavior is implied, and the provided code changes align with addressing the problem. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior (e.g., should the function normalize the path or reject invalid paths?) beyond implying it should work with forward slashes. Additionally, edge cases (e.g., mixed slashes, invalid paths, or non-existent files) are not mentioned, which could impact the solution's completeness. Overall, the statement is valid and clear but lacks some minor details for a fully comprehensive description.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are minimal and localized to a single file (`platform_util_win.cc`). The modification involves adding a call to `NormalizePathSeparators()` on the `full_path` before passing it to the worker thread functions `ShowItemInFolderOnWorkerThread` and `OpenPathOnThread`. This change does not impact the broader system architecture and requires only a small amount of code modification (a few lines).\n\n2. **Technical Concepts Involved**: Solving this issue requires basic familiarity with C++ (the language used in the codebase), specifically understanding file path handling in Windows and the use of the `base::FilePath` class from the Chromium base library. The concept of normalizing path separators (converting forward slashes to backslashes on Windows) is straightforward and does not involve complex algorithms, design patterns, or domain-specific knowledge beyond basic OS-specific file handling.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code change implies a simple solution of normalizing separators, which may not fully address scenarios like mixed slashes, invalid paths, or non-existent files. However, the provided fix does not introduce new error handling logic, and the complexity of potential edge cases appears minimal at this stage.\n\n4. **Overall Complexity**: The task requires understanding a small part of the Electron/Chromium codebase related to file path utilities and making a simple modification. It does not demand deep knowledge of the overall architecture or interactions between multiple modules. The fix is essentially a one-line addition per affected function, making it a relatively simple bug fix.\n\nGiven these points, a difficulty score of 0.30 reflects the ease of the task, requiring only basic code modification and minimal conceptual depth, though with some consideration for potential unaddressed edge cases.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Inspector Section doesn't always update hover state\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nThe hover state on inspector section headers doesn't update when cursor moves in or out of the header rect. It only updates when leaving or entering the entire Control\n\n### Steps to reproduce\n\nCreate any node. Expand an inspector section. Move the cursor in and out of the header rect.\n\nhttps://github.com/user-attachments/assets/b4e0a0fb-9cb2-4e40-8069-f1975cb71dd7\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex dd0030d134f6..0a03583b4bf9 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -1888,6 +1888,15 @@ void EditorInspectorSection::gui_input(const Ref<InputEvent> &p_event) {\n \t} else if (mb.is_valid() && !mb->is_pressed()) {\n \t\tqueue_redraw();\n \t}\n+\n+\tRef<InputEventMouseMotion> mm = p_event;\n+\tif (mm.is_valid()) {\n+\t\tint header_height = _get_header_height();\n+\t\tVector2 previous = mm->get_position() - mm->get_relative();\n+\t\tif ((mm->get_position().y >= header_height) != (previous.y >= header_height)) {\n+\t\t\tqueue_redraw();\n+\t\t}\n+\t}\n }\n \n String EditorInspectorSection::get_section() const {\n", "instance_id": "godotengine__godot-103670", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the hover state of inspector section headers in a GUI does not update correctly when the cursor moves in or out of the header area, only updating when entering or leaving the entire control. The steps to reproduce are provided, along with a reference to a visual asset for context, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what the expected behavior should be (e.g., should the hover state update immediately on cursor movement within the header rect?). Additionally, there are no mentions of specific edge cases or constraints, such as performance considerations for frequent redraws or behavior on different platforms. While the issue is valid and mostly clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is limited to a single file (`editor_inspector.cpp`) and a specific function (`gui_input`), involving a small addition of logic to handle mouse motion events and trigger a redraw when the cursor crosses the header boundary. The change does not impact the broader system architecture or require modifications across multiple modules. Second, the technical concepts involved are relatively straightforward: basic GUI event handling (mouse motion events), coordinate comparison, and triggering a redraw operation, all of which are standard in GUI programming and do not require advanced language features or complex algorithms. Third, while the problem statement does not explicitly mention edge cases, the code change suggests a simple boundary check for the header height, with no complex error handling or performance optimization required. Overall, solving this issue requires understanding some code logic and making a simple modification, aligning with an easy difficulty level. I assign a score of 0.30 to reflect that it is slightly more involved than a trivial fix (e.g., changing a constant) due to the need to handle mouse motion events and calculate relative positions, but it remains a straightforward task for a developer familiar with GUI programming.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Negative scaling is broken when using Jolt Physics\n### Tested versions\n\n\nv4.4.rc2.mono.official [01545c995]\n\nThis error appeared after upgrading to 4.4rc2 from 4.3.  I was previously using the jolt physics add on.  \n\nThis error goes away if i switch to the godot physics engine instead.  It reappears if using jolt.  \n\n### System information\n\nGodot v4.4.rc2.mono - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 3700X 8-Core Processor (16 threads)\n\n### Issue description\n\nWith Jolt Physics enabled, when adding a static body as a child of a VehicleWheel3D I get a flood of quaternion errors:\n\n```\nE 0:00:01:120   get_quaternion: Basis [X: (1.0, 0.0, 0.0), Y: (0.0, 1.0, 0.0), Z: (0.0, 0.0, -1.0)] must be \nnormalized in order to be casted to a Quaternion. Use get_rotation_quaternion() or call orthonormalized() \nif the Basis contains linearly independent vectors.\n  <C++ Error>   Condition \"!is_rotation()\" is true. Returning: Quaternion()\n  <C++ Source>  core/math/basis.cpp:730 @ get_quaternion()\n```\n\nI can get rid of the errors if I move the StaticBody3D outside of the VehicleWheel3D.  I do expect it to work as before.  I prefer adding a staticBody3D as a child of VehicleWheel3D for organizations sake. \n\n### Steps to reproduce\n\n1. Enable Jolt Physics under Project -> Project Settings -> Physics -> 3D -> Physics Engine\n2. Add a VehicleBody3D node with a collision mesh\n3. Add a VehicleWheel3D node\n4. Add a StaticBody3D node as a child of the VehicleWheel3D\n5. Launch the scene and a flood of quaternion errors should appear\n\nIncluding project as well.  Open the project and run.  \n\nThank you.\n\n### Minimal reproduction project (MRP)\n\n[mrpWheelStaticBodyChild.zip](https://github.com/user-attachments/files/19031403/mrpWheelStaticBodyChild.zip)\n", "patch": "diff --git a/modules/jolt_physics/misc/jolt_math_funcs.cpp b/modules/jolt_physics/misc/jolt_math_funcs.cpp\nnew file mode 100644\nindex 000000000000..b0ef5f45747d\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.cpp\n@@ -0,0 +1,70 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.cpp                                                   */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+/*\n+Adapted to Godot from the Jolt Physics library.\n+*/\n+\n+/*\n+Copyright 2021 Jorrit Rouwe\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in\n+the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\n+the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR\n+A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n+ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n+*/\n+\n+#include \"jolt_math_funcs.h\"\n+\n+void JoltMath::decompose(Basis &p_basis, Vector3 &r_scale) {\n+\tVector3 x = p_basis.get_column(Vector3::AXIS_X);\n+\tVector3 y = p_basis.get_column(Vector3::AXIS_Y);\n+\tVector3 z = p_basis.get_column(Vector3::AXIS_Z);\n+\n+\tconst real_t x_dot_x = x.dot(x);\n+\ty -= x * (y.dot(x) / x_dot_x);\n+\tz -= x * (z.dot(x) / x_dot_x);\n+\tconst real_t y_dot_y = y.dot(y);\n+\tz -= y * (z.dot(y) / y_dot_y);\n+\tconst real_t z_dot_z = z.dot(z);\n+\n+\tconst real_t det = x.cross(y).dot(z);\n+\n+\tr_scale = SIGN(det) * Vector3(Math::sqrt(x_dot_x), Math::sqrt(y_dot_y), Math::sqrt(z_dot_z));\n+\n+\tp_basis.set_column(Vector3::AXIS_X, x / r_scale.x);\n+\tp_basis.set_column(Vector3::AXIS_Y, y / r_scale.y);\n+\tp_basis.set_column(Vector3::AXIS_Z, z / r_scale.z);\n+}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.h b/modules/jolt_physics/misc/jolt_math_funcs.h\nnew file mode 100644\nindex 000000000000..ba2d290ac77c\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.h\n@@ -0,0 +1,59 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.h                                                     */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef JOLT_MATH_FUNCS_H\n+#define JOLT_MATH_FUNCS_H\n+\n+#include \"core/math/transform_3d.h\"\n+\n+class JoltMath {\n+public:\n+\t// Note that `p_basis` is mutated to be right-handed orthonormal.\n+\tstatic void decompose(Basis &p_basis, Vector3 &r_scale);\n+\n+\t// Note that `p_transform` is mutated to be right-handed orthonormal.\n+\tstatic _FORCE_INLINE_ void decompose(Transform3D &p_transform, Vector3 &r_scale) {\n+\t\tdecompose(p_transform.basis, r_scale);\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Basis &p_basis, Basis &r_new_basis, Vector3 &r_scale) {\n+\t\tBasis new_basis = p_basis;\n+\t\tdecompose(new_basis, r_scale);\n+\t\tr_new_basis = new_basis;\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Transform3D &p_transform, Transform3D &r_new_transform, Vector3 &r_scale) {\n+\t\tTransform3D new_transform;\n+\t\tdecompose(new_transform, r_scale);\n+\t\tr_new_transform = new_transform;\n+\t}\n+};\n+\n+#endif // JOLT_MATH_FUNCS_H\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex b0a9ffd62225..0a2693ddb634 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -31,6 +31,7 @@\n #include \"jolt_area_3d.h\"\n \n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -370,7 +371,8 @@ void JoltArea3D::set_default_area(bool p_value) {\n void JoltArea3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to area '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -378,8 +380,6 @@ void JoltArea3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex ac2b37470ef1..5bc3aee1bce7 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../joints/jolt_joint_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -543,7 +544,8 @@ JoltBody3D::~JoltBody3D() {\n void JoltBody3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to physics body '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -551,8 +553,6 @@ void JoltBody3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex bfe77e008d59..f32ddad0d469 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_shaped_object_3d.h\"\n \n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_custom_double_sided_shape.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n@@ -347,7 +348,10 @@ void JoltShapedObject3D::commit_shapes(bool p_optimize_compound) {\n void JoltShapedObject3D::add_shape(JoltShape3D *p_shape, Transform3D p_transform, bool p_disabled) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed when adding shape at index %d to physics body '%s'.\", shapes.size(), to_string()));\n \n-\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform.orthonormalized(), p_transform.basis.get_scale(), p_disabled));\n+\tVector3 shape_scale;\n+\tJoltMath::decompose(p_transform, shape_scale);\n+\n+\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform, shape_scale, p_disabled));\n \n \t_shapes_changed();\n }\n@@ -430,8 +434,8 @@ void JoltShapedObject3D::set_shape_transform(int p_index, Transform3D p_transfor\n \tERR_FAIL_INDEX(p_index, (int)shapes.size());\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, \"Failed to correctly set transform for shape at index %d in body '%s'.\");\n \n-\tVector3 new_scale = p_transform.basis.get_scale();\n-\tp_transform.basis.orthonormalize();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \tJoltShapeInstance3D &shape = shapes[p_index];\n \ndiff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex 3852e42d51f2..d7a4afec57ba 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../objects/jolt_area_3d.h\"\n #include \"../objects/jolt_body_3d.h\"\n@@ -288,11 +289,10 @@ bool JoltPhysicsDirectSpaceState3D::_body_motion_cast(const JoltBody3D &p_body,\n \t\tconst Transform3D transform_com_local = transform_local.translated_local(com_scaled);\n \t\tTransform3D transform_com = body_transform * transform_com_local;\n \n-\t\tVector3 scale = transform_com.basis.get_scale();\n+\t\tVector3 scale;\n+\t\tJoltMath::decompose(transform_com, scale);\n \t\tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"body_test_motion was passed an invalid transform along with body '%s'. This results in invalid scaling for shape at index %d.\");\n \n-\t\ttransform_com.basis.orthonormalize();\n-\n \t\treal_t shape_safe_fraction = 1.0;\n \t\treal_t shape_unsafe_fraction = 1.0;\n \n@@ -590,11 +590,10 @@ int JoltPhysicsDirectSpaceState3D::intersect_shape(const ShapeParameters &p_para\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"intersect_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"intersect_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -647,11 +646,10 @@ bool JoltPhysicsDirectSpaceState3D::cast_motion(const ShapeParameters &p_paramet\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tTransform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -684,11 +682,10 @@ bool JoltPhysicsDirectSpaceState3D::collide_shape(const ShapeParameters &p_param\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"collide_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"collide_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -754,11 +751,10 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -890,8 +886,8 @@ bool JoltPhysicsDirectSpaceState3D::body_test_motion(const JoltBody3D &p_body, c\n \tTransform3D transform = p_parameters.from;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, vformat(\"body_test_motion (maybe from move_and_slide?) was passed an invalid transform along with body '%s'.\", p_body.to_string()));\n \n-\tVector3 scale = transform.basis.get_scale();\n-\ttransform.basis.orthonormalize();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \n \tspace->try_optimize();\n \n", "instance_id": "godotengine__godot-103440", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with Jolt Physics in Godot when a StaticBody3D is added as a child of a VehicleWheel3D, resulting in quaternion errors. It provides specific steps to reproduce the issue, system information, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior beyond \"it should work as before,\" nor does it clarify the specific constraints or edge cases (e.g., whether this issue occurs only with specific configurations or node hierarchies). Additionally, while the error message is provided, there is no deeper explanation of why the quaternion error occurs or what specific part of the Jolt Physics integration might be at fault. These minor gaps prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes involves multiple files within the Jolt Physics module of the Godot engine, including the addition of new utility functions for matrix decomposition (`JoltMath::decompose`) and modifications to several existing classes (`JoltArea3D`, `JoltBody3D`, `JoltShapedObject3D`, `JoltPhysicsDirectSpaceState3D`). This indicates a moderate-to-high impact on the codebase, requiring an understanding of how transforms and scaling are handled across different physics objects. Second, the technical concepts involved include 3D mathematics (specifically, basis decomposition and handling of orthonormalization for transforms), integration with a third-party physics engine (Jolt Physics), and familiarity with Godot's internal architecture for physics and scene graph management. These concepts are moderately complex and require a solid grasp of linear algebra and physics engine internals. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest a need to handle invalid transforms and scaling issues (e.g., ensuring non-zero scale), which introduces some error-handling complexity. Finally, the solution impacts a critical part of the physics system, where incorrect handling of transforms could lead to broader issues in simulation accuracy or stability. Given these factors, a difficulty score of 0.65 is appropriate, reflecting a challenging problem that requires deep understanding and careful implementation but does not reach the extreme complexity of system-level or highly domain-specific issues.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Deserializing custom resource created through inspector results in parser error\n### Tested versions\n\n- Reproducible in: 4.4.beta3\n- Not reproducible in: 4.3.stable\n\n### System information\n\nGodot v4.4.beta3 - Windows 11 (build 26100) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 9 7940HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\nWhen doing `bytes_to_var_with_objects(var_to_bytes_with_objects(some_custom_resource))` where `some_custom_resource` was specifically created through the editor inspector, and not through something like `MyResource.new()`, you end up with a debugger break saying:\n\n```\nParser Error: Class \"MyResource\" hides a global script class.\n```\n\nThe exact same setup seemingly worked in 4.3-stable.\n\n### Steps to reproduce\n\n1. Open the MRP.\n2. Run the main scene.\n3. Note error.\n\n### Minimal reproduction project (MRP)\n\n[resource-serialization-error.zip](https://github.com/user-attachments/files/18710656/resource-serialization-error.zip)\n", "patch": "diff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex 8135a9b96644..aec082791ef5 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -39,6 +39,7 @@\n #include \"editor/multi_node_edit.h\"\n #include \"editor/plugins/editor_context_menu_plugin.h\"\n #include \"editor/plugins/editor_plugin.h\"\n+#include \"scene/property_utils.h\"\n #include \"scene/resources/packed_scene.h\"\n \n void EditorSelectionHistory::cleanup_history() {\n@@ -536,15 +537,18 @@ Variant EditorData::instantiate_custom_type(const String &p_type, const String &\n \t\t\tif (get_custom_types()[p_inherits][i].name == p_type) {\n \t\t\t\tRef<Script> script = get_custom_types()[p_inherits][i].script;\n \n-\t\t\t\tVariant ob = ClassDB::instantiate(p_inherits);\n-\t\t\t\tERR_FAIL_COND_V(!ob, Variant());\n+\t\t\t\t// Store in a variant to initialize the refcount if needed.\n+\t\t\t\tVariant v = ClassDB::instantiate(p_inherits);\n+\t\t\t\tERR_FAIL_COND_V(!v, Variant());\n+\t\t\t\tObject *ob = v;\n+\n \t\t\t\tNode *n = Object::cast_to<Node>(ob);\n \t\t\t\tif (n) {\n \t\t\t\t\tn->set_name(p_type);\n \t\t\t\t}\n-\t\t\t\tn->set_meta(SceneStringName(_custom_type_script), script);\n-\t\t\t\t((Object *)ob)->set_script(script);\n-\t\t\t\treturn ob;\n+\t\t\t\tPropertyUtils::assign_custom_type_script(ob, script);\n+\t\t\t\tob->set_script(script);\n+\t\t\t\treturn v;\n \t\t\t}\n \t\t}\n \t}\n@@ -988,12 +992,13 @@ Variant EditorData::script_class_instance(const String &p_class) {\n \t\tRef<Script> script = script_class_load_script(p_class);\n \t\tif (script.is_valid()) {\n \t\t\t// Store in a variant to initialize the refcount if needed.\n-\t\t\tVariant obj = ClassDB::instantiate(script->get_instance_base_type());\n-\t\t\tif (obj) {\n-\t\t\t\tObject::cast_to<Object>(obj)->set_meta(SceneStringName(_custom_type_script), script);\n-\t\t\t\tobj.operator Object *()->set_script(script);\n+\t\t\tVariant v = ClassDB::instantiate(script->get_instance_base_type());\n+\t\t\tif (v) {\n+\t\t\t\tObject *obj = v;\n+\t\t\t\tPropertyUtils::assign_custom_type_script(obj, script);\n+\t\t\t\tobj->set_script(script);\n \t\t\t}\n-\t\t\treturn obj;\n+\t\t\treturn v;\n \t\t}\n \t}\n \treturn Variant();\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 38839a8bbc61..a733e1ce4e1d 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -4751,7 +4751,7 @@ Ref<Script> EditorNode::get_object_custom_type_base(const Object *p_object) cons\n \n \tconst Node *node = Object::cast_to<const Node>(p_object);\n \tif (node && node->has_meta(SceneStringName(_custom_type_script))) {\n-\t\treturn node->get_meta(SceneStringName(_custom_type_script));\n+\t\treturn PropertyUtils::get_custom_type_script(node);\n \t}\n \n \tRef<Script> scr = p_object->get_script();\ndiff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex b46cda63c70b..2bc022f1d1cb 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -2834,7 +2834,7 @@ void SceneTreeDock::_update_script_button() {\n \t\t\tRef<Script> cts;\n \n \t\t\tif (n->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\t\tcts = n->get_meta(SceneStringName(_custom_type_script));\n+\t\t\t\tcts = PropertyUtils::get_custom_type_script(n);\n \t\t\t}\n \n \t\t\tif (selection.size() == 1) {\n@@ -3114,7 +3114,7 @@ void SceneTreeDock::_replace_node(Node *p_node, Node *p_by_node, bool p_keep_pro\n \n \t\t// If we're dealing with a custom node type, we need to create a default instance of the custom type instead of the native type for property comparison.\n \t\tif (oldnode->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\tRef<Script> cts = oldnode->get_meta(SceneStringName(_custom_type_script));\n+\t\t\tRef<Script> cts = PropertyUtils::get_custom_type_script(oldnode);\n \t\t\tdefault_oldnode = Object::cast_to<Node>(get_editor_data()->script_class_instance(cts->get_global_name()));\n \t\t\tif (default_oldnode) {\n \t\t\t\tdefault_oldnode->set_name(cts->get_global_name());\n@@ -3618,7 +3618,7 @@ void SceneTreeDock::_script_dropped(const String &p_file, NodePath p_to) {\n \t} else {\n \t\t// Check if dropped script is compatible.\n \t\tif (n->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\tRef<Script> ct_scr = n->get_meta(SceneStringName(_custom_type_script));\n+\t\t\tRef<Script> ct_scr = PropertyUtils::get_custom_type_script(n);\n \t\t\tif (!scr->inherits_script(ct_scr)) {\n \t\t\t\tString custom_type_name = ct_scr->get_global_name();\n \ndiff --git a/scene/property_utils.cpp b/scene/property_utils.cpp\nindex 9cae7d2a3a8a..dc9a56a294a9 100644\n--- a/scene/property_utils.cpp\n+++ b/scene/property_utils.cpp\n@@ -92,7 +92,7 @@ Variant PropertyUtils::get_property_default_value(const Object *p_object, const\n \t// Handle special case \"script\" property, where the default value is either null or the custom type script.\n \t// Do this only if there's no states stack cache to trace for default values.\n \tif (!p_states_stack_cache && p_property == CoreStringName(script) && p_object->has_meta(SceneStringName(_custom_type_script))) {\n-\t\tRef<Script> ct_scr = p_object->get_meta(SceneStringName(_custom_type_script));\n+\t\tRef<Script> ct_scr = get_custom_type_script(p_object);\n \t\tif (r_is_valid) {\n \t\t\t*r_is_valid = true;\n \t\t}\n@@ -282,3 +282,29 @@ Vector<SceneState::PackState> PropertyUtils::get_node_states_stack(const Node *p\n \t}\n \treturn states_stack_ret;\n }\n+\n+void PropertyUtils::assign_custom_type_script(Object *p_object, const Ref<Script> &p_script) {\n+\tERR_FAIL_NULL(p_object);\n+\tERR_FAIL_COND(p_script.is_null());\n+\n+\tconst String &path = p_script->get_path();\n+\tERR_FAIL_COND(!path.is_resource_file());\n+\n+\tResourceUID::ID script_uid = ResourceLoader::get_resource_uid(path);\n+\tif (script_uid != ResourceUID::INVALID_ID) {\n+\t\tp_object->set_meta(SceneStringName(_custom_type_script), ResourceUID::get_singleton()->id_to_text(script_uid));\n+\t}\n+}\n+\n+Ref<Script> PropertyUtils::get_custom_type_script(const Object *p_object) {\n+\tVariant custom_script = p_object->get_meta(SceneStringName(_custom_type_script));\n+#ifndef DISABLE_DEPRECATED\n+\tif (custom_script.get_type() == Variant::OBJECT) {\n+\t\t// Convert old script meta.\n+\t\tRef<Script> script_object(custom_script);\n+\t\tassign_custom_type_script(const_cast<Object *>(p_object), script_object);\n+\t\treturn script_object;\n+\t}\n+#endif\n+\treturn ResourceLoader::load(custom_script);\n+}\ndiff --git a/scene/property_utils.h b/scene/property_utils.h\nindex 0bf040ad267a..0fa532440413 100644\n--- a/scene/property_utils.h\n+++ b/scene/property_utils.h\n@@ -46,6 +46,9 @@ class PropertyUtils {\n \t// in the tree, since every owner found while traversing towards the root gets a chance\n \t// to override property values.)\n \tstatic Vector<SceneState::PackState> get_node_states_stack(const Node *p_node, const Node *p_owner = nullptr, bool *r_instantiated_by_owner = nullptr);\n+\n+\tstatic void assign_custom_type_script(Object *p_object, const Ref<Script> &p_script);\n+\tstatic Ref<Script> get_custom_type_script(const Object *p_object);\n };\n \n #endif // PROPERTY_UTILS_H\n", "instance_id": "godotengine__godot-102737", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: deserializing a custom resource created through the editor inspector in Godot v4.4.beta3 results in a parser error (\"Class 'MyResource' hides a global script class\"). It provides specific version information, system details, steps to reproduce, and a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior or the root cause of the regression between versions 4.3.stable and 4.4.beta3. Additionally, while the steps to reproduce are provided, they are quite brief (\"Run the main scene. Note error.\"), lacking detailed context about the setup or expected output. Edge cases or specific constraints related to the custom resource creation are also not mentioned. Overall, the statement is valid and mostly clear but could benefit from additional details about the intended functionality and potential edge cases.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. \n\n1. **Scope and Depth of Code Changes**: The code changes span multiple files (`editor_data.cpp`, `editor_node.cpp`, `scene_tree_dock.cpp`, `property_utils.cpp`, and `property_utils.h`) within the Godot engine, a large and complex codebase. The modifications involve replacing direct metadata access with utility functions (`PropertyUtils::get_custom_type_script` and `PropertyUtils::assign_custom_type_script`) to handle custom type scripts, indicating a need to understand interactions between editor components and resource serialization logic. While the actual lines of code changed are relatively small, the impact is significant as it touches core editor functionality and resource handling.\n\n2. **Number of Technical Concepts**: Solving this issue requires a deep understanding of several concepts, including Godot's resource serialization mechanism, custom type handling in the editor, metadata management, and script instantiation. Familiarity with Godot's internal architecture (e.g., how `ClassDB::instantiate` and `Object::set_script` interact with custom scripts) is crucial. Additionally, the changes involve handling resource UIDs and backward compatibility (as seen in the `#ifndef DISABLE_DEPRECATED` block), which adds complexity. Knowledge of C++ (Godot's primary language) and its memory management (e.g., handling `Ref<Script>` and `Variant`) is also necessary.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest several considerations, such as handling invalid or missing script paths, ensuring proper resource UID conversion, and maintaining compatibility with older metadata formats (as seen in the deprecated code path). The introduction of utility functions in `PropertyUtils` indicates a need for robust error handling (e.g., `ERR_FAIL_COND` checks) to prevent crashes or unexpected behavior during resource loading or script assignment.\n\n4. **Overall Complexity**: The issue requires a deep dive into Godot's editor and resource systems, which are non-trivial to understand without prior experience in the engine's internals. The regression between versions suggests a subtle change in behavior that might not be immediately obvious, increasing the difficulty of debugging and fixing. While the solution provided in the diff is relatively focused, implementing or verifying it without prior context would be challenging for someone unfamiliar with the codebase.\n\nGiven these factors, a difficulty score of 0.65 reflects the need for a solid understanding of the Godot engine's architecture, careful handling of cross-module interactions, and attention to potential edge cases in resource serialization. It is not at the highest end of difficulty (0.8-1.0) because the provided diff offers a clear path to resolution, and the problem does not appear to involve system-level or highly domain-specific challenges beyond the engine's scope.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Exported array in inspector has slider for array size\n### Tested versions\n\n- Reproducible in v4.4.beta.custom_build [eee39f004]\n\n### System information\n\nGodot v4.4.beta (eee39f004) - macOS Sequoia (15.3.0) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon Pro 5500 XT OpenGL Engine - Intel(R) Core(TM) i7-10700K CPU @ 3.80GHz (16 threads)\n\n### Issue description\n\nThe array size field in the editor inspector includes a slider, which is effectively useless because it has such a large range:\n\nhttps://github.com/user-attachments/assets/99cebd43-0dd0-4e40-9eba-456725123e22\n\n[In `editor/editor_properties_array_dict.cpp` at line 449, we can see that its maximum value is indeed `INT32_MAX`](https://github.com/godotengine/godot/blob/eee39f004b42a4948af90cdebedf65c34a4a4970/editor/editor_properties_array_dict.cpp#L449):\n```cpp\nsize_slider->set_max(INT32_MAX);\n```\n\nThis number is so large that even with the slider just *barely* moved off to the right, the array is being given over 5,000,000 elements. There is also noticeable lag in the editor as this is done.\n\n### Steps to reproduce\n\nCreate an exported array in a GDScript class:\n```gdscript\n@export var my_array: Array[int] = []\n```\n\nThen, attach it to a node in the editor. Select the node and expand the array, and observe the slider on the \"Size:\" field. Try to drag it, and notice that the array size becomes *very* large.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_properties_array_dict.cpp b/editor/editor_properties_array_dict.cpp\nindex 9663157ff990..93c5a70cf907 100644\n--- a/editor/editor_properties_array_dict.cpp\n+++ b/editor/editor_properties_array_dict.cpp\n@@ -447,6 +447,7 @@ void EditorPropertyArray::update_property() {\n \t\t\tsize_slider = memnew(EditorSpinSlider);\n \t\t\tsize_slider->set_step(1);\n \t\t\tsize_slider->set_max(INT32_MAX);\n+\t\t\tsize_slider->set_editing_integer(true);\n \t\t\tsize_slider->set_h_size_flags(SIZE_EXPAND_FILL);\n \t\t\tsize_slider->set_read_only(is_read_only());\n \t\t\tsize_slider->connect(SceneStringName(value_changed), callable_mp(this, &EditorPropertyArray::_length_changed));\n", "instance_id": "godotengine__godot-102392", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an exported array in the Godot editor inspector has a slider for array size with an impractically large range (up to INT32_MAX), causing usability issues and editor lag. The goal is implied\u2014to improve the usability of the slider by addressing the range issue. The input (an exported array in GDScript) and the problematic output (a slider with an enormous range) are described, along with steps to reproduce the issue. However, there are minor ambiguities: the problem statement does not explicitly specify the desired solution or constraints (e.g., what should the new maximum size be? Should there be a configurable limit?). Additionally, edge cases or performance considerations for very large arrays are not mentioned. While a code reference is provided, the expected behavior after the fix is not fully detailed. Thus, it falls into the \"Mostly Clear\" category with minor details missing.", "difficulty_explanation": "The difficulty of this problem is very low, falling into the 0.0-0.2 range. The issue is straightforward: the slider for array size in the Godot editor has an excessively large maximum value, and the provided code change suggests a minimal modification to improve usability by enabling integer editing on the slider (via `set_editing_integer(true)`). Let's break this down by the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The code change is extremely localized, affecting a single line in a single file (`editor/editor_properties_array_dict.cpp`). It does not impact the broader architecture or require understanding complex interactions between modules. The change is trivial in terms of the amount of code modified.\n\n2. **Technical Concepts Required**: The solution requires basic knowledge of C++ and familiarity with the Godot engine's editor UI components (specifically `EditorSpinSlider`). The concept of setting properties on a UI widget is fundamental and does not involve advanced language features, algorithms, or design patterns. No domain-specific knowledge beyond basic editor UI customization is needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases, and the provided code change does not address error handling or edge cases (e.g., what happens if the user inputs a very large value manually?). However, given the simplicity of the change, it is unlikely to introduce significant edge case complexity. The lag issue mentioned in the problem statement is not directly addressed by the code change, which might indicate an incomplete solution, but this does not increase the difficulty of the provided modification.\n\n4. **Overall Complexity**: The problem and solution are very easy to understand and implement. The code change is a simple tweak to an existing UI component property. Even if the provided solution (enabling integer editing) is not the final or complete fix for the usability issue, the effort required to make this change or to propose a slightly better solution (e.g., setting a reasonable maximum value for the slider) remains minimal.\n\nGiven these factors, a difficulty score of 0.15 reflects the very easy nature of the task, requiring only a basic code modification with minimal impact and no significant technical challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Can't Preload GDScript UIDs on Export Builds\n### Tested versions\n\nTested in 4.4dev5 and 4.4dev7 -- I don't think .gd files had UIDs in prior versions.\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - Vulkan (Mobile) - dedicated NVIDIA RTX A2000 8GB Laptop GPU (NVIDIA; 32.0.15.6103) - 12th Gen Intel(R) Core(TM) i7-12800H (20 threads)\n\n### Issue description\n\nPreloading a GDScript by UID works in editor builds, but does not work in exported builds.\n\nI'd expect preloading by UID to work both in-editor and post-export, or as a worst case fail in both contexts.\n\n### Steps to reproduce\n\nCreate some GDScript that does something. In a different script, preload it using its UID.\n\nThis will work in-editor but fail on export builds with `SCRIPT ERROR: Parse Error: Could not preload resource script \"uid://dn6jx08erf1cw\".`\n\n### Minimal reproduction project (MRP)\n\n[uid.zip](https://github.com/user-attachments/files/18276683/uid.zip)\nRun the MRP and you'll see some console output.\n\nExport it to EXE (with debug) and it will instead produce errors.\n", "patch": "diff --git a/modules/gdscript/gdscript_analyzer.cpp b/modules/gdscript/gdscript_analyzer.cpp\nindex 50b487059bf3..60109efc4d5b 100644\n--- a/modules/gdscript/gdscript_analyzer.cpp\n+++ b/modules/gdscript/gdscript_analyzer.cpp\n@@ -3952,8 +3952,9 @@ Ref<GDScriptParserRef> GDScriptAnalyzer::find_cached_external_parser_for_class(c\n \n Ref<GDScript> GDScriptAnalyzer::get_depended_shallow_script(const String &p_path, Error &r_error) {\n \t// To keep a local cache of the parser for resolving external nodes later.\n-\tparser->get_depended_parser_for(p_path);\n-\tRef<GDScript> scr = GDScriptCache::get_shallow_script(p_path, r_error, parser->script_path);\n+\tconst String path = ResourceUID::ensure_path(p_path);\n+\tparser->get_depended_parser_for(path);\n+\tRef<GDScript> scr = GDScriptCache::get_shallow_script(path, r_error, parser->script_path);\n \treturn scr;\n }\n \n", "instance_id": "godotengine__godot-101442", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: preloading GDScript by UID works in-editor but fails in exported builds, which is an inconsistency in behavior. The description includes the tested versions, system information, steps to reproduce, and a minimal reproduction project (MRP), which are helpful for understanding and replicating the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss the expected behavior in exported builds beyond \"it should work or fail consistently,\" nor does it mention potential edge cases or constraints related to UID handling in different build contexts. Additionally, there is no discussion of the underlying cause or hints about whether this is a parsing, caching, or resource resolution issue, which could help in assessing the scope of the fix. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of the code change is relatively small, as it involves a single modification in the `gdscript_analyzer.cpp` file, specifically in the `get_depended_shallow_script` function. The change itself is straightforward\u2014converting a path to a UID-compatible format using `ResourceUID::ensure_path` before passing it to the parser and cache. This suggests a focused bug fix rather than a broad architectural change. However, the problem requires understanding specific technical concepts, such as how GDScript UIDs are handled, the difference in behavior between editor and exported builds, and the role of `ResourceUID` in path resolution. Additionally, it involves familiarity with the Godot engine's internals, particularly the GDScript parser and caching mechanisms, which adds a layer of complexity beyond basic language features. While the code change does not appear to impact multiple modules or the broader system architecture, it does require careful consideration of potential edge cases, such as invalid or malformed UIDs, differences in path formats across platforms, or unexpected behavior in other build configurations, though these are not explicitly mentioned in the problem statement. Overall, this problem is of medium difficulty (0.45) as it requires moderate technical understanding and targeted modifications, but it does not involve extensive refactoring or deep architectural changes.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "RichTextLabel `get_visible_line_count()` does not work with `visible_characters` anymore\n### Godot version\n\n4.0.2\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\n`get_visible_line_count()` used to take `visible_characters` into account, but now the value seems ignored. Visible line count returns the value as if all characters were visible (although it returns 0 for 0).\n\n### Steps to reproduce\n\n1. Add RichTextLabel\r\n2. Put multiline text\r\n3. Set `visible_characters` to 1\r\n4. Attach this script\r\n```GDScript\r\nextends RichTextLabel\r\n\r\nfunc _process(delta: float) -> void:\r\n\tprint(get_visible_line_count())\r\n```\r\n5. Notice it doesn't print 1\n\n### Minimal reproduction project\n\nN/A\nRichTextLabel `get_visible_line_count()` does not work with `visible_characters` anymore\n### Godot version\n\n4.0.2\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\n`get_visible_line_count()` used to take `visible_characters` into account, but now the value seems ignored. Visible line count returns the value as if all characters were visible (although it returns 0 for 0).\n\n### Steps to reproduce\n\n1. Add RichTextLabel\r\n2. Put multiline text\r\n3. Set `visible_characters` to 1\r\n4. Attach this script\r\n```GDScript\r\nextends RichTextLabel\r\n\r\nfunc _process(delta: float) -> void:\r\n\tprint(get_visible_line_count())\r\n```\r\n5. Notice it doesn't print 1\n\n### Minimal reproduction project\n\nN/A\n", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex ad850b574c38..8f0add25eacd 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -820,6 +820,7 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t}\n \n \tint line_count = 0;\n+\tbool has_visible_chars = false;\n \t// Bottom margin for text clipping.\n \tfloat v_limit = theme_cache.normal_style->get_margin(SIDE_BOTTOM);\n \tSize2 ctrl_size = get_size();\n@@ -843,8 +844,6 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\tfloat length = l.text_buf->get_line_size(line).x;\n \n \t\t// Draw line.\n-\t\tline_count++;\n-\n \t\tif (rtl) {\n \t\t\toff.x = p_width - l.offset.x - width;\n \t\t\tif (!lrtl && p_frame == main) { // Skip Scrollbar.\n@@ -1290,6 +1289,7 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\t\t\t\t\tbool skip = (trim_chars && l.char_offset + glyphs[i].end > visible_characters) || (trim_glyphs_ltr && (processed_glyphs_step >= visible_glyphs)) || (trim_glyphs_rtl && (processed_glyphs_step < total_glyphs - visible_glyphs));\n \t\t\t\t\t\tif (!skip) {\n \t\t\t\t\t\t\tif (txt_visible) {\n+\t\t\t\t\t\t\t\thas_visible_chars = true;\n \t\t\t\t\t\t\t\tif (step == DRAW_STEP_TEXT) {\n \t\t\t\t\t\t\t\t\tif (frid != RID()) {\n \t\t\t\t\t\t\t\t\t\tTS->font_draw_glyph(frid, ci, glyphs[i].font_size, fx_offset + char_off, gl, font_color);\n@@ -1410,6 +1410,10 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \n \t\tr_processed_glyphs = processed_glyphs_step;\n \t\toff.y += TS->shaped_text_get_descent(rid);\n+\t\tif (has_visible_chars) {\n+\t\t\tline_count++;\n+\t\t\thas_visible_chars = false;\n+\t\t}\n \t}\n \n \treturn line_count;\n", "instance_id": "godotengine__godot-101205", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `get_visible_line_count()` method in the `RichTextLabel` class of Godot 4.0.2 no longer considers the `visible_characters` property when calculating the number of visible lines, which is a regression from previous behavior. The steps to reproduce are provided, along with a simple script to demonstrate the issue. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (it should return a line count based on visible characters) but not explicitly stated. Additionally, edge cases such as empty text, special characters, or interactions with other properties (e.g., text wrapping, font sizes) are not mentioned. While a minimal reproduction project is marked as \"N/A,\" it would have been helpful to have a concrete example or further clarification on the desired output for various inputs. Overall, the problem is understandable, but it lacks comprehensive details on edge cases and explicit expected behavior.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change is relatively focused, primarily affecting a single method (`_draw_line`) in one file (`rich_text_label.cpp`) within the Godot engine's codebase. The modification involves tracking visible characters during rendering and incrementing the line count only when visible characters are present, which requires understanding the rendering logic and glyph processing in the `RichTextLabel` class. This introduces a moderate level of complexity as it necessitates familiarity with Godot's text rendering system, including concepts like glyph processing, text shaping, and visibility constraints. The code change itself is not extensive (a few lines added/modified), but it requires careful integration into the existing rendering loop to avoid unintended side effects. Additionally, while the problem statement does not explicitly mention edge cases, the nature of text rendering implies potential challenges such as handling empty lines, partial visibility, right-to-left text, and interactions with other properties like `visible_glyphs`. These require a moderate level of attention to detail and testing. The technical concepts involved include C++ (Godot's primary language), text rendering logic, and possibly familiarity with Godot's internal APIs for text shaping (`TS` in the code). However, the problem does not appear to impact the broader system architecture or require advanced domain-specific knowledge beyond the rendering subsystem. Therefore, I assign a difficulty score of 0.45, reflecting a medium-level challenge that requires understanding specific codebase logic and handling potential edge cases, but not a deep architectural overhaul or highly complex concepts.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Icon and splash screen raw files are not included in exported project\n### Tested versions\n\n- Reproducible in 4.4.dev5\n- Not reproducible in 4.4.dev4\nRegression from #97912\n\n### System information\n\nGodot v4.4.dev7 - Arch Linux #1 SMP PREEMPT_DYNAMIC Thu, 19 Dec 2024 21:29:01 +0000 on Wayland - X11 display driver, Single-window, 1 monitor - OpenGL 3 (Compatibility) - Mesa Intel(R) Graphics (ADL GT2) - 12th Gen Intel(R) Core(TM) i5-1235U (12 threads)\n\n### Issue description\n\nIcon and splash screen files are not included in export project due to saved as UIDs in ProjectSettings. Instead, file at path uid:/<someUIDhere> is exported, but it is ignored by engine, so icon and splash screen doesn't work.\n\n### Steps to reproduce\n\n1. Set custom icon and splash screen. They will be saved in ProjectSettings as UIDs.\n2. Export project.\n3. Run project. Notice default splash screen and icon.\n\n### Minimal reproduction project (MRP)\n\n[mrp.zip](https://github.com/user-attachments/files/18272161/mrp.zip)\n1. Run in editor. Everything works.\n2. Export and run. Icon and splash don't work.\n\n", "patch": "diff --git a/editor/export/editor_export_platform.cpp b/editor/export/editor_export_platform.cpp\nindex cb496fc9f09e..1cf47f348659 100644\n--- a/editor/export/editor_export_platform.cpp\n+++ b/editor/export/editor_export_platform.cpp\n@@ -35,6 +35,7 @@\n #include \"core/extension/gdextension.h\"\n #include \"core/io/file_access_encrypted.h\"\n #include \"core/io/file_access_pack.h\" // PACK_HEADER_MAGIC, PACK_FORMAT_VERSION\n+#include \"core/io/resource_uid.h\"\n #include \"core/io/zip_io.h\"\n #include \"core/version.h\"\n #include \"editor/editor_file_system.h\"\n@@ -925,8 +926,8 @@ Vector<String> EditorExportPlatform::get_forced_export_files() {\n \n \tfiles.push_back(ProjectSettings::get_singleton()->get_global_class_list_path());\n \n-\tString icon = GLOBAL_GET(\"application/config/icon\");\n-\tString splash = GLOBAL_GET(\"application/boot_splash/image\");\n+\tString icon = ResourceUID::ensure_path(GLOBAL_GET(\"application/config/icon\"));\n+\tString splash = ResourceUID::ensure_path(GLOBAL_GET(\"application/boot_splash/image\"));\n \tif (!icon.is_empty() && FileAccess::exists(icon)) {\n \t\tfiles.push_back(icon);\n \t}\n", "instance_id": "godotengine__godot-100920", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear and provides a good overview of the issue. It describes the problem (icon and splash screen files not being included in the exported project due to being saved as UIDs), specifies the affected versions, provides system information, and includes steps to reproduce the issue along with a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the expected behavior (e.g., should the engine resolve UIDs to file paths during export?) or potential edge cases (e.g., what happens if the UID does not map to a valid file?). Additionally, there is no discussion of constraints or specific requirements for the fix. While the issue is understandable, these missing details prevent it from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is localized to a single file (`editor_export_platform.cpp`) and involves a small modification (changing two lines to use `ResourceUID::ensure_path` to resolve UIDs to file paths). The change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is minimal, making this a straightforward fix.\n\n2. **Number of Technical Concepts:** Solving this problem requires a basic understanding of the Godot engine's resource management system, specifically how UIDs are used to reference resources and how they can be resolved to file paths. The code change uses `ResourceUID::ensure_path`, which suggests familiarity with Godot's resource handling API. However, this is not a particularly complex concept for someone familiar with the engine or resource management in general. No advanced algorithms, design patterns, or domain-specific knowledge beyond the Godot framework are required.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, such as invalid UIDs or missing files. The code change includes a check (`FileAccess::exists(icon)`) to ensure the file exists before adding it to the export list, which handles one basic edge case. However, there is no indication of additional error handling or complex edge case considerations required beyond this. The simplicity of the error handling aligns with an easy difficulty level.\n\n4. **Overall Complexity:** The issue is a regression (introduced in a specific version), and the fix is a targeted adjustment to how resource paths are retrieved. It does not require deep architectural changes or extensive debugging of complex interactions within the codebase. The problem can be resolved with a clear understanding of the specific feature (exporting resources) and a small, focused code change.\n\nGiven these factors, I assign a difficulty score of 0.30, reflecting an easy problem that requires understanding some code logic and making a simple modification. It is slightly above the \"very easy\" range due to the need for familiarity with Godot's resource UID system, but it remains a relatively straightforward bug fix for a developer with moderate experience in the domain.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Adding custom camera feeds to `CameraServer` leads to crash on Linux\n### Tested versions\n\nv4.4.dev.custom_build [4364ed6cc]\n\n### System information\n\nGodot v4.4.dev (4364ed6cc) - Freedesktop SDK 24.08 (Flatpak runtime) on Wayland - Wayland display driver, Single-window, 1 monitor - Vulkan (Forward+) - dedicated AMD Radeon RX 6650 XT (RADV NAVI23) - 12th Gen Intel(R) Core(TM) i5-12500 (12 threads)\n\n### Issue description\n\nWhen a custom `CameraFeed` is added to `CameraServer` through either GDScript or GDExtension, the scene will crash with error about caller thread, then crash with signal 11:\n\n```\nERROR: Caller thread can't call this function in this node (/root). Use call_deferred() or call_thread_group() instead.\n   at: propagate_notification (scene/main/node.cpp:2523)\n```\n\n### Steps to reproduce\n\n```gdscript\nvar feed := CameraFeed.new()\n\nfunc _ready() -> void:\n\tCameraServer.add_feed(feed)\n```\n\n### Minimal reproduction project (MRP)\n\nNone\n", "patch": "diff --git a/modules/camera/camera_linux.cpp b/modules/camera/camera_linux.cpp\nindex 60217709af8c..b774d1be3554 100644\n--- a/modules/camera/camera_linux.cpp\n+++ b/modules/camera/camera_linux.cpp\n@@ -52,6 +52,9 @@ void CameraLinux::_update_devices() {\n \n \t\t\tfor (int i = feeds.size() - 1; i >= 0; i--) {\n \t\t\t\tRef<CameraFeedLinux> feed = (Ref<CameraFeedLinux>)feeds[i];\n+\t\t\t\tif (feed.is_null()) {\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n \t\t\t\tString device_name = feed->get_device_name();\n \t\t\t\tif (!_is_active(device_name)) {\n \t\t\t\t\tremove_feed(feed);\n@@ -84,6 +87,9 @@ void CameraLinux::_update_devices() {\n bool CameraLinux::_has_device(const String &p_device_name) {\n \tfor (int i = 0; i < feeds.size(); i++) {\n \t\tRef<CameraFeedLinux> feed = (Ref<CameraFeedLinux>)feeds[i];\n+\t\tif (feed.is_null()) {\n+\t\t\tcontinue;\n+\t\t}\n \t\tif (feed->get_device_name() == p_device_name) {\n \t\t\treturn true;\n \t\t}\ndiff --git a/modules/camera/camera_macos.mm b/modules/camera/camera_macos.mm\nindex bd718a0cb6c8..d242444b0b5a 100644\n--- a/modules/camera/camera_macos.mm\n+++ b/modules/camera/camera_macos.mm\n@@ -323,6 +323,9 @@ - (void)dealloc {\n \t// remove devices that are gone..\n \tfor (int i = feeds.size() - 1; i >= 0; i--) {\n \t\tRef<CameraFeedMacOS> feed = (Ref<CameraFeedMacOS>)feeds[i];\n+\t\tif (feed.is_null()) {\n+\t\t\tcontinue;\n+\t\t}\n \n \t\tif (![devices containsObject:feed->get_device()]) {\n \t\t\t// remove it from our array, this will also destroy it ;)\n@@ -334,6 +337,9 @@ - (void)dealloc {\n \t\tbool found = false;\n \t\tfor (int i = 0; i < feeds.size() && !found; i++) {\n \t\t\tRef<CameraFeedMacOS> feed = (Ref<CameraFeedMacOS>)feeds[i];\n+\t\t\tif (feed.is_null()) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n \t\t\tif (feed->get_device() == device) {\n \t\t\t\tfound = true;\n \t\t\t};\n", "instance_id": "godotengine__godot-100540", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: adding a custom `CameraFeed` to `CameraServer` causes a crash on Linux with a specific error message related to thread safety. It provides the tested version, system information, and steps to reproduce the issue using a minimal GDScript snippet. However, there are minor ambiguities and missing details. For instance, it does not specify whether the crash occurs under specific conditions (e.g., certain camera feed configurations or hardware setups) or if it affects other platforms beyond Linux. Additionally, there is no mention of expected behavior after the fix or potential edge cases to consider. The lack of a minimal reproduction project (MRP) also slightly hinders clarity, as it would help in fully understanding the context of the issue. Overall, the statement is valid and clear but lacks some minor details that could make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code changes are relatively small and localized to specific files (`camera_linux.cpp` and `camera_macos.mm`) within the camera module of what appears to be the Godot engine codebase. The modifications involve adding null checks (`feed.is_null()`) before accessing camera feed objects in loops, which suggests a straightforward fix for a potential null pointer dereference issue. The changes do not impact the broader system architecture or require extensive refactoring, and they are limited to a few lines of code across two files.\n\n2. **Clarity and Complexity of Problem Logic:** The problem's logic is not inherently complex. The crash is likely caused by attempting to access invalid or null camera feed objects, and the solution involves basic defensive programming (null checks). Understanding the issue requires some knowledge of thread safety (as hinted by the error message about caller threads), but the fix itself does not directly address threading issues.\n\n3. **Technical Concepts Involved:** The solution requires basic C++ knowledge, specifically understanding reference counting and null checks in the context of Godot's `Ref` smart pointer system. Familiarity with the Godot engine's camera module and its internal data structures (e.g., `CameraFeedLinux`, `CameraFeedMacOS`) is helpful but not overly complex for someone with moderate experience in C++ or game engine development. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic camera handling are needed.\n\n4. **Edge Cases and Error Handling:** The problem statement does not explicitly mention specific edge cases beyond the general crash scenario. The code changes introduce null checks, which are a form of error handling, but they do not address complex edge cases or require intricate logic. The fix appears to be a preventative measure against null dereferences, which is a common and straightforward error handling pattern.\n\nOverall, this problem is easy to solve for a developer with basic to intermediate C++ skills and some familiarity with the Godot engine. The changes are minimal, the concepts are not advanced, and the impact is localized. I assign a difficulty score of 0.35, slightly above the lower end of the \"Easy\" range, to account for the need to understand the specific context of Godot's camera system and the potential threading issue hinted at in the error message, which might require minor additional investigation.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "In a RichTextLabel, you can't see highlighted text when a background color wraps lines\n### Tested versions\n\n- Reproducible in v4.4.dev5.official [9e6098432] \n- Reproducible in 4.3-stable \n\n\n### System information\n\nGodot v4.4.dev5 - Windows 10.0.26100 - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (NVIDIA; 32.0.15.6614) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nIf you have a `RichTextLabel` which uses BBCode and has a `[bgcolor]` tag, you cannot always see your text selection.\n\nIn particular, if the `[bgcolor]` spans over a line break, you cannot see your selection at all.\n\nFor example with this control:\n\n![Image](https://github.com/user-attachments/assets/4c41249b-2e40-4c78-a79d-79cbe9bb19d9)\n\nIf I highlight from before the end of the line the red text is not highlighted. (The additional red on the second like does get highlighted, though.)\n\n![Image](https://github.com/user-attachments/assets/7555d8bf-1579-4a99-813d-11ad08a0d383)\n\nHere is an example where the `[bgcolor]` is mid sentence and it works fine:\n\n![Image](https://github.com/user-attachments/assets/45d56f26-dab6-44f8-9e0f-d740c88347b6)\n\n\n### Steps to reproduce\n\nI have included a MRP that demonstrates the issue. Simply start it and try to select text in the second line that goes beyond the wrap.\n\n\n\n### Minimal reproduction project (MRP)\n\n[highlight-bg-mrp.zip](https://github.com/user-attachments/files/18030106/highlight-bg-mrp.zip)\n\n", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex ea0b8cd80864..be54ef7c94ed 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -1370,6 +1370,13 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\t\t\t}\n \t\t\t}\n \t\t\t// Finish lines and boxes.\n+\t\t\tif (step == DRAW_STEP_BACKGROUND || step == DRAW_STEP_FOREGROUND) {\n+\t\t\t\tif (last_color.a > 0.0) {\n+\t\t\t\t\tVector2 rect_off = p_ofs + Vector2(box_start - theme_cache.text_highlight_h_padding, off_step.y - l_ascent - theme_cache.text_highlight_v_padding);\n+\t\t\t\t\tVector2 rect_size = Vector2(off_step.x - box_start + 2 * theme_cache.text_highlight_h_padding, l_size.y + 2 * theme_cache.text_highlight_v_padding);\n+\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_rect(ci, Rect2(rect_off, rect_size), last_color);\n+\t\t\t\t}\n+\t\t\t}\n \t\t\tif (step == DRAW_STEP_BACKGROUND) {\n \t\t\t\tif (sel_start != -1) {\n \t\t\t\t\tColor selection_bg = theme_cache.selection_color;\n@@ -1380,13 +1387,6 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n-\t\t\tif (step == DRAW_STEP_BACKGROUND || step == DRAW_STEP_FOREGROUND) {\n-\t\t\t\tif (last_color.a > 0.0) {\n-\t\t\t\t\tVector2 rect_off = p_ofs + Vector2(box_start - theme_cache.text_highlight_h_padding, off_step.y - l_ascent - theme_cache.text_highlight_v_padding);\n-\t\t\t\t\tVector2 rect_size = Vector2(off_step.x - box_start + 2 * theme_cache.text_highlight_h_padding, l_size.y + 2 * theme_cache.text_highlight_v_padding);\n-\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_rect(ci, Rect2(rect_off, rect_size), last_color);\n-\t\t\t\t}\n-\t\t\t}\n \t\t\tif (step == DRAW_STEP_TEXT) {\n \t\t\t\tif (ul_started) {\n \t\t\t\t\tul_started = false;\n", "instance_id": "godotengine__godot-100208", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the `RichTextLabel` in Godot, specifically regarding the visibility of text selection when a `[bgcolor]` tag spans over a line break. It provides context with version information, system details, and visual examples (screenshots) to illustrate the problem. Additionally, a minimal reproduction project (MRP) is included, which helps in understanding and replicating the issue. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior (e.g., how the selection should appear when spanning line breaks with background color) or mention specific edge cases beyond the line break scenario. Constraints or limitations of the rendering system that might affect the solution are also not discussed. While the issue is valid and mostly clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`rich_text_label.cpp`) and involve a small modification (reordering a block of code related to drawing background/foreground rectangles). The change does not impact the broader architecture of the system or require modifications across multiple modules. The amount of code changed is minimal, focusing on adjusting the rendering logic for background colors and selections.\n\n2. **Technical Concepts Involved**: Solving this issue requires understanding of the Godot engine's rendering pipeline, specifically how `RichTextLabel` handles drawing steps (background, foreground, text, etc.) and text selection rendering. Familiarity with C++ and the Godot API (e.g., `RenderingServer`, `canvas_item_add_rect`) is necessary, but these are relatively straightforward concepts for someone with experience in game engine development or GUI rendering. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic rendering are required.\n\n3. **Edge Cases and Error Handling**: The problem statement highlights a specific edge case (background color spanning line breaks affecting text selection visibility), and the code change addresses this by ensuring the background color rectangle is drawn in both background and foreground steps. However, no additional error handling or complex edge case logic is introduced in the provided diff. The complexity of edge cases appears limited to rendering order, which is handled by the small code adjustment.\n\n4. **Overall Complexity**: The problem requires understanding some code logic within the `RichTextLabel` class and making a simple modification to the drawing order. It does not involve deep architectural changes, performance optimizations, or intricate interactions with other parts of the codebase. The fix is essentially a reordering of existing logic to ensure proper rendering, which aligns with an \"Easy\" difficulty level.\n\nA score of 0.35 reflects that while the problem is not trivial (it requires specific knowledge of rendering in Godot), it is still a relatively straightforward bug fix for a developer familiar with the codebase or GUI rendering concepts. It does not demand advanced technical expertise or extensive modifications.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "CANARY: ALT+NUMPAD ADD is Broken\n### Windows Terminal version\n\n1.22.2334.0\n\n### Windows build number\n\n10.0.19045.4780\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nAlt+NumpadAdd pressing combination is broken since Canary build terminal-1.22.2201.0\r\nterminal-1.22.2191.0 - latest good\r\nterminal-1.22.2201.0 - broken\r\n...\r\nterminal-1.22.2334.0 - broken\r\n\r\nrun utilities for getting codes DOWN/UP VK_CODES etc\r\npress Alt key after press NumpadAdd and release NumpadAdd, press NumpadAdd and release NumpadAdd, press NumpadAdd and release NumpadAdd\n\n### Expected Behavior\n\nterminal-1.22.2191.0 - latest good:\r\n21:42:56 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:42:56 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:42:57 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n\n\n### Actual Behavior\n\nsince terminal-1.22.2201.0  to latest canary build terminal-1.22.2334.0  is broken:\r\n\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n", "patch": "diff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..e259d9ea05d 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -1539,11 +1539,24 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             auto encoding = s.encoding;\r\n             wchar_t buf[4]{};\r\n             size_t buf_len = 0;\r\n+            bool handled = true;\r\n \r\n             if (encoding == AltNumpadEncoding::Unicode)\r\n             {\r\n                 // UTF-32 -> UTF-16\r\n-                if (s.accumulator <= 0xffff)\r\n+                if (s.accumulator == 0)\r\n+                {\r\n+                    // If the user pressed Alt + VK_ADD, then released Alt, they probably didn't intend to insert a numpad character at all.\r\n+                    // Send any accumulated key events instead.\r\n+                    for (auto&& e : _altNumpadState.cachedKeyEvents)\r\n+                    {\r\n+                        handled = handled && _TrySendKeyEvent(e.vkey, e.scanCode, e.modifiers, e.keyDown);\r\n+                    }\r\n+                    // Send the alt keyup we are currently processing\r\n+                    handled = handled && _TrySendKeyEvent(vkey, scanCode, modifiers, keyDown);\r\n+                    // do not accumulate into the buffer\r\n+                }\r\n+                else if (s.accumulator <= 0xffff)\r\n                 {\r\n                     buf[buf_len++] = static_cast<uint16_t>(s.accumulator);\r\n                 }\r\n@@ -1587,7 +1600,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             }\r\n \r\n             s = {};\r\n-            return true;\r\n+            return handled;\r\n         }\r\n         // As a continuation of the above, this handles the key-down case.\r\n         if (modifiers.IsAltPressed())\r\n@@ -1601,46 +1614,49 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 SCROLLLOCK_ON |\r\n                 CAPSLOCK_ON;\r\n \r\n-            if (keyDown && (modifiers.Value() & ~permittedModifiers) == 0)\r\n+            if ((modifiers.Value() & ~permittedModifiers) == 0)\r\n             {\r\n                 auto& s = _altNumpadState;\r\n \r\n-                if (vkey == VK_ADD)\r\n-                {\r\n-                    // Alt '+' <number> is used to input Unicode code points.\r\n-                    // Every time you press + it resets the entire state\r\n-                    // in the original OS implementation as well.\r\n-                    s.encoding = AltNumpadEncoding::Unicode;\r\n-                    s.accumulator = 0;\r\n-                    s.active = true;\r\n-                }\r\n-                else if (vkey == VK_NUMPAD0 && s.encoding == AltNumpadEncoding::OEM && s.accumulator == 0)\r\n-                {\r\n-                    // Alt '0' <number> is used to input ANSI code points.\r\n-                    // Otherwise, they're OEM codepoints.\r\n-                    s.encoding = AltNumpadEncoding::ANSI;\r\n-                    s.active = true;\r\n-                }\r\n-                else\r\n+                if (keyDown)\r\n                 {\r\n-                    // Otherwise, append the pressed key to the accumulator.\r\n-                    const uint32_t base = s.encoding == AltNumpadEncoding::Unicode ? 16 : 10;\r\n-                    uint32_t add = 0xffffff;\r\n-\r\n-                    if (vkey >= VK_NUMPAD0 && vkey <= VK_NUMPAD9)\r\n+                    if (vkey == VK_ADD)\r\n                     {\r\n-                        add = vkey - VK_NUMPAD0;\r\n+                        // Alt '+' <number> is used to input Unicode code points.\r\n+                        // Every time you press + it resets the entire state\r\n+                        // in the original OS implementation as well.\r\n+                        s.encoding = AltNumpadEncoding::Unicode;\r\n+                        s.accumulator = 0;\r\n+                        s.active = true;\r\n                     }\r\n-                    else if (vkey >= 'A' && vkey <= 'F')\r\n+                    else if (vkey == VK_NUMPAD0 && s.encoding == AltNumpadEncoding::OEM && s.accumulator == 0)\r\n                     {\r\n-                        add = vkey - 'A' + 10;\r\n+                        // Alt '0' <number> is used to input ANSI code points.\r\n+                        // Otherwise, they're OEM codepoints.\r\n+                        s.encoding = AltNumpadEncoding::ANSI;\r\n+                        s.active = true;\r\n                     }\r\n-\r\n-                    // Pressing Alt + <not a number> should not activate the Alt+Numpad input, however.\r\n-                    if (add < base)\r\n+                    else\r\n                     {\r\n-                        s.accumulator = std::min(s.accumulator * base + add, 0x10FFFFu);\r\n-                        s.active = true;\r\n+                        // Otherwise, append the pressed key to the accumulator.\r\n+                        const uint32_t base = s.encoding == AltNumpadEncoding::Unicode ? 16 : 10;\r\n+                        uint32_t add = 0xffffff;\r\n+\r\n+                        if (vkey >= VK_NUMPAD0 && vkey <= VK_NUMPAD9)\r\n+                        {\r\n+                            add = vkey - VK_NUMPAD0;\r\n+                        }\r\n+                        else if (vkey >= 'A' && vkey <= 'F')\r\n+                        {\r\n+                            add = vkey - 'A' + 10;\r\n+                        }\r\n+\r\n+                        // Pressing Alt + <not a number> should not activate the Alt+Numpad input, however.\r\n+                        if (add < base)\r\n+                        {\r\n+                            s.accumulator = std::min(s.accumulator * base + add, 0x10FFFFu);\r\n+                            s.active = true;\r\n+                        }\r\n                     }\r\n                 }\r\n \r\n@@ -1648,6 +1664,8 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 // return and send the Alt key combination as per usual.\r\n                 if (s.active)\r\n                 {\r\n+                    // Cache it in case we have to emit it after alt is released\r\n+                    _altNumpadState.cachedKeyEvents.emplace_back(vkey, scanCode, modifiers, keyDown);\r\n                     return true;\r\n                 }\r\n \r\ndiff --git a/src/cascadia/TerminalControl/TermControl.h b/src/cascadia/TerminalControl/TermControl.h\nindex f60a72ea792..ab5b0a1ae78 100644\n--- a/src/cascadia/TerminalControl/TermControl.h\n+++ b/src/cascadia/TerminalControl/TermControl.h\n@@ -256,12 +256,20 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         };\r\n         struct AltNumpadState\r\n         {\r\n+            struct CachedKey\r\n+            {\r\n+                WORD vkey;\r\n+                WORD scanCode;\r\n+                ::Microsoft::Terminal::Core::ControlKeyStates modifiers;\r\n+                bool keyDown;\r\n+            };\r\n             AltNumpadEncoding encoding = AltNumpadEncoding::OEM;\r\n             uint32_t accumulator = 0;\r\n             // Checking for accumulator != 0 to see if we have an ongoing Alt+Numpad composition is insufficient.\r\n             // The state can be active, while the accumulator is 0, if the user pressed Alt+Numpad0 which enabled\r\n             // the OEM encoding mode (= active), and then pressed Numpad0 again (= accumulator is still 0).\r\n             bool active = false;\r\n+            til::small_vector<CachedKey, 4> cachedKeyEvents;\r\n         };\r\n         AltNumpadState _altNumpadState;\r\n \r\n", "instance_id": "microsoft__terminal-17774", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Alt+NumpadAdd key combination is broken in specific versions of the Windows Terminal (from 1.22.2201.0 to 1.22.2334.0). It provides detailed steps to reproduce the issue, expected behavior, and actual behavior with logs showing key event records. This helps in understanding the problem context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"broken\" means in terms of user impact or expected functionality beyond the logs (e.g., does it fail to input a character, or is it a different issue?). Additionally, edge cases or specific conditions under which the issue occurs (e.g., different keyboard layouts or system settings) are not mentioned. While the logs are helpful, a clearer explanation of the desired outcome or impact would make the statement more comprehensive. Hence, I rate it as \"Mostly Clear\" with a score of 2.", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`TermControl.cpp`) with modifications to the logic handling Alt+Numpad key combinations, and a minor structural update in `TermControl.h` to support caching key events. The changes involve around 50-60 lines of code, which is moderate in size. Second, the technical concepts required include understanding Windows-specific key event handling (e.g., `KEY_EVENT_RECORD`, virtual key codes like `VK_ADD`), state management for key combinations, and character encoding (Unicode and OEM). These concepts are not overly complex for someone familiar with Windows API and input handling, but they do require specific domain knowledge. Third, the problem involves handling edge cases, such as detecting when the user releases Alt without intending to input a numpad character, which the code addresses by caching and replaying key events. This adds some complexity to the logic. Finally, the changes do not appear to impact the broader system architecture significantly, as they are confined to input processing logic. However, a deep understanding of the existing state machine for Alt+Numpad input in the Windows Terminal codebase is necessary to ensure correctness. Given these factors\u2014a moderate scope of changes, specific but not overly advanced technical concepts, and some edge case handling\u2014I assign a difficulty score of 0.55, placing it in the medium category with a slight lean towards the higher end due to the domain-specific knowledge required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "DCS sequences split across multiple \"packets\" can be corrupted by conpty\n### Windows Terminal version\n\n1.20.10822.0\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nRun the following python script:\r\n\r\n```py\r\nimport sys\r\nimport time\r\n\r\nsys.stdout.write('\\033[37;40m\\033[2J')\r\nsys.stdout.write('\\033P2$p0;2;50;0;0/')\r\nsys.stdout.flush()\r\ntime.sleep(0.1)\r\nsys.stdout.write('0;2;0;0;0\\033\\\\')\r\n```\r\n\n\n### Expected Behavior\n\nIt should clear the screen and briefly make the background color red. It works as expected in OpenConsole.\n\n### Actual Behavior\n\nIn Windows Terminal, the background is left permanently red, and you can see the second half of the DCS sequence output on the screen: `0;2;0;0;0`.\r\n\r\nLooking at the debug tap, it appears that conpty is inserting an SGR reset sequence in the middle of the DCS stream (where the script sleeps for a bit). This seems similar to issue #16079, but that test case is now working correctly on the main branch, while this is still broken.\r\n\r\nI haven't had a chance to git bisect it, so I'm not sure if it's a regression, but I wouldn't be surprised if it was always broken in some way (although possibly not obviously so). There may also be an element of timing involved, but I can reproduce the problem consistently with the script above. \n", "patch": "diff --git a/src/renderer/vt/XtermEngine.cpp b/src/renderer/vt/XtermEngine.cpp\nindex 75fc3510fa6..b6d0c58a862 100644\n--- a/src/renderer/vt/XtermEngine.cpp\n+++ b/src/renderer/vt/XtermEngine.cpp\n@@ -37,7 +37,16 @@ XtermEngine::XtermEngine(_In_ wil::unique_hfile hPipe,\n //      the pipe.\r\n [[nodiscard]] HRESULT XtermEngine::StartPaint() noexcept\r\n {\r\n-    RETURN_IF_FAILED(VtEngine::StartPaint());\r\n+    const auto hr = VtEngine::StartPaint();\r\n+    if (hr != S_OK)\r\n+    {\r\n+        // If _noFlushOnEnd was set, and we didn't return early, it would usually\r\n+        // have been reset in the EndPaint call. But since that's not going to\r\n+        // happen now, we need to reset it here, otherwise we may mistakenly skip\r\n+        // the flush on the next frame.\r\n+        _noFlushOnEnd = false;\r\n+        return hr;\r\n+    }\r\n \r\n     _trace.TraceLastText(_lastText);\r\n \r\n@@ -83,15 +92,6 @@ XtermEngine::XtermEngine(_In_ wil::unique_hfile hPipe,\n         }\r\n     }\r\n \r\n-    if (!_quickReturn)\r\n-    {\r\n-        if (_WillWriteSingleChar())\r\n-        {\r\n-            // Don't re-enable the cursor.\r\n-            _quickReturn = true;\r\n-        }\r\n-    }\r\n-\r\n     return S_OK;\r\n }\r\n \r\ndiff --git a/src/renderer/vt/invalidate.cpp b/src/renderer/vt/invalidate.cpp\nindex 489a6b50bc1..942ba58df26 100644\n--- a/src/renderer/vt/invalidate.cpp\n+++ b/src/renderer/vt/invalidate.cpp\n@@ -75,7 +75,7 @@ CATCH_RETURN();\n     }\r\n     _skipCursor = false;\r\n \r\n-    _cursorMoved = true;\r\n+    _cursorMoved = psrRegion->origin() != _lastText;\r\n     return S_OK;\r\n }\r\n \r\ndiff --git a/src/renderer/vt/math.cpp b/src/renderer/vt/math.cpp\nindex d86e4644ca5..354ca0e9925 100644\n--- a/src/renderer/vt/math.cpp\n+++ b/src/renderer/vt/math.cpp\n@@ -52,38 +52,3 @@ void VtEngine::_OrRect(_Inout_ til::inclusive_rect* const pRectExisting, const t\n     pRectExisting->right = std::max(pRectExisting->right, pRectToOr->right);\r\n     pRectExisting->bottom = std::max(pRectExisting->bottom, pRectToOr->bottom);\r\n }\r\n-\r\n-// Method Description:\r\n-// - Returns true if the invalidated region indicates that we only need to\r\n-//      simply print text from the current cursor position. This will prevent us\r\n-//      from sending extra VT set-up/tear down sequences (?12h/l) when all we\r\n-//      need to do is print more text at the current cursor position.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - true iff only the next character is invalid\r\n-bool VtEngine::_WillWriteSingleChar() const\r\n-{\r\n-    // If there is no scroll delta, return false.\r\n-    if (til::point{ 0, 0 } != _scrollDelta)\r\n-    {\r\n-        return false;\r\n-    }\r\n-\r\n-    // If there is more than one invalid char, return false.\r\n-    if (!_invalidMap.one())\r\n-    {\r\n-        return false;\r\n-    }\r\n-\r\n-    // Get the single point at which things are invalid.\r\n-    const auto invalidPoint = _invalidMap.runs().front().origin();\r\n-\r\n-    // Either the next character to the right or the immediately previous\r\n-    //      character should follow this code path\r\n-    //      (The immediate previous character would suggest a backspace)\r\n-    auto invalidIsNext = invalidPoint == _lastText;\r\n-    auto invalidIsLast = invalidPoint == til::point{ _lastText.x - 1, _lastText.y };\r\n-\r\n-    return invalidIsNext || invalidIsLast;\r\n-}\r\ndiff --git a/src/renderer/vt/paint.cpp b/src/renderer/vt/paint.cpp\nindex af08cdd5b58..1fcb5335887 100644\n--- a/src/renderer/vt/paint.cpp\n+++ b/src/renderer/vt/paint.cpp\n@@ -20,30 +20,30 @@ using namespace Microsoft::Console::Types;\n //      HRESULT error code if painting didn't start successfully.\r\n [[nodiscard]] HRESULT VtEngine::StartPaint() noexcept\r\n {\r\n+    // When unit testing, there may be no pipe, but we still need to paint.\r\n     if (!_hFile)\r\n     {\r\n-        return S_FALSE;\r\n+        return S_OK;\r\n     }\r\n \r\n     // If we're using line renditions, and this is a full screen paint, we can\r\n     // potentially stop using them at the end of this frame.\r\n     _stopUsingLineRenditions = _usingLineRenditions && _AllIsInvalid();\r\n \r\n-    // If there's nothing to do, quick return\r\n+    // If there's nothing to do, we won't need to paint.\r\n     auto somethingToDo = _invalidMap.any() ||\r\n                          _scrollDelta != til::point{ 0, 0 } ||\r\n                          _cursorMoved ||\r\n                          _titleChanged;\r\n \r\n-    _quickReturn = !somethingToDo;\r\n-    _trace.TraceStartPaint(_quickReturn,\r\n+    _trace.TraceStartPaint(!somethingToDo,\r\n                            _invalidMap,\r\n                            _lastViewport.ToExclusive(),\r\n                            _scrollDelta,\r\n                            _cursorMoved,\r\n                            _wrappedRow);\r\n \r\n-    return _quickReturn ? S_FALSE : S_OK;\r\n+    return somethingToDo ? S_OK : S_FALSE;\r\n }\r\n \r\n // Routine Description:\r\n@@ -142,9 +142,9 @@ using namespace Microsoft::Console::Types;\n         _usingLineRenditions = true;\r\n     }\r\n     // One simple optimization is that we can skip sending the line attributes\r\n-    // when _quickReturn is true. That indicates that we're writing out a single\r\n-    // character, which should preclude there being a rendition switch.\r\n-    if (_usingLineRenditions && !_quickReturn)\r\n+    // when we're writing out a single character, which should preclude there\r\n+    // being a rendition switch.\r\n+    if (_usingLineRenditions && !_invalidMap.one())\r\n     {\r\n         RETURN_IF_FAILED(_MoveCursor({ _lastText.x, targetRow }));\r\n         switch (lineRendition)\r\ndiff --git a/src/renderer/vt/state.cpp b/src/renderer/vt/state.cpp\nindex 881fb0c2cce..f192536e3e6 100644\n--- a/src/renderer/vt/state.cpp\n+++ b/src/renderer/vt/state.cpp\n@@ -37,7 +37,6 @@ VtEngine::VtEngine(_In_ wil::unique_hfile pipe,\n     _pool(til::pmr::get_default_resource()),\r\n     _invalidMap(initialViewport.Dimensions(), false, &_pool),\r\n     _scrollDelta(0, 0),\r\n-    _quickReturn(false),\r\n     _clearedAllThisFrame(false),\r\n     _cursorMoved(false),\r\n     _resized(false),\r\ndiff --git a/src/renderer/vt/vtrenderer.hpp b/src/renderer/vt/vtrenderer.hpp\nindex 0125fe17369..b5c487fc1c0 100644\n--- a/src/renderer/vt/vtrenderer.hpp\n+++ b/src/renderer/vt/vtrenderer.hpp\n@@ -113,7 +113,6 @@ namespace Microsoft::Console::Render\n         til::point _lastText;\r\n         til::point _scrollDelta;\r\n \r\n-        bool _quickReturn;\r\n         bool _clearedAllThisFrame;\r\n         bool _cursorMoved;\r\n         bool _resized;\r\n@@ -214,8 +213,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT _RgbUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n         [[nodiscard]] HRESULT _16ColorUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n \r\n-        bool _WillWriteSingleChar() const;\r\n-\r\n         // buffer space for these two functions to build their lines\r\n         // so they don't have to alloc/free in a tight loop\r\n         std::wstring _bufferLine;\r\n", "instance_id": "microsoft__terminal-17194", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a bug in Windows Terminal where a DCS (Device Control String) sequence split across multiple packets gets corrupted by conpty, resulting in incorrect rendering behavior (permanent red background and visible sequence text). It provides a reproducible Python script, expected behavior, actual behavior, and a reference to a related issue. However, there are minor ambiguities and missing details. For instance, it does not explicitly define the root cause beyond a suspicion of conpty inserting an SGR reset sequence, nor does it clarify the exact timing or conditions under which the issue occurs beyond the provided script. Additionally, constraints or specific requirements for the fix (e.g., performance considerations or compatibility with other terminal behaviors) are not mentioned. While the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files in the Windows Terminal's VT renderer (e.g., XtermEngine.cpp, invalidate.cpp, paint.cpp, state.cpp, math.cpp, vtrenderer.hpp), indicating a need to understand and modify interactions across different components of the rendering engine. The changes involve removing or altering logic related to quick returns and single-character invalidation optimizations, which suggests a deep understanding of the rendering pipeline and cursor management is required. Second, the technical concepts involved include VT sequence handling, terminal rendering logic, and state management, which are moderately complex and specific to terminal emulation\u2014a niche domain. Third, while the problem statement does not explicitly mention edge cases, the nature of terminal emulation implies potential challenges with timing (as hinted in the description), sequence parsing, and ensuring compatibility with various input scenarios, which adds to the complexity of testing and validation. Finally, the impact of these changes appears to be significant as they affect core rendering behavior, though not necessarily the overall architecture. Given the need for a deep understanding of the codebase, the multi-file modifications, and the domain-specific knowledge required, I rate this as 0.65, leaning towards the higher end of the \"Hard\" range but not quite reaching \"Very Hard\" due to the absence of system-level or highly intricate algorithmic challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Using == on std::string causes undefined symbol: __library_export_libcalls_memcmp\nWhen I use `==` or `compare` between objects of type `std::string` the linker complains as follows:\r\n```\r\nerror: ld.lld: error: undefined symbol: __library_export_libcalls_memcmp\r\n>>> referenced by hello.cc\r\n>>>               build/cheriot/cheriot/debug/hello.compartment:()\r\n```\r\n\r\nI get this error with the following minimal example.\r\nhello.cc:\r\n```\r\n#include <compartment.h>\r\n#include <debug.hh>\r\n#include <string>\r\n\r\nusing Debug = ConditionalDebug<true, \"Hello world compartment\">;\r\n\r\n/// Thread entry point.\r\nvoid __cheri_compartment(\"hello\") say_hello()\r\n{\r\n\tstd::string first = \"first\";\r\n\tstd::string second = \"second\";\r\n\tif (first == second) {\r\n\t\tDebug::log(\"Equal!\");\r\n\t}\r\n}\r\n```\r\nxmake.lua:\r\n```\r\nset_project(\"CHERIoT Hello World\")\r\nsdkdir = \"../../sdk\"\r\nincludes(sdkdir)\r\nset_toolchains(\"cheriot-clang\")\r\n\r\noption(\"board\")\r\n    set_default(\"sail\")\r\n\r\ncompartment(\"hello\")\r\n    add_deps(\"freestanding\", \"debug\", \"string\")\r\n    add_files(\"hello.cc\")\r\n\r\nfirmware(\"hello_world\")\r\n    add_deps(\"hello\")\r\n    on_load(function(target)\r\n        target:values_set(\"board\", \"$(board)\")\r\n        target:values_set(\"threads\", {\r\n            {\r\n                compartment = \"hello\",\r\n                priority = 1,\r\n                entry_point = \"say_hello\",\r\n                stack_size = 0x300,\r\n                trusted_stack_frames = 3\r\n            }\r\n        }, {expand = false})\r\n    end)\r\n```\r\n\n", "patch": "diff --git a/sdk/include/string.h b/sdk/include/string.h\nindex 965a02b6a..2dd75f1b7 100644\n--- a/sdk/include/string.h\n+++ b/sdk/include/string.h\n@@ -6,21 +6,27 @@\n #include <stddef.h>\n #include <stdint.h>\n \n-int __cheri_libcall   memcmp(const void *str1, const void *str2, size_t count);\n-void *__cheri_libcall memcpy(void *dest, const void *src, size_t n);\n-void *__cheri_libcall memset(void *, int, size_t);\n-void *__cheri_libcall memmove(void *dest, const void *src, size_t n);\n-void *__cheri_libcall memchr(const void *, int, size_t);\n-void *__cheri_libcall memrchr(const void *, int, size_t);\n-size_t __cheri_libcall      strlen(const char *str);\n-int __cheri_libcall         strncmp(const char *s1, const char *s2, size_t n);\n-char *__cheri_libcall       strncpy(char *dest, const char *src, size_t n);\n-int __cheri_libcall         strcmp(const char *s1, const char *s2);\n-char *__cheri_libcall       strnstr(const char *haystack,\n-                                    const char *needle,\n-                                    size_t      haystackLength);\n-char *__cheri_libcall       strchr(const char *s, int c);\n-size_t __cheri_libcall      strlcpy(char *dest, const char *src, size_t n);\n+int __cheri_libcall    memcmp(const void *str1,\n+                              const void *str2,\n+                              size_t      count) __asm__(\"memcmp\");\n+void *__cheri_libcall  memcpy(void       *dest,\n+                              const void *src,\n+                              size_t      n) __asm__(\"memcpy\");\n+void *__cheri_libcall  memset(void *, int, size_t) __asm__(\"memset\");\n+void *__cheri_libcall  memmove(void       *dest,\n+                               const void *src,\n+                               size_t      n) __asm__(\"memmove\");\n+void *__cheri_libcall  memchr(const void *, int, size_t);\n+void *__cheri_libcall  memrchr(const void *, int, size_t);\n+size_t __cheri_libcall strlen(const char *str);\n+int __cheri_libcall    strncmp(const char *s1, const char *s2, size_t n);\n+char *__cheri_libcall  strncpy(char *dest, const char *src, size_t n);\n+int __cheri_libcall    strcmp(const char *s1, const char *s2);\n+char *__cheri_libcall  strnstr(const char *haystack,\n+                               const char *needle,\n+                               size_t      haystackLength);\n+char *__cheri_libcall  strchr(const char *s, int c);\n+size_t __cheri_libcall strlcpy(char *dest, const char *src, size_t n);\n \n /**\n  * Explicit bzero is a memset variant that the compiler is not permitted to\ndiff --git a/sdk/lib/freestanding/compat.S b/sdk/lib/freestanding/compat.S\nnew file mode 100644\nindex 000000000..b6b90c7b5\n--- /dev/null\n+++ b/sdk/lib/freestanding/compat.S\n@@ -0,0 +1,31 @@\n+// Copyright CHERIoT Contributors.\n+// SPDX-License-Identifier: MIT\n+\n+/**\n+ * This file contains compatibility aliases for exporting the freestanding\n+ * library functions as both mangled and unmangled symbols.\n+ */\n+\n+/**\n+ * Given a function named `function_name`, export it as a library function\n+ * named `export_function_name`.\n+ */\n+.macro EXPORT_COMPATIBILITY_ALIAS export_function_name, function_name, flags\n+\t.section .compartment_exports,\"aR\",@progbits\n+\t.type    __library_export_libcalls_\\export_function_name\\(),@object\n+\t.global  __library_export_libcalls_\\export_function_name\\()\n+    .p2align 2\n+  __library_export_libcalls_\\export_function_name\\():\n+\t.half \\function_name - __compartment_pcc_start\n+\t// Stack usage: Ignored for library exports\n+\t.byte 0\n+\t// Flags, only interrupt state is used for library exports, 0 is inherited\n+\t.byte \\flags\n+\t.size __library_export_libcalls_\\export_function_name, 40\n+\t.previous\n+.endm\n+\n+EXPORT_COMPATIBILITY_ALIAS _Z6memcmpPKvS0_j, memcmp, 3\n+EXPORT_COMPATIBILITY_ALIAS _Z6memcpyPvPKvj, memcpy, 3\n+EXPORT_COMPATIBILITY_ALIAS _Z6memsetPvij, memset, 2\n+EXPORT_COMPATIBILITY_ALIAS _Z7memmovePvPKvj, memmove, 3\ndiff --git a/sdk/lib/freestanding/memcmp.c b/sdk/lib/freestanding/memcmp.c\nindex 8f3eef9d6..9a3a5185e 100644\n--- a/sdk/lib/freestanding/memcmp.c\n+++ b/sdk/lib/freestanding/memcmp.c\n@@ -34,11 +34,12 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n /*\n  * Compare memory regions.\n  */\n-int __cheri_libcall\n+int\n memcmp(const void *s1, const void *s2, size_t n)\n {\n \tif (n != 0) {\ndiff --git a/sdk/lib/freestanding/memcpy.c b/sdk/lib/freestanding/memcpy.c\nindex 5b7c7915a..80e880a05 100644\n--- a/sdk/lib/freestanding/memcpy.c\n+++ b/sdk/lib/freestanding/memcpy.c\n@@ -45,6 +45,7 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n typedef void *word;\n \n@@ -54,7 +55,7 @@ _Static_assert((wsize & (wsize - 1)) == 0);\n \n #define wmask (wsize - 1)\n \n-void *__cheri_libcall memcpy(void *dst0, const void *src0, size_t length)\n+void *memcpy(void *dst0, const void *src0, size_t length)\n {\n \tchar *      dst = dst0;\n \tconst char *src = src0;\n@@ -119,7 +120,7 @@ void *__cheri_libcall memcpy(void *dst0, const void *src0, size_t length)\n \treturn (dst0);\n }\n \n-void *__cheri_libcall memmove(void *dst0, const void *src0, size_t length)\n+void *memmove(void *dst0, const void *src0, size_t length)\n {\n \treturn memcpy(dst0, src0, length);\n }\ndiff --git a/sdk/lib/freestanding/memset.c b/sdk/lib/freestanding/memset.c\nindex c9e4c0a31..8945d5c10 100644\n--- a/sdk/lib/freestanding/memset.c\n+++ b/sdk/lib/freestanding/memset.c\n@@ -34,11 +34,12 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n #define wsize sizeof(unsigned int)\n #define wmask (wsize - 1)\n \n-void *__cheri_libcall memset(void *dst0, int c0, size_t length)\n+void *memset(void *dst0, int c0, size_t length)\n {\n \tsize_t         t;\n \tunsigned int   c;\ndiff --git a/sdk/lib/freestanding/xmake.lua b/sdk/lib/freestanding/xmake.lua\nindex 62f10fb8f..6daf6c5ce 100644\n--- a/sdk/lib/freestanding/xmake.lua\n+++ b/sdk/lib/freestanding/xmake.lua\n@@ -1,2 +1,2 @@\n library(\"freestanding\")\n-  add_files(\"memcmp.c\", \"memcpy.c\", \"memset.c\")\n+  add_files(\"memcmp.c\", \"memcpy.c\", \"memset.c\", \"compat.S\")\n", "instance_id": "CHERIoT-Platform__cheriot-rtos-370", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: using `==` or `compare` on `std::string` results in a linker error due to an undefined symbol `__library_export_libcalls_memcmp`. The minimal example provided in `hello.cc` helps illustrate the problem context, and the error message is included, which adds clarity. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the target environment or constraints specific to the CHERIoT platform beyond the provided code snippets. Additionally, it lacks details on expected behavior or edge cases for the fix (e.g., compatibility requirements or performance considerations). While the issue is understandable, these missing pieces prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`string.h`, `memcmp.c`, `memcpy.c`, `memset.c`, `compat.S`, and `xmake.lua`), requiring modifications to both C source files and assembly code, as well as build configuration. This indicates a need to understand interactions between different parts of the codebase, including the freestanding library and the CHERIoT-specific build system. Second, the technical concepts involved are moderately advanced, including understanding C++ name mangling, linker behavior, CHERIoT-specific library export mechanisms (`__cheri_libcall` and custom assembly for compatibility aliases), and the integration of low-level memory operations with higher-level `std::string` functionality. Third, while the problem statement does not explicitly mention edge cases, the nature of the fix (removing `__cheri_libcall` annotations and adding compatibility aliases) suggests potential challenges in ensuring correctness across different calling conventions or environments, as well as maintaining compatibility with existing code. Finally, the changes impact a core part of the system (string and memory operations), which could have broader implications for the codebase, requiring careful consideration of side effects. Overall, solving this requires a deep understanding of low-level programming, platform-specific details, and cross-file modifications, justifying a difficulty score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Firestore for Mac doesn't build in CocoaPods for Xcode 15\n### Description\n\n    - NOTE  | [OSX] xcodebuild:  clang: error: SDK does not contain 'libarclite' at the path '/Applications/Xcode_15.0.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/arc/libarclite_macosx.a'; try increasing the minimum deployment target\r\n\r\nhttps://github.com/grpc/grpc/pull/36340 needs to be merged and published.\r\n\r\nThen update TODO's in firestore.yml, archive.yml, release.yml, and prerelease.yml\n\n### Reproducing the issue\n\nBuild Firestore example for macos or run pod lib lint ...\n\n### Firebase SDK Version\n\n10.24.0\n\n### Xcode Version\n\n15.3\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nFirestore\n\n### Targeted Platforms\n\nmacOS\n\n### Relevant Log Output\n\n_No response_\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/.github/workflows/archiving.yml b/.github/workflows/archiving.yml\nindex 0d8a7eeddcf..8d60f6785b4 100644\n--- a/.github/workflows/archiving.yml\n+++ b/.github/workflows/archiving.yml\n@@ -46,29 +46,7 @@ jobs:\n       matrix:\n         target: [ios, tvos, macos]\n         # These need to be on a single line or else the formatting won't validate.\n-        pod: [\"FirebaseABTesting\", \"FirebaseAuth\", \"FirebaseCore\", \"FirebaseCrashlytics\", \"FirebaseDatabase\", \"FirebaseFunctions\", \"FirebaseMessaging\", \"FirebaseRemoteConfig\", \"FirebaseStorage\"]\n-    steps:\n-    - uses: actions/checkout@v4\n-    - uses: mikehardy/buildcache-action@c87cea0ccd718971d6cc39e672c4f26815b6c126\n-      with:\n-        cache_key: pods-${{ matrix.os }}\n-    - uses: ruby/setup-ruby@v1\n-    - name: Setup Bundler\n-      run: scripts/setup_bundler.sh\n-    - name: Setup project and archive\n-      run: scripts/test_archiving.sh ${{ matrix.pod }} ${{ matrix.target }} ArchiveOutputs/${{ matrix.target }}.xcarchive\n-\n-  # TODO(#12780: Merge Firestore back into above job after https://github.com/grpc/grpc/pull/36340\n-  pods-ios-tvos-macos-cron-macos12:\n-    # Don't run on private repo.\n-    if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule')\n-\n-    runs-on: macos-12\n-    strategy:\n-      matrix:\n-        target: [ios, tvos, macos]\n-        # These need to be on a single line or else the formatting won't validate.\n-        pod: [\"FirebaseFirestore\"]\n+        pod: [\"FirebaseABTesting\", \"FirebaseAuth\", \"FirebaseCore\", \"FirebaseCrashlytics\", \"FirebaseDatabase\", \"FirebaseFirestore\", \"FirebaseFunctions\", \"FirebaseMessaging\", \"FirebaseRemoteConfig\", \"FirebaseStorage\"]\n     steps:\n     - uses: actions/checkout@v4\n     - uses: mikehardy/buildcache-action@c87cea0ccd718971d6cc39e672c4f26815b6c126\ndiff --git a/.github/workflows/firestore.yml b/.github/workflows/firestore.yml\nindex f4641697a1b..ccf74fc36cb 100644\n--- a/.github/workflows/firestore.yml\n+++ b/.github/workflows/firestore.yml\n@@ -326,8 +326,7 @@ jobs:\n     if: |\n       (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') ||\n       (github.event_name == 'pull_request' && needs.changes.outputs.changed == 'true')\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     needs: check\n \n     strategy:\ndiff --git a/.github/workflows/prerelease.yml b/.github/workflows/prerelease.yml\nindex 296fd1c554f..6453cc4960a 100644\n--- a/.github/workflows/prerelease.yml\n+++ b/.github/workflows/prerelease.yml\n@@ -17,8 +17,7 @@ jobs:\n   specs_checking:\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     env:\n       bot_token_secret: ${{ secrets.GHASecretsGPGPassphrase1 }}\n       # The SDK repo will be cloned to this dir and podspecs from\n@@ -112,8 +111,7 @@ jobs:\n     needs: [buildup_SpecsTesting_repo_FirebaseCore, specs_checking]\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     strategy:\n       fail-fast: false\n       matrix: ${{fromJson(needs.specs_checking.outputs.matrix)}}\ndiff --git a/.github/workflows/release.yml b/.github/workflows/release.yml\nindex 500cc2e82eb..0604a1de1d9 100644\n--- a/.github/workflows/release.yml\n+++ b/.github/workflows/release.yml\n@@ -19,8 +19,7 @@ jobs:\n   specs_checking:\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     env:\n       bot_token_secret: ${{ secrets.GHASecretsGPGPassphrase1 }}\n       # The SDK repo will be cloned to this dir and podspecs from\n@@ -114,8 +113,7 @@ jobs:\n     needs: [buildup_SpecsTesting_repo_FirebaseCore, specs_checking]\n     # Don't run on private repo unless it is a PR.\n     if: github.repository == 'Firebase/firebase-ios-sdk'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     strategy:\n       fail-fast: false\n       matrix: ${{fromJson(needs.specs_checking.outputs.matrix)}}\n", "instance_id": "firebase__firebase-ios-sdk-12790", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: Firestore for Mac does not build in CocoaPods with Xcode 15 due to a missing 'libarclite' in the SDK. It references a specific upstream fix in a gRPC pull request (https://github.com/grpc/grpc/pull/36340) that needs to be merged and published, and mentions updating TODOs in several workflow files. However, there are minor ambiguities and missing details. For instance, it does not explicitly describe the expected outcome after the gRPC fix is applied (e.g., will it fully resolve the build issue, or are additional steps required?). Additionally, the problem statement lacks specifics on how to verify the fix beyond updating the workflow files, and it does not mention potential edge cases or risks associated with the macOS version upgrade. Despite these minor gaps, the goal and general steps are understandable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4). The code changes provided are straightforward, primarily involving updates to GitHub Actions workflow files (firestore.yml, archive.yml, release.yml, and prerelease.yml) to remove TODO comments, update the macOS runner version from 12 to 14, and merge Firestore back into the main pod list for testing and archiving. The scope of changes is limited to configuration files and does not involve complex logic, deep architectural modifications, or extensive codebase understanding beyond familiarity with GitHub Actions syntax and the context of the build issue. The technical concepts required are minimal\u2014basic knowledge of CI/CD workflows and macOS versioning. There are no significant edge cases or error handling requirements mentioned in the problem statement or evident in the code changes, as the updates are mostly mechanical. The primary challenge lies in ensuring the upstream gRPC fix is merged and published, but this is outside the scope of the code changes provided and does not directly impact the difficulty of the modifications themselves. Therefore, a score of 0.30 reflects the simplicity of the task while acknowledging the need for some contextual understanding of the build environment.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "TextEdit Scroll Repeats Last Line and Text Pops In\n### Tested versions\n\n- Reproducible in 4.4 Stable, 4.3 Stable, 4.2.2 Stable, 4.2 Stable\n- Not Reproducible in 4.1.4 Stable\n\n### System information\n\nGodot v4.2.stable - macOS 14.5.0 - Vulkan (Forward+) - integrated Apple M1 Pro - Apple M1 Pro (10 Threads)\n\n### Issue description\n\nFor certain heights, the `TextEdit` displays text only displays when the line is fully visible, like a popping into existence effect. This also causes the last line to appear to repeat twice when scrolling down.\n\nFor one line; the following heights have issues: 15-21, 23-24, 26-29, 31-32, 34 px\n\nhttps://github.com/user-attachments/assets/82f8544a-3491-44d5-9da7-ca0a70ed694b\n\n### Steps to reproduce\n\n1. Create a scene with a TextEdit Node\n2. Set the text to \"0\"\n3. Set the size to (100, 32)\n4. Run the scene, and scroll down on the TextEdit\n\n### Minimal reproduction project (MRP)\n\n[MRP.zip](https://github.com/user-attachments/files/19400545/MRP.zip)\n", "patch": "diff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex f6f700de2a6a..8c891d08ce97 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -852,7 +852,7 @@ void TextEdit::_notification(int p_what) {\n \t\t\t}\n \n \t\t\tint first_vis_line = get_first_visible_line() - 1;\n-\t\t\tint draw_amount = visible_rows + (smooth_scroll_enabled ? 1 : 0);\n+\t\t\tint draw_amount = visible_rows + 1;\n \t\t\tdraw_amount += draw_placeholder ? placeholder_wrapped_rows.size() - 1 : get_line_wrap_count(first_vis_line + 1);\n \n \t\t\t// Draw minimap.\n@@ -4639,7 +4639,7 @@ int TextEdit::get_minimap_line_at_pos(const Point2i &p_pos) const {\n \tint minimap_visible_lines = get_minimap_visible_lines();\n \tint visible_rows = get_visible_line_count() + 1;\n \tint first_vis_line = get_first_visible_line() - 1;\n-\tint draw_amount = visible_rows + (smooth_scroll_enabled ? 1 : 0);\n+\tint draw_amount = visible_rows + 1;\n \tdraw_amount += get_line_wrap_count(first_vis_line + 1);\n \tint minimap_line_height = (minimap_char_size.y + minimap_line_spacing);\n \n@@ -8053,7 +8053,7 @@ void TextEdit::_update_scrollbars() {\n \n \tint visible_rows = get_visible_line_count();\n \tint total_rows = draw_placeholder ? placeholder_wrapped_rows.size() : get_total_visible_line_count();\n-\tif (scroll_past_end_of_file_enabled && !fit_content_height) {\n+\tif ((scroll_past_end_of_file_enabled && !fit_content_height) || visible_rows == 0) {\n \t\ttotal_rows += visible_rows - 1;\n \t}\n \n@@ -8076,7 +8076,6 @@ void TextEdit::_update_scrollbars() {\n \t\tv_scroll->set_max(total_rows + _get_visible_lines_offset());\n \t\tv_scroll->set_page(visible_rows + _get_visible_lines_offset());\n \t\tset_v_scroll(get_v_scroll());\n-\n \t} else {\n \t\tfirst_visible_line = 0;\n \t\tfirst_visible_line_wrap_ofs = 0;\n", "instance_id": "godotengine__godot-104776", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear, providing a detailed description of the issue with the `TextEdit` component in the Godot engine, including specific versions affected, system information, and steps to reproduce the issue. It also includes a minimal reproduction project (MRP) and a visual reference (GitHub attachment) to demonstrate the problem. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or desired output after the fix (e.g., how the text should appear when scrolling or what \"popping into existence\" should be replaced with). Additionally, edge cases beyond specific heights are not mentioned, which could be critical for a complete solution. Thus, while the issue is well-documented, it lacks some precision in defining the success criteria for the fix.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively small, confined to a single file (`text_edit.cpp`) with modifications to a few specific lines related to scrolling and visibility logic in the `TextEdit` class. The changes involve adjusting calculations for visible lines and scroll behavior, which suggests a focused bug fix rather than a broad architectural change. However, understanding the codebase requires familiarity with Godot's GUI rendering logic, particularly how `TextEdit` handles line drawing, scrolling, and minimap rendering, which involves non-trivial concepts like smooth scrolling and line wrapping. The technical concepts required include knowledge of GUI rendering, scroll mechanics, and potentially floating-point precision issues in pixel calculations (given the specific heights mentioned). Edge cases are partially addressed in the problem statement (specific heights causing issues), but the code changes do not explicitly handle new error conditions, though they adjust logic to prevent visual glitches. Overall, this problem requires a moderate understanding of the codebase and targeted modifications, placing it in the 0.4-0.6 range, with a score of 0.45 reflecting a slightly above-average challenge within the \"medium\" category due to the need for domain-specific GUI knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Tween] PropertyTweener with a custom interpolator always stops at the 'to' value.\n### Tested versions\n\n- Tested in 4.4 stable (probably a long standing issue)\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3050 (NVIDIA; 32.0.15.7283) - AMD Ryzen 5 4500 6-Core Processor (12 threads)\n\n### Issue description\n\nWhen tweening a property with a custom interpolator, it always set's the property to the final position after the tween finishes, rather than the value it should be at based from the custom interpolator function.\n\nExample:\n\n`func _ready() -> void:\n\ttween = create_tween()\n\ttween.tween_property(self, \"position:x, 500.0, 2.0).set_custom_interpolator(_interpolator)\n\nfunc _interpolator(time: float) -> float:\n\treturn 0.25\n`\nshould be aways at 25% of the way, but after the tween finishes, the x-position goes to 500.\n\n### Steps to reproduce\n\n- Create a function that does not return 1.0 when the input parameter is 1.0.\n- Set that function as the custom interpolator for the PropertyTweener.\n\n### Minimal reproduction project (MRP)\n\n[tween_test_2025-03-24_07-49-49.zip](https://github.com/user-attachments/files/19437132/tween_test_2025-03-24_07-49-49.zip)\n\nThis uses almost the same example given in the docs (https://docs.godotengine.org/en/stable/classes/class_propertytweener.html#class-propertytweener-method-set-custom-interpolator).\n", "patch": "diff --git a/scene/animation/tween.cpp b/scene/animation/tween.cpp\nindex 230f55de8427..db0f0e2684ba 100644\n--- a/scene/animation/tween.cpp\n+++ b/scene/animation/tween.cpp\n@@ -542,6 +542,20 @@ Tween::Tween(SceneTree *p_parent_tree) {\n \tvalid = true;\n }\n \n+double PropertyTweener::_get_custom_interpolated_value(const Variant &p_value) {\n+\tconst Variant *argptr = &p_value;\n+\n+\tVariant result;\n+\tCallable::CallError ce;\n+\tcustom_method.callp(&argptr, 1, result, ce);\n+\tif (ce.error != Callable::CallError::CALL_OK) {\n+\t\tERR_FAIL_V_MSG(false, \"Error calling custom method from PropertyTweener: \" + Variant::get_callable_error_text(custom_method, &argptr, 1, ce) + \".\");\n+\t} else if (result.get_type() != Variant::FLOAT) {\n+\t\tERR_FAIL_V_MSG(false, vformat(\"Wrong return type in PropertyTweener custom method. Expected float, got %s.\", Variant::get_type_name(result.get_type())));\n+\t}\n+\treturn result;\n+}\n+\n Ref<PropertyTweener> PropertyTweener::from(const Variant &p_value) {\n \tRef<Tween> tween = _get_tween();\n \tERR_FAIL_COND_V(tween.is_null(), nullptr);\n@@ -638,17 +652,7 @@ bool PropertyTweener::step(double &r_delta) {\n \tif (time < duration) {\n \t\tif (custom_method.is_valid()) {\n \t\t\tconst Variant t = tween->interpolate_variant(0.0, 1.0, time, duration, trans_type, ease_type);\n-\t\t\tconst Variant *argptr = &t;\n-\n-\t\t\tVariant result;\n-\t\t\tCallable::CallError ce;\n-\t\t\tcustom_method.callp(&argptr, 1, result, ce);\n-\t\t\tif (ce.error != Callable::CallError::CALL_OK) {\n-\t\t\t\tERR_FAIL_V_MSG(false, \"Error calling custom method from PropertyTweener: \" + Variant::get_callable_error_text(custom_method, &argptr, 1, ce) + \".\");\n-\t\t\t} else if (result.get_type() != Variant::FLOAT) {\n-\t\t\t\tERR_FAIL_V_MSG(false, vformat(\"Wrong return type in PropertyTweener custom method. Expected float, got %s.\", Variant::get_type_name(result.get_type())));\n-\t\t\t}\n-\n+\t\t\tdouble result = _get_custom_interpolated_value(t);\n \t\t\ttarget_instance->set_indexed(property, Animation::interpolate_variant(initial_val, final_val, result));\n \t\t} else {\n \t\t\ttarget_instance->set_indexed(property, tween->interpolate_variant(initial_val, delta_val, time, duration, trans_type, ease_type));\n@@ -656,7 +660,12 @@ bool PropertyTweener::step(double &r_delta) {\n \t\tr_delta = 0;\n \t\treturn true;\n \t} else {\n-\t\ttarget_instance->set_indexed(property, final_val);\n+\t\tif (custom_method.is_valid()) {\n+\t\t\tdouble final_t = _get_custom_interpolated_value(1.0);\n+\t\t\ttarget_instance->set_indexed(property, Animation::interpolate_variant(initial_val, final_val, final_t));\n+\t\t} else {\n+\t\t\ttarget_instance->set_indexed(property, final_val);\n+\t\t}\n \t\tr_delta = elapsed_time - delay - duration;\n \t\t_finish();\n \t\treturn false;\ndiff --git a/scene/animation/tween.h b/scene/animation/tween.h\nindex 8d4b9eae6b48..d987b6e9a867 100644\n--- a/scene/animation/tween.h\n+++ b/scene/animation/tween.h\n@@ -200,6 +200,8 @@ VARIANT_ENUM_CAST(Tween::EaseType);\n class PropertyTweener : public Tweener {\n \tGDCLASS(PropertyTweener, Tweener);\n \n+\tdouble _get_custom_interpolated_value(const Variant &p_value);\n+\n public:\n \tRef<PropertyTweener> from(const Variant &p_value);\n \tRef<PropertyTweener> from_current();\n", "instance_id": "godotengine__godot-104578", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the PropertyTweener in the Godot engine when using a custom interpolator. It provides a specific example of the problem (the interpolator returning a constant 0.25 but the property jumping to the final value of 500), steps to reproduce, and references to the documentation. Additionally, a minimal reproduction project (MRP) is provided, which aids in understanding the issue. However, there are minor ambiguities: the problem statement does not explicitly discuss expected behavior in edge cases (e.g., what should happen if the custom interpolator returns invalid values like negative numbers or values outside the expected range). It also lacks detail on whether this issue affects other types of tweening or properties beyond position. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single class (PropertyTweener) in the tween.cpp file, with minor updates to the header file. The changes involve refactoring the logic for applying the custom interpolator's final value and extracting a helper method for clarity, which is not architecturally significant but does require understanding the tweening system's internal logic. Second, the technical concepts involved include familiarity with Godot's animation system, C++ (specifically how Variants and Callables are handled), and the behavior of custom interpolators, which are moderately complex but not overly advanced. Third, the problem does not explicitly mention edge cases beyond the core issue, but the code changes do account for error handling (e.g., checking return types and callable errors), which adds a small layer of complexity. Overall, this requires understanding a specific part of the codebase and making targeted modifications, but it does not demand deep architectural changes or advanced domain knowledge, justifying a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Occlusion Culling on OpenXR is unstable (meshes flickering) in Godot4.4-stable\n### Tested versions\n\n- Reproducible in Godot v4.4-stable, Godot v4.4.1-rc1\n   - Meta Quest 3\n   - X11+SteamVR/OpenXR Vulkan (mobile and forward+)\n       - OpenXR: Running on OpenXR runtime:  SteamVR/OpenXR   2.9.6\n       - OpenXR: XrGraphicsRequirementsVulkan2KHR:\n         - minApiVersionSupported:  1.0.0\n         - maxApiVersionSupported:  1.2.0\n\n- Not Reproducible in Godot v4.3-stable\n\n### System information\n\nGodot v4.4.stable - Ubuntu 22.04.5 LTS 22.04 on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 3050 Laptop GPU - 12th Gen Intel(R) Core(TM) i7-12700H (14 threads)\n\n### Issue description\n\nhttps://github.com/user-attachments/assets/b1f55edf-e9d9-4691-80e5-fc0363f7f0fc\n\nWhen Occlusion Culling is enabled in Godot 4.4-stable some meshes are mysteriously culled. Only Reproducible when using OpenXR and `root.use_xr == true`\n\n### Steps to reproduce\n\n* Extract minimal reproduction in OpenXR\n* install [Godot Openxr vendors addon](https://github.com/GodotVR/godot_openxr_vendors/releases/) in 4_4/addons and 4_3/addons\n* Run 4_4/project.godot or 4_3/project.godot\n\n### Minimal reproduction project (MRP)\n\n[xr-ocull-broken.zip](https://github.com/user-attachments/files/19265466/xr-ocull-broken.zip)\n", "patch": "diff --git a/modules/raycast/raycast_occlusion_cull.cpp b/modules/raycast/raycast_occlusion_cull.cpp\nindex 9f95307cf1c5..88691be8a382 100644\n--- a/modules/raycast/raycast_occlusion_cull.cpp\n+++ b/modules/raycast/raycast_occlusion_cull.cpp\n@@ -525,14 +525,14 @@ void RaycastOcclusionCull::buffer_set_size(RID p_buffer, const Vector2i &p_size)\n \tbuffers[p_buffer].resize(p_size);\n }\n \n-Vector2 RaycastOcclusionCull::_jitter_half_extents(const Vector2 &p_half_extents, const Size2i &p_viewport_size) {\n+Vector2 RaycastOcclusionCull::_get_jitter(const Rect2 &p_viewport_rect, const Size2i &p_buffer_size) {\n \tif (!_jitter_enabled) {\n-\t\treturn p_half_extents;\n+\t\treturn Vector2();\n \t}\n \n \t// Prevent divide by zero when using NULL viewport.\n-\tif ((p_viewport_size.x <= 0) || (p_viewport_size.y <= 0)) {\n-\t\treturn p_half_extents;\n+\tif ((p_buffer_size.x <= 0) || (p_buffer_size.y <= 0)) {\n+\t\treturn Vector2();\n \t}\n \n \tint32_t frame = Engine::get_singleton()->get_frames_drawn();\n@@ -568,8 +568,8 @@ Vector2 RaycastOcclusionCull::_jitter_half_extents(const Vector2 &p_half_extents\n \t\t\tjitter = Vector2(0.5f, 0.5f);\n \t\t} break;\n \t}\n-\n-\tjitter *= Vector2(p_half_extents.x / (float)p_viewport_size.x, p_half_extents.y / (float)p_viewport_size.y);\n+\tVector2 half_extents = p_viewport_rect.get_size() * 0.5;\n+\tjitter *= Vector2(half_extents.x / (float)p_buffer_size.x, half_extents.y / (float)p_buffer_size.y);\n \n \t// The multiplier here determines the jitter magnitude in pixels.\n \t// It seems like a value of 0.66 matches well the above jittering pattern as it generates subpixel samples at 0, 1/3 and 2/3\n@@ -578,7 +578,16 @@ Vector2 RaycastOcclusionCull::_jitter_half_extents(const Vector2 &p_half_extents\n \t// False shown can lower percentage that are occluded, and therefore performance.\n \tjitter *= 0.66f;\n \n-\treturn p_half_extents + jitter;\n+\treturn jitter;\n+}\n+\n+Rect2 _get_viewport_rect(const Projection &p_cam_projection) {\n+\t// NOTE: This assumes a rectangular projection plane, i.e. that:\n+\t// - the matrix is a projection across z-axis (i.e. is invertible and columns[0][1], [0][3], [1][0] and [1][3] == 0)\n+\t// - the projection plane is rectangular (i.e. columns[0][2] and [1][2] == 0 if columns[2][3] != 0)\n+\tSize2 half_extents = p_cam_projection.get_viewport_half_extents();\n+\tPoint2 bottom_left = -half_extents * Vector2(p_cam_projection.columns[3][0] * p_cam_projection.columns[3][3] + p_cam_projection.columns[2][0] * p_cam_projection.columns[2][3] + 1, p_cam_projection.columns[3][1] * p_cam_projection.columns[3][3] + p_cam_projection.columns[2][1] * p_cam_projection.columns[2][3] + 1);\n+\treturn Rect2(bottom_left, 2 * half_extents);\n }\n \n void RaycastOcclusionCull::buffer_update(RID p_buffer, const Transform3D &p_cam_transform, const Projection &p_cam_projection, bool p_cam_orthogonal) {\n@@ -595,11 +604,12 @@ void RaycastOcclusionCull::buffer_update(RID p_buffer, const Transform3D &p_cam_\n \tScenario &scenario = scenarios[buffer.scenario_rid];\n \tscenario.update();\n \n-\tVector2 viewport_half = p_cam_projection.get_viewport_half_extents();\n-\tVector2 jitter_viewport_half = _jitter_half_extents(viewport_half, buffer.get_occlusion_buffer_size());\n-\tVector3 near_bottom_left = Vector3(-jitter_viewport_half.x, -jitter_viewport_half.y, -p_cam_projection.get_z_near());\n+\tRect2 vp_rect = _get_viewport_rect(p_cam_projection);\n+\tVector2 bottom_left = vp_rect.position;\n+\tbottom_left += _get_jitter(vp_rect, buffer.get_occlusion_buffer_size());\n+\tVector3 near_bottom_left = Vector3(bottom_left.x, bottom_left.y, -p_cam_projection.get_z_near());\n \n-\tbuffer.update_camera_rays(p_cam_transform, near_bottom_left, 2 * viewport_half, p_cam_projection.get_z_far(), p_cam_orthogonal);\n+\tbuffer.update_camera_rays(p_cam_transform, near_bottom_left, vp_rect.get_size(), p_cam_projection.get_z_far(), p_cam_orthogonal);\n \n \tscenario.raycast(buffer.camera_rays, buffer.camera_ray_masks.ptr(), buffer.camera_rays_tile_count);\n \tbuffer.sort_rays(-p_cam_transform.basis.get_column(2), p_cam_orthogonal);\ndiff --git a/modules/raycast/raycast_occlusion_cull.h b/modules/raycast/raycast_occlusion_cull.h\nindex a831336df53a..51c1a196eaf0 100644\n--- a/modules/raycast/raycast_occlusion_cull.h\n+++ b/modules/raycast/raycast_occlusion_cull.h\n@@ -161,7 +161,7 @@ class RaycastOcclusionCull : public RendererSceneOcclusionCull {\n \tbool _jitter_enabled = false;\n \n \tvoid _init_embree();\n-\tVector2 _jitter_half_extents(const Vector2 &p_half_extents, const Size2i &p_viewport_size);\n+\tVector2 _get_jitter(const Rect2 &p_viewport_rect, const Size2i &p_buffer_size);\n \n public:\n \tvirtual bool is_occluder(RID p_rid) override;\n", "instance_id": "godotengine__godot-104249", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue of occlusion culling instability (meshes flickering) in Godot 4.4-stable when using OpenXR. It provides specific details about the versions tested, system information, hardware used, and steps to reproduce the issue, along with a minimal reproduction project (MRP). The issue is tied to a specific feature (occlusion culling with OpenXR) and includes visual evidence via an attachment. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or desired outcome of the fix (e.g., what \"stable\" occlusion culling should look like), nor does it mention specific edge cases or constraints that might be critical to solving the issue. Additionally, the root cause of the flickering is not hypothesized or detailed, leaving some uncertainty for the developer. Overall, while the problem is reproducible and well-documented, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes, while localized to a single file (`raycast_occlusion_cull.cpp`) and its header, involves intricate modifications to the occlusion culling logic, specifically around viewport calculations and jitter handling. This suggests a deep understanding of the rendering pipeline in Godot, particularly how occlusion culling interacts with OpenXR and projection matrices. Second, the technical concepts required are advanced, including knowledge of 3D graphics (viewport projections, camera transforms, raycasting), jittering techniques for anti-aliasing or subpixel sampling, and potentially domain-specific knowledge of OpenXR and Vulkan rendering. Third, the problem likely involves subtle edge cases, such as specific projection matrix configurations or viewport sizes that could cause flickering, though these are not explicitly mentioned in the problem statement. The code changes show a refactoring of how viewport rectangles and jitter are calculated, which could have broader implications on rendering accuracy and performance, requiring careful validation. Finally, solving this issue demands familiarity with Godot's internal architecture and debugging rendering issues in a VR context, which is inherently complex. A score of 0.75 reflects the need for deep expertise in graphics programming and the codebase, combined with the potential for non-trivial debugging and testing to ensure stability across different hardware and OpenXR configurations.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Can't cycle Buttons in \"Attach Node Script'' panel with Tab/Shift+Tab\n### Tested versions\n\n- Reproduceable in Godot v4.3.stable (77dcf97d8)\n\n### System information\n\nGodot v4.3.stable (77dcf97d8) - Windows 10.0.26100 - Vulkan (Mobile) - dedicated NVIDIA GeForce GTX 1080 Ti (NVIDIA; 32.0.15.6109) - AMD Ryzen 5 3600 6-Core Processor (12 Threads)\n\n### Issue description\n\nWhen creating a new script on the \"Attach Node Script\" panel if we press tab we can select all other widgets except for \"Create\" and \"Cancel\" buttons. \n\n![Image](https://github.com/user-attachments/assets/12217652-8021-493f-99c8-cfd36789f45f)\n\n### Steps to reproduce\n\n1- Create a node (any kind)\n2- Add a New Script\n3- Notice we can't use Tab to select any of the buttons, only the rest of the properties.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/scene/gui/dialogs.cpp b/scene/gui/dialogs.cpp\nindex d09ce9d72207..a79ba285e9ad 100644\n--- a/scene/gui/dialogs.cpp\n+++ b/scene/gui/dialogs.cpp\n@@ -467,7 +467,7 @@ AcceptDialog::AcceptDialog() {\n \tmessage_label->set_anchor(SIDE_BOTTOM, Control::ANCHOR_END);\n \tadd_child(message_label, false, INTERNAL_MODE_FRONT);\n \n-\tadd_child(buttons_hbox, false, INTERNAL_MODE_FRONT);\n+\tadd_child(buttons_hbox, false, INTERNAL_MODE_BACK);\n \n \tbuttons_hbox->add_spacer();\n \tok_button = memnew(Button);\n", "instance_id": "godotengine__godot-103967", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inability to cycle through buttons in the \"Attach Node Script\" panel using Tab/Shift+Tab in Godot v4.3.stable. It provides specific steps to reproduce the issue, a relevant screenshot, and system information, which helps in understanding the context. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (i.e., the buttons should be selectable via Tab/Shift+Tab) but not explicitly stated. Additionally, there is no mention of potential edge cases or specific requirements for how the fix should behave in different scenarios (e.g., different UI configurations or accessibility settings). Overall, while the problem is understandable, it lacks some precision in defining the desired outcome and constraints, which prevents it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem is very low, as it falls into the 0.0-0.2 range. The code change provided is minimal, involving a single line modification in `dialogs.cpp` to change the internal mode of `buttons_hbox` from `INTERNAL_MODE_FRONT` to `INTERNAL_MODE_BACK`. This suggests the fix is related to the rendering or focus order of UI elements, likely a simple adjustment to ensure the buttons are included in the tab navigation cycle. The scope of the change is limited to a single file and does not appear to impact other parts of the codebase or require deep architectural understanding. The technical concepts involved are basic\u2014understanding UI layout and focus handling in Godot's GUI system, which is not particularly complex for someone familiar with GUI programming. There are no explicit edge cases or error handling requirements mentioned in the problem statement, and the code change does not introduce or modify any error handling logic. Overall, this is a straightforward bug fix that requires minimal effort and expertise to implement and verify.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Shader Materials broken when created in C# (Regression from `4.4-beta2` -> `4.4-beta3`)\n### Tested versions\n\n- The regression occurs in `4.4-beta3`, `4.4-beta4`, `4.4-rc1`.\n- The last working version is `4.4-beta2`.\n\n### System information\n\nGodot v4.4.rc1.mono - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1050 Ti (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i3-9100F CPU @ 3.60GHz (4 threads)\n\n### Issue description\n\n`ShaderMaterial` is completely bugged when created with `new` in C# starting with Godot `4.4-beta3`.\n\nHere is the code that works in `4.4-beta2` but not in `4.4-beta3` and beyond:\n\n```cs\n[Export] Shader EyesShader;\n\n// ...\n\nShaderMaterial EyesMaterial = new() {\n    Shader = EyesShader,\n};\nFaceMesh.SetSurfaceOverrideMaterial(0, EyesMaterial);\n```\n\nHere is the fix:\n\n```cs\n[Export] ShaderMaterial EyesMaterial;\n\n// ...\n\n// Create eyes material\nShaderMaterial Material = (ShaderMaterial)EyesMaterial.Duplicate();\nFaceMesh.SetSurfaceOverrideMaterial(0, Material);\n```\n\nThis is what it looks like in `4.4-beta2`:\n\n![Image](https://github.com/user-attachments/assets/209d6015-e635-46e8-831e-7e78849d994e)\n\nThis is what it looks like in `4.4-rc1` (same as `4.4-beta3` and `4.4-beta4`):\n\n![Image](https://github.com/user-attachments/assets/70b04f25-70f3-4357-8460-debbb8910b72)\n\nThe big orange eyes are created in the editor so the `ShaderMaterial` is not instantiated in C#. The blue eyes on the character are subject to the given C# code.\n\n### Steps to reproduce\n\n```cs\nShader ExampleShader;\nMeshInstance3D ExampleMeshInstance3D;\n\nExampleMeshInstance3D.SetSurfaceOverrideMaterial(0, new ShaderMaterial() {\n    Shader = ExampleShader,\n});\n```\n\n### Minimal reproduction project (MRP)\n\n[shader-material-regression.zip](https://github.com/user-attachments/files/18925757/shader-material-regression.zip)\n\nGodot `4.4-beta2`:\n\n![Image](https://github.com/user-attachments/assets/0fc78bb6-2b7b-4974-b97a-ffe80a39ebb2)\n\nGodot `4.4-rc1`:\n\n![Image](https://github.com/user-attachments/assets/bda579d8-2055-4223-81a5-e8f90854a6ed)\n", "patch": "diff --git a/servers/rendering/renderer_rd/storage_rd/material_storage.cpp b/servers/rendering/renderer_rd/storage_rd/material_storage.cpp\nindex 6008a4d38f24..34ddb2871d55 100644\n--- a/servers/rendering/renderer_rd/storage_rd/material_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/material_storage.cpp\n@@ -799,7 +799,7 @@ void MaterialStorage::MaterialData::update_uniform_buffer(const HashMap<StringNa\n \n \t\t} else if (E.value.default_value.size()) {\n \t\t\t//default value\n-\t\t\t_fill_std140_ubo_value(E.value.type, E.value.default_value, data, p_use_linear_color);\n+\t\t\t_fill_std140_ubo_value(E.value.type, E.value.default_value, data, E.value.hint == ShaderLanguage::ShaderNode::Uniform::HINT_SOURCE_COLOR && p_use_linear_color);\n \t\t\t//value=E.value.default_value;\n \t\t} else {\n \t\t\t//zero because it was not provided\n", "instance_id": "godotengine__godot-103201", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear and provides a detailed description of the issue, including the specific versions of Godot where the regression occurs, the system information, and visual evidence of the bug through images. It also includes a minimal reproduction code snippet and a reference to a reproduction project, which aids in understanding the problem. The goal is evident: to fix a regression in `ShaderMaterial` behavior when instantiated in C# starting from Godot version `4.4-beta3`. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly describe the expected behavior of `ShaderMaterial` beyond visual differences in the images, nor does it detail the root cause of the regression beyond pointing to version changes. Additionally, while a workaround is provided, the statement lacks clarity on whether the fix in the code changes is the intended solution or just a temporary patch. Constraints or edge cases (e.g., specific shader types or rendering pipelines affected) are not explicitly mentioned, which could be critical for a complete understanding.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.65, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is localized to a single line in `material_storage.cpp`, specifically modifying a condition in the `_fill_std140_ubo_value` function related to color handling (`p_use_linear_color`). While the change itself is small, it appears to be in a critical part of the rendering pipeline of the Godot engine, which suggests that understanding the impact requires deep knowledge of the rendering subsystem and material storage logic. The change likely affects how uniform buffer objects (UBOs) are populated for shaders, which could have broader implications across the codebase, even if the diff is minimal.\n\n2. **Technical Concepts Involved**: Solving this issue requires understanding several advanced concepts, including shader material handling in Godot, the rendering pipeline (specifically Vulkan and Forward+ rendering), uniform buffer object management, and color space handling (linear vs. non-linear color). Additionally, familiarity with Godot's internal architecture and how C# interop works with native components is necessary to fully grasp why the regression occurs when materials are instantiated in C#. The fix also hints at domain-specific knowledge of graphics programming, particularly around color hints in shaders.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the nature of the bug (related to rendering and color handling) implies potential complexities in edge cases such as different shader configurations, rendering backends, or hardware-specific behaviors. The code change itself does not introduce new error handling but modifies existing logic, which could have subtle downstream effects that need to be tested across various scenarios (e.g., different GPUs or shader types). Understanding and validating the fix likely requires comprehensive testing beyond the provided minimal reproduction project.\n\n4. **Overall Complexity**: While the code change is small, the difficulty lies in diagnosing the root cause of the regression and ensuring the fix does not introduce new issues in the rendering pipeline. This requires a deep understanding of Godot's internals, graphics programming, and potentially debugging across C# and C++ layers of the engine. The problem's impact on a core feature (shader materials) and its regression nature across multiple versions further elevate the difficulty, as it may involve bisecting commits or analyzing changelog differences between `4.4-beta2` and `4.4-beta3`.\n\nIn summary, this problem is challenging due to the need for specialized knowledge in graphics and engine internals, even though the code change itself is minimal. It falls short of \"Very Hard\" (0.8-1.0) because it does not appear to require extensive refactoring or system-level redesign, but it is still a complex issue that demands significant expertise.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Playing many audio samples causes ever increasing cpu usage in web export\n### Tested versions\n\nv4.4.beta2.official [a013481b0]\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 26100) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nIn web export of my game after playing for a while, the audio starts to crackle. I think I narrowed it down to playing lots of audio samples over time. Even thought the audio samples are short and finish quickly, the cpu usage goes up over time and does not come back down. \n\n\n### Steps to reproduce\n\nI've attached a simple project that plays 100 audio samples each time the 'play' button is pressed.\n\nExport MRP as a no-thread web app. Open in Chrome or Firefox and open the browser's task manager. \nFind WebAudioTest task and note CPU usage (starts low - a few % on my computer)\nClick the play button a bunch of times. CPU starts increasing and doesn't drop again.\nEventually CPU usage becomes so high that audio starts to crackle as well.\n\nMRP also includes a short python script to start a local server:\nD:\\...\\webaudiotest>python server.py \n\n### Minimal reproduction project (MRP)\n\n[webaudiotest.zip](https://github.com/user-attachments/files/18698995/webaudiotest.zip)\n", "patch": "diff --git a/platform/web/js/libs/audio.position.worklet.js b/platform/web/js/libs/audio.position.worklet.js\nindex 7dbeb8a0adde..155d4e6e8765 100644\n--- a/platform/web/js/libs/audio.position.worklet.js\n+++ b/platform/web/js/libs/audio.position.worklet.js\n@@ -35,16 +35,20 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\tsuper(...args);\n \t\tthis.lastPostTime = currentTime;\n \t\tthis.position = 0;\n+\t\tthis.ended = false;\n \n \t\tthis.port.onmessage = (event) => {\n-\t\t\tif (event?.data?.type === 'clear') {\n-\t\t\t\tthis.lastPostTime = currentTime;\n-\t\t\t\tthis.position = 0;\n+\t\t\tif (event?.data?.type === 'ended') {\n+\t\t\t\tthis.ended = true;\n \t\t\t}\n \t\t};\n \t}\n \n \tprocess(inputs, _outputs, _parameters) {\n+\t\tif (this.ended) {\n+\t\t\treturn false;\n+\t\t}\n+\n \t\tif (inputs.length > 0) {\n \t\t\tconst input = inputs[0];\n \t\t\tif (input.length > 0) {\n@@ -55,7 +59,7 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\t// Posting messages is expensive. Let's limit the number of posts.\n \t\tif (currentTime - this.lastPostTime > POST_THRESHOLD_S) {\n \t\t\tthis.lastPostTime = currentTime;\n-\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n+\t\t\tthis.port.postMessage({ type: 'position', data: this.position });\n \t\t}\n \n \t\treturn true;\ndiff --git a/platform/web/js/libs/library_godot_audio.js b/platform/web/js/libs/library_godot_audio.js\nindex c5fa7d5f0fad..d04862795308 100644\n--- a/platform/web/js/libs/library_godot_audio.js\n+++ b/platform/web/js/libs/library_godot_audio.js\n@@ -621,28 +621,24 @@ class SampleNode {\n \t\tif (this.isCanceled) {\n \t\t\treturn;\n \t\t}\n-\t\tthis.getPositionWorklet();\n-\t\tthis._source.connect(this._positionWorklet);\n+\t\tthis._source.connect(this.getPositionWorklet());\n \t\tif (start) {\n \t\t\tthis.start();\n \t\t}\n \t}\n \n \t/**\n-\t * Get a AudioWorkletProcessor from the pool, or create one if no processor is available.\n+\t * Get a AudioWorkletProcessor\n+\t * @returns {AudioWorkletNode}\n \t */\n \tgetPositionWorklet() {\n \t\tif (this._positionWorklet != null) {\n-\t\t\treturn;\n-\t\t}\n-\t\tif (GodotAudio.audioPositionWorkletPool.length == 0) {\n-\t\t\tthis._positionWorklet = new AudioWorkletNode(\n-\t\t\t\tGodotAudio.ctx,\n-\t\t\t\t'godot-position-reporting-processor'\n-\t\t\t);\n-\t\t} else {\n-\t\t\tthis._positionWorklet = GodotAudio.audioPositionWorkletPool.pop();\n+\t\t\treturn this._positionWorklet;\n \t\t}\n+\t\tthis._positionWorklet = new AudioWorkletNode(\n+\t\t\tGodotAudio.ctx,\n+\t\t\t'godot-position-reporting-processor'\n+\t\t);\n \t\tthis._positionWorklet.port.onmessage = (event) => {\n \t\t\tswitch (event.data['type']) {\n \t\t\tcase 'position':\n@@ -652,6 +648,7 @@ class SampleNode {\n \t\t\t\t// Do nothing.\n \t\t\t}\n \t\t};\n+\t\treturn this._positionWorklet;\n \t}\n \n \t/**\n@@ -681,8 +678,7 @@ class SampleNode {\n \t\tif (this._positionWorklet) {\n \t\t\tthis._positionWorklet.disconnect();\n \t\t\tthis._positionWorklet.port.onmessage = null;\n-\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n-\t\t\tGodotAudio.audioPositionWorkletPool.push(this._positionWorklet);\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'ended' });\n \t\t\tthis._positionWorklet = null;\n \t\t}\n \n@@ -1199,7 +1195,6 @@ const _GodotAudio = {\n \n \t\t/** @type {Promise} */\n \t\taudioPositionWorkletPromise: null,\n-\t\taudioPositionWorkletPool: [],\n \n \t\t/**\n \t\t * Converts linear volume to Db.\n", "instance_id": "godotengine__godot-102715", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: increasing CPU usage over time in a web export of a game when playing multiple audio samples, leading to audio crackling. It provides specific details such as the tested version of Godot, system information, steps to reproduce, and even a minimal reproduction project (MRP). This makes the issue reproducible and understandable. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should CPU usage return to baseline after audio samples finish playing?) or constraints (e.g., acceptable CPU usage thresholds). Additionally, edge cases or specific conditions under which the issue is more pronounced (e.g., specific audio formats, sample lengths, or browser configurations beyond Chrome/Firefox) are not mentioned. While the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes involves modifications across two files in the Godot engine's web platform audio subsystem (`audio.position.worklet.js` and `library_godot_audio.js`), indicating a need to understand interactions between audio processing components. The changes, while not extensive in terms of lines of code, impact critical functionality related to audio worklet management and resource cleanup, which can affect the system's performance and stability. Second, the technical concepts required include familiarity with Web Audio API, AudioWorkletProcessor, and JavaScript's event messaging system, as well as an understanding of resource pooling (which is being removed in the changes) and its implications on performance. These are moderately advanced concepts, especially in the context of real-time audio processing in a browser environment. Third, the problem inherently deals with performance optimization (CPU usage over time), which often involves subtle bugs and requires careful consideration of resource lifecycle management (e.g., properly terminating audio worklets to prevent leaks). While the code changes provided address the issue by removing a pooling mechanism and adding an explicit \"ended\" state to stop processing, understanding why this fixes the issue and ensuring it doesn't introduce regressions requires a deep dive into the audio processing pipeline. Edge cases, such as handling multiple simultaneous audio samples or browser-specific behaviors, are not explicitly mentioned but are implied given the nature of the issue, adding to the complexity. Overall, this problem requires a solid understanding of the codebase and careful handling of performance-critical components, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "'@icon' not inheriting\n### Tested versions\n\nv4.4.beta3.official [06acfccf8] - issue is present\nv4.4.beta2.official [a013481b0] - issue is NOT present. This is a recent issue.\n\n### System information\n\nGodot v4.4.beta3 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Mobile) - dedicated AMD Radeon RX 6600 (Advanced Micro Devices, Inc.; 32.0.11027.2001) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nA script of mine uses `@icon(\"res://editor/icons/base_scene.svg\")` to give it a custom icon in the editor. There are other scripts which `extend` this script, which, previously, also showed this icon, without needing to specify it themselves in every script file.\n\nThis is no longer the case, with the child scripts now using the default icon.\n\n![Image](https://github.com/user-attachments/assets/db535219-b27a-47db-9b84-0ccf7acdcd9a)\n(`base_scene` is a `BaseScene` script, showing the icon correctly. `factory_spawn` is a `BaseFactoryScene` script, which `extends BaseScene`, yet it does NOT show the icon correctly)\n\n### Steps to reproduce\n\n1. Set a custom `@icon` on a class.\n2. Extend that class.\n3. Note that the extended class ignores the icon.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex f31e6aba4169..8135a9b96644 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -1023,7 +1023,7 @@ String EditorData::script_class_get_icon_path(const String &p_class, bool *r_val\n \t\t\treturn String();\n \t\t}\n \t\tHashMap<StringName, String>::ConstIterator E = _script_class_icon_paths.find(current);\n-\t\tif ((bool)E) {\n+\t\tif ((bool)E && !E->value.is_empty()) {\n \t\t\tif (r_valid) {\n \t\t\t\t*r_valid = true;\n \t\t\t}\n", "instance_id": "godotengine__godot-102572", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a custom icon set via `@icon` in a base script is not being inherited by child scripts that extend it, which is a regression from a previous version. The description includes the affected and unaffected versions, system information, steps to reproduce, and a visual example to illustrate the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether this behavior is expected or a bug (though it implies a bug due to the regression). Additionally, there are no details about potential edge cases (e.g., specific script structures or icon file formats that might affect the behavior) or constraints on the solution. While a minimal reproduction project (MRP) is marked as \"N/A,\" providing one could have further clarified the issue. Overall, the statement is valid and clear but lacks some minor details for full comprehensiveness.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). The code change provided is minimal, involving a single line modification in `editor_data.cpp` to add a condition (`!E->value.is_empty()`) to ensure that an icon path is only considered valid if it is non-empty. This suggests the issue is a simple bug fix related to how icon paths are handled in the editor data. The scope of the change is limited to a single file and a specific function, with no apparent impact on the broader system architecture or interactions between modules. The technical concepts involved are straightforward, requiring only basic understanding of C++ (specifically, conditional logic and string handling) and familiarity with the Godot engine's editor data structure. There are no complex algorithms, design patterns, or domain-specific knowledge required beyond what a typical contributor to the Godot engine would already know. Edge cases and error handling do not appear to be significant concerns based on the problem statement or the code change, as the fix is narrowly focused on a specific condition check. Overall, this is a simple bug fix that requires minimal effort and understanding to implement and verify.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Inspector size wrong after switching between scenes\n### Tested versions\n\nGodot 4.4.beta2\n\nNot happening in 4.4.dev4\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nIf you scroll down in the inspector and then switch to another scene and back the inspector will not have correct size and scrollbar anymore. \n\nhttps://github.com/user-attachments/assets/07da0f72-224b-4f67-a022-2e9f4b4ee85b\n\nyou can also see in the video that the scrollbar is wrongly shown in the inspector of the other scene.\n\n### Steps to reproduce\n\n^\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex b79d1243ba6c..97335821374e 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -4138,7 +4138,8 @@ void EditorInspector::expand_revertable() {\n }\n \n void EditorInspector::set_scroll_offset(int p_offset) {\n-\tset_v_scroll(p_offset);\n+\t// This can be called before the container finishes sorting its children, so defer it.\n+\tcallable_mp((ScrollContainer *)this, &ScrollContainer::set_v_scroll).call_deferred(p_offset);\n }\n \n int EditorInspector::get_scroll_offset() const {\n", "instance_id": "godotengine__godot-102379", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inspector's size and scrollbar behave incorrectly after switching between scenes in Godot 4.4.beta2. It provides context about the tested versions, system information, and a visual reference (video attachment) to illustrate the bug. However, there are minor ambiguities and missing details. For instance, the \"Steps to reproduce\" section is not explicitly detailed (it just references the video with a caret symbol \"^\"), which could make it harder for someone without access to the video to replicate the issue. Additionally, there are no explicit mentions of expected behavior or specific constraints (e.g., does this happen only under certain conditions or UI configurations?). While the issue is understandable, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, confined to a single line in a single file (`editor_inspector.cpp`). It replaces a direct call to `set_v_scroll()` with a deferred call using `callable_mp` and `call_deferred`. This suggests the fix is localized and does not impact the broader architecture or multiple modules. The change does not require extensive understanding of the entire codebase, only the specific behavior of the `EditorInspector` class and its scroll handling.\n\n2. **Technical Concepts Involved**: The solution requires understanding of Godot's internal API, specifically the `call_deferred` mechanism, which is used to delay execution of a method until a safe time (likely after the container finishes sorting its children, as noted in the comment). This is a moderately advanced concept in Godot but not overly complex for someone familiar with event-driven or deferred execution patterns. No advanced algorithms, design patterns, or domain-specific knowledge beyond Godot's editor UI system are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases or error conditions beyond the general issue of incorrect inspector sizing and scrollbar behavior. The code change itself does not introduce new error handling logic; it simply adjusts the timing of an existing operation to prevent a UI glitch. The complexity of edge cases appears minimal based on the provided information.\n\n4. **Overall Complexity**: The fix is straightforward, addressing a timing issue in the UI rendering or update cycle. It does not require deep architectural changes, performance optimizations, or extensive debugging of complex interactions. The comment in the code change (\"This can be called before the container finishes sorting its children, so defer it\") indicates a clear understanding of the root cause, further reducing the difficulty of implementing or verifying the solution.\n\nGiven these points, a difficulty score of 0.30 reflects an easy problem that requires some understanding of Godot's internals and a simple, targeted code modification. It is not a trivial typo fix (which would be closer to 0.0-0.2), but it also does not approach the complexity of medium or hard problems involving multiple files or intricate logic.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Potential problem in look_at()\n### Godot version\n\n3.3.2.stable.official\n\n### System information\n\nmacOS 11.3.1 GLES3\n\n### Issue description\n\nWhen using the `look_at()` function in a script attached to a camera, there seems to be some sort of discretization effect occurring in my tests; for a camera positioned at e.g. `(0,90,0)` looking towards `(0,0,0)`, I see rendering artifacts. These artifacts persist for a small region around `(0,0,0)` on the `x,z` plane (approx. +/- 0.1 units).\r\n\r\nThis effect is particularly jarring when it manifests as part of an animated movement, producing an effect almost like a magnet snapping the camera view direction onto the target location at `(0,0,0)`.\r\n\r\nI've attached an example project to demonstrate this effect; a camera is located at `(0,90,0)` above a simple plane, and the `look_at()` method is invoked in the camera's `_process()` method. The target position is slowly moved left and right via a `sin()` function, and the effect is visible when the camera looks in the vicinity of `(0,0,0)`.\r\n\r\nAm I missing something important, here?\n\n### Steps to reproduce\n\nSee issue description, and attached project file.\n\n### Minimal reproduction project\n\n[Weird.zip](https://github.com/godotengine/godot/files/6697007/Weird.zip)\r\n\n", "patch": "diff --git a/core/math/basis.cpp b/core/math/basis.cpp\nindex e5f3431eef84..18959f3c0162 100644\n--- a/core/math/basis.cpp\n+++ b/core/math/basis.cpp\n@@ -455,6 +455,11 @@ void Basis::get_rotation_axis_angle_local(Vector3 &p_axis, real_t &p_angle) cons\n }\n \n Vector3 Basis::get_euler(EulerOrder p_order) const {\n+\t// This epsilon value results in angles within a +/- 0.04 degree range being simplified/truncated.\n+\t// Based on testing, this is the largest the epsilon can be without the angle truncation becoming\n+\t// visually noticeable.\n+\tconst real_t epsilon = 0.00000025;\n+\n \tswitch (p_order) {\n \t\tcase EulerOrder::XYZ: {\n \t\t\t// Euler angles in XYZ convention.\n@@ -466,8 +471,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sy = rows[0][2];\n-\t\t\tif (sy < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sy > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sy < (1.0f - epsilon)) {\n+\t\t\t\tif (sy > -(1.0f - epsilon)) {\n \t\t\t\t\t// is this a pure Y rotation?\n \t\t\t\t\tif (rows[1][0] == 0 && rows[0][1] == 0 && rows[1][2] == 0 && rows[2][1] == 0 && rows[1][1] == 1) {\n \t\t\t\t\t\t// return the simplest form (human friendlier in editor and scripts)\n@@ -501,8 +506,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sz = rows[0][1];\n-\t\t\tif (sz < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sz > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sz < (1.0f - epsilon)) {\n+\t\t\t\tif (sz > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(rows[2][1], rows[1][1]);\n \t\t\t\t\teuler.y = Math::atan2(rows[0][2], rows[0][0]);\n \t\t\t\t\teuler.z = Math::asin(-sz);\n@@ -532,8 +537,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\treal_t m12 = rows[1][2];\n \n-\t\t\tif (m12 < (1 - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (m12 > -(1 - (real_t)CMP_EPSILON)) {\n+\t\t\tif (m12 < (1 - epsilon)) {\n+\t\t\t\tif (m12 > -(1 - epsilon)) {\n \t\t\t\t\t// is this a pure X rotation?\n \t\t\t\t\tif (rows[1][0] == 0 && rows[0][1] == 0 && rows[0][2] == 0 && rows[2][0] == 0 && rows[0][0] == 1) {\n \t\t\t\t\t\t// return the simplest form (human friendlier in editor and scripts)\n@@ -568,8 +573,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sz = rows[1][0];\n-\t\t\tif (sz < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sz > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sz < (1.0f - epsilon)) {\n+\t\t\t\tif (sz > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(-rows[1][2], rows[1][1]);\n \t\t\t\t\teuler.y = Math::atan2(-rows[2][0], rows[0][0]);\n \t\t\t\t\teuler.z = Math::asin(sz);\n@@ -596,8 +601,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \t\t\t//        -cx*sy            sx                    cx*cy\n \t\t\tVector3 euler;\n \t\t\treal_t sx = rows[2][1];\n-\t\t\tif (sx < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sx > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sx < (1.0f - epsilon)) {\n+\t\t\t\tif (sx > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::asin(sx);\n \t\t\t\t\teuler.y = Math::atan2(-rows[2][0], rows[2][2]);\n \t\t\t\t\teuler.z = Math::atan2(-rows[0][1], rows[1][1]);\n@@ -624,8 +629,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \t\t\t//        -sy               cy*sx                 cy*cx\n \t\t\tVector3 euler;\n \t\t\treal_t sy = rows[2][0];\n-\t\t\tif (sy < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sy > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sy < (1.0f - epsilon)) {\n+\t\t\t\tif (sy > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(rows[2][1], rows[2][2]);\n \t\t\t\t\teuler.y = Math::asin(-sy);\n \t\t\t\t\teuler.z = Math::atan2(rows[1][0], rows[0][0]);\n", "instance_id": "godotengine__godot-102144", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the `look_at()` function in the Godot engine, specifically highlighting a discretization effect causing rendering artifacts when a camera looks towards certain positions (e.g., near (0,0,0)). The description includes the context of the issue (camera positioning and movement), the environment (Godot version, macOS, GLES3), and steps to reproduce with an attached minimal reproduction project. However, there are minor ambiguities: the exact nature of the \"discretization effect\" and \"rendering artifacts\" is not fully detailed (e.g., visual description or expected vs. actual behavior), and the problem statement does not explicitly define the desired outcome or constraints for a fix. Additionally, edge cases or specific conditions under which the issue occurs are only vaguely mentioned (e.g., \"small region around (0,0,0)\"). Thus, while the issue is valid and mostly clear, it lacks some precision and detail that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is relatively focused, primarily affecting the `get_euler()` method in `basis.cpp`, which is a core math component of the Godot engine. However, the change involves adjusting a critical constant (`epsilon`) that impacts how Euler angles are computed across multiple rotation orders, potentially affecting camera behavior globally. This requires a deep understanding of the codebase's math library and its implications on rendering and camera systems. Second, the technical concepts involved are moderately complex, including 3D mathematics (rotation matrices, Euler angles), floating-point precision issues, and their visual impact on rendering. Third, while the code change itself is small (replacing a constant and updating condition checks), determining the appropriate `epsilon` value (0.00000025) required empirical testing and a nuanced understanding of trade-offs between precision and visual smoothness, as noted in the code comments. Finally, edge cases are implicitly critical here\u2014small deviations near specific points like (0,0,0) cause noticeable artifacts, and the fix must balance avoiding truncation while maintaining stability across various camera positions and movements. This problem does not reach \"Very Hard\" as it does not involve system-wide refactoring or advanced domain-specific knowledge beyond 3D math, but it still demands significant expertise in the Godot engine's internals and careful tuning, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4beta1] Script modification of CanvasTexture doesn't update\n### Tested versions\n\nv4.4.beta1.official [d33da79d3]\n\n### System information\n\nGodot v4.4.beta1 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Mobile) - dedicated AMD Radeon RX 6600 (Advanced Micro Devices, Inc.; 32.0.11027.1003) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nAltering the `.diffuse_texture` of a CanvasTexture at runtime via script causes no visual update. This causes my player character to no longer turn around.\n\n### Steps to reproduce\n\nModify the `.diffuse_texture` of a CanvasTexture via script. It doesn't change visually.\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/EmilyV99/godot-bug-examples/tree/texture-diffuse-mrp\n\nPressing left/right changes the diffuse texture to face the pressed direction. Nothing happens at all visually.\n", "patch": "diff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 02e2486fb9c9..de376599de4c 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -2971,8 +2971,23 @@ void RendererCanvasRenderRD::_uniform_set_invalidation_callback(void *p_userdata\n \tstatic_cast<RendererCanvasRenderRD *>(singleton)->rid_set_to_uniform_set.erase(*key);\n }\n \n+void RendererCanvasRenderRD::_canvas_texture_invalidation_callback(bool p_deleted, void *p_userdata) {\n+\tKeyValue<RID, TightLocalVector<RID>> *kv = static_cast<KeyValue<RID, TightLocalVector<RID>> *>(p_userdata);\n+\tRD *rd = RD::get_singleton();\n+\tfor (RID rid : kv->value) {\n+\t\t// the invalidation callback will take care of clearing rid_set_to_uniform_set cache also\n+\t\trd->free(rid);\n+\t}\n+\tkv->value.clear();\n+\tif (p_deleted) {\n+\t\tstatic_cast<RendererCanvasRenderRD *>(singleton)->canvas_texture_to_uniform_set.erase(kv->key);\n+\t}\n+}\n+\n void RendererCanvasRenderRD::_render_batch(RD::DrawListID p_draw_list, CanvasShaderData *p_shader_data, RenderingDevice::FramebufferFormatID p_framebuffer_format, Light *p_lights, Batch const *p_batch, RenderingMethod::RenderInfo *r_render_info) {\n \t{\n+\t\tRendererRD::TextureStorage *ts = RendererRD::TextureStorage::get_singleton();\n+\n \t\tRIDSetKey key(\n \t\t\t\tp_batch->tex_info->state,\n \t\t\t\tstate.canvas_instance_data_buffers[state.current_data_buffer_index].instance_buffers[p_batch->instance_buffer_index]);\n@@ -2992,6 +3007,19 @@ void RendererCanvasRenderRD::_render_batch(RD::DrawListID p_draw_list, CanvasSha\n \t\t\tconst RIDCache::Pair *iter = rid_set_to_uniform_set.insert(key, rid);\n \t\t\tuniform_set = &iter->data;\n \t\t\tRD::get_singleton()->uniform_set_set_invalidation_callback(rid, RendererCanvasRenderRD::_uniform_set_invalidation_callback, (void *)&iter->key);\n+\n+\t\t\t// If this is a CanvasTexture, it must be tracked so that any changes to the diffuse, normal\n+\t\t\t// or specular channels invalidate all associated uniform sets.\n+\t\t\tif (ts->owns_canvas_texture(p_batch->tex_info->state.texture)) {\n+\t\t\t\tKeyValue<RID, TightLocalVector<RID>> *kv = nullptr;\n+\t\t\t\tif (HashMap<RID, TightLocalVector<RID>>::Iterator i = canvas_texture_to_uniform_set.find(p_batch->tex_info->state.texture); i == canvas_texture_to_uniform_set.end()) {\n+\t\t\t\t\tkv = &*canvas_texture_to_uniform_set.insert(p_batch->tex_info->state.texture, { *uniform_set });\n+\t\t\t\t} else {\n+\t\t\t\t\ti->value.push_back(rid);\n+\t\t\t\t\tkv = &*i;\n+\t\t\t\t}\n+\t\t\t\tts->canvas_texture_set_invalidation_callback(p_batch->tex_info->state.texture, RendererCanvasRenderRD::_canvas_texture_invalidation_callback, kv);\n+\t\t\t}\n \t\t}\n \n \t\tif (state.current_batch_uniform_set != *uniform_set) {\ndiff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.h b/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\nindex 3b071cd804a1..0605b18ba44e 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\n@@ -485,9 +485,14 @@ class RendererCanvasRenderRD : public RendererCanvasRender {\n \n \tstatic void _before_evict(RendererCanvasRenderRD::RIDSetKey &p_key, RID &p_rid);\n \tstatic void _uniform_set_invalidation_callback(void *p_userdata);\n+\tstatic void _canvas_texture_invalidation_callback(bool p_deleted, void *p_userdata);\n \n \ttypedef LRUCache<RIDSetKey, RID, HashableHasher<RIDSetKey>, HashMapComparatorDefault<RIDSetKey>, _before_evict> RIDCache;\n \tRIDCache rid_set_to_uniform_set;\n+\t/// Maps a CanvasTexture to its associated uniform sets, which must\n+\t/// be invalidated when the CanvasTexture is updated, such as changing the\n+\t/// diffuse texture.\n+\tHashMap<RID, TightLocalVector<RID>> canvas_texture_to_uniform_set;\n \n \tstruct Batch {\n \t\t// Position in the UBO measured in bytes\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\nindex a297b9717816..69ae3d971a4e 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n@@ -43,9 +43,15 @@ using namespace RendererRD;\n void TextureStorage::CanvasTexture::clear_cache() {\n \tinfo_cache[0] = CanvasTextureCache();\n \tinfo_cache[1] = CanvasTextureCache();\n+\tif (invalidated_callback != nullptr) {\n+\t\tinvalidated_callback(false, invalidated_callback_userdata);\n+\t}\n }\n \n TextureStorage::CanvasTexture::~CanvasTexture() {\n+\tif (invalidated_callback != nullptr) {\n+\t\tinvalidated_callback(true, invalidated_callback_userdata);\n+\t}\n }\n \n ///////////////////////////////////////////////////////////////////////////\n@@ -735,6 +741,16 @@ TextureStorage::CanvasTextureInfo TextureStorage::canvas_texture_get_info(RID p_\n \treturn res;\n }\n \n+void TextureStorage::canvas_texture_set_invalidation_callback(RID p_canvas_texture, InvalidationCallback p_callback, void *p_userdata) {\n+\tCanvasTexture *ct = canvas_texture_owner.get_or_null(p_canvas_texture);\n+\tif (!ct) {\n+\t\treturn;\n+\t}\n+\n+\tct->invalidated_callback = p_callback;\n+\tct->invalidated_callback_userdata = p_userdata;\n+}\n+\n /* Texture API */\n \n RID TextureStorage::texture_allocate() {\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.h b/servers/rendering/renderer_rd/storage_rd/texture_storage.h\nindex bfee1e367e0c..2073c34ded7b 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.h\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.h\n@@ -90,6 +90,8 @@ class TextureStorage : public RendererTextureStorage {\n \t\t_FORCE_INLINE_ bool is_null() const { return diffuse.is_null(); }\n \t};\n \n+\ttypedef void (*InvalidationCallback)(bool p_deleted, void *p_userdata);\n+\n private:\n \tfriend class LightStorage;\n \tfriend class MaterialStorage;\n@@ -118,6 +120,9 @@ class TextureStorage : public RendererTextureStorage {\n \t\tRS::CanvasItemTextureRepeat texture_repeat = RS::CANVAS_ITEM_TEXTURE_REPEAT_DEFAULT;\n \t\tCanvasTextureCache info_cache[2];\n \n+\t\tInvalidationCallback invalidated_callback = nullptr;\n+\t\tvoid *invalidated_callback_userdata = nullptr;\n+\n \t\tSize2i size_cache = Size2i(1, 1);\n \t\tbool use_normal_cache = false;\n \t\tbool use_specular_cache = false;\n@@ -499,6 +504,7 @@ class TextureStorage : public RendererTextureStorage {\n \tvirtual void canvas_texture_set_texture_repeat(RID p_item, RS::CanvasItemTextureRepeat p_repeat) override;\n \n \tCanvasTextureInfo canvas_texture_get_info(RID p_texture, RS::CanvasItemTextureFilter p_base_filter, RS::CanvasItemTextureRepeat p_base_repeat, bool p_use_srgb, bool p_texture_is_data);\n+\tvoid canvas_texture_set_invalidation_callback(RID p_canvas_texture, InvalidationCallback p_callback, void *p_userdata);\n \n \t/* Texture API */\n \n", "instance_id": "godotengine__godot-101931", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: modifying the `.diffuse_texture` of a `CanvasTexture` at runtime via script does not result in a visual update in the Godot engine (version 4.4.beta1). The goal is evident\u2014ensure that runtime changes to the texture are reflected visually. The statement includes relevant system information, tested versions, steps to reproduce, and a link to a minimal reproduction project (MRP), which adds to its clarity. However, there are minor ambiguities and missing details. For instance, the problem does not explicitly define the expected behavior (e.g., how the visual update should occur or under what conditions), nor does it mention specific constraints or edge cases (e.g., texture size limits, performance implications, or specific rendering pipelines affected). Additionally, the impact on the player character (\"no longer turn around\") is mentioned but not elaborated upon, leaving room for interpretation. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope and depth of code changes are significant, as they involve modifications across multiple files (`renderer_canvas_render_rd.cpp`, `renderer_canvas_render_rd.h`, `texture_storage.cpp`, and `texture_storage.h`) in the Godot engine's rendering subsystem. These changes are not isolated to a single function but require understanding and altering the interaction between texture storage, rendering logic, and uniform set management. The addition of an invalidation callback mechanism for `CanvasTexture` indicates a need to manage resource lifecycle and caching, which impacts the system's architecture to some extent.\n\nSecond, the number of technical concepts involved is substantial. Solving this requires a deep understanding of Godot's rendering pipeline (specifically the Vulkan backend), resource management (RIDs and uniform sets), and callback mechanisms. Familiarity with C++ (including memory management and data structures like `HashMap` and `TightLocalVector`) is essential, as is knowledge of rendering concepts like texture binding and shader uniforms. Additionally, the problem touches on domain-specific knowledge of game engine internals, which adds to the complexity.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes suggest potential complexities in error handling and resource management. For instance, the invalidation callback must handle both texture updates and deletion scenarios, ensuring that uniform sets are properly cleared without memory leaks or dangling references. There may also be implicit edge cases related to concurrent texture modifications or rendering in multi-threaded environments, which are not addressed in the problem statement but are critical in a game engine context.\n\nFinally, the overall complexity is heightened by the need to ensure that these changes do not introduce performance regressions or break existing functionality in a large, complex codebase like Godot. This requires not only implementing the fix but also thoroughly testing it across different rendering backends and use cases. A score of 0.75 reflects the deep understanding of the codebase architecture required, the complexity of the modifications, and the potential for subtle bugs or performance issues, placing it firmly in the \"Hard\" range, though not at the extreme end of \"Very Hard\" since it does not involve entirely new system-level designs or highly intricate algorithms.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "2D Tilemap coordinates disappear when on \"Terrains\" Mode\n### Tested versions\n\nTested Version: v4.3.stable.official [77dcf97d8]\n\n### System information\n\nWindows 10\n\n### Issue description\n\nOn the editor, when using the tilemap in \"Tiles\" mode, you can see your tile coords in the lower left corner. If you switch to \"Terrains\" mode when you no longer see the tilemap coordinates where your cursor is.\n\n![Image](https://github.com/user-attachments/assets/a106c545-8cdb-4533-9145-b19886f177a3)\n\n### Steps to reproduce\n\nCreate a new 2D TilemapLayer. Hover over the field, you can see your coords in the lower left of the game field. Switch to Terrains, coords disappear.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/plugins/tiles/tile_map_layer_editor.cpp b/editor/plugins/tiles/tile_map_layer_editor.cpp\nindex 4f09e738d1c8..33e914e967c7 100644\n--- a/editor/plugins/tiles/tile_map_layer_editor.cpp\n+++ b/editor/plugins/tiles/tile_map_layer_editor.cpp\n@@ -50,6 +50,23 @@ TileMapLayer *TileMapLayerSubEditorPlugin::_get_edited_layer() const {\n \treturn Object::cast_to<TileMapLayer>(ObjectDB::get_instance(edited_tile_map_layer_id));\n }\n \n+void TileMapLayerSubEditorPlugin::draw_tile_coords_over_viewport(Control *p_overlay, const TileMapLayer *p_edited_layer, Ref<TileSet> p_tile_set, bool p_show_rectangle_size, const Vector2i &p_rectangle_origin) {\n+\tPoint2 msgpos = Point2(20 * EDSCALE, p_overlay->get_size().y - 20 * EDSCALE);\n+\tString text = p_tile_set->local_to_map(p_edited_layer->get_local_mouse_position());\n+\n+\tif (p_show_rectangle_size) {\n+\t\tVector2i rect_size = p_tile_set->local_to_map(p_edited_layer->get_local_mouse_position()) - p_tile_set->local_to_map(p_rectangle_origin);\n+\t\ttext += vformat(\" %s (%dx%d)\", TTR(\"Drawing Rect:\"), Math::abs(rect_size.x) + 1, Math::abs(rect_size.y) + 1);\n+\t}\n+\n+\tRef<Font> font = p_overlay->get_theme_font(SceneStringName(font), SNAME(\"Label\"));\n+\tint font_size = p_overlay->get_theme_font_size(SceneStringName(font_size), SNAME(\"Label\"));\n+\n+\tp_overlay->draw_string(font, msgpos + Point2(1, 1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n+\tp_overlay->draw_string(font, msgpos + Point2(-1, -1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n+\tp_overlay->draw_string(font, msgpos, text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(1, 1, 1, 1));\n+}\n+\n void TileMapLayerEditorTilesPlugin::tile_set_changed() {\n \t_update_fix_selected_and_hovered();\n \t_update_tile_set_sources_list();\n@@ -66,7 +83,7 @@ void TileMapLayerEditorTilesPlugin::_on_scattering_spinbox_changed(double p_valu\n }\n \n void TileMapLayerEditorTilesPlugin::_update_toolbar() {\n-\t// Stop draggig if needed.\n+\t// Stop dragging if needed.\n \t_stop_dragging();\n \n \t// Hide all settings.\n@@ -783,7 +800,7 @@ bool TileMapLayerEditorTilesPlugin::forward_canvas_gui_input(const Ref<InputEven\n }\n \n void TileMapLayerEditorTilesPlugin::forward_canvas_draw_over_viewport(Control *p_overlay) {\n-\tTileMapLayer *edited_layer = _get_edited_layer();\n+\tconst TileMapLayer *edited_layer = _get_edited_layer();\n \tif (!edited_layer) {\n \t\treturn;\n \t}\n@@ -1000,19 +1017,7 @@ void TileMapLayerEditorTilesPlugin::forward_canvas_draw_over_viewport(Control *p\n \t\t\t}\n \t\t}\n \n-\t\tRef<Font> font = p_overlay->get_theme_font(SceneStringName(font), SNAME(\"Label\"));\n-\t\tint font_size = p_overlay->get_theme_font_size(SceneStringName(font_size), SNAME(\"Label\"));\n-\t\tPoint2 msgpos = Point2(20 * EDSCALE, p_overlay->get_size().y - 20 * EDSCALE);\n-\n-\t\tString text = tile_set->local_to_map(edited_layer->get_local_mouse_position());\n-\t\tif (drawing_rect) {\n-\t\t\tVector2i size = tile_set->local_to_map(edited_layer->get_local_mouse_position()) - tile_set->local_to_map(drag_start_mouse_pos);\n-\t\t\ttext += vformat(\" %s (%dx%d)\", TTR(\"Drawing Rect:\"), Math::abs(size.x) + 1, Math::abs(size.y) + 1);\n-\t\t}\n-\n-\t\tp_overlay->draw_string(font, msgpos + Point2(1, 1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n-\t\tp_overlay->draw_string(font, msgpos + Point2(-1, -1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n-\t\tp_overlay->draw_string(font, msgpos, text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(1, 1, 1, 1));\n+\t\tdraw_tile_coords_over_viewport(p_overlay, edited_layer, tile_set, drawing_rect, drag_start_mouse_pos);\n \t}\n }\n \n@@ -3168,6 +3173,7 @@ void TileMapLayerEditorTerrainsPlugin::forward_canvas_draw_over_viewport(Control\n \tTransform2D xform = CanvasItemEditor::get_singleton()->get_canvas_transform() * edited_layer->get_global_transform_with_canvas();\n \tVector2 mpos = edited_layer->get_local_mouse_position();\n \tVector2i tile_shape_size = tile_set->get_tile_size();\n+\tbool drawing_rect = false;\n \n \t// Handle the preview of the tiles to be placed.\n \tif (main_vbox_container->is_visible_in_tree() && has_mouse) { // Only if the tilemap editor is opened and the viewport is hovered.\n@@ -3214,6 +3220,8 @@ void TileMapLayerEditorTerrainsPlugin::forward_canvas_draw_over_viewport(Control\n \t\t\t\t\t\tpreview.insert(Vector2i(x, y));\n \t\t\t\t\t}\n \t\t\t\t}\n+\n+\t\t\t\tdrawing_rect = !preview.is_empty();\n \t\t\t\texpand_grid = true;\n \t\t\t} else if (tool_buttons_group->get_pressed_button() == bucket_tool_button && drag_type == DRAG_TYPE_NONE) {\n \t\t\t\t// Preview for a fill.\n@@ -3272,6 +3280,8 @@ void TileMapLayerEditorTerrainsPlugin::forward_canvas_draw_over_viewport(Control\n \t\t\t\t}\n \t\t\t}\n \t\t}\n+\n+\t\tdraw_tile_coords_over_viewport(p_overlay, edited_layer, tile_set, drawing_rect, drag_start_mouse_pos);\n \t}\n }\n \ndiff --git a/editor/plugins/tiles/tile_map_layer_editor.h b/editor/plugins/tiles/tile_map_layer_editor.h\nindex aa19ead81b32..1abc6890cb08 100644\n--- a/editor/plugins/tiles/tile_map_layer_editor.h\n+++ b/editor/plugins/tiles/tile_map_layer_editor.h\n@@ -67,6 +67,7 @@ class TileMapLayerSubEditorPlugin : public Object {\n \tvirtual void forward_canvas_draw_over_viewport(Control *p_overlay) {}\n \tvirtual void tile_set_changed() {}\n \tvirtual void edit(ObjectID p_tile_map_layer_id) {}\n+\tvirtual void draw_tile_coords_over_viewport(Control *p_overlay, const TileMapLayer *p_edited_layer, Ref<TileSet> p_tile_set, bool p_show_rectangle_size, const Vector2i &p_rectangle_origin);\n };\n \n class TileMapLayerEditorTilesPlugin : public TileMapLayerSubEditorPlugin {\n", "instance_id": "godotengine__godot-101737", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the tile coordinates disappear in the editor when switching from \"Tiles\" mode to \"Terrains\" mode in a 2D TilemapLayer. It provides steps to reproduce the issue, specifies the tested version, and includes a visual reference (an image). However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (coordinates should remain visible in \"Terrains\" mode) but not explicitly stated. Additionally, there are no mentions of specific edge cases, performance requirements, or constraints that might affect the solution. While the issue is understandable, the lack of explicit expected behavior and edge case details prevents it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, primarily affecting a single file (`tile_map_layer_editor.cpp`) with minor updates to the header file (`tile_map_layer_editor.h`). The changes involve refactoring existing code to create a reusable function (`draw_tile_coords_over_viewport`) and applying it to both \"Tiles\" and \"Terrains\" modes. The modifications do not impact the broader system architecture and are limited to UI rendering logic in the editor plugin. The amount of code change is moderate, with around 30-40 lines added or modified.\n\n2. **Clarity and Complexity of Problem Description**: As noted in the clarity score, the problem is mostly clear, requiring a straightforward fix to ensure coordinates are displayed in \"Terrains\" mode. The logic to solve this is not inherently complex, as it involves reusing existing rendering code.\n\n3. **Number of Technical Concepts**: Solving this requires understanding C++ (specifically in the context of the Godot engine), basic UI rendering (drawing text over a viewport), and familiarity with the editor plugin structure in Godot. These concepts are not particularly advanced for someone with experience in game engine development or C++. No complex algorithms, design patterns, or domain-specific knowledge beyond Godot's tilemap system are needed.\n\n4. **Edge Cases and Error Handling**: The problem statement does not mention specific edge cases, and the code changes do not introduce new error handling logic. The fix appears to handle the primary use case (displaying coordinates) without addressing potential issues like performance in large tilemaps, UI overlap, or localization of text. The simplicity of edge cases (or lack thereof) keeps the difficulty low.\n\nOverall, this task requires understanding some code logic and making simple modifications to ensure consistent behavior across modes. It does not involve deep architectural changes or complex technical challenges, justifying a score of 0.35. It is slightly above the lower end of the \"Easy\" range due to the need to understand Godot's editor plugin system and coordinate mapping logic, which might be non-trivial for a complete beginner but straightforward for an experienced developer.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Web] Cannot remove files with `DirAccess.remove_absolute`\n### Tested versions\n\nReproducible: 4.4.dev5 and 4.4dev6\n\n### System information\n\nGodot v4.4.dev6 - Windows 10.0.22631 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 3060 Laptop GPU (NVIDIA; 32.0.15.6603) - 12th Gen Intel(R) Core(TM) i5-12500H (16 threads)\n\n### Issue description\n\n\nOn the exported project, I am creating a file in `user://` folder, then letting users remove it. `DirAccess.remove_absolute(filepath)` returns 0 (successful), but after restarting the scene Ctrl + Refresh, the file is seen there again. \n\n\n### Steps to reproduce\n\nList folders in `user://`, if empty create a file there.\n\nDelete using `DirAccess.remove_absolute(\"user://filename\")`.\nRestart the game via refresh button on the browser.\n\n```\nListing folder: user://\ntest.js:459 [\"text.txt\"]\ntest.js:459 File stored at: user://text.txt\ntest.js:459 Listing folder: user://\ntest.js:459 [\"text.txt\"]\ntest.js:459 Deleting: user://text.txt\ntest.js:459 Deleted user://text.txt\ntest.js:459 Listing folder: user://\ntest.js:459 []\n```\nAfter refreshing,\n\n```\nListing folder: user://\ntest.js:459 [\"text.txt\"]`\n```\n\nThe `text.txt` is still there.\n\n### Minimal reproduction project (MRP)\n\n[testbug.zip](https://github.com/user-attachments/files/18067479/testbug.zip)\n\nExport as web and launch it. Check the Dev Console.\n", "patch": "diff --git a/drivers/unix/dir_access_unix.cpp b/drivers/unix/dir_access_unix.cpp\nindex 816ffd7a322f..6d3e4c7dbf19 100644\n--- a/drivers/unix/dir_access_unix.cpp\n+++ b/drivers/unix/dir_access_unix.cpp\n@@ -438,11 +438,19 @@ Error DirAccessUnix::remove(String p_path) {\n \t\treturn FAILED;\n \t}\n \n+\tint err;\n \tif (S_ISDIR(flags.st_mode) && !is_link(p_path)) {\n-\t\treturn ::rmdir(p_path.utf8().get_data()) == 0 ? OK : FAILED;\n+\t\terr = ::rmdir(p_path.utf8().get_data());\n \t} else {\n-\t\treturn ::unlink(p_path.utf8().get_data()) == 0 ? OK : FAILED;\n+\t\terr = ::unlink(p_path.utf8().get_data());\n \t}\n+\tif (err != 0) {\n+\t\treturn FAILED;\n+\t}\n+\tif (remove_notification_func != nullptr) {\n+\t\tremove_notification_func(p_path);\n+\t}\n+\treturn OK;\n }\n \n bool DirAccessUnix::is_link(String p_file) {\n@@ -552,6 +560,8 @@ DirAccessUnix::DirAccessUnix() {\n \tchange_dir(current_dir);\n }\n \n+DirAccessUnix::RemoveNotificationFunc DirAccessUnix::remove_notification_func = nullptr;\n+\n DirAccessUnix::~DirAccessUnix() {\n \tlist_dir_end();\n }\ndiff --git a/drivers/unix/dir_access_unix.h b/drivers/unix/dir_access_unix.h\nindex 8d13ff1fa88d..adf1fa80e7be 100644\n--- a/drivers/unix/dir_access_unix.h\n+++ b/drivers/unix/dir_access_unix.h\n@@ -52,6 +52,9 @@ class DirAccessUnix : public DirAccess {\n \tvirtual bool is_hidden(const String &p_name);\n \n public:\n+\ttypedef void (*RemoveNotificationFunc)(const String &p_file);\n+\tstatic RemoveNotificationFunc remove_notification_func;\n+\n \tvirtual Error list_dir_begin() override; ///< This starts dir listing\n \tvirtual String get_next() override;\n \tvirtual bool current_is_dir() const override;\ndiff --git a/drivers/unix/file_access_unix.cpp b/drivers/unix/file_access_unix.cpp\nindex f2e4b3966be8..048d42529029 100644\n--- a/drivers/unix/file_access_unix.cpp\n+++ b/drivers/unix/file_access_unix.cpp\n@@ -443,7 +443,7 @@ void FileAccessUnix::close() {\n \t_close();\n }\n \n-CloseNotificationFunc FileAccessUnix::close_notification_func = nullptr;\n+FileAccessUnix::CloseNotificationFunc FileAccessUnix::close_notification_func = nullptr;\n \n FileAccessUnix::~FileAccessUnix() {\n \t_close();\ndiff --git a/drivers/unix/file_access_unix.h b/drivers/unix/file_access_unix.h\nindex 66e4bccc2525..fb9d684714c3 100644\n--- a/drivers/unix/file_access_unix.h\n+++ b/drivers/unix/file_access_unix.h\n@@ -38,8 +38,6 @@\n \n #if defined(UNIX_ENABLED)\n \n-typedef void (*CloseNotificationFunc)(const String &p_file, int p_flags);\n-\n class FileAccessUnix : public FileAccess {\n \tFILE *f = nullptr;\n \tint flags = 0;\n@@ -56,6 +54,7 @@ class FileAccessUnix : public FileAccess {\n #endif\n \n public:\n+\ttypedef void (*CloseNotificationFunc)(const String &p_file, int p_flags);\n \tstatic CloseNotificationFunc close_notification_func;\n \n \tvirtual Error open_internal(const String &p_path, int p_mode_flags) override; ///< open a file\ndiff --git a/platform/web/os_web.cpp b/platform/web/os_web.cpp\nindex 51facbaa845d..8f59c8ad668c 100644\n--- a/platform/web/os_web.cpp\n+++ b/platform/web/os_web.cpp\n@@ -224,6 +224,18 @@ void OS_Web::file_access_close_callback(const String &p_file, int p_flags) {\n \t}\n }\n \n+void OS_Web::dir_access_remove_callback(const String &p_file) {\n+\tOS_Web *os = OS_Web::get_singleton();\n+\tbool is_file_persistent = p_file.begins_with(\"/userfs\");\n+#ifdef TOOLS_ENABLED\n+\t// Hack for editor persistence (can we track).\n+\tis_file_persistent = is_file_persistent || p_file.begins_with(\"/home/web_user/\");\n+#endif\n+\tif (is_file_persistent) {\n+\t\tos->idb_needs_sync = true;\n+\t}\n+}\n+\n void OS_Web::update_pwa_state_callback() {\n \tif (OS_Web::get_singleton()) {\n \t\tOS_Web::get_singleton()->pwa_is_waiting = true;\n@@ -287,4 +299,5 @@ OS_Web::OS_Web() {\n \t_set_logger(memnew(CompositeLogger(loggers)));\n \n \tFileAccessUnix::close_notification_func = file_access_close_callback;\n+\tDirAccessUnix::remove_notification_func = dir_access_remove_callback;\n }\ndiff --git a/platform/web/os_web.h b/platform/web/os_web.h\nindex 1ddb745965ac..8965cc4424b7 100644\n--- a/platform/web/os_web.h\n+++ b/platform/web/os_web.h\n@@ -53,6 +53,7 @@ class OS_Web : public OS_Unix {\n \tWASM_EXPORT static void main_loop_callback();\n \n \tWASM_EXPORT static void file_access_close_callback(const String &p_file, int p_flags);\n+\tWASM_EXPORT static void dir_access_remove_callback(const String &p_file);\n \tWASM_EXPORT static void fs_sync_callback();\n \tWASM_EXPORT static void update_pwa_state_callback();\n \n", "instance_id": "godotengine__godot-100221", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: files created in the `user://` folder on a web-exported Godot project are not being removed permanently when using `DirAccess.remove_absolute()`, as they reappear after a scene refresh. The steps to reproduce are provided, along with logs that demonstrate the issue, and a minimal reproduction project is attached. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss potential causes (e.g., browser persistence or file system syncing issues on the web platform), nor does it mention specific edge cases like file permissions or concurrent access. Additionally, the expected behavior after removal (e.g., whether the file should be removed from persistent storage or just temporarily) is implied but not explicitly stated. These minor gaps prevent it from being fully comprehensive, but the overall intent and issue are clear enough to work on.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files (`dir_access_unix.cpp`, `dir_access_unix.h`, `file_access_unix.cpp`, `file_access_unix.h`, `os_web.cpp`, and `os_web.h`) and involves platform-specific logic for web exports in the Godot engine, requiring a good understanding of how file system operations are handled in a browser environment (e.g., IndexedDB persistence). Second, the technical concepts involved include Unix file system operations (`unlink`, `rmdir`), callback mechanisms for notifications, and platform-specific behavior on the web (e.g., syncing with persistent storage). Third, the changes impact the interaction between the core engine's file system abstraction and the web platform's implementation, which requires understanding the broader architecture of Godot's OS and file access layers. While the actual lines of code changed are relatively few, the addition of a notification callback for file removal and the logic to flag sync needs (`idb_needs_sync`) introduce subtle complexity, especially in ensuring correctness across different environments (e.g., editor vs. exported builds). Edge cases, such as handling files in different storage scopes (`/userfs` vs. `/home/web_user/`), are partially addressed in the code but add to the problem's depth. Overall, solving this requires a deep understanding of Godot's internals and web platform constraints, justifying a score of 0.65, leaning towards the harder side of the spectrum.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "cmake: incorrectly reporting MSVC as using ccache\nMentioned by @stickies-v. The CMake configure currently outputs that MSVC builds are using ccache, i.e (https://github.com/bitcoin/bitcoin/actions/runs/13063954360/job/36452895056#step:8:2374):\n```bash\nTreat compiler warnings as errors ..... ON\nUse ccache for compiling .............. ON\n```\n\nHowever that's a bug, as MSVC is currently excluded entirely from using ccache: \nhttps://github.com/bitcoin/bitcoin/blob/8fa10edcd1706a1f0dc9d8c3adbc8efa3c7755bf/cmake/ccache.cmake#L4-L6\n", "patch": "diff --git a/cmake/ccache.cmake b/cmake/ccache.cmake\nindex d1cc204c8e463..0bfd3a41f62db 100644\n--- a/cmake/ccache.cmake\n+++ b/cmake/ccache.cmake\n@@ -23,6 +23,8 @@ if(NOT MSVC)\n   else()\n     set(WITH_CCACHE OFF)\n   endif()\n+else()\n+  set(WITH_CCACHE OFF)\n endif()\n \n mark_as_advanced(CCACHE_EXECUTABLE)\n", "instance_id": "bitcoin__bitcoin-31983", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: CMake incorrectly reports that MSVC builds are using ccache, despite MSVC being explicitly excluded from ccache usage in the codebase. The goal of fixing this misreporting is evident, and references to specific lines of code and build logs help contextualize the problem. However, the statement lacks explicit mention of the expected output or behavior after the fix (e.g., should the CMake output explicitly state \"Use ccache for compiling .............. OFF\" for MSVC?). Additionally, there are minor ambiguities regarding whether this issue affects functionality or is purely a reporting bug, and no edge cases or constraints are discussed. Overall, the problem is valid and mostly clear, but minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward fix to ensure that the ccache usage flag (WITH_CCACHE) is correctly set to OFF for MSVC builds. The code change is minimal, confined to a single file (cmake/ccache.cmake), and involves adding just a couple of lines to handle the MSVC case explicitly. The scope of the change is small, with no impact on the broader system architecture or interactions between modules. The technical concepts required are basic\u2014understanding CMake conditional logic and variable setting\u2014which are fundamental for anyone familiar with build systems. There are no complex edge cases or error handling requirements mentioned in the problem statement or evident in the code change. This task aligns with a very easy problem, requiring only basic code modification, thus warranting a difficulty score of 0.15 (Very Easy).", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "build: depends cross-compile using Clang fails\nSeems like CMake is getting confused, and trying to build and link a `x86_64` binary, when it's meant to be (and thinks it is, according to the  configure output) building for `aarch64`:\n```bash\nmake -C depends/ CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib STRIP=llvm-strip NO_QT=1 NO_WALLET=1 NO_USDT=1 NO_ZMQ=1 -j18 HOST=aarch64-linux-gnu\n<snip>\ncopying packages: boost libevent\nto: /root/ci_scratch/depends/aarch64-linux-gnu\nTo build Bitcoin Core with these packages, pass '--toolchain /root/ci_scratch/depends/aarch64-linux-gnu/toolchain.cmake' to the first CMake invocation.\n\ncmake -B build --toolchain /root/ci_scratch/depends/aarch64-linux-gnu/toolchain.cmake\n<snip>\nCross compiling ....................... TRUE, for Linux, aarch64\nC++ compiler .......................... Clang 18.1.3, /usr/bin/clang++\n<snip>\ncmake --build build -j18 --target bitcoind --verbose\n[ 98%] Linking CXX executable bitcoind\ncd /root/ci_scratch/build/src && /usr/bin/cmake -E cmake_link_script CMakeFiles/bitcoind.dir/link.txt --verbose=1\n/usr/bin/clang++ -pipe -std=c++20 -O2 -O2 -g -fstack-protector-all -fcf-protection=full -fstack-clash-protection -Wl,-z,relro -Wl,-z,now -Wl,-z,separate-code -fPIE -pie CMakeFiles/bitcoind.dir/bitcoind.cpp.o CMakeFiles/bitcoind.dir/init/bitcoind.cpp.o -o bitcoind  libbitcoin_node.a libbitcoin_common.a libbitcoin_consensus.a secp256k1/lib/libsecp256k1.a util/libbitcoin_util.a crypto/libbitcoin_crypto.a crypto/libbitcoin_crypto_sse41.a crypto/libbitcoin_crypto_avx2.a crypto/libbitcoin_crypto_x86_shani.a ../libleveldb.a ../libcrc32c.a ../libcrc32c_sse42.a ../libminisketch.a univalue/libunivalue.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_pthreads.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_core.a  \n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a: error adding symbols: file in wrong format\nclang++: error: linker command failed with exit code 1 (use -v to see invocation)\ngmake[3]: *** [src/CMakeFiles/bitcoind.dir/build.make:130: src/bitcoind] Error 1\n```\nMaybe there's something missing from the toolchain that we should be passing through. The libs in depends have been compiled for aarch64, i.e:\n```bash\nobjdump -x /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a | grep aarch64\nIn archive /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a:\nevent_tagging.c.o:     file format elf64-littleaarch64\narchitecture: aarch64, flags 0x00000011:\nhttp.c.o:     file format elf64-littleaarch64\n```\n\nHowever CMake is building x86_64 object files:\n```bash\nfile build/CMakeFiles/leveldb.dir/src/leveldb/db/filename.cc.o\nbuild/CMakeFiles/leveldb.dir/src/leveldb/db/filename.cc.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), with debug_info, not stripped\n```\nand binaries:\n```bash\nfile build/src/bitcoin-util \nbuild/src/bitcoin-util: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=4ccab1d492154df5dd9a115e6bbc52371d7439b1, for GNU/Linux 3.2.0, with debug_info, not stripped\n```\n", "patch": "diff --git a/depends/Makefile b/depends/Makefile\nindex 2841d50ae4a84..f03db29eb3069 100644\n--- a/depends/Makefile\n+++ b/depends/Makefile\n@@ -203,6 +203,7 @@ endif\n $(host_prefix)/toolchain.cmake : toolchain.cmake.in $(host_prefix)/.stamp_$(final_build_id)\n \t@mkdir -p $(@D)\n \tsed -e 's|@depends_crosscompiling@|$(crosscompiling)|' \\\n+            -e 's|@host@|$(host)|' \\\n             -e 's|@host_system_name@|$($(host_os)_cmake_system_name)|' \\\n             -e 's|@host_system_version@|$($(host_os)_cmake_system_version)|' \\\n             -e 's|@host_arch@|$(host_arch)|' \\\ndiff --git a/depends/toolchain.cmake.in b/depends/toolchain.cmake.in\nindex ac24f74ad4f71..28188f6347cfd 100644\n--- a/depends/toolchain.cmake.in\n+++ b/depends/toolchain.cmake.in\n@@ -13,6 +13,10 @@ if(@depends_crosscompiling@)\n   set(CMAKE_SYSTEM_NAME @host_system_name@)\n   set(CMAKE_SYSTEM_VERSION @host_system_version@)\n   set(CMAKE_SYSTEM_PROCESSOR @host_arch@)\n+\n+  set(CMAKE_C_COMPILER_TARGET @host@)\n+  set(CMAKE_CXX_COMPILER_TARGET @host@)\n+  set(CMAKE_OBJCXX_COMPILER_TARGET @host@)\n endif()\n \n if(NOT DEFINED CMAKE_C_FLAGS_INIT)\n", "instance_id": "bitcoin__bitcoin-31849", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a cross-compilation error when building Bitcoin Core for `aarch64` using Clang and CMake, where the system incorrectly builds `x86_64` binaries despite the configuration indicating `aarch64`. The statement includes detailed logs, build commands, and evidence of the mismatch in architecture (e.g., object file formats). However, there are minor ambiguities and missing details. For instance, it does not explicitly state the expected behavior beyond \"building for `aarch64`,\" nor does it clarify the root cause hypothesis beyond \"CMake is getting confused.\" Additionally, there are no mentions of specific constraints or edge cases related to the build environment (e.g., specific Clang or CMake versions, host system details). While the issue is well-documented with logs, the lack of a precise problem definition or potential causes makes it fall short of a comprehensive score. Hence, a score of 2 (Mostly Clear) is appropriate.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors across the evaluation criteria:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are relatively small, confined to two files (`depends/Makefile` and `depends/toolchain.cmake.in`), and involve adding a few lines to pass the host target explicitly to CMake via compiler target variables. However, the impact of these changes is significant as they affect the entire build system configuration for cross-compilation. Understanding the interaction between the `depends` build system, CMake toolchain files, and the overall Bitcoin Core build process is necessary, which implies a broader scope beyond the modified lines.\n\n2. **Number of Technical Concepts**: Solving this requires a deep understanding of multiple complex concepts, including cross-compilation workflows, CMake toolchain configuration, compiler target triples (e.g., `aarch64-linux-gnu`), and how Clang and CMake interact during cross-compilation. Additionally, familiarity with the Bitcoin Core build system (`depends/` directory) and low-level build tools (e.g., `objdump`, `file`) for debugging architecture mismatches is essential. These concepts are advanced and not trivial for an average developer.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the nature of cross-compilation inherently involves potential issues such as mismatched library architectures, host system compatibility, or toolchain-specific quirks (e.g., Clang version differences). The code changes do not directly address error handling, but ensuring the fix works across different environments or build configurations adds implicit complexity. Debugging such issues often requires handling subtle edge cases related to build flags or system settings.\n\n4. **Overall Complexity**: The problem requires a deep understanding of build system internals and cross-compilation, which are niche and challenging areas even for experienced developers. While the code change itself is small, identifying the root cause (CMake not respecting the target architecture) and applying the correct fix (setting `CMAKE_C_COMPILER_TARGET` and related variables) demands significant expertise. The problem also has architectural implications since it affects how the entire project is compiled for different platforms.\n\nGiven these considerations, a difficulty score of 0.65 is assigned. It is not in the \"Very Hard\" range (0.8-1.0) because the solution does not involve extensive code refactoring or advanced algorithmic design, but it is firmly in the \"Hard\" range due to the specialized knowledge and debugging effort required to understand and resolve the cross-compilation mismatch.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "gen-manpages.py should skip nonexistent binaries and still work for the existent binaries\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nBy executing `BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py`, if one binary is not found, it will stop the generation of all manpages.\r\n\r\nFor example: Executing gen-manpages.py without bitcoin-qt. The command exits after detecting that bitcoin-qt does not exist, and no manpage is generated, even though only bitcoin-qt is missing.\r\n\r\n```bash\r\n\u279c  bitcoin git:(master) \u2717 BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py\r\n/home/andre/repos/bitcoin/build/src/qt/bitcoin-qt not found or not an executable\r\n\u279c  bitcoin git:(master) \u2717 \r\n```\r\n\r\nInitially, I thought this behavior was intended, but after investigating the older shell script implementation `gen-manpages.sh`, I realized that\u2019s not the case. `gen-manpages.sh` was able to generate all the manpages and just warned the user about missing binaries.\r\n\r\nExample using the last version of the shell script: https://github.com/bitcoin/bitcoin/blob/a5edd191be93aff8f9c0f60f04e711e2e78ecc77/contrib/devtools/gen-manpages.sh\r\n\r\n```bash\r\n\u279c  bitcoin git:(master) \u2717 BUILDDIR=$PWD/build contrib/devtools/gen-manpages.sh\r\ncontrib/devtools/gen-manpages.sh: line 25: /home/andre/repos/bitcoin/build/src/qt/bitcoin-qt: No such file or directory\r\nhelp2man: can't get `--help' info from /home/andre/repos/bitcoin/build/src/qt/bitcoin-qt\r\nTry `--no-discard-stderr' if option outputs to stderr\r\n\u279c  bitcoin git:(master) \u2717 git status\r\nOn branch master\r\nYour branch is up to date with 'origin/master'.\r\n\r\nChanges not staged for commit:\r\n  (use \"git add <file>...\" to update what will be committed)\r\n  (use \"git restore <file>...\" to discard changes in working directory)\r\n\tmodified:   doc/man/bitcoin-cli.1\r\n\tmodified:   doc/man/bitcoin-tx.1\r\n\tmodified:   doc/man/bitcoin-util.1\r\n\tmodified:   doc/man/bitcoin-wallet.1\r\n\tmodified:   doc/man/bitcoind.1\r\n\r\n```\r\n\r\nThe script warned about `bitcoin-qt` being missing but still generated the other manpages, as you can see with the git status command.\n\n### Expected behaviour\n\n```sh\r\n\u279c  bitcoin git:(master) \u2717 BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py\r\n/home/andre/repos/bitcoin/build/src/qt/bitcoin-qt not found or not an executable. Skipping...\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoind.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-cli.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-tx.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-wallet.1\u2026\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-util.1\u2026\r\n```\n\n### Steps to reproduce\n\nRun `BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py` without having one of the binaries compiled e.g. bitcoin-qt.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster\n\n### Operating system and version\n\nDebian\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/contrib/devtools/gen-manpages.py b/contrib/devtools/gen-manpages.py\nindex 92acd9a40373c..14c8c408e83af 100755\n--- a/contrib/devtools/gen-manpages.py\n+++ b/contrib/devtools/gen-manpages.py\n@@ -6,6 +6,7 @@\n import subprocess\n import sys\n import tempfile\n+import argparse\n \n BINARIES = [\n 'src/bitcoind',\n@@ -16,6 +17,18 @@\n 'src/qt/bitcoin-qt',\n ]\n \n+parser = argparse.ArgumentParser(\n+    formatter_class=argparse.RawDescriptionHelpFormatter,\n+)\n+parser.add_argument(\n+    \"-s\",\n+    \"--skip-missing-binaries\",\n+    action=\"store_true\",\n+    default=False,\n+    help=\"skip generation for binaries that are not found in the build path\",\n+)\n+args = parser.parse_args()\n+\n # Paths to external utilities.\n git = os.getenv('GIT', 'git')\n help2man = os.getenv('HELP2MAN', 'help2man')\n@@ -38,8 +51,12 @@\n     try:\n         r = subprocess.run([abspath, \"--version\"], stdout=subprocess.PIPE, check=True, text=True)\n     except IOError:\n-        print(f'{abspath} not found or not an executable', file=sys.stderr)\n-        sys.exit(1)\n+        if(args.skip_missing_binaries):\n+            print(f'{abspath} not found or not an executable. Skipping...', file=sys.stderr)\n+            continue\n+        else:\n+            print(f'{abspath} not found or not an executable', file=sys.stderr)\n+            sys.exit(1)\n     # take first line (which must contain version)\n     verstr = r.stdout.splitlines()[0]\n     # last word of line is the actual version e.g. v22.99.0-5c6b3d5b3508\n@@ -51,6 +68,10 @@\n \n     versions.append((abspath, verstr, copyright))\n \n+if not versions:\n+    print(f'No binaries found in {builddir}. Please ensure the binaries are present in {builddir}, or set another build path using the BUILDDIR env variable.')\n+    sys.exit(1)\n+\n if any(verstr.endswith('-dirty') for (_, verstr, _) in versions):\n     print(\"WARNING: Binaries were built from a dirty tree.\")\n     print('man pages generated from dirty binaries should NOT be committed.')\n", "instance_id": "bitcoin__bitcoin-30986", "clarity": 3, "difficulty": 0.25, "clarity_explanation": "The problem statement is comprehensive and well-structured. It clearly defines the current behavior of the `gen-manpages.py` script, where the script halts if a single binary is missing, and contrasts it with the expected behavior, where the script should skip missing binaries and continue generating manpages for the available ones. The statement includes detailed examples of the issue with logs and comparisons to the older shell script (`gen-manpages.sh`), which handled this case gracefully. Steps to reproduce the issue are provided, along with the expected output. There are no significant ambiguities; the goal, input, output, and constraints are well-articulated. The only minor omission is a lack of explicit mention of specific edge cases (e.g., what if no binaries are found at all), but this is addressed in the code changes and does not detract from the overall clarity.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" category (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The modification is confined to a single file (`gen-manpages.py`) and involves a small, focused change. The diff shows the addition of an argument parser to support a `--skip-missing-binaries` flag, a conditional check to skip missing binaries instead of exiting, and a small check to handle the case where no binaries are found. The changes are localized and do not impact the broader architecture of the Bitcoin Core codebase or require understanding complex interactions between modules. The amount of code change is minimal, with less than 20 lines added or modified.\n\n2. **Number of Technical Concepts:** The solution requires basic familiarity with Python, specifically the `argparse` module for command-line argument parsing and control flow modifications using `continue` in a loop. No advanced language features, algorithms, design patterns, or domain-specific knowledge (beyond understanding the purpose of manpage generation) are needed. These concepts are straightforward for anyone with basic Python experience.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the code changes address a key one\u2014handling the scenario where no binaries are found by adding an explicit check and error message. The error handling logic is simple, involving a conditional exit with a clear message. No complex edge cases (e.g., partial binary failures, permission issues, or platform-specific behaviors) are introduced or required to be handled beyond the primary issue of skipping missing binaries.\n\n4. **Overall Complexity:** The task involves understanding a small part of the script's logic (checking binary existence and running subprocesses) and making a simple modification to alter its behavior. It does not require deep knowledge of the Bitcoin Core codebase or intricate debugging. The change is akin to fixing a minor bug or adding a small feature, aligning with the lower end of the difficulty spectrum.\n\nGiven these factors, a difficulty score of 0.25 reflects the simplicity of the task. It requires minimal effort beyond basic Python scripting skills and does not pose significant technical challenges or risks to the codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Update nChainTx to 64bit type\nhttps://github.com/bitcoin/bitcoin/blob/8106b268cde8e97a7c330afdda39b6bb55e5574a/src/chain.h#L178-L186\r\n\r\nHey, it's 2024! `nChainTx` seems to currently be 953368191 (height 826100), which is hex `38d3 3e7f`, so we're only 22% of the way to an overflow, and would still need another 200k blocks (~ four years) full of 60 byte transactions to get there.\n", "patch": "diff --git a/src/chain.h b/src/chain.h\nindex e8a8c066c8e1b..c46392c5355c5 100644\n--- a/src/chain.h\n+++ b/src/chain.h\n@@ -102,7 +102,7 @@ enum BlockStatus : uint32_t {\n      *\n      * If a block's validity is at least VALID_TRANSACTIONS, CBlockIndex::nTx will be set. If a block and all previous\n      * blocks back to the genesis block or an assumeutxo snapshot block are at least VALID_TRANSACTIONS,\n-     * CBlockIndex::nChainTx will be set.\n+     * CBlockIndex::m_chain_tx_count will be set.\n      */\n     BLOCK_VALID_TRANSACTIONS =    3,\n \n@@ -173,8 +173,7 @@ class CBlockIndex\n     //! This value will be non-zero if this block and all previous blocks back\n     //! to the genesis block or an assumeutxo snapshot block have reached the\n     //! VALID_TRANSACTIONS level.\n-    //! Change to 64-bit type before 2024 (assuming worst case of 60 byte transactions).\n-    unsigned int nChainTx{0};\n+    uint64_t m_chain_tx_count{0};\n \n     //! Verification status of this block. See enum BlockStatus\n     //!\n@@ -254,10 +253,10 @@ class CBlockIndex\n      * Does not imply the transactions are consensus-valid (ConnectTip might fail)\n      * Does not imply the transactions are still stored on disk. (IsBlockPruned might return true)\n      *\n-     * Note that this will be true for the snapshot base block, if one is loaded, since its nChainTx value will have\n+     * Note that this will be true for the snapshot base block, if one is loaded, since its m_chain_tx_count value will have\n      * been set manually based on the related AssumeutxoData entry.\n      */\n-    bool HaveNumChainTxs() const { return nChainTx != 0; }\n+    bool HaveNumChainTxs() const { return m_chain_tx_count != 0; }\n \n     NodeSeconds Time() const\n     {\ndiff --git a/src/kernel/chainparams.cpp b/src/kernel/chainparams.cpp\nindex 2b729e3b7a9b4..aa6d80556a073 100644\n--- a/src/kernel/chainparams.cpp\n+++ b/src/kernel/chainparams.cpp\n@@ -180,7 +180,7 @@ class CMainParams : public CChainParams {\n         chainTxData = ChainTxData{\n             // Data from RPC: getchaintxstats 4096 000000000000000000026811d149d4d261995ec5b3f64f439a0a10e1a464af9a\n             .nTime    = 1704194835,\n-            .nTxCount = 946728933,\n+            .tx_count = 946728933,\n             .dTxRate  = 6.569290261471664,\n         };\n     }\n@@ -272,7 +272,7 @@ class CTestNetParams : public CChainParams {\n             {\n                 .height = 2'500'000,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xf841584909f68e47897952345234e37fcd9128cd818f41ee6c3ca68db8071be7\")},\n-                .nChainTx = 66484552,\n+                .m_chain_tx_count = 66484552,\n                 .blockhash = uint256S(\"0x0000000000000093bcb68c03a9a168ae252572d348a2eaeba2cdf9231d73206f\")\n             }\n         };\n@@ -280,7 +280,7 @@ class CTestNetParams : public CChainParams {\n         chainTxData = ChainTxData{\n             // Data from RPC: getchaintxstats 4096 000000000001323071f38f21ea5aae529ece491eadaccce506a59bcc2d968917\n             .nTime    = 1703579240,\n-            .nTxCount = 67845391,\n+            .tx_count = 67845391,\n             .dTxRate  = 1.464436832560951,\n         };\n     }\n@@ -312,7 +312,7 @@ class SigNetParams : public CChainParams {\n             chainTxData = ChainTxData{\n                 // Data from RPC: getchaintxstats 4096 0000000870f15246ba23c16e370a7ffb1fc8a3dcf8cb4492882ed4b0e3d4cd26\n                 .nTime    = 1706331472,\n-                .nTxCount = 2425380,\n+                .tx_count = 2425380,\n                 .dTxRate  = 0.008277759863833788,\n             };\n         } else {\n@@ -382,7 +382,7 @@ class SigNetParams : public CChainParams {\n             {\n                 .height = 160'000,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xfe0a44309b74d6b5883d246cb419c6221bcccf0b308c9b59b7d70783dbdf928a\")},\n-                .nChainTx = 2289496,\n+                .m_chain_tx_count = 2289496,\n                 .blockhash = uint256S(\"0x0000003ca3c99aff040f2563c2ad8f8ec88bd0fd6b8f0895cfaf1ef90353a62c\")\n             }\n         };\n@@ -498,21 +498,21 @@ class CRegTestParams : public CChainParams\n             {   // For use by unit tests\n                 .height = 110,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0x6657b736d4fe4db0cbc796789e812d5dba7f5c143764b1b6905612f1830609d1\")},\n-                .nChainTx = 111,\n+                .m_chain_tx_count = 111,\n                 .blockhash = uint256S(\"0x696e92821f65549c7ee134edceeeeaaa4105647a3c4fd9f298c0aec0ab50425c\")\n             },\n             {\n                 // For use by fuzz target src/test/fuzz/utxo_snapshot.cpp\n                 .height = 200,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0x4f34d431c3e482f6b0d67b64609ece3964dc8d7976d02ac68dd7c9c1421738f2\")},\n-                .nChainTx = 201,\n+                .m_chain_tx_count = 201,\n                 .blockhash = uint256S(\"0x5e93653318f294fb5aa339d00bbf8cf1c3515488ad99412c37608b139ea63b27\"),\n             },\n             {\n                 // For use by test/functional/feature_assumeutxo.py\n                 .height = 299,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xa4bf3407ccb2cc0145c49ebba8fa91199f8a3903daf0883875941497d2493c27\")},\n-                .nChainTx = 334,\n+                .m_chain_tx_count = 334,\n                 .blockhash = uint256S(\"0x3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0\")\n             },\n         };\ndiff --git a/src/kernel/chainparams.h b/src/kernel/chainparams.h\nindex 5d45a1fa9c07f..e367de2f93982 100644\n--- a/src/kernel/chainparams.h\n+++ b/src/kernel/chainparams.h\n@@ -50,11 +50,11 @@ struct AssumeutxoData {\n     //! The expected hash of the deserialized UTXO set.\n     AssumeutxoHash hash_serialized;\n \n-    //! Used to populate the nChainTx value, which is used during BlockManager::LoadBlockIndex().\n+    //! Used to populate the m_chain_tx_count value, which is used during BlockManager::LoadBlockIndex().\n     //!\n     //! We need to hardcode the value here because this is computed cumulatively using block data,\n     //! which we do not necessarily have at the time of snapshot load.\n-    unsigned int nChainTx;\n+    uint64_t m_chain_tx_count;\n \n     //! The hash of the base block for this snapshot. Used to refer to assumeutxo data\n     //! prior to having a loaded blockindex.\n@@ -69,7 +69,7 @@ struct AssumeutxoData {\n  */\n struct ChainTxData {\n     int64_t nTime;    //!< UNIX timestamp of last known number of transactions\n-    int64_t nTxCount; //!< total number of transactions between genesis and that timestamp\n+    uint64_t tx_count; //!< total number of transactions between genesis and that timestamp\n     double dTxRate;   //!< estimated number of transactions per second after that timestamp\n };\n \ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\nindex 29b624cb12f57..bfb11e9fcd4f4 100644\n--- a/src/node/blockstorage.cpp\n+++ b/src/node/blockstorage.cpp\n@@ -410,11 +410,11 @@ bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockha\n         m_snapshot_height = au_data.height;\n         CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};\n \n-        // Since nChainTx (responsible for estimated progress) isn't persisted\n+        // Since m_chain_tx_count (responsible for estimated progress) isn't persisted\n         // to disk, we must bootstrap the value for assumedvalid chainstates\n         // from the hardcoded assumeutxo chainparams.\n-        base->nChainTx = au_data.nChainTx;\n-        LogPrintf(\"[snapshot] set nChainTx=%d for %s\\n\", au_data.nChainTx, snapshot_blockhash->ToString());\n+        base->m_chain_tx_count = au_data.m_chain_tx_count;\n+        LogPrintf(\"[snapshot] set m_chain_tx_count=%d for %s\\n\", au_data.m_chain_tx_count, snapshot_blockhash->ToString());\n     } else {\n         // If this isn't called with a snapshot blockhash, make sure the cached snapshot height\n         // is null. This is relevant during snapshot completion, when the blockman may be loaded\n@@ -449,15 +449,15 @@ bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockha\n                 if (m_snapshot_height && pindex->nHeight == *m_snapshot_height &&\n                         pindex->GetBlockHash() == *snapshot_blockhash) {\n                     // Should have been set above; don't disturb it with code below.\n-                    Assert(pindex->nChainTx > 0);\n-                } else if (pindex->pprev->nChainTx > 0) {\n-                    pindex->nChainTx = pindex->pprev->nChainTx + pindex->nTx;\n+                    Assert(pindex->m_chain_tx_count > 0);\n+                } else if (pindex->pprev->m_chain_tx_count > 0) {\n+                    pindex->m_chain_tx_count = pindex->pprev->m_chain_tx_count + pindex->nTx;\n                 } else {\n-                    pindex->nChainTx = 0;\n+                    pindex->m_chain_tx_count = 0;\n                     m_blocks_unlinked.insert(std::make_pair(pindex->pprev, pindex));\n                 }\n             } else {\n-                pindex->nChainTx = pindex->nTx;\n+                pindex->m_chain_tx_count = pindex->nTx;\n             }\n         }\n         if (!(pindex->nStatus & BLOCK_FAILED_MASK) && pindex->pprev && (pindex->pprev->nStatus & BLOCK_FAILED_MASK)) {\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex 9772b26aea585..02f9ecef341f7 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -1725,16 +1725,16 @@ static RPCHelpMan getchaintxstats()\n \n     UniValue ret(UniValue::VOBJ);\n     ret.pushKV(\"time\", (int64_t)pindex->nTime);\n-    if (pindex->nChainTx) {\n-        ret.pushKV(\"txcount\", pindex->nChainTx);\n+    if (pindex->m_chain_tx_count) {\n+        ret.pushKV(\"txcount\", pindex->m_chain_tx_count);\n     }\n     ret.pushKV(\"window_final_block_hash\", pindex->GetBlockHash().GetHex());\n     ret.pushKV(\"window_final_block_height\", pindex->nHeight);\n     ret.pushKV(\"window_block_count\", blockcount);\n     if (blockcount > 0) {\n         ret.pushKV(\"window_interval\", nTimeDiff);\n-        if (pindex->nChainTx != 0 && past_block.nChainTx != 0) {\n-            const auto window_tx_count = pindex->nChainTx - past_block.nChainTx;\n+        if (pindex->m_chain_tx_count != 0 && past_block.m_chain_tx_count != 0) {\n+            const auto window_tx_count = pindex->m_chain_tx_count - past_block.m_chain_tx_count;\n             ret.pushKV(\"window_tx_count\", window_tx_count);\n             if (nTimeDiff > 0) {\n                 ret.pushKV(\"txrate\", double(window_tx_count) / nTimeDiff);\n@@ -2799,7 +2799,7 @@ UniValue CreateUTXOSnapshot(\n     result.pushKV(\"base_height\", tip->nHeight);\n     result.pushKV(\"path\", path.utf8string());\n     result.pushKV(\"txoutset_hash\", maybe_stats->hashSerialized.ToString());\n-    result.pushKV(\"nchaintx\", tip->nChainTx);\n+    result.pushKV(\"nchaintx\", tip->m_chain_tx_count);\n     return result;\n }\n \ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex d6b3924cda0e3..9126d8e928e30 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2956,7 +2956,7 @@ static void UpdateTipLog(\n     LogPrintf(\"%s%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\",\n         prefix, func_name,\n         tip->GetBlockHash().ToString(), tip->nHeight, tip->nVersion,\n-        log(tip->nChainWork.getdouble()) / log(2.0), (unsigned long)tip->nChainTx,\n+        log(tip->nChainWork.getdouble()) / log(2.0), tip->m_chain_tx_count,\n         FormatISO8601DateTime(tip->GetBlockTime()),\n         GuessVerificationProgress(params.TxData(), tip),\n         coins_tip.DynamicMemoryUsage() * (1.0 / (1 << 20)),\n@@ -3846,17 +3846,17 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n {\n     AssertLockHeld(cs_main);\n     pindexNew->nTx = block.vtx.size();\n-    // Typically nChainTx will be 0 at this point, but it can be nonzero if this\n+    // Typically m_chain_tx_count will be 0 at this point, but it can be nonzero if this\n     // is a pruned block which is being downloaded again, or if this is an\n-    // assumeutxo snapshot block which has a hardcoded nChainTx value from the\n+    // assumeutxo snapshot block which has a hardcoded m_chain_tx_count value from the\n     // snapshot metadata. If the pindex is not the snapshot block and the\n-    // nChainTx value is not zero, assert that value is actually correct.\n-    auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->nChainTx : 0); };\n-    if (!Assume(pindexNew->nChainTx == 0 || pindexNew->nChainTx == prev_tx_sum(*pindexNew) ||\n+    // m_chain_tx_count value is not zero, assert that value is actually correct.\n+    auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->m_chain_tx_count : 0); };\n+    if (!Assume(pindexNew->m_chain_tx_count == 0 || pindexNew->m_chain_tx_count == prev_tx_sum(*pindexNew) ||\n                 pindexNew == GetSnapshotBaseBlock())) {\n-        LogWarning(\"Internal bug detected: block %d has unexpected nChainTx %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n-            pindexNew->nHeight, pindexNew->nChainTx, prev_tx_sum(*pindexNew), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n-        pindexNew->nChainTx = 0;\n+        LogWarning(\"Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n+            pindexNew->nHeight, pindexNew->m_chain_tx_count, prev_tx_sum(*pindexNew), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n+        pindexNew->m_chain_tx_count = 0;\n     }\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n@@ -3877,15 +3877,15 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n         while (!queue.empty()) {\n             CBlockIndex *pindex = queue.front();\n             queue.pop_front();\n-            // Before setting nChainTx, assert that it is 0 or already set to\n+            // Before setting m_chain_tx_count, assert that it is 0 or already set to\n             // the correct value. This assert will fail after receiving the\n             // assumeutxo snapshot block if assumeutxo snapshot metadata has an\n-            // incorrect hardcoded AssumeutxoData::nChainTx value.\n-            if (!Assume(pindex->nChainTx == 0 || pindex->nChainTx == prev_tx_sum(*pindex))) {\n-                LogWarning(\"Internal bug detected: block %d has unexpected nChainTx %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n-                   pindex->nHeight, pindex->nChainTx, prev_tx_sum(*pindex), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n+            // incorrect hardcoded AssumeutxoData::m_chain_tx_count value.\n+            if (!Assume(pindex->m_chain_tx_count == 0 || pindex->m_chain_tx_count == prev_tx_sum(*pindex))) {\n+                LogWarning(\"Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n+                   pindex->nHeight, pindex->m_chain_tx_count, prev_tx_sum(*pindex), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n             }\n-            pindex->nChainTx = prev_tx_sum(*pindex);\n+            pindex->m_chain_tx_count = prev_tx_sum(*pindex);\n             pindex->nSequenceId = nBlockSequenceId++;\n             for (Chainstate *c : GetAll()) {\n                 c->TryAddBlockIndexCandidate(pindex);\n@@ -5333,17 +5333,17 @@ void ChainstateManager::CheckBlockIndex()\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n         }\n-        // Make sure nChainTx sum is correctly computed.\n+        // Make sure m_chain_tx_count sum is correctly computed.\n         if (!pindex->pprev) {\n-            // If no previous block, nTx and nChainTx must be the same.\n-            assert(pindex->nChainTx == pindex->nTx);\n-        } else if (pindex->pprev->nChainTx > 0 && pindex->nTx > 0) {\n-            // If previous nChainTx is set and number of transactions in block is known, sum must be set.\n-            assert(pindex->nChainTx == pindex->nTx + pindex->pprev->nChainTx);\n+            // If no previous block, nTx and m_chain_tx_count must be the same.\n+            assert(pindex->m_chain_tx_count == pindex->nTx);\n+        } else if (pindex->pprev->m_chain_tx_count > 0 && pindex->nTx > 0) {\n+            // If previous m_chain_tx_count is set and number of transactions in block is known, sum must be set.\n+            assert(pindex->m_chain_tx_count == pindex->nTx + pindex->pprev->m_chain_tx_count);\n         } else {\n-            // Otherwise nChainTx should only be set if this is a snapshot\n+            // Otherwise m_chain_tx_count should only be set if this is a snapshot\n             // block, and must be set if it is.\n-            assert((pindex->nChainTx != 0) == (pindex == snap_base));\n+            assert((pindex->m_chain_tx_count != 0) == (pindex == snap_base));\n         }\n \n         // Chainstate-specific checks on setBlockIndexCandidates\n@@ -5548,13 +5548,13 @@ bool Chainstate::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n }\n \n //! Guess how far we are in the verification process at the given block index\n-//! require cs_main if pindex has not been validated yet (because nChainTx might be unset)\n+//! require cs_main if pindex has not been validated yet (because m_chain_tx_count might be unset)\n double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pindex) {\n     if (pindex == nullptr)\n         return 0.0;\n \n-    if (!Assume(pindex->nChainTx > 0)) {\n-        LogWarning(\"Internal bug detected: block %d has unset nChainTx (%s %s). Please report this issue here: %s\\n\",\n+    if (!Assume(pindex->m_chain_tx_count > 0)) {\n+        LogWarning(\"Internal bug detected: block %d has unset m_chain_tx_count (%s %s). Please report this issue here: %s\\n\",\n                    pindex->nHeight, PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n         return 0.0;\n     }\n@@ -5563,13 +5563,13 @@ double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pin\n \n     double fTxTotal;\n \n-    if (pindex->nChainTx <= data.nTxCount) {\n-        fTxTotal = data.nTxCount + (nNow - data.nTime) * data.dTxRate;\n+    if (pindex->m_chain_tx_count <= data.tx_count) {\n+        fTxTotal = data.tx_count + (nNow - data.nTime) * data.dTxRate;\n     } else {\n-        fTxTotal = pindex->nChainTx + (nNow - pindex->GetBlockTime()) * data.dTxRate;\n+        fTxTotal = pindex->m_chain_tx_count + (nNow - pindex->GetBlockTime()) * data.dTxRate;\n     }\n \n-    return std::min<double>(pindex->nChainTx / fTxTotal, 1.0);\n+    return std::min<double>(pindex->m_chain_tx_count / fTxTotal, 1.0);\n }\n \n std::optional<uint256> ChainstateManager::SnapshotBlockhash() const\n@@ -6026,7 +6026,7 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     assert(index);\n     assert(index == snapshot_start_block);\n-    index->nChainTx = au_data.nChainTx;\n+    index->m_chain_tx_count = au_data.m_chain_tx_count;\n     snapshot_chainstate.setBlockIndexCandidates.insert(snapshot_start_block);\n \n     LogPrintf(\"[snapshot] validated snapshot (%.2f MB)\\n\",\n", "instance_id": "bitcoin__bitcoin-29656", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in its intent to update the `nChainTx` variable to a 64-bit type to prevent potential overflow issues in the future. It provides context about the current value and the timeline for potential overflow, which helps in understanding the motivation behind the change. However, the statement lacks detailed requirements or constraints beyond the type change itself. For instance, it does not explicitly mention compatibility concerns, performance implications, or specific edge cases to handle during the transition. Additionally, there are no examples or test cases provided to validate the change. While the goal is clear, these missing minor details prevent it from being comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4) due to several factors. First, the scope of code changes is moderate but straightforward, involving renaming and updating the type of `nChainTx` to `m_chain_tx_count` (or similar) across multiple files in the Bitcoin codebase. The changes span several files (`chain.h`, `chainparams.cpp`, `chainparams.h`, `blockstorage.cpp`, `blockchain.cpp`, `validation.cpp`), but they are mostly mechanical\u2014replacing variable names and updating types from `unsigned int` or `int64_t` to `uint64_t`. Second, the technical concepts required are minimal, focusing on basic C++ type systems and understanding of variable scope within a struct or class. No complex algorithms, design patterns, or domain-specific knowledge beyond basic blockchain transaction counting are needed. Third, the problem does not appear to introduce significant edge cases or error handling beyond ensuring the new type can hold larger values, and the code changes do not suggest major architectural impacts. While the changes touch multiple parts of the codebase, the repetitive nature of the updates and the lack of deep logical complexity make this an easy task for a developer familiar with C++ and large codebases. A score of 0.25 reflects this balance of moderate scope with low technical depth.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Move to OSC 8 hyperlinks with keyboard in mark mode\n# Description of the new feature/enhancement\r\n\r\nCurrently you can cycle through URLs in the scrollback buffer with tab and shift+tab in mark mode. It would be nice if this also worked with OSC 8 hyperlinks.\r\n\r\nRight now this:\r\n```bash\r\nprintf '\\e]8;;http://example.com\\e\\\\This is a link\\e]8;;\\e\\\\\\nhttp://example.com\\n'\r\n```\r\nonly lets you shift+tab back to the plain text link, not the OSC 8 one, which you would have to navigate to using the arrow keys.\n", "patch": "diff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 9501f64a85e..707415015a6 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -437,7 +437,8 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n     }\r\n \r\n     // 0. Useful tools/vars\r\n-    const auto bufferSize = _activeBuffer().GetSize();\r\n+    const auto& buffer = _activeBuffer();\r\n+    const auto bufferSize = buffer.GetSize();\r\n     const auto viewportHeight = _GetMutableViewport().Height();\r\n \r\n     // The patterns are stored relative to the \"search area\". Initially, this search area will be the viewport,\r\n@@ -504,8 +505,18 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n     };\r\n \r\n     // 1. Look for the hyperlink\r\n-    til::point searchStart = dir == SearchDirection::Forward ? _selection->start : til::point{ bufferSize.Left(), _VisibleStartIndex() };\r\n-    til::point searchEnd = dir == SearchDirection::Forward ? til::point{ bufferSize.RightInclusive(), _VisibleEndIndex() } : _selection->start;\r\n+    til::point searchStart;\r\n+    til::point searchEnd;\r\n+    if (dir == SearchDirection::Forward)\r\n+    {\r\n+        searchStart = _selection->start;\r\n+        searchEnd = til::point{ bufferSize.RightInclusive(), _VisibleEndIndex() };\r\n+    }\r\n+    else\r\n+    {\r\n+        searchStart = til::point{ bufferSize.Left(), _VisibleStartIndex() };\r\n+        searchEnd = _selection->start;\r\n+    }\r\n \r\n     // 1.A) Try searching the current viewport (no scrolling required)\r\n     auto resultList = _patternIntervalTree.findContained(convertToSearchArea(searchStart), convertToSearchArea(searchEnd));\r\n@@ -547,27 +558,81 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n                 searchArea = Viewport::FromDimensions(searchStart, { searchEnd.x + 1, searchEnd.y + 1 });\r\n             }\r\n         }\r\n+    }\r\n \r\n-        // 1.C) Nothing was found. Bail!\r\n-        if (!result.has_value())\r\n+    // 2. We found a hyperlink from the pattern tree. Look for embedded hyperlinks too!\r\n+    // Use the result (if one was found) to narrow down the search.\r\n+    if (dir == SearchDirection::Forward)\r\n+    {\r\n+        searchStart = _selection->start;\r\n+        searchEnd = (result ? result->first : buffer.GetLastNonSpaceCharacter());\r\n+    }\r\n+    else\r\n+    {\r\n+        searchStart = (result ? result->second : bufferSize.Origin());\r\n+        searchEnd = _selection->start;\r\n+    }\r\n+\r\n+    // Careful! Selection can point to RightExclusive(), which doesn't contain data!\r\n+    // Clamp to be safe.\r\n+    auto initialPos = dir == SearchDirection::Forward ? searchStart : searchEnd;\r\n+    bufferSize.Clamp(initialPos);\r\n+    auto iter = buffer.GetCellDataAt(initialPos);\r\n+    while (dir == SearchDirection::Forward ? iter.Pos() < searchEnd : iter.Pos() > searchStart)\r\n+    {\r\n+        // Don't let us select the same hyperlink again\r\n+        if (iter.Pos() < _selection->start || iter.Pos() > _selection->end)\r\n         {\r\n-            return;\r\n+            if (auto attr = iter->TextAttr(); attr.IsHyperlink())\r\n+            {\r\n+                // Found an embedded hyperlink!\r\n+                const auto hyperlinkId = attr.GetHyperlinkId();\r\n+\r\n+                // Expand the start to include the entire hyperlink\r\n+                TextBufferCellIterator hyperlinkStartIter{ buffer, iter.Pos() };\r\n+                while (hyperlinkStartIter.Pos() > searchStart && attr.IsHyperlink() && attr.GetHyperlinkId() == hyperlinkId)\r\n+                {\r\n+                    --hyperlinkStartIter;\r\n+                    attr = hyperlinkStartIter->TextAttr();\r\n+                }\r\n+                if (hyperlinkStartIter.Pos() != bufferSize.Origin())\r\n+                {\r\n+                    // undo a move to be inclusive\r\n+                    ++hyperlinkStartIter;\r\n+                }\r\n+\r\n+                // Expand the end to include the entire hyperlink\r\n+                // No need to undo a move! We'll decrement in the next step anyways.\r\n+                TextBufferCellIterator hyperlinkEndIter{ buffer, iter.Pos() };\r\n+                attr = hyperlinkEndIter->TextAttr();\r\n+                while (hyperlinkEndIter.Pos() < searchEnd && attr.IsHyperlink() && attr.GetHyperlinkId() == hyperlinkId)\r\n+                {\r\n+                    ++hyperlinkEndIter;\r\n+                    attr = hyperlinkEndIter->TextAttr();\r\n+                }\r\n+\r\n+                result = { hyperlinkStartIter.Pos(), hyperlinkEndIter.Pos() };\r\n+                break;\r\n+            }\r\n         }\r\n+        iter += dir == SearchDirection::Forward ? 1 : -1;\r\n     }\r\n \r\n-    // 2. Select the hyperlink\r\n+    // 3. Select the hyperlink, if one exists\r\n+    if (!result.has_value())\r\n     {\r\n-        auto selection{ _selection.write() };\r\n-        wil::hide_name _selection;\r\n-        selection->start = result->first;\r\n-        selection->pivot = result->first;\r\n-        selection->end = result->second;\r\n-        _selectionIsTargetingUrl = true;\r\n-        _selectionEndpoint = SelectionEndpoint::End;\r\n+        return;\r\n     }\r\n-\r\n-    // 3. Scroll to the selected area (if necessary)\r\n-    _ScrollToPoint(_selection->end);\r\n+    auto selection{ _selection.write() };\r\n+    wil::hide_name _selection;\r\n+    selection->start = result->first;\r\n+    selection->pivot = result->first;\r\n+    selection->end = result->second;\r\n+    _selectionIsTargetingUrl = true;\r\n+    _selectionEndpoint = SelectionEndpoint::End;\r\n+\r\n+    // 4. Scroll to the selected area (if necessary)\r\n+    _ScrollToPoint(selection->end);\r\n }\r\n \r\n Terminal::UpdateSelectionParams Terminal::ConvertKeyEventToUpdateSelectionParams(const ControlKeyStates mods, const WORD vkey) const noexcept\r\n", "instance_id": "microsoft__terminal-18347", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the desired enhancement: enabling navigation to OSC 8 hyperlinks in mark mode using keyboard shortcuts (tab and shift+tab), similar to how plain text URLs are currently handled. It provides a specific example with a bash command to illustrate the current limitation and the expected behavior. However, there are minor ambiguities and missing details. For instance, it does not explicitly define how OSC 8 hyperlinks should be prioritized or interact with plain text URLs during navigation (e.g., should both types be cycled through together, or should there be a distinction?). Additionally, edge cases such as overlapping hyperlinks, empty buffers, or invalid OSC 8 sequences are not mentioned. While the goal is understandable, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is moderate, primarily confined to a single file (`TerminalSelection.cpp`) and specifically to the `SelectHyperlink` function. The changes involve adding logic to detect and handle OSC 8 hyperlinks alongside existing pattern-based URL detection, which requires understanding the existing codebase's buffer and selection mechanisms. Second, the technical concepts involved include familiarity with terminal escape sequences (OSC 8), text buffer iteration, and hyperlink attribute handling, which are moderately complex but not overly advanced. Third, the code changes are significant, adding new logic for iterating through buffer cells to detect embedded hyperlinks and expanding selections to cover entire hyperlink ranges, which introduces complexity in managing positions and boundaries. Finally, while the problem statement does not explicitly mention edge cases, the code changes implicitly address scenarios like ensuring the selection does not overlap with the current selection and handling buffer boundaries, which adds some intricacy to the implementation. Overall, this task requires a solid understanding of the terminal's internal data structures and selection logic, but it does not impact the broader system architecture or demand advanced domain-specific knowledge, placing it in the medium difficulty range at 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Original console buffer is not restored when closing a secondary one\n### Windows Terminal version\r\n\r\n1.22.240823002-preview\r\n\r\n### Windows build number\r\n\r\n10.0.19045\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nReduced test code (by lhecker): \r\n```cpp\r\n#define WIN32_LEAN_AND_MEAN\r\n#include <Windows.h>\r\n\r\nint main() {\r\n    const auto buffer = CreateConsoleScreenBuffer(GENERIC_READ | GENERIC_WRITE, 0, nullptr, CONSOLE_TEXTMODE_BUFFER, nullptr);\r\n    SetConsoleActiveScreenBuffer(buffer);\r\n    CloseHandle(buffer);\r\n    return 0;\r\n}\r\n```\r\n\r\n---\r\n\r\nRun a program which creates and activates a new console screen buffer using `CreateConsoleScreenBuffer` and `SetConsoleActiveScreenBuffer`.\r\n\r\nThe following C program with argument value 0-4 does all combos:\r\n```\r\n// usage: *argv 0|1|2|3|4\r\n// create+activate new screen buffer, print a message to it, sleep 1s, then before exit:\r\n//   0: do nothing.\r\n//   1: CloseHandle(newbuf).\r\n//   2: SetConsoleActiveScreenBuffer(orig_con)\r\n//   3: CloseHandle(newbuf), SetConsoleActiveScreenBuffer(orig_con)\r\n//   4: SetConsoleActiveScreenBuffer(orig_con), CloseHandle(newbuf)\r\n```\r\n\r\n<details>\r\n<summary>newbuf.c</summary>\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <string.h>\r\n#include <stdlib.h>\r\n#include <windows.h>\r\n\r\n\r\n#define writecon(h, s) WriteConsole(h, (s), strlen(s), 0, 0)\r\n#define ERR_EXIT(...) (fprintf(stderr, __VA_ARGS__), exit(1), 0)\r\n\r\n// usage: *argv 0|1|2|3|4\r\n// create+activate new screen buffer, print a message to it, sleep 1s, then before exit:\r\n//   0: do nothing.\r\n//   1: CloseHandle(newbuf).\r\n//   2: SetConsoleActiveScreenBuffer(orig_con)\r\n//   3: CloseHandle(newbuf), SetConsoleActiveScreenBuffer(orig_con)\r\n//   4: SetConsoleActiveScreenBuffer(orig_con), CloseHandle(newbuf)\r\n\r\nint main(int argc, char **argv)\r\n{\r\n\tint mode = argc > 1 ? atoi(argv[1]) : 0;\r\n\r\n\tHANDLE hcon = GetStdHandle(STD_OUTPUT_HANDLE);\r\n\tif (hcon == INVALID_HANDLE_VALUE)\r\n\t\tERR_EXIT(\"can't get stdout handle\\n\");\r\n\r\n\tif (!writecon(hcon, \"orig screen buffer\\n\"))\r\n\t\tERR_EXIT(\"can't write to stdout console\\n\");\r\n\r\n\tHANDLE hnewbuf = CreateConsoleScreenBuffer(\r\n\t\tGENERIC_WRITE, FILE_SHARE_WRITE,\r\n\t\t0, CONSOLE_TEXTMODE_BUFFER, 0);\r\n\tif (hnewbuf == INVALID_HANDLE_VALUE)\r\n\t\tERR_EXIT(\"can't create new screen buf\\n\");\r\n\r\n\tif (!SetConsoleActiveScreenBuffer(hnewbuf))\r\n\t\tERR_EXIT(\"can't activete new screen buf\\n\");\r\n\r\n\tif (!writecon(hnewbuf, \"new screen buffer\\n\"))\r\n\t\tERR_EXIT(\"can't write to new screen buf\\n\");\r\n\r\n\tSleep(1000);\r\n\r\n\t// all combos of \"close new buf\" and \"restore orig buff\", + reverse order.\r\n\t//\r\n\t// expected result:\r\n\t// - all combos restore the original buf on exit (maybe implicitly)\r\n\t//\r\n\t// actual result:\r\n\t// - Working as expected in conhost.exe or OpenConsole.exe (including 1.22)\r\n\t//   or Windows Terminal (up to and including 1.21).\r\n\t//\r\n\t// - in Windows Terminal 1.22: only 2 and 4 work as expected\r\n\t//   (\"restore orig buf\" without or before \"close new buf\")\r\n\t//   - 0: no close and no manual restore: not restored.\r\n\t//   - 1: close only: not restored.\r\n\t//   - 3: close and restored manually: not restored.\r\n\r\n\tswitch (mode) {\r\n\t\tcase 0:\r\n\t\t\tbreak;\r\n\r\n\t\tcase 1:\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tbreak;\r\n\r\n\t\tcase 2:\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tbreak;\r\n\r\n\t\tcase 3:\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tbreak;\r\n\r\n\t\tcase 4:  // like 3 but in reverse order\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tbreak;\r\n\t}\r\n\r\n\treturn 0;\r\n}\r\n```\r\n\r\n</details>\r\n\r\n\r\n\r\n### Expected Behavior\r\n\r\nOriginal screen buffer is restored when the application exits (its content and original cursor position), regardless if the new screen buffer handle is closed or not, and regardless if the original screen buffer is re-activated before exit.\r\n\r\n### Actual Behavior\r\n\r\nNo issue in conhost.exe or OpenConsole.exe (even of 1.22), or Windows terminal up to and including 1.21.\r\n\r\nWith Windows terminal 1.22 (preview):\r\n- The original screen buffer is only restored if `SetConsoleActiveScreenBuffer(orig_con)` is invoked without or before `CloseHandle(h_newbuf)`.\r\n- Specifically, it's not restored if:\r\n  - Neither `CloseHandle` nor `SetConsoleActiveScreenBuffer(orig_con)` are used.\r\n  - Only `CloseHandle` is used.\r\n  - Both `CloseHandle` and `SetConsoleActiveScreenBuffer(orig_con)` are used in that order.\n", "patch": "diff --git a/src/host/VtIo.cpp b/src/host/VtIo.cpp\nindex 026010b2f70..d64d142d210 100644\n--- a/src/host/VtIo.cpp\n+++ b/src/host/VtIo.cpp\n@@ -6,6 +6,7 @@\n \r\n #include <til/unicode.h>\r\n \r\n+#include \"directio.h\"\r\n #include \"handle.h\" // LockConsole\r\n #include \"output.h\" // CloseConsoleProcessState\r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n@@ -790,3 +791,51 @@ void VtIo::Writer::WriteInfos(til::point target, std::span<const CHAR_INFO> info\n         } while (--repeat);\r\n     }\r\n }\r\n+\r\n+void VtIo::Writer::WriteScreenInfo(SCREEN_INFORMATION& newContext, til::size oldSize) const\r\n+{\r\n+    const auto area = static_cast<size_t>(oldSize.width * oldSize.height);\r\n+\r\n+    auto& main = newContext.GetMainBuffer();\r\n+    auto& alt = newContext.GetActiveBuffer();\r\n+    const auto hasAltBuffer = &alt != &main;\r\n+\r\n+    // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n+    if (oldSize != main.GetBufferSize().Dimensions())\r\n+    {\r\n+        THROW_IF_NTSTATUS_FAILED(main.ResizeTraditional(oldSize));\r\n+        main.SetViewportSize(&oldSize);\r\n+    }\r\n+    if (hasAltBuffer && oldSize != alt.GetBufferSize().Dimensions())\r\n+    {\r\n+        THROW_IF_NTSTATUS_FAILED(alt.ResizeTraditional(oldSize));\r\n+        alt.SetViewportSize(&oldSize);\r\n+    }\r\n+\r\n+    const auto request = Viewport::FromDimensions({}, oldSize);\r\n+    Viewport read;\r\n+    til::small_vector<CHAR_INFO, 1024> infos;\r\n+    infos.resize(area, CHAR_INFO{ L' ', FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED });\r\n+\r\n+    const auto dumpScreenInfo = [&](SCREEN_INFORMATION& screenInfo) {\r\n+        THROW_IF_FAILED(ReadConsoleOutputWImplHelper(screenInfo, infos, request, read));\r\n+        for (til::CoordType i = 0; i < oldSize.height; i++)\r\n+        {\r\n+            WriteInfos({ 0, i }, { infos.begin() + i * oldSize.width, static_cast<size_t>(oldSize.width) });\r\n+        }\r\n+\r\n+        WriteCUP(screenInfo.GetTextBuffer().GetCursor().GetPosition());\r\n+        WriteAttributes(screenInfo.GetAttributes());\r\n+        WriteDECTCEM(screenInfo.GetTextBuffer().GetCursor().IsVisible());\r\n+        WriteDECAWM(WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n+    };\r\n+\r\n+    WriteASB(false);\r\n+    dumpScreenInfo(main);\r\n+\r\n+    if (hasAltBuffer)\r\n+    {\r\n+        WriteASB(true);\r\n+        dumpScreenInfo(alt);\r\n+    }\r\n+}\r\ndiff --git a/src/host/VtIo.hpp b/src/host/VtIo.hpp\nindex a5d13764261..4e9d250c4cf 100644\n--- a/src/host/VtIo.hpp\n+++ b/src/host/VtIo.hpp\n@@ -44,6 +44,7 @@ namespace Microsoft::Console::VirtualTerminal\n             void WriteWindowTitle(std::wstring_view title) const;\r\n             void WriteAttributes(const TextAttribute& attributes) const;\r\n             void WriteInfos(til::point target, std::span<const CHAR_INFO> infos) const;\r\n+            void WriteScreenInfo(SCREEN_INFORMATION& newContext, til::size oldSize) const;\r\n \r\n         private:\r\n             VtIo* _io = nullptr;\r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex cb3c80d7bbb..81701a9f874 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -487,49 +487,8 @@ void ApiRoutines::SetConsoleActiveScreenBufferImpl(SCREEN_INFORMATION& newContex\n \r\n         if (auto writer = gci.GetVtWriter())\r\n         {\r\n-            const auto viewport = gci.GetActiveOutputBuffer().GetBufferSize();\r\n-            const auto size = viewport.Dimensions();\r\n-            const auto area = static_cast<size_t>(viewport.Width() * viewport.Height());\r\n-\r\n-            auto& main = newContext.GetMainBuffer();\r\n-            auto& alt = newContext.GetActiveBuffer();\r\n-            const auto hasAltBuffer = &alt != &main;\r\n-\r\n-            // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n-            THROW_IF_NTSTATUS_FAILED(main.ResizeTraditional(size));\r\n-            main.SetViewportSize(&size);\r\n-            if (hasAltBuffer)\r\n-            {\r\n-                THROW_IF_NTSTATUS_FAILED(alt.ResizeTraditional(size));\r\n-                alt.SetViewportSize(&size);\r\n-            }\r\n-\r\n-            Viewport read;\r\n-            til::small_vector<CHAR_INFO, 1024> infos;\r\n-            infos.resize(area, CHAR_INFO{ L' ', FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED });\r\n-\r\n-            const auto dumpScreenInfo = [&](SCREEN_INFORMATION& screenInfo) {\r\n-                THROW_IF_FAILED(ReadConsoleOutputWImpl(screenInfo, infos, viewport, read));\r\n-                for (til::CoordType i = 0; i < size.height; i++)\r\n-                {\r\n-                    writer.WriteInfos({ 0, i }, { infos.begin() + i * size.width, static_cast<size_t>(size.width) });\r\n-                }\r\n-\r\n-                writer.WriteCUP(screenInfo.GetTextBuffer().GetCursor().GetPosition());\r\n-                writer.WriteAttributes(screenInfo.GetAttributes());\r\n-                writer.WriteDECTCEM(screenInfo.GetTextBuffer().GetCursor().IsVisible());\r\n-                writer.WriteDECAWM(WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n-            };\r\n-\r\n-            writer.WriteASB(false);\r\n-            dumpScreenInfo(main);\r\n-\r\n-            if (hasAltBuffer)\r\n-            {\r\n-                writer.WriteASB(true);\r\n-                dumpScreenInfo(alt);\r\n-            }\r\n-\r\n+            const auto oldSize = gci.GetActiveOutputBuffer().GetBufferSize().Dimensions();\r\n+            writer.WriteScreenInfo(newContext, oldSize);\r\n             writer.Submit();\r\n         }\r\n \r\ndiff --git a/src/server/ObjectHandle.cpp b/src/server/ObjectHandle.cpp\nindex 1fbf69976fc..64f2d51a4c5 100644\n--- a/src/server/ObjectHandle.cpp\n+++ b/src/server/ObjectHandle.cpp\n@@ -273,7 +273,18 @@ INPUT_READ_HANDLE_DATA* ConsoleHandleData::GetClientInput() const\n     LOG_IF_FAILED(pScreenInfo->FreeIoHandle(this));\r\n     if (!pScreenInfo->HasAnyOpenHandles())\r\n     {\r\n+        auto& gci = Microsoft::Console::Interactivity::ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        const auto oldSize = gci.GetActiveOutputBuffer().GetBufferSize().Dimensions();\r\n+        auto writer = gci.GetVtWriter();\r\n+\r\n         SCREEN_INFORMATION::s_RemoveScreenBuffer(pScreenInfo);\r\n+\r\n+        if (writer && gci.HasActiveOutputBuffer())\r\n+        {\r\n+            auto& newContext = gci.GetActiveOutputBuffer();\r\n+            writer.WriteScreenInfo(newContext, oldSize);\r\n+            writer.Submit();\r\n+        }\r\n     }\r\n \r\n     return S_OK;\r\n", "instance_id": "microsoft__terminal-17853", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue with the Windows Terminal version 1.22 (preview) where the original console screen buffer is not restored under specific conditions when closing a secondary buffer. It provides detailed steps to reproduce the issue, including test code and expected versus actual behavior. The inclusion of different test scenarios (modes 0-4) helps in understanding the specific conditions under which the problem occurs. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss potential edge cases beyond the provided test scenarios, nor does it specify if there are any performance or compatibility constraints to consider when implementing a fix. Additionally, while the expected behavior is described, there is no mention of any specific requirements or constraints for the solution (e.g., maintaining compatibility with older versions or specific Windows APIs). Thus, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.65, placing it in the \"Hard\" category. This assessment is based on the following factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem is mostly clear, the underlying issue involves nuanced behavior of Windows console APIs (`CreateConsoleScreenBuffer`, `SetConsoleActiveScreenBuffer`, `CloseHandle`), which requires a deep understanding of how these APIs interact with the Windows Terminal's internal state management. The logic of screen buffer restoration is inherently complex due to the stateful nature of console handling.\n\n2. **Scope and Depth of Code Changes**: The provided code changes span multiple files (`VtIo.cpp`, `VtIo.hpp`, `getset.cpp`, `ObjectHandle.cpp`), indicating that the fix requires modifications across different parts of the codebase. The changes involve refactoring existing logic (e.g., moving screen buffer writing logic into a reusable function `WriteScreenInfo`) and adding new behavior when a screen buffer handle is closed. While the amount of code change is moderate (adding a new function and invoking it in two places), the impact is significant as it touches core console handling logic, which could affect the system's behavior broadly.\n\n3. **Number of Technical Concepts**: Solving this problem requires understanding several technical concepts, including Windows console API behavior, virtual terminal (VT) sequences, and the internal architecture of the Windows Terminal (e.g., how screen buffers are managed between main and alternate buffers). Familiarity with C++ and the specific libraries used in the codebase (e.g., `til` utilities for terminal operations) is necessary. Additionally, the developer must understand how state transitions (e.g., active buffer changes, handle closures) are handled within the terminal's architecture, which adds to the complexity.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement highlights specific scenarios where the original buffer is not restored, but the code changes must ensure that the fix does not introduce new issues, such as incorrect buffer resizing, cursor positioning errors, or attribute mismatches. The provided changes handle resizing and writing screen information for both main and alternate buffers, which suggests attention to detail, but additional edge cases (e.g., multiple rapid buffer switches, invalid handle states, or memory constraints during resizing) may need to be considered. Error handling is present in the form of `THROW_IF_NTSTATUS_FAILED` and `THROW_IF_FAILED`, but ensuring robustness across all scenarios adds to the difficulty.\n\nOverall, this problem requires a deep understanding of the Windows Terminal's internals and careful handling of state management across multiple components. The modifications, while not extensive in terms of lines of code, have a significant impact on core functionality, and the need to handle potential edge cases and ensure compatibility with existing behavior pushes this into the \"Hard\" category. It does not reach \"Very Hard\" as it does not involve system-level redesign or highly specialized domain knowledge beyond Windows console programming.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Mouse events are not sent when the mouse is outside the top of the WT\n### Windows Terminal version\r\n\r\nVers\u00e3o: 1.20.11781.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.0\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nPlease clone this GitHub repository [MouseTests](https://github.com/BDisp/MouseTests.git) and run. Keep pressing the mouse inside the console and move around it, as the gif show.\r\n\r\n### Expected Behavior\r\n\r\nThe mouse events should be sent while the mouse button is pressed and moving inside or outside the console until it's released.\r\n\r\n### Actual Behavior\r\n\r\nThe mouse events are sent as expected except from outside of the console on top.\r\n\r\n![MouseTests](https://github.com/user-attachments/assets/aa84e08d-a96f-43e2-a1ee-8ae199ba74d3)\r\n\r\nWith the `conhost` the mouse events are always sent from anywhere while the mouse isn't released.\n", "patch": "diff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex 7b59babd2e5..f18851c2fbb 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -329,7 +329,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         _touchAnchor = contactPoint;\r\n     }\r\n \r\n-    void ControlInteractivity::PointerMoved(Control::MouseButtonState buttonState,\r\n+    bool ControlInteractivity::PointerMoved(Control::MouseButtonState buttonState,\r\n                                             const unsigned int pointerUpdateKind,\r\n                                             const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                             const bool focused,\r\n@@ -337,11 +337,14 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                             const bool pointerPressedInBounds)\r\n     {\r\n         const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        // Returning true from this function indicates that the caller should do no further processing of this movement.\r\n+        bool handledCompletely = false;\r\n \r\n         // Short-circuit isReadOnly check to avoid warning dialog\r\n         if (focused && !_core->IsInReadOnlyMode() && _canSendVTMouseInput(modifiers))\r\n         {\r\n             _sendMouseEventHelper(terminalPosition, pointerUpdateKind, modifiers, 0, buttonState);\r\n+            handledCompletely = true;\r\n         }\r\n         // GH#4603 - don't modify the selection if the pointer press didn't\r\n         // actually start _in_ the control bounds. Case in point - someone drags\r\n@@ -378,6 +381,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n \r\n         _core->SetHoveredCell(terminalPosition.to_core_point());\r\n+        return handledCompletely;\r\n     }\r\n \r\n     void ControlInteractivity::TouchMoved(const Core::Point newTouchPoint,\r\n@@ -682,13 +686,10 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                                      const SHORT wheelDelta,\r\n                                                      Control::MouseButtonState buttonState)\r\n     {\r\n-        const auto adjustment = _core->ScrollOffset() > 0 ? _core->BufferHeight() - _core->ScrollOffset() - _core->ViewHeight() : 0;\r\n-        // If the click happened outside the active region, just don't send any mouse event\r\n-        if (const auto adjustedY = terminalPosition.y - adjustment; adjustedY >= 0)\r\n-        {\r\n-            return _core->SendMouseEvent({ terminalPosition.x, adjustedY }, pointerUpdateKind, modifiers, wheelDelta, toInternalMouseState(buttonState));\r\n-        }\r\n-        return false;\r\n+        const auto adjustment = _core->BufferHeight() - _core->ScrollOffset() - _core->ViewHeight();\r\n+        // If the click happened outside the active region, core should get a chance to filter it out or clamp it.\r\n+        const auto adjustedY = terminalPosition.y - adjustment;\r\n+        return _core->SendMouseEvent({ terminalPosition.x, adjustedY }, pointerUpdateKind, modifiers, wheelDelta, toInternalMouseState(buttonState));\r\n     }\r\n \r\n     // Method Description:\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 38789827ec3..22eaa95c397 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -58,7 +58,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                             const Core::Point pixelPosition);\r\n         void TouchPressed(const Core::Point contactPoint);\r\n \r\n-        void PointerMoved(Control::MouseButtonState buttonState,\r\n+        bool PointerMoved(Control::MouseButtonState buttonState,\r\n                           const unsigned int pointerUpdateKind,\r\n                           const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                           const bool focused,\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.idl b/src/cascadia/TerminalControl/ControlInteractivity.idl\nindex d1ca9720dc6..926c1e3b0a9 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.idl\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.idl\n@@ -43,12 +43,12 @@ namespace Microsoft.Terminal.Control\n                             Microsoft.Terminal.Core.Point pixelPosition);\r\n         void TouchPressed(Microsoft.Terminal.Core.Point contactPoint);\r\n \r\n-        void PointerMoved(MouseButtonState buttonState,\r\n-                          UInt32 pointerUpdateKind,\r\n-                          Microsoft.Terminal.Core.ControlKeyStates modifiers,\r\n-                          Boolean focused,\r\n-                          Microsoft.Terminal.Core.Point pixelPosition,\r\n-                          Boolean pointerPressedInBounds);\r\n+        Boolean PointerMoved(MouseButtonState buttonState,\r\n+                             UInt32 pointerUpdateKind,\r\n+                             Microsoft.Terminal.Core.ControlKeyStates modifiers,\r\n+                             Boolean focused,\r\n+                             Microsoft.Terminal.Core.Point pixelPosition,\r\n+                             Boolean pointerPressedInBounds);\r\n \r\n         void TouchMoved(Microsoft.Terminal.Core.Point newTouchPoint,\r\n                         Boolean focused);\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..f6874c35e75 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -1910,18 +1910,18 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         if (type == Windows::Devices::Input::PointerDeviceType::Mouse ||\r\n             type == Windows::Devices::Input::PointerDeviceType::Pen)\r\n         {\r\n-            _interactivity.PointerMoved(TermControl::GetPressedMouseButtons(point),\r\n-                                        TermControl::GetPointerUpdateKind(point),\r\n-                                        ControlKeyStates(args.KeyModifiers()),\r\n-                                        _focused,\r\n-                                        pixelPosition.to_core_point(),\r\n-                                        _pointerPressedInBounds);\r\n+            auto suppressFurtherHandling = _interactivity.PointerMoved(TermControl::GetPressedMouseButtons(point),\r\n+                                                                       TermControl::GetPointerUpdateKind(point),\r\n+                                                                       ControlKeyStates(args.KeyModifiers()),\r\n+                                                                       _focused,\r\n+                                                                       pixelPosition.to_core_point(),\r\n+                                                                       _pointerPressedInBounds);\r\n \r\n             // GH#9109 - Only start an auto-scroll when the drag actually\r\n             // started within our bounds. Otherwise, someone could start a drag\r\n             // outside the terminal control, drag into the padding, and trick us\r\n             // into starting to scroll.\r\n-            if (_focused && _pointerPressedInBounds && point.Properties().IsLeftButtonPressed())\r\n+            if (!suppressFurtherHandling && _focused && _pointerPressedInBounds && point.Properties().IsLeftButtonPressed())\r\n             {\r\n                 // We want to find the distance relative to the bounds of the\r\n                 // SwapChainPanel, not the entire control. If they drag out of\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\nindex a5d443b915a..49fcd6d21eb 100644\n--- a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n@@ -998,16 +998,15 @@ namespace ControlUnitTests\n         VERIFY_IS_GREATER_THAN(core->ScrollOffset(), 0);\r\n \r\n         // Viewport is now above the mutable viewport, so the mouse event\r\n-        // straight up won't be sent to the terminal.\r\n+        // will be clamped to the top line.\r\n \r\n-        expectedOutput.push_back(L\"sentinel\"); // Clearly, it won't be this string\r\n+        expectedOutput.push_back(L\"\\x1b[M &!\"); // 5, 1\r\n         interactivity->PointerPressed(leftMouseDown,\r\n                                       WM_LBUTTONDOWN, //pointerUpdateKind\r\n                                       0, // timestamp\r\n                                       modifiers,\r\n                                       cursorPosition0.to_core_point());\r\n         // Flush it out.\r\n-        conn->WriteInput(winrt_wstring_to_array_view(L\"sentinel\"));\r\n         VERIFY_ARE_EQUAL(0u, expectedOutput.size(), L\"Validate we drained all the expected output\");\r\n \r\n         // This is the part as mentioned in GH#12719\r\n", "instance_id": "microsoft__terminal-17779", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: mouse events are not being sent when the mouse is outside the top of the Windows Terminal (WT). It provides a specific version of the software, a reproducible test case via a GitHub repository, and a visual aid (GIF) to illustrate the issue. The expected behavior (mouse events should be sent regardless of position while the button is pressed) and actual behavior (events not sent when outside the top) are explicitly stated, which helps in understanding the goal. However, there are minor ambiguities and missing details. For instance, the problem does not specify whether this behavior is expected across different Windows versions or configurations, nor does it mention potential edge cases like multi-monitor setups or specific mouse hardware. Additionally, constraints or requirements for the fix (e.g., performance considerations or compatibility with existing features) are not provided. These omissions prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes involves multiple files (ControlInteractivity.cpp, ControlInteractivity.h, ControlInteractivity.idl, TermControl.cpp, and unit tests), indicating a need to understand interactions between different components of the Windows Terminal codebase. The changes are not trivial; they modify the behavior of mouse event handling by adjusting how events are processed and sent, including changing the return type of a method (PointerMoved) to indicate whether further processing is needed. This requires a moderate understanding of the terminal's event handling architecture.\n\nSecond, the technical concepts involved include familiarity with C++ (specifically modern C++ with WinRT), Windows API for mouse input handling, and the internal logic of the Windows Terminal's control interactivity system. While these are not extremely advanced topics, they do require specific domain knowledge of GUI event systems and terminal emulation, which adds to the complexity.\n\nThird, the problem touches on edge cases, such as ensuring mouse events are correctly handled outside the visible bounds of the terminal. The code changes suggest a need to handle or clamp coordinates (e.g., adjusting Y position based on scroll offset), which introduces moderate complexity in ensuring correctness across various scenarios. However, the problem does not appear to involve deep architectural refactoring or performance-critical optimizations, nor does it require advanced algorithms or system-level programming.\n\nFinally, the impact of the changes is localized to the mouse event handling logic and does not seem to affect the broader system architecture significantly. The amount of code changed is relatively small but meaningful, requiring careful testing (as evidenced by updates to unit tests). Balancing these factors, a difficulty score of 0.55 reflects a medium-level challenge that demands a solid understanding of the codebase and careful handling of event logic, but does not reach the level of hard or very hard due to the absence of broader systemic impact or highly intricate logic.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "RangeFromPoint and ExpandToEnclosingUnit freezes terminal\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\nhttps://github.com/yinkaisheng/Python-UIAutomation-for-Windows 2.0.19\n\n### Steps to reproduce\n\n```python\r\nimport uiautomation as auto\r\nimport time\r\nimport typing\r\ntime.sleep(5)\r\n[x,y] = auto.GetCursorPos()\r\nc = auto.ControlFromPoint(x,y)\r\nif text_pattern := typing.cast(auto.TextPattern | None, c.GetPattern(auto.PatternId.TextPattern)):\r\n    if r := text_pattern.RangeFromPoint(x,y):\r\n        r.ExpandToEnclosingUnit(auto.TextUnit.Word)\r\n        print(r.GetText())\r\n```\r\nPut the cursor over a terminal window\n\n### Expected Behavior\n\nI get the word under the cursor.\n\n### Actual Behavior\n\nWindows terminals freezes. This program works fine with other software so I don't think the bug is in UIAutomation.\n", "patch": "diff --git a/src/interactivity/win32/uiaTextRange.cpp b/src/interactivity/win32/uiaTextRange.cpp\nindex eb78d090cfc..028e181b383 100644\n--- a/src/interactivity/win32/uiaTextRange.cpp\n+++ b/src/interactivity/win32/uiaTextRange.cpp\n@@ -69,14 +69,14 @@ IFACEMETHODIMP UiaTextRange::Clone(_Outptr_result_maybenull_ ITextRangeProvider*\n     return S_OK;\r\n }\r\n \r\n-void UiaTextRange::_TranslatePointToScreen(til::point* clientPoint) const\r\n+void UiaTextRange::_TranslatePointToScreen(til::point& clientPoint) const\r\n {\r\n-    ClientToScreen(_getWindowHandle(), clientPoint->as_win32_point());\r\n+    ClientToScreen(_getWindowHandle(), clientPoint.as_win32_point());\r\n }\r\n \r\n-void UiaTextRange::_TranslatePointFromScreen(til::point* screenPoint) const\r\n+void UiaTextRange::_TranslatePointFromScreen(til::point& screenPoint) const\r\n {\r\n-    ScreenToClient(_getWindowHandle(), screenPoint->as_win32_point());\r\n+    ScreenToClient(_getWindowHandle(), screenPoint.as_win32_point());\r\n }\r\n \r\n HWND UiaTextRange::_getWindowHandle() const\r\ndiff --git a/src/interactivity/win32/uiaTextRange.hpp b/src/interactivity/win32/uiaTextRange.hpp\nindex 7ea79364d5d..84f8b5a5392 100644\n--- a/src/interactivity/win32/uiaTextRange.hpp\n+++ b/src/interactivity/win32/uiaTextRange.hpp\n@@ -56,8 +56,8 @@ namespace Microsoft::Console::Interactivity::Win32\n         IFACEMETHODIMP Clone(_Outptr_result_maybenull_ ITextRangeProvider** ppRetVal) override;\r\n \r\n     protected:\r\n-        void _TranslatePointToScreen(til::point* clientPoint) const override;\r\n-        void _TranslatePointFromScreen(til::point* screenPoint) const override;\r\n+        void _TranslatePointToScreen(til::point& clientPoint) const override;\r\n+        void _TranslatePointFromScreen(til::point& screenPoint) const override;\r\n \r\n     private:\r\n         HWND _getWindowHandle() const;\r\ndiff --git a/src/types/TermControlUiaTextRange.cpp b/src/types/TermControlUiaTextRange.cpp\nindex 6f3c82e8180..5b26dd5189d 100644\n--- a/src/types/TermControlUiaTextRange.cpp\n+++ b/src/types/TermControlUiaTextRange.cpp\n@@ -73,7 +73,7 @@ IFACEMETHODIMP TermControlUiaTextRange::Clone(_Outptr_result_maybenull_ ITextRan\n //                (0,0) is the top-left of the app window\r\n // Return Value:\r\n // - <none>\r\n-void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) const\r\n+void TermControlUiaTextRange::_TranslatePointToScreen(til::point& clientPoint) const\r\n {\r\n     const gsl::not_null<TermControlUiaProvider*> provider = static_cast<TermControlUiaProvider*>(_pProvider);\r\n \r\n@@ -96,8 +96,8 @@ void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) c\n     // Get scale factor for display\r\n     const auto scaleFactor = provider->GetScaleFactor();\r\n \r\n-    clientPoint->x = includeOffsets(clientPoint->x, boundingRect.left, padding.left, scaleFactor);\r\n-    clientPoint->y = includeOffsets(clientPoint->y, boundingRect.top, padding.top, scaleFactor);\r\n+    clientPoint.x = includeOffsets(clientPoint.x, boundingRect.left, padding.left, scaleFactor);\r\n+    clientPoint.y = includeOffsets(clientPoint.y, boundingRect.top, padding.top, scaleFactor);\r\n }\r\n \r\n // Method Description:\r\n@@ -107,15 +107,13 @@ void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) c\n //                (0,0) is the top-left of the screen\r\n // Return Value:\r\n // - <none>\r\n-void TermControlUiaTextRange::_TranslatePointFromScreen(til::point* screenPoint) const\r\n+void TermControlUiaTextRange::_TranslatePointFromScreen(til::point& screenPoint) const\r\n {\r\n     const gsl::not_null<TermControlUiaProvider*> provider = static_cast<TermControlUiaProvider*>(_pProvider);\r\n \r\n     const auto includeOffsets = [](long screenPos, double termControlPos, double padding, double scaleFactor) {\r\n-        auto result = base::ClampedNumeric<double>(padding);\r\n-        // only the padding is in DIPs now\r\n-        result /= scaleFactor;\r\n-        result -= screenPos;\r\n+        auto result = base::ClampedNumeric<til::CoordType>(screenPos);\r\n+        result -= padding / scaleFactor;\r\n         result -= termControlPos;\r\n         return result;\r\n     };\r\n@@ -130,8 +128,8 @@ void TermControlUiaTextRange::_TranslatePointFromScreen(til::point* screenPoint)\n     // Get scale factor for display\r\n     const auto scaleFactor = provider->GetScaleFactor();\r\n \r\n-    screenPoint->x = includeOffsets(screenPoint->x, boundingRect.left, padding.left, scaleFactor);\r\n-    screenPoint->y = includeOffsets(screenPoint->y, boundingRect.top, padding.top, scaleFactor);\r\n+    screenPoint.x = includeOffsets(screenPoint.x, boundingRect.left, padding.left, scaleFactor);\r\n+    screenPoint.y = includeOffsets(screenPoint.y, boundingRect.top, padding.top, scaleFactor);\r\n }\r\n \r\n til::size TermControlUiaTextRange::_getScreenFontSize() const noexcept\r\ndiff --git a/src/types/TermControlUiaTextRange.hpp b/src/types/TermControlUiaTextRange.hpp\nindex 70ba9cac979..e619583a9e9 100644\n--- a/src/types/TermControlUiaTextRange.hpp\n+++ b/src/types/TermControlUiaTextRange.hpp\n@@ -56,8 +56,8 @@ namespace Microsoft::Terminal\n         IFACEMETHODIMP Clone(_Outptr_result_maybenull_ ITextRangeProvider** ppRetVal) override;\r\n \r\n     protected:\r\n-        void _TranslatePointToScreen(til::point* clientPoint) const override;\r\n-        void _TranslatePointFromScreen(til::point* screenPoint) const override;\r\n+        void _TranslatePointToScreen(til::point& clientPoint) const override;\r\n+        void _TranslatePointFromScreen(til::point& screenPoint) const override;\r\n         til::size _getScreenFontSize() const noexcept override;\r\n     };\r\n }\r\ndiff --git a/src/types/UiaTextRangeBase.cpp b/src/types/UiaTextRangeBase.cpp\nindex 8e83ef47aa0..0ce958e6985 100644\n--- a/src/types/UiaTextRangeBase.cpp\n+++ b/src/types/UiaTextRangeBase.cpp\n@@ -97,30 +97,24 @@ CATCH_RETURN();\n \r\n void UiaTextRangeBase::Initialize(_In_ const UiaPoint point)\r\n {\r\n-    til::point clientPoint;\r\n-    clientPoint.x = static_cast<LONG>(point.x);\r\n-    clientPoint.y = static_cast<LONG>(point.y);\r\n-    // get row that point resides in\r\n+    til::point clientPoint{ static_cast<til::CoordType>(point.x), static_cast<til::CoordType>(point.y) };\r\n+\r\n+    // clamp the point to be within the client area\r\n     const auto windowRect = _getTerminalRect();\r\n+    clientPoint.x = std::clamp(clientPoint.x, windowRect.left, windowRect.right);\r\n+    clientPoint.y = std::clamp(clientPoint.y, windowRect.top, windowRect.bottom);\r\n+\r\n+    // convert point to be relative to client area\r\n+    _TranslatePointFromScreen(clientPoint);\r\n+\r\n+    // convert the point to screen buffer coordinates\r\n+    _pData->LockConsole();\r\n+    const auto currentFontSize = _getScreenFontSize();\r\n     const auto viewport = _pData->GetViewport().ToInclusive();\r\n-    til::CoordType row = 0;\r\n-    if (clientPoint.y <= windowRect.top)\r\n-    {\r\n-        row = viewport.top;\r\n-    }\r\n-    else if (clientPoint.y >= windowRect.bottom)\r\n-    {\r\n-        row = viewport.bottom;\r\n-    }\r\n-    else\r\n-    {\r\n-        // change point coords to pixels relative to window\r\n-        _TranslatePointFromScreen(&clientPoint);\r\n+    _pData->UnlockConsole();\r\n \r\n-        const auto currentFontSize = _getScreenFontSize();\r\n-        row = clientPoint.y / currentFontSize.height + viewport.top;\r\n-    }\r\n-    _start = { 0, row };\r\n+    _start = { clientPoint.x / currentFontSize.width + viewport.left,\r\n+               clientPoint.y / currentFontSize.height + viewport.top };\r\n     _end = _start;\r\n }\r\n \r\n@@ -1381,8 +1375,8 @@ void UiaTextRangeBase::_getBoundingRect(const til::rect& textRect, _Inout_ std::\n \r\n     // convert the coords to be relative to the screen instead of\r\n     // the client window\r\n-    _TranslatePointToScreen(&topLeft);\r\n-    _TranslatePointToScreen(&bottomRight);\r\n+    _TranslatePointToScreen(topLeft);\r\n+    _TranslatePointToScreen(bottomRight);\r\n \r\n     const long width = bottomRight.x - topLeft.x;\r\n     const long height = bottomRight.y - topLeft.y;\r\ndiff --git a/src/types/UiaTextRangeBase.hpp b/src/types/UiaTextRangeBase.hpp\nindex eec30a3dcbd..2b36ccc0efa 100644\n--- a/src/types/UiaTextRangeBase.hpp\n+++ b/src/types/UiaTextRangeBase.hpp\n@@ -123,8 +123,8 @@ namespace Microsoft::Console::Types\n         std::wstring _wordDelimiters{};\r\n         ::Search _searcher;\r\n \r\n-        virtual void _TranslatePointToScreen(til::point* clientPoint) const = 0;\r\n-        virtual void _TranslatePointFromScreen(til::point* screenPoint) const = 0;\r\n+        virtual void _TranslatePointToScreen(til::point& clientPoint) const = 0;\r\n+        virtual void _TranslatePointFromScreen(til::point& screenPoint) const = 0;\r\n \r\n         void Initialize(_In_ const UiaPoint point);\r\n \r\n", "instance_id": "microsoft__terminal-17695", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Windows Terminal freezes when using the `RangeFromPoint` and `ExpandToEnclosingUnit` functions from the UIAutomation library to retrieve text under the cursor. It provides a reproducible code snippet, specifies the software versions involved, and contrasts the behavior with other software to isolate the issue to Windows Terminal. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether the freeze is consistent across different terminal configurations or content, nor does it specify if there are any error messages or logs that could provide additional context. Additionally, edge cases (e.g., cursor at terminal boundaries, different text content) are not discussed, which could be relevant for a comprehensive understanding of the issue. Despite these minor gaps, the statement is actionable and provides enough information to start investigating the issue, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`uiaTextRange.cpp`, `uiaTextRange.hpp`, `TermControlUiaTextRange.cpp`, `TermControlUiaTextRange.hpp`, `UiaTextRangeBase.cpp`, and `UiaTextRangeBase.hpp`), indicating a need to understand and modify interactions across different components of the Windows Terminal's UIA (UI Automation) implementation. The changes primarily involve altering function signatures to use references instead of pointers for `til::point` and adjusting coordinate transformation logic, which suggests a bug fix related to how points are translated between screen and client coordinates. This requires a deep understanding of Windows API functions like `ClientToScreen` and `ScreenToClient`, as well as domain-specific knowledge of UI Automation and text range handling in a terminal context. Additionally, the modifications in `UiaTextRangeBase.cpp` (e.g., clamping coordinates and adjusting initialization logic) indicate a need to handle edge cases such as points outside the client area, which adds complexity to the solution. While the changes do not appear to impact the overall system architecture significantly, they do require careful consideration of coordinate systems, scaling factors, and potential side effects on text selection or rendering. The number of technical concepts involved\u2014UI Automation, Windows API, coordinate transformations, and terminal-specific rendering\u2014further elevates the difficulty. However, it does not reach the \"Very Hard\" category (0.8-1.0) as it does not involve system-level redesign or highly intricate algorithms. Thus, a score of 0.65 reflects the challenging nature of understanding and modifying a specialized part of the codebase with moderate complexity in edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
