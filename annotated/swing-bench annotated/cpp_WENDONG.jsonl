{"problem_statement": "Vertex remapping/reindexing with approximate equality\nAs the README states,\r\n> meshopt_generateVertexRemap uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\r\n\r\nSince rolling a custom version of the algorithm for a single-line change also comes with a maintenance cost, would it be possible to provide a variant of the algorithm that allows the specification of custom distance functions?\r\n\r\nFor instance by extending the `meshopt_Stream` struct or by passing a function pointer to the signature, which then gets the stream and element?\n", "patch": "diff --git a/README.md b/README.md\nindex 7cd858e43..d9d0488a9 100644\n--- a/README.md\n+++ b/README.md\n@@ -56,7 +56,8 @@ First, generate a remap table from your existing vertex (and, optionally, index)\n size_t index_count = face_count * 3;\n size_t unindexed_vertex_count = face_count * 3;\n std::vector<unsigned int> remap(unindexed_vertex_count); // temporary remap table\n-size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count, &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n+size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n ```\n \n Note that in this case we only have an unindexed vertex buffer; when input mesh has an index buffer, it will need to be passed to `meshopt_generateVertexRemap` instead of `NULL`, along with the correct source vertex count. In either case, the remap table is generated based on binary equivalence of the input vertices, so the resulting mesh will render the same way. Binary equivalence considers all input bytes, including padding which should be zero-initialized if the vertex structure has gaps.\n@@ -70,7 +71,18 @@ meshopt_remapVertexBuffer(vertices, &unindexed_vertices[0], unindexed_vertex_cou\n \n You can then further optimize the resulting buffers by calling the other functions on them in-place.\n \n-`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\n+`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use `meshopt_generateVertexRemapCustom` algorithm that allows comparing individual attributes with tolerance by providing a custom comparison function:\n+\n+```c++\n+size_t vertex_count = meshopt_generateVertexRemapCustom(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0].px, unindexed_vertex_count, sizeof(Vertex),\n+    [&](unsigned int lhs, unsigned int rhs) -> bool {\n+        const Vertex& lv = unindexed_vertices[lhs];\n+        const Vertex& rv = unindexed_vertices[rhs];\n+\n+        return fabsf(lv.tx - rv.tx) < 1e-3f && fabsf(lv.ty - rv.ty) < 1e-3f;\n+    });\n+```\n \n ## Vertex cache optimization\n \n@@ -573,6 +585,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_computeSphereBounds`*\n - `meshopt_encodeVertexBufferLevel`*\n - `meshopt_generateProvokingIndexBuffer`*\n+- `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\n - `meshopt_simplifySloppy`\n - `meshopt_spatialSortTriangles`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex 1e3e9ea2e..012a8524d 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -1287,6 +1287,44 @@ void provoking(const Mesh& mesh)\n \t    int(mesh.indices.size() / 3), int(pcount), double(pcount) / double(bestv) * 100.0 - 100.0, (end - start) * 1000);\n }\n \n+static int reindexCompare(void* context, unsigned int lhs, unsigned int rhs)\n+{\n+\tconst Vertex* vertices = static_cast<Vertex*>(context);\n+\tconst Vertex& lv = vertices[lhs];\n+\tconst Vertex& rv = vertices[rhs];\n+\n+\tfloat ln = lv.nx * lv.nx + lv.ny * lv.ny + lv.nz * lv.nz;\n+\tfloat rn = rv.nx * rv.nx + rv.ny * rv.ny + rv.nz * rv.nz;\n+\n+\t// 1/1024px UV tolerance, 3 degree normal tolerance\n+\treturn fabsf(lv.tx - rv.tx) < 1e-3f &&\n+\t       fabsf(lv.ty - rv.ty) < 1e-3f &&\n+\t       (lv.nx * rv.nx + lv.ny * rv.ny + lv.nz * rv.nz >= 0.9986f * sqrtf(ln * rn));\n+}\n+\n+void reindexFuzzy(const Mesh& mesh)\n+{\n+\tstd::vector<PackedVertex> pv(mesh.vertices.size());\n+\tpackMesh(pv, mesh.vertices);\n+\n+\tstd::vector<unsigned int> remap(mesh.vertices.size());\n+\n+\tdouble start = timestamp();\n+\n+\tsize_t up = meshopt_generateVertexRemap(&remap[0], &mesh.indices[0], mesh.indices.size(), &pv[0], mesh.vertices.size(), sizeof(PackedVertex));\n+\n+\tdouble middle = timestamp();\n+\n+\tsize_t uf = meshopt_generateVertexRemapCustom(&remap[0], &mesh.indices[0], mesh.indices.size(), &mesh.vertices[0].px, mesh.vertices.size(), sizeof(Vertex), reindexCompare, const_cast<Vertex*>(&mesh.vertices[0]));\n+\n+\tdouble end = timestamp();\n+\n+\tprintf(\"ReindexQ : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(up), (middle - start) * 1000);\n+\tprintf(\"ReindexF : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(uf), (end - middle) * 1000);\n+}\n+\n void nanite(const std::vector<Vertex>& vertices, const std::vector<unsigned int>& indices); // nanite.cpp\n \n bool loadMesh(Mesh& mesh, const char* path)\n@@ -1468,6 +1506,8 @@ void process(const char* path)\n \tspatialSort(mesh);\n \tspatialSortTriangles(mesh);\n \n+\treindexFuzzy(mesh);\n+\n \tif (path)\n \t\tprocessDeinterleaved(path);\n }\ndiff --git a/gltf/mesh.cpp b/gltf/mesh.cpp\nindex d5c744a59..bf231e32a 100644\n--- a/gltf/mesh.cpp\n+++ b/gltf/mesh.cpp\n@@ -66,6 +66,15 @@ static void transformNormal(float* res, const float* ptr, const float* transform\n \tres[2] = z * s;\n }\n \n+static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n+{\n+\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n+\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n+\t\t\treturn &mesh.streams[i];\n+\n+\treturn NULL;\n+}\n+\n // assumes mesh & target are structurally identical\n static void transformMesh(Mesh& target, const Mesh& mesh, const cgltf_node* node)\n {\n@@ -722,15 +731,6 @@ static void filterTriangles(Mesh& mesh)\n \tmesh.indices.resize(write);\n }\n \n-static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n-{\n-\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n-\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n-\t\t\treturn &mesh.streams[i];\n-\n-\treturn NULL;\n-}\n-\n static void simplifyAttributes(std::vector<float>& attrs, float* attrw, size_t stride, Mesh& mesh)\n {\n \tassert(stride >= 6); // normal + color\ndiff --git a/src/indexgenerator.cpp b/src/indexgenerator.cpp\nindex 0d53020e3..5f36d2463 100644\n--- a/src/indexgenerator.cpp\n+++ b/src/indexgenerator.cpp\n@@ -5,6 +5,7 @@\n #include <string.h>\n \n // This work is based on:\n+// Matthias Teschner, Bruno Heidelberger, Matthias Mueller, Danat Pomeranets, Markus Gross. Optimized Spatial Hashing for Collision Detection of Deformable Objects. 2003\n // John McDonald, Mark Kilgard. Crack-Free Point-Normal Triangles using Adjacent Edge Normals. 2010\n // John Hable. Variable Rate Shading with Visibility Buffer Rendering. 2024\n namespace meshopt\n@@ -86,6 +87,46 @@ struct VertexStreamHasher\n \t}\n };\n \n+struct VertexCustomHasher\n+{\n+\tconst float* vertex_positions;\n+\tsize_t vertex_stride_float;\n+\n+\tint (*callback)(void*, unsigned int, unsigned int);\n+\tvoid* context;\n+\n+\tsize_t hash(unsigned int index) const\n+\t{\n+\t\tconst unsigned int* key = reinterpret_cast<const unsigned int*>(vertex_positions + index * vertex_stride_float);\n+\n+\t\tunsigned int x = key[0], y = key[1], z = key[2];\n+\n+\t\t// replace negative zero with zero\n+\t\tx = (x == 0x80000000) ? 0 : x;\n+\t\ty = (y == 0x80000000) ? 0 : y;\n+\t\tz = (z == 0x80000000) ? 0 : z;\n+\n+\t\t// scramble bits to make sure that integer coordinates have entropy in lower bits\n+\t\tx ^= x >> 17;\n+\t\ty ^= y >> 17;\n+\t\tz ^= z >> 17;\n+\n+\t\t// Optimized Spatial Hashing for Collision Detection of Deformable Objects\n+\t\treturn (x * 73856093) ^ (y * 19349663) ^ (z * 83492791);\n+\t}\n+\n+\tbool equal(unsigned int lhs, unsigned int rhs) const\n+\t{\n+\t\tconst float* lp = vertex_positions + lhs * vertex_stride_float;\n+\t\tconst float* rp = vertex_positions + rhs * vertex_stride_float;\n+\n+\t\tif (lp[0] != rp[0] || lp[1] != rp[1] || lp[2] != rp[2])\n+\t\t\treturn false;\n+\n+\t\treturn callback ? callback(context, lhs, rhs) : true;\n+\t}\n+};\n+\n struct EdgeHasher\n {\n \tconst unsigned int* remap;\n@@ -183,6 +224,43 @@ static void buildPositionRemap(unsigned int* remap, const float* vertex_position\n \tallocator.deallocate(vertex_table);\n }\n \n+template <typename Hash>\n+static size_t generateVertexRemap(unsigned int* remap, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n+{\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n+\n+\tsize_t table_size = hashBuckets(vertex_count);\n+\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n+\tmemset(table, -1, table_size * sizeof(unsigned int));\n+\n+\tunsigned int next_vertex = 0;\n+\n+\tfor (size_t i = 0; i < index_count; ++i)\n+\t{\n+\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tassert(index < vertex_count);\n+\n+\t\tif (remap[index] != ~0u)\n+\t\t\tcontinue;\n+\n+\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n+\n+\t\tif (*entry == ~0u)\n+\t\t{\n+\t\t\t*entry = index;\n+\t\t\tremap[index] = next_vertex++;\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tassert(remap[*entry] != ~0u);\n+\t\t\tremap[index] = remap[*entry];\n+\t\t}\n+\t}\n+\n+\tassert(next_vertex <= vertex_count);\n+\treturn next_vertex;\n+}\n+\n template <size_t BlockSize>\n static void remapVertices(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n {\n@@ -197,55 +275,49 @@ static void remapVertices(void* destination, const void* vertices, size_t vertex\n \t\t}\n }\n \n-} // namespace meshopt\n-\n-size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+template <typename Hash>\n+static void generateShadowBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n {\n-\tusing namespace meshopt;\n-\n-\tassert(indices || index_count == vertex_count);\n-\tassert(!indices || index_count % 3 == 0);\n-\tassert(vertex_size > 0 && vertex_size <= 256);\n-\n-\tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n-\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n \n \tsize_t table_size = hashBuckets(vertex_count);\n \tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n \tmemset(table, -1, table_size * sizeof(unsigned int));\n \n-\tunsigned int next_vertex = 0;\n-\n \tfor (size_t i = 0; i < index_count; ++i)\n \t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tunsigned int index = indices[i];\n \t\tassert(index < vertex_count);\n \n-\t\tif (destination[index] == ~0u)\n+\t\tif (remap[index] == ~0u)\n \t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n+\t\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n \n \t\t\tif (*entry == ~0u)\n-\t\t\t{\n \t\t\t\t*entry = index;\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n-\n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n+\t\t\tremap[index] = *entry;\n \t\t}\n+\n+\t\tdestination[i] = remap[index];\n \t}\n+}\n \n-\tassert(next_vertex <= vertex_count);\n+} // namespace meshopt\n \n-\treturn next_vertex;\n+size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+{\n+\tusing namespace meshopt;\n+\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_size > 0 && vertex_size <= 256);\n+\n+\tmeshopt_Allocator allocator;\n+\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -263,44 +335,24 @@ size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigne\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tunsigned int next_vertex = 0;\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (destination[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t{\n-\t\t\t\t*entry = index;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n+}\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n+size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context)\n+{\n+\tusing namespace meshopt;\n \n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n-\t\t}\n-\t}\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_positions_stride >= 12 && vertex_positions_stride <= 256);\n+\tassert(vertex_positions_stride % sizeof(float) == 0);\n \n-\tassert(next_vertex <= vertex_count);\n+\tmeshopt_Allocator allocator;\n+\tVertexCustomHasher hasher = {vertex_positions, vertex_positions_stride / sizeof(float), callback, context};\n \n-\treturn next_vertex;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_remapVertexBuffer(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n@@ -362,33 +414,9 @@ void meshopt_generateShadowIndexBuffer(unsigned int* destination, const unsigned\n \tassert(vertex_size <= vertex_stride);\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_stride};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -406,33 +434,9 @@ void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const uns\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateAdjacencyIndexBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride)\ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 295324c78..54320c178 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -74,6 +74,19 @@ MESHOPTIMIZER_API size_t meshopt_generateVertexRemap(unsigned int* destination,\n  */\n MESHOPTIMIZER_API size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count);\n \n+/**\n+ * Experimental: Generates a vertex remap table from the vertex buffer and an optional index buffer and returns number of unique vertices\n+ * As a result, all vertices that are equivalent map to the same (new) location, with no gaps in the resulting sequence.\n+ * Equivalence is checked in two steps: vertex positions are compared for equality, and then the user-specified equality function is called (if provided).\n+ * Resulting remap table maps old vertices to new vertices and can be used in meshopt_remapVertexBuffer/meshopt_remapIndexBuffer.\n+ *\n+ * destination must contain enough space for the resulting remap table (vertex_count elements)\n+ * indices can be NULL if the input is unindexed\n+ * vertex_positions should have float3 position in the first 12 bytes of each vertex\n+ * callback can be NULL if no additional equality check is needed; otherwise, it should return 1 if vertices with specified indices are equivalent and 0 if they are not\n+ */\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context);\n+\n /**\n  * Generates vertex buffer from the source vertex buffer and remap table generated by meshopt_generateVertexRemap\n  *\n@@ -722,6 +735,8 @@ template <typename T>\n inline size_t meshopt_generateVertexRemap(unsigned int* destination, const T* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size);\n template <typename T>\n inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const T* indices, size_t index_count, size_t vertex_count, const meshopt_Stream* streams, size_t stream_count);\n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback);\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap);\n template <typename T>\n@@ -930,6 +945,19 @@ inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const\n \treturn meshopt_generateVertexRemapMulti(destination, indices ? in.data : NULL, index_count, vertex_count, streams, stream_count);\n }\n \n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback)\n+{\n+\tstruct Call\n+\t{\n+\t\tstatic int compare(void* context, unsigned int lhs, unsigned int rhs) { return (*static_cast<F*>(context))(lhs, rhs) ? 1 : 0; }\n+\t};\n+\n+\tmeshopt_IndexAdapter<T> in(NULL, indices, indices ? index_count : 0);\n+\n+\treturn meshopt_generateVertexRemapCustom(destination, indices ? in.data : NULL, index_count, vertex_positions, vertex_count, vertex_positions_stride, &Call::compare, &callback);\n+}\n+\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap)\n {\n", "instance_id": "zeux__meshoptimizer-862", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in its intent to extend the vertex remapping functionality in the `meshopt` library to support custom distance functions for comparing vertex attributes with tolerance, addressing issues like floating-point drift in attributes such as normals and tangents. It provides a specific goal (adding a variant of the algorithm for custom comparisons) and suggests implementation approaches (extending `meshopt_Stream` or passing a function pointer). However, there are minor ambiguities and missing details. For instance, it does not explicitly define the expected input and output formats for the custom comparison function beyond a vague mention of per-attribute tolerance. Additionally, edge cases (e.g., handling of invalid or null function pointers, performance implications of custom comparisons) and constraints (e.g., expected behavior for different vertex data layouts) are not addressed. The provided code changes help clarify the intent with examples, but the problem statement itself lacks comprehensive detail on these aspects, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is significant, involving modifications across multiple files (`README.md`, `demo/main.cpp`, `gltf/mesh.cpp`, `src/indexgenerator.cpp`, `src/meshoptimizer.h`) and introducing a new API (`meshopt_generateVertexRemapCustom`). This requires understanding and modifying core logic in the vertex remapping functionality, which impacts a critical part of the mesh optimization library. Second, the technical concepts involved are moderately complex, including C++ template programming, function pointers/callbacks, hashing algorithms (with references to spatial hashing techniques), and domain-specific knowledge of 3D graphics (vertex attributes like normals and tangents, floating-point precision issues). Third, the changes require careful consideration of edge cases, such as ensuring the custom comparison function behaves correctly with different vertex data layouts, handling null or invalid callbacks, and maintaining performance efficiency in a performance-critical library. While the problem does not reach \"Very Hard\" (0.8-1.0) as it does not involve system-level or highly intricate domain-specific challenges beyond graphics, it still demands a deep understanding of the codebase architecture and careful implementation to avoid introducing bugs or performance regressions. A score of 0.65 reflects the need for advanced C++ skills, familiarity with the library's design, and attention to detail in a moderately complex feature addition.", "clarity_label": 0, "difficulty_label": 1, "human_clarity": 3, "human_difficulty": -1}
{"problem_statement": "Not ignoring comments on \"use database\" statements\nI find that the following works as expected:\r\n\r\n    use db /* COMMENT */\r\n\r\nit will connect to the database `db`.\r\n\r\nHowever, if there is a newline in the comment:\r\n\r\n    use db /*\r\n       COMMENT */\r\n\r\nit will try to switch to the database `db /* COMMENT */`, which obviously not what should happen. \r\n\r\nThe other types of comment aren't ignored either:\r\n\r\n    use db -- COMMENT\r\n    use db # COMMENT\r\n\r\nresult in attempts to switch to database `db -- COMMENT` and `db # COMMENT`.\r\n\r\nI have not seen this issue with other statements than the `use` statement, but I haven't done an exhaustive search.\n", "patch": "diff --git a/include/set_parser.h b/include/set_parser.h\nindex 5421868342..bd89bbab22 100644\n--- a/include/set_parser.h\n+++ b/include/set_parser.h\n@@ -42,6 +42,12 @@ class SetParser {\n \t// First implemenation of the parser for TRANSACTION ISOLATION LEVEL and TRANSACTION READ/WRITE\n \tstd::map<std::string, std::vector<std::string>> parse2();\n \tstd::string parse_character_set();\n+\tstd::string parse_USE_query();\n+\tstd::string remove_comments(const std::string& q);\n+#ifdef DEBUG\n+\t// built-in testing\n+\tvoid test_parse_USE_query();\n+#endif // DEBUG\n \t~SetParser();\n };\n \ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex b40d922539..42930c9b92 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -6138,30 +6138,27 @@ void MySQL_Session::handler___status_WAITING_CLIENT_DATA___STATE_SLEEP___MYSQL_C\n \tif (session_type == PROXYSQL_SESSION_MYSQL) {\n \t\t__sync_fetch_and_add(&MyHGM->status.frontend_use_db, 1);\n \t\tstring nq=string((char *)pkt->ptr+sizeof(mysql_hdr)+1,pkt->size-sizeof(mysql_hdr)-1);\n-\t\tRE2::GlobalReplace(&nq,(char *)\"(?U)/\\\\*.*\\\\*/\",(char *)\" \");\n-\t\tchar *sn_tmp = (char *)nq.c_str();\n-\t\twhile (sn_tmp < ( nq.c_str() + nq.length() - 4 ) && *sn_tmp == ' ')\n-\t\t\tsn_tmp++;\n-\t\t//char *schemaname=strdup(nq.c_str()+4);\n-\t\tchar *schemaname=strdup(sn_tmp+3);\n-\t\tchar *schemanameptr=trim_spaces_and_quotes_in_place(schemaname);\n-\t\t// handle cases like \"USE `schemaname`\n-\t\tif(schemanameptr[0]=='`' && schemanameptr[strlen(schemanameptr)-1]=='`') {\n-\t\t\tschemanameptr[strlen(schemanameptr)-1]='\\0';\n-\t\t\tschemanameptr++;\n-\t\t}\n-\t\tclient_myds->myconn->userinfo->set_schemaname(schemanameptr,strlen(schemanameptr));\n-\t\tfree(schemaname);\n-\t\tif (mirror==false) {\n+\t\tSetParser parser(nq);\n+\t\tstring schemaname = parser.parse_USE_query();\n+\t\tif (schemaname != \"\") {\n+\t\t\tclient_myds->myconn->userinfo->set_schemaname((char *)schemaname.c_str(),schemaname.length());\n+\t\t\tif (mirror==false) {\n+\t\t\t\tRequestEnd(NULL);\n+\t\t\t}\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tunsigned int nTrx=NumActiveTransactions();\n+\t\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n+\t\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n+\t\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n+\t\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n+\t\t} else {\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tstd::string msg = \"Unable to parse: \" + nq;\n+\t\t\tclient_myds->myprot.generate_pkt_ERR(true,NULL,NULL,client_myds->pkt_sid+1,1148,(char *)\"42000\", msg.c_str());\n \t\t\tRequestEnd(NULL);\n \t\t}\n-\t\tl_free(pkt->size,pkt->ptr);\n-\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n-\t\tunsigned int nTrx=NumActiveTransactions();\n-\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n-\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n-\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n-\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n \t\tclient_myds->DSS=STATE_SLEEP;\n \t} else {\n \t\tl_free(pkt->size,pkt->ptr);\ndiff --git a/lib/set_parser.cpp b/lib/set_parser.cpp\nindex 521808d642..7abef9adf1 100644\n--- a/lib/set_parser.cpp\n+++ b/lib/set_parser.cpp\n@@ -3,9 +3,11 @@\n #include <string>\n #include <vector>\n #include <map>\n-#ifdef PARSERDEBUG\n+#include <cassert>\n+#include <utility> // for std::pair\n+//#ifdef PARSERDEBUG\n #include <iostream>\n-#endif\n+//#endif\n \n using namespace std;\n \n@@ -506,3 +508,148 @@ std::string SetParser::parse_character_set() {\n \treturn value4;\n }\n \n+std::string SetParser::parse_USE_query() {\n+#ifdef DEBUG\n+\tproxy_debug(PROXY_DEBUG_MYSQL_QUERY_PROCESSOR, 4, \"Parsing query %s\\n\", query.c_str());\n+#endif // DEBUG\n+\n+\tre2::RE2::Options opt2(RE2::Quiet);\n+\topt2.set_case_sensitive(false);\n+\topt2.set_longest_match(false);\n+\n+\tstd::string dbname = remove_comments(query);\n+\tre2::RE2 re0(\"^\\\\s*\", opt2);\n+\tre2::RE2::Replace(&dbname, re0, \"\");\n+\tif (dbname.size() >= 4) {\n+\t\tif (\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE \",4) == 0\n+\t\t\t||\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE`\",4) == 0\n+\t\t) {\n+\t\t\tre2::RE2 re1(\"^USE\\\\s*\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re1, \"\");\n+\t\t\tre2::RE2 re2(\"\\\\s*$\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re2, \"\");\n+\t\t\tif (dbname[0] == '`') {\n+\t\t\t\tif (dbname.length() > 2) {\n+\t\t\t\t\tif (dbname[dbname.length()-1] == '`') {\n+\t\t\t\t\t\t// Remove the first character\n+\t\t\t\t\t\tdbname.erase(0, 1);\n+\t\t\t\t\t\t// Remove the last character\n+\t\t\t\t\t\tdbname.erase(dbname.length() - 1);\n+\t\t\t\t\t\treturn dbname;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\treturn dbname;\n+\t\t\t}\n+\t\t}\n+\t} else {\n+\t\treturn \"\";\n+\t}\n+\n+\treturn \"\";\n+}\n+\n+\n+std::string SetParser::remove_comments(const std::string& q) {\n+    std::string result = \"\";\n+    bool in_multiline_comment = false;\n+\n+    for (size_t i = 0; i < query.size(); ++i) {\n+        char current_char = query[i];\n+\n+        // Check for multiline comment start\n+        if (current_char == '/' && i + 1 < query.size() && query[i + 1] == '*') {\n+            in_multiline_comment = true;\n+            i++; // Skip the '*'\n+            continue;\n+        }   \n+\n+        // Check for multiline comment end\n+        if (in_multiline_comment && current_char == '*' && i + 1 < query.size() && query[i + 1] == '/') {\n+            in_multiline_comment = false;\n+            i++; // Skip the '/'\n+            continue;\n+        }   \n+\n+        // Skip characters inside multiline comment\n+        if (in_multiline_comment) {\n+            continue;\n+        }\n+\n+        // Check for single-line comments\n+        if (current_char == '#' || (current_char == '-' && i + 1 < query.size() && query[i + 1] == '-')) {\n+            // Skip until the end of the line\n+            while (i < query.size() && query[i] != '\\n') {\n+                i++;\n+            }\n+            continue;\n+        }\n+\n+        // Append the character to the result if it's not a comment\n+        result += current_char;\n+    }\n+\n+    return result;\n+}\n+\n+\n+#ifdef DEBUG\n+void SetParser::test_parse_USE_query() {\n+\n+\t// Define vector of pairs (query, expected dbname)\n+\tstd::vector<std::pair<std::string, std::string>> testCases = {\n+\t\t{\"USE my_database\",    \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database\",  \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database \", \"my_database\"},                   // Basic Case\n+\t\t{\"/* comment */USE dbname /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */   USE   dbname\",            \"dbname\"}, // With Comments\n+\t\t{\"USE    dbname           /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */USE `dbname` /* comment */\", \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE`dbname` /* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment */\", \"dbname\"}, // Multiline Comment\n+\t\t{\"/* comment */USE dbname # comment\",       \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname -- comment\",      \"dbname\"}, // Double Dash Comment\n+\t\t{\"/* comment */USE dbname   # comment\",     \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname    -- comment\",   \"dbname\"}, // Double Dash Comment\n+\t\t{\"USE dbname   # comment\",                  \"dbname\"}, // Hash Comment\n+\t\t{\"USE dbname    -- comment\",                \"dbname\"}, // Double Dash Comment\n+\t\t{\"SELECT * FROM my_table\", \"\"}, // No match\n+\t\t{\"/*+ placeholder_comment */ USE test_use_comment\", \"test_use_comment\"},\n+\n+\t\t{\"USE /*+ placeholder_comment */ `test_use_comment-a1`\",  \"test_use_comment-a1\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment_1`\", \"test_use_comment_1\"},\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment_2`\",    \"test_use_comment_2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment_3`\",    \"test_use_comment_3\"},\n+\t\t{\"USE /*+ placeholder_comment */   test_use_comment_4\",   \"test_use_comment_4\"},\n+\t\t{\"USE/*+ placeholder_comment */ test_use_comment_5\",      \"test_use_comment_5\"},\n+\t\t{\"USE /*+ placeholder_comment */test_use_comment_6\",      \"test_use_comment_6\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment-1`\", \"test_use_comment-1\"},\n+\t\t{\"use my_database\", \"my_database\"},\n+\t\t{\"/* comment */  use dbname -- comment\",        \"dbname\"},\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment\\nmultiline comment */\", \"dbname\"}, // Multiline Comment\n+\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment-2`\",      \"test_use_comment-2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment-3`\",      \"test_use_comment-3\"},\n+\t\t{\"/*+ placeholder_comment */USE      `test_use_comment-4`\", \"test_use_comment-4\"},\n+\t\t{\"USE/*+ placeholder_comment */`test_use_comment-5`\",       \"test_use_comment-5\"},\n+\t\t{\"/* comment */USE`test_use_comment-6`\",                    \"test_use_comment-6\"},\n+\t\t{\"USE`test_use_comment-7`\",                                 \"test_use_comment-7\"},\n+\t};\n+\n+\t// Run tests for each pair\n+\tfor (const auto& p : testCases) {\n+\t\tset_query(p.first);\n+\t\tstd::string dbname = parse_USE_query();\n+\t\tif (dbname != p.second) {\n+\t\t\t// we call parse_USE_query() again just to make it easier to create a breakpoint\n+\t\t\tstd::string s = parse_USE_query();\n+\t\t\tassert(s == p.second);\n+\t\t}\n+\t}\n+\n+}\n+#endif // DEBUG\ndiff --git a/src/main.cpp b/src/main.cpp\nindex c30a6bd999..d98743a604 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1976,6 +1976,13 @@ int main(int argc, const char * argv[]) {\n //\t\tstd::cerr << \"Main init phase0 completed in \";\n #endif\n \t}\n+#ifdef DEBUG\n+\t{\n+\t\t// Automated testing\n+\t\tSetParser parser(\"\");\n+\t\tparser.test_parse_USE_query();\n+\t}\n+#endif // DEBUG\n \t{\n \t\tcpu_timer t;\n \t\tProxySQL_Main_process_global_variables(argc, argv);\n", "instance_id": "sysown__proxysql-4605", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: comments in \"use database\" statements are not being ignored, leading to incorrect database name parsing when comments contain newlines or use different comment styles (e.g., --, #). The goal is evident\u2014to ensure comments are properly stripped out before processing the database name. The statement provides specific examples of problematic inputs, which helps in understanding the issue. However, it lacks comprehensive details on edge cases beyond the provided examples (e.g., nested comments, malformed queries) and does not explicitly define the expected behavior for all comment types or positions. Additionally, there is no mention of performance constraints or compatibility requirements with other parts of the system. While the problem is valid and mostly clear, these minor omissions prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of code changes involves multiple files (set_parser.h, set_parser.cpp, MySQL_Session.cpp, main.cpp), requiring modifications to both the parsing logic and integration into the existing codebase. The changes include adding new methods to handle comment removal and query parsing, which indicates a moderate level of complexity. Second, the technical concepts involved include string manipulation, regular expressions (via RE2), and understanding of SQL query syntax and comment styles, which are not overly complex but require careful implementation to avoid introducing bugs. Third, the problem necessitates handling various edge cases related to comment formats (multiline, single-line with # and --), whitespace, and quoted database names, as evidenced by the extensive test cases added in the code. However, the changes do not significantly impact the system's architecture, nor do they require advanced domain-specific knowledge or complex algorithms. The implementation is mostly straightforward once the logic for comment stripping is understood, though it requires attention to detail to ensure robustness. Therefore, a score of 0.45 reflects a medium difficulty level, involving moderate complexity across a few files with some edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[FirebaseDatabase] Databases are disconnected temporarily on app goes inactive state.\n### Description\n\nSince v10.27.0, `FirebaseDatabase` now temporarily goes offline when the app is in the inactive state (e.g., when control center is opened, when returning to the home screen, etc.) and comes back online after a while.\r\n\r\nIn v10.26.0, the behavior was below:\r\n<video width=300, src=\"https://github.com/user-attachments/assets/5008221a-169a-4c17-9266-84e0901ab503\" />\r\n\r\nbut is in v10.27.0 or later:\r\n<video width=300, src=\"https://github.com/user-attachments/assets/247d3c43-f295-4e9c-96c9-a3d8b9bf9a1a\" />\r\n\n\n### Reproducing the issue\n\n1. Create iOS App project\r\n2. Integrate Firebase project and add `FirebaseDatabase` package\r\n3. Replace App code with like this:\r\n\r\n```swift\r\nimport SwiftUI\r\nimport UIKit\r\nimport FirebaseCore\r\nimport FirebaseDatabase\r\n\r\n@main\r\nstruct RtdbReproIOSApp: App {\r\n    \r\n    @UIApplicationDelegateAdaptor (AppDelegate.self) var appDelegate\r\n    \r\n    var body: some Scene {\r\n        WindowGroup {\r\n            ContentView()\r\n        }\r\n    }\r\n}\r\n\r\nclass AppDelegate: NSObject, UIApplicationDelegate {\r\n    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil) -> Bool {\r\n        FirebaseApp.configure()\r\n        \r\n        let connectedRef = Database.database().reference(withPath: \".info/connected\")\r\n        connectedRef.observe(.value, with: { snapshot in\r\n          if snapshot.value as? Bool ?? false {\r\n            print(\"Connected\")\r\n          } else {\r\n            print(\"Not connected\")\r\n          }\r\n        })\r\n        \r\n        return true\r\n    }\r\n}\r\n\r\n```\n\n### Firebase SDK Version\n\n10.27.0\n\n### Xcode Version\n\n15.3\n\n### Installation Method\n\nSwift Package Manager\n\n### Firebase Product(s)\n\nDatabase\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n_No response_\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n{\r\n  \"originHash\" : \"c63c63846d9c539229e96de38d6af51417e28c0ee9a0bc48bd0f0f19d923c329\",\r\n  \"pins\" : [\r\n    {\r\n      \"identity\" : \"abseil-cpp-binary\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/abseil-cpp-binary.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"194a6706acbd25e4ef639bcaddea16e8758a3e27\",\r\n        \"version\" : \"1.2024011602.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"app-check\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/app-check.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"3b62f154d00019ae29a71e9738800bb6f18b236d\",\r\n        \"version\" : \"10.19.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"firebase-ios-sdk\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/firebase-ios-sdk\",\r\n      \"state\" : {\r\n        \"revision\" : \"8bcaf973b1d84e119b7c7c119abad72ed460979f\",\r\n        \"version\" : \"10.27.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleappmeasurement\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleAppMeasurement.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"70df02431e216bed98dd461e0c4665889245ba70\",\r\n        \"version\" : \"10.27.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googledatatransport\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleDataTransport.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"a637d318ae7ae246b02d7305121275bc75ed5565\",\r\n        \"version\" : \"9.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleutilities\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleUtilities.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"57a1d307f42df690fdef2637f3e5b776da02aad6\",\r\n        \"version\" : \"7.13.3\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"grpc-binary\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/grpc-binary.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"e9fad491d0673bdda7063a0341fb6b47a30c5359\",\r\n        \"version\" : \"1.62.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"gtm-session-fetcher\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/gtm-session-fetcher.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"a2ab612cb980066ee56d90d60d8462992c07f24b\",\r\n        \"version\" : \"3.5.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"interop-ios-for-google-sdks\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/interop-ios-for-google-sdks.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"2d12673670417654f08f5f90fdd62926dc3a2648\",\r\n        \"version\" : \"100.0.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"leveldb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/leveldb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"a0bc79961d7be727d258d33d5a6b2f1023270ba1\",\r\n        \"version\" : \"1.22.5\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"nanopb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/nanopb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"b7e1104502eca3a213b46303391ca4d3bc8ddec1\",\r\n        \"version\" : \"2.30910.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"promises\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/promises.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"540318ecedd63d883069ae7f1ed811a2df00b6ac\",\r\n        \"version\" : \"2.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"swift-protobuf\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/apple/swift-protobuf.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"e17d61f26df0f0e06f58f6977ba05a097a720106\",\r\n        \"version\" : \"1.27.1\"\r\n      }\r\n    }\r\n  ],\r\n  \"version\" : 3\r\n}\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/FirebaseDatabase/CHANGELOG.md b/FirebaseDatabase/CHANGELOG.md\nindex 7ee5692d4f0..7df20ba497e 100644\n--- a/FirebaseDatabase/CHANGELOG.md\n+++ b/FirebaseDatabase/CHANGELOG.md\n@@ -1,3 +1,7 @@\n+# Unreleased\n+- [fixed] Fix temporary disconnects when the app goes inactive. The issue was\n+  introduced in 10.27.0. (#13529)\n+\n # 11.0.0\n - [removed] **Breaking change**: The deprecated `FirebaseDatabaseSwift`\n   module has been removed. See\ndiff --git a/FirebaseDatabase/Sources/Core/FPersistentConnection.m b/FirebaseDatabase/Sources/Core/FPersistentConnection.m\nindex 8c22814df00..f07ee977246 100644\n--- a/FirebaseDatabase/Sources/Core/FPersistentConnection.m\n+++ b/FirebaseDatabase/Sources/Core/FPersistentConnection.m\n@@ -34,11 +34,9 @@\n #import \"FirebaseDatabase/Sources/Utilities/FUtilities.h\"\n #import \"FirebaseDatabase/Sources/Utilities/Tuples/FTupleCallbackStatus.h\"\n #import \"FirebaseDatabase/Sources/Utilities/Tuples/FTupleOnDisconnect.h\"\n-#if TARGET_OS_WATCH\n-#import <WatchKit/WatchKit.h>\n-#else\n+#if !TARGET_OS_WATCH\n #import <SystemConfiguration/SystemConfiguration.h>\n-#endif // TARGET_OS_WATCH\n+#endif // !TARGET_OS_WATCH\n #import <dlfcn.h>\n #import <netinet/in.h>\n \n@@ -168,7 +166,6 @@ - (id)initWithRepoInfo:(FRepoInfo *)repoInfo\n                         retryExponent:kPersistentConnReconnectMultiplier\n                          jitterFactor:0.7];\n \n-        [self setupNotifications];\n         // Make sure we don't actually connect until open is called\n         [self interruptForReason:kFInterruptReasonWaitingForOpen];\n     }\n@@ -553,29 +550,6 @@ - (void)openNetworkConnectionWithContext:\n     [self.realtime open];\n }\n \n-- (void)enteringForeground {\n-    dispatch_async(self.dispatchQueue, ^{\n-      // Reset reconnect delay\n-      [self.retryHelper signalSuccess];\n-      if (self->connectionState == ConnectionStateDisconnected) {\n-          [self tryScheduleReconnect];\n-      }\n-    });\n-}\n-\n-- (void)setupNotifications {\n-#if TARGET_OS_WATCH\n-    __weak FPersistentConnection *weakSelf = self;\n-    NSNotificationCenter *center = [NSNotificationCenter defaultCenter];\n-    [center addObserverForName:WKApplicationWillEnterForegroundNotification\n-                        object:nil\n-                         queue:nil\n-                    usingBlock:^(NSNotification *_Nonnull note) {\n-                      [weakSelf enteringForeground];\n-                    }];\n-#endif // TARGET_OS_WATCH\n-}\n-\n - (void)sendAuthAndRestoreStateAfterComplete:(BOOL)restoreStateAfterComplete {\n     NSAssert([self connected], @\"Must be connected to send auth\");\n     NSAssert(self.authToken != nil,\ndiff --git a/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m b/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m\nindex 6aa9d7365e5..078fbb06ef6 100644\n--- a/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m\n+++ b/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m\n@@ -110,27 +110,6 @@ - (instancetype)initWith:(FRepoInfo *)repoInfo\n             NSURLSessionWebSocketTask *task =\n                 [session webSocketTaskWithRequest:req];\n             self.webSocketTask = task;\n-\n-#if TARGET_OS_IOS || TARGET_OS_TV || TARGET_OS_VISION || TARGET_OS_MACCATALYST\n-            NSString *resignName = UIApplicationWillResignActiveNotification;\n-#elif TARGET_OS_OSX\n-            NSString *resignName = NSApplicationWillResignActiveNotification;\n-#elif TARGET_OS_WATCH\n-            NSString *resignName = WKApplicationWillResignActiveNotification;\n-#elif\n-#error(\"missing platform\")\n-#endif\n-            [[NSNotificationCenter defaultCenter]\n-                addObserverForName:resignName\n-                            object:nil\n-                             queue:opQueue\n-                        usingBlock:^(NSNotification *_Nonnull note) {\n-                          FFLog(@\"I-RDB083015\",\n-                                @\"Received notification that application \"\n-                                @\"will resign, \"\n-                                @\"closing web socket.\");\n-                          [self onClosed];\n-                        }];\n         }\n     }\n     return self;\n", "instance_id": "firebase__firebase-ios-sdk-13564", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: FirebaseDatabase temporarily disconnects when the app goes into an inactive state starting from version 10.27.0, which was not the behavior in version 10.26.0. The description includes steps to reproduce the issue, relevant version information, and even video evidence of the behavior change, which aids in understanding the problem. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"inactive state\" entails beyond examples (e.g., opening the control center or returning to the home screen). Additionally, it lacks specifics on expected behavior (e.g., should the connection remain active indefinitely in inactive states, or is there a specific timeout?). Edge cases, such as behavior during prolonged inactivity or network interruptions during state transitions, are not mentioned. Overall, while the core issue is clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting two files (`FPersistentConnection.m` and `FWebSocketConnection.m`) within the FirebaseDatabase module. The changes involve removing notification listeners for app state transitions (e.g., resigning active state) and associated logic for handling foreground/background transitions, which suggests a targeted fix to prevent unnecessary disconnections. However, understanding the impact requires knowledge of iOS app lifecycle events, Objective-C notification mechanisms, and the Firebase SDK's internal connection management logic, which adds moderate complexity. The technical concepts involved include familiarity with platform-specific notifications (e.g., `UIApplicationWillResignActiveNotification`), WebSocket connection handling, and the FirebaseDatabase's persistent connection architecture. While the changes do not appear to impact the broader system architecture significantly, they do require careful consideration of connection state management and potential side effects on reconnection logic. Edge cases, such as app behavior during rapid state transitions or network instability, are not explicitly addressed in the problem statement but may need to be considered during implementation or testing, adding a layer of complexity. Overall, this problem requires a moderate depth of understanding and careful modification across a couple of files, justifying a difficulty score of 0.55, which sits in the medium range (0.4-0.6) due to the need for specific domain knowledge and attention to potential unintended consequences.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "FIRRemoteConfigValue.stringValue is not nullable\n### Description\r\n\r\nFIRRemoteConfigValue.stringValue is marked `nullable` in the header file but will never return `null` as the implement.\r\nhttps://github.com/firebase/firebase-ios-sdk/blob/60f9a33e7084482df67b48e16f315f4f7a6f5da9/FirebaseRemoteConfig/Sources/FIRConfigValue.m#L43-L46\r\nIt would be thankful to implement it as `nullable`, before that marking it `nonnull` would be enough.\r\n\r\n### Firebase SDK Version\r\n\r\n9.6.0\r\n\r\n### Xcode Version\r\n\r\n14.1\r\n\r\n### Installation Method\r\n\r\nCocoaPods\r\n\r\n### Firebase Product(s)\r\n\r\nRemote Config\r\n\r\n### Targeted Platforms\r\n\r\niOS\n", "patch": "diff --git a/FirebaseRemoteConfig/CHANGELOG.md b/FirebaseRemoteConfig/CHANGELOG.md\nindex 2a3024918c8..ff8a8a72050 100644\n--- a/FirebaseRemoteConfig/CHANGELOG.md\n+++ b/FirebaseRemoteConfig/CHANGELOG.md\n@@ -1,4 +1,7 @@\n-# 10.25.0\n+# 11.0.0\n+- [fixed] RemoteConfigValue stringValue is now `nonnull`. This may break some builds. (#10870)\n+\n+  # 10.25.0\n - [fixed] Fixed bug preventing Remote Config from working with a custom sqlite3\n   dependency (#10884).\n \ndiff --git a/FirebaseRemoteConfig/Sources/FIRConfigValue.m b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\nindex 8ab2d30d77a..e68d9c1312d 100644\n--- a/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n+++ b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n@@ -41,8 +41,8 @@ - (instancetype)init {\n }\n \n /// The string is a UTF-8 representation of NSData.\n-- (NSString *)stringValue {\n-  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding];\n+- (nonnull NSString *)stringValue {\n+  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding] ?: @\"\";\n }\n \n /// Number representation of a UTF-8 string.\ndiff --git a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\nindex 29cd12a5143..0a45617545f 100644\n--- a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n+++ b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n@@ -138,7 +138,7 @@ typedef void (^FIRRemoteConfigFetchAndActivateCompletion)(\n NS_SWIFT_NAME(RemoteConfigValue)\n @interface FIRRemoteConfigValue : NSObject <NSCopying>\n /// Gets the value as a string.\n-@property(nonatomic, readonly, nullable) NSString *stringValue;\n+@property(nonatomic, readonly, nonnull) NSString *stringValue;\n /// Gets the value as a number value.\n @property(nonatomic, readonly, nonnull) NSNumber *numberValue;\n /// Gets the value as a NSData object.\ndiff --git a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\nindex d0cea378995..f2d56542760 100644\n--- a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n+++ b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n@@ -35,7 +35,7 @@ struct FirebaseRemoteConfigValueDecoderHelper: FirebaseRemoteConfigValueDecoding\n   }\n \n   func stringValue() -> String {\n-    return value.stringValue ?? \"\"\n+    return value.stringValue\n   }\n \n   func dataValue() -> Data {\ndiff --git a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\nindex 7bf81c97a37..6665dd91258 100644\n--- a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n+++ b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n@@ -188,12 +188,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n@@ -204,13 +199,7 @@ class APITests: APITestBase {\n     let expectation2 = self.expectation(description: #function + \"2\")\n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.yoda)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n-\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.yoda)\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -239,13 +228,10 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.sith).stringValue {\n-        XCTAssertEqual(configValue, Constants.darthSidious)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.sith)\")\n-      }\n-\n+      XCTAssertEqual(\n+        self.config.configValue(forKey: Constants.sith).stringValue,\n+        Constants.darthSidious\n+      )\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -258,12 +244,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n", "instance_id": "firebase__firebase-ios-sdk-13065", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: the `FIRRemoteConfigValue.stringValue` property is marked as `nullable` in the header file but does not return `null` in the implementation, and the request is to update the annotation to `nonnull` as a temporary fix. The goal (changing the nullability annotation) and the context (Firebase Remote Config for iOS) are specified, along with relevant links to the codebase. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss the potential impact on users or downstream code that might rely on the `nullable` behavior, nor does it mention any specific edge cases or constraints to consider when making this change. Additionally, while the desired outcome (marking as `nonnull`) is clear, there is no discussion of why the implementation cannot return `null` or whether a future change to make it truly `nullable` is planned. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The changes are localized to a few files, primarily involving updating the nullability annotation in the header file (`FIRRemoteConfig.h`), modifying the implementation to ensure a non-null return value (`FIRConfigValue.m`), and updating related Swift code and tests to reflect this change. The diff shows modifications across five files, but the changes are straightforward\u2014mostly annotation updates and removing null checks in Swift code. There is no significant impact on the system's architecture, as this is a semantic adjustment rather than a functional overhaul. The amount of code change is minimal.\n\n2. **Number of Technical Concepts**: The problem requires basic understanding of Objective-C nullability annotations (`nullable` vs `nonnull`), Swift interoperability with Objective-C, and how these annotations affect API usage. No advanced algorithms, design patterns, or domain-specific knowledge beyond iOS development basics are needed. Familiarity with the Firebase SDK structure is helpful but not critical, as the changes are well-contained.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes address a potential issue where `stringValue` could return `nil` if the data-to-string conversion fails. The updated implementation returns an empty string (`@\"\"`) as a fallback, which is a simple but effective way to ensure non-null behavior. No complex error handling or additional edge case logic is required beyond this.\n\n4. **Overall Complexity**: The task involves understanding a small part of the codebase and making targeted, low-risk changes. While it requires attention to detail to ensure consistency across Objective-C and Swift interfaces, it does not demand deep architectural knowledge or complex refactoring. The primary challenge is ensuring that downstream consumers of the API are not broken by this change, as noted in the changelog (\"This may break some builds\"), but the code modifications themselves are simple.\n\nGiven these factors, a difficulty score of 0.25 reflects an \"Easy\" problem that requires minimal effort beyond basic code modifications and a surface-level understanding of nullability in Objective-C/Swift interoperability.", "clarity_label": 0, "difficulty_label": 1, "human_clarity": 1, "human_difficulty": -1}
{"problem_statement": "[Bug]: SIGSEGV crash when maximizing window\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n30.0.0-alpha7\r\n\r\n### What operating system are you using?\r\n\r\nUbuntu\r\n\r\n### Operating System Version\r\n\r\n20.04, running on x11\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n30.0.0-alpha6\r\n\r\n### Expected Behavior\r\n\r\nMaximizing/fullscreening the app does not sigfault.\r\n\r\n### Actual Behavior\r\n\r\nMaximizing/fullscreening the window crashes the app.\r\n\r\n### Testcase Gist URL\r\n\r\nThis is visible in the default Fiddle template that opens with the app\r\n\r\n### Additional Information\r\n\r\nThere is no `render-process-gone` or `child-process-gone` event called when it crashes.\r\n\n", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex cd97a83b93a3b..8ab128530c726 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -129,3 +129,4 @@ fix_add_support_for_skipping_first_2_no-op_refreshes_in_thumb_cap.patch\n refactor_expose_file_system_access_blocklist.patch\n revert_power_update_trace_counter_in_power_monitor.patch\n feat_add_support_for_missing_dialog_features_to_shell_dialogs.patch\n+fix_partially_revert_invalidate_focusring.patch\ndiff --git a/patches/chromium/fix_partially_revert_invalidate_focusring.patch b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\nnew file mode 100644\nindex 0000000000000..614f42b4acd3d\n--- /dev/null\n+++ b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\n@@ -0,0 +1,58 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: VerteDinde <keeleymhammond@gmail.com>\n+Date: Mon, 6 May 2024 11:03:08 -0700\n+Subject: fix: partially revert views invalidate FocusRing when its host is\n+ invalidated\n+\n+This reverts commit f425c438dfb11fb714655c999ba8c74b58393425. This\n+commit seems to be causing a sporadic crash on Ubuntu and other Linux\n+distros. This patch can be reverted when the issue is fixed upstream, or\n+when the crash is addressed.\n+\n+diff --git a/ui/views/view.cc b/ui/views/view.cc\n+index 94b026cda4738e489f1d7201c996f6db70d018ed..32ec794f4683be5ded78dcf310d3623b8748c236 100644\n+--- a/ui/views/view.cc\n++++ b/ui/views/view.cc\n+@@ -911,16 +911,6 @@ void View::Layout(PassKey) {\n+ }\n+ \n+ void View::InvalidateLayout() {\n+-  if (invalidating_) {\n+-    return;\n+-  }\n+-\n+-  // There is no need to `InvalidateLayout()` when `Widget::IsClosed()`.\n+-  if (Widget* widget = GetWidget(); widget && widget->IsClosed()) {\n+-    return;\n+-  }\n+-\n+-  base::AutoReset<bool> invalidating(&invalidating_, true);\n+   // We should never need to invalidate during a layout call; this tracks\n+   // how many times that is happening.\n+   ++invalidates_during_layout_;\n+@@ -928,11 +918,6 @@ void View::InvalidateLayout() {\n+   // Always invalidate up. This is needed to handle the case of us already being\n+   // valid, but not our parent.\n+   needs_layout_ = true;\n+-\n+-  for (ViewObserver& observer : observers_) {\n+-    observer.OnViewLayoutInvalidated(this);\n+-  }\n+-\n+   if (HasLayoutManager()) {\n+     GetLayoutManager()->InvalidateLayout();\n+   }\n+diff --git a/ui/views/view.h b/ui/views/view.h\n+index ea7d5441dbbfb713a6ffb57bcc07fb55fa574016..54b4c0a2871f214a4806fd863f32b8d010c09058 100644\n+--- a/ui/views/view.h\n++++ b/ui/views/view.h\n+@@ -2343,9 +2343,6 @@ class VIEWS_EXPORT View : public ui::LayerDelegate,\n+   // it is happening.\n+   int invalidates_during_layout_ = 0;\n+ \n+-  // Whether this view is in the middle of InvalidateLayout().\n+-  bool invalidating_ = false;\n+-\n+   // The View's LayoutManager defines the sizing heuristics applied to child\n+   // Views. The default is absolute positioning according to bounds_.\n+   std::unique_ptr<LayoutManager> layout_manager_;\n", "instance_id": "electron__electron-42126", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a SIGSEGV crash occurs when maximizing or fullscreening a window in Electron version 30.0.0-alpha7 on Ubuntu 20.04 with X11. It provides context about the environment, the expected behavior (no crash), and the actual behavior (crash). Additionally, it mentions the lack of specific events (`render-process-gone` or `child-process-gone`) during the crash, which is useful for debugging. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify under what exact conditions the crash occurs (e.g., specific window states or user actions beyond maximizing/fullscreening), nor does it provide detailed reproduction steps beyond referencing the default Fiddle template. Edge cases or specific configurations that might trigger the crash are also not mentioned. While the issue is valid and mostly clear, these missing details prevent it from being comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is rated as Hard (0.75) based on several factors. First, the scope of the code changes involves modifying a patch to Chromium's codebase, specifically reverting a previous commit related to focus ring invalidation in the `ui/views` module. While the change itself is localized to a single file (`ui/views/view.cc` and `ui/views/view.h`), it requires understanding the broader implications of reverting this logic, as it impacts how view layouts are invalidated\u2014a core part of the UI rendering system in Chromium. This suggests a need to understand interactions between different components of the UI system, even if the actual code change is relatively small (removing a few lines and a variable).\n\nSecond, the technical concepts involved are moderately complex. The developer must be familiar with Chromium's UI framework, specifically the `views` module, and understand the implications of layout invalidation and focus ring behavior. Additionally, knowledge of how these changes affect window management on Linux (X11) is necessary, as the crash is platform-specific. Debugging a SIGSEGV crash also implies familiarity with low-level debugging tools and potentially memory management issues, which adds to the complexity.\n\nThird, while the problem statement does not explicitly mention edge cases, the nature of a crash on window maximization suggests potential edge cases related to window states, display configurations, or specific X11 interactions. The code change (reverting a commit) is a temporary workaround rather than a root cause fix, which implies that a full solution might require deeper investigation into why the original commit causes a crash, further increasing the difficulty.\n\nFinally, the impact of this change is significant because it affects a core UI behavior in a widely-used framework (Electron/Chromium). While the patch itself does not alter the system's architecture directly, any change to UI rendering logic can have downstream effects on application stability and user experience, requiring careful consideration and testing. Given the need for deep understanding of Chromium's internals, platform-specific behavior, and the potential for subtle bugs or regressions, I rate this problem as Hard with a difficulty score of 0.75. It falls short of Very Hard (0.8-1.0) because the provided solution is a straightforward revert rather than a novel implementation or system-level redesign, but it still demands significant expertise and caution.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Unexpected image buffer size when creating PortableCompressedTexture2D from Image\n### Tested versions\n\n- Reproducible in v4.5.dev [1f56d96cf], 4.4.1.stable [96579d139]\n\n### System information\n\nWindows 11 Vulkan (Forward+)\n\n### Issue description\n\nWhen trying to create a PortableCompressedTexture2D from an Image, the following error shows when using compressed formats.\n```\n  ERROR: Expected Image data size of 512x512x3 (RGB8 without mipmaps) = 786432 bytes, got 131072 bytes instead.\n  ERROR: Width must be equal or greater than 1 for all textures\n```\nIf `COMPRESSION_MODE_LOSSLESS `is used, there's no error displayed. Most probably, what's happening is that the Image data buffer is compressed here:\nhttps://github.com/godotengine/godot/blob/1f56d96cf2c768c3844c68ccb504dfeee841ae15/scene/resources/portable_compressed_texture.cpp#L182-L204\nSo the buffer is no longer of the expected size, since it is compressed.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Open the script `test.gd`\n- Then run the script with File > Run\n\n### Minimal reproduction project (MRP)\n\n[test.zip](https://github.com/user-attachments/files/19578958/test.zip)\n", "patch": "diff --git a/scene/resources/portable_compressed_texture.cpp b/scene/resources/portable_compressed_texture.cpp\nindex 99317af5a113..32c7a0965e6a 100644\n--- a/scene/resources/portable_compressed_texture.cpp\n+++ b/scene/resources/portable_compressed_texture.cpp\n@@ -171,6 +171,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t}\n \t\t} break;\n \t\tcase COMPRESSION_MODE_BASIS_UNIVERSAL: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_BASIS_UNIVERSAL, buffer.ptrw() + 2);\n \t\t\tImage::UsedChannels uc = p_image->detect_used_channels(p_normal_map ? Image::COMPRESS_SOURCE_NORMAL : Image::COMPRESS_SOURCE_GENERIC);\n \t\t\tVector<uint8_t> budata = Image::basis_universal_packer(p_image, uc);\n@@ -180,6 +181,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\tcase COMPRESSION_MODE_S3TC:\n \t\tcase COMPRESSION_MODE_ETC2:\n \t\tcase COMPRESSION_MODE_BPTC: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_IMAGE, buffer.ptrw() + 2);\n \t\t\tRef<Image> copy = p_image->duplicate();\n \t\t\tswitch (p_compression_mode) {\n@@ -195,7 +197,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t\tdefault: {\n \t\t\t\t};\n \t\t\t}\n-\n+\t\t\tencode_uint32(copy->get_format(), buffer.ptrw() + 4);\n \t\t\tbuffer.append_array(copy->get_data());\n \n \t\t} break;\n", "instance_id": "godotengine__godot-104962", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an unexpected image buffer size error occurs when creating a `PortableCompressedTexture2D` from an `Image` using compressed formats in the Godot engine. It provides specific error messages, the context of the issue (compressed formats vs. lossless compression), and steps to reproduce the problem with a minimal reproduction project (MRP). Additionally, it points to a specific part of the codebase where the issue likely originates. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or desired outcome (e.g., should the buffer size check be adjusted, or should compression be handled differently?). It also lacks mention of specific edge cases or constraints beyond the general issue with compressed formats. While the issue is reproducible and the description is actionable, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`portable_compressed_texture.cpp`) and involve a small number of lines (adding error checks and encoding format data). The modifications do not impact the broader system architecture or require changes across multiple modules. The changes are straightforward, focusing on adding validation to prevent processing already compressed images and storing additional format information.\n\n2. **Technical Concepts Involved**: Solving this issue requires a basic understanding of image compression formats and how they are handled in the Godot engine. Familiarity with the `Image` class and its methods (e.g., `is_compressed()`, `get_format()`) is necessary, but these are not particularly advanced concepts. No complex algorithms, design patterns, or domain-specific knowledge beyond general graphics programming are required.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases beyond the general issue with compressed formats. The code changes introduce basic error handling (`ERR_FAIL_COND`) to prevent processing already compressed images, which is a simple and standard approach in this context. There are no indications of complex edge cases or performance considerations that need to be addressed.\n\n4. **Overall Complexity**: The issue requires understanding a specific part of the codebase and making targeted modifications to fix a bug. It does not involve deep architectural changes or intricate logic. The solution is relatively mechanical\u2014adding checks and encoding additional data\u2014making it accessible to developers with moderate experience in C++ and graphics programming.\n\nGiven these points, a difficulty score of 0.35 reflects the need for some code logic understanding and simple modifications, but the problem remains on the easier side of the spectrum due to its localized scope and limited complexity.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": ".import / .uid file is not removed when original file is not in root directory and gets removed outside editor\n### Tested versions\n\n4.4 dev4\nLikely earlier too.\n\n### System information\n\nWindows 10.0.19045 - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1060 (NVIDIA; 32.0.15.6603) - Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz (8 threads)\n\n### Issue description\n\nWhen you delete a file outside editor, Godot tries to delete corresponding .import/.uid file. However this only happens if the file is in the project's root directory. If it's in any subdirectory, the other file just stays there and you have to delete it manually.\n\n### Steps to reproduce\n\n1. Open project's root directory in OS' file manager\n2. Delete icon.svg\n3. Focus the editor\n4. The engine will process FileSystem and automatically delete icon.svg.import.\n5. Try again with icon.svg in a subfolder\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex 42cd8632941d..6e76f06a3095 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -933,15 +933,16 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n+\t\t\t\tconst String file_path = ia.dir->get_file_path(idx);\n+\t\t\t\tconst String class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n+\t\t\t\t\t_queue_update_script_class(file_path, ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n-\t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n+\t\t\t\t\t_queue_update_scene_groups(file_path);\n \t\t\t\t}\n \n-\t\t\t\t_delete_internal_files(ia.dir->files[idx]->file);\n+\t\t\t\t_delete_internal_files(file_path);\n \t\t\t\tmemdelete(ia.dir->files[idx]);\n \t\t\t\tia.dir->files.remove_at(idx);\n \n", "instance_id": "godotengine__godot-104669", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when a file is deleted outside the Godot editor, the corresponding .import/.uid file is only removed if the original file is in the project's root directory, but not if it's in a subdirectory. The steps to reproduce are provided, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the expected behavior (though it can be inferred that .import/.uid files should be deleted regardless of the directory). Additionally, there are no mentions of potential edge cases, such as what happens if the .import/.uid file is missing or if there are permission issues. The lack of a minimal reproduction project (MRP) also slightly hinders clarity for someone unfamiliar with the Godot engine's file system handling. Overall, the description is valid and mostly clear but lacks some minor details for a fully comprehensive understanding.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`editor_file_system.cpp`) and involve a small modification (a few lines of code). The change primarily involves updating a variable (`file_path`) to ensure the correct path is used when deleting internal files. It does not impact the broader system architecture or require changes across multiple modules. The amount of code change is minimal.\n\n2. **Technical Concepts Involved**: Solving this issue requires a basic understanding of file path handling in C++ and familiarity with the Godot engine's internal file system logic. The concepts involved are relatively straightforward\u2014string manipulation for file paths and invoking a deletion function. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic file system operations are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce or modify error handling logic. However, a developer might need to consider scenarios like invalid paths or missing .import/.uid files, though these are not complex to handle in this context. The simplicity of the fix suggests that edge case handling is not a significant factor in the difficulty.\n\n4. **Overall Complexity**: The task requires understanding a small part of the codebase (specifically, how file deletion is triggered in the editor's file system) and making a simple adjustment to use the full file path instead of just the file name. While it involves some logic understanding, it does not require deep knowledge of the entire codebase or complex refactoring.\n\nGiven these points, I assign a difficulty score of 0.35, as the problem is slightly more involved than a trivial fix (e.g., changing a constant) but still falls within the \"Easy\" category due to its limited scope and straightforward solution.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor SceneTree inspects nodes while scrolling with drag & drop\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nThere are 2 overlapping actions. If you drag & drop hover over a node in the SceneTree dock, it will inspect the node. Also, if you drag & drop hover near the top / bottom edge of the tree, it will scroll up and down. But currently they conflict, so dragging near the edge will still trigger the \"inspect node\" action, causing stutter during the scroll\n\nRelated to https://github.com/godotengine/godot/pull/103943#issuecomment-2734859037. I have the same fix ready, but just documenting it here\n\n### Steps to reproduce\n\n- Add a bunch of nodes to the scene tree, enough so that there is plenty to scroll.\n- Click and drag a node from the top / bottom, to the other edge to trigger a scroll, and keep cursor in place while it scrolls.\n- After about half a second, some random node in between will be inspected during the scroll.\n\nhttps://github.com/user-attachments/assets/a49f12e1-6362-42b9-a3bc-67354dc54b41\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex 163501dd37c2..41efb74db0bc 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -4764,6 +4764,7 @@ SceneTreeDock::SceneTreeDock(Node *p_scene_root, EditorSelection *p_editor_selec\n \tscene_tree->connect(\"files_dropped\", callable_mp(this, &SceneTreeDock::_files_dropped));\n \tscene_tree->connect(\"script_dropped\", callable_mp(this, &SceneTreeDock::_script_dropped));\n \tscene_tree->connect(\"nodes_dragged\", callable_mp(this, &SceneTreeDock::_nodes_drag_begin));\n+\tscene_tree->get_scene_tree()->get_vscroll_bar()->connect(\"value_changed\", callable_mp(this, &SceneTreeDock::_reset_hovering_timer).unbind(1));\n \n \tscene_tree->get_scene_tree()->connect(SceneStringName(gui_input), callable_mp(this, &SceneTreeDock::_scene_tree_gui_input));\n \tscene_tree->get_scene_tree()->connect(\"item_icon_double_clicked\", callable_mp(this, &SceneTreeDock::_focus_node));\n", "instance_id": "godotengine__godot-104346", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: there is a conflict between the \"inspect node\" action and the scrolling behavior during drag-and-drop operations in the SceneTree dock of the Godot editor. The goal is implied (to resolve the conflict so scrolling does not trigger node inspection), and steps to reproduce the issue are provided along with a visual asset for reference. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior after the fix (e.g., should node inspection be completely disabled during scrolling, or should there be a delay or threshold?). Additionally, while it references a related pull request, it lacks specifics on the broader context or potential side effects of the fix. Constraints or edge cases (e.g., behavior with different input devices or tree sizes) are not mentioned. Overall, the statement is valid and clear enough to understand the issue, but it leaves some room for interpretation.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, involving a single line addition in `scene_tree_dock.cpp` to connect a signal (`value_changed` from the vertical scrollbar) to a method (`_reset_hovering_timer`). This suggests the fix is localized to a specific part of the codebase and does not impact multiple modules or the overall architecture. The change appears to be a small tweak to existing logic, likely resetting a timer that controls node inspection during scrolling.\n\n2. **Number of Technical Concepts**: Solving this requires understanding basic event handling in the Godot engine, specifically signal connections and how the SceneTree dock manages user interactions like drag-and-drop and scrolling. Familiarity with Godot's API and C++ (used in the engine's codebase) is necessary, but the concepts involved are not particularly complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond typical UI event handling are required.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code change does not appear to introduce new error handling logic. However, a developer would need to consider whether resetting the hovering timer could cause unintended side effects (e.g., delayed or missed node inspections in other scenarios). These considerations are minor and do not significantly increase the difficulty.\n\n4. **Overall Complexity**: The fix is straightforward, requiring only a small modification to address a specific bug. It does not demand deep knowledge of the entire codebase or complex refactoring. The primary challenge lies in verifying that the fix resolves the issue without introducing new problems, which is a standard debugging task.\n\nGiven these factors, a difficulty score of 0.25 reflects the simplicity of the code change and the limited scope of understanding required. This task is suitable for a developer with basic to intermediate experience in C++ and familiarity with Godot's editor codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[BUG] sample_baked_with_rotation return wrong rotation when offset=0\n### Godot version\n\nv4.1.stable.official [970459615]\n\n### System information\n\nGodot v4.1.stable - Windows 10.0.19045 - Vulkan (Mobile) - integrated AMD Radeon(TM) Vega 8 Graphics  () - AMD Ryzen 5 3550H with Radeon Vega Mobile Gfx (8 Threads)\n\n### Issue description\n\n![image](https://github.com/godotengine/godot/assets/50233205/c180f8f9-5f7c-4ef2-9410-0ce3d1e0aad6)\r\n\r\nAs shown in the picture above, when the curve offset is 0, the rotation angle seems to be incorrect. I just get the rotation of the offset (contained in the transform) and then copy the sprite2d to this position.\r\nThe other offset are correct, And I've also looked at existing questions and there doesn't seem to be the exact same problem as mine.\r\n\r\ncode as below.\r\n![image](https://github.com/godotengine/godot/assets/50233205/f317529f-a82b-4340-8fda-58adb211fea6)\r\n\r\nThanks for any help.\r\n\n\n### Steps to reproduce\n\n1, create a Node Path2D\r\n2, invoke path2d's curve with sample_baked_with_rotation(0) # only offset=0 seemd not correct\r\n3, display path in debug and run\n\n### Minimal reproduction project\n\n[Curve2DSampleTest.zip](https://github.com/godotengine/godot/files/12779488/Curve2DSampleTest.zip)\r\n\n", "patch": "diff --git a/scene/resources/curve.cpp b/scene/resources/curve.cpp\nindex de68737b8c93..ca9b247f2719 100644\n--- a/scene/resources/curve.cpp\n+++ b/scene/resources/curve.cpp\n@@ -881,12 +881,22 @@ void Curve2D::_bake_segment2d_even_length(RBMap<real_t, Vector2> &r_bake, real_t\n \n Vector2 Curve2D::_calculate_tangent(const Vector2 &p_begin, const Vector2 &p_control_1, const Vector2 &p_control_2, const Vector2 &p_end, const real_t p_t) {\n \t// Handle corner cases.\n-\tif (Math::is_zero_approx(p_t - 0.0f) && p_control_1.is_equal_approx(p_begin)) {\n-\t\treturn (p_end - p_begin).normalized();\n-\t}\n-\n-\tif (Math::is_zero_approx(p_t - 1.0f) && p_control_2.is_equal_approx(p_end)) {\n-\t\treturn (p_end - p_begin).normalized();\n+\tif (Math::is_zero_approx(p_t - 0.0f)) {\n+\t\tif (p_control_1.is_equal_approx(p_begin)) {\n+\t\t\tif (p_control_1.is_equal_approx(p_control_2)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_control_2 - p_begin).normalized();\n+\t\t\t}\n+\t\t}\n+\t} else if (Math::is_zero_approx(p_t - 1.0f)) {\n+\t\tif (p_control_2.is_equal_approx(p_end)) {\n+\t\t\tif (p_control_2.is_equal_approx(p_control_1)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_end - p_control_1).normalized();\n+\t\t\t}\n+\t\t}\n \t}\n \n \treturn p_begin.bezier_derivative(p_control_1, p_control_2, p_end, p_t).normalized();\n@@ -1620,12 +1630,22 @@ void Curve3D::_bake_segment3d_even_length(RBMap<real_t, Vector3> &r_bake, real_t\n \n Vector3 Curve3D::_calculate_tangent(const Vector3 &p_begin, const Vector3 &p_control_1, const Vector3 &p_control_2, const Vector3 &p_end, const real_t p_t) {\n \t// Handle corner cases.\n-\tif (Math::is_zero_approx(p_t - 0.0f) && p_control_1.is_equal_approx(p_begin)) {\n-\t\treturn (p_end - p_begin).normalized();\n-\t}\n-\n-\tif (Math::is_zero_approx(p_t - 1.0f) && p_control_2.is_equal_approx(p_end)) {\n-\t\treturn (p_end - p_begin).normalized();\n+\tif (Math::is_zero_approx(p_t - 0.0f)) {\n+\t\tif (p_control_1.is_equal_approx(p_begin)) {\n+\t\t\tif (p_control_1.is_equal_approx(p_control_2)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_control_2 - p_begin).normalized();\n+\t\t\t}\n+\t\t}\n+\t} else if (Math::is_zero_approx(p_t - 1.0f)) {\n+\t\tif (p_control_2.is_equal_approx(p_end)) {\n+\t\t\tif (p_control_2.is_equal_approx(p_control_1)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_end - p_control_1).normalized();\n+\t\t\t}\n+\t\t}\n \t}\n \n \treturn p_begin.bezier_derivative(p_control_1, p_control_2, p_end, p_t).normalized();\n", "instance_id": "godotengine__godot-104221", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: there is a bug in the `sample_baked_with_rotation` method of a `Path2D` curve in Godot 4.1 where the rotation angle is incorrect specifically when the offset is 0. The user provides a visual representation of the issue, steps to reproduce, system information, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the expected behavior or correct rotation angle for offset=0 is not explicitly defined, leaving room for interpretation. Additionally, the problem statement does not mention specific edge cases beyond offset=0 or constraints that might affect the solution. While the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, affecting specific logic in the `Curve2D` and `Curve3D` classes within a single file (`curve.cpp`). The modifications involve updating the tangent calculation logic for corner cases (when the parameter `p_t` is approximately 0 or 1), which requires understanding Bezier curve mathematics and the existing implementation of derivative calculations. The amount of code change is moderate, with nested conditional checks added to handle different control point configurations, but it does not impact the broader system architecture. \n\nSecond, the technical concepts involved include familiarity with vector mathematics, Bezier curve tangents, and floating-point comparisons (e.g., `Math::is_zero_approx`), which are moderately complex but not overly advanced. Domain-specific knowledge of Godot's curve sampling and rendering pipeline is also necessary to ensure the fix aligns with the engine's expectations for rotation behavior.\n\nThird, the problem inherently involves edge cases (specifically when `p_t` is 0 or 1 and control points overlap with endpoints), and the code changes directly address these by refining the logic for tangent calculation. However, no additional error handling or performance considerations are evident in the problem statement or code changes, and the complexity of these edge cases is moderate.\n\nOverall, this problem requires understanding multiple concepts (Bezier curves, vector math, and Godot's internals) and making targeted but non-trivial modifications. It does not require deep architectural changes or advanced domain knowledge beyond what a mid-level engineer familiar with graphics programming might possess, hence a score of 0.45 in the medium range.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "MetalFX Temporal upscaling fallback on non-supported rendering drivers does not disable TAA jitter (or fallback to FSR2)\n### Tested versions\n\n- Reproducible in: 4.4.stable\n- MetalFX is not available before 4.4.\n\n### System information\n\nGodot v4.4.stable (4c311cbee) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4090 (nvidia; 570.86.16) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nWhen attempting to use MetalFX Temporal upscaling on an unsupported rendering driver, the TAA jitter is still active despite not being needed with bilinear scaling. MetalFX Spatial upscaling doesn't have this issue, as it doesn't engage TAA jitter in the first place due to its purely spatial nature.\n\nAlternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\ncc @stuartcarnie \n\nhttps://github.com/user-attachments/assets/bde8cd82-63ba-4f82-ba59-0be8e46ea63c\n\n### Steps to reproduce\n\n- Create a project using the Forward+ rendering method.\n- Set the root viewport's 3D scaling mode to MetalFX Temporal using a script on a platform/renderer that doesn't support MetalFX upscaling (Windows, Linux, or macOS when using MoltenVK):\n```gdscript\nfunc _ready() -> void:\n    get_window().scaling_3d_mode = Viewport.SCALING_3D_MODE_METALFX_TEMPORAL\n```\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/godotengine/tps-demo/pull/196\n*Change the check in the demo's code from `== \"metal\"` to `!= \"metal` to test this on unsupported drivers. I suggest using the Ultra Performance scaling mode so the issue is more noticeable.*\n", "patch": "diff --git a/servers/rendering/renderer_viewport.cpp b/servers/rendering/renderer_viewport.cpp\nindex 3a8f445c4be1..45a4ebe1b8a8 100644\n--- a/servers/rendering/renderer_viewport.cpp\n+++ b/servers/rendering/renderer_viewport.cpp\n@@ -145,12 +145,22 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_OFF;\n \t\t\t}\n \n-\t\t\t// Verify MetalFX upscaling support.\n-\t\t\tif (\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) ||\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL))) {\n-\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported in the current renderer. Falling back to bilinear 3D resolution scaling.\");\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) {\n+\t\t\t\tif (RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\t\t// Prefer MetalFX spatial if it is supported, which will be much more efficient than FSR2,\n+\t\t\t\t\t// as the hardware already will struggle with FSR2.\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling is not supported by the current renderer or hardware. Falling back to MetalFX Spatial scaling.\");\n+\t\t\t\t} else {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported by the current renderer or hardware. Falling back to FSR 2 scaling.\");\n+\t\t\t\t}\n+\t\t\t\tscaling_type = RS::scaling_3d_mode_type(scaling_3d_mode);\n+\t\t\t}\n+\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR;\n+\t\t\t\tWARN_PRINT_ONCE(\"MetalFX spatial upscaling is not supported by the current renderer or hardware. Falling back to FSR scaling.\");\n \t\t\t}\n \n \t\t\tRS::ViewportMSAA msaa_3d = p_viewport->msaa_3d;\n@@ -160,11 +170,9 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tdouble min_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MIN_SCALE) / 1000'000.0;\n \t\t\t\tdouble max_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MAX_SCALE) / 1000'000.0;\n \t\t\t\tif ((double)scaling_3d_scale < min_scale || (double)scaling_3d_scale > max_scale) {\n-\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to bilinear 3D resolution scaling.\", min_scale, max_scale));\n-\t\t\t\t}\n-\n-\t\t\t\tif (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to FSR 2 3D resolution scaling.\", min_scale, max_scale));\n+\t\t\t\t} else if (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n \t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling does not support 3D MSAA. Disabling 3D MSAA internally.\");\n \t\t\t\t\tmsaa_3d = RS::VIEWPORT_MSAA_DISABLED;\n \t\t\t\t}\n@@ -174,7 +182,7 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\tbool use_taa = p_viewport->use_taa;\n \n \t\t\tif (scaling_3d_is_not_bilinear && (scaling_3d_scale >= (1.0 + EPSILON))) {\n-\t\t\t\t// FSR is not designed for downsampling.\n+\t\t\t\t// FSR and MetalFX is not designed for downsampling.\n \t\t\t\t// Fall back to bilinear scaling.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 3D resolution scaling is not designed for downsampling. Falling back to bilinear 3D resolution scaling.\");\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n@@ -188,8 +196,8 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t}\n \n \t\t\tif (use_taa && (scaling_type == RS::VIEWPORT_SCALING_3D_TYPE_TEMPORAL)) {\n-\t\t\t\t// FSR2 can't be used with TAA.\n-\t\t\t\t// Turn it off and prefer using FSR2.\n+\t\t\t\t// Temporal upscalers can't be used with TAA.\n+\t\t\t\t// Turn it off and prefer using the temporal upscaler.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 2 or MetalFX Temporal is not compatible with TAA. Disabling TAA internally.\");\n \t\t\t\tuse_taa = false;\n \t\t\t}\n", "instance_id": "godotengine__godot-103792", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue with MetalFX Temporal upscaling fallback behavior on unsupported rendering drivers. It specifies the problem (TAA jitter remains active unnecessarily with bilinear scaling fallback) and provides a preferred solution (falling back to FSR2/FSR1 instead of bilinear scaling). The steps to reproduce are well-documented, including a minimal reproduction project and specific system information. However, there are minor ambiguities: the problem statement does not explicitly define all edge cases (e.g., behavior on specific hardware configurations beyond the tested setup) or constraints for fallback mechanisms. Additionally, while the preferred solution is mentioned, it lacks detailed requirements or trade-offs for implementing FSR2/FSR1 fallbacks versus disabling TAA jitter. Overall, the description is valid and clear but misses some minor details that could aid in a fully comprehensive understanding.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as medium (0.55) based on the following analysis of the factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem is mostly clear, the minor ambiguities around edge cases and fallback constraints add a slight layer of complexity to fully understanding the requirements. The logic of handling rendering fallbacks is moderately complex due to the need to balance visual quality and performance.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are confined to a single file (`renderer_viewport.cpp`) and focus on modifying the logic for 3D scaling mode fallbacks. The changes involve updating conditional checks and fallback paths (e.g., preferring MetalFX Spatial or FSR2 over bilinear scaling). The amount of code change is relatively small (around 30-40 lines), and it does not appear to impact the broader system architecture significantly. However, it requires understanding the interaction between different rendering modes and hardware support checks within the Godot engine's rendering pipeline.\n\n3. **Number of Technical Concepts**: Solving this problem requires familiarity with several concepts, including rendering techniques (MetalFX Temporal/Spatial, FSR2/FSR1, TAA jitter, bilinear scaling), hardware feature detection (via `RD::get_singleton()->has_feature`), and the Godot engine's viewport and rendering system. While these concepts are not extremely advanced, they do require domain-specific knowledge of graphics programming and the Godot engine's internals, which adds to the difficulty for someone unfamiliar with this area.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention many edge cases, but the code changes imply handling scenarios like unsupported hardware, invalid scaling ranges, and compatibility issues between rendering techniques (e.g., disabling TAA when using temporal upscalers). The modifications include updating warning messages and fallback logic, which indirectly addresses error handling. These edge cases are moderately complex as they involve ensuring visual quality and performance are not degraded unexpectedly on different hardware configurations.\n\nOverall, this problem falls into the medium difficulty range because it requires understanding multiple graphics-related concepts and making targeted but non-trivial changes to the rendering logic. It does not involve extensive refactoring or deep architectural changes, nor does it require extremely advanced technical knowledge, but it is beyond a simple bug fix due to the need for domain expertise and careful handling of fallback behaviors.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "LineEdit - Caret hides when focus is lost, even though Caret Force Displayed option is checked (Regression)\n### Tested versions\n\nReproducible in v4.4.rc3.official\n\n**Update:**\nI've tested this on versions from 4.3stable on and the version where this stops working is in 4.4 dev3.  In 4.4 dev2 backwards, it works as intended.\n\n### System information\n\nGodot v4.4.rc3 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2060 (NVIDIA; 32.0.15.7242) - Intel(R) Core(TM) i7-8700K CPU @ 3.70GHz (12 threads)\n\n### Issue description\n\nI'm using line input to edit text, and I'm moving away from the line with my controller to interact with other UI elements.  \nI expect the blinking caret in the line Input to remain, since I have the caret_force_displayed property checked.\n\nBut it doesn't seem like this makes a different, and the caret goes away.\n\n### Steps to reproduce\n\nOpen attached project and play it.\n\n1) Type some text in the LineEdit node.\n2) Click away or move away from the text with an attached controller.\n3) Notce the caret goes away even though the caret_force_displayed property is checked.\n\n### Minimal reproduction project (MRP)\n\n[line_edit_caret_issue.zip](https://github.com/user-attachments/files/19038896/line_edit_caret_issue.zip)\n", "patch": "diff --git a/doc/classes/LineEdit.xml b/doc/classes/LineEdit.xml\nindex c6cdacb6ec25..879b179dbfef 100644\n--- a/doc/classes/LineEdit.xml\n+++ b/doc/classes/LineEdit.xml\n@@ -252,7 +252,7 @@\n \t\t\tThe caret's column position inside the [LineEdit]. When set, the text may scroll to accommodate it.\n \t\t</member>\n \t\t<member name=\"caret_force_displayed\" type=\"bool\" setter=\"set_caret_force_displayed\" getter=\"is_caret_force_displayed\" default=\"false\">\n-\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if focus is lost.\n+\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if not editing or focus is lost.\n \t\t</member>\n \t\t<member name=\"caret_mid_grapheme\" type=\"bool\" setter=\"set_caret_mid_grapheme_enabled\" getter=\"is_caret_mid_grapheme_enabled\" default=\"false\">\n \t\t\tAllow moving caret, selecting and removing the individual composite character components.\ndiff --git a/scene/gui/line_edit.cpp b/scene/gui/line_edit.cpp\nindex 969e2fd3a35c..f4d66d5a281d 100644\n--- a/scene/gui/line_edit.cpp\n+++ b/scene/gui/line_edit.cpp\n@@ -1733,7 +1733,7 @@ void LineEdit::_validate_caret_can_draw() {\n \t\tdraw_caret = true;\n \t\tcaret_blink_timer = 0.0;\n \t}\n-\tcaret_can_draw = editing && (window_has_focus || (menu && menu->has_focus())) && (has_focus() || caret_force_displayed);\n+\tcaret_can_draw = (caret_force_displayed && !is_part_of_edited_scene()) || (editing && (window_has_focus || (menu && menu->has_focus())) && has_focus());\n }\n \n void LineEdit::delete_char() {\n", "instance_id": "godotengine__godot-103508", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the expected behavior (caret should remain visible when focus is lost if `caret_force_displayed` is enabled) and the actual behavior (caret disappears). It includes steps to reproduce, system information, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities: the problem statement does not explicitly discuss potential edge cases or constraints (e.g., behavior in specific UI configurations or interactions with other properties). Additionally, it lacks clarity on whether this issue affects other platforms or rendering backends beyond the specified Windows setup with Vulkan. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are minimal and localized to a single file (`line_edit.cpp`) with a small modification to the logic for determining when the caret can be drawn. Additionally, there is a minor documentation update in `LineEdit.xml`. The change does not impact the broader system architecture or require modifications across multiple modules. The diff shows a straightforward adjustment to a conditional statement, indicating a low amount of code change.\n\n2. **Technical Concepts Involved**: Solving this requires a basic understanding of GUI logic in the Godot engine, specifically how focus and caret visibility are managed in the `LineEdit` class. The change involves modifying a boolean condition to account for the `caret_force_displayed` property and a new check (`is_part_of_edited_scene()`), which suggests minimal complexity. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic UI handling are required.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code change introduces a new condition (`is_part_of_edited_scene()`), which might be intended to handle specific scenarios (e.g., preventing caret display in certain editor contexts). However, the complexity of handling such edge cases appears low, as the change is a simple logical adjustment without extensive error handling or validation logic.\n\n4. **Overall Complexity**: The issue is a regression bug fix, and the solution involves a small tweak to existing logic rather than implementing new functionality or refactoring. It requires understanding the intent of `caret_force_displayed` and how focus management works in Godot, but this is relatively straightforward for someone familiar with GUI components or the Godot codebase.\n\nA score of 0.30 reflects that this is an easy problem requiring minimal code changes and a basic understanding of the relevant logic, with no significant architectural impact or complex edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Headless import always emits errors about `!tasks.has(p_task)`\n### Tested versions\n\n- Reproducible in: 4.4.rc2\n- Reproducible in: 4.4.dev2\n- Not reproducible in: 4.4.dev1\n\n### System information\n\nGodot v4.4.rc2 - Windows 11 (build 26100) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 9 7940HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\n(This is a formal issue for what's mentioned [here](https://github.com/godotengine/godot/issues/100900#issuecomment-2567712127), and potentially a duplicate of #100900 itself, but since that one mentions errors at startup I figured it's possibly a different issue.)\n\nWhen running Godot with `--headless --import` on any project, you're currently met with the following output:\n\n```\nERROR: Do not use progress dialog (task) while flushing the message queue or using call_deferred()!\n   at: add_task (editor/progress_dialog.cpp:183)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true.\n   at: end_task (editor/progress_dialog.cpp:240)\n```\n\nThe import seems to complete successfully despite that, I think.\n\nWhen bisecting it seems that this is a regression stemming from #93064.\n\n### Steps to reproduce\n\n- Create a new project.\n- Run `/path/to/godot --headless --import` in the project folder.\n- Note the errors.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex f1d13123d659..de52afa91cda 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -1207,7 +1207,7 @@ void EditorNode::_sources_changed(bool p_exist) {\n \t\t}\n \n \t\t// Start preview thread now that it's safe.\n-\t\tif (!singleton->cmdline_export_mode) {\n+\t\tif (!singleton->cmdline_mode) {\n \t\t\tEditorResourcePreview::get_singleton()->start();\n \t\t}\n \n@@ -1807,7 +1807,7 @@ void EditorNode::_save_scene_with_preview(String p_file, int p_idx) {\n \tsave_scene_progress->step(TTR(\"Saving Scene\"), 4);\n \t_save_scene(p_file, p_idx);\n \n-\tif (!singleton->cmdline_export_mode) {\n+\tif (!singleton->cmdline_mode) {\n \t\tEditorResourcePreview::get_singleton()->check_for_invalidation(p_file);\n \t}\n \n@@ -4944,7 +4944,7 @@ bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringNa\n void EditorNode::progress_add_task(const String &p_task, const String &p_label, int p_steps, bool p_can_cancel) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": begin: \" + p_label + \" steps: \" + itos(p_steps));\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->add_task(p_task, p_label, p_steps, p_can_cancel);\n@@ -4954,7 +4954,7 @@ void EditorNode::progress_add_task(const String &p_task, const String &p_label,\n bool EditorNode::progress_task_step(const String &p_task, const String &p_state, int p_step, bool p_force_refresh) {\n \tif (!singleton) {\n \t\treturn false;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(\"\\t\" + p_task + \": step \" + itos(p_step) + \": \" + p_state);\n \t\treturn false;\n \t} else if (singleton->progress_dialog) {\n@@ -4967,7 +4967,7 @@ bool EditorNode::progress_task_step(const String &p_task, const String &p_state,\n void EditorNode::progress_end_task(const String &p_task) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": end\");\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->end_task(p_task);\n@@ -5220,7 +5220,7 @@ Error EditorNode::export_preset(const String &p_preset, const String &p_path, bo\n \texport_defer.android_build_template = p_android_build_template;\n \texport_defer.patch = p_patch;\n \texport_defer.patches = p_patches;\n-\tcmdline_export_mode = true;\n+\tcmdline_mode = true;\n \treturn OK;\n }\n \n@@ -6848,6 +6848,11 @@ EditorNode::EditorNode() {\n \tDEV_ASSERT(!singleton);\n \tsingleton = this;\n \n+\t// Detecting headless mode, that means the editor is running in command line.\n+\tif (!DisplayServer::get_singleton()->window_can_draw()) {\n+\t\tcmdline_mode = true;\n+\t}\n+\n \tResource::_get_local_scene_func = _resource_get_edited_scene;\n \n \t{\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex de3af997473a..63788e645f30 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -419,7 +419,7 @@ class EditorNode : public Node {\n \tbool script_distraction_free = false;\n \n \tbool changing_scene = false;\n-\tbool cmdline_export_mode = false;\n+\tbool cmdline_mode = false;\n \tbool convert_old = false;\n \tbool immediate_dialog_confirmed = false;\n \tbool opening_prev = false;\n", "instance_id": "godotengine__godot-103403", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: running Godot in headless mode with the `--headless --import` command results in repeated error messages related to a progress dialog task check (`!tasks.has(p_task)`). The goal is implicitly to eliminate these errors during headless operation. The statement includes relevant details such as the affected versions, system information, steps to reproduce, and a reference to a related issue or regression. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior (e.g., should the progress dialog be entirely disabled in headless mode, or should the errors be suppressed?), and it lacks details on potential edge cases or constraints (e.g., does this affect other command-line modes?). Additionally, while the issue is reproducible, there is no minimal reproduction project provided, which could hinder deeper investigation. Overall, the description is valid and mostly clear but misses some finer points that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are relatively localized, primarily within `editor_node.cpp` and `editor_node.h`. The modifications involve replacing a specific flag (`cmdline_export_mode`) with a broader one (`cmdline_mode`) and adding logic to detect headless mode using `DisplayServer::get_singleton()->window_can_draw()`. The changes affect a single class (`EditorNode`) and focus on conditional checks for command-line or headless operation. The amount of code change is small (a few lines across multiple functions), and there is no significant impact on the system's architecture, as it\u2019s mostly a behavioral adjustment for headless mode.\n\n2. **Number of Technical Concepts**: Solving this requires understanding basic C++ concepts (class member variables, conditional logic) and familiarity with the Godot engine's internals, specifically how the editor handles command-line modes and progress dialogs. The concept of headless mode detection using `DisplayServer` is straightforward but requires some domain-specific knowledge of Godot's API. No advanced algorithms, design patterns, or complex libraries are involved, keeping the technical depth low.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest a focus on ensuring proper behavior in headless mode. There might be implicit edge cases, such as ensuring that other command-line operations (beyond `--import`) are correctly handled with the new `cmdline_mode` flag, or verifying that the headless detection logic works across different platforms. However, the error handling in the code changes is minimal, focusing on bypassing progress dialog operations in command-line mode rather than adding new error checks. The complexity of edge cases appears low.\n\n4. **Overall Assessment**: The problem requires understanding a specific part of the Godot editor codebase and making targeted modifications to handle headless mode correctly. It does not involve deep architectural changes or complex logic, and the impact is limited to command-line behavior. The difficulty is slightly above the \"Very Easy\" range due to the need for domain-specific knowledge of Godot and potential minor edge cases, but it remains straightforward for someone familiar with the codebase or C++ in general.\n\nThus, a score of 0.35 reflects an \"Easy\" problem that involves simple modifications with moderate context understanding.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`change_scene_to_*` needs to await for two `process_frame`s\n### Tested versions\r\n\r\nGodot 4.2+\r\n\r\n### System information\r\n\r\nArch Linux\r\n\r\n### Issue description\r\n\r\n`change_scene_to_*()` methods always change scene in a deferred way.\r\n\r\nThe documentation says scene change happens at the end of the frame. But I have to await `SceneTree.process_frame` twice instead of once since #78988.\r\n\r\nhttps://github.com/godotengine/godot/blob/2d0ee20ff30461b6b10f6fdfba87511a0ebc6642/doc/classes/SceneTree.xml#L55-L56\r\n\r\n```gdscript\r\nvar tree := get_tree()\r\n\r\ntree.change_scene_to_file(path)\r\n\r\nawait tree.process_frame\r\n# expected & old behavior: new scene available here\r\n# actual: still not available\r\n\r\nawait tree.process_frame\r\n# actual: new scene available here\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nSee above, or use the MRP.\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[test-change-scene.zip](https://github.com/godotengine/godot/files/13700325/test-change-scene.zip)\r\n\n", "patch": "diff --git a/doc/classes/SceneTree.xml b/doc/classes/SceneTree.xml\nindex 77baef9d0898..9a31492d2018 100644\n--- a/doc/classes/SceneTree.xml\n+++ b/doc/classes/SceneTree.xml\n@@ -58,6 +58,7 @@\n \t\t\t\t1. The current scene node is immediately removed from the tree. From that point, [method Node.get_tree] called on the current (outgoing) scene will return [code]null[/code]. [member current_scene] will be [code]null[/code], too, because the new scene is not available yet.\n \t\t\t\t2. At the end of the frame, the formerly current scene, already removed from the tree, will be deleted (freed from memory) and then the new scene will be instantiated and added to the tree. [method Node.get_tree] and [member current_scene] will be back to working as usual.\n \t\t\t\tThis ensures that both scenes aren't running at the same time, while still freeing the previous scene in a safe way similar to [method Node.queue_free].\n+\t\t\t\tIf you want to reliably access the new scene, await the [signal scene_changed] signal.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"create_timer\">\n@@ -312,6 +313,17 @@\n \t\t\t\tEmitted immediately before [method Node._process] is called on every node in this tree.\n \t\t\t</description>\n \t\t</signal>\n+\t\t<signal name=\"scene_changed\">\n+\t\t\t<description>\n+\t\t\t\tEmitted after the new scene is added to scene tree and initialized. Can be used to reliably access [member current_scene] when changing scenes.\n+\t\t\t\t[codeblock]\n+\t\t\t\t# This code should be inside an autoload.\n+\t\t\t\tget_tree().change_scene_to_file(other_scene_path)\n+\t\t\t\tawait get_tree().scene_changed\n+\t\t\t\tprint(get_tree().current_scene) # Prints the new scene.\n+\t\t\t\t[/codeblock]\n+\t\t\t</description>\n+\t\t</signal>\n \t\t<signal name=\"tree_changed\">\n \t\t\t<description>\n \t\t\t\tEmitted any time the tree's hierarchy changes (nodes being moved, renamed, etc.).\ndiff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 4043eb55ac96..557fced85ed1 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -1517,6 +1517,8 @@ void SceneTree::_flush_scene_change() {\n \tpending_new_scene = nullptr;\n \t// Update display for cursor instantly.\n \troot->update_mouse_cursor_state();\n+\n+\temit_signal(SNAME(\"scene_changed\"));\n }\n \n Error SceneTree::change_scene_to_file(const String &p_path) {\n@@ -1784,6 +1786,7 @@ void SceneTree::_bind_methods() {\n \tADD_PROPERTY(PropertyInfo(Variant::BOOL, \"physics_interpolation\"), \"set_physics_interpolation_enabled\", \"is_physics_interpolation_enabled\");\n \n \tADD_SIGNAL(MethodInfo(\"tree_changed\"));\n+\tADD_SIGNAL(MethodInfo(\"scene_changed\"));\n \tADD_SIGNAL(MethodInfo(\"tree_process_mode_changed\")); //editor only signal, but due to API hash it can't be removed in run-time\n \tADD_SIGNAL(MethodInfo(\"node_added\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n \tADD_SIGNAL(MethodInfo(\"node_removed\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n", "instance_id": "godotengine__godot-102986", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the `change_scene_to_*` methods in Godot 4.2+, where the scene change does not occur as expected after a single `process_frame` await, requiring two awaits instead. It provides a code snippet to illustrate the issue and references the documentation for context. Additionally, a minimal reproduction project (MRP) is provided, which aids in understanding the problem. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior beyond referencing \"old behavior\" and lacks detailed discussion of potential edge cases or constraints (e.g., specific conditions under which this issue occurs or interactions with other systems). While the issue is valid and mostly clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, affecting two files (`SceneTree.xml` for documentation and `scene_tree.cpp` for implementation). The modifications involve adding a new signal (`scene_changed`) to notify when the scene change is complete and updating the documentation to reflect this. The changes are straightforward, involving minimal lines of code (adding a signal emission and binding it), and do not impact the broader system architecture significantly.\n\n2. **Technical Concepts Required**: Solving this requires a basic understanding of Godot's scene management system, specifically how scene changes are deferred and processed at the end of frames. It also involves familiarity with Godot's signal system to emit and bind a new signal. These concepts are not overly complex for someone with moderate experience in game engine development or C++ (used in Godot's core). No advanced algorithms, design patterns, or domain-specific knowledge beyond Godot's API are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce or modify error handling logic. The addition of the `scene_changed` signal is a simple notification mechanism without apparent complexity in handling edge cases. However, a developer might need to consider scenarios like rapid scene changes or signal handling in concurrent contexts, though these are not addressed in the provided changes or problem statement.\n\n4. **Overall Complexity**: The task involves understanding a specific behavior in Godot's scene tree processing and making a small, targeted fix by introducing a signal. It requires some code logic comprehension but does not demand deep architectural changes or extensive debugging of complex interactions. The impact is limited to users of the `change_scene_to_*` methods who need reliable scene change notifications.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires moderate understanding of the codebase and simple modifications, with minimal impact on the overall system.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4 beta 1] TLS Handshake Error with Godot HTTPRequest\n### Tested versions\n\n4.4 beta 1 \n\n\n### System information\n\nWindows 11 - Godot 4.4 beta 1 - Vulkan (Mobile)\n\n### Issue description\n\nI\u2019m encountering a TLS handshake error when trying to make a request to https://graph.oculus.com/ using Godot's HTTPRequest.\n\n* Requests to https://www.google.com/ work without any issues.\n* Python's requests library can access the URL without any problems.\n* The same https://graph.oculus.com/ URL works correctly in Postman.\n* I attempted to create a certificate bundle as well, but it was unsuccessful.\n* This issue appears to be specific to Godot.\n\nCPP ERROR:\n\nE 0:00:01:0639   StreamPeerMbedTLS::_do_handshake: TLS handshake error: -28800\n  <C++ Source>   modules\\mbedtls\\stream_peer_mbedtls.cpp:88 @ StreamPeerMbedTLS::_do_handshake()\n\n### Steps to reproduce\n\n* Create simple project\n* Add a HTTPRequest node\n* Add script:\n```\nextends Node3D\n\n@onready var http: HTTPRequest = $HTTPRequest\n\nfunc _ready() -> void:\n\thttp.request(\"https://graph.oculus.com/\")\n\tprint(await http.request_completed)\n```\n* Run\n\n\n### Minimal reproduction project (MRP)\n\n[teste-vr.zip](https://github.com/user-attachments/files/18505403/teste-vr.zip)\n", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex b27665548f4b..79bf8975411b 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2204,6 +2204,10 @@\n \t\t\tThe CA certificates bundle to use for TLS connections. If this is set to a non-empty value, this will [i]override[/i] Godot's default [url=https://github.com/godotengine/godot/blob/master/thirdparty/certs/ca-certificates.crt]Mozilla certificate bundle[/url]. If left empty, the default certificate bundle will be used.\n \t\t\tIf in doubt, leave this setting empty.\n \t\t</member>\n+\t\t<member name=\"network/tls/enable_tls_v1.3\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n+\t\t\tIf [code]true[/code], enable TLSv1.3 negotiation.\n+\t\t\t[b]Note:[/b] This is experimental, and may cause connections to fail in some cases (notably, if the remote server uses TLS handshake fragmentation).\n+\t\t</member>\n \t\t<member name=\"physics/2d/default_angular_damp\" type=\"float\" setter=\"\" getter=\"\" default=\"1.0\">\n \t\t\tThe default rotational motion damping in 2D. Damping is used to gradually slow down physical objects over time. RigidBodies will fall back to this value when combining their own damping values and no area damping value is present.\n \t\t\tSuggested values are in the range [code]0[/code] to [code]30[/code]. At value [code]0[/code] objects will keep moving with the same velocity. Greater values will stop the object faster. A value equal to or greater than the physics tick rate ([member physics/common/physics_ticks_per_second]) will bring the object to a stop in one iteration.\ndiff --git a/modules/mbedtls/register_types.cpp b/modules/mbedtls/register_types.cpp\nindex bf65dfb0b76a..c0eca6ee18e0 100644\n--- a/modules/mbedtls/register_types.cpp\n+++ b/modules/mbedtls/register_types.cpp\n@@ -35,6 +35,8 @@\n #include \"packet_peer_mbed_dtls.h\"\n #include \"stream_peer_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n #include <psa/crypto.h>\n #endif\n@@ -50,6 +52,8 @@ void initialize_mbedtls_module(ModuleInitializationLevel p_level) {\n \t\treturn;\n \t}\n \n+\tGLOBAL_DEF(\"network/tls/enable_tls_v1.3\", false);\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n \tint status = psa_crypto_init();\n \tERR_FAIL_COND_MSG(status != PSA_SUCCESS, \"Failed to initialize psa crypto. The mbedTLS modules will not work.\");\ndiff --git a/modules/mbedtls/tls_context_mbedtls.cpp b/modules/mbedtls/tls_context_mbedtls.cpp\nindex f5c196596eb2..33c4cfd5450e 100644\n--- a/modules/mbedtls/tls_context_mbedtls.cpp\n+++ b/modules/mbedtls/tls_context_mbedtls.cpp\n@@ -30,6 +30,8 @@\n \n #include \"tls_context_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n static void my_debug(void *ctx, int level,\n \t\tconst char *file, int line,\n \t\tconst char *str) {\n@@ -144,6 +146,11 @@ Error TLSContextMbedTLS::init_server(int p_transport, Ref<TLSOptions> p_options,\n \t\tcookies = p_cookies;\n \t\tmbedtls_ssl_conf_dtls_cookies(&conf, mbedtls_ssl_cookie_write, mbedtls_ssl_cookie_check, &(cookies->cookie_ctx));\n \t}\n+\n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \tmbedtls_ssl_setup(&tls, &conf);\n \treturn OK;\n }\n@@ -187,6 +194,10 @@ Error TLSContextMbedTLS::init_client(int p_transport, const String &p_hostname,\n \t\t}\n \t}\n \n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \t// Set valid CAs\n \tmbedtls_ssl_conf_ca_chain(&conf, &(cas->cert), nullptr);\n \tmbedtls_ssl_setup(&tls, &conf);\n", "instance_id": "godotengine__godot-102774", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a TLS handshake error occurs when making HTTP requests to a specific URL (https://graph.oculus.com/) using Godot's HTTPRequest in version 4.4 beta 1. It provides relevant context, such as the fact that the issue does not occur with other URLs or tools (e.g., Python's requests library, Postman), and includes steps to reproduce the issue along with a minimal reproduction project. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or desired outcome (e.g., whether the goal is to support TLSv1.3 or simply bypass the handshake error). Additionally, it lacks specifics about potential causes of the TLS handshake error (e.g., cipher suite mismatches or server-specific configurations) and does not mention edge cases or constraints related to the environment or TLS versions. While the issue is valid and reproducible, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes involves multiple files (ProjectSettings.xml, register_types.cpp, and tls_context_mbedtls.cpp) within the Godot engine's codebase, specifically in the mbedTLS module, which is a critical component for handling secure connections. The changes introduce a new configuration option to toggle TLSv1.3 support, requiring an understanding of how TLS versions are negotiated and configured in mbedTLS. This involves moderately complex interactions between project settings and the TLS context initialization logic. Second, the technical concepts required include knowledge of TLS protocols (specifically TLSv1.3 limitations and handshake fragmentation issues), familiarity with the mbedTLS library's API (e.g., mbedtls_ssl_conf_max_tls_version), and understanding of Godot's project settings system. Third, while the problem statement does not explicitly mention edge cases, the code changes and accompanying note about potential connection failures due to handshake fragmentation suggest that edge cases related to server compatibility and TLS configurations need to be considered. Finally, the impact of the change is significant as it affects the core networking functionality of the engine, though it is mitigated by making TLSv1.3 optional and disabled by default. Overall, solving this requires a deep understanding of TLS internals and the Godot codebase, along with careful consideration of compatibility issues, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "In tileset editor, attempting to paint terrain over alternative tile instead creates a new alternative tile\n### Tested versions\n\n- Reproducible for v4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.22631 - GLES3 (Compatibility) - AMD Radeon RX 6600M (Advanced Micro Devices, Inc.; 30.0.13024.5001) - AMD Ryzen 7 5800H with Radeon Graphics (16 Threads)\n\n### Issue description\n\nAttempting to paint terrain over an alternative tile instead results with the terrain editor creating a new alternative tile. Which shouldn't happen, as the alternative tile creation is done via \"Select\" tab of the tileset editor.\n\n### Steps to reproduce\n\n1. Load attached project\n2. Open `player.tscn`\n3. Open `TileMapLayer` node\n4. Switch to tileset editing, `Paint` mode\n5. Select property `Terrains` -> `Terrain Set 0` -> `Dots Biome`\n6. Attempt to paint this point:\n![Image](https://github.com/user-attachments/assets/814c2333-8a5a-4d8e-a20a-06daee32f4ef)\n7. Be greeted with this sight:\n![Image](https://github.com/user-attachments/assets/c6be7659-d9d3-43e8-8fd7-25ec609d998b)\n\n\n\n\n### Minimal reproduction project (MRP)\n\n[TerrainPainterBug.zip](https://github.com/user-attachments/files/17937477/TerrainPainterBug.zip)\n", "patch": "diff --git a/editor/plugins/tiles/tile_set_atlas_source_editor.cpp b/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\nindex ffb5bb5009db..80958b2043fb 100644\n--- a/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\n+++ b/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\n@@ -971,40 +971,44 @@ void TileSetAtlasSourceEditor::_update_atlas_view() {\n \t\ttile_create_help->set_visible(tools_button_group->get_pressed_button() == tool_setup_atlas_source_button);\n \t}\n \n-\tVector2i pos;\n-\tVector2 texture_region_base_size = tile_set_atlas_source->get_texture_region_size();\n-\tint texture_region_base_size_min = MIN(texture_region_base_size.x, texture_region_base_size.y);\n-\tfor (int i = 0; i < tile_set_atlas_source->get_tiles_count(); i++) {\n-\t\tVector2i tile_id = tile_set_atlas_source->get_tile_id(i);\n-\t\tint alternative_count = tile_set_atlas_source->get_alternative_tiles_count(tile_id);\n-\t\tif (alternative_count > 1) {\n-\t\t\t// Compute the right extremity of alternative.\n-\t\t\tint y_increment = 0;\n-\t\t\tpos.x = 0;\n-\t\t\tfor (int j = 1; j < alternative_count; j++) {\n-\t\t\t\tint alternative_id = tile_set_atlas_source->get_alternative_tile_id(tile_id, j);\n-\t\t\t\tRect2i rect = tile_atlas_view->get_alternative_tile_rect(tile_id, alternative_id);\n-\t\t\t\tpos.x = MAX(pos.x, rect.get_end().x);\n-\t\t\t\ty_increment = MAX(y_increment, rect.size.y);\n-\t\t\t}\n-\n-\t\t\t// Create and position the button.\n-\t\t\tButton *button = memnew(Button);\n-\t\t\tbutton->set_flat(true);\n-\t\t\tbutton->set_button_icon(get_editor_theme_icon(SNAME(\"Add\")));\n-\t\t\tbutton->add_theme_style_override(CoreStringName(normal), memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(SceneStringName(hover), memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(\"focus\", memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(SceneStringName(pressed), memnew(StyleBoxEmpty));\n-\t\t\tbutton->connect(SceneStringName(pressed), callable_mp(tile_set_atlas_source, &TileSetAtlasSource::create_alternative_tile).bind(tile_id, TileSetSource::INVALID_TILE_ALTERNATIVE));\n-\t\t\tbutton->set_rect(Rect2(Vector2(pos.x, pos.y + (y_increment - texture_region_base_size.y) / 2.0), Vector2(texture_region_base_size_min, texture_region_base_size_min)));\n-\t\t\tbutton->set_expand_icon(true);\n-\t\t\talternative_tiles_control->add_child(button);\n-\n-\t\t\tpos.y += y_increment;\n-\t\t}\n-\t}\n-\ttile_atlas_view->set_padding(Side::SIDE_RIGHT, texture_region_base_size_min);\n+\tif (tools_button_group->get_pressed_button() != tool_paint_button) {\n+\t\tVector2i pos;\n+\t\tVector2 texture_region_base_size = tile_set_atlas_source->get_texture_region_size();\n+\t\tint texture_region_base_size_min = MIN(texture_region_base_size.x, texture_region_base_size.y);\n+\t\tfor (int i = 0; i < tile_set_atlas_source->get_tiles_count(); i++) {\n+\t\t\tVector2i tile_id = tile_set_atlas_source->get_tile_id(i);\n+\t\t\tint alternative_count = tile_set_atlas_source->get_alternative_tiles_count(tile_id);\n+\t\t\tif (alternative_count > 1) {\n+\t\t\t\t// Compute the right extremity of alternative.\n+\t\t\t\tint y_increment = 0;\n+\t\t\t\tpos.x = 0;\n+\t\t\t\tfor (int j = 1; j < alternative_count; j++) {\n+\t\t\t\t\tint alternative_id = tile_set_atlas_source->get_alternative_tile_id(tile_id, j);\n+\t\t\t\t\tRect2i rect = tile_atlas_view->get_alternative_tile_rect(tile_id, alternative_id);\n+\t\t\t\t\tpos.x = MAX(pos.x, rect.get_end().x);\n+\t\t\t\t\ty_increment = MAX(y_increment, rect.size.y);\n+\t\t\t\t}\n+\n+\t\t\t\t// Create and position the button.\n+\t\t\t\tButton *button = memnew(Button);\n+\t\t\t\tbutton->set_flat(true);\n+\t\t\t\tbutton->set_button_icon(get_editor_theme_icon(SNAME(\"Add\")));\n+\t\t\t\tbutton->add_theme_style_override(CoreStringName(normal), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(SceneStringName(hover), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(\"focus\", memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(SceneStringName(pressed), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_constant_override(\"align_to_largest_stylebox\", false);\n+\t\t\t\tbutton->set_mouse_filter(Control::MOUSE_FILTER_PASS);\n+\t\t\t\tbutton->connect(SceneStringName(pressed), callable_mp(this, &TileSetAtlasSourceEditor::_tile_alternatives_create_button_pressed).bind(tile_id));\n+\t\t\t\tbutton->set_rect(Rect2(Vector2(pos.x, pos.y + (y_increment - texture_region_base_size.y) / 2.0), Vector2(texture_region_base_size_min, texture_region_base_size_min)));\n+\t\t\t\tbutton->set_expand_icon(true);\n+\t\t\t\talternative_tiles_control->add_child(button);\n+\n+\t\t\t\tpos.y += y_increment;\n+\t\t\t}\n+\t\t}\n+\t\ttile_atlas_view->set_padding(Side::SIDE_RIGHT, texture_region_base_size_min);\n+\t}\n \n \t// Redraw everything.\n \ttile_atlas_control->queue_redraw();\n@@ -2009,6 +2013,17 @@ void TileSetAtlasSourceEditor::_tile_alternatives_control_mouse_exited() {\n \talternative_tiles_control_unscaled->queue_redraw();\n }\n \n+void TileSetAtlasSourceEditor::_tile_alternatives_create_button_pressed(const Vector2i &p_atlas_coords) {\n+\tEditorUndoRedoManager *undo_redo = EditorUndoRedoManager::get_singleton();\n+\n+\t// FIXME: Doesn't undo changes to `next_alternative_id` counter.\n+\tundo_redo->create_action(TTR(\"Create tile alternatives\"));\n+\tint next_id = tile_set_atlas_source->get_next_alternative_tile_id(p_atlas_coords);\n+\tundo_redo->add_do_method(tile_set_atlas_source, \"create_alternative_tile\", p_atlas_coords, next_id);\n+\tundo_redo->add_undo_method(tile_set_atlas_source, \"remove_alternative_tile\", p_atlas_coords, next_id);\n+\tundo_redo->commit_action();\n+}\n+\n void TileSetAtlasSourceEditor::_tile_alternatives_control_draw() {\n \t// Update the hovered alternative tile.\n \tif (tools_button_group->get_pressed_button() == tool_select_button) {\ndiff --git a/editor/plugins/tiles/tile_set_atlas_source_editor.h b/editor/plugins/tiles/tile_set_atlas_source_editor.h\nindex 12a02e6a3980..b729364d1559 100644\n--- a/editor/plugins/tiles/tile_set_atlas_source_editor.h\n+++ b/editor/plugins/tiles/tile_set_atlas_source_editor.h\n@@ -253,6 +253,7 @@ class TileSetAtlasSourceEditor : public HSplitContainer {\n \tPopupMenu *alternative_tile_popup_menu = nullptr;\n \tControl *alternative_tiles_control = nullptr;\n \tControl *alternative_tiles_control_unscaled = nullptr;\n+\tvoid _tile_alternatives_create_button_pressed(const Vector2i &p_atlas_coords);\n \tvoid _tile_alternatives_control_draw();\n \tvoid _tile_alternatives_control_unscaled_draw();\n \tvoid _tile_alternatives_control_mouse_exited();\n", "instance_id": "godotengine__godot-102640", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: attempting to paint terrain over an alternative tile in the Godot tileset editor results in creating a new alternative tile, which is unintended behavior. The steps to reproduce are detailed, including specific actions and visual references (screenshots), and a minimal reproduction project is provided, which aids in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should painting terrain simply overwrite the alternative tile or ignore it?). Additionally, there are no mentions of specific edge cases or constraints that might affect the solution, such as how the system should behave with different types of tiles or under specific editor configurations. While the issue is reproducible and the goal is implied (prevent creating new alternative tiles in Paint mode), these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`tile_set_atlas_source_editor.cpp`) with modifications to the logic for creating alternative tiles. The changes involve conditional logic to restrict alternative tile creation based on the active tool (e.g., not in Paint mode) and adding undo/redo functionality, which requires understanding the editor's tool system and Godot's undo/redo framework. Second, the technical concepts involved include familiarity with Godot's editor plugin architecture, GUI control manipulation (e.g., buttons and mouse events), and the specific `TileSetAtlasSource` class behavior, which adds moderate complexity. Third, the changes do not significantly impact the broader system architecture but do require careful integration with existing functionality to avoid introducing new bugs. Finally, while the problem statement does not explicitly mention edge cases, the code changes suggest potential considerations, such as ensuring undo/redo works correctly for all tile configurations and preventing unintended interactions in different editor modes. Overall, this problem requires a solid understanding of a specific part of the Godot codebase and careful implementation, placing it slightly above medium difficulty at 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "\"The default value is using \"$\" which won't return nodes...\" warning despite using Unique Name (\"%\")\n### Tested versions\n\n- Reproducible in v4.4.beta.custom_build [eee39f004]\n\n### System information\n\nGodot v4.4.beta (eee39f004) - macOS Sequoia (15.3.0) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon Pro 5500 XT OpenGL Engine - Intel(R) Core(TM) i7-10700K CPU @ 3.80GHz (16 threads)\n\n### Issue description\n\nThe error message for attempting to access a unique-named node in a class body without the `@onready` annotation is slightly incorrect - it claims the user is using \"$\", when in reality the user is using \"%\".\n\n![Image](https://github.com/user-attachments/assets/9ba9b6f5-1bf6-40f2-a5a8-1ab799010175)\n\n \n\n### Steps to reproduce\n\nIn a new GDScript file, on the class level, type the following:\n```gdscript\nvar something = %Hello\n```\n\nYou will get an error like\n```\nThe default value is using \"$\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this. (Warning treated as error.)gdscript(-1)\n```\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/modules/gdscript/gdscript_analyzer.cpp b/modules/gdscript/gdscript_analyzer.cpp\nindex 60109efc4d5b..99fab724e8da 100644\n--- a/modules/gdscript/gdscript_analyzer.cpp\n+++ b/modules/gdscript/gdscript_analyzer.cpp\n@@ -1093,7 +1093,12 @@ void GDScriptAnalyzer::resolve_class_member(GDScriptParser::ClassNode *p_class,\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (is_get_node) {\n-\t\t\t\t\t\t\tparser->push_warning(member.variable, GDScriptWarning::GET_NODE_DEFAULT_WITHOUT_ONREADY, is_using_shorthand ? \"$\" : \"get_node()\");\n+\t\t\t\t\t\t\tString offending_syntax = \"get_node()\";\n+\t\t\t\t\t\t\tif (is_using_shorthand) {\n+\t\t\t\t\t\t\t\tGDScriptParser::GetNodeNode *get_node_node = static_cast<GDScriptParser::GetNodeNode *>(expr);\n+\t\t\t\t\t\t\t\toffending_syntax = get_node_node->use_dollar ? \"$\" : \"%\";\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tparser->push_warning(member.variable, GDScriptWarning::GET_NODE_DEFAULT_WITHOUT_ONREADY, offending_syntax);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n", "instance_id": "godotengine__godot-102389", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an error message in the Godot engine's GDScript analyzer incorrectly reports the use of \"$\" when the user is actually using \"%\" for accessing a unique-named node. The goal is evident (fix the error message to reflect the correct syntax), and the steps to reproduce the issue are provided with a minimal code snippet. Additionally, system information and a screenshot are included to contextualize the problem. However, there are minor ambiguities: the problem statement does not explicitly discuss the expected behavior or output after the fix (though it can be inferred), and it lacks mention of potential edge cases or constraints related to the error message handling. Overall, it falls into the \"Mostly Clear\" category with minor details missing.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). The issue is a straightforward bug fix in the GDScript analyzer component of the Godot engine, specifically in the error message generation logic. The code change is localized to a single file (`gdscript_analyzer.cpp`) and involves a small modification (a few lines) to dynamically determine the offending syntax (\"$\" or \"%\") based on the parsed node data. The technical concepts required are minimal: basic C++ knowledge, familiarity with the Godot engine's GDScript parser structure, and understanding of conditional logic for string selection. There is no significant impact on the broader codebase or system architecture, and the change does not require handling complex edge cases beyond identifying the correct syntax used. Error handling is already in place via the warning system, and no additional logic for edge cases is needed based on the provided diff. This makes the task approachable for someone with basic to intermediate experience in C++ and a cursory understanding of the Godot engine's internals.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[3.x] Autocomplete fails when typing the key before the value in a dictionary\n**Godot version:**\r\nGodot 3.2.stable.official\r\n\r\n**OS/device including version:**\r\nWindows 10 home\r\n\r\n**Issue description:**\r\nWhen adding a key to the dictionary, the autocomplete does not work until I enter the value. The workaround is to start by entering `:any_value` then moving the cursor back and entering the key for the autocomplete to work.\r\n\r\n**Steps to reproduce:**\r\nCreate the following script and try to add a key value pair to `data`, the enum does not autocomplete until a value is added :\r\n```\r\nextends Reference\r\n\r\nvar\tdata = {InnerClass.INNER_ENUM_VALUE_1:1}\r\n\r\nclass InnerClass:\r\n\tenum {INNER_ENUM_VALUE_1}\r\n\r\n```\r\n**Minimal reproduction project:**\r\nDon't need a project, just the above script.\n", "patch": "diff --git a/modules/gdscript/gdscript_parser.cpp b/modules/gdscript/gdscript_parser.cpp\nindex 077ab6f04667..4b95f5a83613 100644\n--- a/modules/gdscript/gdscript_parser.cpp\n+++ b/modules/gdscript/gdscript_parser.cpp\n@@ -3123,13 +3123,9 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\t\tcase DictionaryNode::LUA_TABLE:\n \t\t\t\t\tif (key != nullptr && key->type != Node::IDENTIFIER && key->type != Node::LITERAL) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (key != nullptr && key->type == Node::LITERAL && static_cast<LiteralNode *>(key)->value.get_type() != Variant::STRING) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (!match(GDScriptTokenizer::Token::EQUAL)) {\n \t\t\t\t\t\tif (match(GDScriptTokenizer::Token::COLON)) {\n@@ -3169,6 +3165,21 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\tif (key != nullptr && value != nullptr) {\n \t\t\t\tdictionary->elements.push_back({ key, value });\n \t\t\t}\n+\n+\t\t\t// Do phrase level recovery by inserting an imaginary expression for missing keys or values.\n+\t\t\t// This ensures the successfully parsed expression is part of the AST and can be analyzed.\n+\t\t\tif (key != nullptr && value == nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ key, dummy });\n+\t\t\t} else if (key == nullptr && value != nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ dummy, value });\n+\t\t\t}\n+\n \t\t} while (match(GDScriptTokenizer::Token::COMMA) && !is_at_end());\n \t}\n \tpop_multiline();\ndiff --git a/modules/gdscript/gdscript_parser.h b/modules/gdscript/gdscript_parser.h\nindex 5da2bc80207f..8afc6b5f05a6 100644\n--- a/modules/gdscript/gdscript_parser.h\n+++ b/modules/gdscript/gdscript_parser.h\n@@ -1453,6 +1453,18 @@ class GDScriptParser {\n \n \t\treturn node;\n \t}\n+\n+\t// Allocates a node for patching up the parse tree when an error occurred.\n+\t// Such nodes don't track their extents as they don't relate to actual tokens.\n+\ttemplate <typename T>\n+\tT *alloc_recovery_node() {\n+\t\tT *node = memnew(T);\n+\t\tnode->next = list;\n+\t\tlist = node;\n+\n+\t\treturn node;\n+\t}\n+\n \tvoid clear();\n \tvoid push_error(const String &p_message, const Node *p_origin = nullptr);\n #ifdef DEBUG_ENABLED\n", "instance_id": "godotengine__godot-102218", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: autocomplete in the Godot engine's GDScript editor fails when typing a dictionary key before its value. It provides a specific scenario (adding a key-value pair to a dictionary), steps to reproduce the issue, and a minimal code snippet to demonstrate the problem. However, there are minor ambiguities and missing details. For instance, the expected behavior of autocomplete is not explicitly defined (e.g., should it suggest enum values or other identifiers?), and there is no mention of specific edge cases or constraints that might affect the solution. Additionally, the problem statement does not clarify the desired outcome beyond \"autocomplete should work,\" leaving some room for interpretation. Overall, while the issue is understandable, it lacks comprehensive details about the expected fix or potential complexities in the editor's parsing logic.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the code changes are made in the GDScript parser (a core component of the Godot engine), which requires a deep understanding of the engine's internals, specifically how the parser constructs the Abstract Syntax Tree (AST) and handles incomplete or erroneous input for features like autocomplete. The modifications involve adding recovery logic to handle missing keys or values in dictionary literals by inserting dummy nodes, which is a non-trivial change to the parsing strategy. This impacts not just a single function but the overall behavior of the parser, potentially affecting autocomplete and error reporting across the system. \n\nFrom a technical concepts perspective, the solution requires knowledge of compiler design (parsing and AST construction), memory management in C++ (e.g., `memnew` for node allocation), and familiarity with Godot's custom data structures and parsing rules. The code changes span two files (`gdscript_parser.cpp` and `gdscript_parser.h`), indicating a moderate scope, though the actual lines of code added are relatively small. \n\nRegarding edge cases and error handling, the problem statement does not explicitly mention specific scenarios, but the code changes introduce recovery mechanisms for incomplete dictionary expressions (missing keys or values), which inherently addresses potential edge cases in user input during editing. Crafting this recovery logic without breaking existing parser behavior or introducing performance overhead adds to the complexity. \n\nOverall, this problem requires a solid grasp of the codebase's architecture and careful consideration of the parser's behavior, justifying a difficulty score of 0.65. It is not at the highest end of difficulty (e.g., a complete parser rewrite or system-level change), but it is challenging enough to demand specialized knowledge and careful implementation.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "SpotLight3D shadow has significant peter-panning with default settings (4.4-dev7 and 4.4-beta1)\n### Tested versions\n\nReproducible in: 4.4-dev7 and 4.4-beta1\nNot reproducible in: 4.4-dev6 and before\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 (NVIDIA; 32.0.15.6603) - 13th Gen Intel(R) Core(TM) i7-13700K (24 threads)\n\n### Issue description\n\nShadow casting SpotLight3D has noticeable peter-panning effect with default bias value. Example below:\n\n![Image](https://github.com/user-attachments/assets/501f57ff-6c38-477d-aa8e-0e2e695ab5ba)\n\n### Steps to reproduce\n\nCreate a new 3D scene\nAdd floor into the scene and add mesh on the floor\nAdd SpotLight3D and enable shadows\nPoint the spotlight towards mesh and observe shadow it casts\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl b/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\nindex 8e393c07bdb2..6fb8fe6ca339 100644\n--- a/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\n+++ b/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\n@@ -733,7 +733,7 @@ void light_process_spot(uint idx, vec3 vertex, vec3 eye_vec, vec3 normal, vec3 v\n \t\tvec4 v = vec4(vertex + normal_bias, 1.0);\n \n \t\tvec4 splane = (spot_lights.data[idx].shadow_matrix * v);\n-\t\tsplane.z += spot_lights.data[idx].shadow_bias / (light_length * spot_lights.data[idx].inv_radius);\n+\t\tsplane.z += spot_lights.data[idx].shadow_bias;\n \t\tsplane /= splane.w;\n \n \t\tif (sc_use_light_soft_shadows() && spot_lights.data[idx].soft_shadow_size > 0.0) {\ndiff --git a/servers/rendering/renderer_scene_cull.cpp b/servers/rendering/renderer_scene_cull.cpp\nindex 0b98fc6769e7..ef79ef8cda7a 100644\n--- a/servers/rendering/renderer_scene_cull.cpp\n+++ b/servers/rendering/renderer_scene_cull.cpp\n@@ -2510,7 +2510,7 @@ bool RendererSceneCull::_light_instance_update_shadow(Instance *p_instance, cons\n \t\t\t\t}\n \n \t\t\t\treal_t radius = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_RANGE);\n-\t\t\t\treal_t z_near = MIN(0.005f, radius);\n+\t\t\t\treal_t z_near = MIN(0.025f, radius);\n \t\t\t\tProjection cm;\n \t\t\t\tcm.set_perspective(90, 1, z_near, radius);\n \n@@ -2600,7 +2600,7 @@ bool RendererSceneCull::_light_instance_update_shadow(Instance *p_instance, cons\n \n \t\t\treal_t radius = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_RANGE);\n \t\t\treal_t angle = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_SPOT_ANGLE);\n-\t\t\treal_t z_near = MIN(0.005f, radius);\n+\t\t\treal_t z_near = MIN(0.025f, radius);\n \n \t\t\tProjection cm;\n \t\t\tcm.set_perspective(angle * 2.0, 1.0, z_near, radius);\n", "instance_id": "godotengine__godot-101952", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue of \"peter-panning\" (a visual artifact in shadow rendering) with SpotLight3D in specific versions of the Godot engine (4.4-dev7 and 4.4-beta1). It provides steps to reproduce the issue, system information, and a visual example, which helps in understanding the problem. However, there are minor ambiguities and missing details. For instance, the term \"peter-panning\" is not explicitly defined in the context of shadow rendering, which might require domain-specific knowledge to interpret correctly (it typically refers to shadows detaching from objects). Additionally, the problem statement does not specify the expected behavior or desired outcome after the fix, nor does it mention specific edge cases or constraints that should be considered in the solution. While the reproduction steps are clear, the lack of a minimal reproduction project (MRP) could make it slightly harder to test and validate the issue. Overall, the statement is valid and mostly clear but lacks some minor details for full comprehensiveness.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes involves modifications in two files: a GLSL shader file (`scene_forward_lights_inc.glsl`) and a C++ file (`renderer_scene_cull.cpp`). The changes are relatively small and localized, focusing on adjusting shadow bias calculations and near-plane values for perspective projection in shadow rendering. However, understanding and implementing these changes requires knowledge of multiple technical concepts, including 3D graphics rendering, shadow mapping techniques, GLSL shader programming, and the Godot engine's rendering pipeline. Specifically, the developer needs to understand how shadow bias and near-plane settings affect shadow artifacts like peter-panning, which involves some domain-specific knowledge of computer graphics. The changes also impact a critical part of the rendering system, potentially affecting visual quality across various scenes, which adds a layer of complexity in terms of testing and validation. While the problem does not explicitly mention edge cases or error handling, the nature of shadow rendering implies potential challenges with different light configurations, object geometries, or hardware setups, which the developer must consider. Overall, this problem requires a moderate level of expertise in graphics programming and familiarity with the Godot engine's internals, placing it in the medium difficulty range (0.4-0.6), slightly above the midpoint due to the specialized knowledge required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Jolt Physics and sync_to_physics prevents any AnimatableBody3D transforms\n### Tested versions\n\n- Reproducible: 4.4.beta1\n- Not reproducible: 4.4.dev7\n\n### System information\n\nGodot v4.4.beta1 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1070 (NVIDIA; 32.0.15.6094) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nUsing the Jolt physics engine and enabling `AnimatableBody3D.sync_to_physics` stops the object from moving at all when setting a transform, position or similar.\n\nDisabling `sync_to_physics`, or switching to the Godot physics engine fixes the problem.\n\n \n\n### Steps to reproduce\n\nCreate an `AnimatableBody3D` Node. Set `sync_to_physics` to true. Use the Jolt physics engine.\n\n### Minimal reproduction project (MRP)\n\n[jolt-transform-bug.zip](https://github.com/user-attachments/files/18464415/jolt-transform-bug.zip)\n\n", "patch": "diff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex d1a40e7b105c..ac2b37470ef1 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -210,20 +210,6 @@ void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \tp_jolt_body.MoveKinematic(new_position, new_rotation, p_step);\n }\n \n-void JoltBody3D::_pre_step_rigid(float p_step, JPH::Body &p_jolt_body) {\n-\t_integrate_forces(p_step, p_jolt_body);\n-\t_enqueue_call_queries();\n-}\n-\n-void JoltBody3D::_pre_step_kinematic(float p_step, JPH::Body &p_jolt_body) {\n-\t_update_gravity(p_jolt_body);\n-\t_move_kinematic(p_step, p_jolt_body);\n-\n-\tif (reports_contacts()) {\n-\t\t_enqueue_call_queries();\n-\t}\n-}\n-\n JPH::EAllowedDOFs JoltBody3D::_calculate_allowed_dofs() const {\n \tif (is_static()) {\n \t\treturn JPH::EAllowedDOFs::All;\n@@ -1237,13 +1223,18 @@ void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID:\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID_LINEAR: {\n-\t\t\t_pre_step_rigid(p_step, p_jolt_body);\n+\t\t\t_integrate_forces(p_step, p_jolt_body);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_KINEMATIC: {\n-\t\t\t_pre_step_kinematic(p_step, p_jolt_body);\n+\t\t\t_update_gravity(p_jolt_body);\n+\t\t\t_move_kinematic(p_step, p_jolt_body);\n \t\t} break;\n \t}\n \n+\tif (_should_call_queries()) {\n+\t\t_enqueue_call_queries();\n+\t}\n+\n \tcontact_count = 0;\n }\n \ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.h b/modules/jolt_physics/objects/jolt_body_3d.h\nindex 4f5d4006edcf..9b9472e73ae8 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_body_3d.h\n@@ -110,6 +110,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvirtual void _add_to_space() override;\n \n+\tbool _should_call_queries() const { return state_sync_callback.is_valid() || custom_integration_callback.is_valid(); }\n \tvoid _enqueue_call_queries();\n \tvoid _dequeue_call_queries();\n \n@@ -117,9 +118,6 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvoid _move_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n-\tvoid _pre_step_rigid(float p_step, JPH::Body &p_jolt_body);\n-\tvoid _pre_step_kinematic(float p_step, JPH::Body &p_jolt_body);\n-\n \tJPH::EAllowedDOFs _calculate_allowed_dofs() const;\n \n \tJPH::MassProperties _calculate_mass_properties(const JPH::Shape &p_shape) const;\n", "instance_id": "godotengine__godot-101803", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: using the Jolt physics engine with `AnimatableBody3D.sync_to_physics` enabled prevents the object from moving when transforms or positions are set. It provides specific conditions under which the issue occurs (Jolt physics engine, `sync_to_physics` enabled) and contrasts this with scenarios where the issue does not occur (disabling `sync_to_physics` or using Godot physics). Additionally, it includes system information, tested versions, and steps to reproduce, which are helpful for context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., how the transform should behave with `sync_to_physics` enabled) or provide detailed examples of the failure beyond \"stops the object from moving.\" Edge cases, constraints, or specific failure modes are not mentioned, which could leave room for interpretation when implementing a fix. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`jolt_body_3d.cpp`) with modifications to the logic of pre-step handling for rigid and kinematic bodies. The changes involve refactoring by removing dedicated pre-step methods and inlining their logic into the main `pre_step` method, along with introducing a new helper method `_should_call_queries()`. This indicates a moderate level of complexity as it requires understanding the interaction between different body modes and the physics simulation loop in the Jolt physics engine. Second, the technical concepts involved include familiarity with physics engine internals (e.g., kinematic movement, force integration, gravity updates) and the specific behavior of `AnimatableBody3D` in Godot, which adds a layer of domain-specific knowledge. However, the changes do not appear to impact the broader system architecture or require extensive cross-module modifications. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest potential considerations around contact reporting and query callbacks, though the handling remains straightforward. Overall, this problem requires a moderate understanding of the codebase and physics simulation logic, placing it in the 0.4-0.6 range, with a specific score of 0.45 reflecting that it leans toward the lower end of medium difficulty due to the focused scope of changes.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Duplicating a script triggers modified outside Godot dialog\n### Tested versions\n\nGodot v4.4.dev7\n\nTried v4.4.dev2 too and it did not happen there\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - Wayland display driver, Single-window\n\n### Issue description\n\nIf you duplicate a script in FileSystem with the script open and then either save the open file or focus another window and then back to Godot it triggers the modified outside Godot dialog for the open script.\n\nhttps://github.com/user-attachments/assets/ddfba1e6-8ac9-4812-a46a-3fa22d1bbd4a\n\n\n### Steps to reproduce\n\n^\n\n### Minimal reproduction project (MRP)\n\n[doc.zip](https://github.com/user-attachments/files/18423743/doc.zip)\n", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex f626891bd8ea..caf877f40789 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1486,6 +1486,11 @@ void FileSystemDock::_try_move_item(const FileOrFolder &p_item, const String &p_\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tRef<Resource> res = ResourceCache::get_ref(old_path);\n+\t\t\t\tif (res.is_valid()) {\n+\t\t\t\t\tres->set_path_cache(new_path);\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \ndiff --git a/editor/plugins/script_editor_plugin.cpp b/editor/plugins/script_editor_plugin.cpp\nindex 77dd61b26346..1a1e5697c2d2 100644\n--- a/editor/plugins/script_editor_plugin.cpp\n+++ b/editor/plugins/script_editor_plugin.cpp\n@@ -1170,11 +1170,10 @@ void ScriptEditor::_live_auto_reload_running_scripts() {\n bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \tdisk_changed_list->clear();\n \tTreeItem *r = disk_changed_list->create_item();\n-\tdisk_changed_list->set_hide_root(true);\n \n \tbool need_ask = false;\n \tbool need_reload = false;\n-\tbool use_autoreload = bool(EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\"));\n+\tbool use_autoreload = EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\");\n \n \tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n \t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n@@ -1188,12 +1187,12 @@ bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \t\t\t\tcontinue; //internal script, who cares\n \t\t\t}\n \n-\t\t\tuint64_t last_date = edited_res->get_last_modified_time();\n-\t\t\tuint64_t date = FileAccess::get_modified_time(edited_res->get_path());\n+\t\t\tuint64_t last_date = se->edited_file_data.last_modified_time;\n+\t\t\tuint64_t date = FileAccess::get_modified_time(se->edited_file_data.path);\n \n \t\t\tif (last_date != date) {\n \t\t\t\tTreeItem *ti = disk_changed_list->create_item(r);\n-\t\t\t\tti->set_text(0, edited_res->get_path().get_file());\n+\t\t\t\tti->set_text(0, se->edited_file_data.path.get_file());\n \n \t\t\t\tif (!use_autoreload || se->is_unsaved()) {\n \t\t\t\t\tneed_ask = true;\n@@ -2231,11 +2230,6 @@ void ScriptEditor::_update_script_names() {\n \t\t\tRef<Texture2D> icon = se->get_theme_icon();\n \t\t\tString path = se->get_edited_resource()->get_path();\n \t\t\tbool saved = !path.is_empty();\n-\t\t\tif (saved) {\n-\t\t\t\t// The script might be deleted, moved, or renamed, so make sure\n-\t\t\t\t// to update original path to previously edited resource.\n-\t\t\t\tse->set_meta(\"_edit_res_path\", path);\n-\t\t\t}\n \t\t\tString name = se->get_name();\n \t\t\tRef<Script> scr = se->get_edited_resource();\n \n@@ -2633,7 +2627,8 @@ bool ScriptEditor::edit(const Ref<Resource> &p_resource, int p_line, int p_col,\n \n \t// If we delete a script within the filesystem, the original resource path\n \t// is lost, so keep it as metadata to figure out the exact tab to delete.\n-\tse->set_meta(\"_edit_res_path\", p_resource->get_path());\n+\tse->edited_file_data.path = p_resource->get_path();\n+\tse->edited_file_data.last_modified_time = FileAccess::get_modified_time(p_resource->get_path());\n \tif (se->get_edit_menu()) {\n \t\tse->get_edit_menu()->hide();\n \t\tmenu_hb->add_child(se->get_edit_menu());\n@@ -3042,6 +3037,15 @@ void ScriptEditor::_files_moved(const String &p_old_file, const String &p_new_fi\n \tif (!script_editor_cache->has_section(p_old_file)) {\n \t\treturn;\n \t}\n+\n+\tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n+\t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n+\t\tif (se && se->edited_file_data.path == p_old_file) {\n+\t\t\tse->edited_file_data.path = p_new_file;\n+\t\t\tbreak;\n+\t\t}\n+\t}\n+\n \tVariant state = script_editor_cache->get_value(p_old_file, \"state\");\n \tscript_editor_cache->erase_section(p_old_file);\n \tscript_editor_cache->set_value(p_new_file, \"state\", state);\n@@ -3064,7 +3068,7 @@ void ScriptEditor::_file_removed(const String &p_removed_file) {\n \t\tif (!se) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (se->get_meta(\"_edit_res_path\") == p_removed_file) {\n+\t\tif (se->edited_file_data.path == p_removed_file) {\n \t\t\t// The script is deleted with no undo, so just close the tab.\n \t\t\t_close_tab(i, false, false);\n \t\t}\n@@ -4414,9 +4418,10 @@ ScriptEditor::ScriptEditor(WindowWrapper *p_wrapper) {\n \t\tvbc->add_child(files_are_newer_label);\n \n \t\tdisk_changed_list = memnew(Tree);\n-\t\tvbc->add_child(disk_changed_list);\n+\t\tdisk_changed_list->set_hide_root(true);\n \t\tdisk_changed_list->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \t\tdisk_changed_list->set_v_size_flags(SIZE_EXPAND_FILL);\n+\t\tvbc->add_child(disk_changed_list);\n \n \t\tLabel *what_action_label = memnew(Label);\n \t\twhat_action_label->set_text(TTR(\"What action should be taken?\"));\ndiff --git a/editor/plugins/script_editor_plugin.h b/editor/plugins/script_editor_plugin.h\nindex 892a6155d5b7..50e6cfd91cd6 100644\n--- a/editor/plugins/script_editor_plugin.h\n+++ b/editor/plugins/script_editor_plugin.h\n@@ -173,6 +173,11 @@ class ScriptEditorBase : public VBoxContainer {\n \tstatic void _bind_methods();\n \n public:\n+\tstruct EditedFileData {\n+\t\tString path;\n+\t\tuint64_t last_modified_time = -1;\n+\t} edited_file_data;\n+\n \tvirtual void add_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \tvirtual void set_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \ndiff --git a/editor/plugins/script_text_editor.cpp b/editor/plugins/script_text_editor.cpp\nindex ece9616b69b2..79de2e4cebb5 100644\n--- a/editor/plugins/script_text_editor.cpp\n+++ b/editor/plugins/script_text_editor.cpp\n@@ -456,6 +456,7 @@ void ScriptTextEditor::convert_indent() {\n \n void ScriptTextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void ScriptTextEditor::goto_line(int p_line, int p_column) {\ndiff --git a/editor/plugins/text_editor.cpp b/editor/plugins/text_editor.cpp\nindex ee2d592ed3fd..6af3befe1c41 100644\n--- a/editor/plugins/text_editor.cpp\n+++ b/editor/plugins/text_editor.cpp\n@@ -302,6 +302,7 @@ void TextEditor::convert_indent() {\n \n void TextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void TextEditor::goto_line(int p_line, int p_column) {\n", "instance_id": "godotengine__godot-101616", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: duplicating a script in the Godot editor's FileSystem triggers an erroneous \"modified outside Godot\" dialog under specific conditions (e.g., saving the file or switching focus). It includes the tested versions of Godot, system information, and a reference to a minimal reproduction project, which aids in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (i.e., what should happen when a script is duplicated) or clarify whether the dialog should be suppressed entirely or handled differently. Additionally, edge cases or specific constraints (e.g., behavior with different file types or under different editor configurations) are not mentioned. While the issue is reproducible based on the description and assets provided, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files (`filesystem_dock.cpp`, `script_editor_plugin.cpp`, `script_editor_plugin.h`, `script_text_editor.cpp`, and `text_editor.cpp`) within the Godot editor, indicating a need to understand interactions between the filesystem and script editor components. The changes involve updating resource paths, tracking file modification times, and handling file movement/deletion events, which requires a moderate understanding of Godot's internal architecture, particularly its resource management and editor plugin systems. \n\nSecond, the technical concepts involved include file system operations (e.g., `FileAccess::get_modified_time`), resource caching (`ResourceCache::get_ref`), and editor-specific logic for tracking file states and triggering dialogs. While these are not overly complex for someone familiar with Godot or C++ development, they do require domain-specific knowledge of the engine's internals and careful handling to avoid introducing new bugs.\n\nThird, the problem touches on edge cases, such as ensuring that file path updates and modification time tracking work correctly during duplication, movement, or deletion of scripts. The code changes also modify error handling logic to prevent false positives in the \"modified outside Godot\" dialog, which adds some complexity. However, the changes do not appear to impact the broader system architecture or require advanced algorithms, performance optimizations, or deep system-level knowledge.\n\nOverall, I rate this as 0.55 (medium difficulty) because it requires understanding multiple components of the Godot editor, making non-trivial modifications across several files, and handling specific edge cases related to file operations. It is not a simple bug fix but also not a highly complex refactoring or feature implementation that would warrant a higher difficulty score.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Debugging embedded game does not refocus on continue\n### Tested versions\n\nGodot v4.4.dev (99a8ab795)\n\n### System information\n\nGodot v4.4.dev (99a8ab795) - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Laptop GPU (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 5800H with Radeon Graphics (16 threads)\n\n### Issue description\n\nWhen the game is embedded without the floating window, after hitting a breakpoint in the script editor, when I pressed Continue, the game tab is not refocused and Godot enters a wierd state where the editor is not focused, the game is probably focused but not visible.\n\n### Steps to reproduce\n\n- In the Game Workspace, enabled Embed and disable Floating Window\n- Attach a script and add a breakpoint anywhere\n- Start the game\n- Hit the breakpoint\n- Press Continue\n\nhttps://github.com/user-attachments/assets/fe304f67-773d-4948-9ec7-790e06b28db6\n\n\n### Minimal reproduction project (MRP)\n\n[test-godot-focus-debugging.zip](https://github.com/user-attachments/files/18269775/test-godot-focus-debugging.zip)\n\n", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 9d14e702be41..03c2f2067e9c 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -296,6 +296,7 @@ void EmbeddedProcess::_check_focused_process_id() {\n \t\tfocused_process_id = process_id;\n \t\tif (focused_process_id == current_process_id) {\n \t\t\t// The embedded process got the focus.\n+\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n \t\t\tif (has_focus()) {\n \t\t\t\t// Redraw to updated the focus style.\n \t\t\t\tqueue_redraw();\n@@ -312,6 +313,7 @@ void EmbeddedProcess::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"embedding_completed\"));\n \tADD_SIGNAL(MethodInfo(\"embedding_failed\"));\n \tADD_SIGNAL(MethodInfo(\"embedded_process_updated\"));\n+\tADD_SIGNAL(MethodInfo(\"embedded_process_focused\"));\n }\n \n EmbeddedProcess::EmbeddedProcess() {\ndiff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex f7e58258d425..d611f0a773cf 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -260,6 +260,12 @@ void GameView::_embedded_process_updated() {\n \tgame_size_label->set_text(vformat(\"%dx%d\", game_rect.size.x, game_rect.size.y));\n }\n \n+void GameView::_embedded_process_focused() {\n+\tif (embed_on_play && !window_wrapper->get_window_enabled()) {\n+\t\tEditorNode::get_singleton()->get_editor_main_screen()->select(EditorMainScreen::EDITOR_GAME);\n+\t}\n+}\n+\n void GameView::_project_settings_changed() {\n \t// Update the window size and aspect ratio.\n \t_update_embed_window_size();\n@@ -730,6 +736,7 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tembedded_process->connect(\"embedding_failed\", callable_mp(this, &GameView::_embedding_failed));\n \tembedded_process->connect(\"embedding_completed\", callable_mp(this, &GameView::_embedding_completed));\n \tembedded_process->connect(\"embedded_process_updated\", callable_mp(this, &GameView::_embedded_process_updated));\n+\tembedded_process->connect(\"embedded_process_focused\", callable_mp(this, &GameView::_embedded_process_focused));\n \tembedded_process->set_custom_minimum_size(Size2i(100, 100));\n \n \tstate_label = memnew(Label());\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6568f07b746c..64d679657c33 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -143,6 +143,7 @@ class GameView : public VBoxContainer {\n \tvoid _embedding_completed();\n \tvoid _embedding_failed();\n \tvoid _embedded_process_updated();\n+\tvoid _embedded_process_focused();\n \tvoid _project_settings_changed();\n \n \tvoid _update_ui();\n", "instance_id": "godotengine__godot-100916", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when debugging an embedded game in Godot without a floating window, pressing \"Continue\" after hitting a breakpoint does not refocus the game tab, leading to a weird state where neither the editor nor the game appears focused. The steps to reproduce are provided, along with system information and a minimal reproduction project, which aids in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should the game tab always refocus on \"Continue\"?), nor does it mention potential edge cases or constraints (e.g., behavior with multiple embedded processes or different editor configurations). Additionally, the \"weird state\" is not well-defined, leaving room for interpretation. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively limited, affecting only three files (`embedded_process.cpp`, `game_view_plugin.cpp`, and `game_view_plugin.h`) with a small number of lines changed (adding a signal and handling focus logic). The changes are localized to the embedded process and game view components, without impacting the broader system architecture. Second, the technical concepts involved include understanding Godot's signal system, editor UI interactions, and focus management, which require moderate familiarity with the Godot engine's internals but are not overly complex for someone with experience in game engine development or C++ GUI programming. Third, the problem does not explicitly mention edge cases, but the code changes suggest a straightforward fix without extensive error handling or performance considerations. However, implementing this fix requires understanding the interaction between the embedded process and the editor's main screen, which adds a layer of complexity beyond a simple bug fix. Overall, this problem is of medium difficulty (0.45), as it involves moderate codebase understanding and targeted modifications across a few files, but does not demand deep architectural changes or advanced technical expertise.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Resources saved to file from an imported scene do not save with consistent UIDs\n### Godot version\r\n\r\nv4.0.beta.custom_build [98e0d5995]\r\n\r\n### System information\r\n\r\nFedora 36\r\n\r\n### Issue description\r\n\r\nIf \"save to file\" is enabled for meshes or animations in an imported scene, the saved resources are given a random UID if the file doesn't already exist.\r\nThis is annoying if you've `.gitignore`d these files, which makes sense to do since they're auto-generated from glTF files. For example, I did so for the vehicle meshes in the [Truck Town](https://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town) demo. If you clone this repo right now, opening any of the vehicle scenes gives multiple invalid UID errors because when the mesh `.res` files are generated they don't get the same UIDs.\r\n\r\nI don't know how UIDs work, but I assume the way to fix this would be to remember what UID the resources are saved to in the glTF's `.import` file? That way it would be generated with the same UID every time.\r\n\r\n### Steps to reproduce\r\n\r\n1. Save a mesh or animation resource from a scene to a file using the advanced import options\r\n2. Reference that resource in a scene and save it\r\n3. Delete the resource and reimport the scene to regenerate it\r\n4. Open the scene referencing the resource, notice the invalid UID error\r\n\r\n### Minimal reproduction project\r\n\r\nhttps://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town\n", "patch": "diff --git a/editor/import/3d/resource_importer_scene.cpp b/editor/import/3d/resource_importer_scene.cpp\nindex 81af2e0543aa..211ee77ca197 100644\n--- a/editor/import/3d/resource_importer_scene.cpp\n+++ b/editor/import/3d/resource_importer_scene.cpp\n@@ -1303,9 +1303,9 @@ Node *ResourceImporterScene::_post_fix_animations(Node *p_node, Node *p_root, co\n \t\t\t\tDictionary anim_settings = p_animation_data[name];\n \n \t\t\t\t{\n-\t\t\t\t\tint slices_count = anim_settings[\"slices/amount\"];\n+\t\t\t\t\tint slice_count = anim_settings[\"slices/amount\"];\n \n-\t\t\t\t\tfor (int i = 0; i < slices_count; i++) {\n+\t\t\t\t\tfor (int i = 0; i < slice_count; i++) {\n \t\t\t\t\t\tString slice_name = anim_settings[\"slice_\" + itos(i + 1) + \"/name\"];\n \t\t\t\t\t\tint from_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/start_frame\"];\n \t\t\t\t\t\tint end_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/end_frame\"];\n@@ -1531,8 +1531,26 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n \t\t\t\t\t\t\tif (matdata.has(\"use_external/enabled\") && bool(matdata[\"use_external/enabled\"]) && matdata.has(\"use_external/path\")) {\n \t\t\t\t\t\t\t\tString path = matdata[\"use_external/path\"];\n \t\t\t\t\t\t\t\tRef<Material> external_mat = ResourceLoader::load(path);\n+\t\t\t\t\t\t\t\tif (external_mat.is_null()) {\n+\t\t\t\t\t\t\t\t\tif (matdata.has(\"use_external/fallback_path\")) {\n+\t\t\t\t\t\t\t\t\t\tString fallback_save_path = matdata[\"use_external/fallback_path\"];\n+\t\t\t\t\t\t\t\t\t\tif (!fallback_save_path.is_empty()) {\n+\t\t\t\t\t\t\t\t\t\t\texternal_mat = ResourceLoader::load(fallback_save_path);\n+\t\t\t\t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n+\t\t\t\t\t\t\t\t\t\t\t\tpath = fallback_save_path;\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n \t\t\t\t\t\t\t\t\tm->set_surface_material(i, external_mat);\n+\t\t\t\t\t\t\t\t\tif (!path.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t\t\t\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(path);\n+\t\t\t\t\t\t\t\t\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\t\t\t\t\t\t\t\t\tmatdata[\"use_external/path\"] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\tmatdata[\"use_external/fallback_path\"] = external_mat->get_path();\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n@@ -1784,13 +1802,14 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n }\n \n Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> anim, bool p_save_to_file, const String &p_save_to_path, bool p_keep_custom_tracks) {\n-\tif (!p_save_to_file || !p_save_to_path.is_resource_file()) {\n+\tString res_path = ResourceUID::ensure_path(p_save_to_path);\n+\tif (!p_save_to_file || !res_path.is_resource_file()) {\n \t\treturn anim;\n \t}\n \n-\tif (FileAccess::exists(p_save_to_path) && p_keep_custom_tracks) {\n+\tif (FileAccess::exists(res_path) && p_keep_custom_tracks) {\n \t\t// Copy custom animation tracks from previously imported files.\n-\t\tRef<Animation> old_anim = ResourceLoader::load(p_save_to_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n+\t\tRef<Animation> old_anim = ResourceLoader::load(res_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n \t\tif (old_anim.is_valid()) {\n \t\t\tfor (int i = 0; i < old_anim->get_track_count(); i++) {\n \t\t\t\tif (!old_anim->track_is_imported(i)) {\n@@ -1801,16 +1820,21 @@ Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> ani\n \t\t}\n \t}\n \n-\tif (ResourceCache::has(p_save_to_path)) {\n-\t\tRef<Animation> old_anim = ResourceCache::get_ref(p_save_to_path);\n+\tif (ResourceCache::has(res_path)) {\n+\t\tRef<Animation> old_anim = ResourceCache::get_ref(res_path);\n \t\tif (old_anim.is_valid()) {\n \t\t\told_anim->copy_from(anim);\n \t\t\tanim = old_anim;\n \t\t}\n \t}\n-\tanim->set_path(p_save_to_path, true); // Set path to save externally.\n-\tError err = ResourceSaver::save(anim, p_save_to_path, ResourceSaver::FLAG_CHANGE_PATH);\n-\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + p_save_to_path);\n+\tanim->set_path(res_path, true); // Set path to save externally.\n+\tError err = ResourceSaver::save(anim, res_path, ResourceSaver::FLAG_CHANGE_PATH);\n+\n+\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + res_path);\n+\tif (p_save_to_path.begins_with(\"uid://\")) {\n+\t\t// slow\n+\t\tResourceSaver::set_uid(res_path, ResourceUID::get_singleton()->text_to_id(p_save_to_path));\n+\t}\n \treturn anim;\n }\n \n@@ -2041,6 +2065,7 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MESH: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/shadow_meshes\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lightmap_uv\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lods\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n@@ -2049,11 +2074,13 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MATERIAL: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"use_external/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/path\", PROPERTY_HINT_FILE, \"*.material,*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t} break;\n \t\tcase INTERNAL_IMPORT_CATEGORY_ANIMATION: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"settings/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/keep_custom_tracks\"), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slices/amount\", PROPERTY_HINT_RANGE, \"0,256,1\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), 0));\n \n@@ -2063,7 +2090,8 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/end_frame\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \".res,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/keep_custom_tracks\"), false));\n \t\t\t}\n \t\t} break;\n@@ -2527,7 +2555,7 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \n \t\t\t\t\tif (bool(mesh_settings.get(\"save_to_file/enabled\", false))) {\n \t\t\t\t\t\tsave_to_file = mesh_settings.get(\"save_to_file/path\", String());\n-\t\t\t\t\t\tif (!save_to_file.is_resource_file()) {\n+\t\t\t\t\t\tif (!ResourceUID::ensure_path(save_to_file).is_resource_file()) {\n \t\t\t\t\t\t\tsave_to_file = \"\";\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n@@ -2581,16 +2609,24 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \t\t\t\tsrc_mesh_node->get_mesh()->optimize_indices();\n \n \t\t\t\tif (!save_to_file.is_empty()) {\n-\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_to_file);\n+\t\t\t\t\tString save_res_path = ResourceUID::ensure_path(save_to_file);\n+\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_res_path);\n \t\t\t\t\tif (existing.is_valid()) {\n \t\t\t\t\t\t//if somehow an existing one is useful, create\n \t\t\t\t\t\texisting->reset_state();\n \t\t\t\t\t}\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh(existing);\n \n-\t\t\t\t\tResourceSaver::save(mesh, save_to_file); //override\n+\t\t\t\t\tError err = ResourceSaver::save(mesh, save_res_path); //override\n+\t\t\t\t\tif (err != OK) {\n+\t\t\t\t\t\tWARN_PRINT(vformat(\"Failed to save mesh %s to '%s'.\", mesh->get_name(), save_res_path));\n+\t\t\t\t\t}\n+\t\t\t\t\tif (err == OK && save_to_file.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t// slow\n+\t\t\t\t\t\tResourceSaver::set_uid(save_res_path, ResourceUID::get_singleton()->text_to_id(save_to_file));\n+\t\t\t\t\t}\n \n-\t\t\t\t\tmesh->set_path(save_to_file, true); //takeover existing, if needed\n+\t\t\t\t\tmesh->set_path(save_res_path, true); //takeover existing, if needed\n \n \t\t\t\t} else {\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh();\n@@ -2868,14 +2904,66 @@ Node *ResourceImporterScene::pre_import(const String &p_source_file, const HashM\n \treturn scene;\n }\n \n-Error ResourceImporterScene::_check_resource_save_paths(const Dictionary &p_data) {\n+static Error convert_path_to_uid(ResourceUID::ID p_source_id, const String &p_hash_str, Dictionary &p_settings, const String &p_path_key, const String &p_fallback_path_key) {\n+\tconst String &raw_save_path = p_settings[p_path_key];\n+\tString save_path = ResourceUID::ensure_path(raw_save_path);\n+\tif (raw_save_path.begins_with(\"uid://\")) {\n+\t\tif (save_path.is_empty() || !DirAccess::exists(save_path.get_base_dir())) {\n+\t\t\tif (p_settings.has(p_fallback_path_key)) {\n+\t\t\t\tString fallback_save_path = p_settings[p_fallback_path_key];\n+\t\t\t\tif (!fallback_save_path.is_empty() && DirAccess::exists(fallback_save_path.get_base_dir())) {\n+\t\t\t\t\tsave_path = fallback_save_path;\n+\t\t\t\t\tResourceUID::get_singleton()->add_id(ResourceUID::get_singleton()->text_to_id(raw_save_path), save_path);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tp_settings[p_fallback_path_key] = save_path;\n+\t\t}\n+\t}\n+\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\tif (!save_path.is_empty() && !raw_save_path.begins_with(\"uid://\")) {\n+\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(save_path);\n+\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t} else {\n+\t\t\tResourceUID::ID save_id = hash64_murmur3_64(p_hash_str.hash64(), p_source_id) & 0x7FFFFFFFFFFFFFFF;\n+\t\t\tif (ResourceUID::get_singleton()->has_id(save_id)) {\n+\t\t\t\tif (save_path != ResourceUID::get_singleton()->get_id_path(save_id)) {\n+\t\t\t\t\t// The user has specified a path which does not match the default UID.\n+\t\t\t\t\tsave_id = ResourceUID::get_singleton()->create_id();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(save_id);\n+\t\t\tResourceUID::get_singleton()->add_id(save_id, save_path);\n+\t\t}\n+\t\tp_settings[p_fallback_path_key] = save_path;\n+\t}\n+\treturn OK;\n+}\n+\n+Error ResourceImporterScene::_check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data) {\n \tArray keys = p_data.keys();\n-\tfor (int i = 0; i < keys.size(); i++) {\n-\t\tconst Dictionary &settings = p_data[keys[i]];\n+\tfor (int di = 0; di < keys.size(); di++) {\n+\t\tDictionary settings = p_data[keys[di]];\n \n \t\tif (bool(settings.get(\"save_to_file/enabled\", false)) && settings.has(\"save_to_file/path\")) {\n-\t\t\tconst String save_path = ResourceUID::ensure_path(settings[\"save_to_file/path\"]);\n-\t\t\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix;\n+\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings, \"save_to_file/path\", \"save_to_file/fallback_path\");\n+\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Resource save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t}\n+\n+\t\tif (settings.has(\"slices/amount\")) {\n+\t\t\tint slice_count = settings[\"slices/amount\"];\n+\t\t\tfor (int si = 0; si < slice_count; si++) {\n+\t\t\t\tif (bool(settings.get(\"slice_\" + itos(si + 1) + \"/save_to_file/enabled\", false)) &&\n+\t\t\t\t\t\tsettings.has(\"slice_\" + itos(si + 1) + \"/save_to_file/path\")) {\n+\t\t\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix + itos(si + 1);\n+\t\t\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings,\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/path\",\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/fallback_path\");\n+\t\t\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Slice save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t\t\t}\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -2940,14 +3028,14 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \t// Check whether any of the meshes or animations have nonexistent save paths\n \t// and if they do, fail the import immediately.\n \tif (subresources.has(\"meshes\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"meshes\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"m\", subresources[\"meshes\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\n \t}\n \n \tif (subresources.has(\"animations\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"animations\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"a\", subresources[\"animations\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\ndiff --git a/editor/import/3d/resource_importer_scene.h b/editor/import/3d/resource_importer_scene.h\nindex af79746a4c34..68c06efbabbc 100644\n--- a/editor/import/3d/resource_importer_scene.h\n+++ b/editor/import/3d/resource_importer_scene.h\n@@ -210,7 +210,7 @@ class ResourceImporterScene : public ResourceImporter {\n \t\tSHAPE_TYPE_AUTOMATIC,\n \t};\n \n-\tstatic Error _check_resource_save_paths(const Dictionary &p_data);\n+\tstatic Error _check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data);\n \tArray _get_skinned_pose_transforms(ImporterMeshInstance3D *p_src_mesh_node);\n \tvoid _replace_owner(Node *p_node, Node *p_scene, Node *p_new_owner);\n \tNode *_generate_meshes(Node *p_node, const Dictionary &p_mesh_data, bool p_generate_lods, bool p_create_shadow_meshes, LightBakeMode p_light_bake_mode, float p_lightmap_texel_size, const Vector<uint8_t> &p_src_lightmap_cache, Vector<Vector<uint8_t>> &r_lightmap_caches);\ndiff --git a/editor/import/3d/scene_import_settings.cpp b/editor/import/3d/scene_import_settings.cpp\nindex 71b010a97026..609835385b1e 100644\n--- a/editor/import/3d/scene_import_settings.cpp\n+++ b/editor/import/3d/scene_import_settings.cpp\n@@ -1585,6 +1585,10 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\tcontinue; //ignore\n \t\t}\n \t\tString path = item->get_text(1);\n+\t\tString uid_path = path;\n+\t\tif (path.begins_with(\"uid://\")) {\n+\t\t\tpath = ResourceUID::uid_to_path(uid_path);\n+\t\t}\n \t\tif (!path.is_resource_file()) {\n \t\t\tcontinue;\n \t\t}\n@@ -1601,9 +1605,11 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\t\tEditorNode::get_singleton()->add_io_error(TTR(\"Can't make material external to file, write error:\") + \"\\n\\t\" + path);\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n+\t\t\t\tuid_path = ResourceUID::path_to_uid(path);\n \n \t\t\t\tmd.settings[\"use_external/enabled\"] = true;\n-\t\t\t\tmd.settings[\"use_external/path\"] = path;\n+\t\t\t\tmd.settings[\"use_external/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"use_external/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_MESH_SAVE_PATHS: {\n@@ -1611,14 +1617,16 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\tMeshData &md = mesh_map[id];\n \n \t\t\t\tmd.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tmd.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tmd.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"save_to_file/fallback_path\"] = path;\n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_ANIMATION_SAVE_PATHS: {\n \t\t\t\tERR_CONTINUE(!animation_map.has(id));\n \t\t\t\tAnimationData &ad = animation_map[id];\n \n \t\t\t\tad.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tad.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tad.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tad.settings[\"save_to_file/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t}\n", "instance_id": "godotengine__godot-100786", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: resources saved from an imported scene in Godot (specifically meshes and animations) are assigned random UIDs when regenerated, leading to invalid UID errors in scenes that reference them. The goal is to ensure consistent UIDs for these resources. The statement includes steps to reproduce the issue and references a minimal reproduction project, which aids in understanding the problem. However, there are minor ambiguities and missing details. For instance, it lacks a clear explanation of how UIDs should be consistently assigned or stored (though a suggestion about using the `.import` file is provided). Additionally, edge cases, such as what happens if the UID system itself fails or if there are conflicts, are not addressed. Constraints or expected behavior in complex scenarios (e.g., multiple imports or manual UID overrides) are also missing. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple functions and files within the Godot engine's resource importer system (`resource_importer_scene.cpp`, `resource_importer_scene.h`, and `scene_import_settings.cpp`). The modifications involve intricate logic for handling UIDs, including generating, converting, and saving them consistently, which requires a deep understanding of Godot's resource management and UID system. Second, the number of technical concepts involved is substantial: familiarity with Godot's internal APIs (e.g., `ResourceUID`, `ResourceSaver`, `ResourceLoader`), file system interactions (`DirAccess`), and dictionary-based settings management is necessary. Additionally, the changes touch on domain-specific knowledge related to 3D asset importing (e.g., meshes, animations, materials) and their serialization. Third, the problem requires handling complex edge cases, such as fallback paths for resources, directory existence checks, and UID conflicts, which are evident in the code changes (e.g., `convert_path_to_uid` function). While the changes do not appear to fundamentally alter the system's architecture, they impact critical functionality in the import pipeline, necessitating careful consideration of side effects. Overall, solving this requires a deep understanding of the codebase and complex modifications, justifying a score of 0.75. It does not reach the \"Very Hard\" range (0.8-1.0) as it does not involve system-level redesign or highly advanced algorithmic challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13\n### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/random.cpp b/src/random.cpp\nindex 5da053f74e4a6..fa3d8ec3f1e07 100644\n--- a/src/random.cpp\n+++ b/src/random.cpp\n@@ -41,9 +41,6 @@\n #ifdef HAVE_SYSCTL_ARND\n #include <sys/sysctl.h>\n #endif\n-#if defined(HAVE_STRONG_GETAUXVAL) && defined(__aarch64__)\n-#include <sys/auxv.h>\n-#endif\n \n namespace {\n \n@@ -189,62 +186,6 @@ uint64_t GetRdSeed() noexcept\n #endif\n }\n \n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-\n-bool g_rndr_supported = false;\n-\n-void InitHardwareRand()\n-{\n-    if (getauxval(AT_HWCAP2) & HWCAP2_RNG) {\n-        g_rndr_supported = true;\n-    }\n-}\n-\n-void ReportHardwareRand()\n-{\n-    // This must be done in a separate function, as InitHardwareRand() may be indirectly called\n-    // from global constructors, before logging is initialized.\n-    if (g_rndr_supported) {\n-        LogPrintf(\"Using RNDR and RNDRRS as additional entropy sources\\n\");\n-    }\n-}\n-\n-/** Read 64 bits of entropy using rndr.\n- *\n- * Must only be called when RNDR is supported.\n- */\n-uint64_t GetRNDR() noexcept\n-{\n-    uint8_t ok = 0;\n-    uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDR--Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_0; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n-        __asm__ volatile(\"yield\");\n-    } while (true);\n-    return r1;\n-}\n-\n-/** Read 64 bits of entropy using rndrrs.\n- *\n- * Must only be called when RNDRRS is supported.\n- */\n-uint64_t GetRNDRRS() noexcept\n-{\n-    uint8_t ok = 0;\n-    uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n-        __asm__ volatile(\"yield\");\n-    } while (true);\n-    return r1;\n-}\n-\n #else\n /* Access to other hardware random number generators could be added here later,\n  * assuming it is sufficiently fast (in the order of a few hundred CPU cycles).\n@@ -263,12 +204,6 @@ void SeedHardwareFast(CSHA512& hasher) noexcept {\n         hasher.Write((const unsigned char*)&out, sizeof(out));\n         return;\n     }\n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n-        uint64_t out = GetRNDR();\n-        hasher.Write((const unsigned char*)&out, sizeof(out));\n-        return;\n-    }\n #endif\n }\n \n@@ -294,14 +229,6 @@ void SeedHardwareSlow(CSHA512& hasher) noexcept {\n         }\n         return;\n     }\n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n-        for (int i = 0; i < 4; ++i) {\n-            uint64_t out = GetRNDRRS();\n-            hasher.Write((const unsigned char*)&out, sizeof(out));\n-        }\n-        return;\n-    }\n #endif\n }\n \n", "instance_id": "bitcoin__bitcoin-32248", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: `GetRandBytes()` hangs on specific Android devices (Samsung Galaxy S25 and OnePlus 13) due to an infinite loop in `GetRNDRRS()`. The goal is evident\u2014ensure `GetRandBytes()` returns entropy without hanging. The steps to reproduce are provided, along with relevant hardware and software details (Android 15, specific processors, and Bitcoin Core commit). However, there are minor ambiguities: the problem statement does not explicitly discuss expected fallback mechanisms or alternative entropy sources if hardware RNG fails, nor does it mention specific constraints or requirements for the fix (e.g., performance expectations or compatibility with other platforms). Additionally, edge cases or broader implications of disabling hardware RNG (as seen in the code changes) are not addressed. Despite these minor gaps, the statement is actionable and provides sufficient context for an experienced developer to understand the issue.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is moderate but impactful: the provided diff removes hardware RNG support for AArch64 (specifically RNDR and RNDRRS) from `random.cpp`, which is a core component of the Bitcoin Core codebase dealing with cryptographic randomness. While the change is localized to a single file, it affects a critical system function (entropy generation), requiring a deep understanding of the implications on security and randomness quality. Second, the technical concepts involved are complex, including low-level hardware interactions (ARM-specific RNG instructions), inline assembly, and cryptographic randomness requirements. Understanding why the hardware RNG fails on specific devices and deciding to disable it entirely demands domain-specific knowledge of Android's hardware abstraction layer and ARM architecture. Third, while the code change itself is a removal rather than an addition, it implicitly requires evaluating fallback mechanisms (e.g., software-based entropy sources) and ensuring they are sufficient for security-critical operations. Finally, potential edge cases and error handling are significant: disabling hardware RNG might introduce performance or security risks on affected devices, and the developer must consider whether other devices or future Android versions might exhibit similar issues. This problem requires a solid grasp of system-level programming and cryptographic principles, justifying a difficulty score of 0.65, leaning toward the higher end of the \"Hard\" range due to the critical nature of randomness in a cryptocurrency context.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Implement synchronized update control sequences\n<!-- \r\n\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\ud83d\udea8\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\n\r\nhttps://gitlab.com/gnachman/iterm2/-/wikis/synchronized-updates-spec\r\n\r\nThe goal of synchronized updates is to avoid showing a half-drawn screen, such as while paging through a document in an editor.\r\n\r\nA new control sequence is proposed that indicates the beginning and end of a update. No new content should be rendered by the terminal emulator until the update ends, at which point any changes made during the update should be applied atomically.\r\n\r\nThe purpose of this sequence is to provide a hint to the terminal emulator about how to draw atomically. If it turns out to be too difficult to do under some particular input, the hint can be safely ignored\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\n\n```[tasklist]\n### Tasks\n```\n\n", "patch": "diff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex 90f6d5936f5..5824bcb2f2a 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -4,8 +4,6 @@\n #include \"precomp.h\"\r\n #include \"renderer.hpp\"\r\n \r\n-#pragma hdrstop\r\n-\r\n using namespace Microsoft::Console::Render;\r\n using namespace Microsoft::Console::Types;\r\n \r\n@@ -90,6 +88,11 @@ IRenderData* Renderer::GetRenderData() const noexcept\n             _pData->UnlockConsole();\r\n         });\r\n \r\n+        if (_isSynchronizingOutput)\r\n+        {\r\n+            _synchronizeWithOutput();\r\n+        }\r\n+\r\n         // Last chance check if anything scrolled without an explicit invalidate notification since the last frame.\r\n         _CheckViewportAndScroll();\r\n \r\n@@ -183,6 +186,71 @@ void Renderer::NotifyPaintFrame() noexcept\n     _thread.NotifyPaint();\r\n }\r\n \r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputBegin() noexcept\r\n+{\r\n+    // Kick the render thread into calling `_synchronizeWithOutput()`.\r\n+    _isSynchronizingOutput = true;\r\n+}\r\n+\r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputEnd() noexcept\r\n+{\r\n+    // Unblock `_synchronizeWithOutput()` from the `WaitOnAddress` call.\r\n+    _isSynchronizingOutput = false;\r\n+    WakeByAddressSingle(&_isSynchronizingOutput);\r\n+\r\n+    // It's crucial to give the render thread at least a chance to gain the lock.\r\n+    // Otherwise, a VT application could continuously spam DECSET 2026 (Synchronized Output) and\r\n+    // essentially drop our renderer to 10 FPS, because `_isSynchronizingOutput` is always true.\r\n+    //\r\n+    // Obviously calling LockConsole/UnlockConsole here is an awful, ugly hack,\r\n+    // since there's no guarantee that this is the same lock as the one the VT parser uses.\r\n+    // But the alternative is Denial-Of-Service of the render thread.\r\n+    //\r\n+    // Note that this causes raw throughput of DECSET 2026 to be comparatively low, but that's fine.\r\n+    // Apps that use DECSET 2026 don't produce that sequence continuously, but rather at a fixed rate.\r\n+    _pData->UnlockConsole();\r\n+    _pData->LockConsole();\r\n+}\r\n+\r\n+void Renderer::_synchronizeWithOutput() noexcept\r\n+{\r\n+    constexpr DWORD timeout = 100;\r\n+\r\n+    UINT64 start = 0;\r\n+    DWORD elapsed = 0;\r\n+    bool wrong = false;\r\n+\r\n+    QueryUnbiasedInterruptTime(&start);\r\n+\r\n+    // Wait for `_isSynchronizingOutput` to be set to false or for a timeout to occur.\r\n+    while (true)\r\n+    {\r\n+        // We can't call a blocking function while holding the console lock, so release it temporarily.\r\n+        _pData->UnlockConsole();\r\n+        const auto ok = WaitOnAddress(&_isSynchronizingOutput, &wrong, sizeof(_isSynchronizingOutput), timeout - elapsed);\r\n+        _pData->LockConsole();\r\n+\r\n+        if (!ok || !_isSynchronizingOutput)\r\n+        {\r\n+            break;\r\n+        }\r\n+\r\n+        UINT64 now;\r\n+        QueryUnbiasedInterruptTime(&now);\r\n+        elapsed = static_cast<DWORD>((now - start) / 10000);\r\n+        if (elapsed >= timeout)\r\n+        {\r\n+            break;\r\n+        }\r\n+    }\r\n+\r\n+    // If a timeout occurred, `_isSynchronizingOutput` may still be true.\r\n+    // Set it to false now to skip calling `_synchronizeWithOutput()` on the next frame.\r\n+    _isSynchronizingOutput = false;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Called when the system has requested we redraw a portion of the console.\r\n // Arguments:\r\ndiff --git a/src/renderer/base/renderer.hpp b/src/renderer/base/renderer.hpp\nindex d5f6be56d18..c8c30457604 100644\n--- a/src/renderer/base/renderer.hpp\n+++ b/src/renderer/base/renderer.hpp\n@@ -35,6 +35,8 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT PaintFrame();\r\n \r\n         void NotifyPaintFrame() noexcept;\r\n+        void SynchronizedOutputBegin() noexcept;\r\n+        void SynchronizedOutputEnd() noexcept;\r\n         void TriggerSystemRedraw(const til::rect* const prcDirtyClient);\r\n         void TriggerRedraw(const Microsoft::Console::Types::Viewport& region);\r\n         void TriggerRedraw(const til::point* const pcoord);\r\n@@ -91,6 +93,7 @@ namespace Microsoft::Console::Render\n \r\n         [[nodiscard]] HRESULT _PaintFrame() noexcept;\r\n         [[nodiscard]] HRESULT _PaintFrameForEngine(_In_ IRenderEngine* const pEngine) noexcept;\r\n+        void _synchronizeWithOutput() noexcept;\r\n         bool _CheckViewportAndScroll();\r\n         [[nodiscard]] HRESULT _PaintBackground(_In_ IRenderEngine* const pEngine);\r\n         void _PaintBufferOutput(_In_ IRenderEngine* const pEngine);\r\n@@ -124,6 +127,7 @@ namespace Microsoft::Console::Render\n         std::function<void()> _pfnBackgroundColorChanged;\r\n         std::function<void()> _pfnFrameColorChanged;\r\n         std::function<void()> _pfnRendererEnteredErrorState;\r\n+        bool _isSynchronizingOutput = false;\r\n         bool _forceUpdateViewport = false;\r\n \r\n         til::point_span _lastSelectionPaintSpan{};\r\ndiff --git a/src/renderer/base/thread.cpp b/src/renderer/base/thread.cpp\nindex 467bef73585..39b7ec60783 100644\n--- a/src/renderer/base/thread.cpp\n+++ b/src/renderer/base/thread.cpp\n@@ -34,7 +34,7 @@ DWORD WINAPI RenderThread::_ThreadProc()\n \r\n         // Between waiting on _hEvent and calling PaintFrame() there should be a minimal delay,\r\n         // so that a key press progresses to a drawing operation as quickly as possible.\r\n-        // As such, we wait for the renderer to complete _before_ waiting on _hEvent.\r\n+        // As such, we wait for the renderer to complete _before_ waiting on `_redraw`.\r\n         renderer->WaitUntilCanRender();\r\n \r\n         _redraw.wait();\r\n@@ -78,6 +78,8 @@ void RenderThread::EnablePainting() noexcept\n     }\r\n }\r\n \r\n+// This function is meant to only be called by `Renderer`. You should use `TriggerTeardown()` instead,\r\n+// even if you plan to call `EnablePainting()` later, because that ensures proper synchronization.\r\n void RenderThread::DisablePainting() noexcept\r\n {\r\n     _enable.ResetEvent();\r\ndiff --git a/src/terminal/adapter/DispatchTypes.hpp b/src/terminal/adapter/DispatchTypes.hpp\nindex f1adb1457c8..b99dd997dde 100644\n--- a/src/terminal/adapter/DispatchTypes.hpp\n+++ b/src/terminal/adapter/DispatchTypes.hpp\n@@ -544,6 +544,7 @@ namespace Microsoft::Console::VirtualTerminal::DispatchTypes\n         ALTERNATE_SCROLL = DECPrivateMode(1007),\r\n         ASB_AlternateScreenBuffer = DECPrivateMode(1049),\r\n         XTERM_BracketedPasteMode = DECPrivateMode(2004),\r\n+        SO_SynchronizedOutput = DECPrivateMode(2026),\r\n         GCM_GraphemeClusterMode = DECPrivateMode(2027),\r\n         W32IM_Win32InputMode = DECPrivateMode(9001),\r\n     };\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 9158b962ab3..c8f4c5eb85e 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1914,6 +1914,19 @@ void AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n     case DispatchTypes::ModeParams::XTERM_BracketedPasteMode:\n         _api.SetSystemMode(ITerminalApi::Mode::BracketedPaste, enable);\n         break;\n+    case DispatchTypes::ModeParams::SO_SynchronizedOutput:\n+        if (_renderer)\n+        {\n+            if (enable)\n+            {\n+                _renderer->SynchronizedOutputBegin();\n+            }\n+            else\n+            {\n+                _renderer->SynchronizedOutputEnd();\n+            }\n+        }\n+        break;\n     case DispatchTypes::ModeParams::GCM_GraphemeClusterMode:\n         break;\n     case DispatchTypes::ModeParams::W32IM_Win32InputMode:\n", "instance_id": "microsoft__terminal-18826", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the goal of implementing synchronized update control sequences to avoid half-drawn screens in a terminal emulator. It provides a reference to a specification (via a GitLab wiki link) and explains the purpose of the control sequence as a hint for atomic rendering. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected input and output formats for the control sequences, nor does it mention specific constraints or edge cases that might arise during implementation (e.g., what happens if the update sequence is interrupted or malformed). Additionally, the statement lacks examples of usage or expected behavior in different scenarios, which would help in fully understanding the requirements. Despite these gaps, the intent and high-level goal are clear, and the provided code changes offer context for the implementation, justifying a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" range (0.6-0.8) due to several factors. First, the scope of code changes involves multiple files (`renderer.cpp`, `renderer.hpp`, `thread.cpp`, `DispatchTypes.hpp`, and `adaptDispatch.cpp`), indicating a need to understand and modify interactions across different components of the terminal emulator codebase, particularly the rendering and VT parsing logic. The changes are not trivial, as they introduce new synchronization mechanisms (e.g., `SynchronizedOutputBegin` and `SynchronizedOutputEnd`) and require handling threading and locking concerns to prevent performance issues like denial-of-service in the render thread, as noted in the code comments. \n\nSecond, the technical concepts involved are moderately complex, including multi-threading (e.g., `WaitOnAddress`, lock management), renderer synchronization, and integration with VT control sequences (e.g., DECSET 2026). Understanding and correctly implementing these concepts requires a solid grasp of C++ threading primitives, terminal emulator architecture, and the specific behavior of control sequences.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes reveal implicit handling of scenarios like timeouts (a 100ms timeout in `_synchronizeWithOutput`) and potential performance bottlenecks (e.g., preventing continuous DECSET 2026 spam from degrading renderer performance). These considerations add to the complexity of ensuring robust error handling and system stability.\n\nFinally, the impact on the system's architecture is moderate but significant, as the synchronization logic directly affects the rendering pipeline, a critical component of the terminal emulator. While not a complete overhaul, the changes require careful integration to avoid introducing bugs or performance regressions. Given these factors, a difficulty score of 0.65 is appropriate, reflecting a challenging task that demands a deep understanding of the codebase and careful handling of concurrency and rendering logic, but not reaching the extreme complexity of system-level or highly domain-specific problems.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "In newTabMenu allow assignment/override of the icon property for the action items\n### Description of the new feature\n\nHi.\n\nOne small cosmetic suggestion. \n\nCurrently, I can define actions->command which I can then select as the action in newTabMenu.\nIf I would like to have an icon (or glyph) for that item displayed in the newTabMenu, icon needs to be defined at the level of actions->command. That will result in icon being visible in the command palette as well, which I'd like to avoid (I don't like it visually to have only one or a few items with the icon in a long list of commands).\n\nWould it be possible to have a possibility to define \"icon\" for newTabMenu action items (\"type\": \"action\"). That would allow assignment of desired icons/glyphs to desired commands only in newTabMenu and not in command palette.\n\nOther option would be to have a property on the actions->command item level that would allow for the icon not to be displayed in the command palette (e.g. iconVisibility to have one of the following values: \"newtabmenu\", \"commandpalette\", \"both\", \"none\").\n\nOne more thing that could work is to allow the whole custom command to be excluded from the command palette.\n\nThank you in advance!\n\n### Proposed technical implementation details\n\n_No response_\n", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex ec903dc5b80..9774c51844c 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -733,6 +733,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The name or GUID of the profile to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\n@@ -804,6 +807,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The ID of the action to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex b3111e9b639..99064fef8bb 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,7 +989,7 @@ namespace winrt::TerminalApp::implementation\n \n                 for (auto&& [profileIndex, remainingProfile] : remainingProfilesEntry.Profiles())\n                 {\n-                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex));\n+                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex, {}));\n                 }\n \n                 break;\n@@ -1003,7 +1003,7 @@ namespace winrt::TerminalApp::implementation\n                     break;\n                 }\n \n-                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex());\n+                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex(), profileEntry.Icon());\n                 items.push_back(profileItem);\n                 break;\n             }\n@@ -1013,7 +1013,7 @@ namespace winrt::TerminalApp::implementation\n                 const auto actionId = actionEntry.ActionId();\n                 if (_settings.ActionMap().GetActionByID(actionId))\n                 {\n-                    auto actionItem = _CreateNewTabFlyoutAction(actionId);\n+                    auto actionItem = _CreateNewTabFlyoutAction(actionId, actionEntry.Icon());\n                     items.push_back(actionItem);\n                 }\n \n@@ -1028,7 +1028,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given profile with the given index.\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex, const winrt::hstring& iconPathOverride)\n     {\n         auto profileMenuItem = WUX::Controls::MenuFlyoutItem{};\n \n@@ -1049,9 +1049,10 @@ namespace winrt::TerminalApp::implementation\n         auto profileName = profile.Name();\n         profileMenuItem.Text(profileName);\n \n-        // If there's an icon set for this profile, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = profile.EvaluatedIcon();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this profile, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? profile.EvaluatedIcon() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\n@@ -1112,7 +1113,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given action\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride)\n     {\n         auto actionMenuItem = WUX::Controls::MenuFlyoutItem{};\n         const auto action{ _settings.ActionMap().GetActionByID(actionId) };\n@@ -1125,9 +1126,10 @@ namespace winrt::TerminalApp::implementation\n \n         actionMenuItem.Text(action.Name());\n \n-        // If there's an icon set for this action, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = action.IconPath();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this action, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? action.IconPath() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 9e5d3029c7f..30627d5b7ee 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -316,8 +316,8 @@ namespace winrt::TerminalApp::implementation\n         void _CreateNewTabFlyout();\n         std::vector<winrt::Windows::UI::Xaml::Controls::MenuFlyoutItemBase> _CreateNewTabFlyoutItems(winrt::Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::NewTabMenuEntry> entries);\n         winrt::Windows::UI::Xaml::Controls::IconElement _CreateNewTabFlyoutIcon(const winrt::hstring& icon);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex, const winrt::hstring& iconPathOverride);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride);\n \n         void _OpenNewTabDropdown();\n         HRESULT _OpenNewTab(const Microsoft::Terminal::Settings::Model::INewContentArgs& newContentArgs);\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\nindex b48207e74e9..6f7773e715c 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ActionIdKey{ \"id\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ActionEntry::ActionEntry() noexcept :\r\n     ActionEntryT<ActionEntry, NewTabMenuEntry>(NewTabMenuEntryType::Action)\r\n@@ -22,6 +23,7 @@ Json::Value ActionEntry::ToJson() const\n     auto json = NewTabMenuEntry::ToJson();\r\n \r\n     JsonUtils::SetValueForKey(json, ActionIdKey, _ActionId);\r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n \r\n     return json;\r\n }\r\n@@ -31,6 +33,7 @@ winrt::com_ptr<NewTabMenuEntry> ActionEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ActionEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ActionIdKey, entry->_ActionId);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.h b/src/cascadia/TerminalSettingsModel/ActionEntry.h\nindex 9c89077828c..711cec13bfc 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.h\n@@ -28,6 +28,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         static com_ptr<NewTabMenuEntry> FromJson(const Json::Value& json);\r\n \r\n         WINRT_PROPERTY(winrt::hstring, ActionId);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n     };\r\n }\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\nindex 84bc3777695..acf1f33f6f4 100644\n--- a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n+++ b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n@@ -33,6 +33,7 @@ namespace Microsoft.Terminal.Settings.Model\n \r\n         Profile Profile;\r\n         Int32 ProfileIndex;\r\n+        String Icon;\r\n     }\r\n \r\n     [default_interface] runtimeclass ActionEntry : NewTabMenuEntry\r\n@@ -40,6 +41,7 @@ namespace Microsoft.Terminal.Settings.Model\n         ActionEntry();\r\n \r\n         String ActionId;\r\n+        String Icon;\r\n     }\r\n \r\n     enum FolderEntryInlining\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\nindex c857eea8678..5f01a293beb 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ProfileKey{ \"profile\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ProfileEntry::ProfileEntry() noexcept :\r\n     ProfileEntry{ winrt::hstring{} }\r\n@@ -46,6 +47,8 @@ Json::Value ProfileEntry::ToJson() const\n         JsonUtils::SetValueForKey(json, ProfileKey, _Profile.Guid());\r\n     }\r\n \r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n+\r\n     return json;\r\n }\r\n \r\n@@ -54,6 +57,7 @@ winrt::com_ptr<NewTabMenuEntry> ProfileEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ProfileEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ProfileKey, entry->_ProfileName);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.h b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\nindex fe0f4573d29..9ea78497f1f 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n@@ -41,6 +41,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n \r\n         WINRT_PROPERTY(Model::Profile, Profile);\r\n         WINRT_PROPERTY(int, ProfileIndex);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n \r\n     private:\r\n         winrt::hstring _ProfileName;\r\n", "instance_id": "microsoft__terminal-18116", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the desired feature: allowing the assignment or override of icons for action items in the `newTabMenu` without affecting their visibility in the command palette. The goal is well-defined, and the user provides multiple potential solutions (e.g., defining icons at the `newTabMenu` level, controlling icon visibility, or excluding commands from the command palette). However, there are minor ambiguities and missing details. For instance, the statement does not explicitly address how the icon override should behave if no custom icon is provided (though the code changes imply a fallback to the default icon). Additionally, there are no examples of input configurations or expected output UI changes, which could help clarify the exact behavior. Edge cases, such as invalid icon paths or conflicts between icon settings, are not mentioned. Despite these minor gaps, the intent and scope of the feature are understandable, especially when paired with the provided code changes.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The changes are relatively localized, affecting a few specific files (`profiles.schema.json`, `TerminalPage.cpp`, `TerminalPage.h`, `ActionEntry.cpp`, `ActionEntry.h`, `ProfileEntry.cpp`, `ProfileEntry.h`, and related IDL files). The modifications involve adding a new `icon` property to the schema and updating the logic in `TerminalPage.cpp` to handle icon overrides for menu items. The changes do not impact the broader system architecture and are mostly additive, requiring updates to data structures and UI rendering logic. The amount of code change is moderate, with clear diffs provided.\n\n2. **Number of Technical Concepts**: Solving this requires understanding C++ (specifically in the context of WinRT and XAML for UI components), JSON schema definitions, and the internal data models of the application (e.g., `ProfileEntry`, `ActionEntry`). The concepts involved are not overly complex for a developer familiar with the codebase\u2014primarily, it involves extending existing structures with a new field and updating rendering logic to prioritize an override value. No advanced algorithms, design patterns, or domain-specific knowledge beyond terminal UI customization are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes handle a basic fallback mechanism (using the default icon if no override is provided). Potential edge cases, such as invalid icon paths or missing icon data, are not addressed in the problem statement or code changes, but they do not appear to significantly increase complexity at this stage. Error handling requirements seem minimal based on the provided diffs.\n\n4. **Overall Complexity**: The task requires understanding the interaction between configuration schemas and UI rendering logic, but it does not involve deep architectural changes or complex debugging. It is a straightforward feature addition that builds on existing patterns in the codebase (e.g., icon rendering for profiles and actions). The primary challenge might be ensuring consistency across different menu entry types, but this is manageable with the provided changes.\n\nGiven these considerations, a score of 0.35 reflects an \"Easy\" task that requires moderate understanding of the codebase and simple modifications across a few files, with minimal complexity in edge case handling or architectural impact.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Add support for the S8C1T/S7C1T escape sequences\n# Description of the new feature/enhancement\r\n\r\nThe `S8C1T` and `S7C1T` commands enable an application to choose whether the terminal should use C1 controls when sending key sequences and query responses. For example, instead of encoding a `CSI` prefix as `ESC` `[`, the terminal would use a single `CSI` codepoint (i.e. `U+009B`).\r\n\r\nBack in the days of the 8-bit hardware terminals, this had the advantage of being slightly more efficient (your sequence introducers would take 1 byte rather than 2). And another bonus was that it made it easy to distinguish an <kbd>Esc</kbd> key (assuming your keyboard had one) from other key sequences that merely started with the `ESC` character.\r\n\r\nHowever, these days you're more likely to be using a UTF-8 encoding, in which case a C1 control character is still going to occupy two bytes, so there is no advantage in terms of sequence length. And the ability to distinguish an <kbd>Esc</kbd> key from other key sequences is somewhat diminished by the modern usage of `ESC` as a prefix for <kbd>Alt</kbd> key combinations.\r\n\r\nIn short, there's probably not much demand for this functionality outside of people wanting to connect to legacy systems, but it would be nice to have just for completeness sake (it's a requirement for VT level 2 conformance).\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nSome of the framework for the key sequence encoding was already added in PR #16511, so that just needs to be hooked up to a new input mode which can be toggled by the `S8C1T` and `S7C1T` escape sequences. We need to do something similar in `AdaptDispatch` for all the query responses, but that's also fairly straightforward.\r\n\r\nHowever, if we want to support 8-bit C1 sequences, as used in legacy systems, we also need a way to switch the input code page from UTF-8 to something that can cleanly pass through 8-bit bytes (like ISO-8859-1). Fortunately we already have a `DOCS` escape sequence which sets the *output* code page to ISO-8859-1, and I think it's reasonable to extend that to set the input code page at the same time.\r\n\r\nThe catch is that this won't work in a WSL shell, because WSL doesn't pay any attention to the input code page. And while it is potentially usable from a Windows shell, the typical use case will involve connecting to a remote system, which means you're going to ned a ssh or telnet client that is 8-bit capable (and I think that rules out the Windows inbox clients).\r\n\r\nThe bottom line is there are a few hoops you need to jump through to get this to work. Given these limitations, is it still worth adding?\n", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..94d2a938a81 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -140,8 +140,10 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetWindowTitle(const std::wstring_view title) override;\r\n     CursorType GetUserDefaultCursorStyle() const noexcept override;\r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n-    void SetConsoleOutputCP(const unsigned int codepage) noexcept override;\r\n-    unsigned int GetConsoleOutputCP() const noexcept override;\r\n+    void SetCodePage(const unsigned int codepage) noexcept override;\r\n+    void ResetCodePage() noexcept override;\r\n+    unsigned int GetOutputCodePage() const noexcept override;\r\n+    unsigned int GetInputCodePage() const noexcept override;\r\n     void CopyToClipboard(wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\n     void SetWorkingDirectory(std::wstring_view uri) override;\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 40ff599e115..e6edec3ee92 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -116,14 +116,25 @@ bool Terminal::ResizeWindow(const til::CoordType width, const til::CoordType hei\n     return false;\r\n }\r\n \r\n-void Terminal::SetConsoleOutputCP(const unsigned int /*codepage*/) noexcept\r\n+void Terminal::SetCodePage(const unsigned int /*codepage*/) noexcept\r\n {\r\n-    // TODO: This will be needed to support 8-bit charsets and DOCS sequences.\r\n+    // Code pages are dealt with in ConHost, so this isn't needed.\r\n }\r\n \r\n-unsigned int Terminal::GetConsoleOutputCP() const noexcept\r\n+void Terminal::ResetCodePage() noexcept\r\n {\r\n-    // TODO: See SetConsoleOutputCP above.\r\n+    // There is nothing to reset, since the code page never changes.\r\n+}\r\n+\r\n+unsigned int Terminal::GetOutputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n+    return CP_UTF8;\r\n+}\r\n+\r\n+unsigned int Terminal::GetInputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n     return CP_UTF8;\r\n }\r\n \r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex f199362f7af..b8109bca718 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -1140,7 +1140,6 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n     {\r\n         // Set new code page\r\n         gci.OutputCP = codepage;\r\n-\r\n         SetConsoleCPInfo(TRUE);\r\n     }\r\n \r\n@@ -1157,13 +1156,36 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n {\r\n     try\r\n     {\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-        return DoSrvSetConsoleOutputCodePage(codepage);\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultOutputCP = codepage;\r\n+        return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n }\r\n \r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage)\r\n+{\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+\r\n+    // Return if it's not known as a valid codepage ID.\r\n+    RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n+\r\n+    // Do nothing if no change.\r\n+    if (gci.CP != codepage)\r\n+    {\r\n+        // Set new code page\r\n+        gci.CP = codepage;\r\n+        SetConsoleCPInfo(FALSE);\r\n+    }\r\n+\r\n+    return S_OK;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Sets the codepage used for translating text when calling A versions of functions affecting the input buffer.\r\n // Arguments:\r\n@@ -1177,19 +1199,10 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n         auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-\r\n-        // Return if it's not known as a valid codepage ID.\r\n-        RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n-\r\n-        // Do nothing if no change.\r\n-        if (gci.CP != codepage)\r\n-        {\r\n-            // Set new code page\r\n-            gci.CP = codepage;\r\n-\r\n-            SetConsoleCPInfo(FALSE);\r\n-        }\r\n-\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultCP = codepage;\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\ndiff --git a/src/host/getset.h b/src/host/getset.h\nindex 4c042813c27..f3030eb6050 100644\n--- a/src/host/getset.h\n+++ b/src/host/getset.h\n@@ -19,3 +19,4 @@ Revision History:\n class SCREEN_INFORMATION;\r\n \r\n [[nodiscard]] HRESULT DoSrvSetConsoleOutputCodePage(const unsigned int codepage);\r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage);\r\ndiff --git a/src/host/output.cpp b/src/host/output.cpp\nindex e57412f5310..729821c841a 100644\n--- a/src/host/output.cpp\n+++ b/src/host/output.cpp\n@@ -35,6 +35,8 @@ using namespace Microsoft::Console::Interactivity;\n     // codepage by console.cpl or shell32. The default codepage is OEMCP.\r\n     gci.CP = gci.GetCodePage();\r\n     gci.OutputCP = gci.GetCodePage();\r\n+    gci.DefaultCP = gci.GetCodePage();\r\n+    gci.DefaultOutputCP = gci.GetCodePage();\r\n \r\n     gci.Flags |= CONSOLE_USE_PRIVATE_FLAGS;\r\n \r\ndiff --git a/src/host/outputStream.cpp b/src/host/outputStream.cpp\nindex d88be99ef33..3fbeb3cafaf 100644\n--- a/src/host/outputStream.cpp\n+++ b/src/host/outputStream.cpp\n@@ -221,27 +221,52 @@ void ConhostInternalGetSet::ShowWindow(bool showOrHide)\n }\r\n \r\n // Routine Description:\r\n-// - Connects the SetConsoleOutputCP API call directly into our Driver Message servicing call inside Conhost.exe\r\n+// - Set the code page used for translating text when calling A versions of I/O functions.\r\n // Arguments:\r\n-// - codepage - the new output codepage of the console.\r\n+// - codepage - the new code page of the console.\r\n // Return Value:\r\n // - <none>\r\n-void ConhostInternalGetSet::SetConsoleOutputCP(const unsigned int codepage)\r\n+void ConhostInternalGetSet::SetCodePage(const unsigned int codepage)\r\n {\r\n-    THROW_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n }\r\n \r\n // Routine Description:\r\n-// - Gets the codepage used for translating text when calling A versions of functions affecting the output buffer.\r\n+// - Reset the code pages to their default values.\r\n // Arguments:\r\n // - <none>\r\n // Return Value:\r\n-// - the outputCP of the console.\r\n-unsigned int ConhostInternalGetSet::GetConsoleOutputCP() const\r\n+// - <none>\r\n+void ConhostInternalGetSet::ResetCodePage()\r\n+{\r\n+    const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(gci.DefaultOutputCP));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(gci.DefaultCP));\r\n+}\r\n+\r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of output functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the output code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetOutputCodePage() const\r\n {\r\n     return ServiceLocator::LocateGlobals().getConsoleInformation().OutputCP;\r\n }\r\n \r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of input functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the input code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetInputCodePage() const\r\n+{\r\n+    return ServiceLocator::LocateGlobals().getConsoleInformation().CP;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Copies the given content to the clipboard.\r\n // Arguments:\r\ndiff --git a/src/host/outputStream.hpp b/src/host/outputStream.hpp\nindex 6b564abbf8d..7b76e5f3d0a 100644\n--- a/src/host/outputStream.hpp\n+++ b/src/host/outputStream.hpp\n@@ -53,8 +53,10 @@ class ConhostInternalGetSet final : public Microsoft::Console::VirtualTerminal::\n \r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override;\r\n-    unsigned int GetConsoleOutputCP() const override;\r\n+    void SetCodePage(const unsigned int codepage) override;\r\n+    void ResetCodePage() override;\r\n+    unsigned int GetOutputCodePage() const override;\r\n+    unsigned int GetInputCodePage() const override;\r\n \r\n     void CopyToClipboard(const wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\ndiff --git a/src/host/server.h b/src/host/server.h\nindex 1e14a94b731..0a0f905777b 100644\n--- a/src/host/server.h\n+++ b/src/host/server.h\n@@ -90,6 +90,9 @@ class CONSOLE_INFORMATION :\n     // the following fields are used for ansi-unicode translation\r\n     UINT CP = 0;\r\n     UINT OutputCP = 0;\r\n+    // the VT RIS sequence uses these default values to reset the code pages\r\n+    UINT DefaultCP = 0;\r\n+    UINT DefaultOutputCP = 0;\r\n \r\n     ULONG CtrlFlags = 0; // indicates outstanding ctrl requests\r\n     ULONG LimitingProcessId = 0;\r\ndiff --git a/src/terminal/adapter/ITermDispatch.hpp b/src/terminal/adapter/ITermDispatch.hpp\nindex 3df5ef30178..8ec9e33bdc0 100644\n--- a/src/terminal/adapter/ITermDispatch.hpp\n+++ b/src/terminal/adapter/ITermDispatch.hpp\n@@ -122,6 +122,7 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual void LockingShiftRight(const VTInt gsetNumber) = 0; // LS1R, LS2R, LS3R\r\n     virtual void SingleShift(const VTInt gsetNumber) = 0; // SS2, SS3\r\n     virtual void AcceptC1Controls(const bool enabled) = 0; // DECAC1\r\n+    virtual void SendC1Controls(const bool enabled) = 0; // S8C1T, S7C1T\r\n     virtual void AnnounceCodeStructure(const VTInt ansiLevel) = 0; // ACS\r\n \r\n     virtual void SoftReset() = 0; // DECSTR\r\ndiff --git a/src/terminal/adapter/ITerminalApi.hpp b/src/terminal/adapter/ITerminalApi.hpp\nindex b874bfb8cd4..532133f9a84 100644\n--- a/src/terminal/adapter/ITerminalApi.hpp\n+++ b/src/terminal/adapter/ITerminalApi.hpp\n@@ -72,8 +72,10 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         virtual void ShowWindow(bool showOrHide) = 0;\r\n \r\n-        virtual void SetConsoleOutputCP(const unsigned int codepage) = 0;\r\n-        virtual unsigned int GetConsoleOutputCP() const = 0;\r\n+        virtual void SetCodePage(const unsigned int codepage) = 0;\r\n+        virtual void ResetCodePage() = 0;\r\n+        virtual unsigned int GetOutputCodePage() const = 0;\r\n+        virtual unsigned int GetInputCodePage() const = 0;\r\n \r\n         virtual void CopyToClipboard(const wil::zwstring_view content) = 0;\r\n         virtual void SetTaskbarProgress(const DispatchTypes::TaskbarState state, const size_t progress) = 0;\r\ndiff --git a/src/terminal/adapter/InteractDispatch.cpp b/src/terminal/adapter/InteractDispatch.cpp\nindex fa1a0826047..a8fc483aee6 100644\n--- a/src/terminal/adapter/InteractDispatch.cpp\n+++ b/src/terminal/adapter/InteractDispatch.cpp\n@@ -62,7 +62,7 @@ void InteractDispatch::WriteString(const std::wstring_view string)\n {\r\n     if (!string.empty())\r\n     {\r\n-        const auto codepage = _api.GetConsoleOutputCP();\r\n+        const auto codepage = _api.GetOutputCodePage();\r\n         InputEventQueue keyEvents;\r\n \r\n         for (const auto& wch : string)\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 3899c7cd84d..9ee93ede8b8 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1243,7 +1243,7 @@ void AdaptDispatch::FillRectangularArea(const VTParameter ch, const VTInt top, c\n     const auto charValue = ch.value_or(0) == 0 ? 32 : ch.value();\n     const auto glChar = (charValue >= 32 && charValue <= 126);\n     const auto grChar = (charValue >= 160 && charValue <= 255);\n-    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetConsoleOutputCP() == CP_UTF8);\n+    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetOutputCodePage() == CP_UTF8);\n     if (glChar || grChar || unicodeChar)\n     {\n         const auto fillChar = _termOutput.TranslateKey(gsl::narrow_cast<wchar_t>(charValue));\n@@ -1377,8 +1377,7 @@ void AdaptDispatch::RequestChecksumRectangularArea(const VTInt id, const VTInt p\n             }\n         }\n     }\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", id, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", id, checksum));\n }\n \n // Routine Description:\n@@ -1484,7 +1483,7 @@ void AdaptDispatch::DeviceAttributes()\n     // 32 = Text macros\n     // 42 = ISO Latin-2 character set\n \n-    _api.ReturnResponse(L\"\\x1b[?61;4;6;7;14;21;22;23;24;28;32;42c\");\n+    _ReturnCsiResponse(L\"?61;4;6;7;14;21;22;23;24;28;32;42c\");\n }\n \n // Routine Description:\n@@ -1496,7 +1495,7 @@ void AdaptDispatch::DeviceAttributes()\n // - <none>\n void AdaptDispatch::SecondaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1b[>0;10;1c\");\n+    _ReturnCsiResponse(L\">0;10;1c\");\n }\n \n // Routine Description:\n@@ -1506,7 +1505,7 @@ void AdaptDispatch::SecondaryDeviceAttributes()\n // - <none>\n void AdaptDispatch::TertiaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1bP!|00000000\\x1b\\\\\");\n+    _ReturnDcsResponse(L\"!|00000000\");\n }\n \n // Routine Description:\n@@ -1544,10 +1543,10 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n     switch (permission)\n     {\n     case DispatchTypes::ReportingPermission::Unsolicited:\n-        _api.ReturnResponse(L\"\\x1b[2;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"2;1;1;128;128;1;0x\");\n         break;\n     case DispatchTypes::ReportingPermission::Solicited:\n-        _api.ReturnResponse(L\"\\x1b[3;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"3;1;1;128;128;1;0x\");\n         break;\n     default:\n         break;\n@@ -1562,7 +1561,7 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n // - <none>\n void AdaptDispatch::_DeviceStatusReport(const wchar_t* parameters) const\n {\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{}n\"), parameters));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}n\"), parameters));\n }\n \n // Routine Description:\n@@ -1598,14 +1597,12 @@ void AdaptDispatch::_CursorPositionReport(const bool extendedReport)\n     {\n         // An extended report also includes the page number.\n         const auto pageNumber = page.Number();\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber));\n     }\n     else\n     {\n         // The standard report only returns the cursor position.\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%d;%dR\", cursorPosition.y, cursorPosition.x);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%d;%dR\", cursorPosition.y, cursorPosition.x));\n     }\n }\n \n@@ -1619,8 +1616,7 @@ void AdaptDispatch::_MacroSpaceReport() const\n {\n     const auto spaceInBytes = _macroBuffer ? _macroBuffer->GetSpaceAvailable() : MacroBuffer::MAX_SPACE;\n     // The available space is measured in blocks of 16 bytes, so we need to divide by 16.\n-    const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%zu*{\", spaceInBytes / 16);\n-    _api.ReturnResponse(response);\n+    _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%zu*{\", spaceInBytes / 16));\n }\n \n // Routine Description:\n@@ -1633,8 +1629,7 @@ void AdaptDispatch::_MacroChecksumReport(const VTParameter id) const\n {\n     const auto requestId = id.value_or(0);\n     const auto checksum = _macroBuffer ? _macroBuffer->CalculateChecksum() : 0;\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", requestId, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", requestId, checksum));\n }\n \n // Routine Description:\n@@ -1732,7 +1727,7 @@ void AdaptDispatch::RequestDisplayedExtent()\n     const auto height = page.Viewport().height();\n     const auto left = page.XPanOffset() + 1;\n     const auto top = page.YPanOffset() + 1;\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n }\n \n // Routine Description:\n@@ -2068,7 +2063,7 @@ void AdaptDispatch::RequestMode(const DispatchTypes::ModeParams param)\n         prefix = L\"?\";\n     }\n \n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\x1b[{}{};{}$y\"), prefix, mode, state));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}{};{}$y\"), prefix, mode, state));\n }\n \n // - DECKPAM, DECKPNM - Sets the keypad input mode to either Application mode or Numeric mode (true, false respectively)\n@@ -2785,22 +2780,15 @@ void AdaptDispatch::_InitTabStopsForWidth(const VTInt width)\n // - codingSystem - The coding system that will be selected.\n void AdaptDispatch::DesignateCodingSystem(const VTID codingSystem)\n {\n-    // If we haven't previously saved the initial code page, do so now.\n-    // This will be used to restore the code page in response to a reset.\n-    if (!_initialCodePage.has_value())\n-    {\n-        _initialCodePage = _api.GetConsoleOutputCP();\n-    }\n-\n     switch (codingSystem)\n     {\n     case DispatchTypes::CodingSystem::ISO2022:\n-        _api.SetConsoleOutputCP(28591);\n+        _api.SetCodePage(28591);\n         AcceptC1Controls(true);\n         _termOutput.EnableGrTranslation(true);\n         break;\n     case DispatchTypes::CodingSystem::UTF8:\n-        _api.SetConsoleOutputCP(CP_UTF8);\n+        _api.SetCodePage(CP_UTF8);\n         AcceptC1Controls(false);\n         _termOutput.EnableGrTranslation(false);\n         break;\n@@ -2871,6 +2859,24 @@ void AdaptDispatch::AcceptC1Controls(const bool enabled)\n     _api.GetStateMachine().SetParserMode(StateMachine::Mode::AcceptC1, enabled);\n }\n \n+//Routine Description:\n+// S8C1T/S7C1T - Enable or disable the sending of C1 controls in key sequences\n+//   and query responses. When this is enabled, C1 controls are sent as a single\n+//   codepoint. When disabled, they're sent as a two character escape sequence.\n+//Arguments:\n+// - enabled - true to send C1 controls, false to send escape sequences.\n+void AdaptDispatch::SendC1Controls(const bool enabled)\n+{\n+    // If this is an attempt to enable C1 controls, the input code page must be\n+    // one of the DOCS choices (UTF-8 or ISO-8859-1), otherwise there's a risk\n+    // that those controls won't have a valid encoding.\n+    const auto codepage = _api.GetInputCodePage();\n+    if (enabled == false || codepage == CP_UTF8 || codepage == 28591)\n+    {\n+        _terminalInput.SetInputMode(TerminalInput::Mode::SendC1, enabled);\n+    }\n+}\n+\n //Routine Description:\n // ACS - Announces the ANSI conformance level for subsequent data exchange.\n //  This requires certain character sets to be mapped into the terminal's\n@@ -3003,13 +3009,11 @@ void AdaptDispatch::HardReset()\n \n     // Completely reset the TerminalOutput state.\n     _termOutput = {};\n-    if (_initialCodePage.has_value())\n-    {\n-        // Restore initial code page if previously changed by a DOCS sequence.\n-        _api.SetConsoleOutputCP(_initialCodePage.value());\n-    }\n-    // Disable parsing of C1 control codes.\n+    // Reset the code page to the default value.\n+    _api.ResetCodePage();\n+    // Disable parsing and sending of C1 control codes.\n     AcceptC1Controls(false);\n+    SendC1Controls(false);\n \n     // Sets the SGR state to normal - this must be done before EraseInDisplay\n     //      to ensure that it clears with the default background color.\n@@ -3276,7 +3280,7 @@ void AdaptDispatch::RequestColorTableEntry(const size_t tableIndex)\n     {\n         const til::color c{ color };\n         // Scale values up to match xterm's 16-bit color report format.\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]4;{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+        _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"4;{};rgb:{:04x}/{:04x}/{:04x}\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n     }\n }\n \n@@ -3321,7 +3325,7 @@ void AdaptDispatch::RequestXtermColorResource(const size_t resource)\n         {\n             const til::color c{ color };\n             // Scale values up to match xterm's 16-bit color report format.\n-            _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+            _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"{};rgb:{:04x}/{:04x}/{:04x}\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n         }\n     }\n }\n@@ -3377,7 +3381,7 @@ void AdaptDispatch::WindowManipulation(const DispatchTypes::WindowManipulationTy\n \n     const auto reportSize = [&](const auto size) {\n         const auto reportType = function - 10;\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{}t\"), reportType, size.height, size.width));\n+        _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{}t\"), reportType, size.height, size.width));\n     };\n \n     switch (function)\n@@ -3844,7 +3848,7 @@ void AdaptDispatch::RequestUserPreferenceCharset()\n {\n     const auto size = _termOutput.GetUserPreferenceCharsetSize();\n     const auto id = _termOutput.GetUserPreferenceCharsetId();\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P{}!u{}\\033\\\\\"), (size == 96 ? 1 : 0), id));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"{}!u{}\"), (size == 96 ? 1 : 0), id));\n }\n \n // Method Description:\n@@ -3976,9 +3980,9 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ s.\n+    // A valid response always starts with 2 $ s.\n     fmt::basic_memory_buffer<wchar_t, TextColor::TABLE_SIZE * 18> response;\n-    response.append(L\"\\033P2$s\"sv);\n+    response.append(L\"2$s\"sv);\n \n     const auto modelNumber = static_cast<int>(colorModel);\n     for (size_t colorNumber = 0; colorNumber < TextColor::TABLE_SIZE; colorNumber++)\n@@ -4003,9 +4007,7 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4108,7 +4110,7 @@ ITermDispatch::StringHandler AdaptDispatch::RequestSetting()\n                 _ReportDECACSetting(VTParameter{ parameter });\n                 break;\n             default:\n-                _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+                _ReturnDcsResponse(L\"0$r\");\n                 break;\n             }\n             return false;\n@@ -4147,10 +4149,10 @@ void AdaptDispatch::_ReportSGRSetting() const\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 1 $ r.\n+    // A valid response always starts with 1 $ r.\n     // Then the '0' parameter is to reset the SGR attributes to the defaults.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P1$r0\"sv);\n+    response.append(L\"1$r0\"sv);\n \n     const auto& attr = _pages.ActivePage().Attributes();\n     const auto ulStyle = attr.GetUnderlineStyle();\n@@ -4202,9 +4204,9 @@ void AdaptDispatch::_ReportSGRSetting() const\n     addColor(40, attr.GetBackground());\n     addColor(50, attr.GetUnderlineColor());\n \n-    // The 'm' indicates this is an SGR response, and ST ends the sequence.\n-    response.append(L\"m\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    // The 'm' indicates this is an SGR response.\n+    response.append(L\"m\"sv);\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4217,10 +4219,9 @@ void AdaptDispatch::_ReportDECSTBMSetting()\n {\n     const auto page = _pages.ActivePage();\n     const auto [marginTop, marginBottom] = _GetVerticalMargins(page, false);\n-    // A valid response always starts with DCS 1 $ r, the 'r' indicates this\n-    // is a DECSTBM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the final 'r' indicates this is a DECSTBM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}r\\033\\\\\"), marginTop + 1, marginBottom + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}r\"), marginTop + 1, marginBottom + 1));\n }\n \n // Method Description:\n@@ -4233,10 +4234,9 @@ void AdaptDispatch::_ReportDECSLRMSetting()\n {\n     const auto pageWidth = _pages.ActivePage().Width();\n     const auto [marginLeft, marginRight] = _GetHorizontalMargins(pageWidth);\n-    // A valid response always starts with DCS 1 $ r, the 's' indicates this\n-    // is a DECSLRM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the 's' indicates this is a DECSLRM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}s\\033\\\\\"), marginLeft + 1, marginRight + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}s\"), marginLeft + 1, marginRight + 1));\n }\n \n // Method Description:\n@@ -4249,26 +4249,26 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n {\n     const auto& cursor = _pages.ActivePage().Cursor();\n     const auto blinking = cursor.IsBlinkingAllowed();\n-    // A valid response always starts with DCS 1 $ r. This is followed by a\n+    // A valid response always starts with 1 $ r. This is followed by a\n     // number from 1 to 6 representing the cursor style. The ' q' indicates\n-    // this is a DECSCUSR response, and ST ends the sequence.\n+    // this is a DECSCUSR response.\n     switch (cursor.GetType())\n     {\n     case CursorType::FullBox:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r1 q\\033\\\\\" : L\"\\033P1$r2 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r1 q\" : L\"1$r2 q\");\n         break;\n     case CursorType::Underscore:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r3 q\\033\\\\\" : L\"\\033P1$r4 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r3 q\" : L\"1$r4 q\");\n         break;\n     case CursorType::VerticalBar:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r5 q\\033\\\\\" : L\"\\033P1$r6 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r5 q\" : L\"1$r6 q\");\n         break;\n     default:\n         // If we have a non-standard style, this is likely because it's the\n         // user's chosen default style, so we report a default value of 0.\n         // That way, if an application later tries to restore the cursor with\n         // the returned value, it should be reset to its original state.\n-        _api.ReturnResponse(L\"\\033P1$r0 q\\033\\\\\");\n+        _ReturnDcsResponse(L\"1$r0 q\");\n         break;\n     }\n }\n@@ -4282,10 +4282,10 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n void AdaptDispatch::_ReportDECSCASetting() const\n {\n     const auto isProtected = _pages.ActivePage().Attributes().IsProtected();\n-    // A valid response always starts with DCS 1 $ r. This is followed by '1' if\n-    // the protected attribute is set, or '0' if not. The '\"q' indicates this is\n-    // a DECSCA response, and ST ends the sequence.\n-    _api.ReturnResponse(isProtected ? L\"\\033P1$r1\\\"q\\033\\\\\" : L\"\\033P1$r0\\\"q\\033\\\\\");\n+    // A valid response always starts with 1 $ r. This is followed by '1' if the\n+    // protected attribute is set, or '0' if not. The '\"q' indicates this is a\n+    // DECSCA response.\n+    _ReturnDcsResponse(isProtected ? L\"1$r1\\\"q\" : L\"1$r0\\\"q\");\n }\n \n // Method Description:\n@@ -4297,10 +4297,10 @@ void AdaptDispatch::_ReportDECSCASetting() const\n void AdaptDispatch::_ReportDECSACESetting() const\n {\n     const auto rectangularExtent = _modes.test(Mode::RectangularChangeExtent);\n-    // A valid response always starts with DCS 1 $ r. This is followed by '2' if\n+    // A valid response always starts with 1 $ r. This is followed by '2' if\n     // the extent is rectangular, or '1' if it's a stream. The '*x' indicates\n-    // this is a DECSACE response, and ST ends the sequence.\n-    _api.ReturnResponse(rectangularExtent ? L\"\\033P1$r2*x\\033\\\\\" : L\"\\033P1$r1*x\\033\\\\\");\n+    // this is a DECSACE response.\n+    _ReturnDcsResponse(rectangularExtent ? L\"1$r2*x\" : L\"1$r1*x\");\n }\n \n // Method Description:\n@@ -4324,12 +4324,11 @@ void AdaptDispatch::_ReportDECACSetting(const VTInt itemNumber) const\n         bgIndex = _renderSettings.GetColorAliasIndex(ColorAlias::FrameBackground);\n         break;\n     default:\n-        _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+        _ReturnDcsResponse(L\"0$r\");\n         return;\n     }\n-    // A valid response always starts with DCS 1 $ r, the ',|' indicates this\n-    // is a DECAC response, and ST ends the sequence.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{};{},|\\033\\\\\"), itemNumber, fgIndex, bgIndex));\n+    // A valid response always starts with 1 $ r and the ',|' indicates this is a DECAC response.\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{};{},|\"), itemNumber, fgIndex, bgIndex));\n }\n \n // Routine Description:\n@@ -4442,9 +4441,9 @@ void AdaptDispatch::_ReportCursorInformation()\n     const auto charset2 = _termOutput.GetCharsetId(2);\n     const auto charset3 = _termOutput.GetCharsetId(3);\n \n-    // A valid response always starts with DCS 1 $ u and ends with ST.\n+    // A valid response always starts with 1 $ u.\n     const auto response = fmt::format(\n-        FMT_COMPILE(L\"\\033P1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\\033\\\\\"),\n+        FMT_COMPILE(L\"1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\"),\n         cursorPosition.y,\n         cursorPosition.x,\n         page.Number(),\n@@ -4458,7 +4457,7 @@ void AdaptDispatch::_ReportCursorInformation()\n         charset1,\n         charset2,\n         charset3);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4623,9 +4622,9 @@ void AdaptDispatch::_ReportTabStops()\n \n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ u.\n+    // A valid response always starts with 2 $ u.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P2$u\"sv);\n+    response.append(L\"2$u\"sv);\n \n     auto need_separator = false;\n     for (auto column = 0; column < width; column++)\n@@ -4638,9 +4637,7 @@ void AdaptDispatch::_ReportTabStops()\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4685,6 +4682,26 @@ ITermDispatch::StringHandler AdaptDispatch::_RestoreTabStops()\n     };\n }\n \n+void AdaptDispatch::_ReturnCsiResponse(const std::wstring_view response) const\n+{\n+    const auto csi = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9B\" : L\"\\x1B[\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}\"), csi, response));\n+}\n+\n+void AdaptDispatch::_ReturnDcsResponse(const std::wstring_view response) const\n+{\n+    const auto dcs = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x90\" : L\"\\x1BP\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), dcs, response, st));\n+}\n+\n+void AdaptDispatch::_ReturnOscResponse(const std::wstring_view response) const\n+{\n+    const auto osc = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9D\" : L\"\\x1B]\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), osc, response, st));\n+}\n+\n // Routine Description:\n // - DECPS - Plays a sequence of musical notes.\n // Arguments:\ndiff --git a/src/terminal/adapter/adaptDispatch.hpp b/src/terminal/adapter/adaptDispatch.hpp\nindex 4fc85ebc92a..161e21d358d 100644\n--- a/src/terminal/adapter/adaptDispatch.hpp\n+++ b/src/terminal/adapter/adaptDispatch.hpp\n@@ -121,6 +121,7 @@ namespace Microsoft::Console::VirtualTerminal\n         void LockingShiftRight(const VTInt gsetNumber) override; // LS1R, LS2R, LS3R\n         void SingleShift(const VTInt gsetNumber) noexcept override; // SS2, SS3\n         void AcceptC1Controls(const bool enabled) override; // DECAC1\n+        void SendC1Controls(const bool enabled) override; // S8C1T, S7C1T\n         void AnnounceCodeStructure(const VTInt ansiLevel) override; // ACS\n         void SoftReset() override; // DECSTR\n         void HardReset() override; // RIS\n@@ -289,6 +290,10 @@ namespace Microsoft::Console::VirtualTerminal\n         void _ReportTabStops();\n         StringHandler _RestoreTabStops();\n \n+        void _ReturnCsiResponse(const std::wstring_view response) const;\n+        void _ReturnDcsResponse(const std::wstring_view response) const;\n+        void _ReturnOscResponse(const std::wstring_view response) const;\n+\n         std::vector<uint8_t> _tabStopColumns;\n         bool _initDefaultTabStops = true;\n \n@@ -302,7 +307,6 @@ namespace Microsoft::Console::VirtualTerminal\n         std::shared_ptr<SixelParser> _sixelParser;\n         std::unique_ptr<FontBuffer> _fontBuffer;\n         std::shared_ptr<MacroBuffer> _macroBuffer;\n-        std::optional<unsigned int> _initialCodePage;\n \n         // We have two instances of the saved cursor state, because we need\n         // one for the main buffer (at index 0), and another for the alt buffer\ndiff --git a/src/terminal/adapter/termDispatch.hpp b/src/terminal/adapter/termDispatch.hpp\nindex bb12dc32880..bd91d38d7e9 100644\n--- a/src/terminal/adapter/termDispatch.hpp\n+++ b/src/terminal/adapter/termDispatch.hpp\n@@ -115,6 +115,7 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     void LockingShiftRight(const VTInt /*gsetNumber*/) override {} // LS1R, LS2R, LS3R\r\n     void SingleShift(const VTInt /*gsetNumber*/) override {} // SS2, SS3\r\n     void AcceptC1Controls(const bool /*enabled*/) override {} // DECAC1\r\n+    void SendC1Controls(const bool /*enabled*/) override {} // S8C1T, S7C1T\r\n     void AnnounceCodeStructure(const VTInt /*ansiLevel*/) override {} // ACS\r\n \r\n     void SoftReset() override {} // DECSTR\r\ndiff --git a/src/terminal/adapter/ut_adapter/adapterTest.cpp b/src/terminal/adapter/ut_adapter/adapterTest.cpp\nindex ab2e08d3b85..5fab90f3d39 100644\n--- a/src/terminal/adapter/ut_adapter/adapterTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/adapterTest.cpp\n@@ -158,17 +158,28 @@ class TestGetSet final : public ITerminalApi\n         return true;\r\n     }\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override\r\n+    void SetCodePage(const unsigned int codepage) override\r\n     {\r\n-        Log::Comment(L\"SetConsoleOutputCP MOCK called...\");\r\n-        THROW_HR_IF(E_FAIL, !_setConsoleOutputCPResult);\r\n-        VERIFY_ARE_EQUAL(_expectedOutputCP, codepage);\r\n+        Log::Comment(L\"SetCodePage MOCK called...\");\r\n+        THROW_HR_IF(E_FAIL, !_setCodePageResult);\r\n+        VERIFY_ARE_EQUAL(_expectedCodePage, codepage);\r\n     }\r\n \r\n-    unsigned int GetConsoleOutputCP() const override\r\n+    void ResetCodePage() override\r\n     {\r\n-        Log::Comment(L\"GetConsoleOutputCP MOCK called...\");\r\n-        return _expectedOutputCP;\r\n+        Log::Comment(L\"ResetCodePage MOCK called...\");\r\n+    }\r\n+\r\n+    unsigned int GetOutputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetOutputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n+    }\r\n+\r\n+    unsigned int GetInputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetInputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n     }\r\n \r\n     void CopyToClipboard(const wil::zwstring_view /*content*/)\r\n@@ -367,7 +378,7 @@ class TestGetSet final : public ITerminalApi\n     til::point _expectedCursorPos;\r\n \r\n     TextAttribute _expectedAttribute = {};\r\n-    unsigned int _expectedOutputCP = 0;\r\n+    unsigned int _expectedCodePage = 0;\r\n     bool _isPty = false;\r\n \r\n     bool _returnResponseResult = false;\r\n@@ -376,8 +387,7 @@ class TestGetSet final : public ITerminalApi\n \r\n     bool _setWindowTitleResult = false;\r\n     std::wstring_view _expectedWindowTitle{};\r\n-    bool _setConsoleOutputCPResult = false;\r\n-    bool _getConsoleOutputCPResult = false;\r\n+    bool _setCodePageResult = false;\r\n     bool _expectedShowWindow = false;\r\n \r\n     std::wstring _expectedMenuJson{};\r\n@@ -3529,15 +3539,15 @@ class AdapterTest\n \r\n         Log::Comment(L\"3. Designate ISO-2022 coding system\");\r\n         // Code page should be set to ISO-8859-1 and C1 parsing enabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = 28591;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = 28591;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::ISO2022);\r\n         VERIFY_IS_TRUE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n \r\n         Log::Comment(L\"4. Designate UTF-8 coding system\");\r\n         // Code page should be set to UTF-8 and C1 parsing disabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = CP_UTF8;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::UTF8);\r\n         VERIFY_IS_FALSE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n     }\r\n@@ -3962,6 +3972,39 @@ class AdapterTest\n         _pDispatch->PagePositionAbsolute(1);\r\n     }\r\n \r\n+    TEST_METHOD(SendC1ControlTest)\r\n+    {\r\n+        const auto S7C1T = L\"\\033 F\";\r\n+        const auto S8C1T = L\"\\033 G\";\r\n+\r\n+        _testGetSet->PrepData();\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n+\r\n+        Log::Comment(L\"Generating reports with C1 control sequences\");\r\n+        _stateMachine->ProcessString(S8C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9b>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x90!|00000000\\x9c\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9d\\x34;0;rgb:0c0c/0c0c/0c0c\\x9c\");\r\n+\r\n+        Log::Comment(L\"Generating reports with 7-bit escape sequence\");\r\n+        _stateMachine->ProcessString(S7C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b[>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1bP!|00000000\\x1b\\\\\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b]4;0;rgb:0c0c/0c0c/0c0c\\x1b\\\\\");\r\n+    }\r\n+\r\n private:\r\n     TerminalInput _terminalInput;\r\n     std::unique_ptr<TestGetSet> _testGetSet;\r\ndiff --git a/src/terminal/adapter/ut_adapter/inputTest.cpp b/src/terminal/adapter/ut_adapter/inputTest.cpp\nindex d3c4c3d0d06..ab893be7724 100644\n--- a/src/terminal/adapter/ut_adapter/inputTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/inputTest.cpp\n@@ -36,6 +36,7 @@ class Microsoft::Console::VirtualTerminal::InputTest\n     TEST_METHOD(CtrlNumTest);\r\n     TEST_METHOD(BackarrowKeyModeTest);\r\n     TEST_METHOD(AutoRepeatModeTest);\r\n+    TEST_METHOD(SendC1ControlTest);\r\n \r\n     wchar_t GetModifierChar(const bool fShift, const bool fAlt, const bool fCtrl)\r\n     {\r\n@@ -790,3 +791,20 @@ void InputTest::AutoRepeatModeTest()\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput(L\"A\"), input.HandleKey(down));\r\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput({}), input.HandleKey(up));\r\n }\r\n+\r\n+void InputTest::SendC1ControlTest()\r\n+{\r\n+    TerminalInput input;\r\n+\r\n+    Log::Comment(L\"Sending keys with C1 control sequences\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, true);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x9bH\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x8fP\"), input, 0, VK_F1);\r\n+\r\n+    Log::Comment(L\"Sending keys with 7-bit escape sequence\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, false);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1b[H\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1bOP\"), input, 0, VK_F1);\r\n+}\r\ndiff --git a/src/terminal/input/terminalInput.cpp b/src/terminal/input/terminalInput.cpp\nindex 7c09ef46155..ac0795bdc41 100644\n--- a/src/terminal/input/terminalInput.cpp\n+++ b/src/terminal/input/terminalInput.cpp\n@@ -53,7 +53,7 @@ void TerminalInput::SetInputMode(const Mode mode, const bool enabled) noexcept\n \r\n     // If we've changed one of the modes that alter the VT input sequences,\r\n     // we'll need to regenerate our keyboard map.\r\n-    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey };\r\n+    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey, Mode::SendC1 };\r\n     if (keyMapModes.test(mode))\r\n     {\r\n         _initKeyboardMap();\r\n@@ -353,6 +353,19 @@ try\n \r\n     _keyMap.clear();\r\n \r\n+    // The CSI and SS3 introducers are C1 control codes, which can either be\r\n+    // sent as a single codepoint, or as a two character escape sequence.\r\n+    if (_inputMode.test(Mode::SendC1))\r\n+    {\r\n+        _csi = L\"\\x9B\";\r\n+        _ss3 = L\"\\x8F\";\r\n+    }\r\n+    else\r\n+    {\r\n+        _csi = L\"\\x1B[\";\r\n+        _ss3 = L\"\\x1BO\";\r\n+    }\r\n+\r\n     // PAUSE doesn't have a VT mapping, but traditionally we've mapped it to ^Z,\r\n     // regardless of modifiers.\r\n     defineKeyWithUnusedModifiers(VK_PAUSE, L\"\\x1A\"s);\r\ndiff --git a/src/terminal/input/terminalInput.hpp b/src/terminal/input/terminalInput.hpp\nindex e8ae53267e2..40488269569 100644\n--- a/src/terminal/input/terminalInput.hpp\n+++ b/src/terminal/input/terminalInput.hpp\n@@ -33,6 +33,7 @@ namespace Microsoft::Console::VirtualTerminal\n             CursorKey,\r\n             BackarrowKey,\r\n             Win32,\r\n+            SendC1,\r\n \r\n             Utf8MouseEncoding,\r\n             SgrMouseEncoding,\r\n@@ -80,10 +81,8 @@ namespace Microsoft::Console::VirtualTerminal\n         til::enumset<Mode> _inputMode{ Mode::Ansi, Mode::AutoRepeat, Mode::AlternateScroll };\r\n         bool _forceDisableWin32InputMode{ false };\r\n \r\n-        // In the future, if we add support for \"8-bit\" input mode, these prefixes\r\n-        // will sometimes be replaced with equivalent C1 control characters.\r\n-        static constexpr auto _csi = L\"\\x1B[\";\r\n-        static constexpr auto _ss3 = L\"\\x1BO\";\r\n+        const wchar_t* _csi = L\"\\x1B[\";\r\n+        const wchar_t* _ss3 = L\"\\x1BO\";\r\n \r\n         void _initKeyboardMap() noexcept;\r\n         DWORD _trackControlKeyState(const KEY_EVENT_RECORD& key);\r\n@@ -108,9 +107,9 @@ namespace Microsoft::Console::VirtualTerminal\n #pragma endregion\r\n \r\n #pragma region MouseInput\r\n-        [[nodiscard]] static OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n \r\n         [[nodiscard]] OutputType _makeAlternateScrollOutput(short delta) const;\r\n \r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.cpp b/src/terminal/parser/OutputStateMachineEngine.cpp\nindex 5339c29bdf9..edb53e100d0 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.cpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.cpp\n@@ -256,6 +256,12 @@ bool OutputStateMachineEngine::ActionEscDispatch(const VTID id)\n     case EscActionCodes::DECAC1_AcceptC1Controls:\r\n         _dispatch->AcceptC1Controls(true);\r\n         break;\r\n+    case EscActionCodes::S7C1T_Send7bitC1Controls:\r\n+        _dispatch->SendC1Controls(false);\r\n+        break;\r\n+    case EscActionCodes::S8C1T_Send8bitC1Controls:\r\n+        _dispatch->SendC1Controls(true);\r\n+        break;\r\n     case EscActionCodes::ACS_AnsiLevel1:\r\n         _dispatch->AnnounceCodeStructure(1);\r\n         break;\r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.hpp b/src/terminal/parser/OutputStateMachineEngine.hpp\nindex ad594c269cd..ab41e066cfa 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.hpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.hpp\n@@ -77,6 +77,8 @@ namespace Microsoft::Console::VirtualTerminal\n             LS2R_LockingShift = VTID(\"}\"),\r\n             LS3R_LockingShift = VTID(\"|\"),\r\n             DECAC1_AcceptC1Controls = VTID(\" 7\"),\r\n+            S7C1T_Send7bitC1Controls = VTID(\" F\"),\r\n+            S8C1T_Send8bitC1Controls = VTID(\" G\"),\r\n             ACS_AnsiLevel1 = VTID(\" L\"),\r\n             ACS_AnsiLevel2 = VTID(\" M\"),\r\n             ACS_AnsiLevel3 = VTID(\" N\"),\r\ndiff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 65e7460e9b8..12954512bdb 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -25,6 +25,9 @@ StateMachine::StateMachine(std::unique_ptr<IStateMachineEngine> engine, const bo\n     _oscString{},\r\n     _cachedSequence{ std::nullopt }\r\n {\r\n+    // The state machine must always accept C1 controls for the input engine,\r\n+    // otherwise it won't work when the ConPTY terminal has S8C1T enabled.\r\n+    _parserMode.set(Mode::AcceptC1, _isEngineForInput);\r\n     _ActionClear();\r\n }\r\n \r\n", "instance_id": "microsoft__terminal-17945", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the goal of adding support for S8C1T and S7C1T escape sequences to enable the terminal to use C1 controls for key sequences and query responses. It provides context about the historical significance and modern relevance of these sequences, as well as some technical implementation details, such as hooking up to existing frameworks and handling input/output code pages. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior for all edge cases (e.g., behavior in unsupported environments like WSL) or provide concrete examples of input/output for the escape sequences. Additionally, while it mentions limitations and potential challenges (e.g., WSL and SSH client compatibility), it leaves the decision of whether to proceed somewhat open-ended, which could lead to uncertainty in prioritization or scope. Overall, the description is valid and clear but lacks comprehensive details on edge cases and specific test scenarios.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple files and modules (e.g., Terminal.hpp, TerminalApi.cpp, adaptDispatch.cpp, input handling, and state machine logic), requiring a deep understanding of the terminal emulator's architecture, particularly how escape sequences, input/output code pages, and C1 control handling interact. The changes impact critical components like input processing and response generation, necessitating careful integration with existing systems. Second, the number of technical concepts involved is substantial, including knowledge of VT escape sequences, C1 control codes, code page management (UTF-8, ISO-8859-1), terminal input/output handling, and state machine parsing. Additionally, the problem requires handling edge cases, such as ensuring compatibility with different environments (WSL, Windows shell) and managing the encoding of control sequences (single-byte vs. two-byte representations). While the problem does not involve advanced algorithms or system-level redesign, the need to modify and test across multiple layers of the codebase, combined with the domain-specific knowledge of terminal emulation standards (e.g., VT level 2 conformance), makes this a challenging task. A score of 0.65 reflects the complexity of understanding and modifying the existing framework while ensuring correctness in a niche area of terminal functionality.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": 0.85, "human_difficulty": -1}
{"problem_statement": "Escape sequences in unit test log comments are being interpreted\n### Windows Terminal version\n\nCommit 9b21b78feea9ff0a0b9ff2c8fa4b4aa5602d3889\n\n### Windows build number\n\n10.0.19045.4780\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Get the latest source (I suspect it needs to be 4c018efd641dd71502e4019078bb6325c68b7f9a or later)\r\n2. Build the project\r\n3. From a cmd shell[^1], run the `VtResize` unit test.\r\n    \r\n    ```\r\n    runut /name:ScreenBufferTests::VtResize\r\n    ````\r\n\r\n[^1]: I'm not sure it _has_ to be a cmd shell, but that's all I ever use.\r\n\n\n### Expected Behavior\n\nYou should see the test log output as usual.\n\n### Actual Behavior\n\nThe output appears to be clamped to a corner of the screen.\r\n\r\n![image](https://github.com/user-attachments/assets/bdcedc1b-98c5-431c-a563-21b7e3458ef3)\r\n\r\nIf you have a look at the source for that test, you'll notice there are escape sequences in several of the log comments. For example, see here:\r\nhttps://github.com/microsoft/terminal/blob/main/src/host/ut_host/ScreenBufferTests.cpp#L1173-L1176\r\n\r\nI'm guessing what's happening is that those escape sequences are now being interpreted, which causes the conhost buffer to be resized, and that ends up screwing up the output.\r\n\r\nThis only started happening very recently, and that test has been around for ages, so I'm assuming it's got something to do with the TAEF upgrade in PR #16595.\r\n\r\n\n", "patch": "diff --git a/src/host/ut_host/ScreenBufferTests.cpp b/src/host/ut_host/ScreenBufferTests.cpp\nindex d1fe5a31962..beaab2c3047 100644\n--- a/src/host/ut_host/ScreenBufferTests.cpp\n+++ b/src/host/ut_host/ScreenBufferTests.cpp\n@@ -1105,7 +1105,7 @@ void ScreenBufferTests::VtResize()\n     auto initialViewWidth = si.GetViewport().Width();\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;30;80t'\"\r\n+        L\"Write '\\\\x1b[8;30;80t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 80 columns\"\r\n         L\" The viewport should be w,h=80,30\"));\r\n \r\n@@ -1127,7 +1127,7 @@ void ScreenBufferTests::VtResize()\n     initialViewWidth = newViewWidth;\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;40;80t'\"\r\n+        L\"Write '\\\\x1b[8;40;80t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 80 columns\"\r\n         L\" The viewport should be w,h=80,40\"));\r\n \r\n@@ -1149,7 +1149,7 @@ void ScreenBufferTests::VtResize()\n     initialViewWidth = newViewWidth;\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;40;90t'\"\r\n+        L\"Write '\\\\x1b[8;40;90t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 90 columns\"\r\n         L\" The viewport should be w,h=90,40\"));\r\n \r\n@@ -1171,7 +1171,7 @@ void ScreenBufferTests::VtResize()\n     initialViewWidth = newViewWidth;\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;12;12t'\"\r\n+        L\"Write '\\\\x1b[8;12;12t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 12 columns\"\r\n         L\" The viewport should be w,h=12,12\"));\r\n \r\n", "instance_id": "microsoft__terminal-17790", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: escape sequences in unit test log comments are being interpreted, leading to unintended resizing of the console host buffer and distorted output in the Windows Terminal. The steps to reproduce are provided, along with expected and actual behavior, which helps in understanding the problem context. Additionally, a specific commit and PR are referenced as potential causes of the issue, which adds useful context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the desired fix or constraints (e.g., whether escape sequences should be disabled entirely or handled differently). It also lacks mention of specific edge cases or environments beyond a cmd shell. While the issue is tied to a specific test (`VtResize`), the broader impact on other tests or components is not discussed. Overall, the statement is valid and clear but misses some finer details that would make it comprehensive.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as very easy (0.15) based on the provided factors. Let's break it down:\n\n1. **Scope and Depth of Code Changes**: The code changes are minimal and localized to a single file (`ScreenBufferTests.cpp`). The diff shows a straightforward modification\u2014adding a backslash to escape the escape sequences in log comments (e.g., changing `\\x1b` to `\\\\x1b`) to prevent their interpretation. This involves only a few lines of code and does not impact the broader architecture or require understanding complex interactions within the codebase. The change is purely cosmetic and does not alter the logic of the test itself.\n\n2. **Number of Technical Concepts**: The solution requires only basic knowledge of string handling in C++ and an understanding of escape sequences in terminal output. No advanced language features, libraries, algorithms, or design patterns are involved. The concept of escaping characters in strings is fundamental and does not pose a significant learning curve, even for junior developers.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not mention specific edge cases beyond the observed behavior in the `VtResize` test. The code change itself does not introduce or modify error handling logic; it simply prevents the unintended interpretation of escape sequences in log output. There are no complex edge cases to consider in the provided solution, as the fix is a direct response to the reported issue.\n\n4. **Overall Complexity**: The task is a simple bug fix that addresses a specific, well-defined issue with a minimal and obvious code change. It does not require deep understanding of the Windows Terminal codebase or its architecture, nor does it involve performance considerations or system-level changes. The reference to a TAEF upgrade as a potential cause might suggest a need for deeper investigation, but the provided fix does not engage with that complexity.\n\nGiven these points, the problem falls into the \"very easy\" category. It requires only basic code modification to fix a display issue in log comments, with no significant technical challenges or broader impact on the system.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Quickly invoking PowerShell menu completion multiple times crashes Terminal\n### Windows Terminal version\n\n49e4eea60f737b46b8aeda505f4693df8a9d44a6\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Enable experimental shell completion menu (`\"experimental.enableShellCompletionMenu\": true`)\r\n2. Quickly invoke shell completion multiple times, so that Terminal tries to parse JSON with completion data at the same time from multiple threads in one of the following ways:\r\n   - Terminal versions from 432dfcc4902d1a8393217a5f529d07e65182a3f8 to 6d0342f0bb31bf245843411c6781d6d5399ff651:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938 \r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times\r\n     4. Press any character key - because of #17204 this will send the completions generated in _c._ at the same time\r\n   - Terminal versions 0b76c51ba10c81ba4213ba98cf88f2abdf91b15e and newer or older than 432dfcc4902d1a8393217a5f529d07e65182a3f8:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938, but instead of\r\n        ```ps\r\n        $result += $completions.CompletionMatches | ConvertTo-Json -Compress\r\n        ```\r\n        append a large JSON string to `$result`. It doesn't have to be a valid shell completion data, but it should be a valid JSON. 7.6M characters is large enough to reproduce the bug on my computer and probably every other PC without trying to be fast.\r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times. Depending on your CPU and the JSON size it may or may not have to be done quickly.\n\n### Expected Behavior\n\nCompletion menu is shown or nothing happens\n\n### Actual Behavior\n\nTerminal crashes or throws an exception or some kind of invalid memory access error, because `JSON::CharReader` in `Command::ParsePowerShellMenuComplete` is `static` and shared between threads:\r\n\r\nhttps://github.com/microsoft/terminal/blob/49e4eea60f737b46b8aeda505f4693df8a9d44a6/src/cascadia/TerminalSettingsModel/Command.cpp#L693\r\n\r\nReproduction in one of the versions affected by #17204:\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/693c214e-dbb2-47af-bb73-3b2a3f3efac9\r\n\r\nReproduction in other Terminal versions and demonstration of a possible fix (no menu is shown, because of the huge JSON, but the Terminal doesn't crash):\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/72dc5cb2-dd77-4f1f-a4dc-722f419a53e5\r\n\r\n\n", "patch": "diff --git a/src/cascadia/TerminalSettingsModel/Command.cpp b/src/cascadia/TerminalSettingsModel/Command.cpp\nindex a32ed4efa79..70f63091a1f 100644\n--- a/src/cascadia/TerminalSettingsModel/Command.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Command.cpp\n@@ -690,7 +690,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         auto data = winrt::to_string(json);\r\n \r\n         std::string errs;\r\n-        static std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n+        std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n         Json::Value root;\r\n         if (!reader->parse(data.data(), data.data() + data.size(), &root, &errs))\r\n         {\r\n", "instance_id": "microsoft__terminal-17221", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash in Windows Terminal caused by concurrent access to a static JSON parser when invoking PowerShell menu completion multiple times. It provides detailed steps to reproduce the issue across different versions of the Terminal, specifies the expected and actual behavior, and even includes visual reproductions and a reference to the problematic code. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss the expected behavior in edge cases (e.g., very large JSON inputs beyond the mentioned 7.6M characters) or constraints on the solution (e.g., performance requirements or thread safety guarantees). Additionally, while the root cause is identified (static `JSON::CharReader`), the statement lacks clarity on whether the fix should prevent concurrent access entirely or handle it gracefully. These minor gaps prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, involving a single line modification in one file (`Command.cpp`). The fix removes the `static` qualifier from the `JSON::CharReader` instance, ensuring each thread gets its own parser instance, thus avoiding concurrent access issues. This change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is trivial, limited to a single variable declaration adjustment.\n\n2. **Number of Technical Concepts**: Solving this requires a basic understanding of thread safety and the implications of `static` variables in a multi-threaded environment, which are fundamental concepts in C++ programming. Familiarity with the JSON parsing library used (`Json::CharReader`) is helpful but not critical, as the fix does not involve deep interaction with the library's internals. No advanced algorithms, design patterns, or domain-specific knowledge are needed.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement mentions large JSON inputs as a factor in reproducing the crash, but the provided fix (removing `static`) inherently addresses this by avoiding shared state. No additional error handling logic is introduced or required in the code change. While there could be edge cases related to performance (e.g., memory overhead of creating multiple parser instances) or very high concurrency, these are not explicitly mentioned in the problem statement or addressed in the fix, keeping the complexity low.\n\n4. **Overall Complexity**: The root cause (static variable in a multi-threaded context) is a common concurrency bug, and the solution is straightforward for anyone with basic experience in multi-threaded programming. The fix does not require deep understanding of the Terminal's codebase or its architecture beyond the specific function in question. There are no significant performance or system-level considerations evident in the problem or solution.\n\nGiven the minimal code change, limited scope, basic technical concepts involved, and lack of complex edge case handling, I assign a difficulty score of 0.30. This reflects an easy problem that requires understanding some code logic (thread safety) and making a simple modification, but does not demand advanced expertise or extensive codebase knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Simplification should recognize and handle UV mirroring seams\nRare case but on some models, simplification lead to UV artefacts : UVs are getting fully streched (same value on both vertices) when many other triangles could have been optimized instead, I suggest to give a lower priority to simplify/remove vertices/faces of the mesh leading to these results.\r\n\r\nIt might also be a bug in the way the uvs get re-assigned.\r\n\r\nThe model used to illustrate this example : \r\nhttps://www.dropbox.com/scl/fi/po761ykdiqdmtbzd9fitf/rhino.glb?rlkey=s6jp06vtr4id0opnv76wwys1p&dl=0\r\n\r\nBefore simplify : \r\n<img width=\"527\" alt=\"Screenshot 2024-07-08 at 16 25 05\" src=\"https://github.com/zeux/meshoptimizer/assets/213351/080e3431-bef9-4f61-811d-c5dbe638cf40\">\r\n\r\nAfter simplify :\r\n<img width=\"536\" alt=\"Screenshot 2024-07-08 at 16 14 54\" src=\"https://github.com/zeux/meshoptimizer/assets/213351/2da68c85-190d-441b-a59b-3789170bed2b\">\n", "patch": "diff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex a3ec5a60a..a61f057c9 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -409,6 +409,9 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t{\n \t\tconst Mesh& mesh = meshes[i];\n \n+\t\tif (mesh.type != cgltf_primitive_type_triangles)\n+\t\t\tcontinue;\n+\n \t\tif (settings.simplify_debug > 0)\n \t\t{\n \t\t\tMesh kinds = {};\ndiff --git a/gltf/mesh.cpp b/gltf/mesh.cpp\nindex ae44322f3..c691b48b7 100644\n--- a/gltf/mesh.cpp\n+++ b/gltf/mesh.cpp\n@@ -762,6 +762,78 @@ static void simplifyAttributes(std::vector<float>& attrs, float* attrw, size_t s\n \t}\n }\n \n+static void simplifyUvSplit(Mesh& mesh, std::vector<unsigned int>& remap)\n+{\n+\tassert(mesh.type == cgltf_primitive_type_triangles);\n+\tassert(!mesh.indices.empty());\n+\n+\tconst Stream* uv = getStream(mesh, cgltf_attribute_type_texcoord);\n+\tif (!uv)\n+\t\treturn;\n+\n+\tsize_t vertex_count = uv->data.size();\n+\n+\tstd::vector<unsigned char> uvsign(mesh.indices.size() / 3);\n+\tstd::vector<unsigned char> flipseam(vertex_count);\n+\n+\tfor (size_t i = 0; i < mesh.indices.size(); i += 3)\n+\t{\n+\t\tunsigned int a = mesh.indices[i + 0];\n+\t\tunsigned int b = mesh.indices[i + 1];\n+\t\tunsigned int c = mesh.indices[i + 2];\n+\n+\t\tconst Attr& va = uv->data[a];\n+\t\tconst Attr& vb = uv->data[b];\n+\t\tconst Attr& vc = uv->data[c];\n+\n+\t\tfloat uvarea = (vb.f[0] - va.f[0]) * (vc.f[1] - va.f[1]) - (vc.f[0] - va.f[0]) * (vb.f[1] - va.f[1]);\n+\t\tunsigned char flag = uvarea > 0 ? 1 : (uvarea < 0 ? 2 : 0);\n+\n+\t\tuvsign[i / 3] = flag;\n+\t\tflipseam[a] |= flag;\n+\t\tflipseam[b] |= flag;\n+\t\tflipseam[c] |= flag;\n+\t}\n+\n+\tstd::vector<unsigned int> split(vertex_count);\n+\tsize_t splits = 0;\n+\n+\tremap.resize(vertex_count);\n+\n+\tfor (size_t i = 0; i < vertex_count; ++i)\n+\t{\n+\t\tremap[i] = unsigned(i);\n+\n+\t\tif (flipseam[i] == 3)\n+\t\t{\n+\t\t\tassert(remap.size() == vertex_count + splits);\n+\t\t\tremap.push_back(unsigned(i));\n+\n+\t\t\tsplit[i] = unsigned(vertex_count + splits);\n+\t\t\tsplits++;\n+\n+\t\t\tfor (size_t k = 0; k < mesh.streams.size(); ++k)\n+\t\t\t\tmesh.streams[k].data.push_back(mesh.streams[k].data[i]);\n+\t\t}\n+\t}\n+\n+\tfor (size_t i = 0; i < mesh.indices.size(); i += 3)\n+\t{\n+\t\tunsigned int a = mesh.indices[i + 0];\n+\t\tunsigned int b = mesh.indices[i + 1];\n+\t\tunsigned int c = mesh.indices[i + 2];\n+\n+\t\tunsigned char sign = uvsign[i / 3];\n+\n+\t\tif (flipseam[a] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 0] = split[a];\n+\t\tif (flipseam[b] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 1] = split[b];\n+\t\tif (flipseam[c] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 2] = split[c];\n+\t}\n+}\n+\n static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attributes, bool aggressive, bool lock_borders, bool debug = false)\n {\n \tenum\n@@ -778,6 +850,10 @@ static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attribut\n \tif (!positions)\n \t\treturn;\n \n+\tstd::vector<unsigned int> uvremap;\n+\tif (attributes)\n+\t\tsimplifyUvSplit(mesh, uvremap);\n+\n \tsize_t vertex_count = mesh.streams[0].data.size();\n \n \tsize_t target_index_count = size_t(double(size_t(mesh.indices.size() / 3)) * threshold) * 3;\n@@ -819,6 +895,9 @@ static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attribut\n \t\tindices.resize(meshopt_simplifySloppy(&indices[0], &mesh.indices[0], mesh.indices.size(), positions->data[0].f, vertex_count, sizeof(Attr), target_index_count, target_error_aggressive));\n \t\tmesh.indices.swap(indices);\n \t}\n+\n+\tif (uvremap.size() && mesh.indices.size() && !debug)\n+\t\tmeshopt_remapIndexBuffer(&mesh.indices[0], &mesh.indices[0], mesh.indices.size(), &uvremap[0]);\n }\n \n static void optimizeMesh(Mesh& mesh, bool compressmore)\n@@ -1048,8 +1127,6 @@ void debugSimplify(const Mesh& source, Mesh& kinds, Mesh& loops, float ratio, fl\n \treindexMesh(mesh, quantize_tbn);\n \tfilterTriangles(mesh);\n \n-\tsize_t vertex_count = mesh.streams[0].data.size();\n-\n \tsimplifyMesh(mesh, ratio, error, attributes, /* aggressive= */ false, /* lock_borders= */ false, /* debug= */ true);\n \n \t// color palette for display\n@@ -1079,6 +1156,8 @@ void debugSimplify(const Mesh& source, Mesh& kinds, Mesh& loops, float ratio, fl\n \t\t}\n \t}\n \n+\tsize_t vertex_count = mesh.streams[0].data.size();\n+\n \t// transform kind/loop data into lines & points\n \tStream colors = {cgltf_attribute_type_color};\n \tcolors.data.resize(vertex_count, kPalette[0]);\n", "instance_id": "zeux__meshoptimizer-807", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: UV mirroring seams causing artifacts during mesh simplification in a 3D model processing tool. It provides a specific example with a model file link and before/after images to illustrate the problem, which helps in understanding the goal. However, there are minor ambiguities and missing details. For instance, the statement does not explicitly define the expected behavior or constraints for handling UV seams (e.g., what constitutes a \"lower priority\" for simplification). Additionally, it vaguely suggests a potential bug in UV reassignment without providing specific hypotheses or test cases to narrow down the root cause. Edge cases beyond the provided model are not mentioned, leaving room for interpretation on how general the solution should be. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes involves multiple files (`gltfpack.cpp` and `mesh.cpp`) and introduces a non-trivial amount of new logic (e.g., the `simplifyUvSplit` function with ~70 lines of code). The changes impact the mesh simplification process, a core component of the system, requiring an understanding of how UV coordinates interact with mesh topology during simplification. Second, the technical concepts involved are moderately complex, including 3D graphics fundamentals (UV mapping, mesh simplification), specific library usage (`meshopt` for optimization), and custom data structures (`Mesh`, `Stream`, `Attr`). Implementing the solution requires calculating UV areas to detect mirroring seams and splitting vertices accordingly, which involves geometric reasoning and careful index remapping. Third, while the problem statement does not explicitly mention edge cases beyond the provided model, the code changes implicitly handle scenarios like triangles with zero UV area and vertices shared across flipped UV orientations, adding moderate complexity to error handling. Finally, the need to integrate with existing optimization routines (`meshopt_simplifySloppy`, `meshopt_remapIndexBuffer`) and ensure compatibility with debug modes suggests a deep understanding of the codebase is necessary. While not at the extreme end of difficulty (e.g., no system-level or distributed challenges), this problem requires significant domain knowledge and careful implementation, justifying a score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "The HTTP server should starts at the end of ProxySQL Admin\nUp to version 2.6.2 , in `ProxySQL_Admin::init()` the HTTP server is started at the very beginning:\r\n\r\nhttps://github.com/sysown/proxysql/blob/v2.6.2/lib/ProxySQL_Admin.cpp#L6384\r\n\r\nIf the Prometheus exporter is immediately accessible, it can attempt to access objects yet not initialized, possibly leading to a crash if the exporter is accessed within a few milliseconds from ProxySQL start.\r\n\r\nWe should probably move the initialization of `AdminHTTPServer` outside of `ProxySQL_Admin::init()` , and only initialize after all the other modules are initialized (therefore should be initialized from `main()`.\n", "patch": "diff --git a/include/proxysql_admin.h b/include/proxysql_admin.h\nindex 6906091cc7..d46933a331 100644\n--- a/include/proxysql_admin.h\n+++ b/include/proxysql_admin.h\n@@ -394,6 +394,8 @@ class ProxySQL_Admin {\n \tvoid public_add_active_users(enum cred_username_type usertype, char *user=NULL) {\n \t\t__add_active_users(usertype, user);\n \t}\n+\t// @brief True if all ProxySQL modules have been already started. End of 'phase3'.\n+\tbool all_modules_started;\n \tProxySQL_Admin();\n \t~ProxySQL_Admin();\n \tSQLite3DB *admindb;\t// in memory\n@@ -416,6 +418,18 @@ class ProxySQL_Admin {\n \t */\n \tbool init(const bootstrap_info_t& bootstrap_info);\n \tvoid init_ldap();\n+\t/** @brief Initializes the HTTP server. For safety should be called after 'phase3'. */\n+\tvoid init_http_server();\n+\t/**\n+\t * @brief Loads the HTTP server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_http_server();\n+\t/**\n+\t * @brief Loads the RESTAPI server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_restapi_server();\n \tbool get_read_only() { return variables.admin_read_only; }\n \tbool set_read_only(bool ro) { variables.admin_read_only=ro; return variables.admin_read_only; }\n \tbool has_variable(const char *name);\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex 17ac811b0c..ae9b3e4502 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -6115,6 +6115,12 @@ void ProxySQL_Admin::init_ldap() {\n \t}\n }\n \n+void ProxySQL_Admin::init_http_server() {\n+\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n+\tAdminHTTPServer->init();\n+\tAdminHTTPServer->print_version();\n+}\n+\n struct boot_srv_info_t {\n \tstring member_id;\n \tstring member_host;\n@@ -6381,10 +6387,6 @@ bool ProxySQL_Admin::init(const bootstrap_info_t& bootstrap_info) {\n \tcpu_timer cpt;\n \n \tAdmin_HTTP_Server = NULL;\n-\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n-\tAdminHTTPServer->init();\n-\tAdminHTTPServer->print_version();\n-\n \tAdminRestApiServer = NULL;\n /*\n \tAdminRestApiServer = new ProxySQL_RESTAPI_Server();\n@@ -7220,6 +7222,167 @@ void ProxySQL_Admin::load_or_update_global_settings(SQLite3DB *db) {\n \t}\n }\n \n+void ProxySQL_Admin::load_restapi_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n+\t\t[this](const httpserver::http_request& request) {\n+\t\t\tauto headers = request_headers(request);\n+\t\t\tauto serial_response = this->serial_exposer(headers);\n+\t\t\tauto http_response = make_response(serial_response);\n+\n+\t\t\treturn http_response;\n+\t\t}\n+\t};\n+\n+\tbool free_restapi_port = false;\n+\n+\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n+\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n+\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n+\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n+\n+\t\tif (restapi_port_free == false) {\n+\t\t\tif (e_port_check == -1) {\n+\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n+\t\t\t} else {\n+\t\t\t\tproxy_error(\n+\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n+\t\t\t\t\tvariables.restapi_port\n+\t\t\t\t);\n+\t\t\t}\n+\t\t}\n+\t};\n+\n+\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n+\t\tif (variables.restapi_enabled) {\n+\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t}\n+\n+\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t);\n+\t\t} else {\n+\t\t\tdelete AdminRestApiServer;\n+\t\t\tAdminRestApiServer = NULL;\n+\t\t}\n+\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n+\t} else {\n+\t\tif (variables.restapi_port != variables.restapi_port_old) {\n+\t\t\tif (AdminRestApiServer) {\n+\t\t\t\tdelete AdminRestApiServer;\n+\t\t\t\tAdminRestApiServer = NULL;\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled) {\n+\t\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t\t);\n+\t\t\t}\n+\t\t\tvariables.restapi_port_old = variables.restapi_port;\n+\t\t}\n+\t}\n+}\n+\n+void ProxySQL_Admin::load_http_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tif (variables.web_enabled != variables.web_enabled_old) {\n+\t\tif (variables.web_enabled) {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tchar *key_pem;\n+\t\t\t\tchar *cert_pem;\n+\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tint sfd = 0;\n+\t\t\t\t\tint reuseaddr = 1;\n+\t\t\t\t\tstruct sockaddr_in tmp_addr;\n+\n+\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n+\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n+\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n+\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n+\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n+\n+\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n+\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n+\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n+\t\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t\t);\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tGloWebInterface->stop();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tvariables.web_enabled_old = variables.web_enabled;\n+\t} else {\n+\t\tif (variables.web_port != variables.web_port_old) {\n+\t\t\tif (variables.web_enabled) {\n+\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t\t\tchar *key_pem;\n+\t\t\t\t\tchar *cert_pem;\n+\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t\t} else {\n+\t\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tvariables.web_port_old = variables.web_port;\n+\t\t}\n+\t}\n+}\n+\n void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \tSQLite3DB *db, bool replace, const string& checksum, const time_t epoch, bool lock\n ) {\n@@ -7308,157 +7471,8 @@ void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \t\t}\n \t\twrunlock();\n \t\t{\n-\t\t\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n-\t\t\t\t[this](const httpserver::http_request& request) {\n-\t\t\t\t\tauto headers = request_headers(request);\n-\t\t\t\t\tauto serial_response = this->serial_exposer(headers);\n-\t\t\t\t\tauto http_response = make_response(serial_response);\n-\n-\t\t\t\t\treturn http_response;\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tbool free_restapi_port = false;\n-\n-\t\t\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n-\t\t\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n-\t\t\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n-\t\t\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n-\n-\t\t\t\tif (restapi_port_free == false) {\n-\t\t\t\t\tif (e_port_check == -1) {\n-\t\t\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\tvariables.restapi_port\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n-\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t}\n-\n-\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t);\n-\t\t\t\t} else {\n-\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t}\n-\t\t\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.restapi_port != variables.restapi_port_old) {\n-\t\t\t\t\tif (AdminRestApiServer) {\n-\t\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.restapi_port_old = variables.restapi_port;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\tif (variables.web_enabled != variables.web_enabled_old) {\n-\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tint sfd = 0;\n-\t\t\t\t\t\t\tint reuseaddr = 1;\n-\t\t\t\t\t\t\tstruct sockaddr_in tmp_addr;\n-\n-\t\t\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n-\t\t\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n-\t\t\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n-\t\t\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n-\t\t\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n-\n-\t\t\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n-\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n-\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t} else {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tGloWebInterface->stop();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tvariables.web_enabled_old = variables.web_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.web_port != variables.web_port_old) {\n-\t\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.web_port_old = variables.web_port;\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\tload_http_server();\n+\t\t\tload_restapi_server();\n \t\t\t// Update the admin variable for 'web_verbosity'\n \t\t\tadmin___web_verbosity = variables.web_verbosity;\n \t\t}\ndiff --git a/lib/ProxySQL_HTTP_Server.cpp b/lib/ProxySQL_HTTP_Server.cpp\nindex ff38885582..d8affaf396 100644\n--- a/lib/ProxySQL_HTTP_Server.cpp\n+++ b/lib/ProxySQL_HTTP_Server.cpp\n@@ -586,7 +586,7 @@ int ProxySQL_HTTP_Server::handler(void *cls, struct MHD_Connection *connection,\n \t\t\tdelete cpu_sqlite;\n \t\t\t\n \t\t\ts.append(\"</body></html>\");\n-\t \t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_PERSISTENT); \n+\t\t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_MUST_COPY);\n   \t\t\tret = MHD_queue_response (connection, MHD_HTTP_OK, response);\n   \t\t\tMHD_destroy_response (response);\n \t\t\treturn ret;\ndiff --git a/src/main.cpp b/src/main.cpp\nindex aaac09822c..cfe5f4ff93 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1145,7 +1145,6 @@ void ProxySQL_Main_init_phase3___start_all() {\n \t\tGloAdmin->init_mysql_servers();\n \t\tGloAdmin->init_proxysql_servers();\n \t\tGloAdmin->load_scheduler_to_runtime();\n-\t\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n #ifdef DEBUG\n \t\tstd::cerr << \"Main phase3 : GloAdmin initialized in \";\n #endif\n@@ -1217,6 +1216,17 @@ void ProxySQL_Main_init_phase3___start_all() {\n \tif (GloMyLdapAuth) {\n \t\tGloAdmin->init_ldap_variables();\n \t}\n+\n+\t// HTTP Server should be initialized after other modules. See #4510\n+\tGloAdmin->init_http_server();\n+\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n+\n+\t// Signal ProxySQL_Admin that all modules have been started\n+\tGloAdmin->all_modules_started = true;\n+\n+\t// Load the config not previously loaded for these modules\n+\tGloAdmin->load_http_server();\n+\tGloAdmin->load_restapi_server();\n }\n \n \n", "instance_id": "sysown__proxysql-4518", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the HTTP server in ProxySQL starts too early in the initialization process, potentially leading to crashes if accessed before other modules are ready. The goal of moving the HTTP server initialization outside of `ProxySQL_Admin::init()` to a later stage in `main()` is explicitly stated, along with a reference to the specific line of code in the GitHub repository. However, there are minor ambiguities and missing details. For instance, the statement does not specify the exact conditions under which the crash occurs (e.g., what specific objects are uninitialized) or provide examples of scenarios where this issue manifests. Additionally, there is no mention of potential edge cases or constraints that might arise from delaying the HTTP server initialization. Despite these minor gaps, the intent and high-level solution are understandable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes is moderate, involving multiple files (`proxysql_admin.h`, `ProxySQL_Admin.cpp`, `ProxySQL_HTTP_Server.cpp`, and `main.cpp`) and requiring a restructuring of initialization logic. The changes include adding new methods (`init_http_server`, `load_http_server`, `load_restapi_server`), introducing a control flag (`all_modules_started`), and relocating significant blocks of code related to HTTP and RESTAPI server initialization. This indicates a need to understand interactions between different parts of the codebase, particularly the initialization phases and dependencies between modules. Second, the technical concepts involved include C++ class design, server initialization (using libraries like MHD for HTTP handling), socket programming for port availability checks, and lifecycle management of server components, which are moderately complex. Third, while the problem statement does not explicitly mention edge cases, the code changes introduce error handling for port availability and conditional logic based on module readiness, suggesting some complexity in ensuring robust behavior. However, the changes do not appear to impact the core architecture significantly or require advanced domain-specific knowledge beyond typical server initialization patterns. Therefore, a score of 0.55 reflects a medium difficulty level, requiring a solid understanding of the codebase and careful implementation across multiple components, but not posing an exceptionally challenging or system-wide refactoring task.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "FirebaseCrashlytics deployment target inconsistency iOS 12 or 13\n### Description\n\nOur iOS application has iOS 12 as minimum deployment target (platform :ios, '12.0' in Podfile).\r\n\r\nIn our Podfile we have:\r\n\r\n`pod 'Firebase/Crashlytics', '~> 11.0'`\r\n\r\nIt fails as in Firebase.podspec Crashlytics subspec has iOS 13\r\n```\r\n  s.subspec 'Crashlytics' do |ss|\r\n    ss.ios.deployment_target = '13.0'\r\n  end\r\n```\r\n\r\nBut if we add to Podfile\r\n`pod 'FirebaseCrashlytics', '~> 11.0'`\r\n\r\nIt works, because in FirebaseCrashlytics.podspec iOS 12 is specified\r\n`ios_deployment_target = '12.0'`\r\n\r\nProbably iOS 12 can be specified in both places?\r\n\r\nThanks\r\n\n\n### Reproducing the issue\n\n_No response_\n\n### Firebase SDK Version\n\n11.1\n\n### Xcode Version\n\n15.4\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\n[!] CocoaPods could not find compatible versions for pod \"Firebase/Crashlytics\":\r\n  In Podfile:\r\n    Firebase/Crashlytics (~> 11.0)\r\n\r\nSpecs satisfying the `Firebase/Crashlytics (~> 11.0)` dependency were found, but they required a higher minimum deployment target.\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n_No response_\n\n### If using CocoaPods, the project's Podfile.lock\n\n_No response_\n", "patch": "diff --git a/Firebase.podspec b/Firebase.podspec\nindex 78a0093eef2..75dd6212b16 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -122,7 +122,7 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.2.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '13.0'\n+    ss.ios.deployment_target = '12.0'\n     ss.osx.deployment_target = '10.15'\n     ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n", "instance_id": "firebase__firebase-ios-sdk-13580", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: there is a discrepancy in the minimum iOS deployment target for Firebase Crashlytics between two pod specifications (`Firebase.podspec` and `FirebaseCrashlytics.podspec`), causing installation failures via CocoaPods when using `Firebase/Crashlytics`. The goal is to resolve this inconsistency by adjusting the deployment target. The statement includes relevant details such as the Podfile configuration, error logs, SDK version, and the specific lines in the podspec causing the issue. However, it lacks clarity on whether changing the deployment target to iOS 12 in `Firebase.podspec` is officially supported by Firebase or if there are potential compatibility issues or side effects to consider. Additionally, there are no explicit instructions or examples for testing the change, and edge cases or alternative solutions (e.g., using a different pod name or version) are not discussed. Thus, while the problem is valid and mostly clear, minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward modification to a single line in a configuration file (`Firebase.podspec`) to change the iOS deployment target from 13.0 to 12.0. The scope of the code change is minimal, affecting only one file and requiring no deep understanding of the broader codebase or system architecture. The technical concepts involved are basic\u2014familiarity with CocoaPods and podspec files, which are standard tools in iOS development. There is no need for complex algorithms, design patterns, or domain-specific knowledge beyond basic iOS dependency management. Edge cases and error handling are not a significant concern here, as the change is a simple configuration adjustment, though one might need to verify compatibility with Firebase's official support for iOS 12. Overall, this task falls into the \"Very Easy\" category (0.0-0.2), as it requires only a basic code modification with minimal risk or complexity. I assign a difficulty score of 0.15 to reflect the simplicity of the task while acknowledging the need for minimal verification after the change.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Firebase 11 Minimum Supported version updates\n### Description\r\n\r\nIn order to address Xcode warnings for no longer supported build targets and increase the ability of Firebase to use modern Swift features, update most of Firebase to a minimum iOS version of 13 and comparable versions for other platforms.\r\n\r\nExceptions to consider:\r\n- Analytics and Crashlytics have historically needed to support older versions longer - proposing bumping to iOS 12, etc.\r\n- AppCheck may have a GoogleSignIn dependency in the future - proposing bumping to iOS 12, etc.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\n11.0\r\n\r\n### Xcode Version\r\n\r\n15.2+\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAll\r\n\r\n### Targeted Platforms\r\n\r\nAll\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/CoreOnly/Tests/FirebasePodTest/Podfile b/CoreOnly/Tests/FirebasePodTest/Podfile\nindex d5c3822537b..5724b18b03a 100644\n--- a/CoreOnly/Tests/FirebasePodTest/Podfile\n+++ b/CoreOnly/Tests/FirebasePodTest/Podfile\n@@ -18,7 +18,6 @@ target 'FirebasePodTest' do\n   pod 'FirebaseDatabase', :path => '../../../'\n   pod 'FirebaseDynamicLinks', :path => '../../../'\n   pod 'FirebaseFirestore', :path => '../../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../../'\n   pod 'FirebaseFunctions', :path => '../../../'\n   pod 'FirebaseInAppMessaging', :path => '../../../'\n   pod 'FirebaseInstallations', :path => '../../../'\ndiff --git a/Firebase.podspec b/Firebase.podspec\nindex bb29fb049db..d464a2205ea 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -22,20 +22,20 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     \"CoreOnly/README.md\"\n   ]\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.cocoapods_version = '>= 1.12.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.default_subspec = 'Core'\n \n   s.subspec 'Core' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.ios.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.osx.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.tvos.dependency 'FirebaseAnalytics', '~> 11.0.0'\n@@ -55,30 +55,30 @@ Simplify your app development, grow your user base, and monetize more effectivel\n         'HEADER_SEARCH_PATHS' => \"$(inherited) ${PODS_ROOT}/Firebase/CoreOnly/Sources\"\n       }\n     end\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Analytics' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithoutAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'FirebaseAnalytics/WithoutAdIdSupport', '~> 11.0.0'\n     ss.dependency 'Firebase/CoreOnly'\n   end\n@@ -87,87 +87,87 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseABTesting', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'AppDistribution' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseAppDistribution', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'AppCheck' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAppCheck', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Auth' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAuth', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Crashlytics' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Database' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseDatabase', '~> 11.0.0'\n     # Standard platforms PLUS watchOS 7.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'DynamicLinks' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseDynamicLinks', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'Firestore' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFirestore', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Functions' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFunctions', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'InAppMessaging' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n     ss.tvos.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Installations' do |ss|\n@@ -179,48 +179,48 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMessaging', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'MLModelDownloader' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMLModelDownloader', '~> 11.0.0-beta'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Performance' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebasePerformance', '~> 11.0.0'\n     ss.tvos.dependency 'FirebasePerformance', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'RemoteConfig' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseRemoteConfig', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Storage' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseStorage', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n end\ndiff --git a/FirebaseABTesting.podspec b/FirebaseABTesting.podspec\nindex e8fe7414e45..6392dae0dc7 100644\n--- a/FirebaseABTesting.podspec\n+++ b/FirebaseABTesting.podspec\n@@ -22,10 +22,10 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -35,7 +35,7 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   base_dir = \"FirebaseABTesting/Sources/\"\n   s.source_files = [\ndiff --git a/FirebaseAnalytics.podspec b/FirebaseAnalytics.podspec\nindex 6467a9ef914..822a18a3b5a 100644\n--- a/FirebaseAnalytics.podspec\n+++ b/FirebaseAnalytics.podspec\n@@ -17,11 +17,11 @@ Pod::Spec.new do |s|\n     }\n \n     s.cocoapods_version = '>= 1.12.0'\n-    s.swift_version     = '5.3'\n+    s.swift_version     = '5.9'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/FirebaseAnalyticsOnDeviceConversion.podspec b/FirebaseAnalyticsOnDeviceConversion.podspec\nindex 2decdc2cac8..c8ccfe444c1 100644\n--- a/FirebaseAnalyticsOnDeviceConversion.podspec\n+++ b/FirebaseAnalyticsOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.static_framework = true\n \n-    s.ios.deployment_target = '10.0'\n+    s.ios.deployment_target = '12.0'\n \n     s.source_files = 'FirebaseAnalyticsOnDeviceConversionWrapper/*'\n end\ndiff --git a/FirebaseAppCheck.podspec b/FirebaseAppCheck.podspec\nindex b698de23452..e04fdfd976b 100644\n--- a/FirebaseAppCheck.podspec\n+++ b/FirebaseAppCheck.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAppCheckInterop.podspec b/FirebaseAppCheckInterop.podspec\nindex d8d372b4206..318feae1b1f 100644\n--- a/FirebaseAppCheckInterop.podspec\n+++ b/FirebaseAppCheckInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAppCheck/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAppCheck/Interop/Public/FirebaseAppCheckInterop/*.h'\ndiff --git a/FirebaseAppDistribution.podspec b/FirebaseAppDistribution.podspec\nindex 50135707816..fdfbd788c3c 100644\n--- a/FirebaseAppDistribution.podspec\n+++ b/FirebaseAppDistribution.podspec\n@@ -15,9 +15,9 @@ iOS SDK for App Distribution for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\nindex 2dc8abf4945..43b93570106 100644\n--- a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n+++ b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n@@ -23,12 +23,8 @@\n \n @implementation FIRAppDistributionUIService\n \n-API_AVAILABLE(ios(12.0))\n ASWebAuthenticationSession *_webAuthenticationVC;\n \n-// TODO: Remove this when the deployment target becomes iOS 12+\n-SFAuthenticationSession *_safariAuthenticationVC;\n-\n - (instancetype)init {\n   self = [super init];\n \n@@ -66,15 +62,8 @@ + (NSError *_Nullable)mapErrorToAppDistributionError:(NSError *_Nullable)error {\n   if (!error) {\n     return nil;\n   }\n-\n-  if (@available(iOS 12.0, *)) {\n-    if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n-  } else {\n-    if ([error code] == SFAuthenticationErrorCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n+  if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n+    return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n   }\n \n   return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationFailure];\n@@ -88,39 +77,24 @@ - (void)appDistributionRegistrationFlow:(NSURL *)URL\n   FIRFADInfoLog(@\"Registration URL: %@\", URL);\n   FIRFADInfoLog(@\"Callback URL: %@\", callbackURL);\n \n-  if (@available(iOS 12.0, *)) {\n-    ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    if (@available(iOS 13.0, *)) {\n-      authenticationVC.presentationContextProvider = self;\n-    }\n-\n-    _webAuthenticationVC = authenticationVC;\n+  ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n+            initWithURL:URL\n+      callbackURLScheme:callbackURL\n+      completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n+        [self resetUIState];\n+        [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n+        NSError *_Nullable appDistributionError =\n+            [[self class] mapErrorToAppDistributionError:error];\n+        completion(appDistributionError);\n+      }];\n \n-    [authenticationVC start];\n-  } else {\n-    _safariAuthenticationVC = [[SFAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[SFAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    [_safariAuthenticationVC start];\n+  if (@available(iOS 13.0, *)) {\n+    authenticationVC.presentationContextProvider = self;\n   }\n+\n+  _webAuthenticationVC = authenticationVC;\n+\n+  [authenticationVC start];\n }\n \n - (void)showUIAlert:(UIAlertController *)alertController {\n@@ -234,13 +208,7 @@ - (void)resetUIState {\n \n   self.registrationFlowCompletion = nil;\n \n-  if (@available(iOS 12.0, *)) {\n-    _webAuthenticationVC = nil;\n-  }\n-  // TODO: Remove this when the deployment target becomes iOS 12+\n-  // `_safariAuthenticationVC` is cleared unconditionally just in case;\n-  // It\u2019s supposed to be assigned only when run on iOS 11.\n-  _safariAuthenticationVC = nil;\n+  _webAuthenticationVC = nil;\n }\n \n - (void)safariViewControllerDidFinish:(SFSafariViewController *)controller {\ndiff --git a/FirebaseAuth.podspec b/FirebaseAuth.podspec\nindex 773fa9e5a21..2ce91b86c03 100644\n--- a/FirebaseAuth.podspec\n+++ b/FirebaseAuth.podspec\n@@ -24,7 +24,7 @@ supports email and password accounts, as well as several 3rd party authenticatio\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAuthInterop.podspec b/FirebaseAuthInterop.podspec\nindex f60eb9aa0be..2765250ac45 100644\n--- a/FirebaseAuthInterop.podspec\n+++ b/FirebaseAuthInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAuth/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAuth/Interop/Public/FirebaseAuthInterop/*.h'\ndiff --git a/FirebaseAuthTestingSupport.podspec b/FirebaseAuthTestingSupport.podspec\nindex f581d15d40e..3cf9b5128b5 100644\n--- a/FirebaseAuthTestingSupport.podspec\n+++ b/FirebaseAuthTestingSupport.podspec\n@@ -18,11 +18,11 @@ Pod::Spec.new do |s|\n   }\n \n   ios_deployment_target = '13.0'\n-  osx_deployment_target = '10.13'\n+  osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -39,7 +39,7 @@ Pod::Spec.new do |s|\n     base_dir + 'Sources/**/*.swift',\n   ]\n \n-  s.dependency 'FirebaseAuth', '~> 10.22'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n \n   s.test_spec 'unit' do |unit_tests|\n     unit_tests.scheme = { :code_coverage => true }\ndiff --git a/FirebaseCombineSwift.podspec b/FirebaseCombineSwift.podspec\nindex 6f5ad6bcfc9..1670e68b9d4 100644\n--- a/FirebaseCombineSwift.podspec\n+++ b/FirebaseCombineSwift.podspec\n@@ -1,6 +1,6 @@\n Pod::Spec.new do |s|\n   s.name             = 'FirebaseCombineSwift'\n-  s.version          = '10.0.0'\n+  s.version          = '11.0.0'\n   s.summary          = 'Swift extensions with Combine support for Firebase'\n \n   s.description      = <<-DESC\n@@ -19,12 +19,12 @@ for internal testing only. It should not be published.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  s.swift_version         = '5.3'\n+  s.swift_version       = '5.9'\n \n   ios_deployment_target = '13.0'\n   osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n-  watchos_deployment_target = '6.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -51,11 +51,11 @@ for internal testing only. It should not be published.\n   s.osx.framework = 'AppKit'\n   s.tvos.framework = 'UIKit'\n \n-  s.dependency 'FirebaseCore', '~> 10.0'\n-  s.dependency 'FirebaseAuth', '~> 10.0'\n-  s.dependency 'FirebaseFunctions', '~> 10.0'\n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n-  s.dependency 'FirebaseStorage', '~> 10.0'\n+  s.dependency 'FirebaseCore', '~> 11.0'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n+  s.dependency 'FirebaseFunctions', '~> 11.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n+  s.dependency 'FirebaseStorage', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'HEADER_SEARCH_PATHS' => '\"${PODS_TARGET_SRCROOT}\"',\n@@ -104,6 +104,6 @@ for internal testing only. It should not be published.\n     int_tests.resources = 'FirebaseStorage/Tests/Integration/Resources/1mb.dat',\n                           'FirebaseStorage/Tests/Integration/Resources/GoogleService-Info.plist',\n                           'FirebaseStorage/Tests/Integration/Resources/HomeImprovement.numbers'\n-    int_tests.dependency 'FirebaseAuth', '~> 10.0'\n+    int_tests.dependency 'FirebaseAuth', '~> 11.0'\n   end\n end\ndiff --git a/FirebaseCore.podspec b/FirebaseCore.podspec\nindex 9364d54bc8d..c740a159fa9 100644\n--- a/FirebaseCore.podspec\n+++ b/FirebaseCore.podspec\n@@ -18,10 +18,10 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -40,7 +40,7 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.public_header_files = 'FirebaseCore/Sources/Public/FirebaseCore/*.h'\n \ndiff --git a/FirebaseCore/CHANGELOG.md b/FirebaseCore/CHANGELOG.md\nindex 33f31986a49..be7014d50b1 100644\n--- a/FirebaseCore/CHANGELOG.md\n+++ b/FirebaseCore/CHANGELOG.md\n@@ -1,3 +1,14 @@\n+# Firebase 11.0.0\n+- [changed] **Breaking change**: Firebase's minimum supported versions have\n+  updated for the following platforms:\n+    - | Platform  | Firebase 11 |\n+      | ------------- | ------------- |\n+      | iOS  | **13.0**  |\n+      | tvOS  | **13.0**  |\n+      | macOS  | **10.15**  |\n+      | watchOS  | 7.0  |\n+  - FirebaseAnalytics and FirebaseCrashlytics also continue to support iOS 12.0.\n+\n # Firebase 10.25.0\n - [changed] Firebase now requires at least Xcode 15.2. See\n   https://developer.apple.com/news/?id=fxu2qp7b for more info.\ndiff --git a/FirebaseCoreExtension.podspec b/FirebaseCoreExtension.podspec\nindex 833ef4e5522..dfeecc3b2b4 100644\n--- a/FirebaseCoreExtension.podspec\n+++ b/FirebaseCoreExtension.podspec\n@@ -20,12 +20,12 @@ Pod::Spec.new do |s|\n     }\n     s.social_media_url = 'https://twitter.com/Firebase'\n \n-    s.swift_version = '5.3'\n+    s.swift_version = '5.9'\n \n-    s.ios.deployment_target = '10.0'\n-    s.osx.deployment_target = '10.13'\n-    s.tvos.deployment_target = '12.0'\n-    s.watchos.deployment_target = '6.0'\n+    s.ios.deployment_target = '12.0'\n+    s.osx.deployment_target = '10.15'\n+    s.tvos.deployment_target = '13.0'\n+    s.watchos.deployment_target = '7.0'\n \n     s.source_files = 'FirebaseCore/Extension/*.[hm]'\n     s.public_header_files = 'FirebaseCore/Extension/*.h'\ndiff --git a/FirebaseCoreInternal.podspec b/FirebaseCoreInternal.podspec\nindex a2dd33a0458..bd2ce688b2d 100644\n--- a/FirebaseCoreInternal.podspec\n+++ b/FirebaseCoreInternal.podspec\n@@ -18,10 +18,10 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -36,7 +36,7 @@ Pod::Spec.new do |s|\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Internal/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.dependency 'GoogleUtilities/NSData+zlib', '~> 8.0'\n \ndiff --git a/FirebaseCrashlytics.podspec b/FirebaseCrashlytics.podspec\nindex 365376a02ee..be080d77522 100644\n--- a/FirebaseCrashlytics.podspec\n+++ b/FirebaseCrashlytics.podspec\n@@ -11,12 +11,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabase.podspec b/FirebaseDatabase.podspec\nindex 71360409d13..6884a7a5539 100644\n--- a/FirebaseDatabase.podspec\n+++ b/FirebaseDatabase.podspec\n@@ -17,12 +17,12 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabaseSwift.podspec b/FirebaseDatabaseSwift.podspec\nindex 3e066ab7a0f..1701905ec67 100644\n--- a/FirebaseDatabaseSwift.podspec\n+++ b/FirebaseDatabaseSwift.podspec\n@@ -16,10 +16,10 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseDynamicLinks.podspec b/FirebaseDynamicLinks.podspec\nindex 08d3bcb940d..ad9606e0b76 100644\n--- a/FirebaseDynamicLinks.podspec\n+++ b/FirebaseDynamicLinks.podspec\n@@ -16,9 +16,9 @@ Firebase Dynamic Links are deep links that enhance user experience and increase\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestore.podspec b/FirebaseFirestore.podspec\nindex bd33677cd4a..8334d81e7e7 100644\n--- a/FirebaseFirestore.podspec\n+++ b/FirebaseFirestore.podspec\n@@ -13,11 +13,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.weak_framework = 'FirebaseFirestoreInternal'\n \ndiff --git a/FirebaseFirestoreInternal.podspec b/FirebaseFirestoreInternal.podspec\nindex bd3694dfda3..5e9288ad6c9 100644\n--- a/FirebaseFirestoreInternal.podspec\n+++ b/FirebaseFirestoreInternal.podspec\n@@ -16,11 +16,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestoreSwift.podspec b/FirebaseFirestoreSwift.podspec\nindex 4582f9f240f..511c8d1bff3 100644\n--- a/FirebaseFirestoreSwift.podspec\n+++ b/FirebaseFirestoreSwift.podspec\n@@ -21,10 +21,10 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseFirestoreTestingSupport.podspec b/FirebaseFirestoreTestingSupport.podspec\nindex c2c13ccb23e..a28ab450c3f 100644\n--- a/FirebaseFirestoreTestingSupport.podspec\n+++ b/FirebaseFirestoreTestingSupport.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -42,7 +42,7 @@ Pod::Spec.new do |s|\n \n   s.public_header_files = base_dir + '**/*.h'\n \n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'GCC_C_LANGUAGE_STANDARD' => 'c99',\ndiff --git a/FirebaseFunctions.podspec b/FirebaseFunctions.podspec\nindex 4383ae29317..2d069da346b 100644\n--- a/FirebaseFunctions.podspec\n+++ b/FirebaseFunctions.podspec\n@@ -16,12 +16,12 @@ Cloud Functions for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version    = '5.3'\n+  s.swift_version    = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -31,8 +31,6 @@ Cloud Functions for Firebase.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n-\n   s.source_files = [\n     'FirebaseFunctions/Sources/**/*.swift',\n   ]\ndiff --git a/FirebaseInAppMessaging.podspec b/FirebaseInAppMessaging.podspec\nindex 557b84d94ca..42eaf9ecb84 100644\n--- a/FirebaseInAppMessaging.podspec\n+++ b/FirebaseInAppMessaging.podspec\n@@ -17,10 +17,10 @@ See more product details at https://firebase.google.com/products/in-app-messagin\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\nindex ad7a95252aa..0e5b1ca8483 100644\n--- a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n+++ b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n@@ -160,15 +160,13 @@ - (void)viewDidLoad {\n   self.view.layer.shadowOpacity = 0.4;\n \n   // Calculate status bar height.\n-  CGFloat statusBarHeight = 0;\n-  if (@available(iOS 13.0, tvOS 13.0, *)) {\n-    UIStatusBarManager *manager =\n-        [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n-\n-    statusBarHeight = manager.statusBarFrame.size.height;\n-  } else {\n-    statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height;\n-  }\n+  // TODO(#13068) : Fix keyWindow deprecation.\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n+  UIStatusBarManager *manager =\n+      [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n+#pragma clang diagnostic pop\n+  CGFloat statusBarHeight = manager.statusBarFrame.size.height;\n \n   // Pin title label below status bar with cushion.\n   [[self.titleLabel.topAnchor constraintEqualToAnchor:self.view.topAnchor\ndiff --git a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\nindex ff1c70c111b..d7eac8d3b1e 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'FiamDisplaySwiftExample' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n end\n \ndiff --git a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\nindex 7597b44e9fc..50db2923845 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'InAppMessaging_Example_iOS' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n \n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n   pod 'FirebaseDynamicLinks',  :path => '../../../..'\ndiff --git a/FirebaseInstallations.podspec b/FirebaseInstallations.podspec\nindex 458e1654936..990dd505411 100644\n--- a/FirebaseInstallations.podspec\n+++ b/FirebaseInstallations.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader.podspec b/FirebaseMLModelDownloader.podspec\nindex 1118c479d1c..a45f5b93216 100644\n--- a/FirebaseMLModelDownloader.podspec\n+++ b/FirebaseMLModelDownloader.podspec\n@@ -16,12 +16,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader/Apps/Sample/Podfile b/FirebaseMLModelDownloader/Apps/Sample/Podfile\nindex 24d21a9d4de..cb632e9d85f 100644\n--- a/FirebaseMLModelDownloader/Apps/Sample/Podfile\n+++ b/FirebaseMLModelDownloader/Apps/Sample/Podfile\n@@ -1,4 +1,4 @@\n-platform :ios, '11.0'\n+platform :ios, '13.0'\n use_frameworks!\n \n source 'https://github.com/firebase/SpecsDev.git'\ndiff --git a/FirebaseMessaging.podspec b/FirebaseMessaging.podspec\nindex bbabbcdc201..0e056c8a17a 100644\n--- a/FirebaseMessaging.podspec\n+++ b/FirebaseMessaging.podspec\n@@ -20,12 +20,12 @@ device, and it is completely free.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMessagingInterop.podspec b/FirebaseMessagingInterop.podspec\nindex 31d03220e3c..3e7e1b6d8cb 100644\n--- a/FirebaseMessagingInterop.podspec\n+++ b/FirebaseMessagingInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseMessaging/Interop/*.[hm]'\n   s.public_header_files = 'FirebaseMessaging/Interop/*.h'\ndiff --git a/FirebasePerformance.podspec b/FirebasePerformance.podspec\nindex 9a0f48d3acf..6bcf58249df 100644\n--- a/FirebasePerformance.podspec\n+++ b/FirebasePerformance.podspec\n@@ -17,10 +17,10 @@ Firebase Performance library to measure performance of Mobile and Web Apps.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  tvos_deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.tvos.deployment_target = tvos_deployment_target\ndiff --git a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\nindex c5e04efc947..147b53c516a 100644\n--- a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n+++ b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n@@ -69,9 +69,12 @@ void InstrumentViewDidAppear(FPRUIViewControllerInstrument *instrument,\n \n     // This has to be called on the main thread and so it's done here instead of in\n     // FPRScreenTraceTracker.\n-    // TODO: Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n+    // TODO(#13067): Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n #if !defined(TARGET_OS_VISION) || !TARGET_OS_VISION\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     if ([((UIViewController *)_self).view isDescendantOfView:FPRSharedApplication().keyWindow]) {\n+#pragma clang diagnostic pop\n       [[FPRScreenTraceTracker sharedInstance] viewControllerDidAppear:_self];\n     }\n #endif\ndiff --git a/FirebaseRemoteConfig.podspec b/FirebaseRemoteConfig.podspec\nindex 6c81684decb..a69cdbed484 100644\n--- a/FirebaseRemoteConfig.podspec\n+++ b/FirebaseRemoteConfig.podspec\n@@ -18,12 +18,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseRemoteConfig/Tests/Sample/Podfile b/FirebaseRemoteConfig/Tests/Sample/Podfile\nindex bfff53e6fea..bdce061ec49 100644\n--- a/FirebaseRemoteConfig/Tests/Sample/Podfile\n+++ b/FirebaseRemoteConfig/Tests/Sample/Podfile\n@@ -1,5 +1,4 @@\n-# Uncomment the next line to define a global platform for your project\n-# platform :ios, '9.0'\n+platform :ios, '13.0'\n \n source 'https://github.com/firebase/SpecsDev.git'\n source 'https://github.com/firebase/SpecsStaging.git'\ndiff --git a/FirebaseRemoteConfigInterop.podspec b/FirebaseRemoteConfigInterop.podspec\nindex c9d9a9c30d8..6f9ea69cba2 100644\n--- a/FirebaseRemoteConfigInterop.podspec\n+++ b/FirebaseRemoteConfigInterop.podspec\n@@ -20,15 +20,17 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+\n+  # The ios deployment target must support Crashlytics.\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseRemoteConfig/Interop/*.swift'\n end\ndiff --git a/FirebaseRemoteConfigSwift.podspec b/FirebaseRemoteConfigSwift.podspec\nindex 3f0b3b3174e..7474d09616f 100644\n--- a/FirebaseRemoteConfigSwift.podspec\n+++ b/FirebaseRemoteConfigSwift.podspec\n@@ -19,12 +19,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSessions.podspec b/FirebaseSessions.podspec\nindex 6c282296e9a..8685d6c61af 100644\n--- a/FirebaseSessions.podspec\n+++ b/FirebaseSessions.podspec\n@@ -18,12 +18,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSharedSwift.podspec b/FirebaseSharedSwift.podspec\nindex 0b2ab17a71d..e0e8f4fec9c 100644\n--- a/FirebaseSharedSwift.podspec\n+++ b/FirebaseSharedSwift.podspec\n@@ -18,12 +18,12 @@ Firebase products. FirebaseSharedSwift is not supported for non-Firebase usage.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseStorage.podspec b/FirebaseStorage.podspec\nindex 5322597a81c..17729ae3d28 100644\n--- a/FirebaseStorage.podspec\n+++ b/FirebaseStorage.podspec\n@@ -27,7 +27,7 @@ Firebase Storage provides robust, secure file uploads and downloads from Firebas\n   s.tvos.deployment_target = tvos_deployment_target\n   s.watchos.deployment_target = watchos_deployment_target\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseVertexAI-Docs.not_podspec b/FirebaseVertexAI-Docs.not_podspec\nindex 7967cc616c4..4c447335f65 100644\n--- a/FirebaseVertexAI-Docs.not_podspec\n+++ b/FirebaseVertexAI-Docs.not_podspec\n@@ -34,7 +34,7 @@ Pod::Spec.new do |s|\n     'FirebaseVertexAI/Sources/**/*.swift',\n   ]\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.framework = 'Foundation'\n   s.ios.framework = 'UIKit'\ndiff --git a/Firestore/Example/GoogleBenchmark.podspec b/Firestore/Example/GoogleBenchmark.podspec\nindex ae7fc81cd98..c0024acced3 100644\n--- a/Firestore/Example/GoogleBenchmark.podspec\n+++ b/Firestore/Example/GoogleBenchmark.podspec\n@@ -33,9 +33,9 @@ Google's C++ benchmark framework.\n       :tag => 'v' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/GoogleTest.podspec b/Firestore/Example/GoogleTest.podspec\nindex 87788e99d8b..f7dd32cde06 100644\n--- a/Firestore/Example/GoogleTest.podspec\n+++ b/Firestore/Example/GoogleTest.podspec\n@@ -33,9 +33,9 @@ Google's C++ test framework.\n     :commit => 'bf66935e07825318ae519675d73d0f3e313b3ec6'\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/LibFuzzer.podspec b/Firestore/Example/LibFuzzer.podspec\nindex ea654f48fcc..c4b7b5f34a8 100644\n--- a/Firestore/Example/LibFuzzer.podspec\n+++ b/Firestore/Example/LibFuzzer.podspec\n@@ -28,9 +28,9 @@ Pod::Spec.new do |s|\n   s.license             = { :type => 'BSD-Like' }\n   s.authors             = 'LLVM Team'\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source              = {\n     :git => 'https://github.com/llvm/llvm-project.git'\ndiff --git a/Firestore/Example/Podfile b/Firestore/Example/Podfile\nindex 99bb2815390..c5417d9068d 100644\n--- a/Firestore/Example/Podfile\n+++ b/Firestore/Example/Podfile\n@@ -95,7 +95,7 @@ end\n \n if is_platform(:ios)\n   target 'Firestore_Example_iOS' do\n-    platform :ios, '11.0'\n+    platform :ios, '13.0'\n \n     configure_local_pods()\n \n@@ -120,7 +120,6 @@ if is_platform(:ios)\n     target 'Firestore_IntegrationTests_iOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -130,7 +129,7 @@ if is_platform(:ios)\n \n     target 'Firestore_FuzzTests_iOS' do\n       inherit! :search_paths\n-      platform :ios, '11.0'\n+      platform :ios, '13.0'\n \n       pod 'LibFuzzer', :podspec => 'LibFuzzer.podspec', :inhibit_warnings => true\n     end\n@@ -139,7 +138,7 @@ end\n \n if is_platform(:osx)\n   target 'Firestore_Example_macOS' do\n-    platform :osx, '10.13'\n+    platform :osx, '10.15'\n \n     configure_local_pods()\n \n@@ -158,7 +157,6 @@ if is_platform(:osx)\n     target 'Firestore_IntegrationTests_macOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -170,7 +168,7 @@ end\n \n if is_platform(:tvos)\n   target 'Firestore_Example_tvOS' do\n-    platform :tvos, '12.0'\n+    platform :tvos, '13.0'\n \n     configure_local_pods()\n \n@@ -189,7 +187,6 @@ if is_platform(:tvos)\n     target 'Firestore_IntegrationTests_tvOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\ndiff --git a/Firestore/Example/ProtobufCpp.podspec b/Firestore/Example/ProtobufCpp.podspec\nindex 956f9d3186c..7012de8d076 100644\n--- a/Firestore/Example/ProtobufCpp.podspec\n+++ b/Firestore/Example/ProtobufCpp.podspec\n@@ -29,9 +29,9 @@ Pod::Spec.new do |s|\n     :tag => \"v#{s.version}\"\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source_files = 'src/**/*.{h,cc,inc}',\n                    # utf8_range is needed too, to avoid build errors.\ndiff --git a/GoogleAppMeasurement.podspec b/GoogleAppMeasurement.podspec\nindex f893a310310..b69681f1520 100644\n--- a/GoogleAppMeasurement.podspec\n+++ b/GoogleAppMeasurement.podspec\n@@ -21,9 +21,9 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/GoogleAppMeasurementOnDeviceConversion.podspec b/GoogleAppMeasurementOnDeviceConversion.podspec\nindex a1810fb012c..0c816c4f9c4 100644\n--- a/GoogleAppMeasurementOnDeviceConversion.podspec\n+++ b/GoogleAppMeasurementOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n+    s.ios.deployment_target  = '12.0'\n \n     s.libraries  = 'c++'\n \ndiff --git a/IntegrationTesting/ClientApp/Podfile b/IntegrationTesting/ClientApp/Podfile\nindex e2abd6876dd..29810fab6ad 100644\n--- a/IntegrationTesting/ClientApp/Podfile\n+++ b/IntegrationTesting/ClientApp/Podfile\n@@ -3,7 +3,7 @@ source 'https://github.com/firebase/SpecsStaging.git'\n source 'https://cdn.cocoapods.org/'\n \n target 'ClientApp-CocoaPods' do\n-  platform :ios, '12.0'\n+  platform :ios, '13.0'\n \n   use_frameworks!\n \n@@ -24,7 +24,6 @@ target 'ClientApp-CocoaPods' do\n   pod 'FirebaseDatabaseSwift', :path => '../../'\n   pod 'FirebaseDynamicLinks', :path => '../../'\n   pod 'FirebaseFirestore', :path => '../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../'\n   pod 'FirebaseFunctions', :path => '../../'\n   pod 'FirebaseInAppMessaging', :path => '../../'\n   pod 'FirebaseMessaging', :path => '../../'\ndiff --git a/Package.swift b/Package.swift\nindex 3da098725da..87174d0fb70 100644\n--- a/Package.swift\n+++ b/Package.swift\n@@ -23,7 +23,7 @@ let firebaseVersion = \"11.0.0\"\n \n let package = Package(\n   name: \"Firebase\",\n-  platforms: [.iOS(.v12), .macCatalyst(.v13), .macOS(.v10_13), .tvOS(.v12), .watchOS(.v7)],\n+  platforms: [.iOS(.v12), .macCatalyst(.v15), .macOS(.v10_15), .tvOS(.v13), .watchOS(.v7)],\n   products: [\n     .library(\n       name: \"FirebaseAnalytics\",\n", "instance_id": "firebase__firebase-ios-sdk-13066", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in its intent to update the minimum supported versions for Firebase across various platforms (iOS, macOS, tvOS, watchOS) to address Xcode warnings and enable modern Swift features. It specifies the target versions (e.g., iOS 13 for most components, iOS 12 for exceptions like Analytics and Crashlytics) and mentions the affected platforms and products (\"All\"). However, there are minor ambiguities and missing details. For instance, it lacks specific guidance on how to handle dependencies or potential compatibility issues with older versions of dependent libraries or apps using Firebase. Additionally, there are no explicit examples or test cases provided to validate the changes, and edge cases (e.g., apps still targeting older iOS versions) are not addressed. The lack of detailed reproduction steps or relevant log output also slightly diminishes clarity. Overall, the goal is understandable, but some minor details could be fleshed out for a more comprehensive description.", "difficulty_explanation": "The difficulty of this task falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The changes involve updating deployment targets and Swift versions across numerous `.podspec` files and related configuration files (e.g., `Podfile`, `Package.swift`). While the changes span multiple files, they are largely repetitive and involve straightforward modifications (e.g., changing version numbers from '11.0' to '13.0' or Swift version from '5.3' to '5.9'). There is also a small code change in `FIRAppDistributionUIService.m` to remove deprecated iOS version checks, which is simple. The impact on the system's architecture is minimal as this is primarily a configuration update rather than a functional or structural change. However, the sheer number of files affected requires careful attention to ensure consistency across the codebase.\n\n2. **Number of Technical Concepts:** The task requires basic familiarity with iOS development concepts such as deployment targets, Swift versions, and CocoaPods configuration. It also involves understanding platform-specific version constraints and how they affect app compatibility. While these concepts are not overly complex for a developer familiar with iOS and Firebase, they do require some domain knowledge of Apple's ecosystem and dependency management tools. No advanced algorithms, design patterns, or deep system-level knowledge are needed.\n\n3. **Edge Cases and Error Handling:** The problem statement mentions exceptions for certain Firebase products (e.g., Analytics and Crashlytics supporting iOS 12), which introduces a minor need to handle variations in deployment targets. However, no specific edge cases or error handling requirements are detailed beyond these exceptions. The code changes do not introduce new error handling logic, though developers must ensure that the updated targets do not break existing integrations or apps relying on older versions\u2014a potential implicit edge case not explicitly addressed in the problem.\n\n4. **Overall Complexity:** The task is relatively straightforward but requires attention to detail due to the breadth of files affected and the need to maintain consistency (e.g., ensuring all relevant Firebase components align with the new minimum versions unless explicitly excepted). It does not involve deep architectural changes or complex logic, but it does require a basic understanding of the Firebase ecosystem and iOS platform versioning.\n\nGiven these considerations, a score of 0.35 reflects an \"Easy\" task that involves simple, repetitive changes across multiple files with minimal complexity in logic or architecture, but with a slight increase in effort due to the scope of files and the need to account for platform-specific exceptions.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Empty dictionarySuggestions on Windows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\nv35.0.0-nightly.20250113\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\nv35.0.0-nightly.20250109\n\n### Expected Behavior\n\nContext menu contains `dictionarySuggestions`\n\n### Actual Behavior\n\nContext menu contains `dictionarySuggestions` without any suggestions\n\n### Testcase Gist URL\n\nhttps://gist.github.com/samuelmaddock/e66dde2361de95f3c48f443a8abdd099\n\n### Additional Information\n\nRegressed by https://chromium-review.googlesource.com/c/chromium/src/+/6109477 in https://github.com/electron/electron/pull/45055\n\nRelated:\n* https://github.com/electron/electron/pull/29690\n* https://github.com/electron/electron/issues/29685\n", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex fec7148a7ec5a..cea4da74f5f7f 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -140,3 +140,4 @@ revert_code_health_clean_up_stale_macwebcontentsocclusion.patch\n ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\n feat_add_signals_when_embedder_cleanup_callbacks_run_for.patch\n feat_separate_content_settings_callback_for_sync_and_async_clipboard.patch\n+fix_win32_synchronous_spellcheck.patch\ndiff --git a/patches/chromium/fix_win32_synchronous_spellcheck.patch b/patches/chromium/fix_win32_synchronous_spellcheck.patch\nnew file mode 100644\nindex 0000000000000..355c8f8e9a6ae\n--- /dev/null\n+++ b/patches/chromium/fix_win32_synchronous_spellcheck.patch\n@@ -0,0 +1,29 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Keeley Hammond <khammond@slack-corp.com>\n+Date: Wed, 19 Feb 2025 11:18:44 -0800\n+Subject: fix: re-enable synchronous spellcheck on Windows\n+\n+This fix partially reverts 6109477: Code Health:\n+Clean up stale base::Feature \"WinRetrieveSuggestionsOnlyOnDemand\"\n+https://chromium-review.googlesource.com/c/chromium/src/+/6109477\n+by re-adding a synchronous call to FillSuggestionList.\n+\n+This patch can be removed when an asynchronous spellcheck API\n+option is added to Electron.\n+\n+diff --git a/components/spellcheck/browser/windows_spell_checker.cc b/components/spellcheck/browser/windows_spell_checker.cc\n+index f5a7411037758427eddc088b5426554b4a500d33..04b3edd4d8c58d38e260cc54beb0dab86368fc25 100644\n+--- a/components/spellcheck/browser/windows_spell_checker.cc\n++++ b/components/spellcheck/browser/windows_spell_checker.cc\n+@@ -239,6 +239,11 @@ std::vector<SpellCheckResult> BackgroundHelper::RequestTextCheckForAllLanguages(\n+             (action == CORRECTIVE_ACTION_GET_SUGGESTIONS ||\n+              action == CORRECTIVE_ACTION_REPLACE)) {\n+           std::vector<std::u16string> suggestions;\n++          // TODO (vertedinde): Perform the synchronous operation of retrieving\n++          // suggestions for all misspelled words while performing a text check.\n++          FillSuggestionList(it->first,\n++            text.substr(start_index, error_length),\n++            &suggestions);\n+           result_map[std::tuple<ULONG, ULONG>(start_index, error_length)]\n+               .push_back(suggestions);\n+         }\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex f6265505f8803..a18f580f92bba 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -194,14 +194,6 @@\n #include \"content/public/browser/plugin_service.h\"\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"chrome/browser/spellchecker/spellcheck_factory.h\"\n-#include \"chrome/browser/spellchecker/spellcheck_service.h\"\n-#include \"components/spellcheck/browser/spellcheck_platform.h\"\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#include \"components/spellcheck/common/spellcheck_features.h\"\n-#endif\n-\n #if !IS_MAS_BUILD()\n #include \"chrome/browser/hang_monitor/hang_crash_dump.h\"  // nogncheck\n #endif\n@@ -1521,44 +1513,11 @@ void WebContents::RendererResponsive(\n \n bool WebContents::HandleContextMenu(content::RenderFrameHost& render_frame_host,\n                                     const content::ContextMenuParams& params) {\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (!params.misspelled_word.empty() && spellcheck::UseBrowserSpellChecker()) {\n-    SpellcheckService* spellcheck_service =\n-        SpellcheckServiceFactory::GetForContext(\n-            render_frame_host.GetBrowserContext());\n-    if (spellcheck_service) {\n-      spellcheck_platform::GetPerLanguageSuggestions(\n-          spellcheck_service->platform_spell_checker(), params.misspelled_word,\n-          base::BindOnce(&WebContents::OnGetPlatformSuggestionsComplete,\n-                         GetWeakPtr(), std::ref(render_frame_host), params));\n-    }\n-  } else {\n-#endif\n-    Emit(\"context-menu\",\n-         std::make_tuple(params, &render_frame_host,\n-                         std::optional<std::vector<std::u16string>>{}));\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  }\n-#endif\n+  Emit(\"context-menu\", std::make_pair(params, &render_frame_host));\n \n   return true;\n }\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-void WebContents::OnGetPlatformSuggestionsComplete(\n-    content::RenderFrameHost& render_frame_host,\n-    const content::ContextMenuParams& params,\n-    const spellcheck::PerLanguageSuggestions&\n-        platform_per_language_suggestions) {\n-  std::vector<std::u16string> combined_suggestions;\n-  spellcheck::FillSuggestions(platform_per_language_suggestions,\n-                              &combined_suggestions);\n-  Emit(\"context-menu\",\n-       std::make_tuple(params, &render_frame_host,\n-                       std::make_optional(combined_suggestions)));\n-}\n-#endif\n-\n void WebContents::FindReply(content::WebContents* web_contents,\n                             int request_id,\n                             int number_of_matches,\ndiff --git a/shell/browser/api/electron_api_web_contents.h b/shell/browser/api/electron_api_web_contents.h\nindex 58a6de68d24e5..40a0502b66924 100644\n--- a/shell/browser/api/electron_api_web_contents.h\n+++ b/shell/browser/api/electron_api_web_contents.h\n@@ -57,10 +57,6 @@ class ScriptExecutor;\n }\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#endif\n-\n namespace blink {\n struct DeviceEmulationParams;\n // enum class PermissionType;\n@@ -761,14 +757,6 @@ class WebContents final : public ExclusiveAccessContext,\n   // Update the html fullscreen flag in both browser and renderer.\n   void UpdateHtmlApiFullscreen(bool fullscreen);\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  void OnGetPlatformSuggestionsComplete(\n-      content::RenderFrameHost& render_frame_host,\n-      const content::ContextMenuParams& params,\n-      const spellcheck::PerLanguageSuggestions&\n-          platform_per_language_suggestions);\n-#endif\n-\n   v8::Global<v8::Value> session_;\n   v8::Global<v8::Value> devtools_web_contents_;\n   v8::Global<v8::Value> debugger_;\ndiff --git a/shell/common/gin_converters/content_converter.cc b/shell/common/gin_converters/content_converter.cc\nindex 7e593c324a0dd..d5a257b8f24ac 100644\n--- a/shell/common/gin_converters/content_converter.cc\n+++ b/shell/common/gin_converters/content_converter.cc\n@@ -88,7 +88,8 @@ v8::Local<v8::Value> Converter<blink::mojom::MenuItem::Type>::ToV8(\n v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n     v8::Isolate* isolate,\n     const ContextMenuParamsWithRenderFrameHost& val) {\n-  auto [params, render_frame_host, optional_suggestions] = val;\n+  const auto& params = val.first;\n+  content::RenderFrameHost* render_frame_host = val.second;\n   auto dict = gin_helper::Dictionary::CreateEmpty(isolate);\n   dict.SetGetter(\"frame\", render_frame_host, v8::DontEnum);\n   dict.Set(\"x\", params.x);\n@@ -113,11 +114,7 @@ v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n   dict.Set(\"misspelledWord\", params.misspelled_word);\n   dict.Set(\"selectionRect\", params.selection_rect);\n #if BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (optional_suggestions) {\n-    dict.Set(\"dictionarySuggestions\", optional_suggestions.value());\n-  } else {\n-    dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n-  }\n+  dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n   dict.Set(\"spellcheckEnabled\", params.spellcheck_enabled);\n #else\n   dict.Set(\"spellcheckEnabled\", false);\ndiff --git a/shell/common/gin_converters/content_converter.h b/shell/common/gin_converters/content_converter.h\nindex 1e1f26012f874..2fa5f7f118df9 100644\n--- a/shell/common/gin_converters/content_converter.h\n+++ b/shell/common/gin_converters/content_converter.h\n@@ -26,9 +26,7 @@ struct NativeWebKeyboardEvent;\n }\n \n using ContextMenuParamsWithRenderFrameHost =\n-    std::tuple<content::ContextMenuParams,\n-               content::RenderFrameHost*,\n-               std::optional<std::vector<std::u16string>>>;\n+    std::pair<content::ContextMenuParams, content::RenderFrameHost*>;\n \n namespace gin {\n \n", "instance_id": "electron__electron-45712", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: the context menu on Windows in Electron does not show dictionary suggestions for misspelled words after a specific Chromium update. It provides relevant details such as the Electron version, operating system, and links to related issues and changes in Chromium that caused the regression. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected format or source of the dictionary suggestions, nor does it mention specific edge cases or constraints (e.g., language support, performance expectations). Additionally, while the test case gist and related issues provide context, the statement lacks a detailed description of the desired behavior beyond \"context menu contains dictionarySuggestions.\" Overall, it is clear enough to understand the goal but leaves some minor aspects open to interpretation.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files and components, including a patch to Chromium's spellcheck module and modifications to Electron's web contents handling. This requires understanding the interaction between Electron and Chromium's codebase, which is non-trivial. Second, the technical concepts involved include familiarity with Chromium's spellcheck architecture, Windows-specific spellchecking APIs, and Electron's event emission system for context menus. Additionally, the changes involve reverting a specific Chromium update and reintroducing synchronous spellcheck behavior, which demands careful consideration of potential performance impacts and compatibility issues. Third, while edge cases are not explicitly mentioned in the problem statement, the nature of spellchecking (e.g., handling different languages, empty or invalid input, or large text blocks) implies the need for robust error handling, though the provided code changes do not extensively address this. Finally, the impact on the system is moderate, as it affects a user-facing feature (context menu suggestions) and requires ensuring that the synchronous call does not degrade performance. Overall, solving this requires a deep understanding of the codebase and careful implementation, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "segfault when moving WebContentsView between BrowserWindows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33, 34\n\n### What operating system(s) are you using?\n\nUbuntu\n\n### Operating System Version\n\n23.04\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nWhen moving WebContentsViews between different browser windows, the app doesn't crash\n\n### Actual Behavior\n\nWhen moving WebContentsViews from BrowserWindow A to BrowserWindow B and back to BrowserWindow A, the app crashes. Going just from A BrowserWindow A to BrowserWindow B works, but then back to A segfaults.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/Kilian/8014d47a193a8f66b05f490def934166\n\n### Additional Information\n\n_No response_\n", "patch": "diff --git a/shell/browser/api/electron_api_view.cc b/shell/browser/api/electron_api_view.cc\nindex b01a08be88cb7..c65f80b164fec 100644\n--- a/shell/browser/api/electron_api_view.cc\n+++ b/shell/browser/api/electron_api_view.cc\n@@ -124,6 +124,15 @@ struct Converter<views::FlexAllocationOrder> {\n   }\n };\n \n+template <>\n+struct Converter<electron::api::View> {\n+  static bool FromV8(v8::Isolate* isolate,\n+                     v8::Local<v8::Value> val,\n+                     electron::api::View* out) {\n+    return gin::ConvertFromV8(isolate, val, &out);\n+  }\n+};\n+\n template <>\n struct Converter<views::SizeBound> {\n   static v8::Local<v8::Value> ToV8(v8::Isolate* isolate,\n@@ -257,11 +266,13 @@ void View::RemoveChildView(gin::Handle<View> child) {\n #if BUILDFLAG(IS_MAC)\n     ScopedCAActionDisabler disable_animations;\n #endif\n+    // Remove from child_views first so that OnChildViewRemoved doesn't try to\n+    // remove it again\n+    child_views_.erase(it);\n     // It's possible for the child's view to be invalid here\n     // if the child's webContents was closed or destroyed.\n     if (child->view())\n       view_->RemoveChildView(child->view());\n-    child_views_.erase(it);\n   }\n }\n \n@@ -388,6 +399,19 @@ void View::OnViewIsDeleting(views::View* observed_view) {\n   view_ = nullptr;\n }\n \n+void View::OnChildViewRemoved(views::View* observed_view, views::View* child) {\n+  v8::Isolate* isolate = JavascriptEnvironment::GetIsolate();\n+  auto it = std::ranges::find_if(\n+      child_views_, [&](const v8::Global<v8::Object>& child_view) {\n+        View current_view;\n+        gin::ConvertFromV8(isolate, child_view.Get(isolate), &current_view);\n+        return current_view.view()->GetID() == child->GetID();\n+      });\n+  if (it != child_views_.end()) {\n+    child_views_.erase(it);\n+  }\n+}\n+\n // static\n gin_helper::WrappableBase* View::New(gin::Arguments* args) {\n   View* view = new View();\ndiff --git a/shell/browser/api/electron_api_view.h b/shell/browser/api/electron_api_view.h\nindex 6eeb16521906f..1b0a3f815a6f9 100644\n--- a/shell/browser/api/electron_api_view.h\n+++ b/shell/browser/api/electron_api_view.h\n@@ -47,6 +47,8 @@ class View : public gin_helper::EventEmitter<View>,\n   // views::ViewObserver\n   void OnViewBoundsChanged(views::View* observed_view) override;\n   void OnViewIsDeleting(views::View* observed_view) override;\n+  void OnChildViewRemoved(views::View* observed_view,\n+                          views::View* child) override;\n \n   views::View* view() const { return view_; }\n   std::optional<int> border_radius() const { return border_radius_; }\ndiff --git a/spec/fixtures/crash-cases/webview-move-between-windows/index.js b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\nnew file mode 100644\nindex 0000000000000..de9053ec65ca9\n--- /dev/null\n+++ b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\n@@ -0,0 +1,31 @@\n+const { app, BrowserWindow, WebContentsView } = require('electron');\n+\n+function createWindow () {\n+  // Create the browser window.\n+  const mainWindow = new BrowserWindow();\n+  const secondaryWindow = new BrowserWindow();\n+\n+  const contentsView = new WebContentsView();\n+  mainWindow.contentView.addChildView(contentsView);\n+  mainWindow.webContents.setDevToolsWebContents(contentsView.webContents);\n+  mainWindow.openDevTools();\n+\n+  contentsView.setBounds({\n+    x: 400,\n+    y: 0,\n+    width: 400,\n+    height: 600\n+  });\n+\n+  setTimeout(() => {\n+    secondaryWindow.contentView.addChildView(contentsView);\n+    setTimeout(() => {\n+      mainWindow.contentView.addChildView(contentsView);\n+      app.quit();\n+    }, 1000);\n+  }, 1000);\n+}\n+\n+app.whenReady().then(() => {\n+  createWindow();\n+});\n", "instance_id": "electron__electron-44599", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a segmentation fault occurs when moving WebContentsView between BrowserWindows, specifically when moving it back to the original window. The expected behavior (no crash) and actual behavior (crash on moving back) are explicitly stated, and a test case gist is provided, which adds to the clarity. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify the exact conditions or configurations that might trigger the crash beyond the basic scenario (e.g., specific WebContentsView states, window configurations, or system-specific behaviors). Additionally, there are no explicit mentions of constraints or edge cases to consider, which could be critical for a complete understanding of the issue. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes, while localized to a few files (electron_api_view.cc and electron_api_view.h), involves critical modifications to the view management logic in a complex codebase like Electron, which integrates with Chromium's rendering and windowing systems. Understanding the interaction between WebContentsView, BrowserWindow, and the underlying views::View hierarchy requires a deep knowledge of Electron's architecture and Chromium's view system. Second, the number of technical concepts involved is significant: familiarity with C++ (including templates and smart pointers), V8 JavaScript engine bindings (gin library), Electron's API design, and event handling for view changes are all necessary. Third, the changes impact how child views are managed and removed, which could introduce subtle bugs or performance issues if not handled correctly. While the provided code changes address the issue by adjusting the order of operations in RemoveChildView and adding a new observer method (OnChildViewRemoved), ensuring correctness across various scenarios (e.g., invalid views, concurrent modifications) adds complexity. Finally, edge cases such as closed or destroyed WebContents, multiple view movements, or platform-specific behaviors (noted with macOS-specific code) must be considered, though not fully detailed in the problem statement. Overall, this problem requires a solid understanding of the codebase and careful handling of view lifecycle events, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex 0dcfad8aa6dd5..62c5480edf965 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "instance_id": "electron__electron-41707", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: Electron crashes when closing a notification in a portal environment with libnotify 0.8.3. It provides detailed context, including the affected Electron versions, operating system details, and a step-by-step analysis of the crash's root cause. The expected behavior (no crash on `notification.close()`) and actual behavior (crash in portal environments) are explicitly stated. Additionally, links to relevant code in the Electron repository and an external minimal reproducible example (MRE) are provided, which aids in understanding the issue. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly mention specific constraints or edge cases beyond the portal environment (e.g., are there other environmental factors or configurations that could influence the crash?). Furthermore, while the analysis is detailed, it assumes some familiarity with the Electron notification system and libnotify internals, which might not be immediately clear to someone unfamiliar with these components. Overall, the statement is valid and clear but lacks exhaustive detail on edge cases or broader implications.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.65, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem is mostly clear, the underlying issue involves intricate interactions between Electron's notification system and libnotify's behavior in portal environments (e.g., Flatpak/Snap). Understanding the crash requires tracing the signal handling and object lifecycle management in a C++ codebase, which adds to the logical complexity.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are relatively localized, affecting only two files (`libnotify_notification.cc` and `libnotify_notification.h`). The modification introduces a boolean flag (`on_dismissing_`) to track whether the dismissal is in progress, preventing premature destruction of the notification object. However, this change requires a deep understanding of the notification lifecycle and signal handling in the Electron codebase. While the change itself is small (a few lines), it impacts a critical part of the system (notification handling), and a mistake here could introduce new bugs or crashes. The change does not significantly alter the system's architecture but does require careful consideration of object ownership and callback behavior.\n\n3. **Number of Technical Concepts to Understand**: Solving this problem requires familiarity with several advanced concepts:\n   - C++ memory management and object lifecycle (e.g., avoiding use-after-free issues when `delete` is called on `this`).\n   - GLib signal handling (e.g., understanding how `g_signal_emit` triggers callbacks like `OnNotificationClosed`).\n   - Electron's notification system and its interaction with native libraries like libnotify.\n   - Portal environments (Flatpak/Snap) and their impact on notification behavior, which is a domain-specific nuance.\n   These concepts are moderately to highly complex, especially for developers without prior experience in Electron or GLib-based systems.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement highlights a specific edge case (closing notifications in a portal environment with libnotify 0.8.3), and the code change addresses this by preventing premature destruction during dismissal. However, additional edge cases might exist, such as concurrent notification operations, different libnotify versions, or other environmental factors not mentioned in the statement. The code change modifies error handling logic indirectly by avoiding a crash, but it does not introduce extensive new error handling. The complexity of edge cases is moderate, as the primary issue is well-defined, but ensuring robustness across all scenarios could require further investigation.\n\nOverall, this problem is hard (0.65) because it demands a deep understanding of Electron's internals, C++ memory management, and GLib signal handling, along with domain-specific knowledge of portal environments. The code change, while small, addresses a critical bug with potential for subtle side effects if not handled correctly. It is not in the \"Very Hard\" range (0.8-1.0) because the scope of changes is limited, and the problem does not involve system-level redesign or highly intricate algorithms.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Animation Node Blend Tree Slider drag handle not aligning when zoomed\n### Tested versions\n\nReproducible in: \nv4.4.1.stable.mono.official [49a5bc7b6]\nv4.4.stable.mono.official [4c311cbee] \n\nWorking correctly in:\nv4.3.stable.mono.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable.mono - Windows 10.0.19045 - GLES3 (Compatibility) - NVIDIA GeForce RTX 2070 (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (16 Threads)\n\n### Issue description\n\nWhen using an AnimationNodeBlendTree and zooming in on sliders like the blend slider, the handle for grabbing is offset from the view when it should remain on the line \n\n4.3 Working correctly:\n![Image](https://github.com/user-attachments/assets/e1fb6ded-e1e6-458e-8797-c552f6d2c23a)\n\n4.4.1 being offset:\n![Image](https://github.com/user-attachments/assets/4eec11e9-6e98-4e7d-9685-58f7a04d6cbc)\n\n### Steps to reproduce\n\n* Open a new project\n* Add an AnimationTree node\n* Add an AnimationNodeBlendTree to it\n* In the AnimationTree window right click and add a blend2 \n* Hover the blend slider and zoom in to see that the offset of the handle is not on the slider\n\n\n### Minimal reproduction project (MRP)\n\nTo ensure it was not my theme settings I reset all my theme settings in both 4.4 and 4.4.1\n\nI then downloaded 4.3 and set up the project again and it was not the case. \n\nHere's my a copy of a project with a scene set up in 4.4.1, but it's pretty easy to set up\n\n[BlendTreeIssue_4.4.1.zip](https://github.com/user-attachments/files/19600739/BlendTreeIssue_4.4.1.zip)\n\n", "patch": "diff --git a/editor/gui/editor_spin_slider.cpp b/editor/gui/editor_spin_slider.cpp\nindex e68e3dcc9f42..99acf4e171dd 100644\n--- a/editor/gui/editor_spin_slider.cpp\n+++ b/editor/gui/editor_spin_slider.cpp\n@@ -435,10 +435,8 @@ void EditorSpinSlider::_draw_spin_slider() {\n \t\t\t\t\tgrabber->set_texture(grabber_tex);\n \t\t\t\t}\n \n-\t\t\t\tVector2 scale = get_global_transform_with_canvas().get_scale();\n-\t\t\t\tgrabber->set_scale(scale);\n \t\t\t\tgrabber->reset_size();\n-\t\t\t\tgrabber->set_position((grabber_rect.get_center() - grabber->get_size() * 0.5) * scale);\n+\t\t\t\tgrabber->set_position(grabber_rect.get_center() - grabber->get_size() * 0.5);\n \n \t\t\t\tif (mousewheel_over_grabber) {\n \t\t\t\t\tInput::get_singleton()->warp_mouse(grabber->get_position() + grabber_rect.size);\n", "instance_id": "godotengine__godot-105039", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the specific versions of the software where the bug is reproducible, steps to reproduce, and visual evidence through images. It also includes system information and a minimal reproduction project, which aids in understanding the context. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior beyond \"the handle should remain on the line,\" and it lacks discussion on potential edge cases or constraints (e.g., different zoom levels, themes, or screen resolutions). Additionally, there is no mention of performance or compatibility requirements for the fix. Despite these minor omissions, the issue is well-documented and actionable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). The issue involves a UI rendering bug in the Godot engine's editor interface, specifically with the positioning of a slider handle when zoomed. The provided code change is minimal, confined to a single file (`editor_spin_slider.cpp`), and involves removing a scaling factor from the position calculation of the grabber handle. This suggests the root cause is a straightforward misapplication of scaling in the rendering logic, and the fix requires only a basic understanding of GUI rendering and coordinate transformations in the context of the Godot engine.\n\nAnalyzing the factors:\n1. **Scope and Depth of Code Changes**: The change is localized to a few lines in a single file, with no apparent impact on other modules or the broader architecture of the system. The modification is small and focused.\n2. **Technical Concepts**: Solving this requires a basic understanding of GUI rendering, specifically how transformations (like scaling) affect object positioning in a canvas or viewport. Familiarity with Godot's internal rendering pipeline or editor GUI components is helpful but not deeply complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic graphics rendering are needed.\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code change does not introduce or modify error handling. However, potential edge cases (e.g., extreme zoom levels, different screen resolutions, or custom themes) might need consideration during testing, though they do not appear to complicate the fix itself.\n4. **Overall Complexity**: The fix is a simple adjustment to a position calculation, likely requiring minimal debugging or testing beyond verifying the visual alignment of the slider handle at different zoom levels.\n\nGiven the simplicity of the change, the localized scope, and the lack of complex technical concepts or significant edge case handling, I assign a difficulty score of 0.25. This reflects an easy problem that a developer with basic to intermediate experience in GUI programming or the Godot engine could resolve with minimal effort.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Sensitivity settings don't work in embedded game window\n### Tested versions\n\nv4.4.stable.official [4c311cbee]\n\n### System information\n\nGodot v4.4.stable - Linux Mint 22.1 (Xia) on X11 - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 960 (nvidia; 550.120) - AMD FX(tm)-6300 Six-Core Processor (6 threads)\n\n### Issue description\n\nThe embedded game window doesn't listen to the sensitivity settings in Editor Settings > Editors > 3D. I think it just uses the default value for every option.\n\nhttps://github.com/user-attachments/assets/b76f5570-d0c7-45b1-8d50-14649f853cf1\n\n### Steps to reproduce\n\n1. Change one of the sensitivity settings in Editor Settings > Editors > 3D such as \"Orbit Sensitivity\" or \"Freelook Sensitivity\".\n2. Play the game, in embedded game window click the camera icon and 3D. The sensitivity hasn't changed.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex bc3b4ceeb2b7..fa9dd87bc491 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -65,7 +65,18 @@ void GameViewDebugger::_session_started(Ref<EditorDebuggerSession> p_session) {\n \tsettings[\"editors/panning/warped_mouse_panning\"] = EDITOR_GET(\"editors/panning/warped_mouse_panning\");\n \tsettings[\"editors/panning/2d_editor_pan_speed\"] = EDITOR_GET(\"editors/panning/2d_editor_pan_speed\");\n \tsettings[\"canvas_item_editor/pan_view\"] = DebuggerMarshalls::serialize_key_shortcut(ED_GET_SHORTCUT(\"canvas_item_editor/pan_view\"));\n+#ifndef _3D_DISABLED\n+\tsettings[\"editors/3d/default_fov\"] = EDITOR_GET(\"editors/3d/default_fov\");\n+\tsettings[\"editors/3d/default_z_near\"] = EDITOR_GET(\"editors/3d/default_z_near\");\n+\tsettings[\"editors/3d/default_z_far\"] = EDITOR_GET(\"editors/3d/default_z_far\");\n+\tsettings[\"editors/3d/navigation/invert_x_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_x_axis\");\n+\tsettings[\"editors/3d/navigation/invert_y_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_y_axis\");\n+\tsettings[\"editors/3d/navigation/warped_mouse_panning\"] = EDITOR_GET(\"editors/3d/navigation/warped_mouse_panning\");\n \tsettings[\"editors/3d/freelook/freelook_base_speed\"] = EDITOR_GET(\"editors/3d/freelook/freelook_base_speed\");\n+\tsettings[\"editors/3d/freelook/freelook_sensitivity\"] = EDITOR_GET(\"editors/3d/freelook/freelook_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/orbit_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/orbit_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/translation_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/translation_sensitivity\");\n+#endif // _3D_DISABLED\n \tsetup_data.append(settings);\n \tp_session->send_message(\"scene:runtime_node_select_setup\", setup_data);\n \ndiff --git a/scene/debugger/scene_debugger.cpp b/scene/debugger/scene_debugger.cpp\nindex c620c5fd5c80..5661268f04c3 100644\n--- a/scene/debugger/scene_debugger.cpp\n+++ b/scene/debugger/scene_debugger.cpp\n@@ -1261,7 +1261,18 @@ void RuntimeNodeSelect::_setup(const Dictionary &p_settings) {\n #ifndef _3D_DISABLED\n \tcursor = Cursor();\n \n-\tfreelook_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", FREELOOK_BASE_SPEED);\n+\tcamera_fov = p_settings.get(\"editors/3d/default_fov\", 70);\n+\tcamera_znear = p_settings.get(\"editors/3d/default_z_near\", 0.05);\n+\tcamera_zfar = p_settings.get(\"editors/3d/default_z_far\", 4'000);\n+\n+\tinvert_x_axis = p_settings.get(\"editors/3d/navigation/invert_x_axis\", false);\n+\tinvert_y_axis = p_settings.get(\"editors/3d/navigation/invert_y_axis\", false);\n+\twarped_mouse_panning_3d = p_settings.get(\"editors/3d/navigation/warped_mouse_panning\", true);\n+\n+\tfreelook_base_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", 5);\n+\tfreelook_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/freelook/freelook_sensitivity\", 0.25));\n+\torbit_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/navigation_feel/orbit_sensitivity\", 0.004));\n+\ttranslation_sensitivity = p_settings.get(\"editors/3d/navigation_feel/translation_sensitivity\", 1);\n \n \t/// 3D Selection Box Generation\n \t// Copied from the Node3DEditor implementation.\n@@ -1342,7 +1353,7 @@ void RuntimeNodeSelect::_set_camera_override_enabled(bool p_enabled) {\n \t\t_update_view_2d();\n \n \t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \t}\n #endif // _3D_DISABLED\n }\n@@ -1445,7 +1456,7 @@ void RuntimeNodeSelect::_process_frame() {\n \t\t\tdirection -= up;\n \t\t}\n \n-\t\treal_t speed = freelook_speed;\n+\t\treal_t speed = freelook_base_speed;\n \t\tif (input->is_physical_key_pressed(Key::SHIFT)) {\n \t\t\tspeed *= 3.0;\n \t\t}\n@@ -2011,19 +2022,19 @@ bool RuntimeNodeSelect::_handle_3d_input(const Ref<InputEvent> &p_event) {\n \t\t\tswitch (k->get_physical_keycode()) {\n \t\t\t\tcase Key::EQUAL: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale - 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::MINUS: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale + 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::KEY_0: {\n \t\t\t\t\tcursor.fov_scale = 1;\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n@@ -2063,33 +2074,37 @@ void RuntimeNodeSelect::_set_camera_freelook_enabled(bool p_enabled) {\n }\n \n void RuntimeNodeSelect::_cursor_scale_distance(real_t p_scale) {\n-\treal_t min_distance = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_distance = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_distance = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_distance = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tcursor.distance = CLAMP(cursor.distance * p_scale, min_distance, max_distance);\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n void RuntimeNodeSelect::_scale_freelook_speed(real_t p_scale) {\n-\treal_t min_speed = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_speed = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_speed = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_speed = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tif (unlikely(min_speed > max_speed)) {\n-\t\tfreelook_speed = (min_speed + max_speed) / 2;\n+\t\tfreelook_base_speed = (min_speed + max_speed) / 2;\n \t} else {\n-\t\tfreelook_speed = CLAMP(freelook_speed * p_scale, min_speed, max_speed);\n+\t\tfreelook_base_speed = CLAMP(freelook_base_speed * p_scale, min_speed, max_speed);\n \t}\n }\n \n void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n \tconst Transform3D prev_camera_transform = _get_cursor_transform();\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * freelook_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * freelook_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tcursor.y_rot += relative.x * freelook_sensitivity;\n \n \t// Look is like the opposite of Orbit: the focus point rotates around the camera.\n \tTransform3D camera_transform = _get_cursor_transform();\n@@ -2104,8 +2119,8 @@ void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n-\tconst real_t pan_speed = 1 / 150.0;\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst real_t pan_speed = translation_sensitivity / 150.0;\n \n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2123,17 +2138,35 @@ void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_orbit(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * orbit_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tif (invert_x_axis) {\n+\t\tcursor.y_rot -= relative.x * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.y_rot += relative.x * orbit_sensitivity;\n+\t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n+Point2 RuntimeNodeSelect::_get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_area) const {\n+\tERR_FAIL_COND_V(p_event.is_null(), Point2());\n+\n+\tif (warped_mouse_panning_3d) {\n+\t\treturn Input::get_singleton()->warp_mouse_motion(p_event, p_area);\n+\t}\n+\n+\treturn p_event->get_relative();\n+}\n+\n Transform3D RuntimeNodeSelect::_get_cursor_transform() {\n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2158,13 +2191,13 @@ void RuntimeNodeSelect::_reset_camera_3d() {\n \t\tcursor.x_rot = -camera->get_global_rotation().x;\n \t\tcursor.y_rot = -camera->get_global_rotation().y;\n \n-\t\tcursor.fov_scale = CLAMP(camera->get_fov() / CAMERA_BASE_FOV, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n+\t\tcursor.fov_scale = CLAMP(camera->get_fov() / camera_fov, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n \t} else {\n \t\tcursor.fov_scale = 1.0;\n \t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n }\n #endif // _3D_DISABLED\n #endif\ndiff --git a/scene/debugger/scene_debugger.h b/scene/debugger/scene_debugger.h\nindex 5a56ea9d99b7..b0a365fddfcb 100644\n--- a/scene/debugger/scene_debugger.h\n+++ b/scene/debugger/scene_debugger.h\n@@ -242,20 +242,26 @@ class RuntimeNodeSelect : public Object {\n \tconst double VIEW_3D_MAX_ZOOM = 1'000'000'000'000;\n #else\n \tconst float VIEW_3D_MAX_ZOOM = 10'000;\n-#endif\n-\tconst float CAMERA_ZNEAR = 0.05;\n-\tconst float CAMERA_ZFAR = 4'000;\n+#endif // REAL_T_IS_DOUBLE\n \n-\tconst float CAMERA_BASE_FOV = 75;\n \tconst float CAMERA_MIN_FOV_SCALE = 0.1;\n \tconst float CAMERA_MAX_FOV_SCALE = 2.5;\n \n-\tconst float FREELOOK_BASE_SPEED = 4;\n-\tconst float RADS_PER_PIXEL = 0.004;\n-\n \tbool camera_first_override = true;\n \tbool camera_freelook = false;\n-\treal_t freelook_speed = FREELOOK_BASE_SPEED;\n+\n+\treal_t camera_fov = 0;\n+\treal_t camera_znear = 0;\n+\treal_t camera_zfar = 0;\n+\n+\tbool invert_x_axis = false;\n+\tbool invert_y_axis = false;\n+\tbool warped_mouse_panning_3d = false;\n+\n+\treal_t freelook_base_speed = 0;\n+\treal_t freelook_sensitivity = 0;\n+\treal_t orbit_sensitivity = 0;\n+\treal_t translation_sensitivity = 0;\n \n \tVector2 previous_mouse_position;\n \n@@ -267,7 +273,7 @@ class RuntimeNodeSelect : public Object {\n \tRID sbox_3d_instance_xray_ofs;\n \tTransform3D sbox_3d_xform;\n \tAABB sbox_3d_bounds;\n-#endif\n+#endif // _3D_DISABLED\n \n \tPoint2 selection_position = Point2(INFINITY, INFINITY);\n \tbool list_shortcut_pressed = false;\n@@ -314,6 +320,7 @@ class RuntimeNodeSelect : public Object {\n \tvoid _cursor_look(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_pan(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_orbit(Ref<InputEventWithModifiers> p_event);\n+\tPoint2 _get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_border) const;\n \tTransform3D _get_cursor_transform();\n \tvoid _reset_camera_3d();\n #endif\n", "instance_id": "godotengine__godot-103758", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the embedded game window in Godot v4.4 does not respect the sensitivity settings configured in the Editor Settings for 3D navigation (e.g., Orbit Sensitivity, Freelook Sensitivity). It provides specific steps to reproduce the issue, system information, and a reference to the affected version. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied but not explicitly stated (e.g., how should the sensitivity settings affect the embedded window?). Additionally, there is no mention of edge cases, potential constraints, or specific requirements for the fix (e.g., performance considerations or compatibility with other features). The lack of a minimal reproduction project (MRP) also slightly hinders clarity, as it would help in quickly verifying the issue. Overall, the problem is understandable, but minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes involves multiple files (`game_view_plugin.cpp`, `scene_debugger.cpp`, and `scene_debugger.h`) within the Godot engine, requiring an understanding of how settings are passed from the editor to the runtime environment. The changes are not trivial; they involve adding new settings for 3D navigation and sensitivity, updating how these settings are applied to camera controls, and handling mouse input modifications (e.g., warping and sensitivity adjustments). Second, the technical concepts required include familiarity with Godot's internal architecture (editor-runtime communication, camera systems), C++ programming (including memory management and type handling), and 3D graphics concepts (e.g., field of view, camera transformations, and sensitivity scaling). Third, while the problem statement does not explicitly mention edge cases, the code changes introduce logic for handling mouse input inversion, warped panning, and camera bounds, which suggests some complexity in ensuring robust behavior across different user configurations. However, the changes do not appear to impact the broader system architecture or require advanced domain-specific knowledge beyond typical game engine development. The amount of code change is moderate, with significant logic updates but not a complete overhaul. Therefore, a difficulty score of 0.55 reflects the need for a solid understanding of multiple concepts and careful implementation across several files, placing it in the medium difficulty category.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Persistent window state does not work for linux X11 gnome-shell 'tiled/docked/snapped' editor windows\n### Tested versions\n\n- Reproducible on Godot 4.4-stable\n\n### System information\n\nGodot v4.4.stable - Ubuntu 22.04.5 LTS 22.04 on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3050 Laptop GPU - 12th Gen Intel(R) Core(TM) i7-12700H (14 threads)\n\n### Issue description\n\n[Persistent window state](https://godotengine.org/releases/4.4/#persistent-window-state) doesn't work if your window is 'tiled' in X11 gnome.\n\nTested on X11 GNOME Shell 42.9  Xorg: 1:7.7+23ubuntu2\n\n\nIt looks like `_NET_WM_STATE` is `..._MAXIMIZED_VERT` which isn't the same as maximized..\n\nThe window geometry is `0,65+2558x1375`\n\nBut when I re-open it becomes `..._MAXIMIZED_VERT | ..._MAXIMIZED_HORIZ`\nand the window geometry is  `0,64+5120x1376`\n\nBEFORE closing\n```\n_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 89\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 65\n                program specified size: 2558 by 1375\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4045156\n```\n\nAFTER re-opening\n```_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_HORZ, _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 85\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 64\n                program specified size: 5120 by 1376\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4048202\n```\n\n### Steps to reproduce\n\nRe-open the window in gnome window manager after snapping to the left or right\n\n### Minimal reproduction project (MRP)\n\nno MRP possible?\n", "patch": "diff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex 26c94bf25cf1..ead01551939f 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -2563,7 +2563,8 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\tAtom *atoms = (Atom *)data;\n \t\tAtom wm_act_max_horz;\n \t\tAtom wm_act_max_vert;\n-\t\tif (strcmp(p_atom_name, \"_NET_WM_STATE\") == 0) {\n+\t\tbool checking_state = strcmp(p_atom_name, \"_NET_WM_STATE\") == 0;\n+\t\tif (checking_state) {\n \t\t\twm_act_max_horz = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_HORZ\", False);\n \t\t\twm_act_max_vert = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_VERT\", False);\n \t\t} else {\n@@ -2581,9 +2582,16 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\t\t\tfound_wm_act_max_vert = true;\n \t\t\t}\n \n-\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n-\t\t\t\tretval = true;\n-\t\t\t\tbreak;\n+\t\t\tif (checking_state) {\n+\t\t\t\tif (found_wm_act_max_horz && found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \n", "instance_id": "godotengine__godot-103526", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the persistent window state feature in Godot 4.4-stable does not work correctly for tiled/docked/snapped windows under the X11 GNOME Shell environment on Linux. It provides detailed system information, specific versions tested, and logs showing the difference in window state before and after reopening (e.g., changes in `_NET_WM_STATE` from `_MAXIMIZED_VERT` to both `_MAXIMIZED_HORZ` and `_MAXIMIZED_VERT`). Steps to reproduce are provided, though they are minimal. However, there are minor ambiguities and missing details. For instance, the expected behavior is not explicitly defined\u2014should the window retain its exact tiled state, or is there a specific desired outcome? Additionally, edge cases or other window manager behaviors are not mentioned, and there is no minimal reproduction project (MRP), which could hinder debugging. Overall, the problem is valid and mostly clear, but these minor gaps prevent a perfect score.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively small, confined to a single file (`display_server_x11.cpp`) and a specific function (`_window_maximize_check`). The modification involves adjusting the logic for detecting maximized states under X11, specifically changing the condition to require both `_MAXIMIZED_HORZ` and `_MAXIMIZED_VERT` to consider a window as maximized when checking `_NET_WM_STATE`. This indicates a targeted bug fix rather than a broad architectural change. Second, the technical concepts involved include familiarity with X11 window management protocols (e.g., `_NET_WM_STATE` atoms) and the Godot engine's display server implementation, which requires moderate domain-specific knowledge of Linux windowing systems. Third, the problem does not explicitly mention complex edge cases beyond the tiled/snapped state, though the developer must consider potential side effects on other window states or window managers. Finally, the change does not appear to impact the broader system architecture or require extensive refactoring. Given these factors\u2014a focused change, moderate technical depth, and limited scope\u2014I assign a difficulty score of 0.45, placing it in the medium category as it requires understanding specific X11 concepts and careful logic modification but is not overly complex or system-wide in impact.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor crash on startup caused by loading VRAM compressed texture with specific range of dimensions\n### Tested versions\n\n- Reproduced in 4.4 dev6, all betas, and rc1\n- Not reproduced in 4.4 dev1 through dev5\n\n### System information\n\nGodot v4.4.dev6 - Windows 10.0.19045 - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated Radeon RX 580 Series (Advanced Micro Devices, Inc.; 31.0.21921.1000) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nThe editor crashes after initialization. When running my big project with -v, the last lines displayed are these:\n```\nLoading resource: res://.godot/imported/some_texture.png-1c25004a89b329a9613253a73f2f1983.s3tc.ctex\n\tCompressed image's dimensions are not multiples of 4 (1024x1023), aligning to (1028x1024)\n```\nThe presence of `some_texture.png` actually causes the crash. I copied that texture to an empty project and found out that its dimensions, as well as it having alpha, cause a crash. Note that in the MRP, the above log message doesn't appear, although the same crash happens.\n\nI compiled with debug symbols and debugged in VS code, and the exception message is this:\n`Exception 0xc0000005 encountered at address 0x7ff6f73f5535: Access violation reading location 0x1589ca2d008`\nIt happens in `thirdparty/misc/bcdec.h`\n```\nstatic void bcdec__color_block(const void* compressedBlock, void* decompressedBlock, int destinationPitch, int onlyOpaqueMode) {\n    unsigned short c0, c1;\n    unsigned int refColors[4]; /* 0xAABBGGRR */\n    unsigned char* dstColors;\n    unsigned int colorIndices;\n    int i, j, idx;\n    unsigned int r0, g0, b0, r1, g1, b1, r, g, b;\n\n    c0 = ((unsigned short*)compressedBlock)[0]; <--------- exception here on line 119\n    c1 = ((unsigned short*)compressedBlock)[1];\n```\nAnd here's the call stack in case it helps:\n```\nstatic void bcdec__color_block(const void *, void *, int, int) (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:119)\nbcdec_bc3 (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:287)\nstatic void decompress_image(BCdecFormat, const void *, void *, const unsigned __int64, const unsigned __int64) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:129)\nvoid __cdecl image_decompress_bcdec(class Image *) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:239)\npublic: enum Error __cdecl Image::decompress(void) (c:\\tools\\Godot\\src\\godot\\core\\io\\image.cpp:2670)\npublic: virtual class Ref<class Texture2D> __cdecl EditorTexturePreviewPlugin::generate(class Ref<class Resource> const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\plugins\\editor_preview_plugins.cpp:164)\npublic: virtual class Ref<class Texture2D> __cdecl EditorResourcePreviewGenerator::generate_from_path(class String const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:73)\nprivate: void __cdecl EditorResourcePreview::_generate_preview(class Ref<class ImageTexture> &,class Ref<class ImageTexture> &,struct EditorResourcePreview::QueueItem const &,class String const &,class Dictionary &) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:205)\nprivate: void __cdecl EditorResourcePreview::_iterate(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:379)\nprivate: void __cdecl EditorResourcePreview::_thread(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:407)\nprivate: static void __cdecl EditorResourcePreview::_thread_func(void *) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:139)\nprivate: static void __cdecl Thread::callback(unsigned __int64,struct Thread::Settings const &,void (__cdecl*)(void *),void *) (c:\\tools\\Godot\\src\\godot\\core\\os\\thread.cpp:64)\nvoid std::invoke<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>( * *, unsigned __int64 *, struct Thread::Settings *,  * *, void * *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\type_traits:1741)\nunsigned int std::thread::_Invoke<std::tuple<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>,0,1,2,3,4>(void *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\thread:60)\nstatic unsigned long thread_start<unsigned int (__cdecl*)(void *),1>(void *) (@NoHotPatch:29828)\nBaseThreadInitThunk (@BaseThreadInitThunk:9)\nRtlUserThreadStart (@RtlUserThreadStart:12)\n```\n\n### Steps to reproduce\n\n1. Add a PNG texture to a project with dimensions of 1024x1023, and some alpha on at least one pixel. The MRP's `crash_texture.png` meets these criteria.\n2. Select the PNG in filesystem dock to reveal its import settings, and change the compress mode to \"VRAM compressed\"\n3. Reimport the texture and the editor crashes. It will also crash on each subsequent startup.\n\nOther resolutions that cause crash: 1024x1022, 1024x1021\nNo crash: 1024x1020, 1025x1023, 512x511\n\n### Minimal reproduction project (MRP)\n\n[texture_crash_mrp.zip](https://github.com/user-attachments/files/18947915/texture_crash_mrp.zip)\n", "patch": "diff --git a/modules/bcdec/image_decompress_bcdec.cpp b/modules/bcdec/image_decompress_bcdec.cpp\nindex 6d97ca38abef..ad0c1729d64c 100644\n--- a/modules/bcdec/image_decompress_bcdec.cpp\n+++ b/modules/bcdec/image_decompress_bcdec.cpp\n@@ -158,9 +158,12 @@ void image_decompress_bcdec(Image *p_image) {\n \n \t// Compressed images' dimensions should be padded to the upper multiple of 4.\n \t// If they aren't, they need to be realigned (the actual data is correctly padded though).\n-\tif (width % 4 != 0 || height % 4 != 0) {\n-\t\tint new_width = width + (4 - (width % 4));\n-\t\tint new_height = height + (4 - (height % 4));\n+\tconst bool need_width_realign = width % 4 != 0;\n+\tconst bool need_height_realign = height % 4 != 0;\n+\n+\tif (need_width_realign || need_height_realign) {\n+\t\tint new_width = need_width_realign ? width + (4 - (width % 4)) : width;\n+\t\tint new_height = need_height_realign ? height + (4 - (height % 4)) : height;\n \n \t\tprint_verbose(vformat(\"Compressed image's dimensions are not multiples of 4 (%dx%d), aligning to (%dx%d)\", width, height, new_width, new_height));\n \n", "instance_id": "godotengine__godot-103259", "clarity": 3, "difficulty": 0.3, "clarity_explanation": "The problem statement is comprehensive and well-documented. It clearly describes the issue (editor crash on startup due to loading VRAM compressed textures with specific dimensions), provides detailed system information, specifies the affected versions, and includes precise steps to reproduce the issue. Additionally, it offers a minimal reproduction project (MRP), debug information with a call stack, and specific error messages. The input conditions (texture dimensions and alpha presence) and the expected outcome (crash) are explicitly defined. There are no significant ambiguities, and the problem is supported by concrete examples and logs. The only minor omission is a lack of explicit mention of desired behavior post-fix, but the intent to prevent the crash is implied and clear from the context and code changes.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" category (0.2-0.4) due to the following reasons based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is localized to a single file (`image_decompress_bcdec.cpp`) and involves a small modification to the logic for realigning image dimensions. The change corrects a bug in how padding is applied to dimensions that are not multiples of 4, ensuring that only the necessary dimensions (width or height) are adjusted. This does not impact the broader system architecture or require changes across multiple modules. The amount of code change is minimal, involving just a few lines.\n\n2. **Clarity and Complexity of the Problem Description**: As noted in the clarity score, the problem is well-defined, which reduces the difficulty of understanding the issue. The crash is tied to specific texture dimensions and compression settings, and the call stack points directly to the problematic area in the code (`bcdec.h`), making it easier to pinpoint the root cause.\n\n3. **Number of Technical Concepts**: Solving this requires a basic understanding of image compression (specifically VRAM compressed textures and block compression formats like BC3), memory alignment constraints (dimensions as multiples of 4), and C++ pointer operations. These concepts are not overly complex for someone with moderate experience in graphics programming or low-level C++ development. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic graphics processing are needed.\n\n4. **Edge Cases and Error Handling**: The problem statement highlights specific edge cases (e.g., dimensions like 1024x1023, 1024x1022 causing crashes, while others like 1024x1020 do not). However, the provided code change does not introduce new error handling logic; it simply fixes the dimension alignment logic to prevent the crash. The edge cases are already well-documented, and no additional complex error handling is required in the fix.\n\nOverall, while the problem involves a crash in a third-party library and requires some understanding of image compression, the fix itself is straightforward and localized. It does not demand deep architectural changes or advanced technical expertise beyond basic debugging and C++ skills. A score of 0.30 reflects an \"Easy\" problem that requires understanding some code logic and making a simple modification to fix the bug.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "VideoStreamPlayer causes game to crash upon playing video\n### Tested versions\n\n- Reproducible in v4.4.beta4.official [93d270693]\n- Not reproducible in v4.4.beta3.official [06acfccf8]\n\nThe only VideoStreamPlayer-related commit I saw in beta4 was #101958, so I think it is a likely cause of this issue.\n\n### System information\n\nWindows 11 - both Forward+ and Compatibility - both with and without dedicated GPU\n\n### Issue description\n\nGame closes without displaying any in-editor error messages upon playing a VideoStreamPlayer in 4.4 beta4.\n\n### Steps to reproduce\n\nPlay an Ogg Theora stream through a VideoStreamPlayer, either with `autoplay=true` or `play()`. Seems to affect both Forward+ and Compatibility renderers (haven't tested Mobile).\n\n### Minimal reproduction project (MRP)\n\n[videoplayerbug.zip](https://github.com/user-attachments/files/18838902/videoplayerbug.zip)\nThe main scene can be played to reproduce the issue. In beta3, this works as expected and a blue box moves across the screen. In beta4, the game exits immediately.\nMinGW GCC LTO internal compiler error when linking: cannot read 'LTO_section_decls'\n### Tested versions\n\n- Reproducible in d497631de0c67f22564e1efeb467cf9f061adc80 (commit before merge of workaround #102506) \n- Reproducible in 4.3.beta3 and latest `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) **with #102506 reverted**\n- Not reproducible in 4.3.stable or 4.4.beta2\n\n### System information\n\nFedora 41, mingw64-gcc-14.2.1-3.fc41, mingw64-headers-12.0.0-3.fc41, mingw64-binutils-2.42-2.fc41\n\n### Issue description\n\nThis is the bug report I promised in #102506, describing the actual bug that #102506 just hacks around, but that PR should be reverted and the bug fixed properly. This is very likely to be a GCC or binutils bug, and not a Godot bug.\n\nReproducible this bug requires (for now) to revert #102506 locally, as it seems like reintroducing this unnecessary code prevents the LTO internal compiler error. It's all fairly brittle though and I'm not confident it won't come back as we add/change other code, hence why this is a release blocker.\n\nWhen compiling current `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) with #102506 reverted and the following command, using MinGW-GCC:\n```\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n(mono module and LTO are important)\n\nThe linking steps fails with:\n```\nlto1: internal compiler error: cannot read 'LTO_section_decls' from /tmp/ccf5RNMk.ltrans115.o\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nSee <http://bugzilla.redhat.com/bugzilla> for instructions.\nmake: *** [/tmp/cct9c3iK.mk:347: /tmp/ccf5RNMk.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nOr this:\n```\nlto1: error: two or more sections for .gnu.lto__ZZL39_register_variant_builtin_methods_arrayvEN17Method_Array_back17get_argument_typeEi.lto_priv.0.37928630.b9f437417adc9a80\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/cc3CZrbQ.mk:347: /tmp/ccmO0Wsr.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nI debugged a bit with @bruvzg, who could also reproduce this with mingw-gcc on macOS with GCC 14.2.0. He tried with `-freport-bug` as advised by the error but that seems to prevent the bug.\n\n@Repiteo noted that the second error is similar to the one in #92585 (note: `x86_32` there, while here it's on `x86_64`), which we just worked around at the time by updating the base Fedora version to get newer mingw/gcc/binutils.\n\nBut here we're using the latest version provided on Fedora 41. mingw-headers and mingw-gcc on Fedora 42 aren't newer, but mingw-binutils is at 2.43.1, might be worth testing against.\n\nSince the error popped up between 4.4.beta2 and 4.4.beta3, I bisected it and landed on #102179. There's evidently nothing egregious in that patch that should trigger a LTO crash. Through trial and error, I manage to find a workaround in #102506 by doing a minimal partial revert of #102179. Reintroducing some of that code, even in a path that will never be executed (but could be, as it's checked by an undocumented project setting), seems to prevent the crash.\n\nWe also noticed that the presence of LTO objects from a previous build can also be a cause for the issue. But with a `git clean -fxd` this issue is still reproducible when reverting #102179.\n\nObviously, the problem is deeper so we need to dig. That's where I page @hpvb as the resident expert in debugging GCC bugs :D\n\n### Steps to reproduce\n\nSet up latest mingw with GCC 14.2.\n```\ngit revert e12a424bc569ac5ae9ff2944a8df7fc11b157d71\ngit clean -fxd\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 6f57b880441f..bbdcb9e79aa1 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -732,7 +732,7 @@ def configure_mingw(env: \"SConsEnvironment\"):\n         if env[\"use_static_cpp\"]:\n             env.Append(LINKFLAGS=[\"-static\"])\n \n-    if env[\"arch\"] in [\"x86_32\", \"x86_64\"]:\n+    if env[\"arch\"] == \"x86_32\":\n         env[\"x86_libtheora_opt_gcc\"] = True\n \n     env.Append(CCFLAGS=[\"-ffp-contract=off\"])\n", "instance_id": "godotengine__godot-103176", "clarity": 2, "difficulty": 0.85, "clarity_explanation": "\nThe problem statement is mostly clear in describing two distinct issues: a crash in the VideoStreamPlayer in version 4.4.beta4 and a MinGW GCC LTO internal compiler error during linking. For the VideoStreamPlayer issue, the goal (fixing the crash), steps to reproduce, and system information are provided, along with a minimal reproduction project (MRP). However, critical details such as specific error logs, expected behavior beyond \"game exits,\" or constraints on the fix are missing. For the LTO compiler error, the description is detailed with system information, tested versions, steps to reproduce, and even a workaround reference (#102506). It also includes insights from debugging and bisection, pointing to a specific commit (#102179). However, there are minor ambiguities, such as the lack of clarity on whether this is purely a GCC/binutils bug or if Godot's codebase contributes to triggering it, and the exact nature of the \"deeper problem\" is not fully defined. Overall, while the issues are valid and mostly clear, minor details and potential edge cases are not fully specified, warranting a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.85 (Very Hard) due to the following factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem statement is mostly clear, the dual nature of the issues (VideoStreamPlayer crash and LTO compiler error) adds complexity. The VideoStreamPlayer crash requires debugging a specific component in a game engine, potentially involving rendering pipelines (Forward+ and Compatibility) and video decoding (Ogg Theora). The LTO error is even more complex as it involves low-level compiler and linker behavior, which is outside the typical scope of application-level programming.\n\n2. **Scope and Depth of Code Changes**: The provided code change in `detect.py` is minimal, altering a single condition to disable an optimization (`x86_libtheora_opt_gcc`) for x86_64 architecture. However, this change is likely a workaround or partial fix for the VideoStreamPlayer issue or related to #102179. The actual resolution for both issues may require significant changes or debugging across multiple files or modules. For the VideoStreamPlayer crash, it could involve modifications in video decoding or rendering logic, potentially impacting core engine components. For the LTO error, the fix might not even be in the Godot codebase but in how the build system interacts with GCC/binutils, or it may require intricate workarounds in the codebase to avoid triggering the compiler bug. This suggests a deep impact on the system architecture or build process.\n\n3. **Number of Technical Concepts**: Solving these issues requires understanding multiple advanced concepts. For the VideoStreamPlayer crash, one needs knowledge of game engine architecture, video streaming/decoding libraries (e.g., Theora), rendering pipelines, and possibly platform-specific behavior (Windows). For the LTO error, expertise in compiler internals (GCC LTO), linker behavior (binutils), cross-compilation (MinGW for Windows on Linux/macOS), build systems (SCons), and low-level debugging is essential. Additionally, familiarity with Godot's build configuration and optimization flags is necessary. These are highly specialized and complex concepts, even for experienced engineers.\n\n4. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases for the VideoStreamPlayer crash beyond autoplay and manual play scenarios, but video streaming inherently involves numerous edge cases (e.g., corrupted streams, unsupported formats, resource constraints). The LTO error discussion hints at brittle behavior influenced by previous build artifacts or specific code paths, indicating complex error conditions that are hard to predict or reproduce consistently. Resolving these issues likely requires robust error handling and extensive testing, adding to the difficulty.\n\nOverall, the combination of debugging a game engine crash in a specific component and tackling a compiler/linker bug with minimal direct control over the root cause makes this a very hard problem. It demands advanced technical knowledge, deep familiarity with both the Godot codebase and low-level tools, and the ability to navigate intricate system-level issues. A score of 0.85 reflects the significant challenge posed by these issues, placing it in the upper range of difficulty.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "(4.4.beta1) Android app crashes when exported with .NET 9\n### Tested versions\n\n**Reproducible:**\n4.4.beta1\n4.4.dev7\n\n**Not Reproducible:**\n4.4.dev3\n\n### System information\n\nGodot v4.4.beta1.mono - Windows 10 (build 19045) - OpenGL 3 (Compatibility)\n\n### Issue description\n\nWhen exporting to Android with .NET 9 using Gradle Build via the Remote Deploy, the app crashes immediately at startup.\n\nNote:  .NET 8 works fine, but .NET 9 causes the app to crash\n\nusing the command at runtime:\n**adb logcat|grep godot**\n\n> 01-22 19:27:18.818  1895  3450 I ActivityTaskManager: START u0 {act=android.intent.action.MAIN flg=0x10000000 cmp=com.example.test_android/com.godot.game.GodotApp} from uid 2000\n01-22 19:27:18.857  1895  2224 I ActivityManager: Start proc 1876:com.example.test_android/u0a411 for next-top-activity {com.example.test_android/com.godot.game.GodotApp}\n01-22 19:27:19.885  1895  2006 W ActivityTaskManager:   Force finishing activity com.example.test_android/com.godot.game.GodotApp\n01-22 19:27:19.987  1895  2220 I GameServiceProviderInstance: Failed to remove task overlay. This is expected if the task is already destroyed: GameSessionRecord{mTaskId=306, mState=GAME_SESSION_ATTACHED, mRootComponentName=ComponentInfo{com.example.test_android/com.godot.game.GodotApp}, mIGameSession=android.service.games.IGameSession$Stub$Proxy@3a45eaa, mSurfacePackage=android.view.SurfaceControlViewHost$SurfacePackage@3504a9b}\n01-22 19:27:20.386  1895  2200 W ActivityTaskManager: Activity top resumed state loss timeout for ActivityRecord{691de90 u0 com.example.test_android/com.godot.game.GodotApp} t-1 f}}\n\n\n\n\n\n\n\n### Steps to reproduce\n\n1. Godot 4.4.beta1\n2. Create a new project\n3. Create C# script and attach to a node in the main scene\n4. Update the visual studio project to target .NET 9: \n` <TargetFramework>net9.0</TargetFramework>`\n4. Remote Deploy to Android with Gradle Build\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/platform/android/export/export_plugin.cpp b/platform/android/export/export_plugin.cpp\nindex 578f723e700f..0f50f725258c 100644\n--- a/platform/android/export/export_plugin.cpp\n+++ b/platform/android/export/export_plugin.cpp\n@@ -55,6 +55,10 @@\n #include \"modules/modules_enabled.gen.h\" // For mono.\n #include \"modules/svg/image_loader_svg.h\"\n \n+#ifdef MODULE_MONO_ENABLED\n+#include \"modules/mono/utils/path_utils.h\"\n+#endif\n+\n #ifdef ANDROID_ENABLED\n #include \"../os_android.h\"\n #endif\n@@ -2526,6 +2530,43 @@ bool EditorExportPlatformAndroid::has_valid_username_and_password(const Ref<Edit\n \treturn valid;\n }\n \n+#ifdef MODULE_MONO_ENABLED\n+bool _validate_dotnet_tfm(const String &required_tfm, String &r_error) {\n+\tString assembly_name = path::get_csharp_project_name();\n+\tString project_path = ProjectSettings::get_singleton()->globalize_path(\"res://\" + assembly_name + \".csproj\");\n+\n+\tif (!FileAccess::exists(project_path)) {\n+\t\treturn true;\n+\t}\n+\n+\tString pipe;\n+\tList<String> args;\n+\targs.push_back(\"build\");\n+\targs.push_back(project_path);\n+\targs.push_back(\"--getProperty:TargetFramework\");\n+\n+\tint exitcode;\n+\tError err = OS::get_singleton()->execute(\"dotnet\", args, &pipe, &exitcode, true);\n+\tif (err != OK || exitcode != 0) {\n+\t\tif (err != OK) {\n+\t\t\tWARN_PRINT(\"Failed to execute dotnet command. Error \" + String(error_names[err]));\n+\t\t} else if (exitcode != 0) {\n+\t\t\tprint_line(pipe);\n+\t\t\tWARN_PRINT(\"dotnet command exited with code \" + itos(exitcode) + \". See output above for more details.\");\n+\t\t}\n+\t\tr_error += vformat(TTR(\"Unable to determine the C# project's TFM, it may be incompatible. The export template only supports '%s'. Make sure the project targets '%s' or consider using gradle builds instead.\"), required_tfm, required_tfm) + \"\\n\";\n+\t} else {\n+\t\tString tfm = pipe.strip_edges();\n+\t\tif (tfm != required_tfm) {\n+\t\t\tr_error += vformat(TTR(\"C# project targets '%s' but the export template only supports '%s'. Consider using gradle builds instead.\"), tfm, required_tfm) + \"\\n\";\n+\t\t\treturn false;\n+\t\t}\n+\t}\n+\n+\treturn true;\n+}\n+#endif\n+\n bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<EditorExportPreset> &p_preset, String &r_error, bool &r_missing_templates, bool p_debug) const {\n \tString err;\n \tbool valid = false;\n@@ -2534,6 +2575,15 @@ bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<Edito\n #ifdef MODULE_MONO_ENABLED\n \t// Android export is still a work in progress, keep a message as a warning.\n \terr += TTR(\"Exporting to Android when using C#/.NET is experimental.\") + \"\\n\";\n+\n+\tif (!gradle_build_enabled) {\n+\t\t// For template exports we only support .NET 8 because the template\n+\t\t// includes .jar dependencies that may only be compatible with .NET 8.\n+\t\tif (!_validate_dotnet_tfm(\"net8.0\", err)) {\n+\t\t\tr_error = err;\n+\t\t\treturn false;\n+\t\t}\n+\t}\n #endif\n \n \t// Look for export templates (first official, and if defined custom templates).\n", "instance_id": "godotengine__godot-102627", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an Android app built with Godot 4.4.beta1 crashes at startup when exported with .NET 9, while it works fine with .NET 8. The description includes tested versions, system information, steps to reproduce, and relevant log output, which helps in understanding the context and replicating the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify the exact cause of the crash (e.g., a specific error message or stack trace beyond the log provided), nor does it mention potential edge cases or constraints related to the Android environment or .NET 9 compatibility. Additionally, the lack of a minimal reproduction project (MRP) makes it slightly harder to pinpoint the issue without further investigation. Overall, the statement is valid and clear but lacks some finer details that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes is relatively focused, primarily affecting a single file (`export_plugin.cpp`) in the Godot engine's Android export module. However, the changes introduce a new validation function (`_validate_dotnet_tfm`) to check the .NET Target Framework Moniker (TFM) compatibility, which requires understanding the interaction between Godot's build system, .NET versions, and Android export templates. This involves moderate complexity in terms of codebase architecture, as it touches on the integration of C#/.NET with Android builds.\n\nSecond, the technical concepts involved include familiarity with Godot's export system, .NET framework versioning, command-line execution of `dotnet` commands via the OS interface, and string parsing for validation. Additionally, the developer must understand the implications of using Gradle builds versus template exports and why .NET 9 compatibility fails with the current setup. These concepts are not trivial and require a solid grasp of both Godot's internals and .NET ecosystems.\n\nThird, the code changes, while not extensive in terms of lines of code, have a significant impact by enforcing a specific .NET version (net8.0) for template exports and providing detailed error messaging. This indicates a need for careful error handling and user feedback, though specific edge cases (e.g., missing `dotnet` CLI, malformed project files) are not explicitly handled in the provided diff and may need further consideration.\n\nFinally, solving this issue requires debugging a crash in a specific environment (Android with .NET 9), which often involves deep knowledge of platform-specific behaviors, build configurations, and potentially native debugging tools. While the provided code change addresses a specific compatibility check, the underlying crash issue might require further investigation beyond this diff, adding to the difficulty. A score of 0.65 reflects the need for a deep understanding of the codebase and moderate-to-complex modifications, placing it in the lower end of the \"Hard\" range.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Ctrl-Click on enum value/member does nothing\n### Tested versions\n\n- reproducible in: 4.4.dev7\n- reproducible on master (tested with a 03-Jan-2025 build - `v4.4.dev.gh-101012 [c37ada786]`)\n- works in: 4.4.dev6\n\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nI mentioned this here: https://github.com/godotengine/godot/issues/100680#issuecomment-2557966392\nWhile general control-click was restored with https://github.com/godotengine/godot/pull/100707 the enum issue remains.\n\nCTRL-clicking on an enum value/member does nothing (well, it actually navigates to the beginning of the line).\n\nE.g. enum like this:\n```\nclass_name E extends Object\n\nenum Team {\n\tNone,\n\tOne,\n}\n\nfunc test():\n\tvar t = E.Team.None\n```\nand CTRL-clicking on the `None` of `E.Team.None` does not take you to the `None` under `enum Team`.\n\n\n### Steps to reproduce\n\nOpen enum.gd in MRP - same code as in description.\n\n### Minimal reproduction project (MRP)\n\n[44dev7enum.zip](https://github.com/user-attachments/files/18303044/44dev7enum.zip)\n\n", "patch": "diff --git a/modules/gdscript/gdscript_editor.cpp b/modules/gdscript/gdscript_editor.cpp\nindex cccfff6a8449..062d522b6818 100644\n--- a/modules/gdscript/gdscript_editor.cpp\n+++ b/modules/gdscript/gdscript_editor.cpp\n@@ -3956,10 +3956,14 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t} else {\n \t\t\t\t\t\t\tconst int dot_pos = doc_enum_name.rfind_char('.');\n \t\t\t\t\t\t\tif (dot_pos >= 0) {\n+\t\t\t\t\t\t\t\tError err = OK;\n \t\t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n-\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n-\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\tif (base_type.class_type != nullptr) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = GDScriptCache::get_shallow_script(base_type.script_path, err);\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n \t\t\t\t\t\t\t\t\tconst String enum_name = doc_enum_name.substr(dot_pos + 1);\n \t\t\t\t\t\t\t\t\tif (base_type.class_type->has_member(enum_name)) {\n \t\t\t\t\t\t\t\t\t\tconst GDScriptParser::ClassNode::Member member = base_type.class_type->get_member(enum_name);\n@@ -3972,8 +3976,19 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t} else if (base_type.script_type.is_valid()) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = base_type.script_type;\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n+\t\t\t\t\t\t\t\t\t// TODO: Find a way to obtain enum value location for a script\n+\t\t\t\t\t\t\t\t\tr_result.location = base_type.script_type->get_member_line(doc_enum_name.substr(dot_pos + 1));\n+\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\treturn OK;\n+\t\t\t\t\t\t\t\treturn err;\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t} else if (Variant::has_builtin_method(Variant::DICTIONARY, p_symbol)) {\n", "instance_id": "godotengine__godot-102401", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: CTRL-clicking on an enum value in the Godot engine's GDScript editor does not navigate to the correct definition of the enum member. It provides specific versions where the issue is reproducible, system information, a clear description of the expected behavior versus the actual behavior, steps to reproduce, and a minimal reproduction project (MRP). However, there are minor ambiguities, such as the lack of explicit mention of edge cases (e.g., nested enums, inherited enums, or enums in different scopes) and no detailed specification of the desired navigation behavior for all possible enum usage scenarios. Additionally, the problem statement does not clarify whether this issue affects only specific types of enums or all enum declarations. Despite these minor gaps, the overall intent and context of the issue are well-articulated, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is relatively narrow, confined to a single file (`gdscript_editor.cpp`) and a specific function related to symbol lookup. However, the changes require a deep understanding of the Godot engine's internals, particularly the GDScript parser and how symbol resolution works for enums in different contexts (e.g., script-based enums versus class-based enums). The code modifications involve handling different data types (`base_type.class_type` and `base_type.script_type`) and ensuring correct navigation to the enum member's definition, which adds complexity. \n\nSecond, the number of technical concepts involved is significant: familiarity with C++ (used in Godot's core), the Godot engine's scripting system, symbol lookup mechanisms, and potentially the editor's UI integration for navigation. The developer must also understand how scripts and class members are cached and accessed within the engine, as seen in the use of `GDScriptCache` and script paths.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes suggest the need to handle different enum declaration contexts (e.g., within a class or a script) and potentially incomplete or invalid symbol lookups. Error handling logic is also modified (e.g., returning an `Error` type), indicating some attention to robustness, though the complexity of these edge cases appears moderate.\n\nFinally, the impact on the system's architecture is minimal since the change is localized, but the risk of introducing bugs in symbol resolution\u2014a critical feature for editor usability\u2014is non-trivial. A score of 0.65 reflects the need for a solid understanding of the codebase, careful handling of enum-specific logic, and moderate complexity in ensuring the fix works across various scenarios without breaking existing functionality.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Horrible Flickering when closing docks while embedded game is paused\n### Tested versions\n\n- Reproducible in Godot 4.4 beta1\n\n### System information\n\n\ud83e\ude9f Windows 11 - \ud83e\udd16 Godot 4.4 beta1\n\n### Issue description\n\nClosing a dock while the game is paused and embedded causes the screen to flicker pretty badly.\n\n\u26a0\ufe0f Photosensitivity warning \u26a0\ufe0f\n\ud83c\udfa5 See screen recording:\n\nhttps://github.com/user-attachments/assets/4cb0c17c-bc7b-4723-9e30-91b3ea54bf1f\n\n### Steps to reproduce\n\nEnable 'Embed Game on Next Play' in the Game tab.\n\n1. Run a game.\n2. Open a dock.\n3. Pause the game. \n4. Close the dock.\n5. Survive the flickering \u26a0\ufe0f\ud83d\udd26\ud83d\udcf8\ud83d\udca5\ud83d\ude35\u200d\ud83d\udcab\ud83d\ude35\u200d\ud83d\udcab\ud83d\ude35\u200d\ud83d\udcab\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 723c762a72a5..ad501e77a6d8 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -301,6 +301,7 @@ void GameView::_stop_pressed() {\n \t}\n \n \t_detach_script_debugger();\n+\tpaused = false;\n \n \tEditorNode::get_singleton()->set_unfocused_low_processor_usage_mode_enabled(true);\n \tembedded_process->reset();\n@@ -515,15 +516,26 @@ void GameView::_update_embed_menu_options() {\n }\n \n void GameView::_update_embed_window_size() {\n-\tif (embed_size_mode == SIZE_MODE_FIXED || embed_size_mode == SIZE_MODE_KEEP_ASPECT) {\n-\t\t//The embedded process control will need the desired window size.\n-\t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n-\t\tembedded_process->set_window_size(placement.size);\n+\tif (paused) {\n+\t\t// When paused, Godot does not re-render. As a result, resizing the game window to a larger size\n+\t\t// causes artifacts and flickering. However, resizing to a smaller size seems fine.\n+\t\t// To prevent artifacts and flickering, we will force the game window to maintain its size.\n+\t\t// Using the same technique as SIZE_MODE_FIXED, the embedded process control will\n+\t\t// prevent resizing the game to a larger size while maintaining the aspect ratio.\n+\t\tembedded_process->set_window_size(size_paused);\n+\t\tembedded_process->set_keep_aspect(false);\n+\n \t} else {\n-\t\t//Stretch... No need for the window size.\n-\t\tembedded_process->set_window_size(Size2i());\n+\t\tif (embed_size_mode == SIZE_MODE_FIXED || embed_size_mode == SIZE_MODE_KEEP_ASPECT) {\n+\t\t\t// The embedded process control will need the desired window size.\n+\t\t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n+\t\t\tembedded_process->set_window_size(placement.size);\n+\t\t} else {\n+\t\t\t// Stretch... No need for the window size.\n+\t\t\tembedded_process->set_window_size(Size2i());\n+\t\t}\n+\t\tembedded_process->set_keep_aspect(embed_size_mode == SIZE_MODE_KEEP_ASPECT);\n \t}\n-\tembedded_process->set_keep_aspect(embed_size_mode == SIZE_MODE_KEEP_ASPECT);\n }\n \n void GameView::_hide_selection_toggled(bool p_pressed) {\n@@ -787,7 +799,8 @@ void GameView::_window_close_request() {\n \t\tembedded_process->reset();\n \n \t\t// When the embedding is not complete, we need to kill the process.\n-\t\tif (embedded_process->is_embedding_in_progress()) {\n+\t\t// If the game is paused, the close request will not be processed by the game, so it's better to kill the process.\n+\t\tif (paused || embedded_process->is_embedding_in_progress()) {\n \t\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n \t\t\t// actually closes.\n \t\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n@@ -795,6 +808,20 @@ void GameView::_window_close_request() {\n \t}\n }\n \n+void GameView::_debugger_breaked(bool p_breaked, bool p_can_debug) {\n+\tif (p_breaked == paused) {\n+\t\treturn;\n+\t}\n+\n+\tpaused = p_breaked;\n+\n+\tif (paused) {\n+\t\tsize_paused = embedded_process->get_screen_embedded_window_rect().size;\n+\t}\n+\n+\t_update_embed_window_size();\n+}\n+\n GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tsingleton = this;\n \n@@ -984,6 +1011,8 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tp_wrapper->set_override_close_request(true);\n \tp_wrapper->connect(\"window_close_requested\", callable_mp(this, &GameView::_window_close_request));\n \tp_wrapper->connect(\"window_size_changed\", callable_mp(this, &GameView::_update_floating_window_settings));\n+\n+\tEditorDebuggerNode::get_singleton()->connect(\"breaked\", callable_mp(this, &GameView::_debugger_breaked));\n }\n \n ///////\n@@ -1053,15 +1082,18 @@ void GameViewPlugin::_window_visibility_changed(bool p_visible) {\n }\n \n void GameViewPlugin::_save_last_editor(const String &p_editor) {\n-\tif (p_editor != get_name()) {\n+\tif (p_editor != get_plugin_name()) {\n \t\tlast_editor = p_editor;\n \t}\n }\n \n void GameViewPlugin::_focus_another_editor() {\n \tif (window_wrapper->get_window_enabled()) {\n-\t\tERR_FAIL_COND(last_editor.is_empty());\n-\t\tEditorInterface::get_singleton()->set_main_screen_editor(last_editor);\n+\t\tif (last_editor.is_empty()) {\n+\t\t\tEditorNode::get_singleton()->get_editor_main_screen()->select(EditorMainScreen::EDITOR_2D);\n+\t\t} else {\n+\t\t\tEditorInterface::get_singleton()->set_main_screen_editor(last_editor);\n+\t\t}\n \t}\n }\n \ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 7402b270e3c0..dd384280b5fb 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -122,6 +122,8 @@ class GameView : public VBoxContainer {\n \tbool embed_on_play = true;\n \tbool make_floating_on_play = true;\n \tEmbedSizeMode embed_size_mode = SIZE_MODE_FIXED;\n+\tbool paused = false;\n+\tSize2 size_paused;\n \n \tRect2i floating_window_rect;\n \tint floating_window_screen = -1;\n@@ -186,6 +188,8 @@ class GameView : public VBoxContainer {\n \tvoid _detach_script_debugger();\n \tvoid _remote_window_title_changed(String title);\n \n+\tvoid _debugger_breaked(bool p_breaked, bool p_can_debug);\n+\n protected:\n \tvoid _notification(int p_what);\n \n", "instance_id": "godotengine__godot-102006", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue of flickering when closing docks while an embedded game is paused in Godot 4.4 beta1. It provides a clear context (Godot editor, embedded game mode), steps to reproduce the issue, and even a visual reference via a screen recording. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not explicitly define the expected behavior (e.g., no flickering at all, or a specific way to handle resizing), nor does it mention specific edge cases beyond the general scenario of pausing and closing docks. Additionally, there are no details about performance expectations or constraints for the fix. While the issue is reproducible and the goal is implied (eliminate flickering), these missing specifics slightly reduce the clarity.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is moderate, primarily confined to a single file (`game_view_plugin.cpp`) with modifications to multiple functions, but it does not appear to impact the broader system architecture significantly. However, the changes require a deep understanding of the Godot engine's internals, specifically how embedded game windows, pausing mechanisms, and rendering interact within the editor. The technical concepts involved include handling window resizing, maintaining aspect ratios, and managing state transitions (paused vs. unpaused), which are non-trivial in a game engine context. Additionally, the solution introduces new logic to prevent resizing to larger sizes while paused to avoid flickering, which requires careful handling of state (`paused` and `size_paused`) and integration with existing systems like the debugger (`_debugger_breaked`). Edge cases, such as different embed size modes and window close requests during paused states, are addressed in the code changes, adding to the complexity. While not at the extreme end of difficulty (e.g., no system-level redesign or advanced algorithms), this problem demands a solid grasp of the codebase and thoughtful handling of rendering artifacts, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4.dev5] Websockets stuck in STATE_CLOSING\n### Tested versions\n\nStarting with 4.4.dev5\nConfirmed to work with 4.4.dev4\n\n### System information\n\nGodot v4.4.dev5 - Windows 10.0.26100 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 6700 XT (Advanced Micro Devices, Inc.; 32.0.12033.1030) - Intel(R) Core(TM) i5-9600K CPU @ 3.70GHz (6 threads)\n\n### Issue description\n\nClient WebSocketPeers get stuck on STATE_CLOSING when close() is called.\n\n### Steps to reproduce\n\n- Download MRP with any Godot version >= 4.4.dev5\n- Click on \"Client disconnect\"\n- Check output\n\n### Minimal reproduction project (MRP)\n\n[100948.zip](https://github.com/user-attachments/files/18277136/100948.zip)\n\n", "patch": "diff --git a/modules/websocket/wsl_peer.cpp b/modules/websocket/wsl_peer.cpp\nindex 9ffc343571e8..f50b4c480652 100644\n--- a/modules/websocket/wsl_peer.cpp\n+++ b/modules/websocket/wsl_peer.cpp\n@@ -860,10 +860,12 @@ void WSLPeer::close(int p_code, String p_reason) {\n \t\t}\n \t}\n \n-\theartbeat_waiting = false;\n-\tin_buffer.clear();\n-\tpacket_buffer.resize(0);\n-\tpending_message.clear();\n+\tif (ready_state == STATE_CLOSED) {\n+\t\theartbeat_waiting = false;\n+\t\tin_buffer.clear();\n+\t\tpacket_buffer.resize(0);\n+\t\tpending_message.clear();\n+\t}\n }\n \n IPAddress WSLPeer::get_connected_host() const {\n", "instance_id": "godotengine__godot-101760", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: WebSocketPeers get stuck in the STATE_CLOSING state when the close() method is called in Godot versions starting from 4.4.dev5. It provides specific version information, system details, steps to reproduce, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior after calling close() (e.g., should the state transition to STATE_CLOSED immediately?), nor does it mention specific edge cases or conditions under which the issue occurs (e.g., specific network conditions or timing issues). Additionally, the impact of being \"stuck\" in STATE_CLOSING (e.g., resource leaks, inability to reconnect) is not detailed. These gaps prevent the statement from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is localized to a single file (wsl_peer.cpp) and involves a small modification within the close() method. The diff shows a conditional check to ensure cleanup (clearing buffers and resetting state variables) only occurs if the ready_state is STATE_CLOSED. This suggests a straightforward bug fix with minimal impact on the broader codebase or system architecture. The change does not require understanding complex interactions between modules, as it is confined to the WebSocket peer's state management logic.\n\n2. **Number of Technical Concepts:** Solving this issue requires a basic understanding of WebSocket protocols (specifically state transitions like STATE_CLOSING to STATE_CLOSED), familiarity with C++ (as the codebase is in C++), and knowledge of the Godot engine's WebSocket implementation. These concepts are not overly complex for a developer with moderate experience in networking and C++. No advanced algorithms, design patterns, or domain-specific knowledge beyond WebSocket state handling are needed.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the nature of WebSocket state transitions implies potential issues like race conditions (e.g., close() called during an ongoing operation) or network interruptions. The code change itself does not introduce new error handling logic; it merely adjusts when cleanup occurs. The complexity of edge cases appears minimal, as the fix focuses on ensuring proper state cleanup rather than handling diverse failure modes.\n\n4. **Overall Assessment:** The problem is a relatively simple bug fix involving a small, targeted code change. It requires understanding the WebSocket state machine in Godot but does not demand deep architectural knowledge or extensive modifications. The difficulty is slightly above \"Very Easy\" due to the need to understand the specific state transition logic and verify that the fix does not introduce side effects, but it remains within the \"Easy\" category. Hence, a score of 0.30 is appropriate.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Inspector loads slowly when there's many Color properties\n### Tested versions\n\nReproducible in 4.4.dev7, and probably many versions earlier.\n\n### System information\n\nWindows 11\n\n### Issue description\n\nInspectors (or project/editor settings) that contain many Color properties will load slowly. Additionally, they can be slow to switch away from.\n\n### Steps to reproduce\n\nFor example, check out:\n```\nEditor Settings > Text Editor > Theme     (the worst example)\nEditor Settings > Editors > 3D Gizmos\nEditor Settings > Editors > Visual Editors\nProject Settings > Debug > Shapes\n```\n\n\n\n### Minimal reproduction project (MRP)\n\nAlso, I made an MPR that has a Node with an exported `Array[Color]`, and some extra Color properties. Try repeatedly switching between the `Colorful` and `Colorless` nodes (make sure the Array is expanded).\n\n[color_picker.zip](https://github.com/user-attachments/files/18418402/color_picker.zip)\n", "patch": "diff --git a/editor/editor_properties.cpp b/editor/editor_properties.cpp\nindex 69b44a3e8f88..b1a4bb76f325 100644\n--- a/editor/editor_properties.cpp\n+++ b/editor/editor_properties.cpp\n@@ -2599,6 +2599,17 @@ void EditorPropertyColor::_color_changed(const Color &p_color) {\n \tget_edited_object()->set(get_edited_property(), p_color);\n }\n \n+void EditorPropertyColor::_picker_created() {\n+\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_popup_opening));\n+\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n+}\n+\n+void EditorPropertyColor::_popup_opening() {\n+\tEditorNode::get_singleton()->setup_color_picker(picker->get_picker());\n+\tlast_color = picker->get_pick_color();\n+\twas_checked = !is_checkable() || is_checked();\n+}\n+\n void EditorPropertyColor::_popup_closed() {\n \tget_edited_object()->set(get_edited_property(), was_checked ? Variant(last_color) : Variant());\n \tif (!picker->get_pick_color().is_equal_approx(last_color)) {\n@@ -2606,11 +2617,6 @@ void EditorPropertyColor::_popup_closed() {\n \t}\n }\n \n-void EditorPropertyColor::_picker_opening() {\n-\tlast_color = picker->get_pick_color();\n-\twas_checked = !is_checkable() || is_checked();\n-}\n-\n void EditorPropertyColor::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_ENTER_TREE:\n@@ -2654,9 +2660,7 @@ EditorPropertyColor::EditorPropertyColor() {\n \tadd_child(picker);\n \tpicker->set_flat(true);\n \tpicker->connect(\"color_changed\", callable_mp(this, &EditorPropertyColor::_color_changed));\n-\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(EditorNode::get_singleton(), &EditorNode::setup_color_picker).bind(picker->get_picker()));\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_picker_opening));\n+\tpicker->connect(\"picker_created\", callable_mp(this, &EditorPropertyColor::_picker_created), CONNECT_ONE_SHOT);\n }\n \n ////////////// NODE PATH //////////////////////\ndiff --git a/editor/editor_properties.h b/editor/editor_properties.h\nindex bcdae5342d28..6fe8cc3c3f38 100644\n--- a/editor/editor_properties.h\n+++ b/editor/editor_properties.h\n@@ -593,8 +593,9 @@ class EditorPropertyColor : public EditorProperty {\n \tGDCLASS(EditorPropertyColor, EditorProperty);\n \tColorPickerButton *picker = nullptr;\n \tvoid _color_changed(const Color &p_color);\n+\tvoid _picker_created();\n+\tvoid _popup_opening();\n \tvoid _popup_closed();\n-\tvoid _picker_opening();\n \n \tColor last_color;\n \tbool live_changes_enabled = true;\n", "instance_id": "godotengine__godot-101570", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: inspectors and settings with many Color properties load slowly, and switching between them is also slow. It provides specific examples of affected areas in the editor settings and includes a minimal reproduction project (MRP) to demonstrate the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected performance improvement or success criteria (e.g., target load time or acceptable delay). Additionally, it lacks mention of specific edge cases or constraints that might affect the solution, such as memory usage or compatibility with different platforms beyond Windows 11. While the issue is reproducible and the context is provided, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively localized, primarily affecting the `EditorPropertyColor` class in `editor_properties.cpp` and its header file. The changes involve modifying event handling for the color picker (e.g., connecting signals for popup events and managing state like `last_color` and `was_checked`). This requires understanding the editor's UI event system and the specific behavior of the `ColorPickerButton` widget, which adds moderate complexity. Second, the number of technical concepts involved includes familiarity with C++ class inheritance, signal-slot mechanisms (likely part of a framework like Godot's), and UI component lifecycle management. These are not overly advanced but do require a solid grasp of the codebase's design patterns. Third, the problem does not explicitly mention edge cases, but the code changes suggest potential considerations around state consistency (e.g., ensuring the color value is correctly updated or reverted when the picker popup closes) and performance (e.g., avoiding redundant operations during popup events). However, these are not overly complex to handle. Finally, the impact on the system's architecture appears minimal, as the changes are confined to a specific component without broader refactoring. Overall, this problem requires understanding multiple concepts and making targeted modifications, fitting a medium difficulty score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`invalidateblock` during background validation\nIf you call `invalidateblock` (on the tip) during background validation, the node will currently do the following:\r\n#### bitcoin-cli invalidateblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:01:15Z [background validation] UpdateTip: new best=0000000000000000008dd2857255b2e5fc0c3955740c74dac6bafd0de09c344e height=482000 version=0x20000000 log2_work=86.991735 tx=249395394 date='2017-08-25T19:52:51Z' progress=0.230269 cache=238.7MiB(1748399txo)\r\n2024-09-24T13:02:42Z Saw new header hash=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671\r\n2024-09-24T13:02:45Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81087txo)\r\n2024-09-24T13:02:52Z [background validation] UpdateTip: new best=000000000000000000b7738efb4c4acbc841c032294d2e6ab09295f4117c7b3a height=484000 version=0x20000002 log2_work=87.061771 tx=252628356 date='2017-09-07T11:50:44Z' progress=0.233253 cache=688.5MiB(5222117txo)\r\n2024-09-24T13:02:58Z UpdateTip: new best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec height=862670 version=0x3fff0000 log2_work=95.172216 tx=1085323202 date='2024-09-24T13:00:39Z' progress=0.999999 cache=11.8MiB(77967txo)\r\n2024-09-24T13:02:58Z InvalidChainFound: invalid block=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe  height=862671  log2_work=95.172229  date=2024-09-24T13:02:21Z\r\n2024-09-24T13:02:58Z InvalidChainFound:  current best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec  height=862670  log2_work=95.172216  date=2024-09-24T13:00:39Z\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\n<repeat for every new block processed in the background validation>\r\n```\r\n#### bitcoin-cli reconsiderblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81332txo)\r\n2024-09-24T13:03:16Z New outbound-full-relay v2 peer connected: version: 70016, blocks=862671, peer=69\r\n2024-09-24T13:04:44Z [background validation] UpdateTip: new best=000000000000000000a2a8104d61651f76c666b70754d6e9346176385f7afa24 height=486000 version=0x20000000 log2_work=87.131847 tx=255540060 date='2017-09-19T09:09:00Z' progress=0.235942 cache=1014.2MiB(7475508txo)\r\n2024-09-24T13:06:42Z [background validation] UpdateTip: new best=000000000000000000f980eebec0616501eead146975f1df5ca9a1db40309547 height=488000 version=0x20000000 log2_work=87.210415 tx=258791302 date='2017-10-02T21:02:34Z' progress=0.238943 cache=1284.3MiB(9681780txo)\r\n2024-09-24T13:08:01Z [background validation] UpdateTip: new best=000000000000000000de069137b17b8d5a3dfbd5b145b2dcfb203f15d0c4de90 height=490000 version=0x20000000 log2_work=87.286453 tx=262368718 date='2017-10-15T17:57:17Z' progress=0.242246 cache=1521.0MiB(11621530txo)\r\n```\r\n\r\nPrinting these warning messages does not seem useful, or even the correct thing to do during a background sync; as the chain being warned about, is still our best, active chain?\n", "patch": "diff --git a/src/validation.cpp b/src/validation.cpp\nindex b47b1d09ae1e9..5da3387ad296f 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2020,7 +2020,8 @@ void Chainstate::CheckForkWarningConditions()\n \n     // Before we get past initial download, we cannot reliably alert about forks\n     // (we assume we don't get stuck on a fork before finishing our initial sync)\n-    if (m_chainman.IsInitialBlockDownload()) {\n+    // Also not applicable to the background chainstate\n+    if (m_chainman.IsInitialBlockDownload() || this->GetRole() == ChainstateRole::BACKGROUND) {\n         return;\n     }\n \n", "instance_id": "bitcoin__bitcoin-30962", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: calling `invalidateblock` during background validation in a Bitcoin node results in repeated warning messages about an invalid chain, which the author questions as being unnecessary or incorrect since the chain remains the best active chain. The logs provided offer context about the behavior, showing the sequence of events with `invalidateblock` and `reconsiderblock` commands. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"background validation\" entails or how it interacts with the main chainstate, which could be critical for someone unfamiliar with the Bitcoin codebase. Additionally, the expected behavior or desired outcome after the fix is not fully articulated\u2014while it implies that warnings should not be printed, it does not specify under what conditions or if there are alternative behaviors to consider. Constraints or potential side effects of suppressing these warnings are also not mentioned. Despite these minor gaps, the issue is valid and understandable with the provided logs and context, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is minimal, involving a single line modification in `validation.cpp` to add a condition check for the background chainstate role. It affects only one function (`CheckForkWarningConditions`) and does not require understanding complex interactions across multiple modules or altering the system's architecture. The change is localized and straightforward, simply extending an existing condition to skip warning checks during background validation.\n\n2. **Number of Technical Concepts:** The solution requires basic familiarity with the Bitcoin Core codebase, specifically understanding the concept of chainstate roles (foreground vs. background) and the `IsInitialBlockDownload` mechanism. No advanced language features, algorithms, or design patterns are involved. The change leverages existing logic and does not introduce new technical complexity.\n\n3. **Edge Cases and Error Handling:** The problem statement and code change do not explicitly address specific edge cases or error handling requirements. The modification appears to be a simple conditional check to suppress warnings, and there\u2019s no indication of complex edge cases (e.g., what happens if background validation state changes mid-process). While there might be implicit considerations about ensuring warnings are still appropriately triggered in other contexts, the provided diff does not suggest significant complexity in handling such cases.\n\n4. **Overall Complexity:** The task is a minor bug fix or behavioral adjustment rather than a feature addition or architectural change. It requires understanding a small part of the codebase and making a simple logical modification. The impact is limited to logging behavior during background validation, with no apparent performance or systemic implications.\n\nGiven these factors, a difficulty score of 0.25 reflects the ease of the task. It requires minimal effort beyond identifying the correct place to add the condition and understanding the basic context of background validation in Bitcoin Core. This is well within the capabilities of a junior to mid-level developer with some familiarity with the codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Shutdown during reindex-chainstate can block forever\nDuring `Shutdown`, we stop the scheduler before waiting on the load-block thread. But the load-block thread can call `LimitValidationInterfaceQueue` via `ActivateBestChain`. `LimitValidationInterfaceQueue` then schedules a dummy call and waits for it. But since the scheduler has stopped, it never gets there, and blocks forever. Shutdown remains joined to the thread, and also never exits.\r\n\r\nCan we just wait for the load-block thread before killing the scheduler?\n", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e4b65fbfa94f6..03969b00bb661 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -296,10 +296,11 @@ void Shutdown(NodeContext& node)\n \n     StopTorControl();\n \n+    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n     // After everything has been shut down, but before things get flushed, stop the\n-    // scheduler and load block thread.\n+    // the scheduler. After this point, SyncWithValidationInterfaceQueue() should not be called anymore\n+    // as this would prevent the shutdown from completing.\n     if (node.scheduler) node.scheduler->stop();\n-    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n \n     // After the threads that potentially access these pointers have been stopped,\n     // destruct and reset all to nullptr.\n", "instance_id": "bitcoin__bitcoin-30435", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a deadlock during shutdown caused by the order of stopping the scheduler and waiting for the load-block thread. It identifies the root cause (the scheduler being stopped before the thread can complete its work) and poses a reasonable question about reordering the shutdown sequence. However, it lacks critical details such as the broader context of the shutdown process, specific constraints or risks associated with changing the order of operations, and any potential side effects or edge cases that might arise from the proposed solution. Additionally, there are no examples or detailed scenarios to illustrate the problem, which could make it harder for someone unfamiliar with the codebase to fully grasp the issue. Hence, it is rated as \"Mostly Clear\" with minor details missing.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, involving only a reordering of two operations in a single file (`init.cpp`). It does not impact multiple modules or require significant architectural changes. The modification is straightforward\u2014moving the `join()` call for the load-block thread before stopping the scheduler.\n\n2. **Technical Concepts Involved**: Solving this requires a basic understanding of multithreading and synchronization in C++ (specifically, thread joining and scheduler management). It does not involve complex algorithms, design patterns, or advanced language features. However, it does require some familiarity with the codebase's shutdown sequence and the interaction between the scheduler and threads, which adds a slight layer of complexity.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases or error conditions to handle, and the code change does not introduce new error handling logic. However, there is an implicit risk of unintended consequences (e.g., other dependencies on the scheduler being stopped later), which requires careful consideration but is not overly complex.\n\n4. **Overall Complexity**: While the fix itself is simple, understanding the root cause (deadlock due to scheduling and thread interactions) requires a moderate level of debugging and reasoning about concurrent systems. This pushes the difficulty slightly above the \"Very Easy\" range but keeps it within \"Easy\" as the actual implementation is minimal and localized.\n\nThus, a score of 0.35 reflects a problem that is relatively easy to solve with basic knowledge of threading and a cursory understanding of the codebase's shutdown logic, without requiring deep architectural changes or handling complex edge cases.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "\"Color selection\" off-by-one regression: it colors 1 cell past the end\n### Windows Terminal version\n\n1.23.10732.0\n\n### Windows build number\n\n10.0.26388.1001\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nI use the \"Color Selection\" feature a lot, and often the \"all matches\" variant, which lets you select some text, and then change the fg/bg color for all occurrences of the selected text.\n\nRecently it started coloring one cell past the end of the selection. In the screenshot below, I selected \"abcd\", but the colorization applies to \"abcde\" (as well as \"abcdeX\", demonstrating that the search is not similarly afected):\n\n![Image](https://github.com/user-attachments/assets/6258a18f-d941-443d-9f3e-c7fd6750dbe3)\n\n### Expected Behavior\n\nJust the \"abcd\" should have been colorized.\n\n### Actual Behavior\n\nColorization included one character past the end.\n", "patch": "diff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex df30a3ffb23..7cd232ad539 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -2061,14 +2061,6 @@ void TextBuffer::_ExpandTextRow(til::inclusive_rect& textRow) const\n     }\r\n }\r\n \r\n-size_t TextBuffer::SpanLength(const til::point coordStart, const til::point coordEnd) const\r\n-{\r\n-    const auto bufferSize = GetSize();\r\n-    // The coords are inclusive, so to get the (inclusive) length we add 1.\r\n-    const auto length = bufferSize.CompareInBounds(coordEnd, coordStart) + 1;\r\n-    return gsl::narrow<size_t>(length);\r\n-}\r\n-\r\n // Routine Description:\r\n // - Retrieves the plain text data between the specified coordinates.\r\n // Arguments:\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex 775417caab0..fca973f50de 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -199,8 +199,6 @@ class TextBuffer final\n     std::wstring GetCustomIdFromId(uint16_t id) const;\r\n     void CopyHyperlinkMaps(const TextBuffer& OtherBuffer);\r\n \r\n-    size_t SpanLength(const til::point coordStart, const til::point coordEnd) const;\r\n-\r\n     std::wstring GetPlainText(til::point start, til::point end) const;\r\n \r\n     struct CopyRequest\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex 0a94352e724..4bd41d58d01 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -2868,6 +2868,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 // coloring other matches, then we need to make sure those get redrawn,\r\n                 // too.\r\n                 _renderer->TriggerRedrawAll();\r\n+                _updateSelectionUI();\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 9e6350df044..91def441079 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1571,10 +1571,10 @@ void Terminal::SerializeMainBuffer(const wchar_t* destination) const\n \r\n void Terminal::ColorSelection(const TextAttribute& attr, winrt::Microsoft::Terminal::Core::MatchMode matchMode)\r\n {\r\n-    const auto colorSelection = [this](const til::point coordStart, const til::point coordEnd, const TextAttribute& attr) {\r\n+    const auto colorSelection = [this](const til::point coordStartInclusive, const til::point coordEndExclusive, const TextAttribute& attr) {\r\n         auto& textBuffer = _activeBuffer();\r\n-        const auto spanLength = textBuffer.SpanLength(coordStart, coordEnd);\r\n-        textBuffer.Write(OutputCellIterator(attr, spanLength), coordStart);\r\n+        const auto spanLength = textBuffer.GetSize().CompareInBounds(coordEndExclusive, coordStartInclusive, true);\r\n+        textBuffer.Write(OutputCellIterator(attr, spanLength), coordStartInclusive);\r\n     };\r\n \r\n     for (const auto [start, end] : _GetSelectionSpans())\r\n", "instance_id": "microsoft__terminal-18798", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear, as it describes a specific issue with the \"Color Selection\" feature in Windows Terminal, where the colorization extends one character beyond the intended selection. It provides a version number, a screenshot for visual reference, and clearly states the expected versus actual behavior. However, there are minor ambiguities: the problem statement does not explicitly mention whether this issue occurs under specific conditions (e.g., certain text encodings, buffer sizes, or selection modes beyond \"all matches\"). Additionally, edge cases or constraints (e.g., behavior with empty selections, selections at buffer boundaries) are not addressed. These missing details prevent it from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem is mostly clear, the logic behind the off-by-one error is straightforward\u2014an inclusive range calculation likely needs adjustment. This is a common type of bug in text buffer handling, reducing the conceptual complexity.\n\n2. **Scope and Depth of Code Changes**: The provided diff shows modifications across four files (`textBuffer.cpp`, `textBuffer.hpp`, `ControlCore.cpp`, and `Terminal.cpp`). However, the core fix is localized to replacing the `SpanLength` method with a direct calculation in `Terminal.cpp`, adjusting for inclusive/exclusive bounds. Additional changes, like triggering a UI update in `ControlCore.cpp`, are minor. The changes do not impact the broader system architecture and involve a small amount of code, mostly removing or tweaking existing logic rather than adding significant new functionality.\n\n3. **Number of Technical Concepts**: Solving this requires understanding basic C++ concepts (e.g., method calls, parameter passing), familiarity with the project's custom types (e.g., `til::point`, `TextAttribute`), and a grasp of text buffer manipulation. The off-by-one error fix involves understanding coordinate range calculations, which is a fundamental concept in text rendering or buffer management. No advanced algorithms, design patterns, or domain-specific knowledge beyond terminal rendering basics are needed.\n\n4. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest the issue is related to boundary calculations (inclusive vs. exclusive ranges). The fix appears to handle the general case, but there\u2019s no indication of additional error handling or edge case considerations (e.g., selections at the start/end of a buffer, empty selections). The complexity of edge cases seems minimal based on the provided diff.\n\nOverall, this problem requires understanding a specific part of the codebase (text buffer and selection logic) and making a targeted fix for an off-by-one error, which is a common and relatively simple bug to resolve. The changes span multiple files but are not extensive or architecturally significant. Therefore, a difficulty score of 0.35 is appropriate, reflecting an \"Easy\" problem that requires moderate code logic understanding and simple modifications.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Alt and F7 don't work in 1.23.3481.0\n### Windows Terminal version\n\n1.23.3481.0\n\n### Windows build number\n\n10.0.19045.5247\n\n### Other Software\n\nFAR Manager 3.0.6401.0 x64\n\nwhen migrate from canary build terminal-1.23.3461.0 to next canary build terminal-1.23.3481.0\ni have trouble with keys: Alt/RAlt and F7\n\n### Steps to reproduce\n\nrun utility KeyEvents.exe and press Alt and F7\n\n\n\n### Expected Behavior\n\nresult when press Alt:\n\nterminal-1.23.3461.0 - good behavior\n02:56:37 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n02:56:37 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\nresult when press f7:\n\nterminal-1.23.3461.0 - good behavior\n\n03:08:36 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:08:36 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n### Actual Behavior\n\nresult when press Alt:\n\nterminal-1.23.3481.0 - bad behavior\n02:54:44 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n\n\nresult when press f7:\n\nterminal-1.23.3481.0 - bad behavior\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 59f26b50b16..91e1a9bdb92 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -387,6 +387,9 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     MSG msg{};\r\n     while (GetMessageW(&msg, nullptr, 0, 0))\r\n     {\r\n+        // This is `if (WM_KEYDOWN || WM_KEYUP || WM_SYSKEYDOWN || WM_SYSKEYUP)`.\r\n+        // It really doesn't need to be written that obtuse, but it at\r\n+        // least nicely mirrors our `keyDown = msg.message & 1` logic.\r\n         // FYI: For the key-down/up messages the lowest bit indicates if it's up.\r\n         if ((msg.message & ~1) == WM_KEYDOWN || (msg.message & ~1) == WM_SYSKEYDOWN)\r\n         {\r\n@@ -401,7 +404,7 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n                 loggedInteraction = true;\r\n             }\r\n \r\n-            const bool keyDown = msg.message & 1;\r\n+            const bool keyDown = (msg.message & 1) == 0;\r\n             if (\r\n                 // GH#638: The Xaml input stack doesn't allow an application to suppress the \"caret browsing\"\r\n                 // dialog experience triggered when you press F7. Official recommendation from the Xaml\r\n@@ -438,15 +441,13 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     __assume(false);\r\n }\r\n \r\n-void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\r\n+void WindowEmperor::_dispatchSpecialKey(const MSG& msg) const\r\n {\r\n-    const auto hwnd = msg.hwnd;\r\n+    // Each CoreInput window is a child of our IslandWindow.\r\n+    // We can figure out the IslandWindow HWND via GetAncestor().\r\n+    const auto hwnd = GetAncestor(msg.hwnd, GA_ROOT);\r\n     AppHost* window = nullptr;\r\n \r\n-    // Just in case someone has targed a specific HWND,\r\n-    // we'll try to dispatch it to the corresponding class.\r\n-    // Usually this will not find anything because under WinUI the hidden CoreInput\r\n-    // window is responsible for all input handling (for whatever reason).\r\n     for (const auto& h : _windows)\r\n     {\r\n         const auto w = h->GetWindow();\r\n@@ -457,6 +458,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n         }\r\n     }\r\n \r\n+    // Fallback.\r\n     if (!window)\r\n     {\r\n         window = _mostRecentWindow();\r\n@@ -468,7 +470,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n \r\n     const auto vkey = gsl::narrow_cast<uint32_t>(msg.wParam);\r\n     const auto scanCode = gsl::narrow_cast<uint8_t>(msg.lParam >> 16);\r\n-    const bool keyDown = msg.message & 1;\r\n+    const bool keyDown = (msg.message & 1) == 0;\r\n     window->OnDirectKeyEvent(vkey, scanCode, keyDown);\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.h b/src/cascadia/WindowsTerminal/WindowEmperor.h\nindex 6b9b101507f..ca30159ac2d 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.h\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.h\n@@ -50,7 +50,7 @@ class WindowEmperor\n     AppHost* _mostRecentWindow() const noexcept;\r\n     bool _summonWindow(const SummonWindowSelectionArgs& args) const;\r\n     void _summonAllWindows() const;\r\n-    void _dispatchSpecialKey(MSG& msg) const;\r\n+    void _dispatchSpecialKey(const MSG& msg) const;\r\n     void _dispatchCommandline(winrt::TerminalApp::CommandlineArgs args);\r\n     safe_void_coroutine _dispatchCommandlineCurrentDesktop(winrt::TerminalApp::CommandlineArgs args);\r\n     LRESULT _messageHandler(HWND window, UINT message, WPARAM wParam, LPARAM lParam) noexcept;\r\n", "instance_id": "microsoft__terminal-18444", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the behavior of Alt and F7 keys has regressed in a specific version of Windows Terminal (1.23.3481.0) compared to a previous version (1.23.3461.0). It provides detailed logs of expected and actual behavior for key events, which helps in understanding the problem. However, there are minor ambiguities and missing details. For instance, it does not explicitly state the desired fix or the root cause of the issue (though the code changes imply it). Additionally, there is no mention of specific edge cases or constraints beyond the key events shown in the logs. While the steps to reproduce are provided, they rely on an external utility (KeyEvents.exe) without details on how to obtain or use it. Overall, the problem is valid and mostly clear but lacks some minor contextual details and explicit requirements for the solution.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of code changes is relatively small and localized to a single file (`WindowEmperor.cpp`) with minor updates to a header file (`WindowEmperor.h`). The changes primarily involve fixing the logic for detecting key down/up events by correcting a bitwise operation and improving the handling of window hierarchy for key event dispatching. This requires a basic understanding of Windows API message handling (e.g., `WM_KEYDOWN`, `WM_KEYUP`, `GetAncestor`) and bitwise operations, which are not overly complex for an experienced developer. The problem does not appear to impact the broader system architecture significantly, nor does it require extensive modifications across multiple modules. However, it does demand some domain-specific knowledge of Windows Terminal's input handling and the nuances of key event processing in the Windows API, which adds a slight layer of complexity. Edge cases and error handling are not explicitly mentioned in the problem statement, and the code changes do not introduce significant new error handling logic, keeping the difficulty moderate. Overall, this is a straightforward bug fix that requires understanding a specific part of the codebase and making targeted modifications, justifying a score of 0.35.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Windows Terminal - Command Palette]: 'Shortcut keys' in 'Command Palette' are not visible in high contrast themes for focused or hovered rows.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Pre-requisite:**\r\nSettings>Accessibility>Contrast themes>Aquatic/Desert theme>Reopen the application.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Follow the above-mentioned pre-requisite step.\r\n3. Now open any application like 'Windows Terminal'.\r\n4. Open command Palette by pressing 'Ctrl + Shift + P' keys.\r\n5. 'Command Palette' will open.\r\n6.  Now navigate to any row by up/down arrow keys or hover with mouse.\r\n7. Observe the issue.\r\n\r\n**User experience:**\r\nUsers relying on high contrast themes, especially those with visual impairments, may find it challenging to see the shortcut keys in the Command Palette. This issue impacts navigation efficiency, as users cannot easily identify or use the shortcuts for commands.\r\n\r\n**MAS Reference Link:**\r\n[MAS 4.3.1 \u2013 No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)\r\n\r\n**Attachment:**\r\n[Shortcut keys is not visible in high contrast themes.zip](https://github.com/user-attachments/files/16973765/Shortcut.keys.is.not.visible.in.high.contrast.themes.zip)\n\n### Expected Behavior\n\nThe shortcut keys for commands in the Command Palette should be clearly visible in high contrast themes when rows are focused or hovered. Proper contrast between the text and background should ensure that users can easily see the shortcut keys.\n\n### Actual Behavior\n\nThe shortcut keys associated with the commands in the Command Palette are not visible or are poorly visible when focused or hovered in high contrast themes. The lack of proper contrast makes it difficult to see the shortcut keys, impairing navigation.\n", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.xaml b/src/cascadia/TerminalApp/CommandPalette.xaml\nindex eb47534f9c5..2ed0c136e5f 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.xaml\n+++ b/src/cascadia/TerminalApp/CommandPalette.xaml\n@@ -23,6 +23,27 @@\n \r\n     <UserControl.Resources>\r\n         <ResourceDictionary>\r\n+            <!--  KeyChordText styles  -->\r\n+            <Style x:Key=\"KeyChordBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n+                <Setter Property=\"Background\" Value=\"Transparent\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <Style x:Key=\"KeyChordTextBlockStyle\"\r\n+                   TargetType=\"TextBlock\">\r\n+                <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <!--  ParsedCommandLineText styles  -->\r\n+            <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n+                <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n+            </Style>\r\n+\r\n             <DataTemplate x:Key=\"ListItemTemplate\"\r\n                           x:DataType=\"local:FilteredCommand\">\r\n                 <ListViewItem HorizontalContentAlignment=\"Stretch\"\r\n@@ -69,12 +90,12 @@\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n                             Background=\"{ThemeResource FlyoutPresenterBackground}\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n                 </Grid>\r\n@@ -118,12 +139,12 @@\n                             HorizontalAlignment=\"Right\"\r\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n \r\n@@ -219,79 +240,6 @@\n                                                GeneralItemTemplate=\"{StaticResource GeneralItemTemplate}\"\r\n                                                NestedItemTemplate=\"{StaticResource NestedItemTemplate}\"\r\n                                                TabItemTemplate=\"{StaticResource TabItemTemplate}\" />\r\n-\r\n-            <ResourceDictionary.ThemeDictionaries>\r\n-                <ResourceDictionary x:Key=\"Dark\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"Light\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"HighContrast\">\r\n-\r\n-                    <!--  KeyChordText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-\r\n-                    <!--  ParsedCommandLineText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-                </ResourceDictionary>\r\n-            </ResourceDictionary.ThemeDictionaries>\r\n         </ResourceDictionary>\r\n     </UserControl.Resources>\r\n \r\n@@ -375,7 +323,7 @@\n                     Padding=\"16,12\"\r\n                     HorizontalAlignment=\"Stretch\"\r\n                     VerticalAlignment=\"Center\"\r\n-                    Style=\"{ThemeResource ParsedCommandLineBorderStyle}\"\r\n+                    Style=\"{StaticResource ParsedCommandLineBorderStyle}\"\r\n                     Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(ParsedCommandLineText), Mode=OneWay}\">\r\n \r\n                 <ScrollViewer MaxHeight=\"200\"\r\n", "instance_id": "microsoft__terminal-18132", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: shortcut keys in the Command Palette of Windows Terminal are not visible in high contrast themes when rows are focused or hovered. It provides detailed steps to reproduce the issue, specifies the expected and actual behavior, and highlights the user impact, particularly for those with visual impairments. Additionally, it includes relevant context such as the Windows Terminal version, build number, and test environment. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly mention whether the issue affects all high contrast themes or only specific ones (though \"Aquatic/Desert\" themes are referenced in the steps). It also lacks detailed guidance on the desired contrast ratio or specific visual requirements for compliance with accessibility standards (beyond referencing a MAS document). These missing details could lead to slight uncertainty during implementation, but overall, the goal and scope of the problem are well-defined.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are confined to a single file (`CommandPalette.xaml`), focusing on the styling of UI elements (specifically, borders and text blocks for shortcut keys). The changes involve moving style definitions from theme-specific dictionaries (Dark, Light, HighContrast) to a general resource dictionary and updating references from `ThemeResource` to `StaticResource`. This is a relatively small and localized modification, with no apparent impact on the broader system architecture or interactions with other modules. The amount of code changed is moderate, primarily involving the deletion of redundant theme-specific styles and the addition of generalized styles.\n\n2. **Number of Technical Concepts**: Solving this problem requires a basic understanding of XAML (Extensible Application Markup Language) for UI design in Windows applications, specifically how styles and resources are defined and applied in different themes (including high contrast themes). Familiarity with Windows Terminal's theming system and accessibility considerations (e.g., contrast ratios) is necessary but not overly complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond UI styling are required.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases beyond the general issue of visibility in high contrast themes. The code changes do not introduce or modify error handling logic, as they are purely stylistic. However, the developer must ensure that the new styles do not inadvertently break visibility or accessibility in other themes or contexts, which adds a minor layer of caution but not significant complexity.\n\n4. **Overall Complexity**: The task is straightforward\u2014adjusting UI styles to ensure visibility in high contrast themes. It requires understanding the intent behind the style changes (e.g., leveraging system default brushes for better contrast) and verifying the result across different themes. However, it does not demand deep knowledge of the Windows Terminal codebase or complex refactoring. The primary challenge lies in ensuring compliance with accessibility standards, but the provided changes already address the core issue.\n\nGiven these considerations, a difficulty score of 0.30 reflects an \"Easy\" problem that requires some understanding of XAML and theming but involves minimal risk, scope, and technical depth. It is slightly above the \"Very Easy\" range due to the need to validate the changes across multiple themes and ensure accessibility compliance, but it remains a relatively simple fix.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
